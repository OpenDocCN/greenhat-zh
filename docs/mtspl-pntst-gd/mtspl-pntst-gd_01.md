## 第一章. 渗透测试的绝对基础

渗透测试是一种模拟攻击者可能使用的方法来绕过安全控制并获取组织系统访问权限的方式。渗透测试不仅仅是运行扫描器和自动化工具然后编写报告。你也不会一夜之间成为渗透测试专家；要熟练掌握，需要多年的实践和实际经验。

目前，在安全行业内，人们对渗透测试的看法和定义正在发生变化。*渗透测试执行标准（PTES）*正在重新定义渗透测试，这将影响新和经验丰富的渗透测试人员，并且已被安全社区的一些领先成员采用。其宗旨是通过建立进行渗透测试所需的基本原则的基准，来定义和提升对真正渗透测试含义的认识。如果你是渗透测试的新手或者不熟悉 PTES，请访问 [`www.pentest-standard.org/`](http://www.pentest-standard.org/) 了解更多信息。

## PTES 的阶段

PTES 阶段旨在定义渗透测试并确保客户组织，任何进行此类评估的人都将投入标准化的努力进行渗透测试。该标准分为七个类别，每个类别所需的努力程度不同，具体取决于被攻击的组织。

### 渗透测试前的互动

*渗透测试前的互动*通常发生在你与客户讨论渗透测试的范围和条款时。在渗透测试前，传达合作目标是至关重要的。这一阶段也为你提供了一个机会，向客户教育全面、全面范围的渗透测试可以期待什么——一个在合作期间不受限制的测试，即可以测试和将测试的内容。

### 情报收集

在 *情报收集* 阶段，你将通过使用社交媒体网络、谷歌黑客技术、目标指纹识别等方法收集有关你正在攻击的组织的任何信息。渗透测试人员可以拥有的最重要的技能之一是了解目标的能力，包括它的行为、运作方式以及最终如何被攻击。你收集的有关目标的信息将为你提供关于现有安全控制类型的宝贵见解。

在情报收集期间，你试图通过缓慢地开始探测目标系统来识别目标上存在的保护机制。例如，一个组织通常只会允许外部设备上的一定子集的端口上的流量，如果你在白名单端口之外查询组织，你将被阻止。通常，从最初开始探测一个你愿意被阻止或检测到的可消耗 IP 地址来测试这种阻止行为是一个好主意。当你测试 Web 应用程序时，这也同样适用，在达到一定阈值后，Web 应用程序防火墙将阻止你进一步发送请求。

为了在这些测试中不被发现，你可以从无法追溯到你和你的团队的 IP 地址范围进行初始扫描。通常，在互联网上具有外部存在的组织每天都会遭受攻击，你的初始探测很可能是背景噪音中未被察觉的一部分。

* * *

### 注意

在某些情况下，从除了你将用于主要攻击的 IP 范围之外的其他 IP 范围运行非常嘈杂的扫描可能是有意义的。这将帮助你确定组织对你使用的工具的反应有多好。

* * *

### 威胁建模

*威胁建模*使用你在情报收集阶段获得的信息来识别目标系统上存在的任何现有漏洞。在执行威胁建模时，你将确定最有效的攻击方法、你想要获取的信息类型以及组织可能如何被攻击。威胁建模涉及将组织视为对手，并尝试像攻击者一样利用弱点。

### 漏洞分析

在确定了最可行的攻击方法之后，你需要考虑你将如何访问目标。在*漏洞分析*中，你结合了之前阶段学到的信息，并使用这些信息来了解哪些攻击可能是可行的。在许多其他方面，漏洞分析考虑了端口和漏洞扫描、通过 banner 抓取收集的数据以及情报收集期间收集的信息。

### 利用

*利用*可能是渗透测试中最吸引人的部分之一，然而它通常是通过暴力攻击而不是精确攻击来完成的。只有在几乎可以肯定某个特定的利用将会成功时，才应该执行利用。当然，目标上可能存在未预见的防护措施，阻止特定的利用生效——但在触发漏洞之前，你应该知道系统是脆弱的。盲目地发射大量利用并祈祷获得 shell 是没有成效的；这只会制造噪音，对你作为渗透测试人员或你的客户几乎没有价值。首先做好你的作业，然后发起经过充分研究的、可能成功的利用。

### 后渗透测试

后渗透测试阶段在你入侵一个或多个系统之后开始——但你还没有完成。

后渗透测试是任何渗透测试中的关键组成部分。这是你与普通黑客区分开来的地方，实际上从渗透测试中提供有价值的信息和情报。后渗透测试针对特定的系统，识别关键基础设施，并针对公司最重视且已尝试保护的信息或数据。当你连续利用一个又一个系统时，你试图展示那些可能产生最大商业影响的攻击。

在后渗透测试中攻击系统时，你应该花时间确定各种系统的作用以及它们不同的用户角色。例如，假设你入侵了一个域基础设施系统，并以企业管理员身份运行或拥有域管理员级别的权限。你可能成为了域的君主，但与 Active Directory 通信的系统怎么办？主要财务应用程序，用于支付员工，怎么办？你能入侵那个系统，然后在下一个支付周期，让它将所有资金转移到离岸账户吗？关于目标方的知识产权呢？

例如，假设你的客户是一家大型软件开发公司，向客户交付定制的应用程序用于制造环境。你能在其源代码中植入后门，从而本质上损害所有客户的利益吗？这对他们的品牌信誉会有什么影响？

后渗透测试是那种你必须花时间学习你可以获取哪些信息的复杂场景之一，然后利用这些信息为你带来好处。攻击者通常会在被入侵的系统中花费大量时间做同样的事情。像恶意攻击者一样思考——要有创意，快速适应，并依靠你的智慧而不是自动化工具。

### 报告

*报告*是渗透测试中最重要的元素。你将使用报告来传达你做了什么，如何做的，最重要的是，组织应该如何修复在渗透测试中发现的漏洞。

在进行渗透测试时，你从攻击者的角度出发工作，这是组织很少看到的情况。你在测试中获得的信息对于组织信息安全项目的成功和阻止未来的攻击至关重要。当你整理和报告你的发现时，考虑组织如何利用你的发现来提高意识、修复发现的问题，并提高整体安全性，而不仅仅是修补技术漏洞。

至少，将你的报告分为执行摘要、执行演示和技术发现。技术发现将被客户用来修复安全漏洞，但这也是渗透测试的价值所在。例如，如果你在客户的基于 Web 的应用程序中发现了 SQL 注入漏洞，你可能会建议你的客户对所有用户输入进行清理，利用参数化 SQL 查询，以受限用户账户运行 SQL，并开启自定义错误消息。

在客户实施你的建议并修复了那个特定的 SQL 注入漏洞之后，他们真的就免于 SQL 注入的威胁了吗？不。很可能是一个潜在的问题最初导致了 SQL 注入漏洞，比如未能确保第三方应用程序的安全性。这些问题也需要得到修复。

## 渗透测试类型

现在你已经对七个 PTES 类别有了基本的了解，让我们来探讨两种主要的渗透测试类型：*公开*和*隐秘*。公开渗透测试，或称为“白帽”测试，是在组织完全知情的情况下进行的；隐秘测试旨在模拟一个未知且未宣布的攻击者的行为。这两种测试都各有优缺点。

### 公开渗透测试

使用公开的渗透测试，你将与组织合作以识别潜在的安全威胁，并且组织的 IT 或安全团队会向你展示组织的系统。公开测试的一个主要好处是你可以获取内部知识，并且可以放心地发起攻击而不用担心被阻止。公开测试的一个潜在缺点是公开测试可能无法有效地测试客户的应急响应计划或确定安全计划检测某些攻击的能力。当时间有限且某些 PTES 步骤，如情报收集，超出了范围时，公开测试可能是你的最佳选择。

### 隐秘渗透测试

与公开测试不同，授权的隐秘渗透测试旨在模拟攻击者的行为，并且在不让组织的大部分人知情的情况下进行。隐秘测试是为了测试内部安全团队检测和应对攻击的能力。

隐秘测试可能成本高昂且耗时，并且需要比公开测试更多的技能。在安全行业的渗透测试人员眼中，隐秘场景通常更受欢迎，因为它最接近于模拟真实的攻击。隐秘攻击依赖于你通过侦察获取信息的能力。因此，作为一个隐秘测试人员，你通常会尝试找到进入系统最简单的方法，而不是试图在目标中找到大量漏洞。

## 漏洞扫描器

漏洞扫描器是用于识别影响特定系统或应用程序的安全漏洞的自动化工具。漏洞扫描器通常通过*指纹识别*目标操作系统的版本和类型，以及任何正在运行的服务来实现。一旦你识别了目标操作系统的指纹，你就可以使用漏洞扫描器执行特定的检查，以确定是否存在漏洞。当然，这些检查的效果取决于其创建者，并且，与任何完全自动化的解决方案一样，它们有时可能会错过或错误地表示系统上的漏洞。

大多数现代漏洞扫描器在最小化误报方面做得非常出色，许多组织使用它们来识别过时系统或可能被攻击者利用的新漏洞。

漏洞扫描器在渗透测试中扮演着非常重要的角色，尤其是在公开测试的情况下，这允许你发起多次攻击而无需担心避免检测。从漏洞扫描器中获得的大量知识可能非常有价值，但请注意不要过度依赖它们。渗透测试的美丽之处在于它不能被自动化，成功攻击系统需要你具备知识和技能。在大多数情况下，当你成为一名熟练的渗透测试员时，你很少会使用漏洞扫描器，而是会依靠你的知识和专业知识来攻破系统。

## 综合所有内容

如果你刚开始渗透测试或者还没有真正采用一种正式的方法，请研究 PTES。与任何实验一样，在进行渗透测试时，确保你有一个精细且可适应的过程，同时也是可重复的。作为一名渗透测试员，你需要确保你的情报收集和漏洞分析尽可能专业，以便在适应各种场景时获得优势。
