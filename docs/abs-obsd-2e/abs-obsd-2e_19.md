## 第十九章：构建自定义内核

*重新布线大脑？*

*了解部件的连接方式*

*使其成为可能。*

![图片](http://atomoreilly.com/source/nostarch/images/1616079.png) OpenBSD 团队非常努力地提供高质量的内核，无需调整，只需偶尔设置 sysctl 或可能启用一个功能即可。但如果你想要使用实验性功能或向内核添加设备驱动程序，或者你想要将 OpenBSD 塞入小型硬件或嵌入式系统，你需要从源代码构建自定义内核。如果你冒险进入自定义内核，OpenBSD 的人不会支持你，但他们会提供你需要的一切，让你在接下来的章节中了解如何“自掘坟墓”。

## 内核注意事项

在我们深入了解构建自定义内核的细节之前，我们将探讨为什么这通常是一个糟糕的想法。

### 不要构建自定义内核

许多开源操作系统鼓励系统管理员构建自定义内核。这些操作系统的邮件列表充满了关于重新构建、调整和修改内核的建议。这些用户社区会引导新用户通过重新构建内核。

OpenBSD 开发者采用不同的方法来重新构建内核。他们提供了一个默认内核，称为 GENERIC，你几乎永远不需要重新构建它。

从源代码构建内核并不能证明你是一个 alpha 级别的极客，而且重新构建内核也绝不是解决问题的推荐方法。构建自定义内核的人要么是内核开发者，要么是无知的初学者。OpenBSD 项目成员对帮助用户解决自定义内核问题没有特别的义务。如果你的自定义内核崩溃，破坏了你的文件系统，或者开始向当地的警察局发出威胁电话，他们不会在乎。为什么？添加、移动或更改一个内核选项可能看起来微不足道，但每个选项可能代表成千上万行你随意删除的源代码。

话虽如此，OpenBSD 项目比闭源操作系统要友好得多，因为它提供了内核的源代码，并提供了构建它所需的工具和说明。这片领土可能很危险，有响尾蛇、熊，偶尔还有无底洞，但他们给你一张地图和一盏手电筒。如果你能为自己开辟一片新天地，那真是太好了！如果你被野狼吃了，那基本上就是这样。

### 注意

这些警告仅适用于自定义内核。OpenBSD 团队对提供的内核中存在的问题非常感兴趣，无论是 GENERIC 内核、安装程序内核还是任何其他内核。

当与内核一起工作时，请记住，一些平台有多个 GENERIC 内核。例如，i386 平台有标准的 GENERIC 内核，但它为多处理器机器提供了 GENERIC.MP，并且支持这两个版本。同样，SGI 平台有几个 GENERIC 内核——每个支持的硬件种类都有一个。这些内核都是 GENERIC，并且都受到支持。

### 为什么构建定制内核？

人们构建定制的内核有多种原因。例如，如果你是内核开发者，或者有成为内核开发者的愿望，你需要构建定制的内核来测试新功能和新的代码。

一些玩内核的人对使用实验性功能感兴趣。例如，OpenBSD 支持新开发但未经充分测试的多路径 SCSI，而 GENERIC 不支持。没有多少人拥有使用多路径 SCSI 的硬件，但那些拥有硬件并且具备编程技能的人被鼓励帮助改进这个功能。（当运行实验性功能时，请确保你理解“实验性”是“不稳定”的李生兄弟。）

很少情况下，修复安全漏洞可能需要修补内核源代码。但与其自己构建，不如从 OpenBSD 的稳定分支或快照（在第二十章中讨论）中获取补丁。

最后，有些人会构建定制的内核以在内存非常低的机器上节省 RAM。从内核中移除功能可以减小其大小。

### 构建定制内核时可能遇到的问题

当构建定制内核时，你可能会遇到麻烦。首先，内核模块之间的相互依赖关系相当复杂，并且没有详细记录。开发者通常假设构建定制内核的人会阅读内核源代码和手册页。你预计会阅读错误信息并自行解决。

OpenBSD 的跨平台设计略微复杂化了内核配置。一些设备在某些架构上运行，但在其他架构上无法运行或行为异常。如果你在内核中包含了错误设备，或者告诉内核一张卡连接到了错误的总线，你将构建一个损坏的内核。确保你了解你的硬件是如何实际组合在一起的。

当在源代码树中捣鼓时，你可能会以各种方式损坏源代码，例如通过错误地应用补丁、打乱一个文件，或者忘记你编辑了一个现在给你带来麻烦的文件。为了测试你的源代码，编译 GENERIC。如果 GENERIC 无法编译，那么你可能已经损坏了源代码，或者你的系统存在更深层的问题。

构建自定义内核通常意味着从配置文件中包含或删除内核选项和功能。然而，如果您正在尝试使用花哨的编译器标志，请停止。自定义编译器选项非常适合暴露编译器错误，但 OpenBSD 团队成员并不努力使他们的代码符合这些编译器选项的要求。许多这些选项和更高的优化如果不在非常特定的架构上运行非常特定的操作系统，就会中断。内核代码假设您正在使用指定的编译器选项；如果您更改它们，您只会得到痛苦。

如果您已经检查了一切，但仍然无法构建您的内核，您可能需要穿上防火服，并在 *misc@OpenBSD.org* 上寻求帮助。一开始就说明您正在尝试构建自定义内核，并包括以下信息：

+   您的内核配置

+   OpenBSD 版本

+   从您的计算机上启动 GENERIC 内核时未编辑的启动时间消息

+   对问题的完整描述

可能有人会同情你并试图帮助你。

### 运行自定义内核时遇到的问题

自定义内核可能会有任何数量的问题，例如以下：

+   程序可能无法按预期运行。

+   系统可能无法启动。

+   系统可能会随机崩溃。

+   内核可能无法找到您所有的硬件。

+   内核可能会吞噬您的硬盘或主板（甚至没有芥末，甚至没有一小杯麦芽醋）。

如果您仅对内核进行了有限的定制——比如说，仅向 GENERIC 内核添加了多路径 SCSI 驱动程序——那么正在该功能上工作的开发者可能会对您关于该功能的错误报告感兴趣。

如果您在用 GENERIC 内核启动的相同系统上重现了该问题，OpenBSD 团队肯定会感兴趣。将您的问题报告为发生在 GENERIC 内核上，并且仅包括 GENERIC 的调试输出，而不是自定义内核的。如果您设法识别、调试并创建了一个自定义内核问题的补丁，请将补丁和问题描述发送到邮件列表。您的问题可能是由于运行自定义内核引起的，但您也可能发现了一个可能在 GENERIC 中触发的错误。

但最重要的是，如果您在运行自定义内核时遇到问题，请重新启动到 GENERIC 并继续您的一天。

## 准备自定义内核

在自定义内核之前，请通过将 */bsd* 复制到 */bsd.GENERIC* 来备份您系统上已知的良好状态的 GENERIC 内核。这样，如果您的自定义内核无法启动，您可以通过启动备份内核来恢复。

您需要内核源代码才能构建自定义内核。您可以从 OpenBSD 安装介质中获取 *sys.tar.gz*。如果您从互联网镜像安装，请确保获取您版本 OpenBSD 的源代码。OpenBSD 镜像根目录通常包含相当最近的源代码快照，但请检查您发布版本的目录以获取其源代码。在 */usr/src* 下展开此目录。

```
# **cd /usr/src**
# **tar -xzvpf sys.tar.gz**
```

现在你有了备份（你*确实*在我告诉你的时候备份了你的工作内核，对吧？）和源代码，让我们看看内核配置。

## 内核配置

你通过文本文件来配置 OpenBSD 内核。像 4.4BSD 一样，OpenBSD 不提供花哨的图形内核配置工具或菜单驱动系统。每个内核配置都在一行上，包括一个标签，指示条目的类型和描述。井号（`#`）标记注释。

### 配置条目

内核配置条目分为四个一般类别：选项、设备驱动程序、伪设备和关键字。

#### 选项

*选项* 是与硬件无关的内核功能。选项处理诸如文件系统、网络协议和兼容层等问题。

选项条目看起来是这样的：

```
option     FFS         # UFS
option     INET        # IP + ICMP + TCP + UDP
option     CRYPTO      # Cryptographic framework
```

要了解更多关于选项的信息，请阅读 `options(4)` 手册页。

#### 设备驱动程序

设备驱动程序为内核提供与硬件交互所需的软件。如果你想让你的内核支持某块硬件，它必须包含适当的设备驱动程序。

设备驱动程序内核配置条目可能相当长。它们可能包括标志或设置，告诉内核在哪里找到设备以及如何初始化它。（ISA 卡通常有硬编码的 IRQ 和/或内存地址。）

设备驱动程序没有共同的标签，但它们的条目以设备名称开头。

```
mainbus0 at root
cpu0     at mainbus?
fxp*     at pci?                         # EtherExpress 10/100B ethernet
wd*      at wdc? flags 0x0000
ec0      at isa? port 0x250 iomem 0xd8000 irq 9  # 3C503 ethernet
```

#### 伪设备

*伪设备* 的行为与设备非常相似，但没有任何真实硬件与之相连。伪设备通常是抽象的，可以像真实硬件一样打开、读取、写入和关闭。

例如，回环接口是一个用于连接本地机器的网络连接的伪设备。（你的计算机没有回环网络卡，但回环接口的行为就像一个具有不寻常 MTU 值的真实网络卡。）

伪设备用 `pseudo-device` 标记。

```
pseudo-device   loop    # network loopback
pseudo-device   pf      # packet filter
pseudo-device   gre     # GRE encapsulation interface
```

#### 关键字

最后，一些其他的关键字只出现一次或很少出现。这些一次性更改会影响内核的运行方式或构建方式，难以归类。以下关键字可能会出现：

+   `machine` 关键字告诉内核它应该在哪种架构上运行。

+   `makeoptions` 关键字告诉编译器如何构建内核。

+   `include` 关键字表示引入另一个配置文件。

+   `maxusers` 值设置了一些内核表中的大小。

你会发现更不常见的关键字散布在不同的内核配置中。

```
machine         amd64
makeoptions     DEBUG="-g"  # compile full symbol table
include         "../../../conf/GENERIC"
maxusers        80          # estimated number of users
```

所有这些都会以截然不同的方式影响内核。你会在任何内核中找到这些关键字，即使是 GENERIC。

### 配置 GENERIC

让我们看看实际的内核配置。OpenBSD 将内核配置分为机器无关和机器相关文件。

#### 机器无关配置

机器无关的内核配置文件位于*/usr/src/sys/conf*。文件*/usr/src/sys/conf/GENERIC*包含机器无关的内核配置，它描述了 OpenBSD 在所有硬件平台上支持的所有功能。每个 GENERIC 内核都包含这个文件中的配置。如果你更改此文件，它将影响包含此文件的每个构建的内核。

机器无关的配置文件不包含设备驱动程序；相反，设备与特定硬件相关联。此文件不会包含任何特殊的构建指令，因为它们因平台而异。它也不会包括硬编码的系统限制、数据结构大小等，因为运行在 25 年前 VAX 上的 OpenBSD 与全新的 amd64 系统相比资源要少得多。*/usr/src/sys/conf/GENERIC*文件主要包含选项和伪设备。每个 OpenBSD 内核都必须支持文件系统，否则它将无法写入磁盘或类似磁盘的设备。

基于此文件的内核尚不知道文件系统将在哪种硬件上运行，但它知道如何创建文件系统。它不知道将有什么样的网卡，但一旦你给它一个网卡，它就可以创建 TCP 数据流并为你提供网页服务。你需要机器相关的配置来制作一个能在现实世界中运行的内核。

#### 机器相关配置

每个平台在*/usr/src/sys/arch*下都有自己的机器相关内核目录。在这里，你可以找到 OpenBSD 支持的每个平台的子目录，以及任何开发中的平台的目录。单独的目录包含特定平台的代码，以及用于内核配置文件的进一步的*conf*子目录。

我以 amd64 为例，因此内核配置目录是*/usr/src/sys/arch/amd64/conf*。虽然我们将关注常见的 i386 和 amd64 架构，但内核构建过程在所有硬件平台上都是相同的。

传统的内核配置文件名全部为大写字母。你会看到*GENERIC*配置，以及用于安装盘的*RAMDISK**文件。（*GENERIC.MP*内核是多处理器内核。）我们将从*GENERIC*内核配置文件开始：

```
machine         amd64
include         "../../../conf/GENERIC"
```

这个内核配置文件中的第一个条目定义了机器。机器定义告诉内核配置解析器你正在运行哪种硬件，并定义核心硬件特性和约束，例如整数的位数和系统可以支持的内存量。

第二个条目引入了机器无关的内核配置（在上一节中描述），定义了所有使 OpenBSD 成为 OpenBSD 的协议和工具。amd64 内核从这一条目继承了文件系统和网络堆栈。

在这两行之后，您将看到 OpenBSD 在 amd64 硬件上支持的设备。花点时间浏览一下文件。它包含的设备和附件与本章前面描述的相同。

### 您的内核配置

为了构建您自己的内核，您需要一个配置文件。在这里，我们将探讨如何创建配置文件。（不要只是编辑任一 GENERIC 内核文件。）

#### 小幅修改

如果您的内核只向 GENERIC 内核添加了几个项目，请将 GENERIC 配置作为您新配置的基础。例如，以下是多处理器内核配置，GENERIC.MP：

```
 include  "arch/amd64/conf/GENERIC"
option          MULTIPROCESSOR  # Multiple processor support
cpu*            at mainbus?
```

多处理器内核基于 GENERIC 构建，只添加了一个选项和一个设备附件。您可以使用这个模型来定义自己的内核配置。

例如，假设您想在内核中启用实验性的 SCSI 多路径功能。您可以在平台目录中创建一个内核配置文件，并简单地复制从机器无关的 GENERIC 内核中注释掉的 multipathing 条目，如下所示：

```
include    "arch/amd64/conf/GENERIC"
mpath0     at root
scsibus*   at mpath?
```

这将创建一个与 GENERIC 非常相似的定制内核，增加了这两个额外的设备。

#### 移除选项

要从内核中移除选项，请使用`rmoption`关键字。例如，要创建一个基于 GENERIC 的最小内核，您可以使用`rmoption`关键字来移除一些内核选项，如下例所示：

```
include "arch/amd64/conf/GENERIC"
rmoption    NTFS
rmoption    HIBERNATE
…
```

通过包含默认内核来创建配置的一个优点是，当您更新源代码时，您的自定义内核配置可能仍然有效。然而，您从内核中移除的选项越多，内核编译失败的可能性就越大，或者即使编译成功，它可能无法启动。如果启动了，它可能会损坏您的硬盘。

在移除选项时，请记住，一些选项可能比您想象的更重要。例如，移除`INET6`选项（即 IPv6）可能会创建一个无法正常工作的系统。移除选项并不会节省您多少内存，而且可能会损害许多程序。

#### 移除设备

如果您想从机器相关的内核配置中移除大量内容，同时保留基础 OpenBSD 功能选项，请将机器相关的 GENERIC 配置文件复制到一个新的文本文件中，并在该文件中进行修改。

#### 大规模修改

如果您想对内核进行大规模的修改，您需要一个包含机器无关和机器相关部分的配置。首先，将现有的 GENERIC 内核配置复制到一个文件中，在平台的内核配置中。在这里，我将我的新内核命名为 TREBLE，以主机名命名：

```
# **cd /usr/src/sys/arch/amd64/conf**
# **cp ../../../conf/GENERIC TREBLE**
# **cat GENERIC >> TREBLE**
```

在进行任何其他更改之前，请删除包含机器无关内核配置文件的行。然后移除使系统功能的一切，并尝试构建新的内核。接下来，逐步添加内容，直到内核构建成功。（尽管移除驱动程序不会节省多少内存，但这样做会使启动稍微快一点。）

### 注意

你可能会想使用手册页从头开始创建自己的内核配置。如果你是内核之王或不可救药的傻瓜，你当然可以这样做。请随意尝试。每个系统管理员都可以从这样宝贵的谦卑课程中受益。

#### 内核瘦身

内核中的每个设备驱动程序和选项都使用内存。如果你试图将 OpenBSD 塞入一个小型计算机，或者你正在进行任何类型的嵌入式开发，你可能想构建一个自定义内核，通过编辑`/var/run/dmesg.boot`来包含尽可能少的设备驱动程序，其中每个条目都与内核配置中的一行匹配。

删除不必要的设备驱动程序的最简单方法是删除计算机中不存在的所有内容。内核包括数十个网络卡驱动程序，但你只需要一个或两个。如果你不确定一个设备，请将其保留在配置中。（特别是 ACPI 和 BIOS 设备与它们紧密相关，没有完整的 ACPI 和 BIOS 设备集，你可能会发现构建可启动的自定义内核非常困难。）

#### 内核剖析

如果你删除设备驱动程序后没有为你创建足够小的内核，尝试删除与机器无关的选项。然而，许多这些选项是相互依赖的，删除它们可能会创建一个无法编译的内核。如果你能编译内核，它可能无法启动，如果启动了，可能无法正确运行。

### 使用 config(8)测试你的内核配置

你的自定义内核配置内部一致吗？为了测试内核并准备编译所需的文件，请使用`config(8)`。

在内核配置目录中时，将内核配置文件名作为参数传递给`config`，如下所示：

```
# **config TREBLE**
```

如果收到任何错误信息，请阅读它们。例如，`config`可能会告诉你，在构建新内核之前需要运行`make clean`，或者你的内核配置内部不一致，无法编译。如果有问题，`config`通常会给出你出错的那一行行号。遵循`config`提供的任何建议。

以下是一些更常见的错误类型。

#### 孤儿设备

`config`失败的一个常见方式是如果你缺少另一个设备需要的设备。以下是一个例子：

```
# **config TREBLE**
TREBLE:36: cpu0 at mainbus? is orphaned
 (nothing matching mainbus? declared)
TREBLE:37: bios0 at mainbus0 is orphaned
 (no mainbus0 declared)
TREBLE:38: ioapic* at mainbus? is orphaned
 (nothing matching mainbus? declared)
TREBLE:82: pci* at mainbus0 is orphaned
 (no mainbus0 declared)
*** Stop.
```

你的配置将各种设备附加到`mainbus0`，但你的配置中没有`mainbus0`条目。包含未附加设备的内核没有意义，也无法编译。

为了解决这个问题，再次检查你的硬件。弄清楚这些设备应该如何连接到系统，并修复你的内核配置。

#### 虚假硬件

另一个常见问题是包含不存在的设备驱动程序，这会产生以下错误。

```
# **config TREBLE**
TREBLE:36: cpe0: unknown device `cpe'
*** Stop.
```

`config`会显示错误及其发生的位置。没有`cpe`设备，但有一个`cpu`设备。是我的错。

`config` 执行的错误检查并不能保证您的内核会按预期编译或运行。它捕获的唯一错误是配置内部不一致或完全错误的情况。真正的第一次测试是在您尝试实际构建配置好的内核时。

## 构建内核

如果 `config` 运行成功，您将有一个包含 makefile 和大量头文件的内核编译目录。*编译* 目录的传统位置是在平台目录下，对于 amd64 硬件，该位置是 */usr/src/sys/arch/amd64*。

编译目录包含由 `config` 处理的每个内核配置的子目录。我名为 TREBLE 的 amd64 内核位于 */usr/src/sys/arch/amd64/compile/TREBLE* 目录下，其中包含一个 makefile，以及所有包含设备和选项的头文件。

```
# **cd ../compile/TREBLE**
# **make**
```

现在是等待的时候了。如果编译成功，将创建一个名为 *bsd* 的内核文件，而不会生成任何错误信息。

### 内核构建错误

如果您的内核构建失败，您可能有一个完全可以解释的错误。首先，阅读编译提供的错误信息。大多数时候，错误信息将解释内核缺少什么。通常，您需要以某种方式更改内核配置，因为 `config` 无法捕获错误。损坏的内核编译将结束如下：

```
  ../../../../arch/amd64/pci/pci_machdep.c: In function **1**'pci_intr_map':
  ../../../../arch/amd64/pci/pci_machdep.c:641: error: **2**'PCI_INT_VIA_ISA' **undeclared** (first use in this function)
  ../../../../arch/amd64/pci/pci_machdep.c:641: error: (Each **undeclared** identifier is reported only once
**3** ../../../../arch/amd64/pci/pci_machdep.c:641: error: for each function it
  appears in.)
  *** Error code 1
**4** Stop in /usr/src/sys/arch/amd64/compile/ENVY (line 89 of /usr/share/mk/sys.mk).
```

由于缺少某些内容，这个内核无法构建。当构建失败并显示“未声明”之类的语句（如粗体所示）时，这是一个提示，表明内核缺少必要的条目。

失败的位置名称可能为您提供有关缺少内容的提示。在这种情况下，在 **1**，我在编译失败的地方有一个函数名，然后是一个特定的未声明变量 **2**，它导致编译失败。

我会先找出 `pci_intr_map` 函数的来源以及它应该做什么。在源代码和手册页中搜索对缺失函数的引用。如果那样做失败，尝试邮件列表存档。确保在任何网络搜索中都包含函数和变量名称。通用输出说“有错误”**3**或“编译已停止”**4**不那么独特，因此可能有用。如果所有其他方法都失败，退回到 GENERIC 配置。

## 安装您的内核

您完成的内核是编译目录中的 *bsd* 文件。在您使用新内核之前，请确保您当前的工作内核已备份到根文件系统上的单独文件，然后将新内核复制到 */bsd*。就这样！下次您重启时，您将使用新内核。

### 注意

有些人不喜欢在确定内核能够启动之前将自定义内核复制到 */bsd* 目录。如果你是这些人中的一员，请将你的新内核以不同的名称复制到根目录下，例如 */bsd.test*。以这个备用内核启动。测试你的系统。如果一切正常，请正确安装你的新内核。

## 识别正在运行的内核

如果你构建了多个自定义内核，你可能会忘记你正在运行哪个内核。`uname(1)` 命令会告诉你用于构建正在运行内核的内核配置文件的名称。`-v` 标志会告诉你你的内核配置名称以及你编译它的次数。

```
# **uname -v**
GENERIC.MP#348
```

这个输出并不意味着我已经构建了一个多处理器 GENERIC 内核 348 次。我使用 GENERIC 内核，并让 OpenBSD 发布工程师为我构建内核。他们已经构建了 348 个官方快照多处理器内核，而没有清除内核构建目录。记住，构建自定义内核是为高级程序员和不知情的新手准备的。我既不是前者也不是后者。
