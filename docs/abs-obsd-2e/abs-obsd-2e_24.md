## 附录 A. 后记

*失败已经够糟糕的了；*

*再加上人为因素*

*事情真的很糟糕。*

大约在 2000 年左右，我的雇主的主要业务是设计网络应用程序，但一旦这些应用程序建成，我们的客户就会转过来问，“我们应该在哪里托管这个？”这就是我的工作，为定制应用程序构建和运行一个小型但专业级的数据中心。

就像任何新的商业一样，我们的托管业务需要充分利用现有资源。硬件严格限制为来自网络开发者的废弃设备，我们只使用免费软件。唯一的主要开支是一台知名的商业防火墙，购买的原因更多是出于营销而非技术。

使用大量开源软件，我们构建了一个可靠的网络管理系统，为我们客户提供比他们内部人员所能提供的更多设备洞察。客户支付自己的硬件费用，因此拥有他们选择的、配备有应用程序、平台和操作系统的昂贵高端机架服务器。随着业务的增长，我们升级了硬件（拥有五年以下的硬盘驱动器真是太好了），但我们没有看到更换软件的必要。

一周一早，一位预期使用很少带宽的客户发现，他的请求足以消耗掉整个数据中心带宽的两倍。这影响了每一位客户。如果你的每月 9.95 美元的网页运行缓慢，你没什么好抱怨的；如果你的每月 50,000 美元的网络应用程序运行缓慢，你会拿起电话大喊大叫，直到问题解决。

更糟糕的是，我的祖母几天前去世了。参观是在星期二，葬礼是在星期三早上。我把问题交给了一个小弟，说，“这里，处理一下这个问题。”我知道网络可以在许多点管理带宽。网络服务器本身、它们前面的负载均衡器、商用防火墙，甚至路由器都声称有流量管理能力。

星期二，在参观之后，我的手机语音信箱满了。我们版本的互联网信息服务器（IIS）可以管理带宽——以 8MB 的增量，但仅限于静态 HTML 和 JPEG 文件。在负载均衡器后面的几个网络服务器，这几乎是无用且可笑的。如果购买新的功能集，负载均衡器*会*支持流量整形。如果我们放下信用卡，我们可以在下周日之前安装那个功能集。我们知名的商用防火墙也提供了流量整形功能，*如果*我们升级我们的服务级别并支付额外的（相当可观的）费用来获取该功能集。这留下了路由器，我之前已经调查过，发现只需升级 IOS 即可支持流量整形。

我一直打电话到周二晚上午夜，安排在周三晚上进行紧急路由器 IOS 升级。我计划周三早上参加葬礼，发表悼词，回家小睡一会儿，然后在午夜到达工作地点，准备迎接挑战。

不幸的是，葬礼比我预期的更戏剧化，我是在毫无睡意、眼睛模糊、身体笔直的情况下，仅靠咖啡因和肾上腺素的共同恩赐才到达办公室的。在我的电子邮件中，我发现一条笔记，几个大客户威胁说，除非问题在周四早上解决，否则他们将离开。如果我没有已经压力很大，选择一个下属解雇的可能性就会让我崩溃。（我努力训练我的下属，一旦他们被打造成型，我就不愿意替换他们。）

然而，只有简单的路由器固件升级和一些基本配置就介于我和解脱之间。可能出什么问题呢？

升级过程顺利，但当我启用流量整形功能时，路由器表现异常。在接下来的几个小时里，我发现路由器没有足够的内存同时支持所有的 BGP 数据流和流量整形功能。更糟糕的是，它不接受更多的内存。大约早上 6:00，我终于从路由器供应商那里得到了承认，他们无法帮助我。

我挂断了电话。第一个威胁要离开的客户将在早上 7:30 到达。我在过去的 48 小时内只睡了 4 个小时，大部分时间都在承受着恶魔般的情绪压力。我已经用完了自动售货机里的所有零钱，还从同事的桌子上搜刮了更多的零钱。让我到达办公室的咖啡因和肾上腺素早已消耗殆尽，而更多的剂量只是减缓了我的崩溃。我们每台设备都有支持合同，但它们都毫无用处。我投入的所有时间和我之前的团队，让我一无所获。

我让自己坐了静默两分钟，仅仅专注于呼吸，让我的头不再在我肩膀上滑动，并忽略时钟的巨大滴答声。90 分钟内能做什么——不，现在只有 88 分钟了？

我真的只有一个选择。如果它不起作用，我就会解雇某人或者申请失业救济。

早上 6:05，我开始下载 OpenBSD 安装软盘镜像，然后我抓起一台备用台式机，由于它正好在最上面，我就从众多类似的机器中选择了它。接下来的几分钟，我交替进行着敲击几个必要的安装命令和拆解那些不幸够得着的、未使用的机器，以找到两张不错的网卡。

到早上 6:33，我手里拿着两张 Intel EtherExpress 卡和一个全新的 OpenBSD 系统。我登录了足够长的时间来关闭系统，这样我就可以拧下机箱，把卡插好，然后重新启动。即使是 PF 的早期版本也包含了各种巧妙的过滤功能，但我都忽略了，转而选择了新发布的流量整形功能。到早上 6:37，我推着一辆装有显示器、键盘和我的新流量整形器的车，把它推到架子上。

然后事情变得困难起来。我没有一个额外的交换机可以处理我们的互联网带宽。路由器架子上已经挤满了东西，没有地方放置新的整形器。我花了差不多半小时才找到一根交叉线缆，而且找到的线缆只有两英尺长。当然，路由器是安装在架子顶部的。大约早上 7:10，我发现如果我把台式电脑竖放，放在一个空的运输箱上，然后把箱子放在车上，线缆刚好可以够到路由器。我把所有东西堆起来，确保它们可以到达，然后开始重新布线和重新配置子网。

我模糊地记得我的经理大约在 7:15 进来，带着紧张而平静的语气问他是否可以帮忙。如果我记得正确的话，当我疯狂地在路由器控制台打字时，我说，“是的。走开。”

早上 7:28，我们在托管区域和我们的路由器之间有一个 OpenBSD 流量整形器。所有客户端应用都可以从互联网访问。我瘫坐在椅子上，茫然地盯着墙壁。

虽然一切似乎都在正常工作，但真正的证明将在于我们受影响的网站开始其日常业务时会发生什么。我紧张地看着那个客户端的网络流量逐渐逼近表示问题的红线。流量增长到接近危险线，然后突然停止。其他客户端打电话来，很高兴他们的服务恢复了正常质量。有一个客户抱怨他的网站仍然很慢，但后来发现带宽问题掩盖了他应用程序的问题。客户说，他的网站现在运行得甚至比以前还要慢，我们提出如果他们同意付费，我们可以提供更多的带宽。

稍后，我有了两个新的路由器和新的 DS3。架子再次变得干净。那台破旧的台式机被两个配置为实时故障转移的 OpenBSD 盒子所取代，保护了我们的大名商业防火墙以及流量整形。现在，我储备了各种长度的交叉线缆。

如果我从 OpenBSD 开始，我会有一个更好的夜晚。
