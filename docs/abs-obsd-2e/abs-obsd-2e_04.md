## 第四章. 安装后设置

*首先安装，*

*现在配置软件。*

*服务器已就绪。*

![图片](img/httpatomoreillycomsourcenostarchimages1616079.png) 您已安装 OpenBSD 并重新启动到裸机系统。当然，一个最小的类 Unix 系统实际上相当无聊。虽然它是一个强大的基础，但它实际上并没有做什么。

为了让您开始，本章涵盖了您在安装 OpenBSD 后应采取的一些基本步骤，以建立一个稳固的平台，为后续工作打下基础。我们将直接进入基本任务，例如纠正时区、设置默认网关以及为 root 账户设置电子邮件别名。

但有一点预先警告：当系统运行时，您可以更改 OpenBSD 的许多配置。您可以重新配置主机名、网络配置以及日期和时间，还可以根据需要停止、启动或重置守护进程。但仅仅因为您可以这样做，并不意味着您应该这样做。

当在台式机或笔记本电脑上随意玩耍时可能没问题，但如果您在运行服务器，您应该通过重新启动来测试您的配置。在添加服务之前，请确保系统正好按预期启动。如果您发现 OpenBSD 启动良好，但必须在它工作之前戳一下网卡，请在继续之前修复它。

### 注意

`afterboot(8)` 手册页为刚刚安装了第一个 OpenBSD 系统的系统管理员提供了最新的建议。其中许多建议与本书中我们将要涵盖的材料重叠（我相信会以更加令人兴奋的方式），而其中一些则仅适用于特定的用例。请阅读您系统上的 `afterboot` 文档，以获取最新的信息。

本章中的所有任务都必须以 root 身份执行。我们将在第六章（第六章. 用户管理）中讨论创建额外用户的方法，在第七章（第七章. Root，以及如何避免它）中讨论避免使用 root 账户的方法，但在新安装的系统上您不需要这样做。在开始让用户登录之前，请正确配置系统，否则您会后悔的。^([[10)]

## 第一步

在安装新系统后，您应该做的第一件事是检查任何操作系统补丁或勘误表，并更改 root 管理员密码。这些步骤至关重要，所以不要跳过它们。

### 检查系统勘误表

信不信由你，OpenBSD 并不是完美的。版本有时会有错误。其中一些是严重的问题；而另一些则不那么严重。

当 OpenBSD 团队发现某个版本存在严重问题时，它会发布勘误表，并且每次您构建一个新的服务器时，都应该检查勘误表，网址为 *[`www.OpenBSD.org/errata.html`](http://www.OpenBSD.org/errata.html)*。关键勘误表也会在 *security-announce@OpenBSD.org* 上宣布，所以如果您在这个邮件列表中，您将收到新勘误表的通知。您也会在 *[`www.undeadly.org/`](http://www.undeadly.org/)* 上看到勘误通知。

勘误表不一定会影响您的使用情况。例如，当我写这篇文章时，OpenBSD 5.0 有一个勘误通知：BIND 命名服务器的一个问题。如果这个服务器不能运行 BIND，请不要担心这个勘误。如果您正在构建一个名称服务器，那么在进入生产之前，您需要这个信息。

如果您有疑问，请按照勘误表中的建议修复您的系统，这可能需要从源代码构建 OpenBSD 的一或多个部分。（我将在第二十章中详细讨论勘误和构建 OpenBSD。）

### 设置根密码

在安装过程中，您需要选择一个根密码。要更改它，请使用 `passwd(1)` 命令。当然，您必须是 root 用户才能更改 root 的密码。

## 软件配置

当 OpenBSD 内核完成其初始系统设置并将系统控制权交给用户空间时，`init(8)` 将运行 */etc/rc* 脚本。此脚本启动所有与系统集成的程序，并执行一般系统配置，例如配置网络接口和启动服务器软件。要启用、禁用或配置集成软件，请修改 */etc/rc.conf* 和 */etc/rc.conf.local* 文件。（我将在第五章中详细介绍 OpenBSD 的启动过程，但现在，本节将帮助您入门。）

文件 *rc.conf* 和 *rc.conf.local* 包含控制 */etc/rc* 运行和各个程序的命令行选项的 shell 脚本变量赋值。请记住，*rc.conf.local* 中的任何条目都将覆盖 *rc.conf* 语句。大多数变量赋值有三个合法值：大写 `NO`、引号内的命令行标志（`"-D"`）或双引号（`""`），它们等同于空。每个变量看起来都像 *rc.conf* 中的这个条目：

```
ntpd_flags=NO           # for normal use: ""
```

变量 `ntpd_flags` 控制在启动 `ntpd(8)` 时 */etc/rc* 使用的命令行标志。

`NO` 禁用这个特定的功能。在上面的例子中，NTP 守护进程 `ntpd(8)` 被禁用。

如果变量为空，*/etc/rc* 将不带任何命令行参数启动程序。例如，这个 `ntpd_flags` 条目意味着 `ntpd` 将不带任何参数启动。

```
ntpd_flags=""
```

引号内的任何内容都用作程序的命令行参数。（如果一个程序有典型的默认标志，它们通常会出现在 *rc.conf* 中。）以下示例将变量 `ntpd_flags` 赋值为 `-s`。当系统启动时，而不是运行 `ntpd`，它将运行 `ntpd -s`：

```
ntpd_flags=**"-s"**
```

一些变量有额外的可能值。例如，PF 数据包过滤器（见第二十一章` 确保时区已正确设置：

```
# **ln -fs /usr/share/zoneinfo/Asia/Omsk /etc/localtime**
# **date**
Thu Mar 14 06:02:56 OMST 2013
```

OpenBSD 还支持在 */usr/share/zoneinfo/Etc* 中找到的 POSIX 时区。POSIX 时区有自己的规则。除非你绝对确定你理解它们，否则不要使用它们。（提示：你可能不懂。）

### 设置日期和时间

现在你已经设置了时区，请设置正确的时间和日期。OpenBSD 包含 OpenNTPD，这是一个 BSD 许可的简化版 NTP 守护进程。如果可能的话，请使用 `ntpd(8)` 来管理时间。如果你无法访问 NTP 服务器（例如，如果你在一个没有它们的私有网络上），请设置自己的服务器。如果你无法设置时间服务器，请手动设置系统时间。

#### 使用 ntpd(8) 设置时间

在 */etc/ntpd.conf* 中配置 OpenNTPD。如果你管理过其他任何 NTP 守护进程，语法应该对你来说很熟悉。

对于基本时间，你需要时间服务器，理想情况下是三个或更多。如果你没有本地时间服务器，请使用公开可访问的时间服务器，例如在 *[`pool.ntp.org/`](http://pool.ntp.org/)* 可用的主机。

在 */etc/ntpd.conf* 中列出你的服务器：

```
servers pool.ntp.org
```

然后在 */etc/rc.conf.local* 中启用 `ntpd`:

```
ntpd_flags=
```

默认情况下，`ntpd` 通过偏移系统时钟缓慢调整系统时间。如果系统时间偏差几秒钟，缓慢调整通常足够，但如果偏差几分钟或更多，让 `ntpd` 在启动时纠正系统时间，然后根据需要调整时间。要启用启动时的时间校正，请使用 `-s` 标志：

```
ntpd_flags="-s"
```

在使用频率高、硬件质量差和虚拟机上，时间偏移最严重。

#### 手动设置日期

要手动设置日期和时间，使用 `date(1)`。首先，确保你知道当前的年份、月份、月份中的日期和时间（以 24 小时制表示）。然后使用以下格式设置日期和时间：

```
# date *YYYYmmDDhhMM*
```

例如，要将日期设置为 2013 年 2 月 3 日，时间为下午 1:17，请运行以下命令：

```
# **date 201302031317**
Sun Feb  3 13:17:00 GMT 2013
```

话虽如此，`date(1)` 不会持续纠正你的时钟，在一些时钟性能较差的硬件上，时间会逐渐偏移。在负载较重的硬件上的虚拟机几乎肯定会丢失时间。使用 NTP 来处理这个问题。

## 主机名

在 */etc/myname* 中设置系统的主机名。我的测试系统名为 *caddis.blackhelicopters.org*。

```
$ **cat /etc/myname**
caddis.blackhelicopters.org
```

要更改主机名，编辑 */etc/myname*。新的主机名将在下次重启后生效。

要更改主机名直到下次启动，使用 `hostname -s` 和新的主机名，如下所示：

```
# **hostname -s treble.blackhelicopters.org**
# **hostname**
treble.blackhelicopters.org
```

你可以编辑 */etc/myname* 并运行 `hostname -s` 来立即生效更改，并在下次启动后持久保存。

## 网络配置

如果你通过互联网安装了 OpenBSD，至少应该配置并启用一块以太网卡。但如果你是从 CD 安装的，你不需要配置网络来安装 OpenBSD。如果你在一个网络上安装了 OpenBSD，并希望将机器移动到另一个网络，你需要在你的系统上重新配置网络。

我在网络原理方面涵盖了第十一章（第十一章。TCP/IP 概述）和配置在第十二章（第十二章。连接到网络），但这个简短的条目将把有效的网络地址附加到你的系统上，安装默认路由，并使 DNS 解析工作。如果你不确定在这里该做什么，直到你阅读了后面的章节之前不要做任何事情。

要使网络更改生效，你可以重启或者运行网络启动脚本 */etc/netstart*，如下所示：

```
# **sh /etc/netstart**
```

要仅配置一个接口，请将接口的名称作为参数传递：

```
# **sh /etc/netstart em0**
```

再次强调，如果你的系统是服务器，在宣布服务器准备就绪投入生产之前，请先重启。

### 配置以太网接口

要获取你的主机识别的所有网络接口的完整列表，请运行 `ifconfig(8)`。你应该会看到一些条目，如下所示：

```
**1** em0: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> mtu 1500
          lladdr 00:0c:29:d2:37:be
          priority: 0
          groups: egress
          media: Ethernet autoselect (1000baseT full-duplex,master)
          status: active
**2**         inet 192.0.2.36 netmask 0xffffffe0 broadcast 192.0.2.63
          inet6 fe80::20c:29ff:fed2:37be%em0 prefixlen 64 scopeid 0x1
```

每个 OpenBSD 系统都自带默认接口 `lo0`（环回）、`enc0`（封装接口）和 `pflog0`（PF 日志，在第二十一章中讨论）。这些是虚拟接口，实际上并没有将你的系统连接到本地以太网。其他接口将是物理网络端口，例如在**1**处的以太网接口 `em0`。

每块以太网卡都有自己的配置文件，*/etc/hostname* .interfacename。示例中的 `em0` 接口在文件 */etc/hostname.em0* 中配置。如果该文件不存在，则需要创建它。

在**2**处，你可以看到 IP 地址。静态 IP 地址的格式取决于使用的 IP 版本。

#### 静态 IP 地址

对于 IP 版本 4（IPv4）地址，常见的格式如下：

```
inet *ipaddress netmask broadcastaddress options*
```

此格式包括以下元素：

+   `inet`关键字表示这是一个 IPv4 地址。

+   IP 地址（*`ipaddress`*）以标准点分十进制表示法出现。

+   *`netmask`*可以以点分十进制格式（255.255.255.224）或十六进制（0xffffffe0）出现。

+   广播地址（*`broadcastaddress`*）允许您在此网络上硬编码广播地址。如果您留空或使用单词`NONE`，OpenBSD 将根据之前给出的 IP 地址和子网掩码计算正确的广播地址。如果您使用`ifconfig(8)`选项，必须使用单词`NONE`来提供间隔。（您也可以在 IP 地址后直接提供子网掩码，例如`192.0.2.2/24`。）

+   *`options`*空间是放置任何特定`ifconfig(8)`命令的地方，例如硬编码速度或双工。请参阅第十一章和第十二章中的示例，以及`hostname.if(5)`手册页以获取详细信息。

当与 IPv6（IP 版本 6）地址一起工作时，格式如下：

```
inet6 *address prefixlength options*
```

此格式包括以下元素：

+   `inet6`关键字告诉系统这是一个 IPv6 地址。

+   *`address`*空间用于 IPv6 地址，不带前缀长度。

+   前缀长度（*`prefixlength`*）单独出现，不带斜杠。

+   与 IPv4 一样，根据需要可以使用`ifconfig(8)` *`options`*。

即使是非常简单的配置也能使机器连接到网络。以下配置了`em0`，使用 IPv4 地址 192.0.2.2 和子网掩码 255.255.255.224。它还具有 IPv6 地址 2001:DB8:7700::2/64。

```
$ **cat /etc/hostname.em0**
inet 192.0.2.2 255.255.255.224
inet6 2001:DB8::2 64
```

任何不符合这些 IPv4 和 IPv6 格式的条目都将直接传递给`ifconfig`。但是，如果您不确定特定的配置是否有效，请首先在命令行中尝试。

#### 动态配置

在执行动态配置时，如果该机器是 IPv4 DHCP 客户端，请在*hostname.if*中使用字符串`dhcp`。对于 IPv6 自动配置，使用字符串`rtsol`，单独占一行，以告知 OpenBSD 使用`rtsol(8)` IPv6 自动配置程序。

```
$ **cat /etc/hostname.em0**
dhcp
rtsol
```

为了使 IPv6 自动配置工作，您必须使用以下两个条目在*/etc/sysctl.conf*中禁用 IPv6 路由：

```
net.inet6.ip6.forwarding=0
net.inet6.ip6.accept_rtadv=1
```

这些值已经存在于*/etc/sysctl.conf*中，但已被注释掉。

### 设置默认网关

要设置 IPv4 或 IPv6 默认网关，请在*/etc/mygate*文件中将网关 IP 地址放在单独一行，文件中不包含其他条目。您可以分别为两种协议配置默认网关，每个网关占一行。更改将在您下次重启时生效，或者使用`route(8)`手动更改默认网关。以下示例设置了 IPv4 和 IPv6 的默认网关。

```
192.0.2.1
2001:DB8::1
```

动态配置需要设置默认路由。如果你的*/etc/hostname.if*文件包含动态配置语句，则不会使用*/etc/mygate*来处理该 IP 协议。

### 设置名称服务服务器

如果你想要通过主机名联系其他机器，你需要设置域名服务（DNS）服务器。

第十二章详细介绍了 DNS 解析，但*/etc/resolv.conf*包含了基本的客户端设置。其第一行使用`domain`关键字和域名定义了本地域名。名称服务器出现在随后的行中，使用`nameserver`关键字和 IP 地址定义，如下所示：

```
domain blackhelicopters.org
nameserver 192.0.2.1
nameserver 192.0.2.3
```

## 邮件别名和状态邮件

每个 OpenBSD 系统每天、每周和每月都会运行维护任务，并将结果以电子邮件消息的形式发送到本地 root 账户。我在第十五章中讨论了这些维护任务。如果你有超过两台服务器，你可能需要将这些电子邮件消息转发到单个中央账户。

OpenBSD 系统将发送给本地用户的电子邮件消息重定向到其他用户或远程电子邮件地址，这已在*/etc/mail/aliases*中配置。以下是一些条目：

```
…
# Basic system aliases -- these MUST be present
MAILER-DAEMON: postmaster
postmaster: root
…
```

原始接收者位于左侧，后面跟着一个冒号，然后是一个要转发消息的人员列表。如果你有多个接收者，请用逗号分隔它们。发送到本地系统 MAILER-DAEMON 的邮件将被转发到 postmaster 账户，而 postmaster 账户又会被转发到 root 账户。

你应该为 root 创建一个别名，将发送给 root 的邮件重定向到你的系统管理团队：

```
root: mwlucas@bigcompany.com, sysadminstaff@bigcompany.com
```

在更改*/etc/mail/aliases*后，运行`newaliases(8)`以更新电子邮件转发。

## 键盘映射

OpenBSD 试图猜测你的正确键盘映射。USB 键盘有声明其国家代码的机制。如果自动检测不起作用，你可以使用`kbd(8)`更改键盘布局，并在启动时使用*/etc/kbdtype*设置它。

在触摸键盘布局之前，使用`kbd`查找你的当前键盘映射。`kbd -l`列出了 OpenBSD 支持的超过 100 种键盘编码。浏览列表以找到你的支持键盘布局，或使用`grep`来减少列表。我是一个 Dvorak 用户，所以我像这样搜索：

```
# kbd -l | grep dvorak
fr.dvorak
us.dvorak
…
```

我首选的布局是`us.dvorak`。我在*/etc/kbdtype*中输入**`us.dvorak`**，并在下一次重启后，控制台应该使用 Dvorak 布局。

要立即将键盘映射设置为 Dvorak，我可以使用`kbd`：

```
# **kbd us.dvorak**
kbd: keyboard mapping set to us.dvorak
```

在第十七章中了解更多关于更改控制台的信息。

## 安装端口和源代码

如果你打算构建自己的 OpenBSD 发布版或对 OpenBSD 进行大量自定义，你需要操作系统源代码（见第十八章，第十九章，第二十章中介绍），你需要端口树。端口树和系统源代码都是特定于 OpenBSD 发布版的，如果你需要它们，在安装系统时安装它们。

端口树是存储 OpenBSD 的发布目录中的压缩文件 *ports.tar.gz*，无论是镜像站点还是 CD。所有架构共享一个端口树。将此文件下载到你的主目录，并在 */usr* 中提取它。

```
# **cd /usr/**
# **tar -xzvf $HOME/ports.tar.gz**
```

这会将端口树提取到 */usr/ports*。

系统源代码位于发布目录中的三个文件中：内核源代码 *sys.tar.gz*（见第十九章` 命令。默认的 `xdm` 设置是 `NO`，所以将其更改为空引号可以启用它。

```
xdm_flags=""
```

如果你需要一个更复杂的 `xdm` 设置，请将任何命令行参数放在引号内。

## 继续前进！

在本章提供的信息的帮助下，你应该能够将你的系统连接到本地网络，并使其至少在最小程度上便于使用。接下来，让我们看看 OpenBSD 的启动过程。

* * *

^([10]) 说“很抱歉你的重要数据时间戳错误，但我还没有设置系统时钟”大致等同于说“我不在乎你或你的数据。”如果你有这样的感觉，我不会争论，但至少要有自信告诉用户你真正的想法。
