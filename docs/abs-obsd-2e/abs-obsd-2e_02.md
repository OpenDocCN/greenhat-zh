## 第二章. 安装准备

*我 是 脚本 小子.*

*Windows is warm and tasty;*

*blowfish goes down hard.*

![](img/httpatomoreillycomsourcenostarchimages1616079.png) 安装 OpenBSD 并让机器运行起来是不够的；你希望有一个 *成功的* 安装。成功的安装意味着系统已配置为执行你打算让它做的任务。开发者的笔记本电脑与专用防火墙的要求大不相同，而专用防火墙可能看起来与 Web 服务器大相径庭。适当的规划将使你的 OpenBSD 安装快速、简单且成功。我们将花费大量时间在安装规划上。一旦你明白了你在做什么，实际的安装过程就相当简单了。许多人在 OpenBSD 上遇到的问题都源于没有理解他们众多的选择。

本章中的指南涵盖了大多数情况，但关于安装 OpenBSD 的最终决定权在发布版中包含的安装文档。例如，在 i386 系统上安装 OpenBSD 之前，请阅读您发布版的 *i386/INSTALL.i386*。

## OpenBSD 硬件

OpenBSD 支持广泛的硬件架构。一些平台，如 i386 和 amd64，有广泛的支持，它们的网页和发布说明列出了大量的支持硬件。其他平台，如 SGI，只支持非常特定的硬件型号。

OpenBSD 当前支持的硬件平台包括 i386（标准 PC）、amd64（64 位 PC 风格硬件）、sparc64（Sun 风格硬件）、SGI（硅图形）、以及其他。它还支持旧平台，如 VAX 和像 Zaurus 这样的微型计算机。我感兴趣的以下平台包括：

+   ****i386****. 过去几十年中流行的英特尔兼容计算机

+   ****amd64****. AMD 对 32 位 i386 的 64 位扩展，被英特尔作为 EM64T 实现，有时也称为 x64、x86_64 或 x86-64（这种硬件可以运行 OpenBSD 的 32 位 i386 和 64 位 amd64 版本）

+   ****sparc64****. 64 位 Sun UltraSPARC 和兼容设备

+   ****macppc****. 基于 PowerPC 的 Macintosh 计算机，从 iMac 开始，直到苹果转向 amd64 硬件

+   ****Zaurus****. Sharp Zaurus 个人数字助理（PDA）

本章涵盖了在 i386 和 amd64 平台上安装的内容。这些是大多数供应商提供的标准 32 位和 64 位 PC 系统，也是你在秘书吃午饭时最有可能在办公桌上找到的系统。它们的架构相似，安装方式完全相同。

旧系统可以很好地运行 OpenBSD。我在一个 166 MHz 处理器上运行了 OpenBSD/i386，内存为 128MB，效果相当不错。你可能有一些闲置的旧系统，它们非常适合学习 OpenBSD。

在这本书中，我假设你的设备是 PCI 总线或更新的版本。我不涵盖 EISA 硬件，或现代硬件中除了板载芯片之外的其他 ISA 硬件。如果你有一张仍然工作的 EISA SCSI 卡或网络接口卡（NIC），OpenBSD 可能支持它。我假设你仍然有原始的硬件配置软盘，并记得如何设置中断和中断请求以匹配 OpenBSD 内核所假设的。如果你不记得，就回收这张卡，并购买本世纪建造的设备。

注意，硬件必须处于工作状态。如果你的旧奔腾机因为内存损坏而经常崩溃，使用 OpenBSD 并不能解决这个问题。此外，如果硬件达到某些最低标准，OpenBSD 将非常有用。我根据自己的经验提出建议，但再次强调，文档提供了当前和最终的要求。

你可以在 *[`www.OpenBSD.org/plat.html`](http://www.OpenBSD.org/plat.html)* 找到支持的硬件平台的全列表。这个页面链接到每个硬件平台的页面，你可以获取该硬件的详细支持信息。

### 支持的硬件

好消息是 OpenBSD 支持大多数硬件。坏消息是它并不支持所有硬件。一般来说，OpenBSD 支持最常见的非专有硬件。它可能不支持最新的硬件，因为 OpenBSD 团队在新硬件发布之前很少有机会接触到硬件。几个月前的硬件支持通常比尖端硬件更好。

要验证 OpenBSD 是否支持你的硬件，请阅读你平台的发布说明，或者直接尝试一下。

### 专有硬件、二进制对象和固件

一些硬件厂商希望保持其设备的内部工作原理的秘密，这样竞争对手就不能复制他们的设计。他们通常通过两种方式隐藏其硬件设计：专有硬件和二进制对象设备驱动程序。

一些厂商不会为其硬件提供文档。厂商期望用户使用他们提供的驱动程序，并且他们只为最广泛使用的商品操作系统（如 Windows）或特定目标市场（如 Apple）提供驱动程序。没有文档，编写设备驱动程序既繁琐又困难。某些硬件在没有完整文档的情况下也能得到很好的支持，但许多硬件则不行。例如，OpenBSD 的 sparc64 平台在 Sun 发布文档之前，好几年都不支持新的 Sparc 处理器。

一些供应商不希望提供文档，但希望开源操作系统的用户购买他们的硬件。这些供应商以二进制对象或 *blob* 的形式提供其硬件的驱动程序。这听起来可能一开始是合理的，但操作系统必须将这些 blob 加载到内核中。OpenBSD 团队对此有几个反对意见。首先，代码不可用于审计。如果 blob 存在安全漏洞，或者与内核有细微的交互导致系统不稳定，开发者无法解决这个问题。blob 可能只是低效或浪费，但它可能会对其他内核子系统产生负面影响，甚至可能包含后门。最后，OpenBSD 的哲学要求所有代码都必须在严格的 BSD 许可证下。内核中的 blob 不是免费的，因此 OpenBSD 不会支持它们。

注意，固件与 *固件* 不同。固件是硬件运行所需的二进制对象，它被加载到硬件本身，而不是操作系统。你几乎可以在每个计算机组件中找到固件：CPU、主板、网络接口卡、磁盘控制器等等。固件永远不会加载到内核中；内核将固件加载到卡上。OpenBSD 团队认为这是可以接受的。固件让硬件能够向操作系统提供其文档化的接口，如果它不在磁盘上，它就会在硬件本身上。

一般而言，如果 OpenBSD 开发者拥有一块硬件、该硬件的文档以及任何对该硬件的使用需求，他们可能会实现对该硬件的支持。如果没有，那么该硬件将无法工作。在大多数情况下，不受支持的专有或 blob 驱动的硬件可以用更有效（且更便宜）的开源硬件替换。

### 处理器

处理器品牌无关紧要。OpenBSD 不关心它是否运行在英特尔、AMD、Cyrix 或任何其他兼容英特尔的处理器的 CPU 上。OpenBSD 在启动时探测 CPU，并使用它所识别的任何芯片功能。我曾在 486 类处理器上运行过非常有效的多兆比特防火墙，但你最满意的是使用 1 GHz 或更快的处理器。

然而，OpenBSD 的多处理器支持并不像某些其他操作系统那样广泛。OpenBSD 内核主要使用大巨人锁方法运行，因此内核一次只能运行在一个处理器上。（内核的一些小块代码不在大巨人锁之下。）从实际的角度来看，这意味着 OpenBSD 内核不会有效地使用超过两个处理器或核心。

这是否意味着你不应该在双八核处理器的服务器上使用 OpenBSD？这取决于你预期的服务器负载。只要用户进程不进入内核，它们就可以很好地扩展。例如，大多数网络日志分析软件几乎完全在用户空间运行，你可以运行大规模并行分析任务，这些任务可以很好地随着处理器数量的增加而扩展。然而，像转发数据包这样的任务会通过内核。你需要什么硬件完全取决于你预期的负载。

### 内存（RAM）

内存是好的。你拥有的内存越多，你会越快乐。增加 RAM 比任何其他通用改进都能加速你的系统。你应该至少有 256MB 的 RAM，最好是至少 512MB。如果你能在你的系统中获得几个 GB，OpenBSD 将充分利用这些内存。

如果你继续增加内存，你会达到一个点，你的系统拥有它需要的所有内存，更多的内存不会进一步提高性能。对于一个小型防火墙，这可能是低至 128MB，对于桌面机器，可能是几 GB，而对于大型数据库服务器，则可能更多。

大多数奇怪的崩溃和无法解释、无法重现的问题都可以追溯到不良的内存，所以请确保你使用的内存是好的。内存是旧机器中常见的故障点。

### 硬盘驱动器

你今天能买到的最小的新硬盘可以运行 OpenBSD，并且还有大量的空间。在较旧的系统中，我建议至少有 40GB 的磁盘空间——不是因为 OpenBSD 无法适应更小的空间，而是因为你需要空间来存储额外的文件和软件。你的磁盘越小，你就越需要密切监控其使用情况。当从源代码构建桌面环境时，很容易填满一个小磁盘，而现在的磁盘又很便宜。如果你是从闪存驱动器运行小型防火墙，我建议至少 512MB.^([5])

### 虚拟化

许多人在新操作系统适应期间在虚拟环境中运行它们。一些公司甚至有明确政策，要求所有系统都作为虚拟服务器运行。OpenBSD 在常见的虚拟环境中运行良好，甚至为虚拟化系统如 VMware 提供了特定的设备驱动程序。

在虚拟服务器上运行 OpenBSD 的硬件要求与在真实硬件上运行 OpenBSD 的要求相似。请注意，在虚拟环境中运行的任何操作系统都不如在同一真实硬件上运行的操作系统安全。虚拟环境并不能精确地复制真实硬件。模拟 CPU 有其自己新奇的错误，虚拟网络接口卡有独特的错误，等等。此外，提供虚拟服务器的环境本身也是一个操作系统。入侵者可以攻击那个底层操作系统，一旦入侵者控制了虚拟化服务器，运行在该机器上的客户端就更加脆弱。没有操作系统可以保护自己免受其硬件的影响。在规划 OpenBSD 在您环境中的作用时，您必须考虑这种风险。

然而，对于了解 OpenBSD 来说，虚拟环境是完全可以接受的。我在 VirtualBox、ESXi 和 Linux 的 KVM 虚拟机管理程序上轻松地运行了 OpenBSD 机器。

### 多个操作系统

多年来，我在一台计算机上运行了多个操作系统。我记得我对我的新 6GB 硬盘感到兴奋，因为我可以在一台计算机上运行 FreeBSD、OpenBSD、Windows 和 Linux，并为每个操作系统留有足够的空间。这是在单台桌面计算机上运行多个操作系统的唯一方法，但虚拟化技术的进步已经使这种方法过时。

与其小心翼翼地将您的桌面硬盘分区以运行多个操作系统，并希望某些专有磁盘分区程序不会吞噬其邻居，我建议运行一个支持虚拟化服务器的操作系统，并将您的次要操作系统作为虚拟机运行。OpenBSD 支持使用`qemu`运行虚拟客户机。

## 获取 OpenBSD

一旦您有了硬件，您就需要 OpenBSD。您可以从 CD 和互联网上获取 OpenBSD。

### 官方 CD

你为什么要在 21 世纪购买官方 CD？

OpenBSD 项目主要依靠官方 CD 的销售以及相关的书籍、服装等来资助。您可以从互联网上下载磁盘镜像并烧录自己的安装盘，但购买官方套件有助于改进 OpenBSD。OpenBSD 团队试图使官方 CD 集本身成为有趣的物品，并且通常将它们包装在某种极客主题的艺术作品中。要获取官方 CD，请访问 OpenBSD 网站并查找获取 OpenBSD 链接。您还可以找到大量与 OpenBSD 相关的商品。

您可以从互联网上下载安装镜像，但它们与官方 CD 集不同。下载的磁盘镜像不包含任何软件包，缺乏花哨的物理包装，并且只能在一种硬件架构上运行。您无法下载用于官方磁盘的镜像。

主要的 OpenBSD 分发点位于加拿大，这增加了居住在其他大陆的人的配送成本。OpenBSD 网站列出了提供官方 OpenBSD CD 的各种经销商。选择您国家的经销商可以节省关税。如果此选项对您不可用，您至少可以选择您所在大陆的经销商并节省运费。

### 互联网下载

其他 OpenBSD 安装方法需要网络访问，无论是下载完整镜像还是安装过程中下载文件。首先选择一个靠近您的 OpenBSD 镜像站点。您可以在*[`www.OpenBSD.org/ftp.html`](http://www.OpenBSD.org/ftp.html)*找到镜像的完整列表。

您可以从 ISO 镜像、FTP、HTTP、rsync，甚至在某些平台上从 Andrew 文件系统（AFS）或网络文件系统（NFS）安装操作系统文件。我们将任务分为两部分：使目标系统启动，以及将操作系统文件放置在机器上。

### 镜像站点布局

所有 OpenBSD 镜像都包含类似这些的文件和目录：

+   **5.1, 5.2, 5.3, 和 5.4**. 编号目录包含 OpenBSD 版本。大多数镜像包含最后四个版本。这个特定的服务器包含 OpenBSD 版本 5.1、5.2、5.3 和 5.4。

+   **Changelogs**. 此目录包含对 OpenBSD 并发版本系统（CVS）日志的整理，供对 OpenBSD 开发感兴趣的用户使用。普通用户可能会发现基于 Web 的 CVS 浏览器更有用。

+   **distfiles**. 此目录包含构建 OpenBSD 端口集合中包含的第三方软件所需的文件（见第十三章、基本说明 (*README*) 以及关于 OpenBSD 对第三方软件和不同硬件支持的说明

在您的 CD 或镜像站点中查找您硬件架构的目录。架构目录包含每个硬件平台相当类似的文件。

首先，找到您硬件的安装说明。这些文件以 *INSTALL* 开头，后跟平台名称（例如 *INSTALL.i386*，*INSTALL.amd64* 等）。始终阅读您平台的安装说明。虽然我已经尽最大努力确保本书的准确性，但 OpenBSD 不断变化，您发布版本的安装文档是安装说明的最终版本。

### 启动介质

OpenBSD 的启动介质因硬件平台而异，每个硬件项目都有自己的启动介质要求。您不能期望从 CD 启动 Zaurus 或 VAX。

要轻松地在 i386 或 amd64 硬件上启动 OpenBSD 安装程序，可以使用软盘或光盘（我通常推荐后者）。您可以从 USB 磁盘启动安装程序，但标准方法需要从 OpenBSD 机器引导，并且非标准方法因可用设备而异。

如果您无法从光盘启动，请使用软盘。OpenBSD 提供了一个 amd64 软盘镜像和三个不同的 i386 软盘镜像。如果您从软盘启动 i386，我建议下载所有软盘镜像。

如果您无法使用上述任何一种方法启动，您必须使用如第二十三章中所述的预启动执行环境（PXE）无盘启动方法。这种方法效果良好，但需要更多的准备。

### 选择安装介质

启动盘可以格式化您的硬盘，配置您的网络，并将安装文件复制到磁盘。然而，启动介质不包括那些安装文件。i386 和 amd64 机器的安装文件包含在 ISO 图像中，并通过 FTP 或 HTTP 在网络上提供。

如果您打算在多台 OpenBSD 机器上安装此版本，您可以下载包含安装文件的 CD 镜像。然而，它比仅启动安装的 ISO 图像大得多，因此下载它需要某种宽带连接。

如果您正在进行单个 OpenBSD 安装，或者您没有光盘驱动器，我建议使用 HTTP 安装。如果您从合理接近的镜像站点安装并且有足够的带宽，OpenBSD 通过 HTTP 安装既快又可靠，并且使用的带宽大约是下载安装 ISO 图像的一半。如果您愿意，也可以通过 FTP 安装。

高级用户可以通过 PXE 方法安装 OpenBSD，如前节所述，并在第二十三章中详细说明。

### 本地安装服务器

光盘之所以如此受欢迎，是因为您只需要从互联网下载一次文件，但可以重复使用您的下载来在多台机器上安装 OpenBSD。但是，光盘物理上很脆弱，并不是每台机器都有光盘驱动器。如果您想在多台机器上安装 OpenBSD 而不消耗每台安装的带宽，请下载您架构所需的全部安装文件。如果您将这些文件复制到本地 FTP 或 Web 服务器，您就可以从这些文件安装 OpenBSD 到任意数量的机器。要从本地 FTP 服务器安装，您需要 FTP 服务器的用户名和密码。

为了帮助节省 OpenBSD 项目在带宽成本上的开支，请只下载您需要的架构的目录。如果您确切知道您要安装什么，请只下载那些文件集。您可能不关心自己的带宽，但请尊重他人的带宽。

## 文件集

每个架构的发布目录包含几个名为 *comp52.tgz*、*base52.tgz* 等的压缩文件。这些 *文件集* 包含压缩的 OpenBSD 安装文件。通过选择安装特定的文件集，你可以选择你的 OpenBSD 系统将具有多少开箱即用的功能。例如，文档保存在单独的发行版集中。如果你在其他地方有文档，你可能选择不在特定的系统上安装它。此外，入侵者经常使用编译器，所以你可能不希望在你想保护的系统上安装它们。但如果这是你的实验性“学习 OpenBSD”机器，请安装所有内容。

每个文件集都有一个名称和版本号。例如，OpenBSD 发布 5.2 中的一个发行版集是 *base52.tgz*。这些是 5.2 版本的基文件。在下一个版本中，这个相同的文件集将被称为 *base53.tgz*。

所有架构都包含所有文件集，除非架构的发布说明中另有说明。如果你是第一次安装 OpenBSD，请花点时间决定你需要哪些发行版集。如果可能的话，在你的测试机器上安装它们。你总是可以在以后为专用目的机器缩减它们。

以下文件集可用：

> bsd, bsd.mp, **和** bsd.rd
> 
> 这些文件集仅包含 OpenBSD 内核。内核是操作系统的核心，包含设备驱动程序和基本系统功能。没有内核，系统将无法启动。*bsd* 内核适用于单处理器机器，而 *bsd.mp* 内核支持多处理器。*bsd.rd* 内核包含 OpenBSD 安装程序、基本用户空间实用程序和实时系统内核。一次只能运行一个内核。
> 
> baseXX.tgz
> 
> 这包含了 OpenBSD 的核心程序——所有使 OpenBSD 成为类 Unix 系统的东西。包括 */bin*、*/sbin*、*/usr/bin* 和 */usr/sbin* 的内容；系统库；以及你在最小化类 Unix 系统上期望找到的所有杂项程序都包含在这个文件集中。你必须安装这个文件集。
> 
> etcXX.tgz
> 
> 你可能会猜测这个文件集包含 */etc* 中的文件，但它还包含其他必需的文件和目录，例如 */var/log* 和 root 用户的家目录。你必须安装这个文件集。
> 
> manXX.tgz
> 
> 如果你需要基础和 *etc* 文件集中的程序的 man 页面，请安装这个发行版集。其他集的 man 页面将与各自的文件集一起安装。
> 
> compXX.tgz
> 
> 这个文件集包含 C 和 C++ 编译器、汇编器、库、工具、手册以及每个工具链。你需要这个文件集来开发或编译软件，或者使用端口集合（见第十三章*，被认为是 UNIX 经典，除非安装，否则老用户不会高兴。其他，如 */usr/games/wargames*，假设你熟悉 1980 年代初的电影。你可能不需要游戏文件集（除非你想看看我高中时代所谓的“电脑游戏”）。
> 
> xbaseXX.tgz
> 
> 这包含 Xenocara 的核心，即 OpenBSD 版本的 X Window 系统。如果你想使用 X，你需要这个。尽管你可能没有在这个计算机上安装控制台或显示器，但请记住，X 允许这个服务器上的程序远程显示。
> 
> 大多数 OpenBSD 软件包都假设你已经安装了这个文件集。如果你发现某个软件包因为缺少 X 库的错误而崩溃，你需要这个文件集。
> 
> xetcXX.tgz
> 
> 这包含 X 配置文件。如果你不仅使用 X 的库，还需要这个文件集。
> 
> xfontXX.tgz
> 
> 这包含 X 种字体。如果你计划在这个机器的控制台上使用 X，请安装这个文件集。
> 
> xservXX.tgz
> 
> 这个文件集包含所有 X 显卡驱动程序。如果你计划在这个机器的控制台上使用 X，请安装这个文件集。
> 
> xshareXX.tgz
> 
> 这包含 X 文档。如果你计划在这个机器的控制台上使用 X，请安装这个文件集。

## 分区

*分区* 是硬盘的逻辑子分区。OpenBSD 可以处理具有自己独特特权的不同分区。你可能将一些分区设置为只读，这样它们上的文件就不能被添加、移动或更改。

OpenBSD 可能会拒绝在指定的分区上运行程序，并且它知道设备节点应该只出现在某些分区上。用户文件不应该有 `setuid` 或 `setgid` 权限，因此操作系统不会在用户数据分区上的文件上识别这些特权。虽然许多操作系统支持这类权限控制，但 OpenBSD 默认使用它们。

安装 OpenBSD 最困难的部分是分区。当你不知道分区如何工作时，选择分区可能会很麻烦。

如果你熟悉其他类 Unix 操作系统（例如某些 Linux 发行版），你可能习惯于使用一个大的根分区并将所有内容都放在上面。这有几个原因是不好的。OpenBSD 使用分区作为一个安全工具。一个大的单一分区消除了每个分区的安全和权限。当你的日志文件安全地包含在一个分区上时，一个失控的进程或用户无法填满你的整个驱动器。虽然它可能填满一个分区，但你仍然可以在其他分区上创建和编辑文件，这为你提供了解决问题所需的灵活性。

与许多具有花哨菜单和图形工具的安装程序不同，OpenBSD 的安装程序期望你知道如何使用低级磁盘管理工具，例如`disklabel(8)`。然而，与那些操作系统不同，OpenBSD 可以在更广泛的系统上以多种方式安装，所有这些都可以使用单个安装程序。

如果你这是第一次安装 OpenBSD，请使用安装程序提供的默认分区方案。OpenBSD 将提供所有标准分区，但根据你的磁盘大小调整它们的大小。这里的讨论基于在一个相当小的磁盘上的标准 i386 安装。

如果你之前已经安装了 OpenBSD，并且你正在一个专用机器上安装它，你可能需要特殊的分区方案。在这种情况下，拿一张纸和一支铅笔，写下你的硬盘大小，你需要每个分区，以及每个分区期望的大小。你的专用 OpenBSD 机器几乎肯定会有与默认安装相同的所有分区，但它们的大小会有所不同。一个网络服务器与桌面机器的磁盘空间需求非常不同，而桌面机器的需求又与防火墙的需求不同。

如果你有一个大硬盘，留一些未分配的空间。分区的大小正好满足你的需要可以加速文件系统完整性检查；`fsck(8)`不会花费周期来检查未使用的磁盘空间。在固态硬盘中，未使用的空间为磨损均衡算法提供了更多的单元来操作，从而增加了硬盘的使用寿命并减少了故障的可能性。有备用的磁盘空间而你从未需要它们，总比需要而你却没有磁盘空间要好。

### 标准 OpenBSD 分区

标准 OpenBSD 分区包括 */*（根）、交换空间、*/tmp*、*/var*、*/usr*、*/usr/X11R6*、*/usr/local*、*/usr/src*、*/usr/obj* 和 */home*。如果你创建了一个自定义布局并且不包括这些分区之一，安装程序将把属于该分区的文件放入你的根或 */usr* 分区，从而快速填满它们。如果你想安装后创建一个分区，你必须在你磁盘上找到空间。除非你在磁盘上留下了未分配的空间，否则你最好重新安装整个系统。

#### 根分区

根分区包含主要的 OpenBSD 配置文件和将计算机带入单用户模式并连接到网络所需的最基本软件。你的系统需要快速访问根文件系统，所以如果你有多个磁盘，请将根分区放在最快的（或最小的）一个上。

根分区是唯一一个其磁盘位置至关重要的分区。多年来，i386 系统反复扩展以超越其自身限制——毕竟，它们基于的架构最初只能处理高达 640KB 的 RAM！所有现代操作系统内核都以对用户来说大部分是透明的方式绕过这些限制，但在系统首次启动时，你被硬件的限制所困。

许多旧的 i386 系统对硬盘大小有限制。它们只能识别 128GB 的硬盘、2TB 的硬盘或某些其他数字。硬件 BIOS 无法访问超过这个限制的任何内容。如果你使用的是硬盘大小限制为 128GB 的电脑，并且你将内核放在超过第一个 128GB 磁盘空间的地方，电脑将无法找到内核，因此无法启动系统。在开始之前检查你的硬件手册。如果手册提到了磁盘大小限制，你的整个根分区必须适应那个限制。

如果你违反了这个限制，你的系统可能看起来还能工作。然而，当你更改文件 */bsd* 时，你的电脑很可能会拒绝启动。通过将根分区放在磁盘的第一位，并确保它足够小以适应硬件的限制，你可以避免很多痛苦。

#### 交换空间

交换空间用于虚拟内存。当你的电脑 RAM 不足时，它开始将内存中闲置的信息移动到交换空间。当电脑需要这些信息时，它们从虚拟内存加载到实际内存中。这并不一定对性能有害。许多程序的大部分时间只执行它们代码的一小部分。OpenBSD 在确定哪些内存部分可以移动到交换空间以及哪些使用频率过高而不适合交换方面做得相当不错。如果一切顺利，你的电脑几乎永远不会需要交换空间。

OpenBSD 还在系统故障期间使用交换空间。如果内核崩溃，电脑会将系统内存的内容写入交换分区。这意味着交换分区至少要稍微大于系统中的物理 RAM 量。

你需要多少交换空间？简短的回答是，“这取决于系统。”OpenBSD 默认分配的交换空间是你物理 RAM 的两倍。只要你知道这是一个非常通用的规则，这并不是一个坏规则。物理内存的三到四倍大小的交换空间不会有害。如果你的电脑使用的交换空间超过这个量，它就过载了，并且性能会下降。

如果你发现自己经常使用交换空间，考虑增加你的物理内存。RAM 很便宜。

也考虑未来的升级。当你安装 OpenBSD 时，如果你的系统有 2GB 的 RAM，但打算增加到 8GB，分配 16GB 的交换空间是个好主意。除非你在安装软件时留下未分配的磁盘空间，否则以后添加交换分区是困难的。（注意，虽然你可以将交换空间设置为一个文件，但 OpenBSD 只能将崩溃转储写入实际的交换分区。）

#### /tmp 目录

*/tmp* 目录是系统上所有用户的临时空间。*/tmp*的空间需求通常是个人观点的问题——毕竟，你总是可以在你的*/home*目录中使用一块空间作为临时空间。自动软件安装程序通常会提取文件到*/tmp*。我通常建议至少 3GB 的*/tmp*空间，但我对我的临时空间做了很多糟糕的事情。许多人使用 256MB 或 512MB 的*/tmp*目录并且过得很好。

#### /var 分区

*/var* 分区包含经常变化的数据，如日志、数据库、邮件队列、临时运行文件、网站等。OpenBSD 默认为*/var*分配大约 5GB 的空间。这对于教育安装来说应该足够了。然而，如果你正在构建一个网站、数据库或日志服务器，那么*/var*应该获得你大部分的磁盘空间。如果你在一个非常小的系统上，你甚至可以为*/var*使用 10MB 的空间。

#### /usr 分区

*/usr* 分区包含操作系统程序、编译器、库和附加程序。*/usr*的大部分变化只在你升级系统时发生。OpenBSD 默认为*/usr*分配 2GB 的空间，这在桌面系统上已经足够了。

#### /usr/X11R6 分区

*/usr/X11R6* 分区包含 X 窗口系统的程序和文档。OpenBSD 为链接到 X 窗口系统的软件打包，而且许多你可能在服务器上期望找到的软件（如 ImageMagick）需要 X 库。

如果你打算不安装任何 X 软件，并且计划完全使用自己的软件而不使用 X，那么你不需要这个分区。如果你有疑问，或者这是你的第一次安装，请保留这个分区。

#### /usr/local 分区

*/usr/local* 分区包含附加的 OpenBSD 软件，通常来自软件包（参见第十三章）。这个分区可能比包含核心 OpenBSD 软件的*/usr*分区大得多。OpenBSD 默认为*/usr/local*分配 5GB 的磁盘空间，我从未需要超过这个量。

#### /usr/src 分区

*/usr/src* 分区专门用于 OpenBSD 源代码。在一个没有编译器的专用机器上，如防火墙或安全的 Web 服务器，你可能不需要本地源代码副本。如果你不打算从源代码升级这台机器，也不打算在本地机器上使用源代码作为参考，那么你不需要这个分区。如果你有疑问，请保留它。

#### /usr/obj 分区

*/usr/obj* 分区是 OpenBSD 构建操作系统和 Xenocara 新版本的地方。这里的文件是临时的；一旦你安装了新的 OpenBSD 版本，你就不需要这些文件了。创建新的文件系统比删除这种文件系统中的单个文件要快，所以*/usr/obj*被配置为独立的分区。

如果你没有打算从源代码构建新的 OpenBSD，你不需要*/usr/obj*。如果你后来发现你需要这个分区，你可以从未使用的空间创建它，或者通过 NFS 挂载它。

#### /home 分区

*/home* 分区可以描述为“其他所有东西”。用户目录放入*/home*，以及任何为用户准备的数据。家庭 MP3 和照片收藏应该放在*/home*，以及你的个人源代码、电子邮件和任何你想要保留的东西。

### 创建其他分区

OpenBSD 支持每个磁盘最多 16 个分区。如果你想创建其他分区，你可以使用安装程序。你的公司是否有政策要求所有附加软件都必须放在*/opt*或*/usr/companyname*？好的，创建那个分区。OpenBSD 的标准不是紧身衣，而是一个起点。你拥有系统。让它按照你的需求运行。

## 分区文件系统

“文件系统”和“分区”这两个词经常被互换使用。它们密切相关，但却是两件不同的事情。文件系统是一种在分区上分配和跟踪文件的方法。你可以备份和恢复文件系统，但如果分区损坏，你会遇到更大的麻烦。

OpenBSD 默认使用标准的快速文件系统（FFS）。FFS 已经存在了几十年，调试得很好，理解得也很透彻。不幸的是，使用默认设置，它只能处理略小于 1TB 大小的分区。现代硬盘使这种大小的分区变得很常见。

如果分区大小为 1TB 或更大，安装程序会自动使用 FFS 版本 2（FFS2）格式化它。在第八章中，我们将介绍如何调整你的文件系统以完全满足你的需求。

## 多块硬盘

磁盘输入/输出通常是计算机最慢的部分。如果你有多块硬盘，你可以使用这些硬盘来加速你的系统性能。

首先，确保每个驱动器都在自己的端口上。SCSI 和 SATA 驱动器通常每个端口一个驱动器（除非你特别使用端口多路复用器），但 IDE 驱动器通常每个端口连接两个设备。每个端口都有最大吞吐量。将两个快速驱动器连接到一个端口上是没有用的，因为驱动器会竞争一个端口的吞吐量。

通常，当您有多个驱动器时，您希望在驱动器之间分配读写活动。我通常将我提供的数据放在一个磁盘上，而将重要的系统文件放在另一个磁盘上。如果我在构建数据库服务器，我可能会将一个磁盘用于交换空间和 */var*，而将所有其他分区分配给另一个磁盘。

在驱动器之间分配您的交换空间。请确保至少有一个分区的大小足够容纳您的物理 RAM，这样 OpenBSD 在需要时可以进行崩溃转储。OpenBSD 无法在两个不同的交换分区之间分割崩溃转储。

如果您是更资深的 OpenBSD 用户，您可以使用多个硬盘创建一个具有软件 RAID 的冗余磁盘。我们将在 第九章 中介绍如何做到这一点。

如果您的第二块驱动器比主系统驱动器慢得多，那么使用它就没有意义。计算机的运行速度仅与其最慢的组件相同，因此将那个旧的 IDE 驱动器添加到您的 SATA 系统中将会拖慢整个机器。这不仅会降低整个系统的性能，而且它可能比您的主驱动器更老，并且更有可能发生故障。

## 理解分区

作为历史偶然，i386 和 amd64 系统有两种不同类型的分区。OpenBSD 将第一种称为 *MBR 分区*，第二种称为 *disklabel 分区*（或简称 *分区*）。

### MBR 分区

MBR 分区，也称为 *主分区*，是运行在 i386 硬件上的操作系统普遍理解的。每个硬盘都有四个 MBR 分区。在大多数情况下，只有一个分区分配了空间；其他三个分区的大小为零。如果您想在单个磁盘上安装多个操作系统，那么每个操作系统都需要自己的 MBR 分区。

大多数操作系统使用名为 *fdisk* 的程序来管理 MBR 分区。请注意，这并不是同一个程序——OpenBSD 的 `fdisk(8)` 与 Microsoft 的 Fdisk 不同，后者与 Linux、FreeBSD、OpenSolaris 等程序也不同。任何操作系统的 fdisk 都可以查看属于其他操作系统的 MBR 分区，尽管它们可能无法识别 MBR 分区上的内容，但它们会识别出为 *某种东西* 分配了空间，并会警告您不要覆盖它。不幸的是，并非所有 fdisk 程序都能很好地协同工作。不要使用另一个操作系统的工具来为某个操作系统分区磁盘.^([6])

随着廉价虚拟化的出现，在单个磁盘上安装多个操作系统已不再建议。为每个磁盘分配一个单一的 MBR 分区，使其填满整个磁盘，并将其他三个 MBR 分区的大小设为零。您可以在 第三章 中看到一个如何操作的例子。

### Disklabel 分区

BSD 并非起源于 i386 硬件；它拥有自己的磁盘分区系统，该系统基于对磁盘分区的标记。当 BSD 被移植到 i386 时，磁盘标签被固定在 MBR 分区内部。当有人在 OpenBSD 中提到“分区”时，他们几乎肯定是指磁盘标签分区。

一个磁盘标签可以支持 16 个分区。如果你需要超过 16 个分区，你必须创建第二个 MBR 分区并添加更多的磁盘标签。我建议，如果你需要在单个磁盘上超过 16 个分区，你在决策过程中可能走错了方向。退一步，重新评估你想要实现的目标以及你正在如何进行。

外部操作系统无法识别 OpenBSD 磁盘标签。基于 BSD 的操作系统可能看似能理解它们，但过去 20 年中，各种基于 BSD 的系统所使用的磁盘标签格式已经发生了分歧。请仅使用 OpenBSD 磁盘工具来管理 OpenBSD 分区。

## 理解磁盘标签

OpenBSD 安装程序期望你理解磁盘标签。你可以通过盲目接受 OpenBSD 提供的默认分区来避免学习磁盘标签，但这不会让你走得很远。磁盘标签可能看起来令新用户感到害怕，并需要一些基本的数学知识，但一旦你慢慢走过它们，它们并不那么困难。你需要首先理解磁盘几何形状。

### 扇区和谎言

从前，磁盘驱动器有明确定义的几何形状。每个磁盘实际上都是圆形的，并在硬盘内部旋转。制造商将每个磁盘分成许多小部分，称为 *扇区*。每个扇区都有一个编号，扇区 0 位于磁盘的起始位置，扇区按顺序编号直到磁盘的末端。扇区被聚集到一起形成 *磁道*。磁道堆叠在一起形成 *柱面*。每个磁盘驱动器都有一定数量的 *磁头*——数据读取设备，当磁盘在它们下方旋转时，从磁盘读取信息。整体而言，扇区、磁道和柱面描述了磁盘的 *几何形状*。

这听起来似乎很简单，但今天你实际上不能指望磁盘扇区能映射到任何有用的东西。多年来，硬盘制造商和操作系统都设定并打破了限制。这适用于机器设计的各个方面，从 640KB 的内存限制到 504MB 的磁盘限制。硬盘制造商通过欺骗系统 BIOS 和/或操作系统来避免这些限制。

如果您是制造每磁道 126 个扇区的硬盘驱动器的硬盘制造商，但最流行的操作系统只能接受每磁道 63 个扇区，您就遇到了问题。简单的解决方案是教会您的硬盘说谎。如果您声称每磁道扇区数量减半但盘片数量加倍，数字仍然相加，您仍然可以提供唯一的扇区编号。每个硬盘制造商都会选择以略微不同的方式说谎。最明显的例子是闪存驱动器（即使它们不是圆形且不旋转，它们仍然报告磁道、扇区和磁头^([7]))和硬件 RAID（它报告有关多个磁盘的信息，就像它们是一个一样）。如果您了解硬盘的历史，您会发现各种有趣的谎言。

当磁盘几何信息到达操作系统时，它已经经过一次或多次转换。在您的脑海中寻找写着“接受你所被告知的内容”的按钮，并在重复以下内容时按下它：磁盘被划分为顺序编号的扇区。分区填充一定数量的连续扇区。扇区根据驱动器中的磁头数量分组到磁道中。分区在磁道边界处结束。

### 扇区和磁盘标签

安装程序将显示您的磁盘标签。（您也可以在系统安装并运行后查看磁盘标签，如第八章磁盘和文件系统中所述。）

我们首先查看磁盘的物理信息。虽然物理信息通常不会直接影响安装，但如果出现问题，您需要知道如何读取它。

```
**1** # /dev/rsd0c:
**2** type: SCSI
**3** disk: SCSI disk
**4** label: DSA2CW120G3
**5** duid: adb697598fa0a010
  flags:
**6** bytes/sector: 512
  sectors/track: 63
  tracks/cylinder: 255
  sectors/cylinder: 16065
  cylinders: 14593
**7** total sectors: 234441648
**8** boundstart: 64
**9** boundend: 234436545
  drivedata: 0
```

除了设备唯一标识符（DUID）外，您不能更改这些条目而不更改底层硬件。

第一条是设备名称，`/dev/rsd0c` **1**。前面的`/dev`表示这是一个设备节点。`rsd0c`是磁盘名称。`sd`表示该驱动器使用`sd(4)`设备驱动程序，而`0`表示这是 OpenBSD 找到并附加的第一个驱动器。（这通常是，但不总是 BIOS 驱动器 0。）前面的`r`表示我们以原始模式访问磁盘，而尾部的`c`表示我们正在检查磁盘标签分区*c*。磁盘标签分区*c*始终与包含此磁盘标签的整个 MBR 分区相匹配。几乎所有不是明确 IDE 的磁盘都可能显示为 SCSI 磁盘。

`type` **2** 是一个描述磁盘物理接口的一般标签。任何 IDE 磁盘都会显示为 ESDI（增强型小型设备接口），而 SCSI、SAS、SATA 和几乎所有其他类型的磁盘类型都是 SCSI。

`disk` 字段 **3** 显示连接到此接口的磁盘类型。在这里，它显示为 SCSI 磁盘，但我们已经从类型中知道了这一点。

`label` **4** 显示制造商的名称和/或驱动器型号。在虚拟化服务器的案例中，这显示为`虚拟驱动器`或类似内容。

`duid` **5** 是该磁盘的 DUID。如果你曾经管理过包含两个以上磁盘的系统，你就会知道混淆磁盘是多么容易的事情。硬件 BIOS 通过磁盘连接的物理端口来识别磁盘。如果你需要更换 SATA 或 SCSI 卡，并且在重新运行电缆时将磁盘搞混了，你将很难再次找到你的启动盘。通过在你的系统配置中使用 DUID 而不是 BIOS 分配的设备名称，你将始终使用相同的目的磁盘。如前所述，DUID 是磁盘标签信息顶部可编辑的字段。

每扇区字节数、每磁道扇区数、每柱面磁道数和每柱面扇区数 **6** 都描述了磁盘的几何形状。这些数字都是假的，但磁盘上的总扇区数 **7** *是* 准确的。你还可以看到你可以用 disklabel 分区填充的第一个扇区 **8**，以及你可以使用的最后一个扇区 **9**。（由于硬盘的几何变换，你会丢失一些扇区。不要试图追究硬件的责任。你无法赢得那个争论。）

下一个部分显示了 disklabel 分区，你可以根据需要修改它。以下是我桌面上的一段 disklabel：

```
  16 partitions:
  #             **1** size         **2** offset **3**fstype **4**[fsize bsize  cpg]
**5**  a:          2097121               64  4.2BSD      2048 16384    1 # /
**6**  b:          4698424          2097185    swap
**7**  c:        312581808                0  unused
   d:          8388576          6795617  4.2BSD      2048 16384    1 # /tmp
   e:         16736864         15184193  4.2BSD      2048 16384    1 # /var
   f:          4194304         31921057  4.2BSD      2048 16384    1 # /usr
   g:          2097152         36115361  4.2BSD      2048 16384    1 # /usr/X11R6
   h:         20971520         38212513  4.2BSD      2048 16384    1 # /usr/local
   i:          4194304         59184033  4.2BSD      2048 16384    1 # /usr/src
   j:          4194304         63378337  4.2BSD      2048 16384    1 # /usr/obj
   k:        245003968         67572641  4.2BSD      2048 16384    1 # /home
```

这个磁盘标签声明它有 16 个分区，但只列出了 11 个。磁盘标签有 16 个分区的空间，但就像 MBR 分区表一样，并不是所有的分区都有分配空间。与 Unix-like 操作系统中的大多数配置文件一样，一个井号（`#`）表示注释的开始。这里的注释给出了上面表格的标题。

第一列是分区字母。一个独特的字母标识每个 disklabel 分区。在我们例子中的第一个分区是 *a* **5**，第二个是 *b* **6**，第三个是 *c* **7**，以此类推。

`size` **1** 是驱动器使用的扇区数。在这个例子中，分区 *a* 占用了 2097121 个扇区，分区 *b* 占用了 4698424 个扇区，分区 *c* 占用了 312581808 个扇区。

`offset` **2** 是从 MBR 分区开始到 disklabel 分区开始的扇区数。如果一个磁盘是可引导的，它有一个主引导记录（MBR）标记它为可引导。MBR 记录占据了前 63 个磁盘扇区，编号从 0 到 62。第一个可用于 disklabel 分区的扇区是扇区号 63。分区 *a* 从扇区 64 开始，以便正确对齐固态磁盘中的内存单元。

看一下分区 *b*。它有一个偏移量 2097185，这意味着它从扇区 2097185 开始。我们如何到达那里？嗯，分区 *a* 从扇区 64 开始，大小为 2097121。2097121+64=2097185，或者分区 *a* 结束后的第一个空闲扇区。这似乎非常合理，直到你看到分区 *c*。Disklabel 分区 *c* 是神奇的。在每一个 disklabel 分区中，*c* 代表整个磁盘。它有一个偏移量为 0，大小等于磁盘上的扇区数。你无法在分区 *c* 上放置文件系统；它只用于参考。分区 *d* 从分区 *b* 的位置继续。

`fstype` **3** 标记了该分区上的文件系统类型。OpenBSD 文件系统，如分区 *a*，被标记为 4.2BSD。（请注意，OpenBSD 文件系统与 BSD 4.2 的文件系统不再完全相同。）分区 *b* 是交换空间。

接下来的两列 **4** 展示了该分区文件系统的碎片化行为。这些值是在将文件系统放置到分区时由文件系统创建工具设置的，不应手动更改。如果你好奇，可以阅读 `newfs(8)` 及其相关的 man 页面。`fsize` 是分区上任何文件碎片的大小。`b` 是磁盘上块的大小，以字节为单位。我们将在 第八章 中讨论 FFS 碎片化。你真正需要知道的是，FFS 和 FFS2 都具有很强的抗碎片化能力，并且都不需要任何类型的碎片整理过程。

最后一列显示了每个柱面组中柱面的数量。对于现代磁盘来说，这几乎总是 1。

有趣的是，disklabel 可以被认为是格式化磁盘的配置文件。你可以将这个 disklabel 保存到文件中，获取一个相同的硬盘，将这个标签写入新硬盘，并完美地复制旧硬盘上的分区。

如果你在分区时感到困惑，请打印出当前的 disklabel 并将其与您希望系统看起来的方式进行比较。

## 其他信息

如果这台机器将要连接到互联网，在开始之前你必须知道其网络配置。如果你的网络有 DHCP，那么你一切就绪。如果没有，你需要一个有效的 IP 地址、子网掩码、默认网关和名称服务器 IP 地址。

提前决定这台机器是否将运行 X Window 系统。通常，桌面运行 X，而服务器则不运行。

到目前为止，你已经拥有了在 i386 或 amd64 硬件上安装 OpenBSD 所需的所有背景知识。拿出你的设备，让我们开始吧。

* * *

^([5]) 是的，那是兆字节——你知道，千兆字节以下的单位。是的，兆字节可以应用于磁盘。

^([6]) 我从 OpenBSD 开发者那里得到保证，任何 fdisk 都足以用于任何操作系统。由于反复被有缺陷的 fdisk 程序折磨，我发现自己无法给你完全的自由去尝试这个。

^([7]) 是的，你可以让 U 盘旋转。但一个以 5400 RPM 旋转的 U 盘会有一系列超出常规系统管理范围的问题。
