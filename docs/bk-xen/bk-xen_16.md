# 附录 A. XM 参考

![无标题图片](img/httpatomoreillycomsourcenostarchimages333191.png.jpg)

`xm` 命令可能是你需要了解的第一个 Xen 相关的内容。它是你访问 Xen 控制平面功能的主要接口。使用 `xm`，你可以创建、查询和销毁域。你可以向客户域发送某些指令（例如，关闭）。你可以连接和断开存储和网络设备，并动态调整资源消耗。

简而言之，了解 `xm` 是*重要的*。这就是为什么我们在本节中记录了 `xm` 的子命令，并提供了对本书其他部分的参考。

### 注意

*其中一些命令（从 Xen 3.1 或更高版本引入的）可能不与 RHEL 5 中包含的 Xen 版本兼容*.*x*，因为 Red Hat 的优先级是保持主要版本之间的兼容性，而不是支持新功能。这些命令带有星号*。

所有 `xm` 命令都通过向 `xend` 发送指令来工作，`xend` 是 Xen 控制守护进程。这是一个在域 0 上运行的 Python 程序。它接收请求并向客户端应用程序（如 `xm`）发送回复。

如果 `xend` 没有运行，`xm` 将返回错误并退出。`xm` 的许多功能依赖于 XenBus，这是一个在机器上所有域之间的共享通信通道，以及 XenStore，这是一个集中式配置数据库，`xend` 使用它来保存域配置信息和状态。有关 XenStore 和 XenBus 的更多信息，请参阅第十四章。

话虽如此，让我们看看 `xm` 命令的一般形式。

# `xm` 的语法

`xm` 的语法相当简单且一致：

```
xm <subcommand> <domain specifier> [options]
```

选项可以放在域指定符之前或之后，但我们通常将它们放在末尾。例如，要干净地关闭域 10：

```
xm shutdown 10
```

在这里，我们没有指定任何选项，并且我们通过数字 ID 而不是名称来引用域。域指定符可以是域编号或域名称——名称将内部转换为数字。（注意，如果 XenStore 没有启动，则此操作将不会工作，但那种情况下，你面临的问题更大。）

`xm` 命令通常是异步的，这意味着命令可能在实际上完成之前就返回了。对于像 `xm shutdown` 这样的命令，域可能需要几分钟才能真正关闭。在这种情况下，我们通常会轮询 `xm list` 来确保域已经停止运行。

# `xm` 子命令

这里列出了各种 `xm` 子命令。我们经常使用其中的一些，而完全不使用其中的一些。带有版本 3.1 的新命令带有星号 (*)，因为 3.1 标志着 Xen 在域管理方法上的重大变化。正如我们之前提到的，这意味着它们也可能不与 RHEL 5.*x* 兼容。例如，尽管 RHEL 5.2 使用 Xen 虚拟机的 3.1 版本，但它使用的是 `xend` 等用户空间工具的 3.0.3 版本。

**`addlabel`**, **`cfgbootpolicy`**, **`dumppolicy`**, **`getlabel`**, **`labels`**, **`loadpolicy`**, **`makepolicy`**, **`resources`**, **以及** **`rmlabel`**

这些子命令与 Xen 的安全策略基础设施交互。正如我们在第十四章中提到的，我们没有看到 Xen 安全策略的任何实际用途。如果您对安全模块（它们本身也是正在进行的工作的主题）感兴趣，我们建议查看 Xen 源代码分发中包含的示例策略。

**`block-attach`**, **`block-configure`**, **`block-detach`**, **以及** **`block-list`**

各种 `block` 子命令管理附加到域的存储设备。这些命令在第四章中有更详细的说明。

**`console`**

控制台子命令连接到指定域的控制台。请注意，这只有在域设置为使用 Xen 的虚拟控制台时才有用。

即使一切设置正确，您可能也需要按 ENTER 键来使其显示登录提示。这对新用户来说可能有些令人困惑，因为他们输入 `xm console` 并看到空白屏幕，因为自上次使用以来控制台缓冲区中没有任何内容被添加。

**`create`**

在 Xen 的最新版本中，`xm create` 子命令是 `xm new` 后跟 `xm start` 的同义词。这是我们全书用来启动域的子命令。

`Create` 需要配置文件的名称。如果您没有指定文件，它将使用默认值，*/etc/xen/xmdefconfig*。

`create` 子命令接受以下选项：

+   `-h`: 打印帮助信息。

+   `-q`: 静默模式。

+   `--path`: 域配置文件的基本路径（默认为 */etc/xen*）。

+   `-n`: 干运行模式。打印将要生成的配置。这用于调试域配置中的 Python 代码。如果您正在自动生成域配置，有某种方式来测试它将是非常好的。

+   `-x`: 与 `-n` 类似，但输出 XML 格式的域定义。请注意，截至 Xen 3.3，此选项仍然依赖于已弃用的 `xml.dom.ext` 模块，因此不适用于许多 Python 安装。

+   `-c`: 自动连接到控制台。这是与 PyGRUB 交互所必需的。

+   `-s`: 跳过 XML 域配置的 DTD 检查。

如果您没有为 `xm create` 提供完整路径，它将默认在 */etc/xen* 中查找配置文件。您可以使用 `--path` 选项更改这一点。

**`debug-keys *`**

`debug-keys` 子命令与 Xen 内置的 GDB stub 交互，使您能够发送魔法按键来控制 stub 的输出。这可能在您修改 Xen 内部时非常有用。

注意，这只有在您使用 GDB stub 构建 Xen 时才会生效。

**`delete *`**

`xm delete` 子命令从 Xen 的管理中删除一个域。如果该域正在运行，删除子命令会将其关闭，然后删除其定义。

**`destroy`**

> 在你认为 UNIX 是家庭导向之前，请注意，所有孩子都必须死去。
> 
> —埃里克·福斯特-约翰逊，*跨平台 Perl*

`xm destroy` 命令相当于在物理机器上拔掉电源插头。如果 domU 完全锁定，可能需要请求 `xend` 强制终止它。所有资源将立即返回给虚拟机管理程序。

**`dmesg`**

类似于 `dmesg` 系统命令，`xm dmesg` 子命令会打印出内核启动的诊断信息。我们将在 第十五章 中更多地讨论这些信息。

**`domid`** **和** **`domname`**

`domid` 和 `domname` 命令在你知道域的名称时查找域的 ID，反之亦然。每个子命令接受一个单一参数，即域名称或 ID，并返回相应的 ID 或名称。如果你有很多域在浮动，它们会很有用。

**`dry-run`**

虽然 `dry-run` 子命令在理论上测试 Xen 是否能成功找到并使用其虚拟设备，但我们运气不佳，因为它不太擅长预测我们是否能在启动域时成功。它的一个重要用途是调试包含在域配置中的 Python 代码，如 第十四章 中所述。

此子命令也是 `xm create` 的子选项，它以 dry-run 模式创建域。

**`dump-core`**

`dump-core` 子命令会触发立即的内存转储。

通常，它会暂停域，将其内存转储到指定的文件，然后解除暂停。然而，你可以指定 `-L (--live)` 选项，使其以类似实时迁移的方式转储，而无需暂停和解除暂停（或者至少不需要暂停任何明显的时间）。

**`info`**

`info` 子命令会打印出关于 Xen 主机的大量有用信息，包括你使用的 Xen 的精确版本、处理器的功能以及可用于 domUs 的内存。

**`list`**

`xm list` 子命令在最简单的形式下，只是列出域的表格。然而，它也可以打印出有关域的一般信息，包括完整的 `s-` 表达式（如果提供了 `--long` 选项）。

`list` 子命令的简短形式也会显示每个域的状态。

+   `'b'` (阻塞): 域正在等待某些事情，无论是 I/O 还是调度原因。空闲域将显示为阻塞状态。这是正常的；当它们有事情要做时，它们将被解除阻塞。

+   `'p'` (暂停): 此状态表示该域已被 `xm pause` 暂停。

+   `'c'` (崩溃): 域已崩溃。

+   `'d'` (死亡): 域正在关闭，并且正在由虚拟机管理程序销毁的过程中。如果一个域保持在此状态，那么它很可能是存在一个错误。

+   `'s'`（关闭）：域正在关闭过程中，无论是由于域内发出的命令（例如，`halt`）还是来自 dom0（例如，`xm shutdown`）。此状态还用于已知于 Xen 但尚未启动的域。如果您使用 `xm new`，导入的域定义将在 `xm list` 中显示为 `shutdown`，直到您使用 `xm start` 启动它。

+   `'r'`（运行）：域目前正在物理计算机上执行。请注意，在单处理器机器上，`xm list` 总是会显示 dom0 作为唯一的运行域，因为 dom0 正在生成和显示 `xm list` 输出。

**`log`**

`xm log` 命令简单地打印出 */var/log/xend.log*。我们将在 第十五章 中更详细地介绍 Xen 的各种日志文件。

**`mem-max`**

`mem-max` 子命令指定域可以使用的最大内存量（以兆字节为单位）。这与域配置文件中的 maxmem 指令相同。目前，此子命令对正在运行的域没有影响；更改将在域重新启动时生效。

**`mem-set`**

`xm mem-set` 子命令通过向目标 domU 中的气球驱动程序发送消息来工作。以这种方式更改域的内存分配需要 domU 操作系统的合作，因此不能保证。这也提出了从域中获取过多内存的可能性，这将使其变得不稳定。

我们更喜欢避免使用此子命令。然而，有关气球驱动程序的更多信息，请参阅 第十四章 中的相关讨论。

**`migrate`**

`migrate` 子命令，正如您所猜测的，用于迁移域。迁移相当复杂。第九章 完全致力于此主题。

**`network-attach`**、**`network-detach`** 和 **`network-list`**

如您所猜测，这些子命令管理虚拟网络设备（在 Xen 术语中为 *vifs*，而不是网络本身）。使用这些子命令，您可以连接、断开连接和列出 vifs。我们将在 第五章 中讨论这些子命令。

**`new *`**

新增的 `new` 子命令将域添加到 Xen 的管理中；也就是说，它定义了域，但实际上并不分配资源或运行它。将域导入 Xen 后，您可以使用 `xm start` 子命令启动它。

您可能希望使用 `-f` 选项运行 `new`，指定描述域的文件。这可以是 XML 或标准的 Python 配置格式。

**`pause`**

此子命令暂停域。在暂停期间，域将继续占用内存并锁定其设备，但不会被调度在 CPU 上运行。

**`reboot`**

`reboot`子命令命令域干净地重启自己。请注意，如果您使用 PyGRUB，`xm reboot`不会加载新的内核；为此您需要关闭并重新创建域。例如，`shutdown -r`在 domU 内部也是如此。

**`rename`**

`xm rename`子命令允许管理员更改与域 ID 相关联的可读名称。

**`restore`** **和** **`save`**

`xm restore`和`save`子命令相互补充。正如我们在第九章中描述的，`xm save`使域释放其资源并将状态保存到保存文件中，而`xm restore`则使其从先前创建的保存文件中恢复。这非常类似于休眠。

**`resume *`**

`resume`子命令指示一个域从挂起状态返回。请注意，这仅适用于由`xend` *生命周期支持*管理的域，这本质上是指`xend`管理非活动域的能力。

**`sched-credit`**

信用调度器是 Xen 的默认调度器。`sched-credit`子命令配置信用调度器，允许您显示或调整域的权重和上限。我们在第七章中详细描述了其用法。

**`sched-sedf`**

当然，sedf 调度器已经过时。但是，如果您发现自己在使用它，您可以使用`sched-sedf`子命令调整域的调度参数。

**`shell *`**

`shell`子命令有点有趣。它从一个交互式 shell 启动，被称为*The Xen Master*，您可以从该 shell 中发出各种`xm`子命令。

**`shutdown`**

与`xm reboot`类似，`shutdown`子命令命令域关闭，不同之处在于它不会立即重启。此子命令需要 domU 合作；如果域没有关闭，`xend`不会强制终止它。如果`xm shutdown`不起作用，您可能想尝试`xm destroy`。

**`start *`**

`start`子命令启动一个受管理的域。请注意，此子命令，就像`new`和`suspend`一样，仅存在于 Xen 3.1 中，它添加了`xend`生命周期支持。

**`suspend *`**

`xm suspend`子命令挂起一个受管理的域。

**`sysrq`**

`sysrq`子命令将一个魔法 sysrq 键发送到 domU。请注意，这不能通过`xm`控制台完成，因为 dom0 不会将 sysrq 传递给 domU。如果域似乎处于昏迷状态，这是一个有用的最后手段。有关 sysrq 的更多信息，请参阅内核文档（Linux 内核源树中的*Documentation/sysrq.txt*）。

**`top`**

`xm top`子命令以类似于`top(1)`子命令的格式显示正在运行的 Xen 域的状态信息。

**`trigger *`**

`trigger` 子命令向域发送 CPU 事件。它可以触发不可屏蔽中断 (NMI)、复位或 init 事件（尽管后两个在 Xen 3.2/i386 上会失败，显示“未实现功能”消息）。这个子命令主要用于调试。

**`unpause`**

`xm unpause` 子命令将使用 `xm pause` 暂停的域恢复运行。

**`uptime`**

`xm uptime` 子命令将打印所选域的运行时间，如果没有指定域，则为所有虚拟机打印。

**`vcpu-list`**、**`vcpu-pin`** 和 **`vcpu-set`**

`vcpu-` 子命令控制域在 SMP 系统中将使用哪些 `cpus`。有关更多信息，请参阅 第七章。

**`vnet-create`**、**`vnet-delete`** 和 **`vnet-list`**

这三个 `vnet-` 子命令与 Xen 的 VLAN 支持交互。我们没有涵盖 VLAN 支持，因为我们从未有机会使用它，也从未见过其他人使用它。如果你觉得它很有用，请给我们发一封电子邮件。

**`vtpm-list`**

`vtpm-list` 子命令允许你列出附加到域的虚拟 TPM（可信平台模块）。尽管我们没有详细介绍 TPM，但我们确实在 第十四章 中提到了它。
