# **引言**

![无标题图片](img/httpatomoreillycomsourcenostarchimages651574.png.jpg)

所有背景的网络管理员都有一个共同的、压倒性的愿望。无论你管理的是一个通过全球 MPLS 网状连接的 400 个独立的制造工厂的网络，还是负责三台计算机和一台老式的打印机，网络管理员都共同拥有一个持久而强烈的愿望：我们希望我们的用户闭嘴。

将问题归咎于网络很容易。网络无处不在。企业假设网络将完美运行，并据此做出决策。一个用户不能从他的 20 世纪 PC 打开另一个大陆上的文件服务器上的 900MB Excel 电子表格吗？网络问题。在遥远的 Farawayistan 的网站运行缓慢吗？网络问题。一个用户不能通过 33.6Kbps 的调制解调器获得更快的响应吗？网络问题。总的来说，用户不关心诸如带宽成本、跨大陆光纤的物理布局或光速这样的琐事。他们希望网络按他们想象的方式工作。

这个问题因网络的不可见性而加剧。路由器和交换机是黑盒子。你向网络提供电缆，它就提供连接。传统上，服务器在活动日志和报告方面比网络设备要好得多。系统管理员可以编写脚本，在服务器进程失败时发出通知并尝试解决问题，但很少网络管理员拥有可以自我监控或修复的设备。存储在网络设备上的使用信息最多只能显示最后几分钟。当用户报告应用程序失败时，许多系统管理员检查他们的日志并报告，“我没有问题。一定是网络的问题。”更复杂的网络管理员有如 MRTG、CiscoWorks 或 OpenView 等流量测量工具，但这些并不能证明网络没有问题。它们仅仅显示网络是否具有或缺乏软件可以报告的特定问题集。交换机上行链路端口上没有媒体错误，并不能说明 TCP/IP 错误或防火墙问题。在这样的最小化日志记录下，将问题归咎于网络变得非常容易，而且很难反驳。

此外，现代网络管理员通常没有正式的认证或培训过程。需要计算机科学学位来管理网络的日子已经一去不复返了。现有的网络管理认证通常是为系统管理员准备的。一个“操作系统供应商认证”的网络管理员实际上是在认证操作系统提供给网络的各项服务，而不是网络本身。例如，当你为微软 DHCP 服务器认证学习时，你会学到一些关于网络的知识，但更多的是关于那个特定的 DHCP 实现。网络服务管理是一项有用的技能，但与网络底层管理并不相同。网络管理员只能通过艰难的方式学习——而且确实非常艰难。

这是一件遗憾的事情，因为网络管理员可以在任何组织中扮演一个强大的角色。网络管理员可以帮助解决几乎每一个技术问题。网络管理员可以让自己成为组织中无价、不可或缺且不可替代的组成部分。一个掌握了工具、理解了协议并抑制了对周围人智力轻视的自然情感的网络管理员，除非公司在他周围解散，否则不会被解雇。

一些网络管理员理解这一点，并且总是乐于助人。如果一个用户或系统管理员报告了一个问题，这个网络管理员总是准备好跳进来，使用数据包分析器或防火墙日志并提供见解。这是出色的客户服务，*如果*用户能在网络管理员观察的时候复制出问题。复制问题会消耗无尽的时间，让所有相关人员都变得焦躁不安。

假设你有一个工具，可以具体告诉你昨天、上周或去年网络发生了什么？想象一下能够精确识别服务器和硬件变更对网络的影响。假设你能告诉系统管理员新服务器传输了哪些虚假流量？就让我们暂时梦想一下，能够明确且没有否认风险地声明，“那个问题不是网络问题。”然后想想，通过利用现有的设备来完成所有这些。

网络流量分析让你能够做到这一点。也许你不会完全平息你的用户——没有神圣干预是无法做到的。但你可以在问题发生之前识别出你的网络上的问题。你可以权威、明确和果断地回答问题。人们将不再自动责怪网络。你的工作将变得不那么有压力，因为你将不再*认为*你知道发生了什么。你将*知道*。

本书将引导网络管理员利用任何免费的类 Unix 操作系统、免费软件和现有的网络硬件构建一个基于流的网络管理系统。

# 网络管理和网络管理

网络管理员和网络经理之间有什么区别？

*网络管理* 包括配置硬件、联系技术支持和布线。*网络管理* 涉及对网络的决策。网络经理通常从网络管理员起步，并且可能仍然执行网络管理任务，但他们的技术知识指导管理决策。

虽然改变你的职位名称需要管理层的干预，但任何网络管理员都可以通过完成所需的工作转变为网络经理。你负责你的设备，并且你可能在某个地方能够找到一些计算资源的访问权限。最困难的投入将是你的时间。然而，一旦你开始提供基于事实的回答和诊断，人们就会注意到这种变化。随着时间的推移，公司管理层将开始让你参与关于网络的决策，甚至可能寻求你关于建立在网络之上的业务流程的建议，无论你的名片上写着什么，你都将成为事实上的网络经理。

# 网络管理工具

对于一个网络管理系统来说，这些说法相当令人印象深刻，尤其是如果你熟悉现有的网络管理工具。许多人对自己广泛使用的网络管理系统感到自豪。让我们来看看一些流行的免费网络管理工具，看看它们是如何相互配合的，以及流量分析如何改进它们。

## MRTG、Cricket 和 Cacti

MRTG、Cricket 和 Cacti 使用 SNMP 在设备接口上生成网络流量的图表，并将结果存储在固定大小的数据库中。知道在任何时候有多少流量穿过你的网络是绝对必要的，我自己也大量使用这类工具。固定大小的数据库意味着你不需要担心数据库管理；它们易于设置，并能快速产生有用的信息。

知道你的电路已满可以解释为什么连接速度慢，但接下来的明显问题是“满的是什么？”MRTG 风格的工具无法回答这个问题。流量可以。此外，这些工具通常使用五分钟的流量平均值。它们掩盖了短暂的峰值和低谷。最后，这些工具将历史数据压缩为长期平均值。如果你想了解六个月前的流量细节，你必须重新配置这些工具或使用另一个工具。

## RTG

与之前的工具类似，RTG 使用 SNMP 来测量穿过设备接口的网络流量，并绘制数据图表。与 MRTG 及其衍生工具不同，RTG 测量更短的流量间隔，并将每个单独的结果存储在数据库中。它提供了对流量拥堵的更多详细可见性。如果你想查看网络接口在单分钟内的流量变化，RTG 就是你的朋友。你还可以与历史数据进行详细比较。

数据库的存在意味着你必须对数据库有所了解，或者拥有无限的磁盘空间。此外，RTG 不能显示流量的内容，只能显示流量的数量。它解决了 MRTG 风格工具的一个问题，但不是其他问题。

## Nagios 和 Big Brother

如果你不再关注流量数量，你还需要检查你的网络设备的健康状况。Nagios 和 Big Brother 等免费软件在这方面非常有用；当交换机的冗余电源失败、端口开始产生 CRC 错误或交换机自行重启时，你都可以得到警报。你必须有这些信息来维护一个可靠的网络。

知道你的硬件正在正常运行是至关重要的，但一个交换机运行正常并不意味着通过它的流量没有遇到麻烦。一个功能正常的交换机或路由器会像期望的流量一样可靠地传输不期望的流量。

## CiscoWorks、OpenView 以及更多

然后是你拥有的商业网络管理套件。这些产品中的大多数要么是带有漂亮界面的工具包，要么仅限于简单的网络。这些工具很有吸引力。它们看起来任何人都可以使用。但这些工具往往想要控制你的整个计算基础设施，从路由器到桌面，而在生产环境中部署它们通常都会失败。

大多数人没有意识到的是，当你设置好这些软件套件以符合你的需求时，你所做的工作与构建自己的流量分析系统所做的工作一样多。然而，你确实有满足感，那就是把本应属于你口袋里的钱给了其他公司。 （你说那是老板的钱？为商业产品获取报价。在绩效评估时，告诉你的经理你没有花那笔钱就得到了相同的结果，并希望分得一杯羹。这样做比花完钱后要求加薪更有可能成功。）

# 足够抱怨了：解决方案是什么？

解决方案：网络管理很糟糕。工具都不够好，或者又贵又不好。你如何摆脱这个困境？*你记录通过你的网络传输的流量*。

是的，这是一个很高的要求。幸运的是，你不需要记录每个网络事务的全部内容。暂时想想网络管理员的职责。你的部分责任包括提供网络服务，如 DNS 和 DHCP。你可能每隔几天就要给你的代理服务器喂食，并在每周一早上清理入侵检测系统中的脚本小子。但暂时把运行在网络上的服务放在一边，考虑一下基础网络。

网络的存在就是为了将流量从一个主机传输到另一个主机。仅此而已。网络管理员负责实现这一点。

也许您是公司唯一的 IT 人员，并且还负责其他所有事情。然而，大多数时候，网络管理员与系统管理员、一两个数据库管理员、帮助台和其他 IT 专业人员一起工作。在这种情况下，网络管理员的职责是及时交付数据包。这些数据包的成功交付完成了您的职责。

能够证明数据包已到达目的地并被接受将彻底改变您与同事的关系。突然之间，您有了*证据*。网络不再是每当出现问题就无差别地承担责任的实体。当然，其中一些错误将是您的责任。但许多错误不是，没有什么比第一次彻底证明问题不是您的，而且您可以严格证明问题所在的感觉更令人欣慰。（这里的技巧在于不要用这个证据疏远那些同事，但我稍后会谈到这一点。）

您不需要记录流量内容的完整记录来证明您的观点。您只需要证明主机之间成功发生了网络级通信。例如，如果用户无法显示您内部 Web 服务器上的页面，您不需要记录用户桌面和服务器之间网络连接内容的完整记录。您只需要记录客户端和服务器之间发生了网络对话，网络在两者之间传输了数据，并且网络层上对话正常且无错误地结束。您不需要记录对话中的每个单独的图像或文本块。这不是网络管理员的职责。证明网络在客户端和服务器之间传输了 Web 流量，证明了网络正常工作。请注意，作为网络管理员，您仍然有责任帮助解决问题；只是没有人会在您工作时责怪您。

# Flow-Tools 及其先决条件

Flow-tools 是标准可免费获得的流量管理和分析工具包。尽管您可以找到许多其他流量管理工具，但 Flow-tools 存在时间最长，并且是最广泛部署的免费工具包。许多人基于 Flow-tools 编写了流量分析接口，本书将介绍其中几个。

Flow-tools 是为 Unix-like 系统编写的，例如 Linux、OpenSolaris、各种 BSD、商业选项如 AIX 等，以及许多其他系统。我的参考平台是 FreeBSD，但本书中的所有内容在 Linux 上也能正常工作。您可能会在使用更具挑战性或独特的平台时遇到困难。本书提供了流量管理工具的命令示例，但您必须知道如何调用超级用户权限、导航文件系统等。

这部分软件大多使用 Perl。你不需要编写自己的 Perl，但你需要编辑 Perl 脚本来设置诸如公司名称和 IP 地址之类的变量。一些流量软件包括特定的 Perl 钩子，我将为 Perl 爱好者介绍它们。

如果你想要使用 flow-tools 执行流量数据的即兴报告，你需要一个绘图程序。我讨论了`gnuplot`。如果你在桌面上安装了 X 服务器，你将最舒适地使用`gnuplot`，但这不是强制性的。

此外，要使用 flow-tools，你必须理解 Unix 纪元时间。纪元时间是自 1970 年 1 月 1 日 00:00:00 起，在 UTC 时区内的秒数。许多网站提供纪元到日期的转换器。你可以在命令行中使用`date`命令将纪元秒转换为日期，但语法在不同的类 Unix 操作系统中有所不同。

谈到时间，在你的网络中拥有良好的时间管理将增强你的网络管理能力。因此，我建议安装并使用网络时间协议。为你的网络使用权威的时间源。如果你的服务器日志中的时间戳与你的网络流量记录中的时间戳相匹配，你的分析将会容易得多。

流量可以包括边界网关协议（BGP）信息。我讨论了如何管理流量 BGP 数据，但这些解释假设了基本的 BGP 知识。如果你不使用 BGP，你的流量数据将不包含任何 BGP 数据。你可以安全地跳过基于 BGP 的流量数据的讨论。

最后，你必须理解网络。如果你现在对网络基础知识没有牢固的掌握，但在完成你的流量管理实现时，你将会有。

# 流量和本书

在你能够使用流量信息管理网络之前，你必须理解流量是如何工作的，数据来自哪里，它是如何收集和处理的，以及基于流量的管理的优势和局限性。第一章介绍了流量。

许多路由器和交换机可以执行*流量导出*，其中硬件跟踪流量数据并将其传输到管理系统。如果你的硬件不能导出流量，你可以在软件中执行流量导出。第二章讨论了流量导出以及如何在硬件和软件中配置它，以及如何使用行业标准流量工具软件包从许多不同的网络设备中收集那些流量记录。

第三章教你如何查看你收集的流量记录。流量记录包含大量信息，选择合适的查看格式将帮助你获得所需的认识。

流量记录包括通过网络传输的所有流量，但你通常只对非常具体的信息感兴趣，例如特定电路或特定主机的流量。第四章演示了如何过滤流量以仅显示有趣的数据。

有时你可能更感兴趣于报告汇总的流量数据，而不是单个流量。哪些主机发送了最多的流量？你网络中最受欢迎的 UDP 端口是什么？哪些主机连接到最多的其他主机？Flow-tools 支持广泛的报告，我将在第五章中介绍。

另一个常见的需求是简单可视化网络流量；换句话说，以图形格式展示流量记录。第六章介绍了 FlowScan，这是一款基于 Web 的软件，为用户提供流量图表。它还介绍了用于编写 FlowScan 的`Cflow.pm` Perl 模块，如果你有兴趣，你可以用它来编写自己的流量分析软件。

虽然 FlowScan 对用户来说效果很好，但网络管理员需要更强大的工具。第七章介绍了 FlowViewer，这是一个基于 Web 的工具，允许你深入分析你的流量。

基于 Web 的软件可以处理许多网络可视化任务，但自动化可视化和图形化临时数据并不在其中。有时，你需要准备图表来显示今天的流量与上周或去年相比的情况。在第八章中，你将使用`gnuplot`创建任意流量数据的图表。

最后，第九章讨论了一些流量收集的边缘情况，并讨论了如何使用流量记录主动改进你的网络。

然而，在进行所有高级操作之前，让我们先深入、仔细地看看第一章中的流量。
