- en: Chapter 19. Building Custom Kernels
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第 19 章：构建自定义内核
- en: '*Rewiring the brain?*'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: '*重新布线大脑？*'
- en: '*Knowing where the parts plug in*'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: '*了解部件的连接方式*'
- en: '*makes it possible.*'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '*使其成为可能。*'
- en: '![](httpatomoreillycomsourcenostarchimages1616079.png) The OpenBSD team works
    very hard to provide a high-quality kernel that requires no tweaking beyond setting
    the occasional sysctl or perhaps enabling a feature. But if you want to use an
    experimental feature or add a device driver to the kernel, or you want to squeeze
    OpenBSD into tiny hardware or embedded systems, you’ll need to build a custom
    kernel from source code. The OpenBSD people won’t support you if you venture into
    custom kernels, but they’ll provide you with everything you need to shoot yourself
    in the foot, as you’ll learn in this chapter.'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](http://atomoreilly.com/source/nostarch/images/1616079.png) OpenBSD 团队非常努力地提供高质量的内核，无需调整，只需偶尔设置
    sysctl 或可能启用一个功能即可。但如果你想要使用实验性功能或向内核添加设备驱动程序，或者你想要将 OpenBSD 塞入小型硬件或嵌入式系统，你需要从源代码构建自定义内核。如果你冒险进入自定义内核，OpenBSD
    的人不会支持你，但他们会提供你需要的一切，让你在接下来的章节中了解如何“自掘坟墓”。'
- en: Kernel Cautions
  id: totrans-5
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 内核注意事项
- en: Before we get into the details of building custom kernels, we’ll look at why
    that’s usually a bad idea.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们深入了解构建自定义内核的细节之前，我们将探讨为什么这通常是一个糟糕的想法。
- en: Don’t Build Custom Kernels
  id: totrans-7
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 不要构建自定义内核
- en: Many open source operating systems encourage sysadmins to build custom kernels.
    Mailing lists for these operating systems are full of suggestions on rebuilding,
    tweaking, and modifying the kernel. Those user communities will walk new users
    through rebuilding the kernel.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 许多开源操作系统鼓励系统管理员构建自定义内核。这些操作系统的邮件列表充满了关于重新构建、调整和修改内核的建议。这些用户社区会引导新用户通过重新构建内核。
- en: OpenBSD developers take a different approach to rebuilding the kernel. They
    ship a default kernel, called GENERIC, which you will almost never need to rebuild.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD 开发者采用不同的方法来重新构建内核。他们提供了一个默认内核，称为 GENERIC，你几乎永远不需要重新构建它。
- en: Building a kernel from source doesn’t prove that you’re an alpha geek, and rebuilding
    the kernel is never a recommended way to solve a problem. The people who build
    custom kernels are either kernel developers or ignorant newbies. The OpenBSD Project
    members feel no particular obligation to help users with customized kernels. If
    your custom kernel crashes, destroys your filesystem, or starts making threatening
    calls to the local constabulary, they won’t care. Why? Adding, moving, or changing
    one kernel option might seem trivial, but each option might represent tens of
    thousands of lines of source code that you’ve just casually gutted.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 从源代码构建内核并不能证明你是一个 alpha 级别的极客，而且重新构建内核也绝不是解决问题的推荐方法。构建自定义内核的人要么是内核开发者，要么是无知的初学者。OpenBSD
    项目成员对帮助用户解决自定义内核问题没有特别的义务。如果你的自定义内核崩溃，破坏了你的文件系统，或者开始向当地的警察局发出威胁电话，他们不会在乎。为什么？添加、移动或更改一个内核选项可能看起来微不足道，但每个选项可能代表成千上万行你随意删除的源代码。
- en: That said, the OpenBSD Project is much friendlier than closed source operating
    systems, in that it provides the source code for the kernel, and gives you the
    tools and instructions needed to build it. The territory might be dangerous, with
    rattlesnakes and bears and the occasional bottomless pit, but they give you a
    map and a flashlight. If you can carve out some new territory for yourself, good
    for you! If you get eaten by coyotes, well, that’s pretty much what happens.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 话虽如此，OpenBSD 项目比闭源操作系统要友好得多，因为它提供了内核的源代码，并提供了构建它所需的工具和说明。这片领土可能很危险，有响尾蛇、熊，偶尔还有无底洞，但他们给你一张地图和一盏手电筒。如果你能为自己开辟一片新天地，那真是太好了！如果你被野狼吃了，那基本上就是这样。
- en: Note
  id: totrans-12
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: These warnings apply only to custom kernels. The OpenBSD team is extremely interested
    in problems in a provided kernel, whether that’s the GENERIC kernel, the installer
    kernel, or any other.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 这些警告仅适用于自定义内核。OpenBSD 团队对提供的内核中存在的问题非常感兴趣，无论是 GENERIC 内核、安装程序内核还是任何其他内核。
- en: When working with kernels, keep in mind that some platforms have multiple GENERIC
    kernels. For example, the i386 platform has the standard GENERIC kernel, but it
    provides GENERIC.MP for multiprocessor machines, and it supports both versions.
    By the same token, the SGI platform has several GENERIC kernels—one for each supported
    hardware variety. These kernels are all GENERIC, and all supported.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 当与内核一起工作时，请记住，一些平台有多个GENERIC内核。例如，i386平台有标准的GENERIC内核，但它为多处理器机器提供了GENERIC.MP，并且支持这两个版本。同样，SGI平台有几个GENERIC内核——每个支持的硬件种类都有一个。这些内核都是GENERIC，并且都受到支持。
- en: Why Build Custom Kernels?
  id: totrans-15
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 为什么构建定制内核？
- en: People build custom kernels for various reasons. For example, if you’re a kernel
    developer, or aspire to be one, you will need to build customized kernels to test
    new features and new code.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 人们构建定制的内核有多种原因。例如，如果你是内核开发者，或者有成为内核开发者的愿望，你需要构建定制的内核来测试新功能和新的代码。
- en: Some people who play with kernels are interested in using experimental features.
    For example, OpenBSD supports the newly developed but not well-tested multipath
    SCSI, which is not supported by GENERIC. Not many people have the hardware to
    use multipath SCSI, but those who do have the hardware, along with programming
    skills, are encouraged to help improve this feature. (When running experimental
    features, be sure that you understand that *experimental* is the Siamese twin
    of *unstable*.)
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 一些玩内核的人对使用实验性功能感兴趣。例如，OpenBSD支持新开发但未经充分测试的多路径SCSI，而GENERIC不支持。没有多少人拥有使用多路径SCSI的硬件，但那些拥有硬件并且具备编程技能的人被鼓励帮助改进这个功能。（当运行实验性功能时，请确保你理解“实验性”是“不稳定”的李生兄弟。）
- en: Rarely, remediating a security flaw will require a patch to the kernel source
    code. But rather than build your own, get the patch from OpenBSD’s stable branch
    or a snapshot (discussed in [Chapter 20](ch20.html "Chapter 20. Upgrading")).
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 很少情况下，修复安全漏洞可能需要修补内核源代码。但与其自己构建，不如从OpenBSD的稳定分支或快照（在第20章中讨论）中获取补丁。
- en: Finally, some people will build custom kernels to save RAM on a machine with
    very low memory. Removing features from the kernel reduces its size.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，有些人会构建定制的内核以在内存非常低的机器上节省RAM。从内核中移除功能可以减小其大小。
- en: Problems Building Custom Kernels
  id: totrans-20
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 构建定制内核时可能遇到的问题
- en: When building a custom kernel, you are likely to run into trouble. For one,
    the interdependencies between kernel modules are quite complex and not thoroughly
    documented. The developers generally assume that people building custom kernels
    will read kernel source code and man pages. You are expected to read error messages
    and sort them out yourself.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 当构建定制内核时，你可能会遇到麻烦。首先，内核模块之间的相互依赖关系相当复杂，并且没有详细记录。开发者通常假设构建定制内核的人会阅读内核源代码和手册页。你预计会阅读错误信息并自行解决。
- en: OpenBSD’s cross-platform design slightly complicates kernel configuration. Some
    devices run on some architectures, but they fail to run or behave weirdly on others.
    If you include the wrong device in your kernel or tell the kernel a card is attached
    to the wrong bus, you’ll be building a busted kernel. Be sure that you understand
    how your hardware actually fits together.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD的跨平台设计略微复杂化了内核配置。一些设备在某些架构上运行，但在其他架构上无法运行或行为异常。如果你在内核中包含了错误设备，或者告诉内核一张卡连接到了错误的总线，你将构建一个损坏的内核。确保你了解你的硬件是如何实际组合在一起的。
- en: When mucking around in the source tree, you can corrupt the source code in various
    ways, such as by applying a patch incorrectly, scrambling a file, or forgetting
    that you edited a file that is now causing you grief. To test your source code,
    compile GENERIC. If GENERIC won’t compile, you’ve either mucked up the source
    code or your system has some deeper problem.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 当在源代码树中捣鼓时，你可能会以各种方式损坏源代码，例如通过错误地应用补丁、打乱一个文件，或者忘记你编辑了一个现在给你带来麻烦的文件。为了测试你的源代码，编译GENERIC。如果GENERIC无法编译，那么你可能已经损坏了源代码，或者你的系统存在更深层的问题。
- en: Building a custom kernel usually means including or removing kernel options
    and features from the configuration file. If you’re trying to use fancy compiler
    flags, however, stop. Custom compiler options are great for exposing compiler
    bugs, but the OpenBSD team members make no effort to have their code comply with
    the demands from these compiler options. Many of these options and higher optimizations
    break if you’re not running very specific operating systems on very specific architectures.
    The kernel code assumes that you are using the specified compiler options; if
    you change them, you’ll get nothing but pain.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 构建自定义内核通常意味着从配置文件中包含或删除内核选项和功能。然而，如果您正在尝试使用花哨的编译器标志，请停止。自定义编译器选项非常适合暴露编译器错误，但
    OpenBSD 团队成员并不努力使他们的代码符合这些编译器选项的要求。许多这些选项和更高的优化如果不在非常特定的架构上运行非常特定的操作系统，就会中断。内核代码假设您正在使用指定的编译器选项；如果您更改它们，您只会得到痛苦。
- en: 'If you’ve checked everything, and you still can’t get your kernel to build,
    you might don your flameproof suit and ask for help on *misc@OpenBSD.org*. State
    up front that you’re trying to build a custom kernel, and include the following
    information:'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您已经检查了一切，但仍然无法构建您的内核，您可能需要穿上防火服，并在 *misc@OpenBSD.org* 上寻求帮助。一开始就说明您正在尝试构建自定义内核，并包括以下信息：
- en: Your kernel configuration
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 您的内核配置
- en: OpenBSD version
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: OpenBSD 版本
- en: Unedited boot-time messages from booting a GENERIC kernel on your computer
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从您的计算机上启动 GENERIC 内核时未编辑的启动时间消息
- en: A full description of the problem
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对问题的完整描述
- en: Someone might take pity and try to help you.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 可能有人会同情你并试图帮助你。
- en: Problems Running Custom Kernels
  id: totrans-31
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 运行自定义内核时遇到的问题
- en: 'Custom kernels can have any number of problems, such as the following:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 自定义内核可能会有任何数量的问题，例如以下：
- en: Programs might not run as expected.
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 程序可能无法按预期运行。
- en: The system might not boot.
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 系统可能无法启动。
- en: The system might crash randomly.
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 系统可能会随机崩溃。
- en: The kernel might not find all of your hardware.
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 内核可能无法找到您所有的硬件。
- en: The kernel might eat your hard drives or your motherboard (without mustard or
    even a shot of malt vinegar).
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 内核可能会吞噬您的硬盘或主板（甚至没有芥末，甚至没有一小杯麦芽醋）。
- en: If you have customized your kernel narrowly—say, by adding only the multipath
    SCSI driver to the GENERIC kernel—the developers working on that feature will
    probably be interested in your bug reports on that feature.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您仅对内核进行了有限的定制——比如说，仅向 GENERIC 内核添加了多路径 SCSI 驱动程序——那么正在该功能上工作的开发者可能会对您关于该功能的错误报告感兴趣。
- en: If you can reproduce that problem when the same system boots with the GENERIC
    kernel, the OpenBSD team is definitely interested. Report your problem as occurring
    on the GENERIC kernel, and include debugging output only from GENERIC, not from
    your custom kernel. If you manage to identify, debug, and create a patch for a
    problem with a custom kernel, send your patch and a problem description to the
    mailing list. Your problem may be due to running on a custom kernel, but you may
    also have found a bug that could be triggered in GENERIC.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您在用 GENERIC 内核启动的相同系统上重现了该问题，OpenBSD 团队肯定会感兴趣。将您的问题报告为发生在 GENERIC 内核上，并且仅包括
    GENERIC 的调试输出，而不是自定义内核的。如果您设法识别、调试并创建了一个自定义内核问题的补丁，请将补丁和问题描述发送到邮件列表。您的问题可能是由于运行自定义内核引起的，但您也可能发现了一个可能在
    GENERIC 中触发的错误。
- en: But most important, if you have a problem running a custom kernel, reboot with
    GENERIC and get on with your day.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 但最重要的是，如果您在运行自定义内核时遇到问题，请重新启动到 GENERIC 并继续您的一天。
- en: Preparing for Kernel Customization
  id: totrans-41
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备自定义内核
- en: Before customizing the kernel, back up the known-good GENERIC kernel on your
    system by copying */bsd* to */bsd.GENERIC*. That way, if your custom kernel doesn’t
    boot, you can recover by booting the backup kernel.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 在自定义内核之前，请通过将 */bsd* 复制到 */bsd.GENERIC* 来备份您系统上已知的良好状态的 GENERIC 内核。这样，如果您的自定义内核无法启动，您可以通过启动备份内核来恢复。
- en: You’ll need the kernel source code in order to build a custom kernel. You can
    just grab *sys.tar.gz* from your OpenBSD installation media. If you installed
    from an Internet mirror, make sure to get the source code for your version of
    OpenBSD. The OpenBSD mirror root directory usually contains a snapshot of fairly
    recent source code, but check the directory for your release for its source code.
    Expand this directory under */usr/src*.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 您需要内核源代码才能构建自定义内核。您可以从 OpenBSD 安装介质中获取 *sys.tar.gz*。如果您从互联网镜像安装，请确保获取您版本 OpenBSD
    的源代码。OpenBSD 镜像根目录通常包含相当最近的源代码快照，但请检查您发布版本的目录以获取其源代码。在 */usr/src* 下展开此目录。
- en: '[PRE0]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Now that you have a backup (you *did* make a backup of your working kernel when
    I told you to, right?) and the source code, let’s look at kernel configuration.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你有了备份（你*确实*在我告诉你的时候备份了你的工作内核，对吧？）和源代码，让我们看看内核配置。
- en: Kernel Configuration
  id: totrans-46
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 内核配置
- en: You configure the OpenBSD kernel via text files. Like 4.4BSD, OpenBSD doesn’t
    offer a fancy graphical kernel configuration utility or menu-driven system. Each
    kernel configuration is on a single line, along with a label indicating the type
    of entry and a description. Pound signs (`#`) mark comments.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 你通过文本文件来配置 OpenBSD 内核。像 4.4BSD 一样，OpenBSD 不提供花哨的图形内核配置工具或菜单驱动系统。每个内核配置都在一行上，包括一个标签，指示条目的类型和描述。井号（`#`）标记注释。
- en: Configuration Entries
  id: totrans-48
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 配置条目
- en: 'Kernel configuration entries fall into four general categories: options, device
    drivers, pseudo-devices, and keywords.'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 内核配置条目分为四个一般类别：选项、设备驱动程序、伪设备和关键字。
- en: Options
  id: totrans-50
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 选项
- en: '*Options* are hardware-independent kernel functions. Options handle things
    like filesystems, networking protocols, and compatibility layers.'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: '*选项* 是与硬件无关的内核功能。选项处理诸如文件系统、网络协议和兼容层等问题。'
- en: 'Option entries look like this:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 选项条目看起来是这样的：
- en: '[PRE1]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: To learn more about options, read the `options(4)` man page.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 要了解更多关于选项的信息，请阅读 `options(4)` 手册页。
- en: Device Drivers
  id: totrans-55
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 设备驱动程序
- en: Device drivers give the kernel the necessary software to interact with a piece
    of hardware. If you want your kernel to support a piece of hardware, it must include
    the appropriate device driver.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 设备驱动程序为内核提供与硬件交互所需的软件。如果你想让你的内核支持某块硬件，它必须包含适当的设备驱动程序。
- en: Device driver kernel configuration entries can be quite long. They might include
    flags or settings that tell the kernel where to find the device and how to initialize
    it. (ISA cards usually have a hard-coded IRQ and/or memory address.)
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 设备驱动程序内核配置条目可能相当长。它们可能包括标志或设置，告诉内核在哪里找到设备以及如何初始化它。（ISA 卡通常有硬编码的 IRQ 和/或内存地址。）
- en: Device drivers have no common label, but their entry starts with the device
    name.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 设备驱动程序没有共同的标签，但它们的条目以设备名称开头。
- en: '[PRE2]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Pseudo-Devices
  id: totrans-60
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 伪设备
- en: '*Pseudo-devices* behave much like devices, but have no real hardware attached
    to them. Pseudo-devices are frequently abstractions that can be opened, read from,
    written to, and closed in the same way as real hardware.'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: '*伪设备* 的行为与设备非常相似，但没有任何真实硬件与之相连。伪设备通常是抽象的，可以像真实硬件一样打开、读取、写入和关闭。'
- en: For example, the loopback interface is a pseudo-device used for network connections
    to the local machine. (Your computer has no loopback network card, but the loopback
    interface behaves just like a real network card with an unusual MTU value.)
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，回环接口是一个用于连接本地机器的网络连接的伪设备。（你的计算机没有回环网络卡，但回环接口的行为就像一个具有不寻常 MTU 值的真实网络卡。）
- en: Pseudo-devices are labeled with `pseudo-device`.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 伪设备用 `pseudo-device` 标记。
- en: '[PRE3]'
  id: totrans-64
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Keywords
  id: totrans-65
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 关键字
- en: 'Finally, a handful of other keywords appear only once or rarely. These one-offs
    change how the kernel runs or how it’s built, and defy easy categorization. The
    following keywords may appear:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，一些其他的关键字只出现一次或很少出现。这些一次性更改会影响内核的运行方式或构建方式，难以归类。以下关键字可能会出现：
- en: The `machine` keyword tells the kernel which architecture it should run on.
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`machine` 关键字告诉内核它应该在哪种架构上运行。'
- en: The `makeoptions` keyword tells the compiler how to build the kernel.
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`makeoptions` 关键字告诉编译器如何构建内核。'
- en: The `include` keyword means pull in another configuration file.
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`include` 关键字表示引入另一个配置文件。'
- en: The `maxusers` value sets the size of some in-kernel tables.
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`maxusers` 值设置了一些内核表中的大小。'
- en: You’ll find even less common keywords scattered in different kernel configurations.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 你会发现更不常见的关键字散布在不同的内核配置中。
- en: '[PRE4]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: All of these affect the kernel in wildly different ways. You’ll find several
    of these keywords in any kernel, even GENERIC.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 所有这些都会以截然不同的方式影响内核。你会在任何内核中找到这些关键字，即使是 GENERIC。
- en: Configuring GENERIC
  id: totrans-74
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 配置 GENERIC
- en: Let’s look at an actual kernel configuration. OpenBSD divides kernel configuration
    into machine-independent and machine-dependent files.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看实际的内核配置。OpenBSD 将内核配置分为机器无关和机器相关文件。
- en: Machine-Independent Configuration
  id: totrans-76
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 机器无关配置
- en: The machine-independent kernel configuration files are in */usr/src/sys/conf*.
    The file */usr/src/sys/conf/GENERIC* contains the machine-independent kernel configuration,
    which describes all of the features that OpenBSD supports on all hardware platforms.
    Every GENERIC kernel contains the configuration in this file. If you change this
    file, it will affect every kernel built that includes this file.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 机器无关的内核配置文件位于*/usr/src/sys/conf*。文件*/usr/src/sys/conf/GENERIC*包含机器无关的内核配置，它描述了OpenBSD在所有硬件平台上支持的所有功能。每个GENERIC内核都包含这个文件中的配置。如果你更改此文件，它将影响包含此文件的每个构建的内核。
- en: The machine-independent configuration file doesn’t contain device drivers; instead,
    devices are tied to particular hardware. This file won’t contain any special building
    instructions, because they vary from platform to platform. Nor will it include
    hard-coded system limits, data structure sizes, and so on, as OpenBSD running
    on a 25-year-old VAX has considerably fewer resources than a brand-new amd64 system.
    The */usr/src/sys/conf/GENERIC* file contains mostly options and pseudo-devices.
    Every OpenBSD kernel must support a filesystem, or it won’t be able to write to
    disk or anything disk-like.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 机器无关的配置文件不包含设备驱动程序；相反，设备与特定硬件相关联。此文件不会包含任何特殊的构建指令，因为它们因平台而异。它也不会包括硬编码的系统限制、数据结构大小等，因为运行在25年前VAX上的OpenBSD与全新的amd64系统相比资源要少得多。*/usr/src/sys/conf/GENERIC*文件主要包含选项和伪设备。每个OpenBSD内核都必须支持文件系统，否则它将无法写入磁盘或类似磁盘的设备。
- en: A kernel based on this file doesn’t yet know what sort of hardware the filesystem
    will run on, but it knows how to make a filesystem. It doesn’t know what kind
    of network card it will have, but once you give it a network card, it can create
    a TCP data stream and serve your web pages. You’ll need the machine-dependent
    configuration to make a kernel that can function in the real world.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 基于此文件的内核尚不知道文件系统将在哪种硬件上运行，但它知道如何创建文件系统。它不知道将有什么样的网卡，但一旦你给它一个网卡，它就可以创建TCP数据流并为你提供网页服务。你需要机器相关的配置来制作一个能在现实世界中运行的内核。
- en: Machine-Dependent Configuration
  id: totrans-80
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 机器相关配置
- en: Each platform has its own machine-dependent kernel directory under */usr/src/sys/arch*.
    Here’s where you’ll find a subdirectory for every platform OpenBSD supports, as
    well as a directory for any platforms under development. Separate directories
    contain platform-specific code, as well as further *conf* subdirectories for the
    kernel configuration file.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 每个平台在*/usr/src/sys/arch*下都有自己的机器相关内核目录。在这里，你可以找到OpenBSD支持的每个平台的子目录，以及任何开发中的平台的目录。单独的目录包含特定平台的代码，以及用于内核配置文件的进一步的*conf*子目录。
- en: I’m using amd64 as an example, so the kernel configuration directory is */usr/src/sys/arch/amd64/conf*.
    While we’ll focus on the common i386 and amd64 architectures, the kernel-building
    process is the same across all hardware platforms.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 我以amd64为例，因此内核配置目录是*/usr/src/sys/arch/amd64/conf*。虽然我们将关注常见的i386和amd64架构，但内核构建过程在所有硬件平台上都是相同的。
- en: 'A traditional kernel configuration filename is in all capital letters. You’ll
    see the *GENERIC* configuration, as well as the *RAMDISK** files used for the
    installation disks. (The *GENERIC.MP* kernel is the multiprocessor kernel.) We’ll
    start with the *GENERIC* kernel configuration file:'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 传统的内核配置文件名全部为大写字母。你会看到*GENERIC*配置，以及用于安装盘的*RAMDISK**文件。（*GENERIC.MP*内核是多处理器内核。）我们将从*GENERIC*内核配置文件开始：
- en: '[PRE5]'
  id: totrans-84
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The first entry in this kernel configuration defines the machine.The machine
    definition tells the kernel configuration parser the kind of hardware you’re running,
    and defines core hardware characteristics and constraints, such as how many bits
    are in an integer and how much memory the system can support.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 这个内核配置文件中的第一个条目定义了机器。机器定义告诉内核配置解析器你正在运行哪种硬件，并定义核心硬件特性和约束，例如整数的位数和系统可以支持的内存量。
- en: The second entry pulls in the machine-independent kernel configuration (described
    in the previous section), defining all of the protocols and tools that make OpenBSD
    OpenBSD. The amd64 kernel inherits the filesystems and network stacks from this
    entry.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个条目引入了机器无关的内核配置（在上一节中描述），定义了所有使OpenBSD成为OpenBSD的协议和工具。amd64内核从这一条目继承了文件系统和网络堆栈。
- en: Following these two lines you’ll see the devices OpenBSD supports on amd64 hardware.
    Take a moment and skim the file. It’s the same mix of devices and attachments
    as described earlier in this chapter.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 在这两行之后，您将看到OpenBSD在amd64硬件上支持的设备。花点时间浏览一下文件。它包含的设备和附件与本章前面描述的相同。
- en: Your Kernel Configuration
  id: totrans-88
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 您的内核配置
- en: In order to build your own kernel, you’ll need a configuration file. Here, we’ll
    look at how to create your configuration file. (Do not just edit either GENERIC
    kernel file.)
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 为了构建您自己的内核，您需要一个配置文件。在这里，我们将探讨如何创建配置文件。（不要只是编辑任一GENERIC内核文件。）
- en: Minor Changes
  id: totrans-90
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 小幅修改
- en: 'If your kernel adds only a couple of items to the GENERIC kernel, use the GENERIC
    configuration as a basis for your new one. For example, here’s the multiprocessor
    kernel configuration, GENERIC.MP:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您的内核只向GENERIC内核添加了几个项目，请将GENERIC配置作为您新配置的基础。例如，以下是多处理器内核配置，GENERIC.MP：
- en: '[PRE6]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The multiprocessor kernel builds on GENERIC, adding only one option and one
    device attachment. You can use this model to define your own kernel configuration.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 多处理器内核基于GENERIC构建，只添加了一个选项和一个设备附件。您可以使用这个模型来定义自己的内核配置。
- en: 'For example, suppose you want to enable the experimental SCSI multipathing
    feature on a kernel. You could create a kernel configuration file in your platform
    directory, and simply copy the commented-out multipathing entries from the machine-independent
    GENERIC kernel, like this:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，假设您想在内核中启用实验性的SCSI多路径功能。您可以在平台目录中创建一个内核配置文件，并简单地复制从机器无关的GENERIC内核中注释掉的multipathing条目，如下所示：
- en: '[PRE7]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: This creates a custom kernel that closely resembles GENERIC, with these two
    extra devices.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 这将创建一个与GENERIC非常相似的定制内核，增加了这两个额外的设备。
- en: Removing Options
  id: totrans-97
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 移除选项
- en: 'To strip options from your kernel, use the `rmoption` keyword. For example,
    to create a minimal kernel based on GENERIC, you could use the `rmoption` keyword
    to remove some kernel options, as in this example:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 要从内核中移除选项，请使用`rmoption`关键字。例如，要创建一个基于GENERIC的最小内核，您可以使用`rmoption`关键字来移除一些内核选项，如下例所示：
- en: '[PRE8]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: One advantage to creating a configuration by including the default kernel is
    that when you update your source code, your custom kernel configuration will probably
    still be valid. However, the more options you remove from the kernel, the greater
    the chance that the kernel will fail to compile, or if it compiles, that it might
    not boot. And if it boots, it might eat your hard drive.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 通过包含默认内核来创建配置的一个优点是，当您更新源代码时，您的自定义内核配置可能仍然有效。然而，您从内核中移除的选项越多，内核编译失败的可能性就越大，或者即使编译成功，它可能无法启动。如果启动了，它可能会损坏您的硬盘。
- en: When removing options, keep in mind that some options are more important than
    you might think. For example, removing the `INET6` option (aka IPv6) can create
    a nonfunctional system. Removing options doesn’t save you much memory, and it
    might cripple any number of programs.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 在移除选项时，请记住，一些选项可能比您想象的更重要。例如，移除`INET6`选项（即IPv6）可能会创建一个无法正常工作的系统。移除选项并不会节省您多少内存，而且可能会损害许多程序。
- en: Removing Devices
  id: totrans-102
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 移除设备
- en: If you want to remove a lot of stuff from a machine-dependent kernel configuration,
    while retaining the options for base OpenBSD functions, copy the machine-dependent
    GENERIC configuration file to a new text file and make your changes in that file.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想从机器相关的内核配置中移除大量内容，同时保留基础OpenBSD功能选项，请将机器相关的GENERIC配置文件复制到一个新的文本文件中，并在该文件中进行修改。
- en: Wholesale Butchery
  id: totrans-104
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 大规模修改
- en: 'If you want to commit wholesale butchery on the kernel, you’ll want a configuration
    that includes both the machine-independent and machine-dependent parts. Start
    by copying the existing GENERIC kernel configurations into one file, in the platform’s
    kernel configuration. Here, I call my new kernel TREBLE, after the hostname:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想对内核进行大规模的修改，您需要一个包含机器无关和机器相关部分的配置。首先，将现有的GENERIC内核配置复制到一个文件中，在平台的内核配置中。在这里，我将我的新内核命名为TREBLE，以主机名命名：
- en: '[PRE9]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Before making any other changes, remove the line that includes the machine-independent
    kernel configuration file. Then slice out everything that makes the system functional,
    and try to build the new kernel. Next, add stuff back in until the kernel builds.
    (Although removing drivers won’t save much memory, doing so will make booting
    a tiny bit faster.)
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 在进行任何其他更改之前，请删除包含机器无关内核配置文件的行。然后移除使系统功能的一切，并尝试构建新的内核。接下来，逐步添加内容，直到内核构建成功。（尽管移除驱动程序不会节省多少内存，但这样做会使启动稍微快一点。）
- en: Note
  id: totrans-108
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: You might be tempted to use the man pages to create your own kernel configuration
    from scratch. You’re certainly free to do that, if you’re either a Kernel Lord
    or an irremediable doofus. Feel free to try it. Every sysadmin can use such a
    valuable lesson in humility.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会想使用手册页从头开始创建自己的内核配置。如果你是内核之王或不可救药的傻瓜，你当然可以这样做。请随意尝试。每个系统管理员都可以从这样宝贵的谦卑课程中受益。
- en: Stripping Down the Kernel
  id: totrans-110
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 内核瘦身
- en: Every device driver and option in the kernel uses memory. If you’re trying to
    cram OpenBSD onto a tiny computer, or you’re doing any sort of embedded development,
    you might want to build a custom kernel that includes as few device drivers as
    possible by editing */var/run/dmesg.boot*, where every entry matches a line in
    the kernel configuration.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 内核中的每个设备驱动程序和选项都使用内存。如果你试图将OpenBSD塞入一个小型计算机，或者你正在进行任何类型的嵌入式开发，你可能想构建一个自定义内核，通过编辑`/var/run/dmesg.boot`来包含尽可能少的设备驱动程序，其中每个条目都与内核配置中的一行匹配。
- en: The simplest way to trim out unnecessary device drivers is to remove everything
    that’s not in your computer. The kernel includes dozens of network card drivers,
    but you need only one or two. If you’re unsure about a device, keep it in the
    configuration. (The ACPI and BIOS devices in particular are tightly interrelated,
    and you’ll probably have a really hard time building a bootable custom kernel
    without the complete set of ACPI and BIOS devices.)
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 删除不必要的设备驱动程序的最简单方法是删除计算机中不存在的所有内容。内核包括数十个网络卡驱动程序，但你只需要一个或两个。如果你不确定一个设备，请将其保留在配置中。（特别是ACPI和BIOS设备与它们紧密相关，没有完整的ACPI和BIOS设备集，你可能会发现构建可启动的自定义内核非常困难。）
- en: Gutting the Kernel
  id: totrans-113
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 内核剖析
- en: If removing device drivers doesn’t create a sufficiently small kernel for you,
    try removing machine-independent options. Many of these options are interdependent,
    however, and removing them can create a kernel you can’t compile. If you can compile
    the kernel, it might not boot, and if it boots, it might not function correctly.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你删除设备驱动程序后没有为你创建足够小的内核，尝试删除与机器无关的选项。然而，许多这些选项是相互依赖的，删除它们可能会创建一个无法编译的内核。如果你能编译内核，它可能无法启动，如果启动了，可能无法正确运行。
- en: Testing Your Kernel Configuration with config(8)
  id: totrans-115
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用config(8)测试你的内核配置
- en: Is your custom kernel configuration internally consistent? To test your kernel
    and prepare the files needed to compile it, use `config(8)`.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 你的自定义内核配置内部一致吗？为了测试内核并准备编译所需的文件，请使用`config(8)`。
- en: 'While still in the kernel configuration directory, give `config` the kernel
    configuration filename as an argument, like this:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 在内核配置目录中时，将内核配置文件名作为参数传递给`config`，如下所示：
- en: '[PRE10]'
  id: totrans-118
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: If you get any error messages, read them. For example, `config` might tell you
    that you need to run `make clean` before building your new kernel, or that your
    kernel configuration is internally inconsistent and will not compile. If there’s
    a problem, `config` will often give a line number where you made an error. Follow
    any advice `config` offers.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 如果收到任何错误信息，请阅读它们。例如，`config`可能会告诉你，在构建新内核之前需要运行`make clean`，或者你的内核配置内部不一致，无法编译。如果有问题，`config`通常会给出你出错的那一行行号。遵循`config`提供的任何建议。
- en: The following are some of the more common types of errors.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是一些更常见的错误类型。
- en: Orphaned Devices
  id: totrans-121
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 孤儿设备
- en: 'One common way that `config` fails is if you’re missing a device that’s needed
    by another device. Here’s an example:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: '`config`失败的一个常见方式是如果你缺少另一个设备需要的设备。以下是一个例子：'
- en: '[PRE11]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Your configuration attaches various devices to `mainbus0`, but there’s no `mainbus0`
    entry in your configuration. Kernels that include devices that aren’t attached
    don’t make sense and cannot compile.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 你的配置将各种设备附加到`mainbus0`，但你的配置中没有`mainbus0`条目。包含未附加设备的内核没有意义，也无法编译。
- en: To address this, examine your hardware again. Figure out how these devices are
    supposed to attach to the system, and fix your kernel configuration.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 为了解决这个问题，再次检查你的硬件。弄清楚这些设备应该如何连接到系统，并修复你的内核配置。
- en: Bogus Hardware
  id: totrans-126
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 虚假硬件
- en: Another common problem is including nonexistent device drivers, which generates
    the following error.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个常见问题是包含不存在的设备驱动程序，这会产生以下错误。
- en: '[PRE12]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: '`config` shows me the error and the line number where it occurs. There is no
    `cpe` device, but there is a `cpu` device. My bad.'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: '`config`会显示错误及其发生的位置。没有`cpe`设备，但有一个`cpu`设备。是我的错。'
- en: The error checking performed by `config` does not guarantee that your kernel
    will compile or run as expected. The only errors it catches are ones where the
    configuration is either internally inconsistent or flat-out wrong. The first real
    test comes when you try to actually build your configured kernel.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: '`config` 执行的错误检查并不能保证您的内核会按预期编译或运行。它捕获的唯一错误是配置内部不一致或完全错误的情况。真正的第一次测试是在您尝试实际构建配置好的内核时。'
- en: Building a Kernel
  id: totrans-131
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 构建内核
- en: If `config` ran successfully, you will have a kernel compilation directory including
    a makefile and a whole slew of header files. The traditional place for the *compile*
    directory is under the platform directory, which is */usr/src/sys/arch/amd64*
    for amd64 hardware.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 如果 `config` 运行成功，您将有一个包含 makefile 和大量头文件的内核编译目录。*编译* 目录的传统位置是在平台目录下，对于 amd64
    硬件，该位置是 */usr/src/sys/arch/amd64*。
- en: The compile directory contains a subdirectory for each kernel configuration
    processed by `config`. My amd64 kernel called TREBLE is in the */usr/src/sys/arch/amd64/compile/TREBLE*
    directory, which contains a makefile, as well as all the header files for all
    included devices and options.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 编译目录包含由 `config` 处理的每个内核配置的子目录。我名为 TREBLE 的 amd64 内核位于 */usr/src/sys/arch/amd64/compile/TREBLE*
    目录下，其中包含一个 makefile，以及所有包含设备和选项的头文件。
- en: '[PRE13]'
  id: totrans-134
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Now it’s time to wait. A successful compilation will create a kernel file *bsd*
    without generating any error messages.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 现在是等待的时候了。如果编译成功，将创建一个名为 *bsd* 的内核文件，而不会生成任何错误信息。
- en: Kernel Build Errors
  id: totrans-136
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 内核构建错误
- en: 'If your kernel fails to build, you probably have a perfectly explicable error.
    First, read the error message given by the compilation. Most of the time, the
    error message will explain what the kernel is missing. Generally, you will need
    to change your kernel configuration in some manner because of an error that `config`
    could not catch. A broken kernel compilation will end something like this:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您的内核构建失败，您可能有一个完全可以解释的错误。首先，阅读编译提供的错误信息。大多数时候，错误信息将解释内核缺少什么。通常，您需要以某种方式更改内核配置，因为
    `config` 无法捕获错误。损坏的内核编译将结束如下：
- en: '[PRE14]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: This kernel cannot be built because something is missing. When a build fails
    with statements that something “is undeclared” (as shown in bold), that’s a hint
    that the kernel is missing a necessary entry.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 由于缺少某些内容，这个内核无法构建。当构建失败并显示“未声明”之类的语句（如粗体所示）时，这是一个提示，表明内核缺少必要的条目。
- en: The name of where it failed might offer you a hint as to what’s missing. In
    this case, at **1**, I have a function name where the compilation failed, and
    then a specific undeclared variable **2** that caused the compilation to fail.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 失败的位置名称可能为您提供有关缺少内容的提示。在这种情况下，在 **1**，我在编译失败的地方有一个函数名，然后是一个特定的未声明变量 **2**，它导致编译失败。
- en: I would start by figuring out where the `pci_intr_map` function comes from and
    what it’s supposed to do. Search the source code and man pages for references
    to the missing function. Failing that, try the mailing list archives. Be sure
    to include the function and variable names in any web search. Generic output that
    says that “there was an error” **3** or “the compile has stopped” **4** is less
    unique, and hence it could be useful. If all else fails, fall back to the GENERIC
    configuration.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 我会先找出 `pci_intr_map` 函数的来源以及它应该做什么。在源代码和手册页中搜索对缺失函数的引用。如果那样做失败，尝试邮件列表存档。确保在任何网络搜索中都包含函数和变量名称。通用输出说“有错误”**3**或“编译已停止”**4**不那么独特，因此可能有用。如果所有其他方法都失败，退回到
    GENERIC 配置。
- en: Installing Your Kernel
  id: totrans-142
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 安装您的内核
- en: Your completed kernel is the file *bsd* in the compile directory. Before you
    use your new kernel, verify that you have your current, working, well-behaved
    kernel backed up to a separate file on the root filesystem, and then copy your
    new kernel to */bsd*. That’s it! The next time you reboot, you’ll come up on your
    new kernel.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 您完成的内核是编译目录中的 *bsd* 文件。在您使用新内核之前，请确保您当前的工作内核已备份到根文件系统上的单独文件，然后将新内核复制到 */bsd*。就这样！下次您重启时，您将使用新内核。
- en: Note
  id: totrans-144
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Some people do not like to copy their custom kernel to */bsd* until they’re
    certain that the kernel will boot. If you’re one of these people, copy your new
    kernel to the root directory under a different name, such as */bsd.test*. Boot
    into this alternate kernel. Test your system. If everything works, properly install
    your new kernel.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 有些人不喜欢在确定内核能够启动之前将自定义内核复制到 */bsd* 目录。如果你是这些人中的一员，请将你的新内核以不同的名称复制到根目录下，例如 */bsd.test*。以这个备用内核启动。测试你的系统。如果一切正常，请正确安装你的新内核。
- en: Identifying the Running Kernel
  id: totrans-146
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 识别正在运行的内核
- en: If you build several custom kernels, you might forget which kernel you’re running.
    The `uname(1)` command will tell you the name of the kernel configuration file
    used to build the running kernel. The `-v` flag will tell you the name of your
    kernel configuration and the number of times you have compiled it.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你构建了多个自定义内核，你可能会忘记你正在运行哪个内核。`uname(1)` 命令会告诉你用于构建正在运行内核的内核配置文件的名称。`-v` 标志会告诉你你的内核配置名称以及你编译它的次数。
- en: '[PRE15]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: This output does not mean that I’ve built a multiprocessor GENERIC kernel 348
    times. I use the GENERIC kernel, and I let the OpenBSD release engineers build
    my kernels for me. They have built 348 official snapshot multiprocessor kernels
    without wiping the kernel build directory. Remember that building custom kernels
    is for advanced programmers and ignorant newbies. I’m neither.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 这个输出并不意味着我已经构建了一个多处理器 GENERIC 内核 348 次。我使用 GENERIC 内核，并让 OpenBSD 发布工程师为我构建内核。他们已经构建了
    348 个官方快照多处理器内核，而没有清除内核构建目录。记住，构建自定义内核是为高级程序员和不知情的新手准备的。我既不是前者也不是后者。
