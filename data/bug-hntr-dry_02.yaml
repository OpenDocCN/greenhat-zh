- en: Chapter 2. Back to the ’90s
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第2章。回到90年代
- en: Note
  id: totrans-1
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 备注
- en: '*Sunday, October 12, 2008*'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: '*星期日，2008年10月12日*'
- en: '*Dear Diary*,'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '*亲爱的日记*，'
- en: I had a look at the source code of VideoLAN’s popular VLC media player today.
    I like VLC because it supports all different kinds of media files and runs on
    all my favorite operating system platforms. But supporting all those different
    media file formats has downsides. VLC does a lot of parsing, and that often means
    a lot of bugs just waiting to be discovered.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 我今天查看了VideoLAN的流行媒体播放器VLC的源代码。我喜欢VLC，因为它支持所有不同类型的媒体文件，并且在我的所有喜欢的操作系统平台上运行。但是支持所有这些不同的媒体文件格式也有缺点。VLC做了很多解析，这通常意味着有很多等待被发现的问题。
- en: Note
  id: totrans-5
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 备注
- en: 'According to *Parsing Techniques: A Practical Guide* by Dick Grune and Ceriel
    J.H. Jacobs,^([[6](ch02s05.html#ftn.CHP-2-FN-1)]) “Parsing is the process of structuring
    a linear representation in accordance with a given grammar.” A parser is software
    that breaks apart a raw string of bytes into individual words and statements.
    Depending on the data format, parsing can be a very complex and error-prone task.'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 根据 Dick Grune 和 Ceriel J.H. Jacobs 所著的《解析技术：实用指南》，“解析是根据给定的语法对线性表示进行结构化的过程。”解析器是一种软件，它将原始的字节串分解成单个单词和语句。根据数据格式，解析可能是一个非常复杂且容易出错的任务。
- en: After I became familiar with the inner workings of VLC, finding the first vulnerability
    took me only about half a day. It was a classic stack buffer overflow (see Section
    A.1). This one occurred while parsing a media file format called TiVo, the proprietary
    format native to TiVo digital recording devices. Before finding this bug, I had
    never heard of this file format, but that didn’t stop me from exploiting it.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 在我熟悉了VLC的内部工作原理后，找到第一个漏洞只花了大约半天时间。这是一个经典的堆栈缓冲区溢出（见附录A.1）。这个漏洞发生在解析一个名为TiVo的媒体文件格式时，这是TiVo数字录制设备的本地格式。在发现这个错误之前，我从未听说过这种文件格式，但这并没有阻止我利用它。
- en: 2.1 Vulnerability Discovery
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 2.1 漏洞发现
- en: 'Here is how I found the vulnerability:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是我发现漏洞的方法：
- en: 'Step 1: Generate a list of the demuxers of VLC.'
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第1步：生成VLC解复用器的列表。
- en: 'Step 2: Identify the input data.'
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第2步：识别输入数据。
- en: 'Step 3: Trace the input data.'
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第3步：追踪输入数据。
- en: I’ll explain this process in detail in the following sections.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 我将在以下几节中详细解释这个过程。
- en: 'Step 1: Generate a List of the Demuxers of VLC'
  id: totrans-14
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第1步：生成VLC解复用器的列表
- en: Note
  id: totrans-15
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 备注
- en: '*I used VLC 0.9.4 on the Microsoft Windows Vista SP1 (32-bit) platform for
    all the following steps*.'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: '*我在以下所有步骤中使用了Microsoft Windows Vista SP1 (32-bit)平台上的VLC 0.9.4*。'
- en: After downloading and unpacking the source code of VLC,^([[7](ch02s05.html#ftn.CHP-2-FN-2)])
    I generated a list of the available demuxers of the media player.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 在下载并解压缩VLC的源代码后，我生成了媒体播放器可用的解复用器列表。
- en: Note
  id: totrans-18
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 备注
- en: In digital video, *demuxing* or *demultiplexing* refers to the process of separating
    audio and video as well as other data from a video stream or container in order
    to play the file. A demuxer is software that extracts the components of such a
    stream or container.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在数字视频中，“解复用”或“解复用”是指将音频和视频以及其他数据从视频流或容器中分离出来的过程，以便播放文件。解复用器是一种提取此类流或容器组件的软件。
- en: Generating a list of demuxers wasn’t too hard, as VLC separates most of them
    in different C files in the directory *vlc-0.9.4\modules\demux\* (see [Figure 2-1](ch02.html#vlc_demuxer_list
    "Figure 2-1. VLC demuxer list")).
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 生成解复用器的列表并不太难，因为VLC将大多数解复用器分开在不同的C文件中，位于目录*vlc-0.9.4\modules\demux\*（见[图2-1](ch02.html#vlc_demuxer_list
    "图2-1. VLC解复用器列表")）。
- en: '![VLC demuxer list](httpatomoreillycomsourcenostarchimages939229.png.jpg)'
  id: totrans-21
  prefs: []
  type: TYPE_IMG
  zh: '![VLC解复用器列表](httpatomoreillycomsourcenostarchimages939229.png.jpg)'
- en: Figure 2-1. VLC demuxer list
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 图2-1. VLC解复用器列表
- en: 'Step 2: Identify the Input Data'
  id: totrans-23
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第2步：识别输入数据
- en: Next, I tried to identify the input data processed by the demuxers. After reading
    some C code, I stumbled upon the following structure, which is declared in a header
    file included in every demuxer.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我试图识别由解复用器处理的输入数据。在阅读了一些C代码后，我偶然发现了一个结构，它在每个解复用器包含的头文件中声明。
- en: '**Source code file**'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: '**源代码文件**'
- en: '*vlc-0.9.4\include\vlc_demux.h*'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: '*vlc-0.9.4\include\vlc_demux.h*'
- en: '[PRE0]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'In line 54, the structure element `s` is declared and described as `input stream`.
    This was exactly what I was searching for: a reference to the input data that
    is processed by the demuxers.'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 在第54行，结构元素`s`被声明并描述为`输入流`。这正是我所寻找的：一个指向由解复用器处理的输入数据的引用。
- en: 'Step 3: Trace the Input Data'
  id: totrans-29
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第3步：追踪输入数据
- en: After I discovered the `demux_t` structure and its input stream element, I searched
    the demuxer files for references to it. The input data was usually referenced
    by `p_demux->s`, as shown in lines 1623 and 1641 below. When I found such a reference,
    I traced the input data while looking for coding errors. Using this approach,
    I found the following vulnerability.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 在我发现`demux_t`结构和它的输入流元素后，我在解复用器文件中搜索对它的引用。输入数据通常通过`p_demux->s`来引用，如下面的第1623行和第1641行所示。当我找到这样的引用时，我在寻找编码错误的同时追踪输入数据。使用这种方法，我发现了以下漏洞。
- en: '**Source code file**'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: '**源代码文件**'
- en: '*vlc-0.9.4\modules\demux\Ty.c*'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: '*vlc-0.9.4\modules\demux\Ty.c*'
- en: '**Function**'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: '**函数**'
- en: '`parse_master()`'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: '`parse_master()`'
- en: '[PRE1]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: The `stream_Read()` function in line 1641 reads 32 bytes of user-controlled
    data from a TiVo media file (referenced by `p_demux->s`) and stores them in the
    stack buffer `mst_buf`, declared in line 1626\. The `U32_AT` macro in line 1642
    then extracts a user-controlled value from `mst_buf` and stores it in the signed
    int variable `i_map_size`. In line 1650, the `stream_Read()` function stores user-controlled
    data from the media file in the stack buffer `mst_buf` again. But this time, `stream_Read()`
    uses the user-controlled value of `i_map_size` to calculate the size of the data
    that gets copied into `mst_buf`. This leads to a straight stack buffer overflow
    (see Section A.1) that can be easily exploited.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 第1641行的`stream_Read()`函数从TiVo媒体文件（通过`p_demux->s`引用）中读取32字节用户控制的数据并将其存储在堆栈缓冲区`mst_buf`中，该缓冲区在第1626行声明。第1642行的`U32_AT`宏随后从`mst_buf`中提取一个用户控制值并将其存储在有符号整型变量`i_map_size`中。在第1650行，`stream_Read()`函数再次将媒体文件中的用户控制数据存储在堆栈缓冲区`mst_buf`中。但这次，`stream_Read()`使用用户控制的`i_map_size`值来计算要复制到`mst_buf`中的数据的大小。这导致了一个直接的堆栈缓冲区溢出（见第A.1节），它很容易被利用。
- en: 'Here is the anatomy of the bug, as illustrated in [Figure 2-2](ch02s02.html#overview_of_the_vulnerability_from_input
    "Figure 2-2. Overview of the vulnerability from input to stack buffer overflow"):'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是漏洞的解剖结构，如图2-2所示[图2-2](ch02s02.html#overview_of_the_vulnerability_from_input
    "图2-2. 从输入到堆栈缓冲区溢出的漏洞概述")。
- en: 32 bytes of user-controlled TiVo media file data are copied into the stack buffer
    `mst_buf`. The destination buffer has a size of 32 bytes.
  id: totrans-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将32字节用户控制的TiVo媒体文件数据复制到堆栈缓冲区`mst_buf`中。目标缓冲区的大小为32字节。
- en: 4 bytes of user-controlled data are extracted from the buffer and stored in
    `i_map_size`.
  id: totrans-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从缓冲区中提取了4字节用户控制的数据并存储在`i_map_size`中。
- en: User-controlled TiVo media-file data is copied into `mst_buf` once again. This
    time, the size of the copied data is calculated using `i_map_size`. If `i_map_size`
    has a value greater than 24, a stack buffer overflow will occur (see Section A.1).
  id: totrans-40
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 用户控制的TiVo媒体文件数据再次被复制到`mst_buf`中。这次，复制数据的尺寸是通过`i_map_size`计算的。如果`i_map_size`的值大于24，将发生堆栈缓冲区溢出（见第A.1节）。
- en: 2.2 Exploitation
  id: totrans-41
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 2.2 利用
- en: 'To exploit the vulnerability, I performed the following steps:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 为了利用这个漏洞，我执行了以下步骤：
- en: 'Step 1: Find a sample TiVo movie file.'
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第1步：找到样本TiVo电影文件。
- en: 'Step 2: Find a code path to reach the vulnerable code.'
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第2步：找到到达有漏洞代码的代码路径。
- en: 'Step 3: Manipulate the TiVo movie file to crash VLC.'
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第3步：操纵TiVo电影文件以使VLC崩溃。
- en: 'Step 4: Manipulate the TiVo movie file to gain control of `EIP`.'
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第4步：操纵TiVo电影文件以控制`EIP`。
- en: '![Overview of the vulnerability from input to stack buffer overflow](httpatomoreillycomsourcenostarchimages939231.png.jpg)'
  id: totrans-47
  prefs: []
  type: TYPE_IMG
  zh: '![从输入到堆栈缓冲区溢出的漏洞概述](httpatomoreillycomsourcenostarchimages939231.png.jpg)'
- en: Figure 2-2. Overview of the vulnerability from input to stack buffer overflow
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 图2-2. 从输入到堆栈缓冲区溢出的漏洞概述
- en: There’s more than one way to exploit a file-format bug. You can create a file
    with the right format from scratch, or you can manipulate a valid preexisting
    file. I chose the latter in this example.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 利用文件格式漏洞的方法不止一种。你可以从头开始创建具有正确格式的文件，或者你可以操纵一个有效的现有文件。在这个例子中，我选择了后者。
- en: 'Step 1: Find a Sample TiVo Movie File'
  id: totrans-50
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第1步：找到样本TiVo电影文件
- en: Note
  id: totrans-51
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*The website* [http://samples.mplayerhq.hu/](http://samples.mplayerhq.hu/)
    *is a good starting point to search for all kinds of multimedia file-format samples*'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: '*该网站* [http://samples.mplayerhq.hu/](http://samples.mplayerhq.hu/) *是搜索各种多媒体文件格式样本的好起点*'
- en: 'First I downloaded the following TiVo sample file from [http://samples.mplayerhq.hu/](http://samples.mplayerhq.hu/):'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我从以下网址下载了以下TiVo样本文件：[http://samples.mplayerhq.hu/](http://samples.mplayerhq.hu/)。
- en: '[PRE2]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Step 2: Find a Code Path to Reach the Vulnerable Code'
  id: totrans-55
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第2步：找到到达有漏洞代码的代码路径
- en: I couldn’t find documentation on the specifications of the TiVo file format,
    so I read the source code in order to find a path to reach the vulnerable code
    in `parse_master()`.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 我找不到有关 TiVo 文件格式规范的文档，因此我阅读了源代码以找到到达 `parse_master()` 中易受攻击代码的路径。
- en: 'If a TiVo file is loaded by VLC, the following execution flow is taken (all
    source code references are from *vlc-0.9.4\modules\demux\Ty.c* of VLC). The first
    relevant function that’s called is `Demux()`:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 如果 VLC 加载了 TiVo 文件，则会采取以下执行流程（所有源代码引用均来自 VLC 的 *vlc-0.9.4\modules\demux\Ty.c*）。首先调用的相关函数是
    `Demux()`：
- en: '[PRE3]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: After some sanity checks in lines 395 and 413, the function `get_chunk_header()`
    is called in line 415.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 在第 395 行和 413 行进行了一些合理性检查后，在第 415 行调用了函数 `get_chunk_header()`。
- en: '[PRE4]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: In line 1856 of `get_chunk_header()`, the user-controlled data from the TiVo
    file is assigned to the pointer `p_peek`. Then, in line 1867, the process checks
    whether the file data pointed to by `p_peek` equals `TIVO_PES_FILEID` (which is
    defined as `0xf5467abd` in line 112). If so, the vulnerable function `parse_master()`
    gets called (see line 1870).
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 在 `get_chunk_header()` 的第 1856 行，从 TiVo 文件中获取的用户控制数据被分配给指针 `p_peek`。然后，在第 1867
    行，进程检查由 `p_peek` 指向的文件数据是否等于 `TIVO_PES_FILEID`（在第 112 行定义为 `0xf5467abd`）。如果是这样，易受攻击的函数
    `parse_master()` 就会被调用（见第 1870 行）。
- en: To reach the vulnerable function using this code path, the TiVo sample file
    had to contain the value of `TIVO_PES_FILEID`. I searched the TiVo sample file
    for the `TIVO_PES_FILEID` pattern and found it at file offset `0x00300000` (see
    [Figure 2-3](ch02s02.html#tivo_underscore_pes_underscore_fileid_pa "Figure 2-3. TIVO_PES_FILEID
    pattern in TiVo sample file")).
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 要通过此代码路径到达易受攻击的函数，TiVo 示例文件必须包含 `TIVO_PES_FILEID` 的值。我在 TiVo 示例文件中搜索 `TIVO_PES_FILEID`
    模式，并在文件偏移量 `0x00300000` 处找到它（见 [图 2-3](ch02s02.html#tivo_underscore_pes_underscore_fileid_pa
    "图 2-3. TiVo 示例文件中的 TIVO_PES_FILEID 模式")）。
- en: '![TIVO_PES_FILEID pattern in TiVo sample file](httpatomoreillycomsourcenostarchimages939233.png.jpg)'
  id: totrans-63
  prefs: []
  type: TYPE_IMG
  zh: '![TiVo 示例文件中的 TIVO_PES_FILEID 模式](httpatomoreillycomsourcenostarchimages939233.png.jpg)'
- en: Figure 2-3. `TIVO_PES_FILEID` pattern in TiVo sample file
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 图 2-3. TiVo 示例文件中的 `TIVO_PES_FILEID` 模式
- en: Based on the information from the `parse_master()` function (see the following
    source code snippet) the value of `i_map_size` should be found at offset 20 (`0x14`)
    relative to the `TIVO_PES_FILEID` pattern found at file offset `0x00300000`.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 根据 `parse_master()` 函数的信息（见以下源代码片段），`i_map_size` 的值应该位于相对于在文件偏移量 `0x00300000`
    找到的 `TIVO_PES_FILEID` 模式的偏移量 20 (`0x14`) 处。
- en: '[PRE5]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: At this point, I had discovered that the TiVo sample file I downloaded already
    triggers the vulnerable `parse_master()` function, so it wouldn’t be necessary
    to adjust the sample file. Great!
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 在这一点上，我发现我下载的 TiVo 示例文件已经触发了易受攻击的 `parse_master()` 函数，因此不需要调整示例文件。太好了！
- en: 'Step 3: Manipulate the TiVo Movie File to Crash VLC'
  id: totrans-68
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第 3 步：操纵 TiVo 电影文件以使 VLC 崩溃
- en: Note
  id: totrans-69
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*Get the vulnerable Windows version of VLC from* [http://download.videolan.org/pub/videolan/vlc/0.9.4/win32/](http://download.videolan.org/pub/videolan/vlc/0.9.4/win32/).'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: '*从以下链接获取易受攻击的 Windows 版本 VLC* [http://download.videolan.org/pub/videolan/vlc/0.9.4/win32/](http://download.videolan.org/pub/videolan/vlc/0.9.4/win32/).'
- en: Next, I tried to manipulate the TiVo sample file in order to crash VLC. To achieve
    this, all I had to do was change the 4-byte value at the sample file offset of
    `i_map_size` (which was `0x00300014` in this example).
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我尝试操纵 TiVo 示例文件以使 VLC 崩溃。为了实现这一点，我只需更改示例文件偏移量 `i_map_size` 处的 4 字节值（在这个例子中是
    `0x00300014`）。
- en: As illustrated in [Figure 2-4](ch02s02.html#new_value_for_i_underscore_map_underscor
    "Figure 2-4. New value for i_map_size in TiVo sample file"), I changed the 32-bit
    value at file offset `0x00300014` from `0x00000002` to `0x000000ff`. The new value
    of 255 bytes (`0xff`) should be enough to overflow the 32-byte stack buffer and
    to overwrite the return address stored after the buffer on the stack (see Section
    A.1). Next, I opened the altered sample file with VLC while debugging the media
    player with Immunity Debugger.^([[8](ch02s05.html#ftn.CHP-2-FN-3)]) The movie
    file was played as before, but after a few seconds—as soon as the altered file
    data was processed—the VLC player crashed, with the result shown in [Figure 2-5](ch02s02.html#vlc_access_violation_in_immunity_debugge
    "Figure 2-5. VLC access violation in Immunity Debugger").
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 如 [图 2-4](ch02s02.html#new_value_for_i_underscore_map_underscor "图 2-4. TiVo
    样本文件中 i_map_size 的新值") 所示，我将文件偏移 `0x00300014` 处的 32 位值从 `0x00000002` 更改为 `0x000000ff`。新的
    255 字节（`0xff`）值应该足以溢出 32 字节栈缓冲区，并覆盖在栈上缓冲区之后存储的返回地址（见附录 A.1）。接下来，我在使用 Immunity
    Debugger 调试媒体播放器的同时，用 VLC 打开了修改后的样本文件。[8](ch02s05.html#ftn.CHP-2-FN-3)] 电影文件像以前一样播放，但几秒钟后——一旦处理了修改后的文件数据——VLC
    播放器崩溃，结果如 [图 2-5](ch02s02.html#vlc_access_violation_in_immunity_debugge "图 2-5.
    在 Immunity Debugger 中的 VLC 访问违规") 所示。
- en: '![New value for i_map_size in TiVo sample file](httpatomoreillycomsourcenostarchimages939235.png.jpg)'
  id: totrans-73
  prefs: []
  type: TYPE_IMG
  zh: '![TiVo 样本文件中 i_map_size 的新值](httpatomoreillycomsourcenostarchimages939235.png.jpg)'
- en: Figure 2-4. New value for `i_map_size` in TiVo sample file
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 图 2-4. TiVo 样本文件中 `i_map_size` 的新值
- en: '![VLC access violation in Immunity Debugger](httpatomoreillycomsourcenostarchimages939237.png.jpg)'
  id: totrans-75
  prefs: []
  type: TYPE_IMG
  zh: '![在 Immunity Debugger 中的 VLC 访问违规](httpatomoreillycomsourcenostarchimages939237.png.jpg)'
- en: Figure 2-5. VLC access violation in Immunity Debugger
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 图 2-5. 在 Immunity Debugger 中的 VLC 访问违规
- en: As expected, VLC crashed while parsing the malformed TiVo file. The crash was
    very promising, since the instruction pointer (`EIP` register) was pointing to
    an invalid memory location (indicated by the message `Access violation when executing
    [20030000]` in the status bar of the debugger). This might mean that I could easily
    gain control of the instruction pointer.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 如预期的那样，在解析格式错误的 TiVo 文件时，VLC 发生了崩溃。这次崩溃非常有希望，因为指令指针（`EIP` 寄存器）指向了一个无效的内存位置（在调试器的状态栏中显示为“执行[20030000]时访问违规”）。这可能意味着我可以轻易地控制指令指针。
- en: 'Step 4: Manipulate the TiVo Movie File to Gain Control of EIP'
  id: totrans-78
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第 4 步：操纵 TiVo 电影文件以控制 EIP
- en: My next step was to determine which bytes of the sample file actually overwrote
    the return address of the current stack frame so that I could take control of
    `EIP`. The debugger stated that `EIP` had a value of `0x20030000` at the time
    of the crash. To determine which offset this value is found at, I could try to
    calculate the exact file offset, or I could simply search the file for the byte
    pattern. I chose the latter approach and started from file offset `0x00300000`.
    I found the desired byte sequence at file offset `0x0030005c`, represented in
    little-endian notation, and I changed the 4 bytes to the value `0x41414141` (as
    illustrated in [Figure 2-6](ch02s02.html#new_value_for_eip_in_tivo_sample_file
    "Figure 2-6. New value for EIP in TiVo sample file")).
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 我的下一步是确定样本文件中哪些字节实际上覆盖了当前栈帧的返回地址，以便我可以控制 `EIP`。调试器指出，在崩溃时 `EIP` 的值为 `0x20030000`。为了确定这个值所在的偏移量，我可以尝试计算确切的文件偏移量，或者我可以简单地搜索文件以查找字节模式。我选择了后者，并从文件偏移
    `0x00300000` 开始。我在文件偏移 `0x0030005c` 找到了所需的字节序列，以小端表示法表示，并将这 4 个字节更改为值 `0x41414141`（如
    [图 2-6](ch02s02.html#new_value_for_eip_in_tivo_sample_file "图 2-6. TiVo 样本文件中
    EIP 的新值") 所示）。
- en: '![New value for EIP in TiVo sample file](httpatomoreillycomsourcenostarchimages939239.png.jpg)'
  id: totrans-80
  prefs: []
  type: TYPE_IMG
  zh: '![TiVo 样本文件中 EIP 的新值](httpatomoreillycomsourcenostarchimages939239.png.jpg)'
- en: Figure 2-6. New value for `EIP` in TiVo sample file
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 图 2-6. TiVo 样本文件中 `EIP` 的新值
- en: I then restarted VLC in the debugger and opened the new file (see [Figure 2-7](ch02s02.html#eip_control_of_vlc_media_player
    "Figure 2-7. EIP control of VLC media player")).
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我在调试器中重新启动了 VLC 并打开了新文件（见 [图 2-7](ch02s02.html#eip_control_of_vlc_media_player
    "图 2-7. VLC 播放器的 EIP 控制")）。
- en: '![EIP control of VLC media player](httpatomoreillycomsourcenostarchimages939241.png.jpg)'
  id: totrans-83
  prefs: []
  type: TYPE_IMG
  zh: '![VLC 播放器的 EIP 控制](httpatomoreillycomsourcenostarchimages939241.png.jpg)'
- en: Figure 2-7. `EIP` control of VLC media player
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 图 2-7. VLC 播放器的 `EIP` 控制
- en: '`EIP = 41414141` . . . Mission `EIP` control accomplished! I was able to build
    a working exploit, intended to achieve arbitrary code execution, using the well-known
    `jmp reg` technique, as described in “Variations in Exploit Methods Between Linux
    and Windows” by David Litchfield.^([[9](ch02s05.html#ftn.CHP-2-FN-4)])'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: '`EIP = 41414141` . . . 任务 `EIP` 控制[完成]！我能够构建一个工作漏洞利用程序，旨在实现任意代码执行，使用了众所周知的
    `jmp reg` 技术，如 David Litchfield 在“Linux 和 Windows 之间漏洞利用方法的变化”中所述。^([[9](ch02s05.html#ftn.CHP-2-FN-4)])'
- en: Since Germany has strict laws against it, I will not provide you with a full
    working exploit, but if you’re interested, you can watch a short video I recorded
    that shows the exploit in action.^([[10](ch02s05.html#ftn.CHP-2-FN-5)])
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 由于德国对此有严格的法律，我不会提供完整的漏洞利用程序，但如果您感兴趣，您可以观看我录制的一段简短视频，展示漏洞利用程序的实际操作。^([[10](ch02s05.html#ftn.CHP-2-FN-5)])
- en: 2.3 Vulnerability Remediation
  id: totrans-87
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 2.3 漏洞修复
- en: Note
  id: totrans-88
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*Saturday, October 18, 2008*'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: '*星期六，2008 年 10 月 18 日*'
- en: Now that I’ve discovered a security vulnerability, I could disclose it in several
    ways. I could contact the software developer and “responsibly” tell him what I’ve
    found and help him to create a patch. This process is referred to as *responsible
    disclosure*. Since this term implies that other means of disclosure are irresponsible,
    which isn’t necessarily true, it is slowly being replaced by *coordinated disclosure*.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 既然我已经发现了一个安全漏洞，我可以通过几种方式来披露它。我可以联系软件开发者，并“负责任地”告诉他我所发现的内容，并帮助他创建补丁。这个过程被称为*负责任披露*。由于这个术语暗示其他披露方式是不负责任的，这并不一定正确，它正在逐渐被*协调披露*所取代。
- en: On the other hand, I could sell my findings to a *vulnerability broker* and
    let him tell the software developer. Today, the two primary players in the commercial
    vulnerability market are Verisign’s iDefense Labs, with its Vulnerability Contribution
    Program (VCP), and Tipping Point’s Zero Day Initiative (ZDI). Both VCP and ZDI
    follow coordinated-disclosure practices and work with the affected vendor.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 另一方面，我可以将我的发现卖给一个*漏洞经纪人*，让他通知软件开发者。今天，商业漏洞市场的两个主要参与者是 Verisign 的 iDefense Labs，拥有其漏洞贡献计划（VCP），以及
    Tipping Point 的零日漏洞计划（ZDI）。VCP 和 ZDI 都遵循协调披露实践，并与受影响的供应商合作。
- en: Another option is *full disclosure*. If I chose full disclosure, I would release
    the vulnerability information to the public without notifying the vendor. There
    are other disclosure options, but the motivation behind them usually doesn’t involve
    fixing the bug (for example, selling the findings in underground markets).^([[11](ch02s05.html#ftn.CHP-2-FN-6)])
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个选项是*完全披露*。如果我选择完全披露，我将不会通知供应商，而是将漏洞信息公开发布。当然，还有其他的披露选项，但它们背后的动机通常并不涉及修复漏洞（例如，在地下市场中出售发现的结果）。^([[11](ch02s05.html#ftn.CHP-2-FN-6)])
- en: In the case of the VLC vulnerability described in this chapter, I chose coordinated
    disclosure. In other words, I notified the VLC maintainers, provided them with
    the necessary information, and coordinated with them on the timing of public disclosure.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章所述的 VLC 漏洞的情况下，我选择了协调披露。换句话说，我通知了 VLC 维护者，向他们提供了必要的信息，并就公开披露的时间与他们进行了协调。
- en: After I informed the VLC maintainers about the bug, they developed the following
    patch to address the vulnerability:^([[12](ch02s05.html#ftn.CHP-2-FN-7)])
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 在我通知 VLC 维护者关于这个漏洞之后，他们开发了以下补丁来解决这个问题：^([[12](ch02s05.html#ftn.CHP-2-FN-7)])
- en: '[PRE6]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The changes are quite straightforward. The formerly vulnerable call to `stream_Read()`
    now uses a fixed size value, and the user-controlled value of `i_map_size` is
    used only as a size value for `stream_Read()` if it is less than or equal to 8\.
    An easy fix for an obvious bug.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 这些更改相当直接。之前易受攻击的 `stream_Read()` 调用现在使用一个固定大小的值，并且当 `i_map_size` 的用户控制值小于或等于
    8 时，它仅作为 `stream_Read()` 的大小值使用。这是一个明显的漏洞的简单修复。
- en: But wait—is the vulnerability really gone? The variable `i_map_size` is still
    of the type signed int. If a value greater than or equal to `0x80000000` is supplied
    for `i_map_size`, it’s interpreted as negative, and the overflow will still occur
    in the `stream_Read()` and `memcpy()` functions of the `else` branch of the patch
    (see Section A.3 for a description of unsigned int and signed int ranges). I also
    reported this problem to the VLC maintainers, resulting in another patch:^([[13](ch02s05.html#ftn.CHP-2-FN-8)])
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 但是等等——漏洞真的消失了吗？变量 `i_map_size` 仍然是 signed int 类型。如果为 `i_map_size` 提供一个大于或等于
    `0x80000000` 的值，它将被解释为负数，并且补丁中 `else` 分支的 `stream_Read()` 和 `memcpy()` 函数中仍然会发生溢出（有关
    unsigned int 和 signed int 范围的描述，请参阅第 A.3 节）。我还向 VLC 维护者报告了这个问题，导致另一个补丁的产生：^([[13](ch02s05.html#ftn.CHP-2-FN-8)])
- en: '[PRE7]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Now that `i_map_size` is of the type unsigned int, this bug is fixed. Perhaps
    you’ve already noticed that the `parse_master()` function contains another buffer
    overflow vulnerability. I also reported that bug to the VLC maintainers. If you
    can’t spot it, then take a closer look at the second patch provided by the VLC
    maintainers, which fixed this bug as well.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，`i_map_size` 是无符号整型的类型，这个漏洞已经修复。也许你已经注意到 `parse_master()` 函数中还存在另一个缓冲区溢出漏洞。我也向
    VLC 维护者报告了该漏洞。如果您找不到它，请仔细查看 VLC 维护者提供的第二个补丁，该补丁也修复了这个漏洞。
- en: One thing that surprised me was the fact that none of the lauded exploit mitigation
    techniques of Windows Vista were able to stop me from taking control of `EIP`
    and executing arbitrary code from the stack using the `jmp reg` technique. The
    security cookie or /GS feature should have prevented the manipulation of the return
    address. Furthermore, ASLR or NX/DEP should have prevented arbitrary code execution.
    (See Section C.1 for a detailed description of all of these mitigation techniques.)
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 令我惊讶的一件事是，Windows Vista 所赞誉的利用缓解技术都无法阻止我通过 `jmp reg` 技巧控制 `EIP` 并从堆栈中执行任意代码。安全cookie或/GS功能本应阻止返回地址的操纵。此外，ASLR或NX/DEP本应阻止任意代码执行。（有关所有这些缓解技术的详细描述，请参阅C.1节。）
- en: To solve this mystery, I downloaded Process Explorer^([[14](ch02s05.html#ftn.CHP-2-FN-9)])
    and configured it to show the processes’ DEP and ASLR status.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 为了解开这个谜团，我下载了 Process Explorer^([[14](ch02s05.html#ftn.CHP-2-FN-9)]) 并将其配置为显示进程的DEP和ASLR状态。
- en: Note
  id: totrans-102
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: 'To configure Process Explorer to show the processes’ DEP and ASLR status, I
    added the following columns to the view: **View** ▸ **Select Columns** ▸ **DEP
    Status** and **View** ▸ **Select Columns** ▸ **ASLR Enabled**. Additionally, I
    set the lower pane to view DLLs for a process and added the “ASLR Enabled” column.'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 要将 Process Explorer 配置为显示进程的 DEP 和 ASLR 状态，我在视图中添加了以下列：**视图** ▸ **选择列** ▸ **DEP
    状态** 和 **视图** ▸ **选择列** ▸ **ASLR 启用**。此外，我将下窗格设置为查看进程的 DLL，并添加了“ASLR 启用”列。
- en: The output of Process Explorer, illustrated in [Figure 2-8](ch02s03.html#vlc_in_process_explorer
    "Figure 2-8. VLC in Process Explorer"), shows that VLC and its modules use neither
    DEP nor ASLR (this is denoted by an empty value in the DEP and ASLR columns).
    I investigated further to determine why the VLC process does not use these mitigation
    techniques.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: Process Explorer 的输出，如图 [图2-8](ch02s03.html#vlc_in_process_explorer "图2-8. Process
    Explorer中的VLC") 所示，表明 VLC 及其模块既不使用 DEP 也不使用 ASLR（这由 DEP 和 ASLR 列中的空值表示）。我进一步调查了为什么
    VLC 进程不使用这些缓解技术。
- en: '![VLC in Process Explorer](httpatomoreillycomsourcenostarchimages939243.png.jpg)'
  id: totrans-105
  prefs: []
  type: TYPE_IMG
  zh: '![Process Explorer中的VLC](httpatomoreillycomsourcenostarchimages939243.png.jpg)'
- en: Figure 2-8. VLC in Process Explorer
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 图2-8. Process Explorer中的VLC
- en: 'DEP can be controlled by system policy through special APIs and compile-time
    options (see Microsoft’s Security Research and Defense blog^([[15](ch02s05.html#ftn.CHP-2-FN-10)])
    for more information on DEP). The default system-wide DEP policy for client operating
    systems such as Windows Vista is called OptIn. In this mode of operation, DEP
    is enabled only for processes that explicitly opt in to DEP. Because I used a
    default installation of Windows Vista 32-bit, the system-wide DEP policy should
    be set to OptIn. To verify this, I used the `bcdedit.exe` console application
    from an elevated command prompt:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: DEP 可以通过系统策略和特殊的API以及编译时选项进行控制（有关DEP的更多信息，请参阅微软的安全研究博客^([[15](ch02s05.html#ftn.CHP-2-FN-10)]))。客户端操作系统（如Windows
    Vista）的默认系统级DEP策略称为OptIn。在这种操作模式下，只有明确选择加入 DEP 的进程才会启用 DEP。因为我使用的是默认安装的32位Windows
    Vista，所以系统级DEP策略应设置为OptIn。为了验证这一点，我使用从提升命令提示符中的 `bcdedit.exe` 控制台应用程序：
- en: '[PRE8]'
  id: totrans-108
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'The output of the command shows that the system was indeed configured to use
    the OptIn operation mode of DEP, which explains why VLC doesn’t use this mitigation
    technique: The process simply doesn’t opt in to DEP.'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 命令的输出显示，系统确实配置为使用 DEP 的 OptIn 操作模式，这解释了为什么 VLC 不使用这种缓解技术：进程根本未选择加入 DEP。
- en: There are different ways to opt a process in to DEP. For example, you could
    use the appropriate linker switch (/NXCOMPAT) at compile time, or you could use
    the `SetProcessDEPPolicy` API to allow an application to opt in to DEP programmatically.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 有不同的方法可以将进程加入 DEP。例如，您可以在编译时使用适当的链接器开关 (/NXCOMPAT)，或者可以使用 `SetProcessDEPPolicy`
    API 以编程方式允许应用程序加入 DEP。
- en: To get an overview of the security-relevant compile-time options used by VLC,
    I scanned the executable files of the media player with LookingGlass (see [Figure 2-9](ch02s03.html#lookingglass_scan_result_of_vlc
    "Figure 2-9. LookingGlass scan result of VLC")).^([[16](ch02s05.html#ftn.CHP-2-FN-11)])
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 为了了解VLC使用的与安全相关的编译时选项的概述，我使用LookingGlass扫描了媒体播放器的可执行文件（见图[图2-9](ch02s03.html#lookingglass_scan_result_of_vlc
    "图2-9. LookingGlass对VLC的扫描结果")).^([[16](ch02s05.html#ftn.CHP-2-FN-11)])
- en: Note
  id: totrans-112
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: In 2009, Microsoft released a tool called BinScope Binary Analyzer, which analyzes
    binaries for a wide variety of security protections with a very straightforward
    and easy-to-use interface.^([[17](ch02s05.html#ftn.CHP-2-FN-12)])
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 2009年，Microsoft发布了一个名为BinScope二进制分析器的工具，它具有非常直观且易于使用的界面，用于分析二进制文件中的各种安全保护.^([[17](ch02s05.html#ftn.CHP-2-FN-12)])
- en: LookingGlass showed that the linker switch for neither ASLR nor DEP was used
    to compile VLC.^([[18](ch02s05.html#ftn.CHP-2-FN-13)]) The Windows releases of
    VLC media player are built using the Cygwin^([[19](ch02s05.html#ftn.CHP-2-FN-14)])
    environment, a set of utilities designed to provide the look and feel of Linux
    within the Windows operating system. Since the linker switches that I mentioned
    are supported only by Microsoft’s Visual C++ 2005 SP1 and later (and thus are
    not supported by Cygwin), it isn’t a big surprise that they aren’t supported by
    VLC.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: LookingGlass显示，用于ASLR或DEP的链接器选项都没有用于编译VLC.^([[18](ch02s05.html#ftn.CHP-2-FN-13)])
    VLC媒体播放器的Windows版本是使用Cygwin^([[19](ch02s05.html#ftn.CHP-2-FN-14)])环境构建的，这是一个旨在在Windows操作系统中提供类似Linux外观和感觉的一组实用程序。由于我提到的链接器选项仅由Microsoft的Visual
    C++ 2005 SP1及更高版本支持（因此Cygwin不支持），它们不被VLC支持并不令人惊讶。
- en: '*Exploit mitigation techniques of Microsoft’s Visual C++ 2005 SP1 and later*:'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: '*Microsoft Visual C++ 2005 SP1及更高版本的利用缓解技术*：'
- en: '*/GS for stack cookies/canaries*'
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*/GS用于堆栈cookie/卡*'
- en: '*/DYNAMICBASE for ASLR*.'
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*/DYNAMICBASE用于ASLR*。'
- en: '*/NXCOMPAT for DEP/NX*'
  id: totrans-118
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*/NXCOMPAT用于DEP/NX*'
- en: '*/SAFESEH for exception handler protection*'
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*/SAFESEH用于异常处理程序保护*'
- en: '![LookingGlass scan result of VLC](httpatomoreillycomsourcenostarchimages939245.png.jpg)'
  id: totrans-120
  prefs: []
  type: TYPE_IMG
  zh: '![VLC的LookingGlass扫描结果](httpatomoreillycomsourcenostarchimages939245.png.jpg)'
- en: Figure 2-9. LookingGlass scan result of VLC
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 图2-9. LookingGlass对VLC的扫描结果
- en: 'See the following excerpt from the VLC build instructions:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 请参阅以下VLC构建说明的摘录：
- en: '[PRE9]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: At the time of this writing, VLC didn’t make use of any of the exploit mitigation
    techniques provided by Windows Vista or later releases. As a result, every bug
    in VLC under Windows is as easily exploited today as 20 years ago, when none of
    these security features were widely deployed or supported.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 在撰写本文时，VLC没有使用Windows Vista或更高版本提供的任何利用缓解技术。因此，在Windows下的每个VLC漏洞今天都像20年前一样容易利用，那时这些安全功能并没有广泛部署或得到支持。
- en: 2.4 Lessons Learned
  id: totrans-125
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 2.4 经验教训
- en: 'As a programmer:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 作为程序员：
- en: Never trust user input (this includes file data, network data, etc.).
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 永远不要相信用户输入（这包括文件数据、网络数据等）。
- en: Never use unvalidated length or size values.
  id: totrans-128
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 永远不要使用未经验证的长度或大小值。
- en: Always make use of the exploit mitigation techniques offered by modern operating
    systems wherever possible. Under Windows, software has to be compiled with Microsoft’s
    Visual C++ 2005 SP1 or later, and the appropriate compiler and linker options
    have to be used. In addition, Microsoft has released the *Enhanced Mitigation
    Experience Toolkit*,^([[20](ch02s05.html#ftn.CHP-2-FN-15)]) which allows specific
    mitigation techniques to be applied without recompilation.
  id: totrans-129
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在可能的情况下，始终使用现代操作系统提供的利用缓解技术。在Windows下，软件必须使用Microsoft的Visual C++ 2005 SP1或更高版本的编译器进行编译，并必须使用适当的编译器和链接器选项。此外，Microsoft还发布了*增强缓解体验工具包*，^([[20](ch02s05.html#ftn.CHP-2-FN-15)])
    允许在不重新编译的情况下应用特定的缓解技术。
- en: 'As a user of media players:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 作为媒体播放器的用户：
- en: Don’t ever trust media file extensions (see Section 2.5 below).
  id: totrans-131
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 永远不要相信媒体文件扩展名（见下文第2.5节）。
- en: 2.5 Addendum
  id: totrans-132
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 2.5 补充说明
- en: Note
  id: totrans-133
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*Monday, October 20, 2008*'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: '*2008年10月20日星期一*'
- en: Since the vulnerability was fixed and a new version of VLC is now available,
    I released a detailed security advisory on my website ([Figure 2-10](ch02s05.html#timeline_of_the_vulnerability
    "Figure 2-10. Timeline of the vulnerability") shows the timeline).^([[21](ch02s05.html#ftn.CHP-2-FN-16)])
    The bug was assigned CVE-2008-4654.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 由于漏洞已修复并且现在有了一个新的VLC版本，我在我的网站上发布了一份详细的安全警告([图2-10](ch02s05.html#timeline_of_the_vulnerability
    "图2-10. 漏洞时间线")显示了时间线).^([[21](ch02s05.html#ftn.CHP-2-FN-16)]) 该漏洞被分配了CVE-2008-4654。
- en: Note
  id: totrans-136
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: According to the documentation provided by MITRE,^([[22](ch02s05.html#ftn.CHP-2-FN-17)])
    *Common Vulnerabilities and Exposures Identifiers* (also called *CVE names*, *CVE
    numbers*, *CVE-IDs*, and *CVEs*) are “unique, common identifiers for publicly
    known information security vulnerabilities.”
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 根据MITRE提供的文档，^([[22](ch02s05.html#ftn.CHP-2-FN-17)]) *常见漏洞和暴露标识符*（也称为*CVE名称*、*CVE编号*、*CVE-IDs*和*CVEs*）是“公开已知信息安全漏洞的唯一、通用标识符。”
- en: '![Timeline of the vulnerability](httpatomoreillycomsourcenostarchimages939247.png.jpg)'
  id: totrans-138
  prefs: []
  type: TYPE_IMG
  zh: '![漏洞时间线](httpatomoreillycomsourcenostarchimages939247.png.jpg)'
- en: Figure 2-10. Timeline of the vulnerability
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 图2-10. 漏洞时间线
- en: Note
  id: totrans-140
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 备注
- en: '*Monday, January 5, 2009*'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: '*星期一，2009年1月5日*'
- en: 'In reaction to the bug and my detailed advisory, I got a lot of mail with various
    questions from worried VLC users. There were two questions that I saw over and
    over:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 针对漏洞和我的详细警告，我收到了许多来自担忧的VLC用户的邮件，他们提出了各种问题。有两个问题我反复看到：
- en: I have never heard of the TiVo media format before. Why would I ever open such
    an obscure media file?
  id: totrans-143
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 我以前从未听说过TiVo媒体格式。我为什么要打开这样一个不为人知的媒体文件？
- en: ''
  id: totrans-144
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Am I secure if I don’t open TiVo media files in VLC anymore?
  id: totrans-145
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 如果我不再在VLC中打开TiVo媒体文件，我是否安全？
- en: These are valid questions, so I asked myself how I would normally learn about
    the format of a media file I downloaded via the Internet with no more information
    than the file extension. I could fire up a hex editor and have a look at the file
    header, but to be honest, I don’t think ordinary people would go to the trouble.
    But are file extensions trustworthy? No, they aren’t. The regular file extension
    for TiVo files is *.ty*. But what stops an attacker from changing the filename
    from *fun.ty* to *fun.avi*, *fun.mov*, *fun.mkv*, or whatever she likes? The file
    will still be opened and processed as a TiVo file by the media player, since VLC,
    like almost all media players, does not use file extensions to recognize the media
    format.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 这些是有效的问题，所以我问自己，如果我只知道下载的媒体文件的扩展名，我通常会怎样了解该媒体文件的格式。我可以启动一个十六进制编辑器并查看文件头，但说实话，我认为普通人不会去麻烦这样做。但是文件扩展名是可信的吗？不，它们不可信。TiVo文件的常规文件扩展名是*.ty*。但是，有什么能阻止攻击者将文件名从*fun.ty*改为*fun.avi*、*fun.mov*、*fun.mkv*或她喜欢的任何其他名称？由于VLC和其他几乎所有的媒体播放器一样，不使用文件扩展名来识别媒体格式，该文件仍然会被媒体播放器以TiVo文件的方式打开和处理。
- en: Notes
  id: totrans-147
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 备注
- en: ^([[6](#ftn.CHP-2-FN-1)])
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[6](#ftn.CHP-2-FN-1)])
- en: ^([[7](#ftn.CHP-2-FN-2)])
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[7](#ftn.CHP-2-FN-2)])
- en: ^([[8](#ftn.CHP-2-FN-3)])
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[8](#ftn.CHP-2-FN-3)])
- en: ^([[9](#ftn.CHP-2-FN-4)])
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[9](#ftn.CHP-2-FN-4)])
- en: ^([[10](#ftn.CHP-2-FN-5)])
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[10](#ftn.CHP-2-FN-5)])
- en: ^([[11](#ftn.CHP-2-FN-6)])
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[11](#ftn.CHP-2-FN-6)])
- en: ^([[12](#ftn.CHP-2-FN-7)])
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[12](#ftn.CHP-2-FN-7)])
- en: ^([[13](#ftn.CHP-2-FN-8)])
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[13](#ftn.CHP-2-FN-8)])
- en: ^([[14](#ftn.CHP-2-FN-9)])
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[14](#ftn.CHP-2-FN-9)])
- en: ^([[15](#ftn.CHP-2-FN-10)])
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[15](#ftn.CHP-2-FN-10)])
- en: ^([[16](#ftn.CHP-2-FN-11)])
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[16](#ftn.CHP-2-FN-11)])
- en: ^([[17](#ftn.CHP-2-FN-12)])
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[17](#ftn.CHP-2-FN-12)])
- en: ^([[18](#ftn.CHP-2-FN-13)])
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[18](#ftn.CHP-2-FN-13)])
- en: ^([[19](#ftn.CHP-2-FN-14)])
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[19](#ftn.CHP-2-FN-14)])
- en: ^([[20](#ftn.CHP-2-FN-15)])
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[20](#ftn.CHP-2-FN-15)])
- en: ^([[21](#ftn.CHP-2-FN-16)])
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[21](#ftn.CHP-2-FN-16)])
- en: ^([[22](#ftn.CHP-2-FN-17)])
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[22](#ftn.CHP-2-FN-17)])
- en: '* * *'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: '^([[6](#CHP-2-FN-1)]) See Dick Grune and Ceriel J.H. Jacobs, *Parsing Techniques:
    A Practical Guide*, 2nd ed. (New York: Springer Science+Business Media, 2008),
    1.'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[6](#CHP-2-FN-1)]) 参见迪克·格鲁恩和西里尔·J.H.雅各布斯所著的 *解析技术：实用指南*，第2版（纽约：Springer Science+Business
    Media，2008年），第1页。
- en: ^([[7](#CHP-2-FN-2)]) The vulnerable source code version of VLC can be downloaded
    at [http://download.videolan.org/pub/videolan/vlc/0.9.4/vlc-0.9.4.tar.bz2](http://download.videolan.org/pub/videolan/vlc/0.9.4/vlc-0.9.4.tar.bz2).
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[7](#CHP-2-FN-2)]) 可下载受漏洞影响的VLC源代码版本，请访问 [http://download.videolan.org/pub/videolan/vlc/0.9.4/vlc-0.9.4.tar.bz2](http://download.videolan.org/pub/videolan/vlc/0.9.4/vlc-0.9.4.tar.bz2)。
- en: ^([[8](#CHP-2-FN-3)]) Immunity Debugger is a great Windows debugger based on
    OllyDbg. It comes with a nice GUI and a lot of extra features and plug-ins to
    support bug hunting and exploit development. It can be found at [http://www.immunityinc.com/products-immdbg.shtml](http://www.immunityinc.com/products-immdbg.shtml).
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[8](#CHP-2-FN-3)"]) Immunity Debugger是基于OllyDbg的优秀的Windows调试器。它附带了一个漂亮的GUI以及许多额外的功能和插件，以支持漏洞挖掘和利用开发。可以在
    [http://www.immunityinc.com/products-immdbg.shtml](http://www.immunityinc.com/products-immdbg.shtml)
    找到它。
- en: ^([[9](#CHP-2-FN-4)]) See David Litchfield, “Variations in Exploit Methods Between
    Linux and Windows,” 2003, [http://www.nccgroup.com/Libraries/Document_Downloads/Variations_in_Exploit_methods_between_Linux_and_Windows.sflb.ashx](http://www.nccgroup.com/Libraries/Document_Downloads/Variations_in_Exploit_methods_between_Linux_and_Windows.sflb.ashx).
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[9](#CHP-2-FN-4)]) 请参阅 David Litchfield 的著作，“Linux 和 Windows 之间漏洞利用方法的差异”，2003
    年，[http://www.nccgroup.com/Libraries/Document_Downloads/Variations_in_Exploit_methods_between_Linux_and_Windows.sflb.ashx](http://www.nccgroup.com/Libraries/Document_Downloads/Variations_in_Exploit_methods_between_Linux_and_Windows.sflb.ashx)。
- en: ^([[10](#CHP-2-FN-5)]) See [http://www.trapkit.de/books/bhd/](http://www.trapkit.de/books/bhd/).
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[10](#CHP-2-FN-5)]) 请参阅 [http://www.trapkit.de/books/bhd/](http://www.trapkit.de/books/bhd/)。
- en: ^([[11](#CHP-2-FN-6)]) For more information on responsible, coordinated, and
    full disclosure as well as the commercial vulnerability market, consult Stefan
    Frei, Dominik Schatzmann, Bernhard Plattner, and Brian Trammel, “Modelling the
    Security Ecosystem—The Dynamics of (In)Security,” 2009, [http://www.techzoom.net/publications/security-ecosystem/](http://www.techzoom.net/publications/security-ecosystem/).
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[11](#CHP-2-FN-6)]) 关于负责任的、协调的、完全披露以及商业漏洞市场等信息，请参考 Stefan Frei、Dominik Schatzmann、Bernhard
    Plattner 和 Brian Trammel 的著作，“建模安全生态系统——（不）安全的动态”，2009 年，[http://www.techzoom.net/publications/security-ecosystem/](http://www.techzoom.net/publications/security-ecosystem/)。
- en: ^([[12](#CHP-2-FN-7)]) The Git repository of VLC can be found at [http://git.videolan.org/](http://git.videolan.org/).
    The first fix issued for this bug can be downloaded from [http://git.videolan.org/?p=vlc.git;a=commitdiff;h=26d92b87bba99b5ea2e17b7eaa39c462d65e9133](http://git.videolan.org/?p=vlc.git;a=commitdiff;h=26d92b87bba99b5ea2e17b7eaa39c462d65e9133).
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[12](#CHP-2-FN-7)]) VLC 的 Git 仓库可以在 [http://git.videolan.org/](http://git.videolan.org/)
    找到。针对此漏洞发布的第一个修复程序可以从 [http://git.videolan.org/?p=vlc.git;a=commitdiff;h=26d92b87bba99b5ea2e17b7eaa39c462d65e9133](http://git.videolan.org/?p=vlc.git;a=commitdiff;h=26d92b87bba99b5ea2e17b7eaa39c462d65e9133)
    下载。
- en: ^([[13](#CHP-2-FN-8)]) The fix for the subsequent VLC bug that I found can be
    downloaded from [http://git.videolan.org/?p=vlc.git;a=commitdiff;h=d859e6b9537af2d7326276f70de25a840f554dc3](http://git.videolan.org/?p=vlc.git;a=commitdiff;h=d859e6b9537af2d7326276f70de25a840f554dc3).
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[13](#CHP-2-FN-8)]) 我发现的后续 VLC 漏洞的修复程序可以从 [http://git.videolan.org/?p=vlc.git;a=commitdiff;h=d859e6b9537af2d7326276f70de25a840f554dc3](http://git.videolan.org/?p=vlc.git;a=commitdiff;h=d859e6b9537af2d7326276f70de25a840f554dc3)
    下载。
- en: ^([[14](#CHP-2-FN-9)]) To download Process Explorer, visit [http://technet.microsoft.com/en-en/sysinternals/bb896653/](http://technet.microsoft.com/en-en/sysinternals/bb896653/).
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[14](#CHP-2-FN-9)]) 要下载 Process Explorer，请访问 [http://technet.microsoft.com/en-en/sysinternals/bb896653/](http://technet.microsoft.com/en-en/sysinternals/bb896653/)。
- en: ^([[15](#CHP-2-FN-10)]) See [http://blogs.technet.com/b/srd/archive/2009/06/12/understanding-dep-as-a-mitigation-technology-part-1.aspx](http://blogs.technet.com/b/srd/archive/2009/06/12/understanding-dep-as-a-mitigation-technology-part-1.aspx).
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[15](#CHP-2-FN-10)]) 请参阅 [http://blogs.technet.com/b/srd/archive/2009/06/12/understanding-dep-as-a-mitigation-technology-part-1.aspx](http://blogs.technet.com/b/srd/archive/2009/06/12/understanding-dep-as-a-mitigation-technology-part-1.aspx)。
- en: ^([[16](#CHP-2-FN-11)]) LookingGlass is a handy tool to scan a directory structure
    or the running processes to report which binaries do not make use of ASLR and
    NX. It can be found at [http://www.erratasec.com/lookingglass.html](http://www.erratasec.com/lookingglass.html).
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[16](#CHP-2-FN-11)]) LookingGlass 是一个方便的工具，用于扫描目录结构或正在运行的过程，以报告哪些二进制文件没有使用
    ASLR 和 NX。它可以在 [http://www.erratasec.com/lookingglass.html](http://www.erratasec.com/lookingglass.html)
    找到。
- en: ^([[17](#CHP-2-FN-12)]) To download BinScope Binary analyzer, visit [http://go.microsoft.com/?linkid=9678113](http://go.microsoft.com/?linkid=9678113).
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[17](#CHP-2-FN-12)]) 要下载 BinScope 二进制分析器，请访问 [http://go.microsoft.com/?linkid=9678113](http://go.microsoft.com/?linkid=9678113)。
- en: '^([[18](#CHP-2-FN-13)]) A good article on the exploit mitigation techniques
    introduced by Microsoft Visual C++ 2005 SP1 and later: Michael Howard, “Protecting
    Your Code with Visual C++ Defenses,” *MSDN Magazine*, March 2008, [http://msdn.microsoft.com/en-us/magazine/cc337897.aspx](http://msdn.microsoft.com/en-us/magazine/cc337897.aspx).'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[18](#CHP-2-FN-13)]) 关于 Microsoft Visual C++ 2005 SP1 及以后版本引入的漏洞缓解技术的优秀文章：Michael
    Howard，“使用 Visual C++ 防御保护您的代码”，*MSDN 杂志*，2008 年 3 月，[http://msdn.microsoft.com/en-us/magazine/cc337897.aspx](http://msdn.microsoft.com/en-us/magazine/cc337897.aspx)。
- en: ^([[19](#CHP-2-FN-14)]) See [http://www.cygwin.com/](http://www.cygwin.com/).
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[19](#CHP-2-FN-14)]) 请参阅 [http://www.cygwin.com/](http://www.cygwin.com/)。
- en: ^([[20](#CHP-2-FN-15)]) The Enhanced Mitigation Experience Toolkit is available
    at [http://blogs.technet.com/srd/archive/2010/09/02/enhanced-mitigation-experience-toolkit-emet-v2-0-0.aspx](http://blogs.technet.com/srd/archive/2010/09/02/enhanced-mitigation-experience-toolkit-emet-v2-0-0.aspx).
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[20](#CHP-2-FN-15)]) 增强缓解体验工具包（Enhanced Mitigation Experience Toolkit）可在[http://blogs.technet.com/srd/archive/2010/09/02/enhanced-mitigation-experience-toolkit-emet-v2-0-0.aspx](http://blogs.technet.com/srd/archive/2010/09/02/enhanced-mitigation-experience-toolkit-emet-v2-0-0.aspx)获取。
- en: ^([[21](#CHP-2-FN-16)]) My security advisory that describes the details of the
    VLC vulnerability can be found at [http://www.trapkit.de/advisories/TKADV2008-010.txt](http://www.trapkit.de/advisories/TKADV2008-010.txt).
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[21](#CHP-2-FN-16)]) 我关于VLC漏洞详细信息的安全咨询可以在[http://www.trapkit.de/advisories/TKADV2008-010.txt](http://www.trapkit.de/advisories/TKADV2008-010.txt)找到。
- en: ^([[22](#CHP-2-FN-17)]) See [http://cve.mitre.org/cve/identifiers/index.html](http://cve.mitre.org/cve/identifiers/index.html).
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[22](#CHP-2-FN-17)]) 请参阅[http://cve.mitre.org/cve/identifiers/index.html](http://cve.mitre.org/cve/identifiers/index.html)。
