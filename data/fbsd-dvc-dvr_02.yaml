- en: Chapter 2. Allocating Memory
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第 2 章. 分配内存
- en: '![image with no caption](httpatomoreillycomsourcenostarchimages1137497.png.jpg)'
  id: totrans-1
  prefs: []
  type: TYPE_IMG
  zh: '![无标题图片](httpatomoreillycomsourcenostarchimages1137497.png.jpg)'
- en: In the previous chapter we used `malloc` and `free` for the allocation and release
    of memory. The FreeBSD kernel, however, contains a richer set of memory allocation
    primitives. In this chapter we’ll look at the stock kernel memory management routines.
    This includes describing `malloc` and `free` in more detail and introducing the
    `malloc_type` structure. We’ll finish this chapter by describing the contiguous
    physical memory management routines.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，我们使用了 `malloc` 和 `free` 来进行内存的分配和释放。然而，FreeBSD 内核包含了一组更丰富的内存分配原语。在本章中，我们将探讨标准内核内存管理例程。这包括更详细地描述
    `malloc` 和 `free`，并介绍 `malloc_type` 结构。我们将通过描述连续物理内存管理例程来结束本章。
- en: Memory Management Routines
  id: totrans-3
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 内存管理例程
- en: 'The FreeBSD kernel provides four functions for non-pageable memory allocation
    and release: `malloc`, `free`, `realloc`, and `reallocf`. These functions can
    handle requests of arbitrary size or alignment, and they are the preferred way
    to allocate kernel memory.'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: FreeBSD 内核提供了四个用于非分页内存分配和释放的函数：`malloc`、`free`、`realloc` 和 `reallocf`。这些函数可以处理任意大小或对齐的请求，并且是分配内核内存的首选方式。
- en: '[PRE0]'
  id: totrans-5
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: The `malloc` function allocates `size` bytes of memory in kernel space. If successful,
    a kernel virtual address is returned; otherwise, `NULL` is returned.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: '`malloc` 函数在内核空间中分配 `size` 字节的内存。如果成功，则返回一个内核虚拟地址；否则，返回 `NULL`。'
- en: The `free` function releases the memory at `addr`—that was previously allocated
    by `malloc`—for reuse. Note that `free` doesn’t clear this memory, which means
    that you should explicitly zero any memory whose contents you need to keep private.
    If `addr` is `NULL`, then `free` does nothing.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: '`free` 函数释放 `addr` 处的内存——这是之前由 `malloc` 分配的——以供重用。请注意，`free` 不会清除此内存，这意味着你应该显式地将任何需要保持私有内容的内容的内存设置为
    0。如果 `addr` 是 `NULL`，则 `free` 不做任何操作。'
- en: Note
  id: totrans-8
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If `INVARIANTS` is enabled, then `free` will stuff any released memory with
    `0xdeadc0de`.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 如果启用了 `INVARIANTS`，则 `free` 将用 `0xdeadc0de` 填充任何释放的内存。
- en: Thus, if you get a page fault panic and the faulting address is around `0xdeadc0de`,
    this can be a sign that you’re using `freed` memory.^([[1](#ftn.CHP-2-FN-1)])
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，如果你遇到页面故障恐慌，并且故障地址在 `0xdeadc0de` 附近，这可能表明你正在使用已释放的内存。[1](#ftn.CHP-2-FN-1)]
- en: The `realloc` function changes the size of the memory at `addr` to `size` bytes.
    If successful, a kernel virtual address is returned; otherwise, `NULL` is returned,
    and the memory is left alone. Note that the returned address may differ from `addr`,
    because when the size changes, the memory may be relocated to acquire or provide
    additional room. Interestingly, this implies that you should not have any pointers
    into the memory at `addr` when calling `realloc`. If `addr` is `NULL`, then `realloc`
    behaves identically to `malloc`.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: '`realloc` 函数将 `addr` 处的内存大小更改为 `size` 字节。如果成功，则返回一个内核虚拟地址；否则，返回 `NULL`，并且内存保持不变。请注意，返回的地址可能与
    `addr` 不同，因为当大小改变时，内存可能会被重新定位以获取或提供额外的空间。有趣的是，这暗示了在调用 `realloc` 时不应有任何指向 `addr`
    内存中的指针。如果 `addr` 是 `NULL`，则 `realloc` 的行为与 `malloc` 相同。'
- en: The `reallocf` function is identical to `realloc` except that on failure it
    releases the memory at `addr`.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: '`reallocf` 函数与 `realloc` 函数相同，只是在失败时释放 `addr` 处的内存。'
- en: The `malloc`, `realloc`, and `reallocf` functions provide a `flags` argument
    to further qualify their operational characteristics. Valid values for this argument
    are shown in [Table 2-1](ch02.html#malloc_comma_realloc_comma_and_reallocf "Table 2-1. malloc,
    realloc, and reallocf Symbolic Constants").
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: '`malloc`、`realloc` 和 `reallocf` 函数提供了一个 `flags` 参数来进一步限定它们的操作特性。此参数的有效值显示在
    [表 2-1](ch02.html#malloc_comma_realloc_comma_and_reallocf "表 2-1. malloc、realloc
    和 reallocf 符号常量") 中。'
- en: Table 2-1. malloc, realloc, and reallocf Symbolic Constants
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 表 2-1. malloc、realloc 和 reallocf 符号常量
- en: '| Constant | Description |'
  id: totrans-15
  prefs: []
  type: TYPE_TB
  zh: '| 常量 | 描述 |'
- en: '| --- | --- |'
  id: totrans-16
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| `M_ZERO` | Causes the allocated memory to be set to zero |'
  id: totrans-17
  prefs: []
  type: TYPE_TB
  zh: '| `M_ZERO` | 将分配的内存设置为 0 |'
- en: '| `M_NOWAIT` | Causes `malloc`, `realloc`, and `reallocf` to return `NULL`
    if the allocation cannot be immediately fulfilled due to resource shortage; `M_NOWAIT`
    is required when running in an interrupt context |'
  id: totrans-18
  prefs: []
  type: TYPE_TB
  zh: '| `M_NOWAIT` | 如果由于资源短缺而无法立即满足分配，则 `malloc`、`realloc` 和 `reallocf` 将返回 `NULL`；在中断上下文中运行时需要
    `M_NOWAIT` |'
- en: '| `M_WAITOK` | Indicates that it is okay to wait for resources; if the allocation
    cannot be immediately fulfilled, the current process is put to sleep to wait for
    resources to become available; when `M_WAITOK` is specified, `malloc`, `realloc`,
    and `reallocf` cannot return `NULL` |'
  id: totrans-19
  prefs: []
  type: TYPE_TB
  zh: '| `M_WAITOK` | 表示等待资源是可以接受的；如果分配不能立即完成，当前进程将被挂起等待资源可用；当指定 `M_WAITOK` 时，`malloc`、`realloc`
    和 `reallocf` 不能返回 `NULL` |'
- en: The `flags` argument must include either `M_NOWAIT` or `M_WAITOK`.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: '`flags` 参数必须包含 `M_NOWAIT` 或 `M_WAITOK`。'
- en: '* * *'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[1](#CHP-2-FN-1)]) `INVARIANTS` is a kernel debugging option. For more on
    `INVARIANTS`, see */sys/conf/NOTES*.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[1](#CHP-2-FN-1)]) `INVARIANTS` 是一个内核调试选项。有关 `INVARIANTS` 的更多信息，请参阅 */sys/conf/NOTES*。
- en: malloc_type Structures
  id: totrans-23
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: malloc_type 结构体
- en: The `malloc`, `free`, `realloc`, and `reallocf` functions include a `type` argument,
    which expects a pointer to a `malloc_type` structure; this structure describes
    the purpose of the allocated memory. The `type` argument has no impact on performance;
    it is used for memory profiling and for basic sanity checks.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: '`malloc`、`free`、`realloc` 和 `reallocf` 函数包含一个 `type` 参数，它期望是一个指向 `malloc_type`
    结构体的指针；此结构体描述了分配内存的目的。`type` 参数对性能没有影响；它用于内存分析和基本健全性检查。'
- en: Note
  id: totrans-25
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: You can profile kernel dynamic memory usage, sorted by `type`, with the `vmstat
    -m` command.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用 `vmstat -m` 命令按 `type` 对内核动态内存使用进行性能分析。
- en: MALLOC_DEFINE Macro
  id: totrans-27
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: MALLOC_DEFINE 宏
- en: 'The `MALLOC_DEFINE` macro defines a new `malloc_type` structure. Here is its
    function prototype:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: '`MALLOC_DEFINE` 宏定义了一个新的 `malloc_type` 结构体。以下是它的函数原型：'
- en: '[PRE1]'
  id: totrans-29
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: The `type` argument is the new `malloc_type` structure’s name. In general, `type`
    should begin with `M_` and be in uppercase letters; for example, `M_FOO`.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: '`type` 参数是新 `malloc_type` 结构体的名称。通常，`type` 应以 `M_` 开头并全部大写；例如，`M_FOO`。'
- en: The `shortdesc` argument expects a short description of the new `malloc_type`
    structure. This argument is used in the output of `vmstat -m`. As a result, it
    shouldn’t contain any spaces so that it’s easier to parse `vmstat -m`’s output
    in scripts.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: '`shortdesc` 参数期望是关于新 `malloc_type` 结构体的简短描述。此参数用于 `vmstat -m` 的输出。因此，它不应包含任何空格，以便在脚本中更容易解析
    `vmstat -m` 的输出。'
- en: The `longdesc` argument expects a long description of the new `malloc_type`
    structure.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: '`longdesc` 参数期望是关于新 `malloc_type` 结构体的详细描述。'
- en: MALLOC_DECLARE Macro
  id: totrans-33
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: MALLOC_DECLARE 宏
- en: 'The `MALLOC_DECLARE` macro declares a new `malloc_type` structure with the
    `extern` keyword. Here is its function prototype:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: '`MALLOC_DECLARE` 宏使用 `extern` 关键字声明了一个新的 `malloc_type` 结构体。以下是它的函数原型：'
- en: '[PRE2]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'This macro is defined in the `<sys/malloc.h>` header as follows:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 此宏定义在 `<sys/malloc.h>` 头文件中，如下所示：
- en: '[PRE3]'
  id: totrans-37
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: As an aside, if you require a private `malloc_type` structure, you would prefix
    the `MALLOC_DEFINE` call with the `static` keyword. In fact, a non-static `MALLOC_DEFINE`
    call without a corresponding `MALLOC_DECLARE` call actually causes a warning under
    gcc 4.*x*.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 作为旁注，如果您需要一个私有的 `malloc_type` 结构体，您应该在 `MALLOC_DEFINE` 调用前加上 `static` 关键字。实际上，没有对应
    `MALLOC_DECLARE` 调用的非静态 `MALLOC_DEFINE` 调用在 gcc 4.*x* 下实际上会导致警告。
- en: Tying Everything Together
  id: totrans-39
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 将一切联系在一起
- en: '[Example 2-1](ch02s03.html#echo-2.0.c "Example 2-1. echo-2.0.c") is a revision
    of [Example 1-2](ch01s06.html#echo.c "Example 1-2. echo.c") that uses its own
    `malloc_type` structure instead of the kernel-defined `M_TEMP`.^([[2](#ftn.CHP-2-FN-2)])
    [Example 2-1](ch02s03.html#echo-2.0.c "Example 2-1. echo-2.0.c") should clarify
    any misunderstandings you may have about `MALLOC_DEFINE` and `MALLOC_DECLARE`.'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: '[示例 2-1](ch02s03.html#example-2-1.echo-2.0.c "示例 2-1. echo-2.0.c") 是 [示例 1-2](ch01s06.html#example-1-2.echo.c
    "示例 1-2. echo.c") 的修订版，它使用自己的 `malloc_type` 结构体而不是内核定义的 `M_TEMP`。[示例 2-1](ch02s03.html#example-2-1.echo-2.0.c
    "示例 2-1. echo-2.0.c") 应该可以澄清您对 `MALLOC_DEFINE` 和 `MALLOC_DECLARE` 可能有的任何误解。'
- en: Note
  id: totrans-41
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: To save space, the functions `echo_open`, `echo_close`, `echo_write`, and `echo_read`
    aren’t listed here, as they haven’t been changed.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 为了节省空间，`echo_open`、`echo_close`、`echo_write` 和 `echo_read` 函数没有在此列出，因为它们没有发生变化。
- en: Example 2-1. echo-2.0.c
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 示例 2-1. echo-2.0.c
- en: '[PRE4]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: This driver ![](httpatomoreillycomsourcenostarchimages1137499.png) declares
    and ![](httpatomoreillycomsourcenostarchimages1137501.png) defines a new `malloc_type`
    structure named `M_ECHO`. To use this `malloc_type` structure, `malloc` and `free`
    are ![](httpatomoreillycomsourcenostarchimages1137503.png) ![](httpatomoreillycomsourcenostarchimages1137505.png)
    adjusted accordingly.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 此驱动程序 ![链接](http://atomoreilly.com/source/nostarch/images/1137499.png) 声明并 ![链接](http://atomoreilly.com/source/nostarch/images/1137501.png)
    定义了一个名为 `M_ECHO` 的新 `malloc_type` 结构体。要使用此 `malloc_type` 结构体，需要相应地调整 `malloc`
    和 `free` ![链接](http://atomoreilly.com/source/nostarch/images/1137503.png) ![链接](http://atomoreilly.com/source/nostarch/images/1137505.png)。
- en: Note
  id: totrans-46
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Because `M_ECHO` is used only locally, `MALLOC_DECLARE` is unnecessary—it’s
    only included here for demonstration purposes.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 由于`M_ECHO`仅用于本地，因此不需要`MALLOC_DECLARE`——这里仅包括以供演示目的。
- en: 'Now that [Example 2-1](ch02s03.html#echo-2.0.c "Example 2-1. echo-2.0.c") uses
    a unique `malloc_type` structure, we can easily profile its dynamic memory usage,
    like so:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 现在由于[示例2-1](ch02s03.html#echo-2.0.c "示例2-1. echo-2.0.c")使用了独特的`malloc_type`结构，我们可以轻松地分析其动态内存使用情况，如下所示：
- en: '[PRE5]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Notice that [Example 2-1](ch02s03.html#echo-2.0.c "Example 2-1. echo-2.0.c")
    requests 512 bytes, though `sizeof(echo_t)` is only 260 bytes. This is because
    `malloc` rounds up to the nearest power of two when allocating memory. Additionally,
    note that the second argument to `MALLOC_DEFINE` (`echo_buffer` in this example)
    is used in the output of `vmstat` (instead of the first argument).
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，[示例2-1](ch02s03.html#echo-2.0.c "示例2-1. echo-2.0.c")请求了512字节，尽管`sizeof(echo_t)`只有260字节。这是因为`malloc`在分配内存时向上舍入到最近的2的幂。此外，请注意，`MALLOC_DEFINE`的第二个参数（本例中的`echo_buffer`）用于`vmstat`的输出（而不是第一个参数）。
- en: '* * *'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[2](#CHP-2-FN-2)]) `M_TEMP` is defined in */sys/kern/kern_malloc.c*.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[2](#CHP-2-FN-2)]) `M_TEMP`在`/sys/kern/kern_malloc.c`中定义。
- en: Contiguous Physical Memory Management Routines
  id: totrans-53
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 连续物理内存管理例程
- en: 'The FreeBSD kernel provides two functions for contiguous physical memory management:
    `contigmalloc` and `contigfree`. Ordinarily, you’ll never use these functions.
    They’re primarily for dealing with machine-dependent code and the occasional network
    driver.'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: FreeBSD内核提供了两个连续物理内存管理函数：`contigmalloc`和`contigfree`。通常，你永远不会使用这些函数。它们主要用于处理与硬件相关的代码和偶尔的网络驱动程序。
- en: '[PRE6]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The `contigmalloc` function allocates `size` bytes of contiguous physical memory.
    If `size` is `0`, `contigmalloc` will panic. If successful, the allocation will
    reside between physical addresses `low` and `high`, inclusive.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: '`contigmalloc`函数分配`size`字节的连续物理内存。如果`size`为`0`，`contigmalloc`将引发恐慌。如果成功，分配将位于物理地址`low`和`high`之间，包括这两个地址。'
- en: The `alignment` argument denotes the physical alignment, in bytes, of the allocated
    memory. This argument must be a power of two.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: '`alignment`参数表示分配内存的物理对齐，以字节为单位。此参数必须是2的幂。'
- en: The `boundary` argument specifies the physical address boundaries that cannot
    be crossed by the allocated memory; that is, it cannot cross any multiple of `boundary`.
    This argument must be `0`, which indicates no boundary restrictions, or a power
    of two.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: '`boundary`参数指定分配内存不能跨越的物理地址边界；也就是说，它不能跨越任何`boundary`的倍数。此参数必须是`0`，表示没有边界限制，或者是一个2的幂。'
- en: The `flags` argument modifies `contigmalloc`’s behavior. Valid values for this
    argument are shown in [Table 2-2](ch02s04.html#contigmalloc_symbolic_constants
    "Table 2-2. contigmalloc Symbolic Constants").
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: '`flags`参数修改`contigmalloc`的行为。此参数的有效值在[表2-2](ch02s04.html#contigmalloc_symbolic_constants
    "表2-2. contigmalloc符号常量")中显示。'
- en: Table 2-2. contigmalloc Symbolic Constants
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 表2-2. contigmalloc符号常量
- en: '| Constant | Description |'
  id: totrans-61
  prefs: []
  type: TYPE_TB
  zh: '| 常量 | 描述 |'
- en: '| --- | --- |'
  id: totrans-62
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| `M_ZERO` | Causes the allocated physical memory to be zero filled |'
  id: totrans-63
  prefs: []
  type: TYPE_TB
  zh: '| `M_ZERO` | 导致分配的物理内存被零填充 |'
- en: '| `M_NOWAIT` | Causes `contigmalloc` to return `NULL` if the allocation cannot
    be immediately fulfilled due to resource shortage |'
  id: totrans-64
  prefs: []
  type: TYPE_TB
  zh: '| `M_NOWAIT` | 如果由于资源不足而无法立即满足分配，`contigmalloc`将返回`NULL` |'
- en: '| `M_WAITOK` | Indicates that it is okay to wait for resources; if the allocation
    cannot be immediately fulfilled, the current process is put to sleep to wait for
    resources to become available |'
  id: totrans-65
  prefs: []
  type: TYPE_TB
  zh: '| `M_WAITOK` | 表示可以等待资源；如果分配无法立即满足，当前进程将被挂起等待资源可用 |'
- en: The `contigfree` function releases the memory at `addr`—that was previously
    allocated by `contigmalloc`—for reuse. The `size` argument is the amount of memory
    to release. Generally, `size` should equal the amount allocated.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: '`contigfree`函数释放由`contigmalloc`先前分配的内存`addr`，以便重新使用。`size`参数是要释放的内存量。通常，`size`应等于分配的内存量。'
- en: A Straightforward Example
  id: totrans-67
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 一个简单的例子
- en: '[Example 2-2](ch02s05.html#echo_underscore_contig.c "Example 2-2. echo_contig.c")
    modifies [Example 2-1](ch02s03.html#echo-2.0.c "Example 2-1. echo-2.0.c") to use
    `contigmalloc` and `contigfree` instead of `malloc` and `free`. [Example 2-2](ch02s05.html#echo_underscore_contig.c
    "Example 2-2. echo_contig.c") should clarify any misunderstandings you may have
    about `contigmalloc` and `contigfree`.'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: '[示例 2-2](ch02s05.html#echo_underscore_contig.c "示例 2-2. echo_contig.c") 修改了
    [示例 2-1](ch02s03.html#echo-2.0.c "示例 2-1. echo-2.0.c") 以使用 `contigmalloc` 和 `contigfree`
    而不是 `malloc` 和 `free`。[示例 2-2](ch02s05.html#echo_underscore_contig.c "示例 2-2.
    echo_contig.c") 应该澄清您可能对 `contigmalloc` 和 `contigfree` 的任何误解。'
- en: Note
  id: totrans-69
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: To save space, the functions `echo_open`, `echo_close`, `echo_write`, and `echo_read`
    aren’t listed here, as they haven’t been changed.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 为了节省空间，函数 `echo_open`、`echo_close`、`echo_write` 和 `echo_read` 没有在此列出，因为它们没有发生变化。
- en: Example 2-2. echo_contig.c
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 示例 2-2. echo_contig.c
- en: '[PRE7]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Here, ![](httpatomoreillycomsourcenostarchimages1137499.png) `contigmalloc`
    allocates ![](httpatomoreillycomsourcenostarchimages1137501.png) `sizeof(echo_t)`
    bytes of ![](httpatomoreillycomsourcenostarchimages1137503.png) zero-filled memory.
    This memory resides between physical address ![](httpatomoreillycomsourcenostarchimages1137505.png)
    `0` and ![](httpatomoreillycomsourcenostarchimages1137507.png) `0xffffffff`, is
    aligned on a ![](httpatomoreillycomsourcenostarchimages1137509.png) `PAGE_SIZE`
    boundary, and does not cross a ![](httpatomoreillycomsourcenostarchimages1137511.png)
    1MB address boundary.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，![图](httpatomoreillycomsourcenostarchimages1137499.png) `contigmalloc` 分配了
    ![图](httpatomoreillycomsourcenostarchimages1137501.png) `sizeof(echo_t)` 字节的 ![图](httpatomoreillycomsourcenostarchimages1137503.png)
    零填充内存。此内存位于物理地址 ![图](httpatomoreillycomsourcenostarchimages1137505.png) `0` 和
    ![图](httpatomoreillycomsourcenostarchimages1137507.png) `0xffffffff` 之间，对齐在 ![图](httpatomoreillycomsourcenostarchimages1137509.png)
    `PAGE_SIZE` 边界，并且不跨越 ![图](httpatomoreillycomsourcenostarchimages1137511.png) 1MB
    地址边界。
- en: 'The following output shows the results from `vmstat -m` after loading [Example 2-2](ch02s05.html#echo_underscore_contig.c
    "Example 2-2. echo_contig.c"):'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 以下输出显示了在加载[示例 2-2](ch02s05.html#echo_underscore_contig.c "示例 2-2. echo_contig.c")后的
    `vmstat -m` 的结果：
- en: '[PRE8]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Notice that [Example 2-2](ch02s05.html#echo_underscore_contig.c "Example 2-2. echo_contig.c")
    uses 4KB of memory, though `sizeof(echo_t)` is only 260 bytes. This is because
    `contigmalloc` allocates memory in `PAGE_SIZE` blocks. Predictably, this example
    was run on an *i386* machine, which uses a page size of 4KB.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 注意到[示例 2-2](ch02s05.html#echo_underscore_contig.c "示例 2-2. echo_contig.c")使用了
    4KB 的内存，尽管 `sizeof(echo_t)` 只有 260 字节。这是因为 `contigmalloc` 在 `PAGE_SIZE` 块中分配内存。可以预见，这个示例是在一个
    *i386* 机器上运行的，该机器使用 4KB 的页面大小。
- en: Conclusion
  id: totrans-77
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 结论
- en: This chapter detailed FreeBSD’s memory management routines and contiguous physical
    memory management routines. It also introduced the `malloc_type` structure.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 本章详细介绍了 FreeBSD 的内存管理例程和连续物理内存管理例程。它还介绍了 `malloc_type` 结构体。
- en: Incidentally, most drivers should define their own `malloc_type` structure.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 顺便提一下，大多数驱动程序应该定义它们自己的 `malloc_type` 结构体。
