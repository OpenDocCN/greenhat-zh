- en: Chapter 12. Karmetasploit
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第 12 章。Karmetasploit
- en: 'Karmetasploit is Metasploit’s implementation of KARMA, a set of wireless security
    tools developed by Dino Dai Zovi and Shane Macaulay. KARMA takes advantage of
    a vulnerability inherent in the way Windows XP and Mac OS X operating systems
    search for networks: When each system boots, it sends beacons looking for networks
    to which it has connected previously.'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: Karmetasploit 是 Metasploit 对 KARMA 的实现，KARMA 是由 Dino Dai Zovi 和 Shane Macaulay
    开发的一套无线安全工具。KARMA 利用 Windows XP 和 Mac OS X 操作系统搜索网络的方式中固有的漏洞：当每个系统启动时，它会发送信标寻找之前连接过的网络。
- en: An attacker using KARMA sets up a fake access point on his computer and then
    listens for and responds to these beacons from the target, pretending to be whatever
    wireless network the client is looking for. Because most client computers are
    configured to connect automatically to wireless networks they have already used,
    KARMA can be used to gain complete control of a client’s network traffic, thus
    allowing an attacker to launch client-side attacks, capture passwords, and so
    forth. With the prevalence of poorly secured corporate wireless networks, an attacker
    using KARMA can sit in a nearby parking lot, adjacent office, or similar, and
    gain access to a target’s network with little effort. You can read more about
    the original implementation of KARMA at [http://trailofbits.com/karma/](http://trailofbits.com/karma/).
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 KARMA 的攻击者会在他的电脑上设置一个假接入点，然后监听并响应来自目标的目标信标，假装是客户端正在寻找的任何无线网络。由于大多数客户端电脑都配置为自动连接它们已经使用过的无线网络，因此
    KARMA 可以用来完全控制客户端的网络流量，从而允许攻击者发起客户端攻击、捕获密码等。鉴于不安全的公司无线网络的普遍存在，使用 KARMA 的攻击者可以坐在附近的停车场、相邻的办公室或类似的地方，几乎不费吹灰之力就能访问目标网络。您可以在
    [http://trailofbits.com/karma/](http://trailofbits.com/karma/) 上了解更多关于 KARMA 的原始实现。
- en: Karmetasploit is the Metasploit Framework implementation of the KARMA attack.
    It implements various “evil” services including DNS, POP3, IMAP4, SMTP, FTP, SMB,
    and HTTP. These services accept and respond to most requests from clients and
    will serve up all kinds of malicious fun. (The various modules are in the *modules/auxiliary/server*
    directory of the Metasploit root directory.)
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: Karmetasploit 是 Metasploit 框架对 KARMA 攻击的实现。它实现了包括 DNS、POP3、IMAP4、SMTP、FTP、SMB
    和 HTTP 在内的各种“邪恶”服务。这些服务接受并响应来自客户端的大多数请求，并将提供各种恶意娱乐。（各种模块位于 Metasploit 根目录下的 *modules/auxiliary/server*
    目录中。）
- en: Configuration
  id: totrans-4
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 配置
- en: 'Karmetasploit requires very little configuration. To begin, we configure a
    DHCP server to be used to hand out IP addresses to wireless targets. Back|Track
    includes a DHCP server, but we will need to create a custom configuration file
    for it to use with Karmetasploit, as shown in the following listing:'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: Karmetasploit 需要非常少的配置。首先，我们配置一个 DHCP 服务器，用于向无线目标分配 IP 地址。Back|Track 包含一个 DHCP
    服务器，但我们需要为它创建一个自定义配置文件，以便与 Karmetasploit 一起使用，如下所示列表：
- en: '[PRE0]'
  id: totrans-6
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: We back up our original *dhcpd.conf* file by entering **`cp /etc/dhcp3/dhcpd.conf/etc/dhcp3/dhcpd.conf.back`**,
    and then we create a new file containing the data shown at ![](../images/00002.gif),
    which will serve addresses in the range of 10.0.0.100 to 10.0.0.254 ![](../images/00004.gif).
    (If you are unfamiliar with DHCP configurations, don’t worry; as long as your
    new *dhcpd.conf* looks similar to this it should work fine.)
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 我们通过输入 **`cp /etc/dhcp3/dhcpd.conf/etc/dhcp3/dhcpd.conf.back`** 来备份我们的原始 *dhcpd.conf*
    文件，然后创建一个包含 ![](../images/00002.gif) 中所示数据的新的文件，该文件将为 10.0.0.100 到 10.0.0.254
    范围内的地址提供服务 ![](../images/00004.gif)。（如果你对 DHCP 配置不熟悉，不要担心；只要你的新 *dhcpd.conf* 看起来与此类似，它应该可以正常工作。）
- en: 'Next, we download the KARMA resource file, because as of this writing it’s
    not included in the regular Metasploit trunk:'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们下载 KARMA 资源文件，因为截至本文撰写时，它尚未包含在常规 Metasploit 主干中：
- en: '[PRE1]'
  id: totrans-9
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'When we open the KARMA resource file *karma.rc*, we can see the sequence of
    events that occur when it runs, as shown here:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们打开 KARMA 资源文件 *karma.rc* 时，可以看到它运行时发生的事件序列，如下所示：
- en: '[PRE2]'
  id: totrans-11
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'After loading the database (`db_connect postgres:toor@127.0.0.1/msfbook`) in
    which to store its results, KARMA loads the `browser_autopwn` server as shown
    at ![](../images/00002.gif). This is a handy way to attempt a number of exploits
    against a browser in an untargeted manner. A handful of the browser-based exploits
    in the Frame-work contain the directive `include Msf::Exploit::Remote::BrowserAutopwn`:
    Exploits that contain that include line will be attempted when the autopwn server
    is accessed.'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 在加载用于存储结果的数据库 (`db_connect postgres:toor@127.0.0.1/msfbook`) 后，KARMA 加载了如图 ![](../images/00002.gif)
    所示的 `browser_autopwn` 服务器。这是一种尝试针对浏览器进行多种漏洞利用的便捷方式。框架中的许多基于浏览器的漏洞利用包含指令 `include
    Msf::Exploit::Remote::BrowserAutopwn`：包含该指令的漏洞利用程序将在访问 autopwn 服务器时尝试。
- en: At ![](../images/00004.gif) and ![](../images/00005.gif), the local IP address
    is set to `10.0.0.1`, which coincides with the default DHCP configuration. Then,
    in lines ![](../images/00006.gif) and on, the various servers are configured and
    started. (To get a complete picture of what occurs in this attack, read the resource
    file.)
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 在 ![](../images/00004.gif) 和 ![](../images/00005.gif) 处，本地 IP 地址设置为 `10.0.0.1`，这与默认的
    DHCP 配置相吻合。然后，从 ![](../images/00006.gif) 行开始，配置并启动了各种服务器。（要了解攻击中发生的完整情况，请参阅资源文件。）
- en: 'Next, we place our wireless card in monitor mode. The way in which we do this
    depends on our wireless card’s chipset. The wireless card in the following example
    uses the RT73 chipset. We use `airmon-ng start wlan0` to place it in monitor mode:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将无线网卡置于监控模式。我们这样做的方式取决于无线网卡的芯片组。以下示例中的无线网卡使用 RT73 芯片组。我们使用 `airmon-ng
    start wlan0` 将其置于监控模式：
- en: '[PRE3]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: '* * *'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Note
  id: totrans-17
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If your card uses a different chipset from the one used in this example, visit
    the Aircrack-ng website ([http://www.aircrack-ng.org/](http://www.aircrack-ng.org/))
    for specifics on how to place your card in monitor mode.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您的卡片使用与示例中不同的芯片组，请访问 Aircrack-ng 网站 ([http://www.aircrack-ng.org/](http://www.aircrack-ng.org/))
    了解如何将您的卡片置于监控模式的具体信息。
- en: '* * *'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Launching the Attack
  id: totrans-20
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 启动攻击
- en: 'The `airbase-ng` component of the Aircrack-ng suite is used to create Karmeta-sploit’s
    fake access point. In the next example, we configure the `airbase-ng` access point
    to respond to all probes (`-P`), to beacon every 30 seconds (`-C 30`) with the
    ESSID Free Wi-Fi (`-e "Free WiFi"`), and to be verbose (`-v`) using the interface
    `mon0`:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: Aircrack-ng 套件中的 *airbase-ng* 组件用于创建 Karmeta-sploit 的假接入点。在下一个示例中，我们配置 `airbase-ng`
    接入点以响应所有探测 (`-P`)，每 30 秒发送一次信标 (`-C 30`) 使用 ESSID Free Wi-Fi (`-e "Free WiFi"`)，并使用
    `mon0` 接口详细输出 (`-v`)：
- en: '[PRE4]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: As you can see at ![](../images/00002.gif), Airbase-ng creates a new interface
    called *at0*. Karmetasploit will use this interface.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 如您在 ![](../images/00002.gif) 所见，Airbase-ng 创建了一个名为 *at0* 的新接口。Karmetasploit
    将使用此接口。
- en: 'Next, we turn on the *at0* interface and start the DHCP server:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们打开 *at0* 接口并启动 DHCP 服务器：
- en: '[PRE5]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The *at0* interface is turned on using the IP address of `10.0.0.1` shown at
    ![](../images/00002.gif), and the DHCP server is started using the configuration
    file we created earlier, also using *at0* as shown at ![](../images/00004.gif).
    To make sure that the DHCP server is running, we run a quick `ps aux` at ![](../images/00005.gif).
    Finally, we tail the *messages* log file at ![](../images/00006.gif) to see when
    IP addresses are being handed out.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 使用如图 ![](../images/00002.gif) 所示的 `10.0.0.1` IP 地址打开 *at0* 接口，并使用我们之前创建的配置文件启动
    DHCP 服务器，也使用 *at0*，如图 ![](../images/00004.gif) 所示。为了确保 DHCP 服务器正在运行，我们在 ![](../images/00005.gif)
    处运行了一个快速的 `ps aux` 命令。最后，我们在 ![](../images/00006.gif) 处跟踪 *messages* 日志文件以查看 IP
    地址何时被分配。
- en: 'Now that the entire Karmetasploit configuration is complete, we can load the
    resource file from within *msfconsole* using `resource karma.rc` as shown next.
    (Note that we can also pass the resource file to *msfconsole* via the command
    line by entering `msfconsole -r karma.rc`.) Let’s see it in action:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 现在Karmetasploit的整个配置已经完成，我们可以在 *msfconsole* 中使用 `resource karma.rc` 加载资源文件，如图所示。（请注意，我们也可以通过命令行将资源文件传递给
    *msfconsole*，方法是输入 `msfconsole -r karma.rc`。）让我们看看它的实际效果：
- en: '[PRE6]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: As you can see, a great deal is happening with the resource file. In this listing,
    the `LHOST` address is set to *10.0.0.1* at ![](../images/00002.gif), the POP3
    service (among others) is started at ![](../images/00004.gif), the *autopwn* exploits
    are loaded at ![](../images/00005.gif), and payloads are configured at ![](../images/00006.gif).
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 如您所见，资源文件中发生了很多事情。在此列表中，`LHOST` 地址在 ![](../images/00002.gif) 处设置为 *10.0.0.1*，在
    ![](../images/00004.gif) 处启动了 POP3 服务（以及其他服务），在 ![](../images/00005.gif) 处加载了
    *autopwn* 漏洞利用程序，在 ![](../images/00006.gif) 处配置了有效载荷。
- en: Credential Harvesting
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 凭据收集
- en: 'When a client connects to our malicious access point, the messages file we
    are tailing will show us when an IP address is handed out. This is our cue to
    switch back to *msfconsole* to see what is happening. Here, we see that a client
    connects and is assigned an IP address:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 当客户端连接到我们的恶意接入点时，我们正在跟踪的消息文件会显示何时分配了IP地址。这是我们切换回*msfconsole*以查看发生了什么的提示。在这里，我们看到一个客户端连接并被分配了一个IP地址：
- en: '[PRE7]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The first thing our target does is open an email client. Karmetasploit is waiting,
    as shown here:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的目标首先打开一个电子邮件客户端。Karmetasploit正在等待，如图所示：
- en: '[PRE8]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: The POP3 server configured by Metasploit intercepts the target’s email username
    and password at ![](../images/00002.gif), because all DNS requests are intercepted
    by the DNS server that Karmetasploit set up for us.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: Metasploit配置的POP3服务器在![图片](../images/00002.gif)处拦截了目标电子邮件的用户名和密码，因为所有DNS请求都被Karmetasploit为我们设置的DNS服务器拦截。
- en: Getting a Shell
  id: totrans-36
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 获取Shell
- en: At this point, the user has no new messages, so he decides to do some web browsing.
    When the browser opens, a *captive portal* is presented to the user, as shown
    in [Figure 12-1](part0016.html#karmetasploit_captive_portal).
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个阶段，用户没有新的消息，所以他决定浏览一下网页。当浏览器打开时，用户会看到一个*捕获门户*，如图[图12-1](part0016.html#karmetasploit_captive_portal)所示。
- en: '![Karmetasploit captive portal](../images/00047.jpeg)Figure 12-1. Karmetasploit
    captive portal'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: '![Karmetasploit捕获门户](../images/00047.jpeg)图12-1. Karmetasploit捕获门户'
- en: As the user sits in front of his computer wondering what’s going on, Karmetasploit
    is busy configuring the attack to capture cookies; set up fake email, DNS, and
    other servers; and launch exploits against the client’s browser — all the result
    of the magic contained in our *karma.rc* file.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 当用户坐在电脑前，想知道发生了什么时，Karmetasploit正忙于配置攻击以捕获cookies；设置虚假的电子邮件、DNS和其他服务器；并对客户端的浏览器发起攻击——所有这些都是我们*karma.rc*文件中包含的魔法的结果。
- en: Of course, some degree of luck is involved in this attack. The browser will
    display a “Loading” page while exploits are launched. If the user is impatient,
    he may simply close the browser window, which will stop our exploits.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，这种攻击涉及一定程度的好运。当启动漏洞时，浏览器将显示“加载”页面。如果用户不耐烦，他可能会简单地关闭浏览器窗口，这将停止我们的漏洞攻击。
- en: 'Next, you can see the massive amount of output that results from this attack:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，你可以看到由此攻击产生的巨大输出量：
- en: '[PRE9]'
  id: totrans-42
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: In this output, you can see at ![](../images/00002.gif) that Metasploit first
    lets the client know that various popular websites are in fact located on the
    attacking machine. Then, at ![](../images/00004.gif), it uses JavaScript to determine
    the target’s operating system and browser, and responds at ![](../images/00005.gif)
    with exploits based on that fingerprint. At ![](../images/00006.gif) the client
    is presented with a malicious ActiveX control, resulting in the familiar yellow
    prompt bar in Internet Explorer, shown at the top of [Figure 12-1](part0016.html#karmetasploit_captive_portal).
    You can also see buried in the output at ![](../images/00007.gif) that an exploit
    was launched against the client. After a brief period, you see at ![](../images/00026.gif)
    that the exploit was successful and a Meterpreter session has been opened on the
    target PC!
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个输出中，你可以看到在![图片](../images/00002.gif)处，Metasploit首先让客户端知道各种流行的网站实际上位于攻击机器上。然后，在![图片](../images/00004.gif)处，它使用JavaScript确定目标操作系统和浏览器，并在![图片](../images/00005.gif)处根据该指纹响应以漏洞为基础。在![图片](../images/00006.gif)处，客户端被展示了一个恶意ActiveX控件，导致在Internet
    Explorer中出现了熟悉的黄色提示栏，如图[图12-1](part0016.html#karmetasploit_captive_portal)顶部所示。你还可以在![图片](../images/00007.gif)输出中看到针对客户端启动了漏洞。经过一段短暂的时间，你会在![图片](../images/00026.gif)处看到漏洞成功，并在目标PC上打开了一个Meterpreter会话！
- en: Returning to *msfconsole*, we can interact with the session that was created
    and check to see what permissions we have obtained on the target. Remember, when
    you exploit a browser it’s always a good idea to migrate your process out of the
    web browser in case it gets closed.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 返回到*msfconsole*，我们可以与创建的会话进行交互，并检查我们在目标上获得了哪些权限。记住，当你利用浏览器时，总是将你的进程从浏览器中迁移出来是一个好主意，以防它被关闭。
- en: '[PRE10]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Because this is a default installation of Windows XP SP2 with the very insecure
    Internet Explorer 6 installed (both of which are highly out of date), the client
    didn’t even need to accept and install the malicious ActiveX control.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 由于这是一个默认安装的Windows XP SP2，安装了非常不安全的Internet Explorer 6（两者都高度过时），客户端甚至不需要接受和安装恶意ActiveX控件。
- en: Wrapping Up
  id: totrans-47
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 总结
- en: Attacks against wireless networks have been a popular topic for quite some time.
    Although this attack can take a bit of setup, imagine its success against a number
    of similarly configured clients located in a high-traffic or public area. This
    approach to attacking wireless clients is often popular because it’s easier than
    a brute force attack against a well-secured wireless infrastructure.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 对无线网络的攻击已经是一个热门话题有一段时间了。尽管这种攻击需要一些设置，但想象一下它在位于高流量或公共区域的大量类似配置客户端中的成功率。这种攻击无线客户端的方法之所以受欢迎，通常是因为它比针对高度安全的无线基础设施的暴力攻击要容易。
- en: Now that you’ve seen how easy it is to conduct this sort of attack, you’ll probably
    think twice about using public wireless networks. Are you sure that the coffee
    shop is offering “free public Wi-Fi”? Or perhaps someone is running Karmetasploit?
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经看到进行这类攻击是多么容易，你可能会对使用公共无线网络三思而后行。你确定咖啡馆提供的真的是“免费公共Wi-Fi”吗？或者可能有人在运行Karmetasploit？
