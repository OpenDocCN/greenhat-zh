- en: Chapter 9. Metasploit Auxiliary Modules
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第 9 章。Metasploit 辅助模块
- en: When most people think of Metasploit, exploits come to mind. Exploits are cool,
    exploits get you shell, and exploits get all the attention. But sometimes you
    need something more than that. By definition, a Metasploit module that is not
    an exploit is an *auxiliary module*, which leaves a lot to the imagination.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 当大多数人想到 Metasploit 时，会想到漏洞利用。漏洞利用很酷，漏洞利用能让你获得 shell，漏洞利用吸引了所有的注意力。但有时你需要比这更多的东西。根据定义，Metasploit
    中不是漏洞利用的模块是 *辅助模块*，这留下了很多想象空间。
- en: In addition to providing valuable reconnaissance tools such as port scanners
    and service fingerprinters, auxiliary modules such as *ssh_login* can take a known
    list of usernames and passwords and then attempt to log in via brute force across
    an entire target network. Also included in the auxiliary modules are various protocol
    fuzzers such as *ftp_pre_post*, *http_get_uri_long*, *smtp_fuzzer*, *ssh_version_corrupt*,
    and more. You can launch these fuzzers at a target service in hopes of finding
    your own vulnerabilities to exploit.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 除了提供如端口扫描器和服务指纹识别器等有价值的侦察工具外，辅助模块如 *ssh_login* 可以尝试通过暴力破解整个目标网络登录已知的用户名和密码列表。辅助模块还包括各种协议模糊测试工具，如
    *ftp_pre_post*、*http_get_uri_long*、*smtp_fuzzer*、*ssh_version_corrupt* 等。你可以在目标服务上启动这些模糊测试工具，希望找到可以利用的自己的漏洞。
- en: Just because auxiliary modules don’t have a payload, don’t think you won’t use
    them. But before we dive into their myriad uses, here’s an overview to help you
    see what we are dealing with.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 只是因为辅助模块没有有效载荷，并不意味着你不会使用它们。但在我们深入探讨它们的多种用途之前，这里有一个概述，帮助你了解我们正在处理的内容。
- en: '[PRE0]'
  id: totrans-4
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: As you can see in the preceding listing, modules are installed within the */modules/auxiliary*
    directory ![](../images/00002.gif) of the Framework, and within that, sorted based
    on the functions they provide. Should you want to create your own module or edit
    an existing one to suit a specific purpose, you will find them in their corresponding
    directories. For instance, if you need to develop a fuzzer module to hunt your
    own bugs, you will find some pre-existing modules in the */fuzzers* directory.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，模块安装在与 Framework 的 */modules/auxiliary* 目录 ![图片](../images/00002.gif) 中，并且在该目录内按它们提供的功能进行排序。如果你想要创建自己的模块或编辑现有的模块以适应特定目的，你将在相应的目录中找到它们。例如，如果你需要开发一个模糊测试模块来寻找自己的漏洞，你将在
    */fuzzers* 目录中找到一些预存的模块。
- en: To list all the available auxiliary modules within Metasploit, simply issue
    the **`show auxiliary`** command ![](../images/00002.gif) within *msfconsole*.
    If you compare the preceding directory listing with the module names displayed
    in *msfconsole*, you will notice that the naming of the modules depends on the
    underlying directory structure, as shown below.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 要列出 Metasploit 中所有可用的辅助模块，只需在 *msfconsole* 中发出 **`show auxiliary`** 命令 ![图片](../images/00002.gif)。如果你将前面的目录列表与
    *msfconsole* 中显示的模块名称进行比较，你会注意到模块的命名取决于底层目录结构，如下所示。
- en: '[PRE1]'
  id: totrans-7
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: As you can see in this trimmed output, the auxiliary modules are organized by
    category. At your disposal are the DNS enumeration module, Wi-Fi fuzzers, and
    even a module to locate and abuse the Trojan backdoor that was included on Energizer
    USB battery chargers.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，在这个裁剪后的输出中，辅助模块按类别组织。你可以使用 DNS 枚举模块、Wi-Fi 模糊测试工具，甚至一个用于定位和滥用在 Energizer
    USB 电池充电器上包含的木马后门的模块。
- en: Using an auxiliary module is similar to using any exploit within the Framework
    — simply issue the `use` command followed by the module name. For example, to
    use the *webdav_scanner* module (explored in [Auxiliary Modules in Use](part0013.html#auxiliary_modules_in_use)
    in [Auxiliary Modules in Use](part0013.html#auxiliary_modules_in_use)), you would
    run `use scanner/http/webdav_scanner` as shown below.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 使用辅助模块与在 Framework 中使用任何漏洞利用类似——只需发出 `use` 命令后跟模块名称。例如，要使用 *webdav_scanner*
    模块（在 [使用辅助模块](part0013.html#auxiliary_modules_in_use) 中探讨），你将运行 `use scanner/http/webdav_scanner`，如下所示。
- en: '* * *'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Note
  id: totrans-11
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: In auxiliary modules, the basic options are slightly different with an `RHOSTS`
    option to target multiple machines and a `THREADS` value to fine-tune the speed
    of your scanning.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 在辅助模块中，基本选项略有不同，有一个 `RHOSTS` 选项用于针对多台机器，以及一个 `THREADS` 值用于微调扫描速度。
- en: '* * *'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: '[PRE2]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Here we issue the `use` command ![](../images/00002.gif) for the module of interest.
    We can then get a full dump of information from the system using the `info` command
    ![](../images/00004.gif), as well as a list of the various available options.
    Within the options, we see that the only required option without a default is
    `RHOSTS` ![](../images/00005.gif), which can take a single IP address, list, range,
    or CIDR notation.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们发出`use`命令 ![](../images/00002.gif) 来使用感兴趣的模块。然后，我们可以使用`info`命令 ![](../images/00004.gif)
    从系统中获取完整的信息，以及各种可用选项的列表。在选项中，我们看到唯一一个没有默认值的必需选项是`RHOSTS` ![](../images/00005.gif)，它可以接受单个IP地址、列表、范围或CIDR表示法。
- en: The other options mostly vary depending on the auxiliary module being used.
    For instance, the `THREADS` ![](../images/00006.gif) option allows multiple threads
    to be launched as part of a scan, which speeds things up exponentially.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 其他选项主要取决于所使用的辅助模块。例如，`THREADS` ![](../images/00006.gif)选项允许在扫描过程中启动多个线程，这可以指数级地加快速度。
- en: Auxiliary Modules in Use
  id: totrans-17
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 正在使用的辅助模块
- en: Auxiliary modules are exciting because they can be used in so many ways for
    so many things. If you can’t find the perfect auxiliary module, it’s easy to modify
    one to suit your specific needs.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 辅助模块非常吸引人，因为它们可以用多种方式用于许多事情。如果你找不到完美的辅助模块，很容易修改一个来满足你的特定需求。
- en: Consider a common example. Say you are conducting a remote penetration test,
    and upon scanning the network, you identify a number of web servers and not much
    else. Your attack surface is limited at this point, and you have to work with
    what is available to you. Your auxiliary *scanner/http* modules will now prove
    extremely helpful as you look for low-hanging fruit against which you can launch
    an exploit. To search for all available HTTP scanners, run **`search scanner/http`**
    as shown here.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑一个常见的例子。比如说，你正在进行远程渗透测试，在扫描网络后，你识别出了一些Web服务器以及其他不多的事物。此时你的攻击面有限，你必须利用你所拥有的资源。你的辅助*scanner/http*模块现在将证明在寻找容易攻击的目标时极为有用。要搜索所有可用的HTTP扫描器，运行**`search
    scanner/http`**，如下所示。
- en: '[PRE3]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: There are a lot of options here, so let’s identify some likely candidates in
    that list. Notice that there are the options for identifying the *robots.txt*
    ![](../images/00002.gif) file from various servers, numerous ways to interact
    with WebDAV ![](../images/00004.gif), tools to identify servers with writable
    file access ![](../images/00005.gif), and many other special-purpose modules.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 这里有许多选项，所以让我们在那份列表中识别一些可能的候选者。请注意，有从各种服务器识别*robots.txt* ![](../images/00002.gif)文件的选项，多种与WebDAV
    ![](../images/00004.gif)交互的方式，以及识别具有可写文件访问权限的服务器的工具，还有许多其他特殊用途的模块。
- en: You can see immediately that there are modules that you can use for subsequent
    exploration. Older versions of Microsoft IIS had a vulnerability in their WebDAV
    implementations that allowed for remote exploitation, so you could first run a
    scan against your targets in hopes of finding a server with WebDAV enabled, as
    follows.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以立即看到一些可以用于后续探索的模块。Microsoft IIS的旧版本在其WebDAV实现中存在一个漏洞，允许远程利用，因此你可以首先对你的目标运行扫描，希望找到启用了WebDAV的服务器，如下所示。
- en: '[PRE4]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: As you can see in this example, a number of HTTP servers have been scanned in
    the search for WebDAV ![](../images/00002.gif), and only one happens to have Web-DAV
    enabled ![](../images/00004.gif). This module has quickly identified a specific
    system against which you can launch further attacks.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 正如这个例子所示，在寻找WebDAV ![](../images/00002.gif)的过程中已经扫描了多个HTTP服务器，而只有一个恰好启用了Web-DAV
    ![](../images/00004.gif)。该模块迅速识别了一个特定的系统，你可以针对它发起进一步的攻击。
- en: '* * *'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Note
  id: totrans-26
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Auxiliary module functionality goes far beyond scanning. As you will see in
    [Chapter 14](part0018.html#creating_your_own_exploits) auxiliary modules also
    work great as fuzzers with a little modification. A number of denial-of-service
    modules are also available for Wi-Fi (including *dos/wifi/deauth*), which can
    prove quite disruptive when used properly.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 辅助模块的功能远不止扫描。正如你将在[第14章](part0018.html#creating_your_own_exploits)中看到的那样，辅助模块经过一些修改后也可以作为fuzzers使用。还有一些针对Wi-Fi（包括*dos/wifi/deauth*）的拒绝服务模块也可用，如果正确使用，可能会造成相当大的破坏。
- en: '* * *'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Anatomy of an Auxiliary Module
  id: totrans-29
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 辅助模块的解剖结构
- en: Let’s look at the makeup of an auxiliary module in a fun little example not
    currently in the Metasploit repository (because it does not pertain to penetration
    testing). This example will demonstrate how easy it is to off-load a great deal
    of programming to the Framework, allowing us to focus on the specifics of a module.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们通过一个有趣的小例子来看看辅助模块的构成，这个例子目前不在Metasploit仓库中（因为它与渗透测试无关）。这个例子将展示将大量编程工作卸载到框架中是多么容易，这样我们就可以专注于模块的具体细节。
- en: Chris Gates wrote an auxiliary module for the Framework that gave his Twitter
    followers the impression that he had somehow invented a device that allowed him
    to travel at the speed of light. It makes a great example of the code reuse available
    in Metasploit. (You can access the source of the script at [http://carnal0wnage.googlecode.com/](http://carnal0wnage.googlecode.com/).)
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: Chris Gates为框架编写了一个辅助模块，让他的Twitter粉丝误以为他发明了一种能够以光速旅行的设备。这是Metasploit中可重用代码的一个很好的例子。（您可以在[http://carnal0wnage.googlecode.com/](http://carnal0wnage.googlecode.com/)找到脚本的源代码。）
- en: '[PRE5]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: We’ve placed the module in our auxiliary directory ![](../images/00002.gif)
    so that it will be available for use by Metasploit. But before we use this module,
    let’s look at the actual script and break down the components so we can see exactly
    what the module contains.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将模块放置在我们的辅助目录 ![](../images/00002.gif) 中，以便它可供Metasploit使用。但在我们使用此模块之前，让我们看看实际的脚本，并分解组件，这样我们就可以确切地看到模块包含什么。
- en: '[PRE6]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The module begins with the first two lines importing the auxiliary class ![](../images/00002.gif).
    Next it makes the HTTP client functions available for use ![](../images/00004.gif)
    within the script.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 模块从导入辅助类 ![](../images/00002.gif) 的前两行开始。接下来，它使HTTP客户端函数可用于脚本中使用 ![](../images/00004.gif)。
- en: '[PRE7]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Within the initialization constructor ![](../images/00002.gif) we define much
    of the information ![](../images/00004.gif) that is reported back when issuing
    the `info` command in *msfconsole*. We can see where the various options are defined
    ![](../images/00005.gif) and whether they are required. So far, all are pretty
    direct and their purposes are clear. Still, we have yet to see any actual logic
    being performed. That comes next.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在初始化构造函数 ![](../images/00002.gif) 中，我们定义了在执行`info`命令时通过 *msfconsole* 返回的大部分信息
    ![](../images/00004.gif)。我们可以看到各种选项在哪里定义 ![](../images/00005.gif) 以及它们是否是必需的。到目前为止，所有选项都很直接，它们的目的都很明确。然而，我们还没有看到任何实际执行的逻辑。接下来就是了。
- en: '[PRE8]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Now we reach the actual logic of the script — what happens when `run` is called
    within the module. Initially the provided options are set to local variable names
    ![](../images/00002.gif) along with defining various other objects. An object
    is then created by calling the *send_request_cgi* method ![](../images/00004.gif)
    imported into the script from *lib/msf/core/exploit/http.rb* and defined as “Connects
    to the server, creates a request, sends the request, reads the response.” This
    method takes various parameters that make up the call to the actual server, as
    shown here.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们来到了脚本的真正逻辑——当在模块中调用`run`时会发生什么。最初，提供的选项被设置为局部变量名 ![](../images/00002.gif)，同时定义了各种其他对象。然后通过调用从脚本中导入的`*send_request_cgi*`方法
    ![](../images/00004.gif)（该方法是导入自`*lib/msf/core/exploit/http.rb*`并定义为“连接到服务器，创建请求，发送请求，读取响应。”）来创建一个对象。此方法接受各种参数，这些参数构成了对实际服务器的调用，如这里所示。
- en: '[PRE9]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: After this object is created, the results are printed ![](../images/00002.gif).
    If anything goes wrong, logic exists for catching any errors ![](../images/00004.gif)
    and reporting them to the user. All of this logic is simple and is just a matter
    of plugging various parameters into existing functions of the Framework. This
    is a great example of the power of the Framework, because it allows us to concentrate
    only on the information needed to address our goal. There is no reason to reproduce
    any of the standard functions such as error handling, connection management, and
    so on.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 创建此对象后，结果会被打印出来 ![](../images/00002.gif)。如果发生任何错误，存在逻辑来捕获任何错误 ![](../images/00004.gif)并向用户报告。所有这些逻辑都很简单，只是将各种参数插入到框架的现有函数中。这是一个框架强大功能的绝佳例子，因为它允许我们只关注实现目标所需的信息。没有必要重新实现任何标准功能，如错误处理、连接管理等。
- en: Let’s see this module in action. If you don’t remember the full path to the
    module within the Metasploit directory structure, search for it like so.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看这个模块的实际应用。如果您不记得Metasploit目录结构中模块的完整路径，可以像这样搜索它。
- en: '[PRE10]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: In the prior example, we search for “foursquare” ![](../images/00002.gif), issue
    the `use` command ![](../images/00004.gif) to select the auxiliary module, and
    display the information ![](../images/00005.gif) for the selected module. Based
    on the options presented above, we need to configure a few of them first.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 在先前的例子中，我们搜索“foursquare” ![../images/00002.gif]，发出`use`命令 ![../images/00004.gif]
    来选择辅助模块，并显示所选模块的信息 ![../images/00005.gif]。根据上述提供的选项，我们首先需要配置其中的一些。
- en: '[PRE11]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: In order to run this module successfully, we need a valid set of Foursquare
    credentials to do the check-in. We first define the VenueID that we find online
    with a bit of Googling ![](../images/00002.gif), and then we set our Foursquare
    credentials ![](../images/00004.gif) and run the module. We get a successful result
    with the Foursquare service confirming our check-in and giving us five points
    ![](../images/00005.gif).
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 为了成功运行此模块，我们需要一组有效的Foursquare凭证来进行签到。我们首先通过一些谷歌搜索找到在线的VenueID ![../images/00002.gif]，然后设置我们的Foursquare凭证
    ![../images/00004.gif] 并运行模块。我们得到了一个成功的结果，Foursquare服务确认了我们的签到并给我们五分 ![../images/00005.gif]。
- en: In this case, we have submitted a request to “check in” at Union Station in
    Washington, DC, on the Foursquare service (see [Figure 9-1](part0013.html#a_successful_check-in_at_union_station)).
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，我们在Foursquare服务上提交了一个在华盛顿特区的联合车站“签到”的请求（见[图9-1](part0013.html#a_successful_check-in_at_union_station)）。
- en: '![A successful check-in at Union Station](../images/00038.jpeg)Figure 9-1. A
    successful check-in at Union Station'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: '![在联合车站成功签到](../images/00038.jpeg) 图9-1. 在联合车站成功签到'
- en: When we check the Foursquare website, we see a successful result. Modules like
    these demonstrate that Metasploit allows us to implement nearly anything we can
    programmatically imagine.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们检查Foursquare网站时，我们看到一个成功的结果。这类模块表明Metasploit允许我们实现几乎任何我们可以通过编程想象的事情。
- en: Going Forward
  id: totrans-50
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 展望未来
- en: As you have seen, auxiliary modules can have a wide range of uses. The infrastructure
    provided by the Metasploit Framework can produce a wide array of tools in a very
    short time. Using Metasploit’s auxiliary modules, you can scan an IP address range
    to determine which hosts are alive and which services are running on each host.
    You can then leverage this information to determine vulnerable services, such
    as in the WebDAV example, or even log in via brute force on a remote server.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 正如你所见，辅助模块可以有多种用途。Metasploit框架提供的基础设施可以在很短的时间内产生大量工具。使用Metasploit的辅助模块，你可以扫描IP地址范围以确定哪些主机是活跃的，以及每个主机上运行着哪些服务。然后你可以利用这些信息来确定有漏洞的服务，例如在WebDAV示例中，或者甚至通过暴力破解在远程服务器上登录。
- en: Although you can easily create custom auxiliary modules, don’t discount the
    existing auxiliary modules in the Framework. These modules may be the exact one-off
    tool you need.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然你可以轻松创建自定义辅助模块，但不要低估框架中现有的辅助模块。这些模块可能是你需要的特定一次性工具。
- en: The auxiliary modules provide a wide range of potential additional avenues.
    For a web application, the auxiliary modules offer more than 40 additional checks
    or attacks that you can perform. In some instances, you may want to brute force
    a web server to see which servers are listing directories. Or you may want to
    scan the web server to see if it can act as an open proxy and relay traffic out
    to the Internet. Regardless of your needs, the auxiliary modules can provide additional
    enumeration information, attack vectors, or vulnerabilities.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 辅助模块提供了一系列潜在的可选途径。对于一个Web应用程序，辅助模块提供了40多个额外的检查或攻击，你可以执行。在某些情况下，你可能想暴力破解Web服务器以查看哪些服务器正在列出目录。或者你可能想扫描Web服务器以查看它是否可以作为开放代理并将流量中继到互联网。无论你的需求如何，辅助模块都可以提供额外的枚举信息、攻击向量或漏洞。
