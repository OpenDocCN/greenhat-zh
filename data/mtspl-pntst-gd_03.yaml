- en: Chapter 3. Intelligence Gathering
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第3章 情报收集
- en: Intelligence gathering follows the pre-engagement activities as the second step
    in a penetration test. Your goals during intelligence gathering should be to gain
    accurate information about your targets without revealing your presence or your
    intentions, to learn how the organization operates, and to determine the best
    route of entry. If you don’t do a thorough job of intelligence gathering, you
    may miss vulnerable systems or viable attack vectors. It takes time and patience
    to sort through web pages, perform Google hacking, and map systems thoroughly
    in an attempt to understand the infrastructure of a particular target. Intelligence
    gathering requires careful planning, research, and, most importantly, the ability
    to think like an attacker. At this step, you will attempt to collect as much information
    about the target environment as possible. This can be an expansive amount of information,
    and even the most trivial data gathered during this stage can prove useful later
    on, so pay attention.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 情报收集是渗透测试的第二步，紧随预接触活动之后。在情报收集阶段，你的目标应该是获取关于目标对象的准确信息，同时不暴露你的存在或意图，了解组织的运作方式，并确定最佳进入途径。如果你没有做好情报收集的全面工作，可能会错过易受攻击的系统或可行的攻击向量。对网页进行筛选、执行谷歌黑客攻击以及彻底绘制系统图，以理解特定目标的架构，这需要时间和耐心。情报收集需要周密的计划、研究和，最重要的是，具备像攻击者一样思考的能力。在这一步，你将尝试收集尽可能多的关于目标环境的信息。这可能是一大堆信息，甚至在这个阶段收集到的最微不足道的数据也可能在以后变得有用，所以请务必注意。
- en: Before you begin intelligence gathering, consider how you will record everything
    you do and the results you achieve. You must remember and record as many details
    of your penetration test as possible. Most security professionals quickly learn
    that detailed notes can mean the difference between a successful and a failed
    penetration test. Just as a scientist needs to achieve reproducible results, other
    experienced penetration testers should be able to reproduce your work using your
    documentation alone.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在开始情报收集之前，考虑你将如何记录你所做的一切和所取得的结果。你必须记住并记录尽可能多的渗透测试细节。大多数安全专业人士很快就会意识到，详细的笔记可能意味着成功和失败的渗透测试之间的区别。就像科学家需要达到可重复的结果一样，其他经验丰富的渗透测试人员应该能够仅使用你的文档来重现你的工作。
- en: Intelligence gathering is arguably the most important aspect of a penetration
    test, because it provides the foundation for all work that follows. When recording
    your work, be methodical, accurate, and precise. And, as stated earlier, be sure
    that before you fire off your exploits, you have learned all that you can about
    your target.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 情报收集可以说是渗透测试最重要的方面，因为它为所有后续工作提供了基础。在记录你的工作时，要条理清晰、准确、精确。并且，如前所述，在发动攻击之前，确保你已经了解了关于目标的所有信息。
- en: The excitement for most people comes in exploiting systems and getting to root,
    but you need to learn to walk before you can run.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 对于大多数人来说，兴奋点在于利用系统和获取root权限，但你在跑之前需要学会走路。
- en: '* * *'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Warning
  id: totrans-6
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 警告
- en: If you follow the procedures in this chapter, you can actually damage your system
    and your target’s system, so be sure to set up your test environment now. (For
    help, see [Appendix A](part0022.html#configuring_your_target_machines).) Many
    of the examples in these chapters can be destructive and make a target system
    unusable. The activities discussed in this chapter could be considered illegal
    if they are undertaken by someone with bad intentions, so follow the rules and
    don’t be stupid.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你遵循本章中的程序，实际上可能会损坏你的系统和目标系统，所以请确保现在就设置你的测试环境。（有关帮助，请参阅[附录A](part0022.html#configuring_your_target_machines)。）这些章节中的许多示例可能是破坏性的，并使目标系统无法使用。如果有人出于恶意目的执行本章讨论的活动，可能会被视为非法，所以请遵守规则，不要愚蠢行事。
- en: '* * *'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Passive Information Gathering
  id: totrans-9
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 被动情报收集
- en: By using *passive* and *indirect* information gathering, you can discover information
    about targets without touching their systems. For example, you can use these techniques
    to identify network boundaries, identify the network maintainers, and even learn
    what operating system and web server software is in use on the target network.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 通过使用*被动*和*间接*的情报收集方法，你可以在不接触目标系统的情况下发现有关目标的信息。例如，你可以使用这些技术来识别网络边界、识别网络维护者，甚至了解目标网络上正在使用的操作系统和Web服务器软件。
- en: '*Open source intelligence (OSINT)* is a form of intelligence collection that
    uses open or readily available information to find, select, and acquire information
    about a target. Several tools make passive information gathering almost painless,
    including complex tools such as Yeti and the humble *whois*. In this section,
    we’ll explore the process of passive information gathering and the tools that
    you might use for this step.'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: '*开源情报（OSINT）*是一种情报收集形式，它使用公开或易于获取的信息来查找、选择和获取有关目标的信息。一些工具使被动信息收集变得几乎无痛，包括像Yeti这样的复杂工具和简单的*whois*。在本节中，我们将探讨被动信息收集的过程以及你可能用于此步骤的工具。'
- en: Imagine, for example, an attack against [http://www.secmaniac.net/](http://www.secmaniac.net/).
    Our goal is to determine, as a part of a penetration test, what systems the company
    owns and what systems we can attack. Some systems may not be owned by the company
    and could be considered out of scope and unavailable for attack.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，想象一下对[http://www.secmaniac.net/](http://www.secmaniac.net/)的攻击。我们的目标是确定，作为渗透测试的一部分，公司拥有哪些系统，我们可以攻击哪些系统。一些系统可能不属于公司，可能被视为范围之外且不可攻击。
- en: whois Lookups
  id: totrans-13
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: whois查询
- en: Let’s begin by using Back|Track’s *whois* lookup to find the names of [secmaniac.net](http://secmaniac.net)’s
    domain servers.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从使用Back|Track的*whois*查询开始，以找到[secmaniac.net](http://secmaniac.net)的域名服务器名称。
- en: '[PRE0]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: We learn at ![](../images/00002.gif) that the Domain Name System (DNS) servers
    are hosted by *DOMAINCONTROL.COM*, so this is a good example of systems that would
    not be included in a penetration test because we would have no authority to attack
    them. In most large organizations, the DNS servers are housed within the company
    and are viable attack vectors. Zone transfers and similar DNS attacks can often
    be used to learn more about a network from both the inside and outside. In this
    scenario, because *DOMAINCONTROL.COM* is not owned by [secmaniac.net](http://secmaniac.net),
    we should not attack these systems and will instead move on to a different attack
    vector.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在![使用示例](../images/00002.gif)中了解到，域名系统（DNS）服务器由*DOMAINCONTROL.COM*托管，因此这是一个很好的例子，说明在渗透测试中不会包含的系统，因为我们没有权限攻击它们。在大多数大型组织中，DNS服务器位于公司内部，并且是可行的攻击向量。区域传输和类似的DNS攻击通常可以用来从内部和外部了解更多关于网络的信息。在这种情况下，因为*DOMAINCONTROL.COM*不属于[secmaniac.net](http://secmaniac.net)，所以我们不应该攻击这些系统，而将转向不同的攻击向量。
- en: Netcraft
  id: totrans-17
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Netcraft
- en: Netcraft ([http://searchdns.netcraft.com/](http://searchdns.netcraft.com/))
    is a web-based tool that we can use to find the IP address of a server hosting
    a particular website, as shown in [Figure 3-1](part0007.html#use_netcraft_to_find_the_ip_address_of_t).
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: Netcraft ([http://searchdns.netcraft.com/](http://searchdns.netcraft.com/))是一个基于网络的工具，我们可以用它来查找特定网站托管服务器的IP地址，如图3-1所示。
- en: '![Use Netcraft to find the IP address of the server hosting a particular website.](../images/00003.jpeg)Figure 3-1. Use
    Netcraft to find the IP address of the server hosting a particular website.'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: '![使用Netcraft查找特定网站托管服务器的IP地址。](../images/00003.jpeg)图3-1. 使用Netcraft查找特定网站托管服务器的IP地址。'
- en: 'Having identified [secmaniac.net](http://secmaniac.net)’s IP address as 75.118.185.142,
    we do another *whois* lookup on that IP address:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 在将[secmaniac.net](http://secmaniac.net)的IP地址识别为75.118.185.142后，我们对该IP地址进行了另一个*whois*查询：
- en: '[PRE1]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: We see from the *whois* lookup and a quick search that this IP (*WIDEOPENWEST*)
    appears to be a legitimate service provider. While the actual subnet range isn’t
    specifically registered to [secmaniac.net](http://secmaniac.net) or [secmaniac.com](http://secmaniac.com),
    we can tell that this site appears to be hosted inside the author’s home, because
    the IP block appears to be part of a residential range.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 从*whois*查询和快速搜索中我们可以看到，这个IP（*WIDEOPENWEST*）看起来是一个合法的服务提供商。虽然实际的子网范围并没有特别注册给[secmaniac.net](http://secmaniac.net)或[secmaniac.com](http://secmaniac.com)，但我们可以判断这个网站似乎是在作者的家中托管，因为IP块看起来是居民区的一部分。
- en: NSLookup
  id: totrans-23
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: NSLookup
- en: To get additional server information, we’ll use Back|Track to leverage `nslookup`,
    a tool built into most operating systems, to find information about [secmaniac.net](http://secmaniac.net).
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 为了获取额外的服务器信息，我们将使用Back|Track利用内置在大多数操作系统中的`nslookup`工具来查找关于[secmaniac.net](http://secmaniac.net)的信息。
- en: '[PRE2]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: We see in this listing that the mail servers are pointing to *mailstore1.secureserver.net*
    and *smtp.secureserver.net*. Some quick research on these mail servers tells us
    that this website is hosted by a third party, which would not be within the scope
    of our penetration test.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 从这个列表中我们可以看到，邮件服务器指向*mailstore1.secureserver.net*和*smtp.secureserver.net*。对这些邮件服务器的一些快速研究告诉我们，这个网站由第三方托管，这不会在我们的渗透测试范围内。
- en: At this point, we have gathered some valuable information that we might be able
    to use against the target later on. Ultimately, however, we have to resort to
    active information gathering techniques to determine the actual target IP, which
    is 75.118.185.142.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们已经收集了一些可能后来用于攻击目标的有价值信息。然而，最终，我们必须求助于活动信息收集技术来确定实际的目标IP地址，即75.118.185.142。
- en: '* * *'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Note
  id: totrans-29
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Passive information gathering is an art that is not easily mastered in just
    a few pages of discussion. See the *Penetration Testing Execution Standard (PTES;*
    [http://www.pentest-standard.org/](http://www.pentest-standard.org/)) for a list
    of potential ways to perform additional passive intelligence gathering.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 被动信息收集是一种艺术，仅通过几页的讨论是无法轻易掌握的。请参阅*渗透测试执行标准（PTES；* [http://www.pentest-standard.org/](http://www.pentest-standard.org/))以获取执行额外被动情报收集的潜在方法列表。
- en: '* * *'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Active Information Gathering
  id: totrans-32
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 活动信息收集
- en: 'In active information gathering, we interact directly with a system to learn
    more about it. We might, for example, conduct port scans for open ports on the
    target or conduct scans to determine what services are running. Each system or
    running service that we discover gives us another opportunity for exploitation.
    But beware: If you get careless while active information gathering, you might
    be nabbed by an IDS or intrusion prevention system (IPS) — not a good outcome
    for the covert penetration tester.'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 在活动信息收集过程中，我们直接与系统交互以了解更多信息。例如，我们可能会对目标进行端口扫描以查找开放的端口，或者进行扫描以确定正在运行的服务。我们发现的每个系统或运行中的服务都为我们提供了另一个利用的机会。但请注意：如果在活动信息收集时粗心大意，你可能会被入侵检测系统（IDS）或入侵预防系统（IPS）抓住——这对隐蔽渗透测试员来说不是好结果。
- en: Port Scanning with Nmap
  id: totrans-34
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用Nmap进行端口扫描
- en: Having identified the target IP range with passive information gathering as
    well as the [secmaniac.net](http://secmaniac.net) target IP address, we can begin
    to scan for open ports on the target by *port scanning*, a process whereby we
    meticulously connect to ports on the remote host to identify those that are active.
    (Obviously, in a larger enterprise, we would have multiple IP ranges and things
    to attack instead of only one IP.)
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用被动信息收集识别了目标IP范围以及[secmaniac.net](http://secmaniac.net)的目标IP地址后，我们可以开始通过*端口扫描*来扫描目标上的开放端口，这是一个我们仔细连接到远程主机上的端口以识别那些活跃端口的流程。（显然，在一个更大的企业中，我们会遇到多个IP范围和攻击目标，而不仅仅是单个IP。）
- en: '*Nmap* is, by far, the most popular port scanning tool. It integrates with
    Metasploit quite elegantly, storing scan output in a database backend for later
    use. *Nmap* lets you scan hosts to identify the services running on each, any
    of which might offer a way in.'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: '*Nmap*无疑是最受欢迎的端口扫描工具。它与Metasploit优雅地集成，将扫描输出存储在数据库后端以供以后使用。*Nmap*允许您扫描主机以识别每个主机上运行的服务，其中任何一个都可能提供进入的方式。'
- en: For this example, let’s leave [secmaniac.net](http://secmaniac.net) behind and
    turn to the virtual machine described in [Appendix A](part0022.html#configuring_your_target_machines),
    with IP address 172.16.32.131\. Before we get started, take a quick look at the
    basic *nmap* syntax by entering **`nmap`** from the command line on your Back|Track
    machine.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，让我们将[secmaniac.net](http://secmaniac.net)放在一边，转向[附录A](part0022.html#configuring_your_target_machines)中描述的虚拟机，其IP地址为172.16.32.131。在我们开始之前，快速查看一下基本*nmap*语法，通过在Back|Track机器的命令行中输入**`nmap`**。
- en: You’ll see immediately that *nmap* has a quite a few options, but you’ll use
    just a few of them for the most part.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 你会立即发现*nmap*有很多选项，但大多数情况下你只会使用其中的一小部分。
- en: One of our preferred *nmap* options is `-sS`. This runs a stealth TCP scan that
    determines whether a specific TCP-based port is open. Another preferred option
    is `-Pn`, which tells *nmap* not to use `ping` to determine whether a system is
    running; instead, it considers all hosts “alive.” If you’re performing Internet-based
    penetration tests, you should use this flag, because most networks don’t allow
    Internet Control Message Protocol (ICMP), which is the protocol that `ping` uses.
    If you’re performing this scan internally, you can probably ignore this flag.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 我们偏爱的 *nmap* 选项之一是 `-sS`。这个选项运行一个隐蔽的 TCP 扫描，以确定特定的 TCP 端口是否开放。另一个偏爱的选项是 `-Pn`，它告诉
    *nmap* 不要使用 `ping` 来确定系统是否运行；相反，它认为所有主机都是“活跃”的。如果你正在执行基于互联网的渗透测试，你应该使用这个标志，因为大多数网络不允许使用
    `ping` 的 Internet 控制消息协议 (ICMP)。如果你在内部执行此扫描，你可能可以忽略这个标志。
- en: Now let’s run a quick *nmap* scan against our Windows XP machine using both
    the `-sS` and `-Pn` flags.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们使用 `-sS` 和 `-Pn` 标志快速对 Windows XP 机器进行 *nmap* 扫描。
- en: '[PRE3]'
  id: totrans-41
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: As you can see, *nmap* reports a list of open ports, along with a description
    of the associated service for each.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，*nmap* 报告了一个开放端口的列表，以及每个相关服务的描述。
- en: 'For more detail, try using the `-A` flag. This option will attempt advanced
    service enumeration and banner grabbing, which may give you even more details
    about the target system. For example, here’s what we’d see if we were to call
    *nmap* with the `-sS` and `-A` flags, using our same target system:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 要获取更多详细信息，请尝试使用 `-A` 标志。此选项将尝试高级服务枚举和标语捕获，这可能为你提供有关目标系统的更多详细信息。例如，如果我们使用 `-sS`
    和 `-A` 标志调用 *nmap*，使用我们相同的目标系统，我们会看到以下内容：
- en: '[PRE4]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Working with Databases in Metasploit
  id: totrans-45
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 在 Metasploit 中使用数据库
- en: When you’re running a complex penetration test with a lot of targets, keeping
    track of everything can be a challenge. Luckily, Metasploit has you covered with
    expansive support for multiple database systems.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 当你运行一个具有许多目标的复杂渗透测试时，跟踪所有内容可能是一个挑战。幸运的是，Metasploit 提供了对多个数据库系统的广泛支持。
- en: To ensure that database support is available for your system, you should first
    decide which database system you want to run. Metasploit supports MySQL and PostgreSQL;
    because PostgreSQL is the default, we’ll stick with it in this discussion.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 为了确保数据库支持适用于您的系统，您应该首先决定您想要运行哪种数据库系统。Metasploit 支持 MySQL 和 PostgreSQL；因为 PostgreSQL
    是默认的，所以我们将在这次讨论中坚持使用它。
- en: First, we start the database subsystem using the built-in Back|Track *init.d*
    scripts.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们使用内置的 Back|Track *init.d* 脚本启动数据库子系统。
- en: '[PRE5]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: After PostgreSQL has started, we tell the Framework to connect to the database
    instance. This connection requires a username, password, name of the host on which
    the database is running, and the database name we want to use. Back|Track’s default
    PostgreSQL username is *postgres* with the password *toor*, but we’ll use *msfbook*
    as the database name. Let’s make the connection.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 在 PostgreSQL 启动后，我们告诉框架连接到数据库实例。此连接需要一个用户名、密码、数据库所在主机的名称以及我们想要使用的数据库名称。Back|Track
    的默认 PostgreSQL 用户名是 *postgres*，密码是 *toor*，但我们将使用 *msfbook* 作为数据库名称。让我们建立连接。
- en: '[PRE6]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: If this were the first time we connected to the database name, we would see
    a lot of text output as Metasploit sets up all the necessary tables. Otherwise,
    the command will return to the `msfconsole` prompt.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 如果这是我们第一次连接到名为数据库的数据库，我们会看到大量的文本输出，因为 Metasploit 正在设置所有必要的表。否则，命令将返回到 `msfconsole`
    提示符。
- en: Metasploit provides a number of commands that we can use to interact with the
    database, as you’ll see throughout this book. (For a complete list, enter **`help`**.)
    For now, we’ll use `db_status` to make sure that we’re connected correctly.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: Metasploit 提供了我们可以用来与数据库交互的许多命令，正如你将在本书的整个过程中看到的那样。（要获取完整列表，请输入 **`help`**。）现在，我们将使用
    `db_status` 来确保我们正确连接。
- en: '[PRE7]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Everything seems to be set up just fine.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 似乎一切设置得都很正常。
- en: Importing Nmap Results into Metasploit
  id: totrans-56
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 将 Nmap 结果导入 Metasploit
- en: When you are working with other team members, with various individuals scanning
    at different times and from different locations, it helps to know how to run *nmap*
    on its own and then import its results into the Framework. Next, we’ll examine
    how to import a basic *nmap*-generated XML export file (generated with *nmap*’s
    `-oX` option) into the Framework.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 当你与其他团队成员一起工作时，他们会在不同的时间和不同的地点进行扫描，了解如何单独运行 *nmap* 并将其结果导入框架很有帮助。接下来，我们将检查如何将基本的
    *nmap*-生成的 XML 导出文件（使用 *nmap* 的 `-oX` 选项生成）导入框架。
- en: 'First, we scan the Windows virtual machine using the `-oX` option to generate
    a *Subnet1.xml* file:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们使用 `-oX` 选项扫描 Windows 虚拟机以生成 *Subnet1.xml* 文件：
- en: '[PRE8]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'After generating the XML file, we use the `db_import` command to import it
    into our database. We can then verify that the import worked by using the `db_hosts`
    command, which lists the systems entries that have been created, as shown here:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 生成 XML 文件后，我们使用 `db_import` 命令将其导入我们的数据库。然后，我们可以通过使用 `db_hosts` 命令来验证导入是否成功，该命令列出了已创建的系统条目，如下所示：
- en: '[PRE9]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: This tells us that we’ve successfully imported the output of our *nmap* scans
    into Metasploit, as evidenced by the IP addresses populated when we run the `db_hosts`
    commands.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 这表明我们已经成功将我们的 *nmap* 扫描输出导入到 Metasploit 中，正如我们在运行 `db_hosts` 命令时填充的 IP 地址所证明的那样。
- en: 'Advanced Nmap Scanning: TCP Idle Scan'
  id: totrans-63
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 高级 Nmap 扫描：TCP 空闲扫描
- en: A more advanced *nmap* scan method, *TCP idle scan*, allows us to scan a target
    stealthily by spoofing the IP address of another host on the network. For this
    type of scan to work, we first need to locate an idle host on the network that
    uses incremental IP IDs (which are used to track packet order). When we discover
    an idle system that uses incremental IP IDs, the IP IDs become predictable, and
    we can then predict the next ID. However, when spoofing the address of an idle
    host while scanning a target’s responses from open ports, we can see a break in
    the predictability of the IP ID sequence, which indicates that we have discovered
    an open port. (To learn more about this module and IP ID sequences, visit [http://www.metasploit.com/modules/auxiliary/scanner/ip/ipidseq/](http://www.metasploit.com/modules/auxiliary/scanner/ip/ipidseq/).)
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 一种更高级的 *nmap* 扫描方法，*TCP 空闲扫描*，允许我们通过在网络中伪造另一个宿主的 IP 地址来秘密地扫描目标。为了使此类扫描工作，我们首先需要在网络中定位一个使用增量
    IP IDs（用于跟踪数据包顺序）的空闲宿主。当我们发现一个使用增量 IP IDs 的空闲系统时，IP IDs 变得可预测，然后我们可以预测下一个 ID。然而，当我们扫描目标从开放端口收到的响应并伪造空闲宿主的地址时，我们可以看到
    IP ID 序列的可预测性中断，这表明我们已经发现了一个开放端口。（要了解更多关于此模块和 IP ID 序列的信息，请访问 [http://www.metasploit.com/modules/auxiliary/scanner/ip/ipidseq/](http://www.metasploit.com/modules/auxiliary/scanner/ip/ipidseq/)。）
- en: 'Use the Framework’s *scanner/ip/ipidseq* module to scan for a host that fits
    the TCP idle scan requirements, as shown next:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 使用框架的 *scanner/ip/ipidseq* 模块来扫描符合 TCP 空闲扫描要求的宿主，如下所示：
- en: '[PRE10]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: This listing displays the required options for the *ipidseq* scan. One notable
    one, `RHOSTS` at ![](../images/00002.gif), can take IP ranges (such as 192.168.1.20–192.168.1.30);
    Classless Inter-Domain Routing (CIDR) ranges (such as 192.168.1.0/24); multiple
    ranges separated by commas (such as 192.168.1.0/24, 192.168.3.0/24); and a text
    file with one host per line (such as *file:/tmp/hostlist.txt*). All these options
    give us quite a bit of flexibility in specifying our targets.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 此列表显示了 *ipidseq* 扫描所需的选项。其中一个值得注意的选项是 `RHOSTS` 在 ![](../images/00002.gif) 处，它可以接受
    IP 范围（例如 192.168.1.20–192.168.1.30）；无类域间路由（CIDR）范围（例如 192.168.1.0/24）；用逗号分隔的多个范围（例如
    192.168.1.0/24, 192.168.3.0/24）；以及每行一个宿主的文本文件（例如 *file:/tmp/hostlist.txt*）。所有这些选项为我们提供了相当大的灵活性来指定我们的目标。
- en: The `THREADS` value at ![](../images/00004.gif) sets the number of concurrent
    threads to use while scanning. By default, all scanner modules have their `THREADS`
    value initially set to 1\. We can raise this value to speed up our scans or lower
    it to reduce network traffic. In general, you should not set the `THREADS` value
    greater 16 when running Metasploit on Windows, and not greater than 128 on UNIX-like
    operating systems.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 在 ![](../images/00004.gif) 处设置的 `THREADS` 值用于在扫描时设置并发线程的数量。默认情况下，所有扫描模块的 `THREADS`
    值最初都设置为 1。我们可以提高此值以加快扫描速度或降低此值以减少网络流量。通常，在 Windows 上运行 Metasploit 时，不应将 `THREADS`
    值设置大于 16，在类 UNIX 操作系统上不应大于 128。
- en: Now let’s set our values and run the module. We’ll set the value for `RHOSTS`
    to 192.168.1.0/24, set `THREADS` to 50, and then run the scan.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们设置我们的值并运行模块。我们将 `RHOSTS` 的值设置为 192.168.1.0/24，将 `THREADS` 设置为 50，然后运行扫描。
- en: '[PRE11]'
  id: totrans-70
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Judging by the results of our scan, we see a number of potential idle hosts
    that we can use to perform idle scanning. We’ll try scanning a host using the
    system at 192.168.1.109 shown at ![](../images/00002.gif) by using the `-sI` command
    line flag to specify the idle host:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 根据我们的扫描结果，我们看到有多个潜在的空闲宿主，我们可以使用它们来执行空闲扫描。我们将尝试使用 `-sI` 命令行标志通过使用 ![](../images/00002.gif)
    中显示的系统 192.168.1.109 来扫描一个宿主：
- en: '[PRE12]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: By using the idle host, we were able to discover a number of open ports on our
    target system without sending a single packet to the system.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 通过使用空闲宿主，我们能够在不向系统发送任何数据包的情况下发现目标系统上的多个开放端口。
- en: Running Nmap from MSFconsole
  id: totrans-74
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 从MSFconsole运行Nmap
- en: 'Now that we’ve performed advanced enumeration on our target, let’s connect
    *nmap* with Metasploit. To do this, we first connect to the *msfbook* database:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经对目标进行了高级枚举，让我们将*nmap*与Metasploit连接起来。为此，我们首先连接到*msfbook*数据库：
- en: '[PRE13]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Now we should be able to enter the `db_nmap` command from within *msfconsole*
    to run *nmap* and have its results automatically stored in our new database.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们应该能够从*msfconsole*中输入`db_nmap`命令来运行*nmap*，并将其结果自动存储在我们的新数据库中。
- en: '* * *'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Note
  id: totrans-79
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: We’ll be attacking only one system in this instance, but you can specify IPs
    by CIDR notation and even ranges (for example, 192.168.1.1/24 or 192.168.1.1–254).
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，我们只攻击一个系统，但您可以使用CIDR表示法指定IP，甚至指定范围（例如，192.168.1.1/24或192.168.1.1–254）。
- en: '* * *'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: '[PRE14]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: Notice a series of open ports ![](../images/00002.gif), software versions ![](../images/00004.gif),
    and even a prediction about the target’s operating system ![](../images/00005.gif).
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 注意一系列开放的端口 ![图片](../images/00002.gif)，软件版本 ![图片](../images/00004.gif)，甚至对目标操作系统的预测
    ![图片](../images/00005.gif)。
- en: 'To check that the results from the scan are stored in the database, we run
    `db_services`:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 为了检查扫描结果是否存储在数据库中，我们运行`db_services`：
- en: '[PRE15]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: We’re beginning to develop a picture of our target and exposed ports for use
    as potential attack vectors.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 我们正在开始构建目标及其暴露的端口，这些端口可能作为潜在的攻击向量。
- en: Port Scanning with Metasploit
  id: totrans-87
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用Metasploit进行端口扫描
- en: In addition to its ability to use third-party scanners, Metasploit has several
    port scanners built into its auxiliary modules that directly integrate with most
    aspects of the Framework. In later chapters, we’ll use these port scanners to
    leverage compromised systems to access and attack; his process, often called *pivoting*,
    allows us to use internally connected systems to route traffic to a network that
    would otherwise be inaccessible.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 除了能够使用第三方扫描器外，Metasploit在其辅助模块中集成了几个端口扫描器，这些扫描器可以直接与框架的大部分功能集成。在后面的章节中，我们将使用这些端口扫描器利用受损害的系统进行访问和攻击；这个过程通常被称为*pivoting*，它允许我们使用内部连接的系统将流量路由到原本无法访问的网络。
- en: For example, suppose you compromise a system behind a firewall that is using
    Network Address Translation (NAT). The system behind the NAT-based firewall uses
    private IP addresses, which you cannot contact directly from the Internet. If
    you use Metasploit to compromise a system behind a NAT, you might be able to use
    that compromised internal system to pass traffic (pivot) to internally hosted
    and private IP-based systems to penetrate the network farther behind the firewall.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，假设您攻破了防火墙后面的系统，该防火墙使用网络地址转换（NAT）。NAT防火墙后面的系统使用私有IP地址，您无法从互联网直接联系到这些地址。如果您使用Metasploit攻破NAT后面的系统，您可能能够使用该受损害的内部系统将流量（pivoting）传递到内部托管和基于私有IP地址的系统，以渗透防火墙后面的更远网络。
- en: 'To see the list of port scanning tools that the Framework offers, enter the
    following:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看框架提供的端口扫描工具列表，请输入以下内容：
- en: '[PRE16]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Let’s conduct a simple scan of a single host using Metasploit’s SYN Port Scanner.
    In the following listing, we start the scan with `use scanner/portscan/syn`, set
    `RHOSTS` to 192.168.1.155, set `THREADS` to 50, and then run the scan.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们使用Metasploit的SYN端口扫描器对单个主机进行简单扫描。在下面的列表中，我们使用`use scanner/portscan/syn`，将`RHOSTS`设置为192.168.1.155，将`THREADS`设置为50，然后运行扫描。
- en: '[PRE17]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: From the results, you can see at ![](../images/00002.gif) that ports 135, 139,
    and 445 are open on IP address 192.168.1.155, leveraging the *portscan syn* module
    within Metasploit.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 从结果中，您可以看到![图片](../images/00002.gif)上的135、139和445端口在IP地址192.168.1.155上开放，利用Metasploit中的*portscan
    syn*模块。
- en: Targeted Scanning
  id: totrans-95
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 有针对性的扫描
- en: When you are conducting a penetration test, there is no shame in looking for
    an easy win. A *targeted scan* looks for specific operating systems, services,
    program versions, or configurations that are known to be exploitable and that
    provide an easy door into a target network. For example, it is common to scan
    a target network quickly for the vulnerability MS08-067, as this is (still) an
    extremely common hole that will give you SYSTEM access much more quickly than
    scanning an entire target network for vulnerabilities.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 在进行渗透测试时，寻找容易的胜利并不丢人。一种*有针对性的扫描*会寻找特定的操作系统、服务、程序版本或配置，这些已知可被利用并提供进入目标网络的便捷途径。例如，快速扫描目标网络以寻找MS08-067漏洞是很常见的，因为这个漏洞（仍然）非常普遍，它将比扫描整个目标网络寻找漏洞更快地为您提供SYSTEM访问权限。
- en: Server Message Block Scanning
  id: totrans-97
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 服务器消息块扫描
- en: Metasploit can scour a network and attempt to identify versions of Microsoft
    Windows using its *smb_version* module.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: Metasploit 可以扫描网络并尝试使用其 *smb_version* 模块识别 Microsoft Windows 的版本。
- en: '* * *'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Note
  id: totrans-100
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If you are not familiar with Server Message Block (SMB, a common file-sharing
    protocol), study up a bit on the different protocols and their purposes before
    you continue. You will need to understand basic port information to learn how
    to attack a system successfully.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你不太熟悉服务器消息块（SMB，一种常见的文件共享协议），在继续之前，请了解一下不同的协议及其用途。你需要了解基本端口信息，才能成功攻击一个系统。
- en: '* * *'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: 'We run the module, list our options, set `RHOSTS`, and begin scanning:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 我们运行模块，列出我们的选项，设置 `RHOSTS`，并开始扫描：
- en: '[PRE18]'
  id: totrans-104
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: As you can see at ![](../images/00002.gif) the `smb_version` scanner has pinpointed
    the operating system as Windows XP with Service Pack 2\. Because we are scanning
    only one system, we leave `THREADS` set to 1\. If we had been scanning a number
    of systems, such as a class C subnet range, we might consider upping the `THREADS`
    using the `set THREADS` *`number`* option. The results of this scan are stored
    in the Metasploit database for use at a later time and to be accessed with the
    `db_hosts` command.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 正如你在 ![](../images/00002.gif) 中可以看到，`smb_version` 扫描器已精确识别操作系统为 Windows XP with
    Service Pack 2。因为我们只扫描一个系统，所以我们保留 `THREADS` 设置为 1。如果我们扫描了多个系统，例如一个 C 类子网范围，我们可能会考虑使用
    `set THREADS` *`number`* 选项来增加 `THREADS`。此扫描的结果存储在 Metasploit 数据库中，以供以后使用，并可以通过
    `db_hosts` 命令访问。
- en: '[PRE19]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: We have discovered a system running Windows XP without having to do a full scan
    of the network. This is a great way to target hosts quickly and quietly that are
    likely to be more vulnerable when our goal is avoid being noticed.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 我们发现了一个运行 Windows XP 的系统，而无需对整个网络进行全扫描。这是一种快速且悄无声息地定位可能在我们试图避免被发现时更易受攻击的主机的方法。
- en: Hunting for Poorly Configured Microsoft SQL Servers
  id: totrans-108
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 寻找配置不当的微软 SQL 服务器
- en: Poorly configured Microsoft SQL Server (MS SQL) installations often provide
    an initial way into a target network. In fact, many system administrators don’t
    even realize that they have MS SQL servers installed on their workstations at
    all, because the service is installed as a prerequisite for some common software,
    such as Microsoft Visual Studio. These installations are often unused, unpatched,
    or never even configured.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 配置不当的微软 SQL 服务器（MS SQL）安装通常为进入目标网络提供了一种初始方式。事实上，许多系统管理员甚至没有意识到他们在工作站上安装了 MS
    SQL 服务器，因为该服务是某些常见软件（如 Microsoft Visual Studio）的先决条件。这些安装通常是未使用的、未打补丁的，或者甚至从未配置过。
- en: 'When MS SQL is installed, it listens by default either on TCP port 1433 or
    on a random dynamic TCP port. If MS SQL is listening on a dynamic port, simply
    query UDP port 1434 to discover on what dynamic TCP port MS SQL is listening.
    Of course, Metasploit has a module that can make use of this “feature”: *mssql_ping*.'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 当 MS SQL 安装时，它默认监听 TCP 端口 1433 或一个随机的动态 TCP 端口。如果 MS SQL 在动态端口上监听，只需查询 UDP 端口
    1434 以发现 MS SQL 正在监听的动态 TCP 端口。当然，Metasploit 有一个可以利用这个“特性”的模块：*mssql_ping*。
- en: Because *mssql_ping* uses UDP, it can be quite slow to run across entire subnets
    because of issues with timeouts. But on a local LAN, setting `THREADS` to 255
    will greatly speed up the scan. As Metasploit finds MS SQL servers, it displays
    all the details it can extract from them including, perhaps most importantly,
    the TCP port on which the server is listening.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 由于 *mssql_ping* 使用 UDP，它可能因为超时问题在整个子网中运行时相当慢。但在本地局域网中，将 `THREADS` 设置为 255 将大大加快扫描速度。当
    Metasploit 发现 MS SQL 服务器时，它会显示从它们提取的所有详细信息，包括，也许最重要的是，服务器正在监听的 TCP 端口。
- en: Here’s how you might run an *mssql_ping* scan, which includes starting the scan,
    listing and setting options, and the results.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 这是你可能运行的 *mssql_ping* 扫描的方式，包括启动扫描、列出和设置选项，以及结果。
- en: '[PRE20]'
  id: totrans-113
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: As you can see, not only does the scanner locate a MS SQL server at ![](../images/00002.gif),
    but it also identifies the instance name at ![](../images/00004.gif), the SQL
    server version at ![](../images/00005.gif), and the TCP port number at ![](../images/00006.gif)
    on which it is listening. Just think of how much time this targeted scan for SQL
    servers would save over running *nmap* against all ports on all machines in a
    target subnet in search of the elusive TCP port.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，扫描器不仅定位到一个 MS SQL 服务器在 ![](../images/00002.gif)，而且还识别出实例名称在 ![](../images/00004.gif)，SQL
    服务器版本在 ![](../images/00005.gif)，以及它正在监听的 TCP 端口号在 ![](../images/00006.gif)。想想看，这种针对
    SQL 服务器的有针对性的扫描将节省多少时间，而不是在目标子网中的所有机器的所有端口上运行 *nmap* 来寻找难以捉摸的 TCP 端口。
- en: SSH Server Scanning
  id: totrans-115
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: SSH 服务器扫描
- en: If during your scanning you encounter machines running Secure Shell (SSH), you
    should determine which version is running on the target. SSH is a secure protocol,
    but vulnerabilities in various implementations have been identified. You never
    know when you might get lucky and come across an old machine that hasn’t been
    updated. You can use the Framework’s *ssh_version* module to determine the SSH
    version running on the target server.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在扫描过程中遇到运行Secure Shell (SSH)的机器，你应该确定目标上运行的是哪个版本。SSH是一个安全的协议，但各种实现中的漏洞已经被发现。你永远不知道何时可能会幸运地遇到一个尚未更新的旧机器。你可以使用Framework的*ssh_version*模块来确定目标服务器上运行的SSH版本。
- en: '[PRE21]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: This output tells us that a few different servers are running with various patch
    levels. This information could prove useful if, for example, we wanted to attack
    a specific version of OpenSSH as found with the *ssh_version* scan.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 这个输出告诉我们，几个不同的服务器正在以不同的补丁级别运行。如果，例如，我们想要攻击通过*ssh_version*扫描找到的特定版本的OpenSSH，那么这些信息可能会非常有用。
- en: FTP Scanning
  id: totrans-119
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: FTP扫描
- en: FTP is a complicated and insecure protocol. FTP servers are often the easiest
    way into a target network, and you should always scan for, identify, and fingerprint
    any FTP servers running on your target.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: FTP是一个复杂且不安全的协议。FTP服务器通常是进入目标网络的 easiest way，你应该始终扫描、识别和指纹任何运行在目标上的FTP服务器。
- en: 'Next, we scan our XP box for FTP services using the Framework’s *ftp_version*
    module:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们使用Framework的*ftp_version*模块扫描我们的XP盒子上的FTP服务：
- en: '[PRE22]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: The scanner successfully identifies an FTP server at ![](../images/00002.gif).
    Now let’s see if this FTP server allows anonymous logins using the Framework’s
    *scanner/ftp/anonymous*.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 扫描器在![图片](../images/00002.gif)成功识别了一个FTP服务器。现在让我们看看这个FTP服务器是否允许使用Framework的*scanner/ftp/anonymous*模块进行匿名登录。
- en: '[PRE23]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: The scanner reports at ![](../images/00002.gif) that anonymous access is allowed
    and that anonymous users have both read and write access to the server; in other
    words, we have full access to the remote system and the ability to upload or download
    any file that can be accessed by the FTP server software.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 扫描器报告在![图片](../images/00002.gif)中，匿名访问被允许，并且匿名用户对服务器具有读写访问权限；换句话说，我们有权访问远程系统，并能够上传或下载FTP服务器软件可以访问的任何文件。
- en: Simple Network Management Protocol Sweeping
  id: totrans-126
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 简单网络管理协议扫描
- en: The Simple Network Management Protocol (SNMP) is typically used in network devices
    to report information such as bandwidth utilization, collision rates, and other
    information. However, some operating systems also have SNMP servers that can provide
    information such as CPU utilization, free memory, and other system-specific details.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 简单网络管理协议（SNMP）通常用于网络设备，以报告有关带宽利用率、冲突率和其他信息。然而，一些操作系统也有SNMP服务器，可以提供有关CPU利用率、空闲内存和其他系统特定细节的信息。
- en: Convenience for the system administrator can be a gold mine for the penetration
    tester, and accessible SNMP servers can offer considerable information about a
    specific system or even make it possible to compromise a remote device. If, for
    instance, you can get the read/write SNMP community string for a Cisco router,
    you can download the router’s entire configuration, modify it, and upload it back
    to the router.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 对于系统管理员来说，便利性可能是渗透测试人员的金矿，可访问的SNMP服务器可以提供有关特定系统的大量信息，甚至可能使远程设备受到损害。例如，如果你可以获取Cisco路由器的读写SNMP社区字符串，你可以下载路由器的整个配置，修改它，并将其上传回路由器。
- en: The Metasploit Framework includes a built-in auxiliary module called *scanner/snmp/snmp_enum*
    that is designed specifically for SNMP sweeps. Before you start the scan, keep
    in mind that the read-only (RO) and read/write (RW) community strings will play
    an important role in the type of information you will be able to extract from
    a given device. On Windows-based devices configured with SNMP, you can often use
    the RO or RW community strings to extract patch levels, running services, usernames,
    uptime, routes, and other information that can make things much easier for you
    during a pen test. (*Community strings* are essentially passwords used to query
    a device for information or to write configuration information to the device.)
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: Metasploit Framework包括一个内置的辅助模块，称为*scanner/snmp/snmp_enum*，专门用于SNMP扫描。在开始扫描之前，请记住，只读（RO）和读写（RW）社区字符串将在你能够从给定设备提取的信息类型中扮演重要角色。在配置了SNMP的基于Windows的设备上，你通常可以使用RO或RW社区字符串提取补丁级别、运行的服务、用户名、运行时间、路由和其他信息，这些信息可以在渗透测试期间使事情变得容易得多。（*社区字符串*基本上是用于查询设备以获取信息或将配置信息写入设备的密码。）
- en: After you guess the community strings, SNMP itself (depending on the version)
    can allow anything from excessive information disclosure to full system compromise.
    SNMPv1 and v2 are inherently flawed protocols. SNMPv3, which incorporates encryption
    and better check mechanisms, is significantly more secure. To gain access to a
    switch, you’ll first need to attempt to find its community strings. The Framework’s
    *use scanner/snmp/snmp_login* module will try a word list against one or a range
    of IP addresses.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 在猜出社区字符串后，SNMP 本身（取决于版本）可能允许从过度信息泄露到完全系统妥协的各种情况。SNMPv1 和 v2 是固有的有缺陷的协议。集成了加密和更好的检查机制的
    SNMPv3 显著更安全。要访问交换机，你首先需要尝试找到其社区字符串。框架的 `use scanner/snmp/snmp_login` 模块将尝试一个单词列表针对一个或一系列
    IP 地址。
- en: '[PRE24]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: A quick Google search for *GSM7224* from the output tells us that the scanner
    has found both the public ![](../images/00002.gif) and private ![](../images/00004.gif)
    community strings for a Netgear switch. This result, believe it or not, has not
    been staged for this book. These are the default factory settings for this switch.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 从输出中快速搜索 *GSM7224* 可以告诉我们，该扫描器已找到 Netgear 交换机的公共 ![](../images/00002.gif) 和私有
    ![](../images/00004.gif) 社区字符串。信不信由你，这个结果并不是为这本书准备的。这是该交换机的默认出厂设置。
- en: You will encounter many jaw-dropping situations like these throughout your pen
    testing career, because many administrators simply attach devices to a network
    with all their defaults still in place. The situation is even scarier when you
    find these devices accessible from the Internet within a large corporation.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 在你的渗透测试生涯中，你将遇到许多令人瞠目结舌的情况，因为许多管理员只是将设备连接到网络，所有默认设置仍然保持原样。当你发现在一个大公司内这些设备可以从互联网访问时，情况甚至更加可怕。
- en: Writing a Custom Scanner
  id: totrans-134
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 编写自定义扫描器
- en: Many applications and services lack custom modules in Metasploit. Thankfully,
    the Framework has many features that can be useful when you’re building a custom
    scanner, including offering access to all of its exploit classes and methods,
    and support for proxies, Secure Sockets Layer (SSL), reporting, and threading.
    It can be very useful to write your own scanner during security assessments, because
    doing so will allow you to locate every instance of a bad password or unpatched
    service quickly on a target system.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 许多应用程序和服务在 Metasploit 中缺少自定义模块。幸运的是，该框架具有许多在构建自定义扫描器时可能很有用的功能，包括提供对其所有漏洞类和方法的无限制访问，以及支持代理、安全套接字层（SSL）、报告和线程。在安全评估期间编写自己的扫描器非常有用，因为这样做将允许你快速在目标系统上定位到每个不良密码或未打补丁服务的实例。
- en: The Metasploit Framework scanner modules include various mixins, such as exploit
    mixins for TCP, SMB, and so on, and the auxiliary `scanner` mixin that is built
    into the Framework. *Mixins* are portions of code with predefined functions and
    calls that are preconfigured for you. The `Auxiliary::Scanner` mixin overloads
    the Auxiliary `run` method; calls the module method at runtime with `run_host(ip)`,
    `run_range(range)`, or `run_batch(batch)`; and then processes the IP addresses.
    We can leverage `Auxiliary::Scanner` to call additional, built-in Metasploit functionality.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: Metasploit 框架的扫描器模块包括各种混合模块，例如 TCP、SMB 等的漏洞混合模块，以及内置在框架中的辅助 `scanner` 混合模块。"混合模块"
    是具有预定义函数和调用的代码片段，这些函数和调用已经为您预先配置。`Auxiliary::Scanner` 混合模块重载了辅助 `run` 方法；在运行时通过
    `run_host(ip)`、`run_range(range)` 或 `run_batch(batch)` 调用模块方法；然后处理 IP 地址。我们可以利用
    `Auxiliary::Scanner` 来调用额外的内置 Metasploit 功能。
- en: Following is a Ruby script for a simple TCP scanner that will connect to a remote
    host on a default port of 12345 and upon connecting, send “HELLO SERVER,” receive
    the server response, and print it out along with the server’s IP address.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 下面是一个简单的 TCP 扫描器的 Ruby 脚本，它将连接到默认端口 12345 的远程主机，连接后发送“HELLO SERVER”，接收服务器响应，并将其打印出来，同时打印服务器的
    IP 地址。
- en: '[PRE25]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: This simple scanner uses the `Msf::Exploit::Remote::Tcp` ![](../images/00002.gif)
    mixin to handle the TCP networking, and the `Msf::Auxiliary::Scanner` mixin exposes
    the various settings that are required for scanners within the Framework ![](../images/00004.gif).
    This scanner is configured to use the default port of 12345 ![](../images/00005.gif),
    and upon connecting to the server, it sends a message ![](../images/00006.gif),
    receives the reply from the server, and then prints it out to the screen along
    with the server IP address ![](../images/00007.gif).
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 这个简单的扫描器使用 `Msf::Exploit::Remote::Tcp` ![](../images/00002.gif) 混合来处理 TCP 网络连接，而
    `Msf::Auxiliary::Scanner` 混合则公开了框架内扫描器所需的各项设置！[](../images/00004.gif)。这个扫描器配置为使用默认端口
    12345！[](../images/00005.gif)，连接到服务器后，它会发送一条消息！[](../images/00006.gif)，接收来自服务器的回复，并将其连同服务器
    IP 地址一起打印到屏幕上！[](../images/00007.gif)。
- en: We have saved this custom script under *modules/auxiliary/scanner/* as *simple_tcp.rb*.
    The saved location is important in Metasploit. For example, if the module is saved
    under *modules/auxiliary/scanner/http/*, it would show up in the modules list
    as *scanner/http/simple_tcp*.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经将这个自定义脚本保存在 *modules/auxiliary/scanner/* 目录下，命名为 *simple_tcp.rb*。在 Metasploit
    中，保存位置很重要。例如，如果模块保存在 *modules/auxiliary/scanner/http/* 目录下，它将在模块列表中显示为 *scanner/http/simple_tcp*。
- en: To test this rudimentary scanner, we set up a *netcat* listener on port 12345
    and pipe in a text file to act as the server response.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 为了测试这个基本的扫描器，我们在端口 12345 上设置了一个 *netcat* 监听器，并将一个文本文件管道输入作为服务器响应。
- en: '[PRE26]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: Next, we load up *msfconsole*, select our scanner module, set its parameters,
    and run it to see if it works.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们加载 *msfconsole*，选择我们的扫描模块，设置其参数，然后运行它以查看它是否工作。
- en: '[PRE27]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: Although this is only a simple example, the level of versatility afforded by
    the Metasploit Framework can be of great assistance when you need to get some
    custom code up and running quickly in the middle of a pen test. Hopefully, this
    simple example demonstrates the power of the Framework and modular code. But,
    of course, you don’t have to do everything by hand.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然这只是一个简单的例子，但 Metasploit 框架提供的多功能性在需要快速在渗透测试过程中运行一些自定义代码时非常有帮助。希望这个简单的例子展示了框架和模块化代码的力量。但当然，你不必事事亲力亲为。
- en: Looking Ahead
  id: totrans-146
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 展望未来
- en: In this chapter, you learned how to leverage the Metasploit Framework for intelligence
    gathering, as outlined in the PTES. Intelligence gathering takes practice and
    requires a deep understanding of how an organization operates and how to identify
    the best potential attack vectors. As with anything, you should adapt and improve
    your own methodologies throughout your penetration-testing career. Just remember
    that your main focus for this phase is to learn about the organization you’re
    attacking and its overall footprint. Regardless of whether your work occurs over
    the Internet, on an internal network, wirelessly, or via social engineering, the
    goals of intelligence gathering will always be the same.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你学习了如何利用 Metasploit 框架进行情报收集，正如 PTES 中概述的那样。情报收集需要实践，并需要对组织运作方式和如何识别最佳潜在攻击向量有深入的理解。与任何事物一样，你应该在整个渗透测试生涯中不断调整和改进自己的方法。但请记住，这个阶段的主要焦点是了解你攻击的组织及其整体足迹。无论你的工作是在互联网上、内部网络、无线或有社交工程，情报收集的目标始终相同。
- en: 'In the next chapter, we’ll move on to another important step during the vulnerability
    analysis phase: automated vulnerability scanning. In later chapters, we will explore
    more in-depth examples of how to create your own modules, exploits, and Meterpreter
    scripts.'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将继续到漏洞分析阶段的一个重要步骤：自动化漏洞扫描。在后面的章节中，我们将更深入地探讨如何创建自己的模块、漏洞利用和 Meterpreter
    脚本的示例。
