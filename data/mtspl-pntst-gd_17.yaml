- en: Chapter 17. Simulated Penetration Test
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第17章 模拟渗透测试
- en: Penetration testing is the pinnacle for most of us, and successfully bypassing
    an organization’s defenses during a penetration test is one of our most rewarding
    experiences. In this chapter, we’ll pull together what you’ve learned in previous
    chapters as we simulate a complete penetration test. You will be re-creating steps
    that you’ve seen in previous chapters, so most of what is shown here should be
    familiar.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 渗透测试对我们大多数人来说都是顶峰，在渗透测试中成功绕过组织的防御是我们最令人满意的经验之一。在本章中，我们将结合你在前几章中学到的内容，模拟一个完整的渗透测试。你将重新创建你在前几章中看到的步骤，所以这里展示的大部分内容应该都很熟悉。
- en: Before you begin, download and install Metasploit’s vulnerable Linux virtual
    machine called *Metasploitable*. (You can find it at [http://www.thepiratebay.org/torrent/5573179/Metasploitable/](http://www.thepiratebay.org/torrent/5573179/Metasploitable/).)
    Metasploitable was created to train individuals to use Metasploit for successful
    exploitation. Follow the directions on the site to install Metasploitable, and
    then power it on. We’ll be running the Metasploitable virtual machine alongside
    the Windows XP system [to simulate a small networked](http://www.exploit-db.com/exploits/5720/)
    environment, with one virtual machine acting as an Internet-facing system and
    another acting as an internal network host.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在开始之前，下载并安装Metasploit的易受攻击的Linux虚拟机，名为*Metasploitable*。（你可以在[http://www.thepiratebay.org/torrent/5573179/Metasploitable/](http://www.thepiratebay.org/torrent/5573179/Metasploitable/)找到它。）Metasploitable是为了训练个人使用Metasploit进行成功的利用而创建的。按照网站上的说明安装Metasploitable，然后启动它。我们将同时运行Metasploitable虚拟机和Windows
    XP系统，以模拟一个小型网络环境，一个虚拟机作为面向互联网的系统，另一个作为内部网络主机。[http://www.exploit-db.com/exploits/5720/](http://www.exploit-db.com/exploits/5720/)。
- en: '* * *'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Note
  id: totrans-4
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: The simulated penetration test in this chapter is a small one. You would do
    something more in-depth if your target were a large corporation. We’ve kept this
    simple to make it easy for you to replicate.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 本章中的模拟渗透测试是一个小型的。如果你的目标是大型企业，你会做更深入的事情。我们保持简单，以便你能够轻松复制。
- en: '* * *'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Pre-engagement Interactions
  id: totrans-7
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 预参与互动
- en: Planning is the first step in pre-engagement. During a true planning phase,
    we would identify our target(s) and our primary method of planned attack, which
    might include social engineering, wireless, Internet, or internal attack vectors.
    Unlike an actual penetration test, here we will not be targeting a specific organization
    or a group of systems; we will perform a simulation using our known virtual machine.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 计划是预参与的第一步。在真正的计划阶段，我们会确定我们的目标以及我们计划攻击的主要方法，这可能包括社会工程学、无线、互联网或内部攻击向量。与实际的渗透测试不同，在这里我们不会针对特定的组织或一组系统；我们将使用我们已知的虚拟机进行模拟。
- en: For the purposes of this simulation, our target will be the protected Metasploitable
    virtual machine at IP address 172.16.32.162 (to configure Metasploitable, use
    the username and password of *msfadmin*). The Metasploitable target is a machine
    attached to an internal network, protected by a firewall, and *not* directly connected
    to the Internet. Our Windows XP machine is behind the firewall (turn on Windows
    Firewall) with only port 80 open at IP address 172.16.32.131.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 为了本次模拟的目的，我们的目标将是位于IP地址172.16.32.162的保护性Metasploitable虚拟机（要配置Metasploitable，请使用用户名和密码*msfadmin*）。Metasploitable目标是一个连接到内部网络的机器，由防火墙保护，并且*没有*直接连接到互联网。我们的Windows
    XP机器位于防火墙后面（开启Windows防火墙），只在IP地址172.16.32.131上开放端口80。
- en: Intelligence Gathering
  id: totrans-10
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 情报收集
- en: The next step, intelligence gathering, is one of the most important phases in
    the process, because if you miss something here you might miss an entire avenue
    of attack. Our goal at this point is to understand what we are going to attack
    and determine how we might gain access to the system.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 下一步，情报收集，是整个过程中最重要的阶段之一，因为如果你在这里遗漏了什么，你可能会错过整个攻击途径。我们现在的目标是了解我们将要攻击什么，以及我们如何可能获得对系统的访问权限。
- en: We begin with a basic *nmap* scan (as shown next) against our Windows XP virtual
    machine, and we find that port 80 is open. We use *nmap*’s stealth TCP scan, which
    is typically effective in detecting ports without triggering defenses. Most IPSs
    can detect port scans, but because port scans are so common, they are generally
    considered regular noise and are ignored as long as they’re not very aggressive.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 我们开始对Windows XP虚拟机进行基本的*nmap*扫描（如下所示），我们发现80端口是开放的。我们使用*nmap*的隐蔽TCP扫描，这通常在检测端口时不会触发防御。大多数IPS可以检测端口扫描，但由于端口扫描非常普遍，它们通常被视为常规噪音，并且只要它们不是非常激进，就会被忽略。
- en: '[PRE0]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: We discover what appears to be a web server running on this server. This is
    typical when attacking Internet-facing systems, most of which will limit the ports
    accessible by Internet users. In this example, we find port 80, the standard HTTP
    port, listening. If we browse to it, we see something similar to [Figure 17-1](part0021.html#a_web_application_was_identified).
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 我们发现似乎有一个Web服务器运行在这个服务器上。在攻击面向互联网的系统时，这是很典型的，大多数系统都会限制互联网用户可访问的端口。在这个例子中，我们发现80端口，即标准的HTTP端口正在监听。如果我们浏览到它，我们会看到类似于[图17-1](part0021.html#a_web_application_was_identified)的内容。
- en: '![A web application was identified.](../images/00060.jpeg)Figure 17-1. A web
    application was identified.'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: '![识别了一个Web应用程序。](../images/00060.jpeg)图17-1. 识别了一个Web应用程序。'
- en: Threat Modeling
  id: totrans-16
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 威胁建模
- en: Having identified port 80 as open, we could enumerate any available additional
    systems, but we’re interested only in the single target. Let’s move on to threat
    modeling and attempt to identify the best route into this system.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 确定端口80已开放后，我们可以枚举任何可用的其他系统，但我们只对单个目标感兴趣。让我们继续进行威胁建模，并尝试确定进入该系统的最佳途径。
- en: The web page we found gives us a chance to enter input in User and Password
    fields. At this point, you, as a penetration tester, should think outside the
    box and try to determine what the best avenue is going to be. When you’re performing
    application security penetration tests, consider using tools other than Metasploit,
    such as the Burp Suite ([http://www.portswigger.net/](http://www.portswigger.net/))
    when appropriate; don’t feel locked into a single tool set. In the following example,
    we’ll attempt a manual attack by entering ‘TEST (notice the leading single quote)
    into the username field and a single quote in the password field. Prior to submitting
    the form, our username and password fields should look like those in [Figure 17-2](part0021.html#attempting_to_leverage_sql_injection).
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 我们找到的网页给了我们在用户名和密码字段中输入输入的机会。在这个时候，作为渗透测试员，你应该跳出思维定式，尝试确定最佳途径。当你执行应用程序安全渗透测试时，考虑使用除Metasploit之外的工具，例如在适当的时候使用Burp
    Suite ([http://www.portswigger.net/](http://www.portswigger.net/))；不要觉得被锁定在单一的工具集中。在下面的例子中，我们将通过在用户名字段中输入‘TEST’（注意前面的单引号）和在密码字段中输入一个单引号来尝试手动攻击。在提交表单之前，我们的用户名和密码字段应该看起来像[图17-2](part0021.html#attempting_to_leverage_sql_injection)中的那样。
- en: '![Attempting to leverage SQL injection](../images/00061.jpeg)Figure 17-2. Attempting
    to leverage SQL injection'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: '![尝试利用SQL注入](../images/00061.jpeg)图17-2. 尝试利用SQL注入'
- en: Take a moment to consider what is occurring on the backend when the server receives
    this input. Here we simply tried to start a new SQL statement and appended some
    bogus data to it. You probably won’t find many web applications in the wild that
    are as easy to attack as this one, but this makes for a good example — and it
    was not too long ago that these sorts of errors were in fact being discovered
    all the time. When we click the Submit button, we get the error message shown
    in [Figure 17-3](part0021.html#error_message_colon_sql_injection_is_pre).
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 请花一点时间考虑当服务器接收到这个输入时后端发生了什么。在这里，我们只是尝试启动一个新的SQL语句，并向其中附加了一些虚假数据。你可能不会在野外发现很多像这样容易攻击的Web应用程序，但这是一个很好的例子——而且这些类型的错误实际上并不是很久以前才被发现。当我们点击提交按钮时，我们会得到[图17-3](part0021.html#error_message_colon_sql_injection_is_pre)中显示的错误信息。
- en: This error message indicates that a SQL injection flaw is present based on the
    SQL exception and the “Incorrect syntax near” message shows that the *‘TEST* input
    caused it. With a quick Google search, we can determine that the backend database
    is Microsoft SQL, purely based on the error messages that were presented.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 这个错误信息表明存在SQL注入漏洞，这是基于SQL异常和“语法错误在”消息显示*‘TEST*输入引起的。通过快速谷歌搜索，我们可以确定后端数据库是Microsoft
    SQL，纯粹基于显示的错误信息。
- en: We won’t go into how to perform SQL injection on web applications here, but
    you can easily manipulate the input parameters to attack a given system and completely
    compromise it. (This was covered briefly in [Chapter 11](part0015.html#fast-track).)
    Notice that we still haven’t actually attacked a system yet; we’ve simply tried
    to identify a viable attack vector in the system. Now that we know we can potentially
    compromise this system, it’s time to move on to the exploitation phase.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 我们在这里不会详细介绍如何在 Web 应用程序上执行 SQL 注入，但你可以轻松地操纵输入参数来攻击给定的系统并完全利用它。（这已在 [第 11 章](part0015.html#fast-track)
    中简要介绍。）请注意，我们实际上还没有攻击任何系统；我们只是试图识别系统中的一个可行攻击向量。现在我们知道我们可以潜在地利用这个系统，是时候进入利用阶段了。
- en: '![Error message: SQL injection is present.](../images/00062.jpeg)Figure 17-3. Error
    message: SQL injection is present.'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: '![错误信息：存在 SQL 注入。](../images/00062.jpeg)图 17-3. 错误信息：存在 SQL 注入。'
- en: Exploitation
  id: totrans-24
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 利用
- en: When we looked for vulnerabilities in the web application, we found a viable
    attack vector via SQL injection. In this instance, Fast-Track is our best option
    for compromising the MS SQL server and gaining access to our target through Meterpreter,
    because, as you’ll recall from [Chapter 11](part0015.html#fast-track), it attacks
    Microsoft SQL–based injection vulnerabilities with ease.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们在 Web 应用程序中寻找漏洞时，我们发现了一个可行的攻击向量，即 SQL 注入。在这种情况下，Fast-Track 是我们攻击 MS SQL 服务器并通过
    Meterpreter 访问目标的最佳选择，因为，正如你从 [第 11 章](part0015.html#fast-track) 中回忆的那样，它轻松攻击基于
    Microsoft SQL 的注入漏洞。
- en: After we have a Meterpreter console, we’ll look at how to gain access to the
    Metasploitable system on the internal network.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们获得 Meterpreter 控制台后，我们将探讨如何访问内部网络上的 Metasploitable 系统。
- en: Customizing MSFconsole
  id: totrans-27
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 自定义 MSFconsole
- en: We’ll use SQLPwnage to deploy the Meterpreter console via SQL injection on the
    target to gain administrative access to its backend database. Recall from [Chapter 11](part0015.html#fast-track)
    that SQLPwnage is an automated way of attacking MS SQL–based injection flaws,
    and it uses multiple methods of attack in an attempt to fully compromise the SQL
    server via the `xp_cmdshell` stored procedure.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用 SQLPwnage 通过 SQL 注入在目标上部署 Meterpreter 控制台，以获取对其后端数据库的管理访问权限。回想一下 [第 11
    章](part0015.html#fast-track)，SQLPwnage 是一种攻击基于 MS SQL 的注入漏洞的自动化方法，它通过 `xp_cmdshell`
    存储过程使用多种攻击方法尝试完全利用 SQL 服务器。
- en: Before launching the attack, we need to set up some options through *msfconsole*.
    For practice, let’s create our own Metasploit listener manually. Fast-Track can
    set it up for you, but we will be adding the `load auto_add_route` ![](../images/00002.gif)
    function within Metasploit so that we can automatically connect to systems on
    the internal network. We’ll create a listener and launch Fast-Track to attack
    the system.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 在发起攻击之前，我们需要通过 *msfconsole* 设置一些选项。为了练习，让我们手动创建自己的 Metasploit 监听器。Fast-Track
    可以为你设置它，但我们将向 Metasploit 中添加 `load auto_add_route` ![](../images/00002.gif) 函数，以便我们可以自动连接到内部网络上的系统。我们将创建一个监听器并启动
    Fast-Track 来攻击系统。
- en: '[PRE1]'
  id: totrans-30
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: With our listener waiting for a connection from our soon-to-be compromised target,
    we launch Fast-Track. (When the *xterm* window opens, close it since we already
    have a listener set up.)
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的监听器等待即将被利用的目标的连接时，我们启动 Fast-Track。（当 *xterm* 窗口打开时，请关闭它，因为我们已经设置了监听器。）
- en: '[PRE2]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: This should look familiar. We’ve essentially attacked the web application through
    Fast-Track and exploited it via SQL injection attacks. We used the `xp_cmdshell`
    stored procedure and the binary-to-hex conversion technique to present a full-fledged
    Meterpreter shell.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 这应该看起来很熟悉。我们本质上是通过 Fast-Track 攻击了 Web 应用程序，并通过 SQL 注入攻击来利用它。我们使用了 `xp_cmdshell`
    存储过程和二进制到十六进制的转换技术来展示一个完整的 Meterpreter shell。
- en: Post Exploitation
  id: totrans-34
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 后渗透
- en: At this point, we should have a Meterpreter console running in the background
    within *msfconsole*, so we can begin to scan the target’s subnet for other live
    systems. To do this, we’ll upload *nmap* to the target and run it from the Windows
    machine.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们应该在 *msfconsole* 背景中运行一个 Meterpreter 控制台，这样我们就可以开始扫描目标子网中的其他活动系统。为此，我们将
    *nmap* 上传到目标并从 Windows 机器上运行它。
- en: First, download *nmap* from [insecure.org](http://insecure.org) in an executable
    format and save it locally. We’ll be uploading this to our target. Next, we’ll
    connect to the target via Microsoft’s Remote Desktop Protocol (RDP), a built-in
    graphical remote administration protocol that lets you interact with the Windows
    Desktop as if you were sitting in front of the remote machine. After we’re connected
    with our Meterpreter session, we’ll use the *getgui* Meterpreter script to tunnel
    RDP back out to us over port 8080 and add a new administrative user to the system.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，从 [insecure.org](http://insecure.org) 下载 *nmap* 的可执行格式并保存到本地。我们将将其上传到我们的目标。接下来，我们将通过微软的远程桌面协议
    (RDP) 连接到目标，这是一个内置的图形远程管理协议，允许你像坐在远程机器前一样与 Windows 桌面交互。在我们通过 Meterpreter 会话连接后，我们将使用
    *getgui* Meterpreter 脚本将 RDP 通过端口 8080 隧道回传给我们，并为系统添加一个新的管理员用户。
- en: We enter **rdesktop localhost:8080** from Back|Track’s command line, so we can
    log into the system with the newly created user account. We then use Meterpreter
    to upload *nmap* to the target. Our goal is to install *nmap* on the compromised
    Windows target and use the system as a staging ground for further attacks. Conversely
    you could use *scanner/portscan/syn* and *scanner/portscan/tcp* to port scan directly
    through Metasploit. The choice is a matter of personal preference and needs.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 我们从 Back|Track 的命令行输入 **rdesktop localhost:8080**，以便使用新创建的用户账户登录系统。然后我们使用 Meterpreter
    将 *nmap* 上传到目标。我们的目标是安装 *nmap* 到被攻陷的 Windows 目标上，并使用该系统作为进一步攻击的跳板。相反，你也可以使用 *scanner/portscan/syn*
    和 *scanner/portscan/tcp* 通过 Metasploit 直接进行端口扫描。选择取决于个人偏好和需求。
- en: '[PRE3]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: We now have our launching pad for additional attacks. With *nmap* installed
    on the target, we are essentially sitting on the internal network. We can now
    attempt to enumerate internally connected systems and further penetrate the network.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们有了额外的攻击的跳板。在目标上安装了 *nmap* 后，我们实际上就坐在了内部网络上。我们现在可以尝试枚举内部连接的系统并进一步渗透网络。
- en: Scanning the Metasploitable System
  id: totrans-40
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 扫描 Metasploitable 系统
- en: With our Meterpreter session granting us access to the internal network via
    the `load auto_add_route` command, we can scan and exploit the inside hosts using
    the compromised Windows XP target as the launching point. We’re effectively connected
    to the internal network, so we should be able to reach our Metasploitable system.
    Let’s begin with a basic port scan.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 通过我们的 Meterpreter 会话，通过 `load auto_add_route` 命令获得了对内部网络的访问权限，我们可以使用被攻陷的 Windows
    XP 目标作为启动点来扫描和利用内部主机。我们实际上已经连接到了内部网络，因此我们应该能够到达我们的 Metasploitable 系统。让我们从基本的端口扫描开始。
- en: '[PRE4]'
  id: totrans-42
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Here we see a series of open ports. Based on *nmap*’s OS detection we see that
    the scanned system is a UNIX/Linux variant of some sort. Some of these ports should
    jump out at you, such as FTP, Telnet, HTTP, SSH, Samba, MySQL, PostgreSQL, and
    Apache.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里我们看到一系列开放的端口。根据 *nmap* 的操作系统检测，我们看到扫描的系统是某种 UNIX/Linux 变体。其中一些端口可能会引起你的注意，例如
    FTP、Telnet、HTTP、SSH、Samba、MySQL、PostgreSQL 和 Apache。
- en: Identifying Vulnerable Services
  id: totrans-44
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 识别易受攻击的服务
- en: Because a few ports look interesting, we’ll start banner-grabbing each one to
    try to find a way into the system.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 由于一些端口看起来很有趣，我们将开始抓取每个端口的标志信息，以尝试找到进入系统的方法。
- en: '[PRE5]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Exiting the system, we know now that ProFTPD 1.3.1 is running on port 21\.
    Next we use SSH to learn more about the target. (The addition of the `-v` flag
    gives us verbose output.) The next listing tells us that our target is running
    an older version of OpenSSH, specifically written for Ubuntu:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 退出系统后，我们知道 ProFTPD 1.3.1 正在端口 21 上运行。接下来我们使用 SSH 来获取更多关于目标的信息。（添加 `-v` 标志会提供详细输出。）下一个列表告诉我们我们的目标正在运行一个较旧的
    OpenSSH 版本，专门为 Ubuntu 编写：
- en: '[PRE6]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Now we issue the following to determine the version of Ubuntu running on this
    system:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们发出以下命令以确定该系统上运行的 Ubuntu 版本：
- en: '[PRE7]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Great! We know that the system is running Ubuntu 8.04 and that two unencrypted
    protocols (telnet and FTP) are in use that might come into play later.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 太好了！我们知道该系统正在运行 Ubuntu 8.04，并且有两个未加密的协议（telnet 和 FTP）正在使用，这些可能在以后发挥作用。
- en: Now let’s look at SMTP to see what version our target is running. Remember that
    we are trying to identify the running versions of the services operating on the
    various remote systems.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们看看 SMTP，看看我们的目标正在运行哪个版本。记住，我们正在尝试识别在各个远程系统上运行的服务版本。
- en: '[PRE8]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: As you can see, the Postfix mail server appears to be running on the Metasploitable
    server.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，Postfix 邮件服务器似乎正在 Metasploitable 服务器上运行。
- en: This process is continued through all the different ports that have been discovered
    as listening on our target. The various auxiliary modules are very useful for
    this work. When you’re finished, you should have a list of the versions of software
    running on the system, information that you will use when targeting attacks.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 这个过程会继续到所有已发现的目标端口。各种辅助模块对此工作非常有用。当你完成时，你应该有一个系统上运行的软件版本的列表，这些信息将在攻击目标时使用。
- en: Attacking Apache Tomcat
  id: totrans-56
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 攻击Apache Tomcat
- en: Now we enter the attack phase again, where we start to get our hands dirty.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们再次进入攻击阶段，开始动手操作。
- en: In the course of our research, we noticed a plethora of vulnerabilities on this
    system, including direct exploits and brute force possibilities. Now, if we were
    performing an overt penetration test, we could run vulnerability scanners against
    the system to find most openings for us, but that would take all the fun out of
    it! Let’s attack Apache instead.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的研究过程中，我们注意到这个系统存在大量的漏洞，包括直接利用和暴力破解的可能性。现在，如果我们进行公开的渗透测试，我们可以对系统运行漏洞扫描器以找到大多数开放端口，但这会失去很多乐趣！让我们来攻击Apache吧。
- en: 'We notice that Apache Tomcat is installed on port 8180, as shown in our earlier
    port scans. After a bit of Internet research, we learn that Tomcat is vulnerable
    to a management interface brute force attack. (In most cases, we can use *exploit-db*
    or Google to identify potential vulnerabilities in a given service.) After some
    more research on the operating version number of the Apache Tomcat installation
    running on the target, the Tomcat manager seemed the best route for compromising
    the system. If we can get through Tomcat’s manager function, we can use the HTTP
    `PUT` method to deploy our payload on the vulnerable system. We launch the attack
    as follows (with the list of exploits and payloads snipped):'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 我们注意到Apache Tomcat安装在8180端口，如我们之前的端口扫描所示。经过一番互联网研究，我们了解到Tomcat容易受到管理接口暴力破解攻击。（在大多数情况下，我们可以使用*exploit-db*或Google来识别特定服务中的潜在漏洞。）在进一步研究目标上运行的Apache
    Tomcat安装的操作系统版本后，Tomcat管理器似乎是最容易攻破系统的途径。如果我们能通过Tomcat的管理功能，我们可以使用HTTP `PUT`方法在易受攻击的系统上部署我们的有效载荷。我们按照以下方式发起攻击（省略了漏洞利用和有效载荷列表）：
- en: '[PRE9]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Our brute force attack is successful, and it logs in with the username *tomcat*
    and password *tomcat*. But we don’t yet have a shell.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的暴力破解攻击成功，并以用户名*tomcat*和密码*tomcat*登录。但我们还没有shell。
- en: With our newly discovered credentials, we leverage Apache’s HTTP `PUT` functionality
    with the *multi/http/tomcat_mgr_deploy* exploit to place our payload on the system
    using the valid username and password that we discovered by brute-forcing the
    login.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 利用我们新发现的凭证，我们利用Apache的HTTP `PUT`功能以及*multi/http/tomcat_mgr_deploy*漏洞来将我们的有效载荷放置在系统上，这些有效载荷是通过暴力破解登录我们发现的用户名和密码。
- en: '[PRE10]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Notice that we cannot write to the root folder, because we’re running from a
    limited user account and this folder requires root-level permissions. Usually,
    Apache runs under the Apache user account, which is sometimes *apache* but which
    can also be *httpd*, *www-data*, among other names. Based on what we know about
    the operating system version in use on the target, we could use local privilege
    escalation techniques to gain further access as root. Because we already have
    some basic access, let’s try a couple of different attacks.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，我们无法写入根目录，因为我们是从受限用户账户运行的，而这个文件夹需要root级别的权限。通常，Apache是在Apache用户账户下运行的，有时是*apache*，但也可以是*httpd*、*www-data*等名称。根据我们对目标操作系统版本的了解，我们可以使用本地提权技术以root身份获得进一步访问。因为我们已经有一些基本的访问权限，让我们尝试几种不同的攻击方法。
- en: '* * *'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Note
  id: totrans-66
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 备注
- en: 'Here’s a little hint in obtaining root access to Metasploitable, without privilege
    escalation: Check out [http://www.exploit-db.com/exploits/5720/](http://www.exploit-db.com/exploits/5720/)
    for the SSH predictable PRNG exploit.'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 这里有一个小提示，如何在不需要提权的情况下获得Metasploitable的root访问权限：查看[http://www.exploit-db.com/exploits/5720/](http://www.exploit-db.com/exploits/5720/)中的SSH可预测PRNG漏洞利用。
- en: '* * *'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Attacking Obscure Services
  id: totrans-69
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 攻击未知服务
- en: When we performed only the default *nmap* port scan, we did not include all
    possible ports. Because we have now gained initial access to the system, we enter
    **`netstat -antp`**, and we notice other ports that *nmap* did not scan for when
    performing the attack. (Remember that in a penetration test we can’t always rely
    on the defaults to be successful.)
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们只进行了默认的*nmap*端口扫描时，我们没有包括所有可能的端口。因为我们现在已经获得了对系统的初始访问权限，我们输入**`netstat -antp`**，并注意到在攻击时*nmap*没有扫描的其他端口。（记住，在渗透测试中，我们并不总是可以依赖默认设置来成功。）
- en: Our scan finds that port 3632 is open and associated with *DistCC*. An online
    search tells us that *DistCC* is a program that distributes builds of C/C++ code
    to several machines across a network, and it is vulnerable to an attack. (When
    performing penetration tests, you will often encounter unfamiliar applications
    and products, and you will need to research the application before you can attack
    it.)
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的扫描发现端口3632是开放的，与*DistCC*相关联。在线搜索告诉我们，*DistCC*是一个将C/C++代码的构建版本分发到网络中多个机器上的程序，并且它容易受到攻击。（在进行渗透测试时，你经常会遇到不熟悉的应用程序和产品，在攻击之前你需要研究该应用程序。）
- en: '[PRE11]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Notice above that we are still not at root. A local privilege exploit will further
    compromise the system and give full root access. We won’t tell you the answer
    here; use what you’ve learned in this book to gain root privileges successfully
    on the Metasploitable system. One hint is that you can find the exploit at Exploits
    Database ([http://www.exploit-db.com/](http://www.exploit-db.com/)). Try getting
    a root Linux/Meterpreter shell on the system on your own.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，我们仍然没有获得root权限。本地权限利用将进一步破坏系统并提供完整的root访问权限。我们不会在这里告诉你答案；使用你在本书中学到的知识，在Metasploitable系统上成功获得root权限。一个提示是，你可以在Exploits
    Database（[http://www.exploit-db.com/](http://www.exploit-db.com/)）找到利用代码。尝试在系统上自己获得root
    Linux/Meterpreter shell。
- en: Covering Your Tracks
  id: totrans-74
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 掩盖你的行踪
- en: Having completed our attacks, our next step is to return to each exploited system
    to erase our tracks and clean up any mess we’ve left behind. Remnants of a Meterpreter
    shell or some other pieces of malware should be removed to avoid exposing the
    system further. For example, when we used the `PUT` command to compromise the
    Apache Tomcat instance, an attacker could use the exploit code left behind to
    compromise the system.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 完成我们的攻击后，我们的下一步是返回到每个被利用的系统，擦除我们的行踪并清理我们留下的任何混乱。应该移除Meterpreter shell或其他恶意软件的残留部分，以避免进一步暴露系统。例如，当我们使用`PUT`命令破坏Apache
    Tomcat实例时，攻击者可以使用留下的利用代码来破坏系统。
- en: Sometimes, you will need to cover your tracks — for example, when testing the
    forensics analysis of a compromised system or an incident response program. In
    such cases, your goal is to thwart any forensics analysis or IDS. It’s often difficult
    to hide all your tracks, but you should be able to manipulate the system to confuse
    the examiner and make it almost impossible to identify the extent of the attack.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 有时候，你需要掩盖你的行踪——例如，在测试被破坏的系统或事件响应程序的法医分析时。在这种情况下，你的目标是阻止任何法医分析或入侵检测系统。隐藏所有行踪通常很困难，但你应该能够操纵系统，使检查员困惑，并使其几乎不可能确定攻击的范围。
- en: In most cases, when forensics analysis is performed, if you can mangle the system
    so that it renders the majority of the examiner’s work almost unreadable and inconclusive,
    he will most likely identify the system as having been infected or compromised
    and might not understand how much information you were able to extract from the
    system. The best way to thwart forensic analysis is to wipe the system completely
    and rebuild it, removing all traces, but this is rare during a penetration test.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 在大多数情况下，当进行法医分析时，如果你能破坏系统，使其大部分内容几乎无法阅读和得出结论，他最有可能将系统识别为已感染或被破坏，并且可能无法理解你从系统中提取了多少信息。阻止法医分析的最佳方法是完全擦除系统并重新构建，移除所有痕迹，但在渗透测试期间这种情况很少发生。
- en: One benefit discussed in a number of chapters is the ability for Meterpreter
    to reside purely in memory. Often, you’ll find it challenging to detect and react
    to Meterpreter in memory space. Although research often suggests ways to detect
    a Meterpreter payload, the Metasploit crew typically responds with a new way to
    hide Meterpreter.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 在许多章节中讨论的一个好处是Meterpreter可以完全驻留在内存中。通常，你会发现检测和反应内存中的Meterpreter具有挑战性。尽管研究经常提出检测Meterpreter有效载荷的方法，但Metasploit团队通常会以新的方法来隐藏Meterpreter。
- en: This is the same cat-and-mouse game that antivirus software vendors play with
    new releases of Meterpreter. When a new encoder or method for obfuscating a payload
    is released, vendors can take several months to detect the issues and update their
    product signatures to catch them. In most cases, it’s relatively difficult for
    most forensics analysts to identify a purely memory-resident attack vector from
    Metasploit.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 这与防病毒软件供应商在 Meterpreter 新版本中玩的老鼠捉猫的游戏是一样的。当一个新的编码器或用于混淆有效载荷的方法发布时，供应商可能需要几个月的时间来检测问题并更新他们的产品签名来捕获它们。在大多数情况下，对于大多数取证分析师来说，从
    Metasploit 识别一个纯内存驻留的攻击向量相对困难。
- en: 'We won’t offer in-depth information about covering your tracks, but a couple
    of Metasploit features are worth mentioning: *timestomp* and *event_manager*.
    *Timestomp* is a Meterpreter plug-in that allows you to modify, erase, or set
    certain attributes on files. Let’s run *timestomp* first:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 我们不会提供关于掩盖行踪的深入信息，但有几个 Metasploit 功能值得提及：*timestomp* 和 *event_manager*。*Timestomp*
    是一个 Meterpreter 插件，允许您修改、擦除或设置文件上的某些属性。让我们先运行 *timestomp*：
- en: '[PRE12]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: In this example, we changed the timestamp so that when Encase (a popular forensics
    analysis tool) is used, the timestamps are blank.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，我们更改了时间戳，以便当使用 Encase（一个流行的取证分析工具）时，时间戳为空白。
- en: 'The tool *event_manager* will modify event logs so that they don’t show any
    information that might reveal that an attack occurred. Here it is in action:'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 工具 *event_manager* 将修改事件日志，以便它们不会显示任何可能揭示攻击发生的信息。以下是其实际操作：
- en: '[PRE13]'
  id: totrans-84
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: In this example, we clear all the event logs, but the examiner might notice
    other interesting things on the system that could alert him to an attack. In general
    though, the examiner will not be able to piece together the puzzle to identify
    what happened during the attack, but he will know that something bad had occurred.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，我们清除了所有的事件日志，但检查员可能会注意到系统上的其他有趣的事情，这可能会使他意识到攻击。但总的来说，检查员将无法拼凑出谜题来识别攻击期间发生的事情，但他会知道确实发生了不好的事情。
- en: Remember to document your changes to a target system to make it easier to cover
    your tracks. Usually, you’ll leave a small sliver of information on the system,
    so you might as well make it extremely difficult for the incident response and
    forensics analysis team to find it.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 记得记录你对目标系统的更改，以便更容易掩盖行踪。通常，你会在系统上留下少量信息，所以不妨让它对事件响应和取证分析团队来说极其难以找到。
- en: Wrapping Up
  id: totrans-87
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 总结
- en: Having gotten this far, we could continue to attack other machines on the internal
    network using Metasploit and Meterpreter, with our attacks limited only by our
    creativity and ability. If this were a larger network, we could further penetrate
    the network using information gathered from various systems on the network.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们可以继续使用 Metasploit 和 Meterpreter 攻击内部网络上的其他机器，我们的攻击仅受我们的创造力和能力限制。如果这是一个更大的网络，我们可以利用从网络上的各种系统中收集到的信息进一步渗透网络。
- en: For example, earlier in this chapter we compromised a Windows-based system.
    We could use the Meterpreter console to extract the hash values from that system
    and then use those credentials to authenticate to other Windows-based systems.
    The local administrator account is almost always the same from one system to another,
    so even in a corporate environment, we could use the information from one system
    to bridge attacks to another.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，在本章的早期，我们攻陷了一个基于 Windows 的系统。我们可以使用 Meterpreter 控制台从该系统提取哈希值，然后使用这些凭据对其他基于
    Windows 的系统进行身份验证。本地管理员账户几乎总是从一个系统到另一个系统相同，因此即使在企业环境中，我们也可以使用一个系统的信息来在攻击之间建立桥梁。
- en: Penetration testing requires you to think outside the box and combine pieces
    of a puzzle. We used one method during this chapter, but there are probably several
    different ways to get into the systems and different avenues of attack you can
    leverage. This all comes with experience and spending the time to become creative.
    Persistence is key to penetration testing.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 渗透测试需要你跳出思维定式，并组合拼图的不同部分。我们在本章中使用了一种方法，但可能还有几种不同的方法可以进入系统，以及你可以利用的不同攻击途径。这一切都来自于经验，以及花时间变得有创造性。坚持不懈是渗透测试的关键。
- en: Remember to establish a fundamental set of methodologies you are comfortable
    with, but change them as necessary. Often, penetration testers change their methodologies
    at least once per test to stay fresh. Changes might include a new way of attacking
    a system or use of a new method. Regardless of the method you choose, remember
    that you can accomplish anything in this field with a bit of experience and hard
    work.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 记住要建立一个你感到舒适的根本方法论，但在必要时进行改变。通常，渗透测试员会至少在每个测试中改变一次他们的方法论以保持新鲜感。改变可能包括一种新的攻击系统的方式或使用新的方法。无论你选择哪种方法，记住，只要有一点经验和努力工作，你在这个领域就能完成任何事情。
