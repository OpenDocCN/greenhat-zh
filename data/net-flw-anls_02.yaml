- en: Chapter 2. COLLECTORS AND SENSORS
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第二章。收集器和传感器
- en: '![image with no caption](httpatomoreillycomsourcenostarchimages651574.png.jpg)'
  id: totrans-1
  prefs: []
  type: TYPE_IMG
  zh: '![无标题图片](httpatomoreillycomsourcenostarchimages651574.png.jpg)'
- en: The collector and sensors are the irreplaceable components of any flow system.
    Why? You can analyze data in innumerable ways, but before you do, you must gather
    and store the data, and you do that with sensors and the collector.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 收集器和传感器是任何流系统不可替代的组件。为什么？你可以以无数种方式分析数据，但在你这样做之前，你必须收集和存储数据，而这是通过传感器和收集器来完成的。
- en: Because these pieces of your flow system are so critical, you'll begin your
    implementation with the collector and proceed to the first sensor.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 由于这些流系统组件至关重要，你将从收集器开始实施，然后进行到第一个传感器。
- en: Collector Considerations
  id: totrans-4
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 收集器注意事项
- en: The *collector* is the host that receives records from network equipment and
    is where you'll perform most of your work. You must practice good systems administration
    on your collector, but you have a lot of flexibility on your hardware, operating
    system, and software.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: '**收集器**是接收来自网络设备记录的主机，你将在那里进行大部分工作。你必须对你的收集器进行良好的系统管理，但在硬件、操作系统和软件方面你有很大的灵活性。'
- en: Operating System
  id: totrans-6
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 操作系统
- en: The collector runs on a Unix-like operating system. Almost any modern Unix-like
    operating system will suffice. I recommend a BSD operating system. (If you've
    never worked with BSD, permit me to suggest you buy one of my BSD books, such
    as *Absolute FreeBSD* or *Absolute OpenBSD*.)
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 收集器运行在类Unix操作系统上。几乎任何现代类Unix操作系统都足够使用。我推荐使用BSD操作系统。（如果你从未使用过BSD，请允许我建议你购买我的BSD书籍之一，例如《Absolute
    FreeBSD》或《Absolute OpenBSD》。）
- en: That said, Linux, OpenSolaris, or any standard 32-bit or 64-bit Unix-like system
    with a recent GCC compiler and libraries will work just fine. The more unusual
    your operating system, however, the more trouble you will have with your collector
    and reporting system. Some commercial Unix-like operating systems are noted for
    behavior that technically complies with the standards but differs from every other
    Unix-like operating system in bizarre or downright unspeakable ways.^([[3](#ftn.CHP-2-FN-1)])
    Pick something known for playing well with others.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 话虽如此，Linux、OpenSolaris或任何具有最新GCC编译器和库的标准32位或64位类Unix系统都可以正常工作。然而，如果你的操作系统不太常见，你将面临更多关于收集器和报告系统的问题。一些商业类Unix操作系统因其符合技术标准但与所有其他类Unix操作系统在奇怪或根本无法言喻的方式上有所不同而闻名。[^[[3](#ftn.CHP-2-FN-1)]]
    选择一个与其他系统兼容性好的系统。
- en: Whichever system you choose, it must be secure. Every active Unix-like operating
    system has a current security and hardening guide. Get it. Read it. Use it. Your
    collector should provide no other services except for those related to flow management.
    This will let you harden the system much more than a multipurpose machine permits.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 无论你选择哪个系统，它都必须是安全的。每个活跃的类Unix操作系统都有当前的安全和加固指南。获取它。阅读它。使用它。你的收集器不应提供除与流管理相关的其他服务。这将让你比多用途机器更能加固系统。
- en: System Resources
  id: totrans-10
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 系统资源
- en: Flow collection uses very few system resources other than disk space. (I've
    run flow collectors on Pentium Pro servers.)
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 流收集器除了磁盘空间外，使用的系统资源非常少。（我曾在奔腾Pro服务器上运行过流收集器。）
- en: The amount of disk space needed depends on the type of traffic on your network
    and how long you want to retain your records. In my environment, a data flow averaging
    5Mbps uses about 2GB of disk a month. Today, disk capacity expands faster than
    network utilization. I've found that it's possible to retain all data for the
    indefinite future if you keep buying larger disks.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 需要的磁盘空间取决于你网络上的流量类型以及你希望保留记录的时间长度。在我的环境中，平均5Mbps的数据流每月大约使用2GB的磁盘空间。今天，磁盘容量增长速度超过了网络利用率。我发现，如果你继续购买更大的硬盘，你有可能无限期地保留所有数据。
- en: Additional memory and CPU resources will accelerate flow reporting. When provisioning
    a machine for flow collection, I suggest using a slower but larger hard drive
    (like one of the "green" drives) and adding memory. The slower hard drive will
    save you money and power, and additional memory will improve the system's buffer
    cache and let you analyze data more quickly.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 额外的内存和CPU资源将加速流报告。当为流收集器配置机器时，我建议使用较慢但容量更大的硬盘（如“绿色”硬盘之一）并增加内存。较慢的硬盘可以节省你的金钱和电力，额外的内存将提高系统的缓冲区缓存，并让你更快地分析数据。
- en: Get at least 4GB or more of RAM for your collector. Any modern Unix-like OS
    caches recently accessed disk files in RAM. Large amounts of memory will accelerate
    running multiple reports on the same data more than anything else.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 为你的收集器至少配备4GB或更多的RAM。任何现代类Unix操作系统都会在RAM中缓存最近访问的磁盘文件。大量的内存将比其他任何东西都能加速在同一数据上运行多个报告。
- en: '* * *'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[3](#CHP-2-FN-1)]) I would name names, but IBM has better lawyers than I
    do.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[3](#CHP-2-FN-1)]) 我本想点名道姓，但IBM的律师比我强。
- en: Sensor Considerations
  id: totrans-17
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 传感器考虑因素
- en: The sensor is the device or program that captures flow data from your network
    and forwards it to the collector. Flow sensors are perhaps the most difficult
    portion of a flow-based management system to implement, especially on a geographically
    large network. You don't want to drive across the continent just to install a
    flow sensor!
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 传感器是捕获你的网络流量数据并将其转发到收集器的设备或程序。流量传感器可能是基于流量的管理系统中最难实施的部分，尤其是在地理上大的网络中。你不想为了安装一个流量传感器而穿越整个大陆！
- en: The good news is, you don't need to worry about making those road trips. In
    fact, you probably already have flow sensors installed that you just haven't configured
    yet. Do you have Internet border routers? Have them act as sensors. Got a high-end
    Cisco switch? Great, use that.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 好消息是，你不必担心那些长途旅行。事实上，你可能已经安装了流量传感器，但你还没有配置它们。你有互联网边界路由器吗？让它们充当传感器。你有一个高端的Cisco交换机吗？太好了，就用那个。
- en: If you don't have hardware that can do the job, you can implement a flow sensor
    in software.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你没有能够完成这项工作的硬件，你可以在软件中实现流量传感器。
- en: Location
  id: totrans-21
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 位置
- en: If you have even a medium-sized network, you'll quickly realize that you need
    to be selective about your sensor locations. Perhaps you have a couple dozen small
    switches and a hefty central core switch at your headquarters, half a dozen DMZs,
    an Internet border, and several remote facilities connected via VPN or MPLS. You
    could conceivably have sensors at each of these locations. Which are worth the
    effort?
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你有一个中等大小的网络，你很快就会意识到你需要对传感器位置进行选择。也许你在总部有几个小型交换机和一台大型核心交换机，半打DMZ，一个互联网边界，以及几个通过VPN或MPLS连接的远程设施。你可以在这些位置中的每一个都安装传感器。哪些是值得努力的？
- en: Internet Border
  id: totrans-23
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 互联网边界
- en: Start with your Internet border. Almost all modern commercial-grade routers
    can export flow records. Analyzing those flows will tell you how you're using
    your Internet access. Knowing how much of your traffic is web surfing versus how
    much of your traffic is accessing your VPN will immediately help you make better
    decisions.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 从你的互联网边界开始。几乎所有的现代商用级路由器都可以导出流量记录。分析这些流量将告诉你如何使用你的互联网接入。了解你的流量中有多少是网页浏览，有多少是访问VPN，将立即帮助你做出更好的决策。
- en: Ethernet Core
  id: totrans-25
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 以太网核心
- en: Look at your network's Ethernet core next. The internal LAN will have much more
    traffic than the wide-area Internet connection. Analyzing flow data from your
    internal network will quickly expose problems, misconfigurations, and performance
    issues. Your network architecture dictates sensor placement.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来看看你的网络的以太网核心。内部局域网将比广域互联网连接有更多的流量。分析内部网络的流量数据将迅速暴露问题、配置错误和性能问题。你的网络架构决定了传感器的放置。
- en: If you have a single large core switch, such as a Cisco 4000 or 7000, the switch
    itself can probably export flow information.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你有一个大型核心交换机，例如Cisco 4000或7000，交换机本身可能可以导出流量信息。
- en: If you have multiple switches in your Ethernet core, you might think you need
    flow export on every one of them, but that's overly ambitious. You do not need
    a complete record of every last packet that passes through every switch on your
    office network.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你以太网核心中有多个交换机，你可能认为需要在每个上都进行流量导出，但这过于雄心勃勃。你不需要记录办公室网络中每个交换机上通过的每个数据包的完整记录。
- en: 'When considering where to capture data, think about how traffic flows from
    device to device, and configure flow export only from central "choke" points.
    For example, my main data center has a configuration common in large enterprises:
    a large Cisco switch at its core and client switches in wiring closets on each
    floor. Every closet switch and every server is attached directly to the core switch.
    Any traffic that leaves a local switch must pass through the core switch.'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 在考虑数据捕获位置时，考虑流量如何从设备流向设备，并仅从中央“瓶颈”配置流量导出。例如，我的主要数据中心有一个在大型企业中常见的配置：一个大型Cisco交换机在其核心，以及每层的布线间中的客户端交换机。每个布线间的交换机和每台服务器都直接连接到核心交换机。任何离开本地交换机的流量都必须通过核心交换机。
- en: I collect flow data only from the central switch. This means that I'm blind
    to any traffic that remains entirely on a closet switch, but I capture all client
    broadcast traffic and anything that goes to servers or leaves the network. Even
    if a client uses a printer attached to the local switch, the print job traverses
    the print server attached to the core switch. One single flow export point offers
    adequate visibility into the entire network.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 我只从中心交换机收集流量数据。这意味着我对完全留在机柜交换机上的任何流量都视而不见，但我捕获了所有客户端广播流量以及任何发送到服务器或离开网络的流量。即使客户端使用连接到本地交换机的打印机，打印作业也会穿越连接到核心交换机的打印服务器。一个单独的流量导出点足以提供对整个网络的充分可见性。
- en: If your Ethernet core is only one or two small switches and none of the switches
    can export flow information, you can still implement flow-based network management
    if one of the switches has a "sniffer" or "monitor" port. One of the switches
    is effectively the network core. If you haven't designated a particular switch
    as the core, use the switch that serves the highest number of servers. Attach
    a software flow sensor to the monitor port (see [Configuring Software Flow Sensors](ch02s10.html
    "Configuring Software Flow Sensors") in [Configuring Software Flow Sensors](ch02s10.html
    "Configuring Software Flow Sensors")).
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的以太网核心只有一个或两个小交换机，并且没有任何交换机可以导出流量信息，如果你中的一个交换机有一个“嗅探器”或“监控”端口，你仍然可以实施基于流量的网络管理。其中一个交换机实际上是网络核心。如果你还没有指定一个特定的交换机作为核心，请使用服务服务器数量最多的交换机。将软件流量传感器连接到监控端口（参见[配置软件流量传感器](ch02s10.html
    "配置软件流量传感器")，在[配置软件流量传感器](ch02s10.html "配置软件流量传感器")中）。
- en: From Remote Facilities
  id: totrans-32
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 来自远程设施
- en: Apply similar reasoning to remote facilities. Each remote facility has at least
    one router connecting it to the global network. It might be connected to an MPLS
    cloud or the Internet, but it's still your link into the outside world. Capture
    flows from that device.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 将类似的推理应用于远程设施。每个远程设施至少有一个路由器连接到全球网络。它可能连接到MPLS云或互联网，但它仍然是连接到外部世界的一个链接。捕获该设备的流量。
- en: If a remote facility has a export-capable core switch, use it as well. If the
    site reports many problems and the central switch cannot export flows, consider
    implementing a software sensor or upgrading the core switch.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 如果远程设施有一个具有导出功能的中心交换机，也可以使用它。如果该地点报告了许多问题，中心交换机无法导出流量，考虑实施软件传感器或升级中心交换机。
- en: Have remote sites export their flows to your central collector. Maintaining
    multiple collectors increases your workload with very little gain.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 让远程站点将它们的流量导出到你的中心收集器。维护多个收集器会增加你的工作量，但收益却微乎其微。
- en: From Private Network Segments/DMZs
  id: totrans-36
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 来自私有网络段/DMZ
- en: Tracking flows from your core network, and your Internet border provides insight
    into your entire network, including servers on isolated or private network segments
    such as DMZs. You can see the traffic DMZ servers exchange with your core network
    and the Internet. What you cannot see is the traffic among DMZ servers.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 跟踪核心网络和互联网边界的流量，可以深入了解整个网络，包括DMZ等隔离或私有网络段上的服务器。你可以看到DMZ服务器与核心网络和互联网之间的流量。但你无法看到DMZ服务器之间的流量。
- en: If you have only one or two servers on a DMZ, you probably don't need flow export
    on that network segment. If you have several servers, you'll want flow export.
    You don't need to decide right away, however. Fine-tune your flow management installation
    on your core and border networks, and then implement flow export on your DMZs.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你只有一个或两个服务器在DMZ中，你可能不需要在该网络段上配置流量导出。如果你有多个服务器，你将需要流量导出。然而，你不必立即做出决定。首先微调你的核心和边界网络上的流量管理安装，然后在你DMZ上实施流量导出。
- en: Implementing the Collector
  id: totrans-39
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 实施收集器
- en: Enough theory, enough planning. Let's install something!
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 理论已经足够，计划也已经足够。让我们安装一些东西吧！
- en: An Internet search reveals any number of freely available flow collectors. The
    big three are cflowd, flowd, and flow-tools. Cflowd is obsolete, is unsupported,
    and doesn't compile on 64-bit systems. I have high hopes for flowd, but it's a
    comparatively new tool and doesn't yet have broad support among users or third-party
    software. That leaves us with flow-tools, the most commonly used flow management
    tool kit.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 网络搜索可以找到许多免费可用的流量收集器。其中最大的三个是cflowd、flowd和flow-tools。Cflowd已经过时，不受支持，且在64位系统上无法编译。我对flowd抱有很高的期望，但这是一个相对较新的工具，用户或第三方软件的支持还不够广泛。这就留下了flow-tools，这是最常用的流量管理工具包。
- en: Flow-tools is older but has a very broad user community. The original author
    (Mark Fullmer) released version 0.68 in 2005 and went on to other projects. Any
    unmaintained software slowly becomes obsolete, but a group of users assumed responsibility
    for flow-tools in 2007\. These users collect improvements and bug fixes, and they
    release updated versions as needed. Although you'll still find occasional bugs,
    as with any software, flow-tools has a broad base of users.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: Flow-tools 较旧，但拥有一个非常广泛的用户群体。原始作者（Mark Fullmer）于 2005 年发布了版本 0.68，并继续进行其他项目。任何未维护的软件都会逐渐过时，但一群用户在
    2007 年承担了 flow-tools 的责任。这些用户收集改进和错误修复，并在需要时发布更新版本。尽管您仍然会偶尔发现错误，就像任何软件一样，flow-tools
    拥有广泛的用户基础。
- en: Note
  id: totrans-43
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Do not use version 0.68 of flow-tools. It has many small problems and does not
    function correctly on 64-bit systems. (It seems to work on 64-bit systems, but
    actually corrupts data, which is even worse than completely failing to work!)
    Take the time to install the newer version, 0.68.5 as of this writing.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 不要使用 flow-tools 的 0.68 版本。它存在许多小问题，并且在 64 位系统上无法正确运行。（它似乎在 64 位系统上运行，但实际上会损坏数据，这甚至比完全无法运行还要糟糕！）花时间安装较新版本，即写作时的
    0.68.5。
- en: Installing Flow-tools
  id: totrans-45
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 安装 Flow-tools
- en: You can install flow-tools from an operating system package or from source.
    Before installing it, visit the flow-tools website at [http://code.google.com/p/flow-tools/](http://code.google.com/p/flow-tools/)
    to download the most recent version.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以从操作系统软件包或从源代码安装 flow-tools。在安装之前，访问 flow-tools 网站 [http://code.google.com/p/flow-tools/](http://code.google.com/p/flow-tools/)
    下载最新版本。
- en: Installing from Packages
  id: totrans-47
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 从软件包安装
- en: Most Unix-like operating systems offer prepackaged versions of freely available
    software. If you can use precompiled, prepackaged software, do so.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数类 Unix 操作系统提供免费软件的预包装版本。如果您可以使用预编译的预包装软件，请这样做。
- en: However, many operating systems include only flow-tools version 0.68 rather
    than the newer version with its the bug fixes. Some operating systems, such as
    FreeBSD, include the newer software as a package called *flow-tools-ng*.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，许多操作系统只包含 flow-tools 版本 0.68，而不是包含错误修复的新版本。一些操作系统，如 FreeBSD，将较新的软件作为名为 *flow-tools-ng*
    的软件包提供。
- en: Fine details in the flow-tools package names are important. For example, flow-tools
    was recently at version 0.68.4\. A search for a CentOS flow-tools RPM revealed
    version 0.68-4, which is actually revision 4 of flow-tools package 0.68\. At first
    glance, this might look like the correct package, but it's not.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: flow-tools 软件包名称中的详细细节很重要。例如，flow-tools 最近是版本 0.68.4。对 CentOS flow-tools RPM
    的搜索揭示了版本 0.68-4，这实际上是 flow-tools 软件包 0.68 的第 4 次修订。乍一看，这可能看起来像是正确的软件包，但实际上并不是。
- en: By the time this book reaches print, ideally major OS vendors will provide an
    updated package. If not, you get to install from source.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 当这本书印刷时，理想情况下，主要操作系统供应商将提供更新后的软件包。如果没有，您需要从源代码安装。
- en: Installing from Source
  id: totrans-52
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 从源代码安装
- en: To install the latest version of flow-tools from source, download the source
    code from [http://code.google.com/p/flow-tools/](http://code.google.com/p/flow-tools/),
    and extract it. You'll need GNU `make` and GCC, as well as the libraries and header
    files for your operating system.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 要从源代码安装 flow-tools 的最新版本，请从 [http://code.google.com/p/flow-tools/](http://code.google.com/p/flow-tools/)
    下载源代码，并提取它。您需要 GNU `make` 和 GCC，以及您操作系统的库和头文件。
- en: '[PRE0]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Now go into the *flow-tools* directory, and read the *INSTALL* file for the
    current compiling instructions. The process probably includes the steps `configure`,
    `make`, and `make install`.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 现在进入 *flow-tools* 目录，阅读 *INSTALL* 文件以获取当前的编译说明。该过程可能包括 `configure`、`make` 和
    `make install` 等步骤。
- en: Before installing, run **`./configure —help`** to list the build and installation
    options. The option I find most useful when installing is `prefix`, which allows
    you to specify where you want the software installed.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 在安装之前，运行 **`./configure —help`** 以列出构建和安装选项。我在安装时发现最有用的选项是 `prefix`，它允许您指定您希望软件安装的位置。
- en: Most Unix-like operating systems install prepackaged software in */usr/local/bin*,
    */usr/local/sbin*, and so on. When you build a package such as flow-tools from
    source, however, your installation is not tightly integrated with the system's
    package management system. I suggest installing it in a location not used by the
    rest of the system because you don't want an operating system update to overwrite
    part of flow-tools or, worse, revert it to the obsolete version shipped with your
    OS! (Don't forget to update your PATH and MANPATH environment variables to include
    your new directories.)
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数类 Unix 操作系统在 */usr/local/bin*、*/usr/local/sbin* 等位置安装预包装软件。然而，当你从源代码构建像 flow-tools
    这样的软件包时，你的安装并没有与系统的包管理系统集成。我建议将其安装在系统其他部分不使用的位置，因为你不希望操作系统更新覆盖 flow-tools 的一部分，或者更糟糕的是，将其回滚到操作系统附带的老旧版本！（别忘了更新你的
    PATH 和 MANPATH 环境变量以包括你的新目录。）
- en: In the following example, you'll install flow-tools under */usr/local/flow*.
    I'll use this directory for the examples throughout this book.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下示例中，你将在 */usr/local/flow* 下安装 flow-tools。我将在整本书的示例中使用这个目录。
- en: '[PRE1]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: If your system is missing any prerequisites, the installation process will produce
    an error after the first command. After a successful install, you will find commands
    under */usr/local/flow/bin*, manual pages under */usr/local/flow/share/man*, and
    so on.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的系统缺少任何先决条件，安装过程将在第一个命令后产生错误。安装成功后，你将在 */usr/local/flow/bin* 下找到命令，在 */usr/local/flow/share/man*
    下找到手册页等等。
- en: DON'T CLEAN UP
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 不要清理
- en: Do not run make clean after building flow-tools from source. I find that I occasionally
    need to return to the source code for troubleshooting.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 在从源代码构建 flow-tools 后，不要运行 make clean。我发现我偶尔需要回到源代码中进行故障排除。
- en: Running flow-capture
  id: totrans-63
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 运行 flow-capture
- en: 'The `flow-capture` program listens on a specified UDP port for incoming flow
    exports. It then captures the data and writes flow records to disk. `flow-capture`
    must know where to write the files, how often to start a new file, who to accept
    flow information from, and so on. The `flow-capture` manual page offers many options,
    but the following example suffices for many situations:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: '`flow-capture` 程序监听指定的 UDP 端口以接收流量导出。然后它捕获数据并将流量记录写入磁盘。`flow-capture` 必须知道在哪里写入文件，多久启动一个新文件，以及从哪里接受流量信息等等。`flow-capture`
    的手册页提供了许多选项，但以下示例对于许多情况就足够了：'
- en: '[PRE2]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: The `-p` argument tells `flow-capture` where to store its process ID (PID) file.
    The location */var/run/flow-capture.pid* is a common default for most Unix-like
    operating systems.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: '`-p` 参数告诉 `flow-capture` 将其进程 ID (PID) 文件存储在哪里。对于大多数类 Unix 操作系统，*/var/run/flow-capture.pid*
    是一个常见的默认位置。'
- en: The `-n` option tells `flow-capture` how many times it should rotate its log
    files in a 24-hour period. `287` tells `flow-capture` to create a new log file
    every five minutes. (The astute among you will notice that a day contains 288
    five-minute periods. Flow-capture creates one file and then rotates to a new one
    287 times in a day, for a total of 288 log files per day.) Many of the add-on
    reporting programs you'll use expect log files in five-minute increments.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: '`-n` 选项告诉 `flow-capture` 在 24 小时内应该旋转其日志文件多少次。`287` 告诉 `flow-capture` 每五分钟创建一个新的日志文件。（你们中敏锐的人会注意到一天包含
    288 个五分钟周期。Flow-capture 在一天内创建一个文件，然后旋转到新文件 287 次，因此一天总共创建 288 个日志文件。）你将使用的许多附加报告程序都期望以五分钟为增量来处理日志文件。'
- en: Tell `flow-capture` where to write its files with `-w`. The directory */var/db/flows*
    is a common choice, though some prefer */var/log/flows*. Either way, each collector
    needs its own directory, so you might want to use something like */var/db/flows/internet*
    or */var/log/internet_flows*.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `-w` 选项告诉 `flow-capture` 将其文件写入何处。*/var/db/flows* 是一个常见的选项，尽管有些人更喜欢 */var/log/flows*。无论如何，每个收集器都需要自己的目录，因此你可能想使用类似
    */var/db/flows/internet* 或 */var/log/internet_flows* 的东西。
- en: The `-S` *`5`* option tells `flow-capture` to log messages to syslog, telling
    how many flows it has processed, how many packets it has received, and how many
    flows it believes it has dropped. The argument (`5`) is the number of minutes
    between log messages.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: '`-S` *`5`* 选项告诉 `flow-capture` 将消息记录到 syslog，说明它处理了多少流量，接收了多少数据包，以及它认为丢弃了多少流量。参数（`5`）是日志消息之间的分钟数。'
- en: Note
  id: totrans-70
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '`flow-capture` uses the syslog facility LOCAL6\. (Check a syslog tutorial to
    learn how to manage syslog messages.) You cannot change this facility without
    delving deep into the `flow-capture` source code.'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: '`flow-capture` 使用 syslog 设施 LOCAL6。 （查看一个 syslog 教程以了解如何管理 syslog 消息。）你不能不深入研究
    `flow-capture` 源代码来更改此设施。'
- en: The last command line argument (`192.0.2.10/192.0.2.1/5678`) specifies `flow-capture`'s
    network configuration. The first address is the IP address on the local machine
    that `flow-capture` listens to. As you can see in the listing above, our sample
    collector runs on the IP address 192.0.2.10\. If you put a 0 in this space, the
    collector will accept traffic on all IP addresses on the machine. Even if your
    collector has only one IP address, I recommend explicitly assigning that address
    to your collector. You might add more IP addresses to your collector at a later
    date, and you probably don't want `flow-capture` attaching to those addresses
    as well.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 最后一个命令行参数（`192.0.2.10/192.0.2.1/5678`）指定了`flow-capture`的网络配置。第一个地址是`flow-capture`在本地机器上监听的IP地址。如您在上面的列表中看到的，我们的示例收集器在IP地址192.0.2.10上运行。如果您在这个位置放置0，收集器将接受机器上所有IP地址的流量。即使您的收集器只有一个IP地址，我也建议明确地将该地址分配给您的收集器。您可能在以后添加更多IP地址到您的收集器，而且您可能不希望`flow-capture`也附加到这些地址。
- en: The second IP, 192.0.2.1, is the address of the sensor that is permitted to
    send data to this collector. If you were to put 0 here (or eliminate it) instead
    of an IP address, `flow-capture` would accept flow data from any address. Doing
    so increases the risk that an intruder will send bogus data to your collector
    but also permits you to accept flows from multiple sources simultaneously. (Almost
    all Unix-like operating systems have packet filter functions that would let you
    protect this port from all but sensors you specify, however.)
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个IP地址，192.0.2.1，是允许向此收集器发送数据的传感器的地址。如果您在这里放置0（或删除它）而不是IP地址，`flow-capture`将接受来自任何地址的流量数据。这样做会增加入侵者向您的收集器发送虚假数据的风险，但同时也允许您同时接受来自多个来源的流量。（然而，几乎所有类Unix操作系统都有数据包过滤功能，可以让你保护这个端口，除了你指定的传感器之外。）
- en: Finally, `5678` is the UDP port `flow-capture` listens to. Because no authority
    has formally assigned a UDP port for Cisco NetFlow, you should use any high-numbered
    port not reserved by any other service. Port 6434 is assigned to sFlow, and ports
    4739–4740 have been assigned to IPFIX, so you might want to use one of those ports.
    Also, many Cisco NetFlow products use port 2055, which was assigned to Cisco for
    a product never publicly released.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，`5678`是`flow-capture`监听的UDP端口。因为没有任何权威机构正式分配UDP端口用于Cisco NetFlow，您应该使用任何未被其他服务保留的高编号端口。端口6434分配给了sFlow，端口4739-4740分配给了IPFIX，所以您可能想使用这些端口之一。此外，许多Cisco
    NetFlow产品使用端口2055，这是为Cisco分配给一个从未公开发布的产品。
- en: Try to start `flow-capture` on your system with options appropriate for your
    system. Confirm that it continues to run for a few minutes. This validates that
    you haven't made any fundamental mistakes in building or installing the software
    and that your command line is basically correct.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 尝试使用适合您系统的选项在您的系统上启动`flow-capture`。确认它持续运行几分钟。这验证了您在构建或安装软件时没有犯任何基本错误，并且您的命令行基本上是正确的。
- en: Starting flow-capture at Boot
  id: totrans-76
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在启动时启动flow-capture
- en: Your operating system must start `flow-capture` at boot time, just as it does
    any other critical service. The process for doing so varies widely with operating
    systems. If you installed flow-tools from a package provided by your operating
    system vendor, it almost certainly includes a startup script. For example, the
    Red Hat Linux RPM installs a startup script in */etc/init.d*. The FreeBSD package
    includes a startup script configured in */etc/rc.local*. You'll need to tell the
    script where to store the captured flow files, how often to rotate them, and what
    hosts to accept flow data from—in fact, all of the things you set in the `flow-capture`
    command in the previous section.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 您的操作系统必须在启动时启动`flow-capture`，就像它启动任何其他关键服务一样。这样做的方法因操作系统而异。如果您从操作系统供应商提供的软件包中安装了flow-tools，它几乎肯定包含一个启动脚本。例如，Red
    Hat Linux RPM在*/etc/init.d*中安装了一个启动脚本。FreeBSD软件包包括一个配置在*/etc/rc.local*中的启动脚本。您需要告诉脚本在哪里存储捕获的流量文件，多久轮换一次，以及接受哪些主机的流量数据——实际上，就是您在上一个部分中设置的`flow-capture`命令中的所有设置。
- en: Note
  id: totrans-78
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If the package for your chosen operating system doesn't include a startup script,
    add your `flow-capture` command into the computer's startup system appropriately.
    Check your operating system documentation. Sometimes this is as simple as copying
    the command into */etc/rc.local*. `flow-capture` should start only after the network
    and local storage are started.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您选择的操作系统包中不包含启动脚本，请将您的 `flow-capture` 命令适当地添加到计算机的启动系统中。请检查您的操作系统文档。有时这只需将命令复制到
    */etc/rc.local* 即可。`flow-capture` 应该只在网络和本地存储启动后才开始运行。
- en: Reboot your system to verify that `flow-capture` starts on boot.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 重新启动您的系统以验证 `flow-capture` 是否在启动时启动。
- en: How Many Collectors?
  id: totrans-81
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 收集器的数量？
- en: Now that you have one instance of `flow-capture` running, it's time to decide
    how to handle incoming data. You can choose to have all your sensors feed data
    to a single collector or have each sensor feed data to its own collector instance.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您已经运行了一个 `flow-capture` 实例，是时候决定如何处理传入的数据了。您可以选择让所有传感器将数据发送到单个收集器，或者让每个传感器将数据发送到其自己的收集器实例。
- en: Having all sensors feed records to one collector is simple. Configure one and
    only one collector, and do not restrict the addresses that can send to it. Configure
    all your sensors to use that single collector. The collector will intermingle
    all the flow records from all sensors into one common log file. But how do you
    tell whether flows are from one part of the network or another? You can differentiate
    flows by the sensor IP address, but this adds steps to the analysis.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 将所有传感器记录发送到一个收集器是简单的。配置一个且仅有一个收集器，不要限制可以发送到它的地址。配置所有您的传感器使用该单个收集器。收集器将所有传感器的流量记录混合到一个共同的日志文件中。但是，您如何区分来自网络不同部分的流量？您可以通过传感器IP地址来区分流量，但这会增加分析的步骤。
- en: In the absence of compelling reasons otherwise, I recommend running a separate
    collector for each flow sensor to help you keep your data separate. All the `flow-capture`
    instances can run on the same server and use the same IP address, and you can
    assign each `flow-capture` process its own UDP port and data directory so that
    you can analyze traffic from each network segment separately. Combining separated
    data is much easier than separating combined data.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 如果没有其他强有力的理由，我建议为每个流量传感器运行一个单独的收集器，以帮助您保持数据分离。所有 `flow-capture` 实例都可以运行在同一台服务器上并使用相同的IP地址，您可以为每个
    `flow-capture` 进程分配其自己的UDP端口和数据目录，这样您就可以分别分析每个网络段的数据。合并分离的数据比分离合并的数据要容易得多。
- en: Collector Log Files
  id: totrans-85
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 收集器日志文件
- en: 'Your collector won''t record anything until a sensor starts sending data. Once
    data reaches the collector, however, the collector creates a log file of the following
    format:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 您的收集器在传感器开始发送数据之前不会记录任何内容。然而，一旦数据达到收集器，收集器就会创建以下格式的日志文件：
- en: '| *tmp-v05.2009-11-15.134501-0500* |'
  id: totrans-87
  prefs: []
  type: TYPE_TB
  zh: '| *tmp-v05.2009-11-15.134501-0500* |'
- en: The leading *tmp* in this filename indicates that this is a temporary file.
    `flow-capture` is still writing to this file. The year, month, and day on which
    the flow file was created comes next, followed by the timestamp in 24-hour format.
    The time given is the time the flow file was created, not the time the log file
    was completed and closed off. This example flow file was created on November 15,
    2009 (*2009-11-15*), at 13:45:01 or 1:45:01 **pm** (*134501*). The last number
    (*−0500*) is the time zone offset from UTC. My collector is running in Eastern
    standard time, negative five hours east of UTC. If your collector is in a time
    zone west of UTC, the time zone offset will have a *+* in front of it. If you
    have multiple collectors in multiple time zones, I recommend having them all use
    the same time zone, such as UTC.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 文件名中的前缀 *tmp* 表示这是一个临时文件。`flow-capture` 仍在向该文件写入。接下来是创建流量文件的年、月、日，然后是24小时格式的时间戳。给出的是流量文件创建的时间，而不是日志文件完成和关闭的时间。这个示例流量文件是在2009年11月15日
    (*2009-11-15*)，13:45:01或下午1:45:01 (*134501*) 创建的。最后的数字 (*−0500*) 是相对于UTC的时间区域偏移。我的收集器在东部标准时间运行，比UTC东边五个小时。如果您的收集器位于UTC西边的时间区域，时间区域偏移将前面有一个
    *+*。如果您有多个收集器位于多个时区，我建议它们都使用相同的时间区域，例如UTC。
- en: When it's time to create a new file, `flow-capture` renames the current temporary
    file to begin with *ft-* and creates a new temporary file. The name otherwise
    remains the same, allowing you to easily identify and sort flow files by creation
    time.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 当需要创建新文件时，`flow-capture` 将当前临时文件重命名为以 *ft-* 开头，并创建一个新的临时文件。名称的其他部分保持不变，这使得您可以轻松地根据创建时间识别和排序流量文件。
- en: Collector Troubleshooting
  id: totrans-90
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 收集器故障排除
- en: If you configure a sensor to send data to your collector but `flow-capture`
    isn't generating any log files within a few minutes, start troubleshooting. Either
    the sensor is not transmitting data, flow-capture is not writing the data to disk,
    or a firewall between the sensor and collector is blocking that port.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您配置传感器将数据发送到您的收集器，但 `flow-capture` 在几分钟内没有生成任何日志文件，请开始故障排除。要么传感器没有传输数据，要么
    `flow-capture` 没有将数据写入磁盘，或者传感器和收集器之间的防火墙阻止了该端口。
- en: To begin troubleshooting, first verify that sensor data is reaching your collector
    with `tcpdump` in order to separate network problems from local software problems.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 要开始故障排除，首先使用 `tcpdump` 验证传感器数据是否到达您的收集器，以便将网络问题与本地软件问题分开。
- en: '[PRE3]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The `-p` tells `tcpdump` to *not* put the interface into promiscuous mode. This
    means that the system will only sniff traffic that reaches the local interface.
    (A proper switch configuration should prevent promiscuous-mode sniffing, but using
    `-p` means that the machine won't even try.) The `-i` argument gives the name
    of the interface that you want to listen to, `em0` in this case, which happens
    to be a network card on my system. (Most Linux distributions have a primary network
    interface of `eth0`.) Finally, specify the port your collector runs on, `5678`
    in this case.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: '`-p` 告诉 `tcpdump` 不要将接口置于混杂模式。这意味着系统将仅嗅探到达本地接口的流量。（适当的交换机配置应防止混杂模式嗅探，但使用 `-p`
    意味着机器甚至不会尝试。）`-i` 参数给出了您想要监听的接口名称，在这种情况下是 `em0`，这恰好是我系统上的一个网卡。（大多数 Linux 发行版的主网络接口为
    `eth0`。）最后，指定您的收集器运行的端口，在这种情况下是 `5678`。'
- en: This command should print information about every packet arriving at your collector
    host on the specified port. If you don't see any data reaching the collector host,
    check your sensor configuration and the configuration of any firewalls between
    the sensor and collector, and then use your packet sniffer progressively closer
    to the sensor until you find where the data stops. If you reach your sensor and
    find that it's not putting any flow exports on the wire, your sensor configuration
    is suspect. If necessary, contact your vendor for assistance.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令应打印出指定端口到达您的收集主机上的每个数据包的信息。如果您没有看到任何数据到达收集主机，请检查您的传感器配置以及传感器和收集主机之间任何防火墙的配置，然后使用您的数据包嗅探器逐渐接近传感器，直到找到数据停止的地方。如果您到达传感器并发现它没有将任何流量导出放在线路上，您的传感器配置可能存在问题。如果需要，请联系您的供应商以获得帮助。
- en: If the system is receiving flow data but `flow-capture` is not writing any log
    files, check your flow-capture configuration to be sure that you specified the
    proper UDP port and directory. Verify that the user running `flow-capture` can
    write files to that directory. Also check the system logs, such as */var/log/messages*,
    for error messages. (Remember, `flow-capture` uses LOCAL6\. Be certain to configure
    syslog to log LOCAL6 messages to a file.)
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 如果系统正在接收流量数据，但 `flow-capture` 没有写入任何日志文件，请检查您的 `flow-capture` 配置，以确保您指定了正确的
    UDP 端口和目录。验证运行 `flow-capture` 的用户是否有权向该目录写入文件。此外，检查系统日志，如 */var/log/messages*，以查找错误信息。（记住，`flow-capture`
    使用 LOCAL6。请确保配置 syslog 将 LOCAL6 消息记录到文件中。）
- en: Configuring Hardware Flow Sensors
  id: totrans-97
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 配置硬件流量传感器
- en: Configuring hardware flow sensors is your simplest and best option in most cases.
    Many network hardware manufacturers, such as Cisco, include flow export in their
    products. Cisco routers have supported NetFlow since the 1990s. Some larger Cisco
    switches also support NetFlow, but for best results you must configure switches
    differently than routers. Juniper routers also support flow export, so I'll cover
    configuring them. A number of smaller router vendors also support flow export,
    but you'll need to check your vendor's documentation for configuration instructions.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 在大多数情况下，配置硬件流量传感器是您最简单和最佳的选择。许多网络硬件制造商，如 Cisco，在其产品中包含流量导出。Cisco 路由器自 1990 年代以来就支持
    NetFlow。一些较大的 Cisco 交换机也支持 NetFlow，但为了获得最佳效果，您必须将交换机的配置与路由器不同。Juniper 路由器也支持流量导出，因此我将介绍如何配置它们。一些较小的路由器供应商也支持流量导出，但您需要检查供应商的文档以获取配置说明。
- en: The book's examples will assume that the flow collector is running on the host
    10.10.10.10 on UDP port 5678\. Replace these with appropriate values for your
    environment.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 书中的示例将假设流量收集器正在主机 10.10.10.10 上运行 UDP 端口 5678。请根据您的环境替换这些值。
- en: Cisco Routers
  id: totrans-100
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Cisco 路由器
- en: 'Configure NetFlow on a Cisco router interface by interface. You probably need
    NetFlow only on your upstream interface(s), not on the local Ethernet interface.
    (If you have a complex Ethernet infrastructure, such as an HSRP or VRRP cluster,
    you might want to monitor flows on the Ethernet interfaces as well.) In the following
    example, you activate NetFlow on the interface Serial0/0:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 通过接口接口配置Cisco路由器上的NetFlow。您可能只需要在上游接口（s）上启用NetFlow，而不是在本地以太网接口上。 （如果您有一个复杂的以太网基础设施，例如HSRP或VRRP集群，您可能还希望监控以太网接口上的流量。）在以下示例中，您在接口Serial0/0上激活NetFlow：
- en: '[PRE4]'
  id: totrans-102
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Repeat this configuration on all upstream router interfaces, and then tell the
    router where to send flow data.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 在所有上游路由器接口上重复此配置，然后告诉路由器将流量数据发送到何处。
- en: '[PRE5]'
  id: totrans-104
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Now save your work. You should find that data goes to your collector almost
    immediately.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 现在保存您的作品。您应该会发现数据几乎立即发送到您的收集器。
- en: To see the flow information tracked on your router, use the IOS command **`show
    ip cache flow`**.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看您路由器上跟踪的信息流，请使用IOS命令**`show ip cache flow`**。
- en: Some Cisco models use a slightly different syntax. If you have trouble, search
    Cisco's website or the Internet for suggestions.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 一些Cisco型号使用略有不同的语法。如果您遇到麻烦，请在Cisco的网站或互联网上搜索建议。
- en: Cisco Switches
  id: totrans-108
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Cisco交换机
- en: NetFlow on Cisco switches is a comparatively recent development and is limited
    to higher-end models. As a rule, only modular switches such as the 4000, 6000,
    and their descendants support NetFlow export. Many switches also require an add-on
    NetFlow card that you might or might not have. Stackable switches do not, nor
    do smaller stand-alone managed switches. Enable or disable NetFlow for the switch
    as a whole, not on a per-interface basis.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 在Cisco交换机上，NetFlow是一个相对较新的发展，并且仅限于高端型号。通常，只有模块化交换机，如4000、6000及其后继产品支持NetFlow导出。许多交换机还需要一个附加的NetFlow卡，您可能或可能没有。堆叠式交换机不需要，较小的独立式管理交换机也不需要。为整个交换机启用或禁用NetFlow，而不是基于每个接口。
- en: NetFlow support varies widely by model and the IOS version installed. I'm providing
    a sample configuration here, but do not blindly install it on your switch! Cisco
    switches can perform many tasks in many different ways, and what works in my environment
    might not work in yours.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: NetFlow支持因型号和安装的IOS版本而异。这里提供一个示例配置，但请不要盲目将其安装在您的交换机上！Cisco交换机可以通过许多不同的方式执行许多不同的任务，而在我的环境中有效的方法可能不适合您。
- en: Before configuring NetFlow on your router, ask Cisco how to capture all flow
    data from your model of switch in your environment. Your configuration will probably
    look similar to the following sample.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 在您的路由器上配置NetFlow之前，询问Cisco如何捕获您环境中该型号交换机的所有流量数据。您的配置可能看起来类似于以下示例。
- en: Note
  id: totrans-112
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If you decide that you want to just try this and see what happens, back up your
    configuration first and try it while you have no users on the network.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您决定只想尝试一下并看看会发生什么，请先备份您的配置，并在没有用户在网络上时尝试它。
- en: '[PRE6]'
  id: totrans-114
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The second line's configuration statement (`ip route-cache flow`) tells the
    switch to activate flows, and the next one (`ip flow ingress`) tells the switch
    to track flows based on the route they take to enter the switch.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 第二行的配置语句（`ip route-cache flow`）告诉交换机激活流量，下一行（`ip flow ingress`）告诉交换机根据它们进入交换机的路由来跟踪流量。
- en: By default these routing-capable switches export information only about flows
    that they route, not switched Ethernet traffic. However, because you want to capture
    flow information about the local Ethernet traffic as well, you tell the switch
    to capture the layer 2 flows as well with **`ip flow ingress layer2-switched`**.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，这些具有路由功能的交换机仅导出它们路由的流量信息，而不是交换以太网流量。然而，由于您还想捕获关于本地以太网流量的信息，您告诉交换机使用**`ip
    flow ingress layer2-switched`**同时捕获第2层流量。
- en: Cisco switches speak NetFlow version 7, so you might as well use it. Turn it
    on with **`ip flow-export version 7`**. Finally, you tell the switch where to
    send the flow data, to `10.10.10.10`, port `5678`.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: Cisco交换机使用NetFlow版本7，所以您不妨使用它。使用**`ip flow-export version 7`**来开启它。最后，您告诉交换机将流量数据发送到`10.10.10.10`，端口`5678`。
- en: Once you've completed your configuration, save your work. Data should arrive
    at your collector almost immediately. As with a Cisco router, use the command
    **`show ip cache flow`** to see current flow statistics.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 完成您的配置后，保存您的作品。数据应该几乎立即到达您的收集器。与Cisco路由器一样，使用命令**`show ip cache flow`**来查看当前的流量统计信息。
- en: Juniper Routers
  id: totrans-119
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Juniper路由器
- en: Juniper configurations are much longer than Cisco configurations, but the configuration
    isn't that difficult. Start by telling the Juniper how to sample flow traffic
    and where you want the flows sent.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: Juniper的配置比Cisco的配置长得多，但配置并不困难。首先，告诉Juniper如何采样流量流量，以及您希望将流量发送到何处。
- en: '[PRE7]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Despite all the parentheses, this configuration isn't that hard to understand.
    You begin at ❶ by defining how heavily you want to sample flows. In this example,
    I've set the sampling rate to 1\. This Juniper samples 1 flow out of every 1,
    or all, flows. If you were to set the sampling rate to 100, the Juniper would
    sample 1 out of every 100 packets. This example betrays my personal bias; I record
    all traffic, if possible. If complete traffic recording overloads your router,
    increase the sampling level until the hardware can support it. Those of you with
    10GB networks almost certainly must sample! The only way to determine the lowest
    sustainable sampling rate on your network is through experimentation. Sampling
    too aggressively overloads the router and causes packet loss.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管有很多括号，但这个配置并不难理解。您从❶开始，定义您想要如何大量采样流量。在这个例子中，我将采样率设置为1。Juniper从每1个或所有流量中采样1个流量。如果您将采样率设置为100，Juniper将每100个数据包中采样1个。这个例子暴露了我的个人偏见；如果可能，我会记录所有流量。如果完整的流量记录使您的路由器过载，请增加采样级别，直到硬件可以支持为止。那些拥有10GB网络的您几乎肯定必须采样！确定您网络上的最低可持续采样率唯一的方法是通过实验。过度采样会导致路由器过载并造成数据包丢失。
- en: As you might remember, cflowd is an obsolete flow collector. Juniper hardware
    uses that name to specify where the router will send flows. At ❷ you tell the
    Juniper where to find your flow collector, the UDP port (❸) the collector runs
    on, and what address on the router (❹) to send packets from.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 如您所记得，cflowd是一个过时的流量收集器。Juniper硬件使用该名称来指定路由器将发送流量的位置。在❷处，您告诉Juniper在哪里找到您的流量收集器，收集器运行的UDP端口（❸），以及从路由器（❹）发送数据包的地址。
- en: Now enable sampling on the interface(s) you want to capture flow data from.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 现在启用您想要捕获流量数据的接口的采样。
- en: '[PRE8]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: This configuration sends the incoming and outgoing traffic on this interface
    to the flow export (or sampling) engine.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 此配置将此接口的入站和出站流量发送到流量导出（或采样）引擎。
- en: Configuring Software Flow Sensors
  id: totrans-127
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 配置软件流量传感器
- en: Suppose you need flow export on a network but don't have any switches that support
    flow export. Never fear, you can implement a flow sensor in software instead of
    buying new hardware.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 假设您需要在网络上进行流量导出，但没有支持流量导出的交换机。不必担心，您可以在不购买新硬件的情况下，通过软件实现流量传感器。
- en: Using software instead of hardware for flow sensing has limitations. For one,
    software needs to run on a server, so it adds another device to your network.
    Also, you can only capture data from a managed Ethernet switch. The software might
    not capture all the traffic, and it might not tell you when it misses something.
    And flow sensor software is yet another thing that the network administrator must
    configure, patch, and maintain. Don't you have enough to do already? Still, for
    a small network, software is the only realistic choice.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 使用软件而不是硬件进行流量感知有局限性。首先，软件需要在服务器上运行，因此它会给您的网络增加另一个设备。此外，您只能从管理型以太网交换机捕获数据。软件可能无法捕获所有流量，并且可能不会告诉您它错过了什么。而且流量传感器软件是网络管理员必须配置、修补和维护的另一件事。您的工作还不够多吗？然而，对于小型网络来说，软件是唯一现实的选择。
- en: Setting Up Sensor Server Hardware
  id: totrans-130
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置传感器服务器硬件
- en: Flow sensor software requires very few system resources. You can easily use
    a desktop that your management took out of production because it ran so slowly
    that the receptionist couldn't use it anymore. I've run effective flow sensors
    on tiny computers such as the Soekris ([http://www.soekris.com/](http://www.soekris.com/)).
    Even a modest machine with a 266MHz CPU and 128MB of RAM was mostly idle while
    capturing traffic off a low-traffic LAN.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 流量传感器软件需要的系统资源非常少。您可以使用管理员因运行速度过慢而停用的台式机。我曾在Soekris（[http://www.soekris.com/](http://www.soekris.com/)）等小型计算机上运行有效的流量传感器。即使是拥有266MHz
    CPU和128MB RAM的普通机器，在捕获低流量局域网的流量时也大部分处于空闲状态。
- en: Whatever hardware you choose, your flow sensor machine needs at least two network
    interfaces. One interface must be capable of handling many packets per second.
    If you're recycling a discarded desktop machine with a network card embedded on
    the motherboard, assume that the built-in network card is not of sufficient quality.
    Very few desktop motherboard vendors use high-end network chipsets, preferring
    to use inexpensive chipsets that are just barely adequate for most users. If you're
    not sure what network card to buy, Intel's cards usually suffice for a flow sensor.
    The embedded network cards on server-grade systems are usually adequate; they're
    not great, but they're adequate.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 无论你选择什么硬件，你的流量传感器机器至少需要两个网络接口。一个接口必须能够处理每秒许多个数据包。如果你正在回收一个带有主板集成网络卡的废弃台式机，假设内置网络卡的质量不足以满足需求。非常少的台式机主板厂商使用高端网络芯片组，他们更愿意使用价格低廉的芯片组，这些芯片组对于大多数用户来说刚刚足够。如果你不确定要购买什么网络卡，英特尔的网络卡通常足以用于流量传感器。服务器级系统上的嵌入式网络卡通常足够用；它们不是很好，但足够了。
- en: Finally, if you recycle an old machine for flow sensor hardware, get a new hard
    drive. Flow sensors use very little hard drive space, but the hard drive is the
    system component most likely to fail with age. You don't want to install your
    flow sensor just to see your work evaporate in a few weeks because the hard drive
    shattered! (Senior systems administrators might consider building a flow sensor
    bootable CD out of a tool kit such as FreeSBIE so that you can mass-produce easily
    replaceable sensors.)
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，如果你为流量传感器硬件回收一台旧机器，请获取一个新的硬盘。流量传感器使用的硬盘空间非常少，但硬盘是随着时间推移最有可能出现故障的系统组件。你不想安装流量传感器，结果在几周后看到你的工作因为硬盘损坏而消失！（资深系统管理员可以考虑使用FreeSBIE等工具包制作一个可启动的流量传感器CD，这样你可以轻松地大量生产可替换的传感器。）
- en: Finally, I recommend using the same operating system on both your flow sensor
    server and your collector. This is certainly not a requirement, but running multiple
    operating systems in production just because you can is a symptom of having too
    much time on your hands.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我建议在你的流量传感器服务器和收集器上使用相同的操作系统。这当然不是必需的，但仅仅因为可以就在生产环境中运行多个操作系统，这可能是手头时间过多的一个迹象。
- en: Network Setup
  id: totrans-135
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 网络设置
- en: Using a software flow sensor requires that you have a switch capable of *port
    mirroring* or *port monitoring*. This is often called a *sniffer port*. The switch
    copies all traffic crossing the switch to the monitor interface. You might verify
    this with a packet sniffer before proceeding.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 使用软件流量传感器需要你有具备*端口镜像*或*端口监控*功能的交换机。这通常被称为*嗅探端口*。交换机将所有通过交换机的流量复制到监控接口。在继续之前，你可能需要使用数据包嗅探器来验证这一点。
- en: To configure a monitor port on a Cisco system, define the interfaces you want
    to monitor and the interface to which you want to direct traffic. In the following
    example, a Cisco switch is copying all traffic from VLAN 1 into interface Gi0/4\.
    (Many switch vendors also offer web-based configuration tools.)
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 要在思科系统上配置监控端口，定义你想要监控的接口以及你想要将流量重定向到的接口。在以下示例中，一个思科交换机正在将所有来自VLAN 1的流量复制到接口Gi0/4。许多交换机厂商也提供基于Web的配置工具。
- en: '[PRE9]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: You start at ❶ by defining a monitor session and telling the switch which VLAN
    or ports to monitor. Then at ❷ you tell the switch where to replicate the monitored
    traffic. This small switch will now copy all traffic crossing the main VLAN to
    the monitor port.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 你从❶开始，定义一个监控会话并告诉交换机要监控哪个VLAN或端口。然后，在❷中，你告诉交换机将监控的流量复制到何处。这个小交换机现在将复制所有通过主VLAN的流量到监控端口。
- en: A switch that can export flows should be large enough to allow you to connect
    all of your primary servers to it so that all critical traffic crosses that big
    switch and your flow exports capture pretty much everything vital. If you use
    a few smaller switches instead of one big one, ensure that the monitor port captures
    traffic from all critical servers.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 一个能够导出流量的交换机应该足够大，以便你可以将其连接到所有主要服务器，这样所有关键流量都会通过这个大交换机，并且你的流量导出几乎可以捕获所有重要的信息。如果你使用几个较小的交换机而不是一个大交换机，请确保监控端口能够捕获所有关键服务器的流量。
- en: Note
  id: totrans-141
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Remember, any traffic that remains on a closet switch will not be captured.
    You could deploy a flow sensor on every switch, but that quickly becomes cumbersome.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 记住，任何留在机柜交换机上的流量都不会被捕获。你可以在每个交换机上部署流量传感器，但这很快就会变得繁琐。
- en: Sensor Server Setup
  id: totrans-143
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 传感器服务器设置
- en: A switch will not accept regular traffic on a monitor port, so the sensor machine
    cannot use the monitor port for its network traffic. (Go ahead, try it.) Sniffer
    ports are only for watching the network, not participating in the network. Your
    sensor box needs a second network card for regular network activity.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 交换机不会在监控端口上接受常规流量，因此传感器机器不能使用监控端口进行网络流量。 （试试看。）嗅探器端口仅用于监视网络，而不是参与网络。您的传感器盒需要一个第二块网络卡进行常规网络活动。
- en: 'On Linux and BSD systems, you must activate the sniffer interface before it
    can sense traffic. It''s also wise to disable ARP on the interface (with the `up`
    and `-arp` commands) so that your sniffer interface doesn''t even try to participate
    in the network. Here, you start the interface em0 and disable ARP on it:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 在Linux和BSD系统上，您必须激活嗅探器接口，它才能检测流量。还明智地禁用接口上的ARP（使用`up`和`-arp`命令），这样您的嗅探器接口甚至不会尝试参与网络。在这里，您启动接口em0并禁用其上的ARP：
- en: '[PRE10]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Substitute your sniffer interface for em0, and then use `tcpdump` to verify
    that you're seeing network traffic on your sniffer interface.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 将您的嗅探器接口替换为em0，然后使用`tcpdump`验证您是否在嗅探器接口上看到网络流量。
- en: '[PRE11]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: You should see traffic records streaming across the screen. Press **ctrl**-C
    to stop the output.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该看到流量记录在屏幕上流过。按**ctrl**-C停止输出。
- en: Running the Sensor on the Collector
  id: totrans-150
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在收集器上运行传感器
- en: If your collector runs on higher-end hardware and you don't need many sensors,
    you might consider running the sensor on the collector machine. Add another network
    interface to the machine, have the sensor run on that interface, then configure
    the sensor to transmit to a UDP port on the localhost IP (127.0.0.1), and have
    the collector accept connections only from 127.0.0.1.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您的收集器运行在高端硬件上且不需要很多传感器，您可能考虑在收集器机器上运行传感器。向机器添加另一个网络接口，让传感器在该接口上运行，然后配置传感器将数据传输到本地主机IP（127.0.0.1）上的UDP端口，并让收集器只接受来自127.0.0.1的连接。
- en: This machine becomes doubly security sensitive, however. Not only does the collector
    have a historical record of traffic through your network, but it can view all
    current network activity. Secure this machine!
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，这台机器的安全敏感性加倍。收集器不仅记录了您网络上的流量历史，还可以查看所有当前网络活动。确保这台机器的安全！
- en: 'The Sensor: softflowd'
  id: totrans-153
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 传感器：softflowd
- en: Again, an Internet search will reveal many different software flow sensors,
    but I recommend `softflowd`, from [http://www.mindrot.org/softflowd.html](http://www.mindrot.org/softflowd.html).
    Go there to identify the current version; if you can find a current package for
    your operating system, use it. If you cannot find a package, download the source
    code, and install the program by hand.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 再次，网络搜索将揭示许多不同的软件流量传感器，但我推荐使用来自[http://www.mindrot.org/softflowd.html](http://www.mindrot.org/softflowd.html)的`softflowd`。前往该网站以识别当前版本；如果您能找到适用于您的操作系统的当前软件包，请使用它。如果找不到软件包，请下载源代码，并手动安装程序。
- en: 'Check the `softflowd` README file for instructions on how to build. Much like
    flow-tools, `softflowd` has a `configure` script. I prefer to install my add-on
    software in a different directory than the main system so I can easily keep it
    separate. Here I install `softflowd` under */usr/local/softflowd*:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 检查`softflowd`的README文件以获取构建说明。与flow-tools类似，`softflowd`也有一个`configure`脚本。我更喜欢将我的附加软件安装在主系统之外的不同目录中，这样我可以轻松地将其保持独立。在这里，我在*/usr/local/softflowd*下安装`softflowd`：
- en: '[PRE12]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: This installs two programs (`softflowd` and `softflowctl`), a man page for each
    program, and a README file.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 这将安装两个程序（`softflowd`和`softflowctl`），每个程序都有一个手册页和一个README文件。
- en: Running softflowd
  id: totrans-158
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 运行softflowd
- en: 'To run `softflowd`, you must know the interface `softflowd` will listen to,
    the collector''s hostname or IP address, and the port the collector is running
    on. Here, I''m having `softflowd` listen to the port em0 and transmit data to
    10.10.10.10 on port 5678:'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 要运行`softflowd`，您必须知道`softflowd`将监听的接口、收集器的主机名或IP地址以及收集器运行的端口。在这里，我让`softflowd`监听em0端口并将数据传输到10.10.10.10的5678端口：
- en: '[PRE13]'
  id: totrans-160
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: The `-t maxlife=300` in the middle of the command sets the flow timeout to 300
    seconds, or five minutes.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 命令中间的`-t maxlife=300`设置流量超时为300秒，即五分钟。
- en: '`softflowd` is more flexible than a hardware flow sensor, which means you have
    more opportunities to misconfigure it. The manual page has a complete list of
    ways you can adjust `softflowd`''s performance, but most of them are not useful
    in most environments. The one option that might be helpful, though, is the ability
    to change the upper limit on the number of flows `soft-flowd` will track at any
    one time.'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: '`softflowd` 比硬件流量传感器更灵活，这意味着你更有可能误配置它。手册页列出了你可以调整 `softflowd` 性能的所有方法，但大多数方法在大多数环境中并不实用。不过，有一个选项可能有所帮助，那就是改变
    `soft-flowd` 在任何给定时间跟踪的流量数量的上限。'
- en: By default `softflowd` tracks up to 8,192 flows at once, using about 800KB of
    memory. That's an awful lot of simultaneous connections, but if you're monitoring
    a high-bandwidth link, you might need to raise it. (The next section shows how
    to see how many flows `softflowd` is actually tracking at any given time.) Use
    the **`-m`** flag to specify the upper limit on the number of tracked flows.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，`softflowd` 一次最多跟踪 8,192 个流量，使用大约 800KB 的内存。这是大量的并发连接，但如果你正在监控高带宽链路，你可能需要提高这个数值。（下一节将展示如何查看
    `softflowd` 在任何给定时间实际跟踪的流量数量。）使用 **`-m`** 标志来指定跟踪流量的上限。
- en: '[PRE14]'
  id: totrans-164
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: This example tracks twice the normal number of flows.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 此示例跟踪的是正常流量数量的两倍。
- en: Watching softflowd
  id: totrans-166
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 监视 softflowd
- en: The `softflowctl` program allows the network administrator to manage a running
    `softflowd` process. You can use it to start and stop collecting flows, view currently
    tracked flows, and flush all flows being tracked to the collector. The softflowctl
    manual page gives instructions for all of softflowctl's features, but I'll cover
    only the functions used in normal circumstances.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: '`softflowctl` 程序允许网络管理员管理正在运行的 `softflowd` 进程。你可以用它来启动和停止收集流量，查看当前跟踪的流量，并将所有正在跟踪的流量刷新到收集器。softflowctl
    的手册页提供了关于 softflowctl 所有功能的说明，但我会只介绍在正常情况下使用的功能。'
- en: The easy `softflowctl` commands are `shutdown` and `exit`. To tell `softflowd`
    to export all the flows it's currently tracking to the collector and shut itself
    down, use the `shutdown` command. This is the recommended way to terminate `softflowd`.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 简单的 `softflowctl` 命令有 `shutdown` 和 `exit`。要告诉 `softflowd` 将其当前跟踪的所有流导出到收集器并自行关闭，请使用
    `shutdown` 命令。这是终止 `softflowd` 的推荐方法。
- en: '[PRE15]'
  id: totrans-169
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: If you want `softflowd` to shut itself off without sending any additional flows
    to the collector, use the `exit` command. You will lose any data `softflowd` has
    gathered but not exported.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想让 `softflowd` 在不向收集器发送任何额外流的情况下自行关闭，请使用 `exit` 命令。你将丢失 `softflowd` 收集但尚未导出的任何数据。
- en: '[PRE16]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: The more interesting features of `softflowctl` include the ability to view currently
    tracked flows and the ability to view the `softflowd`'s internal statistics on
    tracked flows.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: '`softflowctl` 更有趣的功能包括查看当前跟踪的流量和查看 `softflowd` 对跟踪流量的内部统计信息的能力。'
- en: Viewing Tracked Flows
  id: totrans-173
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 查看跟踪的流量
- en: If you want to see the flows that `softflowd` is currently tracking, use `softflowctl`'s
    `dump-flows` command. Each line is a single flow. If you see flows, `softflowd`
    is working.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想查看 `softflowd` 当前正在跟踪的流量，请使用 `softflowctl` 的 `dump-flows` 命令。每一行代表一个单独的流量。如果你看到流量，说明
    `softflowd` 正在工作。
- en: '[PRE17]'
  id: totrans-175
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: This flow involves a host with an IP of 192.0.2.253 (❶) and port 4234 (❷), and
    the other end of the connection is the host 239.255.255.250 (❸) on port 1900 (❹).
    This flow uses protocol 17 (❺), or UDP. Although you can see timing information
    as well, you'll have other ways to view this data more conveniently.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 此流量涉及一个 IP 为 192.0.2.253（❶）和端口 4234（❷）的主机，连接的另一端是 IP 为 239.255.255.250（❸）的主机，端口为
    1900（❹）。此流量使用协议 17（❺），或 UDP。尽管你可以看到时间信息，但你还有其他更方便查看这些数据的方法。
- en: Viewing Flow Statistics
  id: totrans-177
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 查看流量统计
- en: '`softflowd` starts tracking flows immediately upon starting. You can use `softflowctl`
    to query `softflowd` about the characteristics of the flows it is currently tracking
    with the `statistics` command, as shown here:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: '`softflowd` 在启动时立即开始跟踪流量。你可以使用 `softflowctl` 的 `statistics` 命令查询 `softflowd`
    当前跟踪的流量特征，如下所示：'
- en: '[PRE18]'
  id: totrans-179
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: I'll break up the lengthy output from this command into a few sections to make
    it easier to understand.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 我会将此命令的冗长输出分成几个部分，以便更容易理解。
- en: '[PRE19]'
  id: totrans-181
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'The first line at ❶ includes one interesting number: the process ID of the
    `softflowd` process you''re querying. If you''re running multiple instances of
    `softflowd` on one machine, this will help you verify that you''re querying the
    correct one.'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 第一行❶包含一个有趣的数字：你查询的 `softflowd` 进程的进程 ID。如果你在一台机器上运行多个 `softflowd` 实例，这将帮助你验证你查询的是正确的实例。
- en: The number of active flows at ❷ tells you how many flows `softflowd` thinks
    are ongoing. This is not the same as the number of active connections on your
    network at the moment. Remember, a sensor tracks a flow unless either it has reason
    to think that the flow has ended or the timeout expires. A flow from a DNS or
    UDP NFS request remains in `softflowd`'s list of tracked flows until the timeout
    expires, which may be long after the corresponding network activity has ceased.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 在❷处的活动流数量告诉你`softflowd`认为有多少流正在进行。这不同于你当前网络上的活动连接数量。记住，传感器跟踪流，除非有理由认为流已结束或超时到期。来自DNS或UDP
    NFS请求的流将保留在`softflowd`跟踪流的列表中，直到超时到期，这可能会在相应的网络活动停止很久之后。
- en: The number of packets processed (❸) should always increase, and the number of
    fragments (❹) probably will increase but less quickly.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 处理的数据包数量（❸）应该始终增加，而片段的数量（❹）可能也会增加，但增长速度较慢。
- en: The number of packets dropped (❺) is much more interesting. Every network tends
    to have "odd stuff " fluttering across it now and then. Flow management only handles
    TCP/IP and its related protocols, including IPv6, SCTP, and other advanced protocols.
    When `softflowd` encounters packets that are not part of TCP/IP, such as DECNet,
    it counts them but doesn't otherwise process them. Dropped packets might come
    from bad hardware, badly scrambled TCP/IP stacks, unusual network protocols, or
    any other weird error. You might try `netstat -s` to get an idea about which part
    of your system is dropping packets, and why. `softflowd` also drops packets that
    are too short to contain actual data.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 丢弃的数据包数量（❺）更有趣。每个网络都倾向于时不时地有“奇怪的东西”飘过。流管理只处理TCP/IP及其相关协议，包括IPv6、SCTP和其他高级协议。当`softflowd`遇到不属于TCP/IP的数据包时，例如DECNet，它会计数但不会对其进行其他处理。丢弃的数据包可能来自不良硬件、混乱的TCP/IP堆栈、不寻常的网络协议或任何其他奇怪的错误。你可以尝试使用`netstat
    -s`来了解系统哪个部分正在丢弃数据包，以及原因。`softflowd`也会丢弃太短而无法包含实际数据的数据包。
- en: You can see at ❻ that the number of flows `softflowd` has expired, as well as
    at ❼ how many it has exported to the collector. These numbers do not necessarily
    equal each other, because the former is a `softflowd` internal statistic. The
    number of flows exported should match the number received on the collector, however.
    If you see that `softflowd` has forced some flows to expire, use `-m` to increase
    the number of flows `softflowd` may track.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在❻处看到`softflowd`已过期的流数量，以及在❼处它导出到收集器的数量。这些数字不一定相等，因为前者是`softflowd`的内部统计。导出的流数量应该与收集器接收到的数量相匹配。如果你看到`softflowd`强制一些流过期，请使用`-m`来增加`softflowd`可能跟踪的流数量。
- en: Libpcap is the packet-capture software `softflowd` uses. At ❽, the number of
    packets libpcap receives should be roughly comparable to the number of packets
    `softflowd` has processed. At ❾, the number of packets dropped by libpcap should
    be very low for proper data capture. If this number is increasing, investigate.
    Your operating system or your hardware might not be adequate to the load being
    placed on it.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: Libpcap是`softflowd`使用的数据包捕获软件。在❽处，libpcap接收到的数据包数量应该大致相当于`softflowd`处理的数据包数量。在❾处，libpcap丢弃的数据包数量应该非常低，以确保正确的数据捕获。如果这个数字在增加，请调查。你的操作系统或硬件可能无法满足所施加的负载。
- en: It's also possible that your network card might not be up to the task of capturing
    all the data from your network. Finally, at ❿, the packets dropped by interface
    counter should be zero, or at least very low.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 也可能你的网卡无法完成捕捉网络中所有数据的任务。最后，在❿处，接口计数器丢弃的数据包应该为零，或者至少非常低。
- en: The output continues with information about the expired flows.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 输出继续显示有关已过期流的信息。
- en: '[PRE20]'
  id: totrans-190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: The smallest flow (❶) had 221 bytes. The smallest number of packets in a flow
    (❷) was 1\. The briefest flow (❸) lasted less than one one-hundredth of a second.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 最小的流（❶）有221字节。一个流中最少的数据包数量（❷）是1。最短的流（❸）持续不到一百分之一秒。
- en: You can make some guesses based on this data. For example, it's likely but not
    certain that the 221-byte flow was in a single packet, and it probably was the
    briefest as well. You might have many flows containing a small number of bytes
    in a single packet, though, and it's possible that the 221-byte flow was broken
    into multiple small packets. To reach any conclusions about particular flows,
    you must perform more detailed analysis. Treat the maximum values similarly; the
    flow with the greatest number of bytes was not necessarily the flow with the greatest
    number of packets.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以根据这些数据进行一些猜测。例如，221字节的流量很可能是一个单独的数据包，而且可能也是最短的。尽管如此，你可能有很多包含单个数据包中少量字节的流量，而且221字节的流量可能被分割成多个小数据包。要得出关于特定流量的任何结论，你必须进行更详细的分析。类似地对待最大值；字节最多的流量不一定是包数最多的流量。
- en: The average flow (❹) was 263,570 bytes, or roughly 257KB, and lasted about 22
    seconds (❺). Again, you cannot assume that the average-sized flows are the same
    as the flows with the average number of packets or the flows of average duration.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 平均流量（❹）为263,570字节，大约257KB，持续了大约22秒（❺）。同样，你不能假设平均大小的流量与平均包数或平均持续时间的流量相同。
- en: The statistics end with a count of the reasons why `softflowd` expired and exported
    each flow and a per-protocol statistics list.
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 统计数据以`softflowd`过期和导出每个流的原因计数以及每个协议的统计列表结束。
- en: '[PRE21]'
  id: totrans-195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: TCP and UDP have their own entries, including the specific reasons why flows
    were expired. For example, as shown at ❶, TCP flows can be expired by a TCP RST
    indicating that a port is closed or by the TCP FIN (❷) that marks the end of a
    normal session. Similarly, a UDP request to a closed port can generate an ICMP
    response, as shown at ❸, or it might just time out.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: TCP和UDP有自己的条目，包括流量过期具体原因。例如，如❶所示，TCP流量可以通过指示端口已关闭的TCP RST来过期，或者通过标记正常会话结束的TCP
    FIN（❷）。同样，向已关闭端口的UDP请求可以生成如❸所示的ICMP响应，或者它可能只是超时。
- en: '`softflowctl` also displays the number of flows expired because the timeout
    elapsed (❹) and the number expired because they exceeded the maximum size of a
    single flow (❺).'
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: '`softflowctl`还显示由于超时（❹）而过期的流量数量以及由于超过单个流的最大大小而过期的流量数量（❺）。'
- en: The `softflowd` program tracks a maximum number of flows simultaneously. If
    `softflowd` detects more flows than it can track, it expires older idle flows
    until it has sufficient capacity to track active flows. If the maxflows number
    (❼) begins climbing, increase the number of flows `softflowd` can track at any
    time.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: '`softflowd`程序跟踪同时跟踪的最大流量数。如果`softflowd`检测到的流量超过其跟踪能力，它将使较旧的空闲流量过期，直到它有足够的容量来跟踪活动流量。如果maxflows数量（❼）开始上升，增加`softflowd`在任何时候可以跟踪的流量数量。'
- en: Finally, the flushed entry (❽) shows how many flows were expired when the administrator
    ran `softflowctl expire-all`.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，清除条目（❽）显示了当管理员运行`softflowctl expire-all`时有多少流量已过期。
- en: The statistics section ends with per-protocol flow information.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 统计部分以每个协议的流量信息结束。
- en: Now that you've gathered some data, you'll learn how to look at it in [Chapter 3](ch03.html
    "Chapter 3. VIEWING FLOWS").
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经收集了一些数据，你将学习如何在[第3章](ch03.html "第3章。查看流量")中查看它。
