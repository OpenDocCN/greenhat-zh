- en: 'Chapter 17. Network Drivers, Part 2: Packet Reception and Transmission'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第17章。网络驱动程序，第二部分：数据包接收和传输
- en: '![image with no caption](httpatomoreillycomsourcenostarchimages1137497.png.jpg)'
  id: totrans-1
  prefs: []
  type: TYPE_IMG
  zh: '![无标题图片](http://atomoreilly.com/source/nostarch/images/1137497.png.jpg)'
- en: This chapter examines the packet reception and transmission components of `em(4)`.
    Predictably, `em(4)` uses both mbufs and MSI for packet reception and transmission.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章探讨了 `em(4)` 的数据包接收和传输组件。不出所料，`em(4)` 使用mbuf和MSI进行数据包接收和传输。
- en: Packet Reception
  id: totrans-3
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 数据包接收
- en: 'When an interface receives a packet, it sends an interrupt. Naturally, this
    causes its interrupt handler to execute. For example, here is what executes in
    `em(4)`:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 当一个接口接收到一个数据包时，它会发送一个中断。自然地，这会导致其中断处理程序执行。例如，以下是在 `em(4)` 中执行的内容：
- en: '[PRE0]'
  id: totrans-5
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This function takes a ![](httpatomoreillycomsourcenostarchimages1137499.png)
    pointer to a ring buffer that contains one or more received packets, and calls
    ![](httpatomoreillycomsourcenostarchimages1137501.png) `em_rxeof` to process those
    packets. If there are more than ![](httpatomoreillycomsourcenostarchimages1137503.png)
    `rx_process_limit` packets, a `task` structure is ![](httpatomoreillycomsourcenostarchimages1137505.png)
    queued; otherwise, this interrupt is ![](httpatomoreillycomsourcenostarchimages1137507.png)
    reenabled. I’ll discuss the `task` structure and its associated function in [em_handle_rx
    Function](ch17.html#em_underscore_handle_underscore_rx_funct "em_handle_rx Function")
    in [em_handle_rx Function](ch17.html#em_underscore_handle_underscore_rx_funct
    "em_handle_rx Function").
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 此函数接收一个 ![环缓冲区指针图片](http://atomoreilly.com/source/nostarch/images/1137499.png)
    指向包含一个或多个接收到的数据包的环缓冲区的指针，并调用 ![em_rxeof图片](http://atomoreilly.com/source/nostarch/images/1137501.png)
    `em_rxeof` 来处理这些数据包。如果有超过 ![rx_process_limit图片](http://atomoreilly.com/source/nostarch/images/1137503.png)
    `rx_process_limit` 个数据包，则将 `task` 结构排队；否则，此中断 ![重新启用图片](http://atomoreilly.com/source/nostarch/images/1137505.png)
    重新启用。我将在 [em_handle_rx 函数](ch17.html#em_underscore_handle_underscore_rx_funct
    "em_handle_rx 函数") 中讨论 `task` 结构及其相关函数。
- en: em_rxeof Function
  id: totrans-7
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: em_rxeof 函数
- en: 'As mentioned previously, `em_rxeof` processes received packets. Its function
    definition is listed below, but because this function is fairly long and involved,
    I’ll introduce it in parts. Here is the first part:'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，`em_rxeof` 处理接收到的数据包。其函数定义如下，但由于此函数相当长且复杂，我将分部分介绍。以下是第一部分：
- en: '[PRE1]'
  id: totrans-9
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: This function’s execution is contained primarily within a ![](httpatomoreillycomsourcenostarchimages1137499.png)
    `for` loop. This loop begins by ![](httpatomoreillycomsourcenostarchimages1137501.png)
    verifying that the ![](httpatomoreillycomsourcenostarchimages1137503.png) interface
    is up and running. Then it ![](httpatomoreillycomsourcenostarchimages1137505.png)
    synchronizes the DMA buffer currently loaded in ![](httpatomoreillycomsourcenostarchimages1137507.png)
    `rxr->rxdma.dma_map`, which is ![](httpatomoreillycomsourcenostarchimages1137509.png)
    `rxr->rx_base`.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 此函数的执行主要在一个 ![for循环图片](http://atomoreilly.com/source/nostarch/images/1137499.png)
    `for` 循环中进行。此循环首先 ![验证接口图片](http://atomoreilly.com/source/nostarch/images/1137501.png)
    验证接口是否已启动并运行。然后它 ![同步DMA缓冲区图片](http://atomoreilly.com/source/nostarch/images/1137505.png)
    同步当前加载在 ![DMA映射图片](http://atomoreilly.com/source/nostarch/images/1137507.png)
    `rxr->rxdma.dma_map` 中的DMA缓冲区，该缓冲区是 ![rx_base图片](http://atomoreilly.com/source/nostarch/images/1137509.png)
    `rxr->rx_base`。
- en: The buffer ![](httpatomoreillycomsourcenostarchimages1137509.png) `rxr->rx_base[i]`
    contains a descriptor that describes a received packet. When a packet spans multiple
    mbufs, `rxr->rx_base[i]` describes one mbuf in the chain.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 缓冲区 ![缓冲区图片](http://atomoreilly.com/source/nostarch/images/1137509.png) `rxr->rx_base[i]`
    包含一个描述符，用于描述接收到的数据包。当一个数据包跨越多个mbuf时，`rxr->rx_base[i]` 描述链中的其中一个mbuf。
- en: 'If `rxr->rx_base[i]` lacks the ![](httpatomoreillycomsourcenostarchimages1137511.png)
    `E1000_RXD_STAT_DD` flag, the `for` loop exits. (The `E1000_RXD_STAT_DD` flag
    stands for *receive descriptor status: descriptor done*. We’ll see its effects
    shortly.)'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 如果 `rxr->rx_base[i]` 缺少 ![接收描述符状态图片](http://atomoreilly.com/source/nostarch/images/1137511.png)
    `E1000_RXD_STAT_DD` 标志，则 `for` 循环退出。（`E1000_RXD_STAT_DD` 标志代表 *接收描述符状态：描述符完成*。我们很快就会看到其效果。）
- en: If `rxr->rx_base[i]` describes the ![](httpatomoreillycomsourcenostarchimages1137513.png)
    last mbuf in the chain, the Boolean variable `eop`, which stands for *end of packet*,
    is set to `TRUE`. (Needless to say, when a packet requires only one mbuf, that
    mbuf is still the last mbuf in the chain.)
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 如果 `rxr->rx_base[i]` 描述链中的 ![最后一个mbuf图片](http://atomoreilly.com/source/nostarch/images/1137513.png)
    最后一个mbuf，布尔变量 `eop`（代表 *数据包结束*）被设置为 `TRUE`。（不用说，当一个数据包只需要一个mbuf时，该mbuf仍然是链中的最后一个mbuf。）
- en: If the packet described by `rxr->rx_base[i]` contains any ![](httpatomoreillycomsourcenostarchimages1137515.png)
    errors, it is ![](httpatomoreillycomsourcenostarchimages1137517.png) discarded.
    Note that I use the word *packet*, not *mbuf*, here, because every mbuf in the
    packet is discarded.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 如果由`rxr->rx_base[i]`描述的包包含任何![错误](http://atomoreilly.com/source/nostarch/images/1137515.png)，则![丢弃](http://atomoreilly.com/source/nostarch/images/1137517.png)。请注意，在这里我使用的是单词*包*，而不是*mbuf*，因为包中的每个
    mbuf 都被丢弃。
- en: 'Now let’s look at the next part of `em_rxeof`:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们看看`em_rxeof`的下一部分：
- en: '[PRE2]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Here, ![](httpatomoreillycomsourcenostarchimages1137505.png) `rxr->fmp` and
    ![](httpatomoreillycomsourcenostarchimages1137507.png) `rxr->lmp` point to the
    first and last mbuf in the chain, ![](httpatomoreillycomsourcenostarchimages1137499.png)
    `mp` is the mbuf described by `rxr->rx_base[i]`, and ![](httpatomoreillycomsourcenostarchimages1137501.png)
    `len` is `mp`’s length.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，![rxr->fmp](http://atomoreilly.com/source/nostarch/images/1137505.png)和![rxr->lmp](http://atomoreilly.com/source/nostarch/images/1137507.png)指向链中的第一个和最后一个
    mbuf，![mp](http://atomoreilly.com/source/nostarch/images/1137499.png)是`rxr->rx_base[i]`描述的
    mbuf，![len](http://atomoreilly.com/source/nostarch/images/1137501.png)是`mp`的长度。
- en: So, this part simply ![](httpatomoreillycomsourcenostarchimages1137503.png)
    identifies whether `mp` is the first mbuf in the chain. If it is not, then `mp`
    is ![](httpatomoreillycomsourcenostarchimages1137509.png) ![](httpatomoreillycomsourcenostarchimages1137511.png)
    linked into the chain.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，这部分只是![识别](http://atomoreilly.com/source/nostarch/images/1137503.png)是否`mp`是链中的第一个
    mbuf。如果不是，则`mp`![被链接](http://atomoreilly.com/source/nostarch/images/1137509.png)![到链中](http://atomoreilly.com/source/nostarch/images/1137511.png)。
- en: 'Here is the next part of `em_rxeof`:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是`em_rxeof`的下一部分：
- en: '[PRE3]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: If `mp` is the ![](httpatomoreillycomsourcenostarchimages1137499.png) last mbuf
    in the chain, ![](httpatomoreillycomsourcenostarchimages1137501.png) `sendmp`
    is set to the ![](httpatomoreillycomsourcenostarchimages1137503.png) first mbuf
    in the chain, and the header checksum is ![](httpatomoreillycomsourcenostarchimages1137505.png)
    verified.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 如果`mp`是链中的![最后一个 mbuf](http://atomoreilly.com/source/nostarch/images/1137499.png)，则![sendmp](http://atomoreilly.com/source/nostarch/images/1137501.png)被设置为链中的![第一个
    mbuf](http://atomoreilly.com/source/nostarch/images/1137503.png)，并且验证了头部校验和。
- en: If our architecture requires ![](httpatomoreillycomsourcenostarchimages1137507.png)
    strict alignment and ![](httpatomoreillycomsourcenostarchimages1137509.png) jumbo
    frames are enabled, `em_rxeof` ![](httpatomoreillycomsourcenostarchimages1137511.png)
    aligns the mbuf chain. (Jumbo frames are Ethernet packets with more than 1500
    bytes of data.)
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们的架构需要![严格对齐](http://atomoreilly.com/source/nostarch/images/1137507.png)并且启用了![巨帧](http://atomoreilly.com/source/nostarch/images/1137509.png)，则`em_rxeof`![对齐](http://atomoreilly.com/source/nostarch/images/1137511.png)
    mbuf 链。 (巨帧是包含超过1500字节数据的以太网数据包。)
- en: 'This part concludes by setting ![](httpatomoreillycomsourcenostarchimages1137513.png)
    `rxr->fmp` and ![](httpatomoreillycomsourcenostarchimages1137515.png) `rxr->lmp`
    to ![](httpatomoreillycomsourcenostarchimages1137517.png) `NULL`. Here is the
    next part of `em_rxeof`:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 这一部分通过设置![rxr->fmp](http://atomoreilly.com/source/nostarch/images/1137513.png)和![rxr->lmp](http://atomoreilly.com/source/nostarch/images/1137515.png)为![NULL](http://atomoreilly.com/source/nostarch/images/1137517.png)来结束。以下是`em_rxeof`的下一部分：
- en: '[PRE4]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Here, `i` is ![](httpatomoreillycomsourcenostarchimages1137499.png) incremented
    so that `em_rxeof` can get to the next mbuf in the ring. Then, ![](httpatomoreillycomsourcenostarchimages1137501.png)
    if `sendmp` points to an mbuf chain, `em(4)`’s input routine is ![](httpatomoreillycomsourcenostarchimages1137503.png)
    executed to send that ![](httpatomoreillycomsourcenostarchimages1137505.png) chain
    to the upper layers. Afterward, new mbufs are ![](httpatomoreillycomsourcenostarchimages1137507.png)
    allocated for `em(4)`.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，`i`![递增](http://atomoreilly.com/source/nostarch/images/1137499.png)以便`em_rxeof`可以到达环中的下一个
    mbuf。然后，如果`sendmp`指向一个 mbuf 链，则执行`em(4)`的输入例程![来发送](http://atomoreilly.com/source/nostarch/images/1137503.png)该链到上层。之后，为`em(4)`![分配](http://atomoreilly.com/source/nostarch/images/1137507.png)新的
    mbuf。
- en: Note
  id: totrans-26
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: When an mbuf chain is sent to the upper layers, drivers must not access those
    mbufs anymore. For all intents and purposes, those mbufs have been freed.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 当将 mbuf 链发送到上层时，驱动程序不得再访问这些 mbuf。从所有目的和用途来看，这些 mbuf 已经被释放。
- en: To sum up, this `for` loop simply links together every mbuf in a received packet
    and then sends that to the upper layers. This continues until every packet in
    the ring has been processed or `rx_process_limit` is hit (`rx_process_limit` was
    described in [Packet Reception](ch17.html#packet_reception "Packet Reception")
    in [Packet Reception](ch17.html#packet_reception "Packet Reception")).
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 总结来说，这个 `for` 循环只是将接收到的数据包中的每个 mbuf 链接起来，并将其发送到上层。这个过程会一直持续，直到处理完环中的每个数据包或达到
    `rx_process_limit`（`rx_process_limit` 在 [数据包接收](ch17.html#packet_reception "数据包接收")
    中描述过）。
- en: 'Here is the final part of `em_rxeof`:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 `em_rxeof` 的最后部分：
- en: '[PRE5]'
  id: totrans-30
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: If there are more packets to process, `em_rxeof` ![](httpatomoreillycomsourcenostarchimages1137499.png)
    returns `TRUE`.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 如果还有更多数据包需要处理，`em_rxeof` 会返回 `TRUE`。
- en: em_handle_rx Function
  id: totrans-32
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: em_handle_rx 函数
- en: Recall that when `em_rxeof` returns TRUE, `em_msix_rx` queues a task structure
    (`em_msix_rx` was discussed in [Packet Reception](ch17.html#packet_reception "Packet
    Reception") in [Packet Reception](ch17.html#packet_reception "Packet Reception")).
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 回想一下，当 `em_rxeof` 返回 TRUE 时，`em_msix_rx` 会将一个任务结构排队（`em_msix_rx` 在 [数据包接收](ch17.html#packet_reception
    "数据包接收") 中讨论过）。
- en: 'Here is that `task` structure’s function:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 这是那个 `task` 结构的函数：
- en: '[PRE6]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: This function is nearly identical to `em_msix_rx`. When there are more packets
    to process, ![](httpatomoreillycomsourcenostarchimages1137499.png) `em_rxeof`
    just gets called again.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 此函数几乎与 `em_msix_rx` 相同。当有更多数据包需要处理时，`em_rxeof` 会被再次调用。
- en: Packet Transmission
  id: totrans-37
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 数据包传输
- en: 'To transmit a packet, the network stack calls a driver’s output routine. All
    output routines end by calling their interface’s transmit or start routine. Here
    is `em(4)`’s start routine:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 为了传输一个数据包，网络栈会调用驱动程序的输出例程。所有输出例程都以调用其接口的传输或启动例程结束。以下是 `em(4)` 的启动例程：
- en: '[PRE7]'
  id: totrans-39
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: This start routine ![](httpatomoreillycomsourcenostarchimages1137499.png) acquires
    a lock and then calls ![](httpatomoreillycomsourcenostarchimages1137501.png) `em_start_locked`.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 此启动例程会获取一个锁，然后调用 `em_start_locked`。
- en: em_start_locked Function
  id: totrans-41
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: em_start_locked 函数
- en: 'The `em_start_locked` function is defined as follows:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: '`em_start_locked` 函数的定义如下：'
- en: '[PRE8]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'This function ![](httpatomoreillycomsourcenostarchimages1137509.png) removes
    one ![](httpatomoreillycomsourcenostarchimages1137513.png) mbuf from `em(4)`’s
    ![](httpatomoreillycomsourcenostarchimages1137511.png) send queue and ![](httpatomoreillycomsourcenostarchimages1137515.png)
    transmits it to the interface. This repeats until the send queue is ![](httpatomoreillycomsourcenostarchimages1137499.png)
    empty. (Send queues, as mentioned in [Chapter 16](ch16.html "Chapter 16. Network
    Drivers, Part 1: Data Structures"), are populated by output routines.)'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 此函数从 `em(4)` 的发送队列中移除一个 mbuf 并将其传输到接口。这个过程会一直重复，直到发送队列为空。（发送队列，如第 16 章所述，由输出例程填充。）
- en: Note
  id: totrans-45
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: The `em_xmit` function, which actually transmits the mbufs to the interface,
    is not detailed in this book, because of its length. It is fairly straightforward,
    though, so you shouldn’t have any trouble with it.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 实际将 mbuf 传输到接口的 `em_xmit` 函数在本书中没有详细说明，因为其长度较长。尽管如此，它相当直接，所以你不会遇到任何麻烦。
- en: If the number of available transmit descriptors is ![](httpatomoreillycomsourcenostarchimages1137501.png)
    less than or equal to `EM_TX_CLEANUP_THRESHOLD`, ![](httpatomoreillycomsourcenostarchimages1137503.png)
    `em_txeof` is called to reclaim the used descriptors. (A transmit descriptor describes
    an outgoing packet. If a packet spans multiple mbufs, a transmit descriptor describes
    one mbuf in the chain.)
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 如果可用的传输描述符数量小于或等于 `EM_TX_CLEANUP_THRESHOLD`，则会调用 `em_txeof` 来回收已使用的描述符。（传输描述符描述一个出站数据包。如果一个数据包跨越多个
    mbuf，则传输描述符描述链中的一个 mbuf。）
- en: If the number of available transmit descriptors is ![](httpatomoreillycomsourcenostarchimages1137505.png)
    less than `EM_MAX_SCATTER`, transfers are ![](httpatomoreillycomsourcenostarchimages1137507.png)
    stopped.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 如果可用的传输描述符数量小于 `EM_MAX_SCATTER`，则传输会被停止。
- en: em_txeof Function
  id: totrans-49
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: em_txeof 函数
- en: 'The `em_txeof` function goes through the transmit descriptors and frees the
    mbufs for packets that have been transmitted. Its function definition is listed
    below, but because this function is fairly long and involved, I’ll introduce it
    in parts. Here is the first part:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: '`em_txeof` 函数遍历传输描述符，并为已传输的数据包释放 mbufs。其函数定义如下，但由于这个函数相当长且复杂，我将分部分介绍。以下是第一部分：'
- en: '[PRE9]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Here, ![](httpatomoreillycomsourcenostarchimages1137499.png) `first` is the
    first mbuf in a chain that housed an outgoing packet, ![](httpatomoreillycomsourcenostarchimages1137505.png)
    `last` is the last mbuf in that chain, and ![](httpatomoreillycomsourcenostarchimages1137507.png)
    `done` is the mbuf after `last`.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，![](httpatomoreillycomsourcenostarchimages1137499.png) `first` 是包含传出数据包的链中的第一个
    mbuf，![](httpatomoreillycomsourcenostarchimages1137505.png) `last` 是该链中的最后一个 mbuf，而
    ![](httpatomoreillycomsourcenostarchimages1137507.png) `done` 是 `last` 之后的 mbuf。
- en: Note
  id: totrans-53
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Recall that transmit descriptors, and subsequently mbufs, are held in a ring
    buffer.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 回想一下，传输描述符以及随后的 mbufs 都存储在一个环形缓冲区中。
- en: The variables ![](httpatomoreillycomsourcenostarchimages1137501.png) `tx_desc`
    and ![](httpatomoreillycomsourcenostarchimages1137503.png) `tx_buffer` are temporary
    variables for a transmit descriptor and its associated mbuf.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 变量 ![](httpatomoreillycomsourcenostarchimages1137501.png) `tx_desc` 和 ![](httpatomoreillycomsourcenostarchimages1137503.png)
    `tx_buffer` 是传输描述符及其相关 mbuf 的临时变量。
- en: 'Now let’s look at the next part of `em_txeof`:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们来看 `em_txeof` 的下一部分：
- en: '[PRE10]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: This ![](httpatomoreillycomsourcenostarchimages1137501.png) `while` loop iterates
    through `first` to `last`, ![](httpatomoreillycomsourcenostarchimages1137505.png)
    freeing their mbufs and ![](httpatomoreillycomsourcenostarchimages1137503.png)
    zeroing their transmit descriptors. (`em(4)` has a finite number of transmit descriptors.
    Zeroing a descriptor makes it available again.)
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 这个 ![](httpatomoreillycomsourcenostarchimages1137501.png) `while` 循环遍历 `first`
    到 `last`，![](httpatomoreillycomsourcenostarchimages1137505.png) 释放它们的 mbufs 和
    ![](httpatomoreillycomsourcenostarchimages1137503.png) 将它们的传输描述符置零。（`em(4)` 有一个有限的传输描述符数量。将描述符置零使其再次可用。）
- en: This ![](httpatomoreillycomsourcenostarchimages1137499.png) `while` loop ![](httpatomoreillycomsourcenostarchimages1137507.png)
    determines whether another mbuf chain can be freed by this ![](httpatomoreillycomsourcenostarchimages1137501.png)
    `while` loop.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 这个 ![](httpatomoreillycomsourcenostarchimages1137499.png) `while` 循环 ![](httpatomoreillycomsourcenostarchimages1137507.png)
    判断是否可以通过这个 ![](httpatomoreillycomsourcenostarchimages1137501.png) `while` 循环释放另一个
    mbuf 链。
- en: 'Here is the final part of `em_txeof`:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 `em_txeof` 的最后一部分：
- en: '[PRE11]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: If there are more transmit descriptors to reclaim, `em_txeof` returns ![](httpatomoreillycomsourcenostarchimages1137505.png)
    `TRUE`; otherwise, it returns ![](httpatomoreillycomsourcenostarchimages1137503.png)
    `FALSE`.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 如果还有更多要回收的传输描述符，`em_txeof` 返回 ![](httpatomoreillycomsourcenostarchimages1137505.png)
    `TRUE`；否则，它返回 ![](httpatomoreillycomsourcenostarchimages1137503.png) `FALSE`。
- en: If the number of available transmit descriptors is ![](httpatomoreillycomsourcenostarchimages1137499.png)
    greater than `EM_MAX_SCATTER`, packets ![](httpatomoreillycomsourcenostarchimages1137501.png)
    can be transmitted.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 如果可用传输描述符的数量 ![](httpatomoreillycomsourcenostarchimages1137499.png) 大于 `EM_MAX_SCATTER`，则可以传输数据包。
- en: Post Packet Transmission
  id: totrans-64
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 数据包传输后
- en: 'Whenever an interface transmits a packet, it sends an interrupt. Naturally,
    this causes its interrupt handler to execute. Here is what executes in `em(4)`:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 每当接口发送一个数据包时，它会发送一个中断。自然地，这会导致其中断处理程序执行。以下是 `em(4)` 中执行的内容：
- en: '[PRE12]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Note
  id: totrans-67
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Because of MSI, `em(4)` can use a different interrupt handler for post packet
    transmission and packet reception.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 由于 MSI，`em(4)` 可以使用不同的中断处理程序来处理数据包传输和接收。
- en: 'This function simply ![](httpatomoreillycomsourcenostarchimages1137499.png)
    reclaims the used transmit descriptors. If there are more descriptors to reclaim,
    a `task` structure is ![](httpatomoreillycomsourcenostarchimages1137501.png) queued.
    Here is that `task` structure’s function:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 这个函数简单地 ![](httpatomoreillycomsourcenostarchimages1137499.png) 回收已使用的传输描述符。如果有更多描述符要回收，则将一个
    `task` 结构排队。以下是该 `task` 结构的函数：
- en: '[PRE13]'
  id: totrans-70
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: This function first ![](httpatomoreillycomsourcenostarchimages1137499.png) reclaims
    any used transmit descriptors, after which any packets that may have been halted
    due to a lack of descriptors are ![](httpatomoreillycomsourcenostarchimages1137501.png)
    transmitted.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 这个函数首先 ![](httpatomoreillycomsourcenostarchimages1137499.png) 回收任何已使用的传输描述符，之后，任何可能由于描述符不足而暂停的包将被
    ![](httpatomoreillycomsourcenostarchimages1137501.png) 传输。
- en: Conclusion
  id: totrans-72
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 结论
- en: 'This chapter and [Chapter 16](ch16.html "Chapter 16. Network Drivers, Part
    1: Data Structures") gave a primer on network devices and drivers. If you’re serious
    about writing network drivers, you should review `em(4)` in its entirety. I recommend
    beginning with its `device_attach` implementation: `em_attach`.'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 本章和[第16章](ch16.html "第16章。网络驱动程序，第一部分：数据结构")介绍了网络设备和驱动程序的基础知识。如果你认真对待编写网络驱动程序，你应该全面复习`em(4)`。我建议从它的`device_attach`实现开始：`em_attach`。
