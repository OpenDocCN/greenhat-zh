# 引言

周一早上十点钟。分支机构老板怒火中烧。他已经等了几个小时，等待一封重要的电子邮件，但它仍然没有到达。这一定是邮件服务器的错；它可能又出故障了。但快速检查电脑显示，那里没有邮件在队列中，日志文件中也没有提到相关发件人的邮件已到达。那么问题出在哪里？

公司的核心邮件服务器对**`ping`**无响应。这可能是问题的根源。但公司总部 IT 部门坚决否认责任。它也无法 ping 通分支机构的邮件节点，但它坚持认为总部网络运行正常，因此问题一定出在分支机构网络。错误搜索仍在继续...

令人羞愧的结果：连接到总部的 VPN 连接已中断，尽管 ISDN 备份连接正在工作，但在备份路由器中并未定义通往总部（以及中央邮件服务器）的路由。一个全球运营的 IT 服务提供商负责分支机构与总部之间的网络连接（VPN 和 ISDN），对于他们来说，类似的事情“根本就不会发生”。最终结果：花费数小时寻找错误，一个愤怒的老板（紧急需要的会议早已结束），以及一个满头大汗的管理员。

在一个正确配置的 Nagios 系统中，管理员会在早上八点就已经注意到问题，并在几分钟内就能找出其根源。这样一来，就不会浪费宝贵的时间，可以直接通知 IT 服务提供商。消除错误（在这个案例中，半小时）所需的时间足以及时发送电子邮件。

第二个例子：在德国某地，存储医院中央 Oracle 数据库日志文件的那个硬盘已达到满容量。尽管这不会导致手术室“灯火管制”，但数据库停止工作，工作流程受到很大干扰：患者无法入院，检查结果无法保存，报告无法记录，直到问题得到解决。

如果关键的硬盘驱动器被 Nagios 监控，IT 部门会在早期阶段收到警告。问题甚至可能根本就不会发生。

随着人力资源越来越稀缺，没有任何 IT 部门真的能负担得起定期手动检查所有系统。尤其是日益复杂的网络，特别需要提前了解已发生的故障或即将发生的问题。Nagios，一个开源的系统和网络监控工具，帮助管理员在电话铃响之前发现问题。

软件的目标是快速通知管理员有关可疑（警告）或关键条件（关键）。什么被视为“可疑”或“关键”由管理员在配置中定义。网页摘要随后通知管理员正常工作的系统和服务的状态，Nagios 用绿色显示，可疑条件（黄色），以及关键情况（红色）。还有可能根据具体服务或系统选择性地通过电子邮件或通过诸如短信之类的呼叫服务通知管理员。

通过专注于交通灯状态（绿色、黄色、红色），Nagios 与显示已过时间图形（例如，在 WAN 接口的负载或整个一天的 CPU）或记录和测量网络流量（特定接口上 HTTP 的比例有多高？）的网络工具不同。Nagios 直接简单地处理是否一切正常的问题。软件在这方面做得很好，不仅限于当前状态，而且也涉及长期时间。

# 测试

在检查关键主机和服务时，Nagios 区分主机检查和服务检查。*主机检查*测试一台计算机，在 Nagios 术语中称为*主机*，以检查其可达性——通常使用简单的**`ping`**。*服务检查*选择性地测试单个网络服务，如 HTTP、SMTP、DNS 等，以及运行中的进程、CPU 负载或日志文件。只要主机上有一个服务可以访问，那么这基本上对该计算机整体有效，因此可以省略这个测试。Nagios 在不规则和必要时执行主机检查，例如，如果监控的主机上没有要监控的服务可以访问。

网络服务的最简单测试是查看相关目标端口是否开放，以及是否有服务在那里监听。但这并不一定意味着，例如，SSH 守护进程确实正在 TCP 端口 22 上运行。因此，Nagios 使用多种服务测试，这些测试要深入几步。例如，对于 SMTP，软件还会测试邮件服务器是否通过“220”输出自我宣布，即所谓的*SMTP 问候*；而对于 PostgreSQL 数据库，它会检查是否接受 SQL 查询。

Nagios 之所以特别有趣，是因为它考虑了网络拓扑中的依赖关系（如果配置了这样做的话）。如果目标系统只能通过一个刚刚宕机的特定路由器访问，那么 Nagios 会报告目标系统“不可达”，并且不会进一步对其进行主机和服务检查。软件使管理员能够更快地发现实际原因并纠正情况。

# 信息供应商

Nagios 的强大之处——即使在与其他网络监控工具的比较中——也在于其模块化结构。Nagios 核心不包含单个测试。相反，它使用外部程序进行服务和主机检查，这些程序被称为*插件*。基本设备已经包含了一些标准插件，用于最重要的应用场景。超出这些范围的特殊需求，如果你具备基本的编程知识，可以通过编写自己的插件来满足。然而，在投入时间开发这些插件之前，首先值得在网上浏览相关邮件列表，^([2]) 因为在这个领域有活跃的活动。可用的插件很多，尤其是在 Nagios Exchange 平台，[`www.nagiosexchange.org/`](http://www.nagiosexchange.org/)。

插件是一个简单的程序——通常是 shell 脚本（Bash、Perl 等）——它提供四种可能的状态之一：OK、WARNING、CRITICAL 或（例如，在操作错误的情况下）UNKNOWN。

这意味着在原则上，Nagios 可以测试所有可以电子测量或计数的对象：服务器室中的温度和湿度、降雨量、在不应有人进入的某个房间中的人员存在。只要你能找到一种方法提供可以由计算机评估的测量数据或事件作为信息（例如，使用温度和湿度传感器、红外传感器等），就没有限制。除了标准插件外，本书还相应地介绍了其他免费可用的插件，例如在第二十一章（Chapter 21）中，从第 505 页介绍如何使用插件查询温度和湿度传感器。

* * *

^([2]) [`www.nagios.org/support/mailinglists.php`](http://www.nagios.org/support/mailinglists.php)

# 保持管理员信息更新

Nagios 拥有一个复杂的通知系统。在发送方（即，与主机或服务检查）方面，你可以配置何时通知每个人员组——所谓的*联系人组*——关于哪些条件或事件（故障、恢复、警告等）。在接收方，你还可以在多个级别上定义对相应消息的处理方式——例如，根据一天中的时间，系统是否应该转发它，或者丢弃该消息。

如果一个特定服务需要每周七天全天候监控，这并不意味着负责的管理员永远不会休息。例如，您可以指示 Nagios 只在周一至周五上午 8 点至下午 5 点之间，每隔两小时通知相关人员。如果负责的管理员在指定的时间内无法解决问题，例如八小时，那么部门负责人应该收到消息。这个过程被称为*升级管理*。相应的配置在第十二章中有解释。

Nagios 还可以利用自由配置的外部程序进行通知，这样您就可以集成任何喜欢的系统，从电子邮件到短信，甚至是一个管理员可以调用并接收有关错误语音消息的语音服务器。

通过其 Web 接口（第十六章]），尽管面临越来越多的竞争，但它仍然非常受欢迎。一个相对较新但非常强大的替代品是 Cacti^([5]）：它具有更广泛的应用范围，可以通过 Web 界面进行配置，并避免了 MRTG 的限制，MRTG 只能同时显示两个测量值，并且不能显示任何负值。另一个有趣的新替代品是 Munin.^([6])

Nagios 本身也可以使用扩展（第十九章图形显示性能数据]) [`www.bb4.org/`](http://www.bb4.org/)

^([4]) [`www.mrtg.org/`](http://www.mrtg.org/)

^([5]) [`www.cacti.net/`](http://www.cacti.net/)

^([6]) [`munin.projects.linpro.no/`](http://munin.projects.linpro.no/)

# 关于本书

本书面向希望使用开源工具了解其系统和网络状况的网络管理员。它描述了 Nagios 的 2.x 和 3.0 版本。另一方面，插件有自己的生活，在很大程度上独立于 Nagios，因此不受特定版本的限制。

尽管本书基于使用 Linux 作为 Nagios 计算机的操作系统，但这并不是一个必要条件。大多数描述也适用于其他 Unix 系统，^([7])只需要相应地调整系统特定的细节，例如启动脚本。然而，Nagios 目前尚未在 Windows 上官方运行.^([8])

本书的第一部分主要介绍如何以最简单的方式快速配置 Nagios，尽管这种配置对于许多用途来说已经足够，但仍然需要尽快完成。这就是为什么从第一章到第三章没有对所有选项和功能进行详细描述和处理。这些内容将在书的第二部分进行探讨。

第四章探讨了服务和主机检查的细节，特别是介绍了它们对网络拓扑的依赖性。

第五章描述了 Nagios 实现服务检查和获取其结果的可选方案。

接下来，本书将介绍个别标准插件以及一些额外可免费获取的插件。第六章探讨了直接从 Nagios 主机检查网络协议服务的插件，而第七章总结了需要在被监控机器上安装的插件，并且 Nagios 需要额外的工具来使它们运行。在第八章中介绍了几个辅助插件，这些插件本身不执行任何测试，但会操纵已经建立的结果。

在接下来的两个章节中，介绍了 Nagios 运行远程主机上的本地插件所需的两个工具。第九章描述了 SSH，而第十章介绍了一个专门为 Nagios 开发的守护进程。

无论在何处监控网络，都需要实现 SNMP。第十一章不仅描述了具有 SNMP 功能的插件，而且还详细探讨了协议和 SNMP 世界本身，提供了进行此操作所需的相关背景知识。

第十二章介绍了 Nagios 通知系统，同时也涉及了使用短信进行通知、升级管理以及考虑依赖关系。

外部命令的接口在第十三章中进行了讨论。这构成了其他 Nagios 机制的基础，例如 Nagios 服务检查接受器（NSCA），一种用于传输被动测试结果的客户端-服务器机制，在第十四章第十四章。Nagios 服务检查接受器（NSCA）中进行了介绍。这种用法在两个具体示例中得到了展示——集成**`syslog-ng`**和处理 SNMP 陷阱。NSCA 也是分布式监控的要求，在第十五章第十五章。分布式监控中进行了讨论。

书的第三部分致力于如何将提取的信息以图形方式表示。第十六章第十六章。经典 Web 界面详细解释了这是如何工作的以及如何设置，并辅以一些有用的截图。它还解释了一系列参数，这些参数在其他地方几乎没有文档，除了在源代码中。

通过添加外部应用程序，可以扩展 Nagios。NDOUtils 允许将所有 Nagios 对象以数据库驱动的方式存储，并在第十七章第十七章。使用 NDOUtils 的灵活 Web 界面中进行了描述。使用第十八章第十八章。NagVis 中描述的附加组件连接到数据库，您就可以构建一个可以配置远超 Nagios 基本范围的 Web 界面。

尽管在操作中，Nagios 主要关注交通信号灯信号（红-黄-绿），但有一些方法可以评估和表示插件提供的性能数据，这些方法在第十九章第十九章。性能数据的图形显示中进行了详细描述。

本书第四部分致力于特殊应用。网络很少是同质的——也就是说，只配备了 Linux 和其他基于 Unix 的操作系统。因此，第二十章第二十章。监控 Windows 服务器展示了可以用来集成和监控 Windows 系统的工具。

第二十一章第二十一章。监控室温和湿度使用低成本硬件传感器的例子来展示如何简单而有效地监控室温和湿度。

只要插件中存在可以查询集成到插件中的系统状态的机制，Nagios 也可以监控专有商业软件。在第二十二章第二十二章。监控 SAP 系统中，这是使用 SAP-R/3 系统进行描述的。

尽管事件处理在第十四章第十四章。Nagios 服务检查接受器（NSCA）中只是简要概述，但在第二十三章第二十三章。使用 EventDB 处理事件中介绍了一种数据库支持的方法，它提供了更多选择来选择和处理事件，包括与 Nagios 的互连。

本书第五部分探讨了构建自己的插件。第二十四章编写自己的插件探讨了标准插件的一般要求，而第二十五章确定文件和目录大小则通过一个逐步示例展示了如何编写适合发布的自己的插件。第二十六章以 Oracle 的即时客户端为例，演示了如何基于并非真正为此目的而设计的程序构建自己的插件。

附录 A 介绍了两个核心配置文件**`nagios.cfg`**和**`cgi.cfg`**的所有参数，而附录 B 和附录 C 则专注于一些有用但相对罕见的特性。

专门的附录附录 D 专注于*宏*，它允许在配置中具有灵活性。

附录 E 略有偏离 Nagios 的核心主题，并演示了单点登录场景也可以用于 Nagios Web 界面的认证。

环境越大，拥有一个强大且反应迅速的 Nagios 系统就越重要。附录 F 提供了一系列建议，而附录 G 则专注于一个特定的工具，即集成到 Nagios 中的 Perl 解释器。

最后，附录 H 简要总结了自 Nagios 2.x 以来所做的所有更改。

* * *

^([7]) 例如，*BSD、HP-UX、AIX 和 Solaris；作者不知道有任何 Nagios 版本在 MacOS X 上运行。

^([8]) 然而，关于 Nagios 在 Cygwin 环境中运行的传闻。

# 关于本书的进一步说明

在本书付印时，Nagios 3.0 即将完成。到本书上市时，可能会有一些修改。有关修改的笔记，以及可能出现的错误，可以在[`linux.swobspace.net/books/nagios/`](http://linux.swobspace.net/books/nagios/)找到。

# 感谢信

许多人为本书的成功做出了贡献。首先我要感谢 Dr. Markus Wirtz，是他以评论“那你为什么不写一本 Nagios 的书呢？！”来启动这本书，当时他拒绝接受我的 Nagios 活动作为推迟写另一本书的借口。特别感谢 Patricia Jung，作为德语版的技术编辑，她彻底重写了手稿，并不断地用成千上万的问题来打扰我——这对书的完整性是有好处的，并且最终使读者更容易理解。

当然，没有书中描述的所有工具，这本书也是不可能完成的。特别感谢 Ethan Galstad，作为作者、开发者和维护者，他使 Nagios 成为今天的样子：一个令人敬畏的、极其有用和有帮助的工具，它也满足了高级要求，并且可以依赖一个非常庞大——更重要的是非常活跃——的社区。还要感谢 Ton Voon，他代表所有*Nagios 插件开发团队*的成员，他与同事们一起管理 Nagios 插件的开发。

我也要感谢那些不仅开发了本书中介绍的所有 Nagios 相关软件，还通过校对和反馈帮助润色和改进本书的人：Matthias Flacke（以**`check_multi`**闻名），Jörg Linge（PNP），以及 Steffen Waitz，他校对了第一版，Hendrik Bäcker（**`npcd`**），Lars Michelsen，Michael Luebben（NagVis），Gerhard Laußer（**`check_logfiles`**），以及 NETWAYS GmbH 的员工（NagiosGrapher，EventDB，交流平台，NagiosExchange）。

我无法列出所有以某种方式为 Nagios 成功做出贡献的个人。因此，我要感谢所有积极支持 Nagios 社区的人，无论是通过免费软件还是通过参与论坛和邮件列表。没有用户，Nagios 会是什么样子？
