## 第十二章。连接到网络

*我的隧道现在已启动*。

*我可以做 IPv6*。

*我和其他三个人*。

![图片](img/httpatomoreillycomsourcenostarchimages1616079.png) 所有的 IPv4 和 IPv6 理论都是好的。现在让我们实际操作一下，并连接到网络。虽然拨号连接与 OpenBSD 一起工作，但它们现在不太使用了，所以我们重点关注以太网连接。以太网是当今最常见的网络类型，也是 OpenBSD 系统上最常见的网络接口。

大多数人都有 IPv4 连接，但 IPv6 越来越重要。如果你无法将原生 IPv6 连接到你的网络，你可以使用隧道来访问 IPv6 地址空间，并为你的客户端提供 IPv6。我将在本章中介绍如何获取和配置这样的隧道。

最后，OpenBSD 可以将网络连接组合成 trunk 或将它们拆分成虚拟局域网 (VLAN)。本章将介绍这两种方法。

## DNS 解析

你可能想使用主机名而不是 IP 地址，这样你就可以浏览到 *[`www.cnn.com/`](http://www.cnn.com/)* 而不是 *[`157.166.255.18`](http://157.166.255.18)*。类 Unix 系统使用 *resolver* 来完成这个功能。

大多数主机使用两个工具在 IP 地址和主机名之间进行映射：*hosts* 文件和 DNS。（不同的操作系统支持额外的名称服务，如 YP、LDAP、NIS 等，但几乎每个系统都支持这两个。）

*hosts* 文件是本地机器上的一个文本文件，其中包含静态 IP 地址和主机名列表。DNS 是一个更动态的服务，它跨越网络查找信息。你可以通过 IP 地址指定 DNS 服务器，但我们将更详细地查看 *hosts* 文件。

如果你更喜欢 IPv4 或 IPv6 地址？或者你想让 *hosts* 文件覆盖 DNS？也许你有一个默认域名，你的查询应该使用。解析器会搜索，直到它找到第一个答案或者耗尽其信息来源，所以这些问题很重要。请在 */etc/resolv.conf* 中告诉解析器你的需求。

### /etc/resolv.conf 文件

你在 */etc/resolv.conf* 中配置解析器行为。没有 */etc/resolv.conf* 的系统只能找到 *hosts* 文件中列出的主机名。因为 *hosts* 文件一开始是空的，这可能不是你想要的。首先指定域名。

#### 默认搜索域名

如果你想要 ping 远程网络上的主机，你可能预计需要指定整个域名。输入 **`ping www.openbsd.org`** 应该可以工作。但如果你想要 ping 你公司的网站服务器，直接输入 **`ping www`** 会更有意义。而且你可以这样做，因为 OpenBSD 允许你指定默认域名，这样当你输入一个简短的域名时，它会尝试找到正确的主机。

例如，如果你只有一个本地域名，你可以在 */etc/resolv.conf* 中这样列出域名关键字：

```
domain michaelwlucas.com
```

现在，当我输入 `ping ftp` 时，解析器应该获取主机 *ftp.michaelwlucas.com* 的 IP 地址。

如果你有一个以上的本地域，请使用 `search` 关键字和域名列表，如下所示：

```
search michaelwlucas.com openbsd.org
```

如果我现在输入 `ping ftp`，解析器应该获取主机 *ftp.michaelwlucas.com* 的 IP 地址。一旦解析器了解到不存在这样的主机，它将检查 *ftp.openbsd.org*。因为该主机存在，`ping` 将开始工作。`search` 关键字可以有最多六个域，并且不能超过 1024 个字符。

#### 使用域名和搜索

你只能使用 `domain` 或 `search`。如果你两者都使用，文件中的最后一个条目将获胜。如果你列出多个搜索或域名行，文件中的最后一行将生效。以下是如何不这样做的方法：

```
search cnn.com openbsd.org
search sluggy.com michaelwlucas.com
domain blackhelicopters.org
```

你不妨删除两个 `search` 语句。解析器永远不会遍历这些域名列表；它将仅使用 `domain` 列表，因为它是最新的。

#### 域名服务器

现在解析器知道默认要检查哪些域，告诉它要使用哪些域名服务器。按 IP 地址顺序，每行列出每个域名服务器，每个域名服务器占一行。

```
nameserver 192.0.2.5
nameserver 198.51.100.5
nameserver 2001:db8::5
```

你可以按 IP 地址列出最多三个域名服务器。（`nameserver` 条目中的主机名不会工作，原因很明显。）

如果你的 *resolv.conf* 没有列出域名服务器，解析器应在本地机器上查找域名服务器。

#### 查找顺序

你可能从 DNS 或从 *hosts* 文件中获取主机信息。解析器应在找到查询答案后停止。如果你先检查 *hosts* 文件然后检查 DNS，*hosts* 文件中的条目将覆盖域名服务器。如果你在 *hosts* 文件之前检查域名服务器，*hosts* 文件仅在无 DNS 记录可用时使用。两种方法都有其用途，但默认情况下，解析器先检查 *hosts* 文件，然后检查 DNS。要反转此操作，请使用 `lookup` 关键字。

```
lookup bind file
```

`file` 选项代表 */etc/hosts*，而由于历史原因，`bind` 代表 DNS。（第一个 DNS 服务器软件是伯克利互联网名称域服务器，或 BIND。）反向（`file bind`）是默认设置，因此不需要明确指定它。

#### 优先 IP 协议

解析器默认先搜索 IPv4 记录，然后查找 IPv6 记录。要反转此操作，请使用 `family` 关键字。

```
family inet6 inet4
```

再次强调，反向是默认设置，因此在这种情况下不需要使用此关键字。

### /etc/hosts 文件

*/etc/hosts* 文件将 IP 地址与主机名匹配。虽然 *hosts* 文件非常简单，但其内容仅可在本地机器上访问。*hosts* 文件在小型私有网络中最有用，例如在你的家庭或测试实验室中。你也可以使用 *hosts* 文件来覆盖 DNS 服务器中的数据，例如当你想测试新系统时。

*/etc/hosts* 文件中的每一行代表一个主机。每行的第一个条目是一个 IP 地址。第二个是主机的完全限定域名。在这两个条目之后，你可以为该主机有任意数量的别名。我经常在行末添加注释，以井号（`#`）开头。

曾经有一段时间，我在家里有一个只有四台机器的小型网络：代理/防火墙、妻子的台式机、我的笔记本电脑和我在上面做愚蠢事情的崩溃机器。*hosts*文件看起来像这样：

```
192.0.2.1 **1**nat.blackhelicopters.org    **2**nat firewall gateway
192.0.2.8   boss.blackhelicopters.org     boss wife  **3**#don't crash
192.0.2.20  crashbox.blackhelicopters.org crashbox test
192.0.10.21 laptop.blackhelicopters.org   laptop mwlucas
```

在**1**处的机器`nat.blackhelicopters.org`也有`firewall`和`gateway`的名称**2**。我在**3**处添加了一个笔记提醒自己不要对我的妻子的台式机运行安全扫描器。（机器`crashbox`也被称为`test`。）

任何具有此*hosts*表的机器都可以通过名称找到*hosts*表中列出的任何机器。例如，我可以运行`ping boss`或`ssh crashbox`来访问目标机器。

*hosts*文件在查找网络主机方面工作得很好，但每次添加、删除或更改一台机器时，你都必须在每个计算机上编辑*/etc/hosts*。每次更改 IP 地址时，你都必须在每个机器上编辑*/etc/hosts*。

### 注意

不幸的是，*/etc/hosts*无法扩展。当我得到第五台机器时，我添加了一个仅限内部使用的 DNS 服务器，并清空了我所有系统上的*hosts*文件。

### 解析器与动态配置

如果你的 OpenBSD 系统像笔记本电脑一样在多个网络之间移动，你可能使用 DHCP 来配置你的网络连接。

DHCP 会覆盖*/etc/resolv.conf*，用其网络的信息。这对于大多数用户来说是合适的，但如果你携带的是 OpenBSD 笔记本电脑，你就不是普通人。你可能希望你的解析器配置（如你的域名搜索列表）在无论你连接到哪个网络时都保持有效。

OpenBSD 支持在文件*/etc/resolv.conf.tail*中进行永久解析器配置。当 OpenBSD 的 DHCP 客户端从服务器获取*/etc/resolv.conf*信息时，它会写入*/etc/resolv.conf*并在末尾添加`/etc/resolv.conf.tail`。

记得只有最后一个`search`或`domain`关键字有效吗？*resolv.conf.tail*利用了这一点，允许你覆盖你的网络管理员的搜索顺序。

## 以太网

以太网是一个共享网络，意味着许多不同的机器可以连接到同一个以太网，并且可以直接相互通信。我将假设你使用的是在普通办公室或数据中心中找到的以太网。此外，尽管以太网已经在许多不同的物理媒体上实现，但我将假设你正在使用 CAT5 或更好的电缆——这是今天最受欢迎的选择。如果你使用一些不寻常的媒体类型，或者你的网卡支持多种媒体，你可能需要在你的接口上手动设置首选媒体。

### 协议和硬件

以太网是一种*广播协议*，这意味着你发送的每个数据包都可以发送到网络上的每个主机（尽管大多数以太网硬件限制了接收者）。要么是你的网卡，要么是你的设备驱动程序将为你计算机打算接收的数据与其他计算机打算接收的数据分开。一个所有主机都可以直接与其他所有主机通信的以太网部分，而不涉及路由器，被称为*冲突域*或*段*。

您可以使用*hubs*连接以太网段，这些是硬件设备，可以物理连接多个以太网主机。网络集线器将所有接收到的帧转发到所有其他网络设备，每个主机负责过滤流量。这是老式的以太网，对于调试网络问题可能很有用。

*交换机*在很大程度上取代了集线器。每个以太网连接都需要一个唯一的标识符，称为*MAC 地址*（有时也称为*以太网地址*），它是一个 48 位的数字。交换机通过过滤连接设备的 MAC 和 IP 地址来控制发送到每个主机的流量，并且（主要）只将帧转发到它们打算发送到的设备。交换机通过减少每个主机必须处理的流量量来减少每个系统的流量和负载。

在 i386 和 amd64 硬件上，MAC 地址是卡的一个属性。在某些其他平台上，例如 SPARC，MAC 地址是服务器本身的属性。IPv4 和 IPv6 都使用 MAC 地址在本地网络上找到其他主机。

#### IPv4 和 ARP

当一个系统需要向本地以太网上的另一个基于 IP 的主机传输数据时，它首先广播一个以太网请求，询问：“哪个 MAC 地址负责这个 IP 地址？”如果有一个主机响应，则将针对该 IP 的进一步数据传输到该 MAC 地址。这个过程由 ARP 处理。

使用`arp(8)`查看您系统的 ARP 表，这是您系统所知的宿主机的列表。输入`arp -a`以显示您的计算机所知的所有 MAC 地址和 IPv4 主机名。

```
$ **arp -a**
fly.blackhelicopters.org (192.0.2.225) at 00:a0:c8:10:eb:82 on fxp0
caddis.blackhelicopters.org (192.0.2.226) at 00:16:36:c0:58:a5 on fxp0 static
treble.blackhelicopters.org (192.0.2.227) at 00:0c:42:5a:58:ae on fxp0
salmon.blackhelicopters.org (192.0.2.232) at (incomplete) on fxp0
```

在这里，您可以看到与我以太网网络上的这个主机通信的三个主机。我还有更多的主机，但由于这台机器最近没有与它们交谈，它们不在本地 ARP 表中。

如果 MAC 地址显示为`incomplete`，则表示您的计算机已尝试与此主机通信，但无法获取其 MAC 地址。在这个例子中，我尝试向主机`salmom`发送数据，但我的计算机无法到达它。（重新开启`salmom`可能会有帮助。）

#### IPv6 和邻居发现

IPv6 主机也使用 MAC 地址通过 ND（在上一章中引入的 IPv6 协议）找到彼此。使用`ndp(8)`查询您的 ND 缓存。`ndp`使用的命令行标志故意与`arp`的类似。

```
$ **ndp -a**
Neighbor                             Linklayer Address  Netif Expire    S Flags
2001:db8:0:12:20c:29ff:feb5:7565     0:c:29:b5:75:65    vic0  permanent R
2001:db8:0:12:5446:fbc:fca0:f2e9     0:c:29:b5:75:65    vic0  permanent R
…
fe80::20c:29ff:feb5:7565%vic0        0:c:29:b5:75:65    vic0  permanent R
fe80::20c:42ff:fe20:7f42%vic0        0:c:42:20:7f:42    vic0  11h20m47s S R
fe80::1%lo0                          (incomplete)       lo0   permanent R
```

与 ARP 缓存一样，ND 缓存显示了每个主机的 IPv6 地址、物理地址、接口和其他详细信息。您将看到的 ND 条目比 ARP 条目多，因为所有链路本地地址都显示在 ND 缓存中。

如果您尝试连接到直接连接到您本地网络的主机，但它没有响应，请检查 ND 缓存。如果 ND 缓存条目显示为`(incomplete)`，就像 ARP 一样，存在某种基本的连接问题。

#### 速度和双工

以太网支持多种速度。您今天可能找到的最慢速度是每秒 10 兆比特（Mbps），但它正在迅速消失。大多数人使用 10/100Mbps 或每秒 1 千兆位（Gbps），尽管您会看到 10Gbps、40Gbps 和 100Gbps 以太网的出现。

您的网络上的主机和与之连接的交换机必须就其连接速度达成一致。如果 OpenBSD 主机认为它连接在 100Mbps，但交换机认为连接是 1Gbps，连接将会不稳定。虽然 *自动协商* 通常会使双方就共同设置达成一致（并且对于千兆连接来说是绝对必要的），但您可以为 10/100Mbps 连接手动设置双工和速度。尽管一些交换机厂商因自动协商不佳而臭名昭著，但只要可能，您应该让以太网自行配置。

*双工* 决定了一张卡是否可以同时发送和接收数据。*半双工* 连接意味着在某一时刻，以太网卡要么在发送要么在接收；它不能同时进行。*全双工* 连接可以同时发送和接收。就像连接速度一样，如果交换机和主机在双工设置上不一致，连接将会不稳定。千兆以太网连接涉及的内容远不止速度和双工，它们*必须*进行自动协商。

仅因为一个设备声称它可以使用定义为 10/100Mbps 以太网的协议，并不意味着它可以以任何速度使用该协议。此外，标有“1Gbps”的卡实际上可能无法每秒传输千兆位。一些网卡会传输其声明的流量，而其他网卡则会在该流量的几百分比处犹豫不决。交换机的质量也参差不齐。

如果您将以太网声明的速度视为一种语言，这可能更有意义。例如，我可以声称我会说俄语和德语，但我从 1985 年起就停止学习外语了。当我 2007 年去德国时，我每分钟只能管理大约三个单词——借助翻译卡和短语书。如果我是以太网卡，制造商会声称我会说德语和俄语，并将我运往西伯利亚。^([33)]

获取合适的硬件。不过，不要在 OpenBSD 邮件列表上询问。过去几个月有人询问过硬件推荐。检查存档。建议没有变化。

## 配置以太网

当为客户端计算机配置以太网时，如果您的 IPv4 网络提供 DHCP，您应该可以直接连接。如果您使用 IPv6，您应该可以连接电缆并让自动配置接管。

如果一台特定的机器将作为服务器，静态 IP 地址可能更有意义。在分配静态地址之前，您需要以下信息：

+   一个 IP 地址（IPv4、IPv6 或两者兼有）

+   子网掩码/前缀长度

+   默认网关的 IP 地址

带着这些信息，将您的系统连接到网络并继续阅读。我首先将讨论如何使用 `ifconfig(8)` 和 `route(8)` 手动执行更改，然后回顾如何在启动时自动设置这些更改。无论如何，您必须配置解析器，如本章开头所述。

### 使用 ifconfig(8)

如果您通过网络安装了 OpenBSD，您的以太网连接应该已经工作，但可能不会按照您喜欢的确切方式设置。要管理您的网络接口，请使用 `ifconfig(8)` 工具。

让我们来看看您的以太网卡，看看它有什么要说的。首先，通过运行 `ifconfig` 来询问您的系统安装了哪些接口。

所有 OpenBSD 系统默认都有三个逻辑接口：`lo0`、`enc0` 和 `pflog0`。`lo0` 接口是回环接口，指的是本地机器。`enc0` 接口是一个封装接口，用于 IPsec 流量。最后，`pflog0` 用于记录 PF 流量，如 第二十二章 中所述。其余的接口都是物理接口。

与一些操作系统不同，OpenBSD 网络接口的命名是根据底层硬件的设备驱动程序来命名的。以下是一个示例列表：

```
$ **ifconfig**
fxp0: flags=8843<**1**UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> mtu 1500
        lladdr 00:16:36:c0:58:a5
        priority: 0
        groups: egress
        media: Ethernet autoselect (100baseTX full-duplex)
     **2** status: active
     **3** inet 192.0.2.226 netmask 0xffffff00 broadcast 192.0.2.255
        inet6 2001:db8::216:36ff:fec0:58a5 prefixlen 64
        inet6 fe80::216:36ff:fec0:58a5%fxp0 prefixlen 64 scopeid 0x2
```

接口 `fxp0` 使用的是 `fxp(4)` 设备驱动程序，根据手册页的说明，这是一张英特尔 EtherExpress PRO 10/100 网卡。如 **1** 所示，接口处于激活状态，意味着它是活跃的并且准备就绪。`lladdr` 是链路本地地址，或网卡的 MAC 地址。这张网卡位于 `egress` 组中。OpenBSD 在多个地方使用接口组，包括在 第二十二章 中讨论的包过滤器。

要查看连接下层的物理媒体类型，请检查 `media` 行。这个特定的连接以 100Mbps 全双工运行。连接处于活动状态，如 **2** 所示；物理层不仅已配置，而且还有一个链路指示灯，准备就绪。连接已分配了 IPv4 地址和子网掩码，如 **3** 所示。您可以在接下来的两行中看到，已分配了 IPv6 地址和链路本地 IPv6 地址。

使用 `ifconfig` 为网络接口分配、更改或删除 IP 地址。OpenBSD 安装程序在启动时提供配置网络卡的服务，但如果您在安装过程中没有配置所有接口，或者安装后添加或删除了网络接口，您将需要手动进行。

#### 添加 IP 地址

要为 IPv4 添加 IP 地址，从接口分配的 IP 地址和子网掩码开始。

```
# **ifconfig *interface-name IP-address netmask***
```

例如，如果您的网卡是 `fxp0`，IP 地址是 192.0.2.55，子网掩码是 255.255.255.128，您将运行以下命令：

```
# **ifconfig fxp0 192.0.2.55 255.255.255.128**
```

使用点分十进制、十六进制或甚至斜杠表示法指定子网掩码，如下所示：

```
# **ifconfig fxp0 192.0.2.55/25**
```

如果你使用斜杠，不需要单独指定子网掩码。

使用 IPv6 添加 IP 地址略有不同。指定地址，一个斜杠，以及前缀长度，但不要尝试添加单独的子网掩码；只需使用地址部分中的斜杠。以下是一个示例：

```
# **ifconfig fxp0 inet6 2001:db8:0:12::2/64**
```

#### 移除 IP 地址

如果您需要从一个接口中移除 IP 地址，请使用`ifconfig`的`delete`选项来删除 IPv4 和 IPv6 地址。

```
# **ifconfig fxp0 192.0.2.55 delete**
```

效果是立即的，所以请确保不要通过移除所有可到达的 IP 地址或移除 SSH 守护进程所附加的唯一地址而将自己锁定在系统之外。（在某些罕见的情况下，对已删除地址的现有连接可能会继续工作，但它们很可能不会，所以不要寄希望于此。）

#### 一张以太网卡上的多个 IP 地址

一个网络接口可以响应多个 IP 地址的请求，这对于服务器可能支持数百或数千个域名并且需要为每个域名分配 IP 地址来说非常重要。（对于普通网站来说，这并不那么重要，但对于基于 SSL 的网站和依赖于反向 DNS 的协议来说，这可能是重要的。）

要向接口添加额外的 IP 地址，请使用*IP 别名*。IP 别名告诉网络卡“同时回答对这个 IP 地址以及您自己的请求。”要添加别名 IP 地址，请使用`ifconfig`并在接口名称后使用关键字`alias`来告诉`ifconfig`这是一个别名。请确保始终为别名地址使用子网掩码 255.255.255.255 或/32。

```
# **ifconfig fxp0 alias 192.0.2.230/32**
# **ifconfig fxp0**
…
        inet 192.0.2.226 netmask 0xfffffff0 broadcast 192.0.2.239
        inet 192.0.2.230 netmask 0xffffffff
```

这里列出的接口有一个主 IP 地址 192.0.2.226 和一个别名 IP 地址 192.0.2.230。

当处理 IPv6 时，添加`inet6`关键字，如下所示：

```
# **ifconfig fxp0 inet6 alias 2001:db8:0:12::3/64**
```

重要的是要认识到，一个网络连接的主机上的所有出站连接都使用主 IP 地址。例如，您可能有一个接口绑定有 2000 个 IP 地址，但当你`ssh`出去时，连接来自主地址。在编写防火墙规则和访问控制列表时请记住这一点，因为虽然一些程序有设置不同源 IP 地址的选项，但它们是例外。

OpenBSD 内核实际上并不区分主 IP 地址和别名——它只是保留一个 IP 地址列表——但它将使用列表中的第一个地址作为源地址，除非被告知否则。如果一个主机有多个网络连接，那么出站连接的源地址是数据包离开系统的网络接口的主 IP 地址。

要删除别名，请使用`ifconfig`的`delete`选项并给出 IP 地址，无需给出子网掩码。

```
# **ifconfig fxp0 delete 192.0.2.230**
```

对于 IPv6，使用`inet6 delete`。

```
# **ifconfig fxp0 inet6 delete 2001:db8:0:12::3**
```

### 注意

如果您删除了接口上的主 IP 地址，第一个别名将成为主 IP 地址。如果您没有剩余的 IP 地址别名，并且您移除了接口的主 IP 地址，那么该接口将停止传递 IP 流量。

### 配置默认路由

使用`route(8)`为每个协议配置默认路由。

```
# **route add default 192.0.2.1**
add net default: gateway 192.0.2.1
```

IPv6 默认路由几乎相同，但您必须添加`-inet6`修饰符。

```
# **route add -inet6 default 2001:db8:0:12::1**
add net default: gateway 2001:db8:0:12::1
```

一旦您为主机添加了 IP 地址和默认路由，您就应该能够访问您的整个网络和互联网。现在让我们看看如何在重新启动之间进行这些更改。

### 使用动态配置

要让 OpenBSD 从 DHCP 服务器获取 IPv4 地址，运行`dhclient(8)`并给它您想要配置的接口名称。

```
# **dhclient fxp0**
```

`dhclient`获取 IP 地址，覆盖`/etc/resolv.conf`，并配置默认路由。

对于 IPv6，运行`rtsol(8)`代替。

```
# **rtsol fxp0**
```

记住，IPv6 自动配置不会配置您的解析器。您需要从 IPv4 DNS 服务器那里获取帮助，或者手动配置`/etc/resolv.conf`。

### 启动时配置网络

虽然`ifconfig(8)`可以用于即时更改，但您的系统应在启动时正确配置其接口，包括接口上的任何别名、接口启动时添加的任何路由等。

每个接口都有一个配置文件，`/etc/hostname.interfacename`，通常称为`hostname.if`。我的台式机上的`fxp0`接口使用配置文件`/etc/hostname.fxp0`，无线接口`wpi0`使用`/etc/hostname.wpi0`，依此类推。在启动时，OpenBSD 的`/etc/netstart`脚本读取所有的`hostname.if`文件，如果找到匹配的物理接口或可以创建匹配的逻辑接口，它将相应地配置接口。

要配置接口的 IPv4 地址，在`hostname.if`中输入以下格式的行：

```
 inet *ipaddress netmask broadcastaddress ifconfig-options*
```

广播地址和选项是可选的。要使用选项但不指定广播地址，请将广播地址设置为`NONE`。您还可以使用斜线代替十进制等价的子网掩码。

类似地，添加 IPv6 地址如下：

```
inet6 *ipv6address/prefix ifconfig-options*
```

要在启动时为`fxp0`分配 IPv4 地址 192.0.2.226 255.255.255.240 和 IPv6 地址 2001:db8:0:12::2/64，请在`/etc/hostname.fxp0`中使用以下命令：

```
inet 192.0.2.226 255.255.255.240 NONE description 'top card'
inet6 2001:db8:0:12::2/64
```

在这里，我还定义了一个将在`ifconfig`输出中显示的接口描述。

要在启动时创建 IP 地址别名，请在`hostname.if`中使用`alias`关键字。

```
inet alias 192.0.2.230/32
inet6 alias 2001:db8:0:12::3/64
```

要在接口启动时运行命令，请在命令前加上感叹号。必须运行的所有命令都必须在根分区上可用（例如，在`/bin`或`/sbin`中）。此功能最常用于路由，但您也可以使用其他命令。

```
!route add 192.0.2.128/25 192.0.2.2
```

要动态配置接口，通过 DHCP（IPv4）或`rtsol`（IPv6），将字符串`dhcp`或`rtsol`单独放在一行上。

```
dhcp
rtsol
```

任何未按此处所示格式化的内容都将未经编辑传递给`ifconfig(8)`。例如，要运行特定的`ifconfig`命令，请在`hostname.if`中将参数单独放在一行上。

```
description 'lower card'
```

如果您只想激活一张卡，但不配置它，请在单独的一行上使用单词`up`来激活接口。

```
up
```

并且记住，您可以使用`/etc/netstart`测试`hostname.if`更改，如果适当，指定接口名称，如下所示：

```
# **/bin/sh /etc/netstart fxp0**
```

如果不包括接口名称，则重新配置系统上的所有接口。

## 通道化

服务器可以有冗余硬盘、电源等。OpenBSD 通过将多个以太网链路组合成一个单独的虚拟链路或 *trunk* 来支持冗余网络连接。你可能也知道这被称为 *链路聚合*、*网络适配器团队协作* 或 *绑定*。

### 注意

思科人员将 *trunks* 理解为支持多个并发 VLAN 的以太网链路。大多数厂商，包括 OpenBSD，都不那样使用 *trunk* 这个词。OpenBSD 支持在 `trunk(4)` 功能之外，通过单个链路发送多个 VLAN。

### 链路聚合协议

要将多个物理链路作为单个大链路使用，你需要一种方法来在链路之间分配流量。OpenBSD 支持五种不同的方法在 trunk 成员之间分配帧，尽管并非所有方法都适用于所有环境。要获取完整列表，请参阅 `trunk(4)`，但我推荐的适用于实际使用的协议是链路聚合控制协议 (LACP)、roundrobin 和故障转移。LACP 是链路聚合的行业标准。物理接口被绑定成一个具有与各个接口总和大致相同带宽的单个虚拟接口。LACP 非常容错，几乎所有高端管理交换机都应该支持它。如果你的交换机支持 LACP，请使用它，但必须在这种类型的 trunk 传输流量之前在交换机端口上配置 LACP。

在 roundrobin 方法中，OpenBSD 使用 roundrobin 调度器通过 trunk 的活动连接发送帧。trunk 在任何端口上接受传入的包，并且 roundrobin 调度器在 trunk 连接之间轮换，同时添加错误和边缘处理。roundrobin trunk 不需要任何特殊的交换机配置；只需要在同一 VLAN 中的两个端口即可。

在故障转移的情况下，OpenBSD 通过 trunk 的第一个端口发送和接收所有流量，如果该端口失败，则切换到另一个活动端口。故障转移方法不会给你提供额外的带宽，但绝对不需要交换机的支持，甚至可以在老式的集线器上工作。

### trunk 配置

例如，让我们将端口 `em0` 和 `em1` 配置为故障转移 trunk `trunk0`。底层端口之前从未配置过，因此首先在不进行任何配置的情况下激活这些接口。

```
# **ifconfig em0 up**
# **ifconfig em1 up**
```

现在创建故障转移 trunk，使用 `ifconfig(8)` 并将这些端口添加到其中，以使 `trunk0` 接口可用。

```
# **ifconfig trunk0 trunkproto failover**
# **ifconfig trunk0 trunkport em0**
# **ifconfig trunk0 trunkport em1**
```

你可以将所有这些都在一个长的 `ifconfig` 命令中完成，但我发现当学习时，更简单、更短的命令更容易理解。

就像为物理接口分配 IP 地址一样，为接口分配 IP 地址，并添加默认网关到你的系统中。

```
# **ifconfig trunk0 192.0.2.8 netmask 255.255.255.0**
# **route add default 192.0.2.1**
```

你现在应该有一个附加到本地网络的故障转移 trunk。要配置另一个 trunk 协议，只需在创建 trunk 时指定所需的 trunk 协议。你可以在 `trunk(4)` 中找到完整的 trunk 协议列表。

### 启动时的 trunk

在*/etc/hostname.if*中配置您的 trunk。例如，假设您需要编辑*hostname.em0*、*hostname.em1*和*hostname.trunk0*。这两个*em*文件只包含一个单词：

```
up
```

这激活了接口，但没有进行配置。

*hostname.trunk0*更为复杂。

```
trunkproto failover
trunkport em0
trunkport em1
192.0.2.8 netmask 255.255.255.0
```

您可以将所有这些条目放在一行中，就像您可以使用单个`ifconfig`命令配置 trunk 一样，但再次强调，我发现多行更容易阅读和理解。

您的 trunk 现在应该在启动时开始工作。

注意，trunk 不一定需要由使用相同类型物理介质的接口组成。如果您喜欢冒险，您可以尝试复制一些 OpenBSD 的开发者和用户已知的行为：将有线和无线网络接口连接起来作为 trunk，当您从以太网端口拔掉插头，或者当您重新插入并关闭接入点进行维护时，所有连接都能正常工作（记住，要实现优雅的故障转移？）。

## VLANs

VLANs 是一种在单根线缆上实现多个以太网段的方法。您有时会看到它被称为*802.1q*、*标记*或这些术语的组合。

在 OpenBSD 术语中，一根线缆可以承载多个网络，通过配置额外的接口，您可以像它们有自己的专用线缆一样与这些额外的网络通信。然而，线缆仍然只能承载一定量的数据，所以所有共享线缆的 VLAN 和常规网络（或*原生 VLAN*）共享相同的带宽池。

到达您的网络卡的 VLAN 帧就像常规的以太网帧一样，在以太网帧之前有一个额外的头部信息，表明“这是 VLAN 编号如此这般的部分。”每个 VLAN 都有一个编号。VLAN 编号 1 通常是原生 VLAN——没有任何标记到达的 VLAN。为了方便，我将使用“标记”这个词来描述 VLAN 是如何发送到您的主机的。

您如何在 OpenBSD 中使用 VLANs？也许您的网络被划分为多个以太网段，例如防火墙外、服务器区域和桌面客户端。或者，您可能有一个需要直接访问所有这些段落的 OpenBSD 主机。您可以将所有这些网络通过一根物理线缆进行路由。您可能会遇到带宽问题，但如果您通过服务器推送超过 1Gbps 的数据，您可以考虑添加第二块网络卡。

### 配置交换机

您必须配置您的交换机将 VLANs 以 802.1q 或标记的形式发送到您的 OpenBSD 盒子上，具体取决于交换机的语法。思科使用*802.1q*，惠普的 Procurve 交换机使用*标记*，其他厂商则根据他们的偏见使用不同的方式。为此有数十种不同的语法，所以我不提供具体的示例。如果交换机不能将标记的 VLAN 发送到您的服务器，您将无法使用 VLAN。

### 配置 VLAN 设备

OpenBSD 在请求时会创建 `vlan(4)` 接口。要创建设备，你需要知道你想将 VLAN 连接到哪个物理设备以及你期望的 VLAN 号码。

使用 `ifconfig` 创建 `vlan` 接口。

```
# **ifconfig vlan*X* vlan *vlan#* vlandev *interface***
```

我按照所使用的 VLAN 号码来编号我的 `vlan` 接口。（你可以创建接口 `vlan0` 并将其连接到 VLAN 3，但这对我那脆弱的大脑来说太复杂了。）如果你没有指定 VLAN 号码，OpenBSD 会从接口上的号码分配 VLAN 号码。

例如，这里我创建了一个接口 `vlan3` 并使用它通过接口 `fxp0` 访问 VLAN 3。

```
# ifconfig vlan3 vlandev fxp0
```

这就是全部内容。现在你可以使用 `ifconfig` 来显示你的新接口：

```
$ **ifconfig vlan3**
vlan3: flags=48843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST,INET6_PRIVACY> mtu 1500
        lladdr 00:16:36:c0:58:a5
        priority: 0
        vlan: 3 parent interface: fxp0
        groups: vlan
        status: active
        inet6 fe80::216:36ff:fec0:58a5%vlan3 prefixlen 64 scopeid 0x7
```

它看起来就像任何物理接口一样，从你的角度来看，它确实是。你可以像对其他任何接口一样添加 IP 地址，分配路由，然后继续你的生活。

### 启动时配置 VLAN

要在启动时配置 VLAN 接口，为它创建一个 *hostname.if* 文件。例如，以下是一个 */etc/hostname.vlan3* 文件的内容，它创建了前一个部分中演示的 `vlan3` 接口，将其分配给 VLAN 3，并自动配置 IPv4 和 IPv6：

```
vlandev fxp0
dhcp
rtsol
```

OpenBSD 应该在启动时找到这个文件，并根据你的命令创建接口。

## 通过隧道使用 IPv6

假设你已经认真考虑了我的建议，并决定尝试使用 IPv6，但你的 ISP 不提供 IPv6。当你只能得到 IPv4 提供的内容时，如何玩转 IPv6 呢？

许多公司提供免费的 IPv6 隧道服务，他们会通过 IPv4 隧道将你路由到 IPv6。他们甚至免费提供 IPv6 /64，这样你就可以为你的家庭网络配置 IPv6。

虽然我通常避免在本书中推荐供应商，但我确实推荐 Hurricane Electric 的 IPv6 隧道服务，网址为*[`www.tunnelbroker.net/`](http://www.tunnelbroker.net/)*。它的 Web 界面直观，甚至为 OpenBSD 客户端提供配置。

你现在应该对在 OpenBSD 上管理 IPv4 和 IPv6 有了一些了解。当你的大脑从所有这些信息中恢复过来时，我们将转向 OpenBSD 中管理附加软件的主题。

* * *

^([33]) 许多人提出要把我送到西伯利亚。但他们都忘记包括一张返回票。奇怪。
