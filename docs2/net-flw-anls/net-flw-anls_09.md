# 第九章。边和数据分析

![无标题图片](img/httpatomoreillycomsourcenostarchimages651574.png.jpg)

通过本书中讨论的工具，您可以用您可能需要的任何方式分析和展示您的数据。在本章中，您将考虑几个类似系统，并学习如何将它们连接到您的流量收集器。然后，您将查看几个常见用例，说明您可以使用流量分析实现什么。

# NetFlow v9

NetFlow 版本 9 主要用于 IPv6（尽管它可以扩展以包含其他类型的信息），并且很少部署。尽管大多数 NetFlow 传感器支持多个版本，如 5 或 7 以及 9，但一些制造商生产的硬件只能使用版本 9。当版本 9 得到更广泛的应用时，flow-tools 和其同类产品可能会开发对其的支持。然而，在此之前，您如何处理 NetFlow 版本 9 数据呢？

其他免费流量收集器接受版本 9 流量。您可以将版本 9 数据转换为 flow-tools 格式。我将展示如何使用 `flowd`^([11]) ([`www.mindrot.org/projects/flowd/`](http://www.mindrot.org/projects/flowd/))，这是 `softflowd` 的作者开发的。要将您的数据转换为 `flow-capture` 记录文件，您首先需要安装 `flowd`。

## 安装 `flowd`

如果您的操作系统包含 `flowd` 软件包，请使用它。如果没有，您应该安装 `flowd`，但在安装之前，您应该安装以下软件：

+   BSD `yacc`（在 Linux 系统上通常打包为 `byacc`）

+   GNU `make`

是的，这是 GNU 风格的 `make` 加上 BSD 风格的 `yacc`。

`flowd` 软件期望以无特权的用户 *_flowd* 运行。在构建软件之前，请创建此用户。

一旦安装了 `yacc` 和 `make`，构建 `flowd` 的方式与构建 flow-tools 或 `softflowd` 类似。`configure` 脚本包含各种选项。在这里，我在 */usr/local/flowd* 下构建和安装 `flowd`：

```
# `configure --prefix=/usr/local/flowd`
# `gmake`
# `gmake install`
```

就这些！您应该会得到一个配置文件和程序本身。

## 配置 `flowd`

在您使用命令行参数控制 `flow-capture` 的地方，`flowd` 使用配置文件。大多数 `flowd` 配置选项与 `flow-capture` 提供的选项类似。

```
❶ logfile "/var/flow/router-v9/current"
❷ pidfile "/var/run/flowd.pid"
❸ listen on 0.0.0.0:6789
❹ flow source 192.0.2.1
❺ store ALL
❻ accept all
```

`flowd` 将流量记录存储在日志文件中 ❶。与 `flow-capture` 的 `ft-` 文件类似，`flowd` 日志是一个无法直接查看的压缩二进制文件。像大多数其他软件一样，`flowd` 在 PID 文件中记录其进程 ID，如图 ❷ 所示。大多数系统将 PID 文件存储在目录 */var/run* 中。

`flowd` 必须监听网络，并在 ❸ 中指定一个 IP 地址和一个 UDP 端口，用冒号分隔。如果您使用 IP 0.0.0.0，`flowd` 将监听系统上所有 IP 地址的传入流量数据。要限制 `flowd` 接受流量数据的 IP 地址，请将路由器的 IP 地址作为流量源列出，如图 ❹ 所示。

虽然`flowd`具有全面的过滤功能，让您仅记录某些类型的流量，但您在❺处告诉`flowd`记录所有内容，并在❻处接受传感器传输的所有内容。

修改完配置文件后，启动`flowd`，并告诉您的版本 9 传感器将数据传输到该收集器的 IP 地址和端口。当版本 9 流量数据到达时，`flowd`应该将其记录在日志文件中。一旦您看到日志文件变大，就是将数据转换为 flow-tools 格式的时候了。

## 将 flowd 数据转换为 Flow-tools

NetFlow 版本 9 包括 NetFlow v5 记录中预期的信息：源和目标地址和端口、协议号、数据包计数等。您需要自动从`flowd`日志中提取这些信息并将其导入到`flow-capture ft-`文件中。幸运的是，Craig Weinhold 的`flowd2ft`脚本为您做了这件事。您可以从以下列表中复制脚本或从[`www.networkflowanalysis.com/`](http://www.networkflowanalysis.com/)下载它。让我们看看它。

```
#!/usr/bin/perl
  # "flowd2ft" crontab script to move flowd capture files into flow-tools

  # -- flow-tools variables
  # where ft's flow-import is
❶ our $ftImport = "/usr/local/bin/flow-import";
  # put a copy of the flow file here, for flowscan
❷ our $ftDir = "/var/flow/router-v5/ft";
  # timezone for ft capture files
❸ our $ftTZ = "-0500";
  # seconds per ft capture file and cron interval
❹ our $ftPeriod = 300;

  # -- flowd variables
  # where flowd-reader is
❺ our $flowdReader = "/usr/local/bin/flowd-reader";
  # where flowd.conf is
❻ our $flowdConf = "/usr/local/etc/flowd.conf";
  # SIGUSR1
  our $flowdHup = "10";
  our ($flowdPid, $flowdLog);

  our ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
  localtime(time - $ftPeriod);
  our $ftFile = sprintf("ft-v05.%04d-%02d-%02d.%02d%02d%02d$ftTZ",
 $year + 1900, $mon + 1, $mday, $hour, $min, $sec);

❼   open(IN, $flowdConf) || die "Could not read $flowdConf";
  while ( <IN> ) {
          if (/^\s*logfile ["]?([^"\s]+)/) { $flowdLog = $1; }
          if (/^\s*pidfile ["]?([^"\s]+)/) { $flowdPid = $1; }
  }
  close(IN);

  exit if (! -f $flowdLog); # exit silently on empty file

  die "$flowdPid does not exist: $!" if (! -f $flowdPid);
  my $pid = `cat $flowdPid`;
❽  `mv $flowdLog $flowdLog.tmp`;
  die "$flowdPid ($pid) invalid: $!" if (! kill $flowdHup, $pid);
❾  `$flowdReader -c $flowdLog.tmp | $ftImport -f 2 -V 5 -z 1 > $ftDir/$ftFile`;
```

在使用此脚本之前，您需要设置配置变量。在❶处，您将`flow-import`程序的路径硬编码。在❷处，您将脚本指向您想要用于存储创建的`flow-capture`文件的目录。在❸处，您给脚本提供分钟数的时间区域偏移量，以便它可以在文件名中包含该信息，就像`flow-capture`一样。在❹处，您告诉脚本每 300 秒创建一个新的`ft-`文件，就像您的常规`flow-capture`实例一样。

脚本还需要知道`flowd-reader`程序（❺）的安装位置以及如何找到`flowd`配置（❻）。在❼处，脚本读取`flowd`配置文件以获取其余设置，然后在❽处将现有的`flowd`文件移开，以便重新启动`flowd`并关闭现有的日志文件。最后，在❾处，它读取新关闭的日志文件并创建一个新的`flow-capture`文件。

配置脚本后，手动运行一次。它应该在目标目录中创建一个新的`ft-`日志文件，并告诉你处理了多少流量。如果脚本运行不正确，请检查您的设置和错误日志消息。一旦您确定脚本运行正常，请通过在`cron`中添加适当的条目，使系统每五分钟运行一次，如下所示：

```
*/5  *  *   *   *       /usr/local/bin/convert-flowd-ft.pl > /tmp/convert.log
```

现在您将拥有与您其余流量报告系统兼容的流量记录。您可以使用这些记录来设置 FlowScan，运行`flow-report`或执行您喜欢的任何其他操作。

* * *

^([11]) 我认真考虑过使用`flowd`来编写这本书，但它还没有像`flow-capture`支持的那样多种预定义报告。然而，我预计这会随着时间的推移而改变，如果您需要一个 IPv6 流量收集器并且能够用 Perl 或 Python 编写报告，您应该考虑使用`flowd`。

# sFlow

sFlow 是由 InMon 发明的流量导出技术，与思科的 NetFlow 竞争。许多供应商，如 HP 和 Extreme，提供导出 sFlow 但不导出 NetFlow 的设备。不过，没有必要绝望：你可以将 sFlow 数据包转换为 NetFlow 版本 5 数据，并将其提供给 flow-tools。

### 注意

然而，如果你有很多基于 sFlow 的设备，那么真正需要考虑的是一个 sFlow 报告系统。我建议在你有一个现有的 `flow-tools` 设置和几个你想要集成到该系统中的 sFlow 设备时将 sFlow 转换为 NetFlow，而不是当你有一个满载 sFlow 硬件的数据中心时。

## 使用 sflowenable 配置 sFlow 导出

一些 sFlow 传感器可以通过 GUI 或命令行进行配置，但有一些 sFlow 传感器需要通过 SNMP 进行配置。虽然你可以手动使用 SNMP GET 和 SET 命令来设置 sFlow，但 InMon 的那些好人提供了一个脚本来自动化这个过程。从 [`www.inmon.com/technology/sflowenable/`](http://www.inmon.com/technology/sflowenable/) 获取 `sflowenable` 的副本。

`sflowenable` 需要你可能已经安装在你的网络管理工作站上的 net-snmp 工具。它还需要 GNU `awk`，也称为 `gawk`。一些操作系统将 `gawk` 作为默认的 `awk` 包含在内；其他操作系统则将其作为附加包提供。如果 `sflowenable` 因为神秘的 `awk` 错误而失败，你使用的 `awk` 是错误的。安装 `gawk`，然后编辑脚本以使用 `gawk` 而不是 `awk`，或者在你的 shell 中将 `awk` 别名为 `gawk`。现在快速地说三遍。

运行 `sflowenable` 需要传感器主机名和读写 SNMP 社区、收集器 IP 地址以及你想要接收 sFlow 数据的 UDP 端口。

```
sflowenable.sh *`sFlow-sensor community collector_IP collector_port`*
```

例如，为了在设备 bigSwitch 上激活 sFlow，使用 SNMP 社区 LucasRulez，并将数据传输到主机 192.0.2.15 上的端口 5515 的 sFlow 收集器，我会运行以下命令：

```
# `sflowenable.sh bigSwitch LucasRulez 192.0.2.15 5515`
```

你应该几乎立即在你的收集器上看到数据流向端口 5515。但是等等——你没有可以监听 sFlow 的东西，更不用说做任何事情了！你现在将处理这个细节。

## 转换 sFlow 到 NetFlow

`sflowtool` 程序是一个免费的 sFlow 收集器、捕获器和转换器，可以从 [`www.inmon.com/technology/sflowTools.php`](http://www.inmon.com/technology/sflowTools.php) 获取。在其特性中，它可以转换 sFlow 数据流到 NetFlow 版本 5 并发送到 NetFlow 收集器。这对于这些目的来说非常完美。

`sflowtool` 是一个没有特殊要求的简单程序。你可以使用熟悉的 `./configure`、`make`、`make install` 程序来构建它，这些程序你已经多次使用过了。

要让 `sflowtool` 转换并重新传输数据，你需要一个用于监听 sFlow 连接的端口、一个 `flow-capture` 主机以及 `flow-capture` 端口。

```
sflowtool -p *`sflow_port`* -c flow-capture-host -d *`flow-capture-port`* > /dev/null &
```

在前面的示例中，我假设你有一个在端口 5515 上的 sFlow 收集器。让我们假设你想要接受这些 sFlow 数据包，将它们转换为 NetFlow，并将它们重新传输到同一主机上的端口 5516 上运行的 `flow-capture` 实例。你会这样运行 `sflowtool`：

```
sflowtool -p 5515 -c localhost -d 5516 > /dev/null &
```

现在配置一个 `flow-capture` 实例以记录流量数据，你就可以从仅支持 sFlow 的设备中获取数据，无需任何本地脚本或转换程序。

# 使用流量数据解决问题

你已经在本书中探讨了各种流量分析功能的有用性。现在，你将查看一些真实问题的案例研究和可能的解决方案。其中一些我在前面已经提到过；其他则是全新的。

## 找到损坏的软件

在正常情况下，每个网络上的 TCP 连接都会定期断开一小部分。软件堆栈行为不当，客户端尝试连接到已废弃的打印机，应该知道更好的用户安装了行为无法言喻的免费软件。也许使用流量数据来改善你的网络最快的方法就是检查这些损坏的连接，确定它们的来源和目的地，并发现受影响机器上导致问题的软件。以下是有两种常见的“损坏”TCP 连接组：

**仅 SYN 流**

一台机器尝试连接到一个不响应的远程主机。

**仅 RST 流**

一台机器尝试连接到一个拒绝连接的远程主机。你可以为这些情况编写过滤器，并分别报告它们。

### 损坏的连接过滤器

以下过滤器将捕获这两种类型的损坏 TCP 连接：

```
❶ filter-primitive syn-only
      type ip-tcp-flags
      permit 0x2
❷ filter-primitive rst-only
      type ip-tcp-flags
      permit 0x4

❸ filter-definition syn-only
      match ip-tcp-flags syn-only
❹ filter-definition rst-only
      match ip-tcp-flags rst-only
```

在这里，你定义了一个仅 SYN 流的原型 ❶，一个相应的过滤器 ❸，一个仅 RST 的原型 ❷，以及它的匹配过滤器 ❹。

### 检查重置

现在在一个典型流量的样本上使用 `rst-only` 过滤器。

```
# `flow-cat` ❶ `ft-v05.2010-01-22.10* | flow-nfilter -F rst-only | flow-report -v` ❷
 `TYPE=ip-address -v` ❸ `SORT=+flows`
  ip-address      flows octets packets duration
❹ 192.0.2.184    1186   14880  372     100
  192.0.2.197     1186  14880  372     100
  198.22.63.8     39    1720   43      4
  72.21.91.20     23    920    23      0
  192.0.6.197     23    1920   48      16
  192.0.64.69     16    640    16      0
  ...
```

选择你预期“典型”流量的时间段的记录。例如，如果你的办公室只在上午 9 点到下午 5 点开放，那么凌晨 2 点的流量记录将不会代表正常使用（尽管它们可能单独查看很有趣）。在我的网络上，我正在分析上午 10 点到 11 点的记录 ❶。

你正在寻找发送或接收异常大量仅 SYN 或仅 RST 流的机器。虽然你可能会最初用 `flow-print` 查看数据，但你真正想要的是一个 IP 地址列表和匹配流量的数量，如 `ip-address` 报告 ❷ 所提供的。我想按降序排序，如 ❸ 所示。在这个小时里，前两个主机的仅 RST 流量比第三名的机器多 30 倍，如 ❹ 所见。那里似乎有什么行为不正常。

下一步是检查更多的时段，看看这种行为是否一致，或者这两个主机是否只是在特定时间有问题。假设行为是一致的，那么更仔细地查看第一个主机的 RST-only 流量。在这个例子中，我正在使用在第四章中创建的 `ip-addr` 报告，所以我还不需要区分源地址和目标地址：

```
# `flow-cat ft-v05.2010-01-22.10* | flow-nfilter`
 `-F rst-only | flow-nfilter -F ip-addr -v ADDR=192.0.2.184 | flow-print | less`
srcIP            dstIP            prot  srcPort  dstPort  octets      packets
192.0.2.184      192.0.2.197      6     443      33171    80          2
192.0.2.184      192.0.2.197      6     443      17866    80          2
192.0.2.184      192.0.2.197      6     443      64447    80          2
192.0.2.184      192.0.2.197      6     443      60076    80          2
192.0.2.184      192.0.2.197      6     443      13839    80          2
...
```

如您在前面的列表中看到的，每个流在第一眼看来基本上是相同的。主机 192.0.2.184 向 192.0.2.197 发送了两个 TCP RST，从端口 443 到一个高端口。这些都是被拒绝的 HTTPS 请求。如果您查看这两个主机之间的所有流量，您会看到 192.0.2.197 向 192.0.2.184 发送 HTTPS 请求，然后被拒绝。

第二次运行 `flow-print` 并使用包括时间戳的格式，如下所示，显示客户端每隔几秒就发起这个请求：

```
flow-print -f 5
```

主机 192.0.2.197 正在运行一个损坏或配置错误的软件。现在去询问系统管理员发生了什么。

注意，我的测试网络相当小。在企业数据中心，您可能会发现几十种不同的软件包表现不佳；我亲眼见过配置错误的软件每秒尝试联系其他主机数百次。尽管 TCP RST 通常不会消耗足够的带宽来引起问题，但解决这些问题可以使软件更高效，减少硬件需求，并可能以意想不到的方式减少网络流量和服务延迟。

### 检查失败的连接

SYN-only 流表明主机请求了一个连接，但没有得到响应。要么请求的地址不在网络上，要么该地址的主机无法响应请求，或者该主机正在静默忽略请求。尽管您可能知道您的设备是否配置为静默忽略请求，但识别前两种类型的设备可能非常有用。您将像检查 RST-only 流一样识别具有高 SYN-only 流量的 IP 地址；只是过滤器有所变化。

```
# `flow-cat ft-v05.2011-01-22.10* | flow-nfilter -F`
 `hamlin | flow-nfilter -F syn-only | flow-report -v TYPE=ip-address -v SORT=+flows`
  ip-address      flows octets packets duration
❶ 192.0.2.13      8306  526240 16998   2390732
  118.126.4.66    256   10240  256     0
  112.110.75.169  224   40640  635     1828064
  192.0.2.158     193   24624  513     1430236
  192.0.2.233     158   24648  474     1421304
  ...
```

在这份报告中，您再次看到了一个明显的异常值：显示在❶处的主机 192.0.2.13 比其他任何主机都有更多的 SYN-only 流。为了了解原因，请使用与特定 RST-only 主机相同的技巧查看该主机的流量，如下所示：

```
# `flow-cat ft-v05.2011-01-22.10* | flow-nfilter`
 `-F rst-only | flow-nfilter -F ip-addr -v ADDR=192.0.2.13 | flow-print | less`
  srcIP            dstIP            prot  srcPort  dstPort  octets      packets
❶ 192.0.2.13       192.0.2.16       6     26064    24       64          1
❷ 192.0.2.13       192.0.2.16       6     26064    26       64          1
❸ 192.0.2.13       192.0.2.16       6     26147    27       64          1
❹ 192.0.2.13       192.0.2.16       6     26148    28       64          1
  192.0.2.13       192.0.2.16       6     26152    29       64          1
  192.0.2.13       192.0.2.16       6     26149    30       64          1
  192.0.2.13       192.0.2.16       6     26246    31       64          1
  192.0.2.13       192.0.2.16       6     26248    32       64          1
  192.0.2.13       192.0.2.16       6     26253    33       64          1
  ...
```

如您所见，主机 192.0.2.13 重复尝试联系 192.0.2.16，首先是在端口 24 上（❶），然后是端口 26（❷），端口 27（❸），端口 28（❹），以此类推。这一特定数据表明 192.0.2.13 正在尝试 192.0.2.16 上的 1 到 1024 之间的所有端口。随后，连接尝试转向 192.0.2.17。

这个活动表明这是一台端口扫描器。记住，并非所有端口扫描器都是按顺序扫描端口的——关键是要寻找在相对较短的时间内被同一 IP 地址在多个端口上击中的情况。如果 192.0.2.13 是你的安全工作站，并且你习惯性地扫描自己的网络，这可能是一种正常行为。然而，蠕虫和入侵者也会使用端口扫描器来识别易受攻击的目标。如果你不知道这台机器为什么扫描网络，找出原因！

在这个输出中，有一个有趣的现象是端口扫描似乎跳过了端口 25。记住，你正在检查立即重置的数据流。如果一个主机在端口上响应，它将不会出现在这个列表中。在这种情况下，192.0.2.16 运行着一个邮件服务器；查看这些主机之间的所有流量将显示一个到端口 25 的数据流和一个响应的数据流。

调查另一个具有高只包含 SYN 计数器的 IP 地址可能会产生类似以下的结果：

```
srcIP            dstIP            prot  srcPort  dstPort  octets      packets
221.194.136.17   192.0.2.158      6     35628    80       432         8
66.249.67.245    192.0.2.158      6     44008    80       240         4
221.194.136.17   192.0.2.158      6     35628    80       48          1
66.249.67.245    192.0.2.158      6     44008    80       60          1
65.55.207.118    192.0.2.158      6     52684    80       144         3
65.55.106.137    192.0.2.158      6     54180    80       144         3
65.55.106.185    192.0.2.158      6     21976    80       144         3
...
```

这些不同的源 IP 地址都在尝试连接到 192.0.2.158，所有这些都是在 TCP 端口 80 上。快速检查显示，这台机器是一个 Web 服务器，并且它确实在端口 80 上响应请求。为什么你会看到这些只包含 SYN 的数据流？

如果你的网络设备报告了一个数据流，那么它肯定将数据包发送到了网络节点，因为发送数据包是一个比流量报告更高的优先级任务！在这个特定的情况下，从`flow-print`命令中移除`syn-only`过滤器显示 Web 服务器响应了数千个请求。"flow-report"告诉你，在你检查的那个小时内，这台主机有 193 个只包含 SYN 的数据流，但 Web 服务器并没有响应这 193 个请求。可能是它耗尽了内存或 CPU。也许网卡已经饱和，或者 Web 服务器软件被重新加载了。

绘制只包含 SYN 的数据包出现的时间图可能会提供一些答案，特别是当与当时打开的连接数量图或服务器执行内部维护的时间列表进行比较时。作为网络管理员，你只能说，在这个小时内，用户遇到了“页面无法显示”或类似的错误 193 次。在你的环境和情况下，这是可以接受的吗？可能不是。

这种类型的结果的好处是，你知道交付系统中的哪个部分失败了。网络交付了数据包，而 Web 服务器没有响应。如果 Web 服务器管理员报告说他在收到关于网络超时的投诉，你可以提供证据表明超时实际上并不是网络问题，并提出解决问题的建议。

## 识别蠕虫

如果你在一个企业网络中，蠕虫造成的麻烦远不止系统问题。它们会引发会议。与管理层一起。由于你的防病毒软件可能在蠕虫尝试传播时触发桌面警报，这些会议可能包括高级管理人员，他们可能会提出关于你如何度过时间的尴尬问题。

你最好的应对策略是尽快找到蠕虫的源头。例如，在 2009 年春季，我的雇主的安全系统开始发出关于 Conficker 病毒感染尝试的警告。在一个拥有数万台桌面的全球公司中，手动识别病毒源头可能需要无数的人时，并需要跨越多个时区和多种语言障碍的合作。尽管我只有全球数十个工厂中的三个工厂的流量数据，但流量分析在约 15 分钟内就确定了源头，并避免了大多数会议。

要找到蠕虫，首先确定蠕虫的传播方式。几分钟的谷歌搜索告诉我，Conficker 通过微软的文件共享端口，在 TCP/445 上传播。蠕虫探测其网络上的每个 IP 以识别 Windows 主机，并感染它找到的任何主机。这种行为是不寻常的：尽管许多服务器会从许多不同的主机接收连接，但很少会有系统试图连接到网络上的每个其他主机。

你可以使用`ip-source-address-destination-count`报告来统计系统尝试联系的主机数量，如下所示：

```
# `flow-cat` ❶ `ft-v05.2009-05-29.* | flow-nfilter -F ip-port -v` ❷
 `PORT=445 | flow-report -v` ❸
 `TYPE=ip-source-address-destination-count -v OPTIONS=-header -v` ❹
 `FIELDS=-duration,-packets,-octets |` ❺
 `sort -rnk 2 | less`ip-source-address ip-destination-address-count flows
❻ 172.17.84.14      1851                         1711
❼ 172.17.84.13      1591                         1483
❽ 172.19.11.65      59                           225
  172.19.11.8       44                           60
  172.19.11.4       17                           38
  ...
```

正如你所见，我从❶开始，查找的是蠕虫攻击我的本地网络的时间窗口内的流量文件。然后我在❷处仅搜索流向或来自端口 445 的流量，并在❸处通过`ip-source-address-destination-count`报告运行这些流量。为了使输出更易于阅读，❹处移除了不必要的字段。

### 注意

记住，这个报告及其对应报告`ip-destination-address-source-count`没有内置的排序功能。你必须在外部进行排序，如下❺所示。（外部排序的一个后果是，每个列的标题出现在列表的底部。我已经将这个示例的标题恢复到了顶部，以便更容易理解。对你的经理们也这样做。）

该报告揭示了两个试图连接到大量其他主机的计算机：172.17.84.14 在我的数据中心网络上连接或尝试连接了 1,851 个不同的主机，如下❻所示。由于网络中少于 500 台活跃的计算机，这立即引起了怀疑。❽处显示的第二个主机具有类似的配置，而❽处的第三个是我的公司文件服务器，它的连接数要少得多。

这两台机器实际上位于不同半球的一个测试网络上。没有流量分析，我永远无法识别这些机器。有了分析，一份记录结果的电子邮件让我免去了参加任何后续会议的需要。

## 流向非法地址的流量

你的防火墙配置错误吗？是的。是的，它是。你只是不知道而已。

大多数防火墙使用网络地址转换（NAT）将私有地址上的主机连接到公共互联网上的地址。如果您有一个复杂的防火墙策略，并且防火墙平台鼓励复杂或甚至古怪的 NAT 规则^([12]), 那么不小心将未翻译的地址泄露到您的面向互联网的网络中很容易。如果您正在使用一个策略运行多个防火墙，这几乎不可避免。您的 ISP 应该从您的互联网电路中过滤内部地址，因此任何在您的外部网络上带有私有 IP 地址的流量都来自您（或者您和您的 ISP 需要稍微谈谈）。

跟踪来自私有地址的流量很容易。首先，定义一个包括您内部地址的过滤器。

```
filter-primitive internal
     type ip-address-prefix
❶    permit 172.16.0.0/16
     permit 172.17.0.0/16
     permit 172.18.0.0/16

 filter-definition internal
   match ip-source-address internal
   or
   match ip-destination-address internal
```

在这里，您在❶处确定了三个用于内部的三块 IP 地址，并为它们定义了一个过滤器。接下来，转到您存储面向互联网网络流量记录的目录，对这些地址进行过滤，并打印结果。

```
# `flow-cat * | flow-nfilter -F internal | flow-print | less`
  srcIP            dstIP            prot  srcPort  dstPort  octets      packets
❶ 172.16.84.151    137.118.232.3    6     33892    25        40         1
  172.16.84.151    94.190.193.162   6     43729    25       309         1
  172.16.84.151    123.118.100.174  6     25051    25       339         1
  172.16.84.151    189.70.172.2     6     33724    2015     133         1
  172.16.84.151    212.242.180.151  6     33724    11906    133         1
❷ 172.16.84.130    198.22.66.10     17    4132     53       132         1
  172.16.84.130    198.22.62.19     17    38897    53       132         1
  ...
```

每个这些流量都通过了具有不正确 NAT 配置的防火墙规则。换句话说，这些规则是错误的，并且它们将以意想不到的方式影响您。例如，❶行显示一个主机试图从一个私有地址发送电子邮件。当然，连接永远不会完成。如果这是您的备用邮件交换机，当您的首选邮件交换机出现问题时，您将会有一个令人不快的惊喜。同样，在❷处，您也有一个主机试图从一个私有地址进行域名服务查询。提前修复这些问题将减少未来的中断。

## 非存在主机的流量

理论上，移除网络服务器应该减少网络使用。不幸的是，这并不总是正确的。

在某个时候，我雇主公司网络上的某些桌面电脑在用户输入用户名和密码五分钟之后才会变得有用。即使是普通操作系统，这也太慢了。尽管并非每个工作站都受到影响，但受影响的大部分工作站都在我缺乏诊断设备的远程位置。我让一个用户在特定时间尝试了一个这样的工作站，然后检查流量记录，看看该工作站是否在窗口期间尝试联系我的数据中心中的任何东西。

结果表明，在那个时间段内，那个工作站的大部分流量都在尝试连接我的 Novell 登录服务器，该服务器几天前已被关闭。然而，工作站仍然安装了客户端。显然，Novell 客户端软件坚持尝试联系登录服务器，尽管它被告知要关闭。从那个客户端中移除 Novell 客户端解决了缓慢登录的问题。

在确定了一个问题后，我接下来使用 FlowGrapher 绘制了从那个远程工厂到断开连接的服务器 IP 地址的流量图。每天早上两个小时，这种流量几乎消耗了工厂网络连接的 25%。尽管之前认为移除禁用客户端是不必要的，但这个证据改变了人们的想法。

严格来说，这不是一个网络问题，但诊断它需要网络管理员的参与，而解决问题减少了网络投诉的数量。记住，网络工程师想要的只是让他的用户闭嘴。

* * *

^([12]) (咳嗽。) 检查点。(咳嗽。)

# 后记

我确信你们中的大多数人都能与每一位同事相处得非常好，你们的工作环境令人愉快，充满乐趣，你们的 IT 团队是一个无缝、团结的团队，没有恶意的争吵或痛苦的诽谤。对于那些在不太支持的环境中工作的人来说，应该读一读这篇文章。

流量分析将改变你的问题解决能力。你将解决那些多年来一直困扰你网络的奇怪问题。你将最终证明，那些大家都舒适地归咎于网络的问题实际上是服务器或软件问题。你甚至能够挖出一长串其他人正在网络上造成的问题。所有这些都会迅速改变你与同事和管理层的关系。

系统管理和网络工程师有与难以共事的传统；我们甚至有像地狱里的混蛋操作员这样的原型。现在你有证据了，你可能会想让你那些怀疑你的人为他们的固执付出代价。然而，现在你有证据了，你可以表现得更加宽容。当你遇到问题时，承认它。当你表明某件事不是你的问题时，然而，可以说些像“这里有证据表明问题。尽管这显然不是网络问题，但我很高兴帮助你解决问题。”诚然，这比用“你 loser”这样的词要令人满意得多。虽然看起来不太可能，但积极的态度可以改变同事和管理层对网络员工的态度，并改善你的生活。

如果不是这样，至少你可以确信这不是你的问题。而且，永远不晚于称呼某人傻瓜。
