# **引言**

*这是一段关于我们的英雄在追求性能的过程中所遇到的挣扎和艰辛的描述：其中有一段短暂的混乱和开始*。

![无标题图片](img/httpatomoreillycomsourcenostarchimages333191.png.jpg)

从前，在阴影之地阿蒙克，一群邪恶的程序员正在编织他们的邪恶计划。似乎地球终于迎来了黑暗的日子，而且永远如此，因为程序员们似乎非常聪明，没有人能够抵挡他们。即使某个英雄，通过极大的幸运或难以想象的英雄主义，将他们中的一个击败，那么仍然会剩下无数的人，每个人都比前一个更加邪恶和狡猾。

等等。这完全不对。事实上，这是另一本完全不同的书的开始。让我们再试一次。

这本书是关于 Xen 的。它不是关于禅。它不会向你展示一条通往觉悟的道路，即从浮世解脱出来。我们不会给你关于八正道的建议，也不会列举四圣谛。这些都超出了我们的范围。但如果一切顺利，这本书将让你感到快乐。

# 虚拟化：简史

在这种情况下，幸福的载体将是虚拟化。这听起来很奇怪，但自从时间的开始，人们就试图通过虚拟化来获得幸福。（在计算机术语中，那就是 20 世纪 70 年代。）IBM 在阿蒙克的一支程序员团队推出了我们知道的第一个虚拟机（VM）解决方案，即 VM/370，以确保他们的新机器能够运行为旧型号开发的程序。顾客在 1979 年非常喜欢它，Xen 开发者将其视为一个重要的灵感来源。一个类似但更现代的例子可能是 Xbox 360 对原始 Xbox 的软件模拟。

一段时间里，并没有什么成果。虚拟化在计算机领域继续发挥作用，主要在市场的高端，但人们仍然固执地要求大多数任务需要一个完整的机器，直到大约 2001 年。

2001 年，每个人都必须承认，与 1979 年大不相同。计算机变得小巧而无处不在。大型分时机器让位于个人电脑。批量处理变得罕见，完全交互式的桌面应用已成为计算机的*存在理由*。最重要的是，从我们的角度来看，单台计算机已被网络所取代：大多数值得拥有的计算机都连接到互联网，并且每个都需要各种服务。

这些服务反过来被设计成可以由甚至最便宜、最小的服务器轻松提供，通常要多得多.^([2]) 突然间，运营这些服务的人们有了大量的计算能力过剩，消耗的电力远远超出他们实际提供的服务。必须采取某种措施。虚拟化重新出现的舞台已经搭建，这次作为服务器 *整合* 的手段。

剑桥的一些聪明人士决定，这个想法可以进一步扩展——如果虚拟化允许个人或公司合并他们的机器，他们推理，那么它是否也应该允许 *多个* 组织合并他们的机器并获取更大的利益？这就是 Xen 的目标。它将虚拟化视为一种技术，允许人们完全忽略硬件。在这个模型中，计算成为一种服务或商品，“创造一个 XenoServer 执行平台遍布全球，任何公众成员都可以使用的世界。”^([3])

这就是我们今天所在的位置。尽管 XenoServer 平台从未发布，但其愿景今天仍然以“云计算”的形式存在，这是由 Xen（以及诚然其他虚拟化系统）实现的。Xen 通过允许站点创建“节点”，这些节点可以通过其他计算服务机制无法实现的方式进行管理、转移和计费，从而融入这个庞大的云计算方案。

* * *

^([1]) 然而，令我们非常沮丧的是，它与电影中的描述也非常不同。

^([2]) 我们知道，有许多应用情况并非如此——但仍然有许多小型网络服务器（例如）存在。

^([3]) Hand 等人，“控制 XenoServer 开放平台”，（英国剑桥大学，2003 年）。摘要。

# 那么，Xen 又是什么呢？（我为什么要使用它？）

即使你对这种网格计算类型不感兴趣，Xen 也为系统管理员和家用用户提供了某些优势。

Xen 是一种软件，它使一台机器表现得就像多个 *虚拟* 机器。这些机器中的每一个都可以运行自己的操作系统，并且几乎独立于同一硬件上运行的其它虚拟机器。每个虚拟机器（在 Xen 术语中称为 *实例* 或 *域*）都有自己的明显网络接口、磁盘和内存。

最初，这使 Xen 看起来与 *模拟器* 没有什么不同，例如 VMware、微软的 Virtual PC 或开源的 QEMU.^([4]) 然而，这些传统的模拟器通过在模拟处理器上运行软件来实现，而这个模拟处理器本身也是软件——这是一个相当慢的过程。Xen 实际上以全速直接在处理器上运行所有软件，只为一些资源管理任务产生非常小的开销。

这导致了 Xen 的第一个，也可能是最重要的优势：与传统的模拟器相比，Xen 运行得*非常快*。"Xen 和虚拟化的艺术"——Xen 的开创性论文之一——的初步结果表明，在标准负载下性能下降不到 2%，在最坏的情况下为 10% 到 20%。从那时起，Xen 已经得到了改进。我们通常只认为 Xen 的性能是"足够的"，就到此为止。（想要更精确答案的读者可能想阅读第十章，该章节讨论了使用特定应用程序对 Xen 的性能进行基准测试。）

Xen 的优势在与独立机器的对比中也显现出来，甚至超出了之前提到的整合论点。就像传统的模拟器一样，Xen 提供了强大的故障隔离——也就是说，任何影响一个虚拟机的软件问题不太可能影响真实机器或同一硬件上运行的其它虚拟机。这使得它在用户意图或技能水平无法确定的环境中特别有用。

同样，像传统的模拟器一样，Xen 在机器和用户之间提供了一个额外的抽象层，这增加了管理员的灵活性——突然之间，应用程序可以几乎完全与硬件解耦；可以停止、启动、移动；可以变成真正的服务。

但从某种意义上说，Xen 的主要优势是心理上的：它使得将计算机时间视为比它已经更像是商品成为可能。^([5)](#ftn.CHP-00-FNOTE-5) 使用 Xen，你可以根据自己的需要运行自己的虚拟计算机，所需资源根据所需的应用程序进行定制。

此外，Xen 还允许你在任何给定时间运行所需的任何配置。例如，想要测试新网页与不同版本的微软 Internet Explorer 的网页开发者不需要维护一个包含不同 Windows 版本、不同补丁级别和不同 Internet Explorer 版本的 Windows 箱子农场。相反，只需在硬盘上保留不同的操作系统镜像，并在需要时启动它们。

## Xen 的局限性

好吧，我们有点走远了。Xen 并非完美，也不是任何形式的计算万能药。它既有缺点也有局限性。

Xen 的主要缺点是它只能与专门修改以支持它的操作系统一起工作。（但请注意，在足够先进的硬件上，未修改的客户端操作系统也是可能的。我们将在第十二章中稍后讨论这一点。）

与纯软件模拟器相比，设置 Xen 需要用户完全在客户端域（尽管是一个特殊、受保护的客户端域）中工作，而不是简单地启动一个外部的模拟程序。

此外，Xen 文档的状态相当糟糕。（你可能会说，这正是我们在这里的原因。）当然，人们正在努力改进它，但众所周知，编写代码比编写文档更有趣。此外，Xen 正在如此积极地开发中，以至于现有的许多文档已经过时。

这些是重大的缺点，但它们并不糟糕到让你放弃运行 Xen。

最后，尽管也有一些情况下 Xen——以及虚拟化本身——根本不起作用。例如，对于具有持续、CPU 限制的工作负载的人来说，Xen 并不是特别有用。在大型服务器农场中，单个节点已经根据其工作进行了扩展，Xen 也不是很好。在这些情况下，Xen 可能不是你想要的，尽管开发人员（以及开源社区）正在为这些环境开发吸引人的功能。

但是，最终，真正有趣的不是 Xen 本身，而是你可以用它做什么。

## 那么，为什么我应该使用 Xen 呢？

简短的回答是，*因为它会使你的生活更轻松*。不相信某个软件？创建一个虚拟机，看看你喜不喜欢。需要测试一个网络应用程序？启动几台机器，看看它们如何相互通信。有一个你想要在上面测试新软件的集群，但负担不起第二个“测试”集群？Xen 提供了一个解决方案。想要良好的快照备份？Xen 可以是你的答案，它能够在几秒钟内暂停并备份正在运行的机器。需要为数十个用户提供托管服务，每个用户都希望完全控制他们的配置？这正是我们所做的，而 Xen 是我们这样做的方式。（敏锐的读者可能会注意到我们的写作中存在某种偏向于最后一个应用。这就是原因。）

在更基本的层面上，Xen 允许你停止一台机器，将其发送到其他地方，并随意恢复其运行。这减少了一件事要考虑——突然间硬件不再重要。这对用户和管理员来说都是一件好事！

最后，还有一个很好的理由来运行 Xen，这个理由既大又平凡，常常被忽视：Xen 简直比运行多个盒子便宜。数据中心中的 CPU 使用率在 5% 到 40% 之间——这个数字相当不引人注目。⁶ Xen 允许你利用那些未使用的周期，而不会牺牲可靠性、性能或可扩展性。

与几十年前的虚拟化技术不同，Xen 虚拟化了廉价的通用硬件；一开始这可能没有意义，直到你意识到市场的大部分内容对价格非常敏感，而电力正变得越来越昂贵。运行一个大型双四核系统比运行八个单核系统便宜得多，而使用 Xen，你可以轻松地将那个四核系统分割成单独的系统。

* * *

^([4]) 事实上，Xen 广泛使用了 QEMU，正如我们将看到的。

^([5]) 这有点像手机。人们使用它们，不是作为固定电话的替代品，而是作为传统计划的替代品。

^([6]) 这是一个普遍存在的信念，但经常引用的一个来源是托马斯·比特曼的演示文稿“虚拟化：掌握您的服务器”。

# 本书概述

好了，不要过多吹嘘。现在让我们进入正题。

我们将本书（主要是）理论与实践讨论交替进行。根据我们的经验，管理员需要实际经验和坚实的理论基础才能有效地解决问题，这正是我们旨在提供的。

第一章是 Xen 和虚拟化技术的一般概述。我们试图概述 Xen 的工作原理，它与其他虚拟化软件包的区别，以及你为什么可能（或可能不）想使用它。这一章理论性较强。

第二章是一个基于经验的快速入门步骤，其理由是没有替代品。我们在 CentOS 系统上从基本原理安装 Xen。

第三章介绍了如何手动创建虚拟机镜像以供 Xen 使用。

第四章涵盖了存储。听起来可能有点平凡，但存储实际上是虚拟化的一个关键部分——如果存储与特定的机器或硬件配置相关联，那么 Xen 的一些最酷的功能将无法工作。我们涵盖了各种存储选项，为后续关于迁移和快照的讨论奠定了基础。

我们在第五章第五章. 网络连接中讨论了网络连接——如何设置以及这样做时有哪些选项。这一章和上一章都更多地侧重于理论。

第六章介绍了几种流行的前端包装，这些前端可以与开源 Xen 虚拟机管理程序一起使用来自动化虚拟机管理的日常繁琐工作。我们还讨论了 Xen 的脚本编写，如果你更愿意构建自己的前端。

第七章回到实际案例研究，讨论 Xen 在共享托管中的应用。这是推动 Xen 早期采用的主要应用之一，我们在这一领域有很多经验。

从共享托管迁移过来，在第八章第八章. 超越 LINUX：在其他类 UNIX 开源系统中使用 Xen 中，我们讨论了 Linux 作为“主机”和“客户机”操作系统的可能替代方案。

在第九章中，我们描述了迁移的理论和实践。

第十章是关于使用 Xen 进行性能分析的内容。我们讨论了 Xen 在这一领域的强大支持，这似乎没有得到应有的关注。

在第十一章中，我们稍微偏离一下，来介绍 XenSource（现在是 CITRIX 的一个部门）围绕 Xen 构建的商业产品。

第十二章是关于 Xen 的 HVM 支持——也就是说，由 Intel 和 AMD 最新处理器支持的硬件虚拟化。

第十三章涵盖了 Windows。我们讨论了如何与 Xen 一起使用它，使其表现良好，你可以期望如何访问它，以及一旦它运行正常后你可能期望用它做什么。

第十四章是针对 Xen 管理员的一组非常实用的技巧。

第十五章是故障排除章节——收集了我们遇到的问题以及我们是如何解决它们的。

我们还包含了关于 Xen 的域配置文件和`xm`语法的附录。

# 但我很急躁！

如果你真的迫不及待地想开始使用 Xen，跳到第二章并按照我们的分步指导进行。然后根据你的兴趣浏览书的其余部分。

如果你计划将 Xen 作为服务提供商部署，我们建议按照第二章中的步骤进行，然后阅读第三章、第四章、第五章、第六章、第七章、第八章，可能还有第十一章，最后再通读整本书。

对于那些正在考虑大规模部署 Xen 的读者，你们可能最感兴趣的是第第三章、第四章、第五章、第六章和第七章，以及第十三章来考虑商业 XenSource 产品。但再次强调，我们认为我们在整本书中都提供了有用的信息。

### 注意

我们尽量使这本书尽可能独立于发行版和版本，除了在教程部分，我们试图非常具体和详细，以及在特定发行版的笔记中，这些笔记必然是，嗯，特定发行版的。

我们经常会陷入一些荒谬的广泛概括，比如“只有白痴才会用 Linux 作为 NFS 服务器。”^([7]) 在合理的情况下，我们尽量添加脚注来限定和缓和偶尔过于尖锐的声明。

* * *

^([7]) 实际上，我们也见过笨蛋和白痴也这样做。
