<html><head></head><body><div class="chapter" title="Chapter&#xA0;13.&#xA0;XEN AND WINDOWS"><div class="titlepage"><div><div><h1 class="title"><a id="xen_and_windows"/>Chapter 13. XEN AND WINDOWS</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject13_d1e13629"/><img src="httpatomoreillycomsourcenostarchimages333191.png.jpg" alt="image with no caption"/></div></div><p>In the last chapter we described Xen's hardware virtualization support and how to use it. Now that we have Xen operating with hardware virtualization, we can run unmodified operating systems, including Windows, that 800-pound gorilla of the computing world.</p><div class="sect1" title="Why Run Windows Under Xen?"><div class="titlepage"><div><div><h1 class="title"><a id="why_run_windows_under_xen"/>Why Run Windows Under Xen?</h1></div></div></div><p>Now, why exactly would you want to do this terrible thing? We could say, "because you can," and that's reason enough to do many things. But it might not be entirely satisfying—it sounds like a lot of work, after all.</p><p><a id="idx-CHP-13-0930" class="indexterm"/>Fortunately, reasons abound. Probably the best of these is the software—especially the server software, considering that Xen's strengths are in the server field.<sup>[<a id="CHP-13-FNOTE-1" href="#ftn.CHP-13-FNOTE-1" class="footnote">79</a>]</sup> Much of the Windows server software, like Exchange Server, has a giant installed base and would be difficult to replace. The same holds for the client software. Take, <a id="idx-CHP-13-0931" class="indexterm"/>for example, Office, Outlook, Visual Studio—Microsoft continues to be a fact of life. Xen with VNC, SDL, or rdesktop allows you to run productivity software at acceptable speeds, with full, albeit unaccelerated, graphics support, all while retaining your comfortable Linux computing environment.</p><p>Xen also gives you a way out from the old worry that the next <a id="idx-CHP-13-0932" class="indexterm"/>security fix or driver update will leave the machine completely unbootable—it provides an equivalent to Microsoft's "system restore points" but under your own control, rather than the OS's. By running <a id="idx-CHP-13-0933" class="indexterm"/>Windows in a virtual machine with an effective storage backend, you can snapshot it, roll back updates, and protect yourself from malware—all without involving the domU.</p><p>Security furnishes another reason to run Windows under Xen. Although it's cliche to say that Windows is insecure, the fact remains that virtualization, when properly used, can be an effective layer of isolation for any server, Windows, *nix, or otherwise. The fact that Windows is a popular target makes this reasoning even more compelling.</p><p>It's also worth noting that Xen's design, which partitions drivers in isolated domains, at least contributes to security. An intrusion in the Windows domain, even if it manages to exploit driver code to interact with physical hardware, is unlikely to compromise other domains on the same hardware. This doesn't mean that Xen is inherently secure, but it does suggest that it might be possible to secure it. Work remains to be done, of course—indeed, a lot of the present work in QEMU is in precisely the area of validating emulated device access to improve security. But even as things are, Xen can help to reduce the exposure of Windows machines.</p><p>Besides, it's easier to run Windows in a domU than you might suppose.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-13-FNOTE-1" href="#CHP-13-FNOTE-1" class="para">79</a>] </sup>At least in light of the ongoing commodification of the operating system, which really is at least part of what Xen is all about, isn't it?</p></div></div></div>
<div class="sect1" title="Windows on Xen: Prerequisites"><div class="titlepage"><div><div><h1 class="title"><a id="windows_on_xen_prerequisites"/>Windows on Xen: Prerequisites</h1></div></div></div><p>Before stepping into the brave new world of virtualized Windows, make sure that you've got a few things.<a id="idx-CHP-13-0934" class="indexterm"/></p><p>First, you're going to need a box that does HVM. (See <a class="xref" href="ch12.html" title="Chapter 12. HVM: BEYOND PARAVIRTUALIZATION">Chapter 12</a> for details on what that is, how it works, and how to tell if you have it.) The box will also need enough free memory and storage for a Windows install—Xen can help to use resources more efficiently, but it's not magic. For example, we suggest that a Xen box running Windows Server 2003 domUs have 512MB of memory and about 10GB of hard drive space for each domU, plus 512MB and another 10GB for dom0. You might want to consult Microsoft's website for more specific system requirements or requirements for other Windows versions.</p><p>It might sound obvious, but you're also going to need a copy of Windows, with a license that allows virtualization. This copy of Windows should be reasonably new. We're going to focus on Windows XP Service Pack 2 and Windows Server 2003 in this chapter—Vista's just too much hassle at this point. Windows NT and 9<span class="emphasis"><em>x</em></span>, while they should in theory work, seem to crash during the install step. No one (us included) seems too interested in figuring out why this happens. Life is full of mysteries.</p></div>
<div class="sect1" title="Windows on Xen: Installation"><div class="titlepage"><div><div><h1 class="title"><a id="windows_on_xen_installation"/>Windows on Xen: Installation</h1></div></div></div><p>Windows is actually quite easy to get installed and running. The basic steps are exactly like any other Xen install, with some extra configuration:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Get Windows install media and put it somewhere that Xen can find it.</p></li><li class="listitem"><p>Make a config file.</p></li><li class="listitem"><p>Boot from the install media.</p></li><li class="listitem"><p>Install using the Windows installer.</p></li><li class="listitem"><p>Reboot from the emulated hard drive.</p></li><li class="listitem"><p>Install paravirtualized drivers.</p></li><li class="listitem"><p>Use Windows.</p></li></ol></div><p>Easy, right? Let's get started.</p><div class="sect2" title="Installing Windows Manually"><div class="titlepage"><div><div><h2 class="title"><a id="installing_windows_manually"/>Installing Windows Manually</h2></div></div></div><p>The first thing to do is get a copy of Windows. In our case, we used a physical CD-ROM, which we put in the Xen server's CD-ROM drive. For convenience, you can of course create an image from the CD and use it just like the physical disc:<a id="idx-CHP-13-0935" class="indexterm"/></p><a id="I_programlisting13_d1e13734"/><pre class="programlisting"># dd if=/dev/cdrom of=/var/tmp/windows2k3.iso</pre><p>(If you go that route, specify <code class="literal">file:/var/tmp/windows2k3.iso</code> instead of <code class="literal">phy:/dev/cdrom</code> in the following steps.)</p><p>While you're at it, create the backing store in the usual way. Here we'll use a file-backed device, but you can use any storage backend that Xen knows about.</p><a id="I_programlisting13_d1e13746"/><pre class="programlisting"># dd if=/dev/zero of=/opt/xen/falstaff/falstaff.img bs=1M count=8192</pre><p>Next, create a config file. Here's a sample (pulled from <a class="xref" href="ch12.html" title="Chapter 12. HVM: BEYOND PARAVIRTUALIZATION">Chapter 12</a> with minor changes). We'll save this as <span class="emphasis"><em>/etc/xen/falstaff</em></span>:</p><a id="I_programlisting13_d1e13755"/><pre class="programlisting">import os, re
arch = os.uname()[4]
if re.search('64', arch):
     arch_libdir = 'lib64'
else:
     arch_libdir = 'lib'

device_model = '/usr/' + arch_libdir + '/xen/bin/qemu-dm'

kernel = '/usr/lib/xen/boot/hvmloader'
builder = 'hvm'
memory = 512
name = 'falstaff'
vif = [ 'type=ioemu, bridge=xenbr0' ]
disk = [ 'file:/opt/xen/falstaff/falstaff.img,ioemu:hda,w',
     'phy:/dev/cdrom,ioemu:hdc:cdrom,r' ]
boot = 'd'

vnc = 1</pre><p>This should be pretty familiar by now. Note that we're leaving ACPI and APIC at their default "off " values to avoid confusing the Windows installer. You'll want to point the entries in the <code class="literal">disk=</code> lines to the appropriate locations for your install, of course. You might also want to diverge from our configuration by setting <code class="literal">sdl=1</code> rather than <code class="literal">vnc</code>—SDL works only on the local X display but has the virtue of popping up automatically.</p><p>Then create the machine as usual:</p><a id="I_programlisting13_d1e13770"/><pre class="programlisting"># xm create falstaff</pre><p>Start a VNC session so that you can talk to it, assuming you decided against SDL. Insert the correct host and display number—in this case we're on the local machine, and this is the first VNC session running:</p><a id="I_programlisting13_d1e13775"/><pre class="programlisting"># vncviewer localhost:1</pre><p>Now Windows Setup will start in its accustomed fashion. Install Windows as usual.</p></div><div class="sect2" title="A Discussion of HALs"><div class="titlepage"><div><div><h2 class="title"><a id="a_discussion_of_hals"/>A Discussion of HALs</h2></div></div></div><p>One problem that occasionally pops up at this stage involves the Windows <a id="idx-CHP-13-0936" class="indexterm"/>HAL (hardware abstraction layer). Windows ships with a selection of possible DLLs to implement the abstraction layer, picking one of six choices during the install process. The correct HAL to use with the system is affected by the <code class="literal">acpi, apic</code>, and <code class="literal">vcpus</code> configuration directives, as indicated in <a class="xref" href="ch13s03.html#hals_available_with_windows" title="Table 13-1. HALs Available with Windows">Table 13-1</a>.</p><div class="table"><a id="hals_available_with_windows"/><p class="title">Table 13-1. HALs Available with Windows</p><div class="table-contents"><table summary="HALs Available with Windows" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/><col/></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>OPTIONS</p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>HAL</p></th><th style="border-bottom: 0.5pt solid ; "><p>COMMENTS</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">acpi=0,apic=0</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>HAL.DLL</p></td><td style="border-bottom: 0.5pt solid ; "><p>Standard PC</p>
<p>Non-ACPI Programmable Interrupt Controller (PIC)</p>
<p>Works with everything</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">acpi=0,apic=1</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>HALAPIC.DLL</p></td><td style="border-bottom: 0.5pt solid ; "><p>MPS (Multiprocessor Specification)</p>
<p>Uniprocessor PC</p>
<p>Non-ACPI APIC uniprocessor HAL</p>
<p>Uniprocessor only</p>
<p>Doesn't work with PIC machines</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">acpi=0,apic=1</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>HALMPS.DLL</p></td><td style="border-bottom: 0.5pt solid ; "><p>Non-ACPI APIC multiprocessor HAL</p>
<p>Does not work with ACPI machines</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">acpi=1,apic=0</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>HALACPI.DLL</p></td><td style="border-bottom: 0.5pt solid ; "><p>Advanced Configuration and Power Interface (ACPI)</p>
<p>ACPI PIC (not APIC) HAL</p>
<p>Do these even exist in hardware?</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">acpi=1,apic=1</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><a id="idx-CHP-13-0937" class="indexterm"/>HALAACPI.DLL</p></td><td style="border-bottom: 0.5pt solid ; "><p>ACPI Uniprocessor PC</p>
<p>ACPI APIC uniprocessor HAL</p>
<p>ACPI only</p>
<p>APIC only</p>
<p>Uniprocessor only</p></td></tr><tr><td style="border-right: 0.5pt solid ; "><p><code class="literal">acpi=1,apic=1</code></p></td><td style="border-right: 0.5pt solid ; "><p>HALMACPI.DLL</p></td><td style=""><p>ACPI Multiprocessor PC</p>
<p>ACPI APIC multiprocessor HAL</p></td></tr></tbody></table></div></div><p>The lucky winner becomes <span class="emphasis"><em>$SYSTEMROOT\system32\HAL.DLL</em></span>.</p><p>The easy answer, therefore, is to use <span class="emphasis"><em>HAL.DLL</em></span>, regardless of the values of ACPI and APIC. This should always work, but it might reduce performance. Microsoft also warns that such a configuration is unsupported.<sup>[<a id="CHP-13-FNOTE-2" href="#ftn.CHP-13-FNOTE-2" class="footnote">80</a>]</sup> We generally turn ACPI and APIC on so that Windows will install the ACPI APIC HAL, and it hasn't caused the machine to burst into flames yet.</p><p>With Windows XP, however, this sometimes doesn't work. Setting ACPI can cause the install process to fail, usually by hanging at Setup is Starting Windows. The easiest way to install Windows XP is to leave ACPI and APIC off during the initial boot from the CD-ROM and then turn them on before the first boot into graphical mode.</p><a id="I_programlisting13_d1e13948"/><pre class="programlisting">acpi=0
apic=0
on_reboot = 'destroy'</pre><p>Then go through the initial format, copy, and so on. When the first phase of Windows Setup completes and the VM turns off, change the config file to read:</p><a id="I_programlisting13_d1e13952"/><pre class="programlisting">acpi=1
apic=1
on_reboot = 'restart'</pre><p>This will cause Windows to install the correct HAL during its second-phase installation.</p><p>If you need to change the HAL later on—for example, if you decide to move from a uniprocessor to a multiprocessor configuration—we recommend reinstalling Windows. It's possible to change the HAL manually by overwriting the various driver files, but it's probably not a great idea.</p></div><div class="sect2" title="Installing Windows the Red Hat Way"><div class="titlepage"><div><div><h2 class="title"><a id="installing_windows_the_red_hat_way"/>Installing Windows the Red Hat Way</h2></div></div></div><p>Red Hat's <code class="literal">virt-manager</code> app can handle most of the trouble of setting up Windows for you. Just create a machine from the <code class="literal">virt-manager</code> GUI, select <span class="strong"><strong>Fully Virtualized</strong></span> rather than Paravirtualized in the appropriate dialog, and indicate the location of Windows install media (either an ISO file or physical CD-ROM). Indicate whether you'd like to connect to the network <a id="idx-CHP-13-0939" class="indexterm"/>using a virtual network or shared physical device (corresponding to networking via <code class="literal">virbr</code> and <code class="literal">xenbr</code>, respectively). Install <a id="idx-CHP-13-0940" class="indexterm"/>Windows as normal, using Microsoft's install program.<a id="idx-CHP-13-0941" class="indexterm"/></p><p>The configuration generated by <code class="literal">virt-manager</code> will look something like this:</p><a id="I_programlisting13_d1e14001"/><pre class="programlisting">name = "hal"
uuid = "5b001f4d-7891-90d8-2f55-96a56e8d07df"
maxmem = 512
memory = 512
vcpus = 1
builder = "hvm"
kernel = "/usr/lib/xen/boot/hvmloader"
boot = "c"
pae = 1
acpi = 0
apic = 0
on_poweroff = "destroy"
on_reboot = "restart"
on_crash = "restart"
device-model = "/usr/lib/xen/bin/qemu-dm"
sdl = 0
vnc = 1
vncunused = 1
keymap = "en-us"
disk = [ "file:/var/lib/xen/images/falstaff.img,hda,w" ]
vif = [ "mac=00:16:3e:7e:f3:15,bridge=virbr0,type=ioemu" ]
serial = "pty"</pre><p>Unfortunately, this doesn't get you quite to the end of the Windows install. For whatever reason, the emulated CD-ROM isn't presented to Windows after the first reboot in the install process, so Windows will complain that it can't find its files.</p><p><a id="idx-CHP-13-0942" class="indexterm"/>Red Hat's documentation will tell you that Windows needs to format its virtual disk as a FAT or FAT32 partition so that you can copy the install files to it. While this approach will work, we prefer to avoid FAT32 in favor of NTFS. To get around this problem, we use the I/O emulator. Modify the <code class="literal">disk=</code> line to use QEMU's I/O emulation as follows:</p><a id="I_programlisting13_d1e14015"/><pre class="programlisting">disk = ['&lt;hda&gt;','file:/mnt/winxp.iso,ioemu:hdc:cdrom,r']</pre><p>(Put your definition for the first hard drive in the appropriate place, of course.) The second stanza specifies an ISO to use as a virtual CD-ROM drive, with hardware emulation provided by Xen's hardware emulation layer (inherited from QEMU). When you've made this change, the CD will appear to the domU as a QEMU emulated device, and you can proceed with the installation.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-13-FNOTE-2" href="#CHP-13-FNOTE-2" class="para">80</a>] </sup>So is everything else about running <a id="idx-CHP-13-0938" class="indexterm"/>Windows under Xen, as far as we can tell.</p></div></div></div>
<div class="sect1" title="Windows with the Virtual Framebuffer"><div class="titlepage"><div><div><h1 class="title"><a id="windows_with_the_virtual_framebuffer"/>Windows with the Virtual Framebuffer</h1></div></div></div><div class="epigraph"><p>"What's the best remote administration tool for Windows NT?"</p><p>"A car."</p><div class="attribution"><span>—<span class="attribution">Anonymous, Usenet</span></span></div></div><p>However you've gone about installing Windows, you'll almost certainly want to log in and use the system when it's running. That's where the virtual framebuffer comes in.</p><p>Xen's virtual framebuffer allows you to interact <a id="idx-CHP-13-0943" class="indexterm"/>with the domU at all stages—from BIOS load, through the bootloader, to postsystem boot. It can be accessed through SDL on the local console or via VNC over the network. It's one of the neater features of HVM domUs, and it really helps to cement the illusion of a real machine.</p><p>Wonderful though the virtual framebuffer is, however, it's got some annoyances. Mouse tracking, <a id="idx-CHP-13-0944" class="indexterm"/>for example, can be kind of iffy out of the box. Here are some ways to fix the most common problems that we've had with the VNC framebuffer.</p><p>First, by default Xen's built-in VNC server won't listen on interfaces other than the loopback. To change this behavior, set <code class="literal">vnc-listen</code> in <span class="emphasis"><em>/etc/xen/xend-config.sxp</em></span> to listen on all interfaces:</p><a id="I_programlisting13_d1e14055"/><pre class="programlisting">(vnc-listen '0.0.0.0')</pre><p>You can also specify the IP address of the interface that you want the VNC server to listen on. Note that this will expose the machine's console over the network and should probably only be done on trusted networks.</p><p>One useful trick when working with the VNC framebuffer under Windows is to specify a tablet as the pointing device, rather than a mouse. This improves the mouse tracking by <a id="idx-CHP-13-0945" class="indexterm"/>using absolute positioning.</p><a id="I_programlisting13_d1e14067"/><pre class="programlisting">usb=1
usbdevice="tablet"</pre><p>(The <code class="literal">usb=1</code> line isn't strictly necessary—it's turned on implicitly by <code class="literal">usbdevice=</code>. However, it's a useful reminder that Xen's USB emulation has been turned on.)</p><p>One last minor annoyance: Sometimes the VNC mouse and keyboard interface just stops working (or else the display stops updating). Nine times out of ten, if you close and reopen the VNC session, it'll come back.</p><p>In addition to Xen's virtual framebuffer, you can handle access at the OS level—for example, by installing the VNC server under Windows or using Microsoft's built-in RDP (Remote Desktop Protocol). These have the advantage of allowing the virtual machine to handle its own graphics tasks rather than involving an emulator in dom0. RDP is also a higher-level, more efficient protocol than VNC, analogous to X in its handling of widgets and graphics primitives. We recommend <a id="idx-CHP-13-0946" class="indexterm"/>using it if possible. As <a class="xref" href="ch13s04.html#here_we_see_two_domains_one_running_wind" title="Figure 13-1. Here we see two domains: one running Windows XP and being accessed through VNC; and one Windows Server 2003 domU being accessed through VNC, RDP from the Windows XP domain, and rdesktop from a Linux machine.">Figure 13-1</a> shows, VNC, <a id="idx-CHP-13-0947" class="indexterm"/>RDP, and SDL can coexist, <a id="idx-CHP-13-0948" class="indexterm"/>with multiple independent sessions on the same VM.</p><p>To enable RDP in administration mode, access <span class="strong"><strong>System Properties</strong></span>, click the <span class="strong"><strong>Remote</strong></span> tab, and check the box marked <span class="strong"><strong>Enable Remote Desktop</strong></span>.</p><div class="figure"><a id="here_we_see_two_domains_one_running_wind"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject13_d1e14114"/><img src="httpatomoreillycomsourcenostarchimages333245.png.jpg" alt="Here we see two domains: one running Windows XP and being accessed through VNC; and one Windows Server 2003 domU being accessed through VNC, RDP from the Windows XP domain, and rdesktop from a Linux machine."/></div></div><p class="title">Figure 13-1. Here we see two domains: one running Windows XP and being accessed through VNC; and one Windows Server 2003 domU being accessed through VNC, RDP from the Windows XP domain, and rdesktop from a Linux machine.</p></div><p>Windows XP and Windows Server 2003 include RDP clients. On other platforms, the open source rdesktop client allows you to access Windows machines from Unix-like operating systems (including Mac OS X). Simply run the following:<a id="idx-CHP-13-0949" class="indexterm"/></p><a id="I_programlisting13_d1e14124"/><pre class="programlisting"># rdesktop &lt;destination address&gt;</pre></div>
<div class="sect1" title="Et Voil&#xE0;!"><div class="titlepage"><div><div><h1 class="title"><a id="et_voilagrave"/>Et Voilà!</h1></div></div></div><p>Now you have Windows running. This would be a good time to make a backup of your clean Windows install so that you can conveniently reimage it when something goes wrong. Just create an LVM snapshot or file-based CoW device, as we outline in the <a class="xref" href="ch04.html" title="Chapter 4. STORAGE WITH XEN">Chapter 4</a>. It'll be good for your peace of mind.</p><p>When you've got a backup, you can do whatever it is you are accustomed to do with Windows. We would not presume to instruct you in this regard.</p><p>There are, however, some things to keep in mind about this new Windows install.</p><div class="sect2" title="Windows Activation"><div class="titlepage"><div><div><h2 class="title"><a id="windows_activation"/>Windows Activation</h2></div></div></div><p><a id="idx-CHP-13-0950" class="indexterm"/>Windows licenses and activations are tied to hardware unless you've got a volume license. Thus, it would be a good idea to decide on a hardware configuration ahead of time and keep it constant to avoid the computer demanding reactivation.</p><p>In particular, specify a MAC address so that Xen doesn't randomly generate a new one on every reboot—this is the single most important value in Windows XP's hardware hash calculation. Other things to keep in mind are the memory amount and virtual CD-ROM.</p></div><div class="sect2" title="Graphics Cards"><div class="titlepage"><div><div><h2 class="title"><a id="graphics_cards"/>Graphics Cards</h2></div></div></div><p>Another of the big caveats about Windows under Xen is that it still won't allow you to use 3D hardware—so the scenario of a desktop Linux box that runs games in a Windows domU is still purely in the realm of fantasy for now. As our discussion above has shown, the virtual Windows machine uses an emulated framebuffer via SDL or VNC. Neither of these modes supports any sort of acceleration.<a id="idx-CHP-13-0951" class="indexterm"/></p><p>The problem with hardware access in <a id="idx-CHP-13-0952" class="indexterm"/>HVM mode (this applies to any PCI device, not just graphics cards) is that there's no way to map the hardware's memory space into the memory of the guest—the guest has an additional layer of abstraction, translating a discontiguous block of physical memory into something that the unmodified domU operating system can use. Recently, chipsets have been incorporating an <span class="emphasis"><em>IOMMU</em></span>, which is hardware that can do this translation job in a manner analogous to the processor's memory management unit (hence the name). Xen's support for Intel's IOMMU implementation, under the name of VT-d, is progressing, but it hasn't gotten to the point where it can make a graphics card usable by a Windows domU.<a id="idx-CHP-13-0953" class="indexterm"/></p><div class="sidebar"><a id="vt-d_support"/><p class="title">VT-D SUPPORT</p><p>If you're curious about whether your machine supports VT-d, you can run <code class="literal">xm dmesg | grep -i vt-d</code> in the dom0 to find out. A machine with VT-d will say something like <span class="emphasis"><em>Intel VT-d has been enabled</em></span>. If you see this, congratulations! The next Xen version will likely include facilities to enable you to use this advanced feature.<a id="idx-CHP-13-0954" class="indexterm"/></p></div><p>Another approach to graphics—one that wouldn't require replacement of all existing hardware—would be for the the graphics driver authors to implement the translation from domU addresses to machine addresses in driver software. Rumor has it that NVIDIA has a Xen-aware driver that could be assigned to an HVM domU and used for 3D acceleration; however, it hasn't yet been released, so there's a good chance it doesn't actually exist.</p><p>One other promising direction uses a virtual 3D graphics driver to forward OpenGL calls to the actual graphics hardware. There are a couple of Xen-based projects that use this principle, but they are Linux only at the moment. VMware has also done some work on a driver architecture that allows for 3D, which appears to take the same tack.</p><p>No finished products exist, that we know of, to allow hardware 3D support under <a id="idx-CHP-13-0955" class="indexterm"/>Windows. Nonetheless, it's a much-requested feature, and it is being worked on. We wouldn't make it an essential part of any Xen deployment just yet, however.</p></div></div>
<div class="sect1" title="Paravirtualized Drivers for Windows"><div class="titlepage"><div><div><h1 class="title"><a id="paravirtualized_drivers_for_windows"/>Paravirtualized Drivers for Windows</h1></div></div></div><p>As we've already mentioned (several times), HVM is somewhat slower than paravirtualization. Partially this is because of the need to virtualize memory access; however, this overhead is minimal compared with emulated I/O and its attendant context switches. (See <a class="xref" href="ch12.html" title="Chapter 12. HVM: BEYOND PARAVIRTUALIZATION">Chapter 12</a> for mind-numbing detail.)<a id="idx-CHP-13-0956" class="indexterm"/></p><p>You can address many of the speed issues related to HVM by swapping the emulated devices for paravirtualized devices after the install process completes. These devices will improve I/O speeds dramatically; however, Windows driver support is lacking. There are two options: proprietary and expensive drivers, or free and unfinished ones.</p><div class="sect2" title="Proprietary Windows PVM Drivers"><div class="titlepage"><div><div><h2 class="title"><a id="proprietary_windows_pvm_drivers"/>Proprietary Windows PVM Drivers</h2></div></div></div><p>Three companies have so far provided Windows drivers that take advantage of paravirtualization: XenSource, <a id="idx-CHP-13-0957" class="indexterm"/>Virtual Iron, and <a id="idx-CHP-13-0958" class="indexterm"/>Novell. All of these drivers are signed by Microsoft for trouble-free installation on Windows.</p><p>Citrix, wearing its XenSource hat, produces <a id="idx-CHP-13-0959" class="indexterm"/>paravirtualized drivers for Windows as part of its Xen-based virtualization suite. These drivers work well, and you can test them for yourself by downloading the free version of the XenSource product. Unfortunately, these drivers don't work with the open source version of Xen.</p><p>Virtual Iron (<a class="ulink" href="http://virtualiron.com/">http://virtualiron.com/</a>) also provides paravirtualized drivers for Windows as part of its product. These drivers work with open source Xen, and Virtual Iron has been working on contributing changes to the Xen community. However, the drivers themselves are still closed source.</p><p>Finally, Novell offers Windows PV drivers that work with open source Xen as an independent product. These drivers are quite expensive (to say the least)—they are so expensive that we haven't actually tried them. More information is at <a class="ulink" href="http://www.novell.com/products/vmdriverpack/">http://www.novell.com/products/vmdriverpack/</a> if you're curious.</p><p>At this point, while all of these drivers (in our experience) function as advertised, none of them seem especially compelling to us. We're content to use Windows, with the HVM drivers, solely in light productivity tasks.</p></div><div class="sect2" title="GPL Windows Paravirtualized Drivers"><div class="titlepage"><div><div><h2 class="title"><a id="gpl_windows_paravirtualized_drivers"/>GPL Windows Paravirtualized Drivers</h2></div></div></div><p>There is one thing that you can try if you're sufficiently adventurous. <a id="idx-CHP-13-0960" class="indexterm"/>GPL Windows PV drivers do exist. They are under active development, which is developer-speak for "don't use these for anything important." They work pretty well for us, but occasionally they do something surprising (usually unpleasant). These drivers try to improve <a id="idx-CHP-13-0961" class="indexterm"/>performance by avoiding some of the inefficient device emulation and by using advanced techniques such as TCP Segmentation Offload, or TSO.<a id="idx-CHP-13-0962" class="indexterm"/></p><p>The <a id="idx-CHP-13-0963" class="indexterm"/>GPL PV drivers are easy to install. First, we recommend checking the <span class="emphasis"><em>xen-devel</em></span> archives to figure out which version is the latest. As of this writing, 0.8.8 is the most current version, and it's available at <a id="idx-CHP-13-0964" class="indexterm"/><a class="ulink" href="http://www.meadowcourt.org/WindowsXenPV-0.8.8.zip">http://www.meadowcourt.org/WindowsXenPV-0.8.8.zip</a>. Unfortunately, there's no web page that lists releases, so you'll want to search the archives of the <span class="emphasis"><em>xen-devel</em></span> mailing list to find out the most recent version. (Alternatively, you can check the current version using Mercurial—check the repository at <a class="ulink" href="http://xenbits.xensource.com/ext/win-pvdrivers.hg">http://xenbits.xensource.com/ext/win-pvdrivers.hg</a>.)</p><p>We opted to download the binary driver package directly within an HVM Windows XP Professional instance. It includes a fairly comprehensive set of installation instructions, but we'll go over what we did anyway, just for convenience.</p><p>First, unpack the drivers. We just dragged the appropriate folder to the desktop.</p><p>Next, run <em class="filename">install.bat</em>. Windows will complain several times about the drivers not being signed. Just click <span class="strong"><strong>OK</strong></span>.</p><p>When the install finishes, reboot to make sure that everything still works.</p><p>Assuming you rebooted successfully, you should now be able to access PV devices from Windows. Try creating a scratch device in the dom0, then running an <code class="literal">xm block-attach</code> command like the following (with appropriate names, as always):</p><a id="I_programlisting13_d1e14292"/><pre class="programlisting"># xm block-attach falstaff phy:/dev/mapper/falstaff_sdb sdb w</pre><p>This should cause Windows to notice a new device, use the correct driver, and present a blank disk, which we can then format, as shown in <a class="xref" href="ch13s06.html#adding_a_paravirtualized_disk_with_the_g" title="Figure 13-2. Adding a paravirtualized disk with the GPL PV drivers">Figure 13-2</a>. Similarly, you can attach a network device with the <code class="literal">xm network-attach</code> command.</p><p>Finally, you'll need to edit the <em class="filename">boot.ini</em> file to tell the GPL PV drivers to activate. (You might need to turn on Show Hidden Files and Folders and uncheck Hide Protected Operating System Files in Tools ► Folder Options to make <em class="filename">boot.ini</em> accessible.)</p><a id="I_programlisting13_d1e14310"/><pre class="programlisting">[boot loader]
timeout=30
default=multi(0)disk(0)rdisk(0)partition(1)\WINDOWS

[operating systems]
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS="Windows XP Professional" /noexecute=optin /fastdetect
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS="Windows XP Professional (PV drivers)"
/noexecute=optin /fastdetect /gplpv</pre><p>Here we've modified the boot entry by putting <code class="literal">/gplpv</code> on the end to tell the GPL PV drivers to activate.</p><div class="figure"><a id="adding_a_paravirtualized_disk_with_the_g"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject13_d1e14320"/><img src="httpatomoreillycomsourcenostarchimages333247.png.jpg" alt="Adding a paravirtualized disk with the GPL PV drivers"/></div></div><p class="title">Figure 13-2. Adding a paravirtualized disk with the GPL PV drivers</p></div><p>Now shut down the Windows install.</p><p>Reboot, select the <span class="strong"><strong>Windows XP Professional (PV Drivers)</strong></span> entry from the boot menu, and you should have a full set of PV devices.</p></div></div>
<div class="sect1" title="Ongoing Development"><div class="titlepage"><div><div><h1 class="title"><a id="ongoing_development"/>Ongoing Development</h1></div></div></div><p>Windows under Xen is still immature, but it's already developed far enough to be useful. Using Xen, you can consolidate Windows servers in a robust, manageable platform and run client software in a native environment on the desktop. You have a reasonable way of accessing the machine via the framebuffer or rdesktop, and finally you have PV drivers for reasonable speed.</p><p>All in all, Xen is quite a good platform for Windows. Not perfect, but certainly usable.<a id="I_indexterm13_d1e14339" class="indexterm"/><a id="I_indexterm13_d1e14344" class="indexterm"/></p></div></body></html>