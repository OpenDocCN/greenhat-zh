- en: Chapter 9. GO SERVER-SIDE
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '![image with no caption](httpatomoreillycomsourcenostarchimages671943.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Mapping APIs are popular because they bring a lot of power to the web browser
    that used to be much more difficult for the average developer to achieve. Plenty
    of situations still exist, however, where your application will benefit from scripts
    that run *outside* of the browser. This is when you'll need to go server-side.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we''ll look at two popular technologies that run on a server:
    PHP, a programming language used mostly to output web pages; and MySQL, a database
    for storing text, numbers, and a whole lot more. As opposed to the numerous other
    available technologies, I''ve chosen these two for their ubiquity—almost all web
    hosts support them. They are also solid platforms used by many including, most
    notably, Yahoo!.'
  prefs: []
  type: TYPE_NORMAL
- en: Entire books have been devoted to PHP and MySQL, together and separately. I'll
    only provide a very quick primer to get you started. Then we'll dive into how
    each can help you make better maps, including storing locations and finding the
    nearest locations from your database.
  prefs: []
  type: TYPE_NORMAL
- en: '#59: Install PHP'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: PHP is an extremely popular programming language for easily creating dynamic
    web pages and applications. You can install it on your computer for testing or
    on a server for sharing with the world. In fact, if you have web hosting on a
    server, PHP may already be installed.
  prefs: []
  type: TYPE_NORMAL
- en: You need to use PHP in conjunction with a web server, the most common of which
    is Apache. Requests come from a web browser to your web server, which then looks
    to see if the page being requested uses PHP. If it does, then the page is sent
    to PHP for processing.
  prefs: []
  type: TYPE_NORMAL
- en: Next I show several ways to install PHP—or to determine if it is already installed.
    In only one situation will you have to also worry about installing Apache. Read
    on and we'll get you up to speed with PHP.
  prefs: []
  type: TYPE_NORMAL
- en: Check Your Web Host for PHP
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you already have web hosting, you almost certainly have PHP installed already.
    The easiest way to check is to create a simple PHP file and then try accessing
    it with a web browser.
  prefs: []
  type: TYPE_NORMAL
- en: You'll want to put this new file where you already know HTML files can be accessed.
    Your site administrator (who could also confirm whether you are able to access
    PHP) can point you to your public directory where web pages are stored.
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a new PHP file in your web directory and add these few lines:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: Easy enough. Give the file a name ending in *.php* (I creatively chose *test.php*),
    and then from your web browser, go to its public web address. For example, I might
    go to *mapscripting.com/test.php*.
  prefs: []
  type: TYPE_NORMAL
- en: If you see your own code when you load that file, then you probably don't have
    PHP. You'll need to ask your administrator to install it or find another way to
    use PHP. You'll know PHP is installed, however, if you see an information page
    like the one shown in [Figure 9-1](ch09.html#the_php_info_dumped_by_my_local_machine
    "Figure 9-1. The PHP info dumped by my local machine"). Remember to delete the
    file from your server when you're done.
  prefs: []
  type: TYPE_NORMAL
- en: '![The PHP info dumped by my local machine](httpatomoreillycomsourcenostarchimages672087.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-1. The PHP info dumped by my local machine
  prefs: []
  type: TYPE_NORMAL
- en: 'If you''re new to PHP, you might want to skip ahead to [#60: A Quick PHP Introduction](ch09s02.html
    "#60: A Quick PHP Introduction") in [Install PHP Yourself](ch09.html#install_php_yourself
    "Install PHP Yourself"). Otherwise, you need to check whether you have MySQL installed,
    too (see [#62: Install MySQL](ch09s04.html "#62: Install MySQL") in [Include Your
    Function in Other Scripts](ch09s03.html#include_your_function_in_other_scripts
    "Include Your Function in Other Scripts")), or connect PHP to MySQL (see [#65:
    Use MySQL from PHP](ch09s07.html "#65: Use MySQL from PHP") in [#65: Use MySQL
    from PHP](ch09s07.html "#65: Use MySQL from PHP")).'
  prefs: []
  type: TYPE_NORMAL
- en: Use a Packaged Installation of PHP
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The easiest way to install PHP on your own computer is to download a package
    for your operating system. The upside to this method is that you'll also get Apache
    and MySQL at the same time, which is useful.
  prefs: []
  type: TYPE_NORMAL
- en: 'The names of the packages are patterned after the popular server architecture,
    *LAMP*, which stands for L*inux*, A*pache*, M*ySQL*, and P*HP*:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Windows (WAMP): [http://www.wampserver.com/](http://www.wampserver.com/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Macintosh (MAMP): [http://www.mamp.info/](http://www.mamp.info/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Either of these packages should install on your computer without needing much
    information from you (though you may have to enter an administrator password).
  prefs: []
  type: TYPE_NORMAL
- en: Open WAMP/MAMP once the install process has completed. The program should open
    two windows. First, it will open a small status dashboard, as shown in [Figure 9-2](ch09.html#the_mamp_console
    "Figure 9-2. The MAMP console"). Second, the application will also create a new
    web browser window pointed at *localhost*, the name of the server on your own
    computer. By default, you'll see a welcome screen.
  prefs: []
  type: TYPE_NORMAL
- en: '![The MAMP console](httpatomoreillycomsourcenostarchimages672089.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-2. The MAMP console
  prefs: []
  type: TYPE_NORMAL
- en: You'll want to change the directory that WAMP/MAMP uses to look for your files.
    To do this, click the **Preferences** button, which will open a new pane with
    more options. Click the Apache (web server) tab, and then select a new document
    root, as shown in [Figure 9-3](ch09.html#change_the_mamp_document_root "Figure 9-3. Change
    the MAMP document root.").
  prefs: []
  type: TYPE_NORMAL
- en: '![Change the MAMP document root.](httpatomoreillycomsourcenostarchimages672091.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-3. Change the MAMP document root.
  prefs: []
  type: TYPE_NORMAL
- en: Install PHP Yourself
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you're using an operating system for which a package is not available, you'll
    need to install PHP yourself. Too many variations exist to describe in this chapter,
    but many tutorials are available on the Internet to help you.
  prefs: []
  type: TYPE_NORMAL
- en: 'The PHP website is the first place to start: [http://php.org/](http://php.org/).'
  prefs: []
  type: TYPE_NORMAL
- en: '#60: A Quick PHP Introduction'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Some very thick books—much thicker than this one—are dedicated to teaching you
    how to program with PHP. This project will provide the boost necessary to use
    PHP in some of your mapping projects. It will not, however, make you a master.
  prefs: []
  type: TYPE_NORMAL
- en: In the sections that follow you'll learn the very basics about structuring PHP
    code. I'll also show you how to use conditionals, often called *if statements*.
    Next, you'll learn how to work with arrays and then use loops. Finally, I'll show
    how to create your own functions to reduce the amount of PHP you need to write.
  prefs: []
  type: TYPE_NORMAL
- en: The Nitty Gritty
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: PHP code is usually added to a file that ends with a *.php* extension. When
    the program is finished running, the output is most often HTML (though it can
    also be XML, JSON, or any text that can be transferred using HTTP). As such, PHP
    can be interspersed with plain HTML.
  prefs: []
  type: TYPE_NORMAL
- en: 'The PHP portions of the code are surrounded by a special *twi-character blocks*,
    `<?php` and `?>`. For example, try this small bit of code, which combines PHP
    and HTML:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: This code is abbreviated HTML, of course. But from it, you should get an idea
    of how PHP works. And the code will load into a browser and simply display the
    text within the quotes, which is output by PHP's `print` function. Note the semicolon—most
    lines of PHP end with a semicolon. Exceptions exist, however; if you write a command
    on a single line, chances are it needs a `;` at the end.
  prefs: []
  type: TYPE_NORMAL
- en: Variables store values that can be changed or accessed later. They can hold
    numbers, text, and more and usually have a descriptive name, always starting with
    a dollar sign. For example, `$mynum` could be a variable for holding a single
    number.
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is some code similar to the previous code, but containing a few variables:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'When you run this example, it produces the following output:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: The code starts with a text variable ❶, often called a *string*. This variable
    starts the line that will eventually be the code's output. Next, you create a
    number variable ❷. I could have simply set this variable to 6, but I wanted to
    show how to add two numbers together.
  prefs: []
  type: TYPE_NORMAL
- en: In the final line ❸ before outputting our message, I set the string equal to
    itself and then concatenate it with more text, before finally tacking the number
    onto the end. Note that to combine strings, you use a period, but to combine numbers,
    use a plus sign.
  prefs: []
  type: TYPE_NORMAL
- en: If we replaced the plus in line ❷ with a period, the number output at the end
    of the message would be `51` (five followed by a one, instead of the number five
    added to the number one). If we replaced the first period in line ❸ with a plus
    sign, the entire message would be `06`, because the number representation of text
    is zero.
  prefs: []
  type: TYPE_NORMAL
- en: Using the correct operator to combine numbers and text is important because
    the operator you use can change your output a great deal.
  prefs: []
  type: TYPE_NORMAL
- en: Taking Input
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'You can accept input from the user in two ways: from the URL itself or through
    a form. Regardless of which possibility you choose, the method for accessing this
    data within PHP is very similar.'
  prefs: []
  type: TYPE_NORMAL
- en: 'If input is being passed in the URL, you''ll see something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: To get at this info, you'll need to use a special PHP variable called `$_GET`.
    `$_GET` is an associative array, which is a collection of key-value pairs accessed
    using bracket syntax. Generally, you'll want to take the value from this array
    and put it into a new variable.
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, here is some PHP to access the two pieces of input:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'Here''s the output of this PHP program:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: To grab the message ❶, I put the key used in the URL (i.e., **`msg`**`=Hello+there`)
    inside brackets after the `$_GET` variable.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The name of the variables do not need to match the names used in the URL, though
    they can.
  prefs: []
  type: TYPE_NORMAL
- en: Now I want to get at the number, which is the `num=42` section of the URL. I
    use the same method as in the previous code ❷, even though this is a number. Finally,
    I print out both of my new variables, along with some descriptive text ❸. Notice
    the periods used to concatenate the portions of the output.
  prefs: []
  type: TYPE_NORMAL
- en: Retrieving data from a form is very similar. Instead of `$_GET`, you use the
    variable `$_POST`. The only tricky part is that the form must have been sent to
    this page using the `action` attribute in HTML.
  prefs: []
  type: TYPE_NORMAL
- en: If This Is True, Then Do That
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Your PHP programs need to make decisions. Because they aren't able to do this
    on their own, you need to tell them how to decide what to do. You do this using
    a *conditional*—or *if* statement.
  prefs: []
  type: TYPE_NORMAL
- en: We'll build upon the previous example, where we received input in the URL, but
    we'll just use the number portion. We want to look at the number and provide different
    output if the number is a double digit number (10 or greater).
  prefs: []
  type: TYPE_NORMAL
- en: 'Our URL will look something like this: *yourfile.php?num=42*.'
  prefs: []
  type: TYPE_NORMAL
- en: 'And here is the code, including our two conditions:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: First, we grab the number that was passed in the URL ❶. This number is stored
    in a variable that can now be used in the rest of the program. We use this variable
    to create an `if` statement ❷, which checks if the number is less than 10\. If
    it is, a message to that effect is output.
  prefs: []
  type: TYPE_NORMAL
- en: Notice the curly braces, `{` and `}`, after the `if` statement. These hold all
    the code that is run when the `if` statement holds true. Otherwise, everything
    in the curly braces after the `else` ❸ is run instead. You can have an `if` without
    an `else`, but in this case, we want to do something in either of the cases, not
    just one.
  prefs: []
  type: TYPE_NORMAL
- en: Table 9-1. Comparison Operators
  prefs: []
  type: TYPE_NORMAL
- en: '| Operator | Description | When used |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| == | Equal | Numbers or text |'
  prefs: []
  type: TYPE_TB
- en: '| != | Not equal | Numbers or text |'
  prefs: []
  type: TYPE_TB
- en: '| > | Greater than | Mostly numbers |'
  prefs: []
  type: TYPE_TB
- en: '| < | Less than | Mostly numbers |'
  prefs: []
  type: TYPE_TB
- en: '| >= | Greater than or equal | Mostly numbers |'
  prefs: []
  type: TYPE_TB
- en: '| <= | Less than or equal | Mostly numbers |'
  prefs: []
  type: TYPE_TB
- en: There are six operators, shown in [Table 9-1](ch09s02.html#comparison_operators
    "Table 9-1. Comparison Operators"), to use when comparing variables. The operators
    are most useful to compare numbers, but can also be used to compare text.
  prefs: []
  type: TYPE_NORMAL
- en: Quite the Array
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'So far I''ve shown two types of variables: text and numbers. Two other common
    types are available, which I''ll introduce in this section.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The first is an *array*. An array is a single variable that holds many other
    variables so you don''t have to name them individually. A simple array tracks
    the values it holds by index, which starts counting at zero. You can declare an
    array like so:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: In this example, I used text. An array can also hold numbers, or a combination
    of numbers and text. It can also hold other arrays and objects, but let's keep
    it simple for now. Notice that the `array` function takes any number of values,
    separated by commas.
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is the line of code to print George (the third option):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: Notice the index is 2, instead of 3\. That's because the index starts at 0\.
    And the index goes inside square brackets `[` and `]` when accessing the values.
  prefs: []
  type: TYPE_NORMAL
- en: The other kind of array I want to show you is called an *associative array*.
    Instead of using an index to track the values inside the array, it uses a textual
    key.
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, you could access George using an associative array in this way:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'We still use the bracket notation, but instead of our index, we use our text
    key. And here is how that associative array may have been declared:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: As with a standard array, the items are separated by commas inside the `array`
    function. In this case, however, `key => value` pairs are used to declare how
    each item in the array will be accessed.
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, I'll show how you could loop through array values.
  prefs: []
  type: TYPE_NORMAL
- en: Feelin' Loopy
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you want to do the same thing many times, you can achieve this by using a
    loop structure. This section will include the `for` and `foreach` loops in PHP.
    We'll visit each value in an array and output its contents.
  prefs: []
  type: TYPE_NORMAL
- en: 'Consider this simple array:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'Now let''s loop through it and print out each name:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'When you run this code, it will print out the name of the band:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: We do this by creating an index variable, starting at zero. The program goes
    through the loop until that index variable is no longer less than the total number
    of items in the array ❶. The increment operator `++` is used to increase the index
    by one each time ❷.
  prefs: []
  type: TYPE_NORMAL
- en: To print the name simply means accessing the current index in the array variable
    ❸. Then, it also prints some text between the names, but only when the index is
    less than the total number minus one ❹. Because the total number is two, this
    will only happen during the first time through the loop, when zero is less than
    one.
  prefs: []
  type: TYPE_NORMAL
- en: If you add your last name as a third item in the `$bandmates` variable and run
    the code again, you'll see another `and` thrown in (and you'll have put yourself
    in the band).
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s use another loop to go through an associative array. We''ll stick with
    the same band, but focus our attention on their hair instead. Is it straight or
    curly? Consider this associative array:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: 'Now let''s loop through this array to share what we know about their hair:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'Finally, here''s the output:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: In this case, we're accessing both the key and the value in each element of
    the associative array. Then, at each step, we're printing them both out.
  prefs: []
  type: TYPE_NORMAL
- en: Get Functional
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Creating your own functions in PHP can save you time typing. You'll also find
    it's good practice. The way you create PHP functions is quite similar to JavaScript,
    so you may be closer than you realize to being able to use your own functions.
  prefs: []
  type: TYPE_NORMAL
- en: For this example, we'll create a function that takes a number as input and returns
    that same number quadrupled. This function may not be especially useful, but it
    is just simple enough to teach how functions work in PHP.
  prefs: []
  type: TYPE_NORMAL
- en: 'Within your PHP brackets, `<?php` and `?>`, include this code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'Like I said, a simple function: It contains a name and is passed a single variable
    ❶. This variable is local to just this function, meaning it doesn''t have to exist
    elsewhere. You can name the variable whatever you want.'
  prefs: []
  type: TYPE_NORMAL
- en: Then I created another variable ❷ to hold the quadrupled value. This variable
    is also local, so we're just using it inside the function. Note that the multiplication
    operator is an asterisk. Armed with our new value, we need to pass it back out
    ❸ to whichever line of code called our new `quadruple` function.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now let''s call our function. And to show how useful this function is, we''ll
    call it on several numbers in a row using an array and a loop. Create a new PHP
    file with this code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: Here I've used a `foreach` loop on a regular, nonassociative array. To do this,
    I simply use one value ❶ instead of a key-value pair. Then, for every item in
    the array, I use the new function to quadruple the number ❷.
  prefs: []
  type: TYPE_NORMAL
- en: 'When all is said and done, here is the output:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: 'And with that, you know the basics of PHP. You''ve interspersed it with HTML.
    You learned several types of variables: numbers, text, arrays, and associative
    arrays. You can help your code think with conditionals, and you can use loops
    and functions to keep your code small and reusable.'
  prefs: []
  type: TYPE_NORMAL
- en: 'To learn how to grab web pages or connect PHP to a web service, continue to
    the next section. And to connect PHP to a database, you''ll want [#65: Use MySQL
    from PHP](ch09s07.html "#65: Use MySQL from PHP") in [#65: Use MySQL from PHP](ch09s07.html
    "#65: Use MySQL from PHP").'
  prefs: []
  type: TYPE_NORMAL
- en: '#61: Retrieve a Web Page'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: One of the most common reasons to use a server-side language like PHP is to
    be able to make calls to web services. Some services provide a result that can
    be read directly into the browser with JavaScript. Taking these calls server-side
    gives you more freedom to use or store the results, however.
  prefs: []
  type: TYPE_NORMAL
- en: Calling a web service is exactly like loading a web page. You pass a URL to
    a server, and it responds with code (HTML for a web page, usually XML for a web
    service). In PHP, the code is put into a string variable, which holds a bunch
    of text. From there, you can do whatever you want with the web page—print it out,
    cut it apart, parse it into data, store it away. But first, let's just work on
    *getting* the web page.
  prefs: []
  type: TYPE_NORMAL
- en: PHP 5 comes with a standard library called *cUrl*. The library is all about
    making network connections. In earlier versions of PHP, you might have used the
    `file` function to do this, which was kind of duct-taped on. Switch to cUrl—it's
    made for doing URL grabbing.
  prefs: []
  type: TYPE_NORMAL
- en: Of course, the `file` function is so easy. Just one line and you had the content
    from a web page. As you'll see, cUrl is a little bit more involved. Let's make
    our own function, however, so we can reuse it in many places (as I have done several
    times in this book). Then we'll have all the convenience of `file` with the power
    of cUrl.
  prefs: []
  type: TYPE_NORMAL
- en: 'In an empty PHP file, add the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: Our function, which I've named `get_url`, has one parameter, the URL ❶. This
    input is what it needs to do its job, which is to fetch a web page. Once inside
    the function, we need to initialize a cUrl object ❷, so we can begin using it.
  prefs: []
  type: TYPE_NORMAL
- en: Now let's tell cUrl what we need by setting options. First, we tell it the URL
    we want to fetch ❸. Then we explain that we want to get back the content the URL
    will send ❹. Some people use cUrl to send information only, in which case they
    don't care about the reply. We do.
  prefs: []
  type: TYPE_NORMAL
- en: Notice that each time we set options, we passed the `$c` variable that we created
    when we initialized cUrl. That variable is important because it keeps track of
    the options we set and the status of our cUrl session.
  prefs: []
  type: TYPE_NORMAL
- en: With the options set, we make the call to the URL ❺ with the content stored
    in a normal variable. First, we run it through the `trim` function to remove any
    spaces or carriage returns from the beginning and end of the file. Otherwise,
    we get the exact data that a web browser would get.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now we''ll clean up our mess, so we tell cUrl that we''re done ❻. Then the
    most important part: We return the content ❼ from this function. This is how we
    get the results of the web page out of the function and into whatever variable
    we declare.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s test our new function. Below the `Additional code may go here` line,
    let''s add this line, which will grab the home page of the book''s website:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: If you load your PHP file into a browser, you should get a web page. The web
    page is coming from your new function! Open [http://mapscripting.com/](http://mapscripting.com/)
    in another browser window, and you'll see almost the same thing, though styles
    and images might be missing from your copy—that's because you're only loading
    the HTML.
  prefs: []
  type: TYPE_NORMAL
- en: 'What''s the big deal with using PHP to show the stripped-down version of this
    book''s website? It isn''t a big deal; this is just a proof of concept. The really
    great stuff comes when you download XML from a web service. I show more of how
    that works in [#52: Use XML](ch08.html#number_symble_52_colon_use_xml "#52: Use
    XML") in [#52: Use XML](ch08.html#number_symble_52_colon_use_xml "#52: Use XML").'
  prefs: []
  type: TYPE_NORMAL
- en: Include Your Function in Other Scripts
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: One way to make your `get_url` function accessible in other PHP scripts you
    write is to copy and paste it in every time. Of course, cutting and pasting each
    time is the hard way and difficult to keep up-to-date if you change the function;
    you would have to change it everywhere that you pasted it.
  prefs: []
  type: TYPE_NORMAL
- en: Instead, create an include file that you can call from other scripts. Take the
    previous code, not including the two lines we used to test the function, and put
    them in a new file. I named the file *net_func.inc.php*, thinking I might add
    more network-related functions down the road. I gave a non-*.php* extension to
    the file because I didn't want it to be mistaken for something that can be shown
    directly to a web browser.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now start a new PHP file, so you can test including your new function file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: The results from this test should be the same as the previous test. Only now
    the code for the `get_url` function is separate from the code that calls it, which
    will allow us to use it easily in many places.
  prefs: []
  type: TYPE_NORMAL
- en: '#62: Install MySQL'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: MySQL is a popular database platform that is available across most operating
    systems. You can install it on your own computer, and you can also run it on a
    web server, which means using it as a data source for applications is easy.
  prefs: []
  type: TYPE_NORMAL
- en: For the uninitiated, a *database* contains one or more tables that are used
    to store data. At a very crude level, you can think of a database as a spreadsheet,
    like a Microsoft Excel file, that can be accessed in part or whole and filtered
    for only the stuff you care about. Instead of worksheets, you have tables. Every
    row of a worksheet is a new *database record*. The columns across the top of most
    worksheets are the *database fields*—they describe the data that goes in that
    column. In fact, when people talk about databases, they often speak about rows
    and columns.
  prefs: []
  type: TYPE_NORMAL
- en: The SQL part of MySQL stands for *structured query language*, the syntax to
    communicate with a database server. MySQL and many other database servers use
    a standard set of statements (called SQL-92), though each also has its own dialect.
  prefs: []
  type: TYPE_NORMAL
- en: You will find MySQL most useful when combined with some other technologies.
    The examples in this chapter use PHP for a programming language and Apache for
    a web server. Read on, however, to get the details about using MySQL by itself.
  prefs: []
  type: TYPE_NORMAL
- en: Check Your Web Host for MySQL
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If you have web hosting, you may have MySQL installed already. You''ll want
    to look in your control panel or double-check with your administrator that MySQL
    is available and set up for your account. Ask about one or both of these two common
    methods for using MySQL:'
  prefs: []
  type: TYPE_NORMAL
- en: '| **phpMyAdmin** A web dashboard for accessing MySQL. As the name implies,
    PHP must also be installed. By using this method, you can create database tables
    and look at data in a visual, point-and-click manner that beginners often prefer.
    |'
  prefs: []
  type: TYPE_TB
- en: '| **Command Interpreter** A command-line utility that lets you access MySQL
    from a text interface. Creating database tables and all other operations occur
    via typed commands. |'
  prefs: []
  type: TYPE_TB
- en: All examples in this chapter will be shown using both methods. In some cases,
    the differences are minimal because you will need to type commands into phpMyAdmin
    as well.
  prefs: []
  type: TYPE_NORMAL
- en: 'If MySQL is installed, you''re ready to move on to [#63: Store Locations to
    a Database](ch09s05.html "#63: Store Locations to a Database") in [Install MySQL
    Yourself](ch09s04.html#install_mysql_yourself "Install MySQL Yourself").'
  prefs: []
  type: TYPE_NORMAL
- en: Use a Packaged Installation of MySQL
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To install MySQL on your own computer, the easiest method is to download a package
    for your operating system that is ready to go. When you follow this route, you'll
    also get PHP and Apache at the same time, which is useful.
  prefs: []
  type: TYPE_NORMAL
- en: 'The names of the packages are patterned after the popular server architecture,
    LAMP, which stands for L*inux*, A*pache*, M*ySQL*, and P*HP*:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Windows (WAMP): [http://www.wampserver.com/](http://www.wampserver.com/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Macintosh (MAMP): [http://www.mamp.info/](http://www.mamp.info/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Either of these packages should install on your computer without much information
    from you (though you may have to enter an administrator password).
  prefs: []
  type: TYPE_NORMAL
- en: Open WAMP/MAMP once the install process has completed. The program should create
    a new web browser window pointed at *localhost*, the name of the server on your
    own computer. By default, a welcome screen will appear, as shown in [Figure 9-4](ch09s04.html#the_mamp_welcome_screen
    "Figure 9-4. The MAMP welcome screen").
  prefs: []
  type: TYPE_NORMAL
- en: '![The MAMP welcome screen](httpatomoreillycomsourcenostarchimages672093.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-4. The MAMP welcome screen
  prefs: []
  type: TYPE_NORMAL
- en: To administer your MySQL installation, click the **phpMyAdmin** link. Now you're
    ready for the next project.
  prefs: []
  type: TYPE_NORMAL
- en: Install MySQL Yourself
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you're using an operating system that does not have a package available,
    you will need to install MySQL yourself. Too many variations exist to describe
    in this chapter, but many tutorials are available on the Internet to help you
    out.
  prefs: []
  type: TYPE_NORMAL
- en: 'The MySQL website is the first place to start: [http://mysql.org/](http://mysql.org/).'
  prefs: []
  type: TYPE_NORMAL
- en: When you are up and running, keep on reading for geographic-specific instructions.
  prefs: []
  type: TYPE_NORMAL
- en: '#63: Store Locations to a Database'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To build extremely powerful mapping applications, you'll want to use a database.
    By maintaining your own data, your site will be quicker and you can do more interesting
    things. First, however, you'll need to create the database and add some locations
    to it. This section will describe how to get started with a MySQL location database.
  prefs: []
  type: TYPE_NORMAL
- en: At this point, we need to get our jargon straight. That data, which lives in
    a database, actually resides in a database *table*. Before you can create a table,
    you need to have a database. MySQL is a database management system that can contain
    many individual databases, which themselves have many tables.
  prefs: []
  type: TYPE_NORMAL
- en: Create a New Database
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you're using MySQL through a hosting provider, you likely already have a
    database assigned to you. Even your database contains other tables already (say,
    for blogging software), you can still use it for this project. We will simply
    be creating an additional database table.
  prefs: []
  type: TYPE_NORMAL
- en: If you don't have a database, creating one is easy in phpMyAdmin. From the main
    screen, simply type the name of your database into the form (I chose *mapscripting*)
    and click the **Create** button (see [Figure 9-5](ch09s05.html#create_a_new_database-id1
    "Figure 9-5. Create a new database.")). Or, using the MySQL Command Interpreter,
    type **`create database("mapscripting");`**.
  prefs: []
  type: TYPE_NORMAL
- en: '![Create a new database.](httpatomoreillycomsourcenostarchimages672095.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-5. Create a new database.
  prefs: []
  type: TYPE_NORMAL
- en: Once completed, you need to select the database name, by clicking it or typing
    **`\u mapscripting`** in the interpreter. Now you're ready to create the database
    table.
  prefs: []
  type: TYPE_NORMAL
- en: Create a Database Table
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Now that you have a database, you can begin adding tables. I'm keeping this
    example simple, so we're only going to have one table.
  prefs: []
  type: TYPE_NORMAL
- en: To create a new table in phpMyAdmin, you fill out the form on the database's
    main page. You need to give the table a name and choose a number of fields. I'm
    calling my table *places*, and it will have four fields, which are types of values
    that every place will contain. Click the **Go** button to further define the table.
  prefs: []
  type: TYPE_NORMAL
- en: As you can see in [Figure 9-6](ch09s05.html#create_a_table_with_four_fields
    "Figure 9-6. Create a table with four fields."), we need to name each field and
    give it a type. The four fields I'm adding to our basic place table are *id* (unique
    identifier), *label* (a name for the place), *latitude*, and *longitude*.
  prefs: []
  type: TYPE_NORMAL
- en: '![Create a table with four fields.](httpatomoreillycomsourcenostarchimages672097.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-6. Create a table with four fields.
  prefs: []
  type: TYPE_NORMAL
- en: The identifier is a good idea for any database table because it makes distinguishing
    one piece of data from another easy. I've made the identifier a *bigint*, meaning
    it is an integer that can get very large (up to 9 quintillion—that's 18 zeros).
    We don't want to worry about counting the number ourselves, however, so we need
    to make sure MySQL does it for us.
  prefs: []
  type: TYPE_NORMAL
- en: Look on the far right in phpMyAdmin (you may need to scroll horizontally), and
    you'll find the Extra column. Select the drop-down for the `id` row and choose
    **auto_increment**. Then, also click the option directly to the right, the one
    with the icon that looks like a key. See [Figure 9-7](ch09s05.html#make_the_identifier_field_auto-increment
    "Figure 9-7. Make the identifier field auto-increment.") for an example. Selecting
    this will make the identifier the primary key. Both of these steps are necessary
    for MySQL to do the counting for you.
  prefs: []
  type: TYPE_NORMAL
- en: 'The remaining fields are fairly simple. The label is a short (100 character)
    description of the place and then the location is stored as two floating point
    (decimal) numbers: latitude and longitude, no doubt quite familiar to you by now.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Click the **Save** button and you''ve created a table. To do the same in the
    Command Interpreter (or using phpMyAdmin''s SQL window), type the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: Now that you have a table, let's start adding data to it.
  prefs: []
  type: TYPE_NORMAL
- en: '![Make the identifier field auto-increment.](httpatomoreillycomsourcenostarchimages672099.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-7. Make the identifier field auto-increment.
  prefs: []
  type: TYPE_NORMAL
- en: Add Data to Your Places Table
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Your places table, with its four fields, is sitting happily inside your database,
    but you have a problem. The table is empty. It doesn't have any data. Let's add
    some.
  prefs: []
  type: TYPE_NORMAL
- en: Within phpMyAdmin, click the table name and then the Insert tab. You should
    see another form (as shown in [Figure 9-8](ch09s05.html#enter_values_in_your_places_table
    "Figure 9-8. Enter values in your places table.")) with four fields. This time,
    instead of names, which are already listed, you'll enter values.
  prefs: []
  type: TYPE_NORMAL
- en: Leaving the `id` value empty is important. MySQL will create that value because
    it's counting (auto-incrementing) for us. In the other boxes, type a descriptive
    name, followed by latitude and longitude. Then click **Go**.
  prefs: []
  type: TYPE_NORMAL
- en: 'You don''t have to add data via phpMyAdmin. You can also use plain SQL (such
    as in the Command Interpreter). To add Old Faithful to the `places` table, type
    the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: Notice that I don't include the `id` here at all. I want MySQL to deal with
    it. The other three fields are first listed by name and then by the values I want
    to add to them.
  prefs: []
  type: TYPE_NORMAL
- en: 'After performing these tasks, you''ve added a single place to your places database
    table. Add a few more, varying the labels, latitude, and longitude. You have yourself
    an up-and-coming location database now. Within phpMyAdmin, click the Browse tab
    to see your places, or type this SQL in the Command Interpreter: **`select * from
    places;`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '![Enter values in your places table.](httpatomoreillycomsourcenostarchimages672101.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-8. Enter values in your places table.
  prefs: []
  type: TYPE_NORMAL
- en: Now you can do something interesting with the location database, such as plot
    locations from a database or get the nearest locations from a database.
  prefs: []
  type: TYPE_NORMAL
- en: '#64: Import Data from a Spreadsheet'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: If you're sold on getting your location data into a database (and I hope you
    are), you'll want a way to make it easy. Filling out form after form or writing
    out SQL inserts by hand is tedious. In this section, I'll show how to use a spreadsheet,
    convert it to CSV, and then import it directly into MySQL.
  prefs: []
  type: TYPE_NORMAL
- en: Earlier I compared a database table to a spreadsheet. Both have columns, which
    in a database are also referred to as field names. Both have rows, which we call
    database records. The easiest way to prepare a lot of data for a database is to
    use a spreadsheet, such as Excel or OpenOffice Calc. Work on your spreadsheet
    as you normally would. [Figure 9-9](ch09s06.html#a_database_table_is_similar_to_a_spreads
    "Figure 9-9. A database table is similar to a spreadsheet.") shows an example
    of how the places database I created in the previous project might look as a spreadsheet.
  prefs: []
  type: TYPE_NORMAL
- en: Make sure you have a few rows filled out, and then save a copy of your spreadsheet.
    Instead of saving as the normal spreadsheet format, scroll through your list of
    file types, and choose **Comma-Separated, .csv**. This format is a simple, universal
    one for storing data.
  prefs: []
  type: TYPE_NORMAL
- en: 'I chose the name *places.csv* for my file, which looks like this when I open
    it in a plain-text editor:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: '![A database table is similar to a spreadsheet.](httpatomoreillycomsourcenostarchimages672103.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-9. A database table is similar to a spreadsheet.
  prefs: []
  type: TYPE_NORMAL
- en: Now you're ready to import this comma-separated values (CSV) version of the
    database table. Within phpMyAdmin, navigate to the places table and click the
    Import tab. First, you'll select the file to import, so click the **Browse** button
    and choose your CSV file. If your file has a header row, as mine does, be sure
    to fill out the form to skip one record because you don't want to import the field
    names as values.
  prefs: []
  type: TYPE_NORMAL
- en: Scroll down to the File Import section. It is probably set to SQL because that's
    the main way MySQL expects to read in files. Choose **CSV** instead. Then fill
    out the options as shown in [Figure 9-10](ch09s06.html#import_a_comma-separated_file_into_mysql
    "Figure 9-10. Import a comma-separated file into MySQL."). Fields are terminated
    by a comma; fields are enclosed by a double quote character; and fields are escaped
    by backslash. You can let line terminators be determined automatically.
  prefs: []
  type: TYPE_NORMAL
- en: '![Import a comma-separated file into MySQL.](httpatomoreillycomsourcenostarchimages672105.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-10. Import a comma-separated file into MySQL.
  prefs: []
  type: TYPE_NORMAL
- en: The final option is a list of fields to import. If you are importing every field
    in the table, you may not need to enter these. We have an automatically generated
    identifier, however, so we need to specify the columns we are importing, which
    is everything except the `id` column.
  prefs: []
  type: TYPE_NORMAL
- en: Click the **Go** button and your data should be imported. To check, click the
    Browse tab, which will show you the current contents of the places table.
  prefs: []
  type: TYPE_NORMAL
- en: 'You can also import using the Command Interpreter:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: The CSV file will need to be accessible to the machine running MySQL. If you're
    using the interpreter on a server, you'll need to upload the file to the server.
  prefs: []
  type: TYPE_NORMAL
- en: Using a spreadsheet to create your data is the easiest method when you have
    more than just a few records. Also, you may find plenty of other data available
    in this format, so knowing how to import from CSV can help you use other people's
    data, as well.
  prefs: []
  type: TYPE_NORMAL
- en: '#65: Use MySQL from PHP'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Many programming languages have ways to connect to MySQL. PHP includes many
    functions in its default installation, making PHP and MySQL a popular pair. In
    this section, I'll introduce you to the most common functions for accessing your
    MySQL database from PHP.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example assumes you have a location database table like the one
    we created in [#63: Store Locations to a Database](ch09s05.html "#63: Store Locations
    to a Database") in [Install MySQL Yourself](ch09s04.html#install_mysql_yourself
    "Install MySQL Yourself") with at least one place added to the database. Once
    you have your table ready to go, let''s write some PHP to grab all the place descriptions.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a new PHP file with the following content:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: Everything that begins with `mysql_` (shown in bold) is a function associated
    with accessing MySQL from PHP. Many more functions are listed at [http://php.net/mysql](http://php.net/mysql).
  prefs: []
  type: TYPE_NORMAL
- en: In this example, you first connect to MySQL using a server, username, and password
    ❶, which are likely provided by your site administrator. If you're using MAMP,
    you can find the login info on your installation's start page. These values establish
    the connection to MySQL and ensure not just anybody can access your data.
  prefs: []
  type: TYPE_NORMAL
- en: Because MySQL can have many different databases, we need to tell it which one
    to use ❷. Here I've chosen the mapscripting database I created previously. Also,
    I pass along the database connection variable from the previous line.
  prefs: []
  type: TYPE_NORMAL
- en: Now we're ready to get some data from the database. We use SQL to do this, similar
    to what happens behind the scenes on the Browse tab in phpMyAdmin. When using
    MySQL with PHP, you need to write the SQL yourself, which I've put into the variable
    `$sql`, which gets passed to a query ❸ along with the database connection variable.
  prefs: []
  type: TYPE_NORMAL
- en: You can fetch data from a query in many ways, all using the object that is returned
    from the previous line. In this example, we use a `while` loop to look at each
    result one at a time. Whenever the `$row` variable no longer has a value, the
    `while` loop will end.
  prefs: []
  type: TYPE_NORMAL
- en: The value for each result is an associative array ❹, so the results are stored
    as key-value pairs. The table's field name is the key, so we put that inside square
    brackets to get at the value ❺. To finish, we close the connection to the database
    ❻, which frees up resources.
  prefs: []
  type: TYPE_NORMAL
- en: When you run this PHP code, you should see the description of every place you
    added print out, one after another, in no particular format. The output may not
    be pretty, but you have now made a very simple connection to your MySQL database
    from PHP. Better yet, any data you want can now be connected to the Web. Are you
    feeling powerful yet? You should be.
  prefs: []
  type: TYPE_NORMAL
- en: Continue reading to do something a bit more useful with the data in your location
    database.
  prefs: []
  type: TYPE_NORMAL
- en: '#66: Plot Locations from a Database'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This project is the one you've been waiting for. You patiently put in your time
    learning the basics of MySQL and PHP. All you really wanted to do was put some
    points on a map without having to hand code it. Once you master the skills in
    this project, your mapping projects will be much more powerful because they'll
    be driven by data.
  prefs: []
  type: TYPE_NORMAL
- en: 'Believe it or not, you already have the knowledge necessary to plot locations
    from a database. The concepts we''ll be using combine [#65: Use MySQL from PHP](ch09s07.html
    "#65: Use MySQL from PHP") in [#65: Use MySQL from PHP](ch09s07.html "#65: Use
    MySQL from PHP") and the parsing portion of a data formats project, [#53: Use
    JSON](ch08s02.html "#53: Use JSON") in [#53: Use JSON](ch08s02.html "#53: Use
    JSON"), which put the JavaScript framework jQuery to work for us.'
  prefs: []
  type: TYPE_NORMAL
- en: 'This project has two parts: creating the JSON on the server using our database
    and interpreting the JSON in the browser. Let''s go at ''em in that order.'
  prefs: []
  type: TYPE_NORMAL
- en: Output All Places as JSON
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: We'll be using PHP that is only slightly more advanced than what you've written
    in other projects. Rather than printing out each result as we come across it,
    we'll store it. Once we have all the data, we'll print it out as JSON with help
    from a built-in PHP function.
  prefs: []
  type: TYPE_NORMAL
- en: Whenever you are getting data from your database, consider what you need. Here,
    we're going to be plotting our locations on a map, so we'll need, at the very
    least, the latitude and longitude of each place. Having a description of each,
    too, would be nice so we'll also grab our label. Depending on what you're doing,
    you might also like the unique `id`.
  prefs: []
  type: TYPE_NORMAL
- en: How many rows do you want? For our example, let's get them all. Bear in mind
    that if your table is very large, you could be setting your users up for quite
    a long download. In that case, you might choose to only get the nearest locations
    from a database, but that's another project. Onward!
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a new PHP file and add the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: We begin with connection details and then go straight to the SQL ❶. I have listed
    the three field names we want to get from the database. Before looping through
    the results, I've created an empty array ❷. We'll use this to hold all the results.
  prefs: []
  type: TYPE_NORMAL
- en: As we loop through every row that the database returns, we use a PHP function
    to "push" the result to the end of our array ❸. You may remember that each result
    from the database is itself an associative array, with values stored with field
    names as keys. So the array containing all the rows is really an array *of arrays*.
    A bit confusing, perhaps, but perfectly suited for JSON.
  prefs: []
  type: TYPE_NORMAL
- en: After all of the results are stored in our massive array, we'll convert the
    variable to JSON text and print it out. We can do all of that in one single line
    ❹, assuming we have the JSON extensions (included in all recent PHP installations).
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is the JSON output from my database, which has two rows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: Very likely your results will be all squished together on one line, but I've
    split up the pieces to make more sense of them. When we parse this into JavaScript,
    we'll have an array (defined by square brackets) of objects (defined by curly
    brackets).
  prefs: []
  type: TYPE_NORMAL
- en: Once the data is put into JavaScript, we'll be able to plot it on a map. Let's
    get going.
  prefs: []
  type: TYPE_NORMAL
- en: Plot Places from JSON
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Using PHP we have output all the places in our location database as JSON. Now
    we need to create a map that reads in the data and creates a new marker for every
    place. On the surface, this map is just like any other map we've created before.
    In this case, however, we won't even initialize the map until we hear back from
    the database.
  prefs: []
  type: TYPE_NORMAL
- en: 'Before we get to parsing the JSON results, we need to include the jQuery JavaScript
    framework. Add the following to the header code of a basic Mapstraction map:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: 'Now replace any JavaScript code with the following function to initialize the
    map:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  prefs: []
  type: TYPE_PRE
- en: Unlike other times we've used a `create_map` function, we don't start by making
    a new Mapstraction map. We save this for later, once we've received data. Instead,
    the first thing we do is use jQuery to create an Ajax call to our PHP file (which
    I've called *allplaces.php*) ❶.
  prefs: []
  type: TYPE_NORMAL
- en: 'Once we have a result, *then* we create the map ❷, so we can start adding the
    data to it. Here, we''ve used a `for` loop to go through each place ❸. We can
    then save that object ❹, which has three attributes: label, latitude, and longitude.
    Those values are used to create a marker and give the marker a message box.'
  prefs: []
  type: TYPE_NORMAL
- en: Finally, outside of the `for` loop (so it only happens once), we automatically
    center the map based on our markers. [Figure 9-11](ch09s08.html#database-driven_places_map
    "Figure 9-11. Database-driven places map") shows what my map, which has two landmarks
    as places, looks like.
  prefs: []
  type: TYPE_NORMAL
- en: If I add a third place to the database and reload the page, I'll have a third
    marker. That's the beauty of a database-driven map!
  prefs: []
  type: TYPE_NORMAL
- en: '![Database-driven places map](httpatomoreillycomsourcenostarchimages672107.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-11. Database-driven places map
  prefs: []
  type: TYPE_NORMAL
- en: '#67: Get Nearest Locations from a Database'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In [Chapter 6](ch06.html "Chapter 6. EXPLORE PROXIMITY"), we looked at several
    projects concerning what''s nearby. I showed how to calculate the distance between
    two points and how to determine the closest marker to a point. Arguably more useful
    is what we''ll be doing in this project: getting the nearest location to a point
    from a list of many possibilities stored in a database.'
  prefs: []
  type: TYPE_NORMAL
- en: 'To be able to look at locations in a database, we need to have something in
    the database in the first place. For this example, we''ll be using the places
    database table from [#63: Store Locations to a Database](ch09s05.html "#63: Store
    Locations to a Database") in [Install MySQL Yourself](ch09s04.html#install_mysql_yourself
    "Install MySQL Yourself"). Although we''ve been using MySQL as an engine, most
    databases will work with the SQL statements that follow.'
  prefs: []
  type: TYPE_NORMAL
- en: Because we're looking for the nearest locations to a single point, we need to
    determine what that point is. I've chosen a point near me in Portland with a latitude
    of 45.517 and a longitude of −122.649\. Now we'll plug this into the Haversine
    formula—that's the same bit of trigonometry that we used in [Chapter 6](ch06.html
    "Chapter 6. EXPLORE PROXIMITY") to determine distance. There, we used JavaScript,
    and in this example, we'll use SQL.
  prefs: []
  type: TYPE_NORMAL
- en: 'From either the MySQL Command Interpreter, or in phpMyAdmin, type the following
    query:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  prefs: []
  type: TYPE_PRE
- en: Here we're selecting all the fields from the places table, plus an additional
    field, described by the entire section in bold. That's a lot of code! This code
    calculates the distance between our point and the points in the database using
    the latitude and longitude values stored with each place.
  prefs: []
  type: TYPE_NORMAL
- en: The distance, which becomes a column named dist, is in kilometers. As with the
    previous implementation of the Haversine formula, we multiply by the earth's radius,
    which is 6,371 km. For miles, replace the number ❶ with its mile equivalent (3,958).
  prefs: []
  type: TYPE_NORMAL
- en: When you run the SQL query, your results will be those shown in [Table 9-2](ch09s09.html#results_of_nearest_place_in_sql
    "Table 9-2. Results of Nearest Place in SQL"). Because we ordered by distance,
    the places nearest to our point come first in the table. Therefore, the nearest
    place to the point we selected is Old Faithful geyser. Of course, more useful
    examples will be from a places database with many locations all within the same
    city. Then, based on a point within that city, you can find the closest places,
    which will likely be within a few miles.
  prefs: []
  type: TYPE_NORMAL
- en: Table 9-2. Results of Nearest Place in SQL
  prefs: []
  type: TYPE_NORMAL
- en: '| ID | Label | Latitude | Longitude | Distance |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| 1 | Old Faithful geyser | 44.46 | − 110.83 | 936.12 |'
  prefs: []
  type: TYPE_TB
- en: '| 2 | St. Louis Gateway Arch | 38.62 | − 90.19 | 2765.97 |'
  prefs: []
  type: TYPE_TB
- en: Improve Your Query's Performance
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Database experts will have some big problems with the SQL we used in the previous
    section. You know all that math we used: COS this and RADIANS that? Those are
    being calculated for each row in the database, even if the value isn''t changing.
    The result is a query that will not make your server very happy once you''ve stored
    many places. In computer science terminology, the query has *poor performance*.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s improve performance by storing some values that won''t change in SQL
    variables. The process is similar to PHP variables, but the syntax is a bit different.
    Alter the query from the previous section to look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  prefs: []
  type: TYPE_PRE
- en: The `SET` command is used to store a value into a variable. The variables themselves
    start with the `@` sign. The first three variables are used to hold numbers that
    were previously written directly into the query, making the distance portion of
    the query (again, in bold) easier to read.
  prefs: []
  type: TYPE_NORMAL
- en: The other four variables, beginning with ❶, also improve readability and make
    the query considerably shorter. Even better, performance improves as well. The
    values stored in the variables are only calculated once—when the variable is created.
  prefs: []
  type: TYPE_NORMAL
- en: A number of calculations are still happening as the query runs, which will bog
    down your server. Code like `COS(RADIANS(latitude))` can be avoided, but only
    if we change our database table. In the next section, I'll show you how you can
    further improve your query's performance.
  prefs: []
  type: TYPE_NORMAL
- en: Precalculate Values in New Columns
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The changes you're making to your SQL won't be noticeable until you have many
    locations stored in your database. The flip-side is that with many locations stored
    applying this query becomes more interesting, which could attract more users to
    your site. And that's definitely not the time you want your server to be slow.
  prefs: []
  type: TYPE_NORMAL
- en: 'Some things *have* to be calculated on-the-fly, otherwise the result would
    be the same for every location. You''ll be returning different results for every
    pair of latitude and longitude coordinates. We''ll focus on precalculating these
    three values from the previous section:'
  prefs: []
  type: TYPE_NORMAL
- en: '`COS(RADIANS(latitude))`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`RADIANS(longitude)`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`SIN(RADIANS(latitude))`'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: For every place stored in the database, these values will be different. Once
    the values are set, however, they will remain the same. That's a perfect case
    for adding three columns to your table. We'll name them `cosRadLat`, `radLon`,
    and `sinRadLat` and make them all type `FLOAT`.
  prefs: []
  type: TYPE_NORMAL
- en: 'Here''s the SQL version to add these columns through the Command Interpreter:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  prefs: []
  type: TYPE_PRE
- en: 'Once you''ve added these three columns, you need to fill in the values for
    all the places currently in your table:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  prefs: []
  type: TYPE_PRE
- en: 'Finally, now that you''ve added values to new columns in your table, you can
    use this optimized query to get the nearest locations from your database:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  prefs: []
  type: TYPE_PRE
- en: The result is an even shorter, much faster query. A few calculations still need
    to happen on the fly, but the rest has been precalculated and stored in either
    variables or columns in the places table.
  prefs: []
  type: TYPE_NORMAL
- en: The only other change is that we are explicitly naming the fields to select,
    which is another database best practice. Plus, now that we added the three precalculated
    columns, we don't want to muddy our results with those additional values. Those
    numbers are just to improve speed and aren't particularly useful outside of that.
  prefs: []
  type: TYPE_NORMAL
- en: '#68: Get Nearest Locations to a Postal Code'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Big businesses often have store locators on their website. To use one, you type
    in your postal code and then you get a list of locations nearest yours. In this
    project, I'll show you how to perform the SQL database calls to reproduce this
    feature on your own site.
  prefs: []
  type: TYPE_NORMAL
- en: On one hand, the code to find places near a postal code is the same as the previous
    project. All you need to do is determine the latitude and longitude point of a
    particular postal code, which you can get from most geocoder services, and you'll
    be able to find the closest places.
  prefs: []
  type: TYPE_NORMAL
- en: 'Of course, having a postal code table in your own database is even more useful.
    This process is described in [#15: Get Postal Code Coordinates](ch03s06.html "#15:
    Get Postal Code Coordinates") in [#15: Get Postal Code Coordinates](ch03s06.html
    "#15: Get Postal Code Coordinates"), and I have links to database sources at [http://mapscripting.com/postal-code-database](http://mapscripting.com/postal-code-database).
    Installing your own database will save one step in the process, so you can find
    the ZIP Code''s coordinates and its closest places in one call to the database.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a new database table, which I''ll be calling *postals*. It will have
    three columns: *code*, *latitude*, and *longitude*. As you can see in [Figure 9-12](ch09s10.html#create_a_zip_code_table
    "Figure 9-12. Create a ZIP Code table."), the postal code itself is a five-character
    string (*varchar*) because that''s what is used in the United States, where ZIP
    Codes are five digits.'
  prefs: []
  type: TYPE_NORMAL
- en: '![Create a ZIP Code table.](httpatomoreillycomsourcenostarchimages672109.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 9-12. Create a ZIP Code table.
  prefs: []
  type: TYPE_NORMAL
- en: The postal code is represented as text to account for the situation when the
    code starts with a zero. If you store the code as a number, which is more efficient,
    you will need to account for the starting zero with every lookup. Latitude and
    longitude are floating point numbers, just as they are in the places database.
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is the SQL version to create this table in the command interpreter:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  prefs: []
  type: TYPE_PRE
- en: 'Now you''re ready to add some postal codes to your database. You can do a few
    by hand just for this test, using a geocoder to determine the correct latitude
    and longitude points. A better long-term solution would be to download a full
    postal code database and use [#64: Import Data from a Spreadsheet](ch09s06.html
    "#64: Import Data from a Spreadsheet") in [#64: Import Data from a Spreadsheet](ch09s06.html
    "#64: Import Data from a Spreadsheet").'
  prefs: []
  type: TYPE_NORMAL
- en: 'At this point, your database should have two tables: *places* and *postals*.
    We''ll use both together in one SQL call to determine the nearest places.'
  prefs: []
  type: TYPE_NORMAL
- en: 'From either the MySQL Command Interpreter or phpMyAdmin, type the following
    query:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  prefs: []
  type: TYPE_PRE
- en: Most of the query is the same as the optimized version from the previous project.
    Instead of hard-coding the latitude and longitude, the first line selects it from
    our *postals* database. The portion in bold stores the coordinates in the `@lat`
    and `@lon` variables.
  prefs: []
  type: TYPE_NORMAL
- en: The results of our example query are shown in [Table 9-3](ch09s10.html#results_of_nearest_place_sql-id1
    "Table 9-3. Results of Nearest Place SQL"). Again, because I've chosen a location
    on the west coast of the United States, Old Faithful geyser is closest. As for
    finding places near a point, the really interesting stuff comes when you have
    many places all within one city.
  prefs: []
  type: TYPE_NORMAL
- en: Table 9-3. Results of Nearest Place SQL
  prefs: []
  type: TYPE_NORMAL
- en: '| Label | Latitude | Longitude | Distance |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| Old Faithful geyser | 44.46 | − 110.83 | 1322.32 |'
  prefs: []
  type: TYPE_TB
- en: '| St. Louis Gateway Arch | 38.62 | − 90.19 | 2566.23 |'
  prefs: []
  type: TYPE_TB
