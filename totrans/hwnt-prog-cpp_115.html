<html><head></head><body>

<div class="calibre21" id="calibre_pb_0"/><div class="calibre1" id="calibre_toc_128">
<a name="ch11" class="calibre6" id="ch11"/>
<div class="calibre1">
<h2 class="lot-title" id="calibre_pb_1"><a name="133" class="calibre16" id="133"/><a name="ch11lev1sec7" class="calibre16" id="ch11lev1sec7"/><span class="chapter-titlelabel">Program 112: </span>Hurry Up and Wait</h2><p class="b24-bookeditorial">For some reason this program runs for a while and then stops:</p>
<div class="calibre1">
<pre class="literallayout-normal">
  1 #include &lt;cstdio&gt;
  2 #include &lt;stdlib.h&gt;
  3 #include &lt;pthread.h&gt;
  4 #include &lt;sys/fcntl.h&gt;
  5
  6 // Resource protection mutexes
  7 static pthread_mutex_t resource1 =
  8         PTHREAD_MUTEX_INITIALIZER;
  9
 10 static pthread_mutex_t resource2 =
 11         PTHREAD_MUTEX_INITIALIZER;
 12
 13 /************************************************
 14  * A couple of routines to do work.   Or they    *
 15  *      would do work if we had any to do.      *
 16  ***********************************************/
 17 static void wait_for_work(void) {}      // Dummy
 18 static void do_work(void) {}            // Dummy
 19
 20 /***********************************************
 21  * process_1 -- First process of two.          *
 22  *                                             *
 23  * Grab both resources and then do the work    *
 24  ***********************************************/
 25 static void *process_1(void *)
 26 {
 27     while (1) {
 28         wait_for_work();
 29
 30         pthread_mutex_lock(&amp;resource1);
 31         pthread_mutex_lock(&amp;resource2);
 32
 33         do_work();
 34
 35         pthread_mutex_unlock(&amp;resource2);
 36         pthread_mutex_unlock(&amp;resource1);
 37     }
 38 }
 39
 40 /************************************************
 41  * process_2 -- Second process of two.          *
 42  *                                              *
 43  * Grab both resources and then do the work.    *
 44  *      (but slightly different work from       *
 45  *      process_1)                              *
 46  ************************************************/
 47 static void process_2(void)
 48 {
 49     while (1) {
 50         wait_for_work();
 51
 52         pthread_mutex_lock(&amp;resource2);
 53         pthread_mutex_lock(&amp;resource1);
 54
 55         do_work();
 56
 57         pthread_mutex_unlock(&amp;resources1);
 58         pthread_mutex_unlock(&amp;resource2);
 59     }
 60 }
 61
 62 int main()
 63 {
 64     int status; /* Status of last system call */
 65
 66     /* Information on the status thread */
 67     pthread_t thread1;
 68
 69     status = pthread_create(&amp;thread1,
 70             NULL, process_1, NULL);
 71
 72     if (status != o) {
 73         perror(
 74             "ERROR: Thread create failed:\n   ");
 75         exit (8);
 76     }
 77
 78     process_2();
 79     return (0);
 80 }
</pre>
</div>
<p class="b24-bookeditorial">(Next <a href="LiB0120.html#233" target="_parent" class="calibre2">Hint 97</a>. <a href="LiB0121.html#522" target="_parent" class="calibre2">Answer 24</a>.)</p>
</div>
</div>



</body></html>