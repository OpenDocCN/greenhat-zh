<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Number Utilities"><div class="titlepage"><div><div><h1 class="title"><a id="number_utilities"/>Chapter 5. Number Utilities</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e6854"/><img alt="image with no caption" src="httpatomoreillycomsourcenostarchimages686190.png.jpg"/></div></div><p>Numbers are fundamental for all computers and programming languages, and Ruby is no exception. In this chapter’s scripts, we’ll deal with useful data that is primarily numeric but is otherwise quite diverse. We’ll explore some pure math, following up with recursion, which I introduced in <a class="xref" href="ch04.html" title="Chapter 4. Text Manipulation">Chapter 4</a>. We’ll also do some type conversion, whereby numbers will be represented in different ways that are convenient for human users. We’ll also do some unit conversion, specifically monetary units.<sup>[<a class="footnote" href="#ftn.CHP-5-FNOTE-1" id="CHP-5-FNOTE-1">12</a>]</sup> While doing all of this, we’ll also delve further into metaprogramming, Hashes, using external libraries, and two distinct formats for data storage in external files: XML (eXtensible Markup Language) and YAML (YAML Ain’t Markup Language). That’s a lot of ground to cover, so let’s get started.</p><div class="sect1" title="#15 Computing Powers (power_of.rb)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp15_computing_powers_power_ofrb"/>#15 Computing Powers (power_of.rb)</h1></div></div></div><p>This is the most purely mathematical of this chapter’s scripts, and it deals with <a class="indexterm" id="idx-CHP-5-0441"/>exponentiation. Before we get too far into the script itself, let’s use irb to explore how Ruby handles exponentiation:<a class="indexterm" id="idx-CHP-5-0442"/><a class="indexterm" id="idx-CHP-5-0443"/></p><a id="I_programlisting5_d1e6884"/><pre class="programlisting">irb(main):001:0&gt; 2 ** 2    <em class="lineannotation"><span class="lineannotation">Exponentiation</span></em>
=&gt; 4
irb(main):002:0&gt; 2 ** 3
=&gt; 8</pre><p>As you can see, the way to express “to the power of” in Ruby is with the double asterisk. Since both the number raised to some power and the power itself are expressions, they can also be more complex, like this:</p><a id="I_programlisting5_d1e6891"/><pre class="programlisting">irb(main):003:0&gt; 2 ** (1 + 2)
=&gt; 8
irb(main):004:0&gt; 8 ** (1.0/3.0)
=&gt; 2.0</pre><p>You can raise a number (called the <span class="emphasis"><em>base</em></span>) to a given exponent easily with the <code class="literal">**</code> operator. As you can see in line four in the above code, when you want to reverse a traditional exponentiation, you can use a <a class="indexterm" id="idx-CHP-5-0444"/>reciprocal power.<a class="indexterm" id="idx-CHP-5-0445"/></p><div class="note" title="Note"><h3 class="title"><a id="note-35"/>Note</h3><p><span class="emphasis"><em>We use floating-point numbers for the exponent in ❶, because we don’t want our expression to be rounded down to zero</em></span>.</p></div><p>If you have the base and the exponent, you can find the missing result. If you have the result of the exponentiation and the exponent, you can undo your operation to find the base by using the reciprocal of the exponent. What if you know the base and the result, and want to find the exponent? That’s what this script is for. Let’s take a look.</p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id014"/>The Code</h2></div></div></div><a id="I_programlisting5_d1e6918"/><pre class="programlisting">  #!/usr/bin/env ruby
  # <a class="indexterm" id="idx-CHP-5-0446"/>power_of.rb

  class Integer

  =begin rdoc
  Add a simple &lt;b&gt;Integer&lt;/b&gt;-only method that reports the
  exponent to which the base must be raised to get self.
  =end
❶   def power_of(base)    <em class="lineannotation"><span class="lineannotation">Recursion</span></em>
      # return nil for inapplicable situations
      return nil   unless base.is_a?(Integer)    <em class="lineannotation"><span class="lineannotation">The<strong class="userinput"><code> is_a?</code></strong> Method</span></em>
❷     return nil   if (base.zero? and not [0,1].include?(self))

      # deal with odd but reasonable
      # numeric situations
❸     return 1     if base == self
❹     return 0     if self == 1
❺     return false if base == 1
❻     return false if base.abs &gt; self.abs    <em class="lineannotation"><span class="lineannotation">The<strong class="userinput"><code> abs</code></strong> Method</span></em>

❼     exponent = (self/base).power_of(base)
❽     return exponent ? exponent + 1 : exponent
    end

  end</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id013"/>How It Works</h2></div></div></div><p>We want this operation to be a method that can be called on any Integer, so we take advantage of Ruby’s open classes and simply add a new method. We have the standard boilerplate and RDoc up to the method definition at ❶, which shows that it takes an argument called <code class="literal">base</code>. The lines up to and including ❷ cause our <code class="literal">power_of</code> method to exit early under conditions that are not appropriate for it to do its job. We return the <code class="literal">nil</code> value when asked to find a power in relation to a <code class="literal">base</code> that isn’t even an Integer, because that question is meaningless. We also return <code class="literal">nil</code> when the <code class="literal">base</code> is zero and the result is neither zero nor one, because zero raised to any power will always be either zero or one, making that question also meaningless.</p><p>There will certainly be other situations where our response is meaningful. We return <code class="literal">1</code> at ❸ if the <code class="literal">base</code> and the result of the exponentiation (<code class="literal">self</code>) are the same value, because any number to the power of one will be itself. We return <code class="literal">0</code> at ❹ if <code class="literal">self</code> is one, because any number raised to the zero power will equal one. This is confusing for many people. How can something multiplied by itself zero times be anything?</p><p>The answer lies in what’s called the <span class="emphasis"><em>multiplicative identity</em></span>, which is how mathematicians describe the fact that any number times one equals one times that number as well as that number itself. You can always assume with any standard multiplication that there could be any number of “times one” additions to your multiplication, and it won’t matter. We can also see this in irb:<a class="indexterm" id="idx-CHP-5-0447"/></p><a id="I_programlisting5_d1e6990"/><pre class="programlisting">irb(main):005:0&gt; (42 * 1) == (1 * 42)
=&gt; true
irb(main):006:0&gt; (1 * 42) == (42 * 1)
=&gt; true
irb(main):007:0&gt; (42 * 1) == 42
=&gt; true
irb(main):008:0&gt; (1 * 42) == 42
=&gt; true</pre><p>Since you can always assume a “times one” for anything multiplied by itself twice, or by itself once, you can similarly assume it for something multiplied by itself zero times, which is all raising something to the zero power means. Therefore, raising something to the zero power will result in a value of one.</p><p>At ❺, we return <code class="literal">false</code> if the base is one. This is because one can never be raised to a power that will result in a value other than one. How do we know that our result isn’t one? Because we would have already returned a zero at ❹ if <code class="literal">self</code> was one. At ❻, we also return <code class="literal">false</code> if the absolute value of the <code class="literal">base</code> (acquired through calling <code class="literal">base.abs</code>) is greater than the absolute value of <code class="literal">self</code>. We do this because you can’t raise a <code class="literal">base</code> to an Integer power and get a result with a smaller absolute value than your original <code class="literal">base</code>.</p><p>Everything from ❶ to ❻ deals with the odd cases—either meaningless situations or situations that let us know we’re finished, otherwise known as <span class="emphasis"><em>exit conditions</em></span>. What happens next? If a given number is a power of a given <code class="literal">base</code>, it means that that number divided by the <code class="literal">base</code> is also a power of the <code class="literal">base</code>, but the exponent will be one lower. Let’s demonstrate in irb.<a class="indexterm" id="idx-CHP-5-0448"/></p><a id="I_programlisting5_d1e7038"/><pre class="programlisting">irb(main):009:0&gt; 3 ** 3
=&gt; 27
irb(main):010:0&gt; 3 ** 2
=&gt; 9
irb(main):011:0&gt; 27 == 9 * 3
=&gt; true</pre><p>Three to the third power is 27, three to the second power is nine, and 27 is equal to nine times three. If we’re trying to find an exponent and none of our base cases apply, we can simply divide <code class="literal">self</code> by the <code class="literal">base</code>, try to get the power of the new divided value relative to the same <code class="literal">base</code>, and remember to add one to our new result if it turns out to be an Integer.</p><p>That’s exactly what we do at ❼ and ❽. We define a new variable called <code class="literal">exponent</code>, which is the result of calling the <code class="literal">power_of</code> method on <code class="literal">self</code> divided by <code class="literal">base</code>. The <code class="literal">exponent</code> variable will either be <code class="literal">nil, false</code>, or an Integer. How do we know this? Because we return either <code class="literal">nil</code> up to ❷, <code class="literal">false</code> at ❺ or ❻, or an Integer.</p><p>All Integers have true Boolean values, so we can test with our standard ternary operator, as we do at ❽. If <code class="literal">exponent</code> evaluates to <code class="literal">true</code>, it’s an Integer (because both <code class="literal">nil</code> and <code class="literal">false</code> would evaluate to <code class="literal">false</code> in the Boolean ternary operation). We therefore <code class="literal">return</code> it, remembering to add one, because we’ve already divided by the <code class="literal">base</code> once. If <code class="literal">exponent</code> evaluates to <code class="literal">false</code>, we want to simply <code class="literal">return</code> that value: either <code class="literal">false</code> or <code class="literal">nil</code>.</p><p>What happens in our new call to <code class="literal">power_of</code> on <code class="literal">self</code> divided by the <code class="literal">base</code> at ❼? It goes through all the same tests from ❶ to ❻, and if none of those apply, it divides the new value of <code class="literal">self</code> by the <code class="literal">base</code> again, remembering to add yet another one to the eventual result. All of this happens inside each iteration of the <code class="literal">power_of</code> method—the first version of it up at the top level doesn’t need to know or care about how many other iterations of <code class="literal">power_of</code> end up being called. This is what <a class="indexterm" id="idx-CHP-5-0449"/>recursion is all about.</p></div><div class="sect2" title="Running the Script"><div class="titlepage"><div><div><h2 class="title"><a id="running_the_script-id013"/>Running the Script</h2></div></div></div><p>You can try out this script in irb by requiring it at the command line with <code class="literal">irb -r power_of.rb</code> or by entering <code class="literal">require ‘power_of.rb’</code> once you’re in irb. Remember that this script can only handle Integers, so <code class="literal">2.power_of(4)</code> will return <code class="literal">false</code>, rather than <code class="literal">0.5</code>.<a class="indexterm" id="idx-CHP-5-0450"/><a class="indexterm" id="idx-CHP-5-0451"/></p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id012"/>The Results</h2></div></div></div><p>Here is a sample irb session with some output.</p><a id="I_programlisting5_d1e7182"/><pre class="programlisting">$ irb -r <a class="indexterm" id="idx-CHP-5-0452"/>power_of.rb
irb(main):001:0&gt; 1.power_of(1)
=&gt; 1
irb(main):002:0&gt; 1.power_of(2)
=&gt; 0
irb(main):003:0&gt; 4.power_of(2)
=&gt; 2
irb(main):004:0&gt; 2.power_of(4)
=&gt; false</pre></div></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-5-FNOTE-1" id="ftn.CHP-5-FNOTE-1">12</a>] </sup>We’ll make a temperature converter in <a class="xref" href="ch07.html" title="Chapter 7. Using, Optimizing, and Testing Functional Techniques">Chapter 7</a>, since it depends on concepts we haven’t covered yet.</p></div></div></div>
<div class="sect1" title="#16 Adding Commas to Numbers (commify.rb)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp16_adding_commas_to_numbers_commify"/>#16 Adding Commas to Numbers (commify.rb)</h1></div></div></div><p>A standard way of formatting numbers is to present them with commas (or some other delimiter) separating each group of thousands. Our next script does that by adding a method called <code class="literal">commify</code> to all numbers. You might think that we could do this by opening the Integer <a class="indexterm" id="idx-CHP-5-0453"/>class and adding a new method to it, as we did in <code class="literal">power_of.rb</code>. This is certainly a reasonable approach, except that we may want to use <code class="literal">commify</code> on floating-point numbers as well. What’s the solution?<a class="indexterm" id="idx-CHP-5-0454"/><a class="indexterm" id="idx-CHP-5-0455"/><a class="indexterm" id="idx-CHP-5-0456"/></p><div class="sect2" title="Inheritance"><div class="titlepage"><div><div><h2 class="title"><a id="inheritance"/>Inheritance</h2></div></div></div><p>The answer deals with an object-oriented concept called <span class="emphasis"><em>inheritance</em></span>. We discussed this earlier in <a class="xref" href="ch03.html" title="Chapter 3. Programmer Utilities">Chapter 3</a> when we added methods to the Object class. Inheritance is what allows all other classes to use methods of the Object class, because these other classes <span class="emphasis"><em>inherit</em></span> from Object. Inheritance is a factor in our <code class="literal">commify</code> script as well. Let’s examine the inheritance hierarchy of some number classes in irb.<a class="indexterm" id="idx-CHP-5-0457"/></p><a id="I_programlisting5_d1e7237"/><pre class="programlisting">irb(main):001:0&gt; Integer.<a class="indexterm" id="idx-CHP-5-0458"/>ancestors    <em class="lineannotation"><span class="lineannotation">The<strong class="userinput"><code> ancestors</code></strong> Method</span></em>
=&gt; [Integer, <a class="indexterm" id="idx-CHP-5-0459"/>Precision, Numeric, Comparable, Object, Kernel]
irb(main):002:0&gt; Float.ancestors
=&gt; [Float, Precision, Numeric, Comparable, Object, Kernel]
irb(main):003:0&gt;</pre><p>We’ve used a method called <code class="literal">ancestors</code> that can be called not on an instance of a class, but on the class itself. It returns an Array of all of the ancestors of the class on which it is called (by <span class="emphasis"><em>ancestors</em></span> I simply mean the classes from which it inherits). You may find it useful to consider inheritance through a biological metaphor, in which each class is a species and the ancestor classes are that species’ ancestor species. We can see that both the Integer class and the Float class inherit directly from something called <span class="emphasis"><em>Precision</em></span>.<a class="indexterm" id="I_indexterm5_d1e7264"/><a class="indexterm" id="I_indexterm5_d1e7267"/></p><p>Precision must be a class—some kind of number, right? Not exactly. Let’s continue in irb.</p><a id="I_programlisting5_d1e7274"/><pre class="programlisting">irb(main):003:0&gt; Integer.class
=&gt; Class
irb(main):004:0&gt; Float.class
=&gt; Class
irb(main):005:0&gt; Precision.class
=&gt; Module</pre><p>We see that Integer is a <span class="emphasis"><em>class</em></span>, something that can be instantiated. So is Float. That’s no surprise. 5 is an Integer, and 3.14 is a Float. But Precision is something called a Module, not a Class at all. What are <a class="indexterm" id="idx-CHP-5-0460"/>Modules for?</p></div><div class="sect2" title="Modules"><div class="titlepage"><div><div><h2 class="title"><a id="modules"/>Modules</h2></div></div></div><p>Let’s continue with our biological metaphor. Both humans and bats are mammals, so if we called <code class="literal">Human.ancestors</code> and <code class="literal">Bat.ancestors</code>, we would have significant overlap—humans and bats have shared ancestors, specifically earlier mammals. If we called <code class="literal">Bird.ancestors</code>, there would be less overlap with either of the others, because birds are not mammals. However, bats and most birds can fly, which you could think of as a method, in object-oriented terms. We could define <code class="literal">Bat.fly</code> and <code class="literal">Bird.fly</code> separately, but there is another option available to us.</p><p>We can thus define the ability to fly (along with related characteristics and behaviors) and add that ability to existing classes. That process is called <span class="emphasis"><em>mixing in</em></span>, and it’s how Ruby deals with the problem of assigning the same methods to different classes with distinct ancestor classes, like our Bat and Bird example.</p><p>We do this by defining the ability to fly as a module, perhaps called Flyable. Modules are similar to classes, except that they don’t get instantiated. We’ll write our own modules later in <a class="xref" href="ch10.html" title="Chapter 10. More Complex Utilities and Tricks, Part II">Chapter 10</a>. For now, keep in mind that the <a class="indexterm" id="idx-CHP-5-0461"/>Precision module adds behavior to both Integer and Float, just like our hypothetical Flyable. Flyable grants the ability to fly to those organisms it’s mixed into, and Precision grants the ability to do precise calculations to those numbers it’s mixed into.</p><p>Modules are open, just like classes, so we can add new behavior to the Precision module, just as we did earlier to the Object class. Let’s take a look at the <code class="literal">commify.rb</code> script.<a class="indexterm" id="idx-CHP-5-0462"/><a class="indexterm" id="I_indexterm5_d1e7326"/></p></div><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id015"/>The Code</h2></div></div></div><a id="I_programlisting5_d1e7332"/><pre class="programlisting">  module Precision    <em class="lineannotation"><span class="lineannotation">Modules</span></em>

❶   # What character should be displayed at each breakpoint?
    COMMIFY_DELIMITER = ','

    # What should the decimal point character be?
    COMMIFY_DECIMAL = '.'

    # What power of 10 defines each breakpoint?
    COMMIFY_BREAKPOINT = 3

    # Should an explicit '0' be shown in the 100ths place,
    # such as for currency?
    COMMIFY_PAD_100THS = true

  =begin rdoc
  This method returns a &lt;b&gt;String&lt;/b&gt; representing the numeric value of
  self, with delimiters at every digit breakpoint. 4 Optional arguments:

  1. delimiter (&lt;b&gt;String&lt;/b&gt;): defaults to a <a class="indexterm" id="idx-CHP-5-0463"/>comma
  2. breakpoint (&lt;b&gt;Integer&lt;/b&gt;): defaults to 3, showing every multiple of 1000
  3. decimal_pt (&lt;b&gt;String&lt;/b&gt;): defaults to '.'
  4. show_hundredths (&lt;b&gt;Boolean&lt;/b&gt;): whether an explicit '0' should be shown
  in the hundredths place, defaulting to &lt;b&gt;true&lt;/b&gt;.
  =end
❷   def commify(args = {})    <em class="lineannotation"><span class="lineannotation">Optional Arguments</span></em>

❸     args[:delimiter]       <a class="indexterm" id="idx-CHP-5-0464"/>||= COMMIFY_DELIMITER
      args[:breakpoint]      ||= COMMIFY_BREAKPOINT
      args[:decimal_pt]      ||= COMMIFY_DECIMAL
      args[:show_hundredths] ||= COMMIFY_PAD_100THS

❹     int_as_string, float_as_string = to_s.split('.')

      int_out = format_int(
        int_as_string,
        args[:breakpoint],
        args[:delimiter]
      )

      float_out = format_float(
        float_as_string,
        args[:decimal_pt],
        args[:show_hundredths]
      )

❺     return int_out + float_out
    end

    private

  =begin rdoc
  Return a &lt;b&gt;String&lt;/b&gt; representing the properly-formatted
  &lt;b&gt;Integer&lt;/b&gt; portion of self.
  =end
❻   def format_int(int_as_string, breakpoint, delimiter)
      reversed_groups = int_as_string.reverse.split(/(\d{#{breakpoint}})/)
      reversed_digits = reversed_groups.grep(/\d+/)
      digit_groups = reversed_digits.reverse.map { |unit| unit.reverse }
      return digit_groups.join(delimiter)
    end
  =begin rdoc
  Return a &lt;b&gt;String&lt;/b&gt; representing the properly-formatted
  floating-point portion of self.
  =end
❼   def format_float(float_as_string, decimal_pt, show_hundredths)
      return ''unless float_as_string
      output = decimal_pt + float_as_string
❽     return output unless show_hundredths
❾     output += '0' if (float_as_string.size == 1)
      return output
    end

  end</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id014"/>How It Works</h2></div></div></div><p>Starting at ❶, we define some useful constants, just like we do for a class. Each definition is preceded by some comments explaining what the constant is for. I mentioned that the <code class="literal">commify</code> method will insert <a class="indexterm" id="idx-CHP-5-0465"/>commas at every grouping of a thousand. This is customary in the <a class="indexterm" id="idx-CHP-5-0466"/>United States, but many other countries use a period in place of a <a class="indexterm" id="idx-CHP-5-0467"/>comma and use a comma to separate units from floating-point portions (for which the United States uses a period). These constants are preset for the US notation that is useful for me, since I live here, but you can easily customize them to match what’s appropriate for your home country.</p><p>After some RDoc that explains the input parameters in the form of a single Hash, at ❷ we get to the definition of the <code class="literal">commify</code> method, our only public method. It accepts a Hash argument called <code class="literal">args</code> to override the default configuration constants, as shown at ❸. Note that the <code class="literal">||=</code> operation means that if <code class="literal">args</code> asks for an override (meaning it has a value in itself for the appropriate Symbol, such as <code class="literal">:delimiter</code> for the delimiter), we use what’s in <code class="literal">args</code>. Otherwise, we fall back to the Module’s appropriate constant. At ❹, we split the Integer and Float portions of <code class="literal">self</code>, although keep in mind that they are both instances of the String class, despite the fact that they represent numbers. Ruby allows us to assign into two different variable names at a time, as we do here.<a class="indexterm" id="idx-CHP-5-0468"/></p><div class="note" title="Note"><h3 class="title"><a id="note-36"/>Note</h3><p><span class="emphasis"><em>Symbols make great Hash keys, and that’s a convention you’ll see a great deal in both my scripts and in the whole Ruby community. You’d have a terrible time trying to do anything in Rails without respecting this convention. Symbols work particularly well for this job because they can be used as names or labels for things, and they take up an extremely small amount of memory</em></span>.<sup>[<a class="footnote" href="#ftn.CHP-5-FNOTE-2" id="CHP-5-FNOTE-2">13</a>]</sup></p></div><p>We then define a variable called <code class="literal">int_out</code> and give it the value of a method called <code class="literal">format_int</code>. We do the same for <code class="literal">float_out</code>, and finally <code class="literal">return</code> the concatenation of those two Strings at ❺. You can see that the real work occurs within the formatting methods (<code class="literal">format_int</code> and <code class="literal">format_float</code>), both of which are <code class="literal">private</code>.</p><div class="sect3" title="The format_int Method"><div class="titlepage"><div><div><h3 class="title"><a id="the_format_int_method"/>The format_int Method</h3></div></div></div><p>The <code class="literal">format_int</code> method at ❻ is the more conceptually complicated of the two methods. Let’s open irb again and step through this method’s operations. First, let’s define some variables representing the inputs to the method.<a class="indexterm" id="idx-CHP-5-0471"/></p><a id="I_programlisting5_d1e7447"/><pre class="programlisting">irb(main):001:0&gt; int_as_string = '186282'
=&gt; "186282"
irb(main):002:0&gt; breakpoint = 3
=&gt; 3
irb(main):003:0&gt; delimiter = ','
=&gt; ","</pre><p>Next, let’s split our String at the appropriate breakpoints, using a regular expression representing any group of digits that is the appropriate length. The notation <code class="literal">{x}</code> within a regular expression means <span class="emphasis"><em>X instances of whatever is to the left</em></span>, so <code class="literal">a{3}</code> means <span class="emphasis"><em>Three instances of the letter</em></span> a. We also use string interpolation so that we can use our <code class="literal">breakpoint</code> argument for the number of digits to break on. We want to go from right to left, so we’ll use the <code class="literal">reverse</code> method prior to breaking up the String into an Array.<a class="indexterm" id="idx-CHP-5-0472"/></p><a id="I_programlisting5_d1e7473"/><pre class="programlisting">irb(main):004:0&gt; reversed_groups = int_as_string.reverse.split(/<a class="indexterm" id="idx-CHP-5-0473"/>(\d{#{breakpoint}})/)
=&gt; ["", "282", "", "681"]</pre><p>Then we want to extract only those Array members that are genuine number groups, which we can do easily enough with another regular expression <code class="literal">/\d+/</code> (meaning <span class="emphasis"><em>Consisting of one or more digits and nothing else</em></span>) and the <code class="literal">grep</code> method, which finds all members of an Array that match the regex argument that <code class="literal">grep</code> takes.<a class="indexterm" id="idx-CHP-5-0474"/><a class="indexterm" id="idx-CHP-5-0475"/></p><a id="I_programlisting5_d1e7499"/><pre class="programlisting">irb(main):005:0&gt; reversed_digits = reversed_groups.grep(<a class="indexterm" id="idx-CHP-5-0476"/>/\d+/)
=&gt; ["282", "681"]</pre><p>What else is wrong with our content at this point? Not only are the number groups in the wrong order, but the numbers within each group are also reversed. This is because we reversed the entire String before doing our <code class="literal">split</code>. Now we want to get everything in the right order. We can just <code class="literal">reverse</code> our Array, right?</p><a id="I_programlisting5_d1e7515"/><pre class="programlisting">irb(main):006:0&gt; reversed_digits.reverse
=&gt; ["681", "282"]</pre><p>This won’t work. It puts the groups in the right order, but the digits within each group are still reversed. We can use the <code class="literal">map</code> method to reverse each member of the Array instead.</p><a id="I_programlisting5_d1e7522"/><pre class="programlisting">irb(main):007:0&gt; reversed_digits.map { |unit| unit.reverse }
=&gt; ["282", "186"]</pre><p>Oops. Now the digits within each set of three numbers are in the right order, but the groups are in the wrong order. We could define yet another variable like <code class="literal">reversed_digits</code> in a two-step operation, but why not take advantage of Ruby’s ability to chain <a class="indexterm" id="idx-CHP-5-0477"/>methods?</p><a id="I_programlisting5_d1e7534"/><pre class="programlisting">irb(main):008:0&gt; digit_groups = reversed_digits.reverse.map { |unit| unit.reverse }
=&gt; ["186", "282"]</pre><p>Now our digits groups are in the right order and have the correct internal ordering, as well.</p><p>Note that the two different calls to the <code class="literal">reverse</code> method in the irb example are completely different. One is a call to the Array method <code class="literal">reverse</code> on <code class="literal">reversed_digits</code> and the other is a call to the String method <code class="literal">reverse</code> on each digit group that we call <code class="literal">unit</code> within the <code class="literal">map</code> operation.</p><p>We still have an Array, and we want a String. This calls for a <code class="literal">join</code>, using the delimiter.</p><a id="I_programlisting5_d1e7564"/><pre class="programlisting">irb(main):009:0&gt; digit_groups.join(delimiter)
=&gt; "186,282"</pre><p>Our <code class="literal">format_int</code> method now returns a String that is an altered version of our <code class="literal">int_as_string</code> argument. We break up <code class="literal">int_as_string</code> at the right point <a class="indexterm" id="idx-CHP-5-0478"/>(<code class="literal">breakpoint</code>), insert the <code class="literal">delimiter</code> between our groups of digits, and make sure that everything stays in the right order. That’s it for the integer component.<a class="indexterm" id="idx-CHP-5-0479"/></p></div><div class="sect3" title="The format_float Method"><div class="titlepage"><div><div><h3 class="title"><a id="the_format_float_method"/>The format_float Method</h3></div></div></div><p>We also want to be able to format floating-point portions of numbers, which we do with the <code class="literal">format_float</code> method at ❼. If there is no floating-point portion, it returns an empty String right away. Otherwise, it creates a new variable called <code class="literal">output</code> consisting of the <code class="literal">decimal_pt</code> argument concatenated with the <code class="literal">float_as_string</code> argument—remember that they’re both Strings, so the plus sign means <a class="indexterm" id="idx-CHP-5-0480"/>concatenation. If the configuration options are such that the hundredths place is not mandatory (you can tell from the <code class="literal">show_hundredths</code> argument), we can simply <code class="literal">return</code> the <code class="literal">output</code> variable at ❽. If we need to show the hundredths place and the floating-point portion is only a single character wide, we need to concatenate the String <code class="literal">‘0’</code> onto the end of the output at ❾. Otherwise, we can simply <code class="literal">return</code> the <code class="literal">output</code> variable.<a class="indexterm" id="idx-CHP-5-0481"/><a class="indexterm" id="I_indexterm5_d1e7635"/></p></div><div class="sect3" title="Type Testing"><div class="titlepage"><div><div><h3 class="title"><a id="type_testing"/>Type Testing</h3></div></div></div><p>You’ll remember that in <code class="literal">power.rb</code>, we had an early exit condition based on whether or not the <code class="literal">base</code> argument was an Integer at all. You’ll also notice that in this <a class="indexterm" id="idx-CHP-5-0482"/>script we don’t test any of the numbers to find out whether or not they’re real numbers. Why is that? The reason is that our new methods will be included in the Precision module, which is only mixed in to classes that represent some sort of number, like Integer and Float. Therefore, checks for numeric type are not necessary.</p></div></div><div class="sect2" title="Running the Script"><div class="titlepage"><div><div><h2 class="title"><a id="running_the_script-id014"/>Running the Script</h2></div></div></div><p>Let’s try this out with a test script. Here are the contents of <code class="literal">tests/test_commify.rb</code>, which we’ll run in the same directory as <code class="literal">commify.rb</code> with the command <code class="literal">ruby -w tests/test_commify.rb 186282.437</code> at the shell.<a class="indexterm" id="idx-CHP-5-0483"/><a class="indexterm" id="idx-CHP-5-0484"/></p><a id="I_programlisting5_d1e7675"/><pre class="programlisting">#!/usr/bin/env ruby
# test_commify.rb

require 'commify'

puts ARGV[0].to_f.commify()
alt_args = {
    :breakpoint =&gt; 2,
    :decimal_pt =&gt; 'dp',
    :show_hundredths =&gt; false
}
puts ARGV[0].to_f.commify(alt_args)</pre><p>We call the <code class="literal">commify</code> method on the first argument after the script name, which in our case is the floating-point number <code class="literal">186282.437</code>. First, we call it with the default parameters with regard to the delimeter character, breakpoint size, and so on. Then we call it with some modified configuration parameters, just to see how they work.</p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id013"/>The Results</h2></div></div></div><p>Here’s the output I got:</p><a id="I_programlisting5_d1e7690"/><pre class="programlisting">186,282.437
18,62,82dp437</pre><p>Yours should look the same. That’s it for this script.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-5-FNOTE-2" id="ftn.CHP-5-FNOTE-2">13</a>] </sup>My technical reviewer, Pat Eyler, wisely asked me to stress that the <span class="emphasis"><em>reason</em></span> Symbols take up so little space is because each Symbol only takes up space once, and all subsequent instances merely refer to that same memory space again, instead of duplicating it, as would happen with a String or other type of object.<a class="indexterm" id="idx-CHP-5-0469"/><a class="indexterm" id="idx-CHP-5-0470"/></p></div></div></div>
<div class="sect1" title="#17 Roman Numerals (roman_numeral.rb)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp17_roman_numerals_roman_numeralrb"/>#17 Roman Numerals (roman_numeral.rb)</h1></div></div></div><p>In the previous script, you learned how to change the representation of a number as a String so that it had <a class="indexterm" id="idx-CHP-5-0485"/>commas (or some other desired delimiting character) in appropriate places for easier readability. One of the most traditional ways to represent a number as a String is as a Roman numeral. This script adds a new method to all Integers called <code class="literal">to_roman</code>. Let’s see it in action in irb.<a class="indexterm" id="idx-CHP-5-0486"/><a class="indexterm" id="idx-CHP-5-0487"/><a class="indexterm" id="idx-CHP-5-0488"/><a class="indexterm" id="I_indexterm5_d1e7715"/><a class="indexterm" id="I_indexterm5_d1e7718"/></p><a id="I_programlisting5_d1e7721"/><pre class="programlisting">$ irb -r <a class="indexterm" id="idx-CHP-5-0489"/>roman_numeral.rb
irb(main):001:0&gt; 42.to_roman
=&gt; "XLII"
irb(main):002:0&gt; 1.to_roman
=&gt; "I"
irb(main):003:0&gt; 5.<a class="indexterm" id="idx-CHP-5-0490"/>to_roman
=&gt; "V"
irb(main):004:0&gt; digits = (0..9).to_a
=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
irb(main):005:0&gt; digits.map { |d| d.to_roman }
=&gt; ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX"]</pre><p>If you remember your <a class="indexterm" id="idx-CHP-5-0491"/>Roman numerals, you will see that <code class="literal">to_roman</code> follows your expectations. It returns the empty string for zero and uses the <span class="emphasis"><em>subtractive</em></span> approach of reporting four as <span class="emphasis"><em>IV</em></span>, using a lower-value letter to the left of a higher-value letter to indicate subtraction. Let’s look at the source code to see how it works.<a class="indexterm" id="idx-CHP-5-0492"/></p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id016"/>The Code</h2></div></div></div><a id="I_programlisting5_d1e7754"/><pre class="programlisting">  class Integer

    # Base conversion Hash
❶   ARABIC_TO_ROMAN = {
      1000 =&gt; 'M',
       500 =&gt; 'D',
       100 =&gt; 'C',
        50 =&gt; 'L',
        10 =&gt; 'X',
         5 =&gt; 'V',
         1 =&gt; 'I',
         0 =&gt; '',
    }

    # Represent 4 as 'IV', rather than 'IIII'?
    SUBTRACTIVE_TO_ROMAN = {
       900 =&gt; 'CM',
       400 =&gt; 'CD',
        90 =&gt; 'XC',
        40 =&gt; 'XL',
         9 =&gt; 'IX',
         4 =&gt; 'IV',
    }

    # Use SUBTRACTIVE_TO_ROMAN Hash?
    SUBTRACTIVE = true

❷   def to_roman()
      @@roman_of ||= create_roman_of()    <em class="lineannotation"><span class="lineannotation">Class Variables</span></em>
❸     return ''unless (self &gt; 0)
❹     return to_s if self &gt; maximum_representable()
❺     base = @@roman_of.keys.sort.reverse.detect { |k| k &lt;= self }    <em class="lineannotation"><span class="lineannotation">The<strong class="userinput"><code> detect</code></strong> Method</span></em>
❻     return '' unless (base and base &gt; 0)
❼     return (@@roman_of[base] * round_to_base(base)) + (self % base).to_roman()
    end

    private
  =begin rdoc
  Use constants to create a &lt;b&gt;Hash&lt;/b&gt; of appropriate <a class="indexterm" id="idx-CHP-5-0493"/>roman numeral values.
  =end
❽   def create_roman_of()
      return ARABIC_<a class="indexterm" id="idx-CHP-5-0494"/>TO_ROMAN unless SUBTRACTIVE
      ARABIC_TO_ROMAN.merge(SUBTRACTIVE_TO_ROMAN)    <em class="lineannotation"><span class="lineannotation">The<strong class="userinput"><code> merge</code></strong> Method</span></em>
    end

  =begin rdoc
  What is the largest number that this method can reasonably represent?
  =end
   def maximum_representable()
❾    (@@roman_of.keys.max * 5) - 1
   end

❿  def round_to_base(base)
     (self - (self % base)) / base
   end

 end</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id015"/>How It Works</h2></div></div></div><p>Since we only need to give Integers the ability to report their Roman numeral representation, we’ll open up the Integer class and give it this new method. After defining some constants at ❶, let’s skip down to ❷, where we define the public method <code class="literal">to_roman</code> that we’ve seen used in irb. In it, we define something called <code class="literal">@@roman_of</code>, and use the <code class="literal">||=</code> operator to set its value to that of the output of a method called <code class="literal">create_roman_of</code>, unless <code class="literal">@@roman_of</code> already evaluates to <code class="literal">true</code>. Why does it have two <code class="literal">@</code> signs at the front? We’ve already seen instance variables with a single <code class="literal">@</code> sign and constants that must begin with an uppercase letter (and traditionally are entirely uppercase), but this is something new called a <span class="emphasis"><em>class variable</em></span>.</p><div class="sect3" title="Class Variables"><div class="titlepage"><div><div><h3 class="title"><a id="class_variables"/>Class Variables</h3></div></div></div><p>Class variables are shared among every instance of a class but are able to change value. Let’s verify in irb that several different instances of any given class variable have the same value.<a class="indexterm" id="idx-CHP-5-0495"/></p><a id="I_programlisting5_d1e7820"/><pre class="programlisting">irb(main):001:0&gt; class String
irb(main):002:1&gt; @@class_var = "I'm a Class Variable."
irb(main):003:1&gt; def cv
irb(main):004:2&gt; @@class_var
irb(main):005:2&gt; end
irb(main):006:1&gt; end
=&gt; nil
irb(main):007:0&gt; ''.cv
=&gt; "I'm a Class Variable."
irb(main):008:0&gt; 'Some other String'.cv
=&gt; "I'm a Class Variable."
irb(main):009:0&gt; 'Yet another String.'.cv
=&gt; "I'm a Class Variable."</pre><p>We define a new <a class="indexterm" id="idx-CHP-5-0496"/>class variable called <code class="literal">@@class_var</code> for all Strings and also give all strings a new method called <code class="literal">cv</code> that returns <code class="literal">@@class_var</code>. We find that it has the same value for all Strings, including Strings that did not yet exist when we defined <code class="literal">@@class_var</code>.<a class="indexterm" id="idx-CHP-5-0497"/></p><p>We have a class variable called <code class="literal">@@roman_of</code>. What is it? To answer that, we need to look inside the private method <code class="literal">create_roman_of</code> at ❽. It returns a constant called <code class="literal">ARABIC_TO_ROMAN</code>, unless some other constant called <code class="literal">SUBTRACTIVE</code> is true. We can see from our constant definition section (❶) that we have set <code class="literal">SUBTRACTIVE</code> to true, so <code class="literal">create_roman_of</code> will not return <code class="literal">ARABIC_TO_ROMAN</code> with our current configuration settings. Instead, it will return the result of calling the method <code class="literal">merge</code> on <code class="literal">ARABIC_TO_ROMAN</code>, with <code class="literal">SUBTRACTIVE_TO_ROMAN</code> as its single argument.<a class="indexterm" id="idx-CHP-5-0498"/><a class="indexterm" id="idx-CHP-5-0499"/><a class="indexterm" id="idx-CHP-5-0500"/><a class="indexterm" id="idx-CHP-5-0501"/></p></div><div class="sect3" title="Hash.merge"><div class="titlepage"><div><div><h3 class="title"><a id="hashmerge"/>Hash.merge</h3></div></div></div><p>At this point we need to learn what <code class="literal">ARABIC_TO_ROMAN</code> is so we know what happens when <code class="literal">merge</code> is called on it. We can see from ❶ that both <code class="literal">ARABIC_TO_ROMAN</code> and <code class="literal">SUBTRACTIVE_TO_ROMAN</code> are Hashes. Their keys are Arabic numerals, and each key’s value is the representation of the key as a Roman numeral. This <a class="indexterm" id="idx-CHP-5-0502"/>script can only represent <a class="indexterm" id="idx-CHP-5-0503"/>Roman numerals up to 4,999, so we could simply define a single Hash of <code class="literal">ALL_ARABICS_TO_ROMAN</code> with a key for every value from one to 4,999 and be done with it.<a class="indexterm" id="idx-CHP-5-0504"/></p><p>That would work, but it would be terribly inelegant. What we’ve done instead is define base cases from which we will extrapolate all cases between zero and 4,999. We also separate out cases of subtractive representation (such as IV for four) into a separate Hash, allowing us to easily turn that feature on or off, as we do with the <code class="literal">SUBTRACTIVE</code> constant and the <code class="literal">create_roman_of</code> method, which uses the <code class="literal">merge</code> method of Hashes. This <code class="literal">merge</code> method allows a Hash to incorporate the information from a second Hash into itself. Let’s explore that in irb.<a class="indexterm" id="I_indexterm5_d1e7940"/></p><a id="I_programlisting5_d1e7943"/><pre class="programlisting">irb(main):001:0&gt; hash1 = { 'key1' =&gt; 'value1', 'key2' =&gt; 'value2' }
=&gt; {"key1"=&gt;"value1", "key2"=&gt;"value2"}
irb(main):002:0&gt; hash2 = { 'key3' =&gt; 'value3', 'key4' =&gt; 'value4' }
=&gt; {"key3"=&gt;"value3", "key4"=&gt;"value4"}
irb(main):003:0&gt; hash1
=&gt; {"key1"=&gt;"value1", "key2"=&gt;"value2"}
irb(main):004:0&gt; hash2
=&gt; {"key3"=&gt;"value3", "key4"=&gt;"value4"}
irb(main):005:0&gt; hash1.merge(hash2)
=&gt; {"key1"=&gt;"value1", "key2"=&gt;"value2", "key3"=&gt;"value3", "key4"=&gt;"value4"}
irb(main):006:0&gt; hash3 = { 'key1' =&gt; nil }
=&gt; {"key1"=&gt;nil}
irb(main):007:0&gt; hash1.merge(hash2).merge(hash3)
=&gt; {"key1"=&gt;nil, "key2"=&gt;"value2", "key3"=&gt;"value3", "key4"=&gt;"value4"}</pre><p>You can see not only that <code class="literal">merge</code> combines key/value pairs, but also that the incoming information (meaning the Hash argument to the <code class="literal">merge</code> method) overrides pre-existing pairs in the calling Hash. That’s why the <code class="literal">“key1”=&gt;nil</code> pair from <code class="literal">hash3</code> overrides the <code class="literal">”key1“=&gt;“value1”</code> pair from <code class="literal">hash1</code>. You’ll also note that the returned value of the <code class="literal">merge</code> method is itself just another Hash, so we can call any Hash method on it, including <code class="literal">merge</code> again.</p><p>So the first time we call the <code class="literal">to_roman</code> method (❷), we create a class variable called <code class="literal">@@roman_of</code> that contains base cases for transliteration into <a class="indexterm" id="idx-CHP-5-0505"/>Roman numerals. It either uses the subtractive approach or it doesn’t, depending on our configuration options. It includes subtractive representation by default. After all that, we <code class="literal">return</code> an empty String at ❸ unless the Integer (<code class="literal">self</code>) is greater than zero.</p><p>You may remember that I said this <a class="indexterm" id="idx-CHP-5-0506"/>script can handle <a class="indexterm" id="idx-CHP-5-0507"/>Roman numerals for Integers up to 4,999. That’s where line ❹ and the <code class="literal">maximum_representable</code> method (defined at ❾) come in. The largest value that Roman numerals can represent (without introducing vertical bars above letters that are not strictly part of the standard Roman alphabet) is 4,999, so I decided to stop there. If the Integer in question (<code class="literal">self</code>) is greater than the maximum value that can be shown, we simply return the result of the <code class="literal">to_s</code> method (❹). Let’s see this in action in irb.</p><a id="I_programlisting5_d1e8011"/><pre class="programlisting">irb(main):001:0&gt; digits = (0..9).to_a
=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
irb(main):002:0&gt; digits.map { |d| (4995+d).to_roman }
=&gt; ["MMMMCMXCV", "MMMMCMXCVI", "MMMMCMXCVII", "MMMMCMXCVIII", "MMMMCMXCIX",
"5000", "5001", "5002", "5003", "5004"]</pre><p>Once we hit the upper limit, we still return a String representing a numeric value (which is all a <a class="indexterm" id="idx-CHP-5-0508"/>Roman numeral is), we just use the familiar Arabic numeral symbols within our String.</p></div><div class="sect3" title="More Recursion"><div class="titlepage"><div><div><h3 class="title"><a id="more_recursion"/>More Recursion</h3></div></div></div><p>If the lines from ❷ through ❹ remind you of the exit conditions in <code class="literal">power_of.rb</code> that prepared for a recursive call to the same method, you’ve been paying attention. That’s exactly what we’re about to do here. At ❺ we create a variable called <code class="literal">base</code> that is the value of a long chain of method calls starting on the <code class="literal">@@roman_of</code> class variable. The purpose of these method calls is to find the largest key of the <code class="literal">@@roman_of</code> Hash that is less than or equal to the <code class="literal">self</code> Integer.</p><p>We get the keys out with the <code class="literal">keys</code> method, which returns an Array of the Hash’s keys. We then <code class="literal">sort</code> that Array in <code class="literal">reverse</code> order, meaning that we start from highest to lowest. We then call a new Array method called <code class="literal">detect</code> with the conditions of being less than or equal to <code class="literal">self</code>. I think a great alias for detect would be <span class="emphasis"><em>find first</em></span>. Let’s see it in irb.<a class="indexterm" id="idx-CHP-5-0509"/><a class="indexterm" id="idx-CHP-5-0510"/></p><a id="I_programlisting5_d1e8068"/><pre class="programlisting">irb(main):001:0&gt; digits = (0..9).to_a
=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
irb(main):002:0&gt; digits.detect { |d| d % 3 }
=&gt; 0
irb(main):003:0&gt; digits.reverse.detect { |d| d % 3 }
=&gt; 9
irb(main):004:0&gt; digits.detect { |d| d &gt; 4 }
=&gt; 5
irb(main):005:0&gt; digits.reverse.detect { |d| d % 2 == 1 }
=&gt; 9</pre><p>The <code class="literal">detect</code> method cycles through each member of the Array and returns the first Array element that matches the conditions in the block. This is what allows us to find the highest value representable in terms of the <code class="literal">@@roman_of</code> Hash, which we put into the <code class="literal">base</code> variable at ❺. At ❻ we <code class="literal">return</code> the empty String, unless we both found a <code class="literal">base</code> and that <code class="literal">base</code> is greater than zero; without a <code class="literal">base</code> greater than zero, we can’t return anything useful.<a class="indexterm" id="idx-CHP-5-0511"/></p></div><div class="sect3" title="Multiples of Our Base"><div class="titlepage"><div><div><h3 class="title"><a id="multiples_of_our_base"/>Multiples of Our Base</h3></div></div></div><p>We now have a <code class="literal">base</code> that’s an Integer greater than zero. If we’re calling something like <code class="literal">1066.to_roman</code>, we have no problem, because our <code class="literal">base</code> value (1,000) is the entire thousands place portion of our Integer. But what if we want something like <code class="literal">2112.to_roman</code> instead? We need to be able to keep track of how many multiples of <code class="literal">base</code> can go into our Integer. That’s what we do at ❼.<a class="indexterm" id="idx-CHP-5-0512"/><a class="indexterm" id="idx-CHP-5-0513"/></p><p>We use the method <code class="literal">round_to_base</code> (defined at ❿) to determine the number of multiples of <code class="literal">base</code> we need to deal with. Our call to <code class="literal">round_to_base</code> tells us how many multiples of <code class="literal">base</code> we need to handle. Calling <code class="literal">@@roman_of[base]</code> also finds the single letter used to represent the base.<a class="indexterm" id="idx-CHP-5-0514"/></p></div><div class="sect3" title="Multiplying Strings by Integers"><div class="titlepage"><div><div><h3 class="title"><a id="multiplying_strings_by_integers"/>Multiplying Strings by Integers</h3></div></div></div><p>Multiplying a String by an Integer results in that String concatenated with itself as many times as the Integer. Let’s see that in irb:<a class="indexterm" id="idx-CHP-5-0515"/><a class="indexterm" id="idx-CHP-5-0516"/></p><a id="I_programlisting5_d1e8160"/><pre class="programlisting">irb(main):006:0&gt; 'M' * 2
=&gt; "MM"</pre><p>This is taken directly from our <code class="literal">2112.to_roman</code> example. The output of <code class="literal">“MM”</code> takes care of representing the 2,000 portion of 2,112, and at line ❼ we also make a recursive call to <code class="literal">to_roman</code>; this time, however, we call it on a smaller number, specifically 112. Because the number on which we call the <code class="literal">to_roman</code> method keeps getting smaller as we pull off multiples of <code class="literal">base</code>, we will eventually reach a point where we’ll exit with the empty String at ❸, marking the end of all of our recursive calls to <code class="literal">to_roman</code>. That’s when we get our final output.</p></div></div><div class="sect2" title="Running the Script"><div class="titlepage"><div><div><h2 class="title"><a id="running_the_script-id015"/>Running the Script</h2></div></div></div><p>This is easily demonstrated within irb.</p><a id="I_programlisting5_d1e8188"/><pre class="programlisting">$ irb -r <a class="indexterm" id="idx-CHP-5-0517"/>roman_numeral.rb
irb(main):001:0&gt; (0..9).to_a.map { |n| n.to_roman }</pre></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id014"/>The Results</h2></div></div></div><p>Here is the output:<a class="indexterm" id="I_indexterm5_d1e8199"/><a class="indexterm" id="I_indexterm5_d1e8202"/></p><a id="I_programlisting5_d1e8207"/><pre class="programlisting">=&gt; ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX"]</pre></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id009"/>Hacking the Script</h2></div></div></div><p>There are other options you could take with this script. Instead of making <code class="literal">SUBTRACTIVE</code> a class constant, we could have made the <code class="literal">to_roman</code> method take an argument. If you do that, you would need to keep track of two separate <code class="literal">[SOMETHING]_TO_ROMAN</code> Hashes, one using the subtractive display method, and one not using it. I decided to assume that the subtractive approach would be used because it does seem to be very common for <a class="indexterm" id="idx-CHP-5-0518"/>Roman numerals. However, I thought I would mention how you could customize this script to make it slightly more complicated—but also more flexible.<a class="indexterm" id="idx-CHP-5-0519"/></p><p>We’ll revisit the idea of representing Integers as different sorts of Strings later when we create the <code class="literal">to_lang</code> method. For now, let’s continue on to our first currency converter.</p></div></div>
<div class="sect1" title="#18 Currency Conversion, Basic (currency_converter1.rb)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp18_currency_conversion_basic_curren"/>#18 Currency Conversion, Basic (currency_converter1.rb)</h1></div></div></div><p>I mentioned earlier that the <code class="literal">commify</code> method needs to vary based on how each country treats the notation of numbers. The area where this issue comes up most often is with currency, of course. The actual conversion process consists of relatively straightforward math, but we’ll use this script as a vehicle to set the stage for two important concepts introduced in our next script—notably the representation of data with either <span class="emphasis"><em>XML</em></span> (<a class="indexterm" id="idx-CHP-5-0520"/>eXtensible Markup Language, <a class="ulink" href="http://www.w3c.org/xml">http://www.w3c.org/xml</a>) or <span class="emphasis"><em>YAML</em></span> (YAML Ain’t Markup Language, <a class="ulink" href="http://www.yaml.org">http://www.yaml.org</a>). We’ll explore both XML and YAML further in the next script, but for now, let’s try out our current script in irb with <code class="literal">irb -r currency_converter.rb</code>.<a class="indexterm" id="idx-CHP-5-0521"/><a class="indexterm" id="idx-CHP-5-0522"/><a class="indexterm" id="idx-CHP-5-0523"/><a class="indexterm" id="idx-CHP-5-0524"/><a class="indexterm" id="I_indexterm5_d1e8277"/><a class="indexterm" id="I_indexterm5_d1e8280"/><a class="indexterm" id="I_indexterm5_d1e8283"/><a class="indexterm" id="I_indexterm5_d1e8287"/></p><a id="I_programlisting5_d1e8292"/><pre class="programlisting">  irb(main):001:0&gt; cc = CurrencyConverter.new()
  =&gt; #&lt;CurrencyConverter:0xb7c979f4 @name_of={"USD"=&gt;"US Dollar"},
  @base_currency="USD"&gt;
❶ irb(main):002:0&gt; puts cc.output_rates(1)
  1 US Dollar (USD) =
          46.540136 Indian Rupees(INR)
          0.781738 Euros(EUR)
          10.890852 Mexican Pesos(MXN)
          7.977233 Chinese Yuans(CNY)
          1.127004 Canadian Dollars(CAD)
  =&gt; nil
❷ irb(main):003:0&gt; puts cc.output_rates(42)
  42 US Dollars (USD) =
          1954.685712 Indian Rupees(INR)
          32.832996 Euros(EUR)
          457.415784 Mexican Pesos(MXN)
          335.043786 Chinese Yuans(CNY)
          47.334168 Canadian Dollars(CAD)
  =&gt; nil</pre><p>We can see on our irb session’s first response that our <code class="literal">cc</code> instance seems to have some fondness for the US dollar—but if you’re in some other country, don’t worry, you’ll learn how to use different currencies in the improved version of the script. In ❶ you can see that our <code class="literal">cc</code> instance’s <code class="literal">output_rates</code> method takes an argument and seems to output the equivalent of that many US dollars in a few other currencies. You can see in ❷ that the values shift as expected with a different number of US dollars. Let’s see how this works by examining the source code.</p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id017"/>The Code</h2></div></div></div><a id="I_programlisting5_d1e8308"/><pre class="programlisting">  #!/usr/bin/env ruby
  # <a class="indexterm" id="idx-CHP-5-0525"/>currency_converter1.rb
  # Using fixed exchange rates

  class CurrencyConverter

❶   BASE_ABBR_AND_NAME = { 'USD' =&gt; 'US Dollar' }

    FULLNAME_OF = {
      'EUR' =&gt; 'Euro',
      'CAD' =&gt; 'Canadian Dollar',
      'CNY' =&gt; 'Chinese Yuan',
      'INR' =&gt; 'Indian Rupee',
      'MXN' =&gt; 'Mexican Peso',
    }

    EXCHANGE_RATES = {
      'EUR' =&gt; 0.781738,
      'INR' =&gt; 46.540136,
      'CNY' =&gt; 7.977233,
      'MXN' =&gt; 10.890852,
      'CAD' =&gt; 1.127004,
    }

❷   def initialize()    <em class="lineannotation"><span class="lineannotation">Initializing Class Variables</span></em>
      @base_currency = BASE_ABBR_AND_NAME.keys[0] 
      @name          = BASE_ABBR_AND_NAME[@base_currency]
    end

❸   def output_rates(mult=1)
      get_value(mult, get_rates) + "\n"
    end

    private

❹   def get_rates()
      return EXCHANGE_RATES
    end

❺   def get_value(mult, rates)
❻     return pluralize(mult, @name) +
      " (#{@base_currency}) = \n" +
❼     rates.keys.map do |abbr|
❽       "\t" +
        pluralize(mult * rates[abbr], FULLNAME_OF[abbr]) +
        "(#{abbr})"
❾     end.join("\n")
    end

  =begin rdoc
  This assumes that all plurals will be formed by adding an 's'.
  It could be made more flexible with a Hash of plural suffixes
  (which could be the empty string) or explicit plural forms that
  are simple replacements for the singular.

  For convenience, this outputs a string with the number of items,
  a space, and then the pluralized form of the currency unit.
  That suited the needs of this particular <a class="indexterm" id="idx-CHP-5-0526"/>script.
  =end
❿   def <a class="indexterm" id="idx-CHP-5-0527"/>pluralize(num, term)
      (num == 1) ? "#{num} #{term}" : "#{num} #{term}s"
    end

  end</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id016"/>How It Works</h2></div></div></div><p>At ❶, we define the “home” currency of the class, and immediately following, we define some handy codes for various other currencies via the <code class="literal">FULLNAME_OF</code> and <code class="literal">EXCHANGE_RATES</code> Hashes. The <code class="literal">EXCHANGE_RATES</code> Hash contains our preset exchange rate values. These were current at the time I created this object, but I’m sure they’ll be at least slightly different by the time you read this.</p><p>The <code class="literal">initialize</code> method at ❷ gives us some handy instance variables related to the home currency, and our only public method <code class="literal">output_rates</code> (❸) is simply a wrapper for the private <code class="literal">get_value</code> method (❺) with a newline.<sup>[<a class="footnote" href="#ftn.CHP-5-FNOTE-3" id="CHP-5-FNOTE-3">14</a>]</sup> The <code class="literal">get_value</code> method also uses another private method called <code class="literal">get_rates</code>, the definition of which (❹) should be fairly clear to you at this point.</p><p>The <code class="literal">get_value</code> method also uses another private method called <code class="literal">pluralize</code> (❿), which returns a String in which the term for the currency is plural when appropriate. I’ve implemented this very simply, because English only requires an s at the end of a term to pluralize it. With a few changes, this method could handle other languages or terms with more complex pluralization needs, most likely a Hash with currency terms as keys and plural endings as values. For now, we just need to add an <code class="literal">s</code> to the end of currency amounts greater than one.</p><p>The <code class="literal">get_value</code> method returns (❻) a pluralized form of the base currency with an equals sign, followed by information about each of the currencies the class knows about. Starting at ❼, it maps an operation onto each currency type (represented by the keys of the <code class="literal">rates</code> Hash). The mapped operation (❽) is the outputting of a tab character, followed by properly pluralized output for that currency based on its relative value, full name, and abbreviation. Each currency’s String output is then joined together with newline characters at ❾, concluding the <code class="literal">return</code> statement begun back at ❻.</p></div><div class="sect2" title="Running the Script"><div class="titlepage"><div><div><h2 class="title"><a id="running_the_script-id016"/>Running the Script</h2></div></div></div><p>This is also easily demonstrated in irb with <code class="literal">irb -r currency_converter1.rb</code>.<a class="indexterm" id="idx-CHP-5-0531"/></p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id015"/>The Results</h2></div></div></div><a id="I_programlisting5_d1e8424"/><pre class="programlisting">$ irb -r <a class="indexterm" id="idx-CHP-5-0532"/>currency_converter1.rb
irb(main):001:0&gt; cc = CurrencyConverter.new()
=&gt; #&lt;CurrencyConverter:0xb7c94b4c @base_currency="USD", @name="US Dollar"&gt;
irb(main):002:0&gt; cc.output_rates
=&gt; "1 US Dollar (USD) = \n\t46.540136 Indian Rupees(INR)\n\t0.781738
Euros(EUR)\n\t10.890852 Mexican Pesos(MXN)\n\t7.977233 Chinese Yuans(CNY)\n\
t1.127004 Canadian Dollars(CAD)\n"
irb(main):003:0&gt; puts cc.output_rates
1 US Dollar (USD) =
        46.540136 Indian Rupees(INR)
        0.781738 Euros(EUR)
        10.890852 Mexican Pesos(MXN)
        7.977233 Chinese Yuans(CNY)
        1.127004 Canadian Dollars(CAD)
=&gt; nil</pre><p>Notice how the prettier output comes from using <code class="literal">puts</code> and that the returned value from <code class="literal">output_rates</code> is <code class="literal">nil</code>, largely because it’s intended to print results instead.</p></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id010"/>Hacking the Script</h2></div></div></div><p>This is all fine when exchange rates are constant and can be stored in a constant Hash, as in this script. However, the main impetus of having a currency converter stems from the fact that exchange rates constantly change. We need a converter that can update itself with new information when that information becomes available and yet continue to work when such information is inaccessible, for whatever reason. That’s our next script.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-5-FNOTE-3" id="ftn.CHP-5-FNOTE-3">14</a>] </sup>We defined <code class="literal">initialize</code>  before the <code class="literal">private</code> keyword, but <code class="literal">initialize</code> is always a private method, so <code class="literal">output_rates</code> is the only public method of <a class="indexterm" id="idx-CHP-5-0528"/>CurrencyConverter.<a class="indexterm" id="idx-CHP-5-0529"/><a class="indexterm" id="idx-CHP-5-0530"/></p></div></div></div>
<div class="sect1" title="#19 Currency Conversion, Advanced (currency_converter2.rb)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp19_currency_conversion_advanced_cur"/>#19 Currency Conversion, Advanced (currency_converter2.rb)</h1></div></div></div><p>This script builds on what we already know from the previous one and uses a similar approach for the actual conversion process. What we’ve added is the ability to store and retrieve external data in both <a class="indexterm" id="idx-CHP-5-0533"/>YAML and XML formats. YAML is so readable that I will simply tell you what you need to know for this script, and I’m sure that you’ll be inspired to learn more about how it works. XML is a bit more complicated, and it’s beyond the scope of this book to teach it to you if you’re not familiar with it, but you won’t need to be an expert to follow along. I’ll describe the relevant bits of XML for this script’s operation, just as I’ll do with YAML. If you find that the XML-related content of this chapter is going a bit too fast, please refer to the excellent <a class="indexterm" id="idx-CHP-5-0534"/>online <a class="indexterm" id="idx-CHP-5-0535"/>XML Tutorial at <a class="ulink" href="http://www.w3schools.com/xml">http://www.w3schools.com/xml</a>.<a class="indexterm" id="idx-CHP-5-0536"/><a class="indexterm" id="I_indexterm5_d1e8472"/><a class="indexterm" id="I_indexterm5_d1e8476"/></p><p>This script differs from the previous in several ways. Let’s see how.</p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id018"/>The Code</h2></div></div></div><a id="I_programlisting5_d1e8486"/><pre class="programlisting">  #!/usr/bin/env ruby
  # <a class="indexterm" id="idx-CHP-5-0537"/>currency_converter2.rb

  ### RSS feeds for rates at
  # http://www.currencysource.com/rss_currencyexchangerates.html

  =begin rdoc
  open-uri allows Kernel.open to read data using a URI, not just from
  a local file.
  =end
❶ require 'open-uri'
  =begin rdoc
  YAML[http://www.yaml.org] stands for "YAML Ain't Markup Language"
  and is a simple human-readable data markup format.
  =end
  require 'yaml'    <em class="lineannotation"><span class="lineannotation">YAML</span></em>

  =begin rdoc
  I also want to add a method to all &lt;b&gt;Hash&lt;/b&gt;es.
  =end
  class Hash

  =begin rdoc
  Allow &lt;b&gt;Hash&lt;/b&gt;es to be subtracted from each other.
  =end
❷   def -(hash_with_pairs_to_remove_from_self)    <em class="lineannotation"><span class="lineannotation">A Subtraction Method for Hashes; The<strong class="userinput"><code> delete</code></strong> Method</span></em>
      output = self.dup
      hash_with_pairs_to_remove_from_self.each_key do |k|
        output.delete(k)
      end
      output
    end

  end

❸ class CurrencyConverter

    BASE_URL = 'http://currencysource.com/RSS'
    CURRENCY_CODES = {
      'EUR' =&gt; 'Euro',
      'CAD' =&gt; 'Canadian Dollar',
      'CNY' =&gt; 'Chinese Yuan',
      'INR' =&gt; 'Indian Rupee',
      'MXN' =&gt; 'Mexican Peso',
      'USD' =&gt; 'US Dollar',
    }
    RATES_DIRECTORY = 'extras/currency_exchange_rates'

    def initialize(code='USD')    <em class="lineannotation"><span class="lineannotation">The <code class="literal">has_key?</code> and <code class="literal">fail</code> Methods</span></em>
      unless CURRENCY_CODES.has_key?(code)
        fail "I know nothing about #{code}"
      end
      @base_<a class="indexterm" id="idx-CHP-5-0538"/>currency = code
      @name          = CURRENCY_CODES[code]
    end

❹   def output_rates(mult=1, try_new_rates=true)
      rates = get_rates(try_new_rates)
      save_rates_in_local_file!(rates)
      return get_value(mult, rates) + "\n"
    end

    private

❺   def download_new_rates()
      puts 'Downloading new exchange rates...'
      begin    <em class="lineannotation"><span class="lineannotation"><strong class="userinput"><code>begin - rescue - end</code></strong></span></em>
        raw_rate_lines = get_xml_lines()
      rescue
        puts 'Download failed. Falling back to local file.'
        return nil
      end
      rates = Hash.new('')
      comparison_codes = CURRENCY_CODES - { @base_currency =&gt; @name }
      comparison_codes.each_key do |abbr|
        rates[abbr] = get_rate_for_abbr_from_raw_rate_lines(
          abbr,
          raw_rate_lines
        )
      end
      return rates
    end

❻   def get_rates(try_new_rates)
      return load_old_rates unless try_new_rates
      return download_new_rates || load_old_rates
    end

    def get_rate_for_abbr_from_raw_rate_lines(abbr, raw_rate_lines)
      regex = {
        :open =&gt;
          /^\&lt;title\&gt;1 #{@base_currency} = #{abbr} \(/,
        :close =&gt;
          /\)\&lt;\/title\&gt;\r\n$/
      }
      line = raw_rate_lines.detect { |line| line =~ /#{abbr}/ }
      line.gsub(regex[:open], '').gsub(regex[:close], '').to_f
    end

    def get_value(mult, rates)
      return "#{pluralize(mult, @name)} (#{@base_currency}) = \n" +
        rates.keys.map do |abbr|
          "\t#{pluralize(mult * rates[abbr], CURRENCY_CODES[abbr])} (#{abbr})"
        end.join("\n")
    end
  =begin rdoc
  get_xml_lines is able to read from a URI with the open-uri library.
  This also could have been implemented with the RSS library
  written by Kouhei Sutou &lt;kou@cozmixng.org&gt; and detailed at
  http://www.cozmixng.org/~rwiki/?cmd=view;name=RSS+Parser%3A%3ATutorial.en
  =end
❼   def get_xml_lines()    <em class="lineannotation"><span class="lineannotation">XML</span></em>
      open("#{BASE_URL}/#{@base_<a class="indexterm" id="idx-CHP-5-0539"/>currency}.xml").readlines.find_all do |line|
        line =~ /1 #{@base_currency} =/
      end
    end

❽   def load_old_rates()
      puts "Reading stored exchange rates from local file #{rates_filename()}"
      rates = YAML.load(File.open(rates_filename))    <em class="lineannotation"><span class="lineannotation"><strong class="userinput"><code>YAML.load</code></strong></span></em>
      fail 'no old rates' unless rates
      return rates
    end

    def pluralize(num, term)
      (num == 1) ? "#{num} #{term}" : "#{num} #{term}s"
    end

❾   def rates_filename()
      "#{RATES_DIRECTORY}/#{@base_currency}.yaml"
    end

  =begin rdoc
  Store new rates in an external YAML file.
  This is a side-effect akin to memoization, hence the bang.
  =end
❿   def save_rates_in_local_file!(rates)
      return unless rates
      File.open(rates_filename, 'w') { |rf| YAML.dump(rates, rf) }    <em class="lineannotation"><span class="lineannotation"><strong class="userinput"><code>YAML.dump</code></strong></span></em>
    end

  end</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id017"/>How It Works</h2></div></div></div><p>How does this file differ from the previous one? The class definition of CurrencyConverter is delayed until ❸, due to some more comments and <code class="literal">require</code> statements at ❶. I also open the Hash class and give it a <a class="indexterm" id="idx-CHP-5-0540"/>subtraction <a class="indexterm" id="idx-CHP-5-0541"/>method, identified by the minus sign at ❷. This new method takes another Hash and returns the original Hash without any pairs found in the argument Hash. Think of it this way: If <code class="literal">merge</code> is addition of Hashes, this method is the subtraction of Hashes. I suppose a good alternative name would be either <code class="literal">demerge</code> or <code class="literal">unmerge</code>
.</p><p>Inside our CurrencyConverter class (❸), we have two new constants: <code class="literal">BASE_URL</code>, which is used for downloading completely new exchange rates, and <code class="literal">RATES_DIRECTORY</code>, which is used to store exchange rates once they have been downloaded. The class’s <code class="literal">initialize</code> method accepts a <a class="indexterm" id="idx-CHP-5-0542"/>currency <code class="literal">code</code>, so folks from other countries can define their own native converters more easily. (It assumes US dollars with no argument.) If it gets a currency <code class="literal">code</code> that it doesn’t understand, it shouldn’t proceed, so we make it break out of the entire program with the command <code class="literal">fail</code>, which causes the program to stop running. The <code class="literal">output_rates</code> method (❹) also tries to get new rates when told to, saves rates in a local <a class="indexterm" id="idx-CHP-5-0543"/>file, and performs the operations we already know about from the last <a class="indexterm" id="idx-CHP-5-0544"/>script.<a class="indexterm" id="idx-CHP-5-0545"/><a class="indexterm" id="idx-CHP-5-0546"/></p><p>How does it get new rates? The <code class="literal">get_rates</code> method (❻) shows us that it either loads old rates or downloads new rates. If it tries to <code class="literal">download_new_rates</code> (❺) but fails to do so, it will fall back to its old rates again. It defaults to downloading new rates, so let’s look at <code class="literal">download_new_rates</code>.<a class="indexterm" id="idx-CHP-5-0547"/><a class="indexterm" id="idx-CHP-5-0548"/></p><p>After some explanatory printing, we get a <code class="literal">begin</code> statement, which starts a block of code that means <span class="emphasis"><em>Try something, and fall back to some other code if the attempt fails</em></span>. What we’re trying to do is call the <code class="literal">get_xml_lines</code> method. If that fails, we’ll explain to the user via <code class="literal">puts</code> that the download failed and return <code class="literal">nil</code>. The <code class="literal">end</code> statement tells us that the block of code pertaining to the <code class="literal">begin</code> has ended. The <code class="literal">return nil</code> is what allows us to fall back to old exchanges rates within <code class="literal">get_rates</code> if the <code class="literal">get_xml_lines</code> method failed.<a class="indexterm" id="idx-CHP-5-0549"/></p><p>So what does <code class="literal">get_xml_lines</code> do? It’s defined at ❼, and it finds all lines from a given XML file in which one unit of the base currency appears with an equals sign. These lines tell us our <a class="indexterm" id="idx-CHP-5-0550"/>exchange rates. Let’s take a look at what one of those XML files looks like. Here are a few lines from a file I downloaded from <a class="ulink" href="http://www.currencysource.com/RSS/USD.xml">http://www.currencysource.com/RSS/USD.xml</a>.</p><a id="I_programlisting5_d1e8669"/><pre class="programlisting">&lt;item&gt;
&lt;title&gt;1 USD = ARS (3.017607)&lt;/title&gt;
&lt;link&gt;http://www.currencysource.com/tables/USD/1X_USD.htm&lt;/link&gt;
&lt;description&gt;&lt;![CDATA[As of Thursday, May 04, 2006...&lt;br&gt;1 U.S. Dollar (USD) =
3.017607 Argentine Peso (ARS)&lt;br&gt;&lt;br&gt;Call 1-877-627-4817 for 'LIVE'
assistance.&lt;br&gt;&lt;br&gt;Source: IMF&lt;br&gt;&lt;br&gt;Aggregated and published by
CurrencySource.com&lt;br&gt;'Rated #1 in Currency Exchange']]&gt;&lt;/description&gt;
&lt;pubDate&gt;Sun, 08 Oct 2006 06:00:04 CST&lt;/pubDate&gt;
&lt;/item&gt;
&lt;item&gt;
&lt;title&gt;1 USD = AUD (1.342818)&lt;/title&gt;
&lt;link&gt;http://www.currencysource.com/tables/USD/1X_USD.htm&lt;/link&gt;
&lt;description&gt;&lt;![CDATA[As of Sunday, October 08, 2006...&lt;br&gt;1 U.S. Dollar (USD)
= 1.342818 Australian Dollar (AUD)&lt;br&gt;&lt;br&gt;Call 1-877-627-4817 for 'LIVE'
assistance.&lt;br&gt;&lt;br&gt;Source: IMF&lt;br&gt;&lt;br&gt;Aggregated and published by
CurrencySource.com&lt;br&gt;'Rated #1 in Currency Exchange']]&gt;&lt;/description&gt;
&lt;pubDate&gt;Sun, 08 Oct 2006 06:00:04 CST&lt;/pubDate&gt;
&lt;/item&gt;</pre><p>If you’re not already familiar with XML, you can see here that it consists of text in which various content is enclosed by <span class="emphasis"><em>tags</em></span>, which are those bits of text within the <code class="literal">&lt;</code> and <code class="literal">&gt;</code> characters. Newlines are not meaningful. We have two definitions of a type of thing called <code class="literal">item</code>, each of which has a title, a link, a description, and a pubDate. This is the content we’re searching through. You’ll notice that the <code class="literal">&lt;title&gt;</code> lines contain direct statements about <a class="indexterm" id="idx-CHP-5-0551"/>exchange rates between the base <a class="indexterm" id="idx-CHP-5-0552"/>currency and some other currency—in my example, the Argentinian peso and the Australian dollar.</p><p>The reason this operation might fail is that the file we’re trying to open and call <code class="literal">readlines</code> on is not a local file, but a file retrieved from the Internet via a URL. The <code class="literal">open-uri</code> library that we required at ❶ modifies the <code class="literal">open</code> command to allow us to open <a class="indexterm" id="idx-CHP-5-0553"/>URLs as well as local files. Without a functioning <a class="indexterm" id="idx-CHP-5-0554"/>Internet connection, the <code class="literal">open</code> will fail, meaning that there will be no file on which to call the <code class="literal">readlines</code> method within <code class="literal">get_xml_lines</code>. However, if our download operation worked, we’ll be able to assign content into the <code class="literal">raw_rate_lines</code> variable within <code class="literal">download_new_rates</code>. The rest of the <code class="literal">download_new_rates</code> method extracts the exchange rate content out of the raw lines.<a class="indexterm" id="idx-CHP-5-0555"/></p><div class="sect3" title="Downloading Rates Information"><div class="titlepage"><div><div><h3 class="title"><a id="downloading_rates_information"/>Downloading Rates Information</h3></div></div></div><p>The <code class="literal">download_new_rates</code> method extracts the exchange rate by first defining a variable for the <code class="literal">rates</code>, which is a Hash. We give <code class="literal">Hash.new</code> an argument halfway through <code class="literal">download_new_rates</code> so that when a given key is not found in the Hash, the returned value is no longer <code class="literal">nil</code>, but instead the argument that was passed to <code class="literal">Hash.new</code> (the empty String in our example). For our purposes, we want to find <code class="literal">comparison_codes</code>, which are all the pairs pertaining to currencies and their codes, without the <code class="literal">@base_currency</code>.<sup>[<a class="footnote" href="#ftn.CHP-5-FNOTE-4" id="CHP-5-FNOTE-4">15</a>]</sup> We then cycle through each key, which is the abbreviation or code associated with the matching currency, and call the <code class="literal">get_rate_for_abbr_from_raw_rate_lines</code> method, which gets the exchange rate for a given abbreviation from the <code class="literal">raw_rate_lines</code> variable.<a class="indexterm" id="idx-CHP-5-0556"/></p><p>The <code class="literal">get_rate_for_abbr_from_raw_rate_lines</code> method is defined immediately after the definition of <code class="literal">get_rates</code> at ❻. The <code class="literal">regex</code> variable is a Hash that stores some regular expressions that signify the opening and closing of the content we care about (the actual exchange rate value). We detect the first line containing the interpolated <code class="literal">abbr</code> value and then strip off the opening and closing <code class="literal">regex</code> values by substituting each of them with the empty string. We then <code class="literal">return</code> the floating-point version (via the <code class="literal">to_f</code> method) of what we have left. That’s the exchange rate for the currency matching the <code class="literal">abbr</code> argument.<a class="indexterm" id="I_indexterm5_d1e8813"/></p><p>We’ve gotten our rates via downloading, which means that we’re ready to save them into a local file within <code class="literal">initialize</code>. We immediately exit <code class="literal">save_rates_in_local_file!</code> (❿) and do nothing if we have no rates. The reason for this is that if there is some problem with getting rates, we don’t want to overwrite our good stored data from a previous use of this <a class="indexterm" id="idx-CHP-5-0557"/>script. Assuming that all is well, we open a new <a class="indexterm" id="idx-CHP-5-0558"/>file for writing with the name <code class="literal">rates_filename</code>, which looks like a variable. It’s actually a method, defined at ❾. It returns something like <code class="literal">“extras/currency_exchange_rates/USD.yaml”</code> or <code class="literal">“extras/currency_exchange_rates/CAD.yaml”</code>, depending on what your base currency is. It’s a method because it’s entirely dependent on the value of <code class="literal">@base_currency</code>.<a class="indexterm" id="idx-CHP-5-0559"/></p><div class="note" title="Note"><h3 class="title"><a id="note-37"/>Note</h3><p><span class="emphasis"><em>Some schools of programming would have defined an instance variable <em class="replaceable"><code>@rates_filename</code></em> within the <em class="replaceable"><code>initialize</code></em> method, just as we did with <em class="replaceable"><code>@base_currency</code></em> and <em class="replaceable"><code>@name</code></em>. Conversely, we could have treated <em class="replaceable"><code>@name</code></em> the same way we do <em class="replaceable"><code>rates_filename</code></em>, defining a method called <em class="replaceable"><code>name</code></em> that simply returns the value of <em class="replaceable"><code>CURRENCY_CODES[@base_currency]</code></em>. Either approach is useful. Using an instance variable (the “eager” approach) is faster, but the different variables with a close relationship to each other could get out of sync, especially in a more complex program. Using a method (the “lazy” approach) is slower, because it has to recalculate its return value every time—but it also means that your variables won’t get out of agreement with each other, at least in this case</em></span>.<a class="indexterm" id="idx-CHP-5-0560"/><a class="indexterm" id="idx-CHP-5-0561"/></p></div><p>Whether it’s an instance variable or a method, our main concern regarding <code class="literal">rates_filename</code> is that it is a name of a file that can be written into. We do the writing using <code class="literal">YAML.dump</code>, which takes two arguments; the first is a data structure that will be converted into YAML and written into the second argument, which is a File object. Let’s open <code class="literal">extras/currency_exchange_rates/USD.yaml</code> and see what we’ve written.<a class="indexterm" id="idx-CHP-5-0562"/></p><a id="I_programlisting5_d1e8904"/><pre class="programlisting">---
EUR: 0.789639
INR: 45.609987
CNY: 7.890017
MXN: 11.062366
CAD: 1.126398</pre><p>That’s the entire content of <code class="literal">USD.yaml</code>. It represents a single Hash whose keys are currency codes and whose values are floating-point numbers. You’ll notice that newlines are significant, and while this example doesn’t show it, so is indentation. There’s a lot about YAML that you can learn at <a class="ulink" href="http://www.yaml.org">http://www.yaml.org</a>, but I find that <code class="literal">YAML.dump</code> is a great way to learn how things are represented in YAML. If you pass a data structure that you understand into <code class="literal">YAML.dump</code>, you can read the resulting. yaml file to see what the proper representation is. You can then change the data structure in some specific way, rewrite using <code class="literal">YAML.dump</code>, and compare the results. It’s very useful.</p><p>In any case, we have now stored our exchange rate data as YAML in an external file, using <code class="literal">save_rates_in_local_file!</code>. We still have the <code class="literal">rates</code> variable available, so we use it, calling the <code class="literal">get_value</code> method, which uses the same approach as in the previous <a class="indexterm" id="idx-CHP-5-0563"/>script.</p></div><div class="sect3" title="What If You Can’t Download New Rates?"><div class="titlepage"><div><div><h3 class="title"><a id="what_if_you_cant_download_new_rates"/>What If You Can’t Download New Rates?</h3></div></div></div><p>In a later call to the script, we might not be able to download new rates, as previously noted. Therefore, let’s look at the <code class="literal">get_rates</code> method again and assume that we either told the script not to download new rates (using a <code class="literal">false</code> value for the <code class="literal">try_new_rates</code> argument) or that the download attempt failed. Either way, we’ll need to get our <a class="indexterm" id="idx-CHP-5-0564"/>rates from the stored YAML file.</p><p>The <code class="literal">load_old_rates</code> method is at ❽. It informs the user that there will be an attempt to read from the local file. Getting the real data out of a YAML file could hardly be easier: You just call <code class="literal">YAML.load</code>, and give it a File argument, which, in our case is the result of calling <code class="literal">File.open</code> on <code class="literal">rates_filename</code>. The result of <code class="literal">YAML.load</code> is whichever data structure was stored in the external file, so we simply assign it into a variable called <code class="literal">rates</code>. We then ensure that we were able to read data into <code class="literal">rates</code> before proceeding, and finally return <code class="literal">rates</code>.<a class="indexterm" id="idx-CHP-5-0565"/><a class="indexterm" id="idx-CHP-5-0566"/></p></div></div><div class="sect2" title="Running the Script"><div class="titlepage"><div><div><h2 class="title"><a id="running_the_script-id017"/>Running the Script</h2></div></div></div><p>After all this explanation, it’s finally time to see the script in action in irb with <code class="literal">irb -r currency_converter2.rb</code>.<a class="indexterm" id="idx-CHP-5-0567"/><a class="indexterm" id="idx-CHP-5-0568"/></p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id016"/>The Results</h2></div></div></div><a id="I_programlisting5_d1e9007"/><pre class="programlisting">  irb(main):001:0&gt; usd = CurrencyConverter.new
  =&gt; #&lt;CurrencyConverter:0xb7bfb498 @name="US Dollar", @base_currency="USD"&gt;
  irb(main):002:0&gt; inr = CurrencyConverter.new('INR')
  =&gt; #&lt;CurrencyConverter:0xb7bef990 @name="Indian Rupee", @base_currency="INR"&gt;
  irb(main):003:0&gt; usd.output_rates(1)
  Downloading new exchange rates...
  =&gt; "1 US Dollar (USD) = \n\t45.609987 Indian Rupees (INR)\n\t0.789639 Euros
  (EUR)\n\t11.062366 Mexican Pesos (MXN)\n\t7.890017 Chinese Yuans (CNY)\n\
  t1.126398 Canadian Dollars (CAD)\n"
  irb(main):004:0&gt; inr.output_rates(1)
  Downloading new exchange rates...
  =&gt; "1 Indian Rupee (INR) = \n\t0.017313 Euros (EUR)\n\t0.242543 Mexican Pesos
  (MXN)\n\t0.172989 Chinese Yuans (CNY)\n\t0.021925 US Dollars (USD)\n\t0.024696
  Canadian Dollars (CAD)\n"
  irb(main):005:0&gt; usd.output_rates(1, false)
  Reading stored exchange rates from local file extras/currency_exchange_rates/USD.yaml
  =&gt; "1 US Dollar (USD) = \n\t0.789639 Euros (EUR)\n\t45.609987 Indian Rupees 
  (INR)\n\t7.890017 Chinese Yuans (CNY)\n\t11.062366 Mexican Pesos (MXN)\n\
  t1.126398 Canadian Dollars (CAD)\n"
  irb(main):006:0&gt; inr.output_rates(100, false)
  Reading stored exchange rates from local file extras/currency_exchange_rates/
  INR.yaml
  =&gt; "100 Indian Rupees (INR) = \n\t1.7313 Euros (EUR)\n\t17.2989 Chinese Yuans 
  (CNY)\n\t24.2543 Mexican Pesos (MXN)\n\t2.4696 Canadian Dollars (CAD)\n\
  t2.1925 US Dollars (USD)\n"
❶ irb(main):007:0&gt; inr.output_rates(100, (not true))
  Reading stored exchange rates from local file extras/currency_exchange_rates/
  INR.yaml
  =&gt; "100 Indian Rupees (INR) = \n\t1.7313 Euros (EUR)\n\t24.2543 Mexican Pesos
  (MXN)\n\t17.2989 Chinese Yuans (CNY)\n\t2.1925 US Dollars (USD)\n\t2.4696
  Canadian Dollars (CAD)\n"</pre><p>You can see that we can easily define converters for specific currencies; then we can tell the <code class="literal">output_rates</code> method to try to download new rates or not to download them, depending on whether or not the optional second argument evaluates to <code class="literal">false</code>. In line ❶, you see that I’ve passed in <code class="literal">(not true)</code> just to make that point. You’ll also notice that the return values with special characters like newlines and tabs represent those characters the same way we do when we insert them, while printing those return values causes them to be interpreted, making the printing output prettier, or at least more easily readable.</p></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id011"/>Hacking the Script</h2></div></div></div><p>This script depends on the directory hierarchy at <code class="literal">BASE_URL</code> staying the same. If it ever changes, you will need to update <code class="literal">get_xml_lines()</code> at ❼ accordingly. We’re also about to get deeper into some functional programming topics. Once you’re comfortable with <code class="literal">lambda</code> (introduced in the next chapter), you could replace the <code class="literal">rates_filename</code> method with a lambda that accepts <code class="literal">RATES_DIRECTORY</code> and <code class="literal">@base_currency</code> as arguments.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-5-FNOTE-4" id="ftn.CHP-5-FNOTE-4">15</a>] </sup>We remove the <code class="literal">@base_currency</code> since it’s not useful to give the exchange rate between a given currency and itself—the rate would always be exactly one.</p></div></div></div>
<div class="sect1" title="Chapter Recap"><div class="titlepage"><div><div><h1 class="title"><a id="chapter_recap-id003"/>Chapter Recap</h1></div></div></div><p>What was new in this chapter?</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Exponentiation in Ruby</p></li><li class="listitem"><p>Returning <code class="literal">nil</code> when a method’s operation is not possible</p></li><li class="listitem"><p>More recursion and exit conditions</p></li><li class="listitem"><p>Modules and Inheritance</p></li><li class="listitem"><p><code class="literal">Hash.merge</code></p></li><li class="listitem"><p>Class Variables</p></li><li class="listitem"><p><code class="literal">Array.detect</code> (“find first”)</p></li><li class="listitem"><p>Subtracting Hashes</p></li><li class="listitem"><p>Exiting the entire script with <code class="literal">fail</code></p></li><li class="listitem"><p><code class="literal">begin—rescue—end</code></p></li><li class="listitem"><p>Downloading with <code class="literal">open-uri</code></p></li><li class="listitem"><p>Parsing XML files with regular expressions</p></li><li class="listitem"><p>Writing to YAML files with <code class="literal">YAML.dump</code></p></li><li class="listitem"><p>Reading from YAML files with <code class="literal">YAML.load</code></p></li></ul></div><p>It’s almost as if this chapter weren’t really about numbers—we covered a large amount of generically useful information, especially Modules, Class Variables, and external data storage and retrieval using either XML or YAML (or both). We’ve done a bit of functional programming already in the last two chapters, but we’ll get into the deep lambda magic in <a class="xref" href="ch06.html" title="Chapter 6. Functionalism with Blocks and Procs">Chapter 6</a>.<a class="indexterm" id="I_indexterm5_d1e9112"/><a class="indexterm" id="I_indexterm5_d1e9115"/></p></div></body></html>