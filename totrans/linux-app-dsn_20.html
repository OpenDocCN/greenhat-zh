<html><head></head><body>
<div>&#13;
<p class="imgc"><a id="page337"/><img src="../images/361-1.jpg" alt=""/></p>&#13;
<p class="ch"><a id="app5"/><a href="toc.html#app5"><b>THE LADDIE APPLIANCE BOOTABLE CD</b></a></p>&#13;
<p class="imgc"><img src="../images/as.jpg" alt=""/></p>&#13;
<p class="nb">The CD accompanying this book serves two purposes. First, it allows you to demonstrate the techniques described in this book by turning your x86 PC into a working appliance. Second, it allows you to study, in as much detail as you care to, the source code that implements this appliance. In this appendix, we show you how to boot and run the Laddie appliance CD, and we provide a tour of the CD’s contents. We also provide a simple example of how the CD supports modifying, rebuilding, and reinstalling the appliance.</p>&#13;
<p class="secl"><a id="app5.1"/><a href="toc.html#app5.1"><b>Running the Laddie Appliance</b></a></p>&#13;
<p class="noindent">The Laddie CD doesn’t require that your machine be running a specific operating system, you don’t need to install anything, and the CD won’t place anything on your hard drive. In fact, you don’t even need a hard drive. The CD creates a ramdisk for the root filesystem with links back to the CD, and in this context it runs the Laddie appliance. When you’re finished using the CD, simply remove it and reboot your original operating system. You’ll find that nothing has changed.</p>&#13;
<p class="indent"><a id="page338"/>What you do need in order to run the Laddie appliance is an x86-based PC with at least 64 megabytes of system memory, a VESA-compliant video card (if you wish to run the framebuffer user interface), and a BIOS that is configured to boot from a CD-ROM.</p>&#13;
<p class="indent">In this section we’ll explain how to boot the CD, show you how to verify that the framebuffer and web interfaces are working, and then explain how to access the other user interfaces. We’ll also explain how to shut down the appliance.</p>&#13;
<p class="secs"><a id="app5.2"/><a href="toc.html#app5.2"><i><b>Booting the CD</b></i></a></p>&#13;
<p class="noindent">With the Laddie CD in the drive, reboot your computer. If the CD boots successfully, you’ll be greeted with a message like the following:</p>&#13;
<p class="imgl"><img src="../images/362-1.jpg" alt=""/></p>&#13;
<p class="indent">At this point, you should press <small>ENTER</small> or wait six seconds to continue the boot sequence.</p>&#13;
<p class="indent">A commercial appliance would typically hide boot messages from the user. Since this is an educational system, we want you to see them. A commercial appliance designed for a specific hardware configuration would also boot up more quickly. But this CD is designed to work with a broad range of hardware configurations and provide a flexible environment for users to experiment with and build from, so the process takes a little longer. In particular, the startup scripts load drivers for any hardware the system recognizes, even hardware that isn’t required for the Laddie appliance.</p>&#13;
<p class="secs"><a id="app5.3"/><a href="toc.html#app5.3"><i><b>Navigating the Framebuffer User Interface</b></i></a></p>&#13;
<p class="noindent">Once the CD boots successfully, the system will present you with the main screen for the Laddie framebuffer user interface (see Figure E-1). If you see this screen, you’ve succeeded in running the appliance and you should now be able to use your keyboard’s arrow keys and enter key to navigate the Laddie framebuffer user interface. (If your keyboard doesn’t have arrow keys, use <b>i</b> for up, <b>j</b> for left, <b>k</b> for down, and <b>l</b> for right.)</p>&#13;
<p class="seclas"><b>NOTE</b></p>&#13;
<p class="noindent"><i>If the boot up process completes and a login prompt appears instead of the screen shown in Figure E-1, your video card is probably not VESA-compliant. In that case, the Laddie appliance will still run, but you won’t be able to experiment with the framebuffer interface.</i></p>&#13;
<p class="imgc"><a id="page339"/><img src="../images/363-1.jpg" alt=""/></p>&#13;
<p class="cap"><i>Figure E-1: The Laddie framebuffer user interface </i></p>&#13;
<p class="secs"><a id="app5.4"/><a href="toc.html#app5.4"><i><b>Accessing the Web Interface</b></i></a></p>&#13;
<p class="noindent">The Laddie appliance boots up with the static IP address 192.168.1.11. If your PC is connected to a local area network with an Ethernet card recognized by Laddie’s operating system, the appliance will serve web pages that allow you to monitor and control the appliance (see Figure E-2). You can access this web interface with a browser on the local network by using the URL <a href="http://192.168.1.11/">http://192.168.1.11</a>.</p>&#13;
<p class="imgc"><img src="../images/363-2.jpg" alt=""/></p>&#13;
<p class="cap"><i>Figure E-2: The Laddie web interface</i></p>&#13;
<p class="seclas"><b>NOTE</b></p>&#13;
<p class="noindent"><i>You can also use the text-based web browser Lynx to access the Laddie web pages. Type <b>lynx</b> at a command prompt, and then navigate by following the instructions at the bottom of the display.</i></p>&#13;
<p class="secs"><a id="app5.5"/><a href="toc.html#app5.5"><i><b>Experimenting with the Linux Shell and Other User Interfaces</b></i></a></p>&#13;
<p class="noindent">In addition to the framebuffer and web interfaces, the Laddie appliance supports a command line interface, a front panel interface, and an SNMP interface. When experimenting with these other interfaces, you will find it useful to have a Linux shell so that you can interact directly with the operating system. If the Laddie appliance is on a network, you can access a login shell using telnet (i.e., telnet 192.168.1.11). To log in, enter the username root and an empty password. You can also switch from the framebuffer user interface to a login prompt by pressing ctrl-alt-F1. (If you want to return to the framebuffer interface later, press ctrl-alt-F7.)</p>&#13;
<p class="indent"><a id="page340"/>Please see the appropriate chapters for instructions on accessing the CLI, front panel, and SNMP interfaces.</p>&#13;
<p class="secs"><a id="app5.6"/><a href="toc.html#app5.6"><i><b>Shutting Down the Laddie Appliance</b></i></a></p>&#13;
<p class="noindent">The Laddie operating system will not eject the CD while the system is running because it relies on the CD for necessary system files. To eject the CD and return to your original operating system, reboot your computer by typing reboot in a Linux shell. When you see the Laddie boot prompt (as shown in “Booting the CD” on page 338), press the spacebar to interrupt the automatic boot, eject the CD, then press CTRL-ALT-DEL to reboot your computer with your original operating system.</p>&#13;
<p class="secl"><a id="app5.7"/><a href="toc.html#app5.7"><b>Exploring the CD Contents</b></a></p>&#13;
<p class="noindent">If you boot the Laddie appliance and then explore the root filesystem from a Linux shell, you’ll find that most of the top-level directories exist in the ramdisk, and only the /bin, /lib, /sbin, and /usr directories are linked back to the CD. In particular, all the directories related to the Laddie appliance are read-write, so you can use the CD to experiment with, rebuild, and reinstall the appliance.</p>&#13;
<p class="secs"><a id="app5.8"/><a href="toc.html#app5.8"><i><b>Laddie Appliance Source Code</b></i></a></p>&#13;
<p class="noindent">The Laddie Appliance software is provided in /Code/src and is partitioned into packages corresponding to the various user interfaces and services. The binaries and related files are installed in /opt/laddie. Table E-1 identifies the source and install directories for each of the Laddie appliance components.</p>&#13;
<p class="tcap"><b>Table E-1:</b> Source and Install Directories for Laddie Appliance Components</p>&#13;
<p class="imgc"><img src="../images/364-1.jpg" alt=""/></p>&#13;
<p class="indent"><a id="page341"/>In addition to these components, the /Code/src directory contains the buildapp subdirectory, which contains scripts and files that support building the appliance. This subdirectory also contains an examples subdirectory that includes the example programs we discuss in the text.</p>&#13;
<p class="indent">Where appropriate, component subdirectories include Makefiles. There is also a top-level Makefile in /Code/src that allows you to build and re-install the entire appliance with these commands:</p>&#13;
<p class="ex">laddie:~# make<br/>laddie:~# rm -rf /opt/laddie<br/>laddie:~# make install</p>&#13;
<p class="indent">If you’d like to study the source code, a good place to start is the alarm code in the /Code/src/ladd subdirectory. This is a simple application, but it demonstrates both the empty daemon and the RTA library. The entry point for this service is in /Code/src/empd/main.c. The function main calls appInit in ladd.c, which uses RTA to publish a table of alarm zones.</p>&#13;
<p class="secs"><a id="app5.9"/><a href="toc.html#app5.9"><i><b>Laddie Appliance Libraries</b></i></a></p>&#13;
<p class="noindent">The Laddie appliance uses several libraries. The RTA library source is provided in the /usr/src/packages/rta-0.7.5.tgz tarball, and it is installed in /usr/local/lib and /usr/local/include.</p>&#13;
<p class="indent">The PostgreSQL client, the lighttpd daemon, and the SNMP utilities are well-documented open-source projects that we have compiled and installed without patches. The source code for the versions we use is provided in /usr/src/packages:</p>&#13;
<ul>&#13;
<li><span class="bb">postgresql-base-8.0.1.tar.bz2</span></li>&#13;
<li><span class="bb">lighttpd-1.4.10.tar.gz</span></li>&#13;
<li><span class="bb">net-snmp-5.1.3.1.tar.gz</span></li>&#13;
</ul>&#13;
<p class="indent">The RTA library and PostgreSQL client do not have configuration files. The lighttpd daemon uses the configuration file /etc/lighttpd.conf. PHP’s configuration file is in /etc/php.ini.</p>&#13;
<p class="secs"><a id="app5.10"/><a href="toc.html#app5.10"><i><b>Startup Scripts</b></i></a></p>&#13;
<p class="noindent">In order to launch the appliance at system startup, we add scripts to the /etc/rc.d/init.d directory. We also provide links from /etc/rc.d/rc3.d so that these scripts will be invoked in runlevel 3. The Laddie startup scripts include ladd, logmuxd, networkd, snmpd, and tbl2filed. Each of these scripts also provides for the graceful termination of the appliance when the operating system shuts down. The framebuffer user interface is launched at startup using the fbmenuctl script, but because the console must be launched first, we invoke it from the /etc/inittab file.</p>&#13;
<p class="indent"><a id="page342"/>For convenience when testing, we provide the laddie script in /opt/ laddie/bin. This script invokes all of the startup scripts specific to the appliance.</p>&#13;
<p class="secs"><a id="app5.11"/><a href="toc.html#app5.11"><i><b>The Linux From-Scratch Distribution and Additional Packages</b></i></a></p>&#13;
<p class="noindent">Had this been a real Linux appliance, we might have opted for a simpler Linux environment. We might have used a smaller kernel, BusyBox utilities, and uclibc libraries, for example. But our emphasis is not embedded Linux, and we feel a more generic Linux environment keeps the focus on the appliance architecture.</p>&#13;
<p class="indent">As a starting point, we used Linux From Scratch (<a href="http://www.linuxfromscratch.org">http://www.linuxfromscratch.org</a>), a distribution that includes most of the tools we needed to build our appliance, and does not include the X Window System (which we didn’t need). All the packages required to rebuild the Laddie appliance are included in the /usr/src/packages directory. Most of these packages were installed according to instructions from the Linux From Scratch documentation, which is also included in the usr/src/packages directory as LFS-BOOK-6.0.pdf. Additional packages include the following:</p>&#13;
<p class="imgc"><img src="../images/366-1.jpg" alt=""/></p>&#13;
<p class="indent">See the file /usr/src/packages/HISTORY for detailed installation notes for these additional packages.</p>&#13;
<p class="secl"><a id="app5.12"/><a href="toc.html#app5.12"><b>Rebuilding the Laddie Appliance</b></a></p>&#13;
<p class="noindent">As a quick illustration of the CD’s filesystem structure, let’s modify and reinstall a portion of the Laddie appliance. This won’t be permanent; we won’t create a new CD. We’ll just add a line to a .c file in the alarm daemon, recompile it at the Linux shell prompt, reinstall it, and run it.</p>&#13;
<p class="indent">If you’d like to follow along, boot up an x86 PC using the Laddie CD and bring up a shell console. See “Booting the CD” on page 338 for instructions.</p>&#13;
<p class="seclas"><b>NOTE</b></p>&#13;
<p class="noindent"><i>This exercise assumes you can use the vi editor. If you’re not familiar with vi, you can get up to speed quickly with vimtutor, which is also provided on the CD.</i></p>&#13;
<p class="indenth"><a id="page343"/>1. Since the alarm daemon will already be running, kill it with this command:</p>&#13;
<p class="exi">laddie:~# laddie stop</p>&#13;
<p class="indenth">2. Then use the following commands to enter the alarm daemon source directory and open the ladd.c file for editing:</p>&#13;
<p class="exi">laddie:~# cd /Code/src/ladd<br/>laddie:~# vi ladd.c</p>&#13;
<p class="indenth">3. In the function user_update() at the end of the file, find the following lines:</p>&#13;
<p class="exi">syslog(LOG_ALERT, "User set alarm on zone %d, %s",<br/>Zone[rowid].id, Zone[rowid].name);</p>&#13;
<p class="indenth">4. Immediately after these lines, insert the following:</p>&#13;
<p class="exi">syslog(LOG_ALERT, "Hello, world! I've modified the alarm daemon!");</p>&#13;
<p class="indenth">5. Save the file and then quit vi. Build and reinstall ladd with the commands:</p>&#13;
<p class="exi">laddie:~# export DEF_APPDIR=/opt/laddie<br/>laddie:~# make -e<br/>laddie:~# make -e install</p>&#13;
<p class="seclas"><b>NOTE</b></p>&#13;
<p class="noindent"><i>The Laddie appliance components use the environment variable DEF_APPDIR to specify the install location. The default is the more conventional location /usr/local, but we use /opt/laddie instead to make it easier for you to identify the components that are specific to the appliance. The -e option tells the make utility to let environment variables override variables that occur in the Makefiles.</i></p>&#13;
<p class="indent1">This will create a new executable and install it in /opt/laddie/bin. Then start the alarm daemon by entering this command:</p>&#13;
<p class="exi">laddie:~# laddie start</p>&#13;
<p class="indenth">6. Press ESC to exit the framebuffer user interface. Then monitor the system logs with this command:</p>&#13;
<p class="exi">laddie:~# cat /var/log/messages</p>&#13;
<p class="indent">Log messages are routed to the pipe /var/log/messages by the logmuxd event handler. Using cat, we can display these messages at the console. The command will do nothing until an event occurs.</p>&#13;
<p class="indenth"><a id="page344"/>7. To create a user update event, use ctrl-alt-F2 to switch to console 2, and then run the command line interface:</p>&#13;
<p class="exi">laddie:~# cli</p>&#13;
<p class="indenth">8. Create an update event with the following commands:</p>&#13;
<p class="exi">clear all<br/>test 1<br/>quit</p>&#13;
<p class="indenth">9. Now use ctrl-alt-F1 to switch back to the original console. If your reinstall worked, the displayed log messages will contain a time-stamped entry with your new “Hello, world!” message.</p>&#13;
<p class="indenth">10. Use ctrl-C to terminate the logging display.</p>&#13;
</div>&#13;
</body></html>