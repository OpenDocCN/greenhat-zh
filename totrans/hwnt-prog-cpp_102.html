<html><head></head><body>
<div style="height:0pt" id="ch09"/><h1 class="title" id="calibre_toc_113"><span class="chapter-titlelabel">Chapter 9: </span>Portage to Hell</h1><blockquote class="blockquote">
<p class="b24-bookeditorial">C++ is supposed to be a portable language. It's a lovely phrase, "supposed to be": It explains how we were able to find all the programs for this chapter.</p>
</blockquote>


<div class="calibre1">
<h2 class="lot-title" id="calibre_pb_3">
<a name="117" class="calibre16" id="117"/><a name="ch09lev1sec1" class="calibre16" id="ch09lev1sec1"/><span class="chapter-titlelabel">Program 100: </span>Going Down to Rio</h2>
<p class="b24-bookeditorial">The Rio is an MP3 music player. I worked on some Linux software for this device. Each data block ends with a 16-byte control structure. I carefully laid out the struct statement to make sure that the block structure was correct, yet when I tested the program, my Rio kept losing blocks.</p>
<p class="b24-bookeditorial">So what is going on?</p>
<div class="calibre1">
<pre class="literallayout-normal">
  1 /*************************************************
  2  * A small part of a set of routines to          *
  3  * download music to a RIO mp3 player.           *
  4  *                                               *
  5  * Full sources for the original can be found    *
  6  *      at http://www.oualline.com.              *
  7  *                                               *
  8  * This just tests the writing of the end of     *
  9  * block structure to the device.                *
 10  *************************************************/
 11
 12 #include &lt;stdio.h&gt;
 13 /*
 14  * The 16 byte end of block structure for a Rio.
 15  *    (We'd label the fields if we knew what they
 16  *    were.)
 17  */
 18 struct end_block_struct
 19 {
 20     unsigned long int next_512_pos;    // [0123]
 21     unsigned char next_8k_pos1;        // [4]
 22     unsigned char next_8k_pos2;        // [5]
 23
 24     unsigned long int prev_251_pos;    // [6789]
 25     unsigned char prev_8k_pos1;        // [10]
 26     unsigned char prev_8k_pos2;        // [11]
 27
 28     unsigned short check_sum;          // [12,13]
 29     unsigned short prev_32K_pos;       // [14,15]
 30 };
 31
 32 /*
 33  * Macro to print offset of the
 34  * field in the structure
 35  */
 36 #define OFFSET(what) \
 37      printf(#what "     %d\n", int(&amp;ptr-&gt;what));
 38
 39 int main()
 40 {
 41     // A structure for debugging the structure
 42     struct end_block_struct *ptr = NULL;
 43
 44     printf("Structure size %d\n",
 45             sizeof(end_block_struct));
 46     OFFSET(next_512_pos);
 47     OFFSET(next_8k_pos1);
 48     OFFSET(next_8k_pos2);
 49
 50     OFFSET(prev_251_pos);
 51     OFFSET(prev_8k_pos1);
 52     OFFSET(prev_8k_pos2);
 53
 54     OFFSET(check_sum);
 55     OFFSET(prev_32K_pos);
 56     return (0);
 57 }
</pre>
</div>
<p class="b24-bookeditorial">(Next <a href="LiB0120.html#479" target="_parent" class="calibre2">Hint 343</a>. <a href="LiB0121.html#601" target="_parent" class="calibre2">Answer 103</a>.)</p>
<div class="calibre1">
<table class="calibre3" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr class="calibre4">
<td class="bluecell"><span class="calibre22"><b class="calibre13"><img src="_1.gif" alt="Start Sidebar" border="0" class="calibre23"/></b></span></td>
</tr>
</table>
<p class="b24-bookeditorial">One large university computerized its class scheduling. Some course titles had to be abbreviated to make them fit into the length limits placed on them by the computer. Most courses abbreviated well, however "Human Sexuality, Intermediate Course" turned into "Sex Int. Course."</p>
<table class="calibre3" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr class="calibre4">
<td class="bluecell"><span class="calibre22"><b class="calibre13"><img src="_1.gif" alt="End Sidebar" border="0" class="calibre23"/></b></span></td>
</tr>
</table>
</div>
<table class="calibre3" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr class="calibre4">
<td height="16" class="calibre8"/>
</tr>
</table>
</div>
</body></html>