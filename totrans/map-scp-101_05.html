<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;HANDLE MAP EVENTS"><div class="titlepage"><div><div><h1 class="title"><a id="handle_map_events"/>Chapter 5. HANDLE MAP EVENTS</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e5323"/><img src="httpatomoreillycomsourcenostarchimages671943.png.jpg" alt="image with no caption"/></div></div><p>Web-based maps are highly interactive. They make users want to drag them, click them, and zoom them. That's all part of the fun, but this interactivity also makes them more useful. By tapping into this interactivity, you can design those little user movements to provide an even better interface; for instance, changing the visible markers when users drag the map or changing the search radius along with the zoom level.</p><p>Events control all the potential ways a user can interact with your map. You can run special code any time a user drags the map, zooms in, or clicks. Events are also specific to markers, message boxes, and polylines. Read on for a quick introduction to the way Mapstraction organizes events and for examples of each.<a id="IDX-CHP-5-0001" class="indexterm"/></p><div class="sect1" title="Mapstraction's Event Model"><div class="titlepage"><div><div><h1 class="title"><a id="mapstraction_apostrophy_s_event_model"/>Mapstraction's Event Model</h1></div></div></div><p>Events happen, regardless of whether we're paying attention. To be able to react to an event, we need to tell Mapstraction that we care about that particular event. We do this by setting a function for Mapstraction to call when an event happens. This function is called a <span class="emphasis"><em>handler</em></span>.<a id="IDX-CHP-5-0002" class="indexterm"/><a id="IDX-CHP-5-0003" class="indexterm"/><a id="IDX-CHP-5-0004" class="indexterm"/><a id="IDX-CHP-5-0005" class="indexterm"/><a id="IDX-CHP-5-0006" class="indexterm"/><a id="IDX-CHP-5-0007" class="indexterm"/><a id="IDX-CHP-5-0008" class="indexterm"/></p><p>To create an event handler, we need to know the event type we're looking for and the object from which the event will be originating. We register our interest in the event using the following form:<a id="IDX-CHP-5-0009" class="indexterm"/></p><a id="I_programlisting5_d1e5373"/><pre class="programlisting"><em class="replaceable"><code>object.event</code></em>.addHandler(function (event_name, event_source, event_args) {
  // Code to perform after the event
});</pre><p>The potential events that can occur for each object are shown in <a class="xref" href="ch05.html#objects_and_their_events" title="Table 5-1. Objects and Their Events">Table 5-1</a>. The <code class="literal">addHandler</code> function accepts one argument—a reference to a function that will handle the event. In the case of the previous example, and most examples in this chapter, I'm using an anonymous, inline function. You can also use named functions, as I do in most examples that involve markers. If you are going to call the same function on many objects, you'll find it more memory efficient to use a named function.<a id="IDX-CHP-5-0010" class="indexterm"/></p><p>Whether you use an anonymous or named function to handle events, however, the function accepts three arguments: an event name, an event source, and additional event arguments. Those values are passed automatically by Mapstraction. The name will always be the same as <span class="emphasis"><em>event</em></span>, whereas the source will always be the <span class="emphasis"><em>object</em></span>. Additional data, if it exists, is included in the arguments object.</p><div class="table"><a id="objects_and_their_events"/><p class="title">Table 5-1. Objects and Their Events</p><div class="table-contents"><table summary="Objects and Their Events" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Object</p></th><th style="text-align: left" valign="bottom"><p>Event</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">Mapstraction</code></p></td><td style="text-align: left" valign="top"><p><code class="literal">click</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">Mapstraction</code></p></td><td style="text-align: left" valign="top"><p><code class="literal">endPan</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">Mapstraction</code></p></td><td style="text-align: left" valign="top"><p><code class="literal">changeZoom</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">Mapstraction</code></p></td><td style="text-align: left" valign="top"><p><code class="literal">markerAdded</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">Mapstraction</code></p></td><td style="text-align: left" valign="top"><p><code class="literal">markerRemoved</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">Mapstraction</code></p></td><td style="text-align: left" valign="top"><p><code class="literal">polylineAdded</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">Mapstraction</code></p></td><td style="text-align: left" valign="top"><p><code class="literal">polylineRemoved</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">Marker</code></p></td><td style="text-align: left" valign="top"><p><code class="literal">click</code></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">Marker</code></p></td><td style="text-align: left" valign="top"><p><code class="literal">openInfoBubble</code></p></td></tr></tbody></table></div></div><p>Each event is covered in depth in the sections of this chapter.</p></div></div>
<div class="sect1" title="#27: The User Clicks the Map"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_27_colon_the_user_clicks"/>#27: The User Clicks the Map</h1></div></div></div><p>Out-of-the-box interactivity makes mapping APIs pretty special. Using built-in controls, users can drag and pan a map, zoom in, and change map types. Users can also click, but nothing will happen unless you help them out.<a id="IDX-CHP-5-0011" class="indexterm"/><a id="IDX-CHP-5-0012" class="indexterm"/><a id="IDX-CHP-5-0013" class="indexterm"/></p><p>Mapstraction's click event is what reacts to a user's click. Unlike some other events shown in this chapter, knowing that your users clicked is not enough. You need to know <span class="emphasis"><em>where</em></span> they clicked.</p><p>To find out when and where a user clicks, add the following code to your <code class="literal">create_map</code> function:</p><a id="I_programlisting5_d1e5523"/><pre class="programlisting">mapstraction.click.addHandler(function(event_name, event_source, event_args) {
  var clickpoint = event_args.location;
  var mk = new mxn.Marker(clickpoint);
  mapstraction.addMarker(mk);
});</pre><p>Here, we add a handler for Mapstraction's <code class="literal">click</code> event. To react to this event, I've used an anonymous inline function. If you have more than a couple lines of code to run, you'll want to use a standard named function, because long anonymous functions are hard to read. I'm pushing the limits here.</p><p>When the user clicks anywhere within the map, Mapstraction calls our function with three pieces of data, the last of which contains the event arguments. The key piece of information we want is inside those arguments: the click location, which is stored as a <code class="literal">LatLonPoint</code>. The previous example uses that point to create a new marker.</p><p>Each click adds another marker to the map. Do this a few times and your map will look something like <a class="xref" href="ch05s03.html#each_click_adds_a_new_marker" title="Figure 5-1. Each click adds a new marker.">Figure 5-1</a>.</p></div>
<div class="sect1" title="#28: The User Drags the Map"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_28_colon_the_user_drags_th"/>#28: The User Drags the Map</h1></div></div></div><p>If you're a developer who likes to be in control, you may not immediately appreciate the interactivity of maps. Users can move the viewable portion of a map to wherever they want, forgoing your perfectly designed experience. What a drag! In fact, literally a drag, as the user drags the map this way and that. You can use an event, however, to help you gain back a little of that control.<a id="IDX-CHP-5-0014" class="indexterm"/></p><p>You can write code to react to a even the smallest movement of the map. You can use this to force the map back to where you put it, if that's what you prefer. A more friendly reaction is to find a way to recognize the area of the map where the user moved. For example, if you are showing search results, try reloading them with the new center.</p><div class="figure"><a id="each_click_adds_a_new_marker"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject5_d1e5552"/><img src="httpatomoreillycomsourcenostarchimages672037.png.jpg" alt="Each click adds a new marker."/></div></div><p class="title">Figure 5-1. Each click adds a new marker.</p></div><p>For this example, we'll merely create a JavaScript alert whenever we notice the map has moved. And how do we know when a map has moved? Add these lines to your basic map:<a id="IDX-CHP-5-0015" class="indexterm"/><a id="IDX-CHP-5-0016" class="indexterm"/></p><a id="I_programlisting5_d1e5565"/><pre class="programlisting">mapstraction.<strong class="userinput"><code>endPan</code></strong>.addHandler(function(event_name, event_source, event_args) {
  alert('The map just moved!');
});</pre><p>Here, we add a handler for Mapstraction's <code class="literal">endPan</code> event. To react to this event, I've used an anonymous inline function. If you have more than a couple lines of code to run, you'll want to use a standard named function.</p><p>With this code implemented, any time the user moves the map, this event will fire, and the alert box will pop up. Programmatically setting the center will also trigger the event because the map has been panned (just not directly by the user). The event does not fire when you initially set the center of the map, however, only because that code comes before Mapstraction knows to look out for map movement.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>With some providers, such as Google, the <code class="literal">endPan</code> event will also be triggered when the zoom level changes.</p></div><p>As soon as the <code class="literal">endPan</code> event fires, you'll have access to the current map data, such as the center, via the Mapstraction object. Here's an example that creates a new marker at the new center whenever the user drags the map:</p><a id="I_programlisting5_d1e5588"/><pre class="programlisting">mapstraction.endPan.addHandler(function(event_name, event_source, event_args) {
  var mk = new mxn.Marker(mapstraction.getCenter());
  mapstraction.addMarker(mk);
});</pre><p>Enter this into your basic map's <code class="literal">create_map</code> function, and load it into a browser. Try moving the map and each time you'll find a brand new marker at its center.</p></div>
<div class="sect1" title="#29: The Zoom Level Changes"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_29_colon_the_zoom_level_ch"/>#29: The Zoom Level Changes</h1></div></div></div><p>"Let's take a closer look," she thinks, clicking the plus-sign button to zoom closer into the map. Assuming you provide the interface to do so, your users will be doing a lot of zooming in and zooming out. In some maps, reacting to those sometimes drastic changes in the map's bounds is important, which is where Mapstraction's zoom event can be your best friend.<a id="IDX-CHP-5-0017" class="indexterm"/></p><p>You can make your map handle the zoom event and do something useful, such as reset your search radius. Or, as shown later in this chapter, determine whether the user moves the map outside preset bounds.</p><p>For this example, we'll create a JavaScript alert whenever the map is zoomed, so you can get a feeling for when this event is triggered. Add the following code to your basic map's <code class="literal">create_map</code> function:</p><a id="I_programlisting5_d1e5613"/><pre class="programlisting">mapstraction.<strong class="userinput"><code>changeZoom</code></strong>.addHandler(function(event_name, event_source, event_args) {
  alert('Zoom level changed!');
});</pre><p>Here, we add a handler for Mapstraction's <code class="literal">changeZoom</code> event. To react to this event, I've used an anonymous inline function. If you have more than a couple lines of code to run, you'll want to use a standard named function.</p><p>Try loading your map with this code included. Change the zoom on your map a few times, and watch it respond. If your provider interprets a double-click as a zoom in (and most do), try that, too. Your users won't be able to zoom in or out without you knowing about it!</p><p>Do you want to respond with something a little more useful? How about an alert displaying the new zoom level? Try the following code:</p><a id="I_programlisting5_d1e5627"/><pre class="programlisting">mapstraction.<strong class="userinput"><code>changeZoom</code></strong>.addHandler(function(event_name, event_source, event_args) {
  alert('Changed zoom to level ' + mapstraction.getZoom());
});</pre><p>Now, each time your users zoom in or out, a message doesn't just say that the zoom level changed; it also shows the new zoom level. If your map has large zoom controls, try zooming in quickly from your current level to one very close in or try zooming extremely far out. An alert will pop up with the new zoom level number. If you'd like to make more sense of zoom levels, see <a class="xref" href="ch01s07.html" title="Set Zoom Level">Set Zoom Level</a> in <a class="xref" href="ch01s07.html" title="Set Zoom Level">Set Zoom Level</a>.<a id="IDX-CHP-5-0018" class="indexterm"/><a id="IDX-CHP-5-0019" class="indexterm"/><a id="IDX-CHP-5-0020" class="indexterm"/><a id="IDX-CHP-5-0021" class="indexterm"/></p></div>
<div class="sect1" title="#30: A Marker Is Added to or Removed from the Map"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_30_colon_a_marker_is_added"/>#30: A Marker Is Added to or Removed from the Map</h1></div></div></div><p>Markers, markers everywhere. Once your mapping application becomes large, you might be adding markers from many different areas of your code. The same could be true of removing markers. You can take advantage of two events that will call a function you specify when a marker is added or removed.<a id="IDX-CHP-5-0022" class="indexterm"/><a id="IDX-CHP-5-0023" class="indexterm"/></p><p>Add the following code to your basic map's <code class="literal">create_map</code> function:</p><a id="I_programlisting5_d1e5676"/><pre class="programlisting">mapstraction.markerAdded.addHandler(function(event_name, event_source, event_args) {
  alert('Added marker at ' + event_args.marker.location);
});
mapstraction.markerRemoved.addHandler(function(event_name, event_source, event_args) {
  alert('Removed marker at ' + event_args.marker.location);
});</pre><p>Of course, using a JavaScript alert to let the user know a marker has been added or removed is probably not that helpful. Instead, you might update your own metadata on markers or autocenter the map based on the new or remaining markers.</p><p>You can access the affected marker via the <code class="literal">event_args</code> object, which contains one property called <code class="literal">marker</code>. You may find it more intuitive to access the marker from the <code class="literal">event_source</code> object. Though these events are related to markers, they are initiated by the Mapstraction object, which is passed as the source.</p><p>Because the only way to add or remove markers is through your code, plenty of other non-event-based ways available to perform an action when a marker is added or removed. As mentioned, you might only find this useful if you have a large application.</p></div>
<div class="sect1" title="#31: A Polyline Is Added to or Removed from the Map"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_31_colon_a_polyline_is_add"/>#31: A Polyline Is Added to or Removed from the Map</h1></div></div></div><p>Do you use lots of polylines on your maps? You can use an event to run a special function every time you add or remove a polyline. This feature is especially useful for large mapping applications, where many different places create new lines or when you need to nix unnecessary ones.</p><p>To create functions for the two Polyline events, add the following code to your <code class="literal">create_map</code> function:<a id="IDX-CHP-5-0024" class="indexterm"/><a id="IDX-CHP-5-0025" class="indexterm"/><a id="IDX-CHP-5-0026" class="indexterm"/><a id="IDX-CHP-5-0027" class="indexterm"/><a id="IDX-CHP-5-0028" class="indexterm"/></p><a id="I_programlisting5_d1e5722"/><pre class="programlisting">mapstraction.polylineAdded.addHandler(function(event_name, event_source, event_args) {
  alert('Added polyline starting at ' + event_args.polyline.points[0]);
});
mapstraction.polylineRemoved.addHandler(function(event_name,
 event_source, event_args) {
  alert('Removed polyline starting at ' + event_args.polyline.points[0]);
});</pre><p>I have created a JavaScript alert to show the first point of the polyline that has been added or removed. You'll want to include something more useful than JavaScript alerts, which users would see as overkill in most situations. You might choose to autocenter the map based on the new or removed polyline, for example.</p><p>You can access the affected polyline via the <code class="literal">event_args</code> object, which contains one property called <code class="literal">polyline</code>. You may find it more intuitive to access the polyline from the <code class="literal">event_source</code> object. Though these events are related to polylines, they are initiated by the Mapstraction object, which is passed as the source.</p><p>Like adding and removing markers, your code is the only way to add new polylines to (or remove unwanted ones from) the map. Due to this fact, other methods are available for running code in these events. For large applications, however, you may prefer this event-based approach.</p></div>
<div class="sect1" title="#32: The User Opens or Closes a Message Box"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_32_colon_the_user_opens_or"/>#32: The User Opens or Closes a Message Box</h1></div></div></div><p>Your map's markers can only do so much to communicate a location's meaning. The rest happens in a message box, which users can open by clicking a marker. If you want to react when a message box is opened or closed, you'll need to write event handlers for each marker.<a id="IDX-CHP-5-0029" class="indexterm"/></p><p>A common use case is to update a section of the website outside the map when a message box is opened. For example, perhaps you want to highlight the result related to that marker in search results. Or you may want to hide each marker once its message box has been viewed. Here, we'll stick with our method of showing a JavaScript alert.</p><p>Add the following code to your basic map's <code class="literal">create_map</code> function:</p><a id="I_programlisting5_d1e5754"/><pre class="programlisting">var mk = new mxn.Marker(mapstraction.getCenter());
mk.setInfoBubble('Look ma, No Starch!');
mk.<strong class="userinput"><code>openInfoBubble</code></strong>.addHandler(myboxopened);
mk.<strong class="userinput"><code>closeInfoBubble</code></strong>.addHandler(myboxclosed);
mapstraction.addMarker(mk);</pre><p>And include this function within the JavaScript section, but outside of other functions:<a id="IDX-CHP-5-0030" class="indexterm"/><a id="IDX-CHP-5-0031" class="indexterm"/></p><a id="I_programlisting5_d1e5774"/><pre class="programlisting">function myboxopened(event_name, ❶event_source, event_args) {
  alert('Opened bubble attached to marker at ' + ❷event_source.location);
}
function myboxclosed(event_name, event_source, event_args) {
  alert('Closed bubble attached to marker at ' + event_source.location);
}</pre><p>Here, I've created a simple marker in the center of the map with a message box, similar to what we created in <a class="xref" href="ch02s03.html" title="#3: Show a Message Box When Your Marker Is Clicked">#3: Show a Message Box When Your Marker Is Clicked</a> in <a class="xref" href="ch02s03.html" title="#3: Show a Message Box When Your Marker Is Clicked">#3: Show a Message Box When Your Marker Is Clicked</a>. The events for opening and closing message boxes are shown in bold. For this particular marker, we're waiting to react to either of these events.</p><p>When the event fires, we call the named functions, either <code class="literal">myboxopened</code> or <code class="literal">myboxclosed</code>. You can name these functions anything you want. When the appropriate function is called, the marker is passed to the <code class="literal">event_source</code> variable ❶. At this point, we have access to any of this marker's attributes, including the location ❷. We can do anything with this marker that we can do with any other marker, including hide it, removing it, or setting new attributes (perhaps tracking which message boxes have been opened?).</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Unlike some of the previous examples, we add handlers for these events to the marker object, not the Mapstraction object. If you want to run similar code for every marker, you need to add an event to each marker.</p></div><p>As you can see from comparing the code for the two events, reacting to a closed message box uses almost identical code. You can see a more advanced example of the <code class="literal">closeInfoBubble</code> event later in this chapter.</p></div>
<div class="sect1" title="#33: The User Clicks a Marker"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_33_colon_the_user_clicks_a"/>#33: The User Clicks a Marker</h1></div></div></div><p>Your users see all those markers on the map and many will want to click them to learn more about a particular location. That's what the message box is for, right? Well, you may want to do a little more. In those cases, you'll need a way to tell when a marker has been clicked. As you might have guessed, Mapstraction has an event for just this occasion.</p><p>The marker click event, like the other marker events, is attached to the marker itself. So, if you want to perform the same action for every marker, you'll need to add a handler individually.</p><p>For this example, we'll simply use a single marker and create a JavaScript alert to share its location. Add the following code to the <code class="literal">create_map</code> function of your basic map:</p><a id="I_programlisting5_d1e5814"/><pre class="programlisting">var mk = new mxn.Marker(mapstraction.getCenter());
mk.<strong class="userinput"><code>click</code></strong>.addHandler(mymarkerclicked);</pre><p>And include this function within the JavaScript section but outside of other functions:<a id="IDX-CHP-5-0032" class="indexterm"/><a id="IDX-CHP-5-0033" class="indexterm"/><a id="IDX-CHP-5-0034" class="indexterm"/><a id="IDX-CHP-5-0035" class="indexterm"/><a id="IDX-CHP-5-0036" class="indexterm"/><a id="IDX-CHP-5-0037" class="indexterm"/><a id="IDX-CHP-5-0038" class="indexterm"/></p><a id="I_programlisting5_d1e5848"/><pre class="programlisting">function mymarkerclicked(event_name, ❶event_source, event_args) {
  alert('Clicked the marker at ' + ❷event_source.location);
}</pre><p>When the event fires, the <code class="literal">mymarkerclicked</code> function is called with three arguments. The marker is then passed to the <code class="literal">event_source</code> variable ❶. At this point, we have access to any of this marker's attributes, including the location ❷. We can do anything with this marker that we can do with any other marker, but here we've just created a JavaScript alert.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>This event is different than Mapstraction's main click event, which fires whenever the map is clicked. In this case, the event is attached to a particular marker, and your code only runs when that marker is clicked.</p></div><p>Here's the truth: You won't use this event very often because a message box is the best way to show information about a marker. The marker click event is a useful tool, however, for the times when you want to do something a bit different.</p></div>
<div class="sect1" title="#34: Return to the Center When the Message Box Is Closed"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_34_colon_return_to_the_cen"/>#34: Return to the Center When the Message Box Is Closed</h1></div></div></div><p>Have I sung the praises of message boxes enough yet? They help explain what your markers represent. They provide additional information about a location yet only at the moment the user wants it. They make your maps more informative and more interactive. But they can also get in the way, as shown in <a class="xref" href="ch05s09.html#opening_a_message_box_can_move_your_map" title="Figure 5-2. Opening a message box can move your map.">Figure 5-2</a>.</p><p>Depending on your provider, opening a message box can cause your map to pan ungracefully, leaving a messy map when the user has closed the message box. A little code and the help of an event already covered in this chapter can improve the user's experience. Re-enter the <code class="literal">closeInfoBubble</code> event.</p><p>Let's say you've laid out your markers so they fit perfectly within the map, as shown in <a class="xref" href="ch02s08.html" title="#8: Determine the Correct Zoom Level to Use Based on Markers">#8: Determine the Correct Zoom Level to Use Based on Markers</a> in <a class="xref" href="ch02s07.html" title="#7: Loop Through All Markers">#7: Loop Through All Markers</a>. If you make that code run again whenever the user closes a message box and after each new marker is added, your map will always look organized.</p><p>Add this code after creating a marker:</p><a id="I_programlisting5_d1e5883"/><pre class="programlisting">mk.closeInfoBubble.addHandler(myboxclosed);</pre><p>And add the function to handle the event:</p><a id="I_programlisting5_d1e5887"/><pre class="programlisting">function myboxclosed(event_name, event_source, event_args) {
  mapstraction.autoCenterAndZoom();
}</pre><p>This code assumes a marker named <code class="literal">mk</code>, but you'll want to change that to match whatever variable name you choose for your marker. Also remember that the <code class="literal">closeInfoBubble</code> event is set for a single marker. In order for the event to fire for every marker, you need to set it for every marker.<a id="IDX-CHP-5-0039" class="indexterm"/><a id="IDX-CHP-5-0040" class="indexterm"/></p><div class="sect2" title="Preserve the Previous Center"><div class="titlepage"><div><div><h2 class="title"><a id="preserve_the_previous_center"/>Preserve the Previous Center</h2></div></div></div><p>Re-autocentering code might be very useful for most situations because users can still see every marker. In some cases, however, you might want to give the user a little more control, while still maintaining the benefit of reorganizing your map when a message box is closed. Here, you want to remember where the map was before the user opened the message box.</p><p>To achieve this result, you'll need to use the two message box events in tandem. This method is a simple and effective way to preserve the map's center. Add the following code after creating each marker:</p><a id="I_programlisting5_d1e5912"/><pre class="programlisting">mk.openInfoBubble.addHandler(myboxopened);
mk.closeInfoBubble.addHandler(myboxclosed);</pre><p>And then include these handler functions:</p><a id="I_programlisting5_d1e5916"/><pre class="programlisting">function myboxopened(event_name, event_source, event_args) {
❶   mapcenter = mapstraction.getCenter();
  }
  function myboxclosed(event_name, event_source, event_args) {
    mapstraction.setCenter(mapcenter, ❷{pan: true});
  }</pre><p>As with the previous example, I'm assuming a marker named <code class="literal">mk</code>. Additionally, I've added a global variable named <code class="literal">mapcenter</code> to hold the <code class="literal">LatLonPoint</code> of the map's center.</p><p>Whenever a message box is opened, the <code class="literal">openInfoBubble</code> event fires <span class="emphasis"><em>before</em></span> the provider moves the map to make room for the message box. This is important: Now we have a chance to record the map's center ❶, which will allow us to reset it later.</p><p>When the message box is closed, the <code class="literal">closeInfoBubble</code> event fires. Instead of autocentering, we set the center to the one stored when the message box was opened, as shown in <a class="xref" href="ch05s09.html#return_to_the_previous_center_when_the_m" title="Figure 5-3. Return to the previous center when the message box is closed.">Figure 5-3</a>. To be extra kind to the user's eyes, we pan the map ❷ instead of setting the center directly.</p><p>Now you've used events to subtly improve your users' interactions with your maps.</p><div class="figure"><a id="opening_a_message_box_can_move_your_map"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject5_d1e5949"/><img src="httpatomoreillycomsourcenostarchimages672039.png.jpg" alt="Opening a message box can move your map."/></div></div><p class="title">Figure 5-2. Opening a message box can move your map.</p></div><div class="figure"><a id="return_to_the_previous_center_when_the_m"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject5_d1e5958"/><img src="httpatomoreillycomsourcenostarchimages672041.png.jpg" alt="Return to the previous center when the message box is closed."/></div></div><p class="title">Figure 5-3. Return to the previous center when the message box is closed.</p></div></div></div>
<div class="sect1" title="#35: The User Moves the Map Outside Preset Bounds"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_35_colon_the_user_moves_th"/>#35: The User Moves the Map Outside Preset Bounds</h1></div></div></div><p>Drag that map all you want, users. But don't drag it too far or we won't have anything else to show you. Providers have mapped the whole earth, but your map may only contain data for a particular neighborhood or city. You can use events to let you know when the user has moved outside of a predetermined area.<a id="IDX-CHP-5-0041" class="indexterm"/><a id="IDX-CHP-5-0042" class="indexterm"/><a id="IDX-CHP-5-0043" class="indexterm"/><a id="IDX-CHP-5-0044" class="indexterm"/><a id="IDX-CHP-5-0045" class="indexterm"/></p><p>Let's say you're creating a sightseeing map of Yellowstone National Park. You'd include Old Faithful geyser and Mammoth Hot Springs because they're both within Yellowstone. You wouldn't include the Statue of Liberty because that's thousands of miles away. We want to warn users that if they drag the map away from Yellowstone, they won't find anything there.</p><p>To start, let's get a basic map centered on Yellowstone. Add the following code to your JavaScript, replacing any other map code:</p><a id="I_programlisting5_d1e5993"/><pre class="programlisting">var mapstraction;
❶ var yellowstone = new mxn.BoundingBox(43.7, −111.8, 45.5, −109.3);
  function create_map() {
    mapstraction = new mxn.Mapstraction('mymap', 'google');
    mapstraction.addLargeControls();
    // Add Old Faithful marker
    var ofmk = new mxn.Marker(new mxn.LatLonPoint(44.46270, −110.81153));
    ofmk.setInfoBubble('Old Faithful');
    mapstraction.addMarker(ofmk);
    // Add Mammoth Hot Springs marker
    var mammk = new mxn.Marker(new mxn.LatLonPoint(44.97682, −110.70425));
    mk.setInfoBubble('Mammoth Hot Springs');
    mapstraction.addMarker(mk);
    mapstraction.autoCenterAndZoom();
    // Event code below here
❷
  }
  // Additional functions below here
❸</pre><p>First, we make a global variable to hold the <code class="literal">BoundingBox</code> to describe Yellowstone ❶. We'll use these bounds in the next step. Within the <code class="literal">create_map</code> function, you'll see a marker for each of the two sights I mentioned. After that, the map is automatically centered to show just those locations. I left two lines to indicate where we'll soon be adding additional code. One spot ❷ is for event code, and the other ❸ is for functions we'll use to determine whether the map is outside of Yellowstone.</p><p>Save the code and load it into a browser. Your map should look something like <a class="xref" href="ch05s10.html#yellowstone_national_park_with_markers_f" title="Figure 5-4. Yellowstone National Park with markers for two sights">Figure 5-4</a>. Try dragging the map to show more area to the north. Drag far enough and the map will be in Canada, far away from Yellowstone. Let's see what we can do to provide users with a warning.</p><p>The act of dragging the map is what moves users far from Yellowstone, so we need to handle the <code class="literal">endPan</code> event, as described earlier in this chapter. Add the following within the <code class="literal">create_map</code> function in the section we set aside for event code:<a id="IDX-CHP-5-0046" class="indexterm"/></p><a id="I_programlisting5_d1e6018"/><pre class="programlisting">mapstraction.endPan.addHandler(function(event_name, event_source, event_args) {
  if (❹!boundsInBounds(mapstraction.getBounds(), yellowstone)) {
    alert('Watch out! You might be leaving Yellowstone...');
  }
});</pre><div class="figure"><a id="yellowstone_national_park_with_markers_f"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject5_d1e6023"/><img src="httpatomoreillycomsourcenostarchimages672043.png.jpg" alt="Yellowstone National Park with markers for two sights"/></div></div><p class="title">Figure 5-4. Yellowstone National Park with markers for two sights</p></div><p>Here we've created code that runs each time the user finishes dragging the map. It uses the global <code class="literal">yellowstone</code> variable, which is the <code class="literal">BoundingBox</code> that describes Yellowstone. The bounds is only data and not visible on the map. <a class="xref" href="ch05s10.html#bounds_of_yellowstone" title="Figure 5-5. Bounds of Yellowstone">Figure 5-5</a> shows the area our bounds cover, however. You can see I've made the bounds big enough to include a reasonable buffer around Yellowstone. We want users to be able to see what's nearby. We only want to warn them when they're obviously off course.</p><p>To check if our map is still within our Yellowstone bounds, we need to compare the new variable to the map's bounds. To do so, we pass each of these to a function called <code class="literal">boundsInBounds</code>, which we still need to write. If that function returns false ❹ (the exclamation point in the code is read as "not"), then we create a JavaScript alert to warn the user.<a id="IDX-CHP-5-0047" class="indexterm"/><a id="IDX-CHP-5-0048" class="indexterm"/></p><div class="figure"><a id="bounds_of_yellowstone"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject5_d1e6053"/><img src="httpatomoreillycomsourcenostarchimages672045.png.jpg" alt="Bounds of Yellowstone"/></div></div><p class="title">Figure 5-5. Bounds of Yellowstone</p></div><p>Let's include the new function outside of <code class="literal">create_map</code>, in the section we set aside for function code:</p><a id="I_programlisting5_d1e6063"/><pre class="programlisting">function boundsInBounds(smaller, larger) {
  if (larger.contains(smaller.sw) &amp;&amp; larger.contains(smaller.ne)) {
    return true;
  }
  return false;
}</pre><p>The function accepts two <code class="literal">BoundingBox</code> variables as arguments. The first is the one we <span class="emphasis"><em>expect</em></span> to be smaller, in this case the map's bounds. The second is the bounds we're checking, in this case Yellowstone. Because a <code class="literal">BoundingBox</code> is made up of two points (its southwest and northeast corners), we know that one <code class="literal">BoundingBox</code> is inside another only if the larger bounds contains both points.</p><p>The event code that we wrote previously will only create an alert if this function returns false, meaning the user has dragged the map outside of Yellowstone. Try it yourself. Drag the map north. Once you leave Yellowstone, you'll receive a warning after each drag of the map, as shown in <a class="xref" href="ch05s10.html#javascript_alert_triggered_when_the_user" title="Figure 5-6. JavaScript alert triggered when the user moves outside of Yellowstone bounds">Figure 5-6</a>.</p><div class="figure"><a id="javascript_alert_triggered_when_the_user"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject5_d1e6086"/><img src="httpatomoreillycomsourcenostarchimages672047.png.jpg" alt="JavaScript alert triggered when the user moves outside of Yellowstone bounds"/></div></div><p class="title">Figure 5-6. JavaScript alert triggered when the user moves outside of Yellowstone bounds</p></div></div></body></html>