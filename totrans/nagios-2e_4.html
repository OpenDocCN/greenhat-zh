<html><head></head><body>
  <div class="part" title="Part&#xA0;IV.&#xA0;Part IV Special Applications">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="special_applications"/>Part IV. Part IV Special Applications</h1>
    </div>

    <div class="partintro" id="id2548412" title="Part IV Special Applications"/>
  </div>


  <div class="chapter" title="Chapter&#xA0;20.&#xA0;Monitoring Windows Servers">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_windows_servers"/>Chapter 20. Monitoring Windows Servers</h1>
    </div>

    <p>You don't always deal with a homogeneous server landscape consisting of just Linux or Linux/Unix computers. As long as you are just monitoring pure network services, operating systems make no difference. But if you want to query local, non-network-capable resources, that is a different matter altogether.<a class="indexterm" id="IDX-CHP-20-1657"/></p>

    <p>With Unix-based systems such as Mac OS X, you can normally use the tools described so far (local plugins, NRPE, NSCA). In Windows you have to find other solutions. To some extent, local plugins can be run and/or compiled in an environment emulating Unix (for example, Cygwin<sup>[<a class="footnote" href="#ftn.CHP-20-FN-1" id="CHP-20-FN-1">228</a>]</sup>).<a class="indexterm" id="IDX-CHP-20-1658"/></p>

    <p>Because of the different philosophies of the operating system families, there are peculiarities as well, features in one operating system that are not comparable with anything in the other operating system. So although the Windows event log fulfils much the same purpose as syslog in Unix, it is queried in a completely different way, seen from a technical point of view. Here you cannot simply compile the Unix plugin in Windows and then use it.<a class="indexterm" id="IDX-CHP-20-1659"/><a class="indexterm" id="IDX-CHP-20-1660"/></p>

    <p>One monitoring approach for Windows servers is to use SNMP, for which Microsoft includes a native implementation that just needs to be installed. Since the SNMP query of a Windows agent does not differ in principle from that of other SNMP agents, we refer you to <a class="xref" href="../Text/ch11.html" title="Chapter 11. Collecting Information Relevant for Monitoring with SNMP">Chapter 11</a>, page 227. The Microsoft implementation, however, does not always work reliably where the display of figures—particularly CPU load and hard drive space—is concerned.<a class="indexterm" id="IDX-CHP-20-1661"/></p>

    <div class="figure">
      <a id="check_underscore_nt_queries_local_wi"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e40142"/><img alt="check_nt queries local Windows resources about the NSClient mechanism." src="../Images/tagoreillycom20081104nostarchimages223990.png.jpg"/></div>

      <p class="title">Figure 20-1. <code class="userinput">check_nt</code> queries local Windows resources about the NSClient mechanism.</p>
    </div>

    <p>But local Windows resources can also be queried if you install a service on the Windows server that can be addressed over the network. Previously, only a single tool was available, NSClient, but today you have a choice of various programs: NSClient, NSClient++, OpMon Agent, or NC_Net. For all of them, basic parameters such as CPU and hard disk load, memory usage or Windows counters are queried with the <strong class="userinput"><code>check_nt</code></strong> plugin (see <a class="xref" href="../Text/ch20.html#check_underscore_nt_queries_local_wi" title="Figure 20-1. check_nt queries local Windows resources about the NSClient mechanism.">Figure 20-1</a>), which is one of the standard Nagios plugins.<a class="indexterm" id="IDX-CHP-20-1662"/><a class="indexterm" id="IDX-CHP-20-1663"/></p>

    <div class="figure">
      <a id="check_underscore_nrpe_uses_the_nrpe"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e40165"/><img alt="check_nrpe uses the NRPE mechanism to execute checks via NSClient++, OpMon Agent, and NRPE_NT." src="../Images/tagoreillycom20081104nostarchimages223992.png.jpg"/></div>

      <p class="title">Figure 20-2. <code class="userinput">check_nrpe</code> uses the NRPE mechanism to execute checks via NSClient++, OpMon Agent, and NRPE_NT.</p>
    </div>

    <p>In addition, NSClient++ and OpMon Agent support NRPE (see <a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a> from page 213). Querying the locally installed plugins is done by <strong class="userinput"><code>check_ nrpe</code></strong> (<a class="xref" href="../Text/ch20.html#check_underscore_nrpe_uses_the_nrpe" title="Figure 20-2. check_nrpe uses the NRPE mechanism to execute checks via NSClient++, OpMon Agent, and NRPE_NT.">Figure 20-2</a>).<a class="indexterm" id="IDX-CHP-20-1664"/></p>

    <p>NC_Net in turn allows passive checks, the results of which are sent to the Nagios server by the NSCA (<a class="xref" href="../Text/ch14.html" title="Chapter 14. The Nagios Service Check Acceptor (NSCA)">Chapter 14</a>, page 299). If you query the data with <strong class="userinput"><code>check_ncnet</code></strong> (<a class="xref" href="../Text/ch20.html#check_underscore_ncnet_allows_passive" title="Figure 20-3. check_ncnet allows passive checks.">Figure 20-3</a>) instead of the standard plugin <strong class="userinput"><code>check_nt</code></strong>, an extended set of commands is available (<a class="xref" href="../Text/ch20s03.html#installing_the_check_underscore_nc" title="20.3.3 Installing the check_ncnet plugin">20.3.3 Installing the check_ncnet plugin</a>, page 480).</p>

    <div class="figure">
      <a id="check_underscore_ncnet_allows_passive"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e40201"/><img alt="check_ncnet allows passive checks." src="../Images/tagoreillycom20081104nostarchimages223994.png.jpg"/></div>

      <p class="title">Figure 20-3. <code class="userinput">check_ncnet</code> allows passive checks.</p>
    </div>

    <p>Finally, there is also a purely NRPE service for Windows: NRPE_NT, which is configured the same as in Unix. Due to the additional NRPE functionality of NSClient++ and OpMon Agent, however, this has lost some of its significance.<a class="indexterm" id="IDX-CHP-20-1665"/></p>

    <div class="sect1" title="20.1 Agent-less Checks via WMI">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="agent-less_checks_via_wmi"/>20.1 Agent-less Checks via WMI</h1>
      </div>

      <p>With <span class="emphasis"><em>Windows Management Instrumentation</em></span>, or WMI for short, Microsoft provides an interface that allows network-wide querying of system properties, assuming that the user doing the query has sufficient permissions. The WMI query is made from a central Windows system; NRPE is used for communication between the Nagios server and the WMI proxy (<a class="xref" href="../Text/ch20.html#using_the_wmi_interface_with_nagios" title="Figure 20-4. Using the WMI interface with Nagios">Figure 20-4</a>). Just a single Windows server is required, on which one NRPE service and all the desired plugins are installed in the form of WMI scripts—although to do this, you have to be familiar with the Microsoft WMI world.<a class="indexterm" id="IDX-CHP-20-1667"/><a class="indexterm" id="IDX-CHP-20-1668"/><a class="indexterm" id="IDX-CHP-20-1666"/></p>

      <div class="figure">
        <a id="using_the_wmi_interface_with_nagios"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e40238"/><img alt="Using the WMI interface with Nagios" src="../Images/tagoreillycom20081104nostarchimages223996.png.jpg"/></div>

        <p class="title">Figure 20-4. Using the WMI interface with Nagios</p>
      </div>

      <p>Extensive configuration examples can be found at the NagiosExchange<sup>[<a class="footnote" href="#ftn.CHP-20-FN-2" id="CHP-20-FN-2">229</a>]</sup> under <span class="strong"><strong>Categories | Check Plugins | Operating Systems | Windows | Windows NRPE</strong></span>, for instance, under the entry <span class="strong"><strong>wmi agentless plugins</strong></span>.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-3" id="CHP-20-FN-3">230</a>]</sup> We will not go into further details of the WMI interface here.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-1" id="ftn.CHP-20-FN-1">228</a>]</sup> <a class="ulink" href="http://www.cygwin.com/">http://www.cygwin.com/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-2" id="ftn.CHP-20-FN-2">229</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org">http://www.nagiosexchange.org</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-3" id="ftn.CHP-20-FN-3">230</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/66;235">http://www.nagiosexchange.org/66;235</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="20.2 Installing and Configuring the Additional Services">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="installing_and_configuring_the_additi"/>20.2 Installing and Configuring the Additional Services</h1>
    </div>

    <p>In contrast to the WMI approach, the additional services NSClient, NS-Client++, OpMon Agent, and NC_Net must be installed on every single Windows server.<a class="indexterm" id="IDX-CHP-20-1669"/><a class="indexterm" id="IDX-CHP-20-1670"/><a class="indexterm" id="IDX-CHP-20-1671"/><a class="indexterm" id="IDX-CHP-20-1672"/><a class="indexterm" id="IDX-CHP-20-1673"/></p>

    <div class="sect2" title="20.2.1 NSClient">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="nsclient"/>20.2.1 NSClient</h2>
      </div>

      <p>NSClient, as the oldest package, has been widely tested and is in widespread use, but it is no longer being actively developed. The last current version is from October 2003; the package can be downloaded from the Nagios Exchange.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-4" id="CHP-20-FN-4">231</a>]</sup>. It also runs in Windows NT, Windows 2000 and Windows XP.</p>

      <p>For Windows 2003, in particular Windows 2003 R2, the original package is no longer suitable, because numerous error messages in the form</p><a id="I_programlisting1_d1e40296"/>
      <pre class="programlisting">PDH.dll Collect CPU - ERROR:...</pre>

      <p>land in the event log, which lengthens the execution time considerably. At the NagiosExchange a recompiled version can be found in the package <strong class="userinput"><code>nsclient_-_no_pdh.zip</code></strong>,<sup>[<a class="footnote" href="#ftn.CHP-20-FN-5" id="CHP-20-FN-5">232</a>]</sup> which does not have this problem.</p>

      <p>For the NSClient installation, you unpack the archive <strong class="userinput"><code>nsclient_201.zip</code></strong> or <strong class="userinput"><code>nsclient_-_no_pdh.zip</code></strong>. This creates subdirectories named according to the architecture: <strong class="userinput"><code>Win_NT4_Bin</code></strong> for Windows NT and <strong class="userinput"><code>Win_2k_XP_Bin</code></strong> for Windows 2000 and higher. Copy the contents of the appropriate folder to the directory <strong class="userinput"><code>C:\Programs\NSClient</code></strong> and install NSClient from there as a service:<a class="indexterm" id="IDX-CHP-20-1674"/></p><a id="I_programlisting1_d1e40330"/>
      <pre class="programlisting">C:\Programs\NSClient&gt; <span class="strong"><strong>pNSClient.exe /install</strong></span>
C:\Programs\NSClient&gt; <span class="strong"><strong>net start nsclient</strong></span></pre>

      <p>Running <strong class="userinput"><code>pNSClient.exe /install</code></strong> installs the service, and the switch <strong class="userinput"><code>/uninstall</code></strong> removes the service again. You should make sure that the operating system starts automatically using the services management.<a class="indexterm" id="IDX-CHP-20-1675"/></p>

      <p>NSClient has two parameters: <strong class="userinput"><code>port</code></strong> and <strong class="userinput"><code>password</code></strong>, with the defaults <strong class="userinput"><code>1248</code></strong> (port) and <strong class="userinput"><code>none</code></strong> (password). The values can only be changed (with <strong class="userinput"><code>regedit</code></strong>) in the registry under <strong class="userinput"><code>HKEY_LOCAL_MACHINE\SOFTWARE\NSClient\Parms</code></strong>.</p>
    </div>

    <div class="sect2" title="20.2.2 NC_Net">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="nc_underscore_net"/>20.2.2 NC_Net</h2>
      </div>

      <p>NC_Net, by Tony Montibello, is one of the successors to NSClient, and its calls are also compatible with NSClient. Thus, NSClient can simply be replaced with NC_Net on the Windows server, without the need to change the Nagios configuration. Development on NC_Net is very active. The current version at the time this book went to press, version 4.x, is based on the <a class="ulink" href="http://dot.net">DOT.NET</a> framework, version 2.0. This is included by default only starting from Windows Server 2003 R2, but even there it is not installed automatically. For those who cannot or who don't want to install the new framework, the older NC_Net version 2.28 runs under <a class="ulink" href="http://DOT.NET">DOT.NET</a> 1.1 and is very stable and well established.<a class="indexterm" id="IDX-CHP-20-1678"/><a class="indexterm" id="IDX-CHP-20-1679"/><a class="indexterm" id="IDX-CHP-20-1680"/><a class="indexterm" id="IDX-CHP-20-1681"/><a class="indexterm" id="IDX-CHP-20-1676"/><a class="indexterm" id="IDX-CHP-20-1677"/></p>

      <p>NC_Net Version 2.28 is available on the NC_Net homepage,<sup>[<a class="footnote" href="#ftn.CHP-20-FN-6" id="CHP-20-FN-6">233</a>]</sup> and all newer versions can be found at SourceForge.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-7" id="CHP-20-FN-7">234</a>]</sup>. Make sure that any previous version installed is first uninstalled. Since NC_Net uses the Microsoft Installer, you do this through the software administration utility. Even an NSClient that might exist should be removed first.</p>

      <p>Double clicking on the file <strong class="userinput"><code>NC_Net_setup.msi</code></strong> installs the service, but you should check in the service management that it really is running, and whether or not <strong class="userinput"><code>automatic</code></strong> is entered as the starting type.</p>

      <p>NC_Net has the same parameters as NSClient, with <strong class="userinput"><code>password</code></strong> and <strong class="userinput"><code>port</code></strong>, but these can also be specified in the services management under <strong class="userinput"><code>properties</code></strong> in the <strong class="userinput"><code>Start parameters</code></strong> line:</p><a id="I_programlisting1_d1e40443"/>
      <pre class="programlisting">port 4711 password <span class="emphasis"><em>password</em></span></pre>
    </div>

    <div class="sect2" title="20.2.3 NSClient++">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="nsclient_plus_plus"/>20.2.3 NSClient++</h2>
      </div>

      <p>NSClient++ combines two query methods. On one hand, it is compatible with NSClient and can make queries as usual with <strong class="userinput"><code>check_nt</code></strong>. On the other hand, it contains a built-in NRPE service which can be configured and used like NRPE_NT (see <a class="xref" href="../Text/ch20s04.html#nrpe_underscore_nt_comma_the_classic" title="20.4.1 NRPE_NT, the classic tool">20.4.1 NRPE_NT, the classic tool</a> from page 488). NSClient++ provides all the NSClient functions via loadable modules, as well as other features such as event log querying or WMI queries via NRPE. In contrast to NRPE_NT, it is not essential to have external plugins for querying the CPU and hard disk load if you are using the modules.<a class="indexterm" id="IDX-CHP-20-1682"/></p>

      <p>NSClient++ is being actively developed; the homepage<sup>[<a class="footnote" href="#ftn.CHP-20-FN-8" id="CHP-20-FN-8">235</a>]</sup> provides not only a download area and documentation in the form of a Wiki, but also a bug-tracking system which allows you to report any errors and to make requests, including tracing open tickets.</p>

      <div class="sect3" title="Installation">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="installation-id9"/>Installation</h3>
        </div>

        <p>The current NSClient++ version can be downloaded as a zip file from the homepage<sup>[<a class="footnote" href="#ftn.CHP-20-FN-9" id="CHP-20-FN-9">236</a>]</sup> or from SourceForge.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-10" id="CHP-20-FN-10">237</a>]</sup> The contents of this file are unpacked, for instance in <strong class="userinput"><code>D:\Program Files\Nagios\nsclient++</code></strong>, and from there they are installed as a service, and the program is started:</p><a id="I_programlisting1_d1e40482"/>
        <pre class="programlisting">D:\Program Files\Nagios\nsclient++&gt; <span class="strong"><strong>NSClient++/install</strong></span>
D:\Program Files\Nagios\nsclient++&gt; <span class="strong"><strong>NSClient++/start</strong></span></pre>

        <p>If you want to use the classical <strong class="userinput"><code>net start</code></strong> command instead of the administrative tools to start and stop the service, you need to know that it is called <strong class="userinput"><code>nsclientpp</code></strong> (and not <strong class="userinput"><code>nsclient++</code></strong>):<a class="indexterm" id="IDX-CHP-20-1683"/></p><a id="I_programlisting1_d1e40503"/>
        <pre class="programlisting">D:\&gt; <span class="strong"><strong>net start nsclientpp</strong></span>
D:\&gt; <span class="strong"><strong>net stop nsclientpp</strong></span></pre>
      </div>

      <div class="sect3" title="Configuration">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="configuration-id4"/>Configuration</h3>
        </div>

        <p>NSClient++ requires a configuration file <strong class="userinput"><code>NSC.ini</code></strong> located in the same directory where the NSClient++-EXE file resides. The <strong class="userinput"><code>NSC.ini</code></strong> included in the distrubution needs to be edited in all cases.<a class="indexterm" id="IDX-CHP-20-1684"/><a class="indexterm" id="IDX-CHP-20-1685"/><a class="indexterm" id="IDX-CHP-20-1686"/><a class="indexterm" id="IDX-CHP-20-1687"/><a class="indexterm" id="IDX-CHP-20-1688"/><a class="indexterm" id="IDX-CHP-20-1689"/><a class="indexterm" id="IDX-CHP-20-1690"/><a class="indexterm" id="IDX-CHP-20-1691"/><a class="indexterm" id="IDX-CHP-20-1692"/><a class="indexterm" id="IDX-CHP-20-1693"/><a class="indexterm" id="IDX-CHP-20-1694"/><a class="indexterm" id="IDX-CHP-20-1695"/><a class="indexterm" id="IDX-CHP-20-1696"/><a class="indexterm" id="IDX-CHP-20-1697"/><a class="indexterm" id="IDX-CHP-20-1698"/><a class="indexterm" id="IDX-CHP-20-1699"/></p>

        <p>This file is divided into a number of sections:</p><a id="I_programlisting1_d1e40603"/>
        <pre class="programlisting">[modules]
; loadable modules
[Settings]
; general settings
[log]
; Logging and debugging
[NSClient]
; Parameters for NSClient-compatible queries
[Check System]
; Fine-tuning configuration for system checks (CPU, memory, ...)
[NRPE]
; Parameters for NRPE
[NRPE Handlers]
; NRPE commands</pre>

        <p>Each section begins with a keyword in square brackets, and comment lines start with a semicolon. The section <strong class="userinput"><code>[modules]</code></strong> loads the individual modules. The following modules are currently available:</p><a id="I_programlisting1_d1e40610"/>
        <pre class="programlisting">[modules]
FileLogger.dll
CheckDisk.dll
CheckSystem.dll
NSClientListener.dll
NRPEListener.dll
; SysTray.dll
; CheckHelpers.dll
; CheckWMI.dll</pre>

        <p>The internal module <strong class="userinput"><code>FileLogger.dll</code></strong> logs the work of NSClient++ to a file and does not provide any checks.<a class="indexterm" id="IDX-CHP-20-1707"/><a class="indexterm" id="IDX-CHP-20-1702"/><a class="indexterm" id="IDX-CHP-20-1704"/><a class="indexterm" id="IDX-CHP-20-1706"/><a class="indexterm" id="IDX-CHP-20-1701"/><a class="indexterm" id="IDX-CHP-20-1703"/><a class="indexterm" id="IDX-CHP-20-1705"/><a class="indexterm" id="IDX-CHP-20-1700"/></p>

        <p><strong class="userinput"><code>CheckDisk.dll</code></strong> checks the file size and hard disk usage, and <strong class="userinput"><code>CheckSystem.dll</code></strong> checks the CPU, the memory, counters, uptime, and service and process states.</p>

        <p><strong class="userinput"><code>NSClientListener.dll</code></strong> ensures compatibility with NSClient. If this module is not loaded, queries with <strong class="userinput"><code>check_nt</code></strong> will fail. The module <strong class="userinput"><code>NRPEListener.dll</code></strong> implements the NRPE service. This means you can choose whether you use NSClient++ as an NSClient or as an NRPE_NT replacement, or whether you use both functions at the same time.</p>

        <p><strong class="userinput"><code>SysTray.dll</code></strong> installs a systray icon on the server for access to NSClient++.</p>

        <p><strong class="userinput"><code>CheckHelpers.dll</code></strong> is a test module that always provides a specific return value (e.g., OK) and is not required for normal operation.</p>

        <p><strong class="userinput"><code>CheckWMI.dll</code></strong> provides queries for the WMI interface, but it is not yet completely finished.</p>

        <p>The global section <strong class="userinput"><code>[Settings]</code></strong> contains settings that apply across section boundaries, including the password parameters and <strong class="userinput"><code>allowed_hosts</code></strong>, which are inherited by the sections <strong class="userinput"><code>[NSClient]</code></strong> (<a class="xref" href="../Text/ch20s02.html#configuration-id4" title="Configuration">Configuration</a>) and <strong class="userinput"><code>[NRPE]</code></strong> (<a class="xref" href="../Text/ch20s04.html#perl_plugins_in_windows" title="Perl plugins in Windows">Perl plugins in Windows</a>), unless these options are set differently there:</p><a id="I_programlisting1_d1e40690"/>
        <pre class="programlisting">[Settings]
; obfuscated_password=Jw0KAUUdXlAAUwASDAAB
; password=secret-password
allowed_hosts=
use_file=1</pre>

        <p><strong class="userinput"><code>obfuscated_password</code></strong>, like <strong class="userinput"><code>password</code></strong>, is currently used only by the NS-Client-compatible part of NSClient++, and not for NRPE. Both parameters set the password for <strong class="userinput"><code>check_nt. obfuscated_password</code></strong> obscures this, so that it does not appear in plain text in the INI file. However, this is not real encryption. An <strong class="userinput"><code>obfuscated_password</code></strong> is generated by running <strong class="userinput"><code>nsclient++ /encrypt</code></strong>. This utility asks for a password, which it then displays in obscured form.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-11" id="CHP-20-FN-11">238</a>]</sup></p>

        <p>The parameter <strong class="userinput"><code>allowed_hosts</code></strong> controls which IP addresses may access NSClient++. If it is left empty, there are no access restrictions. You can specify several IP addresses by separating them with commas, but it is not possible to use host names here.</p>

        <p>Finally, <strong class="userinput"><code>use_file</code></strong> controls whether the configuration file is to be used at all (<strong class="userinput"><code>use_file=1</code></strong>). If the value <strong class="userinput"><code>0</code></strong> is entered here, NSClient++ searches in the registry for the settings. Configuration via the registry is currently still experimental, and it poses a security risk due to lack of sufficient protection, and so we will not look at it in more detail.</p>

        <p>The next section is devoted to logging:</p><a id="I_programlisting1_d1e40729"/>
        <pre class="programlisting">[log]
debug=0
; file=NSC.log
date_mask=%Y-%m-%d %H:%M:%S</pre>

        <p>With <strong class="userinput"><code>debug=1</code></strong>, debugging—which is disabled by default, using the value <strong class="userinput"><code>0</code></strong>—can be switched on. <strong class="userinput"><code>file</code></strong> specifies the log file. If you omit this parameter or (as shown here) comment it out, NSClient++ writes its error messages to <strong class="userinput"><code>nsclient.log</code></strong>, in the same directory in which the binary file lies. The software does this even if debugging is switched off. With <strong class="userinput"><code>date_mask</code></strong> you can specify the date format of the timestamp with which every log message begins. This format corresponds to what is described in <strong class="userinput"><code>man date</code></strong>.</p>

        <p>The <strong class="userinput"><code>[NSClient]</code></strong> section sets a number of options concerning compatibility with NSClient. Although nothing else can be configured here, NSClient functions (see <a class="xref" href="../Text/ch20s03.html" title="20.3 The check_nt Plugin">20.3 The check_nt Plugin</a> from page 472) are only available if the <strong class="userinput"><code>NS-ClientListener.dll</code></strong> module, <strong class="userinput"><code>CheckDisk.dll</code></strong>, and <strong class="userinput"><code>CheckSystem.dll</code></strong> (see <a class="xref" href="../Text/ch20s02.html#configuration-id4" title="Configuration">Configuration</a>) have been loaded.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-12" id="CHP-20-FN-12">239</a>]</sup></p>

        <p>The parameter <strong class="userinput"><code>allowed_hosts</code></strong> overrides the setting in the <strong class="userinput"><code>[Settings]</code></strong> section. In this way, NSClient++ can use a configuration for working with <strong class="userinput"><code>check_nt</code></strong> that is different from the one used for NRPE:</p><a id="I_programlisting1_d1e40794"/>
        <pre class="programlisting">[NSClient]
; allowed_hosts=
port=12489
; bind_to_address=</pre>

        <p>The <strong class="userinput"><code>port</code></strong> and <strong class="userinput"><code>bind_to_address</code></strong> parameters specify the socket on which NSClient++ accepts <strong class="userinput"><code>check_nt</code></strong> queries. The default for the port is 1248, which regularly leads to problems on some Windows servers (e.g., Exchange servers) (see also page 471). You should therefore change to a higher port number (e.g., 12489).</p>

        <p><strong class="userinput"><code>bind_to_address</code></strong> specifies the IP address of the intended host, on which the service will listen. This parameter is only needed if the computer has more than one network interface and a specific IP address is to be set.</p>

        <p>The <strong class="userinput"><code>[Check System]</code></strong> section allows system checks to be fine-tuned. Normally you won't need to configure anything here:</p><a id="I_programlisting1_d1e40816"/>
        <pre class="programlisting">[Check System]
; CPUBufferSize=1h
; CheckResolution=10</pre>

        <p><strong class="userinput"><code>CPUBufferSize</code></strong> determines how long NSClient++ stores information on the CPU load. The allowed value range starts at one second (<strong class="userinput"><code>1s</code></strong>), with a maximum often weeks (<strong class="userinput"><code>10w</code></strong>). To save data for a long period, however, you need a large amount of memory. The default value of one hour is enough for most purposes.</p>

        <p><strong class="userinput"><code>CheckResolution</code></strong> specifies the resolution of the stored measurement values in tenths of a second. The value <strong class="userinput"><code>10</code></strong> therefore means that a value is determined every second. <strong class="userinput"><code>CheckResolution</code></strong> currently influences only CPU measurement values.</p>

        <p>Other parameters for the <strong class="userinput"><code>[Check System]</code></strong> section are rarely required and are documented in the Wiki.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-13" id="CHP-20-FN-13">240</a>]</sup></p>

        <p>Configuration of the NRPE services in the two sections <strong class="userinput"><code>[NRPE Handlers]</code></strong> and <strong class="userinput"><code>[NRPE]</code></strong> is dealt with in <a class="xref" href="../Text/ch20s04.html#nrpe_with_nsclient_plus_plus" title="20.4.3 NRPE with NSClient++">20.4.3 NRPE with NSClient++</a> from page 493, and the internal functions of NSClient++ that can be called via NRPE are described in <a class="xref" href="../Text/ch20s04.html#internal_nsclient_plus_plus_functions" title="20.4.4 Internal NSClient++ functions">20.4.4 Internal NSClient++ functions</a> from page 495.</p>
      </div>
    </div>

    <div class="sect2" title="20.2.4 OpMon Agent">
      <div class="titlepage">
        <h2 class="title" id="heading_id_8"><a id="opmon_agent"/>20.2.4 OpMon Agent</h2>
      </div>

      <p>OpMon Agent is nothing more than a further development of the original NSClient code by the company OPServices.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-14" id="CHP-20-FN-14">241</a>]</sup>. It can therefore be considered to be a succcessor to the NSClient program. Like its predecessor, the software is published under the GNU Public License.<a class="indexterm" id="IDX-CHP-20-1709"/><a class="indexterm" id="IDX-CHP-20-1710"/><a class="indexterm" id="IDX-CHP-20-1711"/><a class="indexterm" id="IDX-CHP-20-1712"/><a class="indexterm" id="IDX-CHP-20-1708"/></p>

      <p>To install it, you unpack the current zip file from <a class="ulink" href="http://www.%20opservices.com.br/downloads/">http://www. opservices.com.br/downloads/</a> to <strong class="userinput"><code>C:\Program Files\Nagios\opmonagent</code></strong> and enter the following commands:</p><a id="I_programlisting1_d1e40897"/>
      <pre class="programlisting">C:\Program Files\Nagios\opmonagent&gt; <span class="strong"><strong>opmonagent/install</strong></span>
C:\Program Files\Nagios\opmonagent&gt; <span class="strong"><strong>net startopmonagent</strong></span></pre>

      <p>OpMon Agent also stores its configuration in an INI file. The original <strong class="userinput"><code>opmo-nagent.ini</code></strong> looks like this:</p><a id="I_programlisting1_d1e40909"/>
      <pre class="programlisting">[OPMONAGENT]
enable=1
password=None
port=5667
allow_from=127.0.0.1,192.168.10.2,192.168.2.1
autodetect_counters=1
use_counters=W2K
max_connections=300
debuglevel=0

[NRPE]
enable=1
port=5666
command_timeout=60
allow_from=127.0.0.1,192.168.10.1,192.168.2.1</pre>

      <p>The NSClient functionality is configured in the <strong class="userinput"><code>[OPMONAGENT]</code></strong> section. <strong class="userinput"><code>enable=1</code></strong> allows queries via <strong class="userinput"><code>check_nt</code></strong>, but if this parameter is set to <strong class="userinput"><code>0</code></strong>, OpMon Agent ignores this.</p>

      <p><strong class="userinput"><code>password</code></strong> sets a password, and the value <strong class="userinput"><code>None</code></strong> means that no password is required. Otherwise, the password is written in plain text after the equals sign.</p>

      <p>5667 is entered here as the standard port, but if you want to use the usual port 1248, you just change the entry and restart the service. <strong class="userinput"><code>allow_from</code></strong> restricts access to specific hosts.</p>

      <p><strong class="userinput"><code>autodetect_counters=1</code></strong> tries to automatically determine the exact name of the Windows performance counter, depending on the language setting of Windows and the exact Windows version. If you switch off this capability with the value <strong class="userinput"><code>0</code></strong>, you must specify the name explicitly in <strong class="userinput"><code>use_counters</code></strong>. Possible values for this parameter are listed in the file <strong class="userinput"><code>counters.def</code></strong>, which is located in the same directory as <strong class="userinput"><code>opmonagent.ini</code></strong>.<a class="indexterm" id="IDX-CHP-20-1713"/></p>

      <p><strong class="userinput"><code>max_connections</code></strong> restricts the number of possible simultaneous connections. A <strong class="userinput"><code>debuglevel</code></strong> value larger than <strong class="userinput"><code>0</code></strong> switches on debugging.</p>

      <p>In the future, it should be possible to configure the NRPE functions of OpMon Agent, which will be introduced in a later version, in the <strong class="userinput"><code>[NRPE]</code></strong> section. The current version of OpMon Agent at the time this book goes to press, version 2.4, does not yet provide official support for NRPE.</p>
    </div>

    <div class="sect2" title="20.2.5 Rectifying problems with port 1248">
      <div class="titlepage">
        <h2 class="title" id="heading_id_9"><a id="rectifying_problems_with_port"/>20.2.5 Rectifying problems with port 1248</h2>
      </div>

      <p>All NSClient-compatible services work by default on port 1248. This can sometimes turn out to be a problem, because Windows operating systems work intensively with RPCs (Remote Procedure Calls). Here ports are assigned dynamically, starting at port 1025. Thus, under certain circumstances—for servers with many services or many simultaneous connections, for example—port 1248 is often already occupied when NSClient is started as a service. For Exchange servers, this happens fairly often after a reboot. You should therefore change to a high, unproblematic port number, such as 12489.<a class="indexterm" id="IDX-CHP-20-1714"/><a class="indexterm" id="IDX-CHP-20-1715"/><a class="indexterm" id="IDX-CHP-20-1716"/></p>

      <p>If you are not installing Nagios for the first time but are working with an existing installation, you may not be able to easily change the port for all hosts to be monitored. For Nagios 2.x, there is no choice but to define a separate command for every port used. With Nagios 3.0, this can be done more elegantly. The solution is to use self-defined variables (see <a class="xref" href="../Text/aphs02.html" title="H.2 Variable and Macros">H.2 Variable and Macros</a> from page 685). In the host template (see <a class="xref" href="../Text/ch02s11.html" title="2.11 Templates">2.11 Templates</a>, page 75) the value is now globally specified as the standard port (in the example shown here, 1248):<a class="indexterm" id="IDX-CHP-20-1717"/><a class="indexterm" id="IDX-CHP-20-1718"/></p><a id="I_programlisting1_d1e41008"/>
      <pre class="programlisting">define host{
   name        host_t
   register    0
   ...
   _NSCLIENT_PORT 1248
   ...
}</pre>

      <p>For hosts that have already been converted to the new port, you overwrite the <strong class="userinput"><code>_NSCLIENT_PORT</code></strong> variable with the new port:</p><a id="I_programlisting1_d1e41015"/>
      <pre class="programlisting">define host{
   host_name      winsrv
   use            host_t
   ...
   _NSCLIENT_PORT 12489
}</pre>

      <p>For all other hosts, the value defined in the template applies. The definition of the command object takes into account the desired port by evaluating the variable, as shown here:</p><a id="I_programlisting1_d1e41019"/>
      <pre class="programlisting">define command{
    command_name check_nt
    command_line $USER1$/check_nt -H $HOSTADDRESS$ -p $_HOSTNSCLIENT_POR
T$ -v $ARG1$ $ARG2$
}</pre>

      <p>This means that for each newly converted host, only the variable needs to be set in this way, and all the service definitions remain unchanged.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-4" id="ftn.CHP-20-FN-4">231</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/49;65">http://www.nagiosexchange.org/49;65</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-5" id="ftn.CHP-20-FN-5">232</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/49;508">http://www.nagiosexchange.org/49;508</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-6" id="ftn.CHP-20-FN-6">233</a>]</sup> <a class="ulink" href="http://www.shatterit.com/NC_Net">http://www.shatterit.com/NC_Net</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-7" id="ftn.CHP-20-FN-7">234</a>]</sup> <a class="ulink" href="http://sourceforge.net/projects/nc-net">http://sourceforge.net/projects/nc-net</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-8" id="ftn.CHP-20-FN-8">235</a>]</sup> <a class="ulink" href="http://trac.nakednuns.org/nscp/">http://trac.nakednuns.org/nscp/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-9" id="ftn.CHP-20-FN-9">236</a>]</sup> <a class="ulink" href="http://trac.nakednuns.org/nscp/downloads">http://trac.nakednuns.org/nscp/downloads</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-10" id="ftn.CHP-20-FN-10">237</a>]</sup> <a class="ulink" href="http://sourceforge.net/projects/nscplus/">http://sourceforge.net/projects/nscplus/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-11" id="ftn.CHP-20-FN-11">238</a>]</sup> The algorithm used is not documented, hence the utility should be treated with mistrust.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-12" id="ftn.CHP-20-FN-12">239</a>]</sup> The <strong class="userinput"><code>MEMUSE</code></strong> command (see <a class="xref" href="../Text/ch20s03.html#main_memory_usage" title="Main memory usage">Main memory usage</a>) thus requires the module <strong class="userinput"><code>CheckSystem.dll</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-13" id="ftn.CHP-20-FN-13">240</a>]</sup> <a class="ulink" href="http://trac.nakednuns.org/nscp/wiki/Documentation">http://trac.nakednuns.org/nscp/wiki/Documentation</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-14" id="ftn.CHP-20-FN-14">241</a>]</sup> <a class="ulink" href="http://www.opservices.com.br/">http://www.opservices.com.br/</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="20.3 The check_nt Plugin">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_check_underscore_nt_plugin"/>20.3 The <strong class="userinput"><code>check_nt</code></strong> Plugin</h1>
    </div>

    <p>When installing the standard Nagios plugins, the <strong class="userinput"><code>check_nt</code></strong> plugin is automatically loaded to the hard drive. The checks that can be queried here correspond to the function range of NSClient provided in NSClient, NS-Client++, OpMon Agent, and NC_Net. To make use of the extensions of NC_Net, you must download the extended sourcecode (the file <strong class="userinput"><code>check_nt.c</code></strong>) from <a class="ulink" href="http://www.shatterit.com/NC_Net">http://www.shatterit.com/NC_Net</a> and compile it yourself.<a class="indexterm" id="IDX-CHP-20-1719"/><a class="indexterm" id="IDX-CHP-20-1720"/><a class="indexterm" id="IDX-CHP-20-1721"/><a class="indexterm" id="IDX-CHP-20-1722"/><a class="indexterm" id="IDX-CHP-20-1723"/></p>

    <p>The actual effect that the <strong class="userinput"><code>check_nt</code></strong> parameters have, described below, depends on the command that is specified with the <strong class="userinput"><code>-v</code></strong> option:<sup>[<a class="footnote" href="#ftn.CHP-20-FN-15" id="CHP-20-FN-15">242</a>]</sup>:</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> / <strong class="userinput"><code>--host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

        <dd>
          <p>IP address or host name of the host on which the NSClient/NC_Net is installed.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-v</code></strong> <strong class="userinput"><code><em class="replaceable"><code>command</code></em></code></strong> / <strong class="userinput"><code>--variable=</code></strong><strong class="userinput"><code><em class="replaceable"><code>command</code></em></code></strong></span></dt>

        <dd>
          <p>The command to be executed.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> / <strong class="userinput"><code>--port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

        <dd>
          <p>This defines an alternative port for NSClient/NC_Net (see <a class="xref" href="../Text/ch20s02.html#rectifying_problems_with_port" title="20.2.5 Rectifying problems with port 1248">20.2.5 Rectifying problems with port 1248</a> in page 471). The default is TCP port 1248.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> / <strong class="userinput"><code>--warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

        <dd>
          <p>This defines a warning limit. This option is not available for all commands.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> / <strong class="userinput"><code>--critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

        <dd>
          <p>The critical limit option is also not available for all commands.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-l</code></strong> <strong class="userinput"><code><em class="replaceable"><code>parameter</code></em></code></strong></span></dt>

        <dd>
          <p>This is used for passing parameters along, such as the drive for the hard drive check or the process name when checking processes.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-d</code></strong> <strong class="userinput"><code><em class="replaceable"><code>option</code></em></code></strong></span></dt>

        <dd>
          <p>When checking services or processes, you can specify several services or processes simultaneously. Normally <strong class="userinput"><code>check_nt</code></strong> then only shows the defective ones (<strong class="userinput"><code>-d SHOWFAIL</code></strong>). To have all of them displayed you must specify <strong class="userinput"><code>SHOWALL</code></strong> as the <strong class="userinput"><code><em class="replaceable"><code>option</code></em></code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong></span></dt>

        <dd>
          <p>A password for authentication is only required if NC_Net or NSClient starts the corresponding service with the password parameter.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> / <strong class="userinput"><code>--timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

        <dd>
          <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds have elapsed, the plugin aborts the test and returns the CRITICAL state. The default is <strong class="userinput"><code>10</code></strong> seconds.</p>
        </dd>
      </dl>
    </div>

    <div class="sect2" title="20.3.1 Generally supported commands">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="generally_supported_commands"/>20.3.1 Generally supported commands</h2>
      </div>

      <p>For the commands introduced here, it makes no difference whether you use NSClient, NSClient++, NC_Net or OpMon; they can be run with the unpatched <strong class="userinput"><code>check_nt</code></strong>.<a class="indexterm" id="IDX-CHP-20-1724"/><a class="indexterm" id="IDX-CHP-20-1725"/><a class="indexterm" id="IDX-CHP-20-1726"/></p>

      <div class="sect3" title="Querying the client version">
        <div class="titlepage">
          <h3 class="title" id="heading_id_4"><a id="querying_the_client_version"/>Querying the client version</h3>
        </div>

        <p>The version of the installed NSClient or NC_Net service is returned by running the command<a class="indexterm" id="IDX-CHP-20-1727"/><a class="indexterm" id="IDX-CHP-20-1728"/></p><a id="I_programlisting1_d1e41272"/>
        <pre class="programlisting">check_nt -H <span class="emphasis"><em>address</em></span> -v CLIENTVERSION</pre>

        <p>All other arguments are ignored:</p><a id="I_programlisting1_d1e41279"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ ./<span class="strong"><strong>check_nt -H winsrv -v CLIENTVERSION</strong></span>
NC_Net 2.21 03/13/05</pre>

        <p>The first edition of this book defined a separate command for each <strong class="userinput"><code>check_nt</code></strong> function. But this is not necessary at all, as Ethan Galstad has shown in the online documentation for Nagios:<sup>[<a class="footnote" href="#ftn.CHP-20-FN-16" id="CHP-20-FN-16">243</a>]</sup></p><a id="I_programlisting1_d1e41292"/>
        <pre class="programlisting">define command{
   command_name check_nt_nsclient
   command_line $USER1$/check_nt -H $HOSTADDRESS$ -v $ARG1$ $ARG2$
}</pre>

        <p>For Nagios 3.0 with NSClient ports defined in a host-dependent fashion (see <a class="xref" href="../Text/ch20s02.html#rectifying_problems_with_port" title="20.2.5 Rectifying problems with port 1248">20.2.5 Rectifying problems with port 1248</a>, page 471), the command object <strong class="userinput"><code>check_nt</code></strong> would look like this:</p><a id="I_programlisting1_d1e41301"/>
        <pre class="programlisting">define command{
   command_name check_nt
   command_line $USER1$/check_nt -H $HOSTADDRESS$ <span class="strong"><strong>-p$_HOSTNSCLIENT_POR</strong></span>
<span class="strong"><strong>T$</strong></span> -v $ARG1$ $ARG2$
}</pre>

        <p>The command line to be executed expects two arguments: The macro <strong class="userinput"><code>$ARG1$</code></strong> expands in each case into the command to be called, and the contents of <strong class="userinput"><code>$ARG2$</code></strong> are dependent on the respective command and may be empty in certain circumstances:</p><a id="I_programlisting1_d1e41317"/>
        <pre class="programlisting">define service{
   host_name           winsrv
   service_description NSClient
   check_command       check_nt!<span class="strong"><strong>CLIENTVERSION</strong></span>
   ...
}</pre>

        <p>The command <strong class="userinput"><code>CLIENTVERSION</code></strong> does not have any other arguments, so the second argument is simply left out.</p>

        <p>This unassuming service is extremely useful in describing dependencies. If NSClient/NC_Net fails on the Windows server, Nagios normally informs the administrator of all services that may have failed. By querying <strong class="userinput"><code>CLIENT-VERSION</code></strong>, it becomes clear that the problem lies in the unavailability of NSClient. If you define appropriate dependencies, Nagios can provide more precise information.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-17" id="CHP-20-FN-17">244</a>]</sup> Here is an example for the NSClient application:</p><a id="I_programlisting1_d1e41339"/>
        <pre class="programlisting">define servicedependency{
    host_name                     winsrv
    service_description           NSClient
    dependent_host_name           winsrv
    dependent_service_description Disks,Load,Memory
    notification_failure_criteria c,u
    execution_failure_criteria    n
}</pre>

        <p>With <strong class="userinput"><code>NSClient</code></strong> as a master service on which the other services are dependent, Nagios does not trouble the admins with messages from these other services, as long as <strong class="userinput"><code>NSClient</code></strong> is in a CRITICAL or UNKNOWN state.</p>

        <p>In Nagios 2.x you must set dependency objects for each host individually. In Nagios 3.0 there are the <span class="emphasis"><em>same host dependencies</em></span>: If you omit the entry <strong class="userinput"><code>dependent_host_name</code></strong>, the dependency defined here applies to the same host. This allows host groups to be used in a sensible manner:</p><a id="I_programlisting1_d1e41357"/>
        <pre class="programlisting"># Nagios 3.0
define servicedependency{
    hostgroup_name                  WINDOWS_SERVER
    service_description             NSClient
    dependent_service_description   Disks,Load,Memory
    notification_failure_criteria   c,u
    execution_failure_criteria      n
}</pre>

        <p>Here the <strong class="userinput"><code>Disks</code></strong> service in each case only depends on the <strong class="userinput"><code>NSClient</code></strong> service of the same host. When using host groups in Nagios 2.x, <strong class="userinput"><code>Disks</code></strong> would be dependent on all <strong class="userinput"><code>NSClient</code></strong> services on all hosts of the host group <strong class="userinput"><code>WINDOWS.SERVER</code></strong>—and this is normally not what is wanted.</p>
      </div>

      <div class="sect3" title="CPU load">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="cpu_load"/>CPU load</h3>
        </div>

        <p>How heavy the load is on the processor is revealed by the command <strong class="userinput"><code>CPU-LOAD</code></strong>:<a class="indexterm" id="IDX-CHP-20-1729"/><a class="indexterm" id="IDX-CHP-20-1730"/><a class="indexterm" id="IDX-CHP-20-1731"/><a class="indexterm" id="IDX-CHP-20-1732"/></p><a id="I_programlisting1_d1e41402"/>
        <pre class="programlisting">check_nt -H <span class="emphasis"><em>address</em></span> -v CPULOAD -l <span class="emphasis"><em>interval, warning limit, critical_limit</em></span></pre>

        <p>It expects a triplet of parameters, separated by commas, consisting of the length of the time interval that is to be averaged, in minutes, and the two thresholds for the warning and critical limits in percent:<a class="indexterm" id="IDX-CHP-20-1733"/><a class="indexterm" id="IDX-CHP-20-1734"/><a class="indexterm" id="IDX-CHP-20-1735"/></p><a id="I_programlisting1_d1e41429"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_nt -H winsrv -v CPULOAD -l 5,80,90</strong></span>
CPU Load 10% (5 min average) |   '5 min avg Load'=10%;80;90;0;100</pre>

        <p>So <strong class="userinput"><code>CPULOAD</code></strong>, with <strong class="userinput"><code>5,80,90</code></strong>, forms the average over five minutes and issues a warning if the value determined exceeds <strong class="userinput"><code>80</code></strong> percent. If there is over 90% CPU load, the command returns CRITICAL.</p>

        <p>The output here also contains additional performance data after the <strong class="userinput"><code>|</code></strong> sign, which Nagios ignores in the Web interface. If you are interested in average values over several intervals, you just add further triplet values following to the first one:</p><a id="I_programlisting1_d1e41450"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_nt -H winsrv -v CPULOAD \</strong></span>
 <span class="strong"><strong>   -l 5,80,90,15,70,80</strong></span>
CPU Load 10% (5 min average) 10% (15 min average) |   '5 min avg Load'=10
%;80;90;0;100 '15 min avg Load'=10%;70;80;0;100</pre>

        <p>In this example <strong class="userinput"><code>CPULOAD</code></strong> checks two intervals: the past five minutes and the past 15 minutes. In the second case there are deviating limit values. The plugin always returns the more critical value; for example, it returns CRITICAL if one interval issues CRITICAL and the other just a WARNING.</p>

        <p>The service definition therefore looks like this:</p><a id="I_programlisting1_d1e41465"/>
        <pre class="programlisting">define service{
   host_name             winsrv
   service_description   CPU Load
   check_command         check_nt!<span class="strong"><strong>CPULOAD</strong></span>!-l 5,80,90,15,70,80
   ...
}</pre>
      </div>

      <div class="sect3" title="Main memory usage">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="main_memory_usage"/>Main memory usage</h3>
        </div>

        <p>When specifying the limit values, the command for monitoring the amount of main memory used—in contrast to <strong class="userinput"><code>CPULOAD</code></strong>—is based on the syntax of "normal" Nagios plugins:<a class="indexterm" id="IDX-CHP-20-1736"/><a class="indexterm" id="IDX-CHP-20-1737"/><a class="indexterm" id="IDX-CHP-20-1738"/><a class="indexterm" id="IDX-CHP-20-1739"/><a class="indexterm" id="IDX-CHP-20-1740"/><a class="indexterm" id="IDX-CHP-20-1741"/><a class="indexterm" id="IDX-CHP-20-1742"/><a class="indexterm" id="IDX-CHP-20-1743"/><a class="indexterm" id="IDX-CHP-20-1744"/></p><a id="I_programlisting1_d1e41520"/>
        <pre class="programlisting">check_nt -H <span class="emphasis"><em>address</em></span> -v MEMUSE -w <span class="emphasis"><em>integer</em></span> -c <span class="emphasis"><em>integer</em></span></pre>

        <p><strong class="userinput"><code>MEMUSE</code></strong> returns the memory usage in percent. It should be remembered that Windows refers here to the sum of memory and swap files, that is, the entire available virtual memory. The command expects the warning and critical limits as percentages, given without a percent sign:</p><a id="I_programlisting1_d1e41534"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_nt -H winsrv -v MEMUSE \</strong></span>
<span class="strong"><strong>     -w 70 -c 90</strong></span>
Memory usage: total:4331.31Mb - used: 257.04Mb (6%) - free: 4074.27Mb (9
4%) |   'Memory usage'=257.04Mb;3031.91;3898.18;0.00;4331.31</pre>

        <p>On the example host, <strong class="userinput"><code>winsrv</code></strong>, only six percent of the virtual memory is used. The fact that the physical size of the main memory itself (here: 256 MB) is already exceeded is not shown in the output.</p>

        <p>It does not necessarily make sense, however, to request the memory usage as in Unix: Windows regularly swaps program and data code from the main memory, even when it still has spare reserves. In Unix, programs and data land in the swap partition only if more space is required than is currently free. In this respect the load of the entire virtual memory in Windows is the more important parameter.</p>

        <p>The command mentioned above is again packed into a service object:</p><a id="I_programlisting1_d1e41551"/>
        <pre class="programlisting">define service{
   host_name           winsrv
   service_description MEM Usage
   check_command       check_nt!<span class="strong"><strong>MEMUSE</strong></span>!-w 70 -c 90
   ...
}</pre>
      </div>

      <div class="sect3" title="Hard drive capacity">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="hard_drive_capacity"/>Hard drive capacity</h3>
        </div>

        <p>The load on a file system is tested by <strong class="userinput"><code>USEDDISKSPACE:</code></strong></p><a id="I_programlisting1_d1e41563"/>
        <pre class="programlisting">check_nt -H <span class="emphasis"><em>address</em></span> -v USEDDISKSPACE -l <span class="emphasis"><em>drive letter</em></span> -w <span class="emphasis"><em>integer</em></span> -c <span class="emphasis"><em>integer</em></span></pre>

        <p>in Windows fashion, the file system is specified as drive letters, the limit values in percent:</p><a id="I_programlisting1_d1e41578"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_nt -H winsrv -v USEDDISKSPACE\</strong></span>
 <span class="strong"><strong>   -l C -w 70 -c 80</strong></span>
C: - total: 4.00 Gb - used: 2.06 Gb (52%) - free 1.94 Gb (48%)  |  'C: Use
d Space'=2.06Gb;2.80;3.20;0.00;4.00
nagios@linux:nagios/libexec$ <span class="strong"><strong>echo $?</strong></span>
0</pre>

        <p>In the example, <strong class="userinput"><code>check_nt</code></strong> should issue a Warning if drive <strong class="userinput"><code>C</code></strong> is more than 70 percent full, and a CRITICAL if the load exceeds 80%. The current value lies at 52 percent, so <strong class="userinput"><code>check_nt</code></strong> therefore returns an OK, which you can check with <strong class="userinput"><code>echo $?</code></strong>.</p>

        <p>The corresponding service object would look something like this:</p><a id="I_programlisting1_d1e41605"/>
        <pre class="programlisting">define service{
   host_name           winsrv
   service_description Disk_C
   check_command       check_nt!<span class="strong"><strong>USEDDISKSPACE</strong></span>!-l C -w 70 -c 80
   ...
}</pre>
      </div>

      <div class="sect3" title="Uptime">
        <div class="titlepage">
          <h3 class="title" id="heading_id_8"><a id="uptime"/>Uptime</h3>
        </div>

        <p>How long ago the last reboot was performed is revealed by the command <strong class="userinput"><code>UPTIME:</code></strong><a class="indexterm" id="IDX-CHP-20-1745"/><a class="indexterm" id="IDX-CHP-20-1746"/><a class="indexterm" id="IDX-CHP-20-1747"/><a class="indexterm" id="IDX-CHP-20-1748"/><a class="indexterm" id="IDX-CHP-20-1749"/><a class="indexterm" id="IDX-CHP-20-1750"/></p><a id="I_programlisting1_d1e41645"/>
        <pre class="programlisting">check_nt -H <span class="emphasis"><em>address</em></span> -v UPTIME</pre>

        <p>Defining a warning or critical limit is not possible, which is why such a query is only for information purposes (the plugin returns either OK, or UNKNOWN if it is used wrongly):</p><a id="I_programlisting1_d1e41652"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_nt -H winsrv -v UPTIME</strong></span>
System Uptime - 17 day(s) 9 hour(s) 54 minute(s)</pre>

        <p>so the host <strong class="userinput"><code>winsrv</code></strong> has already been running for 17 days. A suitable definition of the corresponding service object looks like this:</p><a id="I_programlisting1_d1e41662"/>
        <pre class="programlisting">define service{
   host_name           winsrv
   service_description UPTIME
   check_command       check_nt!<span class="strong"><strong>UPTIME</strong></span>
   ...
}</pre>
      </div>

      <div class="sect3" title="Status of services">
        <div class="titlepage">
          <h3 class="title" id="heading_id_9"><a id="status_of_services"/>Status of services</h3>
        </div>

        <p>The current status of Windows services can be checked with <strong class="userinput"><code>SERVICESTATE</code></strong>:<a class="indexterm" id="IDX-CHP-20-1751"/><a class="indexterm" id="IDX-CHP-20-1752"/><a class="indexterm" id="IDX-CHP-20-1753"/><a class="indexterm" id="IDX-CHP-20-1754"/></p><a id="I_programlisting1_d1e41693"/>
        <pre class="programlisting">check_nt -H <span class="emphasis"><em>address</em></span> -v SERVICESTATE -d SHOWALL -l <span class="emphasis"><em>service1, service2</em></span>,...</pre>

        <p>The optional <strong class="userinput"><code>-d SHOWALL</code></strong> ensures that the output text lists all services. If you leave this option out, the plugin provides information only on those services that are <span class="emphasis"><em>not</em></span> running.</p>

        <p>To find the name of the service description to be specified for NSClient after the <strong class="userinput"><code>-l</code></strong> option is quite a challenge. It is not the <span class="emphasis"><em>display name</em></span> which is displayed by the services management (e.g., <strong class="userinput"><code>Routing and RAS</code></strong>), that is being sought, but the registry entry that corresponds to this. Accordingly you search with the Registry editor <strong class="userinput"><code>regedit</code></strong> in the partial tree <strong class="userinput"><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services</code></strong> for the node with the corresponding display name. It contains the service description being sought, which in the case of <strong class="userinput"><code>Routing and RAS</code></strong> is something like <strong class="userinput"><code>Remote-Access</code></strong>.</p>

        <p>If you use NC_Net, you have an easier task: the software accepts both the service description and the display name, in which no distinction is made between upper and lower case. The following two examples use the display name:</p><a id="I_programlisting1_d1e41735"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_nt -H winsrv1 -v SERVICESTATE \</strong></span>
 <span class="strong"><strong>   -l "RemoteAccess"</strong></span>
RemoteAccess: Stopped
nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_nt -H winsrv2 -v SERVICESTATE \</strong></span>
 <span class="strong"><strong>   -l "Routing and RAS"</strong></span>
All services are running</pre>

        <p>In the first case the service name was used; in the second case, the display name was used. The service first queried is not running, as the output <strong class="userinput"><code>Stopped</code></strong> shows, and <strong class="userinput"><code>check_nt</code></strong> returns <strong class="userinput"><code>2</code></strong> (CRITICAL) as the return value. The service addressed with the second command is working, which is why the plugin does not display it if the <strong class="userinput"><code>-d SHOWALL</code></strong> option is not given. The return value here is <strong class="userinput"><code>0</code></strong> (OK). Several services (separated by commas) can also be queried in a single query. The worst-case result here dictates the return value. A matching service object looks something like this:</p><a id="I_programlisting1_d1e41766"/>
        <pre class="programlisting">define service{
   host_name           winsrv
   service_description Routing and RAS
   check_command       check_nt!<span class="strong"><strong>SERVICESTATE</strong></span>!-l RemoteAccess
   ...
}</pre>
      </div>

      <div class="sect3" title="Status of processes">
        <div class="titlepage">
          <h3 class="title" id="heading_id_10"><a id="status_of_processes"/>Status of processes</h3>
        </div>

        <p>As with the services, <strong class="userinput"><code>PROCSTATE</code></strong> monitors running processes:<a class="indexterm" id="IDX-CHP-20-1755"/><a class="indexterm" id="IDX-CHP-20-1756"/><a class="indexterm" id="IDX-CHP-20-1757"/><a class="indexterm" id="IDX-CHP-20-1758"/><a class="indexterm" id="IDX-CHP-20-1759"/><a class="indexterm" id="IDX-CHP-20-1760"/><a class="indexterm" id="IDX-CHP-20-1761"/><a class="indexterm" id="IDX-CHP-20-1762"/></p><a id="I_programlisting1_d1e41820"/>
        <pre class="programlisting">check_nt -H <span class="emphasis"><em>address</em></span> -v PROCSTATE -d SHOWALL -l <span class="emphasis"><em>process1, process2</em></span>,...</pre>

        <p>The process name, which almost always ends in <strong class="userinput"><code>.exe</code></strong>, is best determined in the process list of the task manager; upper and lower case are also ignored here:</p><a id="I_programlisting1_d1e41833"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_nt -H winsrv -v PROCSTATE</strong></span> \
<span class="strong"><strong>WinVNC.exe,winlogon.exe,notexist.exe</strong></span>
  notexist.exe: not running</pre>

        <p>As with the services, you can also specify a list of several processes, separated by commas. Without <strong class="userinput"><code>-d SHOWALL, PROCSTATE</code></strong> shows only those processes that are <span class="emphasis"><em>not</em></span> running, in this example, <strong class="userinput"><code>notexist.exe</code></strong>. A corresponding service definition might look like this:</p><a id="I_programlisting1_d1e41852"/>
        <pre class="programlisting">define service{
   host_name           winsrv
   service_description WinVNC
   check_command       check_nt!<span class="strong"><strong>PROCSTATE</strong></span>!-l winvnc.exe
   ...
}</pre>
      </div>

      <div class="sect3" title="Age of files">
        <div class="titlepage">
          <h3 class="title" id="heading_id_11"><a id="age_of_files"/>Age of files</h3>
        </div>

        <p>It is worth monitoring the time since the last modification of critical files with <strong class="userinput"><code>FILEAGE</code></strong>, particularly for log files and other files that change regularly:</p><a id="I_programlisting1_d1e41865"/>
        <pre class="programlisting">check_nt -H <span class="emphasis"><em>address</em></span> -v FILEAGE -l <span class="emphasis"><em>path</em></span> -w <span class="emphasis"><em>integer</em></span> -c <span class="emphasis"><em>integer</em></span></pre>

        <p><strong class="userinput"><code>FILEAGE</code></strong> can be used to check the age of a file, for instance a log file to which data should be written regularly. The file name is specified with the full path, and backslashes must be written twice: <strong class="userinput"><code>C:\\xyz.log</code></strong>. If the thresholds, specified in minutes, are exceeded, the plugin issues a WARNING or a CRITICAL. However, it gives the age of the file, by default, in epoch seconds:<sup>[<a class="footnote" href="#ftn.CHP-20-FN-18" id="CHP-20-FN-18">245</a>]</sup><a class="indexterm" id="IDX-CHP-20-1763"/></p><a id="I_programlisting1_d1e41891"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_nt -H winsrv -v FILEAGE \</strong></span>
 <span class="strong"><strong>   -l "C:\\test.log" -w 1 -c 20</strong></span>
1113158517
nagios@linux:nagios/libexec$ <span class="strong"><strong>echo $?</strong></span>
1</pre>

        <p>The status can again be checked with <strong class="userinput"><code>echo $?</code></strong>. Here as well, the service definition does not hold any secrets:</p><a id="I_programlisting1_d1e41907"/>
        <pre class="programlisting">define service{
   host_name           winsrv
   service_description Log file
   check_command       check_nt_fileage!C:       xyz.log!60!1440
   ...
}</pre>
      </div>

      <div class="sect3" title="Querying Windows counters and instances">
        <div class="titlepage">
          <h3 class="title" id="heading_id_12"><a id="querying_windows_counters_and_instances"/>Querying Windows counters and instances</h3>
        </div>

        <p>The duo of NSClient and <strong class="userinput"><code>check_nt</code></strong> provides two other functions: querying Windows counters with <strong class="userinput"><code>COUNTER</code></strong> and querying Windows performance counter objects with <strong class="userinput"><code>INSTANCES</code></strong>. Querying performance counters varies in small details from service to service, however (such as using a double backslash rather than a single backslash in the counter name). For this reason, we shall describe both in the discussion of the extended functions of NC_Net from page 481. If you want to use counters with OpMon Agent, NSClient, or NSClient++, we recommend that you take a look at the original documentation of each service.<a class="indexterm" id="IDX-CHP-20-1764"/><a class="indexterm" id="IDX-CHP-20-1765"/><a class="indexterm" id="IDX-CHP-20-1766"/><a class="indexterm" id="IDX-CHP-20-1767"/></p>

        <p>When using NSClient++, it is recommended that you use the internal function <strong class="userinput"><code>CheckCounter</code></strong>, which is described in <a class="xref" href="../Text/ch20s04.html#checking_memory_load_with_checkmem" title="Checking memory load with CheckMem">Checking memory load with CheckMem</a>.</p>
      </div>
    </div>

    <div class="sect2" title="20.3.2 Advanced functions of NC_Net">
      <div class="titlepage">
        <h2 class="title" id="heading_id_13"><a id="advanced_functions_of_nc_underscore_net"/>20.3.2 Advanced functions of NC_Net</h2>
      </div>

      <p>NC_Net's range of functions is expanding constantly; this chapter describes the possibilities that go beyond NSClient for version 2.28. These can only be used with the modified <strong class="userinput"><code>check_nt</code></strong> plugin. The extended version is based on the original <strong class="userinput"><code>check_nt</code></strong> version 1.4.1. But it is possible that both plugins will continue to be developed in different ways, and thus diverge.</p>

      <p>We will therefore rename the NC_Net version to <strong class="userinput"><code>check_ncnet</code></strong>, so that we can keep the two separate and run them at the same time. Thus, <strong class="userinput"><code>check_nt</code></strong> examples in this book demonstrate functions that are available for all NSClient-compatible services; if <strong class="userinput"><code>check_ncnet</code></strong> is used, the NC_Net functionality in combination with the extended plugin is available.<a class="indexterm" id="IDX-CHP-20-1768"/></p>
    </div>

    <div class="sect2" title="20.3.3 Installing the check_ncnet plugin">
      <div class="titlepage">
        <h2 class="title" id="heading_id_14"><a id="installing_the_check_underscore_nc"/>20.3.3 Installing the <strong class="userinput"><code>check_ncnet</code></strong> plugin</h2>
      </div>

      <p><strong class="userinput"><code>check_ncnet</code></strong> exists only in the source code; it consists of a single file that unfortunately has the same name as the original plugin <strong class="userinput"><code>check_nt.c</code></strong>. The file ends up on the hard drive during the installation of NC_Net, but it can also be downloaded separately from <a class="ulink" href="http://www.shatterit.com/nc_net">http://www.shatterit.com/nc_net</a>.<a class="indexterm" id="IDX-CHP-20-1769"/></p>

      <p>The source can currently be compiled without problems only in combination with the entire Nagios plugin package (see <a class="xref" href="../Text/ch01s04.html" title="1.4 Installing and Testing Plugins">1.4 Installing and Testing Plugins</a>, page 43). To do this, you overwrite the existing file <strong class="userinput"><code>check_nt.c</code></strong> in the subdirectory <strong class="userinput"><code>plugins</code></strong> with the extended version. To be on the safe side, the old <strong class="userinput"><code>check_nt</code></strong> binary should be renamed; then you run <strong class="userinput"><code>make check_nt</code></strong> to recompile the source file. Afterward, you copy the binary under the name <strong class="userinput"><code>check_ncnet</code></strong> to the <strong class="userinput"><code>libexec</code></strong> directory of Nagios, along with the other plugins:</p><a id="I_programlisting1_d1e42020"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cp check_nt.c /usr/local/src/nagios-plugins-1.4/plugins</strong></span>
linux:~ # <span class="strong"><strong>cd /usr/local/src/nagios-plugins-1.4/plugins</strong></span>
linux:nagios-plugins-1.4/plugins # <span class="strong"><strong>mv check_nt check_nt_orig</strong></span>
linux:nagios-plugins-1.4/plugins # <span class="strong"><strong>make check_nt</strong></span>
...
linux:nagios-plugins-1.4/plugins # <span class="strong"><strong>mv check_nt check_ncnet</strong></span>
linux:nagios-plugins-1.4/plugins # <span class="strong"><strong>cp check_ncnet</strong></span> \
 <span class="strong"><strong>   /usr/local/nagios/libexec/</strong></span>.</pre>

      <div class="sect3" title="Windows Performance Counter">
        <div class="titlepage">
          <h3 class="title" id="heading_id_15"><a id="windows_performance_counter"/>Windows Performance Counter</h3>
        </div>

        <p>Through so-called Performance Counters, Windows provides values for everything in the system that can be expressed in numbers: hard drive usage, CPU usage, number of logins, number of terminal server sessions, the load on the network interface, and many more things. <strong class="userinput"><code>check_ncnet</code></strong> queries these with the command <strong class="userinput"><code>ENUMCOUNTER</code></strong>:<a class="indexterm" id="IDX-CHP-20-1771"/><a class="indexterm" id="IDX-CHP-20-1772"/><a class="indexterm" id="IDX-CHP-20-1773"/><a class="indexterm" id="IDX-CHP-20-1774"/><a class="indexterm" id="IDX-CHP-20-1775"/><a class="indexterm" id="IDX-CHP-20-1776"/><a class="indexterm" id="IDX-CHP-20-1777"/><a class="indexterm" id="IDX-CHP-20-1778"/><a class="indexterm" id="IDX-CHP-20-1779"/><a class="indexterm" id="IDX-CHP-20-1780"/><a class="indexterm" id="IDX-CHP-20-1781"/><a class="indexterm" id="IDX-CHP-20-1770"/></p><a id="I_programlisting1_d1e42104"/>
        <pre class="programlisting">check_ncnet -H <span class="emphasis"><em>address</em></span> -v ENUMCOUNTER -l <span class="emphasis"><em>category1, category2</em></span></pre>

        <p>If you omit the <strong class="userinput"><code>-l</code></strong> parameter, <strong class="userinput"><code>ENUMCOUNTER</code></strong> will display a list of all performance counter categories:</p><a id="I_programlisting1_d1e42119"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_ncnet -H winsrv -v ENUMCOUNTER</strong></span>
... Processor; ... Terminal services; .NET CLR loading procedure; tot
al RAS services; Process; ...</pre>

        <p>Otherwise, it shows all counters in the category specified with <strong class="userinput"><code>-l</code></strong>. Several categories are separated with commas. The <strong class="userinput"><code>Terminal services</code></strong> category contains three counter objects in all:</p><a id="I_programlisting1_d1e42132"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_ncnet -H winsrv -v ENUMCOUNTER</strong></span> \
 <span class="strong"><strong>   -l Terminal services</strong></span>
Terminal Services: Total Sessions; Active Sessions; Inactive Sessions
nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_ncnet -H winsrv -v ENUMCOUNTER</strong></span> \
<span class="strong"><strong>   -l "Terminal Services","Process"</strong></span>
Terminal Services: Total Sessions; Active Sessions; Inactive Sessions-Process: %
 Processor Time; % User Time; % Privileged Time; Virtual Bytes Peak; Virtual Bytes;
 Page Faults/sec; Working Set Peak; Working Set; ...</pre>

        <p>The precise object name is important for later use, in which the <strong class="userinput"><code>%</code></strong> sign (as, for example, in <strong class="userinput"><code>% Processor Time</code></strong>) is part of the name. If the counter or category name contains spaces, you must remember to place it within quotation marks when formulating the the request.</p>

        <p>The description stored in the Windows Performance Counter objects are shown, by the way, with the command <strong class="userinput"><code>ENUMCOUNTERDESC</code></strong>.</p>

        <p>Several counter categories contain instances, which you must specify when querying a counter object. For this reason you should always check first, using the <strong class="userinput"><code>INSTANCES</code></strong> function, whether the category you want works with instances:<a class="indexterm" id="IDX-CHP-20-1782"/></p><a id="I_programlisting1_d1e42169"/>
        <pre class="programlisting">check_ncnet -H <span class="emphasis"><em>address</em></span> -v INSTANCES -l <span class="emphasis"><em>category1, category2</em></span></pre>

        <p>For the terminal services, this is not the case:</p><a id="I_programlisting1_d1e42179"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_ncnet -H winsrv -v INSTANCES</strong></span> \
 <span class="strong"><strong>   -l "Terminal Services"</strong></span>
  Terminal Services:</pre>

        <p>Typical categories with instances are <strong class="userinput"><code>Processor or Process</code></strong>:</p><a id="I_programlisting1_d1e42192"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_ncnet -H winsrv -v INSTANCES</strong></span> \
 <span class="strong"><strong>   -l "Process"</strong></span>
Process: svchost#6,svchost,Idle,explorer,services,...</pre>

        <p>Here it becomes apparent what is meant by instances: Windows views every running process as an instance in the <strong class="userinput"><code>Process</code></strong> Performance Counter category. As can be seen in <a class="xref" href="../Text/ch20s03.html#installing_the_check_underscore_nc" title="20.3.3 Installing the check_ncnet plugin">20.3.3 Installing the check_ncnet plugin</a>, the counter object (<strong class="userinput"><code>% Processor Time</code></strong>), which contains the percentage use of processor time), is in this category. It can be queried only for individual instances, such as for the <strong class="userinput"><code>explorer</code></strong> process, or for all processes together. In case of the latter you specify <strong class="userinput"><code>_Total</code></strong> instead of an instance.</p>

        <p>In order to access a Windows Performance Counter, therefore, you always need to give the following details:</p><a id="I_programlisting1_d1e42218"/>
        <pre class="programlisting"><span class="emphasis"><em>\category\counter object</em></span>
<span class="emphasis"><em>\category(instance)\counter object</em></span></pre>

        <p>The instance is specified only if the category has instances available. There must be no space between the category name and the first bracket. The corresponding query command is called <strong class="userinput"><code>COUNTER</code></strong>; the placeholder <strong class="userinput"><code><em class="replaceable"><code>name</code></em></code></strong> is replaced by the combination just described:</p><a id="I_programlisting1_d1e42233"/>
        <pre class="programlisting">check_nt -H <span class="emphasis"><em>adresse</em></span> -v COUNTER -l <span class="emphasis"><em>name, formatbeschreibung</em></span> -w <span class="emphasis"><em>ganzzahl</em></span> -c
<span class="emphasis"><em>ganzzahl</em></span></pre>

        <p>This function asks after the Windows Performance Counter object that is specified after the <strong class="userinput"><code>-l</code></strong> option with its exact name. The warning and critical limits given as integer values refer to the size measured: if an object is involved that has a percentage figure (e.g., the processor load), just imagine a percent sign added to it; the numbers of processes, sessions, etc., are just values that are not specified in units.</p>

        <p>The number of active sessions is checked with the <strong class="userinput"><code>Active Sessions</code></strong> object, for which there are no instances:</p><a id="I_programlisting1_d1e42257"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_ncnet -H winsrv -v COUNTER</strong></span> \
 <span class="strong"><strong>   -l "\Terminal Services\Active Sessions"</strong></span>
1
nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_ncnet -H winsrv -v COUNTER</strong></span> \
 <span class="strong"><strong>   -l "\Process(Idle)\% Processor Time"</strong></span>
98</pre>

        <p>Because the <strong class="userinput"><code>Idle</code></strong> instance always looks at the difference between used and spare processor load, so that the sum of the two is always 100 percent, querying the <strong class="userinput"><code>_Total</code></strong> pseudo-instance in the second example does not make much sense.</p>

        <p>Normally <strong class="userinput"><code>COUNTER</code></strong> does not format its output. This can be changed by following the object name with a description in the <strong class="userinput"><code>printf</code></strong> format,<sup>[<a class="footnote" href="#ftn.CHP-20-FN-19" id="CHP-20-FN-19">246</a>]</sup> separated from it with a comma:</p><a id="I_programlisting1_d1e42292"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_ncnet -H winsrv -v COUNTER</strong></span> \
 <span class="strong"><strong>   -l "\Process(Idle)\% Processor Time","Idle Process: %.2f %%"</strong></span>
Idle Process Usage is: 54.00 % | 'Idle Process Usage is: %.2f %%'=54.000000%;
0.000000;0.000000;</pre>

        <p>Not only does this cause the output to be clearer, it also returns additional performance data. A corresponding service definition might look like this:</p><a id="I_programlisting1_d1e42302"/>
        <pre class="programlisting">define service{
   host_name           winsrv
   service_description Terminal Sessions
   check_command check_nt!<span class="strong"><strong>COUNTER</strong></span>!-v "\Terminal Services\Active Sessions"
-w 20 -c 30
   ...
}</pre>
      </div>

      <div class="sect3" title="Listing processes and services">
        <div class="titlepage">
          <h3 class="title" id="heading_id_16"><a id="listing_processes_and_services"/>Listing processes and services</h3>
        </div>

        <p>To find out the names of processes, you can work your way through the Task Manager—or have a list of all running processes displayed with <strong class="userinput"><code>ENUMPROCESS:</code></strong><a class="indexterm" id="IDX-CHP-20-1783"/><a class="indexterm" id="IDX-CHP-20-1784"/><a class="indexterm" id="IDX-CHP-20-1785"/><a class="indexterm" id="IDX-CHP-20-1786"/><a class="indexterm" id="IDX-CHP-20-1787"/><a class="indexterm" id="IDX-CHP-20-1788"/><a class="indexterm" id="IDX-CHP-20-1789"/><a class="indexterm" id="IDX-CHP-20-1790"/></p><a id="I_programlisting1_d1e42350"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_ncnet -H winsrv -v ENUMPROCESS</strong></span>
System Idle Process; System; smss.exe; csrss.exe; winlogon.exe;
services.exe; lsass.exe; svchost.exe; svchost.exe; svchost.exe;
...</pre>

        <p>The equivalent command for listing all installed services is <strong class="userinput"><code>ENUMSERVICE</code></strong>:</p><a id="I_programlisting1_d1e42360"/>
        <pre class="programlisting">check_ncnet -H <span class="emphasis"><em>host</em></span> -v ENUMSERVICE -l <span class="emphasis"><em>typ</em></span>, short</pre>

        <p>The optional <strong class="userinput"><code>−1</code></strong> restricts the output to specific categories (see <a class="xref" href="../Text/ch20s03.html#limiting_option_for_enumservice" title="Table 20-1. Limiting option for ENUMSERVICE">Table 20-1</a>):</p><a id="I_programlisting1_d1e42375"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_ncnet -H winsrv -v ENUMSERVICE</strong></span>
    \ <span class="strong"><strong>-l manual,short</strong></span>
ALG; AppMgmt; BITS; COMSysApp; dmadmin; EventSystem; HTTPFilter; LPDSVC; MSIServer;
 Netman; Nla; NtFrs; NtLmSsp; NtmsSvc; RasAuto;
...</pre>

        <p>With the <strong class="userinput"><code>short</code></strong> option, <strong class="userinput"><code>ENUMSERVICE</code></strong> displays the service names as they are entered in the registry; if you leave out the keyword, it shows the display names.</p>

        <div class="table">
          <a id="limiting_option_for_enumservice"/>

          <p class="title">Table 20-1. Limiting option for <code class="userinput">ENUMSERVICE</code></p>

          <div class="table-contents">
            <table class="sgc-3" summary="Limiting option for ENUMSERVICE">
              <colgroup>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Type</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Description</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>all</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>all services</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>running</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>all currently active services</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>stopped</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>all services which have been stopped</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>automatic</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>services starting automatically</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>manual</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>services which must be started manually</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>disabled</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>disabled services</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="sect3" title="Querying the Windows event log">
        <div class="titlepage">
          <h3 class="title" id="heading_id_17"><a id="querying_the_windows_event_log"/>Querying the Windows event log</h3>
        </div>

        <p>With the <strong class="userinput"><code>EVENTLOG</code></strong> command, the Windows Event Log can be queried:<a class="indexterm" id="IDX-CHP-20-1791"/><a class="indexterm" id="IDX-CHP-20-1792"/><a class="indexterm" id="IDX-CHP-20-1793"/><a class="indexterm" id="IDX-CHP-20-1794"/><a class="indexterm" id="IDX-CHP-20-1795"/></p><a id="I_programlisting1_d1e42487"/>
        <pre class="programlisting">check_ncnet -H <span class="emphasis"><em>adress</em></span> -v EVENTLOG -w <span class="emphasis"><em>integer</em></span> -c <span class="emphasis"><em>integer</em></span> -l <span class="emphasis"><em>eventlog, event_type,
interval,source_filter, description_filter, id_filter</em></span></pre>

        <p>Using it does take some getting used to, however:<sup>[<a class="footnote" href="#ftn.CHP-20-FN-20" id="CHP-20-FN-20">247</a>]</sup> the first three parameters to follow <strong class="userinput"><code>-l</code></strong> select the events to be taken into account by type and by time.</p>

        <p>The placeholder <strong class="userinput"><code><em class="replaceable"><code>eventlog</code></em></code></strong> is replaced with one of the three log areas <strong class="userinput"><code>application, security</code></strong>, and <strong class="userinput"><code>system</code></strong> that you want to look at. If <strong class="userinput"><code>EVENTLOG</code></strong> is to include all three, you just specify <strong class="userinput"><code>any</code></strong>; but you cannot choose only two of the three areas.</p>

        <p>For the <strong class="userinput"><code><em class="replaceable"><code>event type</code></em></code></strong> you can choose from <strong class="userinput"><code>error, Warning, Information</code></strong>, or <strong class="userinput"><code>any</code></strong> for all three.</p>

        <p>In place of <strong class="userinput"><code><em class="replaceable"><code>interval</code></em></code></strong> you specify a time interval in minutes: <strong class="userinput"><code>5</code></strong> limits the selection to events which occurred in the last five minutes, for example; <strong class="userinput"><code>1440</code></strong> stands for a whole day.</p>

        <p>The last three parameters in effect work as filters with which specific results can be determined from the preselection that all originate from a particular source (the <strong class="userinput"><code><em class="replaceable"><code>source_filter</code></em></code></strong> placeholder), that contain a specific pattern in their descriptions (<strong class="userinput"><code><em class="replaceable"><code>description_filter</code></em></code></strong>), or that have a specific event ID (<strong class="userinput"><code><em class="replaceable"><code>id_filter</code></em></code></strong>).</p>

        <p>Each of these filters consists of two parts: in the first an integer reveals how many search patterns are to follow (formulated as regular expressions in accordance with the .NET-<strong class="userinput"><code>Regexp</code></strong> class), and then the actual filter entries are specified, separated by commas. If one of the filters is not used, its placeholder is replaced with a <strong class="userinput"><code>0</code></strong>, which searches for exactly zero search patterns. A source filter which only looks for <strong class="userinput"><code>NC_Net</code></strong> events would be called <strong class="userinput"><code>1,NC_Net</code></strong>; if you want to search for <strong class="userinput"><code>NC_Net</code></strong> and <strong class="userinput"><code>Perflib</code></strong> events, it would be called <strong class="userinput"><code>2,NC_Net,Perflib</code></strong>.</p>

        <p><strong class="userinput"><code>-l any, any,5,0,0,0</code></strong> evaluates all entries from all event ranges from the last five minutes. <strong class="userinput"><code>-l application,error,1440,0,0,0</code></strong> determines all events of the type <strong class="userinput"><code>error</code></strong>, which occurred in the event range <strong class="userinput"><code>application</code></strong> within the last 24 hours. With <strong class="userinput"><code>−1 application, error, 60,1,NC_Net,0,0</code></strong>, the time window is set to 60 minutes and filters the event source using the string <strong class="userinput"><code>NC_Net</code></strong>. Finally <strong class="userinput"><code>-l application,any,60,0,2, start, stop,0</code></strong> searches the event description for two keywords: <strong class="userinput"><code>start</code></strong> and <strong class="userinput"><code>stop</code></strong>.</p>

        <p>With the warning and critical limits you can specify how many matching entries are needed before the plugin returns a WARNING or CRITICAL value. If you leaveout these two parameters, Nagios shows OK as long as <span class="emphasis"><em>no</em></span> events occurred; otherwise, it shows CRITICAL.</p>

        <p>The following example asks how many messages there were within the last 24 hours in the <strong class="userinput"><code>applications</code></strong> area:</p><a id="I_programlisting1_d1e42629"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ .<span class="strong"><strong>/check_ncnet -H winsrv -v EVENTLOG</strong></span> \
 <span class="strong"><strong>   -l "Application,any,1440,0,0,0"</strong></span>
9 Errors with ID: 13001;2003;1010;6013;1111;262194;26;262194;26 LAST - I
D 262194;Not all data for the file "\Device\LanmanRedirector" were sa
ved. Possible causes are computer hardware or the network connection. P
lease specify a different file path.</pre>

        <p>The service we defined below searches for errors in all classes in the <strong class="userinput"><code>System</code></strong> area which occurred in the past five minutes. (When specifying the time period you should generally ensure that it correlates with the time period in <strong class="userinput"><code>normal_check_interval</code></strong>.) The service examines the descriptions of the entries found for the text <strong class="userinput"><code>data loss</code></strong>. The source and ID filters are not used here:</p><a id="I_programlisting1_d1e42648"/>
        <pre class="programlisting">define service{
   host_name        winsrv
   service_description Eventlog data loss
   check_command    check_ncnet!<span class="strong"><strong>EVENTLOG</strong></span>!-l System,any,5,0,1,data loss,0
   is_volatile           1
   normal_check_interval 5
   max_check_attempts    1
   ...
}</pre>

        <p>Log files have the characteristic of pointing out a problem only once under certain circumstances, even if the problem continues. You must therefore ensure that Nagios immediately makes a notification the first time the event occurs, and leaves out repeated tests and soft states. This can be achieved with <strong class="userinput"><code>max_check_attempts 1</code></strong>: this immediately sets off a hard state, and notification is given right away.<a class="indexterm" id="IDX-CHP-20-1796"/></p>

        <p>But if the hard state remains, this would mean in practice that new errors might occur in the meantime (the next test after five minutes no longer records the old states), while the state has not changed; the admin would only be informed again after the <strong class="userinput"><code>notification_interval</code></strong> has expired. For such cases, Nagios has available the <strong class="userinput"><code>is_volatile</code></strong> parameter (see <a class="xref" href="../Text/ch14s05.html#nagios_configuration_colon_volatile_se" title="14.5.2 Nagios configuration: volatile services">14.5.2 Nagios configuration: volatile services</a>, page 309), with which the system provides notification on every single error.</p>
      </div>

      <div class="sect3" title="Displaying and manipulating the NC_Net configuration">
        <div class="titlepage">
          <h3 class="title" id="heading_id_18"><a id="displaying_and_manipulating_the_nc_u"/>Displaying and manipulating the NC_Net configuration</h3>
        </div>

        <p>The <strong class="userinput"><code>ENUMCONFIG</code></strong> function displays the current settings of NC_Net in a readable form:<a class="indexterm" id="IDX-CHP-20-1797"/><a class="indexterm" id="IDX-CHP-20-1798"/></p><a id="I_programlisting1_d1e42687"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_ncnet -H winsrv -v ENUMCONFIG</strong></span>
Date: 16.04.2005 18:15:10;
Version: NC_Net 2.21 03/13/05;
NC_Net Config Path: c:\Programs\shatter it\nc_net\config\;
Startup Config: c:\Programs\shatter it\nc_net\config\startup.cfg;
Debug Log: c:\Programs\shatter it\nc_net\config\deb.log;
...
Port: 1248;
Pass: None;
...</pre>

        <p><strong class="userinput"><code>Date</code></strong> shows the current query date, <strong class="userinput"><code>Version</code></strong> the NC_Net version used. <strong class="userinput"><code>NC_Net Config Path</code></strong> describes the path to the configuration directory, <strong class="userinput"><code>Startup Config</code></strong> the configuration file used. <strong class="userinput"><code>Debug Log</code></strong> specifies the log file containing the debugging output, but only if the <strong class="userinput"><code>MYDEBUG true</code></strong> parameter is set in the configuration file. <strong class="userinput"><code>Port</code></strong> reveals the port on which NC_Net is listening, and <strong class="userinput"><code>Pass</code></strong> shows whether a password has been used for the connection (<strong class="userinput"><code>None:</code></strong> no password).</p>

        <p>There is also the command <strong class="userinput"><code>CONFIG</code></strong> to manipulate the configuration of the NC_Net installation over the network. For reasons of security you should use this for test purposes only, and otherwise keep the function switched off. Accordingly you should keep the following default set in the configuration file<strong class="userinput"><code>startup.cfg</code></strong>:</p><a id="I_programlisting1_d1e42729"/>
        <pre class="programlisting">lock_passive_config true
lock_active_config true</pre>

        <p>This means that the configuration cannot be changed from the outside.</p>
      </div>

      <div class="sect3" title="Other functions">
        <div class="titlepage">
          <h3 class="title" id="heading_id_19"><a id="other_functions"/>Other functions</h3>
        </div>

        <p>NC_Net's range of functions is growing all the time, and to describe all the functions in detail would need a separate book. We'll just mention a few quite useful commands:<a class="indexterm" id="IDX-CHP-20-1799"/><a class="indexterm" id="IDX-CHP-20-1800"/><a class="indexterm" id="IDX-CHP-20-1801"/><a class="indexterm" id="IDX-CHP-20-1802"/><a class="indexterm" id="IDX-CHP-20-1803"/><a class="indexterm" id="IDX-CHP-20-1804"/><a class="indexterm" id="IDX-CHP-20-1805"/><a class="indexterm" id="IDX-CHP-20-1806"/><a class="indexterm" id="IDX-CHP-20-1807"/><a class="indexterm" id="IDX-CHP-20-1808"/></p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>FREEDISKSPACE</code></strong></span></dt>

            <dd>
              <p>The equivalent of <strong class="userinput"><code>USEDDISKSPACE</code></strong> (<a class="xref" href="../Text/ch20s03.html#main_memory_usage" title="Main memory usage">Main memory usage</a>) expects the free hard drive capacity (instead of the used space) in percent for warning and critical limits</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>WMIQUERY</code></strong></span></dt>

            <dd>
              <p>This function enables the SQL-capable WMI<sup>[<a class="footnote" href="#ftn.CHP-20-FN-21" id="CHP-20-FN-21">248</a>]</sup> database to be queried, which contains the .NET configuration data.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>WMICOUNTER</code></strong></span></dt>

            <dd>
              <p>Objects comparable to the Windows performance counters also exist in the WMI area (only .NET); they can be queried with this.</p>
            </dd>

            <dt><span class="term strong"><strong>Passive Checks</strong></span></dt>

            <dd>
              <p>From version 2.0, NC_Net also supports passive checks based on the NSCA mechanism (see <a class="xref" href="../Text/ch14.html" title="Chapter 14. The Nagios Service Check Acceptor (NSCA)">Chapter 14</a>, page 299). A short documentation can be found in the included <strong class="userinput"><code>passive.cfg</code></strong> file.<a class="indexterm" id="IDX-CHP-20-1809"/><a class="indexterm" id="IDX-CHP-20-1810"/><a class="indexterm" id="IDX-CHP-20-1811"/></p>
            </dd>
          </dl>
        </div>

        <p>More information can be found in the file <strong class="userinput"><code>readme.html</code></strong>, included in the installation, but it can also be viewed directly at <a class="ulink" href="http://www.shatterit.com/nc_net/files/readme.html">http://www.shatterit.com/nc_net/files/readme.html</a>.<a class="indexterm" id="IDX-CHP-20-1812"/></p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-15" id="ftn.CHP-20-FN-15">242</a>]</sup> You can read about them in more detail in <a class="xref" href="../Text/ch20s03.html" title="20.3 The check_nt Plugin">20.3 The check_nt Plugin</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-16" id="ftn.CHP-20-FN-16">243</a>]</sup> <a class="ulink" href="http://nagios.sourceforge.net/docs/3_0/monitoring-windows.html">http://nagios.sourceforge.net/docs/3_0/monitoring-windows.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-17" id="ftn.CHP-20-FN-17">244</a>]</sup> This problem is similar to one with NRPE, which was solved through the definition of dependencies (see <a class="xref" href="../Text/ch12s06.html" title="12.6 Accounting for Dependencies between Hosts and Services">12.6 Accounting for Dependencies between Hosts and Services</a>, page 285).</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-18" id="ftn.CHP-20-FN-18">245</a>]</sup> That is, in seconds elapsed since 01.01.1970.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-19" id="ftn.CHP-20-FN-19">246</a>]</sup> <strong class="userinput"><code>man 3 printf</code></strong></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-20" id="ftn.CHP-20-FN-20">247</a>]</sup> According to his own comments, author Tony Montibello wanted to change the syntax for defining services in version 2.25. But up to and including version 2.28, this resolution has not yet been implemented.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-21" id="ftn.CHP-20-FN-21">248</a>]</sup> Short for <span class="emphasis"><em>Windows Management Instrumentation</em></span>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="20.4 NRPE for Windows">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="nrpe_for_windows"/>20.4 NRPE for Windows</h1>
    </div>

    <p>Besides NRPE_NT (an NRPE daemon ported to Windows), NSClient++ and now also OpMon Agent provide NRPE services. Its task is to execute plugins on the target system if a particular test is only possible locally and no suitable network protocol exists to query the resource concerned. As with the Unix version (see <a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a> in page 213), the desired plugins must be installed locally on the target system, apart from the daemon (in this case: NRPE_NT) and the tests must be entered in a local configuration file.<a class="indexterm" id="IDX-CHP-20-1813"/><a class="indexterm" id="IDX-CHP-20-1814"/><a class="indexterm" id="IDX-CHP-20-1815"/><a class="indexterm" id="IDX-CHP-20-1816"/><a class="indexterm" id="IDX-CHP-20-1817"/><a class="indexterm" id="IDX-CHP-20-1818"/><a class="indexterm" id="IDX-CHP-20-1819"/></p>

    <p>NRPE can also be used for other purposes: once installed on the Windows server, you can use the mechanism to run other scripts remotely, apart from Nagios plugins. If you want Nagios to restart a service remotely through the Eventhandler, this can be done just as easily with NRPE_NT.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-22" id="CHP-20-FN-22">249</a>]</sup></p>

    <div class="sect2" title="20.4.1 NRPE_NT, the classic tool">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="nrpe_underscore_nt_comma_the_classic"/>20.4.1 NRPE_NT, the classic tool</h2>
      </div>

      <p>NRPE_NT can be used like the Nagios Remote Plugin Executor, introduced in <a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a>—in reality, this is just the Windows version of the same tool. At the present time, however, it doesn't look as if this tool will continue to be actively developed.</p>

      <p>The current zip archive from The Nagios Exchange,<sup>[<a class="footnote" href="#ftn.CHP-20-FN-23" id="CHP-20-FN-23">250</a>]</sup> SourceForge<sup>[<a class="footnote" href="#ftn.CHP-20-FN-24" id="CHP-20-FN-24">251</a>]</sup> or <a class="ulink" href="http://www.miwi-dv.com/nrpert">http://www.miwi-dv.com/nrpert</a> is unpacked to a suitable directory, such as <strong class="userinput"><code>D:\Programs\Nagios\nrpe_nt</code></strong>:</p><a id="I_programlisting1_d1e42922"/>
      <pre class="programlisting">D:\Programs\Nagios\nrpe_nt&gt; <span class="strong"><strong>unzip nrpe_nt.0.8-bin.zip</strong></span>
...</pre>

      <p>It contains a subdirectory <strong class="userinput"><code>bin</code></strong>, in which are found the daemon <strong class="userinput"><code>NRPE_NT.exe</code></strong>, two DLLs for using SSL (<strong class="userinput"><code>libeay32.dll</code></strong> and <strong class="userinput"><code>ssleay32.dll</code></strong>), an example of a simple plugin script (<strong class="userinput"><code>test.cmd</code></strong>), and the configuration file <strong class="userinput"><code>nrpe.cfg</code></strong>.<a class="indexterm" id="IDX-CHP-20-1820"/></p>

      <p>The service is installed from this directory with the command <strong class="userinput"><code>nrpe_nt -i</code></strong>, after which it just needs to be started, either in the Windows services manager or from the command line:</p><a id="I_programlisting1_d1e42958"/>
      <pre class="programlisting">D:\Programs\Nagios\nrpe_nt\bin&gt; <span class="strong"><strong>nrpe_nt -i</strong></span>
D:\Programs\Nagios\nrpe_nt\bin&gt; <span class="strong"><strong>net start nrpe_nt</strong></span></pre>

      <p>The configuration file <strong class="userinput"><code>nrpe.cfg</code></strong> is only slightly different from the Unix version of NRPE 2.0 (see <a class="xref" href="../Text/ch10s03.html" title="10.3 NRPE Configuration on the Computer to Be Monitored">10.3 NRPE Configuration on the Computer to Be Monitored</a>, page 218): only the directive <strong class="userinput"><code>include_dir</code></strong> does not function in NRPE_NT.</p>

      <p>The file in Windows also has the classical Unix text format,<sup>[<a class="footnote" href="#ftn.CHP-20-FN-25" id="CHP-20-FN-25">252</a>]</sup> so either you require a suitable editor (<strong class="userinput"><code>notepad.exe</code></strong> is not sufficient) or you must edit it in Linux and copy it afterwards to the test system.</p>

      <p>Since there is no inet daemon in Windows, you must specify the port (standard: <strong class="userinput"><code>server_port=5666</code></strong>) and the hosts from which NRPE should be addressed (you should only enter the Nagios server here; for example: <strong class="userinput"><code>allowed_hosts=172.17.129.2</code></strong>)<sup>[<a class="footnote" href="#ftn.CHP-20-FN-26" id="CHP-20-FN-26">253</a>]</sup> in <strong class="userinput"><code>nrpe.cfg</code></strong>. The parameters <strong class="userinput"><code>nrpe_user</code></strong> and <strong class="userinput"><code>nrpe_group</code></strong> have no meaning in Windows, and the other parameters correspond to those discussed in <a class="xref" href="../Text/ch10s03.html" title="10.3 NRPE Configuration on the Computer to Be Monitored">10.3 NRPE Configuration on the Computer to Be Monitored</a>.</p>

      <p>In the definition of executable commands (here for the included test plugin) you must remember the Windows-typical syntax with hard drive letters and backslashes:</p><a id="I_programlisting1_d1e43011"/>
      <pre class="programlisting">command [check_cmd]=D: \Programs\Nagios\nrpe_nt\plugins\test.cmd</pre>

      <p>In this example the plugins are in a separate subdirectory called <strong class="userinput"><code>plugins</code></strong>. After changes to the configuration file you should always restart NRPE_NT:</p><a id="I_programlisting1_d1e43018"/>
      <pre class="programlisting">D:\Programs\Nagios\nrpe_nt\bin&gt; <span class="strong"><strong>net stop nrpe_nt</strong></span>
D:\Programs\Nagios\nrpe_nt\bin&gt; <span class="strong"><strong>net start nrpe_nt</strong></span></pre>

      <div class="sect3" title="Function test">
        <div class="titlepage">
          <h3 class="title" id="heading_id_4"><a id="function_test"/>Function test</h3>
        </div>

        <p>Before putting NRPE_NT into service, you should check whether it is functioning correctly. To do this, run the plugin <strong class="userinput"><code>check_nt</code></strong> on the Nagios server as the user <strong class="userinput"><code>nagios</code></strong>, with just one host specification and no other parameters:<a class="indexterm" id="IDX-CHP-20-1821"/></p><a id="I_programlisting1_d1e43041"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_nrpe -H winsrv</strong></span>
NRPE_NT v0.8/2.0</pre>

        <p>If the service has been correctly installed and configured, it will reply with a version number. Another simple test is performed by the included <strong class="userinput"><code>test.cmd</code></strong> plugin. It provides a short text and ends with the return value <strong class="userinput"><code>1</code></strong>:</p><a id="I_programlisting1_d1e43054"/>
        <pre class="programlisting">@echo off
echo hallo from cmd
exit 1</pre>

        <p>The command to be executed (defined in the previous section) is passed to the plugin <strong class="userinput"><code>check_nt</code></strong> with the <strong class="userinput"><code>-c</code></strong> option:</p><a id="I_programlisting1_d1e43064"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_nrpe -H winsrv -c check_cmd</strong></span>
hallo from cmd
nagios@linux:nagios/libexec$ <span class="strong"><strong>echo $?</strong></span>
1</pre>

        <p>The return value, determined with <strong class="userinput"><code>echo $?</code></strong>, must be <strong class="userinput"><code>1</code></strong> in this case, since the script exits with an <strong class="userinput"><code>exit 1</code></strong>.</p>
      </div>
    </div>

    <div class="sect2" title="20.4.2 Plugins for NRPE in Windows">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="plugins_for_nrpe_in_windows"/>20.4.2 Plugins for NRPE in Windows</h2>
      </div>

      <p>A series of plugins can be found on the Internet that run in Windows and are suitable for use with NRPE. The first port of call is the subcategory <span class="strong"><strong>Check Plugins | Operating Systems | Windows NRPE</strong></span> at the NagiosExchange.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-27" id="CHP-20-FN-27">254</a>]</sup> Some of these are programs that are based on the same source code as their Unix equivalents, which was just recompiled for Windows. However, the portings also include Perl scripts that require Perl to be installed—and in most cases the script language must be installed in Windows first.<a class="indexterm" id="IDX-CHP-20-1822"/><a class="indexterm" id="IDX-CHP-20-1823"/><a class="indexterm" id="IDX-CHP-20-1824"/></p>

      <div class="sect3" title="The Cygwin plugins">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="the_cygwin_plugins"/>The Cygwin plugins</h3>
        </div>

        <p>In the <span class="strong"><strong>Check Plugins | Windows</strong></span><sup>[<a class="footnote" href="#ftn.CHP-20-FN-28" id="CHP-20-FN-28">255</a>]</sup> category, The Nagios Exchange includes the <strong class="userinput"><code>CygwinPlugins</code></strong> package for downloading. It consists of Nagios standard plugins, which have been compiled for Windows with the help of the Cygwin Tools.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-29" id="CHP-20-FN-29">256</a>]</sup> The package is based on the somewhat older plugin version 1.3.1, but this is enough for most purposes. Apart from the executable plugins (<strong class="userinput"><code>*.exe</code></strong>) the package also contains all the necessary DLLs. It is therefore sufficient to unpack the zip archive into a directory:<a class="indexterm" id="IDX-CHP-20-1833"/><a class="indexterm" id="IDX-CHP-20-1834"/><a class="indexterm" id="IDX-CHP-20-1835"/><a class="indexterm" id="IDX-CHP-20-1825"/><a class="indexterm" id="IDX-CHP-20-1826"/><a class="indexterm" id="IDX-CHP-20-1827"/><a class="indexterm" id="IDX-CHP-20-1828"/><a class="indexterm" id="IDX-CHP-20-1829"/><a class="indexterm" id="IDX-CHP-20-1830"/><a class="indexterm" id="IDX-CHP-20-1831"/><a class="indexterm" id="IDX-CHP-20-1832"/><a class="indexterm" id="IDX-CHP-20-1836"/></p><a id="I_programlisting1_d1e43196"/>
        <pre class="programlisting">D:\Tmp&gt; <span class="strong"><strong>unzip CygwinPlugins1-3-1.zip</strong></span>
D:\Tmp&gt; <span class="strong"><strong>dir NagPlug</strong></span>
check_dummy.exe  check_ssh.exe   check_udp.exe        cygwin1.dll
check_http.exe   check_tcp.exe   cygcrypto-0.9.7.dll  negate.exe
check_smtp.exe   check_time.exe  cygssl-0.9.7.dll     urlize.exe</pre>

        <p>For the sake of simplicity just copy the contents of the directory that is created, <strong class="userinput"><code>NagPlug</code></strong>, to a separate plugin directory:</p><a id="I_programlisting1_d1e43209"/>
        <pre class="programlisting">D:\Tmp\NagPlug&gt; <span class="strong"><strong>copy * D:\Programme\Nagios\plugins</strong></span></pre>

        <p>The plugin functions in the same way as in Linux. <a class="xref" href="../Text/ch20s04.html#cygwin_plugins_for_nrpe_underscore_nt" title="Table 20-2. Cygwin Plugins for NRPE_NT">Table 20-2</a> refers to the corresponding sections in this book.</p>

        <div class="table">
          <a id="cygwin_plugins_for_nrpe_underscore_nt"/>

          <p class="title">Table 20-2. Cygwin Plugins for NRPE_NT</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Cygwin Plugins for NRPE_NT">
              <colgroup>
                <col/>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Plugin</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Page</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Description</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>check_dummy.exe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>188</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Test plugin</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>check_http.exe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>119</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Reachability of a Web site</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>check_smtp.exe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>113</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Testing a mail server</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>check_ssh.exe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>131</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>SSH availability</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>check_tcp.exe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>132</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Generic plugin</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>check_time.exe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>178</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Clock time comparison of two hosts</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>check_udp.exe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>135</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Generic plugin</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>negate.exe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>188</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Negates the return value of a plugin</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>urlize.exe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>189</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Turns the plugin output in the Nagios Web interface into a link</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <p>As in Unix, each of the corresponding command definitions in the configuration file <strong class="userinput"><code>nrpe.cfg</code></strong> must be written on a single line:</p><a id="I_programlisting1_d1e43340"/>
        <pre class="programlisting">command [check_web]=D:\Programme\nagios\plugins\check_http -H www.swobspa ce.de
command [check_identd]=D:\Programme\nagios\plugins\check_tcp -H linux01 -p 113</pre>

        <p>The first line checks whether a Web server is running on the HTTP standard port 80 of the host <a class="ulink" href="http://www.swobspace.de">www.swobspace.de</a>. The second line tests whether an <strong class="userinput"><code>identd</code></strong> daemon (TCP port 113) is active on the host <strong class="userinput"><code>linux01</code></strong>.</p>

        <p>In the event that version 1.3.1 of the plugins is too old, or if you are missing plugins, you can also compile the plugins yourself under Windows in the Cygwin environment if you have some basic knowledge of the development of C programs and how to handle Makefiles. However, not all recompiled plugins will function under Windows/Cygwin. For instance, <strong class="userinput"><code>check_icmp</code></strong> makes direct use of the network socket, whose construction in Windows is quite different from that of the Unix socket; thus, the plugin will not work in Windows unless changes are made to the code first. Notes on compiling under Cygwin, along with an already compiled binary archive of the plugin version 1.4.5, can be obtained at <a class="ulink" href="http://www.psychoticwolf.net/blog/2007/07/nagios_plugins_for_windows.php">http://www.psychoticwolf.net/blog/2007/07/nagios_plugins_for_windows.php</a>.</p>
      </div>

      <div class="sect3" title="Perl plugins in Windows">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="perl_plugins_in_windows"/>Perl plugins in Windows</h3>
        </div>

        <p>Unfortunately the Cygwin plugins do not contain a <strong class="userinput"><code>check_ping</code></strong> or <strong class="userinput"><code>check_icmp</code></strong>. You can use the Perl script <strong class="userinput"><code>check_ping.pl</code></strong> instead, which is available for download on The Nagios Exchange in the <strong class="userinput"><code>Networking</code></strong> category.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-30" id="CHP-20-FN-30">257</a>]</sup> It uses the Perl module <strong class="userinput"><code>Net::Ping</code></strong> for the network connection. In contrast to <strong class="userinput"><code>check_tcp</code></strong>, <strong class="userinput"><code>check_ping.pl</code></strong> sends several packets, so it can make a more precise assessment of response times and packet losses.<a class="indexterm" id="IDX-CHP-20-1837"/><a class="indexterm" id="IDX-CHP-20-1838"/><a class="indexterm" id="IDX-CHP-20-1839"/><a class="indexterm" id="IDX-CHP-20-1840"/><a class="indexterm" id="IDX-CHP-20-1841"/></p>

        <p>An up-to-date and simple to install Perl for Windows can be obtained from ActiveState.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-31" id="CHP-20-FN-31">258</a>]</sup> To download the <span class="emphasis"><em>Active Perl Free Distribution</em></span>, no registration is required, even if the download procedure would suggest otherwise. Of the versions offered, you should use the latest Perl version (currently 5.8.7), and only fall back on the older version 5.6.1 if this should cause problems.<a class="indexterm" id="IDX-CHP-20-1842"/></p>

        <p>The plugin script itself contains a <strong class="userinput"><code>BEGIN</code></strong> statement, which you must comment out for use in Windows:</p><a id="I_programlisting1_d1e43435"/>
        <pre class="programlisting"># BEGIN{
#       push @INC, "/usr/lib/perl5/site_perl/...
# }</pre>

        <p>It sends a TCP echo request to port 7, alternatively you can also explicitly set a different port by adding the following line after the <strong class="userinput"><code>Net::Ping-&gt;new</code></strong> statement:</p><a id="I_programlisting1_d1e43442"/>
        <pre class="programlisting">$p-&gt;port = 80;</pre>

        <p>This would cause a TCP ping to port 80 (HTTP). So that NRPE_NT can execute the script, you must explicitly start the Perl executable:</p><a id="I_programlisting1_d1e43446"/>
        <pre class="programlisting">command [check_ping_eli02]=C:\Perl\bin\perl.exe D:\Programme\Nagios\plugi ns\
check_ping.pl --host 172.17.129.2 --loss 10,20--rta 50,250</pre>

        <p>The command has been line-wrapped for the printed version, but in the configuration file the whole command must be written on a single line. With the <strong class="userinput"><code>--host</code></strong> parameter you specify a host name which can be resolved or an IP address, <strong class="userinput"><code>--loss</code></strong> is followed by a pair of values for the warning and critical limits for packet loss in percent, separated by a comma, (so values between 0 and 100 are possible here). The <strong class="userinput"><code>--rta</code></strong> option also demands a threshold value pair as an argument, for the average response time in milliseconds. Since this is a Perl script, it does not matter if these are specified as integers or floating comma decimals.</p>
      </div>
    </div>

    <div class="sect2" title="20.4.3 NRPE with NSClient++">
      <div class="titlepage">
        <h2 class="title" id="heading_id_8"><a id="nrpe_with_nsclient_plus_plus"/>20.4.3 NRPE with NSClient++</h2>
      </div>

      <p>NSClient++ contains its own NRPE service, so you don't need to install an additional NRPE service when using it. It is activated by loading the library <strong class="userinput"><code>NR.PEListener.dll</code></strong> in the <strong class="userinput"><code>[modules]</code></strong> section of the configuration file <strong class="userinput"><code>NSC.ini</code></strong> (<a class="xref" href="../Text/ch20s02.html#configuration-id4" title="Configuration">Configuration</a>). Configuration of the service is handled by the <strong class="userinput"><code>[NRPE]</code></strong> and <strong class="userinput"><code>[NRPE Handlers]</code></strong> sections. The first section contains the NRPE base configuration, and the second one defines the checks to be performed.<a class="indexterm" id="IDX-CHP-20-1846"/><a class="indexterm" id="IDX-CHP-20-1847"/><a class="indexterm" id="IDX-CHP-20-1848"/><a class="indexterm" id="IDX-CHP-20-1843"/><a class="indexterm" id="IDX-CHP-20-1844"/><a class="indexterm" id="IDX-CHP-20-1845"/></p>

      <p>The default port in NRPE is port 5666, and the parameter <strong class="userinput"><code>allow_arguments</code></strong>, when set to <strong class="userinput"><code>1</code></strong>, allows arguments to be passed and corresponds to the NRPE parameter <strong class="userinput"><code>dont_blame_nrpe</code></strong> (<a class="xref" href="../Text/ch10s03.html" title="10.3 NRPE Configuration on the Computer to Be Monitored">10.3 NRPE Configuration on the Computer to Be Monitored</a>):</p><a id="I_programlisting1_d1e43519"/>
      <pre class="programlisting">[NRPE]
port=5666
allow_arguments=1
allow_nasty_meta_chars=1
use_ssl=1
; bind_to_address=
; allowed_hosts=
command_timeout=10
performance_data=1</pre>

      <p><strong class="userinput"><code>allow_nasty_meta_chars=1</code></strong> allows the use of special characters <code class="literal">|'&amp;&gt;&lt;' "\[]{}</code> in <strong class="userinput"><code>check_nrpe</code></strong> arguments. These are not allowed if the value <strong class="userinput"><code>0</code></strong> is entered here instead of <strong class="userinput"><code>1</code></strong>. <strong class="userinput"><code>use_ssl</code></strong> should only be switched off (that is, set to <strong class="userinput"><code>0</code></strong>) if <strong class="userinput"><code>check_nrpe</code></strong> cannot be compiled with SSL support.</p>

      <p>The <strong class="userinput"><code>bind_to_address</code></strong> und <strong class="userinput"><code>allowed_hosts</code></strong> parameters allow for NRPE settings that are different from the default. <strong class="userinput"><code>command_timeout</code></strong> interrupts an external command to be executed after the time specified (in seconds), but the timeout only has an effect on external commands. NRPE commands based on internal functions are unaffected by this. Finally, the <strong class="userinput"><code>performance_data</code></strong> parameter controls whether or not performance data should be returned. The default (value <strong class="userinput"><code>1</code></strong>) is to return it, and it is not returned with the value <strong class="userinput"><code>0</code></strong>.</p>

      <p>In the <strong class="userinput"><code>[NRPE Handlers]</code></strong> section, the actual commands are defined. You can use the same syntax used in NRPE or a short notation, in which the keyword <strong class="userinput"><code>command</code></strong> is omitted entirely:</p><a id="I_programlisting1_d1e43576"/>
      <pre class="programlisting">command [<span class="emphasis"><em>command_name</em></span>]=<span class="emphasis"><em>command line</em></span>
<span class="emphasis"><em>command_name=command line</em></span></pre>

      <p>Along with the usual plugin calls that make use of external plugins, there is the command <strong class="userinput"><code>inject</code></strong>. This runs an internal function (which is described in <a class="xref" href="../Text/ch20s04.html#internal_nsclient_plus_plus_functions" title="20.4.4 Internal NSClient++ functions">20.4.4 Internal NSClient++ functions</a> from page 495):<a class="indexterm" id="IDX-CHP-20-1849"/></p><a id="I_programlisting1_d1e43596"/>
      <pre class="programlisting">[NRPE Handlers]
; ---------------------------------------------
; external plugins
; ---------------------------------------------
; NRPE-stylish:
;command [check_tcp]=C:\Plugins\check_tcp -H $ARG1$ -p $ARG2$
; shorter:
check_tcp=C:\Plugins\check_tcp -H $ARG1$ -p $ARG2$
;
check_smtp=C:\Plugins\check_smtp -H $ARG1$ -f wob@example.net
;
check_uptime=inject CheckUpTime ShowAll MinWarn=1d MinCrit=12h</pre>

      <p>In this example, <strong class="userinput"><code>check_uptime</code></strong> calls the internal function <strong class="userinput"><code>CheckUpTime</code></strong> by means of <strong class="userinput"><code>inject</code></strong>. If passing arguments via NRPE is allowed, you can greatly simplify the definition of <strong class="userinput"><code>inject</code></strong> commands:</p><a id="I_programlisting1_d1e43613"/>
      <pre class="programlisting">check_inject=inject $ARG1$</pre>

      <p>Now you include the internal function, together with all required parameters, as an argument when calling <strong class="userinput"><code>check_nrpe</code></strong>:</p><a id="I_programlisting1_d1e43620"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_nrpe -H winsrv -ccheck_inject</strong></span> \
 <span class="strong"><strong>   -a "checkUpTime ShowAll MinWarn=1d MinCrit=12h"</strong></span>
OK: uptime: 6d 7:19|'uptime'=544771000;86400000;43200000;</pre>

      <p>If you define the command object in Nagios just as generally, the exact formulation of the command will be shifted entirely to the service definition:</p><a id="I_programlisting1_d1e43630"/>
      <pre class="programlisting">define command{
   command_name   check_inject
   command_line   $USER1$/check_nrpe -u -H $HOSTADDRESS$ -c check_inject -a "$ARG1$"
}
define service{
   host_name         winsrv
   service_description Uptime
   check_command     check_inject!checkUpTime ShowAll MinWarn=1d MinCr
it=12h
   ...
}</pre>

      <p>There is a security issue that should be pointed out here, however. If you define <strong class="userinput"><code>check_inject=inject $ARG1$</code></strong> as described above, then you are opening a door to attackers who might be hoping for a buffer overflow in the code of NSClient++. In that event, the client will be able to run any command at all. You should therefore use this rather generous command only in secure environments, and even then you should restrict the hosts that are allowed to access NSClient++ via NRPE using <strong class="userinput"><code>allowed_hosts</code></strong>. On the other hand, such a free definition makes life much easier during the implementation phase, since you can try out all sorts of combinations and checks on the command line without having to adjust the configuration file <strong class="userinput"><code>NSC.ini</code></strong> to many hosts each time.</p>
    </div>

    <div class="sect2" title="20.4.4 Internal NSClient++ functions">
      <div class="titlepage">
        <h2 class="title" id="heading_id_9"><a id="internal_nsclient_plus_plus_functions"/>20.4.4 Internal NSClient++ functions</h2>
      </div>

      <p>NSClient++ provides a series of internal functions that can be called by the <strong class="userinput"><code>inject</code></strong> command via NRPE, and usually also with the plugin <strong class="userinput"><code>check_nt</code></strong>. These are stored in several loadable modules. <a class="xref" href="../Text/ch20s04.html#internal_functions_of_the_nsclient_p" title="Table 20-3. Internal functions of the NSClient++ module">Table 20-3</a> gives an overview of which module is required for a particular function.<a class="indexterm" id="IDX-CHP-20-1850"/><a class="indexterm" id="IDX-CHP-20-1851"/><a class="indexterm" id="IDX-CHP-20-1852"/><a class="indexterm" id="IDX-CHP-20-1853"/><a class="indexterm" id="IDX-CHP-20-1854"/><a class="indexterm" id="IDX-CHP-20-1855"/><a class="indexterm" id="IDX-CHP-20-1856"/><a class="indexterm" id="IDX-CHP-20-1857"/><a class="indexterm" id="IDX-CHP-20-1858"/><a class="indexterm" id="IDX-CHP-20-1859"/><a class="indexterm" id="IDX-CHP-20-1860"/><a class="indexterm" id="IDX-CHP-20-1861"/><a class="indexterm" id="IDX-CHP-20-1862"/><a class="indexterm" id="IDX-CHP-20-1863"/><a class="indexterm" id="IDX-CHP-20-1864"/><a class="indexterm" id="IDX-CHP-20-1865"/></p>

      <div class="table">
        <a id="internal_functions_of_the_nsclient_p"/>

        <p class="title">Table 20-3. Internal functions of the NSClient++ module</p>

        <div class="table-contents">
          <table class="sgc-3" summary="Internal functions of the NSClient++ module">
            <colgroup>
              <col/>
              <col/>
            </colgroup>

            <thead>
              <tr>
                <th class="sgc-1" valign="bottom">
                  <p>Modules</p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Function</p>
                </th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>CheckDisk</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>CheckFileSize</code></strong>, <strong class="userinput"><code>CheckDriveSize</code></strong></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>CheckSystem</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>CheckCPU</code></strong>, <strong class="userinput"><code>CheckUpTime</code></strong>, <strong class="userinput"><code>CheckServiceState</code></strong>, <strong class="userinput"><code>CheckProcState</code></strong>, <strong class="userinput"><code>CheckMem</code></strong>, <strong class="userinput"><code>CheckCounter</code></strong></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>CheckEventLog</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>CheckEventLog</code></strong></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>CheckHelpers</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>CheckAlwaysOK</code></strong>, <strong class="userinput"><code>CheckAlwaysCRITICAL</code></strong>, <strong class="userinput"><code>CheckAlwaysWARNING</code></strong>, <strong class="userinput"><code>CheckMultiple</code></strong></p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p>To use one of these functions with <strong class="userinput"><code>check_nt</code></strong>, you only need to ensure that the required modules are loaded in the <strong class="userinput"><code>[modules]</code></strong> section. Calling via NRPE and <strong class="userinput"><code>inject</code></strong> provides additional configuration options, however.</p>

      <p>Thus, for the hard disk load check with <strong class="userinput"><code>check_nt</code></strong>, which uses the function <strong class="userinput"><code>CheckDriveSize</code></strong> internally, you can just have a warning and a critical threshold displayed:</p><a id="I_programlisting1_d1e43806"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_nt -H winsrv -vUSEDDISKSPACE</strong></span> \
 <span class="strong"><strong>   -l C -w 80 -c 90</strong></span>
...</pre>

      <p>If, on the other hand, you access <strong class="userinput"><code>CheckDriveSize</code></strong> directly, you may specify higher and lower thresholds, and instead of using a hard drive letter, you can use a UNC path (see <a class="xref" href="../Text/ch20s04.html#checking_file_sizes_with_checkfilesize" title="Checking file sizes with CheckFileSize">Checking file sizes with CheckFileSize</a>).</p>

      <p>Many of the parameters listed below are optional, at least if you go by the documentation in the Wiki. This convention does not seem to have been uniformly adhered to, however. Performance data, for instance, is obtained only if you specify a warning and a critical threshold. You can also omit one or both thresholds and the call will still function; what is missing is the performance data. The <strong class="userinput"><code>ShowAll</code></strong> and <strong class="userinput"><code>nsclient</code></strong> parameters are optional, provided that the function allows this.</p>

      <p>For all other functions, you should test to see whether your configuration really fulfills the desired purpose and whether NSClient++ works without an error message before you deploy it in a production environment.</p>

      <div class="sect3" title="Checking file sizes with CheckFileSize">
        <div class="titlepage">
          <h3 class="title" id="heading_id_10"><a id="checking_file_sizes_with_checkfilesize"/>Checking file sizes with <strong class="userinput"><code>CheckFileSize</code></strong></h3>
        </div>

        <p><strong class="userinput"><code>CheckFileSize</code></strong> tests the size of individual files or directories:<a class="indexterm" id="IDX-CHP-20-1866"/><a class="indexterm" id="IDX-CHP-20-1867"/><a class="indexterm" id="IDX-CHP-20-1868"/><a class="indexterm" id="IDX-CHP-20-1869"/></p><a id="I_programlisting1_d1e43856"/>
        <pre class="programlisting">CheckFileSize MaxWarn=<span class="emphasis"><em>size</em></span> MaxCrit=<span class="emphasis"><em>size</em></span>
MinWarn=<span class="emphasis"><em>size</em></span> MinCrit=<span class="emphasis"><em>size</em></span>
File=<span class="emphasis"><em>path:alias</em></span> ShowAll</pre>

        <p>The last ones here are processed recursively. You can also test drives if you specify <strong class="userinput"><code>File=C:\*.*</code></strong>, for instance. The threshold parameters do require size values to be given, however. If you want to monitor how full a drive is in percent, you are better off using the command <strong class="userinput"><code>CheckDriveSize</code></strong>.</p>

        <p>When specifying the threshold size values you can include a suffix: <strong class="userinput"><code>B</code></strong> for bytes, <strong class="userinput"><code>K</code></strong> for <strong class="userinput"><code>KB</code></strong>, <strong class="userinput"><code>M</code></strong> for MB, and <strong class="userinput"><code>G</code></strong> for GB (e.g., <strong class="userinput"><code>MaxWarn=2198M</code></strong>). A number without a suffix specifies a size in bytes.</p>

        <p>The syntax allows several files and/or directories to be given. In this case, the <strong class="userinput"><code>File</code></strong> parameter follows the associated thresholds:</p><a id="I_programlisting1_d1e43907"/>
        <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_nrpe -H 172.17.129.25</strong></span> \
<span class="strong"><strong>    -c check_inject -a "CheckFileSize</strong></span> \
<span class="strong"><strong>    MaxWarn=500M MaxCrit=1024MFile=E:\Exchsvr\mdbdata_log\*.*</strong></span>\
<span class="strong"><strong>    MaxWarn=10G  MaxCrit=30G  File=F:\store02\priv2.edb</strong></span>
\
<span class="strong"><strong>    File=G:\store03\pub3.edb ShowAll"</strong></span>

WARNING:  E:\Exchsvr\mdbdata_log\*.*: 77M,
F:\store02\priv2.edb: 11.4G &gt; w
arning, G:\store03\pub3.edb: 3.09G|
'E:\Exchsvr\mdbdata_log\*.*'=80740352
;524288000;1073741824;
'F:\store02\priv2.edb'=12234989568;10737418240 ;322
12254720;
'G:\store03\pub3.edb'=3316719616;10737418240;32212254720;</pre>

        <p>When monitoring directories, it is not sufficient to give just the directory names. Instead, as shown in the example for the directory <strong class="userinput"><code>E:\Exchsvr\mdbdata_log\</code></strong>, you need to specify with <strong class="userinput"><code>*.*</code></strong> that all the files and subdirectories (together with their contents) contained in the directory must be included in the calculation.</p>

        <p>Of course, you can also use wildcards, for example, <strong class="userinput"><code>*.log</code></strong> to find out the total size of all files ending in <strong class="userinput"><code>.log</code></strong> in a directory. The thresholds always refer to the total of all files and directories specified in the corresponding <strong class="userinput"><code>File</code></strong> parameter.</p>

        <p>If there are several consecutive <strong class="userinput"><code>File</code></strong> specifications, the last thresholds that were specified before them are used. <strong class="userinput"><code>ShowAll</code></strong> displays the statuses of all files or directories specified, and if this parameter is not given, the display contains only files and directories with an error state.</p>

        <p>The display contains the full path of the file and directories tested, which can become very confusing. <strong class="userinput"><code>CheckFileSize</code></strong> therefore allows the optional use of aliases. Calling</p><a id="I_programlisting1_d1e43957"/>
        <pre class="programlisting">MaxWarn=500M MaxCrit=1024M File:TMP=C:\tmp\*.*</pre>

        <p>will display just the alias <strong class="userinput"><code>TMP</code></strong> instead of the full path:</p><a id="I_programlisting1_d1e43964"/>
        <pre class="programlisting">OK: TMP: 0B|'TMP'=0;524288000;1073741824;</pre>
      </div>

      <div class="sect3" title="Checking how full drives are with CheckDriveSize">
        <div class="titlepage">
          <h3 class="title" id="heading_id_11"><a id="checking_how_full_drives_are_with_chec"/>Checking how full drives are with <strong class="userinput"><code>CheckDriveSize</code></strong></h3>
        </div>

        <p><strong class="userinput"><code>CheckDriveSize</code></strong> checks how full drives are. The thresholds can be given very flexibly here: You can either use the <strong class="userinput"><code>*Free</code></strong> parameters to determine the remaining free drive space or the <strong class="userinput"><code>*Used</code></strong> parameters to establish the used drive space:</p><a id="I_programlisting1_d1e43981"/>
        <pre class="programlisting">CheckDriveSize MaxWarnFree=<span class="emphasis"><em>größe</em></span> MaxCritFree=<span class="emphasis"><em>size</em></span>
MinWarnFree=<span class="emphasis"><em>size</em></span> Min
CritFree=<span class="emphasis"><em>size</em></span> MaxWarnUsed=<span class="emphasis"><em>size</em></span>
MaxCritUsed=<span class="emphasis"><em>size</em></span> MinWarnUsed=<span class="emphasis"><em>size</em></span> Min
CritUsed=<span class="emphasis"><em>size</em></span> Drive=<span class="emphasis"><em>laufwerk</em></span> FilterType=<span class="emphasis"><em>type</em></span>
CheckAll CheckAllOthers Sho
wAll</pre>

        <p>When giving thresholds, you can again use sizes, or use the <strong class="userinput"><code>%</code></strong> suffix to obtain percentages. In contrast to <strong class="userinput"><code>CheckFileSize</code></strong>, the suffixes for size parameters must be written in lower case: <strong class="userinput"><code>b</code></strong> for bytes, <strong class="userinput"><code>k</code></strong> for KB, <strong class="userinput"><code>m</code></strong> for MB, and <strong class="userinput"><code>g</code></strong> for GB.</p>

        <p>For the placeholder <strong class="userinput"><code><em class="replaceable"><code>disk</code></em></code></strong> you can use either the respective disk letter or the UNC path of a network share: for example, <strong class="userinput"><code>Drive=\\WinSRV\C$</code></strong>. If <strong class="userinput"><code>CheckAllOthers</code></strong> is specified, NSClient++ checks all hard disks that have not been individually specified. <strong class="userinput"><code>CheckAll</code></strong> deals with all drives, so the Drive parameter can be omitted. An additional filter allows only certain drive types to be considered: <strong class="userinput"><code>FilterType=FIXED</code></strong> restricts itself to all drives that are permanently installed, while <strong class="userinput"><code>FilterType=REMOVABLE</code></strong> just considers removable drives. The filter <strong class="userinput"><code>FilterType=CDROM</code></strong> describes CD-ROM drives, and <strong class="userinput"><code>FilterType=REMOTE</code></strong> looks at all network drives. It is possible to combine several filters:</p><a id="I_programlisting1_d1e44063"/>
        <pre class="programlisting">CheckDriveSize CheckAll FilterType=FIXED FilterType=REMOTE</pre>

        <p>checks all permanently installed local drives and all connected network drives.</p>
      </div>

      <div class="sect3" title="Checking CPU load with CheckCPU">
        <div class="titlepage">
          <h3 class="title" id="heading_id_12"><a id="checking_cpu_load_with_checkcpu"/>Checking CPU load with <strong class="userinput"><code>CheckCPU</code></strong></h3>
        </div>

        <p><strong class="userinput"><code>CheckCPU</code></strong> checks the processor load in percent, and thresholds are given here without the percentage sign:<a class="indexterm" id="IDX-CHP-20-1870"/><a class="indexterm" id="IDX-CHP-20-1871"/></p><a id="I_programlisting1_d1e44085"/>
        <pre class="programlisting">CheckCPU warn=<span class="emphasis"><em>percentage</em></span> crit=<span class="emphasis"><em>percentage</em></span>
time=<span class="emphasis"><em>period</em></span> ShowAll nsclient</pre>

        <p>The load is calculated over a period specified with the <strong class="userinput"><code>time</code></strong> parameter. If no suffix is given, the period is in seconds, otherwise the suffixes <strong class="userinput"><code>w</code></strong> for weeks, <strong class="userinput"><code>d</code></strong> for days, <strong class="userinput"><code>h</code></strong> for hours, <strong class="userinput"><code>m</code></strong> for minutes, and <strong class="userinput"><code>s</code></strong> for seconds are available. For longer periods, you must make sure that the parameter <strong class="userinput"><code>CpuBufferSize</code></strong> in the configuration file under <strong class="userinput"><code>[CheckSystem]</code></strong> has a sufficiently large value. The default period is one hour.</p>

        <p>To display the CPU load over several different time intervals all at once, you can specify the <strong class="userinput"><code>time</code></strong> parameter multiple times:</p><a id="I_programlisting1_d1e44128"/>
        <pre class="programlisting">CheckCPU warn=30 crit=80 time=1m time=5m time=15m</pre>

        <p><strong class="userinput"><code>ShowAll</code></strong> influences the display of the plugin output (but not of the performance data; these have been omitted below):</p><a id="I_programlisting1_d1e44134"/>
        <pre class="programlisting">OK CPU Load ok.
OK:  1m:  2%,  5m:  2%,  15m:  2%
OK:  1m:  average load 2%, 5m: average load 2%, 15m: average load 2%</pre>

        <p>The first line shows the output without <strong class="userinput"><code>ShowAll</code></strong>, the second line shows it with this parameter. Here <strong class="userinput"><code>CheckCPU</code></strong> displays the values for each time interval individually. The third line demonstrates the parameter <strong class="userinput"><code>ShowAll=long</code></strong>. This does not give you more information, just more text.</p>

        <p>The remaining parameter is <strong class="userinput"><code>nsclient</code></strong>, which displays the output in the style of the original NSClient and separates the details for the time intervals with the <strong class="userinput"><code>&amp;</code></strong> sign: <strong class="userinput"><code>2&amp;2&amp;2</code></strong>. Performance data is not displayed when using this parameter.</p>
      </div>

      <div class="sect3" title="Determining the uptime with CheckUpTime">
        <div class="titlepage">
          <h3 class="title" id="heading_id_13"><a id="determining_the_uptime_with_checkuptime"/>Determining the uptime with <strong class="userinput"><code>CheckUpTime</code></strong></h3>
        </div>

        <p><strong class="userinput"><code>CheckUpTime</code></strong> shows how much time has passed since the system was started. As with <strong class="userinput"><code>CheckCPU</code></strong>, the thresholds can be set using a suffix (<strong class="userinput"><code>s</code></strong>, <strong class="userinput"><code>m</code></strong>, <strong class="userinput"><code>h</code></strong>, <strong class="userinput"><code>d</code></strong>, <strong class="userinput"><code>w</code></strong>):<a class="indexterm" id="IDX-CHP-20-1872"/><a class="indexterm" id="IDX-CHP-20-1873"/><a class="indexterm" id="IDX-CHP-20-1874"/></p><a id="I_programlisting1_d1e44197"/>
        <pre class="programlisting">CheckUpTime MaxWarn=<span class="emphasis"><em>time</em></span> MaxCrit=<span class="emphasis"><em>time</em></span>
MinWarn=<span class="emphasis"><em>time</em></span> MinCrit=<span class="emphasis"><em>time</em></span> ShowAll
nsclient Alias=<span class="emphasis"><em>string</em></span></pre>

        <p><strong class="userinput"><code>ShowAll</code></strong> also displays the time even when there is no error state. <strong class="userinput"><code>nsclient</code></strong> changes the output to a simple value in seconds, without any other text. With <strong class="userinput"><code>Alias</code></strong>, the word <strong class="userinput"><code>Uptime</code></strong> can be replaced with a different text:</p><a id="I_programlisting1_d1e44226"/>
        <pre class="programlisting">OK:  uptime:  1d  20:11
OK:  Running_Time:  1d 20:12</pre>

        <p>The first line shows a normal output with <strong class="userinput"><code>ShowAll</code></strong>; in the second line an additional <strong class="userinput"><code>Alias=Running_Time</code></strong> has been set.</p>
      </div>

      <div class="sect3" title="Activity check with CheckServiceState">
        <div class="titlepage">
          <h3 class="title" id="heading_id_14"><a id="activity_check_with_checkservicestate"/>Activity check with <strong class="userinput"><code>CheckServiceState</code></strong></h3>
        </div>

        <p><strong class="userinput"><code>CheckServiceState</code></strong> checks whether services are active (<strong class="userinput"><code>started</code></strong>) or not (<strong class="userinput"><code>stopped</code></strong>). You can either check one or more individually listed services or use the <strong class="userinput"><code>CheckAll</code></strong> switch, which checks all services for which the autostart flag has been set and which should be running after every system start:</p><a id="I_programlisting1_d1e44254"/>
        <pre class="programlisting">CheckServiceState <span class="emphasis"><em>service</em></span> ShowFail CheckAll
exclude= <span class="emphasis"><em>servicename</em></span>
CheckServiceState ShowFail ShowAll CheckAll exclude=<span class="emphasis"><em>servicename</em></span></pre>

        <p>Individual services can be explicitly checked for the desired state:</p><a id="I_programlisting1_d1e44266"/>
        <pre class="programlisting">CheckServiceState MSExchangeSA=started MSSEARCH=stopped ShowFail</pre>

        <p>This call checks whether the <strong class="userinput"><code>MSExchangeSA</code></strong> service is running and the <strong class="userinput"><code>MSSEARCH</code></strong> service is not. If the state of either of the two services is different from what is specified, CRITICAL is displayed. <strong class="userinput"><code>ShowFail</code></strong> ensures that only services with errors appear in the output.</p>

        <p><strong class="userinput"><code>CheckAll</code></strong> normally includes all services with an autostart flag. Individual services can be excluded from this with <strong class="userinput"><code>exclude</code></strong>.</p>
      </div>

      <div class="sect3" title="Monitoring processes with CheckProcState">
        <div class="titlepage">
          <h3 class="title" id="heading_id_15"><a id="monitoring_processes_with_checkprocstat"/>Monitoring processes with <strong class="userinput"><code>CheckProcState</code></strong></h3>
        </div>

        <p><strong class="userinput"><code>CheckProcState</code></strong> checks the state of processes, and it functions in the same way as <strong class="userinput"><code>CheckServiceState</code></strong>, except that here there are fewer options available:<a class="indexterm" id="IDX-CHP-20-1875"/><a class="indexterm" id="IDX-CHP-20-1876"/><a class="indexterm" id="IDX-CHP-20-1877"/></p><a id="I_programlisting1_d1e44309"/>
        <pre class="programlisting">CheckProcState ShowAll ShowFail
CheckProcState ShowFail <span class="emphasis"><em>prozess</em></span></pre>

        <p>For single processes you can again specify the desired state (<strong class="userinput"><code><em class="replaceable"><code>process</code></em></code></strong><strong class="userinput"><code>=started</code></strong> or <strong class="userinput"><code><em class="replaceable"><code>process</code></em></code></strong><strong class="userinput"><code>=stopped</code></strong>); otherwise only <strong class="userinput"><code>ShowAll</code></strong> will be left to control the output. <strong class="userinput"><code>ShowFail</code></strong> is the default and can be omitted.</p>
      </div>

      <div class="sect3" title="Checking memory load with CheckMem">
        <div class="titlepage">
          <h3 class="title" id="heading_id_16"><a id="checking_memory_load_with_checkmem"/>Checking memory load with <strong class="userinput"><code>CheckMem</code></strong></h3>
        </div>

        <p><strong class="userinput"><code>CheckMem</code></strong> checks the load level of the memory. The <strong class="userinput"><code>type</code></strong> parameter is of interest here:</p><a id="I_programlisting1_d1e44345"/>
        <pre class="programlisting">CheckMem MaxWarn=<span class="emphasis"><em>size</em></span> MaxCrit=<span class="emphasis"><em>size</em></span>
MinWarn=<span class="emphasis"><em>size</em></span> MinCrit=<span class="emphasis"><em>size</em></span> ShowAll
type=<span class="emphasis"><em>typ</em></span></pre>

        <p><strong class="userinput"><code>type=page</code></strong> and <strong class="userinput"><code>type=paged</code></strong> show the entire memory (physical plus swap) and correspond to the value of <strong class="userinput"><code>check_nt -v MEMUSE</code></strong>. The difference between <strong class="userinput"><code>page</code></strong> and <strong class="userinput"><code>paged</code></strong> lies only in the routine used: The former uses the PDH library that is used by NSClient, and which originates from the days of Windows NT, whereas the latter uses the newer routines of Windows 2000 and Windows 2003. <strong class="userinput"><code>type=virtual</code></strong> refers to the swap memory used, and <strong class="userinput"><code>type=physical</code></strong> refers to the physical memory used.</p>

        <p>The output of <strong class="userinput"><code>CheckMem</code></strong> only provides details of the entire memory available if there is an error state; for the OK state, only what is actually used of the specified category is shown.</p>

        <p>As with <strong class="userinput"><code>CheckFileSize</code></strong>, suffixes for thresholds are written in upper case for this function: <strong class="userinput"><code>B</code></strong>, <strong class="userinput"><code>K</code></strong>, <strong class="userinput"><code>M</code></strong>, and <strong class="userinput"><code>G</code></strong>. Specifying percentages with the suffix <strong class="userinput"><code>%</code></strong> is also allowed.</p>
      </div>

      <div class="sect3" title="Checking the performance counter with CheckCounter">
        <div class="titlepage">
          <h3 class="title" id="heading_id_17"><a id="checking_the_performance_counter_with"/>Checking the performance counter with <strong class="userinput"><code>CheckCounter</code></strong></h3>
        </div>

        <p>With <strong class="userinput"><code>CheckCounter</code></strong> you can query Windows performance counters that record nearly all the parameters that Windows has to offer:<a class="indexterm" id="IDX-CHP-20-1878"/><a class="indexterm" id="IDX-CHP-20-1879"/><a class="indexterm" id="IDX-CHP-20-1880"/></p><a id="I_programlisting1_d1e44433"/>
        <pre class="programlisting">CheckCounter MaxWarn=<span class="emphasis"><em>number</em></span> MaxCrit=<span class="emphasis"><em>number</em></span>
MinWarn=<span class="emphasis"><em>number</em></span> MinCrit=<span class="emphasis"><em>number</em></span> showAll
Averages=<span class="emphasis"><em>value</em></span> Counter=<span class="emphasis"><em>countername</em></span></pre>

        <p>With <strong class="userinput"><code>Averages=true</code></strong>, <strong class="userinput"><code>CheckCounter</code></strong> calculates averages for performance counters, which on their own do not provide averages. The value <strong class="userinput"><code>false</code></strong> switches this off, so that the query takes less time. The <strong class="userinput"><code>Averages</code></strong> parameter has no influence on performance counters that Windows already provides as an average.</p>

        <p>The trick lies in finding the right performance counter. One starting point is the performance monitor itself, which is started in Windows via the <strong class="userinput"><code>perfmon</code></strong> program. If you insert a new performance counter in this for viewing, you will be shown all available objects (the performance counter categories) and performance indicators. All available counters are also shown by NSClient++ when it is run directly from the command line. Because of the large number of counters, it is best to redirect the output to a text file:</p><a id="I_programlisting1_d1e44472"/>
        <pre class="programlisting">C:\Programme\Nagios\nsclient++&gt; <span class="strong"><strong>nsclient++CheckSystem listpdh &gt; All.txt</strong></span></pre>

        <p><strong class="userinput"><code>CheckCounter</code></strong> takes as thresholds only whole numbers, since counters generally do not have units. This function allows an alias for the counter to be specified (see <a class="xref" href="../Text/ch20s04.html#checking_file_sizes_with_checkfilesize" title="Checking file sizes with CheckFileSize">Checking file sizes with CheckFileSize</a>):</p><a id="I_programlisting1_d1e44482"/>
        <pre class="programlisting">CheckCounter "Counter:Logins=\Terminal services\Active
sessions" MaxWarn=2
0 MaxCrit=30 showAll</pre>

        <p>The quotation marks are important here. You must ensure that the parameter itself is within the quotation marks. If an alias is specified, NSClient++ replaces the performance counter in the output with the alias:</p><a id="I_programlisting1_d1e44486"/>
        <pre class="programlisting">OK: Login: 1|'Login'=1;20;30;</pre>
      </div>

      <div class="sect3" title="Evaluating log entries with CheckEventLog">
        <div class="titlepage">
          <h3 class="title" id="heading_id_18"><a id="evaluating_log_entries_with_checkeve"/>Evaluating log entries with <strong class="userinput"><code>CheckEventLog</code></strong></h3>
        </div>

        <p><strong class="userinput"><code>CheckEventLog</code></strong> searches through the event log for specific events and issues a WARNING or CRITICAL if the number of entries found exceeds the respective threshold. The function is very powerful and complex—and, regrettably, is not very easy to understand:<a class="indexterm" id="IDX-CHP-20-1881"/><a class="indexterm" id="IDX-CHP-20-1882"/></p><a id="I_programlisting1_d1e44505"/>
        <pre class="programlisting">CheckEventLog file=<span class="strong"><strong>typ</strong></span> filter=<span class="emphasis"><em>value</em></span> truncate=<span class="emphasis"><em>number</em></span>
MaxWarn=<span class="emphasis"><em>number</em></span> MaxCrit=
<span class="emphasis"><em>number</em></span> descriptions filter<span class="emphasis"><em>modetype</em></span>=<span class="emphasis"><em>string</em></span></pre>

        <p>The Windows event log has various log files: for applications themselves (<strong class="userinput"><code>file=Application</code></strong>), for security aspects (<strong class="userinput"><code>file=Security</code></strong>), and for system parameters (<strong class="userinput"><code>file=System</code></strong>). There are some additional ones for domain controllers. If you want to search for events in more than one log file, you just repeat the <strong class="userinput"><code>file</code></strong> parameter:</p><a id="I_programlisting1_d1e44542"/>
        <pre class="programlisting">file=Application file=Security file=System</pre>

        <p>The first <strong class="userinput"><code>filter</code></strong> parameter is used as a switch that is combined with filter expressions that are listed later on. <strong class="userinput"><code>filter=in</code></strong> includes all events that match the actual filter expression, <strong class="userinput"><code>filter=out</code></strong> excludes such events. <strong class="userinput"><code>filter=all</code></strong> demands that all filter expressions match the event (logical AND), but for <strong class="userinput"><code>filter=any</code></strong>, one single match (logical OR) is sufficient.</p>

        <p>Writing the filter expression itself takes some getting used to: It starts with the keyword <strong class="userinput"><code>filter</code></strong>—an unfortunate choice, because the same keyword has already been used. This is followed by a mode: <strong class="userinput"><code>+</code></strong> or . ensure that the event is counted if the filter matches, whereas <strong class="userinput"><code>-</code></strong> excludes the event. For <strong class="userinput"><code>+</code></strong>, if the filter does not match, the event is excluded, even if <strong class="userinput"><code>filter=any</code></strong> is used and another filter expression demands that it be counted.</p>

        <p>The mode is followed by the filter type. <strong class="userinput"><code>eventType</code></strong> describes whether an error or piece of information is involved (possible values for this are <strong class="userinput"><code>error</code></strong>, <strong class="userinput"><code>warning</code></strong>, <strong class="userinput"><code>info</code></strong>, <strong class="userinput"><code>auditSuccess</code></strong>, and <strong class="userinput"><code>auditFailure</code></strong>):</p><a id="I_programlisting1_d1e44602"/>
        <pre class="programlisting">filter+eventType==warning</pre>

        <p>This expression includes all events in which the event type matches <strong class="userinput"><code>warning</code></strong>. The plus sign ensures that this filter is taken into account whatever the case, even if <strong class="userinput"><code>filter=any</code></strong> has been set.</p>

        <p>The <strong class="userinput"><code>eventSource</code></strong> filter type specifies the source of the event (for example <strong class="userinput"><code>Print</code></strong>, <strong class="userinput"><code>Netlogon</code></strong>, or <strong class="userinput"><code>Service Control Manager</code></strong>). The following example searches for all events for which the source contains the partial string <strong class="userinput"><code>KCC</code></strong>:</p><a id="I_programlisting1_d1e44630"/>
        <pre class="programlisting">filter.eventSource=substr:KCC</pre>

        <p>The <strong class="userinput"><code>generated</code></strong> and <strong class="userinput"><code>written</code></strong> filter types refer to time details: <strong class="userinput"><code>generated</code></strong> stands for the time at which the event entry was generated, <strong class="userinput"><code>written</code></strong> for the time at which the event was written to the log file:</p><a id="I_programlisting1_d1e44646"/>
        <pre class="programlisting">filter-generated⇒2d</pre>

        <p>This expression excludes all events that are more than two days old.</p>

        <p>The <strong class="userinput"><code>message</code></strong> filter type refers to the text for the event entry and allows filtering according to text content:</p><a id="I_programlisting1_d1e44655"/>
        <pre class="programlisting">filter.message=regexp:(hans|lisa)</pre>

        <p>Here a regular expression searches for events containing either the text <strong class="userinput"><code>hans</code></strong> or <strong class="userinput"><code>lisa</code></strong>.</p>

        <p>With the <strong class="userinput"><code>event ID</code></strong> filter type you can filter according to the event number:</p><a id="I_programlisting1_d1e44670"/>
        <pre class="programlisting">filter.eventID==7031</pre>

        <p>There is also the <strong class="userinput"><code>severity</code></strong> type, which is intended to filter according to the event priority. Since the author does not know of a suitable use for this, we will not look at it in any more detail.</p>

        <p>It is not immediately clear when you need to write <strong class="userinput"><code>=</code></strong> for a filter expression and when <strong class="userinput"><code>==</code></strong> is needed. For expressions with purely text arguments (<strong class="userinput"><code>eventSource, message</code></strong>), a single equals sign is sufficient. For all other expressions which also allow a comparison, a relation symbol is part of the expression itself: <strong class="userinput"><code>=warning</code></strong>, <strong class="userinput"><code>=7031</code></strong>, <strong class="userinput"><code>&gt;2d</code></strong> in the examples just mentioned. Together with the equals sign belonging to the filter type, this then looks like a double equals sign or a "greater than or equal to" sign—but this is not the case, there is no "greater than or equal to."</p>

        <p>The following example searches in the <strong class="userinput"><code>System</code></strong> log file for crashes of the NSClient++ service:</p><a id="I_programlisting1_d1e44704"/>
        <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_nrpe -H 172.17.133.10</strong></span> \
<span class="strong"><strong>     -c check_inject -a 'CheckEventLog</strong></span> \
<span class="strong"><strong>     file=System filter=in filter=all filter.eventID==7031</strong></span> \
<span class="strong"><strong>     filter.generated=&lt;1d filter.message=substr:NSClientpp</strong></span> \
<span class="strong"><strong>     MaxWarn=1 MaxCrit=2 descriptions'</strong></span>
Service Control Manager(error, 7031, error)[NSClientpp (Nagios) 0.2.7 20 07-03-06, 1,
 60000, 1, Starten Sie den Dienst neu., ], : 1 &gt; warning|''= 1;1;2;</pre>

        <p>Because of <strong class="userinput"><code>filter=in filter=all</code></strong>, all filter expressions must match simultaneously. The event number being looked for is 7031, the event should not be older than one day, and it should contain the substring <strong class="userinput"><code>NSClientpp</code></strong> in the text. If this is found, the test returns a WARNING, and if two or more matching events are found, the return value is CRITICAL. The <strong class="userinput"><code>descriptions</code></strong> switch here ensures that not only the name of the source, but the entire text is displayed. In addition, there is the <strong class="userinput"><code>truncate</code></strong> parameter, which restricts the entire output that is returned to <strong class="userinput"><code>check_nrpe</code></strong>.</p>

        <p>When using <strong class="userinput"><code>CheckEventLog</code></strong>, the expression "practice makes perfect" applies. If you filter too unspecifically, so that <strong class="userinput"><code>CheckEventLog</code></strong> has to process too many event entries, strange side effects may occur. The message <strong class="userinput"><code>UNKNOWN: No handler for that command</code></strong> is sometimes shown, although the reason for this is actually a buffer overflow. In case of doubt, you should switch on debugging for NSClient++ (don't forget to stop/start) and examine the log file, which is in the same directory as the executable program and the INI file, for relevant error entries. Further information on <strong class="userinput"><code>CheckEventLog</code></strong> is contained in the Wiki.<sup>[<a class="footnote" href="#ftn.CHP-20-FN-32" id="CHP-20-FN-32">259</a>]</sup>.</p>
      </div>

      <div class="sect3" title="The debug functions CheckAlwaysOK, CheckAlwaysWARNING, and CheckAlwaysCRITICAL">
        <div class="titlepage">
          <h3 class="title" id="heading_id_19"><a id="the_debug_functions_checkalwaysok_comma"/>The debug functions <strong class="userinput"><code>CheckAlwaysOK</code></strong>, <strong class="userinput"><code>CheckAlwaysWARNING</code></strong>, and <strong class="userinput"><code>CheckAlwaysCRITICAL</code></strong></h3>
        </div>

        <p>The functions <strong class="userinput"><code>CheckAlwaysOK</code></strong>, <strong class="userinput"><code>CheckAlwaysWARNING</code></strong>, and <strong class="userinput"><code>CheckAlwaysCRITICAL</code></strong> are used for debugging purposes and always return the same status. Their use is relatively simple: The chosen debugging function is simply inserted in front of a normally defined function, such as <strong class="userinput"><code>CheckFileSize</code></strong>:<a class="indexterm" id="IDX-CHP-20-1883"/><a class="indexterm" id="IDX-CHP-20-1884"/><a class="indexterm" id="IDX-CHP-20-1885"/><a class="indexterm" id="IDX-CHP-20-1886"/><a class="indexterm" id="IDX-CHP-20-1887"/></p><a id="I_programlisting1_d1e44797"/>
        <pre class="programlisting">CheckAlwaysOK CheckFileSize ...</pre>
      </div>

      <div class="sect3" title="Summarizing several checks with CheckMultiple">
        <div class="titlepage">
          <h3 class="title" id="heading_id_20"><a id="summarizing_several_checks_with"/>Summarizing several checks with <strong class="userinput"><code>CheckMultiple</code></strong></h3>
        </div>

        <p>If several checks need to be summarized into one single check, <strong class="userinput"><code>Check-Multiple</code></strong> is used:<a class="indexterm" id="IDX-CHP-20-1888"/></p><a id="I_programlisting1_d1e44812"/>
        <pre class="programlisting">CheckMultiple command=CheckFileSize ... command=CheckUpTime ... command=...</pre>

        <p>All individual checks are written one after another, each beginning with <strong class="userinput"><code>command=</code></strong>. Quotation marks in the style of <strong class="userinput"><code>command=""</code></strong> are not required. The highest error value that occurs in the individual checks is returned as the result.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-22" id="ftn.CHP-20-FN-22">249</a>]</sup> To execute scripts remotely on a Windows server, you can also use the Windows version of the Secure Shell, a topic that is too large to go into in this book.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-23" id="ftn.CHP-20-FN-23">250</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/77;139">http://www.nagiosexchange.org/77;139</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-24" id="ftn.CHP-20-FN-24">251</a>]</sup> <a class="ulink" href="http://sourceforge.net/project/showfiles.php?group_id=83239">http://sourceforge.net/project/showfiles.php?group_id=83239</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-25" id="ftn.CHP-20-FN-25">252</a>]</sup> The line break in Unix consists of only a line feed character, whereas Windows text files have a line break consisting of the two characters carriage return and line feed.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-26" id="ftn.CHP-20-FN-26">253</a>]</sup> This security measure, however, is restricted to a simple comparison of IP addresses.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-27" id="ftn.CHP-20-FN-27">254</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/NRPE_Plugins.66.0.html">http://www.nagiosexchange.org/NRPE_Plugins.66.0.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-28" id="ftn.CHP-20-FN-28">255</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/49;63">http://www.nagiosexchange.org/49;63</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-29" id="ftn.CHP-20-FN-29">256</a>]</sup> The Cygwin tools contain a large number of GNU tools, including a compiler, libraries, and shells—all for Windows. This means that many Unix programs can be ported to Windows directly. The necessary files normally require only the Cygwin DLL (<strong class="userinput"><code>cygwin1.dll</code></strong>).</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-30" id="ftn.CHP-20-FN-30">257</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/Networking.53.0.html">http://www.nagiosexchange.org/Networking.53.0.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-31" id="ftn.CHP-20-FN-31">258</a>]</sup> <a class="ulink" href="http://www.activestate.com/store/languages/register.plex?id=ActivePerl">http://www.activestate.com/store/languages/register.plex?id=ActivePerl</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-20-FN-32" id="ftn.CHP-20-FN-32">259</a>]</sup> <a class="ulink" href="http://trac.nakednuns.org/nscp/wiki/CheckEventLog/CheckEventLog">http://trac.nakednuns.org/nscp/wiki/CheckEventLog/CheckEventLog</a></p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;21.&#xA0;Monitoring Room Temperature and Humidity">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_room_temperature_and_humidity"/>Chapter 21. Monitoring Room Temperature and Humidity</h1>
    </div>

    <p>There are a number of sensors for monitoring room temperature and humidity. Most of them are integrated into the network as independent network devices, and are normally addressed via SNMP.<a class="indexterm" id="IDX-CHP-21-1889"/></p>

    <p>But you have to spend at least three hundred dollars on your first sensor. Searching for a cheaper and modular system, the author finally came across <a class="ulink" href="http://www.pcmeasure.com/">http://www.pcmeasure.com/</a>; it has met all his requirements until now.</p>

    <p>The fact that this chapter is restricted to this sensor is not meant to detract from other systems, but is down to the fact that this topic alone would be enough for a separate book.</p>

    <div class="sect1" title="21.1 Sensors and Software">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="sensors_and_software"/>21.1 Sensors and Software</h1>
      </div>

      <p>A complete monitoring system for physical data normally consists of three components: a sensor (for temperature or humidity for example), an adapter to connect to the serial or parallel port of a PC, and software to query the sensor.<sup>[<a class="footnote" href="#ftn.CHP-21-FN-1" id="CHP-21-FN-1">260</a>]</sup><a class="indexterm" id="IDX-CHP-21-1890"/><a class="indexterm" id="IDX-CHP-21-1891"/><a class="indexterm" id="IDX-CHP-21-1892"/></p>

      <p>There are adapters for the PCMeasure system in variations from one to four sensors, which can be operated simultaneously. For the power supply the adapters need an available USB interface; alternatively a separate "USB power supply" is available. Instead of the adapter solution, there is also an optionally available Ethernet box with four sensor connections, which is somewhat more expensive, that can be expanded to accept 12 sensors.</p>

      <p>The measurement querying software PCMeasure is available for both Linux and Windows.<sup>[<a class="footnote" href="#ftn.CHP-21-FN-2" id="CHP-21-FN-2">261</a>]</sup> Some features are exclusive to the Windows version, which is why it is slightly more expensive. For use with Nagios, the Linux version is totally sufficient, since only the measurement values are transmitted over a simple network protocol.</p>

      <p>The sensors themselves are interesting: as well as those for temperature and humidity (as well as combinations of the two) there is also a contact sensor, a smoke and water alarm, a movement detector, and voltage detectors. These are normally connected with a twisted-pair cable (RJ45 connector); according to the FAQ,<sup>[<a class="footnote" href="#ftn.CHP-21-FN-3" id="CHP-21-FN-3">262</a>]</sup> they can be used up to 100 meters from the adapter or Ethernet box, provided you have good cables, that is, throughout a building.<a class="indexterm" id="IDX-CHP-21-1893"/><a class="indexterm" id="IDX-CHP-21-1894"/><a class="indexterm" id="IDX-CHP-21-1895"/></p>

      <div class="sect2" title="21.1.1 The PCMeasure software for Linux">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="the_pcmeasure_software_for_linu"/>21.1.1 The <strong class="userinput"><code>PCMeasure</code></strong> software for Linux</h2>
        </div>

        <p>The tar archive <strong class="userinput"><code>pcmeasure.tar.gz</code></strong> with the Linux software is unpacked in its own directory, such as <strong class="userinput"><code>/usr/local/pcmeasure</code></strong>. The configuration file <strong class="userinput"><code>pcmeasure41in.ux.cfg</code></strong> is also installed here. The port entries in this file need to be adjusted so that only those ports are listed to which a sensor is actually connected:</p><a id="I_programlisting2_d1e44895"/>
        <pre class="programlisting">[ports]
com1.1=01</pre>

        <p><strong class="userinput"><code>com1</code></strong> stands for the first serial port; if you are using the first parallel port instead, the entry before the period is <strong class="userinput"><code>lpt1</code></strong>. The digit following the port refers to the adapter slot used by the sensor, so depending on how many adapters you have, this is a number from <strong class="userinput"><code>1</code></strong> to <strong class="userinput"><code>4</code></strong>. The = sign is followed by the sensor type: <strong class="userinput"><code>01</code></strong> stands for a temperature sensor, <strong class="userinput"><code>03</code></strong> for a humidity sensor. An additional humidity sensor on the second slot of the same adapter would then be addressed as <strong class="userinput"><code>coml.2=03</code></strong>.</p>

        <p>The query program <strong class="userinput"><code>pcmeasure</code></strong> requires the configuration file to be specified as an argument:</p><a id="I_programlisting2_d1e44925"/>
        <pre class="programlisting">linux:local/pcmeasure # <span class="strong"><strong>./pcmeasure ./pcmeasure4linux.cfg</strong></span></pre>

        <p>It runs as a daemon in the background and only ends if it is terminated with <strong class="userinput"><code>kill</code></strong>. In principle, any user can start it who has read permissions for the corresponding interface.</p>
      </div>

      <div class="sect2" title="21.1.2 The query protocol">
        <div class="titlepage">
          <h2 class="title" id="heading_id_5"><a id="the_query_protocol"/>21.1.2 The query protocol</h2>
        </div>

        <p>The software opens TCP port 4000 by default and accepts requests from the network. The protocol used is quite simple: you send a text in the format<a class="indexterm" id="IDX-CHP-21-1896"/></p><a id="I_programlisting2_d1e44942"/>
        <pre class="programlisting">pcmeasure.<span class="emphasis"><em>interface.slot</em></span>&lt;CR&gt;&lt;LF&gt;</pre>

        <p>(that is, with a DOS line ending) and you receive a response in the format</p><a id="I_programlisting2_d1e44949"/>
        <pre class="programlisting"><span class="emphasis"><em>port</em></span>;valid=<span class="emphasis"><em>validity</em></span>;value=<span class="emphasis"><em>value</em></span>;...</pre>

        <p>The <span class="emphasis"><em>validity</em></span> placeholder is replaced by a <strong class="userinput"><code>1</code></strong> for a valid value or <strong class="userinput"><code>0</code></strong> for an invalid one. The port specification complies with the internal numbering system: <strong class="userinput"><code>lpt1.1</code></strong> corresponds to <strong class="userinput"><code>port1</code></strong>, <strong class="userinput"><code>com1.1</code></strong> to <strong class="userinput"><code>port13</code></strong>. Whether everything functions correctly or not can be tested with <strong class="userinput"><code>telnet</code></strong>:</p><a id="I_programlisting2_d1e44986"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>telnet localhost 4000</strong></span>
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
<span class="strong"><strong>pcmeasure.com1.1</strong></span>
port13;valid=1;value=22.59;counter0=10627;counter1=14373;
Connection closed by foreign host.</pre>

        <p>The current temperature in this example is 22.59°C, and the value is valid.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-21-FN-1" id="ftn.CHP-21-FN-1">260</a>]</sup> The PCMeasure Web site showed the following prices as of February 2008: simple temperature sensor 30101, $36; serial single-port adapter 30201 $51; Linux software, $38 (Windows: $53).</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-21-FN-2" id="ftn.CHP-21-FN-2">261</a>]</sup> The access data for the download comes with the invoice.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-21-FN-3" id="ftn.CHP-21-FN-3">262</a>]</sup> <a class="ulink" href="http://www.pcmeasure.com/faq.php">http://www.pcmeasure.com/faq.php</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="21.2 The Nagios Plugin check_pcmeasure2.pl">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_nagios_plugin_check_underscore_pcme"/>21.2 The Nagios Plugin check_pcmeasure2.pl</h1>
    </div>

    <p>The plugin <strong class="userinput"><code>check_pcmeasure2.pl</code></strong><sup>[<a class="footnote" href="#ftn.CHP-21-FN-4" id="CHP-21-FN-4">263</a>]</sup> allows a single sensor to be queried across a network. In exceptional cases—when measuring air pressure, for example—one call may also query two sensors. The plugin replaces <strong class="userinput"><code>check_pcmeasure.pl</code></strong> and uses the Perl module <strong class="userinput"><code>Nagios::Plugin</code></strong> to correctly represent the thresholds (see <a class="xref" href="../Text/ch24.html#specifying_thresholds" title="24.1.5 Specifying thresholds">24.1.5 Specifying thresholds</a>, page 557). The older <strong class="userinput"><code>check_pc-measure.pl</code></strong> is still available under the same link, but is no longer maintained by the author.<a class="indexterm" id="IDX-CHP-21-1901"/><a class="indexterm" id="IDX-CHP-21-1898"/><a class="indexterm" id="IDX-CHP-21-1899"/><a class="indexterm" id="IDX-CHP-21-1900"/><a class="indexterm" id="IDX-CHP-21-1897"/></p>

    <p>Apart from the usual standard options, <strong class="userinput"><code>-h</code></strong> (online help), <strong class="userinput"><code>-t</code></strong> (timeout), <strong class="userinput"><code>-V</code></strong> (displays the version), and <strong class="userinput"><code>-v</code></strong> (<span class="emphasis"><em>verbose</em></span>, additional information when looking for errors), <strong class="userinput"><code>check_pcmeasure2.pl</code></strong> has the following options:</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> / <strong class="userinput"><code>--host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

        <dd>
          <p>This is the host name or IP address of the measuring computer on which the software is running and to which the sensors are connected, or the IP address or host name of the Ethernet box.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-S</code></strong> <strong class="userinput"><code><em class="replaceable"><code>sensor</code></em></code></strong> / <strong class="userinput"><code>--sensor=</code></strong><strong class="userinput"><code><em class="replaceable"><code>sensor</code></em></code></strong></span></dt>

        <dd>
          <p>This switch defines the sensor, such as <strong class="userinput"><code>coml.1</code></strong> or <strong class="userinput"><code>lpt1.2</code></strong> (see above). When querying air pressure values, you need two sensors, which are separated by a comma when specified: <strong class="userinput"><code>--sensor=com1.1</code></strong>, <strong class="userinput"><code>com1.2</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> / <strong class="userinput"><code>--port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

        <dd>
          <p>This specifies an alternative TCP port for the software or for the Ethernet box. The default is port 4000.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>thresholds</code></em></code></strong> / <strong class="userinput"><code>--warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>thresholds</code></em></code></strong></span></dt>

        <dd>
          <p>If the measured value lies outside the warning range specified here (e.g., <strong class="userinput"><code>-w 18.0:22.0</code></strong>, see <a class="xref" href="../Text/ch24.html#specifying_thresholds" title="24.1.5 Specifying thresholds">24.1.5 Specifying thresholds</a> from page 557), <strong class="userinput"><code>check_pc-measure2.pl</code></strong> sets off a warning.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong> / <strong class="userinput"><code>--critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong></span></dt>

        <dd>
          <p>This defines the critical threshold; see <strong class="userinput"><code>-w</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-T</code></strong> <strong class="userinput"><code><em class="replaceable"><code>sensor type</code></em></code></strong> / <strong class="userinput"><code>--type=</code></strong><strong class="userinput"><code><em class="replaceable"><code>sensor type</code></em></code></strong></span></dt>

        <dd>
          <p>This specifies the sensor type for sensors with special requirements. Types currently implemented are <strong class="userinput"><code>brightness</code></strong>, <strong class="userinput"><code>barometer</code></strong> (this needs two sensors to be specified in <strong class="userinput"><code>--sensor</code></strong>), and <strong class="userinput"><code>standard</code></strong> (the default).</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-R</code></strong> <strong class="userinput"><code><em class="replaceable"><code>file</code></em></code></strong> / <strong class="userinput"><code>--rrd-database=</code></strong><strong class="userinput"><code><em class="replaceable"><code>file</code></em></code></strong></span></dt>

        <dd>
          <p>This option specifies the round-robin database to save measured values independently of Nagios. The file must be writable for the user <strong class="userinput"><code>nagios</code></strong>. If this is missing, the plugin will create it again.</p>

          <p>In order to work with a round-robin database (see <a class="xref" href="../Text/ch19s02.html" title="19.2 Graphs for the Web with Nagiosgraph">19.2 Graphs for the Web with Nagiosgraph</a>) you need the Perl module <strong class="userinput"><code>RRDs</code></strong> used by the plugin, from the RRDtools.<sup>[<a class="footnote" href="#ftn.CHP-21-FN-5" id="CHP-21-FN-5">264</a>]</sup> The plugin automatically detects whether or not the module is available. If it is missing, it does not save the data separately.</p>
        </dd>
      </dl>
    </div>

    <p>In the following example the plugin asks for the temperature of the sensor connected to the host with the IP address <strong class="userinput"><code>192.168.1.199</code></strong>:</p><a id="I_programlisting2_d1e45237"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_pcmeasure2.pl -H 192.168.1.199</strong></span> \
<span class="strong"><strong>    -S com1.1 -w 18.0:22.0 -c 16.0:24.0</strong></span>
WARNING: Value com1.1: 23.5 |value=23.5;18.0:22.0;16.0:24.0;</pre>

    <p>Since the measured value lies above the warning limit of 22.0°C, but below the critical limit of 24°C, there is a WARNING. The interval details correspond to those in the figure in <a class="xref" href="../Text/ch24.html#specifying_thresholds" title="24.1.5 Specifying thresholds">24.1.5 Specifying thresholds</a>.</p>

    <p>The corresponding Nagios command can be specified with or without a round-robin database:</p><a id="I_programlisting2_d1e45251"/>
    <pre class="programlisting">define command{
    command_name<span class="strong"><strong>   check_temp_max</strong></span>
    command_line   $USER1$/<span class="strong"><strong>check_pcmeasure2.pl</strong></span> -H $HOSTADDRESS$ -S $ARG1$
-w $ARG2$ -c $ARG3$
}
define command{
    command_name<span class="strong"><strong>   check_temp_max_rrd</strong></span>
    command_line   $USER1$/<span class="strong"><strong>check_pcmeasure2.pl</strong></span> -H $HOSTADDRESS$ -S $ARG1$
-w $ARG2$ -c $ARG3$ -R $ARG4$
}</pre>

    <p>Without a RRD, you only need to specify the maximum and critical warning limits, apart from the sensor details. In the second example the RRD file predefined in <strong class="userinput"><code>$ARG4$</code></strong> saves the measured data. The following service uses the file <strong class="userinput"><code>/var/lib/rrd/temperatur-serverroom1.rrd</code></strong> for this purpose:</p><a id="I_programlisting2_d1e45273"/>
    <pre class="programlisting">define service{
    host_name             linux01
    service_description   Room temperature
    max_check_attempts    1
    normal_check_interval 2
 <span class="strong"><strong>   check_command check_temp_max_rrd!com1.1!18.0:22.0!16.0:24.0!/var/lib</strong></span>
<span class="strong"><strong>/rrd/temperatur-serverroom1.rrd</strong></span>

  ...
}</pre>

    <p>With <strong class="userinput"><code>max_check_attempts</code></strong> set to <strong class="userinput"><code>1</code></strong>, Nagios does <span class="emphasis"><em>not</em></span> repeat the query in case of an error at intervals of <strong class="userinput"><code>retry_check_interval</code></strong>. Instead the temperature is measured constantly every two minutes.</p>

    <p>Since room temperatures normally change very slowly, you could use a <strong class="userinput"><code>normal_check_interval</code></strong> of five minutes. If you choose larger measuring intervals, you can set <strong class="userinput"><code>max_check_attempts</code></strong> to a value greater than <strong class="userinput"><code>1</code></strong> and repeat the measurement at shorter intervals in case of errors (e.g., <strong class="userinput"><code>retry_check_interval 1</code></strong>).</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-21-FN-4" id="ftn.CHP-21-FN-4">263</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/60;575">http://www.nagiosexchange.org/60;575</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-21-FN-5" id="ftn.CHP-21-FN-5">264</a>]</sup> <a class="ulink" href="http://www.rrdtool.org/">http://www.rrdtool.org/</a></p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;22.&#xA0;Monitoring SAP Systems">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_sap_systems"/>Chapter 22. Monitoring SAP Systems</h1>
    </div>

    <p>There are several ways of monitoring an SAP system. The simplest is just to check the ports on which the corresponding SAP services are running. Normally these are TCP ports 3200/3300 for system number <strong class="userinput"><code>00</code></strong>, 3201/3301 for system number <strong class="userinput"><code>01</code></strong> etc. This can be done with the generic plugin described in <a class="xref" href="../Text/ch06s09.html#testing_tcp_ports" title="6.7.1 Testing TCP ports">6.7.1 Testing TCP ports</a>, page 132. But it is possible that no user is able to log in even though the port is reachable, because SAP-internal services fail, making it impossible to work with the system.<a class="indexterm" id="IDX-CHP-22-1902"/></p>

    <p>To really test the complex interaction of various SAP components, you require a program that communicates on an application layer with the SAP system. There are two alternatives here: the more simple one uses the program <strong class="userinput"><code>sapinfo</code></strong>, which queries the available information without a direct login—like the SAP-GUI at the start. With somewhat more effort you can communicate with the SAP system over an SAP standard interface. This is no use, however, unless you have an SAP login with corresponding permissions. With the <span class="emphasis"><em>Computing Center Management System</em></span> (CCMS), SAP provides its own internal monitoring system, which can also be queried with the RFC<sup>[<a class="footnote" href="#ftn.CHP-22-FN-1" id="CHP-22-FN-1">265</a>]</sup> interface, and which can be put to excellent use in Nagios, with the right plugins.<a class="indexterm" id="IDX-CHP-22-1903"/></p>

    <div class="sect1" title="22.1 Checking without a Login: sapinfo">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="checking_without_a_login_colon_sapinfo"/>22.1 Checking without a Login: sapinfo</h1>
      </div>

      <p>The program <strong class="userinput"><code>sapinfo</code></strong> is part of an optional software package for the development of client-side RFC interfaces. The Linux version which you require, <strong class="userinput"><code>RFC_0PT_46C.SAR</code></strong>, can be obtained either at <a class="ulink" href="ftp://ftp.sap.com/pub/linuxlab/contrib/">ftp://ftp.sap.com/pub/linuxlab/contrib/</a>, or you can log in to the <span class="emphasis"><em>SAP Service Marketplace</em></span> at <a class="ulink" href="http://service.sap.com/">http://service.sap.com/</a> (a password is required for this) and use the search help there to look for the keyword <strong class="userinput"><code>RFC-SDK</code></strong>. Information is also provided by the SAP notes 413708 (at present the current RFC library), 27517 (installation of the RFC SDK), and 212876 (the new archiving tool SAPCAR).<a class="indexterm" id="IDX-CHP-22-1904"/><a class="indexterm" id="IDX-CHP-22-1905"/></p>

      <div class="sect2" title="22.1.1 Installation">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="installation-id10"/>22.1.1 Installation</h2>
        </div>

        <p>SAP has its own archiving format in which the precompiled software is stored. To unpack programs you require the program <strong class="userinput"><code>SAPCAR</code></strong>, which can also be obtained through the FTP link mentioned or through the SAP Service Marketplace. It is operated in a way similar to tar:</p><a id="I_programlisting3_d1e45383"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>mkdir /usr/local/sap</strong></span>
linux:~ # <span class="strong"><strong>cd /usr/local/sap</strong></span>
linux:local/sap # <span class="strong"><strong><span class="emphasis"><em>/path/to/</em></span>SAPCAR -xvf RFC_OPT_46C.SAR</strong></span>
SAPCAR: processing archive RFC_OPT_46C.SAR
x rfcsdk
x rfcsdk/bin
x rfcsdk/bin/sapinfo
...</pre>

        <p>The data contained in the archive lands in its own subdirectory, <strong class="userinput"><code>rfcsdk</code></strong>. If you run <strong class="userinput"><code>SAPCAR</code></strong> without any parameters, a short operating manual is displayed.</p>
      </div>

      <div class="sect2" title="22.1.2 First test">
        <div class="titlepage">
          <h2 class="title" id="heading_id_5"><a id="first_test"/>22.1.2 First test</h2>
        </div>

        <p>The program <strong class="userinput"><code>sapinfo</code></strong> can be tested now without further configuration. To do this you require the so-called <span class="emphasis"><em>connect string;</em></span> if the connection is running through an SAP gateway, this is a string such as <strong class="userinput"><code>/H/</code></strong><strong class="userinput"><code><em class="replaceable"><code>ip_of_the_sap-gate-way</code></em></code></strong><strong class="userinput"><code>/S/3297/H/</code></strong><strong class="userinput"><code><em class="replaceable"><code>ip_of_the_sap_system</code></em></code></strong>; without a gateway you simply specify an IP address or a host name that can be resolved, instead of this complex expression. In case of doubt, the administrator responsible for the SAP system will reveal the exact connect string. In addition you must specify the system number,<sup>[<a class="footnote" href="#ftn.CHP-22-FN-2" id="CHP-22-FN-2">266</a>]</sup> in this example, <strong class="userinput"><code>01</code></strong>:<a class="indexterm" id="IDX-CHP-22-1906"/><a class="indexterm" id="IDX-CHP-22-1907"/></p><a id="I_programlisting3_d1e45444"/>
        <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>cd /usr/local/sap/rfcsdk/bin</strong></span>
nagios@linux:rfcsdk/bin$ <span class="strong"><strong>./sapinfo ashost=10.128.254.13 sysnr=01</strong></span>

SAP System Information
--------------------------------------------

Destination           p10ap013_P10_01
Host                  p10ap013
System ID             P10
Database              P10
DB host               P10DB012
DB system             ORACLE

SAP release           620
SAP kernel release    640

RFC Protokoll         011
Characters            1100 (NON UNICODE PCS=1)
Integers              LIT
Floating P.           IE3
SAP machine id        560

Timezone              3600</pre>

        <p>The output provides various information on the SAP installation, including the SAP release (<strong class="userinput"><code>620</code></strong>), the SAP system ID (<strong class="userinput"><code>P10</code></strong>), the host on which the database is located, and the database system used, which in this case is Oracle.</p>

        <p>With the <strong class="userinput"><code>ashost</code></strong> parameter you query a specific application server. For a message server, <strong class="userinput"><code>sapinfo</code></strong> requires the following details:</p><a id="I_programlisting3_d1e45468"/>
        <pre class="programlisting">nagios@linux:rfcsdk/bin$ <span class="strong"><strong>./sapinfo r3name=P10 mshost=10.128.254.12 \
    group=ISH</strong></span></pre>

        <p>The <strong class="userinput"><code>r3name</code></strong> parameter specifies the SAP system ID, <strong class="userinput"><code>mshost</code></strong> defines the IP address of the server, and <strong class="userinput"><code>group</code></strong> describes the logon group. As long as the <strong class="userinput"><code>PUBLIC</code></strong> group exists, you can leave this parameter out, and then the default, <strong class="userinput"><code>PUBLIC</code></strong>, will be used.</p>

        <p>If the query ends with an error message such as</p><a id="I_programlisting3_d1e45491"/>
        <pre class="programlisting">ERROR      service 'sapmsP10' unknown</pre>

        <p>then the definition of the <strong class="userinput"><code>sapmsP10</code></strong> service is missing for the Nagios server<sup>[<a class="footnote" href="#ftn.CHP-22-FN-3" id="CHP-22-FN-3">267</a>]</sup> in <strong class="userinput"><code>/etc/services</code></strong>:</p><a id="I_programlisting3_d1e45508"/>
        <pre class="programlisting">sapmsP10    3600/tcp</pre>

        <p>For the port you define the TCP port on which the message server is running. Which one this is depends on the particular SAP installation; the standard port is <strong class="userinput"><code>3600</code></strong>.</p>
      </div>

      <div class="sect2" title="22.1.3 The plugin check_sap.sh">
        <div class="titlepage">
          <h2 class="title" id="heading_id_6"><a id="the_plugin_check_underscore_sap.sh"/>22.1.3 The plugin <strong class="userinput"><code>check_sap.sh</code></strong></h2>
        </div>

        <p>The plugin <strong class="userinput"><code>check_sap.sh</code></strong>, a shell script based on <strong class="userinput"><code>sapinfo</code></strong>, is included in the standard Nagios Plugins package, but it is in the <strong class="userinput"><code>contrib</code></strong> directory and is not automatically installed. You can copy it manually to the plugin directory:<a class="indexterm" id="IDX-CHP-22-1909"/><a class="indexterm" id="IDX-CHP-22-1908"/></p><a id="I_programlisting3_d1e45540"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>cp /usr/local/src/nagios-plugins-1.4/contrib/check_sap.sh \
   /usr/local/nagios/libexec/</strong></span>.</pre>

        <p>Then you look in the plugin for the variable <strong class="userinput"><code>sapinfocmd</code></strong> and adjust the path for <strong class="userinput"><code>sapinfo</code></strong>:</p><a id="I_programlisting3_d1e45553"/>
        <pre class="programlisting">sapinfocmd='/usr/local/sap/rfcsdk/bin/sapinfo'</pre>

        <p>If the plugin <strong class="userinput"><code>sapinfo</code></strong> is not found at the location given here, <strong class="userinput"><code>check_sap.sh</code></strong> will write an error message to STDERR, but if no error occurrs, you will receive an OK message on STDOUT and the return value <strong class="userinput"><code>0</code></strong>:</p><a id="I_programlisting3_d1e45566"/>
        <pre class="programlisting">./check_sap.sh: line 79: /usr/sap/rfcsdk/bin/sapinfo: No such file or directory
OK - SAP server available.</pre>

        <p>Like <strong class="userinput"><code>sapinfo</code></strong>, the plugin can be run in two ways: with the argument <strong class="userinput"><code>as</code></strong> it queries an application server, and with <strong class="userinput"><code>ms</code></strong>, a message server. The second argument in each case is the connect string, and if no SAP gateway is used, then it is the IP address or the host name of the host to be queried:</p><a id="I_programlisting3_d1e45579"/>
        <pre class="programlisting">check_sap.sh as <span class="emphasis"><em>connect_string system_number</em></span>
check_sap.sh ms <span class="emphasis"><em>connect_string SID logon_group</em></span></pre>

        <p>The first variation demands the two-digit system number of the application server as the third parameter, the counting of which starts at <strong class="userinput"><code>00</code></strong>:</p><a id="I_programlisting3_d1e45591"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_sap.sh as 10.128.254.13 01</strong></span>
OK - SAP server p10ap013_P10_01 available.</pre>

        <p>This means that the application server running on the host <strong class="userinput"><code>10.128.254.13</code></strong> is available.</p>

        <p>When the message server is queried, the plugin displays the application server belonging to the specified login group (given as the fourth argument). If this information is missing, it determines the application server for the <strong class="userinput"><code>PUBLIC</code></strong> group.</p>

        <p>For a message server, you specify the SAP system ID (<span class="emphasis"><em>SID</em></span>), for example, <strong class="userinput"><code>P10</code></strong>,<sup>[<a class="footnote" href="#ftn.CHP-22-FN-4" id="CHP-22-FN-4">268</a>]</sup> instead of the system number:</p><a id="I_programlisting3_d1e45619"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_sap.sh ms 10.128.254.12 P10 ISH</strong></span>
OK - SAP server p10ap014_P10_02 available.</pre>

        <p>In this example the message server running on <strong class="userinput"><code>10.128.254.12</code></strong> detects <strong class="userinput"><code>p10ap014_P10_02</code></strong> as the application server for the logon group <strong class="userinput"><code>ISH</code></strong> and also reveals that this is reachable.</p>

        <p>The following two command definitions assume that it is sufficient to use the IP address, and that no SAP connect string is required:</p><a id="I_programlisting3_d1e45637"/>
        <pre class="programlisting">define command{
    command_name<span class="strong"><strong>   check_sap_as</strong></span>
    command_line   $USER1$/<span class="strong"><strong>check_sap.sh</strong></span> as $HOSTADDRESS$ $ARG1$
}
define command{
    command_name<span class="strong"><strong>   check_sap_ms</strong></span>
    command_line   $USER1$/<span class="strong"><strong>check_sap.sh</strong></span> ms $HOSTADDRESS$ $ARG1$ $ARG2$
}</pre>

        <p>If this is not the case, the <strong class="userinput"><code>command_line</code></strong> for querying an application server could look like this:</p><a id="I_programlisting3_d1e45656"/>
        <pre class="programlisting">$USER1$/<span class="strong"><strong>check_sap.sh</strong></span> as /H/sapgw/S/3297/H/$HOSTADDRESS$ $ARG1$</pre>

        <p>The following service definition can be used for all application servers:</p><a id="I_programlisting3_d1e45663"/>
        <pre class="programlisting">define service{
    service_description    SAP_AS
    host_name              sap01
    <span class="strong"><strong>check_command</strong></span>      <span class="strong"><strong>check_sap_as!00</strong></span>
    ...
}</pre>

        <p>Since there is only a single message server in an SAP system, it makes more sense to define a separate service for each logon group. The following example shows this for the group <strong class="userinput"><code>ISH</code></strong>:</p><a id="I_programlisting3_d1e45677"/>
        <pre class="programlisting">define service{
    service_description    SAP_MS_ISH
    host_name              sap09
    <span class="strong"><strong>check_command</strong></span>   <span class="strong"><strong>check_sap_ms!P10!ISH</strong></span>
    ...
}</pre>

        <p>In this way you can test whether a user may log in without actually logging in. If there are interruptions between the database and the application server that make it impossible to log in, <strong class="userinput"><code>sapinfo</code></strong> provides a corresponding error message after a timeout. The author was able to observe several times that <strong class="userinput"><code>sapinfo</code></strong> and <strong class="userinput"><code>check_sap.sh</code></strong> reported an error in such a situation, while the TCP port-only test of the application server, <strong class="userinput"><code>check_tcp</code></strong>, returned an OK, although no user could log in any longer. So <strong class="userinput"><code>check_sap.sh</code></strong>, even without a login, provides more reliable information than a port-only check.<a class="indexterm" id="IDX-CHP-22-1910"/></p>
      </div>

      <div class="sect2" title="22.1.4 More up to date and written in Perl: check_sap.pl">
        <div class="titlepage">
          <h2 class="title" id="heading_id_7"><a id="more_up_to_date_and_written_in_perl_col"/>22.1.4 More up to date and written in Perl: <strong class="userinput"><code>check_sap.pl</code></strong></h2>
        </div>

        <p><strong class="userinput"><code>check_sap.sh</code></strong> is not only getting on in years, it is apparently also no longer maintained, so once in a blue moon you just have to put up with the fact that it returns an OK, even when there is an error. The author of this book has therefore written his own version of the plugin in Perl and made this available on NagiosExchange.<sup>[<a class="footnote" href="#ftn.CHP-22-FN-5" id="CHP-22-FN-5">269</a>]</sup> As befits a reputable Perl plugin, it uses the Perl module <strong class="userinput"><code>Nagios::Plugin</code></strong> (more on this in <a class="xref" href="../Text/ch24s02.html" title="24.2 The Perl Module Nagios::Plugin">24.2 The Perl Module Nagios::Plugin</a> from page 560), parses the command line with <strong class="userinput"><code>Getopt::Long</code></strong> (<a class="xref" href="../Text/ch25.html#splitting_up_the_command_line_with_getop" title="25.1 Splitting up the Command Line With Getopt::Long">25.1 Splitting up the Command Line With Getopt::Long</a>, page 565), and includes integrated online help.<a class="indexterm" id="IDX-CHP-22-1912"/><a class="indexterm" id="IDX-CHP-22-1911"/></p>

        <p>The plugin <strong class="userinput"><code>check_sap.pl</code></strong> also uses <strong class="userinput"><code>sapinfo</code></strong> (<a class="xref" href="../Text/ch22.html#checking_without_a_login_colon_sapinfo" title="22.1 Checking without a Login: sapinfo">22.1 Checking without a Login: sapinfo</a>) and has the following options:</p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>--ashost=</code></strong><strong class="userinput"><code><em class="replaceable"><code>connect_string</code></em></code></strong></span></dt>

            <dd>
              <p>Tests the application server. A connect string (<a class="xref" href="../Text/ch21s02.html" title="21.2 The Nagios Plugin check_pcmeasure2.pl">21.2 The Nagios Plugin check_pcmeasure2.pl</a>) must be specified, which in the simplest case is the IP address of the application server. The test needs an SAP system number to be given at the same time, with <strong class="userinput"><code>--sap-sysnr</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>--mshost=</code></strong><strong class="userinput"><code><em class="replaceable"><code>connect_string</code></em></code></strong></span></dt>

            <dd>
              <p>Tests the message server. A connect string is expected, as with <strong class="userinput"><code>--ashost</code></strong>, and you also need to specify at least the SAP-SID of the system (e.g., <strong class="userinput"><code>P10</code></strong>). The test uses a logon group, and the default is PUBLIC. If this is not available in the SAP system, you must specify the group in question with <strong class="userinput"><code>--group</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>--sap-sysnr=</code></strong><strong class="userinput"><code><em class="replaceable"><code>system_number</code></em></code></strong></span></dt>

            <dd>
              <p>Defines the system number for the test of an application server. Normally the system number begins counting upwards from 00 for the first application server. In case of doubt, you should ask your SAP administrator for the correct system number.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>--sap-id=</code></strong><strong class="userinput"><code><em class="replaceable"><code>sid</code></em></code></strong></span></dt>

            <dd>
              <p>Defines the SAP-SID for the overall system for the test of the message server. In case of doubt, you should also ask your SAP administrator about this parameter.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>--group=</code></strong><strong class="userinput"><code><em class="replaceable"><code>logon group</code></em></code></strong></span></dt>

            <dd>
              <p>Defines the logon group that is to be used for the test of the message server. This must exist in the SAP system, otherwise the message server test will fail. The default is <strong class="userinput"><code>PUBLIC</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>--sapinfo=</code></strong><strong class="userinput"><code><em class="replaceable"><code>path_to_sapinfo</code></em></code></strong></span></dt>

            <dd>
              <p>Specifies the path to the program <strong class="userinput"><code>sapinfo</code></strong>. The default is <strong class="userinput"><code>/usr/local/sap/rfcsdk/bin/sapinfo</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-h</code></strong> / <strong class="userinput"><code>--help</code></strong></span></dt>

            <dd>
              <p>Displays the online help.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-V</code></strong> / <strong class="userinput"><code>--version</code></strong></span></dt>

            <dd>
              <p>Shows the version and the license conditions of the plugin (GPLv2).</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-v</code></strong> / <strong class="userinput"><code>--verbose</code></strong></span></dt>

            <dd>
              <p>Increases the verbosity of the plugin. This option can be given several times, to make the output increasingly extensive.</p>
            </dd>
          </dl>
        </div>

        <p>The following example tests an application server with the SAP system number <strong class="userinput"><code>00</code></strong>:</p><a id="I_programlisting3_d1e45867"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_sap.pl--ashost=10.128.254.12 \
    --sap-sysnr=00</strong></span>
CHECKSAP OK - system p10db012_P10_00 available</pre>

        <p>To test the message server you require the SID instead of the system number and, in our case, a logon group as well, since the default logon group <strong class="userinput"><code>PUBLIC</code></strong> does not exist in the <strong class="userinput"><code>P10</code></strong> system:</p><a id="I_programlisting3_d1e45880"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_sap.pl--mshost=10.128.254.12</strong></span> \
<span class="strong"><strong>     --sap-id=P10 --group=ISH</strong></span>
CHECKSAP OK - system p10ap014_P10_02 available</pre>

        <p>In contrast to the example given for <strong class="userinput"><code>check_sap.sh</code></strong>, the definition of the command is kept very general:</p><a id="I_programlisting3_d1e45893"/>
        <pre class="programlisting">define command{
    command_name<span class="strong"><strong>   check_sap</strong></span>
    command_line   $USER1$/<span class="strong"><strong>check_sap.pl</strong></span> $ARG1$
}</pre>

        <p>Because of <strong class="userinput"><code>$ARG1$</code></strong>, a single command definition is sufficient for all checks, whether for application or message server, whether with or without an SAP connect string. The definition of the service for the test of an application server then looks like this:</p><a id="I_programlisting3_d1e45907"/>
        <pre class="programlisting">define service{
    service_description    SAP_AS
    host_name              sap01
    <span class="strong"><strong>check_command</strong></span>          <span class="strong"><strong>check_sap!--ashost=$HOSTADDRESS$--sap-sysnr=00</strong></span>
    ...
}</pre>

        <p>The service obtains the IP address of the host from the accompanying host definition via the <strong class="userinput"><code>$HOSTADDRESS$</code></strong> macro, so that the service definition works for an entire host group if you define the name of the host group with <strong class="userinput"><code>hostgroup_name</code></strong> instead of <strong class="userinput"><code>host_name</code></strong>. If an SAP connect string is required, you replace <strong class="userinput"><code>$HOSTADDRESS$</code></strong> with the connect string:</p><a id="I_programlisting3_d1e45929"/>
        <pre class="programlisting">check_sap!--ashost=/H/sapgw/S/3297/H/$HOSTADDRESS$ --sap-sysnr=00</pre>

        <p>In an SAP system there is just one message server, therefore the service check only makes sense for this one host. If there are several different logon groups, you define a separate service for each of these. The following example shows this for the group <strong class="userinput"><code>ISH</code></strong>:</p><a id="I_programlisting3_d1e45936"/>
        <pre class="programlisting">define service{
    service_description    SAP_MS_ISH
    host_name              sap00
    <span class="strong"><strong>check_command</strong></span>          <span class="strong"><strong>check_sap!--mshost=$HOSTADDRESS$--sap-id=P10 -</strong></span>
    <span class="strong"><strong>-group=ISH</strong></span>
    ...
}</pre>

        <p>Here it is also possible to add a connect string that might be required.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-1" id="ftn.CHP-22-FN-1">265</a>]</sup> <span class="emphasis"><em>Remote Function Call</em></span>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-2" id="ftn.CHP-22-FN-2">266</a>]</sup> The SAP administrator will also know this.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-3" id="ftn.CHP-22-FN-3">267</a>]</sup> Instead of <strong class="userinput"><code>P10</code></strong>, the appropriate system ID will always be shown here.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-4" id="ftn.CHP-22-FN-4">268</a>]</sup> The first instance of this has the system number 00, the second one, 01, etc.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-5" id="ftn.CHP-22-FN-5">269</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/21;744">http://www.nagiosexchange.org/21;744</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="22.2 Monitoring with SAP's Own Monitoring System CCMS">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_with_sap_apostrophy_s_own_mo"/>22.2 Monitoring with SAP's Own Monitoring System CCMS</h1>
    </div>

    <p>With SAP's own <span class="emphasis"><em>Computing Center Management System</em></span> framework (CCMS), not only SAP systems, but also external applications can be monitored. Here local agents collect data from each of the hosts, which, since Release R/3 4.6C,<sup>[<a class="footnote" href="#ftn.CHP-22-FN-6" id="CHP-22-FN-6">270</a>]</sup> can be queried from a central component. The data examined includes not only SAP-specific features such as SAP buffers or batch jobs, but also operating system data such as memory and CPU usage, or disk IO and swapping. Even information on the database used or the average response times of applications can be queried.<a class="indexterm" id="IDX-CHP-22-1913"/></p>

    <p>The data of the CCMS can also be queried externally through RFC (<span class="emphasis"><em>Remote Function Calls</em></span>, a standard SAP interface). Corresponding libraries for Unix and Windows platforms, with which a Linux program, for example, can query information from the CCMS over the network, are provided by SAP.</p>

    <div class="sect2" title="22.2.1 A short overview over the alert monitor">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="a_short_overview_over_the_alert_monitor"/>22.2.1 A short overview over the alert monitor</h2>
      </div>

      <p>Within the SAP world you gain access to this data through the CCMS Alert Monitor (transaction RZ20) (<a class="xref" href="../Text/ch22s02.html#the_sap_ccms_alert_monitor" title="Figure 22-1. The SAP CCMS Alert Monitor">Figure 22-1</a>). The illustration shows so-called monitor connections that categorize various information in groups.</p>

      <div class="figure">
        <a id="the_sap_ccms_alert_monitor"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e45979"/><img alt="The SAP CCMS Alert Monitor" src="../Images/tagoreillycom20081104nostarchimages223998.png.jpg"/></div>

        <p class="title">Figure 22-1. The SAP CCMS Alert Monitor</p>
      </div>

      <p>SAP provides several monitor collections with preconfigured values in its distribution. A trained SAP administrator can create and operate monitors at any time. We shall restrict ourselves here to the monitor collection <strong class="userinput"><code>SAP CCMS Monitor Templates</code></strong> and focus on the <span class="strong"><strong>Dialog Overview</strong></span> monitor (<a class="xref" href="../Text/ch22s02.html#the_sap_ccms_monitor_dialog_overview" title="Figure 22-2. The SAP CCMS monitor dialog Overview">Figure 22-2</a>).</p>

      <p>The dialog response times specified there (accessible through the <span class="emphasis"><em>monitor attribute</em></span> <strong class="userinput"><code>Dialog Response Time</code></strong>) provide a measurable equivalent for performance problems corresponding to what the user feels is a "slow system." This value specifies the average processing time of a transaction (without network transmission time and without the time needed to render the information in the GUI of the client).</p>

      <div class="figure">
        <a id="the_sap_ccms_monitor_dialog_overview"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e46005"/><img alt="The SAP CCMS monitor dialog Overview" src="../Images/tagoreillycom20081104nostarchimages224000.png.jpg"/></div>

        <p class="title">Figure 22-2. The SAP CCMS monitor dialog Overview</p>
      </div>

      <p>The monitor attribute <strong class="userinput"><code>Network Time</code></strong> reveals how much time the system needs to send data during a dialog stage from the client (the SAP GUI) to the SAP system and back again.</p>

      <p>For each of the attributes, the monitor shows which context defined in the SAP system—normally which SAP instance—is involved in the measured values specified. Most measurement parameters have a warning and a critical limit. If the value lies beneath the warning limit, the monitor displays the line in green; for monochrome devices the color is listed as text. If the warning limit is exceeded, <strong class="userinput"><code>yellow</code></strong> is shown, and if the critical limit is exceeded, <strong class="userinput"><code>red</code></strong>. If an entry of a partial tree lies outside the green limit, the monitor also sets the overlying nodes to yellow or red, so that the administrator can see that something is not right, even when the menus are not open.</p>

      <p>You do not normally need to worry about the thresholds. The settings configured by SAP are sensible and should only be changed if there is a sound reason to do so.</p>

      <p>The Nagios plugins for the CCMS query described in <a class="xref" href="../Text/ch22s02.html#the_ccms_plugins" title="22.2.4 The CCMS plugins">22.2.4 The CCMS plugins</a> (page 525), return the status defined in the CCMS: OK if the traffic light is on green, WARNING for yellow, and CRITICAL for red. The thresholds are therefore set by the SAP system, and not by Nagios.</p>

      <p>If you want to find out more about CCMS, we refer you to the documentation at <a class="ulink" href="http://service.sap.com/monitoring">http://service.sap.com/monitoring</a> (password required). There SAP provides detailed information on the installation and operation of CCMS. The SAP online help also has an extensive range of information available. If you just want a short summary of the subject and are more interested in the way the Nagios plugins work, you can find two informative PDF documents at <a class="ulink" href="http://www.nagiosexchange.org/Misc.54.0.html">http://www.nagiosexchange.org/Misc.54.0.html</a> under the keyword <strong class="userinput"><code>SAP CCMS</code></strong>.</p>
    </div>

    <div class="sect2" title="22.2.2 Obtaining the necessary SAP usage permissions for Nagios">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="obtaining_the_necessary_sap_usage_permi"/>22.2.2 Obtaining the necessary SAP usage permissions for Nagios<sup>[<a class="footnote" href="#ftn.CHP-22-FN-7" id="CHP-22-FN-7">271</a>]</sup></h2>
      </div>

      <p>Retrieving information from the CCMS is done through RFC <span class="emphasis"><em>(Remote Function Calls)</em></span>, which requires a login on the SAP side. Luckily the user only needs a minimal set of permissions.</p>

      <p>A new role is set up in the role generator (transaction PFCG) with a name that conforms to the company-internal conventions. It is not given any transaction assignment in the menu.</p>

      <div class="figure">
        <a id="for_access_from_nagios_you_require_thes"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e46054"/><img alt="For access from Nagios you require these SAP authorization objects" src="../Images/tagoreillycom20081104nostarchimages224002.png.jpg"/></div>

        <p class="title">Figure 22-3. For access from Nagios you require these SAP authorization objects</p>
      </div>

      <p>When maintaining permissions, the following permission objects are added manually: <strong class="userinput"><code>S_RFC</code></strong>, <strong class="userinput"><code>S_XMI_LOG</code></strong>, and <strong class="userinput"><code>S_XMI_PROD</code></strong> (see also <a class="xref" href="../Text/ch22s02.html#for_access_from_nagios_you_require_thes" title="Figure 22-3. For access from Nagios you require these SAP authorization objects">Figure 22-3</a>).</p>

      <p>Whether these permissions are sufficient or not can be tested with the plu-gin <strong class="userinput"><code>check_sap_cons</code></strong> described in <a class="xref" href="../Text/ch22s02.html#the_ccms_plugins" title="22.2.4 The CCMS plugins">22.2.4 The CCMS plugins</a>, page 525 <strong class="userinput"><code>check_sap_cons</code></strong>. If a function group (such as <strong class="userinput"><code>SALG</code></strong>) is missing from the permission object <strong class="userinput"><code>S_RFC</code></strong>, the plugin shows name of this in plain text in the error message.</p>

      <p>The login data is stored on the Nagios server in the file <strong class="userinput"><code>/etc/sapmon/login.cfg</code></strong>. When doing this, various target hosts (called <span class="emphasis"><em>RFC destinations</em></span> in SAP) can be configured simultaneously. Such a login configuration for a target system is called an <span class="emphasis"><em>RFC template</em></span> in the language of the CCMS plugins (<a class="xref" href="../Text/ch22s02.html#the_ccms_plugins" title="22.2.4 The CCMS plugins">22.2.4 The CCMS plugins</a>, page 525). It has the following form:</p><a id="I_programlisting3_d1e46101"/>
      <pre class="programlisting">[LOGIN_<span class="emphasis"><em>template</em></span>]
LOGIN=-d <span class="emphasis"><em>target</em></span> -u <span class="emphasis"><em>user</em></span> -p <span class="emphasis"><em>password</em></span> -c <span class="emphasis"><em>client-id</em></span> -h <span class="emphasis"><em>address</em></span>
    -s <span class="emphasis"><em>system_number</em></span></pre>

      <p>The complete <strong class="userinput"><code>LOGIN</code></strong> definition must be written on a single line, and it is essential that it contain the following details:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-d</code></strong> <strong class="userinput"><code><em class="replaceable"><code>target</code></em></code></strong></span></dt>

          <dd>
            <p>This is the name of the SAP system, also referred to as <span class="emphasis"><em>SID</em></span> or <span class="emphasis"><em>system ID</em></span>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong> <strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong></span></dt>

          <dd>
            <p>These parameters state the SAP user and corresponding password. Remember that a newly created dialog user has to change his or her password on first logon.</p>

            <p>In addition, there are problems with upper/lower case on some systems: In some cases the password must be written entirely in capitals.</p>

            <p>If the login is to work later on, the password may not contain the # sign. Which special characters are allowed seems to depend on the system settings. Here you just have to experiment a bit, if necessary. If you have problems, it is best to start with a very simple password, so that errors of this type can be ruled out.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>client-id</code></em></code></strong></span></dt>

          <dd>
            <p>This is the three digit client ID.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-h</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>The host name of the host on which the named user should log in. This must resolve to an IP address.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>system_number</code></em></code></strong></span></dt>

          <dd>
            <p>The SAP system number. The first SAP instance is normally <strong class="userinput"><code>00</code></strong>, then increased incrementally.</p>
          </dd>
        </dl>
      </div>

      <p>Below, the <strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong> with the password <strong class="userinput"><code><em class="replaceable"><code>secret</code></em></code></strong> should login from the client with the ID <strong class="userinput"><code>020</code></strong> to the host <strong class="userinput"><code>p10ap013</code></strong> whose SAP installation has the system number <strong class="userinput"><code>01</code></strong>:</p><a id="I_programlisting3_d1e46225"/>
      <pre class="programlisting">[LOGIN_P10]
LOGIN=-d P10 -u <span class="emphasis"><em>user</em></span> -p <span class="emphasis"><em>secret</em></span> -c 020 -h p10ap013 -s 01</pre>

      <p>The RFC template name in square brackets consists of the text <strong class="userinput"><code>LOGIN_</code></strong> and the SAP system ID (SID). The RFC template defined here belongs to the SAP system <strong class="userinput"><code>P10</code></strong>.</p>
    </div>

    <div class="sect2" title="22.2.3 Monitors and templates">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="monitors_and_templates"/>22.2.3 Monitors and templates</h2>
      </div>

      <p>The interface provided by SAP that is used by the plugins is available in a simple and an extendable variant. Only additional functions enable all information from the CCMS to be retrieved, which is why we are omitting the description of the simple interface.<sup>[<a class="footnote" href="#ftn.CHP-22-FN-8" id="CHP-22-FN-8">272</a>]</sup><a class="indexterm" id="IDX-CHP-22-1914"/><a class="indexterm" id="IDX-CHP-22-1915"/></p>

      <p>For the extended interface, templates define the monitor data to be used. These are stored on the Nagios server in the file <strong class="userinput"><code>/etc/sapmon/agent.cfg</code></strong> and have the following format:</p><a id="I_programlisting3_d1e46266"/>
      <pre class="programlisting">[TEMPLATE_<span class="emphasis"><em>name</em></span>]
DESCRIPTION <span class="emphasis"><em>description</em></span>
MONI_SET_NAME= <span class="emphasis"><em>monitor collection</em></span>
MONI_NAME= <span class="emphasis"><em>name_of_the_monitor</em></span>
PATTERN_0=SID\<span class="emphasis"><em>context\monitor_object\attribute</em></span></pre>

      <p>The placeholders written in italics are replaced as follows:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code><em class="replaceable"><code>name</code></em></code></strong></span></dt>

          <dd>
            <p>This is the name with which the plugins address the template. The name may consist of digits, letters, and the characters <strong class="userinput"><code>_</code></strong> and <strong class="userinput"><code>-</code></strong>. When it is called by the plugin, the name must be written in lower case, irrespective of whether it is called <strong class="userinput"><code>TEST</code></strong>, <strong class="userinput"><code>Test</code></strong>, or <strong class="userinput"><code>test</code></strong>, for example. If you are having problems with alphanumerical names, it is better to select template names consisting of two digits when you are getting started, e.g., <strong class="userinput"><code>00</code></strong>, <strong class="userinput"><code>01</code></strong>, and so on.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code><em class="replaceable"><code>description</code></em></code></strong></span></dt>

          <dd>
            <p>A freely selectable, simple text.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code><em class="replaceable"><code>monitor collection</code></em></code></strong></span></dt>

          <dd>
            <p>This is the name of the monitor, set exactly as it is in the CCMS (including upper/lower case and spaces).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code><em class="replaceable"><code>name_of_the_monitor</code></em></code></strong></span></dt>

          <dd>
            <p>The name of the monitor must also match the SAP name exactly.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code><em class="replaceable"><code>context</code></em></code></strong></span></dt>

          <dd>
            <p>This pattern filters out the desired values from those contained in the monitor. In most cases you specify the identifier for the SAP instance, such as <strong class="userinput"><code>p10ap013_P10_01</code></strong> (<strong class="userinput"><code>p10ap013</code></strong> is the host name, <strong class="userinput"><code>P10</code></strong> the SID of the SAP system, and <strong class="userinput"><code>01</code></strong> is the system number).<a class="indexterm" id="IDX-CHP-22-1916"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code><em class="replaceable"><code>monitor_object</code></em></code></strong></span></dt>

          <dd>
            <p>This is the name of the desired monitor object, for example <strong class="userinput"><code>Dialog</code></strong>. Unfortunately the term demanded here rarely corresponds to the one shown in the SAP GUI. It is best to determine it using <strong class="userinput"><code>PATTERN_0=*</code></strong>, as described below.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code><em class="replaceable"><code>attribute</code></em></code></strong></span></dt>

          <dd>
            <p>This is the variable to be queried. Each monitor object may contain severable variables. <strong class="userinput"><code>Dialog</code></strong>, for example, has, apart from the <strong class="userinput"><code>ResponseTime</code></strong> variable, the <strong class="userinput"><code>FrontendNetTime</code></strong> variable, which reveals the average processing time of a transaction, restricted to the network transmission time and processing time on the client.</p>
          </dd>
        </dl>
      </div>

      <p>The challenge here is in specifying the filter in <strong class="userinput"><code>PATTERN_0</code></strong>. It must exactly match the SAP-internal names, and these are not identical to the terms that are displayed in the CCMS Alert Monitor (Transaction RZ20).</p>

      <p>It is best to start with <strong class="userinput"><code>PATTERN_0=*</code></strong>, which ensures that the entire tree appears. We shall call the template for this simply <strong class="userinput"><code>00</code></strong>:</p><a id="I_programlisting3_d1e46406"/>
      <pre class="programlisting">[TEMPLATE_00]
DESCRIPTION=Dialog response time
MONI_SET_NAME=SAP CCMS Monitor Templates
MONI_NAME=Dialog Overview
PATTERN_0=*</pre>

      <p>With this entry in <strong class="userinput"><code>/etc/sapmon/agent.cfg</code></strong> you query the complete list of all monitor entries, in this case those of the system with the ID <strong class="userinput"><code>P10</code></strong>, using the <strong class="userinput"><code>check_sap_cons</code></strong> plugin:<a class="indexterm" id="IDX-CHP-22-1917"/></p><a id="I_programlisting3_d1e46422"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_sap_cons 00 P10</strong></span>
...
P10 p10ap013_P10_01 Dialog ResponseTime 262 msec
P10 p10ap014_P10_02 Dialog ResponseTime 61 msec
P10 p10db012_P10_00 Dialog ResponseTime 11 msec
...</pre>

      <p>The entries contain the following information—with items separated by spaces:</p><a id="I_programlisting3_d1e46430"/>
      <pre class="programlisting"><span class="emphasis"><em>SID context monitor_object attribute value</em></span></pre>

      <p>The information for the <strong class="userinput"><code>P10</code></strong> system queried above first gives the SAP instance, such as <strong class="userinput"><code>p10ap013_P10_01</code></strong>, then the monitor object (<strong class="userinput"><code>Dialog</code></strong>) and the attribute (<strong class="userinput"><code>ResponseTime</code></strong>) together with values. In the SAP GUI (<a class="xref" href="../Text/ch22s02.html#the_sap_ccms_monitor_dialog_overview" title="Figure 22-2. The SAP CCMS monitor dialog Overview">Figure 22-2</a>) this latter is called <strong class="userinput"><code>Dialog Response Time</code></strong>, and since each empty space is significant, this is a completely different name.</p>

      <p>In a template that is only interested in the response time of the instance <strong class="userinput"><code>p10ap014_P10_02</code></strong>, the <strong class="userinput"><code>PATTERN_0</code></strong> is defined as follows:</p><a id="I_programlisting3_d1e46461"/>
      <pre class="programlisting">PATTERN_0=P10\p10ap014_P10_02\Dialog\ResponseTime</pre>

      <p>If you want to query all the entries of a query level, you must use the wildcard <strong class="userinput"><code>*</code></strong>. The following example defines templates for the dialog response time, the network response time, and the average CPU load for all instances of the system <strong class="userinput"><code>P10</code></strong>:</p><a id="I_programlisting3_d1e46471"/>
      <pre class="programlisting">[TEMPLATE_00]
DESCRIPTION=Dialog response time
MONI_SET_NAME=SAP CCMS Monitor Templates
MONI_NAME=Dialog Overview
PATTERN_0=P10\*\Dialog\ResponseTime

[TEMPLATE_01]
DESCRIPTION=network response time
MONI_SET_NAME=SAP CCMS Monitor Templates
MONI_NAME=Dialog Overview
PATTERN_0=P10\*\Dialog\FrontEndNetTime

[TEMPLATE_10]
DESCRIPTION=System load in five-minute average
MONI_SET_NAME=SAP CCMS Monitor Templates
MONI_NAME=Operating System
PATTERN_0="P10\*\CPU\5minLoadAverage"</pre>
    </div>

    <div class="sect2" title="22.2.4 The CCMS plugins">
      <div class="titlepage">
        <h2 class="title" id="heading_id_6"><a id="the_ccms_plugins"/>22.2.4 The CCMS plugins</h2>
      </div>

      <p>SAP demonstrates the use of the RFC interface to the CCMS with the CCMS plugins for SuSE. In Debian you can convert the RPM package <strong class="userinput"><code>nagios-plugins-sap-ccms-0.7.3</code></strong><sup>[<a class="footnote" href="#ftn.CHP-22-FN-9" id="CHP-22-FN-9">273</a>]</sup> to a tar file with <strong class="userinput"><code>alien</code></strong>, or alternatively you can obtain the source RPM from a SuSE FTP mirror<sup>[<a class="footnote" href="#ftn.CHP-22-FN-10" id="CHP-22-FN-10">274</a>]</sup> and compile the source code yourself. This will give you the plugins listed in <a class="xref" href="../Text/ch22s02.html#the_sap-ccms_plugins" title="Table 22-1. The SAP-CCMS Plugins">Table 22-1</a>.<a class="indexterm" id="IDX-CHP-22-1919"/><a class="indexterm" id="IDX-CHP-22-1920"/><a class="indexterm" id="IDX-CHP-22-1918"/></p>

      <div class="table">
        <a id="the_sap-ccms_plugins"/>

        <p class="title">Table 22-1. The SAP-CCMS Plugins</p>

        <div class="table-contents">
          <table class="sgc-3" summary="The SAP-CCMS Plugins">
            <colgroup>
              <col/>
              <col/>
            </colgroup>

            <thead>
              <tr>
                <th class="sgc-1" valign="bottom">
                  <p>Plugin</p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Description</p>
                </th>
              </tr>
            </thead>

            <tfoot>
              <tr>
                <th class="sgc-1" colspan="2" valign="top">
                  <p><sup>[<a class="footnote" href="#ftn.CHP-22-TFN-11" id="CHP-22-TFN-11">a</a>]</sup></p>
                </th>
              </tr>
            </tfoot>

            <tbody>
              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_sap</code></strong><a class="indexterm" id="IDX-CHP-22-1921"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Output of the monitor data in HTML format</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_sap_cons</code></strong><a class="indexterm" id="IDX-CHP-22-1922"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Ditto, but without HTML formatting and without hyperlinks for the output on the command line</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_sap_instance</code></strong><a class="indexterm" id="IDX-CHP-22-1923"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Dialog response time and number of logged-in users on a particular application server (requires CCMS Ping<sup>[<a class="footnoteref" href="../Text/ch22s02.html#ftn.CHP-22-TFN-11">a</a>]</sup>)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_sap_instance_cons</code></strong><a class="indexterm" id="IDX-CHP-22-1924"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Ditto, as text output without HTML markup</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_sap_multiple</code></strong><a class="indexterm" id="IDX-CHP-22-1925"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>HTML-formatted output of data of a monitor template, which returns more than one value</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_sap_mult_no_thr</code></strong><a class="indexterm" id="IDX-CHP-22-1926"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Output of multiple values with simple HTML formatting, without hyperlinks, in contrast to <strong class="userinput"><code>check_sap_multiple</code></strong></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_sap_system</code></strong><a class="indexterm" id="IDX-CHP-22-1927"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Shows the application servers of the SAP system and their states (requires CCMS Ping)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_sap_system_cons</code></strong><a class="indexterm" id="IDX-CHP-22-1928"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Like <strong class="userinput"><code>check_sap_system</code></strong>, only without HTML formatting</p>
                </td>
              </tr>
            </tbody>

            <tbody class="footnotes">
              <tr>
                <td colspan="2">
                  <div class="footnote">
                    <p><sup>[<a class="para" href="#CHP-22-TFN-11" id="ftn.CHP-22-TFN-11">a</a>]</sup> As components of the CCMS monitoring system, CCMS Ping monitors the availability of the application server belonging to the SAP system.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p>The plugins that end in _cons are especially suitable for test purposes: they simply pass the data on to the command line, without further formatting. The output of the others contains HTML formatting for a Nagios version modified by SAP; with Nagios 2.0 they usually lead to an incorrect view and are therefore useless.</p>

      <p>Individual values are best retrieved with <strong class="userinput"><code>check_sap_cons</code></strong>. For Nagios 2.x the monitor definition must then really return only one single value. The remaining ones would be returned on additional lines, ignored by Nagios 2.x.</p>

      <p>If you are using Nagios from version 3.0 onward, you can certainly formulate the monitor definition in such a way that <strong class="userinput"><code>check_sap_cons</code></strong> returns several values. Although the Web interface will only display the first line of these, the extended view, with <strong class="userinput"><code>extinfo.cgi</code></strong>, will show the rest of the output up to a length of 8 KB (see <a class="xref" href="../Text/ch22s02.html#check_underscore_sap_underscore_cons" title="Figure 22-4. check_sap_cons with a mulitiple-line output in Nagios 3.0.">Figure 22-4</a>).</p>

      <div class="figure">
        <a id="check_underscore_sap_underscore_cons"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e46649"/><img alt="check_sap_cons with a mulitiple-line output in Nagios 3.0." src="../Images/tagoreillycom20081104nostarchimages224004.png.jpg"/></div>

        <p class="title">Figure 22-4. check_sap_cons with a mulitiple-line output in Nagios 3.0.</p>
      </div>

      <p>If Nagios 2.x is to display several return values, it is best to use <strong class="userinput"><code>check_sap_mult_no_thr</code></strong>, which provides these values with some HTML formatting elements that also work with Nagios 2.x. This causes all results to appear in the Web interface as well.</p>

      <p>All plugins demand two arguments: <strong class="userinput"><code>check_sap</code></strong>, <strong class="userinput"><code>check_sap_cons</code></strong>, <strong class="userinput"><code>check_sap_multiple</code></strong>, and <strong class="userinput"><code>check_sap_mult_no_thr</code></strong> first require the name of the monitor template from the file <strong class="userinput"><code>/etc/sapmon/agent.cfg</code></strong>, such as <strong class="userinput"><code>00</code></strong>, <strong class="userinput"><code>00_sapl3</code></strong>, <strong class="userinput"><code>01</code></strong>, or <strong class="userinput"><code>10</code></strong> (see <a class="xref" href="../Text/ch22s02.html#obtaining_the_necessary_sap_usage_permi" title="22.2.2 Obtaining the necessary SAP usage permissions for Nagios">22.2.2 Obtaining the necessary SAP usage permissions for Nagios</a>), followed by the name of the RFC templates, as defined in <strong class="userinput"><code>/etc/sapmon/login.cfg</code></strong> (in the examples in this book we use the system ID <strong class="userinput"><code>P10</code></strong>).</p>

      <p>For <strong class="userinput"><code>check_sap_system/check_sap_system_cons</code></strong> and <strong class="userinput"><code>check_sap_instance/check_sap_system_cons</code></strong>, the first argument changes: instead of the monitor template, <strong class="userinput"><code>check_sap_system</code></strong> demands the system ID (here, <strong class="userinput"><code>P10</code></strong>), and <strong class="userinput"><code>check_sap_instance</code></strong> demands the SAP instance, consisting of the host name, the SID, and the system number (for example, <strong class="userinput"><code>p10apl3_P10_01</code></strong>).<a class="indexterm" id="IDX-CHP-22-1929"/></p>

      <div class="sect3" title="First steps with check_sap_cons">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="first_steps_with_check_underscore_sap_u"/>First steps with <strong class="userinput"><code>check_sap_cons</code></strong></h3>
        </div>

        <p>The plugin <strong class="userinput"><code>check_sap_cons</code></strong> is probably best suited to your first attempts. Only after this has worked for you properly on the command line should you move on to the actual Nagios configuration. The example in <a class="xref" href="../Text/ch22s02.html#monitors_and_templates" title="22.2.3 Monitors and templates">22.2.3 Monitors and templates</a> already showed how you determine the dialog response time with the monitor template <strong class="userinput"><code>00</code></strong>, and the following example queries the network time which the SAP GUI requires till the result of the transaction appears in the SAP GUI, using the monitor template <strong class="userinput"><code>01</code></strong>:</p><a id="I_programlisting3_d1e46740"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_sap_cons 01 P10</strong></span>
P10 p10ap013_P10_01 Dialog FrontEndNetTime 383 msec
P10 p10ap014_P10_02 Dialog FrontEndNetTime 673 msec
P10 p10db012_P10_00 Dialog FrontEndNetTime 1491 msec</pre>

        <p>The definitions in the two templates can be found in <a class="xref" href="../Text/ch22s02.html#monitors_and_templates" title="22.2.3 Monitors and templates">22.2.3 Monitors and templates</a> in page 523. In both examples, <strong class="userinput"><code>check_sap_cons</code></strong> returns multiple values, only the first line of which would be noticed by Nagios in the Web interface and in notifications. If the instance <strong class="userinput"><code>p10ap014_P10_02</code></strong> displayed a critical status, but <strong class="userinput"><code>p10ap013_P10_01</code></strong> did not, the plugin would return a CRITICAL, but the Web interface would only present the first line (like the notification), which would not give any reason to worry. This means that the admin would not see the very thing that has set off the critical state.</p>

        <p>If <strong class="userinput"><code>check_sap_cons</code></strong> only returns error messages instead of the data you want, there could be several reasons for this. In the following example the login fails:</p><a id="I_programlisting3_d1e46763"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_sap_cons 00 P10</strong></span>
&lt;== RfcLastError
FUNCTION: SXMI_LOGON
RFC operation/code SYSTEM_FAILURE
ERROR/EXCEPTION
key     :
status  :
message : User account not in validity date
internal:
&lt;==  RfcClose</pre>

        <p>The reason is given in the <strong class="userinput"><code>message:</code></strong> field: the user currently does not have a valid account. If the following message were to be found there</p><a id="I_programlisting3_d1e46773"/>
        <pre class="programlisting">message : User 910WOB has no RFC authorization for function group SXMI.</pre>

        <p>this would mean that the user <strong class="userinput"><code>910W0B</code></strong> does not have the necessary permission in the authorization object <strong class="userinput"><code>S_RFC</code></strong>. In order to grant it, that user should be assigned to the function group <strong class="userinput"><code>SXMI</code></strong>.</p>

        <p>The plugins record such RFC error messages in the file <strong class="userinput"><code>dev_rfc</code></strong> in the current working directory. If Nagios runs the plugin, then it will generate this file in the Nagios home directory (<strong class="userinput"><code>/usr/local/nagios</code></strong>, if you have followed the installation description in this book).</p>

        <p>In the next case the login works perfectly, but the plugin does not return any values:</p><a id="I_programlisting3_d1e46797"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_sap_cons 01 P10</strong></span>
No information gathered! System up?</pre>

        <p>The error here lies in the monitor definition: often the name of the monitor set or the monitor is written wrongly, or the pattern does not match the monitor used. The intersection of monitor and pattern is then empty, and SAP also does not warn explicitly if the monitor or monitor set do not even exist.</p>
      </div>

      <div class="sect3" title="Checking multiple values with check_sap_mult_no_thr">
        <div class="titlepage">
          <h3 class="title" id="heading_id_8"><a id="checking_multiple_values_with_check_und"/>Checking multiple values with <strong class="userinput"><code>check_sap_mult_no_thr</code></strong></h3>
        </div>

        <p>If Nagios is to represent multiple queried values in the Web interface, you should use <strong class="userinput"><code>check_sap_mult_no_thr</code></strong>:</p><a id="I_programlisting3_d1e46815"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_sap_mult_no_thr 00 P10</strong></span>
&lt;table&gt;
&lt;tr&gt;&lt;td CLASS='statusOK'&gt;P10 p10ap013_P10_01 &lt;br&gt;
        Dialog ResponseTime 785 msec&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td CLASS='statusOK'&gt;P10 p10ap014_P10_02 &lt;br&gt;
        Dialog ResponseTime 352 msec&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td CLASS='statusOK'&gt;P10 p10db012_P10_00 &lt;br&gt;
        Dialog ResponseTime 22 msec&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;</pre>

        <p>The output is given in a single line, which we have reformatted manually here so that it can be more easily read. With the HTML code, the plugin ensures that each value (thanks to the <strong class="userinput"><code>CLASS</code></strong> specifications) is shown on a separate line in the color matching its status. The status of the Nagios service changes to CRITICAL if at least one measured value is critical. Such a case is shown in <a class="xref" href="../Text/ch22s02.html#check_underscore_sap_underscore_mult_un" title="Figure 22-5. Check_sap_mult_no_thr uses HTML. Markups which Nagios 2.0 also understands">Figure 22-5</a>.</p>

        <div class="figure">
          <a id="check_underscore_sap_underscore_mult_un"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e46832"/><img alt="Check_sap_mult_no_thr uses HTML. Markups which Nagios 2.0 also understands" src="../Images/tagoreillycom20081104nostarchimages224006.png.jpg"/></div>

          <p class="title">Figure 22-5. <code class="userinput">Check_sap_mult_no_thr</code> uses HTML. Markups which Nagios 2.0 also understands</p>
        </div>

        <p>In this case as well you should remember that Nagios 2.x altogether processes no more than 300 bytes of the plugin output, and cuts off the rest. For HTML-formatted output, not only is information then missing, there are also side effects in the table layout in the Web interface. In case of doubt, you must share the test among several service checks. Starting with Nagios 3.0, this problem generally no longer occurs, as the limit of 8 KB for the plugin output is also usually sufficient to display extensive output.</p>

        <p>In the definition of the Nagios command objects, the host name, exceptionally, does not play a role for the CCMS plugins. This means that the <strong class="userinput"><code>$HOSTADDRESS$</code></strong> macro is not used:</p><a id="I_programlisting3_d1e46844"/>
        <pre class="programlisting">define command{
    command_name <span class="strong"><strong>check_sap_ccms</strong></span>
    command_line $USER1$/<span class="strong"><strong>check_sap_mult_no_thr</strong></span> $ARG1$ $ARG2$
}</pre>

        <p>If you request several values simultaneously, they will normally belong to different hosts. This means that services can only be assigned to a host in one-to-one single value queries. Nevertheless, Nagios expects a specific host in the service definition:</p><a id="I_programlisting3_d1e46854"/>
        <pre class="programlisting">define service{
   service_description     SAP Dialog Response Time
   host_name     sap01
   <span class="strong"><strong>   check_command</strong></span> <span class="strong"><strong>     check_sap_ccms!00!P10</strong></span>
   ...
}</pre>
      </div>
    </div>

    <div class="sect2" title="22.2.5 Performance optimization">
      <div class="titlepage">
        <h2 class="title" id="heading_id_9"><a id="performance_optimization"/>22.2.5 Performance optimization</h2>
      </div>

      <p>Since the monitor always transmits all the data it has available over the RFC interface, filtering always takes place on the client side through the plugin. For this reason it is not recommended that you query single values from a large monitor one after another: this consumes considerable resources.<a class="indexterm" id="IDX-CHP-22-1930"/><a class="indexterm" id="IDX-CHP-22-1931"/></p>

      <p>You should either have a single service provide all the values,<sup>[<a class="footnote" href="#ftn.CHP-22-FN-12" id="CHP-22-FN-12">275</a>]</sup> or you should define a separate monitor yourself containing precisely those values you would like to test. This latter method is recommended by SAP.</p>

      <p>If you want to check several monitors, or even single values of the monitor one after the other, you should keep an eye on the necessary network bandwidth. Within a local network this is normally not a problem, but it can place a considerable burden on narrow-bandwidth long-distance connections (ISDN, simple VPNs). In such cases you should measure the network traffic when starting operation, so that you can increase the check intervals accordingly in case of problems.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-6" id="ftn.CHP-22-FN-6">270</a>]</sup> Central evaluation was not possible in earlier releases.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-7" id="ftn.CHP-22-FN-7">271</a>]</sup> This section is intended for SAP authorization administrators. If you do not maintain SAP authorizations yourself, you can skip this section.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-8" id="ftn.CHP-22-FN-8">272</a>]</sup> Information on this is provided by the PDF documents mentioned in <a class="xref" href="../Text/ch22s02.html#a_short_overview_over_the_alert_monitor" title="22.2.1 A short overview over the alert monitor">22.2.1 A short overview over the alert monitor</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-9" id="ftn.CHP-22-FN-9">273</a>]</sup> It can be found at <a class="ulink" href="http://www.rpmseek.com/">http://www.rpmseek.com/</a>, for example, if you search there for nagios-plugins-sap-ccms.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-10" id="ftn.CHP-22-FN-10">274</a>]</sup> e.g., <a class="ulink" href="ftp://ftp5.gwdg.de/pub/linux/suse/opensuse/distribution/SL-OSS-factory/inst-source/suse/i586/nagios-plugins-sap-ccms-0.7.3-143.i586.rpm">ftp://ftp5.gwdg.de/pub/linux/suse/opensuse/distribution/SL-OSS-factory/inst-source/suse/i586/nagios-plugins-sap-ccms-0.7.3-143.i586.rpm</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-22-FN-12" id="ftn.CHP-22-FN-12">275</a>]</sup> Using a plugin predestined for the output of multiple values.</p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;23.&#xA0;Processing Events with the EventDB">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="processing_events_with_the_eventdb"/>Chapter 23. Processing Events with the EventDB</h1>
    </div>

    <p>Events are fundamentally different from the other, usual host and service states in Nagios. The check of a service in a critical state returns a CRITICAL until the state of the service changes, irrespective of the number of checks and the repeat interval. An event, on the other hand, occurs only once, for instance in the form of a syslog entry or an SNMP trap.<a class="indexterm" id="IDX-CHP-23-1932"/></p>

    <p>If the events of an uninterruptible power supply (UPS) are logged via syslog to a log file, the message that the UPS has switched to battery because the voltage supply has failed will appear there only once. If you now test regularly whether a corresponding entry occurred within the last half hour, simple log file checks will not announce a match after this time has expired, so they will return an OK, since there is no critical event. But the UPS is still in a critical state. The critical state only really ends when the message arrives that the voltage supply has been restored.</p>

    <p>Monitoring via SNMP traps comes close to the desired behavior: An alarm trap announces the failure of the voltage supply, the state of the service is set to CRITICAL, a subsequent OK trap announces the restoration of the voltage supply, and the state changes back to OK.<a class="indexterm" id="IDX-CHP-23-1933"/></p>

    <p>Events can be integrated into Nagios in various ways. A simple syslog integration is described in <a class="xref" href="../Text/ch14s05.html" title="14.5 Application Example I: Integrating syslog and Nagios">14.5 Application Example I: Integrating syslog and Nagios</a> from page 306, and another processing method for SNMP traps, also kept very simple, is dealt with in <a class="xref" href="../Text/ch14s06.html" title="14.6 Application Example II: Processing SNMP Traps">14.6 Application Example II: Processing SNMP Traps</a> from page 312. For Windows events it is often sufficient to test whether a specific event has occurred in the past 12 to 24 hours. The check can be made with NSClient++ and the module <strong class="userinput"><code>CheckEventLog</code></strong> (<a class="xref" href="../Text/ch20s04.html#internal_nsclient_plus_plus_functions" title="20.4.4 Internal NSClient++ functions">20.4.4 Internal NSClient++ functions</a>, page 502), for instance.</p>

    <p>The procedure described in this chapter goes a little further. All events are collected in an event database. An administrator processes all these events and sets an acknowledge via a Web interface. Nagios now checks via plugin whether a defined number of events is exceeded for a specific group, so that the administrator will have to act—to set acknowledges and undertake further action, if necessary.</p>

    <p>A similar approach is taken by <strong class="userinput"><code>nagtrap</code></strong><sup>[<a class="footnote" href="#ftn.CHP-23-FN-1" id="CHP-23-FN-1">276</a>]</sup> (formerly SNMPTT Web Frontend, not to be confused with the SNMPTT GUI<sup>[<a class="footnote" href="#ftn.CHP-23-FN-2" id="CHP-23-FN-2">277</a>]</sup>). <strong class="userinput"><code>nagtrap</code></strong> is specialized for SNMP traps and is integrated directly into the Nagios Web interface. For reasons of space, we will not go into a detailed description here.<a class="indexterm" id="IDX-CHP-23-1934"/><a class="indexterm" id="IDX-CHP-23-1935"/></p>

    <div class="sect1" title="23.1 How the EventDB Works">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="how_the_eventdb_works"/>23.1 How the EventDB Works</h1>
      </div>

      <p>The EventDB of NETWAYS<sup>[<a class="footnote" href="#ftn.CHP-23-FN-3" id="CHP-23-FN-3">278</a>]</sup> basically consists of four components: a syslog connection, which collects the events, a MySQL database to save the events, a Web interface for interactive processing, and a Nagios plugin, which connects the EventDB to Nagios. <a class="xref" href="../Text/ch23.html#syslog-ng_collects_data_f" title="Figure 23-1. syslog-ng collects data from various sources and writes these to named pipe. A separate daemon reads the events from this and writes them to the database. From this they can be queried via web interface or via Nagios plugin.">Figure 23-1</a> shows a diagram of the setup.<a class="indexterm" id="IDX-CHP-23-1936"/><a class="indexterm" id="IDX-CHP-23-1937"/><a class="indexterm" id="IDX-CHP-23-1938"/></p>

      <p>A central syslog service—<strong class="userinput"><code>syslog-ng</code></strong> is used because of its more flexible configuration—collects events from various sources. There are various software packages available for the integration of Windows event logs, one of which is described in <a class="xref" href="../Text/ch23s05.html" title="23.6 Sending Windows Events to Syslog">23.6 Sending Windows Events to Syslog</a> (page 545). The SNMP trap daemon installed on the syslog server, <strong class="userinput"><code>snmptrapd</code></strong> (<a class="xref" href="../Text/ch14s06.html#receiving_traps_with_snmptrapd" title="14.6.1 Receiving traps with snmptrapd">14.6.1 Receiving traps with snmptrapd</a>, page 312), is able to pass the traps it receives on to the syslog. To provide more meaningful and readable messages from the cryptic OIDs, the <span class="emphasis"><em>SNMP Trap Translator</em></span> (SNMPTT) is on hand to help out the <strong class="userinput"><code>snmptrapd</code></strong>, and this is described briefly in <a class="xref" href="../Text/ch23s06.html" title="23.7 Making the Incomprehensible Legible with SNMPTT">23.7 Making the Incomprehensible Legible with SNMPTT</a> from page 546.<a class="indexterm" id="IDX-CHP-23-1939"/></p>

      <p><strong class="userinput"><code>syslog-ng</code></strong> allows existing events to be arranged in a self-defined format and to be sent to a named pipe. From this a daemon reads the incoming events and writes them to a MySQL database. Via a Web interface (<a class="xref" href="../Text/ch23s03.html#the_web_interface_for_the_eventdb_allow" title="Figure 23-2. The Web interface for the EventDB allows certain entries to be selected, and the administrator the administrator can also set acknowledges for each event via the Web interface.">Figure 23-2</a>, page 539) the administrator confirms processed events with acknowledges. Nagios uses a plugin to test whether there are one or more non-confirmed entries for a specific event and informs the administrator accordingly about the notification functions.</p>

      <p>It should also be mentioned that the EventDB is ideal for processing sys-log entries, even when Nagios is not used at all. The Web interface of the EventDB provides a simple but effective interface that can be used to search the database quickly and easily for a particular event or for similar events, especially when events of the same type are collected from a large number of hosts.</p>

      <div class="figure">
        <a id="syslog-ng_collects_data_f"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e46995"/><img alt="syslog-ng collects data from various sources and writes these to named pipe. A separate daemon reads the events from this and writes them to the database. From this they can be queried via web interface or via Nagios plugin." src="../Images/tagoreillycom20081104nostarchimages224008.png"/></div>

        <p class="title">Figure 23-1. <code class="userinput">syslog-ng</code> collects data from various sources and writes these to named pipe. A separate daemon reads the events from this and writes them to the database. From this they can be queried via web interface or via Nagios plugin.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-1" id="ftn.CHP-23-FN-1">276</a>]</sup> <a class="ulink" href="http://www.nagtrap.org/">http://www.nagtrap.org/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-2" id="ftn.CHP-23-FN-2">277</a>]</sup> <a class="ulink" href="http://snmptt-gui.sourceforge.net/">http://snmptt-gui.sourceforge.net/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-3" id="ftn.CHP-23-FN-3">278</a>]</sup> <a class="ulink" href="http://www.netways.de/">http://www.netways.de/</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="23.2 Installation">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="installation-id11"/>23.2 Installation</h1>
    </div>

    <p>The current version of the EventDB can be obtained from NagiosExchange,<sup>[<a class="footnote" href="#ftn.CHP-23-FN-4" id="CHP-23-FN-4">279</a>]</sup> and the contents of the tar archive are unpacked in the directory <strong class="userinput"><code>/usr/local/src</code></strong>:</p><a id="I_programlisting4_d1e47012"/>
    <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/src</strong></span>
linux:local/src # <span class="strong"><strong>tar xvzf</strong></span> <span class="bolditalic">/pfad</span><span class="strong"><strong>/eventdb.tgz</strong></span>
eventdb/
eventdb/plugin/
eventdb/plugin/check_eventdb.pl
eventdb/agenten/
eventdb/agenten/syslog-ng/
eventdb/agenten/syslog-ng/syslog-ng2mysql
eventdb/agenten/syslog-ng/syslog-ng.conf
eventdb/agenten/syslog-ng/syslog-ng2mysql.pl
...
eventdb/db/
eventdb/db/create_tables.sql
eventdb/webinterface/
eventdb/webinterface/index.php
...
eventdb/cleanup/
eventdb/cleanup/eventdb-clean_database.sh
eventdb/cleanup/rotate_eventdb.sh
...</pre>

    <p>The Nagios plugin is located in the <strong class="userinput"><code>plugin</code></strong> subdirectory. The subdirectory <strong class="userinput"><code>agenten</code></strong> contains the integration with <strong class="userinput"><code>syslog-ng</code></strong>. In <strong class="userinput"><code>db</code></strong> there is a MySQL script that creates the necessary tables in the database. The <strong class="userinput"><code>webinterface</code></strong> directory contains the Web interface for the EventDB</p>

    <div class="sect2" title="23.2.1 Installation requirements">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="installation_requirements-id1"/>23.2.1 Installation requirements</h2>
      </div>

      <p>A prerequisite for the EventDB is <strong class="userinput"><code>syslog-ng</code></strong> in at least version 1.9.1, since the template mechanism required is only implemented from this version onward. For the database you require a current MySQL-5.0 server (included in the Debian package <strong class="userinput"><code>mysql-server-5.0</code></strong>, for example), and for the <strong class="userinput"><code>syslog-ng2mysql.pl</code></strong> daemon written in Perl, the module <strong class="userinput"><code>DBD::MySQL</code></strong> (in Debian, the package <strong class="userinput"><code>libdbd-mysql-perl</code></strong>).</p>

      <p>The Web interface is implemented in PHP 5. This requires, along with Apache 2, the PHP-5 module for this server version (in Debian <strong class="userinput"><code>libapache2-mod-php5</code></strong>) and the PHP5-MySQL package (in Debian, <strong class="userinput"><code>php5-mysql</code></strong>).</p>

      <p>An automatic installation routine that checks that all required packages are present is not included in EventDB.</p>

      <p>If the SNMPTT, to be described later in <a class="xref" href="../Text/ch23s06.html" title="23.7 Making the Incomprehensible Legible with SNMPTT">23.7 Making the Incomprehensible Legible with SNMPTT</a>, is to be integrated, then you will also require the daemons <strong class="userinput"><code>snmpd</code></strong> and <strong class="userinput"><code>snmptrapd</code></strong>, as well as the accompanying client programs. Debian provides these programs in the packages <strong class="userinput"><code>snmpd</code></strong> and <strong class="userinput"><code>snmp</code></strong>. The SNMP trap translator requires SNMP Perl (in Debian, included in the package <strong class="userinput"><code>libsnmp-perl</code></strong>), which must not be confused with <strong class="userinput"><code>Net::SNMP</code></strong>.<a class="indexterm" id="IDX-CHP-23-1940"/></p>
    </div>

    <div class="sect2" title="23.2.2 Preparing the MySQL database">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="preparing_the_mysql_database-id1"/>23.2.2 Preparing the MySQL database</h2>
      </div>

      <p>After the installation of the MySQL-5 server package for the respective distribution, you set up the database <strong class="userinput"><code>eventdb</code></strong> and the database user <strong class="userinput"><code>eventdb</code></strong>:</p><a id="I_programlisting4_d1e47109"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>mysql -p</strong></span>
mysql&gt; <span class="strong"><strong>CREATE DATABASE eventdb;</strong></span>
Query OK, 1 row affected (0.01 sec)

mysql&gt; <span class="strong"><strong>GRANT SELECT,INSERT,UPDATE,DELETE ON eventdb.* TO</strong></span> \
<span class="strong"><strong>   'eventdb'@'localhost' IDENTIFIED by</strong></span> <span class="bolditalic">'mypassword'</span>;
Query OK, 0 rows affected (0.00 sec)
mysql&gt; <span class="strong"><strong>quit</strong></span>
Bye</pre>

      <p>The <strong class="userinput"><code>GRANT</code></strong> command gives <strong class="userinput"><code>eventdb</code></strong> the necessary permissions to work with the event database; instead of the password set here, you use your own, secure password. Then you change to the directory where the source code has been unpacked (in this case, <strong class="userinput"><code>/usr/local/src/eventdb</code></strong>) and set up the necessary tables with the script <strong class="userinput"><code>create_tables.sql</code></strong> from the subdirectory <strong class="userinput"><code>db</code></strong>:</p><a id="I_programlisting4_d1e47147"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/src/eventdb</strong></span>
linux:src/eventdb # <span class="strong"><strong>mysql -p eventdb &lt; db/create_tables.sql</strong></span></pre>

      <p>If no errors occur when doing this, the prompt will appear, without any other output. What has been created by the script can then be displayed with <strong class="userinput"><code>show tables</code></strong> and <strong class="userinput"><code>describe</code></strong> <em class="replaceable"><code>tablename</code></em>:</p><a id="I_programlisting4_d1e47165"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>mysql -u eventdb -p eventdb</strong></span>
mysql&gt; <span class="strong"><strong>show tables;</strong></span>
+-------------------+
| Tables_in_eventdb |
+-------------------+
| comments          |
| events            |
+-------------------+
2 rows in set (0.00 sec)

mysql&gt; <span class="strong"><strong>describe events;</strong></span>
+-------------+---------------------+-----+-----+---------------+
| Field       | Type                | Null| Key | Default       |
+-------------+---------------------+-----------+---------------+
| uid         | int(11)             | NO  | PRI | NULL          |
| type        | varchar(50)         | NO  | MUL |               |
| host        | varchar(50)         | NO  | MUL |               |
| facility    | varchar(50)         | NO  | MUL |               |
| priority    | varchar(20)         | NO  | MUL |               |
| level       | varchar(10)         | NO  |     |               |
| tag         | varchar(10)         | NO  |     |               |
| program     | varchar(50)         | NO  |     |               |
| datetime    | datetime            | NO  |     | 0000-00-00 00:00:00 |
| message     | blob                | NO  | MUL |               |
| acknowledged| tinyint(1) unsigned | NO  |     | 0             |
+-------------+---------------------+-----+-----+---------------+
11 rows in set (0.00 sec)</pre>

      <p>The MySQL command <strong class="userinput"><code>show tables</code></strong> shows the tables created. All events are saved in <strong class="userinput"><code>events</code></strong>. The <strong class="userinput"><code>comments</code></strong> table is just an auxiliary table, which is used for comments that the administrator might make when setting acknowledges.</p>
    </div>

    <div class="sect2" title="23.2.3 Sending events to the database with syslog-ng">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="sending_events_to_the_database_with"/>23.2.3 Sending events to the database with <strong class="userinput"><code>syslog-ng</code></strong></h2>
      </div>

      <p>The configuration of <strong class="userinput"><code>syslog-ng</code></strong> has already been described in <a class="xref" href="../Text/ch14s05.html" title="14.5 Application Example I: Integrating syslog and Nagios">14.5 Application Example I: Integrating syslog and Nagios</a> from page 306, which is why we will deal here only with the adjustments for the EventDB. In order for the syslog daemon to be able to pass on data to the EventDB, we need suitable <span class="emphasis"><em>destinations</em></span> and a log entry that uses these. To make the configuration more clear we will write our own template to the file <strong class="userinput"><code>syslog-ng.conf</code></strong>, which formats the output and which is referenced in the definition of the two destinations <strong class="userinput"><code>d_eventdb</code></strong> and <strong class="userinput"><code>df_eventdb</code></strong>:<a class="indexterm" id="IDX-CHP-23-1941"/></p><a id="I_programlisting4_d1e47217"/>
      <pre class="programlisting">template t_eventdb {
  template("$HOST\t$FACILITY\t$PRIORITY\t$LEVEL\t$TAG\t$YEAR-$MONTH-$DAY
\t$HOUR:$MIN:$SEC\t$PROGRAM\t$MSG\n");
  template_escape(no);
};
destination d_eventdb {
  pipe("/var/run/syslog-ng.pipe" template(t_eventdb));
};
destination df_eventdb {
  file("/var/log/eventdb" template(t_eventdb));
};</pre>

      <p>In the <strong class="userinput"><code>TAG</code></strong> variable there is a non-documented combination of <strong class="userinput"><code>$FACILITY</code></strong> and <strong class="userinput"><code>$PRIORITY</code></strong>, that is, of the type of program to be logged (daemon, authorization tool, kernel, cron daemon, printer, and so on; see also <strong class="userinput"><code>man 3 syslog</code></strong>) and the significance of the message. <strong class="userinput"><code>$HOST</code></strong> is a placeholder for the computer, <strong class="userinput"><code>$YEAR-$MONTH-$DAY</code></strong> for the date, <strong class="userinput"><code>$HOUR:$MIN:$SEC</code></strong> for the time, <strong class="userinput"><code>$PROGRAM</code></strong> for the program for which the message applies, and <strong class="userinput"><code>$MSG</code></strong> for the log message itself.</p>

      <p>The <strong class="userinput"><code>LEVEL</code></strong> variable is actually unnecessary, since it contains the same value as <strong class="userinput"><code>PRIORITY</code></strong>. The database layout demands both values, however, which is why they must be specified. The entire template definition must be written on one line in the configuration file <strong class="userinput"><code>syslog-ng.conf</code></strong>; it is only line-wrapped here for printing purposes.</p>

      <p>The destination <strong class="userinput"><code>d_eventdb</code></strong> is a named pipe that is fed with the data of the template. The destination <strong class="userinput"><code>df_eventdb</code></strong> is used for debugging purposes and can be used as a substitute or in parallel when you are searching for errors. The data here ends up in a normal log file. Since the same template is used, it produces exactly the same text as is contained in the named pipe.</p>

      <p>The only things missing now are a source, a filter, and a log entry:</p><a id="I_programlisting4_d1e47270"/>
      <pre class="programlisting">source local {
    unix-stream("/dev/log");
    internal();
};
source remote {
   udp( ip(0.0.0.0) port(514) );
};

filter f_warn {
   level(warn .. alert);
};

log {
   source(local); source(remote);
   filter(f_warn);
   destination(d_eventdb);
   # destination(df_eventdb);
};</pre>

      <p>The source <strong class="userinput"><code>local</code></strong> reads all local and system-internal events that arrive at the <strong class="userinput"><code>syslog-ng</code></strong>, but no kernel events. <strong class="userinput"><code>remote</code></strong> describes the classic method of receiving packets from remote syslog daemons via UDP port 514. The filter <strong class="userinput"><code>f_warn</code></strong> covers all events that have a priority (or level) of at least <strong class="userinput"><code>warn</code></strong>. Finally, <strong class="userinput"><code>log</code></strong> writes events from the two sources that are matched by the filter, to the destination <strong class="userinput"><code>d_eventdb</code></strong>.</p>

      <p>The configuration shown uses <strong class="userinput"><code>/var/run/syslog-ng.pipe</code></strong> as a named pipe. Debian-based systems delete the contents of the directory <strong class="userinput"><code>/var/run/</code></strong> when the system is booted, however. For this reason the named pipe must be newly created at each system start. The startup script included with Event-DB, <strong class="userinput"><code>syslog-ng2mysql</code></strong> in the directory <strong class="userinput"><code>agenten/syslog-ng</code></strong>, has been doing this since version 2007-11-30; for older installations you should add the following two lines at the beginning of the script:</p><a id="I_programlisting4_d1e47310"/>
      <pre class="programlisting">FIFO="/var/run/syslog-ng.pipe"
test -p $FIFO || mkfifo $FIFO</pre>

      <p>Then you copy the script to <strong class="userinput"><code>/etc/init.d</code></strong> and ensure, depending on the distribution, that it is run automatically on system start, and certainly before <strong class="userinput"><code>/etc/init.d/syslog-ng</code></strong>.</p>

      <p>The Perl daemon <strong class="userinput"><code>syslog-ng2mysql.pl</code></strong> is also located in the subdirectory <strong class="userinput"><code>agenten/syslog-ng</code></strong>. In this script you need to change the variables <strong class="userinput"><code>$dbuser</code></strong> and <strong class="userinput"><code>$dbpass</code></strong> to match your own MySQL installation:</p><a id="I_programlisting4_d1e47335"/>
      <pre class="programlisting">my $db      = "eventdb";
my $dbhost  = "localhost";
my $dbuser  = "eventdb";
my $dbpass  = <span class="emphasis"><em>"mypasswd";</em></span>
my $dbtable = "events";</pre>

      <p>Then you copy the file to <strong class="userinput"><code>/usr/local/sbin</code></strong>, where the init script expects it to be. With</p><a id="I_programlisting4_d1e47345"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/syslog-ng2mysql start</strong></span>
linux:~ # <span class="strong"><strong>/etc/init.d/syslog-ng restart</strong></span></pre>

      <p>you restart the Perl daemon and perform a restart of the syslog daemon.</p>

      <p>An initial overview of whether events end up in the database can be obtained by entering a simple <strong class="userinput"><code>select *</code></strong> command on the <strong class="userinput"><code>events</code></strong> table:</p><a id="I_programlisting4_d1e47362"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>mysql -u eventdb -p eventdb</strong></span>
mysql&gt; <span class="strong"><strong>select * from events;</strong></span>
...</pre>

      <p>If nothing happens here, you can use the <strong class="userinput"><code>logger</code></strong> program to test whether the syslog daemon is writing entries at all to the log files (for further information, see <strong class="userinput"><code>man logger</code></strong>):</p><a id="I_programlisting4_d1e47378"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>logger -p daemon.warn "hallo wob"</strong></span></pre>

      <p>If no entries appear, despite the syslog working correctly, you should enable the destination <strong class="userinput"><code>df_eventdb</code></strong> and check to see if the output of the template appears correctly formatted.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-4" id="ftn.CHP-23-FN-4">279</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/36;1129">http://www.nagiosexchange.org/36;1129</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="23.3 Using the Web Interface">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="using_the_web_interface"/>23.3 Using the Web Interface</h1>
    </div>

    <p>The Web interface for the EventDB consists of a single PHP file, <strong class="userinput"><code>index.php</code></strong>, which is included in the tarfile in the subdirectory <strong class="userinput"><code>webinterface</code></strong>. It accesses the database directly and therefore requires details of the database, such as user and password. You should check (and change) the following four lines of the file accordingly:<a class="indexterm" id="IDX-CHP-23-1942"/></p><a id="I_programlisting4_d1e47403"/>
    <pre class="programlisting">// Database
cset('db.user', 'eventdb');
cset('db.pass', '<span class="emphasis"><em>mypasswd')</em></span>;
cset('db.host', 'localhost');
cset('db.name', 'eventdb');</pre>

    <p>Then you copy <strong class="userinput"><code>index.php</code></strong> to the (previously created) directory <strong class="userinput"><code>/usr/local/nagios/share/eventdb</code></strong>. The Web interface, as shown in <a class="xref" href="../Text/ch23s03.html#the_web_interface_for_the_eventdb_allow" title="Figure 23-2. The Web interface for the EventDB allows certain entries to be selected, and the administrator the administrator can also set acknowledges for each event via the Web interface.">Figure 23-2</a>, can then be reached via the URL <a class="ulink" href="http://nagios-server/nagios/eventdb/index.php">http://nagios-server/nagios/eventdb/index.php</a>.</p>

    <p>The Web interface is roughly divided into three areas: the selection window at the top, which allows data to be selectively filtered, the event display in the middle, and a third section which allows acknowledges to be commented.</p>

    <div class="figure">
      <a id="the_web_interface_for_the_eventdb_allow"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e47425"/><img alt="The Web interface for the EventDB allows certain entries to be selected, and the administrator the administrator can also set acknowledges for each event via the Web interface." src="../Images/tagoreillycom20081104nostarchimages224010.png.jpg"/></div>

      <p class="title">Figure 23-2. The Web interface for the EventDB allows certain entries to be selected, and the administrator the administrator can also set acknowledges for each event via the Web interface.</p>
    </div>

    <p>The selection filter <span class="strong"><strong>Type</strong></span> refers to the event source, which is normally <span class="strong"><strong>syslog</strong></span>. If SNMP traps are being processed, another type, <span class="strong"><strong>snmptrap</strong></span>, is included. With <span class="emphasis"><em>Host</em></span> you specify the system of origin of the event by means of the host details in the syslog entries. The selection options for <span class="strong"><strong>Facility</strong></span> and <span class="strong"><strong>Priority</strong></span> also correspond to the naming convention used in syslog (see <a class="xref" href="../Text/ch23s02.html#preparing_the_mysql_database-id1" title="23.2.2 Preparing the MySQL database">23.2.2 Preparing the MySQL database</a>).</p>

    <p>If you set a check mark for <span class="strong"><strong>Display acknowledged items, too</strong></span>, the Web interface will display all events. Normally you will just see the events for which there are no acknowledges.</p>

    <p>Of more interest is the <span class="strong"><strong>Text</strong></span> box in the center: At the top you can enter simple patterns. If you are looking for all the entries of the program <strong class="userinput"><code>pluto</code></strong>, for example, you just enter <strong class="userinput"><code>pluto*</code></strong> here. Distinction is made between upper and lower case. More options are provided by regular expressions, which can be specified in the second line: The entry (<strong class="userinput"><code>smbd|nmbd|win/bind</code></strong>) searches for all entries in which either <strong class="userinput"><code>smbd</code></strong>, <strong class="userinput"><code>nmbd</code></strong> or <strong class="userinput"><code>winbind</code></strong> occur. The Regexp search is considerably slower, however. A check mark for <span class="strong"><strong>String not exists</strong></span> negates the previous selection.</p>

    <p>The option <span class="strong"><strong>Message is empty</strong></span> can only be used on its own. It ignores all the other settings in the <span class="strong"><strong>Text</strong></span> box and displays all events that do not contain any message text.</p>

    <p>The <span class="strong"><strong>Display</strong></span> box affects the presentation. You can select different sorting methods, and define the number of entries to be displayed. The default of <strong class="userinput"><code>20</code></strong> entries is too low for many purposes. If the Web interface displays a larger number by default, you should change the following line in the file <strong class="userinput"><code>index.php</code></strong> accordingly:</p><a id="I_programlisting4_d1e47505"/>
    <pre class="programlisting">cset('page.maxrows', 20);</pre>

    <p>The data range shows normal syslog entries, together with the number of the dataset in the database in the <span class="strong"><strong>ID</strong></span> column. For an acknowledgement, you can put a check mark in front of the entry, enter a comment in the lower section if necessary, and select the <span class="strong"><strong>acknowledge</strong></span> button. Confirmed entries disappear when the Web page is reloaded.</p>

    <p>If you want to confirm all entries shown simultaneously, select the <span class="strong"><strong>rev</strong></span> header of the first table column, which inverts the current state of the selection fields. A subsequent acknowledge via the button confirms all entries at the same time.</p>

    <p>The person responsible for an acknowledge is listed in the <span class="strong"><strong>Author</strong></span> line. Once the user has logged in to the Web server, his user name will be given automatically there; otherwise, <span class="strong"><strong>AnonymousGnome</strong></span> will appear as the author. This entry can be overwritten as you please.</p>

    <div class="sect2" title="23.3.1 Preselection of the filter with URL parameters">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="preselection_of_the_filter_with_url"/>23.3.1 Preselection of the filter with URL parameters</h2>
      </div>

      <p>Specific parameters can be passed on to the Web interface through a URL so that a preselection is already made for the call:<a class="indexterm" id="IDX-CHP-23-1943"/></p><a id="I_programlisting4_d1e47538"/>
      <pre class="programlisting">http://<span class="emphasis"><em>nagios-server</em></span>/nagios/eventdb/index.php?host[0]=swobspace</pre>

      <p>This example calls all non-confirmed entries assigned to the host <strong class="userinput"><code>swob-space</code></strong>. The entries for a multiple selection are represented by the Web interface as an array, which is why it must be specified in square brackets for the parameters <strong class="userinput"><code>host</code></strong>, <strong class="userinput"><code>type</code></strong>, <strong class="userinput"><code>facility</code></strong>, and <strong class="userinput"><code>priority</code></strong>. The entries for multiple hosts are queried with a consecutive index: <strong class="userinput"><code>index.php?host[0]=swobspace&amp;host[1]=wobgate</code></strong> or <strong class="userinput"><code>index.php?host[0]=wobgate&amp;host[1]=swobspace</code></strong>—the order of the menu entries in the Web interface does not have to match that of the indices.</p>

      <p>The following CGI parameters can be specified, separated from one another by &amp;:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>type[</code></strong><strong class="userinput"><code><em class="replaceable"><code>index</code></em></code></strong><strong class="userinput"><code>]=</code></strong><strong class="userinput"><code><em class="replaceable"><code>type</code></em></code></strong></span></dt>

          <dd>
            <p>corresponds to the <span class="strong"><strong>Type</strong></span> filter.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>host[</code></strong><strong class="userinput"><code><em class="replaceable"><code>index</code></em></code></strong><strong class="userinput"><code>]=</code></strong><strong class="userinput"><code><em class="replaceable"><code>host</code></em></code></strong></span></dt>

          <dd>
            <p>ensures that the selection is in the <span class="strong"><strong>Host</strong></span> field.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>facility[</code></strong><strong class="userinput"><code><em class="replaceable"><code>index</code></em></code></strong><strong class="userinput"><code>]=</code></strong><strong class="userinput"><code><em class="replaceable"><code>facility</code></em></code></strong></span></dt>

          <dd>
            <p>selects the <span class="strong"><strong>Facility</strong></span> entry.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>priority[</code></strong><strong class="userinput"><code><em class="replaceable"><code>index</code></em></code></strong><strong class="userinput"><code>]=</code></strong><strong class="userinput"><code><em class="replaceable"><code>priority</code></em></code></strong></span></dt>

          <dd>
            <p>corresponds to the <span class="strong"><strong>Priority</strong></span> selection.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>message=</code></strong><strong class="userinput"><code><em class="replaceable"><code>pattern</code></em></code></strong></span></dt>

          <dd>
            <p>the placeholder <strong class="userinput"><code><em class="replaceable"><code>pattern</code></em></code></strong> is replaced by the expression that you would write in the <span class="strong"><strong>Message</strong></span> box. Special characters must first be compiled in HTML-compatible code. Thus, <strong class="userinput"><code>*Bad TCP*</code></strong> is turned into <strong class="userinput"><code>%2Abad%20TCP%2A</code></strong>:<sup>[<a class="footnote" href="#ftn.CHP-23-FN-5" id="CHP-23-FN-5">280</a>]</sup></p><a id="I_programlisting4_d1e47677"/>
            <pre class="programlisting">event.php?message=%2ABad%20TCP%2A</pre>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>regexp=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regular_expression</code></em></code></strong></span></dt>

          <dd>
            <p>allows a regular search expression to be given. As with <strong class="userinput"><code>message</code></strong>, special characters must also be given in an HTML-compatible form.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>displayack=</code></strong><strong class="userinput"><code><em class="replaceable"><code>value</code></em></code></strong></span></dt>

          <dd>
            <p>also displays confirmed entries when set to <strong class="userinput"><code>true</code></strong>. The default is the opposite value, <strong class="userinput"><code>false</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>message_notexists=</code></strong><strong class="userinput"><code><em class="replaceable"><code>value</code></em></code></strong></span></dt>

          <dd>
            <p>simulates setting the check mark in front of <span class="strong"><strong>String not exists</strong></span>: the value <strong class="userinput"><code>true</code></strong> negates the <strong class="userinput"><code>message</code></strong> and <strong class="userinput"><code>regexp</code></strong> selection. The opposite value, <strong class="userinput"><code>false</code></strong>, is the default.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>message_notext=</code></strong><strong class="userinput"><code><em class="replaceable"><code>value</code></em></code></strong></span></dt>

          <dd>
            <p>when set to <strong class="userinput"><code>true</code></strong>, shows only entries with an empty message. Here the default is also <strong class="userinput"><code>false</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>order=</code></strong><strong class="userinput"><code><em class="replaceable"><code>sorting</code></em></code></strong></span></dt>

          <dd>
            <p>enables the sorting order to be defined: <strong class="userinput"><code>ASC</code></strong> for ascending, <strong class="userinput"><code>DESC</code></strong> for descending.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>orderby=</code></strong><strong class="userinput"><code><em class="replaceable"><code>criterion</code></em></code></strong></span></dt>

          <dd>
            <p>defines the field by which sorting should be done: <strong class="userinput"><code>datetime</code></strong>, <strong class="userinput"><code>priority</code></strong>, <strong class="userinput"><code>host</code></strong>, <strong class="userinput"><code>facility</code></strong>, or <strong class="userinput"><code>uid</code></strong> (database index).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>displayrows=</code></strong><strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong></span></dt>

          <dd>
            <p>defines the number of rows to be displayed.</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="sect2" title="23.4 The Nagios Plugin for the EventDB">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="the_nagios_plugin_for_the_eventdb"/>23.4 The Nagios Plugin for the EventDB</h2>
      </div>

      <p>Querying the EventDB from Nagios is done with the plugin <strong class="userinput"><code>check_event-db.pl</code></strong> in the subdirectory <strong class="userinput"><code>plugin</code></strong>, which is copied to the directory <strong class="userinput"><code>/usr/local/nagios/libexec/</code></strong>. It has the following options:<a class="indexterm" id="IDX-CHP-23-1944"/><a class="indexterm" id="IDX-CHP-23-1945"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>--db=</code></strong><strong class="userinput"><code><em class="replaceable"><code>database_name</code></em></code></strong></span></dt>

          <dd>
            <p>The name of the EventDB. This is only specified if it is different from the default <strong class="userinput"><code>eventdb</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--dbtable</code></strong>=<strong class="userinput"><code><em class="replaceable"><code>database_table</code></em></code></strong></span></dt>

          <dd>
            <p>The event table in the database. The default <strong class="userinput"><code>events</code></strong> is rarely changed.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--dbuser=</code></strong><strong class="userinput"><code><em class="replaceable"><code>database_user</code></em></code></strong></span></dt>

          <dd>
            <p>This parameter must always be given, since <strong class="userinput"><code>none</code></strong> is set by default for the database user.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--dbpassword=</code></strong><strong class="userinput"><code><em class="replaceable"><code>database_password</code></em></code></strong></span></dt>

          <dd>
            <p>The same applies for the password for this user.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--dbhost=</code></strong><strong class="userinput"><code><em class="replaceable"><code>database_host</code></em></code></strong></span></dt>

          <dd>
            <p>Details of the host on which the database is running. The default is set to <strong class="userinput"><code>localhost</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>hostname</code></em></code></strong> <strong class="userinput"><code>/--host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>hostname</code></em></code></strong></span></dt>

          <dd>
            <p>Host from which the message in the syslog really originates.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>priority</code></em></code></strong> <strong class="userinput"><code>/ --priority=</code></strong><strong class="userinput"><code><em class="replaceable"><code>priority</code></em></code></strong></span></dt>

          <dd>
            <p>The desired syslog priority (or level), for example <strong class="userinput"><code>warning</code></strong>, <strong class="userinput"><code>err</code></strong>, or <strong class="userinput"><code>crit</code></strong>. For other information, see <strong class="userinput"><code>man 3 syslog</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-f</code></strong> <strong class="userinput"><code><em class="replaceable"><code>facility</code></em></code></strong> <strong class="userinput"><code>/ --facility=</code></strong><strong class="userinput"><code><em class="replaceable"><code>facility</code></em></code></strong></span></dt>

          <dd>
            <p>The syslog facility to be queried, such as <strong class="userinput"><code>cron</code></strong>, <strong class="userinput"><code>daemon</code></strong>, or <strong class="userinput"><code>auth</code></strong> (see also <strong class="userinput"><code>man 3 syslog</code></strong>).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-m</code></strong> <strong class="userinput"><code><em class="replaceable"><code>text</code></em></code></strong> <strong class="userinput"><code>/ --message=</code></strong><strong class="userinput"><code><em class="replaceable"><code>text</code></em></code></strong></span></dt>

          <dd>
            <p>The event text for which the plugin should look. It starts with the name of the program from which the message originates. If you are looking for entries from the program <strong class="userinput"><code>snmpd</code></strong>, you enter <strong class="userinput"><code>-m ' snmpd*'</code></strong>. As wildcards, <strong class="userinput"><code>*</code></strong> (shell syntax) and <strong class="userinput"><code>%</code></strong> (SQL syntax) can be used equivalently; the plugin replaces <strong class="userinput"><code>*</code></strong> with <strong class="userinput"><code>%</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>type</code></em></code></strong> <strong class="userinput"><code>/ --type=</code></strong><strong class="userinput"><code><em class="replaceable"><code>type</code></em></code></strong></span></dt>

          <dd>
            <p>Event type, usually <strong class="userinput"><code>syslog</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-l</code></strong> <strong class="userinput"><code><em class="replaceable"><code>prefix</code></em></code></strong> <strong class="userinput"><code>/ --label=</code></strong><strong class="userinput"><code><em class="replaceable"><code>prefix</code></em></code></strong></span></dt>

          <dd>
            <p>Text placed in front of the plugin output in order to better identify a specific check.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

          <dd>
            <p>If the plugin finds at least <span class="emphasis"><em>integer</em></span> matches it will issue a WARNING.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

          <dd>
            <p>If the plugin finds at least <span class="emphasis"><em>integer</em></span> matches it will issue a CRITICAL.</p>
          </dd>
        </dl>
      </div>

      <p>The following plugin call looks for all error messages with the priority <strong class="userinput"><code>err</code></strong> from the <strong class="userinput"><code>daemon</code></strong> facility that originate from the <strong class="userinput"><code>snmpd</code></strong> and contain any type of message text. If the plugin finds one entry, it should issue a WARNING; if it find two or more, it should issue a CRITICAL:</p><a id="I_programlisting4_d1e48087"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_eventdb.pl --dbuser=eventdb</strong></span> \
<span class="strong"><strong>    --dbpassword=secret --facility daemon --priority err -m "snmpd%" \</strong></span>
<span class="strong"><strong>    -w 1 -c 2 --label=syslog-snmpd</strong></span>
CRITICAL: syslog-snmpd 6 matches found!|matches=6</pre>

      <p><strong class="userinput"><code>--label</code></strong> prefixes the actual result to the <strong class="userinput"><code>syslog-snmpd</code></strong> text, so that the statement can be more easily interpreted.<a class="indexterm" id="IDX-CHP-23-1946"/></p>

      <p>The command definition is kept really simple, due to the fact that the actual logic is stored in the service definition. The entire <strong class="userinput"><code>command_line</code></strong> must, as before, be written in a single line:</p><a id="I_programlisting4_d1e48115"/>
      <pre class="programlisting">define command {
   command_name check_eventdb
   command_line $USER1$/check_eventdb.pl --dbuser=eventdb --dbpass=$USER
9$ $ARG1$
}</pre>

      <p>Database user and password are firmly joined together here. So that no password is visible at this point, we use the macro <strong class="userinput"><code>$USER9$</code></strong> from the resources file (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). All other parameters are specified by the service definition for <strong class="userinput"><code>$ARG1$</code></strong>, for example, as follows:</p><a id="I_programlisting4_d1e48127"/>
      <pre class="programlisting">define service {
    host_name             nagios
    service_description syslog_snmpd
    check_command       check_eventdb!--facility daemon --priority err -m
    "snmpd%" -w 1 -c 2 --label=syslog-snmpd
    ...
}</pre>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-5" id="ftn.CHP-23-FN-5">280</a>]</sup> A special character is converted to <strong class="userinput"><code>%</code></strong> followed by its hexadecimal value: a space corresponds to 20, a <strong class="userinput"><code>*</code></strong>, to 2A; see <strong class="userinput"><code>man ascii</code></strong>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="23.5 Maintenance">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="maintenance"/>23.5 Maintenance</h1>
    </div>

    <p>The MySQL database can, under some circumstances—depending on the number of connected systems and events passed on by the syslog—fill up very quickly. Then it is time to clean up. To do this you need to find all the entries that are older than a certain date, test whether an acknowledge exists for them, and delete them. The following <strong class="userinput"><code>SELECT</code></strong> statement demonstrates the principle:</p><a id="I_programlisting4_d1e48137"/>
    <pre class="programlisting">user@linux:~$ <span class="strong"><strong>mysql -u eventdb -p eventdb</strong></span>
mysql&gt; <span class="strong"><strong>SELECT * FROM events WHERE datetime &lt; '2007-11-16'</strong></span>
    -&gt; <span class="strong"><strong>AND acknowledged;</strong></span></pre>

    <p>The date is stored by MySQL in the format <strong class="userinput"><code><em class="replaceable"><code>YYYY-mm-dd HH:MM:SS</code></em></code></strong>, which is why a simple string comparison works. If an admin has confirmed an entry, the <strong class="userinput"><code>acknowledged</code></strong> field will contain the value <strong class="userinput"><code>1</code></strong>. The following simple cleanup script deletes all confirmed entries that are more than two weeks old:</p><a id="I_programlisting4_d1e48159"/>
    <pre class="programlisting">#!/bin/bash
OLDDATE='date --date '-2 weeks' "+%Y-%m-%d %H:%M:%S"'
MYSQL="mysql --user=eventdb --password<span class="emphasis"><em>mypassword</em></span> eventdb"

$MYSQL --execute="DELETE FROM events WHERE datetime &lt; '$OLDDATE' AND acknowledged;"
$MYSQL --execute="optimize table events;"</pre>

    <p>The script is run daily via cron, but not before it has been thoroughly tested. If you want to archive data before it is deleted, you need to export it <span class="emphasis"><em>prior to</em></span> the <strong class="userinput"><code>DELETE</code></strong> statement. To do this, you add the SQL statement <strong class="userinput"><code>INTO OUTFILE</code></strong> to the <strong class="userinput"><code>SELECT</code></strong> command introduced above, between <strong class="userinput"><code>SELECT *</code></strong> and <strong class="userinput"><code>FROM</code></strong>. This saves data to a text file, with tabs as separators, as shown below:</p><a id="I_programlisting4_d1e48185"/>
    <pre class="programlisting">SELECT *
   INTO OUTFILE '/var/backups/eventdb/$OLDDATE.txt'
   FIELDS TERMINATED BY '\t'
   FROM events WHERE datetime &lt; '2007-11-16' AND acknowledged;</pre>

    <p>The EventDB tarfile contains the two example scripts <strong class="userinput"><code>eventdb-clean_database.sh</code></strong> and <strong class="userinput"><code>rotate_eventdb.sh</code></strong> in the <strong class="userinput"><code>cleanup</code></strong> subdirectory, which essentially call the functions just described. You should nevertheless carefully consider how you are going to clean up the database, and modify and test the scripts accordingly.</p>
  </div>


  <div class="sect1" title="23.6 Sending Windows Events to Syslog">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="sending_windows_events_to_syslog"/>23.6 Sending Windows Events to Syslog</h1>
    </div>

    <p>In order to integrate Windows systems into a syslog environment, you need a service that reads out the Windows event log and sends this on via the syslog protocol to the central Syslog server. This task is performed by the freely available and easy-to-install <strong class="userinput"><code>evtsys</code></strong> tool (an abbreviation of the project name <span class="emphasis"><em>Eventlog to Syslog</em></span>), from the homepage of the Engineering Computer Network of Purdue University<sup>[<a class="footnote" href="#ftn.CHP-23-FN-6" id="CHP-23-FN-6">281</a>]</sup> The Web page provides two binary packages for download, one for 32-bit and one for 64-bit systems (<strong class="userinput"><code>evtsys_exe_32.zip</code></strong> or <strong class="userinput"><code>evtsys_exe_64.zip</code></strong>), along with the source code.<a class="indexterm" id="IDX-CHP-23-1947"/><a class="indexterm" id="IDX-CHP-23-1948"/><a class="indexterm" id="IDX-CHP-23-1949"/></p>

    <p>The files <strong class="userinput"><code>evtsys.exe</code></strong> and <strong class="userinput"><code>evtsys.dll</code></strong> contained in the package are copied to the subdirectory <strong class="userinput"><code>system32</code></strong> of the system root of the Windows server (usually <strong class="userinput"><code>C:\Windows\system32</code></strong>). The service is then installed and activated with the command</p><a id="I_programlisting4_d1e48248"/>
    <pre class="programlisting">C:\Windows\system32&gt; <span class="strong"><strong>evtsys -i -h</strong></span> <span class="bolditalic">syslogserver</span>
C:\Windows\system32&gt; <span class="strong"><strong>net start evtsys</strong></span></pre>

    <p>If the current <strong class="userinput"><code>evtsys</code></strong> version is to be installed on a system on which the service is already running, you must first de-install the old version entirely:</p><a id="I_programlisting4_d1e48263"/>
    <pre class="programlisting">C:\Windows\system32&gt; <span class="strong"><strong>net stop evtsys</strong></span>
C:\Windows\system32&gt; <span class="strong"><strong>evtsys -u</strong></span></pre>

    <p><strong class="userinput"><code>evtsys</code></strong> sends all event log entries without exception to the central syslog server. Messages go the <strong class="userinput"><code>daemon</code></strong> facility, and possible priorities are <strong class="userinput"><code>notice</code></strong>, <strong class="userinput"><code>warning</code></strong>, and <strong class="userinput"><code>err</code></strong>.</p>

    <p>In all cases you should make use of the extensive filter options of the <strong class="userinput"><code>syslog-ng</code></strong> on the syslog server, since the security messages from a single domain controller alone may total 1,000 or more entries per hour, even in small environments!</p>

    <p>If you want to filter event log entries first on the Windows side, you will need to use other services. One tool that is free, but also rather old, and which may not work faultlessly from Windows 2003 R2 onward, is NTsyslog.<sup>[<a class="footnote" href="#ftn.CHP-23-FN-7" id="CHP-23-FN-7">282</a>]</sup> You will also find various commercial solutions on the Internet that can be purchased.<a class="indexterm" id="IDX-CHP-23-1950"/></p>

    <p>Another filter option for Windows is provided by the <span class="emphasis"><em>Nagios EventLog Agent for Windows</em></span>, <strong class="userinput"><code>nagevtlog</code></strong>, by Steve Shipway,<sup>[<a class="footnote" href="#ftn.CHP-23-FN-8" id="CHP-23-FN-8">283</a>]</sup> which is also available on NagiosExchange.<sup>[<a class="footnote" href="#ftn.CHP-23-FN-9" id="CHP-23-FN-9">284</a>]</sup> But this is not compatble with the EventDB, since data is sent via NSCA to the Nagios server.<a class="indexterm" id="IDX-CHP-23-1951"/></p>

    <p>All services that provide filtering on the Windows side have one disadvantage: Unknown events may, under certain circumstances, not even end up in the syslog and must be individually supplemented in the configuration. Provided that the central syslog server can cope with the flood of data, the approach with a central filter is easier to maintain.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-6" id="ftn.CHP-23-FN-6">281</a>]</sup> <a class="ulink" href="https://engineering.purdue.edu/ECN/Resources/Documents/UNIX/evtsys/">https://engineering.purdue.edu/ECN/Resources/Documents/UNIX/evtsys/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-7" id="ftn.CHP-23-FN-7">282</a>]</sup> <a class="ulink" href="http://ntsyslog.sourceforge.net/">http://ntsyslog.sourceforge.net/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-8" id="ftn.CHP-23-FN-8">283</a>]</sup> <a class="ulink" href="http://www.steveshipway.org/software/f_nagios.html">http://www.steveshipway.org/software/f_nagios.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-9" id="ftn.CHP-23-FN-9">284</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/49;221">http://www.nagiosexchange.org/49;221</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="23.7 Making the Incomprehensible Legible with SNMPTT">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="making_the_incomprehensible_legible_with"/>23.7 Making the Incomprehensible Legible with SNMPTT</h1>
    </div>

    <p>The <span class="emphasis"><em>SNMP Trap Translator (SNMPTT)</em></span><sup>[<a class="footnote" href="#ftn.CHP-23-FN-10" id="CHP-23-FN-10">285</a>]</sup> translates numerical object identifiers, which are difficult to understand, to readable text by means of the accompanying MIB.<sup>[<a class="footnote" href="#ftn.CHP-23-FN-11" id="CHP-23-FN-11">286</a>]</sup> To install this, you unpack the SNMPTT sources from Sourceforge<sup>[<a class="footnote" href="#ftn.CHP-23-FN-12" id="CHP-23-FN-12">287</a>]</sup> to <strong class="userinput"><code>/usr/local/src</code></strong>:<a class="indexterm" id="IDX-CHP-23-1953"/><a class="indexterm" id="IDX-CHP-23-1952"/></p><a id="I_programlisting4_d1e48356"/>
    <pre class="programlisting">linux:local/src # <span class="strong"><strong>tar xvzf /</strong></span><span class="bolditalic">pfad</span><span class="emphasis"><em>/snmptt_1.2.tgz</em></span>
linux:local/src # <span class="strong"><strong>cd snmptt_1.2</strong></span>
linux:src/snmptt_1.2 # <span class="strong"><strong>cp snmptt snmptthandler snmpttconvertmib /usr/sbin/</strong></span>.
linux:src/snmptt_1.2 # <span class="strong"><strong>chmod +x /usr/sbin/snmptt*</strong></span>
linux:src/snmptt_1.2 # <span class="strong"><strong>cp snmptt.ini /etc/snmp/</strong></span>.</pre>

    <p>The files <strong class="userinput"><code>snmptt</code></strong>, <strong class="userinput"><code>snmptthandler</code></strong>, and <strong class="userinput"><code>snmpttconvertmib</code></strong> contained in the archive are copied to <strong class="userinput"><code>/usr/sbin</code></strong> and made executable with <strong class="userinput"><code>chmod</code></strong>. The configuration file <strong class="userinput"><code>snmptt.ini</code></strong> is copied to the directory <strong class="userinput"><code>/etc/snmp</code></strong>, which was set up during the installation of the <strong class="userinput"><code>snmpd</code></strong> package.</p>

    <p>SNMP traps are accepted by the <strong class="userinput"><code>snmptrapd</code></strong>. In order for this to forward them to <strong class="userinput"><code>snmptt</code></strong>, the following is entered in the <strong class="userinput"><code>snmptrapd.conf</code></strong> configuration file:<a class="indexterm" id="IDX-CHP-23-1954"/></p><a id="I_programlisting4_d1e48419"/>
    <pre class="programlisting"># /etc/snmp/snmptrapd.conf
traphandle default /usr/sbin/snmptt</pre>

    <p>So that all traps are forwarded to <strong class="userinput"><code>snmptt</code></strong>, the file may contain only this default rule. <strong class="userinput"><code>snmptt</code></strong> accepts the object identifier in a numerical form, which is why <strong class="userinput"><code>snmptrapd</code></strong> needs to be started with the <strong class="userinput"><code>-On</code></strong> option. Depending on the distribution, the <strong class="userinput"><code>snmptrapd</code></strong> startup script may need to be adjusted. For Debian the file <strong class="userinput"><code>/etc/default/snmpdis</code></strong> modified accordingly:</p><a id="I_programlisting4_d1e48442"/>
    <pre class="programlisting"># /etc/default/snmpd (Debian)
...
TRAPDRUN=<span class="strong"><strong>yes</strong></span>
TRAPDOPTS='-Lsd <span class="strong"><strong>-On</strong></span> -p /var/run/snmptrapd.pid'</pre>

    <p>The <strong class="userinput"><code>-Lsd</code></strong> option logs all traps for debugging purposes in parallel via syslog. This should be switched off later on, by replacing <strong class="userinput"><code>-Lsd</code></strong> with <strong class="userinput"><code>-t</code></strong>.</p>

    <div class="sect2" title="23.7.1 The configuration file snmptt.ini">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="the_configuration_file_snmptt.ini"/>23.7.1 The configuration file <strong class="userinput"><code>snmptt.ini</code></strong></h2>
      </div>

      <p>To describe all the parameters of the central SNMPTT configuration file <strong class="userinput"><code>/etc/snmp/snmptt.ini</code></strong> would go beyond the scope of this book. We will just look at the sections and options that can be checked and which might need to be adjusted:<a class="indexterm" id="IDX-CHP-23-1955"/></p><a id="I_programlisting4_d1e48474"/>
      <pre class="programlisting">[General]
mode = standalone
net_snmp_perl_enable = <span class="strong"><strong>1</strong></span>
mibs_environment = <span class="strong"><strong>ALL</strong></span>
...
[Logging]
log_enable = 1
log_system_enable = 1
unknown_trap_log_enable = 1
syslog_enable = 1
syslog_level = warning
...
[TrapFiles]
snmptt_conf_files = &lt;&lt;END
<span class="strong"><strong>/etc/snmp/snmptt/snmptt.conf</strong></span>
<span class="strong"><strong>/etc/snmp/snmptt/messbox.conf</strong></span>
END</pre>

      <p>The setting <strong class="userinput"><code>mode=stardlone</code></strong> in the <strong class="userinput"><code>[General]</code></strong> section states that the <strong class="userinput"><code>snmptrapd</code></strong> calls <strong class="userinput"><code>snmptt</code></strong> directly. With <strong class="userinput"><code>mode=daemon</code></strong>, SNMPTT runs as a separate daemon. <strong class="userinput"><code>net_snmp_perl_enable=1</code></strong> enables the use of the Perl module SNMP, which translates OIDs into meaningful text. Since the default <strong class="userinput"><code>0</code></strong> disables the module, this parameter certainly needs to be changed. <strong class="userinput"><code>mibs_environment=ALL</code></strong> integrates all installed MIBs. These must be free of errors, however, which is normally the case for MIBs installed from the distribution (for Debian, in the package <strong class="userinput"><code>libsnmp-base</code></strong>).</p>

      <p>The parameter <strong class="userinput"><code>snmptt_conf_files</code></strong> in the <strong class="userinput"><code>[TrapFiles]</code></strong> section contains a list of configuration files that translate incoming SNMP traps and set off actions, if necessary. These are obtained from the MIB belonging to the device—how this is done is explained in <a class="xref" href="../Text/ch23s06.html#converting_mibs" title="23.7.2 Converting MIBs">23.7.2 Converting MIBs</a>.</p>

      <p>The three variables <strong class="userinput"><code>log_enable=1</code></strong>, <strong class="userinput"><code>log_system_enable=1</code></strong>, and <strong class="userinput"><code>unknown_trap_log_enable=1</code></strong> in the <strong class="userinput"><code>[Logging]</code></strong> section ensure that SNMPTT logs its activities to <strong class="userinput"><code>/var/log/snmptt*</code></strong>, which is very useful when searching for errors. By logging unknown traps, with <strong class="userinput"><code>unknown_trap_log_enable=1</code></strong>, you can see why SNMPTT does not translate a trap that it has received (for example, perhaps it contains OIDs other than those intended from the configuration file obtained from the MIB).</p>

      <p>The two <strong class="userinput"><code>syslog_*</code></strong> parameters forward translated traps to the syslog daemon here with the syslog priority <strong class="userinput"><code>warning</code></strong> so that the data will then appear in the EventDB.</p>

      <p>The parameters allowed in <strong class="userinput"><code>snmptt.ini</code></strong> and in the device-dependent configuration files are documented in detail on the SNMPTT homepage.<sup>[<a class="footnote" href="#ftn.CHP-23-FN-13" id="CHP-23-FN-13">288</a>]</sup></p>
    </div>

    <div class="sect2" title="23.7.2 Converting MIBs">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="converting_mibs"/>23.7.2 Converting MIBs</h2>
      </div>

      <p>The included program <strong class="userinput"><code>snmpttconvertmib</code></strong> converts existing MIBs into a configuration file which can be used by SNMPTT. The translator only translates files that are explicitly listed in configuration files which have been integrated with <strong class="userinput"><code>snmptt_conf_files</code></strong>.<a class="indexterm" id="IDX-CHP-23-1956"/><a class="indexterm" id="IDX-CHP-23-1957"/><a class="indexterm" id="IDX-CHP-23-1958"/><a class="indexterm" id="IDX-CHP-23-1959"/><a class="indexterm" id="IDX-CHP-23-1960"/></p>

      <p><strong class="userinput"><code>snmptt convertmib</code></strong> uses <strong class="userinput"><code>snmptranslate</code></strong>, so before using this you should check that the actual translation program works properly. To do this, run <strong class="userinput"><code>snmptranslate -m ALL</code></strong> without any other parameters. An online help will appear, starting with the following lines:</p><a id="I_programlisting4_d1e48609"/>
      <pre class="programlisting">USAGE: snmptranslate [OPTIONS] OID [OID]...</pre>

      <p>No other error message should appear before this line; if one does, this means that the MIBs are not correctly installed. If the MIBs were installed directly from the distribution, no errors should occur.</p>

      <p>The conversion process—depending on the quality of the MIB—ranges from very simple (for correctly formed MIBs) to almost impossible (for MIBs with many errors). A flawless MIB is provided by Debian, for example, in the file <strong class="userinput"><code>rfcl628-UPS.mib</code></strong>. This distribution stores the MIBs in the directory <strong class="userinput"><code>/usr/share/snmp/mibs</code></strong>.</p>

      <p>Before you start looking for and installing MIBs from other sources, you should test the conversion with a "clean" MIB. The already mentioned UPS-MIB is converted as follows to an SNMPTT configuration file:</p><a id="I_programlisting4_d1e48623"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>/usr/sbin/snmpttconvertmib</strong></span> \
<span class="strong"><strong>    --in=/usr/share/snmp/mibs/rfc1628-UPS.mib</strong></span> \
<span class="strong"><strong>    --out=rfc1628-UPS.conf</strong></span>
....
Done

Total translations:            4
Successful translations:       4
Failed translations:           0</pre>

      <p>No error should appear in the summary at the end of the output, as is the case here. The contents of the new configuration file now appear as follows:</p><a id="I_programlisting4_d1e48636"/>
      <pre class="programlisting">EVENT upsTrapOnBattery .1.3.6.1.2.1.33.2.1 "Status Events" CRITICAL
FORMAT UPS On Battery - Utility Power Failure: The UPS is operating on ba
ttery power (Minutes Remaining=%0 Seconds on Battery=$1)
...</pre>

      <p>The two decisive entries here are <strong class="userinput"><code>EVENT</code></strong> and <strong class="userinput"><code>FORMAT</code></strong>. The first contains the status (here: CRITICAL) together with the OID, while <strong class="userinput"><code>FORMAT</code></strong> defines the text with which a corresponding event is described in the syslog, and thus in the EventDB. More information can be found in the <span class="strong"><strong>ConvertMIB</strong></span> documentation on the SNMPTT homepage.<sup>[<a class="footnote" href="#ftn.CHP-23-FN-14" id="CHP-23-FN-14">289</a>]</sup></p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-10" id="ftn.CHP-23-FN-10">285</a>]</sup> <a class="ulink" href="http://www.snmptt.org/">http://www.snmptt.org/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-11" id="ftn.CHP-23-FN-11">286</a>]</sup> For SNMP, see <a class="xref" href="../Text/ch11.html" title="Chapter 11. Collecting Information Relevant for Monitoring with SNMP">Chapter 11</a> from page 227; SNMP traps were described in <a class="xref" href="../Text/ch14s06.html" title="14.6 Application Example II: Processing SNMP Traps">14.6 Application Example II: Processing SNMP Traps</a> from page 312.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-12" id="ftn.CHP-23-FN-12">287</a>]</sup> <a class="ulink" href="http://www.sourceforge.net/projects/snmptt">http://www.sourceforge.net/projects/snmptt</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-13" id="ftn.CHP-23-FN-13">288</a>]</sup> <a class="ulink" href="http://www.snmptt.org/docs/snmptt.shtml">http://www.snmptt.org/docs/snmptt.shtml</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-23-FN-14" id="ftn.CHP-23-FN-14">289</a>]</sup> <a class="ulink" href="http://www.snmptt.org/docs/snmpttconvertmib.shtml">http://www.snmptt.org/docs/snmpttconvertmib.shtml</a></p>
      </div>
    </div>
  </div>
</body></html>