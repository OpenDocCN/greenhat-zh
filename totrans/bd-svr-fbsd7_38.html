<html><head></head><body>

<div class="calibre1"><div class="calibre1"><a name="ntp_server_4.2.2" class="calibre8" id="ntp_server_4.2.2"/>
<div class="calibre24" id="calibre_pb_0"/><h2 id="title-ID0E3LPM" class="docPrefaceTitle">Chapter 15. NTP SERVER 4.2.2</h2>
<h4 class="calibre32"><a class="calibre2" target="_blank" href="HTTP://NTP.ISC.ORG">HTTP://NTP.ISC.ORG</a></h4>
<a name="summary-id14" class="calibre8" id="summary-id14"/>
<h3 class="docSection1Title" id="-100000">15.1. SUMMARY</h3>
<p class="docText1"><span class="docEmphasis1"><a name="NTP " class="calibre8" id="NTP "/>NTP (Network Time Protocol)</span><a name="Internet protocol" class="calibre8" id="Internet protocol"/> is an Internet protocol used for synchronizing the clocks of networked computers. Computer clock accuracy is instrumental in providing a consistent reference for system log files, email timestamps, time-activated scripts, and so on. The NTP system is capable of keeping your computer's clock accurate to within a few milliseconds of an accurate time server. Time servers are usually connected directly to a source of accurate time (e.g., atomic or GPS clocks).<a name="IDX-CHP-15-0226" class="calibre8" id="IDX-CHP-15-0226"/><a name="IDX-CHP-15-0227" class="calibre8" id="IDX-CHP-15-0227"/><a name="IDX-CHP-15-0228" class="calibre8" id="IDX-CHP-15-0228"/></p>
<p class="docText1"><a name="a hierarchy" class="calibre8" id="a hierarchy"/>The NTP system consists of a hierarchy, or <span class="docEmphasis1">strata</span><a name="and private" class="calibre8" id="and private"/>, of public and private servers. A <span class="docEmphasis1">stratum 1</span><a name="clock with" class="calibre8" id="clock with"/> server synchronizes its clock with an accurate external GPS (Global Positioning System) clock, radio clock, or other highly accurate time-keeping device. A <span class="docEmphasis1">stratum 2</span><a name="more stratum" class="calibre8" id="more stratum"/> server derives its clock data from one or more stratum 1 servers, a <span class="docEmphasis1">stratum 3</span><a name="or more" class="calibre8" id="or more"/> server derives its clock data from one or more stratum 2 servers, and so on. Servers at the lower stratum levels (numerically speaking) are not necessarily more accurate. The accuracy of the time source, geographic location, and network latency all contribute to the accuracy of a time server.</p>
<p class="docText1"><a name="to one" class="calibre8" id="to one"/>A server running the NTP daemon periodically synchronizes its clock to one or more established time servers. Over time, the NTP daemon calculates the system-specific clock error. If the system temporarily loses Internet connectivity, the NTP daemon will keep the system clock accurate using this error (or <span class="docEmphasis1">clock drift</span>) data until it can re-synchronize with a time server.</p>
<p class="docText1"><a name="originally developed" class="calibre8" id="originally developed"/>David Mills, a professor at the University of Delaware, originally developed NTP in the early '80s. NTP was initially named the Internet Clock Service and was created to provide clock synchronization for the HELLO routing protocol. These early versions of NTP were less accurate than today's because they did not have any frequency correction abilities. Mills, along with a team of volunteers, continues to develop NTP.<a name="IDX-CHP-15-0229" class="calibre8" id="IDX-CHP-15-0229"/></p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="resources-id14" class="calibre8" id="resources-id14"/>
<h3 class="docSection1Title" id="-100000">15.2. RESOURCES</h3>
<p class="docText1"><span class="b"><a name="NTP Documentation" class="calibre8" id="NTP Documentation"/>NTP Documentation Index</span></p>
<p class="docText1"><a class="calibre2" target="_blank" href="http://ntp.isc.org/bin/view/Main/DocumentationIndex">http://ntp.isc.org/bin/view/Main/DocumentationIndex</a></p>
<p class="docText1"><span class="b"><a name="Time Protocol" class="calibre8" id="Time Protocol"/>RFC 4330 - Network Time Protocol Version 4</span></p>
<p class="docText1"><a class="calibre2" target="_blank" href="http://tools.ietf.org/html/rfc4330">http://tools.ietf.org/html/rfc4330</a></p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="required-id14" class="calibre8" id="required-id14"/>
<h3 class="docSection1Title" id="-100000">15.3. REQUIRED</h3>
<p class="docText1"><img border="0" id="" src="OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg" alt="" class="calibre33"/><a name="FreeBSD " class="calibre8" id="FreeBSD "/> FreeBSD 7.0-RELEASE (see "<a class="calibre2" href="freebsd_7.0_split_000.html#freebsd_7.0">FreeBSD 7.0</a>")</p>
<p class="docText1"><img border="0" id="" src="OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg" alt="" class="calibre33"/><a name="collection " class="calibre8" id="collection "/> Updated ports collection (see "<a class="calibre2" href="freebsd_ports_collection.html#freebsd_ports_collection">FreeBSD Ports Collection</a>")</p>
<p class="docText1"><img border="0" id="" src="OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg" alt="" class="calibre33"/> Internet connection</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="optional-id6" class="calibre8" id="optional-id6"/>
<h3 class="docSection1Title" id="-100000">15.4. OPTIONAL</h3>
<p class="docText1"><img border="0" id="" src="OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg" alt="" class="calibre33"/><a name="Registered domain" class="calibre8" id="Registered domain"/> Registered domain name<a name="IDX-CHP-15-0230" class="calibre8" id="IDX-CHP-15-0230"/><a name="IDX-CHP-15-0231" class="calibre8" id="IDX-CHP-15-0231"/></p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="preparation-id14" class="calibre8" id="preparation-id14"/>
<h3 class="docSection1Title" id="-100000">15.5. PREPARATION</h3>
<p class="docText1"><a name="Become the" class="calibre8" id="Become the"/>Become the superuser.</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="install-id14" class="calibre8" id="install-id14"/>
<h3 class="docSection1Title" id="-100000">15.6. INSTALL</h3>
<p class="docText1"><a name="Although NTP" class="calibre8" id="Although NTP"/>Although NTP 4.2.0 is included in the standard FreeBSD 7.0 distribution, we will install an updated version of NTP from the ports collection. Enter the following commands to begin the installation:</p>
<pre class="calibre30"># <b class="calibre28">cd /usr/ports/net/ntp</b>
# <b class="calibre28">make config ; make install clean</b>
# <b class="calibre28">rehash</b></pre>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="configure-id14" class="calibre8" id="configure-id14"/>
<h3 class="docSection1Title" id="-100000">15.7. CONFIGURE</h3>
<p class="docText1"><a name="Once the" class="calibre8" id="Once the"/>Once the installation process is complete, it's time to configure NTP for use on your system.</p>
<div class="calibre34"><ol class="docList" type="1"><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="default search" class="calibre8" id="default search"/>Change the default search path. FreeBSD's base version of NTP uses the same filenames as the version we installed from the ports system. If the search path has not been changed from its default, NTP-related commands will run the FreeBSD base version rather than the new version from ports. See "<a class="calibre2" href="configure.html#default_search_path">Default Search Path</a><a name="default search" class="calibre8" id="default search"/>" for details on changing the default search path.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Create a <span class="docEmphasis1">drift file</span><a name="clock correction" class="calibre8" id="clock correction"/> for storing clock correction data. The following command creates this file in the <span class="docEmphasis1">/etc/ntp</span> directory:</p><pre class="calibre30"># <b class="calibre28">touch /etc/ntp/drift</b></pre>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="servers for" class="calibre8" id="servers for"/>Select appropriate time servers for synchronization. Visit <a class="calibre2" target="_blank" href="http://ntp.isc.org/bin/view/Servers/StratumTwoTimeServers">http://ntp.isc.org/bin/view/Servers/StratumTwoTimeServers</a><a name="at least" class="calibre8" id="at least"/> for an updated list of public time servers. Select at least three servers from the list. Pick servers that are listed as <span class="docEmphasis1">OpenAccess</span> and located in your geographic vicinity.</p><hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> See NTP's web page on Rules of Engagement for recommendations on selecting time servers: <a class="calibre2" target="_blank" href="http://support.ntp.org/bin/view/Servers/RulesOfEngagement">http://support.ntp.org/bin/view/Servers/RulesOfEngagement</a>.</span><hr size="1" noshade="noshade" class="calibre27"/></div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Create a new configuration file named <span class="docEmphasis1">ntp.conf</span>:</p><pre class="calibre30"># <b class="calibre28">ee /etc/ntp.conf</b></pre><br class="calibre1"/>
<p class="docText1">and add the following configuration options:</p><pre class="calibre30">server <tt class="calibre20"><i class="docEmphasis1">time.example1.com</i></tt> iburst
server <tt class="calibre20"><i class="docEmphasis1">time.example2.com</i></tt> iburst
server <tt class="calibre20"><i class="docEmphasis1">time.example3.com</i></tt> iburst
driftfile /etc/ntp/drift
logfile /var/log/ntp.log</pre><br class="calibre1"/>
<p class="docText1"><a name="those you" class="calibre8" id="those you"/>Replace the hostnames of the servers (in italics) with those you have picked. The <tt class="calibre20">iburst</tt> modifier allows the NTP daemon to speed up initial synchronization. The <tt class="calibre20">driftfile</tt><a name="drift file" class="calibre8" id="drift file"/> statement tells the NTP daemon where to look for the drift file (created in step 2). The <tt class="calibre20">logfile</tt><a name="the log" class="calibre8" id="the log"/> statement directs the NTP daemon to store the log file in the <span class="docEmphasis1">/var/log</span> directory. Save and exit.</p></div></li></ol></div>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="testing-id9" class="calibre8" id="testing-id9"/>
<h3 class="docSection1Title" id="-100000">15.8. TESTING</h3>
<p class="docText1"><a name="In this" class="calibre8" id="In this"/>In this section, we'll perform some basic tests to confirm that NTP synchronizes time data properly.<a name="IDX-CHP-15-0232" class="calibre8" id="IDX-CHP-15-0232"/></p>
<div class="calibre34"><ol class="docList" type="1"><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="the NTP" class="calibre8" id="the NTP"/>To start the NTP daemon automatically at boot time, open <span class="docEmphasis1">/etc/rc.conf</span>:</p><pre class="calibre30"># <b class="calibre28">ee /etc/rc.conf</b></pre>
<p class="docText1">and add the following lines:</p><pre class="calibre30">ntpd_enable="YES"
ntpd_program="/usr/local/bin/ntpd"</pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="begin system" class="calibre8" id="begin system"/>Start the NTP daemon and begin system time synchronization:</p><pre class="calibre30"># <b class="calibre28">/etc/rc.d/ntpd start</b></pre><br class="calibre1"/>
<p class="docText1"><a name="and then" class="calibre8" id="and then"/>Wait about 10 minutes, and then execute the following command to check the status of the time synchronization:</p><pre class="calibre30"># <b class="calibre28">ntpq -p localhost</b></pre><br class="calibre1"/>
<p class="docText1"><a name="results similar" class="calibre8" id="results similar"/>You should see results similar to the following:</p><pre class="calibre30">remote           refid      st t when poll reach   delay   offset  jitter
=========================================================================
+gabe.kjsl.com   209.81.9.7  2 u   30   64  377   13.267  1282.65 405.902
+reva.xtremeunix 204.123.2.5 2 u   50   64  377   25.863  1228.18 421.589
*zorac.sf-bay.or 204.123.2.5 2 u   20   64  377   25.283  1017.32 345.212
-time.nist.gov   .INIT.     16 u 159m 1024    0    0.000    0.000 4000.00</pre><br class="calibre1"/>
<hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> The last line in the above output is an example of a peer that is not reachable or is not working properly. The <tt class="calibre20"><i class="docEmphasis1">jitter</i></tt> value will usually be 4000.00 and <tt class="calibre20"><i class="docEmphasis1">stratum</i></tt> will be 16, with zeros for <tt class="calibre20"><i class="docEmphasis1">delay</i></tt> and <tt class="calibre20"><i class="docEmphasis1">offset</i></tt>.</span><hr size="1" noshade="noshade" class="calibre27"/><p class="docText1">The elements of the above output are described below:</p><dl class="docList2">
<dt class="calibre1"><br class="calibre1"/><p class="calibre23"><span class="docPubcolor"/><pre class="calibre30">remote</pre></p></dt>
<dd class="calibre36"><p class="docText1"><a name="by an" class="calibre8" id="by an"/>The hostname of the peer (time server). The hostname preceded by an asterisk indicates the server selected for synchronization.</p></dd>
<dt class="calibre1"><br class="calibre1"/><p class="calibre23"><span class="docPubcolor"/><pre class="calibre30">refid</pre></p></dt>
<dd class="calibre36"><p class="docText1"><a name="the corresponding" class="calibre8" id="the corresponding"/>The type of time-keeping device in use by the corresponding peer. Since the time servers above are stratum 2 servers, they list the IP addresses of the servers supplying their time.</p></dd>
<dt class="calibre1"><br class="calibre1"/><p class="calibre23"><span class="docPubcolor"/><pre class="calibre30">st</pre></p></dt>
<dd class="calibre36"><p class="docText1">The stratum of the peer, ranging from 1 to 16.</p></dd>
<dt class="calibre1"><br class="calibre1"/><p class="calibre23"><span class="docPubcolor"/><pre class="calibre30">t</pre></p></dt>
<dd class="calibre36"><p class="docText1">The type of peer (<tt class="calibre20">u</tt> = unicast, <tt class="calibre20">m</tt> = multicast).</p></dd>
<dt class="calibre1"><br class="calibre1"/><p class="calibre23"><span class="docPubcolor"/><pre class="calibre30">when</pre></p></dt>
<dd class="calibre36"><p class="docText1">How long ago the peer was heard from in seconds.</p></dd>
<dt class="calibre1"><br class="calibre1"/><p class="calibre23"><span class="docPubcolor"/><pre class="calibre30">poll</pre></p></dt>
<dd class="calibre36"><p class="docText1"><a name="the peer" class="calibre8" id="the peer"/>The frequency, in seconds, with which the NTP daemon is synchronizing with the peer.</p></dd>
<dt class="calibre1"><br class="calibre1"/><p class="calibre23"><span class="docPubcolor"/><pre class="calibre30">reach</pre></p></dt>
<dd class="calibre36"><p class="docText1"><a name="value will" class="calibre8" id="value will"/>The status, in octal format, of the reachability register. This value will stabilize at 377 if the last 8 attempts to synchronize with each time server were successful (it takes about 10 minutes to reach this value).</p></dd>
<dt class="calibre1"><br class="calibre1"/><p class="calibre23"><span class="docPubcolor"/><pre class="calibre30">delay</pre></p></dt>
<dd class="calibre36"><p class="docText1"><a name="packet delay" class="calibre8" id="packet delay"/>The roundtrip packet delay time in milliseconds (smaller is better).</p></dd>
<dt class="calibre1"><br class="calibre1"/><p class="calibre23"><span class="docPubcolor"/><pre class="calibre30">offset</pre></p></dt>
<dd class="calibre36"><p class="docText1"><a name="The difference" class="calibre8" id="The difference"/>The difference, in milliseconds, between the system time and the remote peer's time. A negative value here indicates that the clock of the local system is behind that of the remote peer's, while a positive value indicates milliseconds ahead.</p></dd>
<dt class="calibre1"><br class="calibre1"/><p class="calibre23"><span class="docPubcolor"/><pre class="calibre30">jitter</pre></p></dt>
<dd class="calibre36"><p class="docText1"><a name="of the" class="calibre8" id="of the"/>The variation, in milliseconds, of the offset (smaller is better).</p></dd>
</dl></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="time server" class="calibre8" id="time server"/>Check to make sure your time server is answering NTP requests properly with this command:</p><div class="calibre1">
              Code View:</div><pre class="calibre30"># <b class="calibre28">ntpdate -q localhost</b>

server 127.0.0.1, stratum <b class="calibre28">3</b>, offset 0.000004, delay 0.02579
server ::1, stratum <b class="calibre28">3</b>, offset 0.000010, delay 0.02583
 6 Jun 20:15:12 ntpdate[2710]: adjust time server 127.0.0.1 offset 0.0004 sec

					  </pre><br class="calibre1"/>
</div></li></ol></div>
<p class="docText1"><a name="are synchronizing" class="calibre8" id="are synchronizing"/>If you are synchronizing with stratum 2 servers your server will indicate stratum 3 as shown.</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="config_files-id14" class="calibre8" id="config_files-id14"/>
<h3 class="docSection1Title" id="-100000">15.9. CONFIG FILES</h3>
<p class="docText1"><span class="b">/etc/ntp.conf</span><a name="IDX-CHP-15-0233" class="calibre8" id="IDX-CHP-15-0233"/></p>
<p class="docText1"><a name="The main" class="calibre8" id="The main"/>The main configuration file for ntpd</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="log_files-id8" class="calibre8" id="log_files-id8"/>
<h3 class="docSection1Title" id="-100000">15.10. LOG FILES</h3>
<p class="docText1"><span class="b">/var/log/ntp.log</span></p>
<p class="docText1"><a name="The NTP" class="calibre8" id="The NTP"/>The NTP daemon records time synchronization messages to this file.</p>
<p class="docText1"><span class="b">/var/log/messages</span></p>
<p class="docText1"><a name="daemon records" class="calibre8" id="daemon records"/>The NTP daemon records its status in this file.</p>
<p class="docText1"><span class="b">/etc/ntp/drift</span></p>
<p class="docText1"><a name="correction values" class="calibre8" id="correction values"/>The NTP daemon stores clock correction values to this file.</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="notes-id10" class="calibre8" id="notes-id10"/>
<h3 class="docSection1Title" id="-100000">15.11. NOTES</h3>
<ul class="calibre15"><li class="calibre16"><p class="docText1"><a name="The drift" class="calibre8" id="The drift"/>The drift file specified in step 2 of "Configure" (page 108) is automatically updated once per hour with the frequency offset (clock error) computed by the NTP daemon. It is important that the empty file be created as outlined in step 2; the NTP daemon will not automatically create the file. If the drift file does not exist, the NTP daemon will assume an error of zero and will take about 15 minutes to complete initial synchronization and enter a stabilized state or <span class="docEmphasis1">normal mode</span>.<a name="IDX-CHP-15-0234" class="calibre8" id="IDX-CHP-15-0234"/><a name="IDX-CHP-15-0235" class="calibre8" id="IDX-CHP-15-0235"/><a name="IDX-CHP-15-0236" class="calibre8" id="IDX-CHP-15-0236"/></p></li><li class="calibre16"><p class="docText1"><a name="want to" class="calibre8" id="want to"/>If you want to synchronize the clock of your server and deny all client requests to the NTP server, add the following lines to <span class="docEmphasis1">ntp.conf</span> in <span class="docEmphasis1">/etc</span>:</p><pre class="calibre30">restrict default ignore
restrict <tt class="calibre20"><i class="docEmphasis1">time.example1.com</i></tt>
restrict <tt class="calibre20"><i class="docEmphasis1">time.example2.com</i></tt>
restrict <tt class="calibre20"><i class="docEmphasis1">time.example3.com</i></tt></pre>
</li></ul>
<hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> Replace the hostnames in italics with the hostnames of the time servers you configured in step 4 of "Configure." You cannot use NTP pool servers here because pool servers assign NTP server addresses dynamically.</span><hr size="1" noshade="noshade" class="calibre27"/>
<p class="docText1"><a name="NTP services" class="calibre8" id="NTP services"/>If you wish to allow NTP services to the local network only, add this line to the <span class="docEmphasis1">ntp.conf</span> file in <span class="docEmphasis1">/etc</span>:</p>
<pre class="calibre30">restrict <tt class="calibre20"><i class="docEmphasis1">192.168.1.0</i></tt> mask <tt class="calibre20"><i class="docEmphasis1">255.255.255.0</i></tt> nomodify notrap</pre><br class="calibre1"/>
<hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> This line is an addition to the four restrict statements above.</span><hr size="1" noshade="noshade" class="calibre27"/>
<p class="docText1"><a name="IP address" class="calibre8" id="IP address"/>Change the IP address and subnet (in italics) to match your network configuration. The example above would allow systems with an IP address of 192.168.1.<span class="docEmphasis1">X</span><a name="your NTP" class="calibre8" id="your NTP"/> to synchronize with your NTP server.</p>
</div></div>

</body></html>