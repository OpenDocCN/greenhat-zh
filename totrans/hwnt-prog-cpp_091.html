<html><head></head><body>

<div class="calibre21" id="calibre_pb_0"/><div class="calibre1" id="calibre_toc_100">
<a name="ch07" class="calibre6" id="ch07"/>
<div class="calibre1">
<h2 class="lot-title" id="calibre_pb_1"><a name="104" class="calibre16" id="104"/><a name="ch07lev1sec9" class="calibre16" id="ch07lev1sec9"/><span class="chapter-titlelabel">Program 89: </span>Just Because I'm Paranoid Doesn't Mean the Program Isn't Out to Get Me</h2><p class="b24-bookeditorial">In order to illustrate a problem with the <span>setjmp</span> library function, I created a <span>v_string</span> class. The test code for this function (minus the <span>setjmp</span> problem) is listed below.</p>
<p class="b24-bookeditorial">Now I always try and code carefully to avoid errors and memory leaks. Yet this program failed because I was <i class="calibre15">too</i> careful. What's going on?</p>
<div class="calibre1">
<pre class="literallayout-normal">
  1 /************************************************
  2 * Combine strings with a variable length        *
  3 *      string class.                            *
  4 *************************************************/
  5 #include &lt;iostream&gt;
  6 #include &lt;cstring&gt;
  7
  8 /************************************************
  9  * v_string -- variable length C style string   *
 10  *                                              *
 11  * Member functions:                            *
 12  *      set -- set the value of the string.     *
 13  *      get -- get the data from the string.    *
 14  ************************************************/
 15 class v_string
 16 {
 17     public:
 18         const char *data;      // The data
 19         // Default constructor
 20         v_string(): data(NULL)
 21         {}
 22         v_string(const char *const i_data):
 23             data(strdup(i_data))
 24         {}
 25         // Destructor
 26         ~v_string(void)
 27         {
 28             // Note: delete works
 29             // even if data is NULL
 30             delete [] data;
 31             data = NULL;
 32         }
 33         // Copy constructor
 34         v_string(const v_string &amp;old)
 35         {
 36             if (data != NULL)
 37             {
 38                 delete[] data;
 39                 data = NULL;
 40             }
 41             data = strdup(old.data);
 42         }
 43         // operator =
 44         v_string &amp; operator = (
 45                 const v_string &amp;old)
 46         {
 47             if (this == &amp;old)
 48                 return (*this);
 49
 50             if (data != NULL)
 51             {
 52                 delete[] data;
 53                 data = NULL;
 54             }
 55             if (old.data == NULL)
 56             {
 57                 data = NULL;
 58                 return (*this);
 59             }
 60
 61             data = strdup(old.data);
 62             return (*this);
 63         }
 64     public:
 65         // Set a value
 66         void set(
 67             // New string value
 68             const char *const new_data
 69         )
 70         {
 71             if (data != NULL)
 72             {
 73                 delete [] data;
 74                 data = NULL;
 75             }
 76             data = strdup(new_data);
 77
 78         }
 79         // Returns the value of the string
 80         const char * const get(void) const
 81         {
 82             return (data);
 83         }
 84 };
 85 /************************************************
 86  * operator + -- Combine two  v_strings         *
 87  ************************************************/
 88 v_string operator + (
 89         const v_string &amp;first,   // First string
 90         const v_string &amp;second   // Second string
 91 )
 92 {
 93     char tmp[100];       // Combined string
 94
 95     strcpy(tmp, first.get());
 96     strcat(tmp, second.get());
 97
 98     // Strings put together
 99     v_string together(tmp);
100     return (together);
101 }
102
103 /************************************************
104  * combine -- Combine two strings and           *
105  *      print the result.                       *
106  ************************************************/
107 static void combine(
108         const v_string &amp;first, // First string
109         const v_string &amp;second // Second string
110 )
111 {
112     v_string together;  // Strings put together
113     together = first + second;
114
115     std::cout &lt;&lt; "Combination " &lt;&lt;
116         together.get() &lt;&lt; '\n';
117 }
118
119 int main()
120 {
121     // Strings to combine
122     v_string first("First:");
123     v_string second("Second");
124     combine(first, second);
125     return (0);
126 }
</pre>
</div>
<p class="b24-bookeditorial">(Next <a href="LiB0120.html#201" target="_parent" class="calibre2">Hint 65</a>. <a href="LiB0121.html#613" target="_parent" class="calibre2">Answer 115</a>.)</p>
</div>
</div>



</body></html>