<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;DOMU MANAGEMENT: TOOLS AND FRONTENDS"><div class="titlepage"><div><div><h1 class="title"><a id="domu_management_tools_and_frontends"/>Chapter 6. DOMU MANAGEMENT: TOOLS AND FRONTENDS</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e6215"/><img src="httpatomoreillycomsourcenostarchimages333191.png.jpg" alt="image with no caption"/></div></div><p>Most <a id="idx-CHP-6-0430" class="indexterm"/>of the material in this book focuses on fairly low-level administrative tasks. We've got a couple of reasons for this focus: first, because we feel that it's better to understand what the GUI tools are doing before trusting them with your data,<sup>[<a id="CHP-6-FNOTE-1" href="#ftn.CHP-6-FNOTE-1" class="footnote">34</a>]</sup> and second, because the add-on tools are not fully developed.</p><p>However, the true benefit of Xen is that it allows you to do things with a virtual machine that you can't do—or can't do easily—with a simple collection of physical machines. The main advantage of the more advanced management tools is that they exploit Xen virtualization to improve flexibility.</p><p>Besides, it gets kind of tedious to do everything from base principles all the time. In this chapter, we'll take an excursion from our usual fixation on doing things in the most laborious way possible and look at some of the labor-saving innovations available for Xen.</p><p>Broadly, we can categorize the various frontend packages by their intended audience; some tools are for the dom0 administrator and some are for the domU administrator (that is, the <span class="emphasis"><em>customer</em></span> in Xen's computing-service model). The first group tends to focus on provisioning and destroying VMs, and the second group allows users who most likely don't have access to the dom0 to control their own VM at a higher level so they can, for example, give the domain a hard reboot or recover when the domU won't boot at all.</p><p>Despite this neat and theoretically useful division of labor, we're going to ignore the second category almost completely. There are two reasons for this: First, most end users won't want to do anything especially complex to their Xen instance. In our opinion, most of the Xen control panels are solutions in search of a problem. Second, almost none of the tools that we've tried in this category seem to have stabilized as of this writing.<sup>[<a id="CHP-6-FNOTE-2" href="#ftn.CHP-6-FNOTE-2" class="footnote">35</a>]</sup> Instead, we'll focus on the first category: software to simplify your life as a service provider, ranging from the simple to the elaborate. We'll end by briefly discussing the Xen-shell, which is a useful minimal customer-facing tool.</p><div class="sect1" title="Tools for the VM Provider"><div class="titlepage"><div><div><h1 class="title"><a id="tools_for_the_vm_provider"/>Tools for the VM Provider</h1></div></div></div><p>When looking for a management tool, as with any piece of software, the first question to ask yourself is, What <a id="idx-CHP-6-0431" class="indexterm"/>features do I need? Xen management tools run the gamut from simple provisioning scripts, like Xen-tools, to elaborate data-center-oriented packages, like OpenQRM.</p><p>The biggest factor influencing your choice of frontend, assuming that multiple ones provide the necessary functionality, is probably the dom0 operating system. Some frontends, such as Xen-tools, are designed and built with Debian in mind. Some work best with Red Hat. Slackware users, you're still on your own. Although you can install, say, <code class="literal">virt-manager</code> on Debian, it would be a difficult process, contrary to the dictates of nature.<sup>[<a id="CHP-6-FNOTE-3" href="#ftn.CHP-6-FNOTE-3" class="footnote">36</a>]</sup> In this chapter, we're going to focus on each tool in its native environment, beginning with Xen-tools for Debian.</p><div class="sect2" title="Xen-tools"><div class="titlepage"><div><div><h2 class="title"><a id="xen-tools"/>Xen-tools</h2></div></div></div><p>Xen-tools, at heart, consists of a cross-platform set of Perl scripts for automated installs, so it's fairly distro agnostic. Even though the authors develop on Debian, distribute <span class="emphasis"><em>.deb</em></span> packages, and have an Apt repository, Xen-tools is relatively easy to install on other systems, so we encourage you to try it regardless of which distro you're running. Download a tarball at <a class="ulink" href="http://xen-tools.org/">http://xen-tools.org/</a>.</p><div class="sect3" title="Installing Xen-tools"><div class="titlepage"><div><div><h3 class="title"><a id="installing_xen-tools"/>Installing Xen-tools</h3></div></div></div><p>In the interest of keeping everything flowing smoothly, we installed Xen-tools on a Debian machine using Debian's Apt system. Because, like everything Xen-related, Xen-tools is under heavy development, we opted to get the package from the author's own repository to avoid getting an old version.</p><p>To do this, add his repo to your <span class="emphasis"><em>/etc/apt/sources.list</em></span>. For Etch, we appended:</p><a id="I_programlisting6_d1e6287"/><pre class="programlisting">#
#  Steve Kemp's repository:  Etch
#
deb     http://apt.steve.org.uk/etch etch main non-free contrib
deb-src http://apt.steve.org.uk/etch etch main non-free contrib</pre><div class="note" title="Note"><h3 class="title"><a id="note-24"/>Note</h3><p><span class="emphasis"><em>Sometimes even the version in Apt is not as current as the one on the website. If all else fails, download the tar package, unpack it, and run make install to install it</em></span>.</p></div><p>Then run, as usual:</p><a id="I_programlisting6_d1e6296"/><pre class="programlisting"># apt-get update
# apt-get install xen-tools</pre><p>Apt will then work its customary magic, <a id="idx-CHP-6-0432" class="indexterm"/>installing the Xen-tools scripts and creating a configuration directory, <span class="emphasis"><em>/etc/xen-tools</em></span>.</p><p>For usage information, if you have <code class="literal">perldoc</code>, you can access any of the programs' embedded manual pages by running them with the <code class="literal">--manual</code> option. For example:</p><a id="I_programlisting6_d1e6317"/><pre class="programlisting"># xen-create-image --manual</pre><p>will print out a long and intimidating man page. Don't be discouraged; it's just exposing the bewildering array of options Xen itself makes available. You can simplify things by specifying most of these options ahead of time in the Xen-tools config file rather than by command-line options.</p></div><div class="sect3" title="Configuring Xen-tools"><div class="titlepage"><div><div><h3 class="title"><a id="configuring_xen-tools"/>Configuring Xen-tools</h3></div></div></div><p>So let's make a config file. Trust us, it's much more pleasant to spend a bit of time setting some defaults rather than specifying global options every time you use the command.<sup>[<a id="CHP-6-FNOTE-4" href="#ftn.CHP-6-FNOTE-4" class="footnote">37</a>]</sup> Put your preferred options in <span class="emphasis"><em>/etc/xen-tools/xen-tools.conf</em></span>. We would use something like this:<a id="idx-CHP-6-0433" class="indexterm"/></p><a id="I_programlisting6_d1e6338"/><pre class="programlisting">lvm = verona
size = 2Gb
image = full
memory = 128Mb
swap = 128Mb
fs = ext3
dist = sarge

initrd = /boot/initrd.img-2.6.16-2-xen-686
kernel = /boot/vmlinuz-2.6.16-2-xen-686

install-method = debootstrap</pre><p>Fill in appropriate values, as always, <a id="idx-CHP-6-0434" class="indexterm"/>and feel free to add from the liberally commented sample config anything that strikes your fancy. Some of these options, like <code class="literal">initrd</code> and <code class="literal">kernel</code>, specify literal directives that'll wind up in the final domU config file. Of the remaining options, most are self-explanatory; <code class="literal">size</code> specifies the filesystem size, <code class="literal">swap</code> is the amount of swap the domain will have, and so forth.</p><p>Because we've specified an <a id="idx-CHP-6-0435" class="indexterm"/>LVM group, domains will be created with LVM volumes as backing store. You can also use filesystem images by specifying <code class="literal">dir = /path/</code> rather than an LVM group. If you do that, make sure that the directory exists, otherwise the image creation step will fail silently and <code class="literal">xen-create-image</code> will populate the directory where the filesystem would have been mounted. This is almost certainly not what you want.</p><p>Also note the <code class="literal">dist=</code> line; this specifies which set of postinstall <span class="emphasis"><em>hook</em></span> scripts <code class="literal">xen-create-image</code> will run to configure the new domain. If there isn't a directory under <span class="emphasis"><em>/usr/lib/xen-tools</em></span> corresponding to the <code class="literal">dist</code> value, <code class="literal">xen-create-image</code> will exit with an instructive error message. If you don't want to configure the domain at creation time, you can create an empty directory—say, <span class="emphasis"><em>/usr/lib/xen-tools/plan9</em></span>—and pass the name of the distribution (<span class="emphasis"><em>plan9</em></span> in this case) as the dist value.</p><p>When you have the config file populated, actually creating domains is so easy as to be almost anticlimactic. Just specify a hostname, preferably fully qualified so that the postinstall scripts can configure the image correctly, on the command line, and the tool will do the rest. For example:</p><a id="I_programlisting6_d1e6401"/><pre class="programlisting"># xen-create-image mercutio.prgmr.com</pre><div class="note" title="Note"><h3 class="title"><a id="note-25"/>Note</h3><p><span class="emphasis"><em>Although setting a fully qualified domain name allows the postinstall scripts to handle domain configuration, it can cause trouble with the xendomains script on certain Red Hat derivatives, which assumes a domU name no longer than 18 characters</em></span>.</p></div><p>With the config file previously shown, this creates two logical volumes,<span class="emphasis"><em>/dev/verona/mercutio.prgmr.com-disk</em></span> and <span class="emphasis"><em>/dev/verona/mercutio.prgmr.com-swap</em></span>. It then mounts the disk volume and uses <code class="literal">debootstrap</code> to install sarge (Debian 3.1).</p><p>Easy.</p></div><div class="sect3" title="Xen-tools and RPM-based DomU Images"><div class="titlepage"><div><div><h3 class="title"><a id="xen-tools_and_rpm-based_domu_images"/>Xen-tools and RPM-based DomU Images</h3></div></div></div><p>The first versions of Xen-tools were developed with <code class="literal">debootstrap</code> installs of Debian in mind. However, the package has come a long way, and it's been generalized to support virtually every system out there. <a id="idx-CHP-6-0436" class="indexterm"/>RPM-based distros are covered via a <code class="literal">debootstrap</code>-like tool. Other systems—even non-Linux systems—can be installed by copying a pristine filesystem image or extracting tarballs.<a id="idx-CHP-6-0437" class="indexterm"/></p><p>Although older versions of Xen-tools used RPMstrap, which we've used with some success in the past, the author of RPMstrap has ceased to develop it. Accordingly, the Xen-tools author has been working on a replacement called <code class="literal">rinse</code>. It's the recommended way of installing CentOS <a id="idx-CHP-6-0438" class="indexterm"/>and Fedora with Xen-tools, and it's a fairly neat package by itself.<a id="idx-CHP-6-0439" class="indexterm"/></p><p><code class="literal">rinse</code>'s home page is at <a class="ulink" href="http://xen-tools.org/software/rinse/">http://xen-tools.org/software/rinse/</a>. Download it either from the download page at that site or by adding his <code class="literal">apt</code> repository and downloading via your package manager.<a id="idx-CHP-6-0440" class="indexterm"/></p><p>A full discussion of <code class="literal">rinse</code>'s configuration options is probably out of place here. We enjoin you to read the fine manual. However, it works out of the box with an install method for <code class="literal">xen-create-image</code>, with a simple command line like the following:</p><a id="I_programlisting6_d1e6477"/><pre class="programlisting"># xen-create-image --hostname tybalt.prgmr.com --install-method=rinse
dist=centos-5</pre><p>No problem.</p></div><div class="sect3" title="Xen-tools Postinstall"><div class="titlepage"><div><div><h3 class="title"><a id="xen-tools_postinstall"/>Xen-tools Postinstall</h3></div></div></div><p>After the image is installed, but before it's started for the first time, <code class="literal">xen-create-image</code> does some postinstall work. First it runs some scripts in the mounted <a id="idx-CHP-6-0441" class="indexterm"/>domU filesystem to perform setup tasks, like setting the hostname and disabling unneeded gettys. Finally it creates a config file so that you can start the domain.<a id="idx-CHP-6-0442" class="indexterm"/></p><p>At this stage you can also have the machine configure itself with a role—specify the <code class="literal">--role &lt;script&gt;</code> command-line option to run the corresponding script located in <span class="emphasis"><em>/etc/xen-tools/role.d</em></span> at the end of the install, taking the mount point of the domU root filesystem as an argument. The roles that you'll want will depend on your needs. For example, you may want roles that differentiate between web, mail, and dns servers. The Xen-tools distribution comes with some samples that you can build upon.</p><p>After populating the domU image, the <code class="literal">xen-create-image</code> script will create a configuration file based on a template at <span class="emphasis"><em>/etc/xen-tools/xm.tmpl</em></span>. You can also specify a template on the command line using the <code class="literal">--template</code> option.</p></div><div class="sect3" title="Extending the Config File Template"><div class="titlepage"><div><div><h3 class="title"><a id="extending_the_config_file_template"/>Extending the Config File Template</h3></div></div></div><p>You can, as you might suppose, edit the template freely. Xen-tools passes options to the setup scripts by reading environment variables, which makes it easy to extend the template by passing in new variables and adding code to interpret them.<a id="idx-CHP-6-0443" class="indexterm"/></p><p>For example, because we like to use PyGRUB, we might edit the template by adding a <code class="literal">bootloader</code> option right beneath the <code class="literal">kernel</code> and <code class="literal">initrd</code> sections:</p><a id="I_programlisting6_d1e6538"/><pre class="programlisting">{ if ( $bootloader )
  {
    $OUT.= "bootloader        = '$bootloader'";
  }
}</pre><p>Now we can create the image with the additional value specified as an environment variable:</p><a id="I_programlisting6_d1e6542"/><pre class="programlisting"># bootloader=/usr/bin/pygrub xen-create-image --hostname tybalt.prgmr.com
--install-method=rinse --dist=centos-5</pre><p>and, as if by magic, the <a id="idx-CHP-6-0444" class="indexterm"/>config file will have a <code class="literal">bootloader</code> entry.</p><p>We could also update the script that parses the config file and have it pass through the value as an environment variable, just as with the other options.</p></div><div class="sect3" title="xen-list-images"><div class="titlepage"><div><div><h3 class="title"><a id="xen-list-images"/>xen-list-images</h3></div></div></div><p>Having created some domains, whether with <code class="literal">xen-create-image</code> or otherwise, it stands to reason that you might want to view a summary of domains that exist on the machine. The Xen-tools suite therefore also includes a tool to list existing domains, <code class="literal">xen-list-images</code>. Running it on our test system shows:<a id="idx-CHP-6-0445" class="indexterm"/></p><a id="I_programlisting6_d1e6573"/><pre class="programlisting"># xen-list-images
Name: mercutio.prgmr.com
Memory: 128
DHCP

Name: benvolio.prgmr.com
Memory: 96
IP: 192.168.1.93

Name: tybalt.prgmr.com
Memory: 128
DHCP</pre><p>The tool parses Xen config files—both those created by Xen-tools and otherwise—and prints some information.</p></div><div class="sect3" title="xen-delete-image"><div class="titlepage"><div><div><h3 class="title"><a id="xen-delete-image"/>xen-delete-image</h3></div></div></div><p>Finally we have <code class="literal">xen-delete-image</code>, which does exactly what the name suggests. It'll only work on images that follow the naming conventions used by <code class="literal">xen-create-image</code>, that is, it doesn't have the intelligence necessary to parse arbitrary domain definitions. Nonetheless, if you've standardized on Xen-tools or name disks in the format used by Xen-tools, it can be handy.<a id="idx-CHP-6-0446" class="indexterm"/></p><div class="warning" title="Warning"><h3 class="title"><a id="warning-2"/>Warning</h3><p><span class="emphasis"><em>When run as root, this command will destroy data with no confirmation, even if you've specified the</em></span> <em class="replaceable"><code>--test</code></em> <span class="emphasis"><em>option</em></span>.</p></div><p>Run <code class="literal">xen-delete-image</code> like this, but very carefully:</p><a id="I_programlisting6_d1e6609"/><pre class="programlisting"># xen-delete-image --lvm verona mercutio.prgmr.com</pre><p>This will delete <span class="emphasis"><em>mercutio.prgmr.com-disk</em></span> and <span class="emphasis"><em>mercutio.prgmr.com-swap</em></span> from the <span class="emphasis"><em>verona</em></span> VG and delete the config file. If the data source option isn't specified, it defaults to the value in <span class="emphasis"><em>/etc/xen-tools/xen-tools.conf</em></span>.</p></div></div><div class="sect2" title="libvirt, virsh, and virt-manager"><div class="titlepage"><div><div><h2 class="title"><a id="libvirt_virsh_and_virt-manager"/>libvirt, virsh, and virt-manager</h2></div></div></div><p>On the RPM side, including SUSE, CentOS, and Fedora, we have a <a id="idx-CHP-6-0447" class="indexterm"/>suite of tools based on <a id="idx-CHP-6-0448" class="indexterm"/>libvirt. Although packages are available for Debian-based distros and Solaris, libvirt is primarily developed on, for, and largely by Red Hat, and it shows in the project's focus.<a id="idx-CHP-6-0449" class="indexterm"/><a id="idx-CHP-6-0450" class="indexterm"/></p><p>libvirt isn't a management tool per se, but it's worth mentioning here as a Xen frontend, part of a framework that sits in front of Xen and makes management tools easier to develop. The stated goal of the libvirt project (at <a class="ulink" href="http://libvirt.org/">http://libvirt.org/</a>) is to "provide a long-term stable C API for virtualization." In other words, libvirt aims to allow a single tool to control any type of virtualization that libvirt supports, including Xen. This is wonderful, as far as it goes. However, the libvirt-based tools still aren't complete. In particular, their focus on Red Hat is sometimes inconvenient.</p><p>libvirt's main <a id="idx-CHP-6-0451" class="indexterm"/>advantages are that it integrates very closely with Red Hat's tools and that the management tool, <code class="literal">virt-manager</code>, is excellent for interacting with live virtual machines.</p><p>The basic libvirt-based tool—or at least the first-generation, proof-of-concept version of this tool—is <code class="literal">virsh</code>, or <span class="emphasis"><em>virtualization shell</em></span>. Right now it can perform most of the same operations as <code class="literal">xm</code> on Xen, QEMU, KVM, or OpenVZ domains.<a id="idx-CHP-6-0452" class="indexterm"/></p><p>This isn't the place to give a complete how-to on <code class="literal">virsh</code>; we're writing about Xen, and we've therefore focused on <code class="literal">xm</code>. However, <code class="literal">virsh</code> is the frontend of choice for Red Hat, so we'll provide some discussion and examples, but we're going to stick to Xen and <code class="literal">virsh</code>'s capabilities as an <code class="literal">xm</code> replacement rather than emphasizing the new features <code class="literal">virsh</code> introduces.</p><p>The first thing to mention about <code class="literal">virsh</code> is that it uses a flagrantly different syntax from <code class="literal">xm</code> for domain definitions. <code class="literal">virsh</code> has a <code class="literal">create</code> command, just as <code class="literal">xm</code> does, but it expects an XML file as an argument.</p><p>Fortunately, <code class="literal">virsh</code> allows you to create the <a id="idx-CHP-6-0453" class="indexterm"/>XML definition from a Xen domain. For example, to get an <a id="idx-CHP-6-0454" class="indexterm"/>XML definition for the running domain <span class="emphasis"><em>ophelia</em></span>:</p><a id="I_programlisting6_d1e6739"/><pre class="programlisting"># virsh dumpxml ophelia
&lt;domain type='xen' id='8'&gt;
&lt;name&gt;ophelia&lt;/name&gt;
&lt;uuid&gt;162910c82a0c03332349049e8e32ba90&lt;/uuid&gt;
&lt;bootloader&gt;/usr/bin/pygrub&lt;/bootloader&gt;
&lt;os&gt;
  &lt;type&gt;linux&lt;/type&gt;
  &lt;kernel&gt;/var/lib/xen/vmlinuz.8gmQDM&lt;/kernel&gt;
  &lt;initrd&gt;/var/lib/xen/initrd.H3wHj2&lt;/initrd&gt;
  &lt;cmdline&gt;ro root=/dev/VolGroup00/LogVol00 rhgb quiet&lt;/cmdline&gt;
&lt;/os&gt;
&lt;memory&gt;105472&lt;/memory&gt;
&lt;vcpu&gt;1&lt;/vcpu&gt;
&lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&lt;on_crash&gt;restart&lt;/on_crash&gt;
&lt;devices&gt;
  &lt;interface type='bridge'&gt;
    &lt;source bridge='xenbr0'/&gt;
    &lt;mac address='00:16:3e:4b:af:c2'/&gt;
    &lt;script path='vif-bridge'/&gt;
  &lt;/interface&gt;
  &lt;graphics type='vnc' port='5900'/&gt;
  &lt;disk type='file' device='disk'&gt;
    &lt;driver name='tap' type='aio'/&gt;
    &lt;source file='/opt/xen/images/ophelia.img'/&gt;
    &lt;target dev='xvda'/&gt;
  &lt;/disk&gt;
  &lt;console tty='/dev/pts/6'/&gt;
&lt;/devices&gt;
&lt;/domain&gt;</pre><p>You can see the correspondences between this <a id="idx-CHP-6-0455" class="indexterm"/>XML definition and the domain config file; it defines the same basic resources in a different but still recognizable format. We can redirect this to a file, say <em class="filename">ophelia.xml</em>, shut down the original <span class="emphasis"><em>ophelia</em></span>, and create a domain:<a id="idx-CHP-6-0456" class="indexterm"/></p><a id="I_programlisting6_d1e6758"/><pre class="programlisting"># virsh dumpxml ophelia &gt; ophelia.xml
# virsh shutdown ophelia
# virsh create ophelia.xml
<a id="idx-CHP-6-0457" class="indexterm"/></pre><p><code class="literal">virsh</code> can also list domains, just like <code class="literal">xm</code>:</p><a id="I_programlisting6_d1e6773"/><pre class="programlisting"># virsh list
 Id Name                State
----------------------------------
  0 Domain-0            running
  4 ophelia             blocked</pre><p>Finally, just as with <code class="literal">xm</code>, <code class="literal">virsh</code> can <code class="literal">shutdown</code>, <code class="literal">restart</code>, or <code class="literal">destroy</code> a domain, using the obvious command for each.</p><div class="sect3" title="virt-manager"><div class="titlepage"><div><div><h3 class="title"><a id="virt-manager"/>virt-manager</h3></div></div></div><p>Apart from <code class="literal">virt-install</code>, which we discussed in <a class="xref" href="ch03.html" title="Chapter 3. PROVISIONING DOMUS">Chapter 3</a>, the most useful tool in the <a id="idx-CHP-6-0458" class="indexterm"/>suite is probably <code class="literal">virt-manager</code>. It's pretty slick, and it's great in an area that's not covered by the Xen-tools scripts: interacting with live virtual machines. As <a class="xref" href="ch06.html#here_you_can_see_the_virt-manager_ui_it_" title="Figure 6-1. Here you can see the virt-manager UI. It has a main screen that lists virtual machines; a detail view that shows VM resources, performance, and statistics; and a framebuffer console as well as a text console interface.">Figure 6-1</a> shows, <code class="literal">virt-manager</code> provides a centralized location from which to view performance data, virtual framebuffers, and consoles. It also provides a quick overview <a id="idx-CHP-6-0459" class="indexterm"/>of resource allocation. Like most GUI tools, <code class="literal">virt-manager</code> probably requires a bit more manual effort and clicking through dialog boxes than you'd like to use for everyday domU creation. Nonetheless, it's got support for Xen's basic life cycle: create and destroy. It also integrates with Red Hat's Kickstart deployment method for convenient semiautomated installs; you can just specify a <span class="emphasis"><em>.ks</em></span> file when asked during the install dialog.<a id="idx-CHP-6-0460" class="indexterm"/></p></div><div class="sect3" title="Getting Started with virt-manager"><div class="titlepage"><div><div><h3 class="title"><a id="getting_started_with_virt-manager"/>Getting Started with virt-manager</h3></div></div></div><p>Because <code class="literal">virt-manager</code> comes <a id="idx-CHP-6-0461" class="indexterm"/>with the operating system on Red Hat-based distros, assuming you selected the <span class="emphasis"><em>virtualization</em></span> target during the install, you can invoke it without setting a finger to the keyboard. From the default GNOME desktop, click the <span class="strong"><strong>Applications</strong></span> menu at the upper left, then <span class="strong"><strong>System Tools ► Virtual Machine Manager</strong></span>. Enter your root password when prompted, and select <span class="strong"><strong>Local Hypervisor</strong></span> to connect to the local instance of <code class="literal">xend</code>.<sup>[<a id="CHP-6-FNOTE-5" href="#ftn.CHP-6-FNOTE-5" class="footnote">38</a>]</sup> You'll be presented with something that looks vaguely like <a class="xref" href="ch06.html#here_you_can_see_the_virt-manager_ui_it_" title="Figure 6-1. Here you can see the virt-manager UI. It has a main screen that lists virtual machines; a detail view that shows VM resources, performance, and statistics; and a framebuffer console as well as a text console interface.">Figure 6-1</a>.<a id="idx-CHP-6-0462" class="indexterm"/></p><div class="figure"><a id="here_you_can_see_the_virt-manager_ui_it_"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject6_d1e6878"/><img src="httpatomoreillycomsourcenostarchimages333221.png.jpg" alt="Here you can see the virt-manager UI. It has a main screen that lists virtual machines; a detail view that shows VM resources, performance, and statistics; and a framebuffer console as well as a text console interface."/></div></div><p class="title">Figure 6-1. Here you can see the virt-manager UI. It has a main screen that lists virtual machines; a detail view that shows VM resources, performance, and statistics; and a framebuffer console as well as a text console interface.</p></div><p>To create an image <a id="idx-CHP-6-0463" class="indexterm"/>using <code class="literal">virt-manager</code>, click the <span class="strong"><strong>File</strong></span> menu, and select <span class="strong"><strong>New Machine</strong></span>. <code class="literal">virt-manager</code> will then escort you through a set of friendly dialog boxes.</p><p>The first prompt asks for the name of the machine. Enter something appropriate, but make sure that it includes only letters, numerals, and underscores—fully qualified domain names won't work.</p><p>Choose whether the new domain should be paravirtualized or fully virtualized. If you don't have HVM, the dialog will chide you for your inadequate hardware and gray out the Fully Virtualized option. For the purposes of this example, we're picking paravirtualization.</p><p>Then <code class="literal">virt-manager</code> asks for install media. Because it's <a id="idx-CHP-6-0464" class="indexterm"/>calling <code class="literal">virt-install</code> behind the scenes, the same constraints apply; enter a network-accessible Red Hat–style directory tree. For example, <a class="ulink" href="http://archive.fedoraproject.org/pub/archive/fedora/linux/releases/7/Fedora/i386/os/">http://archive.fedoraproject.org/pub/archive/fedora/linux/releases/7/Fedora/i386/os/</a> will install Fedora 7 from an HTTP Fedora mirror.</p><p>At this stage you can also specify a Kickstart file <a id="idx-CHP-6-0465" class="indexterm"/>using the same syntax. This is a handy way to automate the install process. For example, to duplicate your dom0's install configuration, upload your <span class="emphasis"><em>/root/anaconda-ks.cfg</em></span> file somewhere convenient and specify it.</p><p>Select a <a id="idx-CHP-6-0466" class="indexterm"/>backing store for the new virtual machine. The two choices map to <code class="literal">phy:</code> and <code class="literal">tap:aio:</code> devices. The GUI also gives you the option of <a id="idx-CHP-6-0467" class="indexterm"/>creating a sparse file, but we don't recommend that for the reasons we described in some detail in <a class="xref" href="ch03.html" title="Chapter 3. PROVISIONING DOMUS">Chapter 3</a>.</p><p>Select a <a id="idx-CHP-6-0468" class="indexterm"/>networking option. The two choices correspond to a <code class="literal">network-nat</code> work-alike and the standard <code class="literal">network-bridge</code>.</p><p>Finally, select memory and CPU allocation.</p><p>At the end, <code class="literal">virt-manager</code> will list your configuration and give you a chance to back out. Make sure everything looks right and click <span class="strong"><strong>Finish</strong></span>. It'll validate your selections and then start creating the domain using <code class="literal">virt-install</code>.</p><p>The domain creation itself is probably the coolest feature of the libvirt suite. Rather than populating a filesystem from the dom0 and then booting a Xen instance, it downloads a Xen-aware net install image, immediately boots the domain from the installation kernel, and then uses that kernel to download the packages and populate the system. The install looks just like a normal install, using the framebuffer console to provide a completely ordinary Red Hat install experience. Because <code class="literal">virt-manager</code> integrates a VNC viewer, you can watch the install as it progresses from <a id="idx-CHP-6-0469" class="indexterm"/>within the management application.</p><p>When the domain is running, you can pause it, shut it down, or examine its configuration from the main <code class="literal">virt-manager</code> window. Right-click the domain name to get a context menu with a list of operations, or select the domain by clicking it and use the button bar at the top.</p><div class="note" title="Note"><h3 class="title"><a id="note-26"/>Note</h3><p><span class="emphasis"><em>Early versions of</em></span> <em class="replaceable"><code>virt-manager</code></em>, <span class="emphasis"><em>including the version shipped with Red Hat Enterprise Linux 5.0, suffered from the oversight that when a domain had stopped, it vanished from the GUI's list and thus couldn't be restarted without dropping to a command prompt. If you have an afflicted version, you can easily restart a domain configured with</em></span> <em class="replaceable"><code>virt-manager</code></em> <span class="emphasis"><em>using</em></span> <em class="replaceable"><code>xm</code></em> <span class="emphasis"><em>in the normal way</em></span>.</p></div><p>Still, though, <code class="literal">virt-manager</code> is too interactive and too limited to use for large installations. To address this, <a id="idx-CHP-6-0470" class="indexterm"/>Red Hat's Emerging Technologies group (<a class="ulink" href="http://et.redhat.com/">http://et.redhat.com/</a>) is also working on a tool called <a id="idx-CHP-6-0471" class="indexterm"/>oVirt, which aims to scale libvirt-based management across the entire data center. Another tool, the <a id="idx-CHP-6-0472" class="indexterm"/>Puppet Recipe Manager, emphasizes the <span class="emphasis"><em>software appliance</em></span> aspect of virtualization. It enables an administrator to build software <a id="idx-CHP-6-0473" class="indexterm"/>recipes and automatically install them on virtual machines. We also mentioned Cobbler, an automated tool that can provision virtual machines, in <a class="xref" href="ch03.html" title="Chapter 3. PROVISIONING DOMUS">Chapter 3</a>.</p><p>One last libvirt-based tool that you might want to look at is <code class="literal">virt-clone</code>, which is capable of duplicating a domU image and its config file while altering any items that must be unique, such as the MAC address—a nice balance between convenience and control.<a id="idx-CHP-6-0474" class="indexterm"/></p><p>It's simple to run, taking most of its input from command-line options. For example, to clone the machine <code class="literal">sebastian</code> as <code class="literal">viola</code>:</p><a id="I_programlisting6_d1e7065"/><pre class="programlisting"># virt-clone -o sebastian -n viola -f /opt/xen/viola-root.img -f /opt/xen/
viola-swap.img preserve-data</pre></div></div></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-6-FNOTE-1" href="#CHP-6-FNOTE-1" class="para">34</a>] </sup>A position unlikely to occasion much disagreement among sysadmins.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-6-FNOTE-2" href="#CHP-6-FNOTE-2" class="para">35</a>] </sup>We blame Python's scorched-earth policy toward compatibility.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-6-FNOTE-3" href="#CHP-6-FNOTE-3" class="para">36</a>] </sup>Of course there are packages, but they're less closely integrated.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-6-FNOTE-4" href="#CHP-6-FNOTE-4" class="para">37</a>] </sup>Cdrecord, anyone?</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-6-FNOTE-5" href="#CHP-6-FNOTE-5" class="para">38</a>] </sup>Well, if you'd been logged in as root, you wouldn't have had to type anything. Not that we recommend that, of course.</p></div></div></div>
<div class="sect1" title="Administering the Virtualized Data Center"><div class="titlepage"><div><div><h1 class="title"><a id="administering_the_virtualized_data_cente"/>Administering the Virtualized Data Center</h1></div></div></div><p>The chief <a id="idx-CHP-6-0475" class="indexterm"/>benefit of frontends like these is in doing things that are too large or complex for simpler tools, though some would hold that no problem is too large for a well-written shell script. The largest and best of these tools allow Xen to truly flex its capabilities, leading to giant automated systems such as we see in Amazon's EC2. In this category are several packages, including OpenQRM, ConVirt, and Enomalism. All three of these have their adherents. However, we've chosen to focus on lower-level, more commonly available tools while the more advanced management frontends stabilize.<a id="idx-CHP-6-0476" class="indexterm"/></p></div>
<div class="sect1" title="Administration for the VM Customer"><div class="titlepage"><div><div><h1 class="title"><a id="administration_for_the_vm_customer"/>Administration for the VM Customer</h1></div></div></div><p>Although there are a number of packages aimed at allowing customers to manage their virtual machine, it's not clear to us that control-plane operations are really necessary in this context. Furthermore, most of the customer-facing tools are still in flux. It's difficult for us to recommend them at this point.<a id="idx-CHP-6-0477" class="indexterm"/></p><p>The best available solution, at least for now, seems to be to provide a reasonably simple menu through which customers can attach to the console, reboot their machines, shut down their machines, and re-create their domU image. There are many ways to do this. Our favorite is to allow customers to SSH to a console server, <a id="idx-CHP-6-0478" class="indexterm"/>with sharply limited accounts.</p><div class="sect2" title="Xen-shell"><div class="titlepage"><div><div><h2 class="title"><a id="xen-shell"/>Xen-shell</h2></div></div></div><p>Although we like our home brew approach to management as described in <a class="xref" href="ch07.html" title="Chapter 7. HOSTING UNTRUSTED USERS UNDER XEN: LESSONS FROM THE TRENCHES">Chapter 7</a>, there are other options for those who believe that software can be perfectly adequate even if they didn't personally write it. Of these, our favorite is the Xen-shell. It's by the author of Xen-tools and is another example of his no-frills approach. We recommend it, not merely because we like Xen-tools or even because it's got a good feature set, because it doesn't have a giant list of dependencies. It's a simple product that does its job well.<a id="idx-CHP-6-0479" class="indexterm"/><a id="I_indexterm6_d1e7107" class="indexterm"/><a id="I_indexterm6_d1e7112" class="indexterm"/></p><p>It's available at <a class="ulink" href="http://xen-tools.org/software/xen-shell/">http://xen-tools.org/software/xen-shell/</a><a id="idx-CHP-6-0480" class="indexterm"/>. After you've downloaded it, use the standard unpack &amp;&amp; make install process to install it.</p><p>At this point there's some configuration that needs to be done. <a id="idx-CHP-6-0481" class="indexterm"/>Xen-shell works by taking user commands and <a id="idx-CHP-6-0482" class="indexterm"/>running <code class="literal">sudo xm</code> in response to their input. You'll need to put <code class="literal">xm</code> into their path or, conversely, alter their path to include <code class="literal">xm</code>. We took the former approach:</p><a id="I_programlisting6_d1e7145"/><pre class="programlisting"># ln -s /usr/sbin/xm /usr/bin</pre><p>We also need to configure <span class="emphasis"><em>/etc/sudoers</em></span> to make sure that the users are allowed to use <code class="literal">sudo</code> to run <code class="literal">xm</code> on their domain (and only their domain). This entails quite a number of additions to the file, one for each command we want to allow:</p><a id="I_programlisting6_d1e7158"/><pre class="programlisting">marlowe ALL=NOPASSWD:/usr/sbin/xm create goneril
marlowe ALL=NOPASSWD:/usr/sbin/xm create -c goneril
marlowe ALL=NOPASSWD:/usr/sbin/xm destroy goneril
marlowe ALL=NOPASSWD:/usr/sbin/xm shutdown goneril
marlowe ALL=NOPASSWD:/usr/sbin/xm list goneril
marlowe ALL=NOPASSWD:/usr/sbin/xm console goneril
marlowe ALL=NOPASSWD:/usr/sbin/xm reboot goneril</pre><p>Then change the shell of the appropriate users to the <a id="idx-CHP-6-0483" class="indexterm"/>Xen-shell. For example:</p><a id="I_programlisting6_d1e7168"/><pre class="programlisting"># chsh -s /usr/local/bin/xen-login-shell marlowe</pre><p>To mark that a user is allowed to administer a domain, simply add the user to a line in the domain config file—an elegant and ingenious solution. We'll use the domain <span class="emphasis"><em>goneril</em></span> as an example:</p><a id="I_programlisting6_d1e7175"/><pre class="programlisting">name = 'goneril'
xen-shell = 'marlowe'</pre><p>Now, when marlowe logs in, he'll be presented with the Xen-shell interface from which he can execute various commands (get a list by typing <strong class="userinput"><code>Help</code></strong>).</p><div class="note" title="Note"><h3 class="title"><a id="note-27"/>Note</h3><p><span class="emphasis"><em>Although Xen-shell reads domain config files to find which domains can be administered by a user, it doesn't actually keep track of the config file's name, as of this writing. Domain configuration filenames, to work with Xen-shell's</em></span> <em class="replaceable"><code>boot</code></em> <span class="emphasis"><em>command, must be of the form</em></span> <em class="replaceable"><code>&lt;domU name&gt;.cfg</code></em>. <span class="emphasis"><em>Thus, goneril's config file must be</em></span> /etc/xen/goneril.cfg.</p></div><p>To extend the example, let's say that marlowe can administer multiple domains. Simply add the username to both domains, and use the <code class="literal">control</code> command in Xen-shell to switch between them. One of the niceties of Xen-shell is that the command only shows up if it's necessary.</p><a id="I_programlisting6_d1e7205"/><pre class="programlisting">xen-shell[goneril]&gt; control regan
Controlling: regan
xen-shell[regan]&gt;</pre><p>Convenient, isn't it?</p><p>Really, though, this is just the beginning. The client software for Xen is still in turmoil, with constant development by multiple factions.</p><p>You may have noticed that we've left out a couple of prominent frontends. For one, we haven't even mentioned Citrix's offering because we cover it in <a class="xref" href="ch11.html" title="Chapter 11. CITRIX XENSERVER: XEN FOR THE ENTERPRISE">Chapter 11</a>. We also haven't addressed Amazon's EC2, which is probably the nearest thing to <span class="emphasis"><em>utility computing</em></span> at present. As always, there's a big field of tools out there, and we're just aiming to make them seem manageable and talk about what works for us.<a id="I_indexterm6_d1e7218" class="indexterm"/><a id="I_indexterm6_d1e7221" class="indexterm"/></p></div></div></body></html>