<html><head></head><body><section epub:type="chapter" id="metasploit_auxiliary_modules"><div class="titlepage"><div class="book"><div class="book"><h2 class="title1">Chapter 9. Metasploit Auxiliary Modules</h2></div></div></div><p class="calibre2">When most people think of Metasploit, exploits come to mind. Exploits are cool, exploits get you shell, and exploits get all the attention. But sometimes you need something more than that. By definition, a Metasploit module that is not an exploit is an <span class="strong"><em class="calibre4">auxiliary module</em></span>, which leaves a lot to the imagination.</p><p class="calibre2">In addition to providing valuable reconnaissance tools such as port scanners and service fingerprinters, auxiliary modules such as <span class="strong"><em class="calibre4">ssh_login</em></span> can take a known list of usernames and passwords and then attempt to log in via brute force across an entire target network. Also included in the auxiliary modules are various protocol fuzzers such as <span class="strong"><em class="calibre4">ftp_pre_post</em></span>, <span class="strong"><em class="calibre4">http_get_uri_long</em></span>, <span class="strong"><em class="calibre4">smtp_fuzzer</em></span>, <span class="strong"><em class="calibre4">ssh_version_corrupt</em></span>, and more. You can launch these fuzzers at a target service in hopes of finding your own vulnerabilities to exploit.<a id="IDX-CHP-9-0001" class="strong"/></p><p class="calibre2">Just because auxiliary modules don’t have a payload, don’t think you won’t use them. But before we dive into their myriad uses, here’s an overview to help you see what we are dealing with.</p><a id="I_programlisting9_d1e10640" class="strong"/><pre class="programlisting"><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> root@bt:/opt/framework3/msf3/modules/auxiliary# <strong class="calibre3"><code class="calibre6">ls -l</code></strong>
  total 52
  drwxr-xr-x 23 root root 4096 Apr 10 03:22 admin
  drwxr-xr-x  4 root root 4096 Dec 14 03:25 client
  drwxr-xr-x 16 root root 4096 Jan  1 04:19 dos
  drwxr-xr-x  8 root root 4096 Dec 14 03:25 fuzzers
  drwxr-xr-x  3 root root 4096 May  2 15:38 gather
  drwxr-xr-x  4 root root 4096 Dec 14 03:25 pdf
  drwxr-xr-x 36 root root 4096 Apr 10 03:22 scanner
  drwxr-xr-x  5 root root 4096 May  2 15:38 server
  drwxr-xr-x  3 root root 4096 May  2 15:38 sniffer
  drwxr-xr-x  5 root root 4096 Dec 14 03:25 spoof
  drwxr-xr-x  4 root root 4096 Dec 14 03:25 sqli
  drwxr-xr-x  3 root root 4096 May  2 15:38 test
  drwxr-xr-x  3 root root 4096 May  2 15:38 voip</pre><p class="calibre2">As you can see in the preceding listing, modules are installed within the <span class="strong"><em class="calibre4">/modules/auxiliary</em></span> directory <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10655" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> of the Framework, and within that, sorted based on the functions they provide. Should you want to create your own module or edit an existing one to suit a specific purpose, you will find them in their corresponding directories. For instance, if you need to develop a fuzzer module to hunt your own bugs, you will find some pre-existing modules in the <span class="strong"><em class="calibre4">/fuzzers</em></span> directory.<a id="IDX-CHP-9-0002" class="strong"/><a id="IDX-CHP-9-0003" class="strong"/></p><p class="calibre2">To list all the available auxiliary modules within Metasploit, simply issue the <strong class="calibre3"><code class="calibre6">show auxiliary</code></strong> command <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10675" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> within <span class="strong"><em class="calibre4">msfconsole</em></span>. If you compare the preceding directory listing with the module names displayed in <span class="strong"><em class="calibre4">msfconsole</em></span>, you will notice that the naming of the modules depends on the underlying directory structure, as shown below.</p><a id="I_programlisting9_d1e10687" class="strong"/><pre class="programlisting"><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> msf &gt; <strong class="calibre3"><code class="calibre6">show auxiliary</code></strong>

  Auxiliary
  =========

     Name                                  Rank       Description
     ----                                  ----       -----------
     admin/backupexec/dump                 normal
     Veritas Backup Exec Windows Remote
                                                        File Access
     admin/backupexec/registry             normal     Veritas
 Backup Exec Server Registry
                                                        Access
     admin/cisco/ios_http_auth_bypass      normal     Cisco IOS HTTP Unauthorized
                                                        Administrative Access
  <strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

     fuzzers/ssh/ssh_version_corrupt       normal     SSH Version Corruption
     fuzzers/tds/tds_login_corrupt         normal     TDS Protocol
 Login Request Corruption
                                                        Fuzzer
     fuzzers/tds/tds_login_username        normal
    TDS Protocol Login Request Username
                                                        Fuzzer
     fuzzers/wifi/fuzz_beacon              normal     Wireless Beacon Frame Fuzzer
     fuzzers/wifi/fuzz_proberesp           normal
     Wireless Probe Response Frame Fuzzer
     gather/citrix_published_applications  normal     Citrix MetaFrame ICA Published
                                                        Applications Scanner
     gather/citrix_published_bruteforce    normal     Citrix MetaFrame ICA Published
                                                        Applications Bruteforcer
     gather/dns_enum                       normal     DNS Enumeration Module
     gather/search_email_collector         normal
     Search Engine Domain Email Address
                                                        Collector
     pdf/foxit/authbypass                  normal     Foxit
 Reader Authorization Bypass
     scanner/backdoor/energizer_duo_detect normal     Energizer DUO Trojan Scanner
     scanner/db2/db2_auth                  normal     DB2
 Authentication Brute Force Utility
     scanner/db2/db2_version               normal     DB2 Probe Utility</pre><p class="calibre2">As you can see in this trimmed output, the auxiliary modules are organized by category. At your disposal are the DNS enumeration module, Wi-Fi fuzzers, and even a module to locate and abuse the Trojan backdoor that was included on Energizer USB battery chargers.<a id="IDX-CHP-9-0004" class="strong"/><a id="IDX-CHP-9-0005" class="strong"/><a id="IDX-CHP-9-0006" class="strong"/><a id="IDX-CHP-9-0007" class="strong"/><a id="IDX-CHP-9-0008" class="strong"/><a id="IDX-CHP-9-0009" class="strong"/></p><p class="calibre2">Using an auxiliary module is similar to using any exploit within the Framework — simply issue the <code class="literal">use</code> command followed by the module name. For example, to use the <span class="strong"><em class="calibre4">webdav_scanner</em></span> module (explored in <a class="xref" href="part0013.html#auxiliary_modules_in_use">Auxiliary Modules in Use</a> in <a class="xref" href="part0013.html#auxiliary_modules_in_use">Auxiliary Modules in Use</a>), you would run <code class="literal">use scanner/http/webdav_scanner</code> as shown below.</p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">In auxiliary modules, the basic options are slightly different with an <code class="literal">RHOSTS</code> option to target multiple machines and a <code class="literal">THREADS</code> value to fine-tune the speed of your scanning.</p></div><div class="book"><hr class="calibre5"/></div><a id="I_programlisting9_d1e10745" class="strong"/><pre class="programlisting"><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> msf &gt; <strong class="calibre3"><code class="calibre6">use scanner/http/webdav_scanner</code></strong>
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> msf auxiliary(webdav_scanner) &gt; <strong class="calibre3"><code class="calibre6">info</code></strong>

         Name: HTTP WebDAV Scanner
      Version: 9179
      License: Metasploit Framework License (BSD)
         Rank: Normal

  Provided by:
    et &lt;et@metasploit.com&gt;

  Basic options:
    Name     Current Setting  Required  Description
    ----     ---------------  --------  -----------
    Proxies                   no        Use a proxy chain
<img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
  RHOSTS                    yes       The target address range or CIDR identifier
    RPORT    80               yes       The target port
<img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>   THREADS  1                yes       The number of concurrent threads
    VHOST                     no        HTTP server virtual host

  Description:
    Detect webservers with WebDAV enabled

  msf auxiliary(webdav_scanner) &gt;</pre><p class="calibre2">Here we issue the <code class="literal">use</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10781" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> for the module of interest. We can then get a full dump of information from the system using the <code class="literal">info</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10790" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, as well as a list of the various available options. Within the options, we see that the only required option without a default is <code class="literal">RHOSTS</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10800" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, which can take a single IP address, list, range, or CIDR notation.<a id="IDX-CHP-9-0010" class="strong"/><a id="IDX-CHP-9-0011" class="strong"/><a id="IDX-CHP-9-0012" class="strong"/><a id="IDX-CHP-9-0013" class="strong"/><a id="IDX-CHP-9-0014" class="strong"/><a id="IDX-CHP-9-0015" class="strong"/><a id="IDX-CHP-9-0016" class="strong"/></p><p class="calibre2">The other options mostly vary depending on the auxiliary module being used. For instance, the <code class="literal">THREADS</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10834" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> option allows multiple threads to be launched as part of a scan, which speeds things up exponentially.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="auxiliary_modules_in_use">Auxiliary Modules in Use</h2></div></div></div><p class="calibre2">Auxiliary modules are exciting because they can be used in so many ways for so many things. If you can’t find the perfect auxiliary module, it’s easy to modify one to suit your specific needs.</p><p class="calibre2">Consider a common example. Say you are conducting a remote penetration test, and upon scanning the network, you identify a number of web servers and not much else. Your attack surface is limited at this point, and you have to work with what is available to you. Your auxiliary <span class="strong"><em class="calibre4">scanner/http</em></span> modules will now prove extremely helpful as you look for low-hanging fruit against which you can launch an exploit. To search for all available HTTP scanners, run <strong class="calibre3"><code class="calibre6">search scanner/http</code></strong> as shown here.</p><a id="I_programlisting9_d1e10853" class="strong"/><pre class="programlisting">msf auxiliary(webdav_scanner) &gt; <strong class="calibre3"><code class="calibre6">search scanner/http</code></strong>
  [*] Searching loaded modules for pattern 'scanner/http'...

  Auxiliary
  =========

     Name                                        Rank    Description
     ----                                        ----    -----------
     scanner/http/backup_file                    normal  HTTP Backup File Scanner
     scanner/http/blind_sql_query                normal
  HTTP Blind SQL Injection GET QUERY Scanner
     scanner/http/brute_dirs                     normal
 HTTP Directory Brute Force Scanner
     scanner/http/cert                           normal  HTTP SSL Certificate Checker
     scanner/http/copy_of_file                   normal  HTTP Copy File Scanner
     scanner/http/dir_listing                    normal
  HTTP Directory Listing Scanner
     scanner/http/dir_scanner                    normal  HTTP Directory Scanner
     scanner/http/dir_webdav_unicode_bypass      normal
  MS09-020 IIS6 WebDAV Unicode Auth Bypass
                                                           Directory Scanner
     scanner/http/enum_delicious                 normal
  Pull Del.icio.us Links (URLs) for a domain
     scanner/http/enum_wayback                   normal
  Pull Archive.org stored URLs for a domain
     scanner/http/error_sql_injection            normal
  HTTP Error Based SQL Injection Scanner
     scanner/http/file_same_name_dir             normal
  HTTP File Same Name Directory Scanner
     scanner/http/files_dir                      normal  HTTP Interesting File Scanner
     scanner/http/frontpage_login                normal
  FrontPage Server Extensions Login Utility
     scanner/http/http_login                     normal  HTTP Login Utility
     scanner/http/http_version                   normal  HTTP Version Detection
     scanner/http/lucky_punch                    normal
  HTTP Microsoft SQL Injection Table XSS
                                                           Infection
     scanner/http/ms09_020_webdav_unicode_bypass normal
  MS09-020 IIS6 WebDAV Unicode Auth Bypass
     scanner/http/options                        normal  HTTP Options Detection
     scanner/http/prev_dir_same_name_file        normal  HTTP
 Previous Directory File Scanner
     scanner/http/replace_ext                    normal  HTTP File Extension Scanner
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>   scanner/http/robots_txt
                     normal  HTTP Robots.txt Content Scanner
     scanner/http/soap_xml                       normal
  HTTP SOAP Verb/Noun Brute Force Scanner
     scanner/http/sqlmap                         normal  SQLMAP SQL
 Injection External Module
     scanner/http/ssl                            normal  HTTP
 SSL Certificate Information
     scanner/http/svn_scanner                    normal  HTTP Subversion Scanner
     scanner/http/tomcat_mgr_login               normal  Tomcat
 Application Manager Login Utility
     scanner/http/trace_axd                      normal  HTTP
 trace.axd Content Scanner
     scanner/http/verb_auth_bypass               normal  HTTP Verb
 Authentication Bypass Scanner
     scanner/http/vhost_scanner                  normal  HTTP Virtual
 Host Brute Force Scanner
     scanner/http/vmware_server_dir_trav         normal  VMware Server
 Directory Transversal
                                                           Vulnerability
     scanner/http/web_vulndb                     normal  HTTP Vuln scanner

<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>   scanner/http/webdav_internal_ip
             normal  HTTP WebDAV Internal IP Scanner
     scanner/http/webdav_scanner                 normal  HTTP WebDAV Scanner
     scanner/http/webdav_website_content         normal  HTTP
 WebDAV Website Content Scanner
<img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>   scanner/http/writable
                       normal  HTTP Writable Path PUT/DELETE File Access
     scanner/http/xpath                          normal  HTTP Blind XPATH 1.0 Injector</pre><p class="calibre2">There are a lot of options here, so let’s identify some likely candidates in that list. Notice that there are the options for identifying the <span class="strong"><em class="calibre4">robots.txt</em></span> <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10881" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> file from various servers, numerous ways to interact with WebDAV <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10887" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, tools to identify servers with writable file access <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10893" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, and many other special-purpose modules.<a id="IDX-CHP-9-0017" class="strong"/><a id="IDX-CHP-9-0018" class="strong"/><a id="IDX-CHP-9-0019" class="strong"/></p><p class="calibre2">You can see immediately that there are modules that you can use for subsequent exploration. Older versions of Microsoft IIS had a vulnerability in their WebDAV implementations that allowed for remote exploitation, so you could first run a scan against your targets in hopes of finding a server with WebDAV enabled, as follows.</p><a id="I_programlisting9_d1e10911" class="strong"/><pre class="programlisting">msf auxiliary(dir_webdav_unicode_bypass) &gt; <strong class="calibre3"><code class="calibre6">use scanner/http/webdav_scanner</code></strong>
  msf auxiliary(webdav_scanner) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

  Module options:

     Name     Current Setting  Required  Description
     ----     ---------------  --------  -----------
     Proxies                   no        Use a proxy chain
     RHOSTS                    yes       The target address range or CIDR identifier
     RPORT    80               yes       The target port
     THREADS  1                yes       The number of concurrent threads
     VHOST                     no        HTTP server virtual host

<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> msf auxiliary(webdav_scanner) &gt;
 <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.242, 192.168.13.242.252,</code></strong>
  <strong class="calibre3"><code class="calibre6">192.168.13.242.254, 192.168.4.116, 192.168.4.118, 192.168.4.122,</code></strong>
  <strong class="calibre3"><code class="calibre6">192.168.13.242.251, 192.168.13.242.234, 192.168.8.67, 192.68.8.113,</code></strong>
  <strong class="calibre3"><code class="calibre6">192.168.13.242.231, 192.168.13.242.249, 192.168.4.115, 192.168.8.66, 192.168.8.68,</code></strong>
  <strong class="calibre3"><code class="calibre6">192.168.6.62</code></strong>
  RHOSTS =&gt; 192.168.1.242, 192.168.13.242.252, 192.168.13.242.254, 192.168.4.116,
  192.168.4.118, 192.168.4.122, 192.168.13.242.251, 192.168.13.242.234, 192.168.8.67,
  192.168.6.113, 192.168.13.242.231, 192.168.13.242.249, 192.168.4.115, 192.168.8.66,
  192.168.8.68, 192.168.6.62
  msf auxiliary(webdav_scanner) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

  [*] 192.168.1.242 (Microsoft-IIS/6.0) WebDAV disabled.
  [*] 192.168.13.242.252 (Apache/2.2.9 (Debian) proxy_html/3.0.0 mod_ssl/2.2.9
  OpenSSL/0.9.8g) WebDAV disabled.
  [*] Scanned 04 of 31 hosts (012% complete)
  [*] Scanned 07 of 31 hosts (022% complete)
  [*] 192.168.4.116 (Apache/2.2.3 (Red Hat)) WebDAV disabled.
  [*] Scanned 10 of 31 hosts (032% complete)
  [*] 192.168.4.122 (Apache/2.2.3 (Red Hat)) WebDAV disabled.
  [*] Scanned 13 of 31 hosts (041% complete)
  [*] 192.168.13.242.251 (Microsoft-IIS/6.0) WebDAV disabled.
  [*] 192.168.13.242.234 (Microsoft-IIS/6.0) WebDAV disabled.
  [*] Scanned 16 of 31 hosts (051% complete)
  [*] 192.168.8.67 (Microsoft-IIS/6.0) WebDAV disabled.
  [*] Scanned 19 of 31 hosts (061% complete)
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> [*] 192.168.6.113 (Microsoft-IIS/5.0) has WEBDAV ENABLED
  [*] 192.168.13.242.231 (Microsoft-IIS/6.0) WebDAV disabled.
  [*] Scanned 22 of 31 hosts (070% complete)
  [*] 192.168.13.242.249 (Microsoft-IIS/6.0) WebDAV disabled.
  [*] Scanned 25 of 31 hosts (080% complete)
  [*] 192.168.4.115 (Microsoft-IIS/6.0) WebDAV disabled.
  [*] 192.168.8.66 (Microsoft-IIS/6.0) WebDAV disabled.
  [*] Scanned 28 of 31 hosts (090% complete)
  [*] 192.168.8.68 (Microsoft-IIS/6.0) WebDAV disabled.
  [*] Scanned 31 of 31 hosts (100% complete)
  [*] Auxiliary module execution completed</pre><p class="calibre2">As you can see in this example, a number of HTTP servers have been scanned in the search for WebDAV <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10952" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, and only one happens to have Web-DAV enabled <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e10958" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. This module has quickly identified a specific system against which you can launch further attacks.<a id="IDX-CHP-9-0020" class="strong"/></p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">Auxiliary module functionality goes far beyond scanning. As you will see in <a class="xref" href="part0018.html#creating_your_own_exploits">Chapter 14</a> auxiliary modules also work great as fuzzers with a little modification. A number of denial-of-service modules are also available for Wi-Fi (including <span class="strong"><em class="calibre4">dos/wifi/deauth</em></span>), which can prove quite disruptive when used properly.</p></div><div class="book"><hr class="calibre5"/></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="anatomy_of_an_auxiliary_module">Anatomy of an Auxiliary Module</h2></div></div></div><p class="calibre2">Let’s look at the makeup of an auxiliary module in a fun little example not currently in the Metasploit repository (because it does not pertain to penetration testing). This example will demonstrate how easy it is to off-load a great deal of programming to the Framework, allowing us to focus on the specifics of a module.</p><p class="calibre2">Chris Gates wrote an auxiliary module for the Framework that gave his Twitter followers the impression that he had somehow invented a device that allowed him to travel at the speed of light. It makes a great example of the code reuse available in Metasploit. (You can access the source of the script at <a class="xref" href="http://carnal0wnage.googlecode.com/" target="_top">http://carnal0wnage.googlecode.com/</a>.)<a id="IDX-CHP-9-0021" class="strong"/><a id="IDX-CHP-9-0022" class="strong"/></p><a id="I_programlisting9_d1e10992" class="strong"/><pre class="programlisting"><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">cd modules/auxiliary/admin/</code></strong>
  root@bt:/opt/framework3/msf3/modules/auxiliary/admin# wget
 <strong class="calibre3"><code class="calibre6">http://carnal0wnage.googlecode .com/svn/trunk/</code></strong>
<strong class="calibre3"><code class="calibre6">msf3/modules/auxiliary/admin/random/foursquare.rb</code></strong></pre><p class="calibre2">We’ve placed the module in our auxiliary directory <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11009" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> so that it will be available for use by Metasploit. But before we use this module, let’s look at the actual script and break down the components so we can see exactly what the module contains.</p><a id="I_programlisting9_d1e11015" class="strong"/><pre class="programlisting">require 'msf/core'

<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> class Metasploit3 &lt; Msf::Auxiliary

      # Exploit mixins should be called first
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>     include Msf::Exploit::Remote::HttpClient
      include Msf::Auxiliary::Report</pre><p class="calibre2">The module begins with the first two lines importing the auxiliary class <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11031" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>. Next it makes the HTTP client functions available for use <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11037" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> within the script.<a id="IDX-CHP-9-0023" class="strong"/></p><a id="I_programlisting9_d1e11046" class="strong"/><pre class="programlisting"><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> def initialize
          super(
            <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>'Name'         =&gt; 'Foursquare Location Poster',
              'Version       =&gt; '$Revision:$',
              'Description'  =&gt; 'F*ck with Foursquare, be
 anywhere you want to be by venue id',
              'Author'       =&gt; ['CG'],
              'License'      =&gt; MSF_LICENSE,
              'References'   =&gt;
                  [
                      [ 'URL', 'http://groups.google.com/group/foursquare-api' ],
                      [ 'URL', 'http://www.mikekey.com/im-a-foursquare-cheater/'],
                  ]
          )
  #todo pass in geocoords instead of venueid, create a venueid, other tom foolery
          register_options(
              [
                <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>Opt::RHOST('api.foursquare.com'),
                  OptString.new('VENUEID', [ true, 'foursquare
 venueid', '185675']), #Louvre                      Paris France
                  OptString.new('USERNAME', [ true, 'foursquare
 username', 'username']),
                  OptString.new('PASSWORD', [ true, 'foursquare
 password', 'password']),
              ], self.class)

  end</pre><p class="calibre2">Within the initialization constructor <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11067" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> we define much of the information <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11073" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> that is reported back when issuing the <code class="literal">info</code> command in <span class="strong"><em class="calibre4">msfconsole</em></span>. We can see where the various options are defined <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11085" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> and whether they are required. So far, all are pretty direct and their purposes are clear. Still, we have yet to see any actual logic being performed. That comes next.<a id="IDX-CHP-9-0024" class="strong"/><a id="IDX-CHP-9-0025" class="strong"/><a id="IDX-CHP-9-0026" class="strong"/><a id="IDX-CHP-9-0027" class="strong"/><a id="IDX-CHP-9-0028" class="strong"/></p><a id="I_programlisting9_d1e11107" class="strong"/><pre class="programlisting">def run

          begin
            <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>user = datastore['USERNAME']
              pass = datastore['PASSWORD']
              venid = datastore['VENUEID']
              user_pass = Rex::Text.encode_base64(user + ":" + pass)
              decode = Rex::Text.decode_base64(user_pass)
              postrequest = "twitter=1\n" #add facebook=1 if you want facebook

              print_status("Base64 Encoded User/Pass: #{user_pass}") #debug
              print_status("Base64 Decoded User/Pass: #{decode}") #debug

            <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>res = send_request_cgi({
                  'uri'     =&gt; "/v1/checkin?vid=#{venid}",
                  'version'    =&gt; "1.1",
                  'method'  =&gt; 'POST',
                  'data'   =&gt; postrequest,
                  'headers' =&gt;
                      {
                          'Authorization' =&gt; "Basic #{user_pass}",
                          'Proxy-Connection' =&gt;  "Keep-Alive",
                      }
              }, 25)</pre><p class="calibre2">Now we reach the actual logic of the script — what happens when <code class="literal">run</code> is called within the module. Initially the provided options are set to local variable names <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11126" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> along with defining various other objects. An object is then created by calling the <span class="strong"><em class="calibre4">send_request_cgi</em></span> method <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11135" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> imported into the script from <span class="strong"><em class="calibre4">lib/msf/core/exploit/http.rb</em></span> and defined as “Connects to the server, creates a request, sends the request, reads the response.” This method takes various parameters that make up the call to the actual server, as shown here.</p><a id="I_programlisting9_d1e11145" class="strong"/><pre class="programlisting"><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>print_status("#{res}") #this outputs the entire response. We could probably do
                                    #without this but it's
 nice to see what's going on.
              end

         <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
rescue ::Rex::ConnectionRefused, ::Rex::HostUnreachable, ::Rex::ConnectionTimeout
          rescue ::Timeout::Error, ::Errno::EPIPE =&gt;e
              puts e.message
      end
  end</pre><p class="calibre2">After this object is created, the results are printed <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11160" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>. If anything goes wrong, logic exists for catching any errors <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11166" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> and reporting them to the user. All of this logic is simple and is just a matter of plugging various parameters into existing functions of the Framework. This is a great example of the power of the Framework, because it allows us to concentrate only on the information needed to address our goal. There is no reason to reproduce any of the standard functions such as error handling, connection management, and so on.</p><p class="calibre2">Let’s see this module in action. If you don’t remember the full path to the module within the Metasploit directory structure, search for it like so.</p><a id="I_programlisting9_d1e11174" class="strong"/><pre class="programlisting"><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> msf &gt; <strong class="calibre3"><code class="calibre6">search foursquare</code></strong>
  [*] Searching loaded modules for pattern 'foursquare'...

  Auxiliary
  =========

     Name              Rank    Description
     ----              ----    -----------
     admin/foursquare  normal  Foursquare Location Poster

<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> msf &gt; use admin/foursquare
<img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/> msf auxiliary(foursquare) &gt; info

         Name: Foursquare Location Poster
      Version: $Revision:$
      License: Metasploit Framework License (BSD)
         Rank: Normal

  Provided by:
    CG &lt;cg@carnal0wnage.com&gt;

  Basic options:
    Name      Current Setting     Required  Description
    ----      ---------------     --------  -----------
    PASSWORD  password            yes       foursquare password
    Proxies                       no        Use a proxy chain
    RHOST     api.foursquare.com  yes       The target address
    RPORT     80                  yes       The target port
    USERNAME  username            yes       foursquare username
    VENUEID   185675              yes       foursquare venueid
    VHOST                         no        HTTP server virtual host

  Description:
    F*ck with Foursquare, be anywhere you want to be by venue id

  References:
    http://groups.google.com/group/foursquare-api
    http://www.mikekey.com/im-a-foursquare-cheater/</pre><p class="calibre2">In the prior example, we search for “foursquare” <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11198" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, issue the <code class="literal">use</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11207" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> to select the auxiliary module, and display the information <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11213" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> for the selected module. Based on the options presented above, we need to configure a few of them first.<a id="IDX-CHP-9-0029" class="strong"/></p><a id="I_programlisting9_d1e11222" class="strong"/><pre class="programlisting"><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> msf auxiliary(foursquare) &gt; <strong class="calibre3"><code class="calibre6">set VENUEID 2584421</code></strong>
  VENUEID =&gt; 2584421
  msf auxiliary(foursquare) &gt; <strong class="calibre3"><code class="calibre6">set USERNAME msf@elwood.net</code></strong>
  USERNAME =&gt; metasploit
  msf auxiliary(foursquare) &gt; <strong class="calibre3"><code class="calibre6">set PASSWORD ilovemetasploit</code></strong>
  PASSWORD =&gt; ilovemetasploit
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> msf auxiliary(foursquare) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>
  [*] Base64 Encoded User/Pass: bXNmQGVsd29vZC5uZXQ6aWxvdmVtZXRhc3Bsb2l0
  [*] Base64 Decoded User/Pass: msf@elwood.net:ilovemetasploit
  [*] HTTP/1.1 200 OK
  Content-Type: text/xml; charset=utf-8
  Date: Sat, 08 May 2010 07:42:09 GMT
  Content-Length: 1400
  Server: nginx/0.7.64
  Connection: keep-alive

  &lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;checkin&gt;&lt;id&gt;40299544&lt;/id&gt;&lt;created&gt;Sat,
 08 May 10 07:42:09 +0000&lt;/created&gt;&lt;message&gt;OK!
  We've got you @ Washington DC Union Station. This
 is your 1st checkin here!&lt;/message&gt;
  &lt;venue&gt;&lt;id&gt;2584421&lt;/id&gt;&lt;name&gt;Washington DC Union Station&lt;/name&gt;&lt;primary
category&gt;&lt;id&gt;79283&lt;/
  id&gt;&lt;fullpathname&gt;Travel:Train Station&lt;/
fullpathname&gt;&lt;nodename&gt;Train Station&lt;/nodename&gt;
  &lt;iconurl&gt;http://foursquare.com/img/categories/travel/
trainstation.png&lt;/iconurl&gt;&lt;/primary
  category&gt;&lt;address&gt;Union Station&lt;/address&gt;&lt;city&gt;Washington&lt;/city&gt;&lt;state&gt;DC&lt;/
state&gt;&lt;geolat&gt;
  38.89777986957695&lt;/geolat&gt;&lt;geolong&gt;-77.0060920715332
&lt;/geolong&gt;&lt;/venue&gt;&lt;mayor&gt;&lt;type&gt;nochange
  &lt;/type&gt;&lt;checkins&gt;4&lt;/checkins&gt;&lt;user&gt;&lt;id&gt;685446&lt;/id&gt;&lt;firstname&gt;
Ron&lt;/firstname&gt;&lt;photo&gt;http://
  playfoursquare.s3.amazonaws.com/userpix_thumbs/ELOW44Q
HXJFB4PWZ.jpg&lt;/photo&gt;&lt;gender&gt;male&lt;/
  gender&gt;&lt;/user&gt;&lt;message&gt;Ron is The Mayor
 of Washington DC Union Station.&lt;/message&gt;&lt;/mayor&gt;
  &lt;badges&gt;&lt;badge&gt;&lt;id&gt;1&lt;/id&gt;&lt;name&gt;Newbie&lt;/name&gt;&lt;icon&gt;http://
foursquare.com/img/badge/newbie
  .png&lt;/icon&gt;&lt;description&gt;Congrats on your
 first check-in!&lt;/description&gt;&lt;/badge&gt;&lt;/badges&gt;
  &lt;scoring&gt;&lt;score&gt;&lt;points&gt;1&lt;/
points&gt;&lt;icon&gt;http://foursquare.com/img/scoring/2.png&lt;/icon&gt;
  &lt;message&gt;First stop tonight<img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>&lt;/message&gt;&lt;/score&gt;
&lt;score&gt;&lt;points&gt;5&lt;/points&gt;&lt;icon&gt;http://
  foursquare.com/img/scoring/1.png&lt;/icon&gt;
&lt;message&gt;First time @ Washington DC Union Station!&lt;/
  message&gt;&lt;/score&gt;&lt;/scoring&gt;&lt;/checkin&gt;</pre><p class="calibre2">In order to run this module successfully, we need a valid set of Foursquare credentials to do the check-in. We first define the VenueID that we find online with a bit of Googling <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11256" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, and then we set our Foursquare credentials <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11262" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> and run the module. We get a successful result with the Foursquare service confirming our check-in and giving us five points <span class="inlinemediaobject"><a id="I_inlinemediaobject9_d1e11268" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>.<a id="IDX-CHP-9-0030" class="strong"/><a id="IDX-CHP-9-0031" class="strong"/><a id="IDX-CHP-9-0032" class="strong"/></p><p class="calibre2">In this case, we have submitted a request to “check in” at Union Station in Washington, DC, on the Foursquare service (see <a class="xref" href="part0013.html#a_successful_check-in_at_union_station">Figure 9-1</a>).</p><div class="figure"><a id="a_successful_check-in_at_union_station" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject9_d1e11290" class="strong"/><img src="../images/00038.jpeg" alt="A successful check-in at Union Station" hisrc="httpatomoreillycomsourcenostarchimages867530.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 9-1. A successful check-in at Union Station</div></div><p class="calibre2">When we check the Foursquare website, we see a successful result. Modules like these demonstrate that Metasploit allows us to implement nearly anything we can programmatically imagine.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="going_forward">Going Forward</h2></div></div></div><p class="calibre2">As you have seen, auxiliary modules can have a wide range of uses. The infrastructure provided by the Metasploit Framework can produce a wide array of tools in a very short time. Using Metasploit’s auxiliary modules, you can scan an IP address range to determine which hosts are alive and which services are running on each host. You can then leverage this information to determine vulnerable services, such as in the WebDAV example, or even log in via brute force on a remote server.</p><p class="calibre2">Although you can easily create custom auxiliary modules, don’t discount the existing auxiliary modules in the Framework. These modules may be the exact one-off tool you need.</p><p class="calibre2">The auxiliary modules provide a wide range of potential additional avenues. For a web application, the auxiliary modules offer more than 40 additional checks or attacks that you can perform. In some instances, you may want to brute force a web server to see which servers are listing directories. Or you may want to scan the web server to see if it can act as an open proxy and relay traffic out to the Internet. Regardless of your needs, the auxiliary modules can provide additional enumeration information, attack vectors, or vulnerabilities.</p></div></section></body></html>