- en: Part IV. Part IV Special Applications
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Chapter 20. Monitoring Windows Servers
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: You don't always deal with a homogeneous server landscape consisting of just
    Linux or Linux/Unix computers. As long as you are just monitoring pure network
    services, operating systems make no difference. But if you want to query local,
    non-network-capable resources, that is a different matter altogether.
  prefs: []
  type: TYPE_NORMAL
- en: With Unix-based systems such as Mac OS X, you can normally use the tools described
    so far (local plugins, NRPE, NSCA). In Windows you have to find other solutions.
    To some extent, local plugins can be run and/or compiled in an environment emulating
    Unix (for example, Cygwin^([[228](#ftn.CHP-20-FN-1)])).
  prefs: []
  type: TYPE_NORMAL
- en: Because of the different philosophies of the operating system families, there
    are peculiarities as well, features in one operating system that are not comparable
    with anything in the other operating system. So although the Windows event log
    fulfils much the same purpose as syslog in Unix, it is queried in a completely
    different way, seen from a technical point of view. Here you cannot simply compile
    the Unix plugin in Windows and then use it.
  prefs: []
  type: TYPE_NORMAL
- en: One monitoring approach for Windows servers is to use SNMP, for which Microsoft
    includes a native implementation that just needs to be installed. Since the SNMP
    query of a Windows agent does not differ in principle from that of other SNMP
    agents, we refer you to [Chapter 11](../Text/ch11.html "Chapter 11. Collecting
    Information Relevant for Monitoring with SNMP"), page 227\. The Microsoft implementation,
    however, does not always work reliably where the display of figures—particularly
    CPU load and hard drive space—is concerned.
  prefs: []
  type: TYPE_NORMAL
- en: '![check_nt queries local Windows resources about the NSClient mechanism.](../Images/tagoreillycom20081104nostarchimages223990.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 20-1. `check_nt` queries local Windows resources about the NSClient mechanism.
  prefs: []
  type: TYPE_NORMAL
- en: 'But local Windows resources can also be queried if you install a service on
    the Windows server that can be addressed over the network. Previously, only a
    single tool was available, NSClient, but today you have a choice of various programs:
    NSClient, NSClient++, OpMon Agent, or NC_Net. For all of them, basic parameters
    such as CPU and hard disk load, memory usage or Windows counters are queried with
    the **`check_nt`** plugin (see [Figure 20-1](../Text/ch20.html#check_underscore_nt_queries_local_wi
    "Figure 20-1. check_nt queries local Windows resources about the NSClient mechanism.")),
    which is one of the standard Nagios plugins.'
  prefs: []
  type: TYPE_NORMAL
- en: '![check_nrpe uses the NRPE mechanism to execute checks via NSClient++, OpMon
    Agent, and NRPE_NT.](../Images/tagoreillycom20081104nostarchimages223992.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 20-2. `check_nrpe` uses the NRPE mechanism to execute checks via NSClient++,
    OpMon Agent, and NRPE_NT.
  prefs: []
  type: TYPE_NORMAL
- en: In addition, NSClient++ and OpMon Agent support NRPE (see [Chapter 10](../Text/ch10.html
    "Chapter 10. The Nagios Remote Plugin Executor (NRPE)") from page 213). Querying
    the locally installed plugins is done by **`check_ nrpe`** ([Figure 20-2](../Text/ch20.html#check_underscore_nrpe_uses_the_nrpe
    "Figure 20-2. check_nrpe uses the NRPE mechanism to execute checks via NSClient++,
    OpMon Agent, and NRPE_NT.")).
  prefs: []
  type: TYPE_NORMAL
- en: NC_Net in turn allows passive checks, the results of which are sent to the Nagios
    server by the NSCA ([Chapter 14](../Text/ch14.html "Chapter 14. The Nagios Service
    Check Acceptor (NSCA)"), page 299). If you query the data with **`check_ncnet`**
    ([Figure 20-3](../Text/ch20.html#check_underscore_ncnet_allows_passive "Figure 20-3. check_ncnet
    allows passive checks.")) instead of the standard plugin **`check_nt`**, an extended
    set of commands is available ([20.3.3 Installing the check_ncnet plugin](../Text/ch20s03.html#installing_the_check_underscore_nc
    "20.3.3 Installing the check_ncnet plugin"), page 480).
  prefs: []
  type: TYPE_NORMAL
- en: '![check_ncnet allows passive checks.](../Images/tagoreillycom20081104nostarchimages223994.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 20-3. `check_ncnet` allows passive checks.
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, there is also a purely NRPE service for Windows: NRPE_NT, which is
    configured the same as in Unix. Due to the additional NRPE functionality of NSClient++
    and OpMon Agent, however, this has lost some of its significance.'
  prefs: []
  type: TYPE_NORMAL
- en: 20.1 Agent-less Checks via WMI
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: With *Windows Management Instrumentation*, or WMI for short, Microsoft provides
    an interface that allows network-wide querying of system properties, assuming
    that the user doing the query has sufficient permissions. The WMI query is made
    from a central Windows system; NRPE is used for communication between the Nagios
    server and the WMI proxy ([Figure 20-4](../Text/ch20.html#using_the_wmi_interface_with_nagios
    "Figure 20-4. Using the WMI interface with Nagios")). Just a single Windows server
    is required, on which one NRPE service and all the desired plugins are installed
    in the form of WMI scripts—although to do this, you have to be familiar with the
    Microsoft WMI world.
  prefs: []
  type: TYPE_NORMAL
- en: '![Using the WMI interface with Nagios](../Images/tagoreillycom20081104nostarchimages223996.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 20-4. Using the WMI interface with Nagios
  prefs: []
  type: TYPE_NORMAL
- en: Extensive configuration examples can be found at the NagiosExchange^([[229](#ftn.CHP-20-FN-2)])
    under **Categories | Check Plugins | Operating Systems | Windows | Windows NRPE**,
    for instance, under the entry **wmi agentless plugins**.^([[230](#ftn.CHP-20-FN-3)])
    We will not go into further details of the WMI interface here.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[228](#CHP-20-FN-1)]) [http://www.cygwin.com/](http://www.cygwin.com/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[229](#CHP-20-FN-2)]) [http://www.nagiosexchange.org](http://www.nagiosexchange.org)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[230](#CHP-20-FN-3)]) [http://www.nagiosexchange.org/66;235](http://www.nagiosexchange.org/66;235)
  prefs: []
  type: TYPE_NORMAL
- en: 20.2 Installing and Configuring the Additional Services
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In contrast to the WMI approach, the additional services NSClient, NS-Client++,
    OpMon Agent, and NC_Net must be installed on every single Windows server.
  prefs: []
  type: TYPE_NORMAL
- en: 20.2.1 NSClient
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: NSClient, as the oldest package, has been widely tested and is in widespread
    use, but it is no longer being actively developed. The last current version is
    from October 2003; the package can be downloaded from the Nagios Exchange.^([[231](#ftn.CHP-20-FN-4)]).
    It also runs in Windows NT, Windows 2000 and Windows XP.
  prefs: []
  type: TYPE_NORMAL
- en: For Windows 2003, in particular Windows 2003 R2, the original package is no
    longer suitable, because numerous error messages in the form
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: land in the event log, which lengthens the execution time considerably. At the
    NagiosExchange a recompiled version can be found in the package **`nsclient_-_no_pdh.zip`**,^([[232](#ftn.CHP-20-FN-5)])
    which does not have this problem.
  prefs: []
  type: TYPE_NORMAL
- en: 'For the NSClient installation, you unpack the archive **`nsclient_201.zip`**
    or **`nsclient_-_no_pdh.zip`**. This creates subdirectories named according to
    the architecture: **`Win_NT4_Bin`** for Windows NT and **`Win_2k_XP_Bin`** for
    Windows 2000 and higher. Copy the contents of the appropriate folder to the directory
    **`C:\Programs\NSClient`** and install NSClient from there as a service:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: Running **`pNSClient.exe /install`** installs the service, and the switch **`/uninstall`**
    removes the service again. You should make sure that the operating system starts
    automatically using the services management.
  prefs: []
  type: TYPE_NORMAL
- en: 'NSClient has two parameters: **`port`** and **`password`**, with the defaults
    **`1248`** (port) and **`none`** (password). The values can only be changed (with
    **`regedit`**) in the registry under **`HKEY_LOCAL_MACHINE\SOFTWARE\NSClient\Parms`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 20.2.2 NC_Net
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: NC_Net, by Tony Montibello, is one of the successors to NSClient, and its calls
    are also compatible with NSClient. Thus, NSClient can simply be replaced with
    NC_Net on the Windows server, without the need to change the Nagios configuration.
    Development on NC_Net is very active. The current version at the time this book
    went to press, version 4.x, is based on the [DOT.NET](http://dot.net) framework,
    version 2.0\. This is included by default only starting from Windows Server 2003
    R2, but even there it is not installed automatically. For those who cannot or
    who don't want to install the new framework, the older NC_Net version 2.28 runs
    under [DOT.NET](http://DOT.NET) 1.1 and is very stable and well established.
  prefs: []
  type: TYPE_NORMAL
- en: NC_Net Version 2.28 is available on the NC_Net homepage,^([[233](#ftn.CHP-20-FN-6)])
    and all newer versions can be found at SourceForge.^([[234](#ftn.CHP-20-FN-7)]).
    Make sure that any previous version installed is first uninstalled. Since NC_Net
    uses the Microsoft Installer, you do this through the software administration
    utility. Even an NSClient that might exist should be removed first.
  prefs: []
  type: TYPE_NORMAL
- en: Double clicking on the file **`NC_Net_setup.msi`** installs the service, but
    you should check in the service management that it really is running, and whether
    or not **`automatic`** is entered as the starting type.
  prefs: []
  type: TYPE_NORMAL
- en: 'NC_Net has the same parameters as NSClient, with **`password`** and **`port`**,
    but these can also be specified in the services management under **`properties`**
    in the **`Start parameters`** line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 20.2.3 NSClient++
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: NSClient++ combines two query methods. On one hand, it is compatible with NSClient
    and can make queries as usual with **`check_nt`**. On the other hand, it contains
    a built-in NRPE service which can be configured and used like NRPE_NT (see [20.4.1
    NRPE_NT, the classic tool](../Text/ch20s04.html#nrpe_underscore_nt_comma_the_classic
    "20.4.1 NRPE_NT, the classic tool") from page 488). NSClient++ provides all the
    NSClient functions via loadable modules, as well as other features such as event
    log querying or WMI queries via NRPE. In contrast to NRPE_NT, it is not essential
    to have external plugins for querying the CPU and hard disk load if you are using
    the modules.
  prefs: []
  type: TYPE_NORMAL
- en: NSClient++ is being actively developed; the homepage^([[235](#ftn.CHP-20-FN-8)])
    provides not only a download area and documentation in the form of a Wiki, but
    also a bug-tracking system which allows you to report any errors and to make requests,
    including tracing open tickets.
  prefs: []
  type: TYPE_NORMAL
- en: Installation
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The current NSClient++ version can be downloaded as a zip file from the homepage^([[236](#ftn.CHP-20-FN-9)])
    or from SourceForge.^([[237](#ftn.CHP-20-FN-10)]) The contents of this file are
    unpacked, for instance in **`D:\Program Files\Nagios\nsclient++`**, and from there
    they are installed as a service, and the program is started:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'If you want to use the classical **`net start`** command instead of the administrative
    tools to start and stop the service, you need to know that it is called **`nsclientpp`**
    (and not **`nsclient++`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: Configuration
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: NSClient++ requires a configuration file **`NSC.ini`** located in the same directory
    where the NSClient++-EXE file resides. The **`NSC.ini`** included in the distrubution
    needs to be edited in all cases.
  prefs: []
  type: TYPE_NORMAL
- en: 'This file is divided into a number of sections:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'Each section begins with a keyword in square brackets, and comment lines start
    with a semicolon. The section **`[modules]`** loads the individual modules. The
    following modules are currently available:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: The internal module **`FileLogger.dll`** logs the work of NSClient++ to a file
    and does not provide any checks.
  prefs: []
  type: TYPE_NORMAL
- en: '**`CheckDisk.dll`** checks the file size and hard disk usage, and **`CheckSystem.dll`**
    checks the CPU, the memory, counters, uptime, and service and process states.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`NSClientListener.dll`** ensures compatibility with NSClient. If this module
    is not loaded, queries with **`check_nt`** will fail. The module **`NRPEListener.dll`**
    implements the NRPE service. This means you can choose whether you use NSClient++
    as an NSClient or as an NRPE_NT replacement, or whether you use both functions
    at the same time.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`SysTray.dll`** installs a systray icon on the server for access to NSClient++.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`CheckHelpers.dll`** is a test module that always provides a specific return
    value (e.g., OK) and is not required for normal operation.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`CheckWMI.dll`** provides queries for the WMI interface, but it is not yet
    completely finished.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The global section **`[Settings]`** contains settings that apply across section
    boundaries, including the password parameters and **`allowed_hosts`**, which are
    inherited by the sections **`[NSClient]`** ([Configuration](../Text/ch20s02.html#configuration-id4
    "Configuration")) and **`[NRPE]`** ([Perl plugins in Windows](../Text/ch20s04.html#perl_plugins_in_windows
    "Perl plugins in Windows")), unless these options are set differently there:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: '**`obfuscated_password`**, like **`password`**, is currently used only by the
    NS-Client-compatible part of NSClient++, and not for NRPE. Both parameters set
    the password for **`check_nt. obfuscated_password`** obscures this, so that it
    does not appear in plain text in the INI file. However, this is not real encryption.
    An **`obfuscated_password`** is generated by running **`nsclient++ /encrypt`**.
    This utility asks for a password, which it then displays in obscured form.^([[238](#ftn.CHP-20-FN-11)])'
  prefs: []
  type: TYPE_NORMAL
- en: The parameter **`allowed_hosts`** controls which IP addresses may access NSClient++.
    If it is left empty, there are no access restrictions. You can specify several
    IP addresses by separating them with commas, but it is not possible to use host
    names here.
  prefs: []
  type: TYPE_NORMAL
- en: Finally, **`use_file`** controls whether the configuration file is to be used
    at all (**`use_file=1`**). If the value **`0`** is entered here, NSClient++ searches
    in the registry for the settings. Configuration via the registry is currently
    still experimental, and it poses a security risk due to lack of sufficient protection,
    and so we will not look at it in more detail.
  prefs: []
  type: TYPE_NORMAL
- en: 'The next section is devoted to logging:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: With **`debug=1`**, debugging—which is disabled by default, using the value
    **`0`**—can be switched on. **`file`** specifies the log file. If you omit this
    parameter or (as shown here) comment it out, NSClient++ writes its error messages
    to **`nsclient.log`**, in the same directory in which the binary file lies. The
    software does this even if debugging is switched off. With **`date_mask`** you
    can specify the date format of the timestamp with which every log message begins.
    This format corresponds to what is described in **`man date`**.
  prefs: []
  type: TYPE_NORMAL
- en: The **`[NSClient]`** section sets a number of options concerning compatibility
    with NSClient. Although nothing else can be configured here, NSClient functions
    (see [20.3 The check_nt Plugin](../Text/ch20s03.html "20.3 The check_nt Plugin")
    from page 472) are only available if the **`NS-ClientListener.dll`** module, **`CheckDisk.dll`**,
    and **`CheckSystem.dll`** (see [Configuration](../Text/ch20s02.html#configuration-id4
    "Configuration")) have been loaded.^([[239](#ftn.CHP-20-FN-12)])
  prefs: []
  type: TYPE_NORMAL
- en: 'The parameter **`allowed_hosts`** overrides the setting in the **`[Settings]`**
    section. In this way, NSClient++ can use a configuration for working with **`check_nt`**
    that is different from the one used for NRPE:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: The **`port`** and **`bind_to_address`** parameters specify the socket on which
    NSClient++ accepts **`check_nt`** queries. The default for the port is 1248, which
    regularly leads to problems on some Windows servers (e.g., Exchange servers) (see
    also page 471). You should therefore change to a higher port number (e.g., 12489).
  prefs: []
  type: TYPE_NORMAL
- en: '**`bind_to_address`** specifies the IP address of the intended host, on which
    the service will listen. This parameter is only needed if the computer has more
    than one network interface and a specific IP address is to be set.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The **`[Check System]`** section allows system checks to be fine-tuned. Normally
    you won''t need to configure anything here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: '**`CPUBufferSize`** determines how long NSClient++ stores information on the
    CPU load. The allowed value range starts at one second (**`1s`**), with a maximum
    often weeks (**`10w`**). To save data for a long period, however, you need a large
    amount of memory. The default value of one hour is enough for most purposes.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`CheckResolution`** specifies the resolution of the stored measurement values
    in tenths of a second. The value **`10`** therefore means that a value is determined
    every second. **`CheckResolution`** currently influences only CPU measurement
    values.'
  prefs: []
  type: TYPE_NORMAL
- en: Other parameters for the **`[Check System]`** section are rarely required and
    are documented in the Wiki.^([[240](#ftn.CHP-20-FN-13)])
  prefs: []
  type: TYPE_NORMAL
- en: Configuration of the NRPE services in the two sections **`[NRPE Handlers]`**
    and **`[NRPE]`** is dealt with in [20.4.3 NRPE with NSClient++](../Text/ch20s04.html#nrpe_with_nsclient_plus_plus
    "20.4.3 NRPE with NSClient++") from page 493, and the internal functions of NSClient++
    that can be called via NRPE are described in [20.4.4 Internal NSClient++ functions](../Text/ch20s04.html#internal_nsclient_plus_plus_functions
    "20.4.4 Internal NSClient++ functions") from page 495.
  prefs: []
  type: TYPE_NORMAL
- en: 20.2.4 OpMon Agent
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: OpMon Agent is nothing more than a further development of the original NSClient
    code by the company OPServices.^([[241](#ftn.CHP-20-FN-14)]). It can therefore
    be considered to be a succcessor to the NSClient program. Like its predecessor,
    the software is published under the GNU Public License.
  prefs: []
  type: TYPE_NORMAL
- en: 'To install it, you unpack the current zip file from [http://www. opservices.com.br/downloads/](http://www.%20opservices.com.br/downloads/)
    to **`C:\Program Files\Nagios\opmonagent`** and enter the following commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'OpMon Agent also stores its configuration in an INI file. The original **`opmo-nagent.ini`**
    looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: The NSClient functionality is configured in the **`[OPMONAGENT]`** section.
    **`enable=1`** allows queries via **`check_nt`**, but if this parameter is set
    to **`0`**, OpMon Agent ignores this.
  prefs: []
  type: TYPE_NORMAL
- en: '**`password`** sets a password, and the value **`None`** means that no password
    is required. Otherwise, the password is written in plain text after the equals
    sign.'
  prefs: []
  type: TYPE_NORMAL
- en: 5667 is entered here as the standard port, but if you want to use the usual
    port 1248, you just change the entry and restart the service. **`allow_from`**
    restricts access to specific hosts.
  prefs: []
  type: TYPE_NORMAL
- en: '**`autodetect_counters=1`** tries to automatically determine the exact name
    of the Windows performance counter, depending on the language setting of Windows
    and the exact Windows version. If you switch off this capability with the value
    **`0`**, you must specify the name explicitly in **`use_counters`**. Possible
    values for this parameter are listed in the file **`counters.def`**, which is
    located in the same directory as **`opmonagent.ini`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`max_connections`** restricts the number of possible simultaneous connections.
    A **`debuglevel`** value larger than **`0`** switches on debugging.'
  prefs: []
  type: TYPE_NORMAL
- en: In the future, it should be possible to configure the NRPE functions of OpMon
    Agent, which will be introduced in a later version, in the **`[NRPE]`** section.
    The current version of OpMon Agent at the time this book goes to press, version
    2.4, does not yet provide official support for NRPE.
  prefs: []
  type: TYPE_NORMAL
- en: 20.2.5 Rectifying problems with port 1248
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: All NSClient-compatible services work by default on port 1248\. This can sometimes
    turn out to be a problem, because Windows operating systems work intensively with
    RPCs (Remote Procedure Calls). Here ports are assigned dynamically, starting at
    port 1025\. Thus, under certain circumstances—for servers with many services or
    many simultaneous connections, for example—port 1248 is often already occupied
    when NSClient is started as a service. For Exchange servers, this happens fairly
    often after a reboot. You should therefore change to a high, unproblematic port
    number, such as 12489.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you are not installing Nagios for the first time but are working with an
    existing installation, you may not be able to easily change the port for all hosts
    to be monitored. For Nagios 2.x, there is no choice but to define a separate command
    for every port used. With Nagios 3.0, this can be done more elegantly. The solution
    is to use self-defined variables (see [H.2 Variable and Macros](../Text/aphs02.html
    "H.2 Variable and Macros") from page 685). In the host template (see [2.11 Templates](../Text/ch02s11.html
    "2.11 Templates"), page 75) the value is now globally specified as the standard
    port (in the example shown here, 1248):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'For hosts that have already been converted to the new port, you overwrite the
    **`_NSCLIENT_PORT`** variable with the new port:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'For all other hosts, the value defined in the template applies. The definition
    of the command object takes into account the desired port by evaluating the variable,
    as shown here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: This means that for each newly converted host, only the variable needs to be
    set in this way, and all the service definitions remain unchanged.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[231](#CHP-20-FN-4)]) [http://www.nagiosexchange.org/49;65](http://www.nagiosexchange.org/49;65)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[232](#CHP-20-FN-5)]) [http://www.nagiosexchange.org/49;508](http://www.nagiosexchange.org/49;508)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[233](#CHP-20-FN-6)]) [http://www.shatterit.com/NC_Net](http://www.shatterit.com/NC_Net)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[234](#CHP-20-FN-7)]) [http://sourceforge.net/projects/nc-net](http://sourceforge.net/projects/nc-net)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[235](#CHP-20-FN-8)]) [http://trac.nakednuns.org/nscp/](http://trac.nakednuns.org/nscp/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[236](#CHP-20-FN-9)]) [http://trac.nakednuns.org/nscp/downloads](http://trac.nakednuns.org/nscp/downloads)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[237](#CHP-20-FN-10)]) [http://sourceforge.net/projects/nscplus/](http://sourceforge.net/projects/nscplus/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[238](#CHP-20-FN-11)]) The algorithm used is not documented, hence the utility
    should be treated with mistrust.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[239](#CHP-20-FN-12)]) The **`MEMUSE`** command (see [Main memory usage](../Text/ch20s03.html#main_memory_usage
    "Main memory usage")) thus requires the module **`CheckSystem.dll`**.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[240](#CHP-20-FN-13)]) [http://trac.nakednuns.org/nscp/wiki/Documentation](http://trac.nakednuns.org/nscp/wiki/Documentation)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[241](#CHP-20-FN-14)]) [http://www.opservices.com.br/](http://www.opservices.com.br/)
  prefs: []
  type: TYPE_NORMAL
- en: 20.3 The **`check_nt`** Plugin
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: When installing the standard Nagios plugins, the **`check_nt`** plugin is automatically
    loaded to the hard drive. The checks that can be queried here correspond to the
    function range of NSClient provided in NSClient, NS-Client++, OpMon Agent, and
    NC_Net. To make use of the extensions of NC_Net, you must download the extended
    sourcecode (the file **`check_nt.c`**) from [http://www.shatterit.com/NC_Net](http://www.shatterit.com/NC_Net)
    and compile it yourself.
  prefs: []
  type: TYPE_NORMAL
- en: 'The actual effect that the **`check_nt`** parameters have, described below,
    depends on the command that is specified with the **`-v`** option:^([[242](#ftn.CHP-20-FN-15)]):'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** / **`--host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: IP address or host name of the host on which the NSClient/NC_Net is installed.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-v`** **``*`command`*``** / **`--variable=`****``*`command`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The command to be executed.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** / **`--port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This defines an alternative port for NSClient/NC_Net (see [20.2.5 Rectifying
    problems with port 1248](../Text/ch20s02.html#rectifying_problems_with_port "20.2.5
    Rectifying problems with port 1248") in page 471). The default is TCP port 1248.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`integer`*``** / **`--warning=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This defines a warning limit. This option is not available for all commands.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`integer`*``** / **`--critical=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The critical limit option is also not available for all commands.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-l`** **``*`parameter`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is used for passing parameters along, such as the drive for the hard drive
    check or the process name when checking processes.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`** **``*`option`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: When checking services or processes, you can specify several services or processes
    simultaneously. Normally **`check_nt`** then only shows the defective ones (**`-d
    SHOWFAIL`**). To have all of them displayed you must specify **`SHOWALL`** as
    the **``*`option`*``**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s`** **``*`password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: A password for authentication is only required if NC_Net or NSClient starts
    the corresponding service with the password parameter.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** / **`--timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds have elapsed, the plugin aborts the test and
    returns the CRITICAL state. The default is **`10`** seconds.
  prefs: []
  type: TYPE_NORMAL
- en: 20.3.1 Generally supported commands
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: For the commands introduced here, it makes no difference whether you use NSClient,
    NSClient++, NC_Net or OpMon; they can be run with the unpatched **`check_nt`**.
  prefs: []
  type: TYPE_NORMAL
- en: Querying the client version
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The version of the installed NSClient or NC_Net service is returned by running
    the command
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'All other arguments are ignored:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: The first edition of this book defined a separate command for each **`check_nt`**
    function. But this is not necessary at all, as Ethan Galstad has shown in the
    online documentation for Nagios:^([[243](#ftn.CHP-20-FN-16)])
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'For Nagios 3.0 with NSClient ports defined in a host-dependent fashion (see
    [20.2.5 Rectifying problems with port 1248](../Text/ch20s02.html#rectifying_problems_with_port
    "20.2.5 Rectifying problems with port 1248"), page 471), the command object **`check_nt`**
    would look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: 'The command line to be executed expects two arguments: The macro **`$ARG1$`**
    expands in each case into the command to be called, and the contents of **`$ARG2$`**
    are dependent on the respective command and may be empty in certain circumstances:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: The command **`CLIENTVERSION`** does not have any other arguments, so the second
    argument is simply left out.
  prefs: []
  type: TYPE_NORMAL
- en: 'This unassuming service is extremely useful in describing dependencies. If
    NSClient/NC_Net fails on the Windows server, Nagios normally informs the administrator
    of all services that may have failed. By querying **`CLIENT-VERSION`**, it becomes
    clear that the problem lies in the unavailability of NSClient. If you define appropriate
    dependencies, Nagios can provide more precise information.^([[244](#ftn.CHP-20-FN-17)])
    Here is an example for the NSClient application:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: With **`NSClient`** as a master service on which the other services are dependent,
    Nagios does not trouble the admins with messages from these other services, as
    long as **`NSClient`** is in a CRITICAL or UNKNOWN state.
  prefs: []
  type: TYPE_NORMAL
- en: 'In Nagios 2.x you must set dependency objects for each host individually. In
    Nagios 3.0 there are the *same host dependencies*: If you omit the entry **`dependent_host_name`**,
    the dependency defined here applies to the same host. This allows host groups
    to be used in a sensible manner:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: Here the **`Disks`** service in each case only depends on the **`NSClient`**
    service of the same host. When using host groups in Nagios 2.x, **`Disks`** would
    be dependent on all **`NSClient`** services on all hosts of the host group **`WINDOWS.SERVER`**—and
    this is normally not what is wanted.
  prefs: []
  type: TYPE_NORMAL
- en: CPU load
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'How heavy the load is on the processor is revealed by the command **`CPU-LOAD`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: 'It expects a triplet of parameters, separated by commas, consisting of the
    length of the time interval that is to be averaged, in minutes, and the two thresholds
    for the warning and critical limits in percent:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: So **`CPULOAD`**, with **`5,80,90`**, forms the average over five minutes and
    issues a warning if the value determined exceeds **`80`** percent. If there is
    over 90% CPU load, the command returns CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: 'The output here also contains additional performance data after the **`|`**
    sign, which Nagios ignores in the Web interface. If you are interested in average
    values over several intervals, you just add further triplet values following to
    the first one:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: 'In this example **`CPULOAD`** checks two intervals: the past five minutes and
    the past 15 minutes. In the second case there are deviating limit values. The
    plugin always returns the more critical value; for example, it returns CRITICAL
    if one interval issues CRITICAL and the other just a WARNING.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The service definition therefore looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: Main memory usage
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'When specifying the limit values, the command for monitoring the amount of
    main memory used—in contrast to **`CPULOAD`**—is based on the syntax of "normal"
    Nagios plugins:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: '**`MEMUSE`** returns the memory usage in percent. It should be remembered that
    Windows refers here to the sum of memory and swap files, that is, the entire available
    virtual memory. The command expects the warning and critical limits as percentages,
    given without a percent sign:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: 'On the example host, **`winsrv`**, only six percent of the virtual memory is
    used. The fact that the physical size of the main memory itself (here: 256 MB)
    is already exceeded is not shown in the output.'
  prefs: []
  type: TYPE_NORMAL
- en: 'It does not necessarily make sense, however, to request the memory usage as
    in Unix: Windows regularly swaps program and data code from the main memory, even
    when it still has spare reserves. In Unix, programs and data land in the swap
    partition only if more space is required than is currently free. In this respect
    the load of the entire virtual memory in Windows is the more important parameter.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The command mentioned above is again packed into a service object:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: Hard drive capacity
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The load on a file system is tested by **`USEDDISKSPACE:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: 'in Windows fashion, the file system is specified as drive letters, the limit
    values in percent:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: In the example, **`check_nt`** should issue a Warning if drive **`C`** is more
    than 70 percent full, and a CRITICAL if the load exceeds 80%. The current value
    lies at 52 percent, so **`check_nt`** therefore returns an OK, which you can check
    with **`echo $?`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'The corresponding service object would look something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  prefs: []
  type: TYPE_PRE
- en: Uptime
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: How long ago the last reboot was performed is revealed by the command **`UPTIME:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  prefs: []
  type: TYPE_PRE
- en: 'Defining a warning or critical limit is not possible, which is why such a query
    is only for information purposes (the plugin returns either OK, or UNKNOWN if
    it is used wrongly):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  prefs: []
  type: TYPE_PRE
- en: 'so the host **`winsrv`** has already been running for 17 days. A suitable definition
    of the corresponding service object looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  prefs: []
  type: TYPE_PRE
- en: Status of services
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The current status of Windows services can be checked with **`SERVICESTATE`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  prefs: []
  type: TYPE_PRE
- en: The optional **`-d SHOWALL`** ensures that the output text lists all services.
    If you leave this option out, the plugin provides information only on those services
    that are *not* running.
  prefs: []
  type: TYPE_NORMAL
- en: To find the name of the service description to be specified for NSClient after
    the **`-l`** option is quite a challenge. It is not the *display name* which is
    displayed by the services management (e.g., **`Routing and RAS`**), that is being
    sought, but the registry entry that corresponds to this. Accordingly you search
    with the Registry editor **`regedit`** in the partial tree **`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services`**
    for the node with the corresponding display name. It contains the service description
    being sought, which in the case of **`Routing and RAS`** is something like **`Remote-Access`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you use NC_Net, you have an easier task: the software accepts both the service
    description and the display name, in which no distinction is made between upper
    and lower case. The following two examples use the display name:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  prefs: []
  type: TYPE_PRE
- en: 'In the first case the service name was used; in the second case, the display
    name was used. The service first queried is not running, as the output **`Stopped`**
    shows, and **`check_nt`** returns **`2`** (CRITICAL) as the return value. The
    service addressed with the second command is working, which is why the plugin
    does not display it if the **`-d SHOWALL`** option is not given. The return value
    here is **`0`** (OK). Several services (separated by commas) can also be queried
    in a single query. The worst-case result here dictates the return value. A matching
    service object looks something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  prefs: []
  type: TYPE_PRE
- en: Status of processes
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'As with the services, **`PROCSTATE`** monitors running processes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  prefs: []
  type: TYPE_PRE
- en: 'The process name, which almost always ends in **`.exe`**, is best determined
    in the process list of the task manager; upper and lower case are also ignored
    here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  prefs: []
  type: TYPE_PRE
- en: 'As with the services, you can also specify a list of several processes, separated
    by commas. Without **`-d SHOWALL, PROCSTATE`** shows only those processes that
    are *not* running, in this example, **`notexist.exe`**. A corresponding service
    definition might look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  prefs: []
  type: TYPE_PRE
- en: Age of files
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'It is worth monitoring the time since the last modification of critical files
    with **`FILEAGE`**, particularly for log files and other files that change regularly:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  prefs: []
  type: TYPE_PRE
- en: '**`FILEAGE`** can be used to check the age of a file, for instance a log file
    to which data should be written regularly. The file name is specified with the
    full path, and backslashes must be written twice: **`C:\\xyz.log`**. If the thresholds,
    specified in minutes, are exceeded, the plugin issues a WARNING or a CRITICAL.
    However, it gives the age of the file, by default, in epoch seconds:^([[245](#ftn.CHP-20-FN-18)])'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  prefs: []
  type: TYPE_PRE
- en: 'The status can again be checked with **`echo $?`**. Here as well, the service
    definition does not hold any secrets:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  prefs: []
  type: TYPE_PRE
- en: Querying Windows counters and instances
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The duo of NSClient and **`check_nt`** provides two other functions: querying
    Windows counters with **`COUNTER`** and querying Windows performance counter objects
    with **`INSTANCES`**. Querying performance counters varies in small details from
    service to service, however (such as using a double backslash rather than a single
    backslash in the counter name). For this reason, we shall describe both in the
    discussion of the extended functions of NC_Net from page 481\. If you want to
    use counters with OpMon Agent, NSClient, or NSClient++, we recommend that you
    take a look at the original documentation of each service.'
  prefs: []
  type: TYPE_NORMAL
- en: When using NSClient++, it is recommended that you use the internal function
    **`CheckCounter`**, which is described in [Checking memory load with CheckMem](../Text/ch20s04.html#checking_memory_load_with_checkmem
    "Checking memory load with CheckMem").
  prefs: []
  type: TYPE_NORMAL
- en: 20.3.2 Advanced functions of NC_Net
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: NC_Net's range of functions is expanding constantly; this chapter describes
    the possibilities that go beyond NSClient for version 2.28\. These can only be
    used with the modified **`check_nt`** plugin. The extended version is based on
    the original **`check_nt`** version 1.4.1\. But it is possible that both plugins
    will continue to be developed in different ways, and thus diverge.
  prefs: []
  type: TYPE_NORMAL
- en: We will therefore rename the NC_Net version to **`check_ncnet`**, so that we
    can keep the two separate and run them at the same time. Thus, **`check_nt`**
    examples in this book demonstrate functions that are available for all NSClient-compatible
    services; if **`check_ncnet`** is used, the NC_Net functionality in combination
    with the extended plugin is available.
  prefs: []
  type: TYPE_NORMAL
- en: 20.3.3 Installing the **`check_ncnet`** plugin
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '**`check_ncnet`** exists only in the source code; it consists of a single file
    that unfortunately has the same name as the original plugin **`check_nt.c`**.
    The file ends up on the hard drive during the installation of NC_Net, but it can
    also be downloaded separately from [http://www.shatterit.com/nc_net](http://www.shatterit.com/nc_net).'
  prefs: []
  type: TYPE_NORMAL
- en: 'The source can currently be compiled without problems only in combination with
    the entire Nagios plugin package (see [1.4 Installing and Testing Plugins](../Text/ch01s04.html
    "1.4 Installing and Testing Plugins"), page 43). To do this, you overwrite the
    existing file **`check_nt.c`** in the subdirectory **`plugins`** with the extended
    version. To be on the safe side, the old **`check_nt`** binary should be renamed;
    then you run **`make check_nt`** to recompile the source file. Afterward, you
    copy the binary under the name **`check_ncnet`** to the **`libexec`** directory
    of Nagios, along with the other plugins:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  prefs: []
  type: TYPE_PRE
- en: Windows Performance Counter
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Through so-called Performance Counters, Windows provides values for everything
    in the system that can be expressed in numbers: hard drive usage, CPU usage, number
    of logins, number of terminal server sessions, the load on the network interface,
    and many more things. **`check_ncnet`** queries these with the command **`ENUMCOUNTER`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE46]'
  prefs: []
  type: TYPE_PRE
- en: 'If you omit the **`-l`** parameter, **`ENUMCOUNTER`** will display a list of
    all performance counter categories:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]'
  prefs: []
  type: TYPE_PRE
- en: 'Otherwise, it shows all counters in the category specified with **`-l`**. Several
    categories are separated with commas. The **`Terminal services`** category contains
    three counter objects in all:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  prefs: []
  type: TYPE_PRE
- en: The precise object name is important for later use, in which the **`%`** sign
    (as, for example, in **`% Processor Time`**) is part of the name. If the counter
    or category name contains spaces, you must remember to place it within quotation
    marks when formulating the the request.
  prefs: []
  type: TYPE_NORMAL
- en: The description stored in the Windows Performance Counter objects are shown,
    by the way, with the command **`ENUMCOUNTERDESC`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'Several counter categories contain instances, which you must specify when querying
    a counter object. For this reason you should always check first, using the **`INSTANCES`**
    function, whether the category you want works with instances:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  prefs: []
  type: TYPE_PRE
- en: 'For the terminal services, this is not the case:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  prefs: []
  type: TYPE_PRE
- en: 'Typical categories with instances are **`Processor or Process`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  prefs: []
  type: TYPE_PRE
- en: 'Here it becomes apparent what is meant by instances: Windows views every running
    process as an instance in the **`Process`** Performance Counter category. As can
    be seen in [20.3.3 Installing the check_ncnet plugin](../Text/ch20s03.html#installing_the_check_underscore_nc
    "20.3.3 Installing the check_ncnet plugin"), the counter object (**`% Processor
    Time`**), which contains the percentage use of processor time), is in this category.
    It can be queried only for individual instances, such as for the **`explorer`**
    process, or for all processes together. In case of the latter you specify **`_Total`**
    instead of an instance.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In order to access a Windows Performance Counter, therefore, you always need
    to give the following details:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE52]'
  prefs: []
  type: TYPE_PRE
- en: 'The instance is specified only if the category has instances available. There
    must be no space between the category name and the first bracket. The corresponding
    query command is called **`COUNTER`**; the placeholder **``*`name`*``** is replaced
    by the combination just described:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE53]'
  prefs: []
  type: TYPE_PRE
- en: 'This function asks after the Windows Performance Counter object that is specified
    after the **`-l`** option with its exact name. The warning and critical limits
    given as integer values refer to the size measured: if an object is involved that
    has a percentage figure (e.g., the processor load), just imagine a percent sign
    added to it; the numbers of processes, sessions, etc., are just values that are
    not specified in units.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The number of active sessions is checked with the **`Active Sessions`** object,
    for which there are no instances:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE54]'
  prefs: []
  type: TYPE_PRE
- en: Because the **`Idle`** instance always looks at the difference between used
    and spare processor load, so that the sum of the two is always 100 percent, querying
    the **`_Total`** pseudo-instance in the second example does not make much sense.
  prefs: []
  type: TYPE_NORMAL
- en: 'Normally **`COUNTER`** does not format its output. This can be changed by following
    the object name with a description in the **`printf`** format,^([[246](#ftn.CHP-20-FN-19)])
    separated from it with a comma:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE55]'
  prefs: []
  type: TYPE_PRE
- en: 'Not only does this cause the output to be clearer, it also returns additional
    performance data. A corresponding service definition might look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE56]'
  prefs: []
  type: TYPE_PRE
- en: Listing processes and services
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: To find out the names of processes, you can work your way through the Task Manager—or
    have a list of all running processes displayed with **`ENUMPROCESS:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE57]'
  prefs: []
  type: TYPE_PRE
- en: 'The equivalent command for listing all installed services is **`ENUMSERVICE`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE58]'
  prefs: []
  type: TYPE_PRE
- en: 'The optional **`−1`** restricts the output to specific categories (see [Table 20-1](../Text/ch20s03.html#limiting_option_for_enumservice
    "Table 20-1. Limiting option for ENUMSERVICE")):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE59]'
  prefs: []
  type: TYPE_PRE
- en: With the **`short`** option, **`ENUMSERVICE`** displays the service names as
    they are entered in the registry; if you leave out the keyword, it shows the display
    names.
  prefs: []
  type: TYPE_NORMAL
- en: Table 20-1. Limiting option for `ENUMSERVICE`
  prefs: []
  type: TYPE_NORMAL
- en: '| Type | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| **`all`** | all services |'
  prefs: []
  type: TYPE_TB
- en: '| **`running`** | all currently active services |'
  prefs: []
  type: TYPE_TB
- en: '| **`stopped`** | all services which have been stopped |'
  prefs: []
  type: TYPE_TB
- en: '| **`automatic`** | services starting automatically |'
  prefs: []
  type: TYPE_TB
- en: '| **`manual`** | services which must be started manually |'
  prefs: []
  type: TYPE_TB
- en: '| **`disabled`** | disabled services |'
  prefs: []
  type: TYPE_TB
- en: Querying the Windows event log
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'With the **`EVENTLOG`** command, the Windows Event Log can be queried:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE60]'
  prefs: []
  type: TYPE_PRE
- en: Using it does take some getting used to, however:^([[247](#ftn.CHP-20-FN-20)])
    the first three parameters to follow **`-l`** select the events to be taken into
    account by type and by time.
  prefs: []
  type: TYPE_NORMAL
- en: The placeholder **``*`eventlog`*``** is replaced with one of the three log areas
    **`application, security`**, and **`system`** that you want to look at. If **`EVENTLOG`**
    is to include all three, you just specify **`any`**; but you cannot choose only
    two of the three areas.
  prefs: []
  type: TYPE_NORMAL
- en: For the **``*`event type`*``** you can choose from **`error, Warning, Information`**,
    or **`any`** for all three.
  prefs: []
  type: TYPE_NORMAL
- en: 'In place of **``*`interval`*``** you specify a time interval in minutes: **`5`**
    limits the selection to events which occurred in the last five minutes, for example;
    **`1440`** stands for a whole day.'
  prefs: []
  type: TYPE_NORMAL
- en: The last three parameters in effect work as filters with which specific results
    can be determined from the preselection that all originate from a particular source
    (the **``*`source_filter`*``** placeholder), that contain a specific pattern in
    their descriptions (**``*`description_filter`*``**), or that have a specific event
    ID (**``*`id_filter`*``**).
  prefs: []
  type: TYPE_NORMAL
- en: 'Each of these filters consists of two parts: in the first an integer reveals
    how many search patterns are to follow (formulated as regular expressions in accordance
    with the .NET-**`Regexp`** class), and then the actual filter entries are specified,
    separated by commas. If one of the filters is not used, its placeholder is replaced
    with a **`0`**, which searches for exactly zero search patterns. A source filter
    which only looks for **`NC_Net`** events would be called **`1,NC_Net`**; if you
    want to search for **`NC_Net`** and **`Perflib`** events, it would be called **`2,NC_Net,Perflib`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-l any, any,5,0,0,0`** evaluates all entries from all event ranges from
    the last five minutes. **`-l application,error,1440,0,0,0`** determines all events
    of the type **`error`**, which occurred in the event range **`application`** within
    the last 24 hours. With **`−1 application, error, 60,1,NC_Net,0,0`**, the time
    window is set to 60 minutes and filters the event source using the string **`NC_Net`**.
    Finally **`-l application,any,60,0,2, start, stop,0`** searches the event description
    for two keywords: **`start`** and **`stop`**.'
  prefs: []
  type: TYPE_NORMAL
- en: With the warning and critical limits you can specify how many matching entries
    are needed before the plugin returns a WARNING or CRITICAL value. If you leaveout
    these two parameters, Nagios shows OK as long as *no* events occurred; otherwise,
    it shows CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example asks how many messages there were within the last 24
    hours in the **`applications`** area:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE61]'
  prefs: []
  type: TYPE_PRE
- en: 'The service we defined below searches for errors in all classes in the **`System`**
    area which occurred in the past five minutes. (When specifying the time period
    you should generally ensure that it correlates with the time period in **`normal_check_interval`**.)
    The service examines the descriptions of the entries found for the text **`data
    loss`**. The source and ID filters are not used here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE62]'
  prefs: []
  type: TYPE_PRE
- en: 'Log files have the characteristic of pointing out a problem only once under
    certain circumstances, even if the problem continues. You must therefore ensure
    that Nagios immediately makes a notification the first time the event occurs,
    and leaves out repeated tests and soft states. This can be achieved with **`max_check_attempts
    1`**: this immediately sets off a hard state, and notification is given right
    away.'
  prefs: []
  type: TYPE_NORMAL
- en: 'But if the hard state remains, this would mean in practice that new errors
    might occur in the meantime (the next test after five minutes no longer records
    the old states), while the state has not changed; the admin would only be informed
    again after the **`notification_interval`** has expired. For such cases, Nagios
    has available the **`is_volatile`** parameter (see [14.5.2 Nagios configuration:
    volatile services](../Text/ch14s05.html#nagios_configuration_colon_volatile_se
    "14.5.2 Nagios configuration: volatile services"), page 309), with which the system
    provides notification on every single error.'
  prefs: []
  type: TYPE_NORMAL
- en: Displaying and manipulating the NC_Net configuration
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The **`ENUMCONFIG`** function displays the current settings of NC_Net in a
    readable form:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE63]'
  prefs: []
  type: TYPE_PRE
- en: '**`Date`** shows the current query date, **`Version`** the NC_Net version used.
    **`NC_Net Config Path`** describes the path to the configuration directory, **`Startup
    Config`** the configuration file used. **`Debug Log`** specifies the log file
    containing the debugging output, but only if the **`MYDEBUG true`** parameter
    is set in the configuration file. **`Port`** reveals the port on which NC_Net
    is listening, and **`Pass`** shows whether a password has been used for the connection
    (**`None:`** no password).'
  prefs: []
  type: TYPE_NORMAL
- en: 'There is also the command **`CONFIG`** to manipulate the configuration of the
    NC_Net installation over the network. For reasons of security you should use this
    for test purposes only, and otherwise keep the function switched off. Accordingly
    you should keep the following default set in the configuration file**`startup.cfg`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE64]'
  prefs: []
  type: TYPE_PRE
- en: This means that the configuration cannot be changed from the outside.
  prefs: []
  type: TYPE_NORMAL
- en: Other functions
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'NC_Net''s range of functions is growing all the time, and to describe all the
    functions in detail would need a separate book. We''ll just mention a few quite
    useful commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`FREEDISKSPACE`**'
  prefs: []
  type: TYPE_NORMAL
- en: The equivalent of **`USEDDISKSPACE`** ([Main memory usage](../Text/ch20s03.html#main_memory_usage
    "Main memory usage")) expects the free hard drive capacity (instead of the used
    space) in percent for warning and critical limits
  prefs: []
  type: TYPE_NORMAL
- en: '**`WMIQUERY`**'
  prefs: []
  type: TYPE_NORMAL
- en: This function enables the SQL-capable WMI^([[248](#ftn.CHP-20-FN-21)]) database
    to be queried, which contains the .NET configuration data.
  prefs: []
  type: TYPE_NORMAL
- en: '**`WMICOUNTER`**'
  prefs: []
  type: TYPE_NORMAL
- en: Objects comparable to the Windows performance counters also exist in the WMI
    area (only .NET); they can be queried with this.
  prefs: []
  type: TYPE_NORMAL
- en: '**Passive Checks**'
  prefs: []
  type: TYPE_NORMAL
- en: From version 2.0, NC_Net also supports passive checks based on the NSCA mechanism
    (see [Chapter 14](../Text/ch14.html "Chapter 14. The Nagios Service Check Acceptor
    (NSCA)"), page 299). A short documentation can be found in the included **`passive.cfg`**
    file.
  prefs: []
  type: TYPE_NORMAL
- en: More information can be found in the file **`readme.html`**, included in the
    installation, but it can also be viewed directly at [http://www.shatterit.com/nc_net/files/readme.html](http://www.shatterit.com/nc_net/files/readme.html).
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[242](#CHP-20-FN-15)]) You can read about them in more detail in [20.3 The
    check_nt Plugin](../Text/ch20s03.html "20.3 The check_nt Plugin").
  prefs: []
  type: TYPE_NORMAL
- en: ^([[243](#CHP-20-FN-16)]) [http://nagios.sourceforge.net/docs/3_0/monitoring-windows.html](http://nagios.sourceforge.net/docs/3_0/monitoring-windows.html)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[244](#CHP-20-FN-17)]) This problem is similar to one with NRPE, which was
    solved through the definition of dependencies (see [12.6 Accounting for Dependencies
    between Hosts and Services](../Text/ch12s06.html "12.6 Accounting for Dependencies
    between Hosts and Services"), page 285).
  prefs: []
  type: TYPE_NORMAL
- en: ^([[245](#CHP-20-FN-18)]) That is, in seconds elapsed since 01.01.1970.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[246](#CHP-20-FN-19)]) **`man 3 printf`**
  prefs: []
  type: TYPE_NORMAL
- en: ^([[247](#CHP-20-FN-20)]) According to his own comments, author Tony Montibello
    wanted to change the syntax for defining services in version 2.25\. But up to
    and including version 2.28, this resolution has not yet been implemented.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[248](#CHP-20-FN-21)]) Short for *Windows Management Instrumentation*.
  prefs: []
  type: TYPE_NORMAL
- en: 20.4 NRPE for Windows
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Besides NRPE_NT (an NRPE daemon ported to Windows), NSClient++ and now also
    OpMon Agent provide NRPE services. Its task is to execute plugins on the target
    system if a particular test is only possible locally and no suitable network protocol
    exists to query the resource concerned. As with the Unix version (see [Chapter 10](../Text/ch10.html
    "Chapter 10. The Nagios Remote Plugin Executor (NRPE)") in page 213), the desired
    plugins must be installed locally on the target system, apart from the daemon
    (in this case: NRPE_NT) and the tests must be entered in a local configuration
    file.'
  prefs: []
  type: TYPE_NORMAL
- en: 'NRPE can also be used for other purposes: once installed on the Windows server,
    you can use the mechanism to run other scripts remotely, apart from Nagios plugins.
    If you want Nagios to restart a service remotely through the Eventhandler, this
    can be done just as easily with NRPE_NT.^([[249](#ftn.CHP-20-FN-22)])'
  prefs: []
  type: TYPE_NORMAL
- en: 20.4.1 NRPE_NT, the classic tool
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: NRPE_NT can be used like the Nagios Remote Plugin Executor, introduced in [Chapter 10](../Text/ch10.html
    "Chapter 10. The Nagios Remote Plugin Executor (NRPE)")—in reality, this is just
    the Windows version of the same tool. At the present time, however, it doesn't
    look as if this tool will continue to be actively developed.
  prefs: []
  type: TYPE_NORMAL
- en: 'The current zip archive from The Nagios Exchange,^([[250](#ftn.CHP-20-FN-23)])
    SourceForge^([[251](#ftn.CHP-20-FN-24)]) or [http://www.miwi-dv.com/nrpert](http://www.miwi-dv.com/nrpert)
    is unpacked to a suitable directory, such as **`D:\Programs\Nagios\nrpe_nt`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE65]'
  prefs: []
  type: TYPE_PRE
- en: It contains a subdirectory **`bin`**, in which are found the daemon **`NRPE_NT.exe`**,
    two DLLs for using SSL (**`libeay32.dll`** and **`ssleay32.dll`**), an example
    of a simple plugin script (**`test.cmd`**), and the configuration file **`nrpe.cfg`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'The service is installed from this directory with the command **`nrpe_nt -i`**,
    after which it just needs to be started, either in the Windows services manager
    or from the command line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE66]'
  prefs: []
  type: TYPE_PRE
- en: 'The configuration file **`nrpe.cfg`** is only slightly different from the Unix
    version of NRPE 2.0 (see [10.3 NRPE Configuration on the Computer to Be Monitored](../Text/ch10s03.html
    "10.3 NRPE Configuration on the Computer to Be Monitored"), page 218): only the
    directive **`include_dir`** does not function in NRPE_NT.'
  prefs: []
  type: TYPE_NORMAL
- en: The file in Windows also has the classical Unix text format,^([[252](#ftn.CHP-20-FN-25)])
    so either you require a suitable editor (**`notepad.exe`** is not sufficient)
    or you must edit it in Linux and copy it afterwards to the test system.
  prefs: []
  type: TYPE_NORMAL
- en: 'Since there is no inet daemon in Windows, you must specify the port (standard:
    **`server_port=5666`**) and the hosts from which NRPE should be addressed (you
    should only enter the Nagios server here; for example: **`allowed_hosts=172.17.129.2`**)^([[253](#ftn.CHP-20-FN-26)])
    in **`nrpe.cfg`**. The parameters **`nrpe_user`** and **`nrpe_group`** have no
    meaning in Windows, and the other parameters correspond to those discussed in
    [10.3 NRPE Configuration on the Computer to Be Monitored](../Text/ch10s03.html
    "10.3 NRPE Configuration on the Computer to Be Monitored").'
  prefs: []
  type: TYPE_NORMAL
- en: 'In the definition of executable commands (here for the included test plugin)
    you must remember the Windows-typical syntax with hard drive letters and backslashes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE67]'
  prefs: []
  type: TYPE_PRE
- en: 'In this example the plugins are in a separate subdirectory called **`plugins`**.
    After changes to the configuration file you should always restart NRPE_NT:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE68]'
  prefs: []
  type: TYPE_PRE
- en: Function test
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Before putting NRPE_NT into service, you should check whether it is functioning
    correctly. To do this, run the plugin **`check_nt`** on the Nagios server as the
    user **`nagios`**, with just one host specification and no other parameters:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE69]'
  prefs: []
  type: TYPE_PRE
- en: 'If the service has been correctly installed and configured, it will reply with
    a version number. Another simple test is performed by the included **`test.cmd`**
    plugin. It provides a short text and ends with the return value **`1`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE70]'
  prefs: []
  type: TYPE_PRE
- en: 'The command to be executed (defined in the previous section) is passed to the
    plugin **`check_nt`** with the **`-c`** option:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE71]'
  prefs: []
  type: TYPE_PRE
- en: The return value, determined with **`echo $?`**, must be **`1`** in this case,
    since the script exits with an **`exit 1`**.
  prefs: []
  type: TYPE_NORMAL
- en: 20.4.2 Plugins for NRPE in Windows
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: A series of plugins can be found on the Internet that run in Windows and are
    suitable for use with NRPE. The first port of call is the subcategory **Check
    Plugins | Operating Systems | Windows NRPE** at the NagiosExchange.^([[254](#ftn.CHP-20-FN-27)])
    Some of these are programs that are based on the same source code as their Unix
    equivalents, which was just recompiled for Windows. However, the portings also
    include Perl scripts that require Perl to be installed—and in most cases the script
    language must be installed in Windows first.
  prefs: []
  type: TYPE_NORMAL
- en: The Cygwin plugins
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'In the **Check Plugins | Windows**^([[255](#ftn.CHP-20-FN-28)]) category, The
    Nagios Exchange includes the **`CygwinPlugins`** package for downloading. It consists
    of Nagios standard plugins, which have been compiled for Windows with the help
    of the Cygwin Tools.^([[256](#ftn.CHP-20-FN-29)]) The package is based on the
    somewhat older plugin version 1.3.1, but this is enough for most purposes. Apart
    from the executable plugins (**`*.exe`**) the package also contains all the necessary
    DLLs. It is therefore sufficient to unpack the zip archive into a directory:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE72]'
  prefs: []
  type: TYPE_PRE
- en: 'For the sake of simplicity just copy the contents of the directory that is
    created, **`NagPlug`**, to a separate plugin directory:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE73]'
  prefs: []
  type: TYPE_PRE
- en: The plugin functions in the same way as in Linux. [Table 20-2](../Text/ch20s04.html#cygwin_plugins_for_nrpe_underscore_nt
    "Table 20-2. Cygwin Plugins for NRPE_NT") refers to the corresponding sections
    in this book.
  prefs: []
  type: TYPE_NORMAL
- en: Table 20-2. Cygwin Plugins for NRPE_NT
  prefs: []
  type: TYPE_NORMAL
- en: '| Plugin | Page | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_dummy.exe`** | 188 | Test plugin |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_http.exe`** | 119 | Reachability of a Web site |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_smtp.exe`** | 113 | Testing a mail server |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_ssh.exe`** | 131 | SSH availability |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_tcp.exe`** | 132 | Generic plugin |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_time.exe`** | 178 | Clock time comparison of two hosts |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_udp.exe`** | 135 | Generic plugin |'
  prefs: []
  type: TYPE_TB
- en: '| **`negate.exe`** | 188 | Negates the return value of a plugin |'
  prefs: []
  type: TYPE_TB
- en: '| **`urlize.exe`** | 189 | Turns the plugin output in the Nagios Web interface
    into a link |'
  prefs: []
  type: TYPE_TB
- en: 'As in Unix, each of the corresponding command definitions in the configuration
    file **`nrpe.cfg`** must be written on a single line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE74]'
  prefs: []
  type: TYPE_PRE
- en: The first line checks whether a Web server is running on the HTTP standard port
    80 of the host [www.swobspace.de](http://www.swobspace.de). The second line tests
    whether an **`identd`** daemon (TCP port 113) is active on the host **`linux01`**.
  prefs: []
  type: TYPE_NORMAL
- en: In the event that version 1.3.1 of the plugins is too old, or if you are missing
    plugins, you can also compile the plugins yourself under Windows in the Cygwin
    environment if you have some basic knowledge of the development of C programs
    and how to handle Makefiles. However, not all recompiled plugins will function
    under Windows/Cygwin. For instance, **`check_icmp`** makes direct use of the network
    socket, whose construction in Windows is quite different from that of the Unix
    socket; thus, the plugin will not work in Windows unless changes are made to the
    code first. Notes on compiling under Cygwin, along with an already compiled binary
    archive of the plugin version 1.4.5, can be obtained at [http://www.psychoticwolf.net/blog/2007/07/nagios_plugins_for_windows.php](http://www.psychoticwolf.net/blog/2007/07/nagios_plugins_for_windows.php).
  prefs: []
  type: TYPE_NORMAL
- en: Perl plugins in Windows
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Unfortunately the Cygwin plugins do not contain a **`check_ping`** or **`check_icmp`**.
    You can use the Perl script **`check_ping.pl`** instead, which is available for
    download on The Nagios Exchange in the **`Networking`** category.^([[257](#ftn.CHP-20-FN-30)])
    It uses the Perl module **`Net::Ping`** for the network connection. In contrast
    to **`check_tcp`**, **`check_ping.pl`** sends several packets, so it can make
    a more precise assessment of response times and packet losses.
  prefs: []
  type: TYPE_NORMAL
- en: An up-to-date and simple to install Perl for Windows can be obtained from ActiveState.^([[258](#ftn.CHP-20-FN-31)])
    To download the *Active Perl Free Distribution*, no registration is required,
    even if the download procedure would suggest otherwise. Of the versions offered,
    you should use the latest Perl version (currently 5.8.7), and only fall back on
    the older version 5.6.1 if this should cause problems.
  prefs: []
  type: TYPE_NORMAL
- en: 'The plugin script itself contains a **`BEGIN`** statement, which you must comment
    out for use in Windows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE75]'
  prefs: []
  type: TYPE_PRE
- en: 'It sends a TCP echo request to port 7, alternatively you can also explicitly
    set a different port by adding the following line after the **`Net::Ping->new`**
    statement:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE76]'
  prefs: []
  type: TYPE_PRE
- en: 'This would cause a TCP ping to port 80 (HTTP). So that NRPE_NT can execute
    the script, you must explicitly start the Perl executable:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE77]'
  prefs: []
  type: TYPE_PRE
- en: The command has been line-wrapped for the printed version, but in the configuration
    file the whole command must be written on a single line. With the **`--host`**
    parameter you specify a host name which can be resolved or an IP address, **`--loss`**
    is followed by a pair of values for the warning and critical limits for packet
    loss in percent, separated by a comma, (so values between 0 and 100 are possible
    here). The **`--rta`** option also demands a threshold value pair as an argument,
    for the average response time in milliseconds. Since this is a Perl script, it
    does not matter if these are specified as integers or floating comma decimals.
  prefs: []
  type: TYPE_NORMAL
- en: 20.4.3 NRPE with NSClient++
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: NSClient++ contains its own NRPE service, so you don't need to install an additional
    NRPE service when using it. It is activated by loading the library **`NR.PEListener.dll`**
    in the **`[modules]`** section of the configuration file **`NSC.ini`** ([Configuration](../Text/ch20s02.html#configuration-id4
    "Configuration")). Configuration of the service is handled by the **`[NRPE]`**
    and **`[NRPE Handlers]`** sections. The first section contains the NRPE base configuration,
    and the second one defines the checks to be performed.
  prefs: []
  type: TYPE_NORMAL
- en: 'The default port in NRPE is port 5666, and the parameter **`allow_arguments`**,
    when set to **`1`**, allows arguments to be passed and corresponds to the NRPE
    parameter **`dont_blame_nrpe`** ([10.3 NRPE Configuration on the Computer to Be
    Monitored](../Text/ch10s03.html "10.3 NRPE Configuration on the Computer to Be
    Monitored")):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE78]'
  prefs: []
  type: TYPE_PRE
- en: '**`allow_nasty_meta_chars=1`** allows the use of special characters `|''&><''
    "\[]{}` in **`check_nrpe`** arguments. These are not allowed if the value **`0`**
    is entered here instead of **`1`**. **`use_ssl`** should only be switched off
    (that is, set to **`0`**) if **`check_nrpe`** cannot be compiled with SSL support.'
  prefs: []
  type: TYPE_NORMAL
- en: The **`bind_to_address`** und **`allowed_hosts`** parameters allow for NRPE
    settings that are different from the default. **`command_timeout`** interrupts
    an external command to be executed after the time specified (in seconds), but
    the timeout only has an effect on external commands. NRPE commands based on internal
    functions are unaffected by this. Finally, the **`performance_data`** parameter
    controls whether or not performance data should be returned. The default (value
    **`1`**) is to return it, and it is not returned with the value **`0`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the **`[NRPE Handlers]`** section, the actual commands are defined. You
    can use the same syntax used in NRPE or a short notation, in which the keyword
    **`command`** is omitted entirely:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE79]'
  prefs: []
  type: TYPE_PRE
- en: 'Along with the usual plugin calls that make use of external plugins, there
    is the command **`inject`**. This runs an internal function (which is described
    in [20.4.4 Internal NSClient++ functions](../Text/ch20s04.html#internal_nsclient_plus_plus_functions
    "20.4.4 Internal NSClient++ functions") from page 495):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE80]'
  prefs: []
  type: TYPE_PRE
- en: 'In this example, **`check_uptime`** calls the internal function **`CheckUpTime`**
    by means of **`inject`**. If passing arguments via NRPE is allowed, you can greatly
    simplify the definition of **`inject`** commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE81]'
  prefs: []
  type: TYPE_PRE
- en: 'Now you include the internal function, together with all required parameters,
    as an argument when calling **`check_nrpe`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE82]'
  prefs: []
  type: TYPE_PRE
- en: 'If you define the command object in Nagios just as generally, the exact formulation
    of the command will be shifted entirely to the service definition:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE83]'
  prefs: []
  type: TYPE_PRE
- en: There is a security issue that should be pointed out here, however. If you define
    **`check_inject=inject $ARG1$`** as described above, then you are opening a door
    to attackers who might be hoping for a buffer overflow in the code of NSClient++.
    In that event, the client will be able to run any command at all. You should therefore
    use this rather generous command only in secure environments, and even then you
    should restrict the hosts that are allowed to access NSClient++ via NRPE using
    **`allowed_hosts`**. On the other hand, such a free definition makes life much
    easier during the implementation phase, since you can try out all sorts of combinations
    and checks on the command line without having to adjust the configuration file
    **`NSC.ini`** to many hosts each time.
  prefs: []
  type: TYPE_NORMAL
- en: 20.4.4 Internal NSClient++ functions
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: NSClient++ provides a series of internal functions that can be called by the
    **`inject`** command via NRPE, and usually also with the plugin **`check_nt`**.
    These are stored in several loadable modules. [Table 20-3](../Text/ch20s04.html#internal_functions_of_the_nsclient_p
    "Table 20-3. Internal functions of the NSClient++ module") gives an overview of
    which module is required for a particular function.
  prefs: []
  type: TYPE_NORMAL
- en: Table 20-3. Internal functions of the NSClient++ module
  prefs: []
  type: TYPE_NORMAL
- en: '| Modules | Function |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| **`CheckDisk`** | **`CheckFileSize`**, **`CheckDriveSize`** |'
  prefs: []
  type: TYPE_TB
- en: '| CheckSystem | **`CheckCPU`**, **`CheckUpTime`**, **`CheckServiceState`**,
    **`CheckProcState`**, **`CheckMem`**, **`CheckCounter`** |'
  prefs: []
  type: TYPE_TB
- en: '| CheckEventLog | **`CheckEventLog`** |'
  prefs: []
  type: TYPE_TB
- en: '| CheckHelpers | **`CheckAlwaysOK`**, **`CheckAlwaysCRITICAL`**, **`CheckAlwaysWARNING`**,
    **`CheckMultiple`** |'
  prefs: []
  type: TYPE_TB
- en: To use one of these functions with **`check_nt`**, you only need to ensure that
    the required modules are loaded in the **`[modules]`** section. Calling via NRPE
    and **`inject`** provides additional configuration options, however.
  prefs: []
  type: TYPE_NORMAL
- en: 'Thus, for the hard disk load check with **`check_nt`**, which uses the function
    **`CheckDriveSize`** internally, you can just have a warning and a critical threshold
    displayed:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE84]'
  prefs: []
  type: TYPE_PRE
- en: If, on the other hand, you access **`CheckDriveSize`** directly, you may specify
    higher and lower thresholds, and instead of using a hard drive letter, you can
    use a UNC path (see [Checking file sizes with CheckFileSize](../Text/ch20s04.html#checking_file_sizes_with_checkfilesize
    "Checking file sizes with CheckFileSize")).
  prefs: []
  type: TYPE_NORMAL
- en: Many of the parameters listed below are optional, at least if you go by the
    documentation in the Wiki. This convention does not seem to have been uniformly
    adhered to, however. Performance data, for instance, is obtained only if you specify
    a warning and a critical threshold. You can also omit one or both thresholds and
    the call will still function; what is missing is the performance data. The **`ShowAll`**
    and **`nsclient`** parameters are optional, provided that the function allows
    this.
  prefs: []
  type: TYPE_NORMAL
- en: For all other functions, you should test to see whether your configuration really
    fulfills the desired purpose and whether NSClient++ works without an error message
    before you deploy it in a production environment.
  prefs: []
  type: TYPE_NORMAL
- en: Checking file sizes with **`CheckFileSize`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`CheckFileSize`** tests the size of individual files or directories:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE85]'
  prefs: []
  type: TYPE_PRE
- en: The last ones here are processed recursively. You can also test drives if you
    specify **`File=C:\*.*`**, for instance. The threshold parameters do require size
    values to be given, however. If you want to monitor how full a drive is in percent,
    you are better off using the command **`CheckDriveSize`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'When specifying the threshold size values you can include a suffix: **`B`**
    for bytes, **`K`** for **`KB`**, **`M`** for MB, and **`G`** for GB (e.g., **`MaxWarn=2198M`**).
    A number without a suffix specifies a size in bytes.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The syntax allows several files and/or directories to be given. In this case,
    the **`File`** parameter follows the associated thresholds:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE86]'
  prefs: []
  type: TYPE_PRE
- en: When monitoring directories, it is not sufficient to give just the directory
    names. Instead, as shown in the example for the directory **`E:\Exchsvr\mdbdata_log\`**,
    you need to specify with **`*.*`** that all the files and subdirectories (together
    with their contents) contained in the directory must be included in the calculation.
  prefs: []
  type: TYPE_NORMAL
- en: Of course, you can also use wildcards, for example, **`*.log`** to find out
    the total size of all files ending in **`.log`** in a directory. The thresholds
    always refer to the total of all files and directories specified in the corresponding
    **`File`** parameter.
  prefs: []
  type: TYPE_NORMAL
- en: If there are several consecutive **`File`** specifications, the last thresholds
    that were specified before them are used. **`ShowAll`** displays the statuses
    of all files or directories specified, and if this parameter is not given, the
    display contains only files and directories with an error state.
  prefs: []
  type: TYPE_NORMAL
- en: The display contains the full path of the file and directories tested, which
    can become very confusing. **`CheckFileSize`** therefore allows the optional use
    of aliases. Calling
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE87]'
  prefs: []
  type: TYPE_PRE
- en: 'will display just the alias **`TMP`** instead of the full path:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE88]'
  prefs: []
  type: TYPE_PRE
- en: Checking how full drives are with **`CheckDriveSize`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`CheckDriveSize`** checks how full drives are. The thresholds can be given
    very flexibly here: You can either use the **`*Free`** parameters to determine
    the remaining free drive space or the **`*Used`** parameters to establish the
    used drive space:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE89]'
  prefs: []
  type: TYPE_PRE
- en: 'When giving thresholds, you can again use sizes, or use the **`%`** suffix
    to obtain percentages. In contrast to **`CheckFileSize`**, the suffixes for size
    parameters must be written in lower case: **`b`** for bytes, **`k`** for KB, **`m`**
    for MB, and **`g`** for GB.'
  prefs: []
  type: TYPE_NORMAL
- en: 'For the placeholder **``*`disk`*``** you can use either the respective disk
    letter or the UNC path of a network share: for example, **`Drive=\\WinSRV\C$`**.
    If **`CheckAllOthers`** is specified, NSClient++ checks all hard disks that have
    not been individually specified. **`CheckAll`** deals with all drives, so the
    Drive parameter can be omitted. An additional filter allows only certain drive
    types to be considered: **`FilterType=FIXED`** restricts itself to all drives
    that are permanently installed, while **`FilterType=REMOVABLE`** just considers
    removable drives. The filter **`FilterType=CDROM`** describes CD-ROM drives, and
    **`FilterType=REMOTE`** looks at all network drives. It is possible to combine
    several filters:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE90]'
  prefs: []
  type: TYPE_PRE
- en: checks all permanently installed local drives and all connected network drives.
  prefs: []
  type: TYPE_NORMAL
- en: Checking CPU load with **`CheckCPU`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`CheckCPU`** checks the processor load in percent, and thresholds are given
    here without the percentage sign:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE91]'
  prefs: []
  type: TYPE_PRE
- en: The load is calculated over a period specified with the **`time`** parameter.
    If no suffix is given, the period is in seconds, otherwise the suffixes **`w`**
    for weeks, **`d`** for days, **`h`** for hours, **`m`** for minutes, and **`s`**
    for seconds are available. For longer periods, you must make sure that the parameter
    **`CpuBufferSize`** in the configuration file under **`[CheckSystem]`** has a
    sufficiently large value. The default period is one hour.
  prefs: []
  type: TYPE_NORMAL
- en: 'To display the CPU load over several different time intervals all at once,
    you can specify the **`time`** parameter multiple times:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE92]'
  prefs: []
  type: TYPE_PRE
- en: '**`ShowAll`** influences the display of the plugin output (but not of the performance
    data; these have been omitted below):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE93]'
  prefs: []
  type: TYPE_PRE
- en: The first line shows the output without **`ShowAll`**, the second line shows
    it with this parameter. Here **`CheckCPU`** displays the values for each time
    interval individually. The third line demonstrates the parameter **`ShowAll=long`**.
    This does not give you more information, just more text.
  prefs: []
  type: TYPE_NORMAL
- en: 'The remaining parameter is **`nsclient`**, which displays the output in the
    style of the original NSClient and separates the details for the time intervals
    with the **`&`** sign: **`2&2&2`**. Performance data is not displayed when using
    this parameter.'
  prefs: []
  type: TYPE_NORMAL
- en: Determining the uptime with **`CheckUpTime`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`CheckUpTime`** shows how much time has passed since the system was started.
    As with **`CheckCPU`**, the thresholds can be set using a suffix (**`s`**, **`m`**,
    **`h`**, **`d`**, **`w`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE94]'
  prefs: []
  type: TYPE_PRE
- en: '**`ShowAll`** also displays the time even when there is no error state. **`nsclient`**
    changes the output to a simple value in seconds, without any other text. With
    **`Alias`**, the word **`Uptime`** can be replaced with a different text:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE95]'
  prefs: []
  type: TYPE_PRE
- en: The first line shows a normal output with **`ShowAll`**; in the second line
    an additional **`Alias=Running_Time`** has been set.
  prefs: []
  type: TYPE_NORMAL
- en: Activity check with **`CheckServiceState`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`CheckServiceState`** checks whether services are active (**`started`**)
    or not (**`stopped`**). You can either check one or more individually listed services
    or use the **`CheckAll`** switch, which checks all services for which the autostart
    flag has been set and which should be running after every system start:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE96]'
  prefs: []
  type: TYPE_PRE
- en: 'Individual services can be explicitly checked for the desired state:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE97]'
  prefs: []
  type: TYPE_PRE
- en: This call checks whether the **`MSExchangeSA`** service is running and the **`MSSEARCH`**
    service is not. If the state of either of the two services is different from what
    is specified, CRITICAL is displayed. **`ShowFail`** ensures that only services
    with errors appear in the output.
  prefs: []
  type: TYPE_NORMAL
- en: '**`CheckAll`** normally includes all services with an autostart flag. Individual
    services can be excluded from this with **`exclude`**.'
  prefs: []
  type: TYPE_NORMAL
- en: Monitoring processes with **`CheckProcState`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`CheckProcState`** checks the state of processes, and it functions in the
    same way as **`CheckServiceState`**, except that here there are fewer options
    available:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE98]'
  prefs: []
  type: TYPE_PRE
- en: For single processes you can again specify the desired state (**``*`process`*``****`=started`**
    or **``*`process`*``****`=stopped`**); otherwise only **`ShowAll`** will be left
    to control the output. **`ShowFail`** is the default and can be omitted.
  prefs: []
  type: TYPE_NORMAL
- en: Checking memory load with **`CheckMem`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`CheckMem`** checks the load level of the memory. The **`type`** parameter
    is of interest here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE99]'
  prefs: []
  type: TYPE_PRE
- en: '**`type=page`** and **`type=paged`** show the entire memory (physical plus
    swap) and correspond to the value of **`check_nt -v MEMUSE`**. The difference
    between **`page`** and **`paged`** lies only in the routine used: The former uses
    the PDH library that is used by NSClient, and which originates from the days of
    Windows NT, whereas the latter uses the newer routines of Windows 2000 and Windows
    2003\. **`type=virtual`** refers to the swap memory used, and **`type=physical`**
    refers to the physical memory used.'
  prefs: []
  type: TYPE_NORMAL
- en: The output of **`CheckMem`** only provides details of the entire memory available
    if there is an error state; for the OK state, only what is actually used of the
    specified category is shown.
  prefs: []
  type: TYPE_NORMAL
- en: 'As with **`CheckFileSize`**, suffixes for thresholds are written in upper case
    for this function: **`B`**, **`K`**, **`M`**, and **`G`**. Specifying percentages
    with the suffix **`%`** is also allowed.'
  prefs: []
  type: TYPE_NORMAL
- en: Checking the performance counter with **`CheckCounter`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'With **`CheckCounter`** you can query Windows performance counters that record
    nearly all the parameters that Windows has to offer:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE100]'
  prefs: []
  type: TYPE_PRE
- en: With **`Averages=true`**, **`CheckCounter`** calculates averages for performance
    counters, which on their own do not provide averages. The value **`false`** switches
    this off, so that the query takes less time. The **`Averages`** parameter has
    no influence on performance counters that Windows already provides as an average.
  prefs: []
  type: TYPE_NORMAL
- en: 'The trick lies in finding the right performance counter. One starting point
    is the performance monitor itself, which is started in Windows via the **`perfmon`**
    program. If you insert a new performance counter in this for viewing, you will
    be shown all available objects (the performance counter categories) and performance
    indicators. All available counters are also shown by NSClient++ when it is run
    directly from the command line. Because of the large number of counters, it is
    best to redirect the output to a text file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE101]'
  prefs: []
  type: TYPE_PRE
- en: '**`CheckCounter`** takes as thresholds only whole numbers, since counters generally
    do not have units. This function allows an alias for the counter to be specified
    (see [Checking file sizes with CheckFileSize](../Text/ch20s04.html#checking_file_sizes_with_checkfilesize
    "Checking file sizes with CheckFileSize")):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE102]'
  prefs: []
  type: TYPE_PRE
- en: 'The quotation marks are important here. You must ensure that the parameter
    itself is within the quotation marks. If an alias is specified, NSClient++ replaces
    the performance counter in the output with the alias:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE103]'
  prefs: []
  type: TYPE_PRE
- en: Evaluating log entries with **`CheckEventLog`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`CheckEventLog`** searches through the event log for specific events and
    issues a WARNING or CRITICAL if the number of entries found exceeds the respective
    threshold. The function is very powerful and complex—and, regrettably, is not
    very easy to understand:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE104]'
  prefs: []
  type: TYPE_PRE
- en: 'The Windows event log has various log files: for applications themselves (**`file=Application`**),
    for security aspects (**`file=Security`**), and for system parameters (**`file=System`**).
    There are some additional ones for domain controllers. If you want to search for
    events in more than one log file, you just repeat the **`file`** parameter:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE105]'
  prefs: []
  type: TYPE_PRE
- en: The first **`filter`** parameter is used as a switch that is combined with filter
    expressions that are listed later on. **`filter=in`** includes all events that
    match the actual filter expression, **`filter=out`** excludes such events. **`filter=all`**
    demands that all filter expressions match the event (logical AND), but for **`filter=any`**,
    one single match (logical OR) is sufficient.
  prefs: []
  type: TYPE_NORMAL
- en: 'Writing the filter expression itself takes some getting used to: It starts
    with the keyword **`filter`**—an unfortunate choice, because the same keyword
    has already been used. This is followed by a mode: **`+`** or . ensure that the
    event is counted if the filter matches, whereas **`-`** excludes the event. For
    **`+`**, if the filter does not match, the event is excluded, even if **`filter=any`**
    is used and another filter expression demands that it be counted.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The mode is followed by the filter type. **`eventType`** describes whether
    an error or piece of information is involved (possible values for this are **`error`**,
    **`warning`**, **`info`**, **`auditSuccess`**, and **`auditFailure`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE106]'
  prefs: []
  type: TYPE_PRE
- en: This expression includes all events in which the event type matches **`warning`**.
    The plus sign ensures that this filter is taken into account whatever the case,
    even if **`filter=any`** has been set.
  prefs: []
  type: TYPE_NORMAL
- en: 'The **`eventSource`** filter type specifies the source of the event (for example
    **`Print`**, **`Netlogon`**, or **`Service Control Manager`**). The following
    example searches for all events for which the source contains the partial string
    **`KCC`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE107]'
  prefs: []
  type: TYPE_PRE
- en: 'The **`generated`** and **`written`** filter types refer to time details: **`generated`**
    stands for the time at which the event entry was generated, **`written`** for
    the time at which the event was written to the log file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE108]'
  prefs: []
  type: TYPE_PRE
- en: This expression excludes all events that are more than two days old.
  prefs: []
  type: TYPE_NORMAL
- en: 'The **`message`** filter type refers to the text for the event entry and allows
    filtering according to text content:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE109]'
  prefs: []
  type: TYPE_PRE
- en: Here a regular expression searches for events containing either the text **`hans`**
    or **`lisa`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'With the **`event ID`** filter type you can filter according to the event number:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE110]'
  prefs: []
  type: TYPE_PRE
- en: There is also the **`severity`** type, which is intended to filter according
    to the event priority. Since the author does not know of a suitable use for this,
    we will not look at it in any more detail.
  prefs: []
  type: TYPE_NORMAL
- en: 'It is not immediately clear when you need to write **`=`** for a filter expression
    and when **`==`** is needed. For expressions with purely text arguments (**`eventSource,
    message`**), a single equals sign is sufficient. For all other expressions which
    also allow a comparison, a relation symbol is part of the expression itself: **`=warning`**,
    **`=7031`**, **`>2d`** in the examples just mentioned. Together with the equals
    sign belonging to the filter type, this then looks like a double equals sign or
    a "greater than or equal to" sign—but this is not the case, there is no "greater
    than or equal to."'
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example searches in the **`System`** log file for crashes of
    the NSClient++ service:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE111]'
  prefs: []
  type: TYPE_PRE
- en: Because of **`filter=in filter=all`**, all filter expressions must match simultaneously.
    The event number being looked for is 7031, the event should not be older than
    one day, and it should contain the substring **`NSClientpp`** in the text. If
    this is found, the test returns a WARNING, and if two or more matching events
    are found, the return value is CRITICAL. The **`descriptions`** switch here ensures
    that not only the name of the source, but the entire text is displayed. In addition,
    there is the **`truncate`** parameter, which restricts the entire output that
    is returned to **`check_nrpe`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'When using **`CheckEventLog`**, the expression "practice makes perfect" applies.
    If you filter too unspecifically, so that **`CheckEventLog`** has to process too
    many event entries, strange side effects may occur. The message **`UNKNOWN: No
    handler for that command`** is sometimes shown, although the reason for this is
    actually a buffer overflow. In case of doubt, you should switch on debugging for
    NSClient++ (don''t forget to stop/start) and examine the log file, which is in
    the same directory as the executable program and the INI file, for relevant error
    entries. Further information on **`CheckEventLog`** is contained in the Wiki.^([[259](#ftn.CHP-20-FN-32)]).'
  prefs: []
  type: TYPE_NORMAL
- en: The debug functions **`CheckAlwaysOK`**, **`CheckAlwaysWARNING`**, and **`CheckAlwaysCRITICAL`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The functions **`CheckAlwaysOK`**, **`CheckAlwaysWARNING`**, and **`CheckAlwaysCRITICAL`**
    are used for debugging purposes and always return the same status. Their use is
    relatively simple: The chosen debugging function is simply inserted in front of
    a normally defined function, such as **`CheckFileSize`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE112]'
  prefs: []
  type: TYPE_PRE
- en: Summarizing several checks with **`CheckMultiple`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If several checks need to be summarized into one single check, **`Check-Multiple`**
    is used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE113]'
  prefs: []
  type: TYPE_PRE
- en: All individual checks are written one after another, each beginning with **`command=`**.
    Quotation marks in the style of **`command=""`** are not required. The highest
    error value that occurs in the individual checks is returned as the result.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[249](#CHP-20-FN-22)]) To execute scripts remotely on a Windows server, you
    can also use the Windows version of the Secure Shell, a topic that is too large
    to go into in this book.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[250](#CHP-20-FN-23)]) [http://www.nagiosexchange.org/77;139](http://www.nagiosexchange.org/77;139)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[251](#CHP-20-FN-24)]) [http://sourceforge.net/project/showfiles.php?group_id=83239](http://sourceforge.net/project/showfiles.php?group_id=83239)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[252](#CHP-20-FN-25)]) The line break in Unix consists of only a line feed
    character, whereas Windows text files have a line break consisting of the two
    characters carriage return and line feed.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[253](#CHP-20-FN-26)]) This security measure, however, is restricted to a
    simple comparison of IP addresses.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[254](#CHP-20-FN-27)]) [http://www.nagiosexchange.org/NRPE_Plugins.66.0.html](http://www.nagiosexchange.org/NRPE_Plugins.66.0.html)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[255](#CHP-20-FN-28)]) [http://www.nagiosexchange.org/49;63](http://www.nagiosexchange.org/49;63).
  prefs: []
  type: TYPE_NORMAL
- en: ^([[256](#CHP-20-FN-29)]) The Cygwin tools contain a large number of GNU tools,
    including a compiler, libraries, and shells—all for Windows. This means that many
    Unix programs can be ported to Windows directly. The necessary files normally
    require only the Cygwin DLL (**`cygwin1.dll`**).
  prefs: []
  type: TYPE_NORMAL
- en: ^([[257](#CHP-20-FN-30)]) [http://www.nagiosexchange.org/Networking.53.0.html](http://www.nagiosexchange.org/Networking.53.0.html)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[258](#CHP-20-FN-31)]) [http://www.activestate.com/store/languages/register.plex?id=ActivePerl](http://www.activestate.com/store/languages/register.plex?id=ActivePerl)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[259](#CHP-20-FN-32)]) [http://trac.nakednuns.org/nscp/wiki/CheckEventLog/CheckEventLog](http://trac.nakednuns.org/nscp/wiki/CheckEventLog/CheckEventLog)
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 21. Monitoring Room Temperature and Humidity
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: There are a number of sensors for monitoring room temperature and humidity.
    Most of them are integrated into the network as independent network devices, and
    are normally addressed via SNMP.
  prefs: []
  type: TYPE_NORMAL
- en: But you have to spend at least three hundred dollars on your first sensor. Searching
    for a cheaper and modular system, the author finally came across [http://www.pcmeasure.com/](http://www.pcmeasure.com/);
    it has met all his requirements until now.
  prefs: []
  type: TYPE_NORMAL
- en: The fact that this chapter is restricted to this sensor is not meant to detract
    from other systems, but is down to the fact that this topic alone would be enough
    for a separate book.
  prefs: []
  type: TYPE_NORMAL
- en: 21.1 Sensors and Software
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'A complete monitoring system for physical data normally consists of three components:
    a sensor (for temperature or humidity for example), an adapter to connect to the
    serial or parallel port of a PC, and software to query the sensor.^([[260](#ftn.CHP-21-FN-1)])'
  prefs: []
  type: TYPE_NORMAL
- en: There are adapters for the PCMeasure system in variations from one to four sensors,
    which can be operated simultaneously. For the power supply the adapters need an
    available USB interface; alternatively a separate "USB power supply" is available.
    Instead of the adapter solution, there is also an optionally available Ethernet
    box with four sensor connections, which is somewhat more expensive, that can be
    expanded to accept 12 sensors.
  prefs: []
  type: TYPE_NORMAL
- en: The measurement querying software PCMeasure is available for both Linux and
    Windows.^([[261](#ftn.CHP-21-FN-2)]) Some features are exclusive to the Windows
    version, which is why it is slightly more expensive. For use with Nagios, the
    Linux version is totally sufficient, since only the measurement values are transmitted
    over a simple network protocol.
  prefs: []
  type: TYPE_NORMAL
- en: 'The sensors themselves are interesting: as well as those for temperature and
    humidity (as well as combinations of the two) there is also a contact sensor,
    a smoke and water alarm, a movement detector, and voltage detectors. These are
    normally connected with a twisted-pair cable (RJ45 connector); according to the
    FAQ,^([[262](#ftn.CHP-21-FN-3)]) they can be used up to 100 meters from the adapter
    or Ethernet box, provided you have good cables, that is, throughout a building.'
  prefs: []
  type: TYPE_NORMAL
- en: 21.1.1 The **`PCMeasure`** software for Linux
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The tar archive **`pcmeasure.tar.gz`** with the Linux software is unpacked
    in its own directory, such as **`/usr/local/pcmeasure`**. The configuration file
    **`pcmeasure41in.ux.cfg`** is also installed here. The port entries in this file
    need to be adjusted so that only those ports are listed to which a sensor is actually
    connected:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE114]'
  prefs: []
  type: TYPE_PRE
- en: '**`com1`** stands for the first serial port; if you are using the first parallel
    port instead, the entry before the period is **`lpt1`**. The digit following the
    port refers to the adapter slot used by the sensor, so depending on how many adapters
    you have, this is a number from **`1`** to **`4`**. The = sign is followed by
    the sensor type: **`01`** stands for a temperature sensor, **`03`** for a humidity
    sensor. An additional humidity sensor on the second slot of the same adapter would
    then be addressed as **`coml.2=03`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The query program **`pcmeasure`** requires the configuration file to be specified
    as an argument:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE115]'
  prefs: []
  type: TYPE_PRE
- en: It runs as a daemon in the background and only ends if it is terminated with
    **`kill`**. In principle, any user can start it who has read permissions for the
    corresponding interface.
  prefs: []
  type: TYPE_NORMAL
- en: 21.1.2 The query protocol
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The software opens TCP port 4000 by default and accepts requests from the network.
    The protocol used is quite simple: you send a text in the format'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE116]'
  prefs: []
  type: TYPE_PRE
- en: (that is, with a DOS line ending) and you receive a response in the format
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE117]'
  prefs: []
  type: TYPE_PRE
- en: 'The *validity* placeholder is replaced by a **`1`** for a valid value or **`0`**
    for an invalid one. The port specification complies with the internal numbering
    system: **`lpt1.1`** corresponds to **`port1`**, **`com1.1`** to **`port13`**.
    Whether everything functions correctly or not can be tested with **`telnet`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE118]'
  prefs: []
  type: TYPE_PRE
- en: The current temperature in this example is 22.59°C, and the value is valid.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: '^([[260](#CHP-21-FN-1)]) The PCMeasure Web site showed the following prices
    as of February 2008: simple temperature sensor 30101, $36; serial single-port
    adapter 30201 $51; Linux software, $38 (Windows: $53).'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[261](#CHP-21-FN-2)]) The access data for the download comes with the invoice.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[262](#CHP-21-FN-3)]) [http://www.pcmeasure.com/faq.php](http://www.pcmeasure.com/faq.php)
  prefs: []
  type: TYPE_NORMAL
- en: 21.2 The Nagios Plugin check_pcmeasure2.pl
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The plugin **`check_pcmeasure2.pl`**^([[263](#ftn.CHP-21-FN-4)]) allows a single
    sensor to be queried across a network. In exceptional cases—when measuring air
    pressure, for example—one call may also query two sensors. The plugin replaces
    **`check_pcmeasure.pl`** and uses the Perl module **`Nagios::Plugin`** to correctly
    represent the thresholds (see [24.1.5 Specifying thresholds](../Text/ch24.html#specifying_thresholds
    "24.1.5 Specifying thresholds"), page 557). The older **`check_pc-measure.pl`**
    is still available under the same link, but is no longer maintained by the author.
  prefs: []
  type: TYPE_NORMAL
- en: 'Apart from the usual standard options, **`-h`** (online help), **`-t`** (timeout),
    **`-V`** (displays the version), and **`-v`** (*verbose*, additional information
    when looking for errors), **`check_pcmeasure2.pl`** has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** / **`--host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name or IP address of the measuring computer on which the software
    is running and to which the sensors are connected, or the IP address or host name
    of the Ethernet box.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-S`** **``*`sensor`*``** / **`--sensor=`****``*`sensor`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This switch defines the sensor, such as **`coml.1`** or **`lpt1.2`** (see above).
    When querying air pressure values, you need two sensors, which are separated by
    a comma when specified: **`--sensor=com1.1`**, **`com1.2`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** / **`--port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies an alternative TCP port for the software or for the Ethernet
    box. The default is port 4000.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`thresholds`*``** / **`--warning=`****``*`thresholds`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the measured value lies outside the warning range specified here (e.g., **`-w
    18.0:22.0`**, see [24.1.5 Specifying thresholds](../Text/ch24.html#specifying_thresholds
    "24.1.5 Specifying thresholds") from page 557), **`check_pc-measure2.pl`** sets
    off a warning.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`threshold`*``** / **`--critical=`****``*`threshold`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This defines the critical threshold; see **`-w`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-T`** **``*`sensor type`*``** / **`--type=`****``*`sensor type`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the sensor type for sensors with special requirements. Types
    currently implemented are **`brightness`**, **`barometer`** (this needs two sensors
    to be specified in **`--sensor`**), and **`standard`** (the default).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-R`** **``*`file`*``** / **`--rrd-database=`****``*`file`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This option specifies the round-robin database to save measured values independently
    of Nagios. The file must be writable for the user **`nagios`**. If this is missing,
    the plugin will create it again.
  prefs: []
  type: TYPE_NORMAL
- en: In order to work with a round-robin database (see [19.2 Graphs for the Web with
    Nagiosgraph](../Text/ch19s02.html "19.2 Graphs for the Web with Nagiosgraph"))
    you need the Perl module **`RRDs`** used by the plugin, from the RRDtools.^([[264](#ftn.CHP-21-FN-5)])
    The plugin automatically detects whether or not the module is available. If it
    is missing, it does not save the data separately.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example the plugin asks for the temperature of the sensor
    connected to the host with the IP address **`192.168.1.199`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE119]'
  prefs: []
  type: TYPE_PRE
- en: Since the measured value lies above the warning limit of 22.0°C, but below the
    critical limit of 24°C, there is a WARNING. The interval details correspond to
    those in the figure in [24.1.5 Specifying thresholds](../Text/ch24.html#specifying_thresholds
    "24.1.5 Specifying thresholds").
  prefs: []
  type: TYPE_NORMAL
- en: 'The corresponding Nagios command can be specified with or without a round-robin
    database:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE120]'
  prefs: []
  type: TYPE_PRE
- en: 'Without a RRD, you only need to specify the maximum and critical warning limits,
    apart from the sensor details. In the second example the RRD file predefined in
    **`$ARG4$`** saves the measured data. The following service uses the file **`/var/lib/rrd/temperatur-serverroom1.rrd`**
    for this purpose:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE121]'
  prefs: []
  type: TYPE_PRE
- en: With **`max_check_attempts`** set to **`1`**, Nagios does *not* repeat the query
    in case of an error at intervals of **`retry_check_interval`**. Instead the temperature
    is measured constantly every two minutes.
  prefs: []
  type: TYPE_NORMAL
- en: Since room temperatures normally change very slowly, you could use a **`normal_check_interval`**
    of five minutes. If you choose larger measuring intervals, you can set **`max_check_attempts`**
    to a value greater than **`1`** and repeat the measurement at shorter intervals
    in case of errors (e.g., **`retry_check_interval 1`**).
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[263](#CHP-21-FN-4)]) [http://www.nagiosexchange.org/60;575](http://www.nagiosexchange.org/60;575)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[264](#CHP-21-FN-5)]) [http://www.rrdtool.org/](http://www.rrdtool.org/)
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 22. Monitoring SAP Systems
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: There are several ways of monitoring an SAP system. The simplest is just to
    check the ports on which the corresponding SAP services are running. Normally
    these are TCP ports 3200/3300 for system number **`00`**, 3201/3301 for system
    number **`01`** etc. This can be done with the generic plugin described in [6.7.1
    Testing TCP ports](../Text/ch06s09.html#testing_tcp_ports "6.7.1 Testing TCP ports"),
    page 132\. But it is possible that no user is able to log in even though the port
    is reachable, because SAP-internal services fail, making it impossible to work
    with the system.
  prefs: []
  type: TYPE_NORMAL
- en: 'To really test the complex interaction of various SAP components, you require
    a program that communicates on an application layer with the SAP system. There
    are two alternatives here: the more simple one uses the program **`sapinfo`**,
    which queries the available information without a direct login—like the SAP-GUI
    at the start. With somewhat more effort you can communicate with the SAP system
    over an SAP standard interface. This is no use, however, unless you have an SAP
    login with corresponding permissions. With the *Computing Center Management System*
    (CCMS), SAP provides its own internal monitoring system, which can also be queried
    with the RFC^([[265](#ftn.CHP-22-FN-1)]) interface, and which can be put to excellent
    use in Nagios, with the right plugins.'
  prefs: []
  type: TYPE_NORMAL
- en: '22.1 Checking without a Login: sapinfo'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The program **`sapinfo`** is part of an optional software package for the development
    of client-side RFC interfaces. The Linux version which you require, **`RFC_0PT_46C.SAR`**,
    can be obtained either at [ftp://ftp.sap.com/pub/linuxlab/contrib/](ftp://ftp.sap.com/pub/linuxlab/contrib/),
    or you can log in to the *SAP Service Marketplace* at [http://service.sap.com/](http://service.sap.com/)
    (a password is required for this) and use the search help there to look for the
    keyword **`RFC-SDK`**. Information is also provided by the SAP notes 413708 (at
    present the current RFC library), 27517 (installation of the RFC SDK), and 212876
    (the new archiving tool SAPCAR).
  prefs: []
  type: TYPE_NORMAL
- en: 22.1.1 Installation
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'SAP has its own archiving format in which the precompiled software is stored.
    To unpack programs you require the program **`SAPCAR`**, which can also be obtained
    through the FTP link mentioned or through the SAP Service Marketplace. It is operated
    in a way similar to tar:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE122]'
  prefs: []
  type: TYPE_PRE
- en: The data contained in the archive lands in its own subdirectory, **`rfcsdk`**.
    If you run **`SAPCAR`** without any parameters, a short operating manual is displayed.
  prefs: []
  type: TYPE_NORMAL
- en: 22.1.2 First test
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The program **`sapinfo`** can be tested now without further configuration.
    To do this you require the so-called *connect string;* if the connection is running
    through an SAP gateway, this is a string such as **`/H/`****``*`ip_of_the_sap-gate-way`*``****`/S/3297/H/`****``*`ip_of_the_sap_system`*``**;
    without a gateway you simply specify an IP address or a host name that can be
    resolved, instead of this complex expression. In case of doubt, the administrator
    responsible for the SAP system will reveal the exact connect string. In addition
    you must specify the system number,^([[266](#ftn.CHP-22-FN-2)]) in this example,
    **`01`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE123]'
  prefs: []
  type: TYPE_PRE
- en: The output provides various information on the SAP installation, including the
    SAP release (**`620`**), the SAP system ID (**`P10`**), the host on which the
    database is located, and the database system used, which in this case is Oracle.
  prefs: []
  type: TYPE_NORMAL
- en: 'With the **`ashost`** parameter you query a specific application server. For
    a message server, **`sapinfo`** requires the following details:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE124]'
  prefs: []
  type: TYPE_PRE
- en: The **`r3name`** parameter specifies the SAP system ID, **`mshost`** defines
    the IP address of the server, and **`group`** describes the logon group. As long
    as the **`PUBLIC`** group exists, you can leave this parameter out, and then the
    default, **`PUBLIC`**, will be used.
  prefs: []
  type: TYPE_NORMAL
- en: If the query ends with an error message such as
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE125]'
  prefs: []
  type: TYPE_PRE
- en: 'then the definition of the **`sapmsP10`** service is missing for the Nagios
    server^([[267](#ftn.CHP-22-FN-3)]) in **`/etc/services`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE126]'
  prefs: []
  type: TYPE_PRE
- en: For the port you define the TCP port on which the message server is running.
    Which one this is depends on the particular SAP installation; the standard port
    is **`3600`**.
  prefs: []
  type: TYPE_NORMAL
- en: 22.1.3 The plugin **`check_sap.sh`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The plugin **`check_sap.sh`**, a shell script based on **`sapinfo`**, is included
    in the standard Nagios Plugins package, but it is in the **`contrib`** directory
    and is not automatically installed. You can copy it manually to the plugin directory:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE127]'
  prefs: []
  type: TYPE_PRE
- en: 'Then you look in the plugin for the variable **`sapinfocmd`** and adjust the
    path for **`sapinfo`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE128]'
  prefs: []
  type: TYPE_PRE
- en: 'If the plugin **`sapinfo`** is not found at the location given here, **`check_sap.sh`**
    will write an error message to STDERR, but if no error occurrs, you will receive
    an OK message on STDOUT and the return value **`0`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE129]'
  prefs: []
  type: TYPE_PRE
- en: 'Like **`sapinfo`**, the plugin can be run in two ways: with the argument **`as`**
    it queries an application server, and with **`ms`**, a message server. The second
    argument in each case is the connect string, and if no SAP gateway is used, then
    it is the IP address or the host name of the host to be queried:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE130]'
  prefs: []
  type: TYPE_PRE
- en: 'The first variation demands the two-digit system number of the application
    server as the third parameter, the counting of which starts at **`00`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE131]'
  prefs: []
  type: TYPE_PRE
- en: This means that the application server running on the host **`10.128.254.13`**
    is available.
  prefs: []
  type: TYPE_NORMAL
- en: When the message server is queried, the plugin displays the application server
    belonging to the specified login group (given as the fourth argument). If this
    information is missing, it determines the application server for the **`PUBLIC`**
    group.
  prefs: []
  type: TYPE_NORMAL
- en: 'For a message server, you specify the SAP system ID (*SID*), for example, **`P10`**,^([[268](#ftn.CHP-22-FN-4)])
    instead of the system number:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE132]'
  prefs: []
  type: TYPE_PRE
- en: In this example the message server running on **`10.128.254.12`** detects **`p10ap014_P10_02`**
    as the application server for the logon group **`ISH`** and also reveals that
    this is reachable.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following two command definitions assume that it is sufficient to use the
    IP address, and that no SAP connect string is required:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE133]'
  prefs: []
  type: TYPE_PRE
- en: 'If this is not the case, the **`command_line`** for querying an application
    server could look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE134]'
  prefs: []
  type: TYPE_PRE
- en: 'The following service definition can be used for all application servers:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE135]'
  prefs: []
  type: TYPE_PRE
- en: 'Since there is only a single message server in an SAP system, it makes more
    sense to define a separate service for each logon group. The following example
    shows this for the group **`ISH`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE136]'
  prefs: []
  type: TYPE_PRE
- en: In this way you can test whether a user may log in without actually logging
    in. If there are interruptions between the database and the application server
    that make it impossible to log in, **`sapinfo`** provides a corresponding error
    message after a timeout. The author was able to observe several times that **`sapinfo`**
    and **`check_sap.sh`** reported an error in such a situation, while the TCP port-only
    test of the application server, **`check_tcp`**, returned an OK, although no user
    could log in any longer. So **`check_sap.sh`**, even without a login, provides
    more reliable information than a port-only check.
  prefs: []
  type: TYPE_NORMAL
- en: '22.1.4 More up to date and written in Perl: **`check_sap.pl`**'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '**`check_sap.sh`** is not only getting on in years, it is apparently also no
    longer maintained, so once in a blue moon you just have to put up with the fact
    that it returns an OK, even when there is an error. The author of this book has
    therefore written his own version of the plugin in Perl and made this available
    on NagiosExchange.^([[269](#ftn.CHP-22-FN-5)]) As befits a reputable Perl plugin,
    it uses the Perl module **`Nagios::Plugin`** (more on this in [24.2 The Perl Module
    Nagios::Plugin](../Text/ch24s02.html "24.2 The Perl Module Nagios::Plugin") from
    page 560), parses the command line with **`Getopt::Long`** ([25.1 Splitting up
    the Command Line With Getopt::Long](../Text/ch25.html#splitting_up_the_command_line_with_getop
    "25.1 Splitting up the Command Line With Getopt::Long"), page 565), and includes
    integrated online help.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The plugin **`check_sap.pl`** also uses **`sapinfo`** ([22.1 Checking without
    a Login: sapinfo](../Text/ch22.html#checking_without_a_login_colon_sapinfo "22.1
    Checking without a Login: sapinfo")) and has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`--ashost=`****``*`connect_string`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Tests the application server. A connect string ([21.2 The Nagios Plugin check_pcmeasure2.pl](../Text/ch21s02.html
    "21.2 The Nagios Plugin check_pcmeasure2.pl")) must be specified, which in the
    simplest case is the IP address of the application server. The test needs an SAP
    system number to be given at the same time, with **`--sap-sysnr`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--mshost=`****``*`connect_string`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Tests the message server. A connect string is expected, as with **`--ashost`**,
    and you also need to specify at least the SAP-SID of the system (e.g., **`P10`**).
    The test uses a logon group, and the default is PUBLIC. If this is not available
    in the SAP system, you must specify the group in question with **`--group`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--sap-sysnr=`****``*`system_number`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Defines the system number for the test of an application server. Normally the
    system number begins counting upwards from 00 for the first application server.
    In case of doubt, you should ask your SAP administrator for the correct system
    number.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--sap-id=`****``*`sid`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Defines the SAP-SID for the overall system for the test of the message server.
    In case of doubt, you should also ask your SAP administrator about this parameter.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--group=`****``*`logon group`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Defines the logon group that is to be used for the test of the message server.
    This must exist in the SAP system, otherwise the message server test will fail.
    The default is **`PUBLIC`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--sapinfo=`****``*`path_to_sapinfo`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Specifies the path to the program **`sapinfo`**. The default is **`/usr/local/sap/rfcsdk/bin/sapinfo`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-h`** / **`--help`**'
  prefs: []
  type: TYPE_NORMAL
- en: Displays the online help.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-V`** / **`--version`**'
  prefs: []
  type: TYPE_NORMAL
- en: Shows the version and the license conditions of the plugin (GPLv2).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-v`** / **`--verbose`**'
  prefs: []
  type: TYPE_NORMAL
- en: Increases the verbosity of the plugin. This option can be given several times,
    to make the output increasingly extensive.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example tests an application server with the SAP system number
    **`00`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE137]'
  prefs: []
  type: TYPE_PRE
- en: 'To test the message server you require the SID instead of the system number
    and, in our case, a logon group as well, since the default logon group **`PUBLIC`**
    does not exist in the **`P10`** system:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE138]'
  prefs: []
  type: TYPE_PRE
- en: 'In contrast to the example given for **`check_sap.sh`**, the definition of
    the command is kept very general:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE139]'
  prefs: []
  type: TYPE_PRE
- en: 'Because of **`$ARG1$`**, a single command definition is sufficient for all
    checks, whether for application or message server, whether with or without an
    SAP connect string. The definition of the service for the test of an application
    server then looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE140]'
  prefs: []
  type: TYPE_PRE
- en: 'The service obtains the IP address of the host from the accompanying host definition
    via the **`$HOSTADDRESS$`** macro, so that the service definition works for an
    entire host group if you define the name of the host group with **`hostgroup_name`**
    instead of **`host_name`**. If an SAP connect string is required, you replace
    **`$HOSTADDRESS$`** with the connect string:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE141]'
  prefs: []
  type: TYPE_PRE
- en: 'In an SAP system there is just one message server, therefore the service check
    only makes sense for this one host. If there are several different logon groups,
    you define a separate service for each of these. The following example shows this
    for the group **`ISH`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE142]'
  prefs: []
  type: TYPE_PRE
- en: Here it is also possible to add a connect string that might be required.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[265](#CHP-22-FN-1)]) *Remote Function Call*.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[266](#CHP-22-FN-2)]) The SAP administrator will also know this.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[267](#CHP-22-FN-3)]) Instead of **`P10`**, the appropriate system ID will
    always be shown here.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[268](#CHP-22-FN-4)]) The first instance of this has the system number 00,
    the second one, 01, etc.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[269](#CHP-22-FN-5)]) [http://www.nagiosexchange.org/21;744](http://www.nagiosexchange.org/21;744)
  prefs: []
  type: TYPE_NORMAL
- en: 22.2 Monitoring with SAP's Own Monitoring System CCMS
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: With SAP's own *Computing Center Management System* framework (CCMS), not only
    SAP systems, but also external applications can be monitored. Here local agents
    collect data from each of the hosts, which, since Release R/3 4.6C,^([[270](#ftn.CHP-22-FN-6)])
    can be queried from a central component. The data examined includes not only SAP-specific
    features such as SAP buffers or batch jobs, but also operating system data such
    as memory and CPU usage, or disk IO and swapping. Even information on the database
    used or the average response times of applications can be queried.
  prefs: []
  type: TYPE_NORMAL
- en: The data of the CCMS can also be queried externally through RFC (*Remote Function
    Calls*, a standard SAP interface). Corresponding libraries for Unix and Windows
    platforms, with which a Linux program, for example, can query information from
    the CCMS over the network, are provided by SAP.
  prefs: []
  type: TYPE_NORMAL
- en: 22.2.1 A short overview over the alert monitor
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Within the SAP world you gain access to this data through the CCMS Alert Monitor
    (transaction RZ20) ([Figure 22-1](../Text/ch22s02.html#the_sap_ccms_alert_monitor
    "Figure 22-1. The SAP CCMS Alert Monitor")). The illustration shows so-called
    monitor connections that categorize various information in groups.
  prefs: []
  type: TYPE_NORMAL
- en: '![The SAP CCMS Alert Monitor](../Images/tagoreillycom20081104nostarchimages223998.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 22-1. The SAP CCMS Alert Monitor
  prefs: []
  type: TYPE_NORMAL
- en: SAP provides several monitor collections with preconfigured values in its distribution.
    A trained SAP administrator can create and operate monitors at any time. We shall
    restrict ourselves here to the monitor collection **`SAP CCMS Monitor Templates`**
    and focus on the **Dialog Overview** monitor ([Figure 22-2](../Text/ch22s02.html#the_sap_ccms_monitor_dialog_overview
    "Figure 22-2. The SAP CCMS monitor dialog Overview")).
  prefs: []
  type: TYPE_NORMAL
- en: The dialog response times specified there (accessible through the *monitor attribute*
    **`Dialog Response Time`**) provide a measurable equivalent for performance problems
    corresponding to what the user feels is a "slow system." This value specifies
    the average processing time of a transaction (without network transmission time
    and without the time needed to render the information in the GUI of the client).
  prefs: []
  type: TYPE_NORMAL
- en: '![The SAP CCMS monitor dialog Overview](../Images/tagoreillycom20081104nostarchimages224000.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 22-2. The SAP CCMS monitor dialog Overview
  prefs: []
  type: TYPE_NORMAL
- en: The monitor attribute **`Network Time`** reveals how much time the system needs
    to send data during a dialog stage from the client (the SAP GUI) to the SAP system
    and back again.
  prefs: []
  type: TYPE_NORMAL
- en: For each of the attributes, the monitor shows which context defined in the SAP
    system—normally which SAP instance—is involved in the measured values specified.
    Most measurement parameters have a warning and a critical limit. If the value
    lies beneath the warning limit, the monitor displays the line in green; for monochrome
    devices the color is listed as text. If the warning limit is exceeded, **`yellow`**
    is shown, and if the critical limit is exceeded, **`red`**. If an entry of a partial
    tree lies outside the green limit, the monitor also sets the overlying nodes to
    yellow or red, so that the administrator can see that something is not right,
    even when the menus are not open.
  prefs: []
  type: TYPE_NORMAL
- en: You do not normally need to worry about the thresholds. The settings configured
    by SAP are sensible and should only be changed if there is a sound reason to do
    so.
  prefs: []
  type: TYPE_NORMAL
- en: 'The Nagios plugins for the CCMS query described in [22.2.4 The CCMS plugins](../Text/ch22s02.html#the_ccms_plugins
    "22.2.4 The CCMS plugins") (page 525), return the status defined in the CCMS:
    OK if the traffic light is on green, WARNING for yellow, and CRITICAL for red.
    The thresholds are therefore set by the SAP system, and not by Nagios.'
  prefs: []
  type: TYPE_NORMAL
- en: If you want to find out more about CCMS, we refer you to the documentation at
    [http://service.sap.com/monitoring](http://service.sap.com/monitoring) (password
    required). There SAP provides detailed information on the installation and operation
    of CCMS. The SAP online help also has an extensive range of information available.
    If you just want a short summary of the subject and are more interested in the
    way the Nagios plugins work, you can find two informative PDF documents at [http://www.nagiosexchange.org/Misc.54.0.html](http://www.nagiosexchange.org/Misc.54.0.html)
    under the keyword **`SAP CCMS`**.
  prefs: []
  type: TYPE_NORMAL
- en: 22.2.2 Obtaining the necessary SAP usage permissions for Nagios^([[271](#ftn.CHP-22-FN-7)])
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Retrieving information from the CCMS is done through RFC *(Remote Function Calls)*,
    which requires a login on the SAP side. Luckily the user only needs a minimal
    set of permissions.
  prefs: []
  type: TYPE_NORMAL
- en: A new role is set up in the role generator (transaction PFCG) with a name that
    conforms to the company-internal conventions. It is not given any transaction
    assignment in the menu.
  prefs: []
  type: TYPE_NORMAL
- en: '![For access from Nagios you require these SAP authorization objects](../Images/tagoreillycom20081104nostarchimages224002.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 22-3. For access from Nagios you require these SAP authorization objects
  prefs: []
  type: TYPE_NORMAL
- en: 'When maintaining permissions, the following permission objects are added manually:
    **`S_RFC`**, **`S_XMI_LOG`**, and **`S_XMI_PROD`** (see also [Figure 22-3](../Text/ch22s02.html#for_access_from_nagios_you_require_thes
    "Figure 22-3. For access from Nagios you require these SAP authorization objects")).'
  prefs: []
  type: TYPE_NORMAL
- en: Whether these permissions are sufficient or not can be tested with the plu-gin
    **`check_sap_cons`** described in [22.2.4 The CCMS plugins](../Text/ch22s02.html#the_ccms_plugins
    "22.2.4 The CCMS plugins"), page 525 **`check_sap_cons`**. If a function group
    (such as **`SALG`**) is missing from the permission object **`S_RFC`**, the plugin
    shows name of this in plain text in the error message.
  prefs: []
  type: TYPE_NORMAL
- en: 'The login data is stored on the Nagios server in the file **`/etc/sapmon/login.cfg`**.
    When doing this, various target hosts (called *RFC destinations* in SAP) can be
    configured simultaneously. Such a login configuration for a target system is called
    an *RFC template* in the language of the CCMS plugins ([22.2.4 The CCMS plugins](../Text/ch22s02.html#the_ccms_plugins
    "22.2.4 The CCMS plugins"), page 525). It has the following form:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE143]'
  prefs: []
  type: TYPE_PRE
- en: 'The complete **`LOGIN`** definition must be written on a single line, and it
    is essential that it contain the following details:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`** **``*`target`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name of the SAP system, also referred to as *SID* or *system ID*.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u`** **``*`user`*``** **`-p`** **``*`password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: These parameters state the SAP user and corresponding password. Remember that
    a newly created dialog user has to change his or her password on first logon.
  prefs: []
  type: TYPE_NORMAL
- en: 'In addition, there are problems with upper/lower case on some systems: In some
    cases the password must be written entirely in capitals.'
  prefs: []
  type: TYPE_NORMAL
- en: 'If the login is to work later on, the password may not contain the # sign.
    Which special characters are allowed seems to depend on the system settings. Here
    you just have to experiment a bit, if necessary. If you have problems, it is best
    to start with a very simple password, so that errors of this type can be ruled
    out.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`client-id`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the three digit client ID.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-h`** **``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The host name of the host on which the named user should log in. This must resolve
    to an IP address.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s`** **``*`system_number`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The SAP system number. The first SAP instance is normally **`00`**, then increased
    incrementally.
  prefs: []
  type: TYPE_NORMAL
- en: 'Below, the **``*`user`*``** with the password **``*`secret`*``** should login
    from the client with the ID **`020`** to the host **`p10ap013`** whose SAP installation
    has the system number **`01`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE144]'
  prefs: []
  type: TYPE_PRE
- en: The RFC template name in square brackets consists of the text **`LOGIN_`** and
    the SAP system ID (SID). The RFC template defined here belongs to the SAP system
    **`P10`**.
  prefs: []
  type: TYPE_NORMAL
- en: 22.2.3 Monitors and templates
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The interface provided by SAP that is used by the plugins is available in a
    simple and an extendable variant. Only additional functions enable all information
    from the CCMS to be retrieved, which is why we are omitting the description of
    the simple interface.^([[272](#ftn.CHP-22-FN-8)])
  prefs: []
  type: TYPE_NORMAL
- en: 'For the extended interface, templates define the monitor data to be used. These
    are stored on the Nagios server in the file **`/etc/sapmon/agent.cfg`** and have
    the following format:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE145]'
  prefs: []
  type: TYPE_PRE
- en: 'The placeholders written in italics are replaced as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`name`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name with which the plugins address the template. The name may consist
    of digits, letters, and the characters **`_`** and **`-`**. When it is called
    by the plugin, the name must be written in lower case, irrespective of whether
    it is called **`TEST`**, **`Test`**, or **`test`**, for example. If you are having
    problems with alphanumerical names, it is better to select template names consisting
    of two digits when you are getting started, e.g., **`00`**, **`01`**, and so on.
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`description`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: A freely selectable, simple text.
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`monitor collection`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name of the monitor, set exactly as it is in the CCMS (including
    upper/lower case and spaces).
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`name_of_the_monitor`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The name of the monitor must also match the SAP name exactly.
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`context`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This pattern filters out the desired values from those contained in the monitor.
    In most cases you specify the identifier for the SAP instance, such as **`p10ap013_P10_01`**
    (**`p10ap013`** is the host name, **`P10`** the SID of the SAP system, and **`01`**
    is the system number).
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`monitor_object`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name of the desired monitor object, for example **`Dialog`**. Unfortunately
    the term demanded here rarely corresponds to the one shown in the SAP GUI. It
    is best to determine it using **`PATTERN_0=*`**, as described below.
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`attribute`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the variable to be queried. Each monitor object may contain severable
    variables. **`Dialog`**, for example, has, apart from the **`ResponseTime`** variable,
    the **`FrontendNetTime`** variable, which reveals the average processing time
    of a transaction, restricted to the network transmission time and processing time
    on the client.
  prefs: []
  type: TYPE_NORMAL
- en: The challenge here is in specifying the filter in **`PATTERN_0`**. It must exactly
    match the SAP-internal names, and these are not identical to the terms that are
    displayed in the CCMS Alert Monitor (Transaction RZ20).
  prefs: []
  type: TYPE_NORMAL
- en: 'It is best to start with **`PATTERN_0=*`**, which ensures that the entire tree
    appears. We shall call the template for this simply **`00`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE146]'
  prefs: []
  type: TYPE_PRE
- en: 'With this entry in **`/etc/sapmon/agent.cfg`** you query the complete list
    of all monitor entries, in this case those of the system with the ID **`P10`**,
    using the **`check_sap_cons`** plugin:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE147]'
  prefs: []
  type: TYPE_PRE
- en: 'The entries contain the following information—with items separated by spaces:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE148]'
  prefs: []
  type: TYPE_PRE
- en: The information for the **`P10`** system queried above first gives the SAP instance,
    such as **`p10ap013_P10_01`**, then the monitor object (**`Dialog`**) and the
    attribute (**`ResponseTime`**) together with values. In the SAP GUI ([Figure 22-2](../Text/ch22s02.html#the_sap_ccms_monitor_dialog_overview
    "Figure 22-2. The SAP CCMS monitor dialog Overview")) this latter is called **`Dialog
    Response Time`**, and since each empty space is significant, this is a completely
    different name.
  prefs: []
  type: TYPE_NORMAL
- en: 'In a template that is only interested in the response time of the instance
    **`p10ap014_P10_02`**, the **`PATTERN_0`** is defined as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE149]'
  prefs: []
  type: TYPE_PRE
- en: 'If you want to query all the entries of a query level, you must use the wildcard
    **`*`**. The following example defines templates for the dialog response time,
    the network response time, and the average CPU load for all instances of the system
    **`P10`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE150]'
  prefs: []
  type: TYPE_PRE
- en: 22.2.4 The CCMS plugins
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: SAP demonstrates the use of the RFC interface to the CCMS with the CCMS plugins
    for SuSE. In Debian you can convert the RPM package **`nagios-plugins-sap-ccms-0.7.3`**^([[273](#ftn.CHP-22-FN-9)])
    to a tar file with **`alien`**, or alternatively you can obtain the source RPM
    from a SuSE FTP mirror^([[274](#ftn.CHP-22-FN-10)]) and compile the source code
    yourself. This will give you the plugins listed in [Table 22-1](../Text/ch22s02.html#the_sap-ccms_plugins
    "Table 22-1. The SAP-CCMS Plugins").
  prefs: []
  type: TYPE_NORMAL
- en: Table 22-1. The SAP-CCMS Plugins
  prefs: []
  type: TYPE_NORMAL
- en: '| Plugin | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| ^([[a](#ftn.CHP-22-TFN-11)]) |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_sap`** | Output of the monitor data in HTML format |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_sap_cons`** | Ditto, but without HTML formatting and without hyperlinks
    for the output on the command line |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_sap_instance`** | Dialog response time and number of logged-in users
    on a particular application server (requires CCMS Ping^([[a](../Text/ch22s02.html#ftn.CHP-22-TFN-11)]))
    |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_sap_instance_cons`** | Ditto, as text output without HTML markup
    |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_sap_multiple`** | HTML-formatted output of data of a monitor template,
    which returns more than one value |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_sap_mult_no_thr`** | Output of multiple values with simple HTML
    formatting, without hyperlinks, in contrast to **`check_sap_multiple`** |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_sap_system`** | Shows the application servers of the SAP system
    and their states (requires CCMS Ping) |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_sap_system_cons`** | Like **`check_sap_system`**, only without HTML
    formatting |'
  prefs: []
  type: TYPE_TB
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[a](#CHP-22-TFN-11)]) As components of the CCMS monitoring system, CCMS Ping
    monitors the availability of the application server belonging to the SAP system.
  prefs: []
  type: TYPE_NORMAL
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: 'The plugins that end in _cons are especially suitable for test purposes: they
    simply pass the data on to the command line, without further formatting. The output
    of the others contains HTML formatting for a Nagios version modified by SAP; with
    Nagios 2.0 they usually lead to an incorrect view and are therefore useless.'
  prefs: []
  type: TYPE_NORMAL
- en: Individual values are best retrieved with **`check_sap_cons`**. For Nagios 2.x
    the monitor definition must then really return only one single value. The remaining
    ones would be returned on additional lines, ignored by Nagios 2.x.
  prefs: []
  type: TYPE_NORMAL
- en: If you are using Nagios from version 3.0 onward, you can certainly formulate
    the monitor definition in such a way that **`check_sap_cons`** returns several
    values. Although the Web interface will only display the first line of these,
    the extended view, with **`extinfo.cgi`**, will show the rest of the output up
    to a length of 8 KB (see [Figure 22-4](../Text/ch22s02.html#check_underscore_sap_underscore_cons
    "Figure 22-4. check_sap_cons with a mulitiple-line output in Nagios 3.0.")).
  prefs: []
  type: TYPE_NORMAL
- en: '![check_sap_cons with a mulitiple-line output in Nagios 3.0.](../Images/tagoreillycom20081104nostarchimages224004.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 22-4. check_sap_cons with a mulitiple-line output in Nagios 3.0.
  prefs: []
  type: TYPE_NORMAL
- en: If Nagios 2.x is to display several return values, it is best to use **`check_sap_mult_no_thr`**,
    which provides these values with some HTML formatting elements that also work
    with Nagios 2.x. This causes all results to appear in the Web interface as well.
  prefs: []
  type: TYPE_NORMAL
- en: 'All plugins demand two arguments: **`check_sap`**, **`check_sap_cons`**, **`check_sap_multiple`**,
    and **`check_sap_mult_no_thr`** first require the name of the monitor template
    from the file **`/etc/sapmon/agent.cfg`**, such as **`00`**, **`00_sapl3`**, **`01`**,
    or **`10`** (see [22.2.2 Obtaining the necessary SAP usage permissions for Nagios](../Text/ch22s02.html#obtaining_the_necessary_sap_usage_permi
    "22.2.2 Obtaining the necessary SAP usage permissions for Nagios")), followed
    by the name of the RFC templates, as defined in **`/etc/sapmon/login.cfg`** (in
    the examples in this book we use the system ID **`P10`**).'
  prefs: []
  type: TYPE_NORMAL
- en: 'For **`check_sap_system/check_sap_system_cons`** and **`check_sap_instance/check_sap_system_cons`**,
    the first argument changes: instead of the monitor template, **`check_sap_system`**
    demands the system ID (here, **`P10`**), and **`check_sap_instance`** demands
    the SAP instance, consisting of the host name, the SID, and the system number
    (for example, **`p10apl3_P10_01`**).'
  prefs: []
  type: TYPE_NORMAL
- en: First steps with **`check_sap_cons`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The plugin **`check_sap_cons`** is probably best suited to your first attempts.
    Only after this has worked for you properly on the command line should you move
    on to the actual Nagios configuration. The example in [22.2.3 Monitors and templates](../Text/ch22s02.html#monitors_and_templates
    "22.2.3 Monitors and templates") already showed how you determine the dialog response
    time with the monitor template **`00`**, and the following example queries the
    network time which the SAP GUI requires till the result of the transaction appears
    in the SAP GUI, using the monitor template **`01`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE151]'
  prefs: []
  type: TYPE_PRE
- en: The definitions in the two templates can be found in [22.2.3 Monitors and templates](../Text/ch22s02.html#monitors_and_templates
    "22.2.3 Monitors and templates") in page 523\. In both examples, **`check_sap_cons`**
    returns multiple values, only the first line of which would be noticed by Nagios
    in the Web interface and in notifications. If the instance **`p10ap014_P10_02`**
    displayed a critical status, but **`p10ap013_P10_01`** did not, the plugin would
    return a CRITICAL, but the Web interface would only present the first line (like
    the notification), which would not give any reason to worry. This means that the
    admin would not see the very thing that has set off the critical state.
  prefs: []
  type: TYPE_NORMAL
- en: 'If **`check_sap_cons`** only returns error messages instead of the data you
    want, there could be several reasons for this. In the following example the login
    fails:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE152]'
  prefs: []
  type: TYPE_PRE
- en: 'The reason is given in the **`message:`** field: the user currently does not
    have a valid account. If the following message were to be found there'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE153]'
  prefs: []
  type: TYPE_PRE
- en: this would mean that the user **`910W0B`** does not have the necessary permission
    in the authorization object **`S_RFC`**. In order to grant it, that user should
    be assigned to the function group **`SXMI`**.
  prefs: []
  type: TYPE_NORMAL
- en: The plugins record such RFC error messages in the file **`dev_rfc`** in the
    current working directory. If Nagios runs the plugin, then it will generate this
    file in the Nagios home directory (**`/usr/local/nagios`**, if you have followed
    the installation description in this book).
  prefs: []
  type: TYPE_NORMAL
- en: 'In the next case the login works perfectly, but the plugin does not return
    any values:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE154]'
  prefs: []
  type: TYPE_PRE
- en: 'The error here lies in the monitor definition: often the name of the monitor
    set or the monitor is written wrongly, or the pattern does not match the monitor
    used. The intersection of monitor and pattern is then empty, and SAP also does
    not warn explicitly if the monitor or monitor set do not even exist.'
  prefs: []
  type: TYPE_NORMAL
- en: Checking multiple values with **`check_sap_mult_no_thr`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If Nagios is to represent multiple queried values in the Web interface, you
    should use **`check_sap_mult_no_thr`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE155]'
  prefs: []
  type: TYPE_PRE
- en: The output is given in a single line, which we have reformatted manually here
    so that it can be more easily read. With the HTML code, the plugin ensures that
    each value (thanks to the **`CLASS`** specifications) is shown on a separate line
    in the color matching its status. The status of the Nagios service changes to
    CRITICAL if at least one measured value is critical. Such a case is shown in [Figure 22-5](../Text/ch22s02.html#check_underscore_sap_underscore_mult_un
    "Figure 22-5. Check_sap_mult_no_thr uses HTML. Markups which Nagios 2.0 also understands").
  prefs: []
  type: TYPE_NORMAL
- en: '![Check_sap_mult_no_thr uses HTML. Markups which Nagios 2.0 also understands](../Images/tagoreillycom20081104nostarchimages224006.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 22-5. `Check_sap_mult_no_thr` uses HTML. Markups which Nagios 2.0 also
    understands
  prefs: []
  type: TYPE_NORMAL
- en: In this case as well you should remember that Nagios 2.x altogether processes
    no more than 300 bytes of the plugin output, and cuts off the rest. For HTML-formatted
    output, not only is information then missing, there are also side effects in the
    table layout in the Web interface. In case of doubt, you must share the test among
    several service checks. Starting with Nagios 3.0, this problem generally no longer
    occurs, as the limit of 8 KB for the plugin output is also usually sufficient
    to display extensive output.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the definition of the Nagios command objects, the host name, exceptionally,
    does not play a role for the CCMS plugins. This means that the **`$HOSTADDRESS$`**
    macro is not used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE156]'
  prefs: []
  type: TYPE_PRE
- en: 'If you request several values simultaneously, they will normally belong to
    different hosts. This means that services can only be assigned to a host in one-to-one
    single value queries. Nevertheless, Nagios expects a specific host in the service
    definition:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE157]'
  prefs: []
  type: TYPE_PRE
- en: 22.2.5 Performance optimization
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Since the monitor always transmits all the data it has available over the RFC
    interface, filtering always takes place on the client side through the plugin.
    For this reason it is not recommended that you query single values from a large
    monitor one after another: this consumes considerable resources.'
  prefs: []
  type: TYPE_NORMAL
- en: You should either have a single service provide all the values,^([[275](#ftn.CHP-22-FN-12)])
    or you should define a separate monitor yourself containing precisely those values
    you would like to test. This latter method is recommended by SAP.
  prefs: []
  type: TYPE_NORMAL
- en: If you want to check several monitors, or even single values of the monitor
    one after the other, you should keep an eye on the necessary network bandwidth.
    Within a local network this is normally not a problem, but it can place a considerable
    burden on narrow-bandwidth long-distance connections (ISDN, simple VPNs). In such
    cases you should measure the network traffic when starting operation, so that
    you can increase the check intervals accordingly in case of problems.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[270](#CHP-22-FN-6)]) Central evaluation was not possible in earlier releases.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[271](#CHP-22-FN-7)]) This section is intended for SAP authorization administrators.
    If you do not maintain SAP authorizations yourself, you can skip this section.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[272](#CHP-22-FN-8)]) Information on this is provided by the PDF documents
    mentioned in [22.2.1 A short overview over the alert monitor](../Text/ch22s02.html#a_short_overview_over_the_alert_monitor
    "22.2.1 A short overview over the alert monitor").
  prefs: []
  type: TYPE_NORMAL
- en: ^([[273](#CHP-22-FN-9)]) It can be found at [http://www.rpmseek.com/](http://www.rpmseek.com/),
    for example, if you search there for nagios-plugins-sap-ccms.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[274](#CHP-22-FN-10)]) e.g., [ftp://ftp5.gwdg.de/pub/linux/suse/opensuse/distribution/SL-OSS-factory/inst-source/suse/i586/nagios-plugins-sap-ccms-0.7.3-143.i586.rpm](ftp://ftp5.gwdg.de/pub/linux/suse/opensuse/distribution/SL-OSS-factory/inst-source/suse/i586/nagios-plugins-sap-ccms-0.7.3-143.i586.rpm)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[275](#CHP-22-FN-12)]) Using a plugin predestined for the output of multiple
    values.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 23. Processing Events with the EventDB
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Events are fundamentally different from the other, usual host and service states
    in Nagios. The check of a service in a critical state returns a CRITICAL until
    the state of the service changes, irrespective of the number of checks and the
    repeat interval. An event, on the other hand, occurs only once, for instance in
    the form of a syslog entry or an SNMP trap.
  prefs: []
  type: TYPE_NORMAL
- en: If the events of an uninterruptible power supply (UPS) are logged via syslog
    to a log file, the message that the UPS has switched to battery because the voltage
    supply has failed will appear there only once. If you now test regularly whether
    a corresponding entry occurred within the last half hour, simple log file checks
    will not announce a match after this time has expired, so they will return an
    OK, since there is no critical event. But the UPS is still in a critical state.
    The critical state only really ends when the message arrives that the voltage
    supply has been restored.
  prefs: []
  type: TYPE_NORMAL
- en: 'Monitoring via SNMP traps comes close to the desired behavior: An alarm trap
    announces the failure of the voltage supply, the state of the service is set to
    CRITICAL, a subsequent OK trap announces the restoration of the voltage supply,
    and the state changes back to OK.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Events can be integrated into Nagios in various ways. A simple syslog integration
    is described in [14.5 Application Example I: Integrating syslog and Nagios](../Text/ch14s05.html
    "14.5 Application Example I: Integrating syslog and Nagios") from page 306, and
    another processing method for SNMP traps, also kept very simple, is dealt with
    in [14.6 Application Example II: Processing SNMP Traps](../Text/ch14s06.html "14.6
    Application Example II: Processing SNMP Traps") from page 312\. For Windows events
    it is often sufficient to test whether a specific event has occurred in the past
    12 to 24 hours. The check can be made with NSClient++ and the module **`CheckEventLog`**
    ([20.4.4 Internal NSClient++ functions](../Text/ch20s04.html#internal_nsclient_plus_plus_functions
    "20.4.4 Internal NSClient++ functions"), page 502), for instance.'
  prefs: []
  type: TYPE_NORMAL
- en: The procedure described in this chapter goes a little further. All events are
    collected in an event database. An administrator processes all these events and
    sets an acknowledge via a Web interface. Nagios now checks via plugin whether
    a defined number of events is exceeded for a specific group, so that the administrator
    will have to act—to set acknowledges and undertake further action, if necessary.
  prefs: []
  type: TYPE_NORMAL
- en: A similar approach is taken by **`nagtrap`**^([[276](#ftn.CHP-23-FN-1)]) (formerly
    SNMPTT Web Frontend, not to be confused with the SNMPTT GUI^([[277](#ftn.CHP-23-FN-2)])).
    **`nagtrap`** is specialized for SNMP traps and is integrated directly into the
    Nagios Web interface. For reasons of space, we will not go into a detailed description
    here.
  prefs: []
  type: TYPE_NORMAL
- en: 23.1 How the EventDB Works
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The EventDB of NETWAYS^([[278](#ftn.CHP-23-FN-3)]) basically consists of four
    components: a syslog connection, which collects the events, a MySQL database to
    save the events, a Web interface for interactive processing, and a Nagios plugin,
    which connects the EventDB to Nagios. [Figure 23-1](../Text/ch23.html#syslog-ng_collects_data_f
    "Figure 23-1. syslog-ng collects data from various sources and writes these to
    named pipe. A separate daemon reads the events from this and writes them to the
    database. From this they can be queried via web interface or via Nagios plugin.")
    shows a diagram of the setup.'
  prefs: []
  type: TYPE_NORMAL
- en: A central syslog service—**`syslog-ng`** is used because of its more flexible
    configuration—collects events from various sources. There are various software
    packages available for the integration of Windows event logs, one of which is
    described in [23.6 Sending Windows Events to Syslog](../Text/ch23s05.html "23.6
    Sending Windows Events to Syslog") (page 545). The SNMP trap daemon installed
    on the syslog server, **`snmptrapd`** ([14.6.1 Receiving traps with snmptrapd](../Text/ch14s06.html#receiving_traps_with_snmptrapd
    "14.6.1 Receiving traps with snmptrapd"), page 312), is able to pass the traps
    it receives on to the syslog. To provide more meaningful and readable messages
    from the cryptic OIDs, the *SNMP Trap Translator* (SNMPTT) is on hand to help
    out the **`snmptrapd`**, and this is described briefly in [23.7 Making the Incomprehensible
    Legible with SNMPTT](../Text/ch23s06.html "23.7 Making the Incomprehensible Legible
    with SNMPTT") from page 546.
  prefs: []
  type: TYPE_NORMAL
- en: '**`syslog-ng`** allows existing events to be arranged in a self-defined format
    and to be sent to a named pipe. From this a daemon reads the incoming events and
    writes them to a MySQL database. Via a Web interface ([Figure 23-2](../Text/ch23s03.html#the_web_interface_for_the_eventdb_allow
    "Figure 23-2. The Web interface for the EventDB allows certain entries to be selected,
    and the administrator the administrator can also set acknowledges for each event
    via the Web interface."), page 539) the administrator confirms processed events
    with acknowledges. Nagios uses a plugin to test whether there are one or more
    non-confirmed entries for a specific event and informs the administrator accordingly
    about the notification functions.'
  prefs: []
  type: TYPE_NORMAL
- en: It should also be mentioned that the EventDB is ideal for processing sys-log
    entries, even when Nagios is not used at all. The Web interface of the EventDB
    provides a simple but effective interface that can be used to search the database
    quickly and easily for a particular event or for similar events, especially when
    events of the same type are collected from a large number of hosts.
  prefs: []
  type: TYPE_NORMAL
- en: '![syslog-ng collects data from various sources and writes these to named pipe.
    A separate daemon reads the events from this and writes them to the database.
    From this they can be queried via web interface or via Nagios plugin.](../Images/tagoreillycom20081104nostarchimages224008.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 23-1. `syslog-ng` collects data from various sources and writes these
    to named pipe. A separate daemon reads the events from this and writes them to
    the database. From this they can be queried via web interface or via Nagios plugin.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[276](#CHP-23-FN-1)]) [http://www.nagtrap.org/](http://www.nagtrap.org/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[277](#CHP-23-FN-2)]) [http://snmptt-gui.sourceforge.net/](http://snmptt-gui.sourceforge.net/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[278](#CHP-23-FN-3)]) [http://www.netways.de/](http://www.netways.de/)
  prefs: []
  type: TYPE_NORMAL
- en: 23.2 Installation
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The current version of the EventDB can be obtained from NagiosExchange,^([[279](#ftn.CHP-23-FN-4)])
    and the contents of the tar archive are unpacked in the directory **`/usr/local/src`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE158]'
  prefs: []
  type: TYPE_PRE
- en: The Nagios plugin is located in the **`plugin`** subdirectory. The subdirectory
    **`agenten`** contains the integration with **`syslog-ng`**. In **`db`** there
    is a MySQL script that creates the necessary tables in the database. The **`webinterface`**
    directory contains the Web interface for the EventDB
  prefs: []
  type: TYPE_NORMAL
- en: 23.2.1 Installation requirements
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: A prerequisite for the EventDB is **`syslog-ng`** in at least version 1.9.1,
    since the template mechanism required is only implemented from this version onward.
    For the database you require a current MySQL-5.0 server (included in the Debian
    package **`mysql-server-5.0`**, for example), and for the **`syslog-ng2mysql.pl`**
    daemon written in Perl, the module **`DBD::MySQL`** (in Debian, the package **`libdbd-mysql-perl`**).
  prefs: []
  type: TYPE_NORMAL
- en: The Web interface is implemented in PHP 5\. This requires, along with Apache
    2, the PHP-5 module for this server version (in Debian **`libapache2-mod-php5`**)
    and the PHP5-MySQL package (in Debian, **`php5-mysql`**).
  prefs: []
  type: TYPE_NORMAL
- en: An automatic installation routine that checks that all required packages are
    present is not included in EventDB.
  prefs: []
  type: TYPE_NORMAL
- en: If the SNMPTT, to be described later in [23.7 Making the Incomprehensible Legible
    with SNMPTT](../Text/ch23s06.html "23.7 Making the Incomprehensible Legible with
    SNMPTT"), is to be integrated, then you will also require the daemons **`snmpd`**
    and **`snmptrapd`**, as well as the accompanying client programs. Debian provides
    these programs in the packages **`snmpd`** and **`snmp`**. The SNMP trap translator
    requires SNMP Perl (in Debian, included in the package **`libsnmp-perl`**), which
    must not be confused with **`Net::SNMP`**.
  prefs: []
  type: TYPE_NORMAL
- en: 23.2.2 Preparing the MySQL database
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'After the installation of the MySQL-5 server package for the respective distribution,
    you set up the database **`eventdb`** and the database user **`eventdb`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE159]'
  prefs: []
  type: TYPE_PRE
- en: 'The **`GRANT`** command gives **`eventdb`** the necessary permissions to work
    with the event database; instead of the password set here, you use your own, secure
    password. Then you change to the directory where the source code has been unpacked
    (in this case, **`/usr/local/src/eventdb`**) and set up the necessary tables with
    the script **`create_tables.sql`** from the subdirectory **`db`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE160]'
  prefs: []
  type: TYPE_PRE
- en: 'If no errors occur when doing this, the prompt will appear, without any other
    output. What has been created by the script can then be displayed with **`show
    tables`** and **`describe`** *`tablename`*:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE161]'
  prefs: []
  type: TYPE_PRE
- en: The MySQL command **`show tables`** shows the tables created. All events are
    saved in **`events`**. The **`comments`** table is just an auxiliary table, which
    is used for comments that the administrator might make when setting acknowledges.
  prefs: []
  type: TYPE_NORMAL
- en: 23.2.3 Sending events to the database with **`syslog-ng`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The configuration of **`syslog-ng`** has already been described in [14.5 Application
    Example I: Integrating syslog and Nagios](../Text/ch14s05.html "14.5 Application
    Example I: Integrating syslog and Nagios") from page 306, which is why we will
    deal here only with the adjustments for the EventDB. In order for the syslog daemon
    to be able to pass on data to the EventDB, we need suitable *destinations* and
    a log entry that uses these. To make the configuration more clear we will write
    our own template to the file **`syslog-ng.conf`**, which formats the output and
    which is referenced in the definition of the two destinations **`d_eventdb`**
    and **`df_eventdb`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE162]'
  prefs: []
  type: TYPE_PRE
- en: In the **`TAG`** variable there is a non-documented combination of **`$FACILITY`**
    and **`$PRIORITY`**, that is, of the type of program to be logged (daemon, authorization
    tool, kernel, cron daemon, printer, and so on; see also **`man 3 syslog`**) and
    the significance of the message. **`$HOST`** is a placeholder for the computer,
    **`$YEAR-$MONTH-$DAY`** for the date, **`$HOUR:$MIN:$SEC`** for the time, **`$PROGRAM`**
    for the program for which the message applies, and **`$MSG`** for the log message
    itself.
  prefs: []
  type: TYPE_NORMAL
- en: The **`LEVEL`** variable is actually unnecessary, since it contains the same
    value as **`PRIORITY`**. The database layout demands both values, however, which
    is why they must be specified. The entire template definition must be written
    on one line in the configuration file **`syslog-ng.conf`**; it is only line-wrapped
    here for printing purposes.
  prefs: []
  type: TYPE_NORMAL
- en: The destination **`d_eventdb`** is a named pipe that is fed with the data of
    the template. The destination **`df_eventdb`** is used for debugging purposes
    and can be used as a substitute or in parallel when you are searching for errors.
    The data here ends up in a normal log file. Since the same template is used, it
    produces exactly the same text as is contained in the named pipe.
  prefs: []
  type: TYPE_NORMAL
- en: 'The only things missing now are a source, a filter, and a log entry:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE163]'
  prefs: []
  type: TYPE_PRE
- en: The source **`local`** reads all local and system-internal events that arrive
    at the **`syslog-ng`**, but no kernel events. **`remote`** describes the classic
    method of receiving packets from remote syslog daemons via UDP port 514\. The
    filter **`f_warn`** covers all events that have a priority (or level) of at least
    **`warn`**. Finally, **`log`** writes events from the two sources that are matched
    by the filter, to the destination **`d_eventdb`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'The configuration shown uses **`/var/run/syslog-ng.pipe`** as a named pipe.
    Debian-based systems delete the contents of the directory **`/var/run/`** when
    the system is booted, however. For this reason the named pipe must be newly created
    at each system start. The startup script included with Event-DB, **`syslog-ng2mysql`**
    in the directory **`agenten/syslog-ng`**, has been doing this since version 2007-11-30;
    for older installations you should add the following two lines at the beginning
    of the script:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE164]'
  prefs: []
  type: TYPE_PRE
- en: Then you copy the script to **`/etc/init.d`** and ensure, depending on the distribution,
    that it is run automatically on system start, and certainly before **`/etc/init.d/syslog-ng`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'The Perl daemon **`syslog-ng2mysql.pl`** is also located in the subdirectory
    **`agenten/syslog-ng`**. In this script you need to change the variables **`$dbuser`**
    and **`$dbpass`** to match your own MySQL installation:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE165]'
  prefs: []
  type: TYPE_PRE
- en: Then you copy the file to **`/usr/local/sbin`**, where the init script expects
    it to be. With
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE166]'
  prefs: []
  type: TYPE_PRE
- en: you restart the Perl daemon and perform a restart of the syslog daemon.
  prefs: []
  type: TYPE_NORMAL
- en: 'An initial overview of whether events end up in the database can be obtained
    by entering a simple **`select *`** command on the **`events`** table:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE167]'
  prefs: []
  type: TYPE_PRE
- en: 'If nothing happens here, you can use the **`logger`** program to test whether
    the syslog daemon is writing entries at all to the log files (for further information,
    see **`man logger`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE168]'
  prefs: []
  type: TYPE_PRE
- en: If no entries appear, despite the syslog working correctly, you should enable
    the destination **`df_eventdb`** and check to see if the output of the template
    appears correctly formatted.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[279](#CHP-23-FN-4)]) [http://www.nagiosexchange.org/36;1129](http://www.nagiosexchange.org/36;1129)
  prefs: []
  type: TYPE_NORMAL
- en: 23.3 Using the Web Interface
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The Web interface for the EventDB consists of a single PHP file, **`index.php`**,
    which is included in the tarfile in the subdirectory **`webinterface`**. It accesses
    the database directly and therefore requires details of the database, such as
    user and password. You should check (and change) the following four lines of the
    file accordingly:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE169]'
  prefs: []
  type: TYPE_PRE
- en: Then you copy **`index.php`** to the (previously created) directory **`/usr/local/nagios/share/eventdb`**.
    The Web interface, as shown in [Figure 23-2](../Text/ch23s03.html#the_web_interface_for_the_eventdb_allow
    "Figure 23-2. The Web interface for the EventDB allows certain entries to be selected,
    and the administrator the administrator can also set acknowledges for each event
    via the Web interface."), can then be reached via the URL [http://nagios-server/nagios/eventdb/index.php](http://nagios-server/nagios/eventdb/index.php).
  prefs: []
  type: TYPE_NORMAL
- en: 'The Web interface is roughly divided into three areas: the selection window
    at the top, which allows data to be selectively filtered, the event display in
    the middle, and a third section which allows acknowledges to be commented.'
  prefs: []
  type: TYPE_NORMAL
- en: '![The Web interface for the EventDB allows certain entries to be selected,
    and the administrator the administrator can also set acknowledges for each event
    via the Web interface.](../Images/tagoreillycom20081104nostarchimages224010.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 23-2. The Web interface for the EventDB allows certain entries to be
    selected, and the administrator the administrator can also set acknowledges for
    each event via the Web interface.
  prefs: []
  type: TYPE_NORMAL
- en: The selection filter **Type** refers to the event source, which is normally
    **syslog**. If SNMP traps are being processed, another type, **snmptrap**, is
    included. With *Host* you specify the system of origin of the event by means of
    the host details in the syslog entries. The selection options for **Facility**
    and **Priority** also correspond to the naming convention used in syslog (see
    [23.2.2 Preparing the MySQL database](../Text/ch23s02.html#preparing_the_mysql_database-id1
    "23.2.2 Preparing the MySQL database")).
  prefs: []
  type: TYPE_NORMAL
- en: If you set a check mark for **Display acknowledged items, too**, the Web interface
    will display all events. Normally you will just see the events for which there
    are no acknowledges.
  prefs: []
  type: TYPE_NORMAL
- en: 'Of more interest is the **Text** box in the center: At the top you can enter
    simple patterns. If you are looking for all the entries of the program **`pluto`**,
    for example, you just enter **`pluto*`** here. Distinction is made between upper
    and lower case. More options are provided by regular expressions, which can be
    specified in the second line: The entry (**`smbd|nmbd|win/bind`**) searches for
    all entries in which either **`smbd`**, **`nmbd`** or **`winbind`** occur. The
    Regexp search is considerably slower, however. A check mark for **String not exists**
    negates the previous selection.'
  prefs: []
  type: TYPE_NORMAL
- en: The option **Message is empty** can only be used on its own. It ignores all
    the other settings in the **Text** box and displays all events that do not contain
    any message text.
  prefs: []
  type: TYPE_NORMAL
- en: 'The **Display** box affects the presentation. You can select different sorting
    methods, and define the number of entries to be displayed. The default of **`20`**
    entries is too low for many purposes. If the Web interface displays a larger number
    by default, you should change the following line in the file **`index.php`** accordingly:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE170]'
  prefs: []
  type: TYPE_PRE
- en: The data range shows normal syslog entries, together with the number of the
    dataset in the database in the **ID** column. For an acknowledgement, you can
    put a check mark in front of the entry, enter a comment in the lower section if
    necessary, and select the **acknowledge** button. Confirmed entries disappear
    when the Web page is reloaded.
  prefs: []
  type: TYPE_NORMAL
- en: If you want to confirm all entries shown simultaneously, select the **rev**
    header of the first table column, which inverts the current state of the selection
    fields. A subsequent acknowledge via the button confirms all entries at the same
    time.
  prefs: []
  type: TYPE_NORMAL
- en: The person responsible for an acknowledge is listed in the **Author** line.
    Once the user has logged in to the Web server, his user name will be given automatically
    there; otherwise, **AnonymousGnome** will appear as the author. This entry can
    be overwritten as you please.
  prefs: []
  type: TYPE_NORMAL
- en: 23.3.1 Preselection of the filter with URL parameters
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Specific parameters can be passed on to the Web interface through a URL so
    that a preselection is already made for the call:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE171]'
  prefs: []
  type: TYPE_PRE
- en: 'This example calls all non-confirmed entries assigned to the host **`swob-space`**.
    The entries for a multiple selection are represented by the Web interface as an
    array, which is why it must be specified in square brackets for the parameters
    **`host`**, **`type`**, **`facility`**, and **`priority`**. The entries for multiple
    hosts are queried with a consecutive index: **`index.php?host[0]=swobspace&host[1]=wobgate`**
    or **`index.php?host[0]=wobgate&host[1]=swobspace`**—the order of the menu entries
    in the Web interface does not have to match that of the indices.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The following CGI parameters can be specified, separated from one another by
    &:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`type[`****``*`index`*``****`]=`****``*`type`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: corresponds to the **Type** filter.
  prefs: []
  type: TYPE_NORMAL
- en: '**`host[`****``*`index`*``****`]=`****``*`host`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: ensures that the selection is in the **Host** field.
  prefs: []
  type: TYPE_NORMAL
- en: '**`facility[`****``*`index`*``****`]=`****``*`facility`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: selects the **Facility** entry.
  prefs: []
  type: TYPE_NORMAL
- en: '**`priority[`****``*`index`*``****`]=`****``*`priority`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: corresponds to the **Priority** selection.
  prefs: []
  type: TYPE_NORMAL
- en: '**`message=`****``*`pattern`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: the placeholder **``*`pattern`*``** is replaced by the expression that you would
    write in the **Message** box. Special characters must first be compiled in HTML-compatible
    code. Thus, **`*Bad TCP*`** is turned into **`%2Abad%20TCP%2A`**:^([[280](#ftn.CHP-23-FN-5)])
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE172]'
  prefs: []
  type: TYPE_PRE
- en: '**`regexp=`****``*`regular_expression`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: allows a regular search expression to be given. As with **`message`**, special
    characters must also be given in an HTML-compatible form.
  prefs: []
  type: TYPE_NORMAL
- en: '**`displayack=`****``*`value`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: also displays confirmed entries when set to **`true`**. The default is the opposite
    value, **`false`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`message_notexists=`****``*`value`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'simulates setting the check mark in front of **String not exists**: the value
    **`true`** negates the **`message`** and **`regexp`** selection. The opposite
    value, **`false`**, is the default.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`message_notext=`****``*`value`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: when set to **`true`**, shows only entries with an empty message. Here the default
    is also **`false`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`order=`****``*`sorting`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'enables the sorting order to be defined: **`ASC`** for ascending, **`DESC`**
    for descending.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`orderby=`****``*`criterion`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'defines the field by which sorting should be done: **`datetime`**, **`priority`**,
    **`host`**, **`facility`**, or **`uid`** (database index).'
  prefs: []
  type: TYPE_NORMAL
- en: '**`displayrows=`****``*`number`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: defines the number of rows to be displayed.
  prefs: []
  type: TYPE_NORMAL
- en: 23.4 The Nagios Plugin for the EventDB
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Querying the EventDB from Nagios is done with the plugin **`check_event-db.pl`**
    in the subdirectory **`plugin`**, which is copied to the directory **`/usr/local/nagios/libexec/`**.
    It has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`--db=`****``*`database_name`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The name of the EventDB. This is only specified if it is different from the
    default **`eventdb`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--dbtable`**=**``*`database_table`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The event table in the database. The default **`events`** is rarely changed.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--dbuser=`****``*`database_user`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This parameter must always be given, since **`none`** is set by default for
    the database user.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--dbpassword=`****``*`database_password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The same applies for the password for this user.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--dbhost=`****``*`database_host`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Details of the host on which the database is running. The default is set to
    **`localhost`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`hostname`*``** **`/--host=`****``*`hostname`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Host from which the message in the syslog really originates.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`priority`*``** **`/ --priority=`****``*`priority`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The desired syslog priority (or level), for example **`warning`**, **`err`**,
    or **`crit`**. For other information, see **`man 3 syslog`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-f`** **``*`facility`*``** **`/ --facility=`****``*`facility`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The syslog facility to be queried, such as **`cron`**, **`daemon`**, or **`auth`**
    (see also **`man 3 syslog`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-m`** **``*`text`*``** **`/ --message=`****``*`text`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The event text for which the plugin should look. It starts with the name of
    the program from which the message originates. If you are looking for entries
    from the program **`snmpd`**, you enter **`-m ' snmpd*'`**. As wildcards, **`*`**
    (shell syntax) and **`%`** (SQL syntax) can be used equivalently; the plugin replaces
    **`*`** with **`%`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`type`*``** **`/ --type=`****``*`type`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Event type, usually **`syslog`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-l`** **``*`prefix`*``** **`/ --label=`****``*`prefix`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Text placed in front of the plugin output in order to better identify a specific
    check.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`integer`*``** **`/ --warning=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the plugin finds at least *integer* matches it will issue a WARNING.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`integer`*``** **`/ --critical=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the plugin finds at least *integer* matches it will issue a CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following plugin call looks for all error messages with the priority **`err`**
    from the **`daemon`** facility that originate from the **`snmpd`** and contain
    any type of message text. If the plugin finds one entry, it should issue a WARNING;
    if it find two or more, it should issue a CRITICAL:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE173]'
  prefs: []
  type: TYPE_PRE
- en: '**`--label`** prefixes the actual result to the **`syslog-snmpd`** text, so
    that the statement can be more easily interpreted.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The command definition is kept really simple, due to the fact that the actual
    logic is stored in the service definition. The entire **`command_line`** must,
    as before, be written in a single line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE174]'
  prefs: []
  type: TYPE_PRE
- en: 'Database user and password are firmly joined together here. So that no password
    is visible at this point, we use the macro **`$USER9$`** from the resources file
    (see [A.1 The Main Configuration File nagios.cfg](../Text/apa.html#an_overview_of_the_nagios_configuration
    "A.1 The Main Configuration File nagios.cfg")). All other parameters are specified
    by the service definition for **`$ARG1$`**, for example, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE175]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: '^([[280](#CHP-23-FN-5)]) A special character is converted to **`%`** followed
    by its hexadecimal value: a space corresponds to 20, a **`*`**, to 2A; see **`man
    ascii`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 23.5 Maintenance
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The MySQL database can, under some circumstances—depending on the number of
    connected systems and events passed on by the syslog—fill up very quickly. Then
    it is time to clean up. To do this you need to find all the entries that are older
    than a certain date, test whether an acknowledge exists for them, and delete them.
    The following **`SELECT`** statement demonstrates the principle:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE176]'
  prefs: []
  type: TYPE_PRE
- en: 'The date is stored by MySQL in the format **``*`YYYY-mm-dd HH:MM:SS`*``**,
    which is why a simple string comparison works. If an admin has confirmed an entry,
    the **`acknowledged`** field will contain the value **`1`**. The following simple
    cleanup script deletes all confirmed entries that are more than two weeks old:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE177]'
  prefs: []
  type: TYPE_PRE
- en: 'The script is run daily via cron, but not before it has been thoroughly tested.
    If you want to archive data before it is deleted, you need to export it *prior
    to* the **`DELETE`** statement. To do this, you add the SQL statement **`INTO
    OUTFILE`** to the **`SELECT`** command introduced above, between **`SELECT *`**
    and **`FROM`**. This saves data to a text file, with tabs as separators, as shown
    below:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE178]'
  prefs: []
  type: TYPE_PRE
- en: The EventDB tarfile contains the two example scripts **`eventdb-clean_database.sh`**
    and **`rotate_eventdb.sh`** in the **`cleanup`** subdirectory, which essentially
    call the functions just described. You should nevertheless carefully consider
    how you are going to clean up the database, and modify and test the scripts accordingly.
  prefs: []
  type: TYPE_NORMAL
- en: 23.6 Sending Windows Events to Syslog
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In order to integrate Windows systems into a syslog environment, you need a
    service that reads out the Windows event log and sends this on via the syslog
    protocol to the central Syslog server. This task is performed by the freely available
    and easy-to-install **`evtsys`** tool (an abbreviation of the project name *Eventlog
    to Syslog*), from the homepage of the Engineering Computer Network of Purdue University^([[281](#ftn.CHP-23-FN-6)])
    The Web page provides two binary packages for download, one for 32-bit and one
    for 64-bit systems (**`evtsys_exe_32.zip`** or **`evtsys_exe_64.zip`**), along
    with the source code.
  prefs: []
  type: TYPE_NORMAL
- en: The files **`evtsys.exe`** and **`evtsys.dll`** contained in the package are
    copied to the subdirectory **`system32`** of the system root of the Windows server
    (usually **`C:\Windows\system32`**). The service is then installed and activated
    with the command
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE179]'
  prefs: []
  type: TYPE_PRE
- en: 'If the current **`evtsys`** version is to be installed on a system on which
    the service is already running, you must first de-install the old version entirely:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE180]'
  prefs: []
  type: TYPE_PRE
- en: '**`evtsys`** sends all event log entries without exception to the central syslog
    server. Messages go the **`daemon`** facility, and possible priorities are **`notice`**,
    **`warning`**, and **`err`**.'
  prefs: []
  type: TYPE_NORMAL
- en: In all cases you should make use of the extensive filter options of the **`syslog-ng`**
    on the syslog server, since the security messages from a single domain controller
    alone may total 1,000 or more entries per hour, even in small environments!
  prefs: []
  type: TYPE_NORMAL
- en: If you want to filter event log entries first on the Windows side, you will
    need to use other services. One tool that is free, but also rather old, and which
    may not work faultlessly from Windows 2003 R2 onward, is NTsyslog.^([[282](#ftn.CHP-23-FN-7)])
    You will also find various commercial solutions on the Internet that can be purchased.
  prefs: []
  type: TYPE_NORMAL
- en: Another filter option for Windows is provided by the *Nagios EventLog Agent
    for Windows*, **`nagevtlog`**, by Steve Shipway,^([[283](#ftn.CHP-23-FN-8)]) which
    is also available on NagiosExchange.^([[284](#ftn.CHP-23-FN-9)]) But this is not
    compatble with the EventDB, since data is sent via NSCA to the Nagios server.
  prefs: []
  type: TYPE_NORMAL
- en: 'All services that provide filtering on the Windows side have one disadvantage:
    Unknown events may, under certain circumstances, not even end up in the syslog
    and must be individually supplemented in the configuration. Provided that the
    central syslog server can cope with the flood of data, the approach with a central
    filter is easier to maintain.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[281](#CHP-23-FN-6)]) [https://engineering.purdue.edu/ECN/Resources/Documents/UNIX/evtsys/](https://engineering.purdue.edu/ECN/Resources/Documents/UNIX/evtsys/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[282](#CHP-23-FN-7)]) [http://ntsyslog.sourceforge.net/](http://ntsyslog.sourceforge.net/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[283](#CHP-23-FN-8)]) [http://www.steveshipway.org/software/f_nagios.html](http://www.steveshipway.org/software/f_nagios.html)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[284](#CHP-23-FN-9)]) [http://www.nagiosexchange.org/49;221](http://www.nagiosexchange.org/49;221)
  prefs: []
  type: TYPE_NORMAL
- en: 23.7 Making the Incomprehensible Legible with SNMPTT
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The *SNMP Trap Translator (SNMPTT)*^([[285](#ftn.CHP-23-FN-10)]) translates
    numerical object identifiers, which are difficult to understand, to readable text
    by means of the accompanying MIB.^([[286](#ftn.CHP-23-FN-11)]) To install this,
    you unpack the SNMPTT sources from Sourceforge^([[287](#ftn.CHP-23-FN-12)]) to
    **`/usr/local/src`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE181]'
  prefs: []
  type: TYPE_PRE
- en: The files **`snmptt`**, **`snmptthandler`**, and **`snmpttconvertmib`** contained
    in the archive are copied to **`/usr/sbin`** and made executable with **`chmod`**.
    The configuration file **`snmptt.ini`** is copied to the directory **`/etc/snmp`**,
    which was set up during the installation of the **`snmpd`** package.
  prefs: []
  type: TYPE_NORMAL
- en: 'SNMP traps are accepted by the **`snmptrapd`**. In order for this to forward
    them to **`snmptt`**, the following is entered in the **`snmptrapd.conf`** configuration
    file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE182]'
  prefs: []
  type: TYPE_PRE
- en: 'So that all traps are forwarded to **`snmptt`**, the file may contain only
    this default rule. **`snmptt`** accepts the object identifier in a numerical form,
    which is why **`snmptrapd`** needs to be started with the **`-On`** option. Depending
    on the distribution, the **`snmptrapd`** startup script may need to be adjusted.
    For Debian the file **`/etc/default/snmpdis`** modified accordingly:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE183]'
  prefs: []
  type: TYPE_PRE
- en: The **`-Lsd`** option logs all traps for debugging purposes in parallel via
    syslog. This should be switched off later on, by replacing **`-Lsd`** with **`-t`**.
  prefs: []
  type: TYPE_NORMAL
- en: 23.7.1 The configuration file **`snmptt.ini`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'To describe all the parameters of the central SNMPTT configuration file **`/etc/snmp/snmptt.ini`**
    would go beyond the scope of this book. We will just look at the sections and
    options that can be checked and which might need to be adjusted:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE184]'
  prefs: []
  type: TYPE_PRE
- en: The setting **`mode=stardlone`** in the **`[General]`** section states that
    the **`snmptrapd`** calls **`snmptt`** directly. With **`mode=daemon`**, SNMPTT
    runs as a separate daemon. **`net_snmp_perl_enable=1`** enables the use of the
    Perl module SNMP, which translates OIDs into meaningful text. Since the default
    **`0`** disables the module, this parameter certainly needs to be changed. **`mibs_environment=ALL`**
    integrates all installed MIBs. These must be free of errors, however, which is
    normally the case for MIBs installed from the distribution (for Debian, in the
    package **`libsnmp-base`**).
  prefs: []
  type: TYPE_NORMAL
- en: The parameter **`snmptt_conf_files`** in the **`[TrapFiles]`** section contains
    a list of configuration files that translate incoming SNMP traps and set off actions,
    if necessary. These are obtained from the MIB belonging to the device—how this
    is done is explained in [23.7.2 Converting MIBs](../Text/ch23s06.html#converting_mibs
    "23.7.2 Converting MIBs").
  prefs: []
  type: TYPE_NORMAL
- en: The three variables **`log_enable=1`**, **`log_system_enable=1`**, and **`unknown_trap_log_enable=1`**
    in the **`[Logging]`** section ensure that SNMPTT logs its activities to **`/var/log/snmptt*`**,
    which is very useful when searching for errors. By logging unknown traps, with
    **`unknown_trap_log_enable=1`**, you can see why SNMPTT does not translate a trap
    that it has received (for example, perhaps it contains OIDs other than those intended
    from the configuration file obtained from the MIB).
  prefs: []
  type: TYPE_NORMAL
- en: The two **`syslog_*`** parameters forward translated traps to the syslog daemon
    here with the syslog priority **`warning`** so that the data will then appear
    in the EventDB.
  prefs: []
  type: TYPE_NORMAL
- en: The parameters allowed in **`snmptt.ini`** and in the device-dependent configuration
    files are documented in detail on the SNMPTT homepage.^([[288](#ftn.CHP-23-FN-13)])
  prefs: []
  type: TYPE_NORMAL
- en: 23.7.2 Converting MIBs
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The included program **`snmpttconvertmib`** converts existing MIBs into a configuration
    file which can be used by SNMPTT. The translator only translates files that are
    explicitly listed in configuration files which have been integrated with **`snmptt_conf_files`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`snmptt convertmib`** uses **`snmptranslate`**, so before using this you
    should check that the actual translation program works properly. To do this, run
    **`snmptranslate -m ALL`** without any other parameters. An online help will appear,
    starting with the following lines:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE185]'
  prefs: []
  type: TYPE_PRE
- en: No other error message should appear before this line; if one does, this means
    that the MIBs are not correctly installed. If the MIBs were installed directly
    from the distribution, no errors should occur.
  prefs: []
  type: TYPE_NORMAL
- en: The conversion process—depending on the quality of the MIB—ranges from very
    simple (for correctly formed MIBs) to almost impossible (for MIBs with many errors).
    A flawless MIB is provided by Debian, for example, in the file **`rfcl628-UPS.mib`**.
    This distribution stores the MIBs in the directory **`/usr/share/snmp/mibs`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'Before you start looking for and installing MIBs from other sources, you should
    test the conversion with a "clean" MIB. The already mentioned UPS-MIB is converted
    as follows to an SNMPTT configuration file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE186]'
  prefs: []
  type: TYPE_PRE
- en: 'No error should appear in the summary at the end of the output, as is the case
    here. The contents of the new configuration file now appear as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE187]'
  prefs: []
  type: TYPE_PRE
- en: 'The two decisive entries here are **`EVENT`** and **`FORMAT`**. The first contains
    the status (here: CRITICAL) together with the OID, while **`FORMAT`** defines
    the text with which a corresponding event is described in the syslog, and thus
    in the EventDB. More information can be found in the **ConvertMIB** documentation
    on the SNMPTT homepage.^([[289](#ftn.CHP-23-FN-14)])'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[285](#CHP-23-FN-10)]) [http://www.snmptt.org/](http://www.snmptt.org/)
  prefs: []
  type: TYPE_NORMAL
- en: '^([[286](#CHP-23-FN-11)]) For SNMP, see [Chapter 11](../Text/ch11.html "Chapter 11. Collecting
    Information Relevant for Monitoring with SNMP") from page 227; SNMP traps were
    described in [14.6 Application Example II: Processing SNMP Traps](../Text/ch14s06.html
    "14.6 Application Example II: Processing SNMP Traps") from page 312.'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[287](#CHP-23-FN-12)]) [http://www.sourceforge.net/projects/snmptt](http://www.sourceforge.net/projects/snmptt)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[288](#CHP-23-FN-13)]) [http://www.snmptt.org/docs/snmptt.shtml](http://www.snmptt.org/docs/snmptt.shtml)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[289](#CHP-23-FN-14)]) [http://www.snmptt.org/docs/snmpttconvertmib.shtml](http://www.snmptt.org/docs/snmpttconvertmib.shtml)
  prefs: []
  type: TYPE_NORMAL
