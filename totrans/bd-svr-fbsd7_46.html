<html><head></head><body>

<div class="calibre1"><div class="calibre1"><a name="openvpn_server_2.0.6" class="calibre8" id="openvpn_server_2.0.6"/>
<div class="calibre24" id="calibre_pb_0"/><h2 id="title-ID0ES1PM" class="docPrefaceTitle">Chapter 19. OPENVPN SERVER 2.0.6</h2>
<h4 class="calibre32"><a class="calibre2" target="_blank" href="HTTP://OPENVPN.NET">HTTP://OPENVPN.NET</a></h4>
<a name="summary-id18" class="calibre8" id="summary-id18"/>
<h3 class="docSection1Title" id="-100000">19.1. SUMMARY</h3>
<p class="docText1"><a name="OpenVPN is" class="calibre8" id="OpenVPN is"/>OpenVPN is an open source VPN implementation that uses the OpenSSL library to encrypt data traveling over a public network. A <span class="docEmphasis1">VPN (virtual private network)</span><a name="private connection" class="calibre8" id="private connection"/> is a private connection from one point to another that utilizes an existing network as a transport medium. VPNs are popular with businesses because they allow secure communication between sites or employees without the need to lease dedicated WAN (wide area network) lines.<a name="IDX-CHP-19-0288" class="calibre8" id="IDX-CHP-19-0288"/><a name="IDX-CHP-19-0289" class="calibre8" id="IDX-CHP-19-0289"/><a name="IDX-CHP-19-0290" class="calibre8" id="IDX-CHP-19-0290"/><a name="IDX-CHP-19-0291" class="calibre8" id="IDX-CHP-19-0291"/><a name="IDX-CHP-19-0292" class="calibre8" id="IDX-CHP-19-0292"/><a name="IDX-CHP-19-0293" class="calibre8" id="IDX-CHP-19-0293"/></p>
<p class="docText1"><a name="in early" class="calibre8" id="in early"/>James Yonan began developing OpenVPN in early 2002. Yonan's employer at the time afforded him the freedom to telecommute. As a result, he became interested in telecommunication tools. His examination of the open source VPN community revealed a divide between security-conscious and usability-based software projects. Yonan's OpenVPN has grown into a very popular and complete VPN solution that addresses both security and usability issues. Yonan continues development of OpenVPN as project leader.</p>
<p class="docText1"><a name="several VPN" class="calibre8" id="several VPN"/>There are several VPN implementations, each of which offers various levels of security and functionality.</p>
<ul class="calibre15"><li class="calibre16"><p class="docText1"><a name="Tunneling Protocol" class="calibre8" id="Tunneling Protocol"/>PPTP (Point to Point Tunneling Protocol) is used to implement some VPNs. It is considered insecure due to a publicly known security exploit.<a name="IDX-CHP-19-0294" class="calibre8" id="IDX-CHP-19-0294"/></p></li><li class="calibre16"><p class="docText1"><a name="secure VPN" class="calibre8" id="secure VPN"/>L2TP/IPsec (Layer 2 Tunneling Protocol with Internet Protocol Security) is a reasonably secure VPN solution. However, it has problems traversing many basic NAT routers.</p></li><li class="calibre16"><p class="docText1"><a name="proven to" class="calibre8" id="proven to"/>OpenVPN is a cross-platform VPN solution that has proven to be secure, sustainable across NAT routers, and scalable. OpenVPN does require client software installation to function and can be complicated to set up initially.</p></li></ul>
<p class="docText1">OpenVPN supports routed or bridged VPNs. A <span class="docEmphasis1">routed VPN</span><a name="over the" class="calibre8" id="over the"/> creates a virtual subnet for the client and routes traffic over the VPN if addressed to a system on the remote side. A <span class="docEmphasis1">bridged VPN</span><a name="is broadcast" class="calibre8" id="is broadcast"/> connects clients to an existing network subnet. Data is broadcast through the bridge like a virtual Ethernet hub. A bridged VPN tunnel can provide a client with the same network functionality as being connected locally to that network. This guide outlines the setup of a bridged VPN rather than the default routed method.</p>
<p class="docText1"><a name="VPN joins" class="calibre8" id="VPN joins"/>A bridged VPN joins remote clients to a local network as if they were onsite, with all of the benefits of being on that local network. Also, bridged VPNs can use non-routable protocols (required by Windows file shares, broadcast traffic, LAN games, and so on) that small office and home office users may find useful.<a name="IDX-CHP-19-0295" class="calibre8" id="IDX-CHP-19-0295"/></p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="resources-id18" class="calibre8" id="resources-id18"/>
<h3 class="docSection1Title" id="-100000">19.2. RESOURCES</h3>
<p class="docText1"><span class="b"><a name="OpenVPN Articles" class="calibre8" id="OpenVPN Articles"/>OpenVPN Articles</span></p>
<p class="docText1"><a class="calibre2" target="_blank" href="http://openvpn.net/articles.html">http://openvpn.net/articles.html</a></p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="required-id18" class="calibre8" id="required-id18"/>
<h3 class="docSection1Title" id="-100000">19.3. REQUIRED</h3>
<p class="docText1"><img border="0" id="" src="OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg" alt="" class="calibre33"/><a name="FreeBSD " class="calibre8" id="FreeBSD "/> FreeBSD 7.0-RELEASE (see "<a class="calibre2" href="freebsd_7.0_split_000.html#freebsd_7.0">FreeBSD 7.0</a>")<a name="IDX-CHP-19-0296" class="calibre8" id="IDX-CHP-19-0296"/><a name="IDX-CHP-19-0297" class="calibre8" id="IDX-CHP-19-0297"/></p>
<p class="docText1"><img border="0" id="" src="OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg" alt="" class="calibre33"/><a name="collection " class="calibre8" id="collection "/> Updated ports collection (see "<a class="calibre2" href="freebsd_ports_collection.html#freebsd_ports_collection">FreeBSD Ports Collection</a>")</p>
<p class="docText1"><img border="0" id="" src="OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg" alt="" class="calibre33"/> Internet connection</p>
<p class="docText1"><img border="0" id="" src="OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg" alt="" class="calibre33"/> OpenSSL (see "<a class="calibre2" href="openssl_0.9.8g.html#openssl_0.9.8g">OpenSSL 0.9.8g</a>")</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="optional-id9" class="calibre8" id="optional-id9"/>
<h3 class="docSection1Title" id="-100000">19.4. OPTIONAL</h3>
<p class="docText1"><img border="0" id="" src="OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg" alt="" class="calibre33"/><a name="Local DNS" class="calibre8" id="Local DNS"/> Local DNS server (see "<a class="calibre2" href="isc_bind_dns_server_9.4.2.html#isc_bind_dns_server_9.4.2">ISC BIND DNS Server 9.4.2</a><a name="hostnames of" class="calibre8" id="hostnames of"/>") for resolving hostnames of systems on the local network and resolving VPN client DNS queries</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="preparation-id18" class="calibre8" id="preparation-id18"/>
<h3 class="docSection1Title" id="-100000">19.5. PREPARATION</h3>
<p class="docText1"><a name="need to" class="calibre8" id="need to"/>You'll need to determine your local network's default gateway, default DNS servers, and the device name of your server's network interface. The commands shown below will help you obtain these addresses.</p>
<div class="calibre34"><ol class="docList" type="1"><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="the IP" class="calibre8" id="the IP"/>To display the IP address of the local network's default gateway and the device name, become root and enter:</p><pre class="calibre30"># <b class="calibre28">netstat -rn | grep default</b>

default          192.168.1.1      UGS       0   2144  ed0</pre>
<p class="docText1">Here, the default gateway is <tt class="calibre20">192.168.1.1</tt><a name="network interface" class="calibre8" id="network interface"/>. The device name of the network interface is <tt class="calibre20">ed0</tt>.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="the DNS" class="calibre8" id="the DNS"/>To display the DNS servers currently configured for use on your system, enter:</p><pre class="calibre30"># <b class="calibre28">grep nameserver /etc/resolv.conf</b></pre><br class="calibre1"/>
</div></li></ol></div>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="install-id18" class="calibre8" id="install-id18"/>
<h3 class="docSection1Title" id="-100000">19.6. INSTALL</h3>
<p class="docText1"><a name="To begin" class="calibre8" id="To begin"/>To begin the OpenVPN installation process, enter the following commands:</p>
<pre class="calibre30"># <b class="calibre28">cd /usr/ports/security/openvpn</b>
# <b class="calibre28">make config ; make install clean</b>
# <b class="calibre28">rehash</b></pre>
<p class="docText1"><a name="should appear" class="calibre8" id="should appear"/>A menu should appear with an option for OpenVPN. We will leave this option at its default (off), so press [tab] to select <span class="b">OK</span> and then [enter] to continue.</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="configure-id18" class="calibre8" id="configure-id18"/>
<h3 class="docSection1Title" id="-100000">19.7. CONFIGURE</h3>
<p class="docText1"><a name="Once the" class="calibre8" id="Once the"/>Once the installation process completes, it is time to configure OpenVPN for use on your system.</p>
<div class="calibre34"><ol class="docList" type="1"><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="directory named" class="calibre8" id="directory named"/>Create a directory named <span class="docEmphasis1">openvpn</span> in <span class="docEmphasis1">/usr/local/etc</span><a name="file to" class="calibre8" id="file to"/> and copy the sample configuration file to it with the following commands (we'll edit this file later):</p><pre class="calibre30"># <b class="calibre28">mkdir /usr/local/etc/openvpn</b>
# <b class="calibre28">cd /usr/local/share/doc/openvpn/sample-config-files</b>
# <b class="calibre28">cp server.conf /usr/local/etc/openvpn/openvpn.conf</b></pre>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="the SSL" class="calibre8" id="the SSL"/>Begin creating the SSL Certificates and keys that are necessary for OpenVPN to function. Create a subdirectory of the <span class="docEmphasis1">openvpn</span> directory named <span class="docEmphasis1">keys</span><a name="your working" class="calibre8" id="your working"/>, for use as your working directory. The following commands will create the <span class="docEmphasis1">keys</span><a name="files to" class="calibre8" id="files to"/> directory and copy the appropriate OpenSSL and script files to it:</p><pre class="calibre30"># <b class="calibre28">mkdir /usr/local/etc/openvpn/keys</b>
# <b class="calibre28">cd /usr/local/etc/openvpn/keys</b>
# <b class="calibre28">cp /usr/local/openssl/misc/CA.pl .</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="the" class="calibre8" id="the"/>Create a CA certificate and key using the <span class="docEmphasis1">CA.pl</span> script:</p><pre class="calibre30"># <b class="calibre28">./CA.pl -newca</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="the file" class="calibre8" id="the file"/>When prompted for a CA certificate filename, simply press [enter] to create the file.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="be sure" class="calibre8" id="be sure"/>When asked for a PEM passphrase, enter one, and be sure to remember it. You will need it later.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="for Country" class="calibre8" id="for Country"/>When prompted for Country Name, State, Locality, and so on, enter the appropriate responses. Enter <tt class="calibre20"><b class="calibre28">OpenVPN-CA</b></tt><a name="for the" class="calibre8" id="for the"/> for the Common Name.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="an email" class="calibre8" id="an email"/>After entering an email address, you will be prompted for a challenge password. Just press [enter] twice; the challenge password and company name are optional. You will be returned to the command prompt once you enter the PEM passphrase you created in step 5.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="following command" class="calibre8" id="following command"/>Generate a certificate request. Enter the following command to begin this process:</p><pre class="calibre30"># <b class="calibre28">./CA.pl -newreq</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="for a" class="calibre8" id="for a"/>When asked for a passphrase, enter the same one you used earlier for the sake of simplicity.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="information you" class="calibre8" id="information you"/>Enter the same information you entered earlier, but enter <tt class="calibre20"><b class="calibre28">server</b></tt> for the Common Name.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="for a" class="calibre8" id="for a"/>After entering an email address, you will be prompted for a challenge password. Just press [enter] twice; the challenge password and company name are optional. You will be returned to the command prompt.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="and certificate" class="calibre8" id="and certificate"/>Create the signed certificate from the request and certificate authority files we produced above. Begin the certificate signing process with:</p><pre class="calibre30"># <b class="calibre28">./CA.pl -signreq</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Enter the password you assigned earlier.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Answer <span class="b">yes</span> to the <span class="docEmphasis1">Sign the certificate</span> and <span class="docEmphasis1">commit</span> prompts to create a signed SSL Certificate.</p><p class="docText1"><a name="and is" class="calibre8" id="and is"/>The signed SSL Certificate is in the current working directory and is named <span class="docEmphasis1">newcert.pem</span><a name="to" class="calibre8" id="to"/>. To make it easily identifiable, we'll copy this file to <span class="docEmphasis1">openvpn-cert.pem</span><a name="private key" class="calibre8" id="private key"/> and our private key to <span class="docEmphasis1">openvpn-encrypted-key.pem</span><a name="The CA" class="calibre8" id="The CA"/> below. The CA certificate and key are in the <span class="docEmphasis1">demoCA</span><a name="copy them" class="calibre8" id="copy them"/> directory. We will copy them to the current working directory and rename them <span class="docEmphasis1">openvpn-CAcert.pem</span> and <span class="docEmphasis1">openvpn-encrypted-CAkey.pem</span> respectively.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="organize your" class="calibre8" id="organize your"/>Enter the following commands to organize your SSL Certificates as mentioned above:</p><pre class="calibre30"># <b class="calibre28">cp newcert.pem openvpn-cert.pem</b>
# <b class="calibre28">cp newkey.pem openvpn-encrypted-key.pem</b>
# <b class="calibre28">cp demoCA/cacert.pem ./openvpn-CAcert.pem</b>
# <b class="calibre28">cp demoCA/private/cakey.pem ./openvpn-encrypted-CAkey.pem</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">The <span class="docEmphasis1">openvpn-encrypted-key.pem</span><a name="encrypted with" class="calibre8" id="encrypted with"/> file is encrypted with the password you entered earlier. We will remove this encryption so OpenVPN can use the file. The following commands will remove the encryption and make the file readable by the root user:</p><div class="calibre1">
              Code View:</div><pre class="calibre30"># <b class="calibre28">openssl rsa -in openvpn-encrypted-key.pem -out openvpn-unencrypted-key.pem</b>
# <b class="calibre28">chmod 400 openvpn-unencrypted-key.pem</b>
</pre><br class="calibre1"/>
<p class="docText1"><a name="producing client" class="calibre8" id="producing client"/>Now we begin producing client certificates with private keys for use with OpenVPN. In this example, we will use the names client01, client02, and so on. (You may use a different naming convention that helps you to identify clients easily.)</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="for client" class="calibre8" id="for client"/>To create the private key and certificate request for client01, enter the following commands:</p><pre class="calibre30"># <b class="calibre28">openssl req -days 1095 -nodes -new -keyout</b> <span class="docEmphBoldItalic">client01</span><b class="calibre28">-key.pem\</b>
? <b class="calibre28">-out</b> <span class="docEmphBoldItalic">client01</span><b class="calibre28">-req.pem</b>
# <b class="calibre28">chmod 400</b> <span class="docEmphBoldItalic">client01</span><b class="calibre28">-key.pem</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="enter the" class="calibre8" id="enter the"/>When prompted for the Country Name, State, Locality, and so on, enter the appropriate responses.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1">You must enter <span class="docEmphBoldItalic">client01</span> for the Common Name because each client <span class="docEmphasis1">must</span> have a unique Common Name. You may replace <tt class="calibre20"><i class="docEmphasis1">client01</i></tt><a name="long as" class="calibre8" id="long as"/> with another name if you used a different naming convention, as long as each new client name is unique.</p><hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> You may press [enter] at the optional challenge password and company name prompts to bypass them; they are not necessary.</span><hr size="1" noshade="noshade" class="calibre27"/></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="OpenVPN certificate" class="calibre8" id="OpenVPN certificate"/>Create a signed client certificate using the OpenVPN certificate authority we created earlier:</p><pre class="calibre30"># <b class="calibre28">openssl ca -days 1095 -out</b> <span class="docEmphBoldItalic">client01</span><b class="calibre28">-cert.pem -in</b> <span class="docEmphBoldItalic">client01</span><b class="calibre28">-req.pem</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="the password" class="calibre8" id="the password"/>When prompted, enter the password you assigned earlier.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="Answer" class="calibre8" id="Answer"/>Answer <span class="b">yes</span> to the <span class="docEmphasis1">Sign the certificate</span> and <span class="docEmphasis1">commit</span> prompts to continue.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="additional certificates" class="calibre8" id="additional certificates"/>To create additional certificates and keys for additional clients, repeat steps 17 through 22 above, substituting client02, client03, and so on for client01. (Be sure to change the Common Name to reflect the iteration of the client you are creating.)</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="client certificates" class="calibre8" id="client certificates"/>Once you have created your client certificates, transfer the appropriate certificate (<span class="docEmphasis1">client01-cert.pem</span>) and key (<span class="docEmphasis1">client01-key.pem</span><a name="client system" class="calibre8" id="client system"/>) to your client system using a secure medium (SFTP, removable media, etc.). Do not expose the <span class="docEmphasis1">client01-key.pem</span> file to the public!</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="create a" class="calibre8" id="create a"/>You need to create a Diffie-Hellman parameter in order for OpenVPN to function correctly. To do so, ensure that you are still in the <span class="docEmphasis1">/usr/local/etc/openvpn/keys</span> working directory, then enter the following command:</p><pre class="calibre30"># <b class="calibre28">openssl dhparam -out dh2048.pem 2048</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Edit the <span class="docEmphasis1">openvpn.conf</span> file that you created in step 1. First, open <span class="docEmphasis1">openvpn.conf</span>:</p><pre class="calibre30"># <b class="calibre28">ee /usr/local/etc/openvpn/openvpn.conf</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Uncomment the <tt class="calibre20">dev tap</tt> declaration (~52) by removing the semicolon (<tt class="calibre20">;</tt>) from the beginning of the line. Comment the <tt class="calibre20">dev tun</tt><a name="of the" class="calibre8" id="of the"/> declaration by inserting a semicolon at the beginning of the line. This tells OpenVPN to use the <tt class="calibre20">tap</tt><a name="lines should" class="calibre8" id="lines should"/> device, which is needed for Ethernet bridging. These two lines should now appear like this:</p><pre class="calibre30">dev tap
<b class="calibre28">;</b>dev tun</pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="private key" class="calibre8" id="private key"/>Tell OpenVPN where to find the CA certificate, server certificate, and server private key. Scroll down to the <tt class="calibre20">ca</tt> declaration (~78) and replace <tt class="calibre20">ca.crt</tt> with the relative path (relative to the <span class="docEmphasis1">openvpn</span><a name="the same" class="calibre8" id="the same"/> directory) and filename of your CA certificate file. Do the same for the <tt class="calibre20">cert</tt> and <tt class="calibre20">key</tt><a name="should appear" class="calibre8" id="should appear"/> declarations. The lines should appear as follows:</p><pre class="calibre30">ca <b class="calibre28">keys/openvpn-CAcert.pem</b>
cert <b class="calibre28">keys/openvpn-cert.pem</b>
key <b class="calibre28">keys/openvpn-unencrypted-key.pem</b> # This file should be kept secret</pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="Tell OpenVPN" class="calibre8" id="Tell OpenVPN"/>Tell OpenVPN where the Diffie-Hellman parameter file resides. Modify the <tt class="calibre20">dh</tt><a name="point to" class="calibre8" id="point to"/> declaration (~87) to point to <span class="docEmphasis1">dh2048.pem</span> in the <span class="docEmphasis1">openvpn</span> directory. It should now appear as follows:</p><pre class="calibre30">dh <b class="calibre28">keys/dh2048.pem</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Comment out the <tt class="calibre20">server</tt> declaration (~96) by inserting a semicolon (<tt class="calibre20">;</tt><a name="This line" class="calibre8" id="This line"/>) at the beginning of the line. This line should now appear as follows:</p><pre class="calibre30"><b class="calibre28">;</b>server 10.8.0.0 255.255.255.0</pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Uncomment the <tt class="calibre20">server-bridge</tt><a name="removing the" class="calibre8" id="removing the"/> statement (~115) by removing the semicolon from the beginning of the line. Modify the IP addresses on this line to reflect your network: The first IP address should be your local network's default gateway; the second is the netmask of the local network; the third defines the lower limit of the client IP address pool; and the fourth defines the upper limit of the client IP address pool. This line should appear something like this:</p><br class="calibre1"/><div class="calibre25" style="text-align:center">
<img border="0" id="" src="OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjVnMA--.jpg" alt="" class="calibre39"/>
</div><br class="calibre1"/><hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> If you are using a local DHCP server (common in NAT routers) be sure the range you specify here doesn't overlap the range of IP addresses used by the DHCP server. If you are using a DHCP server built into a NAT router, check its configuration interface for this range. For example, if the DHCP server has a starting IP address of 192.168.1.10 with a maximum of 50 users, you would have a range from 192.168.1.10 to 192.168.1.60, and you could safely use a range of 192.168.1.61 to 192.168.1.69 for VPN clients (assuming there are no static IP assignments in this range).</span><hr size="1" noshade="noshade" class="calibre27"/></div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Uncomment the <tt class="calibre20">push redirect-gateway</tt><a name="should appear" class="calibre8" id="should appear"/> declaration (~181). This line should appear as follows:</p><pre class="calibre30">push "redirect-gateway"</pre><br class="calibre1"/>
<hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> This option changes the default gateway of the VPN client to that of the gateway on the OpenVPN server side network. It is useful when you are on an untrusted remote network (such as those found in hotel rooms, Wi-Fi hotspots, etc.) and want to eliminate the risk of exposing your data to potential attackers. You may leave this line untouched if you do not wish to enable this feature, and skip to step 34 below.</span><hr size="1" noshade="noshade" class="calibre27"/></div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Uncomment the <tt class="calibre20">push dhcp-option</tt><a name="the specified" class="calibre8" id="the specified"/> statement (~187). This option instructs VPN clients to use the specified DNS server for hostname lookups. This line should now appear as follows, with your default DNS server IP substituted for the one shown here in italics.</p><pre class="calibre30">push "dhcp-option DNS <tt class="calibre20"><i class="docEmphasis1">192.168.1.11</i></tt>"</pre><br class="calibre1"/>
<hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> As of this writing the above feature functions on GUI OpenVPN clients running Windows (OpenVPN GUI) or Macintosh (Tunnelblick). If you have clients on other platforms, visit their client software vendor for updates or manually set their DNS server IP after their VPN connection is established.</span><hr size="1" noshade="noshade" class="calibre27"/></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="connected simultaneously" class="calibre8" id="connected simultaneously"/>To enable communication between VPN clients (two users connected simultaneously), uncomment the <tt class="calibre20">client-to-client</tt> declaration (~196). The line should appear as follows:</p><pre class="calibre30">client-to-client</pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Uncomment <tt class="calibre20">user nobody</tt> and <tt class="calibre20">group nobody</tt> (~254). This reduces OpenVPN's privileges after initialization. These two lines should appear like this:</p><pre class="calibre30">user nobody
group nobody</pre><br class="calibre1"/>
<p class="docText1">Save and exit.</p></div></li></ol></div>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="testing-id12" class="calibre8" id="testing-id12"/>
<h3 class="docSection1Title" id="-100000">19.8. TESTING</h3>
<p class="docText1"><a name="In this" class="calibre8" id="In this"/>In this section, we'll perform some tests to confirm that OpenVPN answers requests properly. You'll need a computer with an OpenVPN client installed and configured before continuing. (See "<a class="calibre2" href="notes.html#notes">Notes</a><a name="for information" class="calibre8" id="for information"/>" of page 143 for information on client setup.)<a name="IDX-CHP-19-0298" class="calibre8" id="IDX-CHP-19-0298"/></p>
<div class="calibre34"><ol class="docList" type="1"><li class="calibre16"><div class="calibre35"><p class="docText1">The kernel modules <tt class="calibre20">if_bridge</tt> and <tt class="calibre20">if_tap</tt><a name="to allow" class="calibre8" id="to allow"/> must be loaded in order to allow traffic on a remote client to bridge into the local network. Load these two modules like this:</p><pre class="calibre30"># <b class="calibre28">kldload if_bridge</b>
# <b class="calibre28">kldload if_tap</b></pre>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="virtual bridge" class="calibre8" id="virtual bridge"/>Create the virtual bridge and tap network interfaces that will act as a virtual hub between remote clients and the local network, as follows (replace <tt class="calibre20"><i class="docEmphasis1">ed0</i></tt><a name="name of" class="calibre8" id="name of"/> with the device name of your network interface):</p><pre class="calibre30"># <b class="calibre28">ifconfig bridge0 create</b>
# <b class="calibre28">ifconfig tap0 create</b>
# <b class="calibre28">ifconfig tap0 up</b>
# <b class="calibre28">ifconfig bridge0 addm</b> <span class="docEmphBoldItalic">ed0</span> <b class="calibre28">addm tap0</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="your OpenVPN" class="calibre8" id="your OpenVPN"/>Start OpenVPN and watch for incoming connections from your OpenVPN client.</p><pre class="calibre30"># <b class="calibre28">cd /usr/local/etc/openvpn</b>
# <b class="calibre28">openvpn openvpn.conf</b></pre><br class="calibre1"/>
<p class="docText1">You should see output similar to this:</p><div class="calibre1">
              Code View:</div><pre class="calibre30">Sun Jun 15 17:04:20 2008 OpenVPN 2.0.6 i386-portbld-freebsd7.0 [SSL] [LZO]
Sun Jun 15 17:04:20 2008 Diffie-Hellman initialized with 2048 bit key
Sun Jun 15 17:04:20 2008 TLS-Auth MTU parms [ L:1574 D:138 EF:38 EB:0 ET:0
Sun Jun 15 17:04:20 2008 TUN/TAP device /dev/tap0 opened
Sun Jun 15 17:04:20 2008 Data Channel MTU parms [ L:1574 D:1450 EF:42 EB:135

Sun Jun 15 17:04:20 2008 GID set to nobody
Sun Jun 15 17:04:20 2008 UID set to nobody
Sun Jun 15 17:04:20 2008 UDPv4 link local (bound): [undef]:1194
Sun Jun 15 17:04:20 2008 UDPv4 link remote: [undef]
Sun Jun 15 17:04:20 2008 MULTI: multi_init called, r=256 v=256
Sun Jun 15 17:04:20 2008 IFCONFIG POOL: base=192.168.0.200 size=11
Sun Jun 15 17:04:20 2008 IFCONFIG POOL LIST
Sun Jun 15 17:04:20 2008 client01,192.168.1.61
Sun Jun 15 17:04:20 2008 Initialization Sequence Completed

					  </pre><br class="calibre1"/>
<hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> If possible, try connecting a client to the server from outside the local network. (Remember to forward UDP port 1194 to the server if it is behind a NAT router.) Once a connection is initiated, you should see status messages scroll by in real time.</span><hr size="1" noshade="noshade" class="calibre27"/></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="console to" class="calibre8" id="console to"/>When you have completed testing, press [ctrl-C] at the console to shut down OpenVPN. Assuming the test was successful, configure OpenVPN and the necessary bridge and tap interfaces to start automatically at system startup.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Enable the <tt class="calibre20">if_bridge</tt> and <tt class="calibre20">if_tap</tt> kernel modules at startup by first opening <span class="docEmphasis1">loader.conf</span> in <span class="docEmphasis1">/boot</span> like this:</p><pre class="calibre30"># <b class="calibre28">ee /boot/loader.conf</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Carefully add the following lines and double-check for typos:</p><pre class="calibre30">if_bridge_load="YES"
bridgestp_load="YES"
if_tap_load="YES"</pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Save and exit.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Add a single line to the <span class="docEmphasis1">sysctl.conf</span> file in <span class="docEmphasis1">/etc</span> to automatically apply the <tt class="calibre20">up</tt> flag to the <tt class="calibre20">tap0</tt> interface when the OpenVPN daemon opens it. To do so, open <span class="docEmphasis1">sysctl.conf</span> like so:</p><pre class="calibre30"># <b class="calibre28">ee /etc/sysctl.conf</b></pre><br class="calibre1"/>
<p class="docText1">and add the following line:</p><pre class="calibre30">net.link.tap.up_on_open=1</pre><br class="calibre1"/>
<p class="docText1">Save and exit.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Add the OpenVPN startup lines and bridge statements to the <span class="docEmphasis1">rc.conf</span> file in <span class="docEmphasis1">/etc</span>. Open <span class="docEmphasis1">rc.conf</span>:</p><pre class="calibre30"># <b class="calibre28">ee /etc/rc.conf</b></pre><br class="calibre1"/>
<p class="docText1">and add the following lines (replace <tt class="calibre20"><i class="docEmphasis1">ed0</i></tt> with the device name of your network interface):</p><pre class="calibre30">openvpn_enable="YES"
cloned_interfaces="bridge0 tap0"
ifconfig_bridge0="addm ed0 addm tap0"</pre><br class="calibre1"/>
<p class="docText1">Save, exit, and reboot.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="that it" class="calibre8" id="that it"/>Retest OpenVPN by reconnecting with a client system to confirm that it starts properly.</p></div></li></ol></div>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="config_files-id18" class="calibre8" id="config_files-id18"/>
<h3 class="docSection1Title" id="-100000">19.9. CONFIG FILES</h3>
<p class="docText1"><span class="b">/usr/local/etc/openvpn/openvpn.conf</span><a name="IDX-CHP-19-0299" class="calibre8" id="IDX-CHP-19-0299"/><a name="IDX-CHP-19-0300" class="calibre8" id="IDX-CHP-19-0300"/><a name="IDX-CHP-19-0301" class="calibre8" id="IDX-CHP-19-0301"/><a name="IDX-CHP-19-0302" class="calibre8" id="IDX-CHP-19-0302"/></p>
<p class="docText1"><a name="Main configuration" class="calibre8" id="Main configuration"/>Main configuration file</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="log_files-id11" class="calibre8" id="log_files-id11"/>
<h3 class="docSection1Title" id="-100000">19.10. LOG FILES</h3>
<p class="docText1"><span class="b">/var/log/messages</span></p>
<p class="docText1"><a name="Contains output" class="calibre8" id="Contains output"/>Contains output from OpenVPN</p>
<p class="docText1"><span class="b">/usr/local/etc/openvpn/openvpn-status.log</span></p>
<p class="docText1"><a name="status of" class="calibre8" id="status of"/>Shows the status of current connections updated every minute</p>
<p class="docText1"><span class="b">/usr/local/etc/openvpn/ipp.txt</span></p>
<p class="docText1">Records client virtual IP addresses</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="notes-id14" class="calibre8" id="notes-id14"/>
<h3 class="docSection1Title" id="-100000">19.11. NOTES</h3>
<p class="docText1"><a name="When you" class="calibre8" id="When you"/>When you are ready to configure an OpenVPN client, you will need these four files on the client system:</p>
<ul class="calibre15"><li class="calibre16"><p class="docText1"><a name="public CA" class="calibre8" id="public CA"/>The OpenVPN public CA certificate file (<span class="docEmphasis1">openvpn-CAcert.pem</span>)</p></li><li class="calibre16"><p class="docText1">The client certificate (<span class="docEmphasis1">client01-cert.pem</span>)</p></li><li class="calibre16"><p class="docText1">The client private key (<span class="docEmphasis1">client01-key.pem</span>)</p></li><li class="calibre16"><p class="docText1">A client OpenVPN configuration file (example below)</p></li></ul>
<p class="docText1"><a name="first three" class="calibre8" id="first three"/>You should already have the first three files (we created them earlier). The fourth file is a modification of the <span class="docEmphasis1">openvpn.conf</span><a name="used to" class="calibre8" id="used to"/> file we used to configure the server above.<a name="IDX-CHP-19-0303" class="calibre8" id="IDX-CHP-19-0303"/></p>
<p class="docText1"><a name="a copy" class="calibre8" id="a copy"/>Listed below is a copy of a client version of the <span class="docEmphasis1">openvpn.conf</span><a name="this chapter" class="calibre8" id="this chapter"/> that would work with the server configuration in this chapter (change the items shown in italics to match your configuration):</p>
<pre class="calibre30">client
dev tap
proto udp
remote <tt class="calibre20"><i class="docEmphasis1">host.example.com</i></tt> 1194
resolv-retry infinite
persist-key
persist-tun
ca <tt class="calibre20"><i class="docEmphasis1">openvpn-CAcert.pem</i></tt>
cert <tt class="calibre20"><i class="docEmphasis1">client01-cert.pem</i></tt>
key <tt class="calibre20"><i class="docEmphasis1">client01-key.pem</i></tt>
comp-lzo
verb 3</pre>
<p class="docText1"><a name="the same" class="calibre8" id="the same"/>You should keep these four files in the same directory on the client system.</p>
<p class="docText1"><a name="installation details" class="calibre8" id="installation details"/>See the documentation from your specific client application for additional installation details. The OpenVPN website has a list of popular OpenVPN client GUIs for different platforms at <a class="calibre2" target="_blank" href="http://openvpn.net/gui.html">http://openvpn.net/gui.html</a>.</p>
</div></div>

</body></html>