<html><head></head><body><div class="preface" title="INTRODUCTION"><div class="titlepage"><div><div><h1 class="title"><a id="introduction"/>INTRODUCTION</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject_d1e240"/><img alt="image with no caption" src="httpatomoreillycomsourcenostarchimages651574.png.jpg"/></div></div><p>Network administrators of all backgrounds share one underlying, overwhelming desire. It doesn't matter if you manage a network with 400 separate manufacturing plants connected by a global MPLS mesh or if you're responsible for three computers and an elderly printer. Network administrators all share an abiding and passionate desire for just one thing: We want our users to shut up.<a class="indexterm" id="IDX-PREFACE-0002"/></p><p>Blaming the network is easy. The network touches everything. Businesses assume that the network will work perfectly and make decisions accordingly. A user can't open that 900MB Excel spreadsheet on the file server on another continent from his 20th-century PC? Network problem. A website in Farawayistan is slow? Network problem. A user can't get a faster response over a 33.6Kbps modem? Network problem. In general, users don't care about trivialities such as the cost of bandwidth, the physical layout of transcontinental fiber, or the speed of light. They want the network to work the way they think it should.</p><p>This problem is exacerbated by the network's invisibility. Routers and switches are black boxes. You feed cables to the network, and it gives connectivity back. Traditionally, servers have much better activity logging and reporting than network devices. Sysadmins can write scripts to announce when a server process fails and try to remedy the situation, but very few network administrators have equipment that can monitor or repair itself. The usage information stored on a network device shows only the last few minutes at best. When a user reports an application failure, many systems administrators check their logs and report, "I have no problems. It must be the network." More sophisticated network administrators have traffic measurement tools such as MRTG, CiscoWorks, or OpenView, but these don't prove a network has no problems. They merely show whether the network has or lacks the particular set of problems that the software can report. The lack of media errors on a switch's uplink port says nothing about TCP/IP errors or firewall issues. With such minimal logging, blaming the network becomes very easy and hard to disprove.<a class="indexterm" id="IDX-PREFACE-0003"/><a class="indexterm" id="IDX-PREFACE-0004"/><a class="indexterm" id="IDX-PREFACE-0005"/><a class="indexterm" id="IDX-PREFACE-0006"/><a class="indexterm" id="IDX-PREFACE-0007"/></p><p>In addition, modern-day network administrators typically have no formal certification or training process. The days of needing a computer science degree to manage a network are long gone. What network administration certifications exist are frequently for systems administration. An "operating system vendor-certified" network administrator is actually certified in the services that the operating system offers to the network, not the network itself. When you study for a Microsoft DHCP Server certification, for example, you learn some things about networking but a whole lot more about that particular DHCP implementation. Network service management is a useful skill, mind you, but it's not the same as managing the lowest level of the network. Network administrators learn the hard way—and it's a very hard way indeed.<a class="indexterm" id="IDX-PREFACE-0008"/></p><p>This is a shame, because network administrators can claim a powerful role in any organization. The network administrator can help resolve almost every technical issue. The network administrator can make himself an invaluable, indispensable, and irreplaceable component of the organization. A network administrator who masters the tools, understands the protocols, and restrains his natural contempt for the lesser minds surrounding him will not be fired until the company dissolves around him.<a class="indexterm" id="IDX-PREFACE-0009"/></p><p>Some network administrators understand this and are always ready to help. If a user or sysadmin reports an issue, this network admin is always ready to leap in with a packet analyzer or firewall log and offer insights. This is great customer service, <span class="emphasis"><em>if</em></span> the user can replicate the problem at the time the network administrator is watching. Replicating problems consumes endless time and makes everyone involved testy.</p><p>What if you had a tool that could tell you specifically what happened on the network yesterday or last week or last year? Imagine being able to precisely identify the network impact of server and hardware changes. Suppose you could tell systems administrators exactly what bogus traffic their new server transmitted? Just for a moment, dream about being able to categorically and without risk of repudiation state, "That problem was not the network." Then think about doing all that by taking advantage of your existing equipment.</p><p>Network flow analysis lets you do exactly that. Perhaps you won't completely silence your users—nothing short of divine intervention can manage that. But you can identify problems on your network before they happen. You can answer questions authoritatively, definitively, and decisively. People will no longer automatically blame the network. Your work will become less stressful because you will no longer <span class="emphasis"><em>think</em></span> you know what happened. You'll <span class="emphasis"><em>know</em></span>.<a class="indexterm" id="IDX-PREFACE-0010"/><a class="indexterm" id="IDX-PREFACE-0011"/><a class="indexterm" id="IDX-PREFACE-0012"/><a class="indexterm" id="IDX-PREFACE-0013"/></p><p>This book will take network administrators through building a flow-based network management system out of any free Unix-like operating system, freely available software, and existing network hardware.</p><div class="sect1" title="Network Administration and Network Management"><div class="titlepage"><div><div><h1 class="title"><a id="network_administration_and_network_manag"/>Network Administration and Network Management</h1></div></div></div><p>What's the difference between a network administrator and a network manager?</p><p><span class="emphasis"><em>Network administration</em></span> involves configuring hardware, phoning tech support, and running cables. <span class="emphasis"><em>Network management</em></span> involves making decisions about the network. Network managers usually start off as network administrators and may still perform network administration duties, but their technical knowledge guides managerial decisions.</p><p>Although changing your job title requires intervention from management, any network administrator can transform into a network manager by doing the work required. You're in charge of your equipment, and you can probably scrounge up access to some computing resources somewhere. The most difficult investment will be your time. Once you start providing fact-based answers and diagnoses, however, people will notice the change. Over time, company management will start involving you in decisions about the network or even seek your advice about business processes built on top of the network, making you the de facto network manager no matter what your business card says.</p></div></div>
<div class="sect1" title="Network Management Tools"><div class="titlepage"><div><div><h1 class="title"><a id="network_management_tools"/>Network Management Tools</h1></div></div></div><p>These are some pretty heady claims for a network management system, especially if you are familiar with existing network management tools. Many people are justifiably proud of their extensive network management systems. Let's take a look at some of the popular free network management tools and see how they fit together and how flow analysis can improve on them.<a class="indexterm" id="IDX-PREFACE-0014"/></p><div class="sect2" title="MRTG, Cricket, and Cacti"><div class="titlepage"><div><div><h2 class="title"><a id="mrtg_comma_cricket_comma_and_cacti"/>MRTG, Cricket, and Cacti</h2></div></div></div><p>MRTG, Cricket, and Cacti use SNMP to generate graphs of network traffic across device interfaces and store the results in a fixed-size database. Knowing how much traffic crosses your network at any time is an absolute necessity, and I make heavy use of such tools myself. The fixed-size databases mean that you don't need to worry about database administration; they're easy to set up, and they quickly produce useful information.<a class="indexterm" id="IDX-PREFACE-0015"/><a class="indexterm" id="IDX-PREFACE-0016"/><a class="indexterm" id="IDX-PREFACE-0017"/></p><p>Knowing that your circuits are full explains why connectivity is slow, but the obvious next question is "full of what?" MRTG-style tools cannot answer that question. Flows can. Also, these tools normally use five-minute averages of traffic. They obscure brief spikes and valleys. Finally, these tools compress historical data into long-term averages. If you want to know the details of traffic six months ago, you must either extensively reconfigure these tools or use another tool.<a class="indexterm" id="IDX-PREFACE-0018"/><a class="indexterm" id="IDX-PREFACE-0019"/><a class="indexterm" id="IDX-PREFACE-0020"/><a class="indexterm" id="IDX-PREFACE-0021"/><a class="indexterm" id="IDX-PREFACE-0022"/></p></div><div class="sect2" title="RTG"><div class="titlepage"><div><div><h2 class="title"><a id="rtg"/>RTG</h2></div></div></div><p>Like the previous tools, RTG uses SNMP to measure network traffic crossing device interfaces and graphs the data. Unlike MRTG and its descendants, RTG measures much briefer intervals of traffic and stores each individual result in a database. It provides much more detailed visibility into traffic congestion. If you want to see how traffic has varied on a network interface throughout a single minute, RTG is your friend. You can also perform detailed comparisons with historical data.</p><p>The presence of a database means that you must either know something about databases or have an infinite amount of disk space. Also, RTG can't show you the contents of the traffic, only how much there was. It resolves one problem with MRTG-style tools but not the others.</p></div><div class="sect2" title="Nagios and Big Brother"><div class="titlepage"><div><div><h2 class="title"><a id="nagios_and_big_brother"/>Nagios and Big Brother</h2></div></div></div><p>If you step away from measuring the quantity of traffic, you also need to check the health of your network gear. Free software such as Nagios and Big Brother is very useful in this regard; you can get an alarm when a switch's redundant power supply fails, when a port starts spewing CRC errors, or when a switch reboots itself. You must have this information to maintain a reliable network.<a class="indexterm" id="IDX-PREFACE-0023"/><a class="indexterm" id="IDX-PREFACE-0024"/></p><p>Knowing that your hardware is operating correctly is vital, but the fact that a switch is operating correctly doesn't mean that the traffic passing through it isn't having trouble. A functional switch or router will transmit undesirable traffic just as reliably as desirable traffic.</p></div><div class="sect2" title="CiscoWorks, OpenView, and More"><div class="titlepage"><div><div><h2 class="title"><a id="ciscoworks_comma_openview_comma_and_more"/>CiscoWorks, OpenView, and More</h2></div></div></div><p>Then you have the commercial network management suites. Most of these products are either tool kits with pretty frontends or limited to simple networks. These tools are seductive. They look like anyone can use them. But these tools often want to control your entire computing infrastructure, from router to desktop, and attempts to deploy them in production usually fail.<a class="indexterm" id="IDX-PREFACE-0025"/></p><p>What most people don't realize is that by the time you've set up these software suites to work the way you need, you've done just as much work as you would through building your own flow analysis system. You have had the satisfaction of giving some other company money that rightfully belongs in your pocket, however. (It's the boss's money, you say? Get a price quote for the commercial stuff. During your performance review, tell your manager that you got the same results without spending that cash and you'd like a slice of it. It's more likely to work than asking for a raise after spending that money.)<a class="indexterm" id="IDX-PREFACE-0026"/></p></div></div>
<div class="sect1" title="Enough Griping: What's the Solution?"><div class="titlepage"><div><div><h1 class="title"><a id="enough_griping_colon_what_apostrophy_s_t"/>Enough Griping: What's the Solution?</h1></div></div></div><p>Resolved: Network administration sucks. The tools are all inadequate, expensive, or both. How do you escape this pit? <span class="emphasis"><em>You record the traffic that passes across your network</em></span>.</p><p>Yes, this is a tall order. Fortunately, you don't have to record the entire contents of every network transaction. For a moment, think about the duties of a network administrator. Part of your responsibilities include providing network services, such as DNS and DHCP. You probably have to feed your proxy server every few days and dust the script kiddies out of the intrusion detection system each Monday morning. But set aside the services that run on the network for a moment, and consider the base network.</p><p>The network exists to carry traffic from one host to another. That's it. The network administrator makes that happen.</p><p>Perhaps you're the only IT person at your company, and you are also responsible for everything else. Most of the time, however, network administrators work on a team with system administrators, a database administrator or two, a help desk, and other IT professionals. In this case, the network administrator's responsibility is to deliver packets in a timely manner. Successful delivery of those packets completes your responsibilities.</p><p>Being able to prove that packets arrived at their destination and were accepted will completely change your relationship with your co-workers. All of a sudden, you have <span class="emphasis"><em>proof</em></span>. The network is no longer something that indiscriminately accepts the blame whenever something goes askew. Some of the errors will be your responsibility, of course. But many won't, and there's nothing like the glorious feeling of conclusively demonstrating for the very first time that not only is a problem not yours, but you can rigorously demonstrate where the problem lies. (The trick here lies in not alienating those same co-workers with said proof, but I'll talk about that later.)</p><p>You don't need a complete record of the contents of traffic to demonstrate your point. All you need is proof that successful network-level communication occurred between hosts. If a user cannot display a page on your internal web server, for example, you don't need a full record of the contents of the network connections between the user's desktop and the server. You only need a record that a network conversation occurred between the client and the server, that the network carried data between the two, and that the conversation concluded normally and without error at the network level. You don't need to record every individual image or chunk of text in that conversation. That's not the network administrator's responsibility. Proving that the network carried web traffic between the client and the server demonstrates that the network functioned correctly. Mind you, as the network administrator, you're still on the hook for helping solve the problem; it's just that nobody will be blaming you as you work.</p></div>
<div class="sect1" title="Flow-Tools and Its Prerequisites"><div class="titlepage"><div><div><h1 class="title"><a id="flow-tools_and_its_prerequisites"/>Flow-Tools and Its Prerequisites</h1></div></div></div><p>Flow-tools is the standard freely available flow management and analysis tool kit. Although you can find many other tools for flow management, flow-tools has been around for the longest time and is the most widely deployed free toolkit. Many people have written flow analysis interfaces based on flow-tools, and I'll cover several of them in this book.<a class="indexterm" id="IDX-PREFACE-0027"/><a class="indexterm" id="IDX-PREFACE-0028"/><a class="indexterm" id="IDX-PREFACE-0029"/><a class="indexterm" id="IDX-PREFACE-0030"/></p><p>Flow-tools is written for Unix-like systems such as Linux, OpenSolaris, various BSDs, commercial options such as AIX, and many others. My reference platform is FreeBSD, but everything in this book also works on Linux. You might have difficulties using more challenging or unique platforms. This book provides examples of the commands for the flow management tools, but you must know how to invoke superuser privilege, navigate the file system, and so on.<a class="indexterm" id="IDX-PREFACE-0031"/><a class="indexterm" id="IDX-PREFACE-0032"/></p><p>Much of this software uses Perl. You don't need to write your own Perl, but you'll need to edit Perl scripts to set variables such as your company name and your IP addresses. Some flow software includes specific Perl hooks, and I'll cover them for Perl aficionados.<a class="indexterm" id="IDX-PREFACE-0033"/></p><p>If you want to perform ad hoc reporting of flow data with flow-tools, you'll want a plotting program. I discuss <code class="literal">gnuplot</code>. You'll be most comfortable using <code class="literal">gnuplot</code> if you have an X server installed on your desktop, but that's not mandatory.<a class="indexterm" id="IDX-PREFACE-0034"/><a class="indexterm" id="IDX-PREFACE-0035"/><a class="indexterm" id="IDX-PREFACE-0036"/></p><p>In addition, to use flow-tools, you must understand Unix epoch time. Epoch time is the number of seconds since 00:00:00 on January 1, 1970, in the UTC time zone. Any number of websites offer epoch-to-date converters. You can convert epoch seconds to a date on the command line with the <code class="literal">date</code> command, but the syntax varies among Unix-like operating systems.<a class="indexterm" id="IDX-PREFACE-0037"/><a class="indexterm" id="IDX-PREFACE-0038"/></p><p>Speaking of time, having good time on your network will enhance your network management capabilities. Therefore, I recommend installing and using Network Time Protocol. Use authoritative time sources for your network. If the timestamps in your server logs match the timestamps in your network traffic records, your analysis will be much easier.</p><p>Flows can include Border Gateway Protocol (BGP) information. I discuss how to manage flow BGP data, but those explanations assume basic BGP knowledge. If you don't use BGP, your flow data will not contain any BGP data. You can safely skip discussions of BGP-based flow data.<a class="indexterm" id="IDX-PREFACE-0039"/></p><p>Finally, you must understand networking. If you don't have a strong grip on networking fundamentals now, however, you'll have one by the time you finish your flow management implementation.</p></div>
<div class="sect1" title="Flows and This Book"><div class="titlepage"><div><div><h1 class="title"><a id="flows_and_this_book"/>Flows and This Book</h1></div></div></div><p>Before you can manage your network with flow information, you must understand how flows work, where the data comes from, how it is gathered and processed, and the strengths and limitations of flow-based management. <a class="xref" href="ch01.html" title="Chapter 1. FLOW FUNDAMENTALS">Chapter 1</a> introduces flows.</p><p>Many routers and switches can perform <span class="emphasis"><em>flow export</em></span>, where the hardware tracks flow data and transmits it to a management system. If your hardware cannot export flows, you can perform flow export in software. <a class="xref" href="ch02.html" title="Chapter 2. COLLECTORS AND SENSORS">Chapter 2</a> discusses flow export and how to configure it in both hardware and software, as well as how to collect those flow records from many different network devices using the industry-standard flow-tools software package.<a class="indexterm" id="IDX-PREFACE-0040"/><a class="indexterm" id="IDX-PREFACE-0041"/></p><p><a class="xref" href="ch03.html" title="Chapter 3. VIEWING FLOWS">Chapter 3</a> teaches you how to view the flow records you've gathered. Flow records contain vast amounts of information, and choosing the proper viewing format will help you get the insight you need.</p><p>Flow records include all the traffic that passes over your network, but you'll often be interested only in very specific information, such as the traffic over a particular circuit or to a certain host. <a class="xref" href="ch04.html" title="Chapter 4. FILTERING FLOWS">Chapter 4</a> demonstrates filtering flows to display only interesting data.</p><p>At times you'll be interested in reporting on the aggregated flow data rather than individual flows. What hosts sent the most traffic? What are the most popular UDP ports on your network? Which hosts connect to the most other hosts? Flow-tools supports a wide variety of reports, which I'll cover in <a class="xref" href="ch05.html" title="Chapter 5. REPORTING AND FOLLOW-UP ANALYSIS">Chapter 5</a>.</p><p>Another common requirement is for simple visualization of network traffic; in other words, presenting the flow records in graphical format. <a class="xref" href="ch06.html" title="Chapter 6. PERL, FLOWSCAN, AND CFLOW.PM">Chapter 6</a> covers FlowScan, web-based software that offers traffic graphs to your users. It also covers the <code class="literal">Cflow.pm</code> Perl module used to write FlowScan so you can write your own flow analysis software if you're so inclined.<a class="indexterm" id="IDX-PREFACE-0042"/></p><p>Although FlowScan works well for users, network administrators need something more powerful. <a class="xref" href="ch07.html" title="Chapter 7. FLOWVIEWER">Chapter 7</a> covers FlowViewer, another web-based tool that lets you deeply dissect your traffic.</p><p>Web-based software can handle many network visualization tasks, but automating visuals and graphing ad hoc data aren't among them. At times, you'll need to prepare graphs that show today's traffic compared to last week's or last year's. In <a class="xref" href="ch08.html" title="Chapter 8. AD HOC FLOW VISUALIZATION">Chapter 8</a>, you'll use <code class="literal">gnuplot</code> to create graphs of truly arbitrary flow data.</p><p>Finally, <a class="xref" href="ch09.html" title="Chapter 9. EDGES AND ANALYSIS">Chapter 9</a> discusses some flow collection edge cases and talks about how you can use flow records to proactively improve your network.</p><p>Before doing all the advanced stuff, however, let's take a deep, hard look at flows in <a class="xref" href="ch01.html" title="Chapter 1. FLOW FUNDAMENTALS">Chapter 1</a>.</p></div></body></html>