- en: Chapter 15\. NTP SERVER 4.2.2
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[HTTP://NTP.ISC.ORG](HTTP://NTP.ISC.ORG)'
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 15.1\. SUMMARY
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: NTP (Network Time Protocol) is an Internet protocol used for synchronizing the
    clocks of networked computers. Computer clock accuracy is instrumental in providing
    a consistent reference for system log files, email timestamps, time-activated
    scripts, and so on. The NTP system is capable of keeping your computer's clock
    accurate to within a few milliseconds of an accurate time server. Time servers
    are usually connected directly to a source of accurate time (e.g., atomic or GPS
    clocks).
  prefs: []
  type: TYPE_NORMAL
- en: The NTP system consists of a hierarchy, or strata, of public and private servers.
    A stratum 1 server synchronizes its clock with an accurate external GPS (Global
    Positioning System) clock, radio clock, or other highly accurate time-keeping
    device. A stratum 2 server derives its clock data from one or more stratum 1 servers,
    a stratum 3 server derives its clock data from one or more stratum 2 servers,
    and so on. Servers at the lower stratum levels (numerically speaking) are not
    necessarily more accurate. The accuracy of the time source, geographic location,
    and network latency all contribute to the accuracy of a time server.
  prefs: []
  type: TYPE_NORMAL
- en: A server running the NTP daemon periodically synchronizes its clock to one or
    more established time servers. Over time, the NTP daemon calculates the system-specific
    clock error. If the system temporarily loses Internet connectivity, the NTP daemon
    will keep the system clock accurate using this error (or clock drift) data until
    it can re-synchronize with a time server.
  prefs: []
  type: TYPE_NORMAL
- en: David Mills, a professor at the University of Delaware, originally developed
    NTP in the early '80s. NTP was initially named the Internet Clock Service and
    was created to provide clock synchronization for the HELLO routing protocol. These
    early versions of NTP were less accurate than today's because they did not have
    any frequency correction abilities. Mills, along with a team of volunteers, continues
    to develop NTP.
  prefs: []
  type: TYPE_NORMAL
- en: 15.2\. RESOURCES
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: NTP Documentation Index
  prefs: []
  type: TYPE_NORMAL
- en: '[http://ntp.isc.org/bin/view/Main/DocumentationIndex](http://ntp.isc.org/bin/view/Main/DocumentationIndex)'
  prefs: []
  type: TYPE_NORMAL
- en: RFC 4330 - Network Time Protocol Version 4
  prefs: []
  type: TYPE_NORMAL
- en: '[http://tools.ietf.org/html/rfc4330](http://tools.ietf.org/html/rfc4330)'
  prefs: []
  type: TYPE_NORMAL
- en: 15.3\. REQUIRED
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '![](OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg) FreeBSD 7.0-RELEASE
    (see "[FreeBSD 7.0](freebsd_7.0_split_000.html#freebsd_7.0)")'
  prefs: []
  type: TYPE_IMG
- en: '![](OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg) Updated ports
    collection (see "[FreeBSD Ports Collection](freebsd_ports_collection.html#freebsd_ports_collection)")'
  prefs: []
  type: TYPE_IMG
- en: '![](OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg) Internet
    connection'
  prefs: []
  type: TYPE_NORMAL
- en: 15.4\. OPTIONAL
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '![](OWlnMmQvN2ZtYXI4dGMvaWVnL3MxOTU5MzE0NTdwc3BuVTAvLjNnMA--.jpg) Registered
    domain name'
  prefs: []
  type: TYPE_NORMAL
- en: 15.5\. PREPARATION
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Become the superuser.
  prefs: []
  type: TYPE_NORMAL
- en: 15.6\. INSTALL
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Although NTP 4.2.0 is included in the standard FreeBSD 7.0 distribution, we
    will install an updated version of NTP from the ports collection. Enter the following
    commands to begin the installation:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 15.7\. CONFIGURE
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Once the installation process is complete, it's time to configure NTP for use
    on your system.
  prefs: []
  type: TYPE_NORMAL
- en: Change the default search path. FreeBSD's base version of NTP uses the same
    filenames as the version we installed from the ports system. If the search path
    has not been changed from its default, NTP-related commands will run the FreeBSD
    base version rather than the new version from ports. See "[Default Search Path](configure.html#default_search_path)"
    for details on changing the default search path.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Create a drift file for storing clock correction data. The following command
    creates this file in the /etc/ntp directory:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Select appropriate time servers for synchronization. Visit [http://ntp.isc.org/bin/view/Servers/StratumTwoTimeServers](http://ntp.isc.org/bin/view/Servers/StratumTwoTimeServers)
    for an updated list of public time servers. Select at least three servers from
    the list. Pick servers that are listed as OpenAccess and located in your geographic
    vicinity.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '* * *'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '***Note:*** See NTP''s web page on Rules of Engagement for recommendations
    on selecting time servers: [http://support.ntp.org/bin/view/Servers/RulesOfEngagement](http://support.ntp.org/bin/view/Servers/RulesOfEngagement).'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '* * *'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Create a new configuration file named ntp.conf:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'and add the following configuration options:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Replace the hostnames of the servers (in italics) with those you have picked.
    The `iburst` modifier allows the NTP daemon to speed up initial synchronization.
    The `driftfile` statement tells the NTP daemon where to look for the drift file
    (created in step 2). The `logfile` statement directs the NTP daemon to store the
    log file in the /var/log directory. Save and exit.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 15.8\. TESTING
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In this section, we'll perform some basic tests to confirm that NTP synchronizes
    time data properly.
  prefs: []
  type: TYPE_NORMAL
- en: 'To start the NTP daemon automatically at boot time, open /etc/rc.conf:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'and add the following lines:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Start the NTP daemon and begin system time synchronization:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Wait about 10 minutes, and then execute the following command to check the
    status of the time synchronization:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'You should see results similar to the following:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '* * *'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '***Note:*** The last line in the above output is an example of a peer that
    is not reachable or is not working properly. The `*jitter*` value will usually
    be 4000.00 and `*stratum*` will be 16, with zeros for `*delay*` and `*offset*`.'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '* * *'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'The elements of the above output are described below:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The hostname of the peer (time server). The hostname preceded by an asterisk
    indicates the server selected for synchronization.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The type of time-keeping device in use by the corresponding peer. Since the
    time servers above are stratum 2 servers, they list the IP addresses of the servers
    supplying their time.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The stratum of the peer, ranging from 1 to 16.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The type of peer (`u` = unicast, `m` = multicast).
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: How long ago the peer was heard from in seconds.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The frequency, in seconds, with which the NTP daemon is synchronizing with the
    peer.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The status, in octal format, of the reachability register. This value will stabilize
    at 377 if the last 8 attempts to synchronize with each time server were successful
    (it takes about 10 minutes to reach this value).
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The roundtrip packet delay time in milliseconds (smaller is better).
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The difference, in milliseconds, between the system time and the remote peer's
    time. A negative value here indicates that the clock of the local system is behind
    that of the remote peer's, while a positive value indicates milliseconds ahead.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The variation, in milliseconds, of the offset (smaller is better).
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Check to make sure your time server is answering NTP requests properly with
    this command:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Code View:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: If you are synchronizing with stratum 2 servers your server will indicate stratum
    3 as shown.
  prefs: []
  type: TYPE_NORMAL
- en: 15.9\. CONFIG FILES
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: /etc/ntp.conf
  prefs: []
  type: TYPE_NORMAL
- en: The main configuration file for ntpd
  prefs: []
  type: TYPE_NORMAL
- en: 15.10\. LOG FILES
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: /var/log/ntp.log
  prefs: []
  type: TYPE_NORMAL
- en: The NTP daemon records time synchronization messages to this file.
  prefs: []
  type: TYPE_NORMAL
- en: /var/log/messages
  prefs: []
  type: TYPE_NORMAL
- en: The NTP daemon records its status in this file.
  prefs: []
  type: TYPE_NORMAL
- en: /etc/ntp/drift
  prefs: []
  type: TYPE_NORMAL
- en: The NTP daemon stores clock correction values to this file.
  prefs: []
  type: TYPE_NORMAL
- en: 15.11\. NOTES
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The drift file specified in step 2 of "Configure" (page 108) is automatically
    updated once per hour with the frequency offset (clock error) computed by the
    NTP daemon. It is important that the empty file be created as outlined in step
    2; the NTP daemon will not automatically create the file. If the drift file does
    not exist, the NTP daemon will assume an error of zero and will take about 15
    minutes to complete initial synchronization and enter a stabilized state or normal
    mode.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'If you want to synchronize the clock of your server and deny all client requests
    to the NTP server, add the following lines to ntp.conf in /etc:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: '***Note:*** Replace the hostnames in italics with the hostnames of the time
    servers you configured in step 4 of "Configure." You cannot use NTP pool servers
    here because pool servers assign NTP server addresses dynamically.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: 'If you wish to allow NTP services to the local network only, add this line
    to the ntp.conf file in /etc:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: '***Note:*** This line is an addition to the four restrict statements above.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: Change the IP address and subnet (in italics) to match your network configuration.
    The example above would allow systems with an IP address of 192.168.1.X to synchronize
    with your NTP server.
  prefs: []
  type: TYPE_NORMAL
