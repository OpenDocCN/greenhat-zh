<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;PLOTTING MARKERS AND MESSAGE BOXES"><div class="titlepage"><div><div><h1 class="title"><a id="plotting_markers_and_message_boxes"/>Chapter 2. PLOTTING MARKERS AND MESSAGE BOXES</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e1559"/><img src="httpatomoreillycomsourcenostarchimages671943.png.jpg" alt="image with no caption"/></div></div><p>Creating simple maps is a cool and useful way to see the area around a location, but you'll find creating maps even more fun and useful when you plot your own points on a map. Using mapping APIs you can overlay small graphics to call attention to locations (determined by latitude and longitude coordinates). Optionally, you can create messages that describe a location when the marker is clicked.</p><p>You've seen these principles in action on just about any chain store's website, among many others. If you're looking to shop in person, you've probably used the Find a Store link. From there, you enter your city, ZIP Code, address, or some other determination of your location. Then a map appears showing the closest stores, with each store's location marked, often with a number that matches a results list. If the number is clickable, you will likely find that store's address, telephone number, or other information.<a id="IDX-CHP-2-0001" class="indexterm"/><a id="IDX-CHP-2-0002" class="indexterm"/><a id="IDX-CHP-2-0003" class="indexterm"/><a id="IDX-CHP-2-0004" class="indexterm"/></p><p>This chapter will get you started creating tools like store locators. You will learn to add markers, create custom icons, show messages in hovering boxes, and more. Mapping providers implement similar, but slightly different ways, of plotting markers on your map. Mapstraction wrangles these differences into a single set of functions that can add markers and message boxes no matter the underlying map type.<a id="IDX-CHP-2-0005" class="indexterm"/></p><div class="sect1" title="#1: Add a Marker to Your Map"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_1_colon_add_a_marker_to"/>#1: Add a Marker to Your Map</h1></div></div></div><p>The basic marker is a staple of web maps. Markers bring the user's attention to one or more points on the map. For many projects, you won't need to get any more complicated than a map and a handful of basic markers.</p><p>Although we'll be using Mapstraction to produce our markered maps, the underlying work is being done by whichever mapping service we're using. Just like the look of the map is determined by the provider, so will the default style of the basic marker. <a class="xref" href="ch02.html#default_markers_from_different_providers" title="Figure 2-1. Default markers from different providers: Google, Yahoo!, and Microsoft">Figure 2-1</a> shows the differences among the markers from major map services.</p><div class="figure"><a id="default_markers_from_different_providers"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject2_d1e1603"/><img src="httpatomoreillycomsourcenostarchimages671967.png.jpg" alt="Default markers from different providers: Google, Yahoo!, and Microsoft"/></div></div><p class="title">Figure 2-1. Default markers from different providers: Google, Yahoo!, and Microsoft</p></div><p>To add a simple marker to your map, you just need to use two Mapstraction functions. First, create the marker. Next, add it to the map. The reason for these two distinct steps will become clear in further projects when we start to use advanced options, such as custom marker icons.</p><p>Let's see what creating the marker looks like in code. Start with the basic Mapstraction map you created in <a class="xref" href="ch01s03.html#create_a_mapstraction_map" title="Create a Mapstraction Map">Create a Mapstraction Map</a> in <a class="xref" href="ch01s03.html#create_a_mapstraction_map" title="Create a Mapstraction Map">Create a Mapstraction Map</a>, and add these lines to the <code class="literal">create_map()</code> function:</p><a id="I_programlisting2_d1e1619"/><pre class="programlisting">marker = new mxn.Marker(new mxn.LatLonPoint(37.7740486,-122.4101883));
// marker options will go here
mapstraction.addMarker(marker);</pre><p>The first line creates a marker object, passing latitude/longitude coordinates for the No Starch Press offices in San Francisco. Remember this is the same point we used as the center of our map in <a class="xref" href="ch01.html" title="Chapter 1. MAPPING BASICS">Chapter 1</a>. By drawing attention to the graphical marker, we are essentially marking that spot as important.<a id="IDX-CHP-2-0006" class="indexterm"/><a id="IDX-CHP-2-0007" class="indexterm"/></p><p>The second line is a placeholder for any marker options we want to add later. (Any JavaScript line that begins with two slashes is a comment, and the browser ignores them.) The marker options are where we tell Mapstraction which icon to use or add a message to be displayed when the marker is clicked.</p><p>Finally, the third line adds the marker to the map. Once this happens, no additional options can be added. The reason is that the marker object is used only by Mapstraction. Once the marker is added to the map, however, Mapstraction makes the appropriate calls to the mapping provider. Mapstraction plots the marker based on all options set beforehand. In this case, we don't have options to add, but we'll add to this map in future projects.</p><p>If you're using Google as your mapping provider, your new map will look like <a class="xref" href="ch02.html#google_map_with_a_simple_marker" title="Figure 2-2. Google map with a simple marker">Figure 2-2</a>. The default Google icon sits in the center of the map. Although the marker is clickable, this marker is very simple and nothing actually happens if you click it. Read on to learn other cool things you can do with markers.</p><div class="figure"><a id="google_map_with_a_simple_marker"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject2_d1e1647"/><img src="httpatomoreillycomsourcenostarchimages671969.png.jpg" alt="Google map with a simple marker"/></div></div><p class="title">Figure 2-2. Google map with a simple marker</p></div></div></div>
<div class="sect1" title="#2: Remove or Hide a Marker"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_2_colon_remove_or_hide_a_m"/>#2: Remove or Hide a Marker</h1></div></div></div><p>Once your map has markers, you may wish to remove them from the map selectively. You might replace the current markers with new results. Or maybe the user added a filter that does not include the current marker. Mapstraction provides three functions to make markers disappear and reappear. Though <span class="emphasis"><em>removing</em></span> and <span class="emphasis"><em>hiding</em></span> may sound like similar terms, understanding the differences between them is important. Removing a marker from a map means the marker is gone for good. Simply hiding the marker allows you to make it visible again.<a id="IDX-CHP-2-0008" class="indexterm"/><a id="IDX-CHP-2-0009" class="indexterm"/><a id="IDX-CHP-2-0010" class="indexterm"/><a id="IDX-CHP-2-0011" class="indexterm"/><a id="IDX-CHP-2-0012" class="indexterm"/><a id="IDX-CHP-2-0013" class="indexterm"/><a id="IDX-CHP-2-0014" class="indexterm"/><a id="IDX-CHP-2-0015" class="indexterm"/></p><p>To use the functions to remove, hide, and show markers, you need access to Mapstraction and marker objects. These objects are generated when you create your new map and whenever you create a new marker. Whether they become available to the rest of your script, however, depends on the variable's scope.</p><p><span class="emphasis"><em>Scope</em></span> refers to the parts of code where a variable can be accessed. Any variable created inside the <code class="literal">create_map</code> function can only be used inside that function. To remove or hide markers, we need to make our Mapstraction and marker objects global. To do this, add this declaration right above the <code class="literal">create_map</code> function:</p><a id="I_programlisting2_d1e1706"/><pre class="programlisting">var mapstraction, marker;</pre><p>These two variables now have a global scope, meaning we can use the variables outside of the <code class="literal">create_map</code> function. To remove a marker, you call the <code class="literal">removeMarker</code> function on the Mapstraction object:</p><a id="I_programlisting2_d1e1716"/><pre class="programlisting">mapstraction.removeMarker(marker);</pre><p>To simply hide a marker, you call the <code class="literal">hide</code> function on the marker object:</p><a id="I_programlisting2_d1e1723"/><pre class="programlisting">marker.hide();</pre><p>To make a hidden marker reappear, you call the <code class="literal">show</code> function on the marker object:</p><a id="I_programlisting2_d1e1730"/><pre class="programlisting">marker.show();</pre><p>Where do you call these functions? Anywhere they're needed. For testing purposes, create a link anywhere after the <code class="literal">&lt;body&gt;</code> tag. For example, here is a link that will hide your marker:</p><a id="I_programlisting2_d1e1738"/><pre class="programlisting">&lt;a href="javascript:marker.hide();"&gt;hide marker&lt;/a&gt;</pre><p>Again, this location is just for testing. You want unobtrusive JavaScript that isn't called from a link's <code class="literal">href</code>. One barrier to using all three of these functions is having access to the marker object.</p><p>This single marker example only requires the variable be within a global scope. As you've seen, that's easy enough. When you start using many markers, you'll need a way to organize them beyond declaring dozens of variables.<a id="IDX-CHP-2-0016" class="indexterm"/><a id="IDX-CHP-2-0017" class="indexterm"/><a id="IDX-CHP-2-0018" class="indexterm"/></p><p>Mapstraction's built-in ability to filter out certain markers (see <a class="xref" href="ch02s09.html" title="#9: Filter Out Certain Markers">#9: Filter Out Certain Markers</a> in <a class="xref" href="ch02s09.html" title="#9: Filter Out Certain Markers">#9: Filter Out Certain Markers</a>) may be the easiest solution. If it does not provide all the features you need, you can always access all the markers that Mapstraction has added:</p><a id="I_programlisting2_d1e1766"/><pre class="programlisting">var allmarkers = mapstraction.markers;</pre><p>Mapstraction's <code class="literal">markers</code> object gives you an array of markers. From here, you can remove, hide, or show them as you wish.</p></div>
<div class="sect1" title="#3: Show a Message Box When Your Marker Is Clicked"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_3_colon_show_a_message_box"/>#3: Show a Message Box When Your Marker Is Clicked</h1></div></div></div><p>Markers alone are useful because they identify spots on the map. Once your map has more than one, viewers will start wondering what each marker means. Sure, you could use custom icons to differentiate markers and we'll see how to do that shortly. But you can provide more information by showing descriptive text when the user clicks a marker.</p><p>Each mapping provider has a way to show a message box. Like markers themselves, the box looks different depending on the provider. <a class="xref" href="ch02s03.html#message_boxes_from_different_providers" title="Figure 2-3. Message boxes from different providers">Figure 2-3</a> shows the differences among the message boxes from the major map services.</p><div class="figure"><a id="message_boxes_from_different_providers"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject2_d1e1785"/><img src="httpatomoreillycomsourcenostarchimages671971.png.jpg" alt="Message boxes from different providers"/></div></div><p class="title">Figure 2-3. Message boxes from different providers</p></div><p>Mapstraction provides an interface, called an <span class="emphasis"><em>InfoBubble</em></span>, that works with all providers. To create an InfoBubble for a marker, you add a marker option like so:<a id="IDX-CHP-2-0019" class="indexterm"/></p><a id="I_programlisting2_d1e1798"/><pre class="programlisting">marker.setInfoBubble("Look ma, No Starch!");</pre><p>The <code class="literal">setInfoBubble</code> function takes a string of text (HTML works, too) and saves it in connection with the marker. The line must be inserted after the marker object is created but before the marker is added to the map. If you have the code from creating a basic marker (<a class="xref" href="ch02.html#number_symble_1_colon_add_a_marker_to" title="#1: Add a Marker to Your Map">#1: Add a Marker to Your Map</a> in <a class="xref" href="ch02.html#number_symble_1_colon_add_a_marker_to" title="#1: Add a Marker to Your Map">#1: Add a Marker to Your Map</a>), you can just add the <code class="literal">setInfoBubble</code> line in place of the comment about marker options.</p><p>For clarification, here are the commands necessary to create a brand new marker, include an InfoBubble, and place the marker on the map:</p><a id="I_programlisting2_d1e1814"/><pre class="programlisting">marker = new mxn.Marker(new mxn.LatLonPoint(37.7740486,-122.4101883));
marker.setInfoBubble("Look ma, No Starch!");
mapstraction.addMarker(marker);</pre><p>Great! Now if you load this file, you see a basic marker in the No Starch Press neighborhood. Where is the InfoBubble? Click the marker, and you see something similar to <a class="xref" href="ch02s03.html#message_box_with_message_displayed" title="Figure 2-4. Message box with message displayed">Figure 2-4</a>. Mapstraction and the mapping provider do all the work of capturing the click event and displaying the InfoBubble. All you need to do is provide the content. If you're hoping to open the InfoBubble automatically or from code, read on; I'll show you how to display a message box without making the user click in the next project.</p><div class="figure"><a id="message_box_with_message_displayed"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject2_d1e1823"/><img src="httpatomoreillycomsourcenostarchimages671973.png.jpg" alt="Message box with message displayed"/></div></div><p class="title">Figure 2-4. Message box with message displayed</p></div></div>
<div class="sect1" title="#4: Show and Hide Message Boxes Without Clicking the Marker"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_4_colon_show_and_hide_mess"/>#4: Show and Hide Message Boxes Without Clicking the Marker</h1></div></div></div><p>Maps let users click around and interact with a location. You've seen how you can add clickable markers that provide more information about the spots you've plotted. But sometimes you want a little bit more control. Sometimes you want to open up that InfoBubble <span class="emphasis"><em>without</em></span> the user's permission.<a id="IDX-CHP-2-0020" class="indexterm"/><a id="IDX-CHP-2-0021" class="indexterm"/><a id="IDX-CHP-2-0022" class="indexterm"/><a id="IDX-CHP-2-0023" class="indexterm"/><a id="IDX-CHP-2-0024" class="indexterm"/><a id="IDX-CHP-2-0025" class="indexterm"/><a id="IDX-CHP-2-0026" class="indexterm"/><a id="IDX-CHP-2-0027" class="indexterm"/><a id="IDX-CHP-2-0028" class="indexterm"/></p><p>For example, if your map shows search results, you might duplicate the locations in a list format beside the map. Then users can choose a location from the list and its corresponding marker opens a message box on the map.</p><p>The basic setup for displaying a message box from code is the same as a standard clickable marker. You can just set some text as a marker option:</p><a id="I_programlisting2_d1e1876"/><pre class="programlisting">marker.setInfoBubble("Look ma, No Starch!");</pre><p>This ensures that a clicked marker will still show your message. Then, from elsewhere in your code (such as when the user clicks one of the search results), you can tell the marker to open the InfoBubble:</p><a id="I_programlisting2_d1e1880"/><pre class="programlisting">marker.openBubble();</pre><p>You can close the InfoBubble with a similar command:</p><a id="I_programlisting2_d1e1884"/><pre class="programlisting">marker.closeBubble();</pre><p>The <code class="literal">openBubble</code> and <code class="literal">closeBubble</code> functions require the marker variable to be accessible globally. That is, the marker object needs to be declared at the top of your code, or you need to find another way to access it. In <a class="xref" href="apas05.html" title="Functions">Functions</a> in <a class="xref" href="apas05.html" title="Functions">Functions</a>, I describe variable scope and how to declare variables so they can be accessed anywhere in your code.</p></div>
<div class="sect1" title="#5: Create a Custom Icon Marker"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_5_colon_create_a_custom_ic"/>#5: Create a Custom Icon Marker</h1></div></div></div><p>The quickest way to make a map feel like your own is to change the default icon used for markers. Mapstraction has simple marker options that make the technical process of using custom icons a cinch. The more laborious part may be creating the icon file itself. To avoid this, you can find icons others have made online for free. I list several resources at <a class="ulink" href="http://mapscripting.com/download-custom-markers/">http://mapscripting.com/download-custom-markers/</a>.</p><p>Still want to create your own? Read on.</p><div class="sect2" title="Get Out the Image Editor"><div class="titlepage"><div><div><h2 class="title"><a id="get_out_the_image_editor"/>Get Out the Image Editor</h2></div></div></div><p>To create your own marker icon, you just need to have a graphics program that can save a transparent <span class="emphasis"><em>.png</em></span> file. The icon can be whatever size you want, but keeping each dimension between 20 and 50 pixels is probably best. If the icon is too small, clicking it becomes difficult; too big, and the icon obscures the location you're attempting to call out.<a id="IDX-CHP-2-0029" class="indexterm"/><a id="IDX-CHP-2-0030" class="indexterm"/></p><p>If you're using Google as your mapping provider, you also want to create an image to use as your marker's shadow. This step isn't necessary if your marker is a similar shape to the Google default or if you're using another provider.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Not much of an image magician? You can find an online service to create a shadow at <a class="ulink" href="http://www.cycloloco.com/shadowmaker/">http://www.cycloloco.com/shadowmaker/</a>.</p></div></div><div class="sect2" title="Add Your Icon to the Map"><div class="titlepage"><div><div><h2 class="title"><a id="add_your_icon_to_the_map"/>Add Your Icon to the Map</h2></div></div></div><p>Now that you have an icon, the easy part is adding it to the marker options. All it takes is setting a few values to tell Mapstraction where the icon image files resides. Your best bet is to keep custom marker icons in a special directory on your server. If you're testing locally, you can use local copies, accessed by their location relative to the page containing the map. For simplicity, I have the HTML file and the icon files in the same directory in this example. In reality, you might prefer to be more organized.</p><p>I decided to use a teensy No Starch Press logo for my custom icon. It's 27 pixels wide by 31 pixels high. Like I said, the icon is teensy. Then, I used a shadow-maker service to create a file that is 43×31 including the marker's shadow.</p><p>Finally, it's time to code. Add these lines as marker options. These lines are inserted after a marker has been created but before the marker has been added to the map:</p><a id="I_programlisting2_d1e1939"/><pre class="programlisting">marker.setIcon(❶'nostarch-logo.png', ❷[27,31]);
marker.setShadowIcon('nostarch-shadow.png', [43,31]);</pre><p>The only parameter that you need to include is the path to the image ❶ for both the icon and the shadow. Notice that the dimensions of each graphic get passed as an inline array ❷. This parameter is optional but recommended. If you leave it out, some providers will assume the dimensions of the default marker, which could mean a poorly scaled graphic.</p><p>The results of the custom marker code are shown in <a class="xref" href="ch02s05.html#custom_marker_shows_the_no_starch_press" title="Figure 2-5. Custom marker shows the No Starch Press logo">Figure 2-5</a>. The No Starch Press office is marked by the company's logo, a little iron icon. Notice the shadow, as well, which makes the graphic pop out from the map.</p><p>Omit the shadow icon at your own risk. Some mapping providers will assume the default shadow, which might look silly with your icon. Not every mapping provider uses shadows, but planning for one is good. If you really don't want a shadow, consider using a completely transparent graphic. I show an example of shadowless icons in <a class="xref" href="ch10s02.html" title="#69: Create a Weather Map">#69: Create a Weather Map</a> in <a class="xref" href="ch10s02.html" title="#69: Create a Weather Map">#69: Create a Weather Map</a>.<a id="IDX-CHP-2-0031" class="indexterm"/></p><div class="figure"><a id="custom_marker_shows_the_no_starch_press"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject2_d1e1959"/><img src="httpatomoreillycomsourcenostarchimages671975.png.jpg" alt="Custom marker shows the No Starch Press logo"/></div></div><p class="title">Figure 2-5. Custom marker shows the No Starch Press logo</p></div></div></div>
<div class="sect1" title="#6: Create Numbered Markers"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_6_colon_create_numbered_ma"/>#6: Create Numbered Markers</h1></div></div></div><p>When you have a list of locations on your web page that you also want to plot on a map, provide users with numbered markers. For example, when displaying search results, you want a matching label both on and off the map so users can easily identify what's what.<a id="IDX-CHP-2-0032" class="indexterm"/><a id="IDX-CHP-2-0033" class="indexterm"/></p><p>Numbered markers are not any different from any other custom marker. You'll need to create a graphic icon for each number you want. Numerous icon sets are available online that you can use, or you can create them dynamically with the Google Charts API.<a id="IDX-CHP-2-0034" class="indexterm"/></p><div class="sect2" title="Generate the Numbered Icon"><div class="titlepage"><div><div><h2 class="title"><a id="generate_the_numbered_icon"/>Generate the Numbered Icon</h2></div></div></div><p>The Google Charts API generates reverse teardrop–style pins that look like the default Google marker. Using these Google-generated icons does not mean you have to use Google Maps. Mapstraction will add the icon for any provider to your map.</p><p>You control the marker's background and border color, as well as what the label reads. The criteria you require are sent in the URL of the icon itself. For example, here is the URL for a red marker labeled with a number one:<a id="IDX-CHP-2-0035" class="indexterm"/></p><a id="I_programlisting2_d1e1994"/><pre class="programlisting">http://chart.apis.google.com/chart?chst=d_map_pin_letter&amp;chld=❶1|❷FF3333|❸000000</pre><p>The final argument of the URL contains all the important information for the marker: the label text ❶ (in this case, the number one), the background color, ❷ and the border ❸ color. The colors are represented as hex values, similar to how colors are declared in CSS.</p><p>The individual pieces of the <code class="literal">chld</code> argument are separated by the pipe character, <code class="literal">|</code>. In a way, the final argument is really three arguments with its own way of segmenting the values.</p><p>Custom markers added to a map when using Google as a mapping provider also require a shadow. Because the shapes of these dynamic markers are all the same, the shadow can be static. The Google Charts API provides this URL:</p><a id="I_programlisting2_d1e2008"/><pre class="programlisting">http://chart.apis.google.com/chart?chst=d_map_pin_shadow</pre><p>Now that you can generate the icons, you need to place them on the map. To do this, we'll call these Google Charts URLs on the fly.<a id="IDX-CHP-2-0036" class="indexterm"/></p></div><div class="sect2" title="Add the Icon to the Map"><div class="titlepage"><div><div><h2 class="title"><a id="add_the_icon_to_the_map"/>Add the Icon to the Map</h2></div></div></div><p>Armed with dynamically generated marker URLs from Google Charts, the process of adding these numbered markers to a map is much like adding any custom icon. Here is the code listing that creates five random points within San Francisco. Each marker is given an icon with a label numbered one through five based on the order that it is created:</p><a id="I_programlisting2_d1e2020"/><pre class="programlisting">mapstraction = new mxn.Mapstraction('mymap', 'googlev3');
mapstraction.setCenterAndZoom(new mxn.LatLonPoint(37.7740486,-122.4101883), 11);
mapstraction.addLargeControls();
for (i=1; i&lt;=5; i++) {
    var rndlatlon = get_random_by_bounds(mapstraction.getBounds());
    marker = new mxn.Marker(rndlatlon);
    <strong class="userinput"><code>marker.setIcon(</code></strong>
      <strong class="userinput"><code>'http://chart.apis.google.com/chart?chst=d_map_pin_letter&amp;chld=' + i +</code></strong>
      <strong class="userinput"><code>'|FF3333|000000', [21,32]);</code></strong>
    <strong class="userinput"><code>marker.setShadowIcon(</code></strong>
      <strong class="userinput"><code>'http://chart.apis.google.com/chart?chst=d_map_pin_shadow');</code></strong>
    mapstraction.addMarker(marker);
}
mapstraction.autoCenterAndZoom();</pre><p>The lines in bold set the generated icon and its shadow. The rest either sets up the map or creates the random points. For the code to work, you need a JavaScript function, <code class="literal">get_random_by_bounds</code>, which is discussed in <a class="xref" href="ch06.html" title="Chapter 6. EXPLORE PROXIMITY">Chapter 6</a> but which I have reprinted next. Put the previous code inside the <code class="literal">create_map</code> function used in all examples so far, and then make sure the following function is included somewhere in the JavaScript (but outside of other functions):<a id="IDX-CHP-2-0037" class="indexterm"/></p><a id="I_programlisting2_d1e2050"/><pre class="programlisting">function get_random_by_bounds(bounds) {
  var lat = bounds.sw.lat + (Math.random() * (bounds.ne.lat − bounds.sw.lat));
  var lon = bounds.sw.lon + (Math.random() * (bounds.ne.lon − bounds.sw.lon));
  return new mxn.LatLonPoint(lat, lon);
}</pre><p>Save your file. You'll see a map like the one shown in <a class="xref" href="ch02s06.html#numbered_markers_comma_randomly_plotted" title="Figure 2-6. Numbered markers, randomly plotted">Figure 2-6</a> (marker locations vary—remember, they're random).</p><div class="figure"><a id="numbered_markers_comma_randomly_plotted"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject2_d1e2059"/><img src="httpatomoreillycomsourcenostarchimages671977.png.jpg" alt="Numbered markers, randomly plotted"/></div></div><p class="title">Figure 2-6. Numbered markers, randomly plotted</p></div><p>Use numbered markers when the order matters, such as when displaying nearby locations. Numbering is also helpful when users will match search results or another list from outside the map to the individual markers.</p></div></div>
<div class="sect1" title="#7: Loop Through All Markers"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_7_colon_loop_through_all"/>#7: Loop Through All Markers</h1></div></div></div><p>When you've added a bunch of markers to the map, you may want a way to access them all. For example, you might be looking for outliers or determining which marker is the farthest north.<a id="IDX-CHP-2-0038" class="indexterm"/><a id="IDX-CHP-2-0039" class="indexterm"/><a id="IDX-CHP-2-0040" class="indexterm"/><a id="IDX-CHP-2-0041" class="indexterm"/><a id="IDX-CHP-2-0042" class="indexterm"/></p><p>Mapstraction provides a property that holds an array of every marker plotted on the map. You can then reference an individual marker from within that array using standard JavaScript code to pull out a value at a specific index. Doing this for each marker on the map lets you loop through and perform an action on all the markers.</p><p>Add these lines to your code wherever you need to do something to each marker:</p><a id="I_programlisting2_d1e2099"/><pre class="programlisting">❶ var allm = mapstraction.markers;
❷ for (var i=0; i&lt;allm.length; i++) {
❸   var thism = allm[i];
    // Any code for thism variable goes here
  }</pre><p>The first thing we do is reference the array of all markers from Mapstraction ❶ with a new variable name, <code class="literal">allm</code>. The saves us some typing, as we'll need to use the marker variable several times. Next, we use JavaScript's <code class="literal">for</code> statement ❷ to loop through the array. A temporary variable, <code class="literal">i</code>, keeps track of the index, as we count from zero (the first element in an array is at zero) up to the total number of markers.</p><p>As each marker becomes available, we place a reference to it inside the temporary <code class="literal">thism</code> variable ❸, a name I chose because it describes "this marker," as in the marker we are currently utilizing. Anything within the braces, <code class="literal">{</code> and <code class="literal">}</code>, of the <code class="literal">for</code> loop now has access to this new variable.</p><p>We can look up marker options or call functions on the marker (such as <code class="literal">showBubble</code> or <code class="literal">hide</code>, for example). In most cases, we cannot <span class="emphasis"><em>add</em></span> options because options need to be added before the marker is added to the map. For example, we cannot change the marker's icon without removing and re-adding the marker.</p><p>Despite these few limitations, looping through the markers is a useful trick to add to your mapping tool bag. Many of Mapstraction's functions, such as filtering or autocentering, use a loop internally.<a id="IDX-CHP-2-0043" class="indexterm"/></p></div>
<div class="sect1" title="#8: Determine the Correct Zoom Level to Use Based on Markers"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_8_colon_determine_the_corr"/>#8: Determine the Correct Zoom Level to Use Based on Markers</h1></div></div></div><p>Once your map has several markers, ensuring that all of them can be viewed becomes a chore. This is especially true when your locations are being served up by a database (<a class="xref" href="ch09s08.html" title="#66: Plot Locations from a Database">#66: Plot Locations from a Database</a> in <a class="xref" href="ch09s08.html" title="#66: Plot Locations from a Database">#66: Plot Locations from a Database</a>). Markers start to fall outside of your manually set center and zoom levels.</p><p>You may have tried to fix this on your own by changing the zoom level. If you zoom out, your markers can end up scrunched together, with lots of room to zoom in. The only way to achieve a good zoom level for any marker is to determine it programmatically after all the markers are added to the map.<a id="IDX-CHP-2-0044" class="indexterm"/><a id="IDX-CHP-2-0045" class="indexterm"/></p><p>Mapstraction makes setting the zoom level as easy as one function call. Add the following line to the <code class="literal">create_map</code> function from the basic map after you have added some markers:</p><a id="I_programlisting2_d1e2166"/><pre class="programlisting">mapstraction.autoCenterAndZoom();</pre><p>You can also use a similar function that only works on displayed markers. That is, if you've hidden or filtered out some markers, you will probably want to zoom in to the ones that are still on the map. Instead of the previous function, use this:</p><a id="I_programlisting2_d1e2170"/><pre class="programlisting">mapstraction.visibleCenterAndZoom();</pre><p>If these functions feel like magic, that's okay. Mapstraction makes it easy, but a lot is going on behind the curtain. Here's the run-down of how Mapstraction makes auto-zooming happen:<a id="IDX-CHP-2-0046" class="indexterm"/></p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Loops through all the markers (or just the visible ones), and determines the maximum and minimum latitude and longitude of the markers. This measurement is called the <span class="emphasis"><em>bounding box</em></span> and consists of four numbers that describe each edge of the box.</p></li><li class="listitem"><p>Finds the center of the bounding box by averaging the two latitudes and the two longitudes.</p></li><li class="listitem"><p>Checks zoom levels until it finds one that displays the entire bounding box.</p></li></ol></div><p>Actually, Mapstraction does not need to perform the last two steps for very many mapping providers. Most already have something that does the auto-zooming work within their own library. That wasn't always the case, however, and it points to the power of Mapstraction. Mapstraction is able to add these indispensable functions before they're available in all map APIs.</p><p>To get a feel for how auto-zooming works, insert this code in the basic map's <code class="literal">create_map</code> function to add random markers:</p><a id="I_programlisting2_d1e2198"/><pre class="programlisting">❶ var num_markers = 5;
❷ var bigbounds = new mxn.BoundingBox(37.766, −122.400, 37.784, −122.418);
  for (i=1; i&lt;=num_markers; i++) {
      var rndlatlon = ❸get_random_by_bounds(bigbounds);
      marker = new mxn.Marker(rndlatlon);
      mapstraction.addMarker(marker);
  }
❹ mapstraction.autoCenterAndZoom();</pre><p>This code chooses five random markers, but you can change the first variable ❶ to any number you want. I've also created a bounding box ❷ that is larger than the basic map's visible area (you can learn more about bounds in <a class="xref" href="ch06.html" title="Chapter 6. EXPLORE PROXIMITY">Chapter 6</a>). These bounds are used to produce a new random point for each of my markers. You actually need to include a special function ❸ to create the point. We'll get to that in a moment.<a id="IDX-CHP-2-0047" class="indexterm"/></p><p>First, note the last line ❹, the one that auto-zooms. Try commenting it out by placing a <code class="literal">//</code> at the front of the line to see how the markers look without auto-zooming. Reload the map a few times with and without the comment slashes. <a class="xref" href="ch02s08.html#difference_between_markers_without_and_w" title="Figure 2-7. Difference between markers without and with automatic centering and zooming">Figure 2-7</a> shows an example comparison of the maps in each of these situations.<a id="IDX-CHP-2-0048" class="indexterm"/><a id="IDX-CHP-2-0049" class="indexterm"/></p><div class="figure"><a id="difference_between_markers_without_and_w"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject2_d1e2227"/><img src="httpatomoreillycomsourcenostarchimages671979.png.jpg" alt="Difference between markers without and with automatic centering and zooming"/></div></div><p class="title">Figure 2-7. Difference between markers without and with automatic centering and zooming</p></div><p>Of course, you need that special function, <code class="literal">get_random_by_bounds</code>. Unlike in the previous code, add this outside of the <code class="literal">create_map</code> function but within the JavaScript section:</p><a id="I_programlisting2_d1e2240"/><pre class="programlisting">function get_random_by_bounds(bounds) {
  var lat = bounds.sw.lat + (Math.random() * (bounds.ne.lat − bounds.sw.lat));
  var lon = bounds.sw.lon + (Math.random() * (bounds.ne.lon − bounds.sw.lon));
  return new mxn.LatLonPoint(lat, lon);
}</pre><p>This function is described in detail in <a class="xref" href="ch06s09.html" title="#44: Get a Random Point in a Bounding Box">#44: Get a Random Point in a Bounding Box</a> in <a class="xref" href="ch06s09.html" title="#44: Get a Random Point in a Bounding Box">#44: Get a Random Point in a Bounding Box</a>.</p><p>As for the automatic centering and zooming, now that you can do it in a single function call, you'll likely include it for all but the simplest maps—it's really that useful.</p></div>
<div class="sect1" title="#9: Filter Out Certain Markers"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_9_colon_filter_out_certain"/>#9: Filter Out Certain Markers</h1></div></div></div><p>You must have a map with a whole bunch of markers by now, right? That means you're getting the hang of this mapping stuff. With a full screen of markers, users will likely want to way to see only what they care about. That's where you'll find Mapstraction's filtering options handy.</p><p>Keeping track of many markers without the filtering options is a pain. You need to maintain global arrays or make use of the <code class="literal">mapstraction.markers</code> object. In either case, you need a way to distinguish the type of marker or some data associated with it.<a id="IDX-CHP-2-0050" class="indexterm"/><a id="IDX-CHP-2-0051" class="indexterm"/></p><p>The first step in filtering is to create a new attribute and add it to your new marker. You do this by adding some marker options, which has to happen after a marker is created but before you add it to the map. Here, I'll set the price to be 1000—maybe the marker represents an apartment and this attribute is its rent:</p><a id="I_programlisting2_d1e2268"/><pre class="programlisting">marker.setAttribute('price', '1000');</pre><p>If you'd like to add more attributes, such as number of bedrooms, you can do that with additional <code class="literal">setAttribute</code> lines. Once you've added the data for several markers, you can move on to filtering.</p><p>Filters are applied after the markers have been added to the map. In fact, filtering usually happens in response to user behavior, such as when a user clicks a filter button or enters search terms.</p><p>To show only markers with a price attribute greater than or equal to 1000, use this code:</p><a id="I_programlisting2_d1e2279"/><pre class="programlisting">mapstraction.removeAllFilters();
  mapstraction.addFilter(❶'price', ❷'ge', ❸1000);
❹ mapstraction.doFilter();</pre><p>First, use <code class="literal">removeAllFilters</code> unless you know no filters are applied. The reason is that filters are additive, meaning a second filter does not remove the first. You could end up with fewer results than you expect because of a previously applied filter.</p><p>Once filters are removed, you can continue. To add the filter requires three parameters: the attribute name ❶, the operator (in this case <span class="strong"><strong>g</strong></span>reater than or <span class="strong"><strong>e</strong></span>qual to) ❷, and the number ❸ to use as a comparison. Finally, the map will not change at all unless you apply the filter ❹.</p><div class="table"><a id="filtering_operators"/><p class="title">Table 2-1. Filtering Operators</p><div class="table-contents"><table summary="Filtering Operators" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Operator</p></th><th style="text-align: left" valign="bottom"><p>Description</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">ge</code></p></td><td style="text-align: left" valign="top"><p>Greater than or equal to—use on numbers.</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">le</code></p></td><td style="text-align: left" valign="top"><p>Less than or equal to—use on numbers.</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">eq</code></p></td><td style="text-align: left" valign="top"><p>Equal to—use on numbers or with words (such as tags or types).</p></td></tr></tbody></table></div></div><p>Once a filter is applied, the markers that <span class="emphasis"><em>don't</em></span> match the filter will disappear. In our example, anything with a price attribute less than 1000 (or without a price attribute) will be removed. Thus, filtering can be thought of as filtering <span class="emphasis"><em>in</em></span> rather than <span class="emphasis"><em>out</em></span>.</p><p>Mapstraction provides three operators to use to filter markers, as seen in <a class="xref" href="ch02s09.html#filtering_operators" title="Table 2-1. Filtering Operators">Table 2-1</a>. You can combine filters to achieve more granular results. Sticking with the apartment search theme, you might add a neighborhood attribute, so users can view apartments in a certain neighborhood that are below a certain price, for example.<a id="IDX-CHP-2-0052" class="indexterm"/><a id="IDX-CHP-2-0053" class="indexterm"/><a id="IDX-CHP-2-0054" class="indexterm"/><a id="IDX-CHP-2-0055" class="indexterm"/><a id="IDX-CHP-2-0056" class="indexterm"/></p><p>Mapstraction filters are a speedy way to show only a subset of markers based on simple criteria. They do not require any additional communication with the server because Mapstraction stores information about every marker in memory. For an example of filtering used in a real project, see <a class="xref" href="ch10s04.html" title="#71: Search Music Events by Location">#71: Search Music Events by Location</a> in <a class="xref" href="ch10s04.html" title="#71: Search Music Events by Location">#71: Search Music Events by Location</a>.</p></div>
<div class="sect1" title="#10: Remove or Hide All Markers"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_10_colon_remove_or_hide_al"/>#10: Remove or Hide All Markers</h1></div></div></div><p>Need to start fresh, or want to show a clear map in some situations? We all can use a little spring cleaning from time to time. I've already shown how to remove or hide a single marker in this chapter. Now we'll get rid of them all.</p><p>Again, make sure you understand that when you remove a marker it is gone forever. Removing a marker is sometimes desired, such as when the user activates a new search. Mapstraction has a function to achieve a clean slate. A hidden marker, on the other hand, can always be shown again. We'll have to write our own function to hide all markers and make the slate <span class="emphasis"><em>appear</em></span> clean.<a id="IDX-CHP-2-0057" class="indexterm"/><a id="IDX-CHP-2-0058" class="indexterm"/></p><p>First, let's be destructive and remove all the markers from our map. Add this line wherever you want to axe all the markers:</p><a id="I_programlisting2_d1e2394"/><pre class="programlisting">mapstraction.removeAllMarkers();</pre><p>That's it—they're gone. <a class="xref" href="ch10s04.html" title="#71: Search Music Events by Location">#71: Search Music Events by Location</a> in <a class="xref" href="ch10s04.html" title="#71: Search Music Events by Location">#71: Search Music Events by Location</a> shows an example of this function in use every time a user starts a search. By removing the markers, we ensure the previous search results don't get mixed up with the new ones.</p><p>If we only want to hide all markers, we need to write our own function. To do this, we need to loop through all markers (described in detail in <a class="xref" href="ch02s07.html" title="#7: Loop Through All Markers">#7: Loop Through All Markers</a> in <a class="xref" href="ch02s07.html" title="#7: Loop Through All Markers">#7: Loop Through All Markers</a>) and hide each one.</p><a id="I_programlisting2_d1e2408"/><pre class="programlisting">function hideAllMarkers() {
❶   var allm = mapstraction.markers;
    for (var i=0; i&lt;allm.length; i++) {
❷     var thism = allm[i];
❸     thism.hide();
    }
  }</pre><p>So far, much of our code has been used inside the <code class="literal">create_map</code> function. Because <code class="literal">hideAllMarkers</code> is a new function, we need to add it in its own place outside of other functions but still in the JavaScript section of the page.</p><p>The function itself is straightforward. It first grabs a reference to the marker object ❶ from Mapstraction, which holds an array of every marker added to the map. Then, using that array of markers, the function goes through them one by one. Each time through the loop, the function takes another marker and puts it in a temporary variable named <code class="literal">thism</code> ❷ (for "this marker"). Finally, it calls the <code class="literal">hide</code> function ❸ on this marker.<a id="IDX-CHP-2-0059" class="indexterm"/><a id="IDX-CHP-2-0060" class="indexterm"/></p><p>By the end of the function, no markers will be displayed on the map. We've looped through every marker and hidden them one at a time.</p><p>To write the function is not enough. We need to call the function from somewhere else in our code:</p><a id="I_programlisting2_d1e2439"/><pre class="programlisting">hideAllMarkers();</pre><p>Notice that this call looks very similar to the call for removing all the markers. One major difference is that <code class="literal">removeAllMarkers</code> was called on the Mapstraction object. This new function is merely called on its own. The difference is that we wrote <code class="literal">hideAllMarkers</code> in our own code, whereas Mapstraction's functions are part if its package.</p><p>Writing utility functions, as we did here to hide every marker, is an important part of programming. Now that we've written the function once, we can call it any time we need it.</p></div>
<div class="sect1" title="#11: Handle Clusters of Markers"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_11_colon_handle_clusters"/>#11: Handle Clusters of Markers</h1></div></div></div><p>This chapter has already covered several ways to make sense of a map with many markers plotted. You can number them and filter them. You can automatically zoom to show all the markers within the visible portion of the map. These tools are all good to have, but you'll find that sometimes your markers are still scrunched together and overlapping. You can't avoid it, but you can make it less of a problem.</p><p>Instead of showing every single marker, you can use a special icon to represent a cluster of markers. Then, when users zoom in, the cluster will disappear and be replaced by the actual markers. You can see an example of many markers, with and without clustering, in <a class="xref" href="ch02s11.html#difference_between_markers_with_and_with" title="Figure 2-8. Difference between markers with and without clustering">Figure 2-8</a>.</p><div class="figure"><a id="difference_between_markers_with_and_with"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject2_d1e2463"/><img src="httpatomoreillycomsourcenostarchimages671981.png.jpg" alt="Difference between markers with and without clustering"/></div></div><p class="title">Figure 2-8. Difference between markers with and without clustering</p></div><p>The code behind marker clustering is surprisingly complicated, but the concept is simple. Although many approaches exist, commonly the map is divided into a grid. If one <span class="emphasis"><em>cell</em></span> of the map contains more than one marker (or more than a certain number—you may prefer a cutoff of five markers per cell), they're replaced by a cluster.<a id="IDX-CHP-2-0061" class="indexterm"/><a id="IDX-CHP-2-0062" class="indexterm"/></p><p>Rather than write this algorithm ourselves, we'll use a utility that is already written to work directly with Google Maps, called <span class="emphasis"><em>ClusterMarker</em></span>. You can download the code from <a class="ulink" href="http://www.acme.com/javascript/">http://www.acme.com/javascript/</a> and save it in a file named <span class="emphasis"><em>clusterer2.js</em></span>.</p><p>Unlike most examples in this book, you'll work with Google Maps directly, as you did in <a class="xref" href="ch01s03.html#create_a_google_map" title="Create a Google Map">Create a Google Map</a> in <a class="xref" href="ch01s03.html" title="Create Your First Map">Create Your First Map</a>. In addition to including the Google Maps API JavaScript in the header, you also need to reference the new cluster file. Add this to the header section of your HTML:</p><a id="I_programlisting2_d1e2497"/><pre class="programlisting">&lt;script type="text/javascript" src="clusterer2.js"&gt;&lt;/script&gt;</pre><p>The cluster code is similar to Mapstraction in that it wraps itself around Google Maps. The code to add markers will go through the cluster functions and then be routed to Google Maps. Replace your <code class="literal">create_map</code> function with this one, which will place 100 random markers on the map and cluster where necessary:</p><a id="I_programlisting2_d1e2504"/><pre class="programlisting">function create_map() {
   if (GBrowserIsCompatible()) {
     // Basic Google Map
     var map = new Gmap2(document.getElementById("mymap"));
     var center_point = new GLatLng(39.34, −98.26);
     map.setCenter(center_point, 8);
     map.addControl(new GsmallMapControl());
     // Cluster settings
❶     var clustobj = new Clusterer(map);
❷      clustobj.SetMaxVisibleMarkers(50);
❸      clustobj.SetMinMarkersPerCluster(2);
     // Add Markers
     for (var i=1; i&lt;=100; i++) {
       var lat = center_point.lat() + Math.random() − 0.5;
       var lon = center_point.lng() + Math.random() − 0.5;
       var gmk = new GMarker(new GLatLng(lat, lon));
❹      clustobj.AddMarker(gmk, 'Marker #' + i);
    }
}</pre><p>I've centered this map roughly in the middle of the United States (hello, Kansas!). Once the basic map has been created, we need to tell the cluster code where to find it ❶, which creates an object that is put into a variable named <code class="literal">clustobj</code>.</p><p>Before we add any markers, we want to reset some properties of the clusterer. The first ❷ sets the number of markers when the cluster code will begin clustering. The default is 150, which means every single one of our 100 markers will be shown without clustering if we don't change this setting. The next setting ❸ declares how many markers need to occupy a grid cell before clustering takes over. The default is 5 and, for our example, seems a little too crowded. Experiment with what works best for your map.<a id="IDX-CHP-2-0063" class="indexterm"/><a id="IDX-CHP-2-0064" class="indexterm"/></p><p>Now we're ready to add markers to the map. I wrote a <code class="literal">for</code> loop that creates 100 markers at random points near the center of our map. Then, instead of adding them directly to the map, we add them to the clusterer ❹.</p><p>Save your file, and load it in a browser to see the large clustered markers. You may also see a few stray normal markers—these markers didn't need to be clustered because other markers weren't nearby. The map looks a whole lot cleaner, doesn't it? Zoom in and some of the clusters will disappear, as the map is able to display the actual markers without crowding them.</p><div class="sect2" title="Change the Cluster Icon"><div class="titlepage"><div><div><h2 class="title"><a id="change_the_cluster_icon"/>Change the Cluster Icon</h2></div></div></div><p>Out of the box, your cluster code uses a large, blue icon for cluster markers. If you have another graphic you would rather use, you can include it instead.</p><p>Add the following code after your other cluster settings but before you start adding markers:</p><a id="I_programlisting2_d1e2536"/><pre class="programlisting">var cicon = new GIcon();
cicon.image = 'icon.png';
cicon.iconSize = new GSize(27,31);
cicon.shadow = 'shadow.png';
cicon.shadowSize = new Gsize(43,31);
clusterer.SetIcon(cicon);</pre><p>Clustering icons solves the marker overload problem, in which the markers are so numerous they become meaningless. Clustering is also a quick way to still show everything without overwhelming your users.</p></div></div></body></html>