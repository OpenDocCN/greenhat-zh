<html><head></head><body>
  <div class="part" title="Part&#xA0;VI.&#xA0;Part VI Appendixes">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="appendixes"/>Part VI. Part VI Appendixes</h1>
    </div>

    <div class="partintro" id="id2572061" title="Part VI Appendixes"/>
  </div>


  <div class="appendix" title="Appendix&#xA0;A.&#xA0;An Overview of the Nagios Configuration Parameters">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="an_overview_of_the_nagios-conf"/>Appendix A. An Overview of the Nagios Configuration Parameters</h1>
    </div>

    <p>Nagios contains two independent main configuration files: <strong class="userinput"><code>nagios.cfg</code></strong> controls operation of the Nagios daemon, <strong class="userinput"><code>cgi.cfg</code></strong> configures the Web interface. Both files should be located in the Nagios configuration directory, which is normally <strong class="userinput"><code>/etc/nagios</code></strong>.</p>

    <p><strong class="userinput"><code>nagios.cfg</code></strong> specifies a series of further configuration database and log files, and their functions for the respective parameter will be briefly described in the following reference. The notation ⇒<strong class="userinput"><code>parameter</code></strong> refers to the description of the <strong class="userinput"><code>parameter</code></strong> in the configuration file currently being discussed.</p>

    <p>Unless specified otherwise, parameters may have either the value <strong class="userinput"><code>0</code></strong> (disabled) or <strong class="userinput"><code>1</code></strong> (enabled). If a parameter has a default value, this is specified accordingly. For some path details, the standard value is defined by options during compiling. The values listed in this case correspond to the paths used in the book (see <a class="xref" href="../Text/ch01s02.html#installation_parameters_for_nagios" title="Table 1-1. Installation parameters for Nagios">Table 1-1</a>, page 40).</p>

    <p>For some parameters there are no defaults. If these are missing from the configuration, Nagios does not provide the corresponding function (so, for example, without the <strong class="userinput"><code>cfg_dir</code></strong> parameter, Nagios ignores the object definitions stored in separate directories).</p>

    <p>Depending on the version of Nagios you're using, not all parameters will always be available. (Nagios 2.x) denotes those limited to Nagios 2.x, while (Nagios 3.0) denotes those that have been added in Nagios 3.0.</p>

    <div class="sect1" title="A.1 The Main Configuration File nagios.cfg">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="an_overview_of_the_nagios_configuration"/>A.1 The Main Configuration File <strong class="userinput"><code>nagios.cfg</code></strong></h1>
      </div>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>accept_passive_host_checks</code></strong></span></dt>

          <dd>
            <p>Global switch for passive host checks; the value <strong class="userinput"><code>0</code></strong> suppresses them. Even though passive host checks are allowed according to <strong class="userinput"><code>nagios.cfg</code></strong>, this feature must be explicitly enabled when defining the host object. Default value:<a class="indexterm" id="IDX-APP-A-2021"/><a class="indexterm" id="IDX-APP-A-2022"/><a class="indexterm" id="IDX-APP-A-2023"/><a class="indexterm" id="IDX-APP-A-2024"/><a class="indexterm" id="IDX-APP-A-2025"/><a class="indexterm" id="IDX-APP-A-2026"/><a class="indexterm" id="IDX-APP-A-2027"/><a class="indexterm" id="IDX-APP-A-2028"/><a class="indexterm" id="IDX-APP-A-2029"/><a class="indexterm" id="IDX-APP-A-2030"/><a class="indexterm" id="IDX-APP-A-2031"/><a class="indexterm" id="IDX-APP-A-2032"/><a class="indexterm" id="IDX-APP-A-2033"/><a class="indexterm" id="IDX-APP-A-2034"/><a class="indexterm" id="IDX-APP-A-2035"/><a class="indexterm" id="IDX-APP-A-2020"/><a class="indexterm" id="IDX-APP-A-2036"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>accept_passive_host_checks=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>accept_passive_service_checks</code></strong></span></dt>

          <dd>
            <p>Global switch for passive service checks. Even though the value <strong class="userinput"><code>1</code></strong> allows corresponding tests, this feature must be explicitly enabled when defining the service object. Default value:<a class="indexterm" id="IDX-APP-A-2037"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>accept_passive_service_checks=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>additional_freshness_latency</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Adds the latency, specified in seconds, to the fixed freshness interval. An upcoming freshness check (see <a class="xref" href="../Text/ch13s04.html" title="13.4 Reacting to Out-of-Date Information of Passive Checks">13.4 Reacting to Out-of-Date Information of Passive Checks</a> from page 295) is delayed by this time before it is run. Example:<a class="indexterm" id="IDX-APP-A-2038"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>additional_freshness_latency=15</code></strong></span></dt>

                <dd>
                  <p>The default is <strong class="userinput"><code>0</code></strong> (no additional delay).</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>admin_email</code></strong></span></dt>

          <dd>
            <p>The e-mail address of the administrator responsible for the Nagios server, to which you have access through the macro <strong class="userinput"><code>$ADMINEMAIL$</code></strong>. If there is no explicit configuration of a contact object, Nagios will not send an e-mail to this address. Example (no default value):<a class="indexterm" id="IDX-APP-A-2039"/><a class="indexterm" id="IDX-APP-A-2040"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>admin_email=nagios</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>admin_pager</code></strong></span></dt>

          <dd>
            <p>Pager number, SMS number, or e-mail address for a pager gateway/ SMS gateway through which the administrator of the Nagios server can be reached. Accessible through the macro <strong class="userinput"><code>$ADMINPAGER$</code></strong>. Example (no default value):<a class="indexterm" id="IDX-APP-A-2041"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>admin_pager=pagenagios</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>aggregate_status_updates</code></strong></span></dt>

          <dd>
            <p>Specifies whether Nagios writes status information from hosts, services, and its own programs for the time interval <strong class="userinput"><code>⇒status_update_interval</code></strong> in a block to the <strong class="userinput"><code>⇒status_file</code></strong>. The value 0 means Nagios updates this file immediately after every event. Default value:<a class="indexterm" id="IDX-APP-A-2042"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>aggregate_status_updates=1</code></strong></span></dt>

                <dd>
                  <p>Nagios 3.0 works fundamentally according to the first method, which is why the parameter is omitted.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>auto_reschedule_checks</code></strong></span></dt>

          <dd>
            <p>With this experimental feature, Nagios spreads tests equally over the time period, to avoid peaks. This can considerably reduce performance and in particular is of no use if Nagios is already struggling to keep on schedule because of poor performance. Normally this option should be switched off. Default value:<a class="indexterm" id="IDX-APP-A-2043"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>auto_reschedule_checks=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>auto_rescheduling_interval</code></strong></span></dt>

          <dd>
            <p>In the intervals specified here, Nagios distributes tests which are to be executed in the next <strong class="userinput"><code>auto_rescheduling_window</code></strong> seconds, so that there is an equal load. Default value:<a class="indexterm" id="IDX-APP-A-2044"/><a class="indexterm" id="IDX-APP-A-2045"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>auto_rescheduling_interval=30</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>auto_rescheduling_window</code></strong></span></dt>

          <dd>
            <p>All tests that are to take place in the next number of seconds specified here are rescheduled by Nagios so that they are spread equally over this time period. Checks specified for a future time that lie outside this interval are not (yet) taken into account. Experimental feature; use only in exceptional cases! Default value:</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>auto_rescheduling_window=180</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>broker_module</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>This parameter integrates the specified event broker module (see <a class="xref" href="../Text/ch17.html#the_event_broker" title="17.1 The Event Broker">17.1 The Event Broker</a> from page 376) during the system start. Apart from the full path, you can also specify the module-specific arguments. The following example integrates the NDO event broker module (see also <a class="xref" href="../Text/ch17s04.html#loading_the_event_broker_module_in_nagio" title="17.4.4 Loading the Event Broker module in Nagios">17.4.4 Loading the Event Broker module in Nagios</a>, page 386):</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>broker_module=/usr/local/nagios/bin/ndomod-3x.o config_file=/etc/ nagios/ndomod.cfg</code></strong></span></dt>

                <dd>
                  <p>The module-specific argument <strong class="userinput"><code>config_file</code></strong> provides the path for its configuration file. To integrate several modules, just specify the parameter <strong class="userinput"><code>broker_module</code></strong> for each module separately.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>cached_host_check_horizon</code></strong>(Nagios 3.0)</span></dt>

          <dd>
            <p>Specifies the time in seconds in which Nagios recycles the result of a host check. Nagios does not repeat the test within this time frame but considers the cached result of the last check to still be up to date. This saves time and resources. Example:<a class="indexterm" id="IDX-APP-A-2046"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>cached_host_check_liorizon=30</code></strong></span></dt>

                <dd>
                  <p>The value <strong class="userinput"><code>0</code></strong> switches off caching; the default is <strong class="userinput"><code>15</code></strong>. How large this value should be depends on circumstances. Large values take considerable strain off Nagios, but then there is a danger that the values may become obsolete and will no longer be valid.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>cached_service_check_horizon</code></strong>(Nagios 3.0)</span></dt>

          <dd>
            <p>Like <strong class="userinput"><code>⇒cached_host_check_horizon</code></strong>, but Nagios uses cached service check results only for dependencies. This parameter therefore only has an effect on performance if there is a very large number of service dependency checks. Example:<a class="indexterm" id="IDX-APP-A-2047"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>cached_service_check_horizon=30</code></strong></span></dt>

                <dd>
                  <p>The value <strong class="userinput"><code>0</code></strong> switches off caching; the default is <strong class="userinput"><code>15</code></strong>.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>cfg_dir</code></strong></span></dt>

          <dd>
            <p>The directory in which the configuration files containing object definitions are located. Nagios searches through it recursively for configuration files with the extension <strong class="userinput"><code>.cfg</code></strong>. Files with other names are ignored, so that you can place help files in this directory, such as a CSV file from which host definitions are generated automatically by a script. To integrate individual files <strong class="userinput"><code>⇒cfg_file</code></strong>. The directive may be specified as often as you want (see also <a class="xref" href="../Text/ch02.html#the_main_configuration_file_nagios.cfg" title="2.1 The Main Configuration File nagios.cfg">2.1 The Main Configuration File nagios.cfg</a>, page 55). Example (no default value set):<a class="indexterm" id="IDX-APP-A-2048"/><a class="indexterm" id="IDX-APP-A-2049"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term">cfg_dir=/etc/nagios/servers</span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>cfg_file</code></strong></span></dt>

          <dd>
            <p>Integrates a single file with object definitions. More on this in <a class="xref" href="../Text/ch02.html#the_main_configuration_file_nagios.cfg" title="2.1 The Main Configuration File nagios.cfg">2.1 The Main Configuration File nagios.cfg</a>, page 55. The directive can be specified as often as you want. Example (no default value set):</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>cfg_file=/etc/nagios/checkcommands.cfg</code></strong></span></dt>

                <dd>
                  <p>Nagios 3.0 allows relative paths to be set, starting from the directory in which the file <strong class="userinput"><code>nagios.cfg</code></strong> is located.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>check_external_commands</code></strong></span></dt>

          <dd>
            <p>Enables the interface for external commands. Necessary for passive checks or if commands are to be executed through the Web interface. More on this in <a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>, page 292. Default value:</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>check_external_commands=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>check_for_orphaned_hosts</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Starting with Nagios 3.0, this parameter adds the host pendant to the ⇒ <strong class="userinput"><code>check_for_orphaned_services</code></strong> that already existed in Nagios 2.x.<a class="indexterm" id="IDX-APP-A-2050"/><a class="indexterm" id="IDX-APP-A-2051"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>check_for_orphaned_services</code></strong></span></dt>

          <dd>
            <p>If the results of a service check are not received after a certain time, this is referred to as an <span class="emphasis"><em>orphaned service</em></span>. Since Nagios only reschedules service checks if a result exists, it could be the case that a service is never again tested. Normally this only happens if a running service check is terminated manually from outside.<a class="indexterm" id="IDX-APP-A-2052"/></p>

            <p>If there is a suspicion that such orphaned services have occurred, you should set <strong class="userinput"><code>check_for_orphaned_services</code></strong> to <strong class="userinput"><code>1</code></strong> for debugging purposes. This is then confirmed if Nagios writes a corresponding error entry to the log file. Whether this is justified or not can easily be seen in the Web interface: you can have all services displayed independently of their status, and sorted by the last test time, in ascending order. Normally the execution of an active check should not be longer ago than specified in <strong class="userinput"><code>normal_check_interval</code></strong>. Default value:</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>check_for_orphaned_services=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>check_host_freshness</code></strong></span></dt>

          <dd>
            <p>Allows a passive host check to be tested actively if no check result has arrived for a long time. If Nagios considers the test result to be too old, ⇒<strong class="userinput"><code>host_freshness_check_interval</code></strong> steps in. More on <span class="emphasis"><em>freshness checking</em></span> in <a class="xref" href="../Text/ch13s04.html" title="13.4 Reacting to Out-of-Date Information of Passive Checks">13.4 Reacting to Out-of-Date Information of Passive Checks</a>, page 295. Default value:<a class="indexterm" id="IDX-APP-A-2053"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>check_host_freshness=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>check_result_path</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>The path in which check results are cached in file form from Nagios 3.0. There should be no other files in this directory, since Nagios regularly empties it. Each Nagios instance requires a separate directory. Example:<a class="indexterm" id="IDX-APP-A-2054"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>check_result_path=/var/nagios/checkresults</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>check_result_reaper_frequency</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Reaper processes gather in check results and process these for Nagios. <strong class="userinput"><code>check_result_reaper_frequency</code></strong> defines in seconds the interval at which these processes are started. A short interval increases the system load; a long interval could lead to delays in the Nagios scheduling. Example:<a class="indexterm" id="IDX-APP-A-2055"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>check_result_reaper_frequency=5</code></strong></span></dt>

                <dd>
                  <p>The parameter replaces ⇒service_reaper_frequency from Nagios 2.x.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>check_service_freslmess</code></strong></span></dt>

          <dd>
            <p>The service equivalent to <strong class="userinput"><code>check_host_freshness</code></strong>. The time after which Nagios considers the test result to be too old is defined by the parameter ⇒<strong class="userinput"><code>service_freshness_check_interval</code></strong>. Default value:</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>check_service_freslmess=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>child_process_fork_twice</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Nagios normally starts two sub-processes when service or host checks are performed. This is not necessary but is intended to make the system more robust against plugin calls that crash. Default:<a class="indexterm" id="IDX-APP-A-2056"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>child_process_fork_twice=1</code></strong></span></dt>

                <dd>
                  <p>The parameter <strong class="userinput"><code>use_large_installation_tweaks</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>) sets the value <strong class="userinput"><code>0</code></strong> (just one sub-process); <strong class="userinput"><code>child_process_fork_twice=1</code></strong> activates this, despite the fact that <strong class="userinput"><code>use_large_installation_tweaks</code></strong> is set.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>command_check_interval</code></strong></span></dt>

          <dd>
            <p>Defines the time interval in which Nagios tests the External Command File (see <a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>, page 292) for new entries. For this to happen at all, ⇒<strong class="userinput"><code>check_external_coramands</code></strong> must be enabled.<a class="indexterm" id="IDX-APP-A-2057"/></p>

            <p>A simple number as the value refers to the time unit specified by ⇒<strong class="userinput"><code>interval_leiigth</code></strong> (normally 60 seconds, so that <strong class="userinput"><code>1</code></strong> stands for one minute). The value <strong class="userinput"><code>−1</code></strong> means that Nagios tests the interface as often as possible. If the number is supplemented (without a space) with the unit s, seconds can also be explicitly specified.</p>

            <p>The interval dependent on passive checks may not be too large, since the operating system in the External Command File, a named pipe, can normally only save 4 KB. Default value:<a class="indexterm" id="IDX-APP-A-2058"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>command_check_interval=-1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>command_file</code></strong></span></dt>

          <dd>
            <p>The named pipe that serves as an External Command File. It should only be writable for the user <strong class="userinput"><code>nagios</code></strong> and the group <strong class="userinput"><code>nagcmd</code></strong> (see also <a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>, page 292). Default value:<a class="indexterm" id="IDX-APP-A-2059"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>command_file=/var/nagios/rw/nagios.cmd</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>comment_file (Nagios 2.x)</code></strong></span></dt>

          <dd>
            <p>File in which Nagios stores the comments, which can be specified through the Web interface. Default value:<a class="indexterm" id="IDX-APP-A-2060"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>comment_file=/var/nagios/comments.dat</code></strong></span></dt>

                <dd>
                  <p>This parameter has been removed in Nagios 3.0; comments are now stored in the file <strong class="userinput"><code>status.dat</code></strong>.<a class="indexterm" id="IDX-APP-A-2061"/></p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>date_format</code></strong></span></dt>

          <dd>
            <p>The date format that Nagios displays in the Web interface or uses in the date and time macro. Possible values are <strong class="userinput"><code>us</code></strong> (<strong class="userinput"><code><em class="replaceable"><code>mm/dd/yyyy hh:mm:ss</code></em></code></strong>), euro (<strong class="userinput"><code><em class="replaceable"><code>dd/mm/yyyy hh:mm:ss</code></em></code></strong>), <strong class="userinput"><code>iso8601</code></strong> (<strong class="userinput"><code><em class="replaceable"><code>yyyy-mm-dd hh:mm:ss</code></em></code></strong>), and <strong class="userinput"><code>strict-iso8601</code></strong> (<strong class="userinput"><code><em class="replaceable"><code>yyyy-mm-ddThh:mm:ss</code></em></code></strong>). Default value:<a class="indexterm" id="IDX-APP-A-2062"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>date_format=us</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>downtime_file</code></strong> (Nagios 2.x)</span></dt>

          <dd>
            <p>File in which the downtime details are saved, which can be specified through the Nagios Web interface for hosts and/or services (see <a class="xref" href="../Text/ch16s03.html" title="16.3 Planning Downtimes">16.3 Planning Downtimes</a>, page 359). Default value:<a class="indexterm" id="IDX-APP-A-2063"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>downtime_file=/var/nagios/downtime.dat</code></strong></span></dt>

                <dd>
                  <p>This parameter has been removed in Nagios 3.0; comments are now stored in the file <strong class="userinput"><code>status.dat</code></strong>.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>debug_file</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>For Nagios 2.x, debugging still had to be activated when compiling (for instance, with <strong class="userinput"><code>./configure --enable-DEBUGALL</code></strong>; see <strong class="userinput"><code>configure --help</code></strong>). In Nagios 3.0 this can normally be configured in <strong class="userinput"><code>nagios.cfg</code></strong>. <strong class="userinput"><code>debug_file</code></strong> defines the file to which the debugging output is written. Example:<a class="indexterm" id="IDX-APP-A-2064"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>debug_file=/var/nagios/debug.log</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>debug_level</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>This defines what information is logged. The parameter has the following values, which can also be combined:<a class="indexterm" id="IDX-APP-A-2065"/></p>

            <table border="0" class="simplelist" summary="Simple list">
              <tr>
                <td><strong class="userinput"><code>−1</code></strong> all information</td>
              </tr>

              <tr>
                <td><strong class="userinput"><code>0</code></strong> switches off debugging</td>
              </tr>

              <tr>
                <td><strong class="userinput"><code>1</code></strong> Start/end of function calls</td>
              </tr>

              <tr>
                <td><strong class="userinput"><code>2</code></strong> Information on the configuration</td>
              </tr>

              <tr>
                <td><strong class="userinput"><code>4</code></strong> Information on processes</td>
              </tr>

              <tr>
                <td><strong class="userinput"><code>8</code></strong> Scheduling details</td>
              </tr>

              <tr>
                <td><strong class="userinput"><code>16</code></strong> Host and service checks</td>
              </tr>

              <tr>
                <td><strong class="userinput"><code>32</code></strong> Messages</td>
              </tr>

              <tr>
                <td><strong class="userinput"><code>64</code></strong> Event broker</td>
              </tr>
            </table>

            <p>Example:</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>debug_level=−1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>debug_verbosity</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Defines the level of verbosity when debugging: The value <strong class="userinput"><code>0</code></strong> provides only basic information, while <strong class="userinput"><code>1</code></strong> information is slightly more detailed. The value <strong class="userinput"><code>2</code></strong> provides much more detailed information that is generally only of interest to developers. Default:<a class="indexterm" id="IDX-APP-A-2066"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>debug_verbos ity=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>enable_embedded_perl</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Switches on the Embedded Perl Interpreter (<a class="xref" href="../Text/apg.html" title="Appendix G. The Embedded Perl Interpreter">Appendix G</a> from page 669), provided it has been built in. In Nagios 2.x a built-in Interpreter is always active, whereas Nagios 3.0 allows this to be set with this parameter. Example:<a class="indexterm" id="IDX-APP-A-2067"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>enable_embedded_perl=1</code></strong></span></dt>

                <dd>
                  <p>switches on the Interpreter, the value <strong class="userinput"><code>0</code></strong> switches it off. The default is <strong class="userinput"><code>1</code></strong> if the Interpreter has been built in, otherwise <strong class="userinput"><code>0</code></strong>.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>enable_environment_macros</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Nagios standard macros, such as <strong class="userinput"><code>$HOSTADDRESS$</code></strong> (see <a class="xref" href="../Text/apd.html#using_standard_macros_about_the_environm" title="D.1.8 Using standard macros about the environment">D.1.8 Using standard macros about the environment</a>, page 631) can (even in Nagios 2.x) be accessed as environment variables. In Nagios 3.0 the number of available macros has increased so drastically that to process them in large environments would lead to performance problems. Default:<a class="indexterm" id="IDX-APP-A-2068"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>enable_environment_macros=1</code></strong></span></dt>

                <dd>
                  <p>The value <strong class="userinput"><code>0</code></strong> switches off this mechanism.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>enable_event_handlers</code></strong></span></dt>

          <dd>
            <p>Globally switches the option on (or off) to work with event handlers for service and host checks. More on this in <a class="xref" href="../Text/apc.html" title="Appendix C. Event Handlers">Appendix C</a>, page 619. Default value:<a class="indexterm" id="IDX-APP-A-2069"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>enable_event_handlers=l</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>enable_flap_detection</code></strong></span></dt>

          <dd>
            <p>Defines whether Nagios is generally able to detect continually changing states (<span class="emphasis"><em>flap detection</em></span>, more on this in <a class="xref" href="../Text/apb.html" title="Appendix B. Rapidly Alternating States: Flapping">Appendix B</a>, page 611). Default value:<a class="indexterm" id="IDX-APP-A-2070"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>enable_flap_detection=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>enable_notifications</code></strong></span></dt>

          <dd>
            <p>Defines whether Nagios can send notifications. Switching off this feature normally only makes sense on the central hosts of a distributed installation, which themselves cannot generate notifications, and instead forward their test results to a central Nagios instance (see <a class="xref" href="../Text/ch15.html" title="Chapter 15. Distributed Monitoring">Chapter 15</a> from page 317). Default value:<a class="indexterm" id="IDX-APP-A-2071"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>enable_notifications=l</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>enable_predictive_host_dependency_checks</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Nagios 3.x caches host check results if a corresponding time frame is given with ⇒<strong class="userinput"><code>cached_host_check_horizon</code></strong>. The parameter <strong class="userinput"><code>enable_predictive_host_dependency_checks</code></strong> uses caching not only to decide between DOWN and UNREACHABLE for unreachable hosts, but also for host dependency checks, provided some have been defined (see <a class="xref" href="../Text/ch12s06.html#only_in_exceptional_cases_colon_host_de" title="12.6.2 Only in exceptional cases: host dependencies">12.6.2 Only in exceptional cases: host dependencies</a>, page 289).<a class="indexterm" id="IDX-APP-A-2072"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>enable_predictive_service_dependency_checks</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>If this parameter is enabled (value <strong class="userinput"><code>1</code></strong>), service checks will use cached results to resolve dependencies instead of peforming the checks again. There is more on service dependency checks in <a class="xref" href="../Text/ch12s06.html#the_standard_case_colon_service_depende" title="12.6.1 The standard case: service dependencies">12.6.1 The standard case: service dependencies</a>, page 285.<a class="indexterm" id="IDX-APP-A-2073"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>event_broker_options</code></strong></span></dt>

          <dd>
            <p>The event broker as a new interface in Nagios 2.0 allows third parties to add some features to Nagios in the form of loadable modules, for example to save test results to a database instead of to a file. One application that uses the event broker interface is the NDOutils (<a class="xref" href="../Text/ch17.html" title="Chapter 17. Flexible Web Interface with the NDOUtils">Chapter 17</a> from page 375). Possible values are <strong class="userinput"><code>0</code></strong> (switched off) and <strong class="userinput"><code>−1</code></strong> (accept all broker modules). Default value:<a class="indexterm" id="IDX-APP-A-2074"/><a class="indexterm" id="IDX-APP-A-2075"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>event_broker_options=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>event_handler_timeout</code></strong></span></dt>

          <dd>
            <p>The time after which Nagios terminates the event handlers which have not yet finished. Default value:<a class="indexterm" id="IDX-APP-A-2076"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>event_handler_timeout=30</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>execute_host_checks</code></strong></span></dt>

          <dd>
            <p>Enables/disables active host checks globally. This is only worth switching off in distributed environments with a central Nagios instance that only accepts passive results from other Nagios servers (see <a class="xref" href="../Text/ch15.html" title="Chapter 15. Distributed Monitoring">Chapter 15</a>, page 317). Default value:<a class="indexterm" id="IDX-APP-A-2077"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>execute_host_checks=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>execute_service_checks</code></strong></span></dt>

          <dd>
            <p>Like <strong class="userinput"><code>execute_host_checks</code></strong>, but for service checks. Default value:<a class="indexterm" id="IDX-APP-A-2078"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>execute_service_checks=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>external_command_buffer_slots</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Specifies the maximum number of external commands that the external command file interface (<a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a> from page 292) can store temporarily. If the buffer is not large enough, some results might be lost. Default:<a class="indexterm" id="IDX-APP-A-2079"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>external_command_buffer_slots=4096</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>free_child_process_memory</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Nagios normally clears up sub-processes from the memory, but the parameter <strong class="userinput"><code>use_large_installation_tweaks=1</code></strong> (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>) switches off this behavior by default. With<a class="indexterm" id="IDX-APP-A-2080"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>free_child_process_memory=1</code></strong></span></dt>

                <dd>
                  <p>you can reactivate the cleaning up process, despite <strong class="userinput"><code>use_large_installation_tweaks=1</code></strong> being set.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>global_host_event_handler</code></strong></span></dt>

          <dd>
            <p>Defines a global host event handler, in addition to the host-specific event handlers defined with <strong class="userinput"><code>event_handler</code></strong>. For this, both the global parameter ⇒<strong class="userinput"><code>enable_event_handlers</code></strong> as well as the parameter <strong class="userinput"><code>event_handler_enabled</code></strong> must be enabled in the host definition. Nagios executes the global event handler, a normal command object, before the host-specific one. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2081"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>global_host_event_handler=</code></strong><strong class="userinput"><code><em class="replaceable"><code>name_of_the_command-object</code></em></code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>global_service_event_handler</code></strong></span></dt>

          <dd>
            <p>The service-specific equivalent to <strong class="userinput"><code>global_host_event_handler</code></strong>. Apart from ⇒<strong class="userinput"><code>enable_event_handlers</code></strong>, the parameter <strong class="userinput"><code>event_handler_enabled</code></strong> in the service definition must also be enabled. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2082"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>global_service_event_handler=</code></strong><strong class="userinput"><code><em class="replaceable"><code>name_of_command_object</code></em></code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>high_host_flap_threshold</code></strong></span></dt>

          <dd>
            <p>Upper limit of flap detection for host checks. Details are given in <a class="xref" href="../Text/apb.html" title="Appendix B. Rapidly Alternating States: Flapping">Appendix B</a>, page 611. Default value:<a class="indexterm" id="IDX-APP-A-2083"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>high_host_flap_threshold=30.0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>high_service_flap_threshold</code></strong></span></dt>

          <dd>
            <p>Upper limit of flap detection for service checks (see <a class="xref" href="../Text/apb.html" title="Appendix B. Rapidly Alternating States: Flapping">Appendix B</a>). Default value:<a class="indexterm" id="IDX-APP-A-2084"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>high_service_flap_threshold=30.0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>host_check_timeout</code></strong></span></dt>

          <dd>
            <p>Time in seconds after which Nagios aborts a host check if this has not yet returned a result. Default value:<a class="indexterm" id="IDX-APP-A-2085"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>host_check_timeout=30</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>host_freshness_check_interval</code></strong></span></dt>

          <dd>
            <p>Interval between two <span class="emphasis"><em>freshness checks</em></span> in seconds. Default value:<a class="indexterm" id="IDX-APP-A-2086"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>host_freshness_check_interval=60</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>host_inter_check_delay_method</code></strong></span></dt>

          <dd>
            <p>Controls how Nagios processes host checks after a restart. A sophisticated procedure aims to prevent Nagios in this situation from executing all tests simultaneously, and thus overloading the server. Possible values are: <strong class="userinput"><code>s</code></strong> (<span class="emphasis"><em>smart</em></span>, intelligent, automatic distribution of the host checks), <strong class="userinput"><code>n</code></strong> (<span class="emphasis"><em>no</em></span>, all checks start simultaneously), <strong class="userinput"><code>d</code></strong> (<span class="emphasis"><em>dumb</em></span>, Nagios processes the tests at intervals of seconds), and an interval specified in seconds, in the format <strong class="userinput"><code><em class="replaceable"><code>x.xx</code></em></code></strong>. Default value:</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>host_inter_check_delay_method=s</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>host_perfdata_command</code></strong></span></dt>

          <dd>
            <p>A Nagios command object that should check the performance data after every host check. Requires the ⇒<strong class="userinput"><code>process_performance_data</code></strong> parameter to be set.<a class="indexterm" id="IDX-APP-A-2087"/></p>

            <p>This parameter only makes sense in a few cases, since Nagios executes host checks only if necessary, and therefore at very irregular intervals. It is used if performance data are to be processed without a template (<a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a>, page 404). Example (no default value set):</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>host_perfdata_command=process-host-perfdata</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>host_perfdata_file</code></strong></span></dt>

          <dd>
            <p>Specifies a file or named pipe through which Nagios forwards performance data from host checks via a template mechanism to an external program (see <a class="xref" href="../Text/ch19.html" title="Chapter 19. Graphic Display of Performance Data">Chapter 19</a>, page 403). ⇒<strong class="userinput"><code>process_performance_data</code></strong> must be set. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2088"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>host_perfdata_file=/tmp/host-perfdata</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>host_perfdata_file_mode</code></strong></span></dt>

          <dd>
            <p>Defines how data is passed on to the file ⇒<strong class="userinput"><code>host_perf data_file</code></strong>. Possible values are <strong class="userinput"><code>a</code></strong> (<span class="emphasis"><em>append</em></span> to a normal file) or <strong class="userinput"><code>w</code></strong> (<span class="emphasis"><em>write</em></span> to a new file), and for Nagios 3.0 also <strong class="userinput"><code>p</code></strong> (<span class="emphasis"><em>non blocking write</em></span>), which is particularly useful for pipes. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2089"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>host_perfdata_file_mode=a</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>host_perfdata_file_processing_command</code></strong></span></dt>

          <dd>
            <p>Nagios command object that is called after host performance data is passed on to the ⇒<strong class="userinput"><code>host_perf data_file</code></strong> interface. The parameter is only used with the template mechanism and is optional. Programs such as <strong class="userinput"><code>perf2rrd</code></strong> (<a class="xref" href="../Text/ch19s03.html" title="19.3 Preparing Performance Data for Evaluation with Perf2rrd">19.3 Preparing Performance Data for Evaluation with Perf2rrd</a>, page 415) have their own daemon that permanently reads data from the interface. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2090"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>host_perfdata_file_processing_command=process-host-perfdata-file</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>host_perfdata_file_processing_interval</code></strong></span></dt>

          <dd>
            <p>If this interval—specified in seconds—is larger than <strong class="userinput"><code>0</code></strong>, the command belonging to it (⇒<strong class="userinput"><code>host_perfdata_file_processing_command</code></strong>) is run periodically at these intervals. <strong class="userinput"><code>0</code></strong> ensures that it is not used. Example (no default value set):</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>host_perfdata_file_processing_interval=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>host_perfdata_file_template</code></strong></span></dt>

          <dd>
            <p>Describes the output format of the performance data. The Nagios macros and format details in it, such as <strong class="userinput"><code>\t</code></strong> (tabulator) or <strong class="userinput"><code>\n</code></strong> (linefeed) are replaced in the output. More on the use of templates in <a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a>, page 404. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2091"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term">host_perfdata_file_template=$TIMET$\t$HOSTNAME$\t$HOST-EXECUTIONTIME$\t\$HOSTOUTPUT$\t$HOSTPERFDATA$</span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>illegal_macro_output_chars</code></strong></span></dt>

          <dd>
            <p>Lists characters that are discarded when macros are substituted for notifications, to avoid problems such as interpretation by the shell. The parameter has no influence on the substitution of macros in host or service definitions. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2092"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>illegal_macro_output_chars=' ˜$&amp;|'"&lt;&gt;</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>illegal_object_name_chars</code></strong></span></dt>

          <dd>
            <p>Specifies impermissible characters in the names of Nagios objects. It is recommended that at least the characters listed in the following example be specified (no default value set):<a class="indexterm" id="IDX-APP-A-2093"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term">illegal_object_name_chars='˜ !$%^&amp;*|'"&lt;&gt;?, () =</span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>interval_length</code></strong></span></dt>

          <dd>
            <p>Defines the time unit in seconds to which time details in object definitions (such as with <strong class="userinput"><code>normal_check_interval</code></strong> or <strong class="userinput"><code>retry_check_interval</code></strong>) refer. If <strong class="userinput"><code>interval_length</code></strong> is <strong class="userinput"><code>60</code></strong> seconds, the time specification is <strong class="userinput"><code>5</code></strong> five minutes. You should only change the default of 60 seconds if there is good reason to do so. <strong class="userinput"><code>interval_length</code></strong> has no influence on time parameters in <strong class="userinput"><code>nagios.cfg</code></strong>, however. Default value:<a class="indexterm" id="IDX-APP-A-2094"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>interval_length=60</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>lock_file</code></strong></span></dt>

          <dd>
            <p>Specifies a lock file for the Nagios daemon containing the process ID (PID) of the daemon running. Is required for start/stop purposes. Default value:<a class="indexterm" id="IDX-APP-A-2095"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>lock_file=/var/nagios/nagios.lock</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>log_archive_path</code></strong></span></dt>

          <dd>
            <p>The archive directory for rotating Nagios log files. Evaluations are based on the archive files copied there. If one of the files is deleted, the information contained in it is lost. Nagios uses the directory only if log rotation is enabled with the ⇒<strong class="userinput"><code>log_rotation_method</code></strong> parameter. Default value:<a class="indexterm" id="IDX-APP-A-2096"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>log_archive_path=/var/nagios/archives</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>log_event_handlers</code></strong></span></dt>

          <dd>
            <p>Should event handler actions appear in the log file? The parameter is used primarily to search for errors. Default value:</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>log_event_handlers=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>log_external_commands</code></strong></span></dt>

          <dd>
            <p>Should Nagios log external commands (see <a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>, page 292) in the log file? Default value:<a class="indexterm" id="IDX-APP-A-2098"/><a class="indexterm" id="IDX-APP-A-2097"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>log_external_commands=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>log_file</code></strong></span></dt>

          <dd>
            <p>The central log file. Apart from errors and problems, it also retains all events. All history evaluations use this file. For log rotation, Nagios provides a separate mechanism, with ⇒<strong class="userinput"><code>log_rotation_method</code></strong>, and you should not use external programs here. Default value:<a class="indexterm" id="IDX-APP-A-2099"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>log_file=/var/nagios/nagios.log</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>log_host_retries</code></strong></span></dt>

          <dd>
            <p>Specifies whether Nagios should log host check repeats because of an error state. This is absolutely essential if event handlers (see <a class="xref" href="../Text/apc.html" title="Appendix C. Event Handlers">Appendix C</a>, page 619) are used which are to react to soft states. Default value:<a class="indexterm" id="IDX-APP-A-2100"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>log_host_retries=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>log_initial_states</code></strong></span></dt>

          <dd>
            <p>Specifies whether the start state of services and hosts should appear in the log file when the Nagios system is started. Default value:<a class="indexterm" id="IDX-APP-A-2101"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>log_initial_states=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>log_notifications</code></strong></span></dt>

          <dd>
            <p>Defines whether Nagios should also log notifications in the log file. Default value:<a class="indexterm" id="IDX-APP-A-2102"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>log_notifications=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>log_passive_checks</code></strong></span></dt>

          <dd>
            <p>Specifies whether Nagios should log passive checks in the log file. Default value:<a class="indexterm" id="IDX-APP-A-2103"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>log_passive_checks=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>log_rotation_method</code></strong></span></dt>

          <dd>
            <p>Defines whether the log file ⇒<strong class="userinput"><code>log_file</code></strong> should be saved periodically to the archive ⇒<strong class="userinput"><code>log_archive_path</code></strong>. Log rotating should always be left to Nagios itself, rather than any external programs, or otherwise the software will have difficulties in evaluating history data. Possible values are <strong class="userinput"><code>n</code></strong> (<span class="emphasis"><em>none</em></span>, no archiving), <strong class="userinput"><code>h</code></strong> (<span class="emphasis"><em>hourly</em></span>, at the beginning of each hour), <strong class="userinput"><code>d</code></strong> (<span class="emphasis"><em>daily</em></span>, each day at 00:00 hours), <strong class="userinput"><code>w</code></strong> (<span class="emphasis"><em>weekly</em></span>, at midnight from Saturday to Sunday), and <strong class="userinput"><code>m</code></strong> (<span class="emphasis"><em>monthly</em></span>, the first day of each month at 00:00 hours). Default:</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>log_rotation_method=n</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>log_service_retries</code></strong></span></dt>

          <dd>
            <p>Should Nagios log the repeat of a service check because of a soft state error? This is useful for debugging when developing event handlers, but otherwise it is best to leave this out. Default value:<a class="indexterm" id="IDX-APP-A-2104"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>log_service_retries=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>low_host_flap_threshold</code></strong></span></dt>

          <dd>
            <p>Lower limit for flap detection for hosts checks. Details are described in <a class="xref" href="../Text/apb.html" title="Appendix B. Rapidly Alternating States: Flapping">Appendix B</a>, page 611. Default value:<a class="indexterm" id="IDX-APP-A-2105"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>low_host_flap_threshold=20.0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>low_service_flap_threshold</code></strong></span></dt>

          <dd>
            <p>Like <strong class="userinput"><code>low_host_flap_threshold</code></strong>, but for service checks. Default value:<a class="indexterm" id="IDX-APP-A-2106"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>low_service_flap_threshold=20.0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>max_check_result_file_age</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Defines the maximum age of a check result file in seconds, which the Reaper process from the directory <strong class="userinput"><code>check_result_path</code></strong> still processes. Older files are discarded. Example:<a class="indexterm" id="IDX-APP-A-2107"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>max_check_result_file_age=1800</code></strong></span></dt>

                <dd>
                  <p>Check results are only processed here if the accompanying file is not older than 30 minutes. A value of <strong class="userinput"><code>0</code></strong> ignores the age of the result files.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>max_check_result_reaper_time (Nagios 3.0)</code></strong></span></dt>

          <dd>
            <p>Restricts the runtime of an individual Reaper process to the time in seconds specified. Example:<a class="indexterm" id="IDX-APP-A-2108"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>max_check_result_reaper_time=10</code></strong></span></dt>

                <dd>
                  <p>Here the Reaper process is canceled after 10 seconds. Check results left over are processed by the next reaper process.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>max_concurrent_checks</code></strong></span></dt>

          <dd>
            <p>Specifies how many checks Nagios may execute simultaneously. The value <strong class="userinput"><code>0</code></strong> allows an unlimited number. A restriction through a value larger than zero may, under unfavorable circumstances, lead to the test not being executed in time. Default value:<a class="indexterm" id="IDX-APP-A-2109"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>max_concurrent_cnecks=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>max_debug_file_size (Nagios 3.0)</code></strong></span></dt>

          <dd>
            <p>Limits the size of the debugging file to the value specified in bytes. Example:<a class="indexterm" id="IDX-APP-A-2110"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>max_debug_file_size=2048000</code></strong></span></dt>

          <dd>
            <p>If the size exceeds the given value, Nagios adds the ending <strong class="userinput"><code>.old</code></strong> to the file. If a file already exists with the same name, it will be deleted. You must therefore make provision for twice the size specified here, since there could be two files (with and without the suffix <strong class="userinput"><code>.old</code></strong>) with the maximum size at the same time.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>max_host_check_spread</code></strong></span></dt>

          <dd>
            <p>At what time interval (in minutes) should Nagios have started all host checks after a restart? Prevents all tests from being executed simultaneously, which would overload the Nagios server. Default value:<a class="indexterm" id="IDX-APP-A-2111"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>max_host_check_spread=30</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>max_service_check_spread</code></strong></span></dt>

          <dd>
            <p>Like <strong class="userinput"><code>max_host_check_spread</code></strong>, but for service checks. Default value:<a class="indexterm" id="IDX-APP-A-2112"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>max_service_check_spread=30</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>nagios_group</code></strong></span></dt>

          <dd>
            <p>The group with whose permissions the Nagios daemon runs. Default value (is defined during compilation):<a class="indexterm" id="IDX-APP-A-2113"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>nagios_group=nagios</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>nagios_user</code></strong></span></dt>

          <dd>
            <p>The user with whose permissions the Nagios daemon runs. Default value (is defined during compilation):<a class="indexterm" id="IDX-APP-A-2114"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>nagios_user=nagios</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>notification_timeout</code></strong></span></dt>

          <dd>
            <p>After how many seconds should Nagios abort the attempt to deliver a notification? Some actions, such as sending an SMS message, require a certain amount of time, since the system first waits for confirmation from the recipient. The value should therefore not be too low. Default value:<a class="indexterm" id="IDX-APP-A-2115"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>notification_timeout=30</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>object_cache_file</code></strong></span></dt>

          <dd>
            <p>The file in which Nagios stores all objects after it starts. Since the Web interface uses this file, the normal configuration files with the object definitions can be edited while Nagios is running, without jeopardizing the functionality of the Web interface. Default value:<a class="indexterm" id="IDX-APP-A-2116"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>object_cache_file=/var/nagios/objects.cache</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>obsess_over_hosts</code></strong></span></dt>

          <dd>
            <p>Defines in general whether host check results are forwarded to a central Nagios instance. If the parameter is enabled, the command defined in ⇒<strong class="userinput"><code>ocsp_commandis</code></strong> run. This is used in distributed environments; a description can be found in <a class="xref" href="../Text/ch15.html" title="Chapter 15. Distributed Monitoring">Chapter 15</a>, page 317. Default value:<a class="indexterm" id="IDX-APP-A-2117"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>obsess_over_hosts=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>obsess_over_services</code></strong></span></dt>

          <dd>
            <p>Defines in general whether service check results should be forwarded to a central Nagios instance. If the parameter is enabled, the command defined in ⇒<strong class="userinput"><code>ohcp_command</code></strong> is used. This feature is used in distributed environments (see <a class="xref" href="../Text/ch15.html" title="Chapter 15. Distributed Monitoring">Chapter 15</a>, page 317). Default value:<a class="indexterm" id="IDX-APP-A-2118"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>obsess_over_services=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>ochp_command</code></strong></span></dt>

          <dd>
            <p>Defines the <span class="emphasis"><em>obsessive compulsive host processor</em></span>, a Nagios command object that forwards all host check results in a distributed environment to a central instance (see <a class="xref" href="../Text/ch15.html" title="Chapter 15. Distributed Monitoring">Chapter 15</a>, page 317). Example (no default value set):<a class="indexterm" id="IDX-APP-A-2119"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>ochp_command=</code></strong><strong class="userinput"><code><em class="replaceable"><code>name_of_the_command_object</code></em></code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>ochp_timeout</code></strong></span></dt>

          <dd>
            <p>Defines the timeout for the ⇒<strong class="userinput"><code>ochp_command</code></strong>. After this time has expired, Nagios aborts the execution of the command. Default value:<a class="indexterm" id="IDX-APP-A-2120"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>ochp_timeout=15</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>ocsp_command</code></strong></span></dt>

          <dd>
            <p>Specifies the command object that, as the <span class="emphasis"><em>obsessive compulsive service processor</em></span>, should forward all service check results in a distributed environment to a central instance (see <a class="xref" href="../Text/ch15.html" title="Chapter 15. Distributed Monitoring">Chapter 15</a>, page 317). Example (no default value set):<a class="indexterm" id="IDX-APP-A-2121"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>ochp_command=</code></strong><strong class="userinput"><code><em class="replaceable"><code>name_of_the_command_object</code></em></code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>ocsp_timeout</code></strong></span></dt>

          <dd>
            <p>The timeout for the ⇒<strong class="userinput"><code>ocsp_command</code></strong>. After the time specified here has expired, Nagios aborts the execution of the command. Default value:<a class="indexterm" id="IDX-APP-A-2122"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>ocsp_timeout=15</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>passive_host_checks_are_soft</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Normally, the results of passive host checks are always regarded as hard states. With</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>passive_host_checks_are_soft=1</code></strong></span></dt>

                <dd>
                  <p>the same behavior can be set for active host checks. Assigning soft or hard states can now be regulated by the parameter <strong class="userinput"><code>max_check_attempts</code></strong> from the host definition.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>perfdata_timeout</code></strong></span></dt>

          <dd>
            <p>Defines after how many seconds a performance command (⇒<strong class="userinput"><code>host_perfdata_command</code></strong>,⇒<strong class="userinput"><code>service_perfdata_command</code></strong>,⇒<strong class="userinput"><code>host_perf-data_file_processing_command</code></strong>, or ⇒<strong class="userinput"><code>service_perfdata_file_processing_command</code></strong>) should be aborted. Default value:<a class="indexterm" id="IDX-APP-A-2123"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>perfdata_timeout=5</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>precached_object_file</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Starting with Nagios 3.0, it is possible to carry out reading and checking the configuration even before a Nagios restart and to cache the result in the file specified with <strong class="userinput"><code>precached_object_file</code></strong> (see <a class="xref" href="../Text/aphs08.html" title="H.8 Restart">H.8 Restart</a> from page 690). Example:<a class="indexterm" id="IDX-APP-A-2124"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>precached_object_file=/var/nagios/objects.precache</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>process_performance_data</code></strong></span></dt>

          <dd>
            <p>Switches on processing of performance data. This parameter should be enabled only if performance data really is evaluated. Otherwise it only uses up resources on the Nagios server. Default value:<a class="indexterm" id="IDX-APP-A-2125"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>process_performance_data=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>resource_file</code></strong></span></dt>

          <dd>
            <p>The configuration file containing the definitions of the (maximum of 32) <strong class="userinput"><code>$USER</code></strong>χ<strong class="userinput"><code>$</code></strong> macros. <strong class="userinput"><code>$USER1$</code></strong> normally specifies the path to the Nagios plugins. Otherwise you could save passwords here, for example, which should not be readable in the normal Nagios configuration files. The file must then be protected from all external access, and only the user <strong class="userinput"><code>nagios</code></strong> should be able to read it. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2126"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>resource_file=/etc/nagios/resource.cfg</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>retain_state_information</code></strong></span></dt>

          <dd>
            <p>Determines whether Nagios will save current states to a file on shutdown (⇒<strong class="userinput"><code>state_retention_file</code></strong>) and read these again when it starts. Default value:<a class="indexterm" id="IDX-APP-A-2127"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>retain_state_information=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>retention_update_interval</code></strong></span></dt>

          <dd>
            <p>Every how many minutes should Nagios store current state information in the ⇒<strong class="userinput"><code>state_retention_file</code></strong>? With a value of <strong class="userinput"><code>0</code></strong>, the system only saves information if Nagios is shut down. The parameter ⇒<strong class="userinput"><code>retain_state_information</code></strong> must be enabled for this. Default value:</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>retention_update_interval=60</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_check_timeout</code></strong></span></dt>

          <dd>
            <p>Number of seconds after which Nagios aborts a service check if this has not returned a result by then. Default value:<a class="indexterm" id="IDX-APP-A-2128"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_check_timeout=60</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_freshness_check_interval</code></strong></span></dt>

          <dd>
            <p>Interval between two freshness checks in seconds. Default value:<a class="indexterm" id="IDX-APP-A-2129"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_freshness_check_interval=60</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_inter_check_delay_method</code></strong></span></dt>

          <dd>
            <p>Controls how Nagios processes service checks after a restart. An "intelligent" procedure should prevent them from all starting at the same time, to avoid putting an unnecessary load on the server. Possible values are <span class="strong"><strong>s</strong></span> (<span class="emphasis"><em>smart</em></span>, automatic distribution), <span class="strong"><strong>n</strong></span> (<span class="emphasis"><em>no</em></span>, start all tests simultaneously!), <span class="strong"><strong>d</strong></span> (<span class="emphasis"><em>dumb</em></span>, one second interval between checks), as well as an explicitly specified interval in seconds, in the form <span class="emphasis"><em>x. xx</em></span>. Default value:<a class="indexterm" id="IDX-APP-A-2130"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_inter_check_delay_method=s</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_interleave_factor</code></strong></span></dt>

          <dd>
            <p>Prevents the checks accumulating for a specific host from being executed at the same time (⇒<strong class="userinput"><code>max_concurrent_checks</code></strong>, 598), through Nagios distributing the planned checks for all hosts "intelligently" over a period of time. Possible values are <span class="strong"><strong>s</strong></span> (<span class="emphasis"><em>smart</em></span>, automatic distribution) or an integer larger than 0. With a value of <strong class="userinput"><code>1</code></strong>, Nagios does not carry out any distribution, with a value of <span class="strong"><strong>4</strong></span>, Nagios initially plans every fourth service check (that is, from the amount of intended checks, the 1st, 5th, 9th, etc.), then the following number (that is, the 2nd, 6th, 10th, etc.), and so on. The test sequence is shown by the <span class="strong"><strong>Service Detail</strong></span> item in the Web interface. In case of doubt, the default value can be left as it is:<a class="indexterm" id="IDX-APP-A-2131"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_interleave_factor=s</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_perfdata_command</code></strong></span></dt>

          <dd>
            <p>The Nagios command object that is run after each service check to process performance data. A requirement for this is that ⇒<strong class="userinput"><code>process_performance_data</code></strong> must be set.<a class="indexterm" id="IDX-APP-A-2132"/></p>

            <p>The parameter is used if the performance data is to be processed without a template (<a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a>, page 404). Example (no default value set):</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_perfdata_command=process-service-perfdata</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_perfdata_file</code></strong></span></dt>

          <dd>
            <p>Path to the file or named pipe through which Nagios forwards performance data from service checks via a template mechanism to an external program. This only works if ⇒<strong class="userinput"><code>process_performance_data</code></strong> is set. More on processing performance data in <a class="xref" href="../Text/ch19.html" title="Chapter 19. Graphic Display of Performance Data">Chapter 19</a>, page 403. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2133"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_perfdata_file=/tmp/service-perfdata</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_perfdata_file_mode</code></strong></span></dt>

          <dd>
            <p>Defines the mode in which data is passed on to ⇒<strong class="userinput"><code>service_perfdata_file</code></strong>. Possible values are <span class="strong"><strong>a</strong></span> (<span class="emphasis"><em>append</em></span> to a normal file), <span class="strong"><strong>w</strong></span> (<span class="emphasis"><em>write</em></span> to a new file) and in Nagios 3.0 <span class="strong"><strong>p</strong></span> as well (<span class="emphasis"><em>non-blocking write</em></span>), which is useful for pipes. Example (no default value):<a class="indexterm" id="IDX-APP-A-2134"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_perfdata_file_mode=a</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_perfdata_file_processing_command</code></strong></span></dt>

          <dd>
            <p>A command object that is executed after Nagios has passed on service performance data to the ⇒<strong class="userinput"><code>service_perfdata_file</code></strong>. The parameter is optional and is only used together with the template mechanism. As long as programs that further process the data, such as <strong class="userinput"><code>perf2rrd</code></strong> (<a class="xref" href="../Text/ch19s03.html" title="19.3 Preparing Performance Data for Evaluation with Perf2rrd">19.3 Preparing Performance Data for Evaluation with Perf2rrd</a>, page 415), include their own service that permanently reads out the <strong class="userinput"><code>service_perfdata_file</code></strong>, you can manage without defining a command for reading out. See also <a class="xref" href="../Text/ch19.html" title="Chapter 19. Graphic Display of Performance Data">Chapter 19</a>, page 403. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2135"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_perfdata_file_processing_command=process-service-perfdata-file</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_perfdata_file_processing_interval</code></strong></span></dt>

          <dd>
            <p>Interval in seconds in which the command defined in ⇒<strong class="userinput"><code>service_perfdata_file_processing_command</code></strong> is periodically run. Setting the value <strong class="userinput"><code>0</code></strong> ensures that it is never used. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2136"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_perfdata_file_processing_interval=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_perfdata_file_template</code></strong></span></dt>

          <dd>
            <p>The output format for performance data; Nagios macros and format details such as <strong class="userinput"><code>\t</code></strong> (tabulator) or <strong class="userinput"><code>\n</code></strong> (linefeed) are substituted in the output. See also <a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a>, page 404. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2137"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_perfdata_file_template=$TIMET$\t$HOSTNAME$\t$SERVICEDESC$\t$SERVICEEXECUTIONTIME$\t$SERVICELATENCY$\t$SERVICEOUTPUT$\t$SERVICEPERFDATA$</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>service_reaper_frequency</code></strong> (Nagios 2.x)</span></dt>

          <dd>
            <p>Every how many seconds should Nagios process accumulated service test results? Default value:<a class="indexterm" id="IDX-APP-A-2138"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>service_reaper_frequency=10</code></strong></span></dt>

                <dd>
                  <p>In Nagios 3.0 the corresponding parameter is called ⇒check_result_reaper_frequency and influences not only service checks but also host checks.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>sleep_time</code></strong></span></dt>

          <dd>
            <p>Pause in seconds for which Nagios waits before searching again in the scheduling queue for checks to be performed. Default value:<a class="indexterm" id="IDX-APP-A-2139"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>sleep_time=0.5</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>state_retention_file</code></strong></span></dt>

          <dd>
            <p>The file in which Nagios stores status information on shutdown, and from which the information is read in again when Nagios is started. This is used only if the ⇒<strong class="userinput"><code>retain_state_information</code></strong> parameter is set. Default value:<a class="indexterm" id="IDX-APP-A-2140"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>state_retention_file=/var/nagios/retention.dat</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>status_file</code></strong></span></dt>

          <dd>
            <p>Path to the file in which Nagios saves all current status values and from which the Web interface retrieves them. Default value:<a class="indexterm" id="IDX-APP-A-2141"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>status_file=/var/nagios/status.dat</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>status_update_interval</code></strong></span></dt>

          <dd>
            <p>At what interval should Nagios store status values in the file⇒<strong class="userinput"><code>status_file</code></strong>? If ⇒<strong class="userinput"><code>aggregate_status_updates</code></strong> is not set, the system ignores this parameter and immediately writes the status values to this file (not recommended). Default value:<a class="indexterm" id="IDX-APP-A-2142"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>status_update_interval=60</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>temp_file</code></strong></span></dt>

          <dd>
            <p>Path to a temporary file that Nagios uses if necessary, and deletes each time when it no longer requires it. Default value:<a class="indexterm" id="IDX-APP-A-2143"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>temp_file=/var/nagios/tempfile</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>temp_path</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>A directory in which Nagios may store temporary files. The directory should be emptied regularly. Example:<a class="indexterm" id="IDX-APP-A-2144"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>temp_path=/tmp</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>translate_passive_host_checks</code></strong>(Nagios 3.0)</span></dt>

          <dd>
            <p>Determines whether Nagios should translate the result of a passive host check from a topological perspective to DOWN or UNREACHABLE. The default is "no":</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>translate_passive_host_checks=0</code></strong></span></dt>

                <dd>
                  <p>Passive host checks are often used in distributed environments, and Nagios does not have all the information concerning the topological structure of these environments. In that case, the default makes sense. The value 1 switches the translation to DOWN or UNREACHABLE.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>use_aggressive_host_checking</code></strong></span></dt>

          <dd>
            <p>Nagios makes a number of assumptions in deciding whether unreachable hosts are DOWN or UNREACHABLE. If this parameter is set to the value <span class="strong"><strong>1</strong></span>, Nagios is very particular in the host check and in some circumstances may perform considerably more individual checks. Although the result will be more precise, this puts quite a strain on the system. This parameter should only be set if there are problems in detecting failed hosts. Default:<a class="indexterm" id="IDX-APP-A-2145"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>use_aggressive_host_checking=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>use_embedded_perl_implicitly</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Automatically runs all Perl scripts in the Embedded Perl Interpreter, provided the script itself does not contain an explicit instruction to avoid the Interpreter. More on this in <a class="xref" href="../Text/apgs02.html" title="G.2 Using ePN">G.2 Using ePN</a>, page 672.<a class="indexterm" id="IDX-APP-A-2146"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>use_large_installation_tweaks</code></strong>(Nagios 3.0)</span></dt>

          <dd>
            <p>This parameter covers a number of settings intended to improve the performance of Nagios in large environments. The following entry switches it on:<a class="indexterm" id="IDX-APP-A-2147"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>use_large_installation_tweaks=1</code></strong></span></dt>

                <dd>
                  <p>There is more on this in <a class="xref" href="../Text/apfs03.html#optimizing_large_nagios_environmen" title="F.2.7 Optimizing large Nagios environments">F.2.7 Optimizing large Nagios environments</a>, page 667.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>use_regexp_matching</code></strong></span></dt>

          <dd>
            <p>Defines whether the wildcards <strong class="userinput"><code>*</code></strong> (any character) and <strong class="userinput"><code>?</code></strong> (a single character) are allowed in object definitions. If you want to work with regular expressions, ⇒<strong class="userinput"><code>use_true_regexp_matching</code></strong> must be used. Default value:<a class="indexterm" id="IDX-APP-A-2148"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>use_regexp_matching=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>use_retained_program_state</code></strong></span></dt>

          <dd>
            <p>Should changes to the parameters ⇒<strong class="userinput"><code>enable_notifications</code></strong>, ⇒<strong class="userinput"><code>en-able_flap_detection</code></strong>, ⇒<strong class="userinput"><code>enable_event_handlers</code></strong>, ⇒<strong class="userinput"><code>execute_service_checks</code></strong> and ⇒<strong class="userinput"><code>accept_passive_service_checks</code></strong> on the Web interface survive a Nagios restart? Only works if ⇒<strong class="userinput"><code>retain_status_informationis</code></strong> enabled. Default value:<a class="indexterm" id="IDX-APP-A-2149"/><a class="indexterm" id="IDX-APP-A-2150"/><a class="indexterm" id="IDX-APP-A-2151"/><a class="indexterm" id="IDX-APP-A-2152"/><a class="indexterm" id="IDX-APP-A-2153"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>use_retained_program_state=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>use_retained_scheduling_info</code></strong></span></dt>

          <dd>
            <p>Should Nagios save current scheduling information on shutdown so it can read it in again when it restarts? You can temporarily disable the parameter if you are adding a large number of tests; otherwise it is sensible to keep it enabled. Default value:<a class="indexterm" id="IDX-APP-A-2154"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>use_retained_scheduling_info=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>use_syslog</code></strong></span></dt>

          <dd>
            <p>Ensures logging of all Nagios activities in the syslog. Default value:<a class="indexterm" id="IDX-APP-A-2155"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>use_syslog=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>use_timezone</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Explicitly sets a time zone for Nagios. Normally, Nagios uses the time zone of the system on which it is running. This parameter is only required if several instances for different time zones are being run on one host. Example:<a class="indexterm" id="IDX-APP-A-2156"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>use_timezone=Europe/Berlin</code></strong></span></dt>

                <dd>
                  <p>The relative path for the desired zone information file is specified, usually in <strong class="userinput"><code>/usr/lib/zoneinfo</code></strong> or <strong class="userinput"><code>/usr/share/zoneinfo</code></strong>.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>use_true_regexp_matching</code></strong></span></dt>

          <dd>
            <p>In contrast to ⇒<strong class="userinput"><code>use_regexp_matching</code></strong>, allows the use of real regular expressions in accordance with the POSIX standard.<sup>[<a class="footnote" href="#ftn.APP-A-FN-1" id="APP-A-FN-1">304</a>]</sup> Default value:<a class="indexterm" id="IDX-APP-A-2157"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>use_true_regexp_matching=0</code></strong></span></dt>
              </dl>
            </div>
          </dd>
        </dl>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-A-FN-1" id="ftn.APP-A-FN-1">304</a>]</sup> See man 7 regex.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="A.2 CGI Configuration in cgi.cfg">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="cgi_configuration_in_cgi.cfg-id1"/>A.2 CGI Configuration in <strong class="userinput"><code>cgi.cfg</code></strong></h1>
    </div>

    <div class="sect2" title="A.2.1 Authentication parameters">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="authentication_parameters"/>A.2.1 Authentication parameters</h2>
      </div>

      <p>Through the contact and the contact group, Nagios allocates responsibilities to users from which permissions for the Web interface can likewise be inferred: each contact may normally only see those hosts and services for which he is also responsible. This is why the name of the Web login must match the contact name.<a class="indexterm" id="IDX-APP-A-2159"/><a class="indexterm" id="IDX-APP-A-2160"/><a class="indexterm" id="IDX-APP-A-2161"/><a class="indexterm" id="IDX-APP-A-2158"/></p>

      <p>The parameters listed below work around this concept to some extent. They are not intended to solve problems, however, caused by contact and Web user names not matching.</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term">cmduse_authentication</span></dt>

          <dd>
            <p>Determines whether you normally need to log in to the Web interface. Like the user name, the contact name is always used; how you store passwords is described in <a class="xref" href="../Text/ch01s05.html" title="1.5 Configuration of the Web Interface">1.5 Configuration of the Web Interface</a>, page 47.</p>

            <p>In general you should never permit this authentication, but if you do, you should make sure that the interface for external commands (<a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>, page 292) is switched off completely. Default:</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>use_authentication=1</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>authorized_for_all_host_commands</code></strong></span></dt>

          <dd>
            <p>Allows the users specified here to run commands through the Web interface for all hosts, without them belonging to the appropriate contact group. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2162"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>authorized_for_all_host_commands=nagiosadmin</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>authorized_for_all_hosts</code></strong></span></dt>

          <dd>
            <p>Allows the users specified here to look at all host information, irrespective of their actual responsibility Example (no default value set):<a class="indexterm" id="IDX-APP-A-2163"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>authorized_for_all_hosts=nagiosadmin.guest</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>authorized_for_all_service_commands</code></strong></span></dt>

          <dd>
            <p>Allows the users defined here to run commands for all services via the Web interface, independently of membership of contact groups. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2164"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>authorized_for_all_service_commands=nagiosadmin</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>authorized_for_all_services</code></strong></span></dt>

          <dd>
            <p>Allows the users specified to view all service information, irrespective of their own permissions. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2165"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>authorized_for_all_services=nagiosadmin,guest</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>authorized_for_configuration_information</code></strong></span></dt>

          <dd>
            <p>Enables the users specified to view all configuration data via the Web interface. This should be reserved for the Nagios administrators. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2166"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>authorized_for_configuration_information=nagiosadmin,jdoe</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>authorized_for_system_commands</code></strong></span></dt>

          <dd>
            <p>Allows the specified users to shut down or restart Nagios via the Web interface. Normally, nobody has this authorization. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2167"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>authorized_for_system_commands=nagiosadmin</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>authorized_for_system_information</code></strong></span></dt>

          <dd>
            <p>Allows the specified users to view Nagios process information. Normally, nobody may do this. Example (no default value set):</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>authorized_for_system_information=nagiosadmin,theboss,jdoe</code></strong></span></dt>
              </dl>
            </div>
          </dd>
        </dl>
      </div>
    </div>

    <div class="sect2" title="A.2.2 Other Parameters">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="other_parameters"/>A.2.2 Other Parameters</h2>
      </div>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>action_url_target</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Sets the HTML tag <strong class="userinput"><code>target</code></strong> for an action URL (see <a class="xref" href="../Text/ch16s04.html#extended_host_information" title="16.4.1 Extended host information">16.4.1 Extended host information</a>). The default is <strong class="userinput"><code>blank</code></strong>, which opens a new window:<a class="indexterm" id="IDX-APP-A-2168"/><a class="indexterm" id="IDX-APP-A-2169"/><a class="indexterm" id="IDX-APP-A-2170"/><a class="indexterm" id="IDX-APP-A-2171"/><a class="indexterm" id="IDX-APP-A-2172"/><a class="indexterm" id="IDX-APP-A-2173"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>action_url_target=blank</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>default_statusmap_layout</code></strong></span></dt>

          <dd>
            <p>Defines the layout for the status map. Possible values are <span class="strong"><strong>0</strong></span> (coordinates defined through a <span class="strong"><strong>hostextinfo</strong></span> object), <span class="strong"><strong>1</strong></span> (the user must move by mouse click from one layer to the next one), <span class="strong"><strong>2</strong></span> (compressed tree—somewhat confusing, because branches cut across each other in the picture), <span class="strong"><strong>3</strong></span> (balanced tree, the branches are displayed so that there are no crossovers in the graphic—clearer, but requires much space), <span class="strong"><strong>4</strong></span> (circular representation, with Nagios at the center: hosts that can be reached directly<sup>[<a class="footnote" href="#ftn.APP-A-FN-2" id="APP-A-FN-2">305</a>]</sup> are shown in the inner circle, while on other circles are located those hosts that can be reached from hosts already entered in the graphic), <span class="strong"><strong>5</strong></span> (circular, like <span class="strong"><strong>4</strong></span>; the area around the host is marked in color—gray for OK, red for DOWN or UNREACHABLE; Figure A.27 in <a class="xref" href="../Text/ch16s02.html#the_most_important_things_at_a_glance_c" title="16.2.4 The most important things at a glance: tac.cgi">16.2.4 The most important things at a glance: tac.cgi</a> shows an example), and <span class="strong"><strong>6</strong></span> (circular; the hosts are shown as balloons). The settings can also be changed in the Web interface without the need to adjust the configuration file each time, which makes it easier to try things out. Example:<a class="indexterm" id="IDX-APP-A-2174"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>default_statusmap_layout=5</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>default_statuswrl_layout</code></strong></span></dt>

          <dd>
            <p>Determines the layout for the VRML representation of the status page through <strong class="userinput"><code>statuswrl.cgi</code></strong>. Possible values are <span class="strong"><strong>0</strong></span>, <span class="strong"><strong>2</strong></span>, <span class="strong"><strong>3</strong></span>, and <span class="strong"><strong>4</strong></span>; the corresponding appearance is based on the values of the same name for ⇒<strong class="userinput"><code>default_statusmap_layout</code></strong>. Example:<a class="indexterm" id="IDX-APP-A-2175"/><a class="indexterm" id="IDX-APP-A-2176"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>default_statuswrl_layout=4</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>default_user_name</code></strong></span></dt>

          <dd>
            <p>Name of a guest user who may use the Web pages without authentication. You should only use this parameter if the Web server is protected from unauthorized access, and you should look closely at what permissions this user is allocated through the contact groups. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2177"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>default_user_name=guest</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>enable_splunk_integration</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Activates integration of the Splunk tool, a search engine for log files.<sup>[<a class="footnote" href="#ftn.APP-A-FN-3" id="APP-A-FN-3">306</a>]</sup><a class="indexterm" id="IDX-APP-A-2178"/><a class="indexterm" id="IDX-APP-A-2179"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>escape_html_tags</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>The value <span class="strong"><strong>1</strong></span> disables HTML formatting in the plugin output:<a class="indexterm" id="IDX-APP-A-2180"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>escape_html_tags=1</code></strong></span></dt>

                <dd>
                  <p>Corresponding formatting thus has no effect. The default is <strong class="userinput"><code>0</code></strong>, which causes HTML formatting to be passed on.</p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>lock_author_name</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>For various CGI actions, such as setting acknowledgements, an author name is specified. With the setting</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>lock_author_names=1</code></strong></span></dt>

                <dd>
                  <p>this can no longer be changed (the default is the user logged in).<a class="indexterm" id="IDX-APP-A-2181"/></p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>main_config_file</code></strong></span></dt>

          <dd>
            <p>The Nagios main configuration file. Default value:<a class="indexterm" id="IDX-APP-A-2182"/><a class="indexterm" id="IDX-APP-A-2183"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>main_config_file=/etc/nagios/nagios.cfg</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>notes_url_target</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Sets the HTML tag <strong class="userinput"><code>target</code></strong> for Notes URLs (see <a class="xref" href="../Text/ch16s04.html#extended_host_information" title="16.4.1 Extended host information">16.4.1 Extended host information</a>). The default is <strong class="userinput"><code>blank</code></strong>, which opens a new window:<a class="indexterm" id="IDX-APP-A-2184"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>notes_url_target=blank</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>physical_html_path</code></strong></span></dt>

          <dd>
            <p>Path in the file system that leads to the Nagios directory for documentation and images. See also ⇒<strong class="userinput"><code>url_html_path</code></strong>. Default value:<a class="indexterm" id="IDX-APP-A-2185"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>physical_html_path=/usr/local/nagios/share</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>refresh_rate</code></strong></span></dt>

          <dd>
            <p>Specifies at what intervals the Web page is automatically updated. Default value:<a class="indexterm" id="IDX-APP-A-2186"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>refresh_rate=60</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>splunk_url</code></strong> (Nagios 3.0)</span></dt>

          <dd>
            <p>Defines the URL for the Splunk search engine. Example:<a class="indexterm" id="IDX-APP-A-2187"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>splunk_url=http://127.0.0.1:8000/</code></strong></span></dt>

                <dd>
                  <p>The parameter ⇒<strong class="userinput"><code>enable_splunk_integration</code></strong> (<a class="xref" href="../Text/apas02.html#other_parameters" title="A.2.2 Other Parameters">A.2.2 Other Parameters</a>) must also be enabled for this.<a class="indexterm" id="IDX-APP-A-2188"/></p>
                </dd>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>statusmap_background_image</code></strong></span></dt>

          <dd>
            <p>The background image for the status map display. Example (no default value set):</p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>statusmap_background_image=smbackground.gd2</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>statuswrl_include</code></strong></span></dt>

          <dd>
            <p>A file with its own VRML objects used in the VRML representation. The path is specified relative to ⇒<strong class="userinput"><code>html_physical_path</code></strong>. Example (no default value set):<a class="indexterm" id="IDX-APP-A-2189"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>statuswrl_include=myworld.wrl</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>url_html_path</code></strong></span></dt>

          <dd>
            <p>The logical path to the Nagios documents and images from the point of view of the browser, starting from the document root of the Web server. If you use this path in a URL, you will be taken to the Nagios start page. Default value:<a class="indexterm" id="IDX-APP-A-2190"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>url_html_path=/nagios</code></strong></span></dt>
              </dl>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code><strong class="userinput"><code>use_pending_states</code></strong> (Nagios 3.0)</code></strong></span></dt>

          <dd>
            <p>How should hosts and services be displayed in the Web interface if no check has yet taken place for this?<a class="indexterm" id="IDX-APP-A-2191"/></p>

            <div class="variablelist">
              <dl>
                <dt><span class="term"><strong class="userinput"><code>use_pending_states=1</code></strong></span></dt>

                <dd>
                  <p>shows unchecked hosts and services with the state <strong class="userinput"><code>PENDING</code></strong>; the value <strong class="userinput"><code>0</code></strong> can be left as it is.</p>
                </dd>
              </dl>
            </div>
          </dd>
        </dl>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-A-FN-2" id="ftn.APP-A-FN-2">305</a>]</sup> That is, without the "diversion" via parents.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-A-FN-3" id="ftn.APP-A-FN-3">306</a>]</sup> <a class="ulink" href="http://www.splunk.com/">http://www.splunk.com/</a></p>
      </div>
    </div>
  </div>


  <div class="appendix" title="Appendix&#xA0;B.&#xA0;Rapidly Alternating States: Flapping">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="rapidly_alternating_states_colon_flapp"/>Appendix B. Rapidly Alternating States: Flapping</h1>
    </div>

    <p>If the state of a host or service keeps on changing over and over, Nagios inundates the administrator with a flood of problem and recovery messages, which can not only be very irritating but also distract the administrator's attention from other, perhaps more urgent problems.</p>

    <p>With a special mechanism, Nagios quickly recognizes alternating states and can inform the administrator of these selectively. The Nagios documentation refers to such alternating states as <span class="emphasis"><em>state flapping</em></span> and to their detection as <span class="emphasis"><em>flap detection</em></span>.</p>

    <p>Whether these alternating states involve hosts or services has no influence on the detection mechanism itself. The differences are more to be found in the nature of host and service checks: Nagios carries out service checks periodically, and therefore regularly. In this way the system continuously receives new information on the current status. Regular host checks only make sense from Nagios 3.0 onward (see <a class="xref" href="../Text/aphs07.html" title="H.7 A New Logic for Host Checks">H.7 A New Logic for Host Checks</a> from page 689). In Nagios 2.x, host checks generally take place only if needed, so Nagios has to obtain the appropriate information in other ways.</p>

    <div class="sect1" title="B.1 Flap Detection with Services">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="flap_detection_with_services"/>B.1 Flap Detection with Services</h1>
      </div>

      <p>To detect alternating states you need a complete list of all states that occurred during the last service checks. For this purpose Nagios stores the last 21 test results for each service and then overwrites the oldest value in each case in the memory. In these 21 states, a maximum of 20 changes can occur.<a class="indexterm" id="IDX-APP-B-2192"/><a class="indexterm" id="IDX-APP-B-2193"/></p>

      <p><a class="xref" href="../Text/apb.html#nagios_saves_the_last_21_states_to_detec" title="Figure B-1. Nagios saves the last 21 states to detect frequently alternating states. This service changed its state twelve times">Figure B-1</a> shows an example. The x-axis numbers the possible alternating states in each case from 1 to 20, and the heads of the arrow indicate alternating states that have actually occurred.</p>

      <div class="figure">
        <a id="nagios_saves_the_last_21_states_to_detec"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e54436"/><img alt="Nagios saves the last 21 states to detect frequently alternating states. This service changed its state twelve times" src="../Images/tagoreillycom20081104nostarchimages224014.png.jpg"/></div>

        <p class="title">Figure B-1. Nagios saves the last 21 states to detect frequently alternating states. This service changed its state twelve times</p>
      </div>

      <p>In the period specified, the state of the system shown changed 12 times out of a possible 20, which as a percentage is 60 percent. At 0 percent, not one alternation state has taken place, and 100% means that the service really was in a different state every time it was recorded.</p>

      <p>When determining the percentage value, Nagios assigns less significance to older changes of state than to more recent ones. Accordingly it weights the oldest change in state at <strong class="userinput"><code>1</code></strong> in <a class="xref" href="../Text/apb.html#nagios_saves_the_last_21_states_to_detec" title="Figure B-1. Nagios saves the last 21 states to detect frequently alternating states. This service changed its state twelve times">Figure B-1</a> with 0.8, and the most recent at <strong class="userinput"><code>20</code></strong> with 1.2. From left to right, the factor increases each time by approx. 0.02,<sup>[<a class="footnote" href="#ftn.APP-B-FN-1" id="APP-B-FN-1">307</a>]</sup> resulting in a linear progression.</p>

      <p>This weighting does not have any major effects on the end result in this example: for <a class="xref" href="../Text/apb.html#nagios_saves_the_last_21_states_to_detec" title="Figure B-1. Nagios saves the last 21 states to detect frequently alternating states. This service changed its state twelve times">Figure B-1</a>, this results in 62.21 percent (instead of 60), a slight shift, since the state in the second half changed more often. If there was only a single change of state at <strong class="userinput"><code>20</code></strong>, the weighting would have the most effect: instead of 5% (that is, one change out of a possible 20) this would result in 5 * 1.2 = 6 percent.</p>

      <p>Using threshold values which can be defined—two for services, two for hosts—Nagios defines whether a service or host is "flapping". Both the upper and lower limits are specified as percentages. If the detected change state exceeds the upper threshold, Nagios categorizes the service as <span class="emphasis"><em>flapping</em></span>. This has consequences: Nagios logs the event in the log file, adds a nonpermanent comment,<sup>[<a class="footnote" href="#ftn.APP-B-FN-2" id="APP-B-FN-2">308</a>]</sup> and stops any notifications concerning this from being sent.<a class="indexterm" id="IDX-APP-B-2194"/></p>

      <p>If the percentage value falls below the lower limit, the system undoes this step; that is, the comment disappears, notifications are sent again, and the result also appears in the log file.</p>

      <div class="sect2" title="B.1.1 Nagios configuration">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="nagios_configuration-id6"/>B.1.1 Nagios configuration</h2>
        </div>

        <p>Flap detection is configured at two locations: in the central configuration file and in the definition of the service object. In <strong class="userinput"><code>nagios.cfg</code></strong> the feature is switched on generally with the parameter <strong class="userinput"><code>enable_flap_detection</code></strong>, and global limit values are also defined here, which will always apply if nothing else is defined for the service in question:<a class="indexterm" id="IDX-APP-B-2195"/></p><a id="I_programlisting_d1e54494"/>
        <pre class="programlisting"># /etc/nagios/nagios.cfg
...
enable_flap_detection=1
low_service_flap_threshold=5.0
high_service_flap_threshold=20.0
...</pre>

        <p>The value <strong class="userinput"><code>1</code></strong> set here for <strong class="userinput"><code>enable_flap_detection</code></strong> enables flap detection, and <strong class="userinput"><code>0</code></strong> switches it off.<a class="indexterm" id="IDX-APP-B-2196"/><a class="indexterm" id="IDX-APP-B-2197"/><a class="indexterm" id="IDX-APP-B-2198"/></p>

        <p>The lower limit <strong class="userinput"><code>low_service_flap_threshold</code></strong> lies at 5 percent in this case, the upper <strong class="userinput"><code>high_service_flap_threshold</code></strong> limit at 20. This means that Nagios categorizes a service as flapping if the history saved detects at least five changes in state (more than four out of a possible 20).<sup>[<a class="footnote" href="#ftn.APP-B-FN-3" id="APP-B-FN-3">309</a>]</sup> The lower five percent limit corresponds to one change in state. To drop below this, all 21 states must be identical.<sup>[<a class="footnote" href="#ftn.APP-B-FN-4" id="APP-B-FN-4">310</a>]</sup></p>

        <p>In the definition of a service object, you have another chance to decide whether flap detection is desired in this case. You also have an option to specify threshold values for this service that differ from the global settings:</p><a id="I_programlisting_d1e54535"/>
        <pre class="programlisting">define service{
    host_name              linux01
    service_description    NTP
    ...
    flap_detection_enabled 1
    low_flap_threshold     5.0
    high_flap_threshold    20.0
    ...
}</pre>

        <p>The value <strong class="userinput"><code>1</code></strong> in <strong class="userinput"><code>flap_detection_enabled</code></strong> switches on the feature for this service, and <strong class="userinput"><code>0</code></strong> (the default) switches it off. The two limit values <strong class="userinput"><code>low_flap_threshold</code></strong> and <strong class="userinput"><code>high_flap_threshold</code></strong> define the limit values that override the globally defined values. If they are set to <strong class="userinput"><code>0</code></strong>, or are omitted, the global thresholds will apply.<a class="indexterm" id="IDX-APP-B-2199"/><a class="indexterm" id="IDX-APP-B-2200"/></p>

        <p>Starting with Nagios 3.0, the parameter <strong class="userinput"><code>flap_detection_options</code></strong> enables only specified states to be taken into account when detecting changes in states. Possible values are <strong class="userinput"><code>o</code></strong> (OK), <strong class="userinput"><code>w</code></strong> (WARNING), <strong class="userinput"><code>c</code></strong> (CRITICAL), and <strong class="userinput"><code>u</code></strong> (UNKNOWN). The default is</p><a id="I_programlisting_d1e54581"/>
        <pre class="programlisting">flap_detection_options u,w,c,u</pre>

        <p>If the values are restricted to <strong class="userinput"><code>w</code></strong>, <strong class="userinput"><code>c</code></strong>, only WARNING and CRITICAL play a role in detection; the other states are ignored. Nagios 3.0 also saves states when flap detection is switched off globally and introduces a corresponding new message type. More on this in <a class="xref" href="../Text/aphs04.html" title="H.4 Rapidly Changing States">H.4 Rapidly Changing States</a> from page 687.</p>
      </div>

      <div class="sect2" title="B.1.2 The history memory and the chronological progression of the changes in state">
        <div class="titlepage">
          <h2 class="title" id="heading_id_5"><a id="the_history_memory_and_the_chronological"/>B.1.2 The history memory and the chronological progression of the changes in state</h2>
        </div>

        <p>Since the history only saves hard states and soft recovery, the sections on the x-axis cannot be allocated so easily on a chronological basis, because the intervals between possible changes of state are not equal. Assuming that the service object has the following definitions:</p><a id="I_programlisting_d1e54598"/>
        <pre class="programlisting">max_check_attempts    3
normal_check_interval                 5
retry_check_interval                  1</pre>

        <p>Nagios checks the service two more times after a change in state from OK to WARNING has taken place, before the service changes to the hard state WARNING (state 1 in <a class="xref" href="../Text/apb.html#nagios_saves_the_last_21_states_to_detec" title="Figure B-1. Nagios saves the last 21 states to detect frequently alternating states. This service changed its state twelve times">Figure B-1</a> in page 612). Since the last check, which returned OK, a total of seven minutes<sup>[<a class="footnote" href="#ftn.APP-B-FN-5" id="APP-B-FN-5">311</a>]</sup> has elapsed, since the two soft states after five and six minutes are not included in the history.<a class="indexterm" id="IDX-APP-B-2201"/><a class="indexterm" id="IDX-APP-B-2202"/><a class="indexterm" id="IDX-APP-B-2203"/><a class="indexterm" id="IDX-APP-B-2204"/></p>

        <p>If the next service check, as in <a class="xref" href="../Text/apb.html#nagios_saves_the_last_21_states_to_detec" title="Figure B-1. Nagios saves the last 21 states to detect frequently alternating states. This service changed its state twelve times">Figure B-1</a>, again detects a WARNING (i.e., the state does not change this time), then only five minutes elapse this time between states 1 and 2. The x-axis therefore only illustrates time in a linear form in exceptional circumstances—if no change of state occurs, for example.</p>
      </div>

      <div class="sect2" title="B.1.3 Representation in the Web interface">
        <div class="titlepage">
          <h2 class="title" id="heading_id_6"><a id="representation_in_the_web_interface"/>B.1.3 Representation in the Web interface</h2>
        </div>

        <p>Services that Nagios categorizes as flapping are visible in the Web interface at three points: in the summaries generated by <strong class="userinput"><code>tac.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#the_most_important_things_at_a_glance_c" title="16.2.4 The most important things at a glance: tac.cgi">16.2.4 The most important things at a glance: tac.cgi</a>, page 345) and <strong class="userinput"><code>status.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#variations_in_status_display_colon_stat" title="16.2.1 Variations in status display: status.cgi">16.2.1 Variations in status display: status.cgi</a>, page 334), as well as on the information page created by <strong class="userinput"><code>extinfo.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#additional_information_and_control_cent" title="16.2.2 Additional information and control center: extinfo.cgi">16.2.2 Additional information and control center: extinfo.cgi</a>, page 339).<a class="indexterm" id="IDX-APP-B-2205"/><a class="indexterm" id="IDX-APP-B-2206"/><a class="indexterm" id="IDX-APP-B-2207"/><a class="indexterm" id="IDX-APP-B-2208"/></p>

        <p>The quickest way to get there is through <strong class="userinput"><code>tac.cgi</code></strong> (<a class="xref" href="../Text/apb.html#tac.cgi_notes_changing_states_in_section" title="Figure B-2. tac.cgi notes changing states in section Monitoring Features">Figure B-2</a>): a link in the <strong class="userinput"><code>Monitoring Features</code></strong> section marked by <strong class="userinput"><code>x Services Flapping</code></strong> takes you to the status overview of services which continually change their state. The status overview shown in <a class="xref" href="../Text/apb.html#animated_horizontal_bars_denote_flapping" title="Figure B-3. Animated horizontal bars denote flapping states">Figure B-3</a> can also be opened directly with <strong class="userinput"><code>status.cgi?host=all&amp;style=detail&amp;serviceprops=1024</code></strong>.</p>

        <p><strong class="userinput"><code>serviceprops=1024</code></strong> describes all services that Nagios categorizes as flapping. <strong class="userinput"><code>style=detail</code></strong> provides a detailed view (in contrast to <strong class="userinput"><code>overview</code></strong>, as can be seen in Figure B.10 in <a class="xref" href="../Text/ch16s02.html" title="16.2 An Overview of the Individual CGI Programs">16.2 An Overview of the Individual CGI Programs</a>), and <strong class="userinput"><code>host=all</code></strong> includes all hosts.</p>

        <div class="figure">
          <a id="tac.cgi_notes_changing_states_in_section"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e54701"/><img alt="tac.cgi notes changing states in section Monitoring Features" src="../Images/tagoreillycom20081104nostarchimages224016.png.jpg"/></div>

          <p class="title">Figure B-2. <code class="userinput">tac.cgi</code> notes changing states in section <code class="userinput">Monitoring Features</code></p>
        </div>

        <p>In the status view in <a class="xref" href="../Text/apb.html#animated_horizontal_bars_denote_flapping" title="Figure B-3. Animated horizontal bars denote flapping states">Figure B-3</a>, a white field with several horizontal gray bars moving to and fro reveal that a flapping service is involved. At the same time a white speech bubble denotes the existence of a comment on this (generated automatically by Nagios).</p>

        <div class="figure">
          <a id="animated_horizontal_bars_denote_flapping"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e54713"/><img alt="Animated horizontal bars denote flapping states" src="../Images/tagoreillycom20081104nostarchimages224018.png.jpg"/></div>

          <p class="title">Figure B-3. Animated horizontal bars denote flapping states</p>
        </div>

        <p>If you click in the status view on the flapping icon next to the service in question, <strong class="userinput"><code>extinfo.cgi</code></strong> generates additional information on the service (<a class="xref" href="../Text/apb.html#percent_state_change_colon_reveals_how_o" title="Figure B-4. Percent State Change: reveals how often the hard state changed, as a percentage">Figure B-4</a>), showing the changes in state in percent next to the flapping category, depicted by a red bar labeled with <span class="strong"><strong>YES</strong></span>.<a class="indexterm" id="IDX-APP-B-2209"/></p>

        <div class="figure">
          <a id="percent_state_change_colon_reveals_how_o"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e54736"/><img alt="Percent State Change: reveals how often the hard state changed, as a percentage" src="../Images/tagoreillycom20081104nostarchimages224020.png.jpg"/></div>

          <p class="title">Figure B-4. <code class="userinput">Percent State Change</code>: reveals how often the hard state changed, as a percentage</p>
        </div>

        <p>The page also contains the nonpermanent comment generated by Nagios (<a class="xref" href="../Text/apb.html#with_this_comment_comma_nagios_categoriz" title="Figure B-5. With this comment, Nagios categorizes a service as flapping">Figure B-5</a>), which points out that the sending of messages has been stopped until the status of the service becomes stable again. It disappears, therefore, when Nagios is restarted.<a class="indexterm" id="IDX-APP-B-2210"/></p>

        <div class="figure">
          <a id="with_this_comment_comma_nagios_categoriz"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e54753"/><img alt="With this comment, Nagios categorizes a service as flapping" src="../Images/tagoreillycom20081104nostarchimages224022.png.jpg"/></div>

          <p class="title">Figure B-5. With this comment, Nagios categorizes a service as flapping</p>
        </div>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-B-FN-1" id="ftn.APP-B-FN-1">307</a>]</sup> (1.2–0.8)/19=0.0211</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-B-FN-2" id="ftn.APP-B-FN-2">308</a>]</sup> Nonpermanent comments disappear after the monitoring system is restarted, but permanent ones remain.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-B-FN-3" id="ftn.APP-B-FN-3">309</a>]</sup> If the changes in state took place recently, the weighting would ensure that four changes in state would already be enough to exceed the 20 percent limit.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-B-FN-4" id="ftn.APP-B-FN-4">310</a>]</sup> If a single change of state takes place in the first half, the weighting results in a value of less than 5 percent.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-B-FN-5" id="ftn.APP-B-FN-5">311</a>]</sup> 5 5+2*1=7</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="B.2 Flap Detection for Hosts">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="flap_detection_for_hosts"/>B.2 Flap Detection for Hosts</h1>
    </div>

    <p>Nagios tries to detect changing states of a host in two ways: in the host check itself (either in the context of the active check from Nagios 3.0 or in on-demand checks), and also if a service check for a host was performed, the last flap detection of which took place some time ago. When Nagios next performs a service check to detect a changing state is determined by the average value for all service check intervals.<a class="indexterm" id="IDX-APP-B-2211"/><a class="indexterm" id="IDX-APP-B-2212"/><a class="indexterm" id="IDX-APP-B-2213"/><a class="indexterm" id="IDX-APP-B-2214"/><a class="indexterm" id="IDX-APP-B-2215"/><a class="indexterm" id="IDX-APP-B-2216"/></p>

    <p>Regular host checks are also not necessary from Nagios 3.0 onward, and recent versions of Nagios manage perfectly well without them. For reasons of performance, they really should be avoided in Nagios 2.x (<a class="xref" href="../Text/ch04s02.html" title="4.2 On-Demand Host Checks vs. Periodic Reachability Tests">4.2 On-Demand Host Checks vs. Periodic Reachability Tests</a>, page 95). By making use of a trick to perform service checks only when required, Nagios compensates for the fact that regular host check results are missing. If at least one service check returns an OK, Nagios concludes from this that the host is also reachable and is in an OK state. The results of flap detection are stored by Nagios in the history.<a class="indexterm" id="IDX-APP-B-2217"/></p>

    <p>The same flap detection mechanism is used for hosts as for services. So the difference is only in how Nagios determines the corresponding data basis.</p>

    <p>Whether flap detection is desired for hosts is revealed by the central configuration file <strong class="userinput"><code>nagios.cfg</code></strong> and the definition of the host objects. The global parameter <strong class="userinput"><code>enable_flap_detection</code></strong>, which applies equally to hosts and services, must be set to <strong class="userinput"><code>1</code></strong>:<a class="indexterm" id="IDX-APP-B-2218"/></p><a id="I_programlisting_d1e54812"/>
    <pre class="programlisting"># /etc/nagios/nagios.cfg
enable_flap_detection=1
low_host_flap_threshold=5.0
high_host_flap_threshold=20.0</pre>

    <p>The threshold parameters for hosts include <strong class="userinput"><code>host</code></strong> in their names, but they have the same effect as their <strong class="userinput"><code>service</code></strong> equivalents.<sup>[<a class="footnote" href="#ftn.APP-B-FN-6" id="APP-B-FN-6">312</a>]</sup><a class="indexterm" id="IDX-APP-B-2219"/><a class="indexterm" id="IDX-APP-B-2220"/></p>

    <p>For the host object itself, detection is switched on with <strong class="userinput"><code>flap_detection_enabled</code></strong> <strong class="userinput"><code>1</code></strong> and off with <strong class="userinput"><code>0</code></strong>:<a class="indexterm" id="IDX-APP-B-2221"/></p><a id="I_programlisting_d1e54847"/>
    <pre class="programlisting">define host{
    host_name              linux01
    ...
    flap_detection_enabled 1
    low_flap_threshold     5.0
    high_flap_threshold    20.0
}</pre>

    <p>The optional parameters <strong class="userinput"><code>low_flap_threshold</code></strong> and <strong class="userinput"><code>high_flap_threshold</code></strong> allow for host-specific thresholds. If these are omitted, the global threshold values are used.<a class="indexterm" id="IDX-APP-B-2222"/><a class="indexterm" id="IDX-APP-B-2223"/></p>

    <p>As for service checks, Nagios from 3.0 onward also has the additional <strong class="userinput"><code>flap_detection_options</code></strong> parameter here. Possible values in the host definition are <strong class="userinput"><code>o</code></strong> (OK), <strong class="userinput"><code>d</code></strong> (DOWN), and <strong class="userinput"><code>u</code></strong> (UNREACHABLE). Only the states specified for the parameter are used in flap detection, and if this parameter is not given, then all possible states are used.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-B-FN-6" id="ftn.APP-B-FN-6">312</a>]</sup> See <a class="xref" href="../Text/apb.html#flap_detection_with_services" title="B.1 Flap Detection with Services">B.1 Flap Detection with Services</a>.</p>
      </div>
    </div>
  </div>


  <div class="appendix" title="Appendix&#xA0;C.&#xA0;Event Handlers">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="event_handlers"/>Appendix C. Event Handlers</h1>
    </div>

    <p>If the state of a host or service alternates between OK and error states, you can use an <span class="emphasis"><em>event handler</em></span> to run any programs you want. You can make use of this if a service fails, for example, and you want Nagios to try and restart it. This provides an opportunity to solve minor problems without the administrator needing to intervene.<a class="indexterm" id="IDX-APP-C-2224"/></p>

    <p>Use of the <span class="emphasis"><em>event handlers</em></span> is not just restricted to self-healing, however: with an appropriate script you can just as easily log current values or the event itself in a database. But there are more suitable methods for doing this, described in <a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a>, page 404. A failed printer service serves as an example here of using an event handler for self-healing. In this example the printer service <strong class="userinput"><code>lpd</code></strong> is used, but this method can be applied in general to any service for which a start-stop script is available.</p>

    <div class="sect1" title="C.1 Execution Times for the Event Handler">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="execution_times_for_the_event_handler"/>C.1 Execution Times for the Event Handler</h1>
      </div>

      <p>The following parameters in the service definition ensure that Nagios tests the service under normal circumstances every five minutes, but in cases of error, every two minutes:</p><a id="I_programlisting_d1e54903"/>
      <pre class="programlisting">normal_check_interval 5
retry_check_interval  2
max_check_attempts    4</pre>

      <p>An error state becomes hard after four tests leading to the same result.<a class="indexterm" id="IDX-APP-C-2225"/><a class="indexterm" id="IDX-APP-C-2226"/></p>

      <div class="figure">
        <a id="when_does_nagios_run_the_event_handler_q"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e54916"/><img alt="When does Nagios run the event handler?" src="../Images/tagoreillycom20081104nostarchimages224024.png.jpg"/></div>

        <p class="title">Figure C-1. When does Nagios run the event handler?</p>
      </div>

      <p><a class="xref" href="../Text/apc.html#when_does_nagios_run_the_event_handler_q" title="Figure C-1. When does Nagios run the event handler?">Figure C-1</a> shows an example of the change of the <strong class="userinput"><code>lpd</code></strong> service from an OK state to CRITICAL, and back again. After 10 minutes test No. 2 detects that the service is no longer available. The soft state that results causes Nagios to examine <strong class="userinput"><code>lpd</code></strong> more closely at two-minute intervals (checks No. 3, 4, and 5). Test No. 5 returns a CRITICAL for the fourth time, causing Nagios to categorize this as a hard state and to go back to the normal, five-minute test interval. In check No. 7 the service is functioning again, and the state changes from CRITICAL to OK (for hard state, see <a class="xref" href="../Text/ch04s03.html" title="4.3 States of Hosts and Services">4.3 States of Hosts and Services</a>, page 96.).</p>

      <p>Event handlers are carried out by Nagios for soft error states (in checks No. 2, 3, 4), the first time a hard error state occurs (in check No. 5), and in the resetting of the OK state after an error (irrespective of whether this is a hard or soft recovery).</p>

      <p>Since hard error states lead to the administrator being notified, it is recommended that the repair attempt is moved to the time of the soft error states. If it succeeds at this point in time, the administrator is spared these minor details. Ideally the service will be running again before a user even notices that it has failed.</p>

      <p>The fact that Nagios only executes the event handler when a hard error state first occurs prevents periodic attempts at repair that do not lead to the desired result after all (if the attempt had succeeded, no further hard error states would have occurred).</p>
    </div>
  </div>


  <div class="sect1" title="C.2 Defining the Event Handler in the Service Definition">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="defining_the_event_handler_in_the_servic"/>C.2 Defining the Event Handler in the Service Definition</h1>
    </div>

    <p>Although Nagios executes the event handler for every event, it does not have to carry out an action each time. In our example the handler should attempt to reset the printer service on the third soft error state (check No. 4) and on the first hard error state (check No. 5), and do nothing at all the other execution times.<a class="indexterm" id="IDX-APP-C-2227"/><a class="indexterm" id="IDX-APP-C-2228"/></p>

    <p>For this purpose, the service definition is modified as follows:</p><a id="I_programlisting_d1e54953"/>
    <pre class="programlisting">define service{
    host_name             printserver
    service_description   LPD
    ...
 <span class="strong"><strong>   event_handler</strong></span>  <span class="strong"><strong>restart-lpd</strong></span>
    ...
}</pre>

    <p>The <strong class="userinput"><code>event_handler</code></strong> parameter expects a Nagios command object that will run the handler script:</p><a id="I_programlisting_d1e54966"/>
    <pre class="programlisting">define command{
    command_name <span class="strong"><strong>restart-lpd</strong></span>
    command_line $USER1$/eventhandler/restart-lpd.sh $SERVICESTATE$ $SER
VICESTATETYPE$ $SERVICEATTEMPT$
}</pre>

    <p>In this example it is called <strong class="userinput"><code>restart-lpd.sh</code></strong> and is not located directly in the Nagios plugin directory <strong class="userinput"><code>/usr/local/nagios/libexec</code></strong>, but in a subdirectory called <strong class="userinput"><code>/usr/local/nagios/libexec/eventhandler</code></strong>, as suggested in the Nagios documentation. The script receives three macros as parameters: the current state <strong class="userinput"><code>$SERVICESTATE$</code></strong> (OK, WARNING, CRITICAL, or UNKNOWN), the state type <strong class="userinput"><code>$SERVICESTATETYPE$</code></strong> (<strong class="userinput"><code>SOFT</code></strong>, or <strong class="userinput"><code>HARD</code></strong>), and the number of the current (possibly repeated) attempt <strong class="userinput"><code>$SERVICE ATTEMPT$</code></strong> (e.g., <strong class="userinput"><code>3</code></strong> if the test is being performed for the third time). If the event handler is to be used for host checks, then the macros <strong class="userinput"><code>$HOSTSTATE$</code></strong>, <strong class="userinput"><code>$HOSTSTATE-TYPE$</code></strong>, and <strong class="userinput"><code>$HOSTATTEMPT$</code></strong> are used instead.<a class="indexterm" id="IDX-APP-C-2231"/><a class="indexterm" id="IDX-APP-C-2232"/><a class="indexterm" id="IDX-APP-C-2233"/><a class="indexterm" id="IDX-APP-C-2234"/><a class="indexterm" id="IDX-APP-C-2229"/><a class="indexterm" id="IDX-APP-C-2230"/></p>
  </div>


  <div class="sect1" title="C.3 The Handler Script">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_handler_script"/>C.3 The Handler Script</h1>
    </div>

    <p>The actual treatment of the error—depending on the current event—is dealt with by the script defined in the command definition. So that we can concentrate on the essential aspects in this context, we shall assume that <strong class="userinput"><code>lpd</code></strong> is installed on the Nagios server itself. This enables the service to be restarted locally, without the need for a remote shell such as the Secure Shell.<a class="indexterm" id="IDX-APP-C-2235"/><a class="indexterm" id="IDX-APP-C-2236"/></p>

    <p>The script <strong class="userinput"><code>restart-lpd.sh</code></strong> checks to see exactly what event is involved, using the macros passed on to it, and either does nothing at all or tries to restart <strong class="userinput"><code>lpd</code></strong>:</p><a id="I_programlisting_d1e55063"/>
    <pre class="programlisting">#!/bin/bash
# /usr/local/nagios/libexec/eventhandlers/restart-lpd.sh
# $1 = Status, $2 = status type, $3 = attempt

case $1 in
   OK)
      ;;
   WARNING)
      ;;
   CRITICAL)
      if [ $2 == "HARD" ] || [[ $2 == "SOFT" &amp;&amp; $3 -eq 3 ]]; then
         echo "Restarting lpd service"
         /usr/bin/sudo /etc/init.d/lpd restart
      fi
      ;;
   UNKNOWN)
      ;;
esac
exit 0</pre>

    <p>The <strong class="userinput"><code>case</code></strong> statement first checks to see what state exists. Only if it is CRITICAL will the script do anything; it does not carry out any action for other states. If the service is in a critical state, either the state type must be <strong class="userinput"><code>HARD</code></strong> or (<strong class="userinput"><code>||</code></strong>) a corresponding soft state must occur for the third time in succession, so that <strong class="userinput"><code>restart-lpd.sh</code></strong> can execute the <strong class="userinput"><code>lpd</code></strong> init script with the argument <strong class="userinput"><code>restart</code></strong>.<sup>[<a class="footnote" href="#ftn.APP-C-FN-1" id="APP-C-FN-1">313</a>]</sup><a class="indexterm" id="IDX-APP-C-2237"/></p>

    <p>The script is executed with the permissions of the user <strong class="userinput"><code>nagios</code></strong>, who may neither stop nor restart system services. This is why <strong class="userinput"><code>sudo</code></strong> is used, which provides temporary <strong class="userinput"><code>root</code></strong> permissions exclusively for the start-up script <strong class="userinput"><code>/etc/init.d/lpd</code></strong>, just for this user. The corresponding configuration can be found in the file <strong class="userinput"><code>/etc/sudoers</code></strong>, but if it is edited then you must use the program <strong class="userinput"><code>visudo</code></strong> rather than a standard editor (this checks the configuration file for syntax errors when it is saved):</p><a id="I_programlisting_d1e55118"/>
    <pre class="programlisting">linux:~ # <span class="strong"><strong>visudo</strong></span></pre>

    <p>Then you add the following line to the configuration file:</p><a id="I_programlisting_d1e55124"/>
    <pre class="programlisting">nagios nagsrv=(root) NOPASSWD: /etc/init.d/lpd</pre>

    <p>In plain language this means: the user <strong class="userinput"><code>nagios</code></strong> may run the command <strong class="userinput"><code>/etc/init.d/lpd</code></strong> on the host <strong class="userinput"><code>nagsrv</code></strong>. The command is run as the user <strong class="userinput"><code>root</code></strong>, but no password is required for this.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-C-FN-1" id="ftn.APP-C-FN-1">313</a>]</sup> If you want to get to know Bash programming more closely, we can recommend the excellent <span class="emphasis"><em>Advanced Bash-Scripting Guide</em></span> (<a class="ulink" href="http://www.tldp.org/LDP/abs/html">http://www.tldp.org/LDP/abs/html</a>) by Mendel Cooper.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="C.4 Things to Note When Using Event Handlers">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="things_to_note_when_using_event_handlers"/>C.4 Things to Note When Using Event Handlers</h1>
    </div>

    <p>If you restart a service that is already in a soft error state as described here, the administrator will not receive any notification as long as the action was successful. Although the log file records the restart, it will scarcely be noticed unless you search the log file explicitly for such events. This means that the administrator will seldom investigate the cause of the service failure.<a class="indexterm" id="IDX-APP-C-2238"/><a class="indexterm" id="IDX-APP-C-2239"/><a class="indexterm" id="IDX-APP-C-2240"/><a class="indexterm" id="IDX-APP-C-2241"/><a class="indexterm" id="IDX-APP-C-2242"/></p>

    <p>You should therefore bear in mind that eliminating the problem is the best solution, and that a restart is only second best. Like air bags in automobiles, the event handler should just be regarded as an additional security measure, and should certainly not represent the primary method of handling errors. If you carry out the restart only when a hard error state occurs, the administrator is confronted with the problem through the notification mechanism.</p>

    <p>In addition, not every service is suitable for an automatic restart. With OpenLDAP in versions before 2.1.17, a problem occurred sporadically in the replication through <strong class="userinput"><code>slurpd</code></strong>, which left behind a corrupted replication file. Although the replication service could be restarted, it died again after a short time. To really get the replication up and running again, you would have to repair the replication file manually.</p>

    <p>You should always remember this example and never have complete faith in self-healing. In the worst case, restarting a service repeatedly and without thought could lead to loss of data, which might be rectified only by retrieving data from the backups.</p>
  </div>


  <div class="appendix" title="Appendix&#xA0;D.&#xA0;Macros">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="macros"/>Appendix D. Macros</h1>
    </div>

    <p>Macros are the salt in the Nagios soup, for without them each service would have to be defined individually for each host and each command defined separately for each host and each service. They are identified by the dollar signs surrounding them: <strong class="userinput"><code>$macro$</code></strong>. We will look at the definition of a command with the plugin <strong class="userinput"><code>check_http</code></strong> (see <a class="xref" href="../Text/ch06s04.html#web_server_control_via_http" title="6.4.2 Web server control via HTTP">6.4.2 Web server control via HTTP</a>, page 119):<a class="indexterm" id="IDX-APP-D-2243"/></p><a id="I_programlisting_d1e55187"/>
    <pre class="programlisting">define command{
   command_name check_http
   command_line $USER1$/check_http -H $HOSTADDRESS$ $ARG1$
}</pre>

    <p>The definition contains three different macros: the user macro <strong class="userinput"><code>$USER1$</code></strong>, defined in the file <strong class="userinput"><code>resource.cfg</code></strong> (see <a class="xref" href="../Text/ch02s14.html" title="2.14 The Resources File resource.cfg">2.14 The Resources File resource.cfg</a>, page 79), as well as <strong class="userinput"><code>$HOSTADDRESS$</code></strong> and <strong class="userinput"><code>$ARG1$</code></strong>. The 32 possible user macros <strong class="userinput"><code>$USER1$</code></strong> to <strong class="userinput"><code>$USER32$</code></strong> are like constants that you use to record information, such as the path to the plugin directory (normally in <strong class="userinput"><code>$USER1$</code></strong>) or even passwords that should not appear in the normal configuration. The file <strong class="userinput"><code>resource.cfg</code></strong> may then be readable only for the user <strong class="userinput"><code>nagios</code></strong>.<a class="indexterm" id="IDX-APP-D-2244"/><a class="indexterm" id="IDX-APP-D-2245"/><a class="indexterm" id="IDX-APP-D-2246"/></p>

    <p>The second macro, <strong class="userinput"><code>$HOSTADDRESS$</code></strong>, is a so-called <span class="emphasis"><em>standard macro</em></span>, which is replaced by the host address of the host definition before the command is run:<a class="indexterm" id="IDX-APP-D-2247"/></p><a id="I_programlisting_d1e55248"/>
    <pre class="programlisting">define host{
   host_name linux01
   address 192.0.2.1
   ...
}

define service{
  host_name            linux01

  service_description  HTTP
  check_command        check_http!-u test.html
  ...
}</pre>

    <p>If the service <strong class="userinput"><code>linux0l;HTTP</code></strong> calls the command <strong class="userinput"><code>check_http</code></strong>, the command will obtain the host address from the parameter <strong class="userinput"><code>address</code></strong>. However, standard macros can provide not only the contents of a parameter from an object definition, as in this case, but also dynamic values that can change. Examples include the state of a host (e.g., <strong class="userinput"><code>$HOSTSTATE$</code></strong>), the output of a plugin (e.g., <strong class="userinput"><code>$SERVICEOUTPUT$</code></strong>), and system information, such as the start time of Nagios or the current time, or information on the configuration or static values.<a class="indexterm" id="IDX-APP-D-2248"/><a class="indexterm" id="IDX-APP-D-2249"/></p>

    <p>The <strong class="userinput"><code>$ARGx$</code></strong> macros contain the command line arguments in sequence. These appear in the service definition after the exclamation mark following the command <strong class="userinput"><code>check_http</code></strong>. The exclamation mark is also used as a separator between the individual arguments. In this way, spaces can be used within an argument, as in the example here (<strong class="userinput"><code>-u test.html</code></strong>), without any problem whatsoever.</p>

    <p>Nagios can handle two other groups of macros: on-demand and custom macros. <span class="emphasis"><em>On-demand macros</em></span> (see <a class="xref" href="../Text/apds02.html" title="D.2 On-Demand Macros">D.2 On-Demand Macros</a> in page 632) are extended standard macros that are used to access values belonging to an external object: for example, <strong class="userinput"><code>$H0STADDRESS:linux02$</code></strong> returns the IP address of <strong class="userinput"><code>linux02</code></strong>, irrespective of whether we are in the host or service definition of <strong class="userinput"><code>linuxOl</code></strong> or <strong class="userinput"><code>linux04</code></strong>.<a class="indexterm" id="IDX-APP-D-2250"/><a class="indexterm" id="IDX-APP-D-2251"/><a class="indexterm" id="IDX-APP-D-2252"/></p>

    <p><span class="emphasis"><em>Custom macros</em></span>, also referred to as <span class="emphasis"><em>user-defined variables</em></span>, were only introduced in Nagios 3.0. The definition of host, service, and contact objects is now supplemented with definitions you can make yourself, in whatever manner you like. <a class="xref" href="../Text/apds03.html" title="D.3 Macros for User-defined Variables">D.3 Macros for User-defined Variables</a> from page 633 deals with these custom macros in more detail.<a class="indexterm" id="IDX-APP-D-2253"/></p>

    <div class="sect1" title="D.1 Standard Macros">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="standard_macros"/>D.1 Standard Macros</h1>
      </div>

      <p>It would go beyond the scope of this book to describe all the available macros. The description below concentrates on the most important ones. A complete list is given in a tabular overview in the online documentation.<sup>[<a class="footnote" href="#ftn.APP-D-FN-1" id="APP-D-FN-1">314</a>]</sup></p>

      <p>Not all macros can be used everywhere. For this reason the tables provide information on the contexts in which each one is applicable. Normally this can be deduced with a bit of common sense. A service macro does not belong in a host check or a host notification, and likewise, a notification macro has no place in a host or service check. A value (such as a host state) which first has to be found is of course not yet available while it is being identified (that is, during the host check).<a class="indexterm" id="IDX-APP-D-2258"/></p>

      <p>Macros can basically be used in the following actions: for host and service checks, for host and service notifications, when running event handlers (<a class="xref" href="../Text/apc.html" title="Appendix C. Event Handlers">Appendix C</a>, page 619) or the OCSP/OHCP commands (<a class="xref" href="../Text/ch15.html" title="Chapter 15. Distributed Monitoring">Chapter 15</a>, page 317), and also when processing performance data with the accompanying commands (<a class="xref" href="../Text/ch19.html#the_template_mechanism" title="19.1.1 The template mechanism">19.1.1 The template mechanism</a>, page 405 and <a class="xref" href="../Text/ch19.html#using_external_commands_to_process_perf" title="19.1.2 Using external commands to process performance data">19.1.2 Using external commands to process performance data</a>, page 407).</p>

      <div class="sect2" title="D.1.1 Host macros">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="host_macros"/>D.1.1 Host macros</h2>
        </div>

        <div class="table">
          <a id="selected_host_macros"/>

          <p class="title">Table D-1. Selected host macros</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Selected host macros">
              <colgroup>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Macro<a class="indexterm" id="IDX-APP-D-2259"/></p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Description</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTNAME$</code></strong><a class="indexterm" id="IDX-APP-D-2260"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Host name from the <strong class="userinput"><code>host_name</code></strong> parameter for the host definition</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTALIAS$</code></strong><a class="indexterm" id="IDX-APP-D-2261"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Alias from the <strong class="userinput"><code>alias</code></strong> parameter for the host definition</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTADDRESS$</code></strong><a class="indexterm" id="IDX-APP-D-2262"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>IP address or FQDN from the host definition parameter<a class="indexterm" id="IDX-APP-D-2263"/></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTSTATE$</code></strong><a class="indexterm" id="IDX-APP-D-2264"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>State as text: UP, DOWN, UNREACHABLE</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTSTATEID$</code></strong><a class="indexterm" id="IDX-APP-D-2265"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>State in numerical form: <strong class="userinput"><code>0</code></strong> (UP), <strong class="userinput"><code>1</code></strong> (DOWN), <strong class="userinput"><code>2</code></strong> (UNREACHABLE)</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTSTATETYPE$</code></strong><a class="indexterm" id="IDX-APP-D-2266"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>HARD</code></strong>, <strong class="userinput"><code>SOFT</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTOUTPUT$</code></strong><a class="indexterm" id="IDX-APP-D-2267"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>The first line of the text output of the host check</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTLONGOUTPUT$</code></strong>(Nagios 3.0)<a class="indexterm" id="IDX-APP-D-2268"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Long text of the host check, if this provides multiple-line information</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTPERFDATA$</code></strong><a class="indexterm" id="IDX-APP-D-2269"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Performance data from the host check</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <p><a class="xref" href="../Text/apd.html#selected_host_macros" title="Table D-1. Selected host macros">Table D-1</a> documents the most important macros in connection with hosts. The macros <strong class="userinput"><code>$HOSTNAME$</code></strong>, <strong class="userinput"><code>$HOSTALIAS$</code></strong>, and <strong class="userinput"><code>$HOSTADDRESS$</code></strong> provide information from the host definition itself, so they are static. <strong class="userinput"><code>$HOSTSTATEID$</code></strong> and <strong class="userinput"><code>$HOSTSTATE$</code></strong> do <span class="emphasis"><em>not</em></span> give the return value of the plugin—<strong class="userinput"><code>1</code></strong> (OK) or <strong class="userinput"><code>2</code></strong> (CRITICAL)—but the result after the topological evaluation by Nagios. <strong class="userinput"><code>$HOSTSTATETYPE$</code></strong> defines whether Nagios really has completed the check (hard state) or whether the check is to be repeated (soft state).</p>
      </div>

      <div class="sect2" title="D.1.2 Service macros">
        <div class="titlepage">
          <h2 class="title" id="heading_id_5"><a id="service_macros"/>D.1.2 Service macros</h2>
        </div>

        <p><a class="xref" href="../Text/apd.html#selected_macros_for_services" title="Table D-2. Selected macros for services">Table D-2</a> presents selected service macros.<a class="indexterm" id="IDX-APP-D-2270"/><a class="indexterm" id="IDX-APP-D-2271"/><a class="indexterm" id="IDX-APP-D-2272"/><a class="indexterm" id="IDX-APP-D-2273"/></p>

        <div class="table">
          <a id="selected_macros_for_services"/>

          <p class="title">Table D-2. Selected macros for services</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Selected macros for services">
              <colgroup>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Macro</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Description</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$SERVICEDESC$</code></strong><a class="indexterm" id="IDX-APP-D-2274"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Name of the service, taken from the parameter <strong class="userinput"><code>service_description</code></strong> from the service definition</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$SERVICESTATE$</code></strong><a class="indexterm" id="IDX-APP-D-2275"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>The state in text form: OK, WARNING, CRITICAL, UNKNOWN</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$SERVICESTATEID$</code></strong><a class="indexterm" id="IDX-APP-D-2276"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>The state numerically: <strong class="userinput"><code>0</code></strong> (OK), <strong class="userinput"><code>1</code></strong> (WARNING), <strong class="userinput"><code>2</code></strong> (CRITICAL), <strong class="userinput"><code>3</code></strong> (UNKNOWN)</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$SERVICESTATETYPE$</code></strong><a class="indexterm" id="IDX-APP-D-2277"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>HARD</code></strong>, <strong class="userinput"><code>SOFT</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$SERVICEOUTPUT$</code></strong><a class="indexterm" id="IDX-APP-D-2278"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>The first line of the text output of the plugin during the service check</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$SERVICELONGOUTPUT$</code></strong> (Nagios 3.0)<a class="indexterm" id="IDX-APP-D-2279"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>The long text of the service check, if this provides multiple-line output</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$SERVICEPERFDATA$</code></strong><a class="indexterm" id="IDX-APP-D-2280"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Performance data of the service check</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="sect2" title="D.1.3 Group macros">
        <div class="titlepage">
          <h2 class="title" id="heading_id_6"><a id="group_macros"/>D.1.3 Group macros</h2>
        </div>

        <p>The host group macros described in <a class="xref" href="../Text/apd.html#selected_group_macros" title="Table D-3. Selected group macros">Table D-3</a> are provided by Nagios for service and contact groups as well. The string <strong class="userinput"><code>HOST</code></strong> in the macro name is replaced accordingly by ys<strong class="userinput"><code>SERVICE</code></strong> or <strong class="userinput"><code>CONTACT</code></strong>.<a class="indexterm" id="IDX-APP-D-2281"/><a class="indexterm" id="IDX-APP-D-2282"/><a class="indexterm" id="IDX-APP-D-2283"/><a class="indexterm" id="IDX-APP-D-2284"/></p>

        <p>The macros <strong class="userinput"><code>$HOSTGROUPNAME$</code></strong> and <strong class="userinput"><code>$HOSTGROUPNAMES$</code></strong> are always connected to the host. The same applies for the equivalent <strong class="userinput"><code>SERVICEGROUP</code></strong> (connected to a service) and <strong class="userinput"><code>CONTACTGR0UP</code></strong> macros (connected to a contact). Whereas <strong class="userinput"><code>$HOSTGROUPNAME$</code></strong> always returns the first host group of the associated host, <strong class="userinput"><code>$HOSTGROUPNAMES$</code></strong> displays a complete, comma-separated list of all host groups of which the host is a member.</p>

        <div class="table">
          <a id="selected_group_macros"/>

          <p class="title">Table D-3. Selected group macros</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Selected group macros">
              <colgroup>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Macro<a class="indexterm" id="IDX-APP-D-2285"/></p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Description</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTGROUPNAME$</code></strong><a class="indexterm" id="IDX-APP-D-2286"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Name of the first host group</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTGROUPNAMES$</code></strong><a class="indexterm" id="IDX-APP-D-2287"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Comma-separated list of all host groups to which the associated host belongs</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTGROUPALIAS$</code></strong><a class="indexterm" id="IDX-APP-D-2288"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Alias of the host group</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTGROUPMEMBERS$</code></strong><a class="indexterm" id="IDX-APP-D-2289"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Members of the host group</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <p>In contrast, the macros <strong class="userinput"><code>$HOSTGROUPALIAS$</code></strong> and <strong class="userinput"><code>$HOSTGROUPMEMBERS$</code></strong> refer to a host group. However, now there are no activities using a host group as a reference point.<sup>[<a class="footnote" href="#ftn.APP-D-FN-2" id="APP-D-FN-2">315</a>]</sup> So what is the purpose of these macros? They can be implemented as on-demand macros (see <a class="xref" href="../Text/apds02.html" title="D.2 On-Demand Macros">D.2 On-Demand Macros</a> from page 632). For example, <strong class="userinput"><code>$HOSTGROUPMEMBERS:Linux$</code></strong> displays a list of all members of the <strong class="userinput"><code>Linux</code></strong> host group.<a class="indexterm" id="IDX-APP-D-2290"/></p>

        <p>On the other hand, if the macro is run in a "normal" context, Nagios identifies the first host group specified in the host definition and assesses the accompanying value. The same applies for service and contact groups.<a class="indexterm" id="IDX-APP-D-2291"/></p>
      </div>

      <div class="sect2" title="D.1.4 Contact macros">
        <div class="titlepage">
          <h2 class="title" id="heading_id_7"><a id="contact_macros"/>D.1.4 Contact macros</h2>
        </div>

        <p>The macros listed in <a class="xref" href="../Text/apd.html#selected_contact_macros" title="Table D-4. Selected contact macros">Table D-4</a> reference all the parameters in the respective contact definition.<a class="indexterm" id="IDX-APP-D-2292"/><a class="indexterm" id="IDX-APP-D-2293"/><a class="indexterm" id="IDX-APP-D-2294"/><a class="indexterm" id="IDX-APP-D-2295"/><a class="indexterm" id="IDX-APP-D-2296"/><a class="indexterm" id="IDX-APP-D-2297"/><a class="indexterm" id="IDX-APP-D-2298"/><a class="indexterm" id="IDX-APP-D-2299"/><a class="indexterm" id="IDX-APP-D-2300"/><a class="indexterm" id="IDX-APP-D-2301"/><a class="indexterm" id="IDX-APP-D-2302"/><a class="indexterm" id="IDX-APP-D-2303"/></p>

        <div class="table">
          <a id="selected_contact_macros"/>

          <p class="title">Table D-4. Selected contact macros</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Selected contact macros">
              <colgroup>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Macro<a class="indexterm" id="IDX-APP-D-2304"/></p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Parameter to be read out</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$CONTACTNAME$</code></strong><a class="indexterm" id="IDX-APP-D-2305"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>contact_name</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$CONTACTALIAS$</code></strong><a class="indexterm" id="IDX-APP-D-2306"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>alias</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$CONTACTEMAIL$</code></strong><a class="indexterm" id="IDX-APP-D-2307"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>email</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$CONTACTPAGER$</code></strong><a class="indexterm" id="IDX-APP-D-2308"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Parameter <strong class="userinput"><code>pager</code></strong> of the contact</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$CONTACTADDRESSn$</code></strong><a class="indexterm" id="IDX-APP-D-2309"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>One of six possible contact addresses, where <strong class="userinput"><code>n</code></strong> is a digit between <strong class="userinput"><code>1</code></strong> and <strong class="userinput"><code>6</code></strong><sup>[<a class="footnote" href="#ftn.APP-D-FN-3" id="APP-D-FN-3">a</a>]</sup></p>
                  </td>
                </tr>
              </tbody>

              <tbody class="footnotes">
                <tr>
                  <td colspan="2">
                    <div class="footnote">
                      <p><sup>[<a class="para" href="#APP-D-FN-3" id="ftn.APP-D-FN-3">a</a>]</sup> The exact contents of <strong class="userinput"><code>$CONTACTADDRESSn$</code></strong> are specified by the Nagios administrator. Anything goes: other telephone numbers, e-mail addresses, or even Granny's phone number.</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="sect2" title="D.1.5 Notification macros">
        <div class="titlepage">
          <h2 class="title" id="heading_id_8"><a id="notification_macros"/>D.1.5 Notification macros</h2>
        </div>

        <p><a class="xref" href="../Text/apd.html#selected_macros_for_notifications" title="Table D-5. Selected macros for notifications">Table D-5</a> shows a selection of macros for notifications.<a class="indexterm" id="IDX-APP-D-2311"/><a class="indexterm" id="IDX-APP-D-2312"/><a class="indexterm" id="IDX-APP-D-2313"/><a class="indexterm" id="IDX-APP-D-2314"/><a class="indexterm" id="IDX-APP-D-2310"/></p>

        <div class="table">
          <a id="selected_macros_for_notifications"/>

          <p class="title">Table D-5. Selected macros for notifications</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Selected macros for notifications">
              <colgroup>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Macro</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Description</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$NOTIFICATIONTYPE$</code></strong><a class="indexterm" id="IDX-APP-D-2315"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Notification type (for values, see text)</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$NOTIFICATIONRECIPIENTS$</code></strong> (Nagios 3.0)<a class="indexterm" id="IDX-APP-D-2316"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Comma-separated list of all recipients</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$HOSTNOTIFICATIONNUMBER$</code></strong><a class="indexterm" id="IDX-APP-D-2317"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Notification counter</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$SERVICENOTIFICATIONNUMBER$</code></strong> (Nagios 3.0)<a class="indexterm" id="IDX-APP-D-2318"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Notification counter</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <p><strong class="userinput"><code>$NOTIFICATI0NTYPE$</code></strong> describes the type of notification. For Nagios 2.x the notification types are <strong class="userinput"><code>PROBLEM</code></strong>, <strong class="userinput"><code>RECOVERY</code></strong>, <strong class="userinput"><code>ACKNOWLEDGEMENT</code></strong>, <strong class="userinput"><code>FLAPPING-START</code></strong>, and <strong class="userinput"><code>FLAPPINGSTOP</code></strong>. Nagios 3.0 also has <strong class="userinput"><code>FLAPPINGDISABLED</code></strong>, as well as <strong class="userinput"><code>DOWNTIMESTART</code></strong>, <strong class="userinput"><code>DOWNTIMEEND</code></strong>, and <strong class="userinput"><code>DOWNTIMECANCELLED</code></strong>.<a class="indexterm" id="IDX-APP-D-2319"/></p>

        <p>The macro <strong class="userinput"><code>$NOTIFICATIONRECIPIENTS$</code></strong> is only available from Nagios 3.0; it contains a comma-separated list of all recipients of the notification that has just been sent. Also new in this version are the two macros <strong class="userinput"><code>$HOSTNOTIFICATIONNUMBER$</code></strong> and <strong class="userinput"><code>$SERVICENOTIFICATIONNUMBER$</code></strong>. These contain the incremented number of the last sent message, which is important for escalation management. Acknowledge messages are ignored in this case, as are flapping messages or messages on planned maintenance periods. As soon as the state of the host or service is again OK, this counter is reset to 0, and in the event of an error, counting starts again from the beginning.</p>
      </div>

      <div class="sect2" title="D.1.6 Macros to specify time and date">
        <div class="titlepage">
          <h2 class="title" id="heading_id_9"><a id="macros_to_specify_time_and_date"/>D.1.6 Macros to specify time and date</h2>
        </div>

        <p>The output of the date macro from <a class="xref" href="../Text/apd.html#selected_macros_for_details_of_the_date" title="Table D-6. Selected macros for details of the date">Table D-6</a> depends on the date form specified in the parameter <strong class="userinput"><code>date_format</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>).<a class="indexterm" id="IDX-APP-D-2320"/></p>

        <div class="table">
          <a id="selected_macros_for_details_of_the_date"/>

          <p class="title">Table D-6. Selected macros for details of the date</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Selected macros for details of the date">
              <colgroup>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Macro</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Example</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$LONGDATETIME$</code></strong><a class="indexterm" id="IDX-APP-D-2321"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>Sa 29 Dec 17:23:22 CET 2007</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$SHORTDATETIME$</code></strong><a class="indexterm" id="IDX-APP-D-2322"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>2007-12-29 17:23:22</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$DATE$</code></strong><a class="indexterm" id="IDX-APP-D-2323"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>2007-12-29</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$TIME$</code></strong><a class="indexterm" id="IDX-APP-D-2324"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>17:23:22</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$TIMET$</code></strong><a class="indexterm" id="IDX-APP-D-2325"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>1198945589</code></strong></p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <p><strong class="userinput"><code>$LONGDATETIME$</code></strong> outputs a format also provided by the <strong class="userinput"><code>date</code></strong> program without any parameters. The examples for <strong class="userinput"><code>$SHORTDATETIME$</code></strong> and <strong class="userinput"><code>$DATE$</code></strong> correspond to the <strong class="userinput"><code>date_format=iso8601</code></strong> setting. With the value <strong class="userinput"><code>date_format=us</code></strong>, the date would be written here as <strong class="userinput"><code>12/29/2007</code></strong>. <strong class="userinput"><code>$TIME$</code></strong> contains only the time, whereas <strong class="userinput"><code>$TIMET$</code></strong> shows the epoch time (seconds elapsed since 01.01.1970).</p>
      </div>

      <div class="sect2" title="D.1.7 Statistics macros">
        <div class="titlepage">
          <h2 class="title" id="heading_id_10"><a id="statistics_macros"/>D.1.7 Statistics macros</h2>
        </div>

        <p>If you use the macros shown in <a class="xref" href="../Text/apd.html#selected_macros_for_statistical_purposes" title="Table D-7. Selected macros for statistical purposes">Table D-7</a> in notifications, the macro in each case will show the number of hosts or services for which the contact to whom the notification is sent is responsible. This means that different recipients may receive different figures for the same notification.<a class="indexterm" id="IDX-APP-D-2326"/><a class="indexterm" id="IDX-APP-D-2327"/><a class="indexterm" id="IDX-APP-D-2328"/></p>

        <div class="table">
          <a id="selected_macros_for_statistical_purposes"/>

          <p class="title">Table D-7. Selected macros for statistical purposes</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Selected macros for statistical purposes">
              <colgroup>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Macro<a class="indexterm" id="IDX-APP-D-2329"/></p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Description</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$TOTALHOSTSUP$</code></strong><a class="indexterm" id="IDX-APP-D-2330"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Number of hosts in UP state</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$TOTALHOSTSDOWN$</code></strong><a class="indexterm" id="IDX-APP-D-2331"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Number of hosts in DOWN state</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$TOTALHOSTSUNREACHABLE$</code></strong><a class="indexterm" id="IDX-APP-D-2332"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Number of hosts in UNREACHABLE state</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$TOTALSERVICESOK$</code></strong><a class="indexterm" id="IDX-APP-D-2333"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Number of services in OK state</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$TOTALSERVICESCRITICAL$</code></strong><a class="indexterm" id="IDX-APP-D-2334"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Number of services in CRITICAL state</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$TOTALSERVICESWARNING$</code></strong><a class="indexterm" id="IDX-APP-D-2335"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Number of services in WARNING state</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$TOTALSERVICESUNKNOWN$</code></strong><a class="indexterm" id="IDX-APP-D-2336"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Number of services in UNKNOWN state</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>$TOTALSERVICEPROBLEMS$</code></strong><a class="indexterm" id="IDX-APP-D-2337"/></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Total number of services with problems</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="sect2" title="D.1.8 Using standard macros about the environment">
        <div class="titlepage">
          <h2 class="title" id="heading_id_11"><a id="using_standard_macros_about_the_environm"/>D.1.8 Using standard macros about the environment</h2>
        </div>

        <p>All standard macros can be provided by Nagios as environment variables, if required. The variable name here is derived from the name of the macro without the dollar sign, to which the prefix <strong class="userinput"><code>NAGIOS_</code></strong> is added. The macro <strong class="userinput"><code>$HOSTADDRESS$</code></strong> thus converts to the environment variable <strong class="userinput"><code>NAGIOS_HOST-ADDRESS</code></strong>. Among the on-demand macros (see next section), the host and service macros are not available as environment variables for reasons of security, and the same goes for the <strong class="userinput"><code>$USERx$</code></strong> macros, since these could contain sensitive information such as passwords.</p>

        <p>Providing these environment variables takes a great deal of time. You should therefore consider whether you can do without them altogether in Nagios 3.0 (see the parameters <strong class="userinput"><code>use_large_installation_tweaks</code></strong>, <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>, and <strong class="userinput"><code>enable_environment_macros</code></strong>, <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). In Nagios 2.x the environment variable cannot be switched off.</p>

        <p>Instead of accessing the Nagios environment variable directly from an external script, as in the following example,</p><a id="I_programlisting_d1e56397"/>
        <pre class="programlisting">#!/bin/bash
# badscript

HOST=$NAGIOS_HOSTADDRESS
...</pre>

        <p>which is called as follows,</p><a id="I_programlisting_d1e56401"/>
        <pre class="programlisting">define command{
command_line $USER1$/badscript
...
}</pre>

        <p>as an alternative, you could pass on the contents of the macro to the script explicitly as an argument:</p><a id="I_programlisting_d1e56405"/>
        <pre class="programlisting">define command{
   command_line $USER1$/goodscript $HOSTADDRESS$
...
}</pre>

        <p>Then you can manage without the Nagios environment variable in the script itself:</p><a id="I_programlisting_d1e56409"/>
        <pre class="programlisting">#!/bin/bash
# goodscript

HOST=$1
...</pre>

        <p><strong class="userinput"><code>goodscript</code></strong> retrieves the relevant value from the command line, with <strong class="userinput"><code>$1</code></strong>.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-D-FN-1" id="ftn.APP-D-FN-1">314</a>]</sup> Nagios 2.x: <a class="ulink" href="http://nagios.sourceforge.net/docs/2_0/macros.html">http://nagios.sourceforge.net/docs/2_0/macros.html</a>;<a class="indexterm" id="IDX-APP-D-2254"/><a class="indexterm" id="IDX-APP-D-2255"/><a class="indexterm" id="IDX-APP-D-2256"/><a class="indexterm" id="IDX-APP-D-2257"/></p>

        <p>Nagios 3.0: <a class="ulink" href="http://nagios.sourceforge.net/docs/3_0/macrolist.html">http://nagios.sourceforge.net/docs/3_0/macrolist.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-D-FN-2" id="ftn.APP-D-FN-2">315</a>]</sup> It is possible to run commands for a host group from the Web interface, but Nagios always resolves these into single actions for each host.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="D.2 On-Demand Macros">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="on-demand_macros"/>D.2 On-Demand Macros</h1>
    </div>

    <p>On-demand macros—which have existed since Nagios 2.0—reference the same contents as standard macros do. The subtle difference between them lies in the context of what they reference. Whereas standard macros refer exclusively to the host, service, or contact object currently being used, on-demand macros enable access to values from any external objects you please:<a class="indexterm" id="IDX-APP-D-2338"/><a class="indexterm" id="IDX-APP-D-2339"/></p><a id="I_programlisting_d1e56433"/>
    <pre class="programlisting">$HOSTADDRESS:linux01$
$HOSTSTATE:switch05$</pre>

    <p>The macros are the same as standard macros, but their names include the name of the host to which the reference is made. The colon is used as a separator. For services, the service name also needs to be specified, again separated with another colon:</p><a id="I_programlisting_d1e56437"/>
    <pre class="programlisting">$SERVICESTATE:switch05:PING$
$SERVICESTATE::NRPE$</pre>

    <p>If the host field is left empty, the macro refers to the host in whose context the macro is called. If, for instance, you are checking the disk usage via NRPE on the host <strong class="userinput"><code>linux01</code></strong> with the service <strong class="userinput"><code>Disks</code></strong> NRPE, then the standard macro <strong class="userinput"><code>$SERVICESTATE$</code></strong> will return the state of the service <strong class="userinput"><code>linux01;Disks</code></strong>, whereas the on-demand macro <strong class="userinput"><code>$SERVICESTATE::NRPE$</code></strong> will display the state of the service <strong class="userinput"><code>linux01;NRPE</code></strong>. An appropriate script can take into account the dependency here between the service <strong class="userinput"><code>NRPE</code></strong> and an NRPE-based check such as <strong class="userinput"><code>Disks</code></strong>.</p>

    <p>For contact objects, the external reference point is a contact in each case:</p><a id="I_programlisting_d1e56468"/>
    <pre class="programlisting">$CONTACTNAME:gregor$
$CONTACTEMAIL:smith$</pre>

    <p>In addition to this, there are also on-demand macros for host, service, and contact groups, and in each case the reference point is the group concerned.<a class="indexterm" id="IDX-APP-D-2340"/></p>
  </div>


  <div class="sect1" title="D.3 Macros for User-defined Variables">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="macros_for_user-defined_variables"/>D.3 Macros for User-defined Variables</h1>
    </div>

    <p>Starting from Nagios 3.0, you can specify your own macros in host, service, and contact definitions. These macros, called <span class="emphasis"><em>custom macros</em></span> in Nagios jargon, are treated like normal standard macros, and their names begin with an underscore to make them more easily identifiable:<a class="indexterm" id="IDX-APP-D-2341"/><a class="indexterm" id="IDX-APP-D-2342"/><a class="indexterm" id="IDX-APP-D-2343"/><a class="indexterm" id="IDX-APP-D-2344"/></p><a id="I_programlisting_d1e56501"/>
    <pre class="programlisting">define host {
   host_name         linux01
   ...
   _NSCLIENT_PORT 12489
   _ASSETID       734287
}
define service {
   host_name           linux01
   service_description HTTP
   ...
   _HTTP_PORT          8080
}
define contact {
   contact_name wob
   ...
   _DEPARTMENT  41ZBV
}</pre>

    <p>They are addressed with a prefixed object type:</p><a id="I_programlisting_d1e56505"/>
    <pre class="programlisting">$_HOSTNSCLIENT_PORT$
$_HOSTASSETID$
$_SERVICEHTTP_PORT$
$_CONTACTDEPARTMENT$</pre>

    <p>The macro again starts with an underscore, but the underscore supplied in the definition is omitted. This is difficult to read. If you want to use the underscore as a separator, for instance between <strong class="userinput"><code>HOST</code></strong> and <strong class="userinput"><code>NSCLIENT_PORT</code></strong>, the custom macro must begin with a double underscore. Thus,</p><a id="I_programlisting_d1e56515"/>
    <pre class="programlisting">define host {
   host_name       linux01
   ...
   __NSCLIENT_PORT 12489
   __ASSETID       734287
}</pre>

    <p>turns into</p><a id="I_programlisting_d1e56519"/>
    <pre class="programlisting">$_HOST_NSCLIENT_PORT$
$_HOST_ASSETID$</pre>

    <p>In the definition of a custom macro, upper and lower case are not distinguished, but when the macro is called it is always written in capitals. Besides providing abbreviations for content used mainly for documentation purposes, such as <strong class="userinput"><code>ASSETID</code></strong> or <strong class="userinput"><code>DEPARTMENT</code></strong>, such user-defined macros can also be used to neatly define commands.</p>

    <p>For example, if you are monitoring a Windows environment with the NS-Client mechanism, a service is installed on the host being monitored that listens to a specific port (<a class="xref" href="../Text/ch20s02.html#nsclient" title="20.2.1 NSClient">20.2.1 NSClient</a>, page 464). Under certain circumstances you will be forced to change the standard port. If you now have several servers with different ports, you must tell the plugin on which port it is to run the query.</p>

    <p>One method would be to also include the port as an argument for each service definition, or to define a second command with a permanently stored, alternative port. However, if the port on the target system is now changed, the entire service definition of the target system must be modified.</p>

    <p>A more elegant solution is to store the port, as above, as a custom macro in the host definition and to evaluate the custom macro in the command.</p>

    <p>This solution, which unfortunately works only in Nagios 3.0, is described for the NSClient service in <a class="xref" href="../Text/ch20s02.html#rectifying_problems_with_port" title="20.2.5 Rectifying problems with port 1248">20.2.5 Rectifying problems with port 1248</a> from page 471, and an equivalent example for NRPE can be found in <a class="xref" href="../Text/aphs02.html" title="H.2 Variable and Macros">H.2 Variable and Macros</a> from page 685.</p>
  </div>


  <div class="sect1" title="D.4 Macro Contents: Not Everything Is Allowed">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="macro_contents_colon_not_everything_is_a"/>D.4 Macro Contents: Not Everything Is Allowed</h1>
    </div>

    <p>A number of macros contain values that were not defined within the Nagios configuration or defined by Nagios itself, but which originate from external programs. These include macros that record the plugin output (<strong class="userinput"><code>$HOSTOUTPUT$</code></strong>, <strong class="userinput"><code>$LONGHOSTOUTPUT$</code></strong>, <strong class="userinput"><code>$HOSTPERFDATA$</code></strong>), and the corresponding macros for services. Via the Web interface, the administrator can pass on values to Nagios through acknowledgments, which can be read out from the macros <strong class="userinput"><code>$HOSTACKAUTHOR$</code></strong>, <strong class="userinput"><code>$HOSTACKCOMMENT$</code></strong>, and the equivalent service macros.<a class="indexterm" id="IDX-APP-D-2345"/><a class="indexterm" id="IDX-APP-D-2346"/><a class="indexterm" id="IDX-APP-D-2347"/><a class="indexterm" id="IDX-APP-D-2348"/><a class="indexterm" id="IDX-APP-D-2349"/><a class="indexterm" id="IDX-APP-D-2350"/><a class="indexterm" id="IDX-APP-D-2351"/></p>

    <p>To guard against the possibility that these macros might contain damaging code, which might trigger a buffer overflow or enable other mischievous things, Nagios removes "dangerous" lines. What these are is defined by the parameter <strong class="userinput"><code>illegal_object_name_chars</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>):<a class="indexterm" id="IDX-APP-D-2352"/></p><a id="I_programlisting_d1e56598"/>
    <pre class="programlisting">illegal_object_name_chars='~$^&amp;'&lt;&gt;</pre>

    <p>The Nagios administrator can change these, but he must be aware that fewer characters means a higher potential of risk.</p>
  </div>


  <div class="appendix" title="Appendix&#xA0;E.&#xA0;Single Sign-On for the Nagios Web Interface">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="single_sign-on_for_the_nagios_web_interf"/>Appendix E. Single Sign-On for the Nagios Web Interface</h1>
    </div>

    <p>For the login to the Web interface, Nagios takes the user who has authenticated himself to the Web server, usually Apache. In principle it makes no difference how this authentication comes about, but the name of the contact must match the user name passed on to the CGI programs from the Web server. Nagios is quite tolerant in terms of its name conventions here. Even user names such as <strong class="userinput"><code>wob@EXAMPLE.NET</code></strong> or <strong class="userinput"><code>EXAMPLE/wob</code></strong> are possible. This is enabled by <span class="emphasis"><em>single sign-on (SSO)</em></span>, which means that users only need to log on a single time. Ideally, all applications should accept the authentication that has already been performed, and the user will not be asked for a password every time.<a class="indexterm" id="IDX-APP-E-2353"/><a class="indexterm" id="IDX-APP-E-2354"/></p>

    <p>Security experts have been busy discussing the pros and cons<sup>[<a class="footnote" href="#ftn.APP-E-FN-1" id="APP-E-FN-1">316</a>]</sup> of single sign-on, but it is very popular with users. We will therefore not go into the disscussion on security.</p>

    <p>Single sign-on, in combination with the Nagios Web interface, means that the user is automatically authenticated from the browser when the Nagios CGI programs are called, and a password is no longer required. Of course, what is described here can also be used for other Web pages—this could be the NagVis, PNP, or a Wiki. There are hardly any limits to the opportunities for using single sign-on.</p>

    <p>This chapter describes the use of two alternative Apache modules for Apache 2 that enable a single sign-on scenario. As the authentication server, a running Active Directory in Windows 2003 is required.<sup>[<a class="footnote" href="#ftn.APP-E-FN-2" id="APP-E-FN-2">317</a>]</sup> On the client side, the browser used must support the selected HTTP authentication procedure. Microsoft Internet Explorer and Firefox are both suitable for this.</p>

    <p>The Apache module <strong class="userinput"><code>mod_auth_kerb</code></strong> uses Kerberos directly, and could therefore be used in an exclusively Linux environment (without Active Directory). Since the author himself does not have a production Kerberos environment with Linux clients available, we will not deal with this topic here. If you are running a fully functional Kerberos environment in Linux/Unix, you should find it easy to modify the <strong class="userinput"><code>mod_auth_kerb</code></strong> section to your environment.</p>

    <p>The Apache module <strong class="userinput"><code>mod_auth_ntlm_winbind</code></strong> makes use of <strong class="userinput"><code>ntlm_auth</code></strong>, a program that is a component of Samba 3.0. It therefore requires a complete Samba installation, and the server must be a member of an Active Directory domain.</p>

    <div class="sect1" title="E.1 HTTP Authentication for Single Sign-On">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="http_authentication_for_single_sign-on"/>E.1 HTTP Authentication for Single Sign-On</h1>
      </div>

      <p>Microsoft has supported single sign-on via Web browser for some time now. The original procedure was based on (<span class="emphasis"><em>NT LAN Manager (NTLM)</em></span>, a protocol that is also used in networks, for example when logging in to a domain or when accessing network drives. Here the client sends a so-called <span class="emphasis"><em>type 1 message</em></span> containing the host and domain names of the client. The server replies with an NTLM challenge (an NTLM <span class="emphasis"><em>type 2 message</em></span>), and the client completes authentication with a <span class="emphasis"><em>type 3 message</em></span>, which in turn sends back to the server not only the client name and domain, but also the challenge, which has been encrypted with the client's password. The procedure is Microsoft-specific and was never published as a standard. Nevertheless,<a class="indexterm" id="IDX-APP-E-2355"/></p>

      <p>Firefox is able to use it. The HTTP authentication-related descriptions of the NTLM protocol can also be found on the Internet.<sup>[<a class="footnote" href="#ftn.APP-E-FN-3" id="APP-E-FN-3">318</a>]</sup></p>

      <p>Microsoft will soon replace the NTLM-based authentication with a newer, Kerberos-based authentication. With Windows Server 2008, NTLM will no longer be available for HTTP authentication, at least on the server side.<a class="indexterm" id="IDX-APP-E-2356"/></p>

      <p>The successor to this has already been in practical use for some time. It uses a generic interface called <span class="emphasis"><em>Generic Security Services Application Program Interface (GSSAPI)</em></span>. For HTTP authentication, as well as GSSAPI, a mechanism called <span class="emphasis"><em>SPNEGO (Simple and Protected Negotiate</em></span>) is used, through which concrete authentication is negotiated. Microsoft describes the HTTP authentication in an informal Request for Comment, RFC 4559.<sup>[<a class="footnote" href="#ftn.APP-E-FN-4" id="APP-E-FN-4">319</a>]</sup> This also discusses the NTLM procedure. The SPNEGO, used for the newer variation, is described in RFC 4178.<sup>[<a class="footnote" href="#ftn.APP-E-FN-5" id="APP-E-FN-5">320</a>]</sup><a class="indexterm" id="IDX-APP-E-2357"/></p>

      <p>The SPNEGO procedure is somewhat shorter than the NTLM authentication and is closer to the HTTP authentication methods <strong class="userinput"><code>Basic</code></strong> and <strong class="userinput"><code>Digest</code></strong>. First, the client requests a protected page with the command <strong class="userinput"><code>GET</code></strong>. The server replies with the status code <strong class="userinput"><code>401</code></strong> (Unauthorized) and includes the possible authentication procedures:</p><a id="I_programlisting_d1e56718"/>
      <pre class="programlisting">HTTP/1.1 401 Authorization Required
...
WWW-Authenticate: Negotiate
WWW-Authenticate: NTLM
WWW-Authenticate: Basic realm="Nagios Monitoring"
...</pre>

      <p>The server in this example provides a choice of three procedures: <strong class="userinput"><code>Negotiate</code></strong> stands for the Kerberos-based SPNEGO procedure, <strong class="userinput"><code>NTLM</code></strong> stands for the older NTLM authentication, and <strong class="userinput"><code>Basic</code></strong> refers to the classic user password method in which the authentication data are transmitted in plain text. It is now up to the client to decide on one of the three procedures. The client—here an instance of Microsoft Internet Explorer 6.0—selects the secure Kerberos-based procedure:</p><a id="I_programlisting_d1e56731"/>
      <pre class="programlisting"><span class="strong"><strong>GET /nagios/index.html HTTP/1.1</strong></span>
...
<span class="strong"><strong>Authorization: Negotiate YIIIlwYGKwYBBQUCoIIIizCCCIegJDA..</strong></span>.</pre>

      <p>After the HTTP header field <strong class="userinput"><code>Authorization</code></strong> comes the keyword <strong class="userinput"><code>Negotiate</code></strong>, followed by the Base64-encoded authentication data. If this is successful,</p>

      <p>the server replies in turn with the HTTP code <strong class="userinput"><code>200</code></strong> (OK), and the HTTP header also contains authentication data,<sup>[<a class="footnote" href="#ftn.APP-E-FN-6" id="APP-E-FN-6">321</a>]</sup> which the client processes:</p><a id="I_programlisting_d1e56756"/>
      <pre class="programlisting">HTTP/1.1 200 OK
...
WWW-Authenticate: Negotiate oYGeMIGbo...</pre>

      <p>If successful, the browser will display the HTTP page it has received. The negotiate procedure is shown in a somewhat simplified form here, and it is possible that the server sends back a <strong class="userinput"><code>401</code></strong> code (Unauthorized) with the <strong class="userinput"><code>WWW-Authenticate</code></strong> field after it receives the <strong class="userinput"><code>Authorization</code></strong> packet of the client, because further authentication data is required. The client then sends another <strong class="userinput"><code>Authorization</code></strong> header entry, as requested. This is repeated until the server answers with <strong class="userinput"><code>200 OK</code></strong>.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-1" id="ftn.APP-E-FN-1">316</a>]</sup> <a class="ulink" href="http://en.wikipedia.org/wiki/Single_sign_on">http://en.wikipedia.org/wiki/Single_sign_on</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-2" id="ftn.APP-E-FN-2">317</a>]</sup> The scenario described may also work with Windows 2000, but the author was not able to test this. Nevertheless, there are certainly differences in the Kerberos implementation between Windows 2000 and Windows 2003, which probably require adjustments to the procedure descrbed here.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-3" id="ftn.APP-E-FN-3">318</a>]</sup> <a class="ulink" href="http://www.innovation.ch/personal/ronald/ntlm.html">http://www.innovation.ch/personal/ronald/ntlm.html</a>, in more detail at <a class="ulink" href="http://davenport.sourceforge.net/ntlm.html">http://davenport.sourceforge.net/ntlm.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-4" id="ftn.APP-E-FN-4">319</a>]</sup> <a class="ulink" href="http://rfc.sunsite.dk/rfc/rfc4559.html">http://rfc.sunsite.dk/rfc/rfc4559.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-5" id="ftn.APP-E-FN-5">320</a>]</sup> <a class="ulink" href="http://rfc.sunsite.dk/rfc/rfc4178.html">http://rfc.sunsite.dk/rfc/rfc4178.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-6" id="ftn.APP-E-FN-6">321</a>]</sup> In general, Kerberos provides authentication on both sides, so the server must also authenticate itself with the client.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="E.2 Kerberos Authentication with mod_auth_kerb">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="kerberos_authentication_with_mod_auth_k"/>E.2 Kerberos Authentication with <strong class="userinput"><code>mod_auth_kerb</code></strong></h1>
    </div>

    <p>The module <strong class="userinput"><code>mod_auth_kerb</code></strong> integrates Apache into an existing Kerberos environment and allows authentication through two procedures: simple authentication with the <strong class="userinput"><code>Basic</code></strong> method or the negotiation procedure SP-NEGO, described in RFC 4559.</p>

    <p>Both procedures are shown in <a class="xref" href="../Text/apes02.html#mod_auth_kerb_allows_full" title="Figure E-1. mod_auth_kerb allows full authentication via Kerberos, via SPNEGO. With the Basic procedure, communication between Web server and Kerberos server also runs via the Kerberos protocol.">Figure E-1</a>. For an authentication via negotiate (only Kerberos v5), the client fetches a ticket from the Kerberos server (1), which it forwards to the Web server (2). The Web server in turn sends the ticket via the Kerberos protocol to the Kerberos server for inspection (3). What is not shown is the response of the Web server to the client if authentication is successful (or if it fails).</p>

    <div class="figure">
      <a id="mod_auth_kerb_allows_full"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e56800"/><img alt="mod_auth_kerb allows full authentication via Kerberos, via SPNEGO. With the Basic procedure, communication between Web server and Kerberos server also runs via the Kerberos protocol." src="../Images/tagoreillycom20081104nostarchimages224026.png"/></div>

      <p class="title">Figure E-1. <code class="userinput">mod_auth_kerb</code> allows full authentication via Kerberos, via SPNEGO. With the <code class="userinput">Basic</code> procedure, communication between Web server and Kerberos server also runs via the Kerberos protocol.</p>
    </div>

    <p>With the <strong class="userinput"><code>Basic</code></strong> authentication the client sends a user/password pair in plain text to the Web server (4). The server for its part, however, transmits the authentication data via the Kerberos protocol to the Kerberos server (5)—which doen't alter the fact that the authentication between the Web server and client takes place without protection. It is essential that SSL encryption is used here. The Web server itself has a permanent ticket for the HTTP service so that it can communicate with the Kerberos server in the first place.<a class="indexterm" id="IDX-APP-E-2358"/></p>

    <div class="sect2" title="E.2.1 Installation">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="installation-id13"/>E.2.1 Installation</h2>
      </div>

      <p>The module is available at SourceForge,<sup>[<a class="footnote" href="#ftn.APP-E-FN-7" id="APP-E-FN-7">322</a>]</sup> where you can also find some notes on the installation and a little documentation. Modern distributions include the module as a package, which has the advantage that you don't need to worry about the dependencies of other packages—the installer automatically installs the required software. In Debian "Etch" the module is called <strong class="userinput"><code>libapache2-mod-auth-kerb</code></strong>. You should have at least version 5.3, since earlier versions have some minor bugs, especially when working with Microsoft Internet Explorer 6.0.<sup>[<a class="footnote" href="#ftn.APP-E-FN-8" id="APP-E-FN-8">323</a>]</sup></p>

      <p>To carry out the configuration, the programs <strong class="userinput"><code>klist</code></strong> and <strong class="userinput"><code>kinit</code></strong> are also required, and in Debian "Etch" these can be found in the package <strong class="userinput"><code>krb5-user</code></strong> (and not in <strong class="userinput"><code>krb5-clients</code></strong>!). One more note on Kerberos itself: The description in this book is based on the Kerberos implementation of the Massachusetts Institute of Technology (MIT), which is also used in Microsoft Windows.</p>
    </div>

    <div class="sect2" title="E.2.2 Creating a service ticket for Apache">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="creating_a_service_ticket_for_apache"/>E.2.2 Creating a service ticket for Apache</h2>
      </div>

      <p>To participate in the Kerberos procedure, Apache requires a service ticket with a quite specific realm:</p><a id="I_programlisting_d1e56847"/>
      <pre class="programlisting">HTTP/<span class="emphasis"><em>fqdn</em></span>@EXAMPLE.NET</pre>

      <p>This consists of the protocol, in this case <strong class="userinput"><code>HTTP</code></strong>, the fully qualified domain name (FQDN), and the realm of the domain. The protocol and the domain realm must be written in capitals, and the FQDN must exactly match the name with which the Web server is addressed later on. Otherwise, the client will refuse to work during the negotiate procedure. Below, <strong class="userinput"><code>nagios.example.net</code></strong> will be used as the FQDN, and the domain controller has the name <strong class="userinput"><code>dc01.example.net</code></strong>.</p>

      <p>The Kerberos implementation in Windows 2003 requires that the service ticket is bound to one user. To do this, a user is set up (in the example, <strong class="userinput"><code>webnagios</code></strong>) who does not need to have any special permissions. To create a ticket manually, you need the support tools in an Active Directory environment, which are best installed on a domain controller. After the installation, you change to the directory where the support tools are located and create the service ticket with the program <strong class="userinput"><code>ktpass</code></strong>:</p><a id="I_programlisting_d1e56871"/>
      <pre class="programlisting">C:\&gt; <span class="strong"><strong>cd \Programs\Support Tools</strong></span>
C:\Programs\Support Tools&gt; <span class="strong"><strong>ktpass -princ HTTP/nagios.example.net@EXAMP</strong></span>
<span class="strong"><strong>LE.NET -mapuser webnagios@example.net -pass ***** -out c:\temp\webnagios</strong></span>
<span class="strong"><strong>http.keytab</strong></span>

Targeting domain controller: dc01.example.net
Successfully mapped HTTP/nagios.example.net
to webnagios. Key created. Output keytab to
c:\temp\webnagioshttp.keytab: Keytab version:
0x502 keysize 81 HTTP/nagios.example.net@EXAMPLE.NET
ptype 1 (KRB5_NT_PRINCIPAL) vno 3 etype 0x3 (DES-CBC-MD5)
keylength 8 (0x7fc42302a7342952) Account webnagios has
been set for DES-only encryption.</pre>

      <p>The ticket is then copied to a directory, preferably in the Apache installation, for example to <strong class="userinput"><code>/etc/apache2/keytabs</code></strong>.</p>
    </div>

    <div class="sect2" title="E.2.3 Kerberos configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="kerberos_configuration"/>E.2.3 Kerberos configuration</h2>
      </div>

      <p><strong class="userinput"><code>/etc/krb5.conf</code></strong> is used as the configuration file for Kerberos:<a class="indexterm" id="IDX-APP-E-2359"/></p><a id="I_programlisting_d1e56902"/>
      <pre class="programlisting"># /etc/krb5.conf
[libdefaults]
   default_realm = EXAMPLE.NET

[realms]
   EXAMPLE.NET = {
        kdc = dc01.example.net:88
        kdc = dc02.example.net:88
        admin_server = dc01.example.net
}</pre>

      <p>The <strong class="userinput"><code>[libdefaults]</code></strong> section basically defines the defaults. It is important here that the domain realm is written in upper case. In the <strong class="userinput"><code>[realms]</code></strong> section, the individual realms are defined with their respective servers. The parameter <strong class="userinput"><code>kdc</code></strong> describes Kerberos servers that act as a key service (all domain controllers in the Active Directory), and <strong class="userinput"><code>admin_server</code></strong> is the Kerberos master (normally the first domain controller in the Active Directory). It must be possible to resolve the name specified here into an IP address, which can be tested with a <strong class="userinput"><code>ping</code></strong> to the FQDN given here.</p>

      <p>To see if Kerberos is working, it is best to use the program <strong class="userinput"><code>kinit</code></strong>, which—if successful—will obtain a valid ticket from the Kerberos server:</p><a id="I_programlisting_d1e56926"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>kinit administrator@EXAMPLE.NET</strong></span>
Password for administrator@EXAMPLE.NET: ******</pre>

      <p><strong class="userinput"><code>kinit</code></strong> requires a valid account as an argument, and it is important that the domain after the user name is written in upper case. If the password is correct and everything works, <strong class="userinput"><code>kinit</code></strong> will have no output. The ticket obtained can now be shown, with <strong class="userinput"><code>klist</code></strong>:</p><a id="I_programlisting_d1e56941"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>klist</strong></span>
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: administrator@EXAMPLE.NET

Valid starting      Expires     Service principal
08/26/07 14:31:47   08/27/07 00:31:49 krbtgt/EXAMPLE.NET@EXAMPLE.NET
      renew until 08/27/07 14:31:47

Kerberos 4 ticket cache: /tmp/tkt0
klist: You have no tickets cached</pre>
    </div>

    <div class="sect2" title="E.2.4 Apache configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_6"><a id="apache_configuration-id1"/>E.2.4 Apache configuration</h2>
      </div>

      <p>You must make sure that Apache really does load the module <strong class="userinput"><code>mod_auth_kerb</code></strong> when it starts. When installing through a distribution, the module is already preconfigured. In Debian "Etch" the accompanying <strong class="userinput"><code>LoadModule</code></strong> directive can be found in the file <strong class="userinput"><code>/etc/apache2/mods-available/auth_ kerb.load:</code></strong><a class="indexterm" id="IDX-APP-E-2360"/></p><a id="I_programlisting_d1e56964"/>
      <pre class="programlisting">LoadModule auth_kerb_module /usr/lib/apache2/modules/mod_auth_kerb.so</pre>

      <p>For activation, Debian uses the command <strong class="userinput"><code>a2enmod</code></strong>, which basically does nothing more than place a symlink in the directory <strong class="userinput"><code>/etc/apache2/mods-enabled/</code></strong>, pointing to the configuration file:</p><a id="I_programlisting_d1e56974"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>a2enmod auth_kerb</strong></span>
Module auth_kerb installed; run /etc/init.d/apache2 force-reload to enable.</pre>

      <p>To be able to use Kerberos for authentication, you need to modify the Apache configuration file <strong class="userinput"><code>/etc/apache2/conf.d/nagios.conf</code></strong>, which was described in <a class="xref" href="../Text/ch01s05.html#user_authentication" title="1.5.3 User authentication">1.5.3 User authentication</a> (<a class="xref" href="../Text/ch01s05.html#selinux" title="1.5.2 SELinux">1.5.2 SELinux</a>):</p><a id="I_programlisting_d1e56988"/>
      <pre class="programlisting">&lt;Directory "/usr/local/nagios"&gt;
   AllowOverride None
   Order allow,deny
   Allow from all

   # -- Authentification
   AuthType Kerberos
   AuthName "Nagios Monitoring"
   KrbAuthRealms EXAMPLE.NET
   Krb5Keytab /etc/apache2/keytabs/webnagioshttp.keytab
   KrbMethodK5Passwd on
   KrbMethodNegotiate on
   KrbSaveCredentials off

   require valid-user
&lt;/Directory&gt;</pre>

      <p><strong class="userinput"><code>AuthType</code></strong> specifies that Kerberos should be used. With <strong class="userinput"><code>AuthName</code></strong> the authentication is given a name, which is displayed in the <strong class="userinput"><code>Basic</code></strong> authentication. <strong class="userinput"><code>KrbAuthRealms</code></strong> describes one or more domain realms, and if there are several, they are separated by spaces.</p>

      <p>The service ticket generated on the domain controller is specified under <strong class="userinput"><code>Krb5Keytab</code></strong>. <strong class="userinput"><code>KrbMethodK5Passwd on</code></strong>, apart from the negotiate procedure, allows simple authentication using a password, in which the browser sends the password via <strong class="userinput"><code>Basic</code></strong> authentication to the Web server. With <strong class="userinput"><code>KrbMethodNegotiate on</code></strong> the negotiate procedure is switched on, and a completely closed Kerberos circuit is established. Then <strong class="userinput"><code>KrbSaveCredentials</code></strong> determines whether received authentication data are to be cached, in case other CGI applications should use these automatically. This is not necessary for our purposes, which is why we switch it off with the <strong class="userinput"><code>off</code></strong> option. Finally, <strong class="userinput"><code>require valid-user</code></strong> ensures that only valid users can gain access. A more detailed configuration, such as specifying a group or individual users, is not necessary, because Nagios manages its users itself and needs only the name of the authenticated user.</p>
    </div>

    <div class="sect2" title="E.2.5 Definition of a Nagios contact">
      <div class="titlepage">
        <h2 class="title" id="heading_id_7"><a id="definition_of_a_nagios_contact"/>E.2.5 Definition of a Nagios contact</h2>
      </div>

      <p>To be able to use single sign-on in Nagios, you now just need to adapt the name of the contact to the new, authenticated Web user <strong class="userinput"><code>user@REALM:</code></strong><a class="indexterm" id="IDX-APP-E-2361"/></p><a id="I_programlisting_d1e57039"/>
      <pre class="programlisting">define contact{
        use            template-contact-webuser
        contact_name   wob@EXAMPLE.NET
        alias          wob@EXAMPLE
        contactgroups  admins
        email          w.barth@example.net
}</pre>

      <p>The contact definition (see <a class="xref" href="../Text/ch02s07.html" title="2.7 Defining Addressees for Error Messages: contact">2.7 Defining Addressees for Error Messages: contact</a> in page 70) assumes that a template (see <a class="xref" href="../Text/ch02s11.html" title="2.11 Templates">2.11 Templates</a> in page 75) exists with the name <strong class="userinput"><code>template-contact-webuser</code></strong>.</p>

      <p>When modifying the authentication and the name change connected with this, you must also modify the CGI configuration file <strong class="userinput"><code>cgi.cfg</code></strong> (see <a class="xref" href="../Text/apas02.html" title="A.2 CGI Configuration in cgi.cfg">A.2 CGI Configuration in cgi.cfg</a> from page 606), if this is to explicitly contain entered users in the <strong class="userinput"><code>authorized_*</code></strong> parameters.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-7" id="ftn.APP-E-FN-7">322</a>]</sup> <a class="ulink" href="http://modauthkerb.sourceforge.net/">http://modauthkerb.sourceforge.net/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-8" id="ftn.APP-E-FN-8">323</a>]</sup> Even if the negotiation procedure was being used at browser startup, a password window pops up after a while and the IE switches back to Basic authentication.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="E.3 Single Sign-On with mod_auth_ntlm_winbind">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="single_sign-on_with_mod_auth_ntlm_winbin"/>E.3 Single Sign-On with <strong class="userinput"><code>mod_auth_ntlm_winbind</code></strong></h1>
    </div>

    <p>The Apache module <strong class="userinput"><code>mod_auth_ntlm_winbind</code></strong> uses the program originally developed for Squid, <strong class="userinput"><code>ntlm_auth</code></strong>, for authentication, and so one of its requirements is a Samba server installation in which the server itself is a member of an Active Directory domain. <strong class="userinput"><code>ntlm_auth</code></strong> uses <strong class="userinput"><code>winbind</code></strong> and therefore offers smooth integration into an existing Active Directory.<a class="indexterm" id="IDX-APP-E-2362"/></p>

    <p>The module has three methods available for authentication: NTLM, Negotiate (SPNEGO), and the <strong class="userinput"><code>Basic</code></strong> authentication. In Summer 2007 there were still problems with Negotiate. Developed originally for a proxy, the method did not quite fit the needs of a Web server and therefore was not used. At the time of writing, NTLM and <strong class="userinput"><code>Basic</code></strong> authentication remain, but this may change after this book is published. NTLM works very well, whereby <strong class="userinput"><code>ntlm_auth</code></strong> also allows the selection of a specific group. But you should also bear in mind that Microsoft is discontinuing NTLM for HTTP authentication with Windows Server 2008.</p>

    <div class="sect2" title="E.3.1 Installation">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="installation-id14"/>E.3.1 Installation</h2>
      </div>

      <p>The module is still very new. It has the version number 0.0.0 and can only be obtained in the source code from Subversion<sup>[<a class="footnote" href="#ftn.APP-E-FN-9" id="APP-E-FN-9">324</a>]</sup> or from corresponding <strong class="userinput"><code>unpacked</code></strong> directories.<sup>[<a class="footnote" href="#ftn.APP-E-FN-10" id="APP-E-FN-10">325</a>]</sup> Some documentation, in addition to the included <strong class="userinput"><code>README</code></strong>, can be found at SourceForge.<sup>[<a class="footnote" href="#ftn.APP-E-FN-11" id="APP-E-FN-11">326</a>]</sup></p>

      <p>For the installation you change to the directory where the source code has been unpacked:</p><a id="I_programlisting_d1e57120"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/src/mod_auth_ntlm_winbind</strong></span>
linux:src/mod_auth_ntlm_winbind # <span class="strong"><strong>autoconf</strong></span>
...
linux:src/mod_auth_ntlm_winbind # <span class="strong"><strong>./configure</strong></span>
...
linux:src/mod_auth_ntlm_winbind # <span class="strong"><strong>apxs2 -DAPACHE2 -c -i mod_auth_ntlm_ \</strong></span>
<span class="strong"><strong>winbind.c</strong></span>
...</pre>

      <p><strong class="userinput"><code>autoconf</code></strong> generates a <strong class="userinput"><code>configure</code></strong> file, which is then run to query the specific system parameters. The classic <strong class="userinput"><code>make ; make install</code></strong> usually doesn't work; luckily, there is no more work involved in running the Apache extension tool <strong class="userinput"><code>apxs2</code></strong> directly, which knows the precise settings of the installed Apache environment. The option <strong class="userinput"><code>-c</code></strong> compiles the C file specified, and <strong class="userinput"><code>-i</code></strong> installs the result to the directory where the other dynamically loadable modules are located.<a class="indexterm" id="IDX-APP-E-2363"/></p>

      <p>For Debian there is an Apache configuration file in the form of the file <strong class="userinput"><code>auth_ntlm_winbind.load</code></strong> in the subdirectory <strong class="userinput"><code>debian</code></strong>, which automatically loads the module when Apache is started:</p><a id="I_programlisting_d1e57168"/>
      <pre class="programlisting">LoadModule auth_ntlm_winbind_module /usr/lib/apache2/modules/mod_auth_nt
lm_winbind.so</pre>

      <p>This file is copied to the directory <strong class="userinput"><code>/etc/apache2/mods-available</code></strong>, and it is activated with <strong class="userinput"><code>a2enmod auth_ntlm_winbind</code></strong>.</p>

      <p>For other distributions the entry shown is entered in the file in which the dynamic modules are loaded, and the path to the module directory is adjusted accordingly. Then Apache is started again:</p><a id="I_programlisting_d1e57180"/>
      <pre class="programlisting">linux: # <span class="strong"><strong>/etc/init.d/apache2 stop; /etc/init.d/apache2 start</strong></span></pre>

      <p>A simple restart will not be sufficient in most cases.</p>
    </div>

    <div class="sect2" title="E.3.2 Preparing Samba">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="preparing_samba"/>E.3.2 Preparing Samba</h2>
      </div>

      <p>So that <strong class="userinput"><code>mod_auth_ntlm_winbind</code></strong> can perform its services, the server on which Apache is running must be included in the Active Directory domain as the Samba server. To do this, you need a current Samba-3 server package. The installation is best performed using the on-board resources of the distribution.</p>

      <p>For the domain membership, Kerberos (as described in <a class="xref" href="../Text/apes02.html#kerberos_configuration" title="E.2.3 Kerberos configuration">E.2.3 Kerberos configuration</a> from page 642) must be completely configured, and in addition you need a valid administrator ticket for access to the domain, obtained using <strong class="userinput"><code>kinit</code></strong>. If Samba is used only for the Apache module, a very simple Samba configuration is sufficient:</p><a id="I_programlisting_d1e57201"/>
      <pre class="programlisting"># /etc/samba/smb.conf (Minimalkonfiguration)
[global]
workgroup             =EXAMPLE
realm                 =EXAMPLE.NET
security              =ads
password server       =dc01.example.net dc02.example.net
encrypt passwords     =yes
idmap uid             =10000-20000
idmap gid             = 10000-20000
winbind enum users    =yes
winbind enum groups   =yes
winbind separator     = /
# winbind use default domain = yes
hosts allow           =127.0.0.1</pre>

      <p><strong class="userinput"><code>workgroup</code></strong> and <strong class="userinput"><code>realm</code></strong> correspond to the NetBIOS domain names and the fully written-out domain name of the Active Directory domain. For <strong class="userinput"><code>realm</code></strong>, it is again important that you write the name in capitals. <strong class="userinput"><code>security=ads</code></strong> describes the membership in an Active Directory domain. For the password server you must give at least one, and preferably two, domain controllers; <strong class="userinput"><code>encrypt passwords = yes</code></strong> is mandatory.</p>

      <p>The parameters <strong class="userinput"><code>idmap*</code></strong> and <strong class="userinput"><code>winbind enum*</code></strong> map Windows users and groups to Unix users and groups. For the <strong class="userinput"><code>winbind separator</code></strong> you should select a Unix-compatible character, normally <strong class="userinput"><code>/</code></strong>, to separate the domain from the user name, as in <strong class="userinput"><code>EXAMPLE/wob</code></strong>. If this results in problems with applications, however, you can replace this character with another one, provided that Nagios can handle it. Here <strong class="userinput"><code>hosts allow</code></strong> allows access only from the local host.</p>

      <p>The parameter <strong class="userinput"><code>winbind use default domain</code></strong> defines whether a missing domain should be replaced automatically by the default domain from <strong class="userinput"><code>workgroup</code></strong>. Then the domain can be omitted in the <strong class="userinput"><code>Basic</code></strong> authentication. At the same time, <strong class="userinput"><code>mod_auth_ntlm_winbind</code></strong> removes the domain name in the HTTP user. Users are treated differently, depending on the domain membership: Users from external domains are assigned to the HTTP user <strong class="userinput"><code>FOREIGN/</code></strong><strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong>, whereas users from the same domain are assigned only to <strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong> (without a domain in front). If you are just using a single domain, you can set the parameter to <strong class="userinput"><code>yes</code></strong>, and you will no longer need to worry about a possible prefixed domain.</p>

      <p>Access to the domain is achieved with the Samba command <strong class="userinput"><code>net ads join</code></strong>:</p><a id="I_programlisting_d1e57273"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>net ads join -U administrator@EXAMPLE.NET</strong></span>
administrator's password: ******
Using short domain name - EXAMPLE
Joined 'NAGIOS' to realm 'EXAMPLE.NET'</pre>

      <p>After successfully joining, it is essential that you restart both Samba and Winbind:</p><a id="I_programlisting_d1e57280"/>
      <pre class="programlisting">linux:~ <span class="strong"><strong># /etc/init.d/samba restart</strong></span>
linux:~ <span class="strong"><strong># /etc/init.d/winbind restart</strong></span></pre>

      <p>You can test whether everything is working properly with <strong class="userinput"><code>wbinfo -t</code></strong>. The command runs an encrypted RPC call, which is only possible if the server really is a member in the domain:</p><a id="I_programlisting_d1e57293"/>
      <pre class="programlisting">linux:~ <span class="strong"><strong># wbinfo -t</strong></span>
checking the trust secret via RPC calls succeeded</pre>

      <p>If you still want to play around a bit with Winbind, you can display all users displayed with <strong class="userinput"><code>wbinfo -u</code></strong> and all groups with <strong class="userinput"><code>wbinfo -g</code></strong>. When run for the first time after being started, it will take a while until the two programs display anything.</p>

      <p>For authentication, Apache calls the program <strong class="userinput"><code>ntlm_auth</code></strong> with the permissions under which the Web server is running. In Debian this is the user <strong class="userinput"><code>www-data</code></strong> from the group <strong class="userinput"><code>www-data</code></strong>. With his permissions, <strong class="userinput"><code>ntlm_auth</code></strong> tries to access the directory <strong class="userinput"><code>/var/lib/samba/winbindd_privileged/</code></strong>. This must belong to the user <strong class="userinput"><code>root</code></strong> and be readable for the user under which Apache is running, and otherwise nobody else may access the directory:</p><a id="I_programlisting_d1e57327"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>chgrp www-data /var/lib/samba/winbindd_privileged</strong></span>
user@linux:~$ <span class="strong"><strong>chmod 750 /var/lib/samba/winbindd_privileged</strong></span>
user@linux:~$ <span class="strong"><strong>ls -ld /var/lib/samba/winbindd_privileged</strong></span>
drwxr-x— 2 root www-data 4096 Aug 26 17:51 /var/lib/samba/winbindd_pri
vileged/</pre>

      <p>If the access permissions are incorrectly set, <strong class="userinput"><code>ntlm_auth</code></strong> will refuse its services.</p>
    </div>

    <div class="sect2" title="E.3.3 Apache configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="apache_configuration-id2"/>E.3.3 Apache configuration</h2>
      </div>

      <p>The module <strong class="userinput"><code>mod_auth_ntlm_winbind</code></strong> requires only a few entries in the Apache configuration file <strong class="userinput"><code>/etc/apache2/conf.d/nagios.conf</code></strong>, since the overwhelming part of the configuration takes place in Kerberos and Samba. The file <strong class="userinput"><code>nagios.conf</code></strong>, described in <a class="xref" href="../Text/ch01s05.html#user_authentication" title="1.5.3 User authentication">1.5.3 User authentication</a> (page 49), is changed as follows:</p><a id="I_programlisting_d1e57359"/>
      <pre class="programlisting">&lt;Directory "/usr/local/nagios"&gt;
  AllowOverride None
  Order allow,deny
  Allow from all

  AuthName "Nagios Monitoring"
  # -- NTLM
  AuthType NTLM
  NTLMAuth on
  NTLMAuthHelper "/usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp"

  # -- Basic
  NTLMBasicAuth on
  NTLMBasicAuthoritative on
  PlaintextAuthHelper "/usr/bin/ntlm_auth --helper-protocol=squid-2.5-bas
ic"
  NTLMBasicRealm "Nagios Monitoring (Basic)"

  # -- Negotiate
  # AuthType Negotiate
  # NegotiateAuth on
  # NegotiateAuthHelper "/usr/bin/ntlm_auth --helper-protocol=gss-spnego"

   require valid-user
&lt;/Directory&gt;</pre>

      <p>Only three parameters are needed for NTLM authentication: <strong class="userinput"><code>AuthType</code></strong> selects the authentication module, <strong class="userinput"><code>NTLMAuth</code></strong> on activates the NTLM procedure, and <strong class="userinput"><code>NTLMAuthHelper</code></strong> defines the specific call of <strong class="userinput"><code>ntlm_auth</code></strong>. Here the protocol <strong class="userinput"><code>squid-2.5-ntlmssp</code></strong> is used, which was originally intended for Squid.</p>

      <p>The <strong class="userinput"><code>Basic</code></strong> authentication, in which the browser sends user and password in plain text to the Web server, also requires a <span class="emphasis"><em>Basic Realm</em></span> to be specified in the form of the parameter <strong class="userinput"><code>NTLMBasicRealm</code></strong>. The value of the parameter <strong class="userinput"><code>NTLMBasic Authoritative</code></strong> controls whether a failed attempt (User not found) can then be answered (<strong class="userinput"><code>on</code></strong>) or whether further authentication modules—if they exist—should be queried (<strong class="userinput"><code>off</code></strong>).</p>

      <p>If it does not really functon properly, the negotiation procedure should not be configured under any circumstances. If the Web server offers negotiation along with the other procedures, the browser will always choose to negotiate. The authentication is then bound to fail.</p>

      <p>By the way, with the <strong class="userinput"><code>ntlm_auth</code></strong> parameter <strong class="userinput"><code>--require-membership-of</code></strong>, membership in a particular group can be forced. <strong class="userinput"><code>/usr/bin/ntlm_auth--require-membership-of =EXAMPLE/admins</code></strong> returns OK only if the user who is authenticating himself is a member of the group <strong class="userinput"><code>admins</code></strong>. The separator/corresponds to the value of <strong class="userinput"><code>winbind separator</code></strong> given in <strong class="userinput"><code>smb.conf</code></strong>.</p>
    </div>

    <div class="sect2" title="E.3.4 Defining a Nagios contact">
      <div class="titlepage">
        <h2 class="title" id="heading_id_6"><a id="defining_a_nagios_contact"/>E.3.4 Defining a Nagios contact</h2>
      </div>

      <p>In the definition of the contact, the setting <strong class="userinput"><code>winbind use default domain</code></strong> in the Samba configuration file <strong class="userinput"><code>smb.conf</code></strong> must be taken into account. If the value <strong class="userinput"><code>no</code></strong> is given there (or if the parameter is not given at all), the contact name will always consist of the domain, written in capitals, the <strong class="userinput"><code>winbind separator</code></strong>, and the user name:</p><a id="I_programlisting_d1e57439"/>
      <pre class="programlisting">define contact{
       use           template-contact-webuser
       contact_name  EXAMPLE/wob
       ...
}</pre>

      <p>On the other hand, if <strong class="userinput"><code>winbind use default domain</code></strong> is set to <strong class="userinput"><code>yes</code></strong>, the domain is omitted for users in the domain to which the Nagios server belongs. For users in external domains, the naming convention with the prefixed domain is retained.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-9" id="ftn.APP-E-FN-9">324</a>]</sup> svn co <a class="ulink" href="svn://svnanon.samba.org/lorikeet/trunk/mod_auth_ntlm_winbind_mod_auth_ntlm_winbind">svn://svnanon.samba.org/lorikeet/trunk/mod_auth_ntlm_winbind_mod_auth_ntlm_winbind</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-10" id="ftn.APP-E-FN-10">325</a>]</sup> <a class="ulink" href="http://samba.org/ftp/unpacked/lorikeet/mod_auth_ntlm_winbind/">http://samba.org/ftp/unpacked/lorikeet/mod_auth_ntlm_winbind/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-11" id="ftn.APP-E-FN-11">326</a>]</sup> <a class="ulink" href="http://adldap.sourceforge.net/mod_auth_ntlm_winbind.php">http://adldap.sourceforge.net/mod_auth_ntlm_winbind.php</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="E.4 Mozilla Firefox as a Web Client">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="mozilla_firefox_as_a_web_client"/>E.4 Mozilla Firefox as a Web Client</h1>
    </div>

    <p>Configuring the Mozilla Web browser in Windows XP is very simple, provided that the workstation is a member in the Active Directory domain. With the address <strong class="userinput"><code>about:config</code></strong> you can call up the current configuration in Firefox and enter <strong class="userinput"><code>negotiate</code></strong> as the filter (see <a class="xref" href="../Text/apes04.html#single_sign-on_via_spnego_solidus" title="Figure E-2. Single sign-on via SPNEGO/Kerberos is enabled in the Firefox settings under network.negotiate">Figure E-2</a>). In the <strong class="userinput"><code>network.negotiate-auth.trusted-uris</code></strong> parameter you enter all hosts or domains for which an automatic login should take place. Multiple entries are separated by spaces or commas. If a target host or its domain is not in the list, Firefox will certainly ask for the user name and password. These are transmitted in plain text, however, which is why you should prefer automatic login in all cases.<a class="indexterm" id="IDX-APP-E-2364"/></p>

    <div class="figure">
      <a id="single_sign-on_via_spnego_solidus"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e57473"/><img alt="Single sign-on via SPNEGO/Kerberos is enabled in the Firefox settings under network.negotiate" src="../Images/tagoreillycom20081104nostarchimages224028.png.jpg"/></div>

      <p class="title">Figure E-2. Single sign-on via SPNEGO/Kerberos is enabled in the Firefox settings under <code class="userinput">network.negotiate</code></p>
    </div>

    <p>In Linux you can also authenticate yourself with Firefox automatically via the negotiation procedure. You need only a valid user ticket to do this.</p>

    <p>As long as the Linux workstation logins are not already actively processed via Kerberos, it is enough just to obtain the ticket manually with <strong class="userinput"><code>kinit</code></strong>. In addition the file <strong class="userinput"><code>/etc/krb5.conf</code></strong> must be configured as described in <a class="xref" href="../Text/apes02.html#kerberos_configuration" title="E.2.3 Kerberos configuration">E.2.3 Kerberos configuration</a> from page 642. As a normal user, you fetch the ticket with the realm of the corresponding Windows user:</p><a id="I_programlisting_d1e57490"/>
    <pre class="programlisting">user@linux:~$ <span class="strong"><strong>kinit myuser@EXAMPLE.NET</strong></span>
Password for myuser@EXAMPLE.NET: ******</pre>

    <p>Afterward, you can check with <strong class="userinput"><code>klist</code></strong> to see whether you really have received a ticket. This is usually only valid for eight hours. After the time has expired, you must fetch a new ticket, because without a valid ticket Firefox will announce itself again with the user/password query.</p>

    <div class="sect2" title="E.4.1 Firefox and NTLM">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="firefox_and_ntlm"/>E.4.1 Firefox and NTLM</h2>
      </div>

      <p>Along with the SPNEGO/Kerberos procedure, Firefox is also capable of performing authentication via NTLM. To do this, you enter the desired domains or hosts in the parameter <strong class="userinput"><code>network.automatic-ntlm-auth.trusted-uris</code></strong>. In Windows XP, everything else runs automatically.</p>

      <p>In Linux, NTLM authentication is normally not available, since a Linux client cannot authenticate itself via NTLM to a Windows domain in the Active Directory. But there is also a solution here: the <span class="emphasis"><em>NTLM Authorization Proxy Server</em></span> <strong class="userinput"><code>ntlmaps</code></strong><sup>[<a class="footnote" href="#ftn.APP-E-FN-12" id="APP-E-FN-12">327</a>]</sup> allows even Linux clients to take part in an NTLM-based Web authentication. A description of this would go beyond the scope of this book, however.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-E-FN-12" id="ftn.APP-E-FN-12">327</a>]</sup> <a class="ulink" href="http://ntlmaps.sourceforge.net/">http://ntlmaps.sourceforge.net/</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="E.5 Microsoft Internet Explorer as a Web Client">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="microsoft_internet_explorer_as_a"/>E.5 Microsoft Internet Explorer as a Web Client</h1>
    </div>

    <p>Microsoft Internet Explorer can handle both the SPNEGO/Kerberos and the NTLM authentication procedures. For reasons of security, however, Internet Explorer does not always immediately provide information on account data. You should therefore enter the Nagios host in the security settings under <span class="strong"><strong>Trusted Sites</strong></span>, using exactly the same URL that it will be called with later on (<a class="xref" href="../Text/apes05.html#how_to_add_hosts_for_trusted" title="Figure E-3. How to add hosts for trusted sites in Internet Explorer">Figure E-3</a>).<a class="indexterm" id="IDX-APP-E-2365"/></p>

    <div class="figure">
      <a id="how_to_add_hosts_for_trusted"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e57536"/><img alt="How to add hosts for trusted sites in Internet Explorer" src="../Images/tagoreillycom20081104nostarchimages224030.png.jpg"/></div>

      <p class="title">Figure E-3. How to add hosts for trusted sites in Internet Explorer</p>
    </div>

    <p>In addition you should check, in <span class="strong"><strong>Custom Level</strong></span>, whether the user name and password really need to be transmitted for the level selected (<a class="xref" href="../Text/apes05.html#when_updating_the_trustworthy_sites" title="Figure E-4. When updating the trustworthy sites, Automatic logon with current user name and password must be checked">Figure E-4</a>). After the changes, it does not do any harm to restart Internet Explorer.</p>

    <div class="figure">
      <a id="when_updating_the_trustworthy_sites"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e57551"/><img alt="When updating the trustworthy sites, Automatic logon with current user name and password must be checked" src="../Images/tagoreillycom20081104nostarchimages224032.png.jpg"/></div>

      <p class="title">Figure E-4. When updating the trustworthy sites, Automatic logon with current user name and password must be checked</p>
    </div>
  </div>


  <div class="appendix" title="Appendix&#xA0;F.&#xA0;Tips on Optimizing Performance">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="tips_on_optimizing_performance"/>Appendix F. Tips on Optimizing Performance</h1>
    </div>

    <p>It is very difficult to describe, in general terms, a Nagios installation that performs well. Nagios should perform checks immediately, that is, it should have a small <span class="emphasis"><em>latency time</em></span> for host and service checks. This is the difference between the planned and actual execution times of the check. If this is an hour or more, you can certainly talk about disastrous performance. On the other hand, latency of less than a second represents very good performance. In between these extremes, the borders between acceptable and unacceptable are somewhat hazy.<a class="indexterm" id="IDX-APP-F-2366"/></p>

    <p>The latency time of host and service checks can be measured objectively. Other, more subjective impressions are more difficult to evaluate. Doggedly working on the command line of the host, a really high system load, or a long time lag for a page to be displayed when the Nagios Web interface is called: whether such things are regarded as performance problems or can be tolerated, depends on what your specific requirements are. If the Web interface always needs more than ten seconds to display even just a few services, this is certainly not acceptable for interactive use. A load of 40 on a powerful 4-CPU machine may not be a problem, while a load of 10 on a less powerful system may already be catastrophic.</p>

    <p>Of course, the capacity of the host system on which Nagios is installed also heavily influences the overall performance. A very slow RAID system, for instance, could slow down Nagios considerably if Nagios wants to write a large number of check results to the RAID within a short period of time, and the NDOUtils simultaneously want to save all events to a database. If the latency values of Nagios are within tolerance, there is no reason from the perspective of Nagios to change the configuration of the RAID system.</p>

    <p>So that we can better distinguish between individual qualities, we will introduce two concepts here. A <span class="emphasis"><em>performance indicator</em></span> is a measure of the objective performance of Nagios. The latency time of service and host checks is by far the best choice for a performance indicator. As soon as anything at all starts creating problems for Nagios, this nearly always manifests itself directly in the latency.</p>

    <p><span class="emphasis"><em>Problem indicators</em></span>, on the other hand, are parameters which may point to a possible problem, but whose absolute values alone does not allow a judgment to be made about the actual performance. These may be system measurements, such as a high CPU load or permanent swapping of the host on which Nagios is running, or they may be internal Nagios measurements, such as a permanently full queue for the results of external commands (see <a class="xref" href="../Text/apfs03.html" title="F.2.6 Preferring passive checks">F.2.6 Preferring passive checks</a> in page 666).</p>

    <div class="sect1" title="F.1 Internal Statistics of Nagios">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="internal_statistics_of_nagios"/>F.1 Internal Statistics of Nagios</h1>
      </div>

      <p>Nagios displays a short version of the performance indicators in the so-called tactical overview of the Web interface, at the top right, (see Figure in <a class="xref" href="../Text/ch16s02.html#the_most_important_things_at_a_glance_c" title="16.2.4 The most important things at a glance: tac.cgi">16.2.4 The most important things at a glance: tac.cgi</a>), and a slightly more detailed version via <strong class="userinput"><code>extinfo.cgi</code></strong> (see Figure in <a class="xref" href="../Text/ch16s02.html#additional_information_and_control_cent" title="16.2.2 Additional information and control center: extinfo.cgi">16.2.2 Additional information and control center: extinfo.cgi</a>). In addition, the command-line program <strong class="userinput"><code>nagiostats</code></strong> shows individual performance values or a summary of all data.<a class="indexterm" id="IDX-APP-F-2367"/></p>

      <div class="sect2" title="F.1.1 The command-line tool nagiostats">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="the_command-line_tool_nagiostats"/>F.1.1 The command-line tool nagiostats</h2>
        </div>

        <p><strong class="userinput"><code>nagiostats</code></strong> is installed automatically during the Nagios installation and is located in the same directory as the main <strong class="userinput"><code>nagios</code></strong> program itself (in our case: <strong class="userinput"><code>/usr/local/nagios/bin</code></strong>). It requires, as a parameter, the main configuration file <strong class="userinput"><code>nagios.cfg</code></strong>, along with the path to it, in order to display all values in Nagios 2.x. (For Nagios 3.0 this is not necessary.)</p><a id="I_programlisting_d1e57616"/>
        <pre class="programlisting">user@linux:~$ /usr/local/nagios/bin/nagiostats -c /etc/nagios/nagios.cfg
Nagios Stats 3.0b3
Copyright (c) 2003-2007 Ethan Galstad (www.nagios.org)
Last Modified: 08-30-2007
License: GPL

CURRENT STATUS DATA
-----------------------------------------------------
Status File:                              /var/nagios/status.dat
Status File Age:                          0d 0h 0m 5s
Status File Version:                      3.0b3

Program Running Time:                     1d 23h 26m 57s
Nagios PID:                               8184
<span class="strong"><strong>Used/High/Total Command Buffers:          0 / 1 / 4096</strong></span>

Total Services:                           1997
Services Checked:                         1997
Services Scheduled:                       1995
Services Actively Checked:                1995
Services Passively Checked:               2
Total Service State Change:               0.000 / 30.260 / 0.040 %
<span class="strong"><strong>Active Service Latency:                   0.000 / 2.233 / 0.361 sec</strong></span>
Active Service Execution Time:            0.063 / 20.081 / 0.518 sec
Active Service State Change:              0.000 / 7.630 / 0.011 %
Active Services Last 1/5/15/60 min:       308 / 1417 / 1922 / 1944
Passive Service State Change:             26.250 / 30.260 / 28.255 %
Passive Services Last 1/5/15/60 min:      0 / 0 / 0 / 0
Services Ok/Warn/Unk/Crit:                1904 / 61 / 5 / 27
Services Flapping:                        2
Services In Downtime:                     0

Total Hosts:                              166
Hosts Checked:                            166
Hosts Scheduled:                          166
Hosts Actively Checked:                   166
Host Passively Checked:                   0
Total Host State Change:                  0.000 / 0.000 / 0.000 %
<span class="strong"><strong>Active Host Latency:                      0.000 / 1.527 / 0.638 sec</strong></span>
<span class="strong"><strong>Active Host Execution Time:               0.066 / 0.537 / 0.155 sec</strong></span>
Active Host State Change:                 0.000 / 0.000 / 0.000 %
Active Hosts Last 1/5/15/60 min:          52 / 148 / 166 / 166
Passive Host State Change:                0.000 / 0.000 / 0.000 %
Passive Hosts Last 1/5/15/60 min:         0 / 0 / 0 / 0
Hosts Up/Down/Unreach:                    166 / 0 / 0
Hosts Flapping:                           0
Hosts In Downtime:                        0

Active Host Checks Last 1/5/15 min:       59 / 209 / 622
   Scheduled:                             54 / 154 / 475
   On-demand:                             5 / 43 / 108
   Parallel:                              59 / 198 / 584
<span class="strong"><strong>   Serial:                                0 / 0 / 0</strong></span>
   Cached:                                0 / 12 / 39
Passive Host Checks Last 1/5/15 min:      0 / 0 / 0
<span class="strong"><strong>Active Service Checks Last 1/5/15 min:    345 / 2148 / 6342</strong></span>
      Scheduled:                          345 / 2148 / 6342
      On-demand:                          0 / 0 / 0
      Cached:                             0 / 0 / 0
Passive Service Checks Last 1/5/15 min:   0 / 0 / 0

External Commands Last 1/5/15 min:        0 / 0 / 0</pre>

        <p>The program first provides information on the evaluated status file and the Nagios version. The details of the <strong class="userinput"><code>Command Buffers</code></strong> in the second paragraph are of more interest. If the command buffer becomes full, Nagios will have problems processing commands via the interface for external commands. All passive checks will suffer from this (see <a class="xref" href="../Text/apfs03.html" title="F.2.6 Preferring passive checks">F.2.6 Preferring passive checks</a>).</p>

        <p>The next two blocks provide values on host and service checks. Many of them are of a purely informative nature. If the right column contains several values, as for the two performance indicators <strong class="userinput"><code>Active Service Latency</code></strong> and <strong class="userinput"><code>Active Host Latency</code></strong> (shown here in bold type), without the page on left offering any explanation of this, then these are the minimum and maximum values and a mean value.</p>

        <p>You should keep an eye on the two problem indicators <strong class="userinput"><code>Active Host Execution Time</code></strong> and <strong class="userinput"><code>Active Service Execution Time</code></strong>. Long execution times for host checks due to failed hosts certainly have a negative influence on Nagios's performance. With a standard timeout of 10 seconds for plug-ins, average values of more than 30 seconds are rather ominous, assuming that long timeouts were not configured explicitly. Although long execution times for service checks usually have no significant effect on performance, they nevertheless reveal that something is not right.</p>

        <p>The details for <strong class="userinput"><code>Active/Passive Host/Service Checks Last 1/5/15 min</code></strong> in the final information block provide statistics that describe how the current check results were determined. The details under <strong class="userinput"><code>Scheduled</code></strong> deal with the checks planned regularly by Nagios, and the <strong class="userinput"><code>On-demand</code></strong> lines deal with tests executed while taking account of current circumstances. For hosts, these include checks made due to failed hosts, and, for services, tests triggered by dependencies. If a test can be avoided because of an already existing and relatively up-to-date value, this is listed in the <strong class="userinput"><code>Cached</code></strong> line.</p>

        <p>For host checks, the statistic in the line <strong class="userinput"><code>Serial</code></strong> also reveals how many tests were executed in series in accordance with the inefficient old host check logic. The line <strong class="userinput"><code>Parallel</code></strong> deals with host checks executed in parallel and also shows the values for regularly planned and executed host checks. Active host checks can contribute in Nagios 3.0 to an improvement in performance. In Nagios 2.x you should leave them out if possible. The improvements in the host check logic are described in <a class="xref" href="../Text/aphs07.html" title="H.7 A New Logic for Host Checks">H.7 A New Logic for Host Checks</a> in page 689.</p>

        <p>The 5-minute average resource of <strong class="userinput"><code>Active Service Checks Last</code></strong> gives information on the activities of Nagios rather than on the absolute number of service checks: 10,000 service checks with a check interval of 20 minutes result in just 2,500 checks in the 5-minute average, but 1,000 checks with a check interval of just 1 minute lead to 5,000 in the 5-minute average.</p>

        <p>The absolute number of all checks therefore does not mean a lot. The crucial issue is how many checks Nagios carries out per time unit: 2,500 service checks in 5 minutes results in an average of 8.33 checks per second. This means that Nagios starts 8.33 checks every second and at the same time has to gather and process the results of 8.33 other checks, forward any performance data to an external program, and then it might even have to wait for each check to be handed over. If the NDOUtils are used in addition (see <a class="xref" href="../Text/ch17.html" title="Chapter 17. Flexible Web Interface with the NDOUtils">Chapter 17</a>, page 375), the system also passes on results to the event broker.</p>

        <div class="sect3" title="Determining single values">
          <div class="titlepage">
            <h3 class="title" id="heading_id_5"><a id="determining_single_values"/>Determining single values</h3>
          </div>

          <p><strong class="userinput"><code>nagiostats</code></strong> also displays selected values, with the options <strong class="userinput"><code>--mrtg</code></strong> and <strong class="userinput"><code>--data=</code></strong><strong class="userinput"><code><em class="replaceable"><code>variables</code></em></code></strong>. What values are available here can be seen by running <strong class="userinput"><code>nagiostats -h:</code></strong></p><a id="I_programlisting_d1e57711"/>
          <pre class="programlisting">user@linux:~$ <span class="strong"><strong>/usr/local/nagios/bin/nagiostats -h</strong></span>
 ...
 NUMACTSVCCHECKSxM  number of total active service checks
                    occuring in last 1/5/15 minute
 ...
 xxxACTSVCLAT       MIN/MAX/AVG active service check latency (ms).
 ...</pre>

          <p>Here, the <strong class="userinput"><code>x</code></strong> in <strong class="userinput"><code>NUMACTSVCCHECKSxM</code></strong> is replaced with the desired time period in minutes: <strong class="userinput"><code>1</code></strong>, <strong class="userinput"><code>5</code></strong>, <strong class="userinput"><code>15</code></strong>, or <strong class="userinput"><code>60</code></strong>:</p><a id="I_programlisting_d1e57737"/>
          <pre class="programlisting">user@linux:~$ <span class="strong"><strong>/usr/local/nagios/bin/nagiostats -c /etc/nagios/nagios.cfg\</strong></span>
 <span class="strong"><strong>   --mrtg --data=NUMACTSVCCHECKS5M</strong></span>
2195</pre>

          <p>With <strong class="userinput"><code>xxxACTSVCLAT</code></strong>, <strong class="userinput"><code>nagiostats</code></strong> behaves in a similar manner; now <strong class="userinput"><code>xxx</code></strong> is replaced by <strong class="userinput"><code>MIN</code></strong> (Minimum), <strong class="userinput"><code>MAX</code></strong> (Maximum), or <strong class="userinput"><code>AVG</code></strong> (mean value). Multiple target values are separated by commas:</p><a id="I_programlisting_d1e57766"/>
          <pre class="programlisting">user@linux:~$ <span class="strong"><strong>/usr/local/nagios/bin/nagiostats -c /etc/nagios/nagios.cfg\</strong></span>
 <span class="strong"><strong>   --mrtg --data=MINACTSVCLAT,MAXACTSVCLAT,AVGCTSVCLAT</strong></span>
0
934
203</pre>

          <p>The output here is given in milliseconds, and each value has its own line. The average latency time for service checks is therefore 0.203 seconds, and the maximum, 0.934 seconds. The switch <strong class="userinput"><code>--mrtg</code></strong> indicates that this output is intended primarily for processing by MRTG, as will be seen in the next section. Individual output of performance indicators is also very useful when you are writing your own plugins. We will look at this in <a class="xref" href="../Text/apf.html#a_plugin_to_monitor_latency" title="F.1.3 A plugin to monitor latency">F.1.3 A plugin to monitor latency</a> from page 660.<a class="indexterm" id="IDX-APP-F-2368"/><a class="indexterm" id="IDX-APP-F-2369"/></p>
        </div>
      </div>

      <div class="sect2" title="F.1.2 Showing Nagios performance graphically">
        <div class="titlepage">
          <h2 class="title" id="heading_id_6"><a id="showing_nagios_performance_graphic"/>F.1.2 Showing Nagios performance graphically</h2>
        </div>

        <p>The <span class="emphasis"><em>Multi Router Traffic Grapher (MRTG)</em></span><sup>[<a class="footnote" href="#ftn.APP-F-FN-1" id="APP-F-FN-1">328</a>]</sup> was originally developed to represent the bandwidth of active network components in graphical form. MRTG always displays two measured values in a graphic, one as a green area, the other as a blue line. When representing network bandwidths, these are normally for incoming and outgoing traffic. Nagios uses MRTG to display the values delivered by <strong class="userinput"><code>nagiostats</code></strong>.</p>

        <p>Usually the best way to install MRTG is from the package of the same name provided by the distribution you are using. The sources can be found on the homepage.<sup>[<a class="footnote" href="#ftn.APP-F-FN-2" id="APP-F-FN-2">329</a>]</sup></p>

        <p>MRTG is run by cron every five minutes. Debian includes the ready-made cron table <strong class="userinput"><code>/etc/cron.d/mrtg</code></strong>; the tool expects its configuration to be in <strong class="userinput"><code>/etc/mrtg.cfg</code></strong>. The file provided by Debian contains just two global settings:</p><a id="I_programlisting_d1e57816"/>
        <pre class="programlisting"># Global configuration
WorkDir: /var/www/mrtg
WriteExpires: Yes</pre>

        <p><strong class="userinput"><code>WorkDir</code></strong> specifies the directory in which MRTG should save the current graphics, and <strong class="userinput"><code>WriteExpires</code></strong> creates additional Expire files for Apache. This parameter can be omitted, however.</p>

        <p>To these two lines you simply append the configuration file <strong class="userinput"><code>mrtg.cfg</code></strong> included by Nagios in the <strong class="userinput"><code>./sample-config</code></strong> directory of the source code.</p>

        <p>Finally, you use the program <strong class="userinput"><code>indexmaker</code></strong>, which is also part of the MRTG package, to generate the overview page shown in <a class="xref" href="../Text/apf.html#mrtg_overview_page_for" title="Figure F-1. MRTG overview page for the Nagios performance indicators">Figure F-1</a>:</p><a id="I_programlisting_d1e57840"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>indexmaker /etc/mrtg.cfg &gt; /var/www/mrtg/index.html</strong></span></pre>

        <div class="figure">
          <a id="mrtg_overview_page_for"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e57847"/><img alt="MRTG overview page for the Nagios performance indicators" src="../Images/tagoreillycom20081104nostarchimages224034.png.jpg"/></div>

          <p class="title">Figure F-1. MRTG overview page for the Nagios performance indicators</p>
        </div>

        <p>If you click on one of the graphics on this page, a detailed view will appear that displays the graphs in different time resolutions, as shown in <a class="xref" href="../Text/apf.html#detail_view_for_the_lat" title="Figure F-2. Detail view for the latency time for service checks">Figure F-2</a> (daily, weekly, monthly, and annually).</p>

        <div class="figure">
          <a id="detail_view_for_the_lat"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject_d1e57860"/><img alt="Detail view for the latency time for service checks" src="../Images/tagoreillycom20081104nostarchimages224036.png.jpg"/></div>

          <p class="title">Figure F-2. Detail view for the latency time for service checks</p>
        </div>

        <p>The graphical display of the check latencies over the course of time allows you to see at a glance whether a high latency is a isolated event, part of a trend, or a permanent problem. The view in <a class="xref" href="../Text/apf.html#detail_view_for_the_lat" title="Figure F-2. Detail view for the latency time for service checks">Figure F-2</a> clearly shows that the measures taken on Saturday afternoon<sup>[<a class="footnote" href="#ftn.APP-F-FN-3" id="APP-F-FN-3">330</a>]</sup> have had a positive effect (see weekly graphic). Instead of 20–80 seconds, the service check latency now lies at values below one second.</p>

        <p>The accompanying online documentation<sup>[<a class="footnote" href="#ftn.APP-F-FN-4" id="APP-F-FN-4">331</a>]</sup> contains more detailed links for each individual graphic, with links to the documentation of various parameters that can be used to influence the indicators shown in each graphic.</p>
      </div>

      <div class="sect2" title="F.1.3 A plugin to monitor latency">
        <div class="titlepage">
          <h2 class="title" id="heading_id_7"><a id="a_plugin_to_monitor_latency"/>F.1.3 A plugin to monitor latency</h2>
        </div>

        <p>What could be more appropriate than to have Nagios monitor its own performance and, if necessary, use the notification system? To do this, you can query the latency values with <strong class="userinput"><code>nagiostats</code></strong> or use the plugin <strong class="userinput"><code>check_mrtg</code></strong> to query the performance data already collected through MRTG.<a class="indexterm" id="IDX-APP-F-2370"/><a class="indexterm" id="IDX-APP-F-2371"/><a class="indexterm" id="IDX-APP-F-2372"/><a class="indexterm" id="IDX-APP-F-2373"/><a class="indexterm" id="IDX-APP-F-2374"/><a class="indexterm" id="IDX-APP-F-2375"/><a class="indexterm" id="IDX-APP-F-2376"/></p>

        <p>We will choose the first method here and provide the latency time for service checks as a passive check result for Nagios. The shell script intended for this purpose is run via cron independently of the Nagios scheduling. A plugin actively run by Nagios may in some circumstances return no results, or only irregular ones, if the Nagios schedule has become totally messed up because of performance problems. The script looks like this:<a class="indexterm" id="IDX-APP-F-2377"/></p><a id="I_programlisting_d1e57929"/>
        <pre class="programlisting">#!/bin/bash
# Attention: thresholds in milliseconds

WARN=20000
CRIT=60000
TIMESTAMP='date +%s'
CMDFILE='/var/nagios/rw/nagios.cmd'

LATENCY='/usr/local/nagios/bin/nagiostats \
           --config=/etc/nagios/nagios.cfg \
           --mrtg --data=AVGACTSVCLAT'

if [$LATENCY &lt; $WARN ]; then
   STATUS=0; INFO="OK"
elif [$LATENCY &lt; $CRIT ]; then
   STATUS=1; INFO="WARNING"
else
   STATUS=2; INFO="CRITICAL"
fi

CMD="PROCESS_SERVICE_CHECK_RESULT"
OUTCMD="[%lu] $CMD;<span class="emphasis"><em>nagios-server</em></span>;Service Latency;$STATUS;"
OUTINFO="$INFO Service Latency = ${LATENCY}ms "
OUTPERF="svclat=$LATENCY;$WARN;$CRIT;\n"

printf "${OUTCMD}${OUTINFO}|${OUTPERF}" $TIMESTAMP &gt; $CMDFILE</pre>

        <p>First <strong class="userinput"><code>nagiostats</code></strong> determines the current value for average service latencies (<strong class="userinput"><code>AVGACTSVCLAT</code></strong>). The script saves the result in the variable <strong class="userinput"><code>LATENCY</code></strong> and decides, using the thresholds in <strong class="userinput"><code>WARN</code></strong> and <strong class="userinput"><code>CRIT</code></strong>, whether it should return OK, WARNING, or CRITICAL.</p>

        <p><strong class="userinput"><code>OUTCMD</code></strong>, <strong class="userinput"><code>OUTINFO</code></strong>, and <strong class="userinput"><code>OUTPERF</code></strong> compose the command that is passed on to the interface for external commands (see also <a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>, page 292). It begins with the timestamp in square brackets. The command <strong class="userinput"><code>PROCESS_SERVICE_CHECK_RESULT</code></strong> is followed by the host name and the service name <strong class="userinput"><code>Service Latency</code></strong>, the status, and the actual output, including performance data. In Nagios 3.0 it is better to omit the detail of the configuration file, with <strong class="userinput"><code>--config</code></strong>, because <strong class="userinput"><code>nagiostats</code></strong> will otherwise begin its output with an additional info line that only interferes with the script:<a class="indexterm" id="IDX-APP-F-2378"/><a class="indexterm" id="IDX-APP-F-2379"/></p><a id="I_programlisting_d1e57984"/>
        <pre class="programlisting">NEW VALUE: /etc/nagios/nagios.cfg</pre>

        <p>In Nagios 2.x, however, you need to specify the configuration file. So that the cron daemon runs the script at regular intervals, a <strong class="userinput"><code>nagios</code></strong> file is created in the directory <strong class="userinput"><code>/etc/cron.d</code></strong> containing the following line:</p><a id="I_programlisting_d1e57994"/>
        <pre class="programlisting">*/3 * * * * nagios /usr/local/nagios/libexec/passive/check_svc_latency.sh
&gt; /dev/null</pre>

        <p>All that is missing now is an appropriately defined service:</p><a id="I_programlisting_d1e57998"/>
        <pre class="programlisting"># -- service latency check
define service{
    host_name                   <span class="emphasis"><em>nagios-server</em></span>
    service_description         Service-Latenz
    active_checks_enabled       0
    passive_checks_enabled      1
    check_freshness             0
    check_command               check_dummy!3!active check, should not happen!
    max_check_attempts          3
    flap_detection_enabled      0

    use                         template-service
}</pre>

        <p><strong class="userinput"><code>host_name</code></strong> and <strong class="userinput"><code>service_description</code></strong> must match the corresponding detals in the script. Active checks are switched off, passive ones enabled. So that Nagios doesn't perform a check itself at some point, <strong class="userinput"><code>check_freshness</code></strong> must be set to <strong class="userinput"><code>0</code></strong> (see also <a class="xref" href="../Text/ch13s04.html" title="13.4 Reacting to Out-of-Date Information of Passive Checks">13.4 Reacting to Out-of-Date Information of Passive Checks</a>, page 295). The definition here uses a service template defined somewhere else (see also <a class="xref" href="../Text/ch02s11.html" title="2.11 Templates">2.11 Templates</a>, page 75).<a class="indexterm" id="IDX-APP-F-2380"/></p>

        <p>After a reload, Nagios accepts the information from the script and processes it. If you use PNP to process the performance data (<a class="xref" href="../Text/ch19s06.html" title="19.6 Smooth Plotting with PNP">19.6 Smooth Plotting with PNP</a>, page 446), you should make sure that Nagios includes the name of the check command (in this case, <strong class="userinput"><code>check_dummy</code></strong>). If you want to use a different name, you need to specify the performance label <strong class="userinput"><code>svclat</code></strong> in the script:<a class="indexterm" id="IDX-APP-F-2381"/></p><a id="I_programlisting_d1e58038"/>
        <pre class="programlisting">OUTPERF=<span class="strong"><strong>"check_svc_latency::check_svc_latency::svclat</strong></span>=$LATENCY;$WARN; $CRIT;"</pre>

        <p>PNP accepts labels in the form <strong class="userinput"><code><em class="replaceable"><code>wrapper :: check_command :: label</code></em></code></strong>, from which the tool extracts the name between the double colons (in this case, <strong class="userinput"><code>check_svc_latency</code></strong>), so that it can use it as the plugin name. This trick normally works for all passive checks.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-F-FN-1" id="ftn.APP-F-FN-1">328</a>]</sup> <a class="ulink" href="http://www.mrtg.org/">http://www.mrtg.org/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-F-FN-2" id="ftn.APP-F-FN-2">329</a>]</sup> <a class="ulink" href="http://www.mrtg.org/">http://www.mrtg.org/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-F-FN-3" id="ftn.APP-F-FN-3">330</a>]</sup> Namely, enlarging the free memory that Linux uses for file system caching, in order to improve I/O performance for the MySQL database used by the NDOUtils and the overall file system accesses.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-F-FN-4" id="ftn.APP-F-FN-4">331</a>]</sup> <a class="ulink" href="http://nagios.sourceforge.net/docs/3_0/mrtggraphs.html">http://nagios.sourceforge.net/docs/3_0/mrtggraphs.html</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="F.2 Measures for Improving Performance">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="measures_for_improving_performance"/>F.2 Measures for Improving Performance</h1>
    </div>

    <p>If performance is subjectively poor and the latency of the service check lies permanently in the red zone, then you need to act. But where do you start? Trying things out is preferable to studying the problem, and there are no patent recipes. Normally you will lose sight of the overall picture very quickly if you try making small adjustments here and there. You should therefore always change just one parameter at a time and give Nagios time to adjust to the new state of affairs. Depending on the system, the number of checks to be performed in the five-minute average, and other indicators, sometimes a few minutes is enough to notice changes using <strong class="userinput"><code>nagiostats</code></strong> or MRTG, but at other times even half an hour may not be long enough if the latency has built up over a longer period of time.<a class="indexterm" id="IDX-APP-F-2382"/><a class="indexterm" id="IDX-APP-F-2383"/></p>

    <p>The following sections deal with various problem zones in Nagios that could be the cause of poor performance.</p>

    <div class="sect2" title="F.2.1 Service checks: as often as necessary, as few as possible">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="service_checks_colon_as_often_as_n"/>F.2.1 Service checks: as often as necessary, as few as possible</h2>
      </div>

      <p>Would you use a cannon to shoot at sparrows? Surely not. Apart from the fact that you would ordinarily never shoot at sparrows, even if you had to, you would never use such an oversized weapon as a cannon. Likewise, what is the proper choice for the intervals for your service checks? Why check the usage of a hard drive every 60 seconds, unless you or a colleague will react within a few minutes to a warning threshold being overstepped? Maybe an interval of five to ten minutes will do the job just as well. And if the typical growth rate of the data stored in the file system lies at five percent per week, then a check interval of 15 minutes is certainly enough.</p>

      <p>If you install security patches only once per day and non-critical security updates just once per week, it is of little use to check the relevant version status every five minutes. And why check virus signatures every fifteen minutes if you only download them every two hours? Do you react immediately after the first alarm, or only if no update has been performed for several hours?</p>

      <p>These are not just academic questions—they are intended to make you think. There are certainly situations in which a service needs to be checked once per minute, for instance when compliance with Service Level Agreements is concerned, and the contract penalties for outages are calculated on a per-minute basis. But this is no reason to test other services every minute if a fifteen-minute check would be sufficient. The bottom line is <span class="emphasis"><em>check as often as necessary, but as little as possible</em></span>.</p>

      <p>Start with an average check interval of 5 minutes. For less critical or static services, you can extend the interval to 10, 15, 30, or 60 minutes, or perhaps even more. Only if it is absolutely essential should you lower the interval below the 5-minute limit—and do it selectively for individual checks. 2,000 service checks, performed on average every two minutes, generate about the same load as 5,000 service checks with an average interval of 5 minutes. This small difference of 3 minutes can be a real problem for Nagios.</p>
    </div>

    <div class="sect2" title="F.2.2 Processing performance data intelligently">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="processing_performance_data_intell"/>F.2.2 Processing performance data intelligently</h2>
      </div>

      <p>Processing performance data can, under unfavorable conditions, be a real performance killer.<a class="indexterm" id="IDX-APP-F-2384"/><a class="indexterm" id="IDX-APP-F-2385"/></p>

      <p>For the template mechanism, in which Nagios first has to format performance data and then write them to a file, and have these files processed at regular intervals by an external command (<a class="xref" href="../Text/ch19.html#the_template_mechanism" title="19.1.1 The template mechanism">19.1.1 The template mechanism</a>, page 405), the internal Nagios logic stops when the command is called. Nagios expects a confirmation when the program called has finished its work. If the external program requires some time to do its task, it is easy to work out that calling an external command directly for each individual check result (<a class="xref" href="../Text/ch19.html#using_external_commands_to_process_perf" title="19.1.2 Using external commands to process performance data">19.1.2 Using external commands to process performance data</a>, page 407) can put a considerable strain on Nagios. The template mechanism can provide relief here. If 400 check results are waiting each minute (2,000 checks in the 5-minute average) and Nagios calls the external command for the template mechanism every 30 seconds, this will process some 200 results in one go. Although this will take somewhat longer than an external program that processes just one single result, 199 program starts are no longer needed.</p>

      <p>With a large number of check results, this may still not be enough, because Nagios also waits here every 30 seconds for the external program and waits until it has terminated.</p>

      <p>To keep this pause as brief as possible, you can make use of the bulk mode in PNP (<a class="xref" href="../Text/ch19s06.html" title="19.6 Smooth Plotting with PNP">19.6 Smooth Plotting with PNP</a>, page 446): then Nagios just moves the file with the cached results to a special directory every 30 seconds. This happens without any time loss. Full responsibility for processing the external data is given to a daemon that Nagios does not have to control. Details of this are described in <a class="xref" href="../Text/ch19s06.html#bulk_processing_of_performance_data" title="19.6.4 Bulk processing of performance data">19.6.4 Bulk processing of performance data</a> from page 452.</p>

      <p>Another aspect of intelligent processing is to record performance data only where they are evaluated and required. An example of the opposite would be to send performance data for all checks to a tool such as NagiosGrapher (<a class="xref" href="../Text/ch19s05.html" title="19.5 Automated to a Large Extent: NagiosGrapher">19.5 Automated to a Large Extent: NagiosGrapher</a>, page 426) and then discard the data not required on the side of the collector daemon <strong class="userinput"><code>collect2.pl</code></strong>. Processing performance data for required services is switched on with <strong class="userinput"><code>process_perf_data=1</code></strong> in the service definition.</p>
    </div>

    <div class="sect2" title="F.2.3 Avoiding plugins in interpreted languages">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="avoiding_plugins_in_interpreted_la"/>F.2.3 Avoiding plugins in interpreted languages</h2>
      </div>

      <p>The standard plugins for Nagios were written predominantly in C and C++, and there are good reasons for this. Admittedly, it is usually easier to write a plugin in a script language; however, a plugin in an interpreted language is checked for correct syntax each time it is run, then interpreted at runtime, and finally executed.<a class="indexterm" id="IDX-APP-F-2386"/></p>

      <p>Not only that, every time such a plugin is called, the relevant interpreter is started. With a compiled plugin, one does not have to put up with all of this. Syntax checking and the compiling process only take place once, and the result can be executed directly, without the additional support of another program, such as an interpreter, which is not exactly small. Considering the many hundreds of thousands of calls that are made during the lifetime of an interpreted plugin, you are looking at resource commitments that could really be used for more sensible purposes.</p>

      <p>This is not to fundamentally question the use of interpreted languages in general. For certain purposes, it is simply easier to implement a plugin into a script language. But you should not be surprised at the resources that will be needed if you perform 5,000 service checks in the 5-minute average exclusively with interpreted plugins. Then simple PC hardware will certainly not suffice for the Nagios server.</p>

      <p>There is an almost perfect solution if you want to use Perl plugins: Nagios's built-in Perl interpreter (see <a class="xref" href="../Text/apg.html" title="Appendix G. The Embedded Perl Interpreter">Appendix G</a> from page 669). Although not all Perl plugins will run under this, the majority do, which considerably reduces strain on the Nagios server.</p>
    </div>

    <div class="sect2" title="F.2.4 Optimizing host checks">
      <div class="titlepage">
        <h2 class="title" id="heading_id_6"><a id="optimizing_host_checks"/>F.2.4 Optimizing host checks</h2>
      </div>

      <p>One performance factor that should not be underestimated is the way in which Nagios executes a host check. Sometimes considerable time can be lost here, regardless of the Nagios version.<a class="indexterm" id="IDX-APP-F-2387"/><a class="indexterm" id="IDX-APP-F-2388"/></p>

      <p>For host checks, a <strong class="userinput"><code>check_ping</code></strong> or <strong class="userinput"><code>check_icmp</code></strong> is normally used (see <a class="xref" href="../Text/ch06s02.html" title="6.2 Reachability Test with Ping">6.2 Reachability Test with Ping</a>). Older <strong class="userinput"><code>check_ping</code></strong> versions wait for an ICMP echo reply or wait for the timeout. It does not evaluate "<strong class="userinput"><code>ICMP Host Unreachable</code></strong>" messages, so that time is lost unnecessarily. <strong class="userinput"><code>check_icmp</code></strong> uses a special host detection mode if it is run under the name <strong class="userinput"><code>check_host</code></strong> (see <a class="xref" href="../Text/ch06s02.html" title="6.2 Reachability Test with Ping">6.2 Reachability Test with Ping</a>). This causes the check to be interrupted immediately if an <strong class="userinput"><code>ICMP Host Unreachable</code></strong> message arrives.<a class="indexterm" id="IDX-APP-F-2389"/></p>

      <p>Newer versions of <strong class="userinput"><code>check_icmp</code></strong> and <strong class="userinput"><code>check_ping</code></strong> take the ICMP error message into account, even without a special prompt. Version 1.4.11 of the Nagios plugins does have a faulty <strong class="userinput"><code>check_icmp</code></strong>, however. If you run it as <strong class="userinput"><code>check_host</code></strong>, it will not detect the ICMP error message immediately and requires more time than necessary. Nagios 2.x calls all host checks in series, or one after the other. If a central network node should fail, it checks several hundred hosts in many setups. If the host check for unreachable hosts is only interrupted after ten seconds, it will take a huge amount of time until Nagios has checked all hosts. The length of a host check in case of error is of considerable significance here. You could, if need be, use a shorter timeout, but then you run the risk of false alarms, if a network connection with narrow bandwidth is overloaded at that moment, for instance, and the response times are longer than the reduced timeout. The evaluation of ICMP error messages is much safer here. The catastrophic performance, with hundreds of failed hosts due to the serial checks, will still remain, however—an important reason to change to Nagios 3.0 in large environments.</p>

      <p>Whereas it is usually better in Nagios 2.x to do without active host checks, in Nagios 3.0 these may help in certain circumstances to improve performance, if you can have the check results cached with the parameters <strong class="userinput"><code>cached_host_check_horizon</code></strong> and <strong class="userinput"><code>cached_service_check_horizon</code></strong> (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>) for the interval specified. If an on-demand check occurs, this will not even be run if the existing result is sufficiently up to date.<a class="indexterm" id="IDX-APP-F-2390"/><a class="indexterm" id="IDX-APP-F-2391"/></p>

      <p>Whether active host checks really do improve performance must be tested in individual cases by means of <strong class="userinput"><code>nagiostats</code></strong>. If the number of cached host checks is relatively small in comparison to the number of on-demand checks, caching will not be of much use. You could increase the <strong class="userinput"><code>cached_host_check_horizon</code></strong>—the interval for caching—but then you run the risk of using old results that are no longer relevant. It is best to try out different time horizons and observe the latency. As a comparison, you should try turning off caching altogether, with <strong class="userinput"><code>cached_host_check_horizon=0</code></strong>.</p>

      <p>In connection with host checks, Nagios 3.0 also has the parameter <strong class="userinput"><code>aggressive_host_checks</code></strong>. If this is set to the value <strong class="userinput"><code>1</code></strong> (and therefore active), Nagios will be very exact in its checking, but it needs time to do this. In normal operation you should therefore always make sure that the system makes more sensible assumptions for host checks with <strong class="userinput"><code>aggressive_host_ checks=0</code></strong> and so does not test hosts with scrupulous precision.<a class="indexterm" id="IDX-APP-F-2392"/></p>
    </div>

    <div class="sect2" title="F.2.5 The matter of the Reaper">
      <div class="titlepage">
        <h2 class="title" id="heading_id_7"><a id="the_matter_of_the_reaper"/>F.2.5 The matter of the Reaper</h2>
      </div>

      <p>Nagios 3.0 stores the check results in a directory intended for just this purpose, specified by the parameter <strong class="userinput"><code>check_result_path</code></strong> (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). The <span class="emphasis"><em>Reaper</em></span> (this is the "harvesting machine" of the Nagios core) retrieves these regularly.<a class="indexterm" id="IDX-APP-F-2394"/><a class="indexterm" id="IDX-APP-F-2395"/><a class="indexterm" id="IDX-APP-F-2396"/><a class="indexterm" id="IDX-APP-F-2397"/><a class="indexterm" id="IDX-APP-F-2398"/><a class="indexterm" id="IDX-APP-F-2393"/></p>

      <p>Two parameters control the procedure: <strong class="userinput"><code>check_result_reaper_frequen-cy</code></strong><sup>[<a class="footnote" href="#ftn.APP-F-FN-5" id="APP-F-FN-5">332</a>]</sup> specifies the interval, in seconds, at which the Reaper searches the directory for new results (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). If the interval is increased, it is possible that latency times may also increase. You should only change the default of <strong class="userinput"><code>5</code></strong> seconds to a lower value, and only do this if a large number of checks are waiting and Nagios never really empties the directory for the check results.<a class="indexterm" id="IDX-APP-F-2399"/></p>

      <p>The second parameter, <strong class="userinput"><code>max_check_result_reaper_time</code></strong>, interrupts activities after the time specified, so that Nagios is not held up for ages by the Reaper. The default here is <strong class="userinput"><code>30</code></strong> seconds (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>).<a class="indexterm" id="IDX-APP-F-2400"/></p>

      <p>In Nagios 2.x only the parameter <strong class="userinput"><code>service_reaper_frequency</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>) is available, and moreover Nagios does not store check results in file form, but in a message queue.</p>

      <p>At this point we ought to mention that the Reaper has only a limited influence on performance. Provided that you keep the defaults of the two parameters unchanged, changing the parameter <strong class="userinput"><code>check_result_reaper_frequency</code></strong> will not solve any problems that have arisen elsewhere. Nevertheless, if you are running out of ideas as to what else you can try, it is certainly worthwhile to change this setting. In any case, you should monitor the check latency times graphically. If there are no changes, you should go back to the defaults.<a class="indexterm" id="IDX-APP-F-2401"/></p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-F-FN-5" id="ftn.APP-F-FN-5">332</a>]</sup> In Nagios 2.x the parameter is called service_reaper_frequency, see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="F.2.6 Preferring passive checks">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="preferring_passive_checks"/>F.2.6 Preferring passive checks</h1>
    </div>

    <p>Instead of getting Nagios to actively start each check individually, you can also use external applications and forward check results as passive checks to Nagios. The external application—even if this is just a cron job—relieves strain on Nagios in several areas, including scheduling. Nagios needs only to accept the result and sort it accordingly.<a class="indexterm" id="IDX-APP-F-2402"/><a class="indexterm" id="IDX-APP-F-2403"/></p>

    <p>In a number of cases you can even go a step further and do without a regular check, for instance if a UPS sends an SNMP trap when there is a power failure, which Nagios processes as a passive check (see <a class="xref" href="../Text/ch14s06.html" title="14.6 Application Example II: Processing SNMP Traps">14.6 Application Example II: Processing SNMP Traps</a>, page 312).</p>

    <p>Passive check results are cached by Nagios. By default there are 4096 so-called <span class="emphasis"><em>Command Buffer Slots</em></span> available for this. Each buffer slot accepts just one external command. If this maximum has almost been reached, you should certainly enlarge the value with the parameter <strong class="userinput"><code>external_command_buffer_slots</code></strong> (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>), whether or not you have concrete performance problems. One report on the buffer slots used is provided by <strong class="userinput"><code>nagio-stats</code></strong>; its values are best displayed by MRTG on the time axis (see <a class="xref" href="../Text/apf.html#showing_nagios_performance_graphic" title="F.1.2 Showing Nagios performance graphically">F.1.2 Showing Nagios performance graphically</a>). Too few buffer slots will certainly lead to a loss in performance.<a class="indexterm" id="IDX-APP-F-2404"/></p>

    <div class="sect2" title="F.2.7 Optimizing large Nagios environments">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="optimizing_large_nagios_environmen"/>F.2.7 Optimizing large Nagios environments</h2>
      </div>

      <p>For very large environments, Nagios has available the parameter <strong class="userinput"><code>use_large_installation_tweaks</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). If this is set to <strong class="userinput"><code>1</code></strong>, Nagios optimizes a number of processes that can be very time-intensive, especially in large environments. Thus the system does without explicit memory release for child processes. leaving this task entirely to the operating system.<a class="indexterm" id="IDX-APP-F-2405"/><a class="indexterm" id="IDX-APP-F-2406"/><a class="indexterm" id="IDX-APP-F-2407"/><a class="indexterm" id="IDX-APP-F-2408"/><a class="indexterm" id="IDX-APP-F-2409"/></p>

      <p>Normally Nagios starts checks via a two-pronged fork so that it can defend itself against crashes and other abnormalities when the plugin is run. Checks are then performed not as child processes, but as grandchild processes. The two-pronged fork leaves cleaning up after grandchild processes to the operating system. If, instead of this, Nagios is happy with a simple fork (with <strong class="userinput"><code>use_large_installation_tweaks=1</code></strong>), it will have to look after all the cleaning up work for all check processes, because these are now running directly as child processes. But in return the system load is reduced, because only half as many processes need to be started. This generally improves performance.</p>

      <p>As a third measure, Nagios switches off the envivronment variables for <span class="emphasis"><em>summary macros</em></span> (<a class="xref" href="../Text/apd.html#statistics_macros" title="D.1.7 Statistics macros">D.1.7 Statistics macros</a>, page 631). It takes up a great deal of time to make these available.<a class="indexterm" id="IDX-APP-F-2410"/></p>

      <p>The parameter <strong class="userinput"><code>enable_environment_macros</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>) goes even further—with the value <strong class="userinput"><code>0</code></strong>, Nagios in general no longer makes available the content of macros as environment variables (see <a class="xref" href="../Text/apd.html#using_standard_macros_about_the_environm" title="D.1.8 Using standard macros about the environment">D.1.8 Using standard macros about the environment</a> from page 631).<a class="indexterm" id="IDX-APP-F-2411"/></p>

      <p>The macros can be used as normal within the Nagios configuration, but now external scripts can no longer access them implicitly. Switching this off saves considerable resources, especially in large environments, and in many cases the environment variables are not needed at all.</p>
    </div>

    <div class="sect2" title="F.2.8 Optimizing the NDOUtils database">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="optimizing_the_ndoutils_database"/>F.2.8 Optimizing the NDOUtils database</h2>
      </div>

      <p>The NDOUtils take advantage of the possibility of writing all information which is at the disposal of Nagios to an external database, via the event broker (<a class="xref" href="../Text/ch17.html" title="Chapter 17. Flexible Web Interface with the NDOUtils">Chapter 17</a> from page 375). The parameter <strong class="userinput"><code>event_broker_options</code></strong> controls which data Nagios passes on here. The default is <strong class="userinput"><code>−1</code></strong>, which means that any information available is passed on.<a class="indexterm" id="IDX-APP-F-2412"/><a class="indexterm" id="IDX-APP-F-2413"/></p>

      <p>From a performance point of view, this is quite a bad choice. If you just require selected data—such as the results of host and service checks—you should pass on only this information. Everything else consumes unnecessary resources and influences performance without providing any benefits in return. Further information, including possible values for the parameter event_broker_options, is given in <a class="xref" href="../Text/ch17.html#the_event_broker" title="17.1 The Event Broker">17.1 The Event Broker</a> from page 376.</p>
    </div>
  </div>


  <div class="appendix" title="Appendix&#xA0;G.&#xA0;The Embedded Perl Interpreter">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_embedded_perl_interpreter"/>Appendix G. The Embedded Perl Interpreter</h1>
    </div>

    <p>Perl is an interpreted scripting language. When a Perl script is started, it is read by the Perl interpreter, checked for errors, transformed into executable code only at runtime, and finally executed. Programs in languages such as C or C++ are checked for errors, compiled only once, and saved as binary code that can be run directly. Here the checking and compilation process takes place just once—before the program is run for the first time—whereas a Perl script is checked and compiled each time it is run. This takes place at an astounding speed, but it still takes time.<a class="indexterm" id="IDX-APP-G-2414"/></p>

    <p>But things get worse—for each script, no matter how small it is, the heavyweight Perl interpreter is loaded every time. It's as if, in order to add two numbers together, you needed to switch on your PC, wait until you can log in, then run a spreadsheet program in which you can finally enter the two numbers.</p>

    <p>What if you want to continue using the spreadsheet? Well, then the computer must be turned on and the spreadsheet program must be installed and running so you can enter your numbers. Transferring the analogy to Nagios scripts, this means that an instance of the Perl interpreter must already be running on the Nagios server—and preferably this instance should be used for all plugins, so that each plugin can be executed immediately when it is called. This is precisely what the Embedded Perl interpreter, which is embedded into Nagios, does. The technique is not new; the Apache module <strong class="userinput"><code>mod_perl</code></strong> works in the same way.</p>

    <p>However, the Embedded Perl interpreter does have one slight drawback: It makes more demands of a Perl script than the normal Perl interpreter does. Not every plugin that runs on the command line without problems will work under the embedded interpreter. It is often a matter of small details. Debugging is very difficult with this interpreter, and even with simple errors, it is not easy to localize them and adjust the plugin accordingly. But you should not be put off by this, because in Nagios 3.x the interpreter can be selectively switched off, and in Nagios 2.x a trick can be used to bypass it.</p>

    <p>A quick note on terminology: In the official Nagios documentation, ePN stands for <span class="emphasis"><em>Embedded Perl Nagios</em></span>, that is, Nagios with a Perl interpreter compiled into it. In general usage, the term means the integrated Perl interpreter itself. This is how we use the term in this book as well. Either way, Nagios is needed in order to use it.</p>

    <div class="sect1" title="G.1 Requirements of an ePN-capable Plugin">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="requirements_of_an_epn-capable_plugi"/>G.1 Requirements of an ePN-capable Plugin</h1>
      </div>

      <p>Many primitive errors can be avoided from the beginning if you use the pragmas <strong class="userinput"><code>use strict</code></strong> and <strong class="userinput"><code>use warnings</code></strong>:<a class="indexterm" id="IDX-APP-G-2415"/><a class="indexterm" id="IDX-APP-G-2416"/><a class="indexterm" id="IDX-APP-G-2417"/><a class="indexterm" id="IDX-APP-G-2418"/><a class="indexterm" id="IDX-APP-G-2419"/><a class="indexterm" id="IDX-APP-G-2420"/></p><a id="I_programlisting_d1e58515"/>
      <pre class="programlisting">#!/usr/bin/perl
use strict;
use warnings;
...</pre>

      <p><strong class="userinput"><code>use strict</code></strong> treats the code very precisely and forces the predefinition of all variables (e. g., <strong class="userinput"><code>my $var;</code></strong>). <strong class="userinput"><code>use warnings</code></strong> displays extended error information, which greatly simplifies the search for the line or statement causing the error. For Perl versions prior to 5.6, <strong class="userinput"><code>use warnings</code></strong> does not exist, and you must use the <strong class="userinput"><code>-w</code></strong> switch, for example in the first line of the script:</p><a id="I_programlisting_d1e58533"/>
      <pre class="programlisting">#!/usr/bin/perl -w
...</pre>

      <p>Detailed information on pragmas can be found in <strong class="userinput"><code>man 3perl strict</code></strong> and <strong class="userinput"><code>man 3perl warnings</code></strong>, as well as the corresponding Perldoc pages on the Internet.<sup>[<a class="footnote" href="#ftn.APP-G-FN-1" id="APP-G-FN-1">333</a>]</sup></p>

      <p>To obtain a better understanding of the following notes, you must be aware of two things. On one hand, the plugin is loaded just once into the interpreter, so initialization sequences are performed explicitly only the very fist time it is run. On the other hand, the interpreter embeds the Perl code into other Perl code. Thus the end of the plugin code itself is not the end of the complete Perl code executed for this plugin. Actions that refer implicitly to the end of the respective script therefore sometimes generate undesired side effects, and you should take notice of the following tips:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term">If possible, make do without <strong class="userinput"><code>BEGIN!</code></strong></span></dt>

          <dd>
            <p>In a <strong class="userinput"><code>BEGIN</code></strong> statement you normally include statements that initialize values or should, for one reason or another, be executed before the rest of the code. ePN runs this section only the very first time the plugin is executed. Statements that must be executed every time a plugin is called will come to nothing. It is therefore better to leave out the <strong class="userinput"><code>BEGIN</code></strong> section altogether.</p>
          </dd>

          <dt><span class="term">Define an explicit exit code!</span></dt>

          <dd>
            <p>A normal Perl script always ends (provided you do not explicitly specify an exit code) with the exit code <strong class="userinput"><code>0</code></strong>. This does not work with the ePN, since other code is run after the script code. Although such plugins return an OK when run on the command line (without ePN), they return UNKNOWN under ePN.</p>
          </dd>

          <dt><span class="term">Make do without <strong class="userinput"><code>__DATA__</code></strong> or <strong class="userinput"><code>__END__</code></strong> sections!</span></dt>

          <dd>
            <p>Both instructions explicitly terminate the execution of the Perl code. In ePN this is not the case, however. For this reason you must leave out such instructions. For example, instead of the <strong class="userinput"><code>__DATA__</code></strong>, section you could use a Here instruction:</p><a id="I_programlisting_d1e58589"/>
            <pre class="programlisting">my $data = &lt;&lt;DATA;
a 1  30
b 2  40
c 7  80
...
DATA</pre>
          </dd>

          <dt><span class="term">Do not misuse lexical variables as global variables!</span></dt>

          <dd>
            <p>Lexical variables such as <strong class="userinput"><code>my $value</code></strong> define values required locally. You should therefore not access these directly from subroutines. Store the corresponding values as global values instead:</p><a id="I_programlisting_d1e58600"/>
            <pre class="programlisting">use vars qw($value);</pre>

            <p>It is better still to pass on the variable as a reference:</p><a id="I_programlisting_d1e58604"/>
            <pre class="programlisting">$result = &amp;mysub( \$value );</pre>
          </dd>

          <dt><span class="term">Terminate all actions and functions!</span></dt>

          <dd>
            <p>The Embedded Perl Interpreter also stumbles over small details. To cite an example, consider POD documentation integrated into the script (see <a class="xref" href="../Text/ch25s02.html" title="25.2 The Perl Online Documentation">25.2 The Perl Online Documentation</a>, page 566): Normally the documentation section is completed with <strong class="userinput"><code>=cut</code></strong>. At the end of the Perl script, Perl ensures an implicit end, so that a documentation section not finished with <strong class="userinput"><code>=cut</code></strong> at the end of the script will not cause a problem on the command line. But ePN appends Perl code to this, so that omitting <strong class="userinput"><code>=cut</code></strong> always leads to an error.</p>

            <p>This error pattern also recurs in other contexts, so that you should make a habit of always explicitly cleaning up. If the plugin opens a file, it must also explicitly close it.</p>
          </dd>
        </dl>
      </div>

      <p>More information is provided by the Nagios online documentation<sup>[<a class="footnote" href="#ftn.APP-G-FN-2" id="APP-G-FN-2">334</a>]</sup> and the mod_perl Users Guide.<sup>[<a class="footnote" href="#ftn.APP-G-FN-3" id="APP-G-FN-3">335</a>]</sup> For errors that occur exclusively with the ePN, the included mini-version is of help, and is described in <a class="xref" href="../Text/apgs03.html" title="G.3 The Testing Tool new_mini_epn">G.3 The Testing Tool new_mini_epn</a> in page 674.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-G-FN-1" id="ftn.APP-G-FN-1">333</a>]</sup> <a class="ulink" href="http://perldoc.perl.org/strict.html">http://perldoc.perl.org/strict.html</a> and <a class="ulink" href="http://perldoc.perl.org/warnings.html">http://perldoc.perl.org/warnings.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-G-FN-2" id="ftn.APP-G-FN-2">334</a>]</sup> <a class="ulink" href="http://nagios.sourceforge.net/docs/3_0/epnplugins.html">http://nagios.sourceforge.net/docs/3_0/epnplugins.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-G-FN-3" id="ftn.APP-G-FN-3">335</a>]</sup> <a class="ulink" href="http://perl.apache.org/docs/1.0/guide/">http://perl.apache.org/docs/1.0/guide/</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="G.2 Using ePN">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="using_epn"/>G.2 Using ePN</h1>
    </div>

    <p>In order to use the Embedded Perl interpreter, this feature must be compiled into Nagios. This suffices for Nagios 2.x, but for Nagios 3.0 you must also set parameters in the main configuration file <strong class="userinput"><code>nagios.cfg</code></strong>. In addition, Nagios 3.0 allows each individual Perl plugin to activate or to switch off the Embedded Perl interpreter.<a class="indexterm" id="IDX-APP-G-2421"/></p>

    <div class="sect2" title="G.2.1 Compiling ePN">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="compiling_epn"/>G.2.1 Compiling ePN</h2>
      </div>

      <p>The interpreter is integrated during the <strong class="userinput"><code>configure</code></strong> call, with the switch <strong class="userinput"><code>--enable-embedded-perl</code></strong>. In Nagios 2.x you should also use the option <strong class="userinput"><code>--with-perlcache</code></strong>, which ensures that the interpreter caches scripts that have already been loaded, thus speeding them up if they are run again. Nagios 3.0 sets this implicitly if <strong class="userinput"><code>--enable-embedded-perl</code></strong> is specified.</p>

      <p>Caching in Nagios 2.x has one drawback: In some circumstances Nagios will not recognize changes made later on to a Perl script. The only remedy here is a reload or a restart of Nagios. On a development system, which is only used to develop or test plugins, it certainly makes sense to do without caching. On production Nagios systems, however, the benefits of caching cannot be overlooked. In Nagios 3.0, the Perl interpreter takes account of changes to the script and reloads these if required.</p>
    </div>

    <div class="sect2" title="G.2.2 Interpreter-specific parameters in nagios.cfg">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="interpreter-specific_parameters_in"/>G.2.2 Interpreter-specific parameters in nagios.cfg</h2>
      </div>

      <p>Starting from Nagios 3.0, parameters in the main configuration file <strong class="userinput"><code>nagios.cfg</code></strong> determine whether the Embedded Perl interpreter is used or not:<a class="indexterm" id="IDX-APP-G-2422"/><a class="indexterm" id="IDX-APP-G-2423"/></p><a id="I_programlisting_d1e58687"/>
      <pre class="programlisting"># /etc/nagios.cfg
...
enable_embedded_perl=1
use_embedded_perl_implicitly=1
...</pre>

      <p><strong class="userinput"><code>enable_embedded_perl=1</code></strong> enables the general use of the interpreter, and the value <strong class="userinput"><code>0</code></strong> switches it off. The second parameter is used for fine-tuning. <strong class="userinput"><code>use_embedded_perl_implicitly=1</code></strong> automatically switches on the interpreter for each plugin, provided the plugin itself does not contain any further instructions (see next section). The value <strong class="userinput"><code>0</code></strong> switches ePN off for the time being, and then each plugin must decide for itself whether to use it or not.<a class="indexterm" id="IDX-APP-G-2424"/><a class="indexterm" id="IDX-APP-G-2425"/></p>
    </div>

    <div class="sect2" title="G.2.3 Disabling ePN on a per-plugin basis">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="disabling_epn_on_a_per-plugin_basi"/>G.2.3 Disabling ePN on a per-plugin basis</h2>
      </div>

      <p>In Nagios 3.0, the parameter <strong class="userinput"><code>use_embedded_perl_implicitly</code></strong> is supplemented with an instruction that can be set within every plugin:</p><a id="I_programlisting_d1e58716"/>
      <pre class="programlisting">#!/usr/bin/perl -w
# nagios: -epn
...</pre>

      <p>The text <strong class="userinput"><code># nagios: +epn</code></strong> or <strong class="userinput"><code>-epn</code></strong> must appear within the first ten lines. With <strong class="userinput"><code>+epn</code></strong> the plugin is executed in the ePN environment, and with <strong class="userinput"><code>-epn</code></strong> it is not. This explicit detail in the plugin has the highest priority Only if the instruction is missing does Nagios 3.0 use the parameter <strong class="userinput"><code>use_embedded_ perl_implicitly</code></strong>.</p>

      <p>In many cases, existing Perl plugins will work in ePN. We therefore recommend that you use the setting <strong class="userinput"><code>use_embedded_perl_implicitly=1</code></strong>. For plugins that cause problems, you can explicitly switch off the use of the interpreter with <strong class="userinput"><code>-epn</code></strong>.</p>

      <p>In Nagios 2.x there is no option to switch the Embedded Interpreter on or off at runtime or in the plugin. Once it has been compiled into Nagios, it is always active. But there is a workaround that you can use when defining a command, by prefixing <strong class="userinput"><code>/usr/bin/perl</code></strong> to the actual command line:</p><a id="I_programlisting_d1e58748"/>
      <pre class="programlisting">define command{
   command_name    check_disk
   command_line <span class="strong"><strong>   /usr/bin/perl</strong></span> $USER1$/check_disk.pl $ARG1$
}</pre>

      <p>Thus, for the plugin <strong class="userinput"><code>check_disk.pl</code></strong>, the normal Perl interpreter is started each time the plugin is run, and ePN is sidestepped.</p>
    </div>
  </div>


  <div class="sect1" title="G.3 The Testing Tool new_mini_epn">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_testing_tool_new_mini"/>G.3 The Testing Tool <strong class="userinput"><code>new_mini_epn</code></strong></h1>
    </div>

    <p>In its source code, Nagios includes two utilities that simulate an ePN environment, which considerably simplifies searching for errors: <strong class="userinput"><code>mini_epn</code></strong> and the more recent <strong class="userinput"><code>new_mini_epn</code></strong>. They are not absolutely identical in behavior to ePN, but this involves only a small number of exotic scenarios. In general the following applies: If a Nagios plugin does not run in the mini-interpreter, it won't run in the ePN either.<a class="indexterm" id="IDX-APP-G-2427"/><a class="indexterm" id="IDX-APP-G-2428"/><a class="indexterm" id="IDX-APP-G-2429"/><a class="indexterm" id="IDX-APP-G-2430"/><a class="indexterm" id="IDX-APP-G-2426"/></p>

    <p>The two programs are located in the subdirectory <strong class="userinput"><code>./contrib</code></strong> of the source code and are not installed automatically. If you want to use them, run</p><a id="I_programlisting_d1e58793"/>
    <pre class="programlisting">linux:nagios/contrib <span class="strong"><strong># make mini_epn</strong></span>
...
linux:nagios/contrib <span class="strong"><strong># make new_mini_epn</strong></span>
...</pre>

    <p>but <span class="emphasis"><em>under no circumstances</em></span> should you run <strong class="userinput"><code>make install!</code></strong> The Makefile in this directory does not take into account the defaults for paths and may change the access permissions for directories such as <strong class="userinput"><code>/bin</code></strong> and <strong class="userinput"><code>/var</code></strong>. The programs must be executed in the directory in which the file <strong class="userinput"><code>p1.pl</code></strong> is located. During the basic installation of Nagios, this is copied to <strong class="userinput"><code>/usr/local/nagios/bin</code></strong>, and so these two programs are also copied there:</p><a id="I_programlisting_d1e58822"/>
    <pre class="programlisting">linux:nagios/contrib <span class="strong"><strong># cp mini_epn new_mini_epn /usr/local/nagios/bin/</strong></span>.</pre>

    <p>In the <strong class="userinput"><code>./contrib</code></strong> directory itself there is an obsolete <strong class="userinput"><code>p1.pl</code></strong>, which should not be used. The up-to-date <strong class="userinput"><code>p1.pl</code></strong> installed by Nagios is located in the main directory of the source code.</p>

    <p>In order to run the mini-interpreter, you change, as the user <strong class="userinput"><code>nagios</code></strong>, to the directory <strong class="userinput"><code>/usr/local/nagios/bin</code></strong> and run the program without parameters:</p><a id="I_programlisting_d1e58846"/>
    <pre class="programlisting">user@linux:nagios$ <span class="strong"><strong>~cd /usr/local/nagios/bin</strong></span>
user@linux:nagios$ nagios/bin<span class="strong"><strong>./new_mini_epn</strong></span>
plugin command line:</pre>

    <p>You are taken to a simple comand line from which you can run plugins. You should always include the full path to the plugin:</p><a id="I_programlisting_d1e58856"/>
    <pre class="programlisting">plugin command line: <span class="strong"><strong>/usr/local/nagios/libexec/check_file_age -f /etc/hosts</strong></span>
embedded perl plugin return code and output was: 2 &amp; FILE_AGE CRITICAL:
/etc/hosts is 3718127 seconds old and 2671 bytes</pre>

    <p>The mini-interpreter displays the return code, along with the actual output of the plugin after the <strong class="userinput"><code>&amp;</code></strong> character.</p>

    <p>If one mini-interpreter does not find an error, you should try the other one out, as it is possible that it may react differently in this special case. In addition, you should always run the interpreter with the permissions of the user under which Nagios is running (in this book, this is <strong class="userinput"><code>nagios</code></strong>), to rule out problems with access permissions from the start.</p>

    <p>The mini-interpreter caches the executed plugin just like its big brother does and is not aware at runtime of any changes made to the plugin. If you have made changes to the plugin, you should restart the mini-interpreter, otherwise you may be searching in vain for an error at the wrong spot.</p>
  </div>


  <div class="appendix" title="Appendix&#xA0;H.&#xA0;What's New in Nagios 3.0?">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="what_apostrophy_s_new_in_nagios_3.0"/>Appendix H. What's New in Nagios 3.0?</h1>
    </div>

    <p>Nagios 3.0 presents a series of improvements and innovations compared to the 2.x versions.<sup>[<a class="footnote" href="#ftn.APP-H-FN-1" id="APP-H-FN-1">336</a>]</sup>. Much of this is not noticeable from the outside, and the configuration is also nearly identical; normally Nagios 3.0 will also start with a functioning Nagios-2.x configuration. None of the new configuration parameters are absolutely essential.</p>

    <p>Some parameters were renamed, and Nagios 3.0 complains on startup that a parameter contained in the configuration has been removed, then sets the new variable to a sensible value. The objects <strong class="userinput"><code>hostextinfo</code></strong> and <strong class="userinput"><code>service-extinfo</code></strong> are considered to be obsolete, but can still be used, at least in version 3.0.</p>

    <p>Apart from the configuration, the internal logic has been improved in many places. For instance the changed way of running host checks has led to significantly higher performance, especially for very large installations.</p>

    <div class="sect1" title="H.1 Changes in Object Definitions">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="changes_in_object_definitions"/>H.1 Changes in Object Definitions</h1>
      </div>

      <p>Nagios 3.0 now allows floating point decimals when specifying check and notification intervals. The new parameter <strong class="userinput"><code>check_interval =2.5</code></strong>, which replaces the <strong class="userinput"><code>normal_check_interval</code></strong>, determines that Nagios will perform a check every two-and-a-half time units. The time unit itself is defined by <strong class="userinput"><code>interval_length</code></strong> in the main configuration file <strong class="userinput"><code>nagios.cfg</code></strong> (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). With the default of 60 seconds, a <strong class="userinput"><code>check_interval</code></strong> of <strong class="userinput"><code>2.5</code></strong> corresponds to 150 seconds.<a class="indexterm" id="IDX-APP-H-2431"/><a class="indexterm" id="IDX-APP-H-2432"/><a class="indexterm" id="IDX-APP-H-2433"/><a class="indexterm" id="IDX-APP-H-2434"/></p>

      <div class="sect2" title="H.1.1 The host object">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="the_host_object"/>H.1.1 The <strong class="userinput"><code>host</code></strong> object</h2>
        </div>

        <p>Aliases are no longer absolutely essential in Nagios 3.0. If this detail is missing in the host definition, the host name is used automatically. <strong class="userinput"><code>host</code></strong> objects can make use of the following options from version 3.0:</p><a id="I_programlisting_d1e58946"/>
        <pre class="programlisting">define host {

   ...
   display_name              <span class="emphasis"><em>display_name</em></span>
   contacts                  <span class="emphasis"><em>contacts</em></span>
   first_notification_delay  <span class="emphasis"><em>number</em></span>
   flap_detection_options    o,d,u
   notification_options      d,u,r,f,s
   initial_state             o,d,u
   retry_interval            <span class="emphasis"><em>number</em></span>

   ...
}</pre>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>display_name</code></strong></span></dt>

            <dd>
              <p>Defines an alternative name that should appear later in the Web interface and other future user interfaces. The CGI programs of Nagios 3.0 do not yet use this parameter. The default is <strong class="userinput"><code>host_name</code></strong>.<a class="indexterm" id="IDX-APP-H-2435"/><a class="indexterm" id="IDX-APP-H-2436"/><a class="indexterm" id="IDX-APP-H-2437"/></p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>contacts</code></strong></span></dt>

            <dd>
              <p>Nagios 3.0 now allows individual contacts to be specified directly in the host definition. Until now you could only enter contact groups here, so you always had to first define a specific contact group for each individual contact. You can still use contact groups and specify them together with individual contacts.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>first_notification_delay</code></strong></span></dt>

            <dd>
              <p>Delay the sending of the first notification (in Nagios time units, defined by the new parameter <strong class="userinput"><code>interval_length</code></strong>; see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). Normally Nagios sends a notification immediately after a error turns into a hard state. In order for the first notification to be sent only after a certain time has elapsed, you previously had to use the escalation mechanism (see <a class="xref" href="../Text/ch12s05.html" title="12.5 Escalation Management">12.5 Escalation Management</a>, page 282). With the parameter <strong class="userinput"><code>first_notification_delay</code></strong> this can now be done more easily.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>flap_detection_options</code></strong></span></dt>

            <dd>
              <p>With <strong class="userinput"><code>flap_detection_options</code></strong>, certain states of flap detection (<a class="xref" href="../Text/apb.html" title="Appendix B. Rapidly Alternating States: Flapping">Appendix B</a>, page 611) can be ruled out.<a class="indexterm" id="IDX-APP-H-2438"/></p>

              <p>Possible values are <strong class="userinput"><code>o</code></strong> (OK), <strong class="userinput"><code>u</code></strong>(UNREACHABLE), and <strong class="userinput"><code>d</code></strong> (DOWN). If you exclude the OK states with <strong class="userinput"><code>flap_detection_options o</code></strong>, Nagios will only take into account the change between UNREACHABLE and DOWN.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>notification_options</code></strong></span></dt>

            <dd>
              <p>If the new value <strong class="userinput"><code>s</code></strong> is specified, Nagios will send a notification if a maintenance interval (see <a class="xref" href="../Text/ch16s03.html" title="16.3 Planning Downtimes">16.3 Planning Downtimes</a> from page 359) is started, finished, or canceled.<a class="indexterm" id="IDX-APP-H-2439"/></p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>initial_state</code></strong></span></dt>

            <dd>
              <p>Sets the initial state of the host. Normally Nagios assumes that this is UP (<strong class="userinput"><code>initial_state o</code></strong>). <strong class="userinput"><code>d</code></strong> sets the initial state to DOWN, <strong class="userinput"><code>u</code></strong> to UNREACHABLE.<a class="indexterm" id="IDX-APP-H-2440"/></p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>retry_interval</code></strong></span></dt>

            <dd>
              <p>After how many time units will an active host check be repeated if <strong class="userinput"><code>max_check_attempts</code></strong> is larger than 1? There is more on the new features for host checks in <a class="xref" href="../Text/aphs07.html" title="H.7 A New Logic for Host Checks">H.7 A New Logic for Host Checks</a>.<a class="indexterm" id="IDX-APP-H-2441"/></p>
            </dd>
          </dl>
        </div>

        <div class="sect3" title="Extended host information">
          <div class="titlepage">
            <h3 class="title" id="heading_id_5"><a id="extended_host_information-id1"/>Extended host information</h3>
          </div>

          <p>The objects <strong class="userinput"><code>hostextinfo</code></strong> and <strong class="userinput"><code>serviceextinfo</code></strong> are considered obsolete, but are still evaluated by Nagios 3.0. When checking the configuration, as well as on restarting, Nagios issues a corresponding warning. Later Nagios versions will no longer support this object type.<a class="indexterm" id="IDX-APP-H-2442"/><a class="indexterm" id="IDX-APP-H-2443"/><a class="indexterm" id="IDX-APP-H-2444"/><a class="indexterm" id="IDX-APP-H-2445"/></p>

          <p>Additional information for the Web interfaces (see <a class="xref" href="../Text/ch16s04.html#extended_host_information" title="16.4.1 Extended host information">16.4.1 Extended host information</a> from page 363) are now defined directly in the host (or service):</p><a id="I_programlisting_d1e59115"/>
          <pre class="programlisting">define host {
   ...
   # -- extended host information
   notes             <span class="emphasis"><em>free text</em></span>
   notes_url         <span class="emphasis"><em>url</em></span>
   action_url        <span class="emphasis"><em>url</em></span>
   icon_image        <span class="emphasis"><em>image file</em></span>
   icon_image_alt    <span class="emphasis"><em>free text</em></span>
   vrml_image        <span class="emphasis"><em>image file</em></span>
   statusmap_image   <span class="emphasis"><em>image file</em></span>
   2d_coords         <span class="emphasis"><em>x,y</em></span>
   3d_coords         <span class="emphasis"><em>x,y,z</em></span>
}</pre>
        </div>
      </div>

      <div class="sect2" title="H.1.2 The service object">
        <div class="titlepage">
          <h2 class="title" id="heading_id_6"><a id="the_service_object"/>H.1.2 The service object</h2>
        </div>

        <p>The innovations for the service object are essentially the same as those for the host object. The parameters <strong class="userinput"><code>flap_detection_options</code></strong>, <strong class="userinput"><code>notification_options</code></strong>, and <strong class="userinput"><code>initial_state</code></strong> are now assigned the values <strong class="userinput"><code>w</code></strong> (WARNING) and <strong class="userinput"><code>c</code></strong> (CRITICAL) instead of the host states DOWN and UNREACHABLE:<a class="indexterm" id="IDX-APP-H-2446"/><a class="indexterm" id="IDX-APP-H-2447"/><a class="indexterm" id="IDX-APP-H-2448"/><a class="indexterm" id="IDX-APP-H-2449"/><a class="indexterm" id="IDX-APP-H-2450"/><a class="indexterm" id="IDX-APP-H-2451"/></p><a id="I_programlisting_d1e59186"/>
        <pre class="programlisting">define service {
   ...
   display_name              <span class="emphasis"><em>display_name</em></span>
   contacts                  <span class="emphasis"><em>contacts</em></span>
   first_notification_delay  <span class="emphasis"><em>number</em></span>
   flap_detection_options    o,c,w,u
   notification_options      w,u,c,r,f,s
   initial_state             o,d,u
   check_interval            <span class="emphasis"><em>number</em></span>
   retry_interval            <span class="emphasis"><em>number</em></span>
   ...
   # -- extended service information
   Notes             <span class="emphasis"><em>free text</em></span>
   notes_url         <span class="emphasis"><em>url</em></span>
   action_url        <span class="emphasis"><em>url</em></span>
   icon_image        <span class="emphasis"><em>image file</em></span>
   icon_image_alt    <span class="emphasis"><em>free text</em></span>
   vrml_image        <span class="emphasis"><em>image file</em></span>
   statusmap_image   <span class="emphasis"><em>image file</em></span>
   2d_coords         <span class="emphasis"><em>x,y</em></span>
   3d_coords         <span class="emphasis"><em>x,y,z</em></span>
}</pre>

        <p>The three parameters <strong class="userinput"><code>contact_groups</code></strong>, <strong class="userinput"><code>notification_interval</code></strong>, and <strong class="userinput"><code>notification_period</code></strong> are no longer mandatory in Nagios 3.0. If they are omitted, they are taken from the <strong class="userinput"><code>host</code></strong> object. The parameter <strong class="userinput"><code>alias</code></strong> is also optional, and if it is not set, the name is taken from <strong class="userinput"><code>service_description</code></strong>.<a class="indexterm" id="IDX-APP-H-2454"/><a class="indexterm" id="IDX-APP-H-2455"/><a class="indexterm" id="IDX-APP-H-2456"/><a class="indexterm" id="IDX-APP-H-2457"/><a class="indexterm" id="IDX-APP-H-2452"/><a class="indexterm" id="IDX-APP-H-2453"/></p>

        <p>The parameter <strong class="userinput"><code>parallelize_check</code></strong>, which in Nagios 2.0 is set by default to 1 and can be altered to prevent parallel service checks, is dropped entirely in Nagios 3.0; service checks here are always performed in parallel.<a class="indexterm" id="IDX-APP-H-2458"/></p>

        <p>The parameters <strong class="userinput"><code>normal_check_interval</code></strong> and <strong class="userinput"><code>retry_check_interval</code></strong> were renamed to <strong class="userinput"><code>check_interval</code></strong> and <strong class="userinput"><code>retry_interval</code></strong>, in order to use the same identifier as for the host definition. The old name remains valid so that Nagios does not show an error message.</p>
      </div>

      <div class="sect2" title="H.1.3 Group objects">
        <div class="titlepage">
          <h2 class="title" id="heading_id_7"><a id="group_objects"/>H.1.3 Group objects</h2>
        </div>

        <p>With the parameters <strong class="userinput"><code>hostgroup_members</code></strong>, <strong class="userinput"><code>servicegroup_members</code></strong>, and <strong class="userinput"><code>contactgroup_members</code></strong> you can now also define groups of the same type as members of a group, and thus form hierarchies:<a class="indexterm" id="IDX-APP-H-2459"/><a class="indexterm" id="IDX-APP-H-2460"/><a class="indexterm" id="IDX-APP-H-2461"/><a class="indexterm" id="IDX-APP-H-2462"/><a class="indexterm" id="IDX-APP-H-2463"/><a class="indexterm" id="IDX-APP-H-2464"/><a class="indexterm" id="IDX-APP-H-2465"/><a class="indexterm" id="IDX-APP-H-2466"/><a class="indexterm" id="IDX-APP-H-2467"/></p><a id="I_programlisting_d1e59347"/>
        <pre class="programlisting">define hostgroup {
   hostgroup_members <span class="emphasis"><em>host groups</em></span>
   ...
   notes             <span class="emphasis"><em>free text</em></span>
   notes_url         <span class="emphasis"><em>url</em></span>
   action_url        <span class="emphasis"><em>url</em></span>
}
define servicegroup {
   servicegroup_members <span class="emphasis"><em>service groups</em></span>
   ...
   notes          <span class="emphasis"><em>free text</em></span>
   notes_url      <span class="emphasis"><em>url</em></span>
   action_url     <span class="emphasis"><em>url</em></span>
}
define contactgroup {
   contactgroup_members <span class="emphasis"><em>contact groups</em></span>
   ...
}</pre>

        <p>Extended group information for the group types <strong class="userinput"><code>hostgroup</code></strong> and <strong class="userinput"><code>service-group</code></strong> allows additional information to be stored, in a similar way as for host and service definitions. <strong class="userinput"><code>notes</code></strong> here is a simple text which is displayed on the page with the extended status information (see <a class="xref" href="../Text/ch16s02.html#additional_information_and_control_cent" title="16.2.2 Additional information and control center: extinfo.cgi">16.2.2 Additional information and control center: extinfo.cgi</a> in page 339). The two URLs point to external Web pages, for instance so that a Wiki can be integrated for the purpose of online documentation.</p>
      </div>

      <div class="sect2" title="H.1.4 The contact object">
        <div class="titlepage">
          <h2 class="title" id="heading_id_8"><a id="the_contact_object"/>H.1.4 The contact object</h2>
        </div>

        <p>The value <strong class="userinput"><code>n</code></strong> (none) for the parameters <strong class="userinput"><code>host_notifications_options</code></strong> and <strong class="userinput"><code>service_notifications_options</code></strong> switches off notifications completely. This can also be achieved with a separate on/off function via the interface for external commands (<a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>, page 292), which requires the new parameters <strong class="userinput"><code>host_notifications_enabled</code></strong> and <strong class="userinput"><code>service_notifications_enabled</code></strong>:<a class="indexterm" id="IDX-APP-H-2468"/><a class="indexterm" id="IDX-APP-H-2469"/><a class="indexterm" id="IDX-APP-H-2470"/><a class="indexterm" id="IDX-APP-H-2471"/></p><a id="I_programlisting_d1e59425"/>
        <pre class="programlisting">define contact {
   host_notifications_enabled     <span class="emphasis"><em>value</em></span>
   service_notifications_enabled  <span class="emphasis"><em>value</em></span>
   can_submit_commands            <span class="emphasis"><em>value</em></span>
   ...
}</pre>

        <p>They can be set to <strong class="userinput"><code>1</code></strong> (on) or <strong class="userinput"><code>0</code></strong> (off). <strong class="userinput"><code>can_submit_commands</code></strong> controls whether a contact may only view his hosts and services, or whether he can run commands for them via the Web interface. In Nagios 2.0 every user who has access to hosts and services may do this. The default is <strong class="userinput"><code>1</code></strong> (commands are allowed), <strong class="userinput"><code>0</code></strong> allows only viewing.<a class="indexterm" id="IDX-APP-H-2472"/></p>
      </div>

      <div class="sect2" title="H.1.5 Time definitions">
        <div class="titlepage">
          <h2 class="title" id="heading_id_9"><a id="time_definitions"/>H.1.5 Time definitions</h2>
        </div>

        <p>Periods of time can be defined much more flexibly in Nagios 3.0 than was previously the case:<a class="indexterm" id="IDX-APP-H-2473"/></p><a id="I_programlisting_d1e59467"/>
        <pre class="programlisting">define timeperiod {
   timeperiod_name  veryspecial
   2007-12-23      00:00-24:00
   april 1         00:00-24:00
   day 1           00:00-24:00
   monday 2 may    00:00-24:00
   monday 3        00:00-24:00
   monday          00:00-24:00
   2007-12-01 - 2009-04-01 / 3 00:00-24:00
   ...
   exclude <span class="emphasis"><em>timeperiod_name1, timeperiod_name2</em></span>,...
}</pre>

        <p>Whereas Nagios 2.x allows only single weekdays to be defined, you can now also specify an ISO date (<strong class="userinput"><code>2007-12-23</code></strong>), the first day of a specific month (<strong class="userinput"><code>april 1</code></strong>), the first day of each month (<strong class="userinput"><code>day 1</code></strong>), the second Monday in May (<strong class="userinput"><code>monday 2 may</code></strong>), or every third Monday in the month (<strong class="userinput"><code>monday 3</code></strong>). Intervals are also allowed here, consisting of two time specifications separated by a - sign. In addition, time periods independent of the month or day of the week are possible: <strong class="userinput"><code>2007-12-01 - 2009-04-01 / 3</code></strong> describes evey third day from 01. 12. 2007 to 01. 04. 2009.</p>

        <p>The parameter <strong class="userinput"><code>exclude</code></strong> rules out the time periods that follow (themselves also <strong class="userinput"><code>timeperiod</code></strong> objects).</p>

        <p>More information on defining times can be found in <a class="xref" href="../Text/ch02s10.html" title="2.10 Defining a Time Period with timeperiod">2.10 Defining a Time Period with timeperiod</a> from page 74.</p>
      </div>

      <div class="sect2" title="H.1.6 Dependency descriptions">
        <div class="titlepage">
          <h2 class="title" id="heading_id_10"><a id="dependency_descriptions"/>H.1.6 Dependency descriptions</h2>
        </div>

        <p>There is a new parameter for the objects <strong class="userinput"><code>hostdependency</code></strong> and <strong class="userinput"><code>servicedependency</code></strong> called <strong class="userinput"><code>dependency_period</code></strong>, which defines how long dependencies are valid. An object of the type <strong class="userinput"><code>timeperiod</code></strong> is specified as the value. If this parameter is missing, dependencies are unrestricted in time:<a class="indexterm" id="IDX-APP-H-2474"/><a class="indexterm" id="IDX-APP-H-2475"/><a class="indexterm" id="IDX-APP-H-2476"/><a class="indexterm" id="IDX-APP-H-2477"/><a class="indexterm" id="IDX-APP-H-2478"/><a class="indexterm" id="IDX-APP-H-2479"/></p><a id="I_programlisting_d1e59549"/>
        <pre class="programlisting">define hostdependency {
   dependency_period  <span class="emphasis"><em>timeperiod_name</em></span>
   ...
}

define servicedependency {
   dependency_period  <span class="emphasis"><em>timeperiod_name</em></span>
   ...
}</pre>

        <p>So-called <span class="emphasis"><em>Same-Host Dependencies</em></span> are also new; these are <strong class="userinput"><code>servicedependencies</code></strong> that refer to the same host. In this case the parameter <strong class="userinput"><code>dependend_host_name</code></strong> is simply omitted:<a class="indexterm" id="IDX-APP-H-2480"/></p><a id="I_programlisting_d1e59571"/>
        <pre class="programlisting">define servicedependency {
   host_name                                linux
   service_description                    Disk_Usage
   dependent_service_description NRPE
   ...
}</pre>

        <p>The <strong class="userinput"><code>Disk_Usage</code></strong> service therefore depends on the <strong class="userinput"><code>NRPE</code></strong> service on the same host.</p>

        <p>If the parameter <strong class="userinput"><code>host_name</code></strong> is replaced with <strong class="userinput"><code>hostgroup_name</code></strong>, the same dependency can be defined for an entire host group. In Nagios 2.x this is not possible. If you defined <strong class="userinput"><code>dependent_hostgroup_name</code></strong>, the <strong class="userinput"><code>Disk_Usage</code></strong> services for all hosts of the group would be dependent on all the <strong class="userinput"><code>NRPE</code></strong> services for these hosts, which would be counterproductive in many cases.</p>
      </div>

      <div class="sect2" title="H.1.7 Escalation objects">
        <div class="titlepage">
          <h2 class="title" id="heading_id_11"><a id="escalation_objects"/>H.1.7 Escalation objects</h2>
        </div>

        <p>As with the host and service definition, it is also possible starting with Nagios 3.0 to specify individual contacts instead of a whole contact group for host and service escalations, by means of <strong class="userinput"><code>contacts</code></strong>:</p><a id="I_programlisting_d1e59606"/>
        <pre class="programlisting">define hostescalation {
   contacts   <span class="emphasis"><em>contact</em></span>
   ...
}
define serviceescalation {
   contacts <span class="emphasis"><em>contact</em></span>
   ...
}</pre>
      </div>

      <div class="sect2" title="H.1.8 Inheritance">
        <div class="titlepage">
          <h2 class="title" id="heading_id_12"><a id="inheritance-id1"/>H.1.8 Inheritance</h2>
        </div>

        <p>It was already possible in Nagios 2.x to define templates for objects and for the actual object to inherit the properties of the template. Multiple inheritance is now possible in Nagios 3.0, and an inheritance can also be selectively suppressed. In the following example, the two templates <strong class="userinput"><code>host_generic_t</code></strong> and <strong class="userinput"><code>host_site_t</code></strong> are inherited by the host <strong class="userinput"><code>linux01</code></strong>:<a class="indexterm" id="IDX-APP-H-2481"/><a class="indexterm" id="IDX-APP-H-2482"/></p><a id="I_programlisting_d1e59634"/>
        <pre class="programlisting">define host {
   name <span class="strong"><strong>host_generic_t</strong></span>
   register 0
   #
   check_period         24×7
   max_check_attempts   3
   check_interval       10
   retry_interval       2
   ...
   hostgroups           ALL_HOSTS
}
define host {
   name <span class="strong"><strong>host_site_t</strong></span>
   register 0
   #
   check_interval   5
   retry_interval   1
   ...
   parents          switch01
   hostgroups       HAMBURG
}
define host {
   host_name   linux01
   use         <span class="strong"><strong>host_site_t,host_generic_t</strong></span>
   ...
   parents<span class="strong"><strong>     null</strong></span>
   hostgroups<span class="strong"><strong>  +LINUX</strong></span>
}</pre>

        <p>The parameters <strong class="userinput"><code>check_interval</code></strong> and <strong class="userinput"><code>retry_interval</code></strong> are defined in both templates. In this case the first template to be defined (<strong class="userinput"><code>host_site_t</code></strong>) is used, and the result appears as follows:</p><a id="I_programlisting_d1e59662"/>
        <pre class="programlisting">define host {
   host_name             linux01
   check_period          24×7
   max_check_attempts    3
   check_interval        5
   retry_interval        1
   ...
   hostgroups            <span class="strong"><strong>HAMBURG,LINUX</strong></span>
}</pre>

        <p>Both check intervals originate from the template <strong class="userinput"><code>host_site_t</code></strong>. The value <strong class="userinput"><code>zero</code></strong> for <strong class="userinput"><code>parents</code></strong> suppresses the inheritance; a value defined in the templates is not carried over, and the parameter is not set.</p>

        <p>Equally new is the option of combining a specified value with the value from the template. The plus sign in <strong class="userinput"><code>hostgroups</code></strong> carries over the value from the template and adds the specified value to this. Until now, inherited values were completely overwritten by an object. The defaults from the templates, however, can only be combined with the values specified in the object for standard parameters containing a list in text form (for example, <strong class="userinput"><code>hostgroups</code></strong>, <strong class="userinput"><code>servicegroups</code></strong>, <strong class="userinput"><code>contact_groups</code></strong>).<a class="indexterm" id="IDX-APP-H-2483"/></p>

        <p>For <strong class="userinput"><code>contact_groups</code></strong> within escalations, there is an additional variation of the plus sign. If the enclosing escalation object does not define a contact group whose properties can be inherited, the accompanying host (for host escalations) or service definition (for service escalations) is used. The three parameters <strong class="userinput"><code>contact_groups</code></strong>, <strong class="userinput"><code>notification_interval</code></strong>, and <strong class="userinput"><code>notification_period</code></strong> are inherited from the host object automatically by the service object, so that their definition there is no longer mandatory.<a class="indexterm" id="IDX-APP-H-2484"/><a class="indexterm" id="IDX-APP-H-2485"/></p>

        <p>The online documentation included in Nagios uses a more complex example to describe multiple inheritance.<sup>[<a class="footnote" href="#ftn.APP-H-FN-2" id="APP-H-FN-2">337</a>]</sup></p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-H-FN-1" id="ftn.APP-H-FN-1">336</a>]</sup> See also <a class="ulink" href="http://nagios.sourceforge.net/docs/3_0/whatsnew.html">http://nagios.sourceforge.net/docs/3_0/whatsnew.html</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-H-FN-2" id="ftn.APP-H-FN-2">337</a>]</sup> <a class="ulink" href="http://localhost/nagios/docs/objectinheritance.html">http://localhost/nagios/docs/objectinheritance.html</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="H.2 Variable and Macros">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="variable_and_macros"/>H.2 Variable and Macros</h1>
    </div>

    <p>You can define your own variables in the objects <strong class="userinput"><code>host</code></strong>, <strong class="userinput"><code>service</code></strong>, and <strong class="userinput"><code>contact</code></strong>. The names of these always begin with an underscore and are inherited like normal variables:<a class="indexterm" id="IDX-APP-H-2486"/><a class="indexterm" id="IDX-APP-H-2487"/><a class="indexterm" id="IDX-APP-H-2488"/><a class="indexterm" id="IDX-APP-H-2489"/><a class="indexterm" id="IDX-APP-H-2490"/><a class="indexterm" id="IDX-APP-H-2491"/><a class="indexterm" id="IDX-APP-H-2492"/><a class="indexterm" id="IDX-APP-H-2493"/><a class="indexterm" id="IDX-APP-H-2494"/><a class="indexterm" id="IDX-APP-H-2495"/><a class="indexterm" id="IDX-APP-H-2496"/><a class="indexterm" id="IDX-APP-H-2497"/></p><a id="I_programlisting_d1e59783"/>
    <pre class="programlisting">define host {
   host_name linux01
   use       host_site_t,host_generic_t
   ...
<span class="strong"><strong>   _NRPE_PORT</strong></span> 5666
}</pre>

    <p>The variable <strong class="userinput"><code>_NRPE_PORT</code></strong> is accessed with <strong class="userinput"><code>$_HOSTNRPE_PORT$</code></strong>, which means that the object type (<strong class="userinput"><code>HOST</code></strong>, <strong class="userinput"><code>SERVICE</code></strong>, or <strong class="userinput"><code>CONTACT</code></strong>) is added <span class="emphasis"><em>after</em></span> the underscore. This is slightly unfortunate, as it is more difficult to read. The macro created can be used elsewhere, for example in the definition of a command:</p><a id="I_programlisting_d1e59809"/>
    <pre class="programlisting">define command {
   command_name check_nrpe
   command_line $USER1$/check_nrpe -H $HOSTADDRESS$ -p $_HOSTNRPE_PORT$
-c $ARG1$
}</pre>

    <p>Macros allow access to configuration data, states, and check results. In Nagios 3.0 the macro <strong class="userinput"><code>$NOTIFICATIONNUMBER$</code></strong>, which contains the number of notifications sent for the current state, has been removed. It has been replaced by the host- and service-specific macros <strong class="userinput"><code>$HOSTNOTIFICATIONNUM-BER$</code></strong> and <strong class="userinput"><code>$SERVICENOTIFICATIONNUMBER$</code></strong>.<a class="indexterm" id="IDX-APP-H-2498"/><a class="indexterm" id="IDX-APP-H-2499"/><a class="indexterm" id="IDX-APP-H-2500"/></p>

    <p>The list of available macros has grown considerably. Some new ones are <strong class="userinput"><code>$L0NGH0ST0UTPUT$</code></strong> and <strong class="userinput"><code>$LONGSERVICEOUTPUT$</code></strong>, for example, which contain the extended plugin output of multiple-line plugin results (see <a class="xref" href="../Text/aphs10.html" title="H.10 Extended Plugin Output">H.10 Extended Plugin Output</a> and <a class="xref" href="../Text/ch08s05.html#multiple-line_plugin_output" title="8.5.1 Multiple-line plugin output">8.5.1 Multiple-line plugin output</a>, page 193).<a class="indexterm" id="IDX-APP-H-2501"/></p>

    <p>The macros <strong class="userinput"><code>$H0STN0TIFICATI0NID$</code></strong>, <strong class="userinput"><code>$SERVICENOTIFICATIONID$</code></strong>, <strong class="userinput"><code>$H0ST-EVENTID$</code></strong>, <strong class="userinput"><code>$SERVICEEVENTID$</code></strong>, <strong class="userinput"><code>$LASTHOSTEVENTID$</code></strong>, and <strong class="userinput"><code>$LASTSERVICE-EVENTID$</code></strong> assign to each event a unique identification number that has been added in Nagios 3.0.<a class="indexterm" id="IDX-APP-H-2502"/><a class="indexterm" id="IDX-APP-H-2503"/><a class="indexterm" id="IDX-APP-H-2504"/></p>

    <p><strong class="userinput"><code>$HOSTDISPLAYNAME$</code></strong> and <strong class="userinput"><code>$SERVICEDISPLAYNAME$</code></strong> return the <strong class="userinput"><code>display_name</code></strong> set in the host and service definition.</p>

    <p>Also of interest are the new macros that enable the last state to be accessed: <strong class="userinput"><code>$LASTHOSTSTATE$</code></strong> and <strong class="userinput"><code>$LASTHOSTSTATEID$</code></strong> give the previous host state, and <strong class="userinput"><code>$LASTSERVICESTATE$</code></strong> and <strong class="userinput"><code>$LASTSERVICESTATEID$</code></strong> are used for the previous service state. The <strong class="userinput"><code>*ID</code></strong> macros provide the numerical value (e. g., <strong class="userinput"><code>2</code></strong> for the critical state of services), and the other two provide the corresponding text (e. g., WARNING for services and DOWN for hosts).<a class="indexterm" id="IDX-APP-H-2505"/><a class="indexterm" id="IDX-APP-H-2506"/><a class="indexterm" id="IDX-APP-H-2507"/><a class="indexterm" id="IDX-APP-H-2508"/></p>

    <p>Macros can usually also be read out via the environment, but the increased number of macros has an effect on performance. If you don't access Nagios macros through environment variables, it is therefore better to switch this feature off entirely in Nagios 3.0:</p><a id="I_programlisting_d1e59922"/>
    <pre class="programlisting">enable_environment_macros=0</pre>

    <p>How you can use macros is described in <a class="xref" href="../Text/apd.html" title="Appendix D. Macros">Appendix D</a> in page 625. The complete list of all macros can be found in the online documentation.<sup>[<a class="footnote" href="#ftn.APP-H-FN-3" id="APP-H-FN-3">338</a>]</sup> The change log for Nagios 3.0<sup>[<a class="footnote" href="#ftn.APP-H-FN-4" id="APP-H-FN-4">339</a>]</sup> will tell you which of these are new.<a class="indexterm" id="IDX-APP-H-2509"/></p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-H-FN-3" id="ftn.APP-H-FN-3">338</a>]</sup> <a class="ulink" href="http://nagios.sourceforge.net/docs/3_0/macrolist.html">http://nagios.sourceforge.net/docs/3_0/macrolist.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-H-FN-4" id="ftn.APP-H-FN-4">339</a>]</sup> <a class="ulink" href="http://nagios.sourceforge.net/docs/3_0/whatsnew.html">http://nagios.sourceforge.net/docs/3_0/whatsnew.html</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="H.3 Downtime, Comments, and Acknowledgments">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="downtime_comma_comments_comma_and"/>H.3 Downtime, Comments, and Acknowledgments</h1>
    </div>

    <p>Comments and maintenance intervals are now saved together with other information in the status and retention file. These special files and the accompanying parameters <strong class="userinput"><code>downtime_file</code></strong> and <strong class="userinput"><code>comment_file</code></strong> have been removed from Nagios 3.0. With an upgrade from Nagios 2.x to this version you can keep any existing comments and maintenance intervals—how to do this is described in <a class="xref" href="../Text/aphs13.html" title="H.13 Upgrade from Nagios 2.x to 3.0">H.13 Upgrade from Nagios 2.x to 3.0</a>.<a class="indexterm" id="IDX-APP-H-2510"/><a class="indexterm" id="IDX-APP-H-2511"/><a class="indexterm" id="IDX-APP-H-2512"/><a class="indexterm" id="IDX-APP-H-2513"/></p>

    <p>A further change involves the commenting of acknowledgments. Until now, non-persistent acknowledgments were deleted with every restart. In Nagios 3.0 they now survive; the system deletes the comment for an acknowledgment only when the problem has been rectified, so that the service or host status is OK.</p>
  </div>


  <div class="sect1" title="H.4 Rapidly Changing States">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="rapidly_changing_states"/>H.4 Rapidly Changing States</h1>
    </div>

    <p>Nagios 3.0 now records the state history even when flap detection is switched off. If you switch this on globally, with <strong class="userinput"><code>enable_flap_detection</code></strong> (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>), Nagios will test all hosts and services immediately for flapping.</p>

    <p>For globally switched off flap detection, Nagios logs flapping states to the log file and sends messages of the notification type FLAPPINGDISABLED, if you have specified <strong class="userinput"><code>f</code></strong> (flapping) in the <strong class="userinput"><code>notification_options</code></strong> in the host or service definition.<a class="indexterm" id="IDX-APP-H-2514"/></p>

    <p>Whereas Nagios 2.x still recorded every change in state, in Nagios 3.0 the parameter <strong class="userinput"><code>flap_detection_options</code></strong> (see <a class="xref" href="../Text/aph.html#the_host_object" title="H.1.1 The host object">H.1.1 The host object</a>, page 679) allows this to be restricted to certain states. Only the states specified are then included in the calculation of the change in state.<a class="indexterm" id="IDX-APP-H-2515"/><a class="indexterm" id="IDX-APP-H-2516"/><a class="indexterm" id="IDX-APP-H-2517"/></p>
  </div>


  <div class="sect1" title="H.5 External Commands">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="external_commands"/>H.5 External Commands</h1>
    </div>

    <p>The list of external commands has grown larger in Nagios 3.0, so that considerably more things can be set through the relevant interface (see <a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>, page 292.).<a class="indexterm" id="IDX-APP-H-2518"/></p>

    <p>Of special interest here is the command <strong class="userinput"><code>PROCESS_FILE</code></strong>, which is passed a file that itself contains external commands. This allows for the bulk processing of passive checks:<a class="indexterm" id="IDX-APP-H-2519"/></p><a id="I_programlisting_d1e60029"/>
    <pre class="programlisting">PROCESS_FILE; <span class="emphasis"><em>path/to/file; number</em></span></pre>

    <p><strong class="userinput"><code>PROCESS_FILE</code></strong> requires the full path to the file that is to be processed. The second argument determines whether the file is kept after processing (<strong class="userinput"><code>0</code></strong>) or deleted (a value not equal to <strong class="userinput"><code>0</code></strong>).</p>

    <p>Two other new commands allow you to make your own notifications. Notifications actually have a fixed type (<strong class="userinput"><code>PROBLEM</code></strong>, <strong class="userinput"><code>RECOVERY</code></strong>, <strong class="userinput"><code>ACKNOWLEDGE</code></strong>, etc.; see <a class="xref" href="../Text/ch12s04.html#macros_used_in_notify-by-email_and_host" title="Table 12-1. Macros used in notify-by-email and host-notify-by-email">Table 12-1</a> in page 277), which is queried via the macro <strong class="userinput"><code>$N0TIFI-CATI0NTYPE$</code></strong>. The so-called <span class="emphasis"><em>Custom Notifications</em></span>, in contrast, are of the type <strong class="userinput"><code>CUSTOM</code></strong> and allow notifications outside the otherwise strict rules. This means that broadcasts—messages to all—are also possible:</p><a id="I_programlisting_d1e60066"/>
    <pre class="programlisting">SEND_CUSTOM_SVC_NOTIFICATION;<span class="emphasis"><em>host; service; options; author; comment</em></span>
SEND_CUSTOM_HOST_NOTIFICATION;<span class="emphasis"><em>host; options; author; comment</em></span></pre>

    <p>Instead of the <span class="emphasis"><em>options</em></span> placeholder, you specify a bitmask, which controls the behavior of the two commands. The value <strong class="userinput"><code>0</code></strong> means "no option set." <strong class="userinput"><code>1</code></strong> ensures a broadcast message to all normal contacts and to those who are added during an escalation. <strong class="userinput"><code>2</code></strong> forces the message to be sent, regardless of whether notifications are switched on or off for the host, service, or contact, and ignores any time window that may be set. Finally, the value <strong class="userinput"><code>4</code></strong> increments the notification counter, and the message is then counted in the escalation procedure. Normally a Custom Notification is not counted.<a class="indexterm" id="IDX-APP-H-2520"/><a class="indexterm" id="IDX-APP-H-2521"/></p>

    <p>A complete description of all external commands is provided on the developer pages of the Nagios homepage.<sup>[<a class="footnote" href="#ftn.APP-H-FN-5" id="APP-H-FN-5">340</a>]</sup> The Web interface there enables a selective search to be made for commands that are allowed in a specific Nagios version or deal with a certain topic (for example, services, hosts, <span class="strong"><strong>scheduled downtime</strong></span> (maintenance window), <span class="strong"><strong>notifications</strong></span>).</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#APP-H-FN-5" id="ftn.APP-H-FN-5">340</a>]</sup> <a class="ulink" href="http://www.nagios.org/developerinfo/externalconunands/conunandlist.php">http://www.nagios.org/developerinfo/externalconunands/conunandlist.php</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="H.6 Embedded Perl">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="embedded_perl"/>H.6 Embedded Perl</h1>
    </div>

    <p>Handling the Embedded Perl Interpreter (see <a class="xref" href="../Text/apg.html" title="Appendix G. The Embedded Perl Interpreter">Appendix G</a> from page 669) is also easier in Nagios 3.0. It can be switched on or off with the parameter <strong class="userinput"><code>enable_embeded_perl</code></strong> in the main configuration file <strong class="userinput"><code>nagios.cfg</code></strong>. The parameter <strong class="userinput"><code>use_embedded_perl_implicitly</code></strong> controls whether a plugin should implicitly use the activated interpreter if there are no instructions to the contrary (see also <a class="xref" href="../Text/apgs02.html" title="G.2 Using ePN">G.2 Using ePN</a> from page 672). In Nagios 2.x there was only the option of switching the interpreter on or off when compiling the Nagios system.<a class="indexterm" id="IDX-APP-H-2522"/><a class="indexterm" id="IDX-APP-H-2523"/><a class="indexterm" id="IDX-APP-H-2524"/><a class="indexterm" id="IDX-APP-H-2525"/><a class="indexterm" id="IDX-APP-H-2526"/><a class="indexterm" id="IDX-APP-H-2527"/><a class="indexterm" id="IDX-APP-H-2528"/></p>

    <p>If the switch <strong class="userinput"><code>--with-embedded-perl</code></strong> is enabled, the <strong class="userinput"><code>configure</code></strong> script of Nagios 3.0 automatically uses the switch <strong class="userinput"><code>--with-perlcache</code></strong> as well. If Nagios detects that something has changed in the script to be executed, it will reload the script. In version 2.x you had to restart Nagios with the Perl cache switched on.</p>
  </div>


  <div class="sect1" title="H.7 A New Logic for Host Checks">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="a_new_logic_for_host_checks"/>H.7 A New Logic for Host Checks</h1>
    </div>

    <p>Nagios 2.x performs host checks serially, so it waits for the results of the individual check before checking other hosts in the direct vicinity to find out if the first host is DOWN or UNREACHABLE (see the figure in <a class="xref" href="../Text/ch04.html#taking_into_account_the_network_topology" title="4.1 Taking into Account the Network Topology">4.1 Taking into Account the Network Topology</a>). In contrast, Nagios 3.0 works in parallel here, provided that the parameter <strong class="userinput"><code>max_check_attempts</code></strong> for the host to be checked is larger than <strong class="userinput"><code>1</code></strong>. For <strong class="userinput"><code>max_check_attempts=l</code></strong> the system behaves as in version 2.x.<a class="indexterm" id="IDX-APP-H-2529"/></p>

    <p>In some cases this strongly influence performance, so you should always set a value larger than <strong class="userinput"><code>1</code></strong> in Nagios 3.0. Running host checks in parallel also means that a check result will sometimes get lost, since Nagios no longer waits until the result for every single check is available. The parameter <strong class="userinput"><code>check_for_orphaned_hosts</code></strong> now ensures that Nagios will deal with orphaned checks.<a class="indexterm" id="IDX-APP-H-2530"/></p>

    <p>Active host checks can even improve performance in certain environments, if the equally new feature of <span class="emphasis"><em>check caching</em></span> is used. Here Nagios accesses the result of a recently performed check, provided that this can be considered to be up to date. This means that the system saves a considerable amount of time in host checks for failed services, in resolving the topology for failed hosts, and for forward-looking dependency checks (see last section). For service checks, caching only plays a role for service dependencies.<a class="indexterm" id="IDX-APP-H-2531"/></p>

    <p>How large the time horizon for caching should be is defined for host checks by the parameter <strong class="userinput"><code>cached_host_check_horizon</code></strong> (see also <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>) and for service checks by the parameter <strong class="userinput"><code>cached_service_check_horizon</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). The default is 15 seconds in each case, and the value <strong class="userinput"><code>0</code></strong> switches caching off entirely.<a class="indexterm" id="IDX-APP-H-2532"/><a class="indexterm" id="IDX-APP-H-2533"/></p>

    <p>The larger the time interval in which Nagios caches results, the more often Nagios accesses the cache without actually performing the check itself. However, this does have a crucial disadvantage: The cached result may be obsolete. Therefore, you always need to compromise between obsolete results and taking the strain off Nagios. You will have to decide for yourself how large the time interval for caching should be. Again, the preferred method is to measure the latency times of service checks, which are a good indication of the performance of Nagios. If there is no visible difference over a long period of time between a caching time of 30 seconds and one of 60 seconds, it is better to select the shorter period, since you will be working with more up-to-date results in this case. How you measure the latency times of checks is described in <a class="xref" href="../Text/apf.html#a_plugin_to_monitor_latency" title="F.1.3 A plugin to monitor latency">F.1.3 A plugin to monitor latency</a> from page 660.</p>

    <p>Whether or not active host checks in combination with check caching lead to an improvement in performance can also be tested with <strong class="userinput"><code>nagiostats</code></strong> (<a class="xref" href="../Text/apf.html#the_command-line_tool_nagiostats" title="F.1.1 The command-line tool nagiostats">F.1.1 The command-line tool nagiostats</a>, page 654). The program displays the number of cached host checks whose results have been reused by Nagios in the last minute, in the last five minutes, and in the last fifteen minutes.</p>

    <p>In distributed environments, or for redundant Nagios installations, the perspective is sometimes altered: Nagios server A has a different topological view of the network than Nagios server B. The result of a host check that server A sends to server B as a passive check result may in some cases no longer match. What is categorized by server A as UNREACHABLE may be a failed host in the DOWN state from the perspective of server B. The parameter <strong class="userinput"><code>translate_passive_host_checks</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>) enables Nagios to reclassify passive host checks that it has been sent.<a class="indexterm" id="IDX-APP-H-2534"/><a class="indexterm" id="IDX-APP-H-2535"/></p>

    <p>To achieve greater fine-tuning, passive host checks may now also accept a soft state if you set the parameter <strong class="userinput"><code>max_check_attempts</code></strong> in the host definition to a value larger than <strong class="userinput"><code>1</code></strong> and enable the parameter <strong class="userinput"><code>passive_host_checks_are_soft</code></strong> (page 600) in the main configuration file. Until now, passive host checks were always "hard."<a class="indexterm" id="IDX-APP-H-2536"/><a class="indexterm" id="IDX-APP-H-2537"/></p>
  </div>


  <div class="sect1" title="H.8 Restart">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="restart"/>H.8 Restart</h1>
    </div>

    <p>When you start Nagios, it rechecks the configuration each time for errors and dependencies. Depending on the specific environment, this can be very quick, or it may last a long time, during which Nagios will not operate. In Nagios 3.0 there is an option to disconnect this test from the restart and instead save the result in a separate temporary file. When Nagios starts, it will read this file, and the otherwise usual processing of objects is left out at this point. Whether this is worthwhile or not is revealed by <strong class="userinput"><code>nagios -s</code></strong>:</p><a id="I_programlisting_d1e60276"/>
    <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>/usr/local/nagios/bin/nagios -s /etc/nagios/nagios.cfg</strong></span>
OBJECT CONFIG PROCESSING TIMES
(* = Potential for precache savings with -u option)
----------------------------------
Read:                 0.019277 sec
Resolve:              0.001001 sec *
Recomb Contactgroups: 0.000737 sec *
Recomb Hostgroups:    0.003890 sec *
Dup Services:         0.005938 sec *
Recomb Servicegroups: 0.048659 sec *
Duplicate:            0.001527 sec *
Inherit:              0.005602 sec *
Recomb Contacts:      0.000001 sec *
Sort:                 0.030277 sec *
Register:             0.010132 sec
Free:                 0.001831 sec
                      ============
TOTAL:                0.128874 sec * = 0.097634 sec (75.76%)
                                       estimated savings

CONFIG VERIFICATION TIMES
(* = Potential for speedup with -x option)
----------------------------------
Object Relationships: 0.013131 sec
Circular Paths:       0.002341 sec *
Misc:                 0.001032 sec
                      ============
TOTAL:                0.016504 sec * = 0.002341 sec (14.2%)
                                       estimated savings</pre>

    <p>The times marked with <strong class="userinput"><code>*</code></strong> are saved with this <span class="emphasis"><em>precaching</em></span> procedure. In this example, 75 percent of the startup time is occupied with processing the defined objects, but in absolute terms, this is just a tenth of a second and so is hardly worth mentioning.</p>

    <p>If there is real potential for savings, precaching is turned on with the following steps:</p><a id="I_programlisting_d1e60291"/>
    <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>/usr/local/nagios/bin/nagios -vp /etc/nagios/nagios.cfg</strong></span>
nagios@linux:~$ <span class="strong"><strong>/etc/init.d/nagios stop</strong></span>
nagios@linux:~$ <span class="strong"><strong>/usr/local/nagios/bin/nagios -udx /etc/nagios/nagios.cfg</strong></span></pre>

    <p>The first call uses the options <strong class="userinput"><code>-v</code></strong> to check the configuration and <strong class="userinput"><code>-p</code></strong> to cache the processed objects in a separate file. The file is defined in <strong class="userinput"><code>nagios.cfg</code></strong> with the parameter <strong class="userinput"><code>precached_object_file</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). Then Nagios is stopped in the second step.<a class="indexterm" id="IDX-APP-H-2538"/></p>

    <p>The third step is to start the system with the options <strong class="userinput"><code>-udx</code></strong>. The option <strong class="userinput"><code>-u</code></strong> reads the contents of the precaching file, and <strong class="userinput"><code>-d</code></strong> starts Nagios as a daemon, as normal. <strong class="userinput"><code>-x</code></strong> prevents the test for circular dependencies, but assumes that this call is always based on a tested configuration, like the one generated in step 1. Whether the option <strong class="userinput"><code>-x</code></strong> really saves time or not can be seen in the example above from the line <strong class="userinput"><code>Circular Paths</code></strong> in the <strong class="userinput"><code>CONFIG VERIFICATION TIMES</code></strong> section.</p>
  </div>


  <div class="sect1" title="H.9 Performance Optimization">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="performance_optimization-id1"/>H.9 Performance Optimization</h1>
    </div>

    <p>Besides performance optimizations that are not externally visible, Nagios 3.0 includes a number of parameters intended to improve performance in large installations. The most important of these is <strong class="userinput"><code>large_installation_tweaks</code></strong> (<a class="xref" href="../Text/apfs03.html" title="F.2.6 Preferring passive checks">F.2.6 Preferring passive checks</a>).<a class="indexterm" id="IDX-APP-H-2539"/><a class="indexterm" id="IDX-APP-H-2540"/><a class="indexterm" id="IDX-APP-H-2541"/></p>

    <p>The improvement of performance in an existing environment is dealt with in <a class="xref" href="../Text/apf.html" title="Appendix F. Tips on Optimizing Performance">Appendix F</a> from page 653.</p>
  </div>


  <div class="sect1" title="H.10 Extended Plugin Output">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="extended_plugin_output"/>H.10 Extended Plugin Output</h1>
    </div>

    <p>Nagios 3.0 is finally capable of processing multi-line plugin output. The total length of the output must not exceed 8 KB—but you must also make sure that all the transmission paths are compatible for such an amount of data. NRPE currently still needs to be adjusted in the source code (<a class="xref" href="../Text/ch08s05.html#installation_requirements" title="8.5.2 Installation requirements">8.5.2 Installation requirements</a>); the plugin <strong class="userinput"><code>check_by_ssh</code></strong> from the standard plugins inversion 1.4.10 (<a class="xref" href="../Text/ch09.html" title="Chapter 9. Executing Plugins via SSH">Chapter 9</a>) can deal with the 8 KB.<a class="indexterm" id="IDX-APP-H-2542"/><a class="indexterm" id="IDX-APP-H-2543"/><a class="indexterm" id="IDX-APP-H-2544"/><a class="indexterm" id="IDX-APP-H-2545"/><a class="indexterm" id="IDX-APP-H-2546"/><a class="indexterm" id="IDX-APP-H-2547"/><a class="indexterm" id="IDX-APP-H-2548"/><a class="indexterm" id="IDX-APP-H-2549"/></p>

    <p>The format of the extended and muti-line outputs are described in <a class="xref" href="../Text/ch08s05.html#multiple-line_plugin_output" title="8.5.1 Multiple-line plugin output">8.5.1 Multiple-line plugin output</a> (page 193), and an example of the use of the extended format is provided by the plugin <strong class="userinput"><code>check_multi</code></strong> (<a class="xref" href="../Text/ch08s05.html" title="8.5 Summarizing Checks with check_multi">8.5 Summarizing Checks with check_multi</a> from page 191).</p>
  </div>


  <div class="sect1" title="H.11 CGI">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="cgi"/>H.11 CGI</h1>
    </div>

    <p>The Nagios Web interface has also undergone some interesting changes. Some new parameters have been added to the configuration file <strong class="userinput"><code>cgi.cfg</code></strong> (<a class="xref" href="../Text/apas02.html" title="A.2 CGI Configuration in cgi.cfg">A.2 CGI Configuration in cgi.cfg</a>, page 606). <strong class="userinput"><code>lock_author_names</code></strong> prevents the user name, which is included if you set an acknowledgement or a comment on a host or service, from being changed. Instead the user name specified by the user when authenticating himself to the Web server is used. Each registered user is thus an authenticated user.<a class="indexterm" id="IDX-APP-H-2550"/></p>

    <p><strong class="userinput"><code>escape_html_tags</code></strong> determines whether HTML formatting in the plugin output is used (value <strong class="userinput"><code>0</code></strong>) or whether Nagios removes it (value <strong class="userinput"><code>1</code></strong>). In order to link it with <strong class="userinput"><code>action_url</code></strong> (<a class="xref" href="../Text/ch16s04.html#extended_host_information" title="16.4.1 Extended host information">16.4.1 Extended host information</a>) and <strong class="userinput"><code>notes_url</code></strong> (<a class="xref" href="../Text/ch16s04.html#extended_host_information" title="16.4.1 Extended host information">16.4.1 Extended host information</a>), there is now an additional option to specify a target window, with <strong class="userinput"><code>action_url_target</code></strong> and <strong class="userinput"><code>notes_url_target</code></strong>.<a class="indexterm" id="IDX-APP-H-2551"/><a class="indexterm" id="IDX-APP-H-2552"/><a class="indexterm" id="IDX-APP-H-2553"/><a class="indexterm" id="IDX-APP-H-2554"/></p>

    <p>With the CGI program <strong class="userinput"><code>status.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#variations_in_status_display_colon_stat" title="16.2.1 Variations in status display: status.cgi">16.2.1 Variations in status display: status.cgi</a>, page 334) you can now select hard and soft states via <strong class="userinput"><code>hostprops</code></strong> and <strong class="userinput"><code>serviceprops</code></strong> as well. This is particularly useful when using NagVis (<a class="xref" href="../Text/ch18.html" title="Chapter 18. NagVis">Chapter 18</a>, page 389), since NagVis by default only displays hard error states.<a class="indexterm" id="IDX-APP-H-2555"/></p>
  </div>


  <div class="sect1" title="H.12 Miscellaneous">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="miscellaneous"/>H.12 Miscellaneous</h1>
    </div>

    <p>One of the improvements that does not fit into any of the above sections is the parameter <strong class="userinput"><code>use_timezone</code></strong> (page 606), with which you can set the time zone independently of the time zone set on the Nagios server. This is only necessary if several Nagios instances are running on a single machine.<a class="indexterm" id="IDX-APP-H-2556"/></p>

    <p>The parameter <strong class="userinput"><code>additional_freslmess_latency</code></strong> (see <a class="xref" href="../Text/apa.html" title="Appendix A. An Overview of the Nagios Configuration Parameters">Appendix A</a>) delays freshness checks (see <a class="xref" href="../Text/ch13s04.html" title="13.4 Reacting to Out-of-Date Information of Passive Checks">13.4 Reacting to Out-of-Date Information of Passive Checks</a>, page 295), normally using a time period specified in seconds, in case Nagios has to wait too long for a result for passive checks.</p>

    <p>The directives <strong class="userinput"><code>cfg_file</code></strong> and <strong class="userinput"><code>cfg_dir</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>) can now also handle relative paths. The base directory is the directory containing the file <strong class="userinput"><code>nagios.cfg</code></strong>.</p>

    <p>The parameter <strong class="userinput"><code>temp_path</code></strong> allows a temporary directory to be specified explicitly (in Nagios 2.x the temporary space consists of only a single file, defined in the parameter <strong class="userinput"><code>temp_file</code></strong>).<a class="indexterm" id="IDX-APP-H-2557"/><a class="indexterm" id="IDX-APP-H-2558"/></p>

    <p>Nagios 3.0 now allows multiple-line instructions in all configuration files. An instruction that is continued on the following line must end with a backslash <strong class="userinput"><code>\</code></strong>.</p>
  </div>


  <div class="sect1" title="H.13 Upgrade from Nagios 2.x to 3.0">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="upgrade_from_nagios_2.x_to_3.0"/>H.13 Upgrade from Nagios 2.x to 3.0</h1>
    </div>

    <p>If you already have a running Nagios-2.x environment, you can change over to Nagios 3.0 with little effort. The existing configuration will usually run unchanged.<a class="indexterm" id="IDX-APP-H-2559"/><a class="indexterm" id="IDX-APP-H-2560"/></p>

    <p>Nagios 3.0 is very particular when testing, however. It is quite possible that a so far undiscovered error—one tolerated or ignored by Nagios 2.0—will prevent Nagios 3.0 from starting. It is therefore a good idea to test your configuration before upgrading. To do this, you run the installation as described in <a class="xref" href="../Text/ch01s02.html" title="1.2 Compiling Source Code">1.2 Compiling Source Code</a> in page 39 with <strong class="userinput"><code>configure</code></strong> and <strong class="userinput"><code>make all</code></strong>, but without running <strong class="userinput"><code>make install</code></strong>. You will obtain an executable Nagios-3.0 binary in the <strong class="userinput"><code>base</code></strong> subdirectory, which you can use to test the existing configuration from the source code directory:</p><a id="I_programlisting_d1e60571"/>
    <pre class="programlisting">linux:src/nagios-3.0 # <span class="strong"><strong>./base/nagios -v /etc/nagios/nagios.cfg</strong></span>
...</pre>

    <p>If Nagios finds an error here, this error will prevent the start of the new Nagios version if it is not eliminated. At some points Nagios 3.0 will give warnings and information about the new features, but these do not stand in the way of a restart.</p>

    <p>Nevertheless, there are a few small details that you should attend to before Nagios 3.0 goes into operation. The parameter <strong class="userinput"><code>service_reaper_frequency</code></strong> is now called <strong class="userinput"><code>check_result_reaper_frequency</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>); it is simply renamed in <strong class="userinput"><code>nagios.cfg.aggregate_status_updates</code></strong> is removed altogether, so it is commented out in <strong class="userinput"><code>nagios.cfg</code></strong>.<a class="indexterm" id="IDX-APP-H-2561"/><a class="indexterm" id="IDX-APP-H-2562"/><a class="indexterm" id="IDX-APP-H-2563"/></p>

    <p>The macro <strong class="userinput"><code>$NOTIFICATIONNUMBER$</code></strong> was sensibly split up into a host- and a service-specific macro (<strong class="userinput"><code>$HOSTNOTIFICATIONNUMBER$</code></strong> and <strong class="userinput"><code>$SERVICEN0TI-FICATI0NNUMBER$</code></strong>). Commands and scripts that use the macro must be adjusted to ensure that they work correctly.<a class="indexterm" id="IDX-APP-H-2564"/><a class="indexterm" id="IDX-APP-H-2565"/></p>

    <p>In order to retain the maintenance intervals and comments from the no longer used files specified in <strong class="userinput"><code>downtime_file</code></strong> and <strong class="userinput"><code>comment_file</code></strong> (in this book, <strong class="userinput"><code>comments.dat</code></strong> and <strong class="userinput"><code>downtime.dat</code></strong>), you must stop Nagios, save them, and then remove the Info block at the beginning from them, since this may occur only once in the new file, specified in <strong class="userinput"><code>retention_file</code></strong>:<a class="indexterm" id="IDX-APP-H-2566"/></p><a id="I_programlisting_d1e60642"/>
    <pre class="programlisting">info {
   created=1144429286
   version=2.0
}</pre>

    <p>Then the contents of the two files are copied to the end of the retention file, which here in this book is the file <strong class="userinput"><code>/var/nagios/retention.dat</code></strong>:</p><a id="I_programlisting_d1e60649"/>
    <pre class="programlisting">linux:~ <span class="strong"><strong># /etc/init.d/nagios stop</strong></span>
linux:~ <span class="strong"><strong># cd /var/nagios</strong></span>
linux:var/nagios # cat <span class="strong"><strong>comments.dat downtime.dat &gt;&gt; retention.dat</strong></span></pre>

    <p>Now the three remaining installation steps are performed (see <a class="xref" href="../Text/ch01s02.html" title="1.2 Compiling Source Code">1.2 Compiling Source Code</a>):</p><a id="I_programlisting_d1e60664"/>
    <pre class="programlisting">linux:src/nagios-3.0 # <span class="strong"><strong>make install</strong></span>
...
linux:src/nagios-3.0 # <span class="strong"><strong>make install-init</strong></span>
...
linux:src/nagios-3.0 # <span class="strong"><strong>make install-commandmode</strong></span>
...</pre>
  </div>
</body></html>