<html><head></head><body>
  <div class="part" title="Part&#xA0;II.&#xA0;In More Detail...">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="in_more_detail"/>Part II. In More Detail...</h1>
    </div>

    <div class="partintro" id="id2437466" title="In More Detail..."/>
  </div>


  <div class="chapter" title="Chapter&#xA0;4.&#xA0;Nagios Basics">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="nagios_basics"/>Chapter 4. Nagios Basics</h1>
    </div>

    <p>The fact that a host can be reached, in itself, has little meaning if no service is running on it on which somebody or something relies. Accordingly, everything in Nagios revolves around service checks. After all, no service can run without a host. If the host computer fails, it cannot provide the desired service. Things get slightly more complicated if, for example, a router that lies between users and the system providing services is brought into play. If this fails, the desired service may still be running on the target host, but it is nevertheless no longer reachable for the user.</p>

    <p>Nagios is in a position to reproduce such dependencies and to precisely inform the administrator of the failure of an important network component, instead of flooding the administrator with irrelevant error messages concerning services that cannot be reached. An understanding of such dependencies is essential for the smooth operation of Nagios, which is why <a class="xref" href="../Text/ch04.html#taking_into_account_the_network_topology" title="4.1 Taking into Account the Network Topology">4.1 Taking into Account the Network Topology</a> will examine these dependencies and the way Nagios works in more detail.</p>

    <p>Another important item is the <span class="emphasis"><em>state</em></span> of a host or service. On the one hand Nagios allows a much finer distinction than just OK or "not OK;" on the other hand the distinction between <span class="emphasis"><em>soft state</em></span> and <span class="emphasis"><em>hard state</em></span> means that the administrator does not have to deal with short-term disruptions that have long since disappeared by the time the administrator has received the information. These states also influence the intensity of the service checks. How this functions is described in detail in <a class="xref" href="../Text/ch04s03.html" title="4.3 States of Hosts and Services">4.3 States of Hosts and Services</a>.<a class="indexterm" id="IDX-CHP-4-0307"/><a class="indexterm" id="IDX-CHP-4-0308"/></p>

    <div class="sect1" title="4.1 Taking into Account the Network Topology">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="taking_into_account_the_network_topology"/>4.1 Taking into Account the Network Topology</h1>
      </div>

      <p>How Nagios handles dependencies of hosts and services can be best illustrated with an example. <a class="xref" href="../Text/ch04.html#topology_of_an_example_network" title="Figure 4-1. Topology of an example network">Figure 4-1</a> represents a small network in which the Domain Name Service on <strong class="userinput"><code>proxy</code></strong> is to be monitored.<a class="indexterm" id="IDX-CHP-4-0309"/><a class="indexterm" id="IDX-CHP-4-0310"/><a class="indexterm" id="IDX-CHP-4-0311"/><a class="indexterm" id="IDX-CHP-4-0312"/><a class="indexterm" id="IDX-CHP-4-0313"/><a class="indexterm" id="IDX-CHP-4-0314"/><a class="indexterm" id="IDX-CHP-4-0315"/><a class="indexterm" id="IDX-CHP-4-0316"/><a class="indexterm" id="IDX-CHP-4-0317"/></p>

      <div class="figure">
        <a id="topology_of_an_example_network"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e5382"/><img alt="Topology of an example network" src="../Images/tagoreillycom20081104nostarchimages223798.png"/></div>

        <p class="title">Figure 4-1. Topology of an example network</p>
      </div>

      <p>The service check always serves as the starting point for monitoring that is regularly performed by the system. As long as the service can be reached, Nagios takes no further steps; that is, it does not perform any host checks.<sup>[<a class="footnote" href="#ftn.CHP-4-FN-1" id="CHP-4-FN-1">41</a>]</sup><a class="indexterm" id="IDX-CHP-4-0318"/></p>

      <p>For <strong class="userinput"><code>switch1</code></strong>, <strong class="userinput"><code>switch2</code></strong>, and <strong class="userinput"><code>proxy</code></strong>, such a check would be pointless anyway, because if the DNS service responds to <strong class="userinput"><code>proxy</code></strong>, then the hosts mentioned are automatically accessible.</p>

      <p>If the name service fails, however, Nagios tests the computer involved with a host check, to see whether the service or the host is causing the problem.</p>

      <p>If <strong class="userinput"><code>proxy</code></strong> cannot be reached, Nagios might test the <span class="emphasis"><em>parent</em></span> hosts entered in the configuration (<a class="xref" href="../Text/ch04.html#the_order_of_tests_performed_after_a" title="Figure 4-2. The order of tests performed after a service failure">Figure 4-2</a>). With the <strong class="userinput"><code>parents</code></strong> host parameter, the administrator has a means available to provide Nagios with information on the network topology.<a class="indexterm" id="IDX-CHP-4-0319"/></p>

      <div class="figure">
        <a id="the_order_of_tests_performed_after_a"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e5433"/><img alt="The order of tests performed after a service failure" src="../Images/tagoreillycom20081104nostarchimages223800.png"/></div>

        <p class="title">Figure 4-2. The order of tests performed after a service failure</p>
      </div>

      <p>When doing this, the administrator only enters the direct neighbor computer for each host on the same path to the Nagios server as the parent.<sup>[<a class="footnote" href="#ftn.CHP-4-FN-2" id="CHP-4-FN-2">42</a>]</sup> Hosts that are allocated in the same network segment as the Nagios server itself are defined without a parent. For the network topology from <a class="xref" href="../Text/ch04.html#topology_of_an_example_network" title="Figure 4-1. Topology of an example network">Figure 4-1</a>, the corresponding configuration (reduced to the host name and parent) appears as follows:</p><a id="I_programlisting1_d1e5449"/>
      <pre class="programlisting">define host{
    host_name      proxy
    ...
 <span class="strong"><strong>   parents switch2</strong></span>
}
define host{
    host_name      switch2
    ...
 <span class="strong"><strong>   parents switch1</strong></span>
}
define host{
    host_name      switch1
    ...
}</pre>

      <p><strong class="userinput"><code>switch1</code></strong> is located in the same network segment as the Nagios server, so it is therefore not allocated a parent computer. What belongs to a network segment is a matter of opinion. If you interpret the switches as the segment limit, as is the case here, this has the advantage of being able to more closely isolate a disruption. But you can also take a different view and interpret an IP subnetwork as a segment. Then a router would form the segment limit; in our example, <strong class="userinput"><code>proxy</code></strong> would then count in the same network as the Nagios server. However, it would no longer be possible to distinguish between a failure of <strong class="userinput"><code>proxy</code></strong> and a failure of <strong class="userinput"><code>switch1</code></strong> or <strong class="userinput"><code>switch2</code></strong>.</p>

      <div class="figure">
        <a id="classification_of_individual_network_no"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e5477"/><img alt="Classification of individual network nodes by Nagios" src="../Images/tagoreillycom20081104nostarchimages223802.png"/></div>

        <p class="title">Figure 4-3. Classification of individual network nodes by Nagios</p>
      </div>

      <p>If <strong class="userinput"><code>switch1</code></strong> in the example fails, <a class="xref" href="../Text/ch04.html#classification_of_individual_network_no" title="Figure 4-3. Classification of individual network nodes by Nagios">Figure 4-3</a> shows the sequence in which Nagios proceeds. First the system checks the DNS service on <strong class="userinput"><code>proxy</code></strong> and determines that this service is no longer reachable (1). To differentiate, it now performs a host check to determine the state of the <strong class="userinput"><code>proxy</code></strong> computer (2). Since <strong class="userinput"><code>proxy</code></strong> cannot be reached, but it has <strong class="userinput"><code>switch2</code></strong> as a parent, Nagios performs a host check on <strong class="userinput"><code>switch2</code></strong> (3). If this switch also cannot be reached, the system checks its parent, <strong class="userinput"><code>switch1</code></strong> (4).<a class="indexterm" id="IDX-CHP-4-0320"/></p>

      <p>If Nagios can establish contact with <strong class="userinput"><code>switch1</code></strong>, the cause for the failure of the DNS service on <strong class="userinput"><code>proxy</code></strong> can be isolated to <strong class="userinput"><code>switch2</code></strong>. The system accordingly specifies the states of the host: <strong class="userinput"><code>switch1</code></strong> is UP, <strong class="userinput"><code>switch2</code></strong> DOWN; <strong class="userinput"><code>proxy</code></strong>, on the other hand, is UNREACHABLE. Through a suitable configuration of the Nagios messaging system (see <a class="xref" href="../Text/ch12s03.html" title="12.3 The Message Filter">12.3 The Message Filter</a> in page 267) you can use this distinction to determine, for example, that the administrator is informed only about the host that is in the DOWN state and represents the actual problem, but not about the hosts that are dependent on the down host.</p>

      <p>In a further step, Nagios can determine other topology-specific failures in the network (so-called <span class="emphasis"><em>network outages</em></span>). <strong class="userinput"><code>proxy</code></strong> is the parent of <strong class="userinput"><code>gate</code></strong>, so <strong class="userinput"><code>gate</code></strong> is also represented as UNREACHABLE (5). <strong class="userinput"><code>gate</code></strong> in turn functions as a parent; the Internet server dependent on this is also classified as "UNREACHABLE."<a class="indexterm" id="IDX-CHP-4-0321"/></p>

      <p>This "intelligence," which distinguishes Nagios, helps the administrator all the more when more hosts and services are dependent on a failed component. For a router in the backbone, on which hundreds of hosts and services are dependent, the system informs administrators of the specific disruption, instead of sending them hundreds of error messages that are not wrong in principle, but are not really of any help in trying to eliminate the disruption.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-4-FN-1" id="ftn.CHP-4-FN-1">41</a>]</sup> <a class="xref" href="../Text/ch04s02.html" title="4.2 On-Demand Host Checks vs. Periodic Reachability Tests">4.2 On-Demand Host Checks vs. Periodic Reachability Tests</a> from page 95 deals with these <span class="emphasis"><em>on-demand checks</em></span></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-4-FN-2" id="ftn.CHP-4-FN-2">42</a>]</sup> The parameter name <strong class="userinput"><code>parents</code></strong> can be explained by the fact that there are scenarios— such as in high availability environments—in which a host has two upstream routers that guarantee the Internet connection, for example.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="4.2 On-Demand Host Checks vs. Periodic Reachability Tests">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="on-demand_host_checks_vs._periodic_reach"/>4.2 On-Demand Host Checks vs. Periodic Reachability Tests</h1>
    </div>

    <p>As a matter of principle, Nagios performs service checks at regular intervals, with the exception of passive service checks. (See <a class="xref" href="../Text/ch13s02.html" title="13.2 Passive Service Checks">13.2 Passive Service Checks</a> in page 293.) Some slightly different rules apply for host checks, which play the main role. Nagios executes host checks when it needs them—that is, <span class="emphasis"><em>on demand</em></span>—and uses them to monitor hosts where a service installed on them changes to an error state or hosts that lie in topological dependency to a failed host. A third way is via host dependencies, as described in <a class="xref" href="../Text/ch12s06.html#only_in_exceptional_cases_colon_host_de" title="12.6.2 Only in exceptional cases: host dependencies">12.6.2 Only in exceptional cases: host dependencies</a> in page 289. On-demand host checks are a core function of Nagios, as this is the only way the system can precisely inform the administrator about a failed central switch, instead of bombarding him with thousands of error messages about unreachable services.<a class="indexterm" id="IDX-CHP-4-0322"/><a class="indexterm" id="IDX-CHP-4-0323"/><a class="indexterm" id="IDX-CHP-4-0324"/><a class="indexterm" id="IDX-CHP-4-0325"/></p>

    <p>Planned host checks at regular intervals—<span class="emphasis"><em>active host checks</em></span> in Nagios terminology —play only a minor role. Although Nagios 2.0 does provide a way to do this, Nagios 2.x only performs active host checks serially, which is considered to be a real performance killer.<a class="indexterm" id="IDX-CHP-4-0326"/></p>

    <p>In Nagios 3.0, checks are executed simultaneously, eliminating the drop in performance of earlier versions. If a Nagios version prior to 3.0 is used, you would be well advised not to use active host checks. However, in Nagios 3.0 regular host checks like these can help to improve performance, because this version caches the check results, if required, for a time that can be specified. Instead of running an on-demand check, Nagios then reverts to the cached result, saving considerable time—provided that this is still sufficiently up-to-date. The new logic for host checks in Nagios 3.0 is dealt with in <a class="xref" href="../Text/aphs07.html" title="H.7 A New Logic for Host Checks">H.7 A New Logic for Host Checks</a> in page 689.</p>

    <p>The reachability of a host can also be regularly be checked in Nagios 2.x by using a trick in the shape of a ping-based service check (see <a class="xref" href="../Text/ch06s02.html" title="6.2 Reachability Test with Ping">6.2 Reachability Test with Ping</a> in page 108). Nagios performs service checks in parallel, so the serial brake in performance under Nagios 2.x is released. At the same time you will obtain further information such as the response times or possible packet losses, which provides indirect clues about the network load or possible network problems. A host check, on the other hand, also issues an OK even if many packets go missing and the network performance is catastrophic. What is involved here, as the name "host check" implies, is only reachability in principle and not the quality of the connection.</p>
  </div>


  <div class="sect1" title="4.3 States of Hosts and Services">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="states_of_hosts_and_services"/>4.3 States of Hosts and Services</h1>
    </div>

    <p>Nagios uses plugins for the host and service checks. They provide four different return values (see <a class="xref" href="../Text/ch06.html#return_values_for_nagios_plugins" title="Table 6-1. Return values for Nagios plugins">Table 6-1</a> in page 105): <strong class="userinput"><code>0</code></strong> (OK), <strong class="userinput"><code>1</code></strong> (WARNING), <strong class="userinput"><code>2</code></strong> (CRITICAL), and <strong class="userinput"><code>3</code></strong> (UNKNOWN).<a class="indexterm" id="IDX-CHP-4-0327"/><a class="indexterm" id="IDX-CHP-4-0328"/><a class="indexterm" id="IDX-CHP-4-0329"/><a class="indexterm" id="IDX-CHP-4-0330"/><a class="indexterm" id="IDX-CHP-4-0331"/><a class="indexterm" id="IDX-CHP-4-0332"/><a class="indexterm" id="IDX-CHP-4-0333"/><a class="indexterm" id="IDX-CHP-4-0334"/><a class="indexterm" id="IDX-CHP-4-0335"/><a class="indexterm" id="IDX-CHP-4-0336"/><a class="indexterm" id="IDX-CHP-4-0337"/></p>

    <p>The return value UNKNOWN means that the running of the plugin generally went wrong, perhaps because of wrong parameters. You can normally specify the situations in which the plugin issues a warning or a critical state when it is started.<a class="indexterm" id="IDX-CHP-4-0338"/></p>

    <p>Nagios determines the states of services and hosts from the return values of the plugin. The states for services are the same as the return values OK, WARNING, CRITICAL, and UNKNOWN. For the hosts the picture is slightly different: the UP state describes a reachable host, DOWN means that the computer is down, and UNREACHABLE refers to the state of nonreachability, where Nagios cannot test whether the host is available or not, because a parent is down (see <a class="xref" href="../Text/ch04.html#taking_into_account_the_network_topology" title="4.1 Taking into Account the Network Topology">4.1 Taking into Account the Network Topology</a>, page 92).<a class="indexterm" id="IDX-CHP-4-0339"/></p>

    <p>In addition to this, Nagios makes a distinction between two types of state: soft state and hard state. If a problem occurs for the first time (that is, if there was nothing wrong with the state of a service until now), then the program categorizes the new state initially as a soft state and repeats the test several times. It may be the case that the error state was just a one-off event that was eliminated a short while later. Only if the error continues to exist after multiple tests is it then categorized by Nagios as a hard state. Administrators are informed only of hard states, because messages involving short-term disruptions that disappear again immediately afterwards only add to an unnecessary flood of information.<a class="indexterm" id="IDX-CHP-4-0340"/><a class="indexterm" id="IDX-CHP-4-0341"/></p>

    <p>In our example the chronological sequence of states of a service can be illustrated quite simply. A service with the following parameters is used for this purpose:</p><a id="I_programlisting1_d1e5688"/>
    <pre class="programlisting">define service{
     host_name                              proxy
     service_description                    DNS
     ...
     <span class="strong"><strong>normal_check_interval</strong></span><sup>[<a class="footnote" href="#ftn.CHP-4-FN-3" id="CHP-4-FN-3">43</a>]</sup> <span class="strong"><strong>5</strong></span>
<span class="strong"><strong>     retry_check_interval</strong></span><sup>[<a class="footnote" href="#ftn.CHP-4-FN-4" id="CHP-4-FN-4">44</a>]</sup><span class="strong"><strong>  1</strong></span>
<span class="strong"><strong>     max_check_attempts</strong></span>              <span class="strong"><strong>5</strong></span>
     ...
}</pre>

    <p><strong class="userinput"><code>normal_check_interval</code></strong> specifies at what interval Nagios should check the corresponding service as long as the state is OK or if a hard state exists—in this case, every five minutes. <strong class="userinput"><code>retry_check_interval</code></strong> defines the interval between two service checks during a soft state—one minute in the example. If a new error occurs, then Nagios will take a closer look at the service at shorter intervals.<a class="indexterm" id="IDX-CHP-4-0345"/><a class="indexterm" id="IDX-CHP-4-0342"/><a class="indexterm" id="IDX-CHP-4-0343"/><a class="indexterm" id="IDX-CHP-4-0344"/></p>

    <p><strong class="userinput"><code>max_check_attempts</code></strong> determines how often the service check is to be repeated after an error has first occurred. If <strong class="userinput"><code>max_check_attempts</code></strong> has been reached and if the error state continues, Nagios inspects the service again at the intervals specified in <strong class="userinput"><code>normal_check_interval</code></strong>.<a class="indexterm" id="IDX-CHP-4-0346"/></p>

    <p><a class="xref" href="../Text/ch04s03.html#example_of_the_chronological_progressio" title="Figure 4-4. Example of the chronological progression of states in a monitored service">Figure 4-4</a> represents the chronological progression in graphic form. The illustration begins with an OK state (which is always a hard state). Normally Nagios will repeat the service check at five-minute intervals. After ten minutes an error occurs; the state changes to CRITICAL, but this is initially a soft state. At this point in time, Nagios has not yet issued any message.</p>

    <p>Now the system checks the service at intervals specified in <strong class="userinput"><code>retry_check_interval</code></strong>. Here this is every minute. After a total of five checks (as specified in <strong class="userinput"><code>max_check_attempts</code></strong>) with the same result, the state changes from soft to hard. Only now does Nagios inform the relevant people. The tests are now repeated at the intervals specified in <strong class="userinput"><code>normal_check_interval</code></strong>.</p>

    <div class="figure">
      <a id="example_of_the_chronological_progressio"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e5770"/><img alt="Example of the chronological progression of states in a monitored service" src="../Images/tagoreillycom20081104nostarchimages223804.png"/></div>

      <p class="title">Figure 4-4. Example of the chronological progression of states in a monitored service</p>
    </div>

    <p>In the next test the service is again available; thus its state changes from CRITICAL to OK. Since an OK state is always a hard state, this change is not subject to any tests by Nagios at shorter intervals.</p>

    <p>The transition of the service to the OK state after an error in the hard state is referred to as a <span class="emphasis"><em>hard recovery</em></span>. The system informs the administrators of this (if it is configured to do so) as well as of the change between various error-connected hard states (such as from WARNING to UNKNOWN). If the service recovers from an error soft state to the normal state (OK)—also called a <span class="emphasis"><em>soft recovery</em></span>—the administrators will not be notified.<a class="indexterm" id="IDX-CHP-4-0347"/><a class="indexterm" id="IDX-CHP-4-0348"/></p>

    <p>Even if the messaging system leaves out soft states and switches back to soft states, it will still record such states in the Web interface and in the log files. In the Web front end, soft states can be identified by the fact that the value <strong class="userinput"><code>2/5</code></strong> is listed in the column <span class="strong"><strong>Attempts</strong></span>, for example. This means that <strong class="userinput"><code>max_check_attempts</code></strong> expects <strong class="userinput"><code>five</code></strong> attempts, but only two have been carried out until now. With a hard state, <strong class="userinput"><code>max_check_attempts</code></strong> is listed twice at the corresponding position, which in the example is <strong class="userinput"><code>5/5</code></strong>.</p>

    <p>More important for the administrator in the Web interface than the distinction of whether the state is still "soft" or already "hard," is the duration of the error state in the column <span class="strong"><strong>Duration</strong></span>. From this a better judgment can be made of how large the overall problem may be.</p>

    <p>For services that are not available because the host is down, the entry 1/5 in the column <span class="strong"><strong>Attempts</strong></span> would appear, since Nagios does not repeat service checks until the entire host is reachable again. The failure of a computer can be more easily recognized by its color in the Web interface: the service overview figure in <a class="xref" href="../Text/ch03s03.html" title="3.3 Overview of the Web Interface">3.3 Overview of the Web Interface</a> marks the failed host in red; if the computer is reachable, the background remains gray.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-4-FN-3" id="ftn.CHP-4-FN-3">43</a>]</sup> As an alternative, Nagios 3.0 allows the notation known from the host definition, <strong class="userinput"><code>check_interval</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-4-FN-4" id="ftn.CHP-4-FN-4">44</a>]</sup> For Nagios 3.0 you can alternatively use <strong class="userinput"><code>retry_interval</code></strong>.</p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;5.&#xA0;Service Checks and How They Are Performed">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="service_checks_and_how_they_are_perform"/>Chapter 5. Service Checks and How They Are Performed</h1>
    </div>

    <p>To test services, Nagios makes use of external programs called <span class="emphasis"><em>plugins</em></span>. In the simplest case this involves testing an Internet service, for example, SMTP. Here the service can be addressed directly over the network, so it is sufficient to call a program locally on the Nagios server that tests the mail server on the remote host.</p>

    <p>Not everything you might want to test can be reached so easily over the network, however; there is no network protocol for checking free capacity on a hard drive, for example. Then you must either start a plugin on the remote host via a remote shell (but first this has to be installed on the remote computer), or you use other methods, such as the <span class="emphasis"><em>Simple Network Management Protocol (SNMP)</em></span>, to test the hard drive capacity.<a class="indexterm" id="IDX-CHP-5-0349"/></p>

    <p>The fact that different methods are available here does not make it any easier to get started with Nagios. For this reason, this chapter provides an overview of the common methods and attempts to develop an understanding of the underlying concepts involved. Later chapters then provide detailed configuration examples.</p>

    <div class="figure">
      <a id="nagios_allows_different_testing_methods"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject2_d1e5845"/><img alt="Nagios allows different testing methods." src="../Images/tagoreillycom20081104nostarchimages223806.png.jpg"/></div>

      <p class="title">Figure 5-1. Nagios allows different testing methods.</p>
    </div>

    <p><a class="xref" href="../Text/ch05.html#nagios_allows_different_testing_methods" title="Figure 5-1. Nagios allows different testing methods.">Figure 5-1</a> shows an overview of the various test methods supported by Nagios. The upper box with a gray background marks all the components that run directly on the Nagios server machine: this includes the server itself, as well as plugins and other auxiliary tools. This unit is in contact with five clients, which are tested in various ways. The following sections will go into somewhat more detail regarding the individual methods.</p>

    <p>In order to monitor the network service on the first client (starting from the left) marked as <strong class="userinput"><code>service</code></strong>, the Nagios server runs its "own" plugin, <strong class="userinput"><code>check_xyz</code></strong> (<a class="xref" href="../Text/ch05.html#testing_network_services_directly" title="5.1 Testing Network Services Directly">5.1 Testing Network Services Directly</a>, page 101). For the second client it starts the "middle plugin" <strong class="userinput"><code>check_by_ssh</code></strong>, in order to execute the plugin it really wants remotely on the client (<a class="xref" href="../Text/ch05s02.html" title="5.2 Running Plugins via Secure Shell on the Remote Computer">5.2 Running Plugins via Secure Shell on the Remote Computer</a>, page 102).</p>

    <p>In the third case the plugin is also executed directly on the client machine, but now Nagios uses the NRPE service, created specifically for this purpose. The query is made on the Nagios side with <strong class="userinput"><code>check_nrpe</code></strong> (<a class="xref" href="../Text/ch05s03.html" title="5.3 The Nagios Remote Plugin Executor">5.3 The Nagios Remote Plugin Executor</a>, page 102).</p>

    <p>The fourth method performs a query via SNMP. For this, the client must have an SNMP agent available (<a class="xref" href="../Text/ch11.html#introduction_to_snmp" title="11.1 Introduction to SNMP">11.1 Introduction to SNMP</a>, page 228). Various plugins are available for querying data via SNMP (<a class="xref" href="../Text/ch05s04.html" title="5.4 Monitoring via SNMP">5.4 Monitoring via SNMP</a>, page 103).</p>

    <p>These four methods represent "active" checks, because Nagios takes the initiative and triggers the test itself. The fifth method, in contrast, is passive. Here Nagios does nothing actively, but waits for incoming information that the client sends to the Nagios server with the program <strong class="userinput"><code>send_nsca</code></strong>. On the Nagios server itself the <span class="emphasis"><em>Nagios Service Check Acceptor</em></span>, NSCA, is running as a daemon that accepts the transmitted results and forwards them to the interface for external commands (see <a class="xref" href="../Text/ch05s05.html" title="5.5 The Nagios Service Check Acceptor">5.5 The Nagios Service Check Acceptor</a>, page 104).<a class="indexterm" id="IDX-CHP-5-0350"/><a class="indexterm" id="IDX-CHP-5-0351"/></p>

    <p>There are other ways of performing checks in addition to these. Usually a separate service is installed on the client, which is then queried by the Nagios server via a specialized plugin. A typical example here is NSClient/NC_Net, which can be used to monitor Windows servers (<a class="xref" href="../Text/ch20s02.html#nsclient" title="20.2.1 NSClient">20.2.1 NSClient</a>, page 464).<a class="indexterm" id="IDX-CHP-5-0352"/><a class="indexterm" id="IDX-CHP-5-0353"/></p>

    <div class="sect1" title="5.1 Testing Network Services Directly">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="testing_network_services_directly"/>5.1 Testing Network Services Directly</h1>
      </div>

      <p>Mail or Web servers can be tested very simply over the network, since the underlying protocols, SMTP and HTTP, are by definition network-capable (<a class="xref" href="../Text/ch05.html#nagios_allows_different_testing_methods" title="Figure 5-1. Nagios allows different testing methods.">Figure 5-1</a>, page 100, Client 1). Nagios can call here on a wide range of plugins, each specialized for a particular service.<a class="indexterm" id="IDX-CHP-5-0354"/><a class="indexterm" id="IDX-CHP-5-0355"/><a class="indexterm" id="IDX-CHP-5-0356"/><a class="indexterm" id="IDX-CHP-5-0357"/><a class="indexterm" id="IDX-CHP-5-0358"/><a class="indexterm" id="IDX-CHP-5-0359"/><a class="indexterm" id="IDX-CHP-5-0360"/><a class="indexterm" id="IDX-CHP-5-0361"/><a class="indexterm" id="IDX-CHP-5-0362"/><a class="indexterm" id="IDX-CHP-5-0363"/></p>

      <p>Such a specific program has advantages over a generic one. A generic plugin tests only whether the corresponding TCP or UDP port is open and whether the service is waiting there, but it does not determine whether the correct service is on the port, or whether it is active.</p>

      <p>Specific plugins adopt the network protocol and test whether the service on the port in question behaves as it is expected to. A mail server, for example, normally responds with a so-called <span class="emphasis"><em>Greeting</em></span> after a connection has been established:</p><a id="I_programlisting2_d1e5971"/>
      <pre class="programlisting">220 swobspace.de ESMTP</pre>

      <p>The important thing here is the number <strong class="userinput"><code>220</code></strong>. A number in the 200 range means OK, 220 stands for the greeting. The <strong class="userinput"><code>check_smtp</code></strong> plugin evaluates this reply. It can also simulate the initial dialog when sending mail (in addition to the greeting), as shown in <a class="xref" href="../Text/ch06s03.html" title="6.3 Monitoring Mail Servers">6.3 Monitoring Mail Servers</a> in page 113.<a class="indexterm" id="IDX-CHP-5-0364"/></p>

      <p>It behaves in a similar way with other specific plugins, such as <strong class="userinput"><code>check_http</code></strong>, which not only can handle a simple HTTP dialog, but also manipulates HTTP headers where required, checks SSL capabilities and certificates of the Web server, and even sends data to the server with the <strong class="userinput"><code>POST</code></strong> command (more on this in <a class="xref" href="../Text/ch06s04.html" title="6.4 Monitoring FTP and Web Servers">6.4 Monitoring FTP and Web Servers</a> from page 118).<a class="indexterm" id="IDX-CHP-5-0365"/></p>

      <p>The package with the Nagios plugins, which is installed separately (see <a class="xref" href="../Text/ch01s04.html" title="1.4 Installing and Testing Plugins">1.4 Installing and Testing Plugins</a> from page 43), includes specific plugins for the most important network services. If one is missing for a specific service, it is worth taking a look at the Nagios homepage<sup>[<a class="footnote" href="#ftn.CHP-5-FN-1" id="CHP-5-FN-1">45</a>]</sup> or the Exchange for Nagios Add-ons.<sup>[<a class="footnote" href="#ftn.CHP-5-FN-2" id="CHP-5-FN-2">46</a>]</sup></p>

      <p>If no suitable plugin can be found in these locations, you can use the generic plugins <strong class="userinput"><code>check_tcp</code></strong> or <strong class="userinput"><code>check_udp</code></strong>, which apart from performing a pure port test, also send data to the target port and evaluate the response. (In most cases, this only makes sense if an ASCII-based protocol is involved.) More on generic plugins in <a class="xref" href="../Text/ch06s09.html#testing_tcp_ports" title="6.7.1 Testing TCP ports">6.7.1 Testing TCP ports</a> in page 132.<a class="indexterm" id="IDX-CHP-5-0366"/><a class="indexterm" id="IDX-CHP-5-0367"/><a class="indexterm" id="IDX-CHP-5-0368"/></p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-5-FN-1" id="ftn.CHP-5-FN-1">45</a>]</sup> <a class="ulink" href="http://www.nagios.org/">http://www.nagios.org/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-5-FN-2" id="ftn.CHP-5-FN-2">46</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/">http://www.nagiosexchange.org/</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="5.2 Running Plugins via Secure Shell on the Remote Computer">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="running_plugins_via_secure_shell_on_the"/>5.2 Running Plugins via Secure Shell on the Remote Computer</h1>
    </div>

    <p>To test local resources such as hard drive capacity, the load on the swap area, the current CPU load, or whether a specific process is running, various <span class="emphasis"><em>local plugins</em></span> are available. They are called "local" because they have to be installed on the computer that is to be checked.<a class="indexterm" id="IDX-CHP-5-0369"/><a class="indexterm" id="IDX-CHP-5-0370"/><a class="indexterm" id="IDX-CHP-5-0371"/><a class="indexterm" id="IDX-CHP-5-0372"/><a class="indexterm" id="IDX-CHP-5-0373"/><a class="indexterm" id="IDX-CHP-5-0374"/><a class="indexterm" id="IDX-CHP-5-0375"/><a class="indexterm" id="IDX-CHP-5-0376"/><a class="indexterm" id="IDX-CHP-5-0377"/></p>

    <p>The Nagios server has no way to directly access such information over the network, without taking further measures. However, it can start local plugins on the remote host via a remote shell (<a class="xref" href="../Text/ch05.html#nagios_allows_different_testing_methods" title="Figure 5-1. Nagios allows different testing methods.">Figure 5-1</a>, page 100, Client 2). Only the <span class="emphasis"><em>Secure Shell</em></span>, SSH, should be considered for use here; the <span class="emphasis"><em>Remote Shell</em></span>, RSH, simply has too many security holes.<a class="indexterm" id="IDX-CHP-5-0378"/></p>

    <p>To do this, the Nagios server runs the program <strong class="userinput"><code>check_by_ssh</code></strong>, which is given the command, as an argument, to run the local plugin on the target host. For this, <strong class="userinput"><code>check_by_ssh</code></strong> needs a way of logging into the target host without a password, which can be set up with <span class="emphasis"><em>Public Key Authentication</em></span>.<a class="indexterm" id="IDX-CHP-5-0379"/></p>

    <p>From the viewpoint of the Nagios server, <strong class="userinput"><code>check_by_ssh</code></strong> is the plugin whose results are processed. It does not notice anything concerning the start of the secure shell connection and of the remote plugin—the main thing is that the reply corresponds to the Nagios standard and contains the status plus a line of comment text for the administrator. (See the introduction to <a class="xref" href="../Text/ch06.html" title="Chapter 6. Plugins for Network Services">Chapter 6</a> in page 105.)</p>

    <p>Further information on the <span class="emphasis"><em>Remote Execution</em></span> of plugins via Secure Shell is provided in <a class="xref" href="../Text/ch09.html" title="Chapter 9. Executing Plugins via SSH">Chapter 9</a> in page 205.</p>
  </div>


  <div class="sect1" title="5.3 The Nagios Remote Plugin Executor">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_nagios_remote_plugin_executor"/>5.3 The Nagios Remote Plugin Executor</h1>
    </div>

    <p>An alternative method of running plugins installed on the target computer via the secure shell is represented by the <span class="emphasis"><em>Nagios Remote Plugin Executor</em></span> (NRPE). <a class="xref" href="../Text/ch05.html#nagios_allows_different_testing_methods" title="Figure 5-1. Nagios allows different testing methods.">Figure 5-1</a> (page 100) illustrates this with the middle client.<a class="indexterm" id="IDX-CHP-5-0380"/></p>

    <p>The NRPE is installed on the target host and started via the inet daemon, which must be configured accordingly. If NRPE receives a query from the Nagios server via the (selectable) TCP port 5666, it will run the matching query for this. As with the method using the Secure Shell, the plugin that is to perform the test must be installed on the target host.</p>

    <p>So all of this is somewhat more work than using the Secure Shell, especially as SSH should be installed on almost every Unix machine, and when it is used, enables monitoring to be configured centrally on the Nagios server. The Secure Shell method requires an account with a local shell, however, thus enabling any command to be run on the target host.<sup>[<a class="footnote" href="#ftn.CHP-5-FN-3" id="CHP-5-FN-3">47</a>]</sup> The Remote Plugin Executor, on the other hand, is restricted to the commands configured.</p>

    <p>If you don't want the user <strong class="userinput"><code>nagios</code></strong> to be able to do anything more than run plugins on the target host without a password, than you are better off sticking with NRPE. The installation configuration for this is described in <a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a> in page 213.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-5-FN-3" id="ftn.CHP-5-FN-3">47</a>]</sup> The Secure Shell does allow a single command to be executed without opening a separate shell. Usually, however, you will want to test several resources, so you'll need to run more than one command.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="5.4 Monitoring via SNMP">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_via_snmp"/>5.4 Monitoring via SNMP</h1>
    </div>

    <p>With the <span class="emphasis"><em>Simple Network Management Protocol</em></span>, SNMP, local resources can be queried over the network (see also Client 4 in <a class="xref" href="../Text/ch05.html#nagios_allows_different_testing_methods" title="Figure 5-1. Nagios allows different testing methods.">Figure 5-1</a>, page 100). If an SNMP daemon is installed (NET-SNMPD is used extensively and is described in <a class="xref" href="../Text/ch11s02.html#the_net-snmp_daemon" title="11.2.2 The NET-SNMP daemon">11.2.2 The NET-SNMP daemon</a> in page 238), Nagios can use it to query local resources such as processes, hard drive, and interface load.<a class="indexterm" id="IDX-CHP-5-0381"/><a class="indexterm" id="IDX-CHP-5-0382"/><a class="indexterm" id="IDX-CHP-5-0383"/><a class="indexterm" id="IDX-CHP-5-0384"/><a class="indexterm" id="IDX-CHP-5-0385"/></p>

    <p>The advantage of SNMP lies in the fact that it is widely used. There are corresponding services for both UNIX and Windows systems, and almost all modern network components such as routers and switches can be queried via SNMP. Even uninterruptable power supplies (UPSs) and other equipment sometimes have a network connection and can provide current status information via SNMP.</p>

    <p>Apart from the standard plugin <strong class="userinput"><code>check_snmp</code></strong>, a generic SNMP plugin, there are various specialized plugins that concentrate on specific SNMP queries but are sometimes more simple to use. <strong class="userinput"><code>check_ifstatus</code></strong> and <strong class="userinput"><code>check_if-operstatus</code></strong>, for example, focus on the status of network interfaces.<a class="indexterm" id="IDX-CHP-5-0386"/><a class="indexterm" id="IDX-CHP-5-0387"/></p>

    <p>If you are grappling with SNMP for the first time, you will soon come to realize that the phrase "human-readable" did not seem to be high on the list of priorities when the protocol was defined. SNMP queries are optimized for machine processing, such as for a network monitoring tool.</p>

    <p>If you use the tool available from the vendor for its network components, SNMP will basically remain hidden to the user. But to use it with Nagios, you have to get your hands dirty and get involved with the protocol and its underlying syntax. It takes some getting used to, but it's not really as difficult as it seems at first sight.</p>

    <p>The use of SNMP is the subject of <a class="xref" href="../Text/ch11.html" title="Chapter 11. Collecting Information Relevant for Monitoring with SNMP">Chapter 11</a> (page 227); there you can learn how to configure and use an SNMP daemon for Linux and other UNIX systems.</p>
  </div>


  <div class="sect1" title="5.5 The Nagios Service Check Acceptor">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_nagios_service_check_acceptor-id1"/>5.5 The Nagios Service Check Acceptor</h1>
    </div>

    <p>The fifth method of processing the results of service checks leads to the use of the <span class="emphasis"><em>Nagios Service Check Acceptor</em></span>, NSCA. This runs as a daemon on the Nagios server and waits for incoming test results (see <a class="xref" href="../Text/ch05.html#nagios_allows_different_testing_methods" title="Figure 5-1. Nagios allows different testing methods.">Figure 5-1</a> in the right in <a class="xref" href="../Text/ch05.html" title="Chapter 5. Service Checks and How They Are Performed">Chapter 5</a>). This method is referred to as <span class="emphasis"><em>passive</em></span>, because Nagios itself does not take the initiative.<a class="indexterm" id="IDX-CHP-5-0388"/><a class="indexterm" id="IDX-CHP-5-0389"/><a class="indexterm" id="IDX-CHP-5-0390"/><a class="indexterm" id="IDX-CHP-5-0391"/><a class="indexterm" id="IDX-CHP-5-0392"/><a class="indexterm" id="IDX-CHP-5-0393"/><a class="indexterm" id="IDX-CHP-5-0394"/><a class="indexterm" id="IDX-CHP-5-0395"/><a class="indexterm" id="IDX-CHP-5-0396"/><a class="indexterm" id="IDX-CHP-5-0397"/><a class="indexterm" id="IDX-CHP-5-0398"/><a class="indexterm" id="IDX-CHP-5-0399"/><a class="indexterm" id="IDX-CHP-5-0400"/><a class="indexterm" id="IDX-CHP-5-0401"/><a class="indexterm" id="IDX-CHP-5-0402"/><a class="indexterm" id="IDX-CHP-5-0403"/><a class="indexterm" id="IDX-CHP-5-0404"/><a class="indexterm" id="IDX-CHP-5-0405"/></p>

    <p>NSCA uses the interface for external commands used by CGI scripts, among others, to send commands to Nagios. It consists of a <span class="emphasis"><em>named pipe</em></span><sup>[<a class="footnote" href="#ftn.CHP-5-FN-4" id="CHP-5-FN-4">48</a>]</sup> from which Nagios reads the external commands. With the command <strong class="userinput"><code>PROCESS_SERVICE_CHECK_RESULT</code></strong> Nagios processes test results that were determined elsewhere. The interface itself is described in more detail in <a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a> in page 292.<a class="indexterm" id="IDX-CHP-5-0408"/><a class="indexterm" id="IDX-CHP-5-0406"/><a class="indexterm" id="IDX-CHP-5-0407"/></p>

    <p>The main use for NSCA is <span class="emphasis"><em>Distributed Monitoring</em></span>. By this we mean having several different Nagios installations that send their results to a central Nagios server. The distributed Nagios servers, perhaps in different branches of a company, work as autonomous and independent Nagios instances, except that they also send the results to a head office. This does not check the decentralized networks actively, but processes the information sent from the branches in a purely passive manner.</p>

    <p>NSCA is not just restricted to distributed monitoring, however. With the program <strong class="userinput"><code>send_nsca</code></strong>, test results can be sent which were not obtained from a Nagios instance, but rather from a cron job, for example, which executes the desired service check.<a class="indexterm" id="IDX-CHP-5-0409"/><a class="indexterm" id="IDX-CHP-5-0410"/></p>

    <p>Before you use NSCA, you should consider the security aspects. Because it can be used by external programs to send information and commands to Nagios, there is a danger that it could be misused. This should not stop you from using NSCA, but rather should motivate you into paying attention to security aspects during the NSCA configuration.</p>

    <p>Further information on using NSCA, distributed monitoring and on security in general is provided in <a class="xref" href="../Text/ch14.html" title="Chapter 14. The Nagios Service Check Acceptor (NSCA)">Chapter 14</a> in page 299.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-5-FN-4" id="ftn.CHP-5-FN-4">48</a>]</sup> A named pipe is a buffer to which a process writes something and from which another process reads out the data. This buffer is given a name in the file system so that it can be specifically addressed, which is why it is called <span class="emphasis"><em>named</em></span> pipe.</p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;6.&#xA0;Plugins for Network Services">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="plugins_for_network_services"/>Chapter 6. Plugins for Network Services</h1>
    </div>

    <p>Every plugin that is used for host and service checks is a separate and independent program that can also be used independently of Nagios. The other way round, it is not so easy: in order for Nagios to use an external program, it must obey certain rules. The most important of these concerns the return status that is returned by the program. Using this, Nagios precisely evaluates the status. <a class="xref" href="../Text/ch06.html#return_values_for_nagios_plugins" title="Table 6-1. Return values for Nagios plugins">Table 6-1</a> displays the possible values.<a class="indexterm" id="IDX-CHP-6-0411"/></p>

    <div class="table">
      <a id="return_values_for_nagios_plugins"/>

      <p class="title">Table 6-1. Return values for Nagios plugins</p>

      <div class="table-contents">
        <table class="sgc-3" summary="Return values for Nagios plugins">
          <colgroup>
            <col/>
            <col/>
            <col/>
          </colgroup>

          <thead>
            <tr>
              <th class="sgc-1" valign="bottom">
                <p>Status</p>
              </th>

              <th class="sgc-1" valign="bottom">
                <p>Name</p>
              </th>

              <th class="sgc-1" valign="bottom">
                <p>Description</p>
              </th>
            </tr>
          </thead>

          <tbody>
            <tr>
              <td class="sgc-2" valign="top">
                <p>0</p>
              </td>

              <td class="sgc-2" valign="top">
                <p>OK</p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Everything in order</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>1</p>
              </td>

              <td class="sgc-2" valign="top">
                <p>WARNING</p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Warning limit has been exceeded, but critical limit not yet reached</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>2</p>
              </td>

              <td class="sgc-2" valign="top">
                <p>CRITICAL</p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Critical limit exceeded or the plugin has broken off the test after a timeout</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>3</p>
              </td>

              <td class="sgc-2" valign="top">
                <p>UNKNOWN</p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Error has occurred inside the plugin (the wrong parameter has been used, for example)<a class="indexterm" id="IDX-CHP-6-0412"/></p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <p>A plugin therefore does not distinguish by using the pattern "OK—Not OK," but instead is more highly differentiated. In order for it to be able to categorize a status as WARNING, it requires details of up to what measured value a certain event is regarded as OK, when it is seen as a WARNING, and when it is CRITICAL.</p>

    <p>For example, apart from the response time, a ping also returns the rate of packet loss. For a slow network connection (ISDN, DSL), a response time of 1000 milliseconds could be seen as a warning limit and 5000 milliseconds as critical, because that would mean that interactive working is no longer possible. If there is a high load on the network connection, occasional packet loss could also occur,<sup>[<a class="footnote" href="#ftn.CHP-6-FN-1" id="CHP-6-FN-1">49</a>]</sup> so that 20 percent packet loss can be specified as a warning limit and 60 percent as the critical limit.</p>

    <p>In all cases, the administrator decides what values shall serve as warning signs or be regarded as critical. Since all services can be individually configured, the values for each host may vary, even in the same plugin.</p>

    <p>Plugins always have a <span class="emphasis"><em>timeout</em></span>, which is usually ten seconds. This prevents the program from waiting endlessly, thus stopping a large number of plugin processes from accumulating at the Nagios host. In other ways too, a response time above 10 seconds makes little sense for many applications, since these interrupt connection attempts themselves after a certain time span, which has the same effect as the total failure of the corresponding service. Here the administrator can step in and explicitly specify a different timeout.<a class="indexterm" id="IDX-CHP-6-0413"/></p>

    <p>A further characteristic of all plugins is a text output, which Nagios shows in its overview. It is principally intended for the administrator, so it needs to be "human-readable." Nagios 2.x processes only the first line, and here the output may not exceed 300 characters. Nagios since version 3.0 no longer has this restriction. The output may have multiple lines and can be up to 8KB in length (see <a class="xref" href="../Text/ch08s05.html#multiple-line_plugin_output" title="8.5.1 Multiple-line plugin output">8.5.1 Multiple-line plugin output</a>, page 193). In the Web interface, however, Nagios 3.0 also displays only the first line. Simple plugins should therefore restrict their output to a single line, the multiple-line output is recommended only for special applications such as the <strong class="userinput"><code>plugin check_multi</code></strong> (<a class="xref" href="../Text/ch08s05.html" title="8.5 Summarizing Checks with check_multi">8.5 Summarizing Checks with check_multi</a> from page 191). The following form has become established for the text output:</p><a id="I_programlisting3_d1e6456"/>
    <pre class="programlisting"><span class="emphasis"><em>TYPE_OF_CHECK STATUS - informational text</em></span></pre>

    <p>In practice, the text output looks like this:</p><a id="I_programlisting3_d1e6461"/>
    <pre class="programlisting">SMTP OK - 0.186 sec. response time
DISK WARNING - free space: /net/eli02/a 3905 MB (7%);</pre>

    <p>The above examples are from the plugin <strong class="userinput"><code>check_smtp</code></strong> and <strong class="userinput"><code>check_disk</code></strong>, respectively. In both cases, the type of check (here <strong class="userinput"><code>SMTP</code></strong> or <strong class="userinput"><code>DISK</code></strong>) is followed by the status in text form and then the actual information. Not all plugins adhere to this recommendation in their output. Sometimes the detail of the test type is missing, and sometimes even the status is missing.<a class="indexterm" id="IDX-CHP-6-0414"/></p>

    <p>Various plugins also provide performance information, which can be evaluated and graphically represented with external programs (see <a class="xref" href="../Text/ch19.html" title="Chapter 19. Graphic Display of Performance Data">Chapter 19</a>, page 403):</p><a id="I_programlisting3_d1e6485"/>
    <pre class="programlisting">OK - 172.17.129.2: rta 97.751ms, lost 0%| rta=97.751ms;200.000;500.000;0; pl=0%;40;80;;</pre>

    <p>As can be seen here from the example of the <strong class="userinput"><code>check_icmp</code></strong> plugin, the performance data follows the text output, separated by the pipe character <strong class="userinput"><code>|</code></strong>. These data do not appear in the Web interface.<a class="indexterm" id="IDX-CHP-6-0415"/><a class="indexterm" id="IDX-CHP-6-0416"/></p>

    <p><strong class="userinput"><code>check_icmp</code></strong> here provides two values: the medium reply time, <strong class="userinput"><code><em class="replaceable"><code>r</code></em></code></strong><strong class="userinput"><code>ta</code></strong> (<span class="emphasis"><em>Real Time Answer</em></span>), in milliseconds and the packet loss rate, <strong class="userinput"><code>pl</code></strong>.<sup>[<a class="footnote" href="#ftn.CHP-6-FN-2" id="CHP-6-FN-2">50</a>]</sup> For each variable, the plugin first displays the measured value (<strong class="userinput"><code>97.751</code></strong> ms and <strong class="userinput"><code>0%</code></strong>), followed by the warning limit (200 milliseconds or 40 percent) and the critical limit (500 milliseconds or 80 percent). The fact that only the first value in the <strong class="userinput"><code><em class="replaceable"><code>r</code></em></code></strong><strong class="userinput"><code>ta</code></strong> or <strong class="userinput"><code>pl</code></strong> list is provided with a scale unit is specified by the Developer Guidelines—since the unit of a variable does not change, it only needs to be given once.</p>

    <p>To keep the installation (<a class="xref" href="../Text/ch01s04.html" title="1.4 Installing and Testing Plugins">1.4 Installing and Testing Plugins</a> from page 43) as simple as possible, there are no manual pages for the plugins. Each of these programs must maintain an online help, which is displayed with the option <strong class="userinput"><code>-h</code></strong> or <strong class="userinput"><code>--help</code></strong>. Some plugins distinguish here between a short help (<strong class="userinput"><code>-h</code></strong>) and a long one (<strong class="userinput"><code>--help</code></strong>); it is therefore recommended that you always try <strong class="userinput"><code>--help</code></strong> as well.<a class="indexterm" id="IDX-CHP-6-0417"/></p>

    <p>This chapter introduces the most important plugins from the basic distribution of the <strong class="userinput"><code>nagios-plugins</code></strong> package, version 1.4.11,<sup>[<a class="footnote" href="#ftn.CHP-6-FN-3" id="CHP-6-FN-3">51</a>]</sup> which test network services. With their help, the Nagios server queries services on other servers. The description is restricted to the functionality that is important for normal operation. If you are interested in all the options, we refer you to the integrated online help.</p>

    <div class="sect1" title="6.1 Standard Options">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="standard_options"/>6.1 Standard Options</h1>
      </div>

      <p><a class="xref" href="../Text/ch06.html#standard_options_of_plugins" title="Table 6-2. Standard options of plugins">Table 6-2</a> lists the options that are common to all plugins. The options in bold type must be known to all plugins. The key words not in bold type can be omitted by the programs, but if they are supported at all, they must be used in the sense specified.<a class="indexterm" id="IDX-CHP-6-0418"/><a class="indexterm" id="IDX-CHP-6-0419"/><a class="indexterm" id="IDX-CHP-6-0420"/><a class="indexterm" id="IDX-CHP-6-0421"/><a class="indexterm" id="IDX-CHP-6-0422"/><a class="indexterm" id="IDX-CHP-6-0423"/><a class="indexterm" id="IDX-CHP-6-0424"/><a class="indexterm" id="IDX-CHP-6-0425"/><a class="indexterm" id="IDX-CHP-6-0426"/><a class="indexterm" id="IDX-CHP-6-0427"/><a class="indexterm" id="IDX-CHP-6-0428"/></p>

      <p>If an option demands an argument, it is usually separated by spaces in the short form, but by equals signs in the long form. But for Perl or shell scripts in particular, not all authors adhere to these, so you have no option here but to take a look at the corresponding description.</p>

      <div class="table">
        <a id="standard_options_of_plugins"/>

        <p class="title">Table 6-2. Standard options of plugins</p>

        <div class="table-contents">
          <table class="sgc-3" summary="Standard options of plugins">
            <colgroup>
              <col/>
              <col/>
              <col/>
            </colgroup>

            <thead>
              <tr>
                <th class="sgc-1" valign="bottom">
                  <p>Short form</p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Long form</p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Description</p>
                </th>
              </tr>
            </thead>

            <tfoot>
              <tr>
                <th class="sgc-1" colspan="3" valign="top">
                  <p><sup>[<a class="footnote" href="#ftn.CHP-6-TFN-4" id="CHP-6-TFN-4">a</a>]</sup></p>
                </th>
              </tr>
            </tfoot>

            <tbody>
              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>-h</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>--help</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Output of the online help</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>-V</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>--version</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Output of the plugin version<a class="indexterm" id="IDX-CHP-6-0429"/></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>-v</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>--verbose</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Output of additional information-this option may be given multiple times<sup>[<a class="footnoteref" href="../Text/ch06.html#ftn.CHP-6-TFN-4">a</a>]</sup></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>-H</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>--hostname</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Host name or IP address of the target</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>-t</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>--timeout</code></strong><a class="indexterm" id="IDX-CHP-6-0430"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Timeout in seconds after which the plugin will interrupt the operation and return the CRITICAL status</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>-w</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>--warning</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Specificies the warning limit value</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>-c</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>--critical</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Specifies the critical limit value</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>−4</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>--use-ipv4</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Force IPv4 to be used</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>−6</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>--use-ipv6</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Force IPv6 to be used</p>
                </td>
              </tr>
            </tbody>

            <tbody class="footnotes">
              <tr>
                <td colspan="3">
                  <div class="footnote">
                    <p><sup>[<a class="para" href="#CHP-6-TFN-4" id="ftn.CHP-6-TFN-4">a</a>]</sup> Whether this leads to more information depends on the individual plugin ...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p>Thus it is not allowed to use <strong class="userinput"><code>-c</code></strong>, for example, for anything other than specifying a critical limit. How exactly <strong class="userinput"><code>-c</code></strong> and <span class="strong"><strong>-w</strong></span> are used may, on the other hand, vary from plugin to plugin, because sometimes an individual value may be required, at other times, multiple values (see also the explanations on the plugin <strong class="userinput"><code>check_icmp</code></strong>), described below.<a class="indexterm" id="IDX-CHP-6-0431"/><a class="indexterm" id="IDX-CHP-6-0432"/></p>

      <p>Most plugins also have the options <strong class="userinput"><code>−4</code></strong> and <strong class="userinput"><code>−6</code></strong>, which was not necessarily the case prior to version 1.4.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-1" id="ftn.CHP-6-FN-1">49</a>]</sup> ICMP packets are not re-sent; a lost packet remains lost.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-2" id="ftn.CHP-6-FN-2">50</a>]</sup> Short for <span class="emphasis"><em>packet loss</em></span>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-3" id="ftn.CHP-6-FN-3">51</a>]</sup> Versions prior to 1.4 should no longer be used. Some parameters have changed, and often performance data output is missing. In addition, plugin developers make great efforts to clean up existing errors and to continually improve the plugins.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="6.2 Reachability Test with Ping">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="reachability_test_with_ping"/>6.2 Reachability Test with Ping</h1>
    </div>

    <p>The classic reachability test in UNIX systems has always been a ping, which sends an ICMP echo request packet and waits for an ICMP echo response packet. The Nagios plugin package includes two programs that carry out this ping check: <strong class="userinput"><code>check_icmp</code></strong> and <strong class="userinput"><code>check_ping</code></strong>. Even though <strong class="userinput"><code>check_ping</code></strong> is used in the standard configuration, you should replace it with the more efficient <strong class="userinput"><code>check_icmp</code></strong>, which has been included since plugin version 1.4.<a class="indexterm" id="IDX-CHP-6-0433"/><a class="indexterm" id="IDX-CHP-6-0434"/><a class="indexterm" id="IDX-CHP-6-0435"/><a class="indexterm" id="IDX-CHP-6-0436"/><a class="indexterm" id="IDX-CHP-6-0437"/><a class="indexterm" id="IDX-CHP-6-0439"/><a class="indexterm" id="IDX-CHP-6-0440"/><a class="indexterm" id="IDX-CHP-6-0441"/><a class="indexterm" id="IDX-CHP-6-0438"/></p>

    <p>Whereas <strong class="userinput"><code>check_ping</code></strong> calls the UNIX program <strong class="userinput"><code>/bin/ping</code></strong>, which is why there are always compatibility problems with the existing <strong class="userinput"><code>ping</code></strong> version, <strong class="userinput"><code>check_icmp</code></strong> sends ICMP without any external help programs. <strong class="userinput"><code>check_icmp</code></strong> basically works more efficiently, since it does not wait for one second between individual packets, as <strong class="userinput"><code>ping</code></strong> does. In addition it evaluates ICMP error messages such as <strong class="userinput"><code>ICMP host unreachable</code></strong>, while <strong class="userinput"><code>check_ping</code></strong> discards these. <strong class="userinput"><code>check_icmp</code></strong> is backward-compatible to <strong class="userinput"><code>check_ping</code></strong>; this makes it easy to do without <strong class="userinput"><code>check_ping</code></strong> entirely and to replace it with <strong class="userinput"><code>check_icmp</code></strong>.</p>

    <p><strong class="userinput"><code>check_icmp</code></strong> measures the reply time of the ICMP packets and determines the proportion of packets that have been lost. If an error message arrives instead of the expected <strong class="userinput"><code>ICMP echo reply</code></strong>, this is evaluated immediately. Thus Nagios breaks off the test if an <strong class="userinput"><code>ICMP host unreachable</code></strong> message arrives.</p>

    <p><strong class="userinput"><code>check_icmp</code></strong> has the following options:<sup>[<a class="footnote" href="#ftn.CHP-6-FN-5" id="CHP-6-FN-5">52</a>]</sup><a class="indexterm" id="IDX-CHP-6-0442"/></p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

        <dd>
          <p>Without the host name or the IP address of the computer to be tested, <strong class="userinput"><code>check_icmp</code></strong> cannot work. With <strong class="userinput"><code>-H</code></strong>, multiple <strong class="userinput"><code><em class="replaceable"><code>host</code></em></code></strong> entries can be separated, using spaces.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>response_time,packet_loss_percent%</code></em></code></strong></span></dt>

        <dd>
          <p>This switch sets the warning limit for a warning. <strong class="userinput"><code><em class="replaceable"><code>response time</code></em></code></strong> stands here for the desired response time in milliseconds, <strong class="userinput"><code><em class="replaceable"><code>packet loss percent</code></em></code></strong> stands for the corresponding packet loss as a percentage. If you specify <strong class="userinput"><code>-w 500.0,20%</code></strong> the plugin will give a warning either if the response time is at least 500.0 milliseconds or if 20 percent or more of ICMP packets are lost.<a class="indexterm" id="IDX-CHP-6-0443"/></p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>response_time,packet_loss_percent%</code></em></code></strong></span></dt>

        <dd>
          <p>This switch specifies the critical limit in the same way as <strong class="userinput"><code>-w</code></strong> defines the warning value. The critical limit should always be larger than the warning limit.<a class="indexterm" id="IDX-CHP-6-0444"/></p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-n</code></strong> <strong class="userinput"><code><em class="replaceable"><code>packets</code></em></code></strong></span></dt>

        <dd>
          <p>With <strong class="userinput"><code><em class="replaceable"><code>packets</code></em></code></strong> you can set the number of packets that <strong class="userinput"><code>check_icmp</code></strong> should use for each test. The default is <strong class="userinput"><code>5</code></strong> packets.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-i</code></strong> <strong class="userinput"><code><em class="replaceable"><code>packet_interval</code></em></code></strong></span></dt>

        <dd>
          <p>This switch sets the time interval between two single packets that are going to the same host. The default is 80 milliseconds. It is specified as a floating point (e.g., <strong class="userinput"><code>-i 80.000</code></strong>).</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-I</code></strong> <strong class="userinput"><code><em class="replaceable"><code>target_interval</code></em></code></strong></span></dt>

        <dd>
          <p>This switch sets the time interval in which packets are sent to different hosts (provided that <strong class="userinput"><code>-H</code></strong> contains more than one host). The default is <strong class="userinput"><code>0</code></strong> milliseconds, meaning that packets to multiple hosts are sent simultaneously.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-m</code></strong> <strong class="userinput"><code><em class="replaceable"><code>number_of_reachable_hosts</code></em></code></strong></span></dt>

        <dd>
          <p>This switch specifies the number of hosts that must be reachable for the plugin to return OK. This option allows a simple cluster check:</p><a id="I_programlisting3_d1e7070"/>
          <pre class="programlisting">nagios@linux:local/libexec$ <span class="strong"><strong>./check_icmp -m 2 -H 192.168.1.9</strong></span>
\
<span class="strong"><strong>192.168.1.11 192.168.1.13</strong></span>
OK - 192.168.1.9: rta 0.098ms, lost 0% :: <span class="strong"><strong>192.168.1.11: rta nan, lost 100%</strong></span> ::
192.168.1.13: rta 0.744ms, lost 0%|192.168.1.9rta=0.09 8ms;200.000;500.000;0;
 192.168.1.9pl=0%;40;80;; 192.168.1.11rta=0. 000ms;200.000;500.000;0;
 192.168.1.11pl=100%;40;80;;
 192.168.1.13r ta=0.744ms;200.000 ;500.000;0; 192.168.1.13pl=0%;40;80;;</pre>

          <p>Of the three hosts specified, <strong class="userinput"><code>192.168.1.11</code></strong> (printed in bold) is not reachable. <strong class="userinput"><code>-m 2</code></strong> requests only two reachable hosts; therefore, the result is OK. Without this detail, the result would be CRITICAL, because one host is not reachable.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-l</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ttl</code></em></code></strong></span></dt>

        <dd>
          <p>A value larger than <strong class="userinput"><code>0</code></strong> sets the TTL (<span class="emphasis"><em>Time to Live</em></span>) of the IP packet. The default is the value <strong class="userinput"><code>0</code></strong>, which means that the plugin leaves the choice of the TTL to the operating system.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

        <dd>
          <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds have passed, the plugin interrupts the test and returns the CRITICAL status. The default is <strong class="userinput"><code>10</code></strong> seconds.<a class="indexterm" id="IDX-CHP-6-0445"/></p>
        </dd>
      </dl>
    </div>

    <p>Like the program <strong class="userinput"><code>/bin/ping</code></strong>, <strong class="userinput"><code>check_icmp</code></strong> must also run with <strong class="userinput"><code><em class="replaceable"><code>r</code></em></code></strong><strong class="userinput"><code>oot</code></strong> permissions, which is why the SUID bit is set:</p><a id="I_programlisting3_d1e7146"/>
    <pre class="programlisting">linux:~ # <span class="strong"><strong>chown root.nagios /usr/local/nagios/libexec/check_icmp</strong></span>
linux:~ # <span class="strong"><strong>chmod 4711 /usr/local/nagios/libexec/check_icmp</strong></span>
linux:~ # <span class="strong"><strong>ls -l /usr/local/nagios/libexec/check_icmp</strong></span>
-rwsr-x--x l root nagios 61326 2005-02-08 19:49 check_icmp</pre>

    <p>As a test, you should execute the plugin on the command line as the user <strong class="userinput"><code>nagios</code></strong>, since Nagios will later execute it under this account:</p><a id="I_programlisting3_d1e7162"/>
    <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>cd /usr/local/nagios/libexec</strong></span>
nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_icmp -H 192.168.1.13</strong></span> \ <span class="strong"><strong>-w 100.0,20%
 -c 200.0,40%</strong></span>

OK - 192.168.1.13: rta 0.253ms, lost 0%| rta=0.253ms;100.000;200.000;0; pl=0%;20;40;;</pre>

    <p><strong class="userinput"><code>check_icmp</code></strong> then sends the standard number of five ICMP packets on their way. Instead of an OK, it issues a WARNING as soon as the response time, averaged over all the packets, is at least 100.0 milliseconds or if 20 percent or more are lost—that is, at least one packet in five. For a CRITICAL status, the average response time must be at least 200.0 milliseconds, or at least two packets (40 percent of five) must remain unanswered.</p>

    <div class="sect2" title="6.2.1 check_icmp as a Service Check">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="check_underscore_icmp_as_a_service_check"/>6.2.1 <strong class="userinput"><code>check_icmp</code></strong> as a Service Check</h2>
      </div>

      <p>In order for <strong class="userinput"><code>check_icmp</code></strong> to be used as a service check, you need to have a suitable command object. The file <strong class="userinput"><code>checkcommands.cfg</code></strong>, with <strong class="userinput"><code>check_ping</code></strong>, already has one for the ping service. We will just replace the <strong class="userinput"><code>check_ping</code></strong> plugin in it with <strong class="userinput"><code>check_icmp</code></strong>:<a class="indexterm" id="IDX-CHP-6-0446"/><a class="indexterm" id="IDX-CHP-6-0447"/><a class="indexterm" id="IDX-CHP-6-0448"/><a class="indexterm" id="IDX-CHP-6-0449"/><a class="indexterm" id="IDX-CHP-6-0450"/></p><a id="I_programlisting3_d1e7225"/>
      <pre class="programlisting">define command{
<span class="strong"><strong>   command_name   check</strong></span>_<span class="strong"><strong>ping</strong></span>
      command_line          $USER1$/<span class="strong"><strong>check</strong></span>_<span class="strong"><strong>icmp</strong></span> -H $HOSTADDRESS$ -w $ARG1$ -c
 $ARG2$
}</pre>

      <p>The macro <strong class="userinput"><code>$HOSTADDRESS$</code></strong> provides the IP address of the <strong class="userinput"><code>address</code></strong> parameter from the host definition, and with the two freely defined macros <strong class="userinput"><code>$ARG1$</code></strong> and <strong class="userinput"><code>$ARG2$</code></strong>, parameters can be taken over from the service definition, so that warning and critical limits can be set with these.<a class="indexterm" id="IDX-CHP-6-0451"/></p>

      <p>In the service definition (an extract of it is shown here)<sup>[<a class="footnote" href="#ftn.CHP-6-FN-6" id="CHP-6-FN-6">53</a>]</sup> for the <strong class="userinput"><code>PING</code></strong> service, the <strong class="userinput"><code>check_command</code></strong> entry, in addition to the name of the command object to be executed, now needs two arguments, which are entered after the command and separated by an exclamation mark:</p><a id="I_programlisting3_d1e7273"/>
      <pre class="programlisting">define service{
    service_description   PING
    host_name             linux01
   <span class="strong"><strong> check_command      check_ping!100.0,20%!500.0,60%</strong></span>
   ...
}</pre>

      <p>From the definition of the command object, you can see that the first parameter (<strong class="userinput"><code>100.0,20%</code></strong>) defines the warning limit, and the second one (<strong class="userinput"><code>500.0,60%</code></strong>) defines the critical value.</p>
    </div>

    <div class="sect2" title="6.2.2 check_icmp as a Host Check">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="check_underscore_icmp_as_a_host_check"/>6.2.2 <strong class="userinput"><code>check_icmp</code></strong> as a Host Check</h2>
      </div>

      <p>To be able to use the plugin under the name <strong class="userinput"><code>check_host</code></strong> for host checks, a corresponding symbolic link to <strong class="userinput"><code>check_icmp</code></strong> is set:<a class="indexterm" id="IDX-CHP-6-0452"/><a class="indexterm" id="IDX-CHP-6-0453"/><a class="indexterm" id="IDX-CHP-6-0454"/><a class="indexterm" id="IDX-CHP-6-0455"/></p><a id="I_programlisting3_d1e7314"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/nagios/libexec</strong></span>
linux:nagios/libexec # <span class="strong"><strong>ln -s check_icmp check</strong></span>_<span class="strong"><strong>host</strong></span></pre>

      <p>If it is called under its new name, <strong class="userinput"><code>check_host</code></strong>, the plugin modifies its behavior somewhat: it interrupts the test after receiving the first ICMP echo reply, because a single reply packet is enough to prove that the host "is alive." The same applies if the first response to be returned is an error message such as <strong class="userinput"><code>ICMP network unreachable</code></strong> or <strong class="userinput"><code>host unreachable</code></strong>—the host is then considered to be unreachable.<a class="indexterm" id="IDX-CHP-6-0456"/></p>

      <p>Host checks are defined like every other check. The only difference is that this test is specified during the definition of the host object (and not of a service object):</p><a id="I_programlisting3_d1e7340"/>
      <pre class="programlisting">define host{
    host_name           linux01
    alias               Linux File Server
    address             192.168.1.21
    <span class="strong"><strong> check</strong></span>_<span class="strong"><strong>command   check-host-alive</strong></span>
    ...
}</pre>

      <p>The name used here, <strong class="userinput"><code>check-host-alive</code></strong>, can be freely defined and can be specified separately for each host. The definition of the command itself is made in <strong class="userinput"><code>checkcommands.cfg</code></strong>:<a class="indexterm" id="IDX-CHP-6-0457"/></p><a id="I_programlisting3_d1e7359"/>
      <pre class="programlisting">define command{
<span class="strong"><strong>   command</strong></span>_<span class="strong"><strong>name  check-host-alive</strong></span>
      command_line         $USER1$/<span class="strong"><strong>check</strong></span>_<span class="strong"><strong>host</strong></span> -H $HOSTADDRESS$
}</pre>

      <p>Host checks do not always need to be executed with <strong class="userinput"><code>check_icmp</code></strong>. You could just as well measure the refrigerator temperature or test, with the generic plugins for TCP or UDP (<strong class="userinput"><code>check_tcp</code></strong> and <strong class="userinput"><code>check_udp</code></strong>; see <a class="xref" href="../Text/ch06s09.html#testing_tcp_ports" title="6.7.1 Testing TCP ports">6.7.1 Testing TCP ports</a> from page 132), whether a specific port is open or not. The port scanner <strong class="userinput"><code>nmap</code></strong>, for example, uses TCP port 80 (HTTP).</p>

      <p>The disadvantage of such a method lies in the fact that, apart from the host itself, another application also needs to run—that is, the Web server. In addition, the test of a specific application by no means proves that the computer is no longer reachable. A ping has the great advantage that the kernel replies to ICMP echo request messages itself, so that no application needs to be running for this. You should therefore change from ping to other host check methods only if there is a good reason to do so. One example might be a firewall that filters ICMP messages, and over which the administrator has no influence, but that does let through HTTP queries on TCP port 80.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-5" id="ftn.CHP-6-FN-5">52</a>]</sup> The online help <strong class="userinput"><code>check_icmp</code></strong> -h says that it knows some of the options in the long form as well, but these have not been implemented as of today.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-6" id="ftn.CHP-6-FN-6">53</a>]</sup> Like any other object, service definitions can also be defined in a file of your choice, from which Nagios loads object definitions. For the sake of clarity it is best to choose a descriptive name for the file, such as <strong class="userinput"><code>services.cfg</code></strong>, as in our example in <a class="xref" href="../Text/ch02.html#simple_structure" title="Simple structure">Simple structure</a>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="6.3 Monitoring Mail Servers">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_mail_servers"/>6.3 Monitoring Mail Servers</h1>
    </div>

    <p>A number of plugins are also available to monitor mail servers. The mail server itself (<span class="emphasis"><em>Mail Transport Agent</em></span> (MTA)) is monitored by <strong class="userinput"><code>check_smtp</code></strong>, and the mail queue on the mail server can be checked with <strong class="userinput"><code>check_mailq</code></strong>. Since the latter test takes place locally, the plugin is described in the next chapter in <a class="xref" href="../Text/ch07s08.html" title="7.8 Regularly Checking the Status of the Mail Queue">7.8 Regularly Checking the Status of the Mail Queue</a> (page 180).<a class="indexterm" id="IDX-CHP-6-0458"/><a class="indexterm" id="IDX-CHP-6-0459"/><a class="indexterm" id="IDX-CHP-6-0460"/><a class="indexterm" id="IDX-CHP-6-0461"/><a class="indexterm" id="IDX-CHP-6-0462"/></p>

    <p>To monitor the <span class="emphasis"><em>Mail User Agent</em></span> (MUA) protocols POP3 and IMAP —including the SSL variants, POP3S and IMAPS—the plugin <strong class="userinput"><code>check_tcp</code></strong> is used. <strong class="userinput"><code>check_pop</code></strong> and so forth are symbolic links to <strong class="userinput"><code>check_tcp</code></strong>, which determines which protocol it should test by means of the name by which it is called, and makes the relevant presettings.</p>

    <div class="sect2" title="6.3.1 Monitoring SMTP with check_smtp">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="monitoring_smtp_with_check_underscore_sm"/>6.3.1 Monitoring SMTP with <strong class="userinput"><code>check_smtp</code></strong></h2>
      </div>

      <p>The SMTP monitoring plugin <strong class="userinput"><code>check_smtp</code></strong> has the following options:<a class="indexterm" id="IDX-CHP-6-0464"/><a class="indexterm" id="IDX-CHP-6-0465"/><a class="indexterm" id="IDX-CHP-6-0466"/><a class="indexterm" id="IDX-CHP-6-0463"/><a class="indexterm" id="IDX-CHP-6-0467"/><a class="indexterm" id="IDX-CHP-6-0468"/><a class="indexterm" id="IDX-CHP-6-0469"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/--host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>Details the computer on which the SMTP service should be checked.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/--port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

          <dd>
            <p><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> determines the ports, in case the mail service is not listening on the standard port 25. In this way the mail virus scanner Amavis (usually port 10024) can be monitored, for example. But this can normally be reached only from <strong class="userinput"><code>localhost</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-e</code></strong> <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> <strong class="userinput"><code>/--expect=</code></strong><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong></span></dt>

          <dd>
            <p><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> defines the text which the mail server must provide in the very first reply line. The default setting for <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> is <strong class="userinput"><code>220</code></strong>, with which the normal SMTP greeting begins, but there may be servers that have different settings. A wrong reply from the service monitored will generate a WARNING.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-f</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/--from=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>With <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> you specify a mail address that <strong class="userinput"><code>check_smtp</code></strong> then sends to the server with the "<strong class="userinput"><code>MAIL FROM:</code></strong>" command. This option is required to test a Microsoft Exchange 2000 Server.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"mail command"</code></em></code></strong> <strong class="userinput"><code>/--command=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"mail command"</code></em></code></strong></span></dt>

          <dd>
            <p>With <strong class="userinput"><code>-C</code></strong> you can send individual mail commands to the server, to extend the test slightly (see example below).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-R</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> <strong class="userinput"><code>/--response=</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p>If you send an SMTP command to the server with <strong class="userinput"><code>-C</code></strong>, you can specify the expected reply here instead of <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> (for example, <strong class="userinput"><code>250</code></strong>). A "wrong" reply triggers a WARNING.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-S / --starttls</code></strong></span></dt>

          <dd>
            <p>The connection setup during the test uses STARTTLS.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-D</code></strong> <strong class="userinput"><code><em class="replaceable"><code>duration</code></em></code></strong><strong class="userinput"><code>/--certificate=</code></strong><strong class="userinput"><code><em class="replaceable"><code>duration</code></em></code></strong></span></dt>

          <dd>
            <p>The minimum duration in days for which the certificate used for STARTTLS must still be valid.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-A / --authtype=</code></strong><strong class="userinput"><code><em class="replaceable"><code>autheutication type</code></em></code></strong></span></dt>

          <dd>
            <p>The authentication type for the SMTP-Auth procedure. The default is <strong class="userinput"><code>none</code></strong> (no authentication). The only procedure supported until now is <strong class="userinput"><code>LOGIN</code></strong>, which is based on user-password pairs.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-U / --authuser=</code></strong><strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong></span></dt>

          <dd>
            <p>The user name for the SMTP authentication, if <strong class="userinput"><code>-A LOGIN</code></strong> is used.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-P / --authpass=</code></strong><strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong></span></dt>

          <dd>
            <p>The accompanying password if <strong class="userinput"><code>-A LOGIN</code></strong> is specified.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/--warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floatii2g_point_dec</code></em></code></strong></span></dt>

          <dd>
            <p>If the server takes longer than <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> seconds for the answer, <strong class="userinput"><code>check_smtp</code></strong> issues a WARNING.<a class="indexterm" id="IDX-CHP-6-0470"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/--critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

          <dd>
            <p>Like <strong class="userinput"><code>-w</code></strong>, except that <strong class="userinput"><code>check_smtp</code></strong> issues a CRITICAL after <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> seconds.</p>
          </dd>
        </dl>
      </div>

      <p>In the simplest case, you just enter the name or the IP address of the mail server:</p><a id="I_programlisting3_d1e7752"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_smtp -H smtp01</strong></span>
SMTP OK - 0,008 sec. response time|time=0,008157s;;;0,000000</pre>

      <p>The plugin <strong class="userinput"><code>check_smtp</code></strong> sends back a <strong class="userinput"><code>HELO</code></strong> <strong class="userinput"><code><em class="replaceable"><code>hostname</code></em></code></strong> after receiving the SMTP greeting, which should contain the reply <strong class="userinput"><code>250</code></strong>.</p>

      <p>The definition of the corresponding command object in this case appears as follows:</p><a id="I_programlisting3_d1e7774"/>
      <pre class="programlisting">define command{
    command_name<span class="strong"><strong>   check_smtp</strong></span>
    command_line      $USER1$/<span class="strong"><strong>check_smtp</strong></span> -H $HOSTADDRESS$
}</pre>

      <p>To check the host object <strong class="userinput"><code>linux01</code></strong> with this, it requires the following service definition:</p><a id="I_programlisting3_d1e7787"/>
      <pre class="programlisting">define service{
     service_description     SMTP
     host_name               linux01
     <span class="strong"><strong>  check_command    check_smtp</strong></span>
     ...
}</pre>

      <p>Using the <strong class="userinput"><code>-C</code></strong> option, the SMTP dialog can be extended even further, roughly until <strong class="userinput"><code>RCPT TO</code></strong>:<a class="indexterm" id="IDX-CHP-6-0471"/></p><a id="I_programlisting3_d1e7804"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_smtp -H localhost</strong></span> \
<span class="strong"><strong>   -C "MAIL FROM: &lt;bla@gna.dot&gt;" -R "250"</strong></span> \
<span class="strong"><strong>   -C "RCPT TO: &lt;bla@gna.dot&gt;" -R "554"</strong></span>
SMTP OK - 0,019 sec. response time|time=0,018553s;;;0,000000</pre>

      <p>Such a test could be used, for example, to check the configuration of the restrictions built into the mail server (invalid domains, spam defenses, and more). The example checks whether the mail server refuses to accept a mail containing the invalid domain <strong class="userinput"><code>gna.dot</code></strong> (that is, in the <strong class="userinput"><code>RCPT TO</code></strong>:). The test runs successfully, therefore, if the server rejects the mail with <strong class="userinput"><code>554</code></strong>. What <strong class="userinput"><code>check_smtp</code></strong> does here corresponds to the following mail dialog reproduced by <strong class="userinput"><code>telnet</code></strong>:</p><a id="I_programlisting3_d1e7832"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>telnet localhost 25</strong></span>
Trying 127.0.0.1...
Connected to loca1host.
Escape character is '^]'.
220 swobspace.de ESMTP
<span class="strong"><strong>helo swobspace</strong></span>
250 swobspace.de
<span class="strong"><strong>MAIL FROM: &lt;bla@gna.dot&gt;</strong></span>
250 Ok
<span class="strong"><strong>RCPT TO: &lt;bla@gna.dot&gt;</strong></span>
554 &lt;bla@gna.dot&gt;: Recipient address rejected: test not existing top lev
el domain
...</pre>

      <p>If the mail server did not reject the recipient domain because of the configuration error, the reply would no longer contain <strong class="userinput"><code>554</code></strong> and the plugin would issue a WARNING.</p>

      <p>In general you should remember, when checking restrictions, that the server rejects mails only after a <strong class="userinput"><code>RCPT TO:</code></strong>, depending on the configuration, even if the reason for this (a certain client IP address, the server name in <strong class="userinput"><code>HELO</code></strong> or the sender address in <strong class="userinput"><code>MAIL FROM:</code></strong>) has already occurred before this.</p>
    </div>

    <div class="sect2" title="6.3.2 POP and IMAP">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="pop_and_imap"/>6.3.2 POP and IMAP</h2>
      </div>

      <p>Four pseudo plugins are available for testing the POP and IMAP protocols: <strong class="userinput"><code>check_pop</code></strong>, <strong class="userinput"><code>check_spop</code></strong>, <strong class="userinput"><code>check_imap</code></strong>, and <strong class="userinput"><code>check_simap</code></strong>. They are called pseudo plugins because they are just symbolic links to the plugin <strong class="userinput"><code>check_tcp</code></strong>. By means of the name with which the plugin is called, this determines its intended use and correspondingly sets the required parameters, such as the standard port, whether something should be sent to the server, the expected response, and how the connection should be terminated. The options are the same for all plugins, which is why we shall introduce them all together:<a class="indexterm" id="IDX-CHP-6-0472"/><a class="indexterm" id="IDX-CHP-6-0473"/><a class="indexterm" id="IDX-CHP-6-0474"/><a class="indexterm" id="IDX-CHP-6-0475"/><a class="indexterm" id="IDX-CHP-6-0476"/><a class="indexterm" id="IDX-CHP-6-0477"/><a class="indexterm" id="IDX-CHP-6-0478"/><a class="indexterm" id="IDX-CHP-6-0479"/><a class="indexterm" id="IDX-CHP-6-0480"/><a class="indexterm" id="IDX-CHP-6-0481"/><a class="indexterm" id="IDX-CHP-6-0485"/><a class="indexterm" id="IDX-CHP-6-0482"/><a class="indexterm" id="IDX-CHP-6-0486"/><a class="indexterm" id="IDX-CHP-6-0483"/><a class="indexterm" id="IDX-CHP-6-0484"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/--host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>This specifies the computer on which POP or IMAP is to be checked.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/--port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

          <dd>
            <p><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> specifies an alternative port if the plugin is intended to monitor a different port from the standard one: 110 for <strong class="userinput"><code>check_pop</code></strong>, 995 for <strong class="userinput"><code>check_spop</code></strong>, 143 for <strong class="userinput"><code>check_imap</code></strong>, and 993 for <strong class="userinput"><code>check_simap</code></strong> (see also <strong class="userinput"><code>/etc/services</code></strong>).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/--warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

          <dd>
            <p>The placeholder <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> is replaced by the warning limit for the response time in seconds, specified as a floating point decimal.<a class="indexterm" id="IDX-CHP-6-0487"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/--critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

          <dd>
            <p>This sets the critical limit for the response time in seconds (see <strong class="userinput"><code>-w</code></strong>).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> <strong class="userinput"><code>/--send=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p>This string is to be sent to the server. In the default setting, none of the four plugins uses this option.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-e</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> <strong class="userinput"><code>/--expect=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> specifies a text string, which must be contained in the response of the server. The default is +<strong class="userinput"><code>0K</code></strong> for (S) POP and <strong class="userinput"><code>* OK</code></strong> for (S)IMAP. This option may be given multiple times to search for different partial strings in the answer.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-E / --escape</code></strong></span></dt>

          <dd>
            <p>This switch allows the use of the escape sequences <strong class="userinput"><code>\n</code></strong>, <strong class="userinput"><code>\r</code></strong>, <strong class="userinput"><code>\t</code></strong>, or simply <strong class="userinput"><code>\</code></strong> in the details for <strong class="userinput"><code>-s</code></strong> and <strong class="userinput"><code>-e</code></strong>. In all cases <strong class="userinput"><code>-E</code></strong> must be placed in front of the options <strong class="userinput"><code>-s</code></strong> and <strong class="userinput"><code>-e</code></strong> on which it is to have an influence.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-A / --all</code></strong></span></dt>

          <dd>
            <p>If you specify several reply strings with <strong class="userinput"><code>-e</code></strong>, the plugin with <strong class="userinput"><code>-A</code></strong> will only return OK if all required reply strings were found. Without this option, one string out of several sought is enough to trigger a positive acknowledgment.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-M</code></strong> <strong class="userinput"><code><em class="replaceable"><code>return value</code></em></code></strong> <strong class="userinput"><code>/ -mismatch=</code></strong><strong class="userinput"><code><em class="replaceable"><code>return value</code></em></code></strong></span></dt>

          <dd>
            <p>How should the plugin react if a returned string does not match the statement in <strong class="userinput"><code>-e</code></strong>? The default is <strong class="userinput"><code>warn</code></strong>, which means there is a WARNING. With <strong class="userinput"><code>crit</code></strong> a false return can be assigned as CRITICAL, with <strong class="userinput"><code>ok</code></strong> as OK.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-q</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> <strong class="userinput"><code>/--quit=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p>This is the string with which the service is requested to end the connection. For (S)POP this is <strong class="userinput"><code>QUIT\r\n</code></strong>, for (S)IMAP, <strong class="userinput"><code>al L0G0UT\r\n</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-S / --ssl</code></strong></span></dt>

          <dd>
            <p>The connection set up during the test uses SSL/TLS for the connection. If you call the plugins <strong class="userinput"><code>check_simap</code></strong> and <strong class="userinput"><code>check_spop</code></strong>, this option is set automatically. In order for a connection to be established, the server must support SSL/TLS directly on the addressed port.</p>

            <p>STARTTLS<sup>[<a class="footnote" href="#ftn.CHP-6-FN-7" id="CHP-6-FN-7">54</a>]</sup> on its own does not support the plugin. With<a class="indexterm" id="IDX-CHP-6-0488"/></p><a id="I_programlisting3_d1e8221"/>
            <pre class="programlisting">./check_imap -H <span class="emphasis"><em>computer</em></span> -s "a1 CAPABILITY" -e "STARTTLS"</pre>

            <p>you can at least check whether the server provides this method: the plugin returns OK if the reply string contains STARTTLS, or WARNING if it doesn't. But this is not really a genuine test of whether STARTTLS really does work properly.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-D</code></strong> <strong class="userinput"><code><em class="replaceable"><code>duration</code></em></code></strong> <strong class="userinput"><code>/--certificate=</code></strong><strong class="userinput"><code><em class="replaceable"><code>duration</code></em></code></strong></span></dt>

          <dd>
            <p>This switch specifies the number of days the certificate used for STARTTLS will remain valid.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-r</code></strong> <strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong> <strong class="userinput"><code>/ -refuse=</code></strong><strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong></span></dt>

          <dd>
            <p>This switch specifies which value the plugin returns if the server rejects the TCP connection. The default is <strong class="userinput"><code>crit</code></strong> (CRITICAL). The value <strong class="userinput"><code>ok</code></strong> can be set in case no POP or IMAP service is available. The third possible value, <strong class="userinput"><code>warn</code></strong>, triggers a WARNING.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-m</code></strong> <strong class="userinput"><code><em class="replaceable"><code>bytes</code></em></code></strong> <strong class="userinput"><code>/--maxbytes=</code></strong><strong class="userinput"><code><em class="replaceable"><code>bytes</code></em></code></strong></span></dt>

          <dd>
            <p>This switch advices the plugin to close the TCP connection when the specified data amount (in bytes) has been received.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-d</code></strong> <strong class="userinput"><code><em class="replaceable"><code>seconds</code></em></code></strong> <strong class="userinput"><code>/--delay=</code></strong><strong class="userinput"><code><em class="replaceable"><code>seconds</code></em></code></strong></span></dt>

          <dd>
            <p>This switch waits for the specified time after a string has been sent to the server before the answer is searched for the string specified with <strong class="userinput"><code>-e</code></strong>.</p>
          </dd>
        </dl>
      </div>

      <p>Of course, all the other options of the generic plugin <strong class="userinput"><code>check_tcp</code></strong> (described in <a class="xref" href="../Text/ch06s09.html#testing_tcp_ports" title="6.7.1 Testing TCP ports">6.7.1 Testing TCP ports</a> in page 132) can be used with <strong class="userinput"><code>check_pop</code></strong>, <strong class="userinput"><code>check_spop</code></strong>, <strong class="userinput"><code>check_imap</code></strong>, and <strong class="userinput"><code>check_simap</code></strong>.</p>

      <p>In the simplest case you just need to give the name of the computer to be tested (here: <strong class="userinput"><code>mailsrv</code></strong>) or the IP address:</p><a id="I_programlisting3_d1e8334"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_pop -H mailsrv</strong></span>
POP OK - 0.064 second response time on port 110 [+OK eli11 Cyrus POP3
v2.1.16 server ready &lt;1481963980.1118597146@eli11&gt;]
|time=0.064228s;0.000000;0.000000;0.000000;10.000000</pre>

      <p>In each case the plugin provides just one line of output, which has been line-wrapped here for layout reasons. The details after the pipe character <strong class="userinput"><code>|</code></strong> in turn involve performance data not shown by the Web interface. The structure of performance data and how they are processed are described in more detail in <a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a> in page 404.<a class="indexterm" id="IDX-CHP-6-0489"/></p>

      <p>Implemented as a command object, the above <strong class="userinput"><code>check_pop</code></strong> command looks like this:</p><a id="I_programlisting3_d1e8354"/>
      <pre class="programlisting">define command{
    command_name<span class="strong"><strong>  check_pop</strong></span>
    command_line     $USER1$/<span class="strong"><strong>check_pop</strong></span> -H $HOSTADDRESS$
}</pre>

      <p>As a service for the machine <strong class="userinput"><code>linuxO1</code></strong>, it is integrated like this:</p><a id="I_programlisting3_d1e8367"/>
      <pre class="programlisting">define service{
    service_description     POP
    host_name               linux01
    <span class="strong"><strong>    check_command    check_pop</strong></span>
     ...
}</pre>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-7" id="ftn.CHP-6-FN-7">54</a>]</sup> STARTTLS refers to the capacity of a service to set up an SSL/TLS-secured connection after a normal connection has been established—for example, for POP3, via TCP port 110. Every service that implements STARTTLS must have a suitable command available to do this. With POP3 this is called <strong class="userinput"><code>STLS</code></strong> (see RFC 2595). STARTTLS is used with SMTP, LDAP, IMAP, and POP3, among others, but not every server supports this method automatically.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="6.4 Monitoring FTP and Web Servers">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_ftp_and_web_servers"/>6.4 Monitoring FTP and Web Servers</h1>
    </div>

    <p>The Nagios plugin package provides two plugins to monitor the classic Internet services FTP and HTTP (including HTTPS): <strong class="userinput"><code>check_ftp</code></strong> and <strong class="userinput"><code>check_ http</code></strong>. When many users from a network are using Web services, a proxy is usually used in addition. To monitor this, you could also use <strong class="userinput"><code>check_http</code></strong>, but with the <strong class="userinput"><code>check_squid.pl</code></strong> plugin, The Nagios Exchange has a better tool available.<a class="indexterm" id="IDX-CHP-6-0490"/><a class="indexterm" id="IDX-CHP-6-0491"/></p>

    <div class="sect2" title="6.4.1 FTP services">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="ftp_services"/>6.4.1 FTP services</h2>
      </div>

      <p>The plugin <strong class="userinput"><code>check_ftp</code></strong> is, like the plugins for POP and IMAP, a symbolic link to the generic plugin <strong class="userinput"><code>check_tcp</code></strong>, so that it also has the same options. They are described in detail in <a class="xref" href="../Text/ch06s09.html#testing_tcp_ports" title="6.7.1 Testing TCP ports">6.7.1 Testing TCP ports</a> in page 132.<a class="indexterm" id="IDX-CHP-6-0492"/><a class="indexterm" id="IDX-CHP-6-0493"/></p>

      <p>The generic plugin sets the following parameters if it is called with the name <strong class="userinput"><code>check_ftp</code></strong>:</p><a id="I_programlisting3_d1e8423"/>
      <pre class="programlisting">--port=21 --expect="220" --quit="QUIT\r\n"</pre>

      <p>It does not send a string to the server, but it expects a reply containing the text <strong class="userinput"><code>220</code></strong>, and it ends the connection to the standard port 21 cleanly with <strong class="userinput"><code>QUIT\r\n</code></strong>.</p>

      <p>On the command line there is, as usual, a one-line reply (with line breaks for the printed version) with performance data after the <strong class="userinput"><code>|</code></strong> character that is not shown by the Web interface, (see <a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a> from page 404) for an explanation of this:</p><a id="I_programlisting3_d1e8440"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_ftp -H ftp.gwdg.de</strong></span>
FTP OK - 0,130 second response time on port 21 [220-Gesellschaft fuer wi
ssenschaftliche Datenverarbeitung mbH Goettingen] |time=0,130300s;0,0000
00;0,000000;0,000000;10,000000</pre>

      <p>As a command object, this call appears as follows:</p><a id="I_programlisting3_d1e8447"/>
      <pre class="programlisting">define command{
     command_name<span class="strong"><strong>   check_ftp</strong></span>
     command_line   $USER1$/<span class="strong"><strong>check_ftp</strong></span> -H $HOSTADDRESS$
}</pre>

      <p>A corresponding service definition looks like this:</p><a id="I_programlisting3_d1e8457"/>
      <pre class="programlisting">define service{
    service_description    FTP
    host_name              linux01
<span class="strong"><strong>    check_command   check_ftp</strong></span>
    ...
}</pre>
    </div>

    <div class="sect2" title="6.4.2 Web server control via HTTP">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="web_server_control_via_http"/>6.4.2 Web server control via HTTP</h2>
      </div>

      <p>The <strong class="userinput"><code>check_http</code></strong> plugin for HTTP and HTTPS checks contains a large number of very useful options, depending on the intended use:<a class="indexterm" id="IDX-CHP-6-0494"/><a class="indexterm" id="IDX-CHP-6-0495"/><a class="indexterm" id="IDX-CHP-6-0496"/><a class="indexterm" id="IDX-CHP-6-0497"/><a class="indexterm" id="IDX-CHP-6-0498"/><a class="indexterm" id="IDX-CHP-6-0499"/><a class="indexterm" id="IDX-CHP-6-0500"/><a class="indexterm" id="IDX-CHP-6-0501"/><a class="indexterm" id="IDX-CHP-6-0502"/><a class="indexterm" id="IDX-CHP-6-0503"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>virtual_host</code></em></code></strong> <strong class="userinput"><code>/--hostn.ame=</code></strong><strong class="userinput"><code><em class="replaceable"><code>virtual_host</code></em></code></strong></span></dt>

          <dd>
            <p>This switch specifies the virtual host name that the plugin transmits in the HTTP header in the <strong class="userinput"><code>host:</code></strong> field:</p><a id="I_programlisting3_d1e8541"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_http -H www.swobspace.de</strong></span>
HTTP OK HTTP/1.1 200 OK - 2553 bytes in 0.154 seconds</pre>

            <p>If you don't want <strong class="userinput"><code>check_http</code></strong> to send this, you can use <strong class="userinput"><code>-I</code></strong> instead.<a class="indexterm" id="IDX-CHP-6-0504"/><a class="indexterm" id="IDX-CHP-6-0505"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-I</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ip-address</code></em></code></strong> <strong class="userinput"><code>/--IP-address=</code></strong><strong class="userinput"><code><em class="replaceable"><code>ip-address</code></em></code></strong></span></dt>

          <dd>
            <p>Instead of <strong class="userinput"><code><em class="replaceable"><code>ip</code></em></code></strong>, the host name or IP address of the target computer is given. For systems with several virtual environments, you will land in the default environment, and for most Web hosting providers you will then receive an error message:</p><a id="I_programlisting3_d1e8588"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_http -I www.swobspace.de</strong></span>
HTTP WARNING: HTTP/1.1 404 Not Found</pre>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code><em class="replaceable"><code>url_or_path</code></em></code></strong> <strong class="userinput"><code>/--url=</code></strong><strong class="userinput"><code><em class="replaceable"><code>url_or_path</code></em></code></strong></span></dt>

          <dd>
            <p>The argument is the URL to be sent to the Web server. If the design document lies on the server to be tested, it is sufficient to enter the directory path, starting from the <span class="emphasis"><em>document root</em></span> of the server:</p><a id="I_programlisting3_d1e8613"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_http -H linux.swobspace.net \</strong></span>
<span class="strong"><strong> -u /mailinglisten/index.html</strong></span>
HTTP OK HTTP/1.1 200 OK - 5858 bytes in 3.461 seconds</pre>

            <p>If this option is not specified, the plugin asks for the document root<strong class="userinput"><code>/</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/--port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

          <dd>
            <p>This is an alternative port specification for HTTP.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/--warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floati.ng_point_dec</code></em></code></strong></span></dt>

          <dd>
            <p>This is the warning limit for the response time of the Web server in seconds.<a class="indexterm" id="IDX-CHP-6-0506"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/--critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

          <dd>
            <p>This is the critical limit for the response time of the Web server in seconds.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> <strong class="userinput"><code>/--timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

          <dd>
            <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds have expired, the plugin interrupts the test and returns the CRITICAL status. The default is <strong class="userinput"><code>10</code></strong> seconds.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-L</code></strong> <strong class="userinput"><code>/--link-url</code></strong></span></dt>

          <dd>
            <p>This option ensures that the virtual host in the text output appears on the Web interface as a link.</p><a id="I_programlisting3_d1e8716"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_http -H www.swobspace.de -L</strong></span>
&lt;A HREF="http://www.swobspace.de:80/" target="_blank"&gt; HTTP OK HTT P/1.1 200 OK
 - 2553 bytes in 0.156 seconds&lt;/A&gt;</pre>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-a</code></strong> <strong class="userinput"><code><em class="replaceable"><code>username : password</code></em></code></strong> <strong class="userinput"><code>/--authorization=</code></strong><strong class="userinput"><code><em class="replaceable"><code>username : password</code></em></code></strong></span></dt>

          <dd>
            <p>If the Web server requires authentication, this option can be used to specify a user-password pair. The plugin can only handle <span class="emphasis"><em>basic authentication</em></span>, however; <span class="emphasis"><em>digest authentication</em></span> is currently not yet possible.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-f</code></strong> <strong class="userinput"><code><em class="replaceable"><code>behavior</code></em></code></strong> <strong class="userinput"><code>/--onredirect=</code></strong><strong class="userinput"><code><em class="replaceable"><code>behavior</code></em></code></strong></span></dt>

          <dd>
            <p>If the Web server sends a redirect as a reply to the requested Web page, the <strong class="userinput"><code><em class="replaceable"><code>behavior</code></em></code></strong> parameter influences the behavior of the plugin. The values <strong class="userinput"><code>ok</code></strong>, <strong class="userinput"><code>warning</code></strong>, <strong class="userinput"><code>critical</code></strong> and <strong class="userinput"><code>follow</code></strong> are allowed. The default is <strong class="userinput"><code>ok</code></strong>, so the plugin will simply return an OK, without following the redirect. The plugin can be made to follow the redirect with <strong class="userinput"><code>follow</code></strong>. <strong class="userinput"><code>warning</code></strong> and <strong class="userinput"><code>critical</code></strong> with a redirect return the <strong class="userinput"><code>WARNING</code></strong> or <strong class="userinput"><code>CRITICAL</code></strong> status.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-e</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> <strong class="userinput"><code>/--expect=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p>This is the text that the server response should contain in its first status line. If this option is not specified, the plugin expects <strong class="userinput"><code>HTTP/1</code></strong>. as a <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> <strong class="userinput"><code>/--string=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p>This is the search text that the plugin looks for in the contents of the page returned, not in the header.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-r</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"regexp"</code></em></code></strong> <strong class="userinput"><code>/--regex=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"regexp"</code></em></code></strong></span></dt>

          <dd>
            <p>This is a regular expression<sup>[<a class="footnote" href="#ftn.CHP-6-FN-8" id="CHP-6-FN-8">55</a>]</sup> for which the plugin should search in the page returned.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-R</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"regexp"</code></em></code></strong> <strong class="userinput"><code>/--eregi=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"regexp"</code></em></code></strong></span></dt>

          <dd>
            <p>This switch works like <strong class="userinput"><code><em class="replaceable"><code>-r</code></em></code></strong>, except that the plugin now makes no distinction between upper and lower case.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--invert-regex</code></strong></span></dt>

          <dd>
            <p>This inverts the search with <strong class="userinput"><code><em class="replaceable"><code>-r</code></em></code></strong> or <strong class="userinput"><code>-R</code></strong>. The plugin now returns CRITICAL instead of OK if there is a match.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-l</code></strong> <strong class="userinput"><code>/--linespan</code></strong></span></dt>

          <dd>
            <p>Normally the search for regular expressions is restricted to one line with <strong class="userinput"><code><em class="replaceable"><code>-r</code></em></code></strong> and <strong class="userinput"><code>-R</code></strong>. If <strong class="userinput"><code>−l</code></strong> precedes these options, the search pattern can refer to text covering multiple lines.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-P</code></strong> <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> <strong class="userinput"><code>/--post=</code></strong><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong></span></dt>

          <dd>
            <p>Use this switch for data that you would like to send via a POST command to the Web server. The characters in <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> must be encoded in accordance with RFC 1738:<sup>[<a class="footnote" href="#ftn.CHP-6-FN-9" id="CHP-6-FN-9">56</a>]</sup> only the letters A to Z (upper and lower case), the special characters <strong class="userinput"><code>$-_. + !*' ()</code></strong>, and the numbers 0 to 9 are allowed.</p>

            <p>To send the text <span class="strong"><strong>Übung für Anfänger</strong></span> ("Exercise For Beginners" in German) as a <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong>, umlauts and spaces must be encoded before they are sent:<span class="strong"><strong>%DCbung%20f%FCr%20Anf%E4nger</strong></span>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-T</code></strong> <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> <strong class="userinput"><code>/ -content-type=</code></strong><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong></span></dt>

          <dd>
            <p>This specifies the <strong class="userinput"><code>content type</code></strong> of the header, if you are sending something with <strong class="userinput"><code>--post</code></strong>, for example, to the server. The default is <strong class="userinput"><code>application/x-www-form-urlencoded</code></strong>. A list of all content types is given in the file <strong class="userinput"><code>/etc/mime.types</code></strong>, and a description of the format can be found in RFC2045.<sup>[<a class="footnote" href="#ftn.CHP-6-FN-10" id="CHP-6-FN-10">57</a>]</sup></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-m</code></strong> <strong class="userinput"><code><em class="replaceable"><code>min_bytes:max_bytes</code></em></code></strong> <strong class="userinput"><code>/--pagesize=</code></strong><strong class="userinput"><code><em class="replaceable"><code>min_bytes:max_bytes</code></em></code></strong></span></dt>

          <dd>
            <p>This parameter defines that the page returned must be at least <strong class="userinput"><code><em class="replaceable"><code>min_bytes</code></em></code></strong> in size, otherwise the plugin will issue a WARNING. You can optionally use an upper limit as well—separated by a colon—to specify the size of the Web page. Now <strong class="userinput"><code>check_http</code></strong> will also give a warning if the page returned is larger than <strong class="userinput"><code><em class="replaceable"><code>max_bytes</code></em></code></strong>. In the following example, everything is in order if the page returned is at least 500 bytes and at most 2000 bytes in size:</p><a id="I_programlisting3_d1e9018"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_http -H www.swobspace.de</strong></span> \
<span class="strong"><strong>    m 500:2000</strong></span>
HTTP WARNING: page size 2802 too large|size=2802B;500;0;0</pre>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-N</code></strong> <strong class="userinput"><code>/--no-body</code></strong></span></dt>

          <dd>
            <p>With this option the plugin does not wait for the server to return the complete page contents, but just reads in the header data. To do this it uses the HTTP commands <strong class="userinput"><code>GET</code></strong> or <strong class="userinput"><code>POST</code></strong>, and not <strong class="userinput"><code>HEAD</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-M</code></strong> <strong class="userinput"><code><em class="replaceable"><code>seconds</code></em></code></strong> <strong class="userinput"><code>/--max-age=</code></strong><strong class="userinput"><code><em class="replaceable"><code>seconds</code></em></code></strong></span></dt>

          <dd>
            <p>If the returned document is older than the date specified in the header (HTTP header field <strong class="userinput"><code>Date:</code></strong>), the plugin will generate a WARNING. Instead of seconds (without additional details) you can also use explicit units such as <strong class="userinput"><code>5m</code></strong> (five minutes), <strong class="userinput"><code>12h</code></strong> (twelve hours), or <strong class="userinput"><code>3d</code></strong> (three days); combinations are not allowed.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-A</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> <strong class="userinput"><code>/--useragent=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p>This parameter explicitly specifies a user agent in the HTTP header, such as <strong class="userinput"><code>-A "Lynx/1.12"</code></strong> for Lynx version 1.12. Normally the plugin does not send this field.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-k</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> <strong class="userinput"><code>/--header=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p>This specifies any HTTP header tags. If several tags are to be specified, they must be separated by a semicolon, as in the following example:</p><a id="I_programlisting3_d1e9112"/>
            <pre class="programlisting">-k "Accept-Charset: iso-8859-1; Accept-Encoding: compress, gzip;"</pre>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-S</code></strong> <strong class="userinput"><code>/--ssl</code></strong></span></dt>

          <dd>
            <p>This forces an SSL connection to be used:</p><a id="I_programlisting3_d1e9124"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_http --ssl -H \</strong></span>
<span class="strong"><strong>    www.verisign.com</strong></span>
HTTP OK HTTP/1.1 200 OK - 33836 bytes in 1.911 seconds</pre>

            <p>The host <a class="ulink" href="http://www.verisign.com">www.verisign.com</a> allows an SSL connection. If this is not the case, the server returns an error and the plugin returns the value CRITICAL:<sup>[<a class="footnote" href="#ftn.CHP-6-FN-11" id="CHP-6-FN-11">58</a>]</sup><a class="indexterm" id="IDX-CHP-6-0507"/><a class="indexterm" id="IDX-CHP-6-0508"/></p><a id="I_programlisting3_d1e9153"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_http --ssl -H www.swobspace.de</strong></span>
Connection refused
Unable to open TCP socket</pre>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>days</code></em></code></strong> <strong class="userinput"><code>/--certificate=</code></strong><strong class="userinput"><code><em class="replaceable"><code>days</code></em></code></strong></span></dt>

          <dd>
            <p>Tests whether the certificate is at least valid for the given number of days. Otherwise a WARNING is issued.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>−4</code></strong> <strong class="userinput"><code>/--use-ipv4</code></strong></span></dt>

          <dd>
            <p>The test is made explicitly over an IPv4 connection.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>−6</code></strong> <strong class="userinput"><code>/--use-ipv6</code></strong></span></dt>

          <dd>
            <p>The test is made explicitly over an IPv6 connection.</p>
          </dd>
        </dl>
      </div>

      <p>The definition of a corresponding command object and its use as a service is no different from that based on other plugins; <a class="xref" href="../Text/ch06s04.html#monitoring_web_proxies" title="6.4.3 Monitoring Web proxies">6.4.3 Monitoring Web proxies</a> shows an example.</p>
    </div>

    <div class="sect2" title="6.4.3 Monitoring Web proxies">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="monitoring_web_proxies"/>6.4.3 Monitoring Web proxies</h2>
      </div>

      <div class="sect3" title="Proxy test with check_http">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="proxy_test_with_check_underscore_http"/>Proxy test with <strong class="userinput"><code>check_http</code></strong></h3>
        </div>

        <p>A proxy such as Squid can also be tested with <strong class="userinput"><code>check_http</code></strong>, but this assumes that you have some knowledge of how a browser makes contact with the proxy. It does this in the form of an HTTP header:<a class="indexterm" id="IDX-CHP-6-0509"/><a class="indexterm" id="IDX-CHP-6-0510"/><a class="indexterm" id="IDX-CHP-6-0511"/><a class="indexterm" id="IDX-CHP-6-0512"/><a class="indexterm" id="IDX-CHP-6-0513"/><a class="indexterm" id="IDX-CHP-6-0514"/></p><a id="I_programlisting3_d1e9240"/>
        <pre class="programlisting">GET <span class="strong"><strong>http://www.swobspace.de/</strong></span> HTTP/1.1
Host: <span class="strong"><strong>www.swobspace.de</strong></span>
User-Agent: Mozilla/5.0 (X11; U; Linux i686; de-DE; rv:1.7.5)
Gecko/20041108 Firefox/1.0
Accept: text/xml,application/xml,application/xhtml+xml,...
Accept-Language: de-de,de;q=0.8,en-us;q=0.5,en;q=0.3
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-15,utf-8;q=0.7,*;q=0.7
Keep-Alive: 300
Proxy-Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache</pre>

        <p>The decisive entries are printed in bold type. In contrast to normal Web server queries, the browser requests the document from the server via a GET command, not by specifying the directory path, but by using the complete URL, including the protocol type. In the <strong class="userinput"><code>Host:</code></strong> field it specifies the host name of the Web server that it actually wants to reach. With normal HTTP queries that go directly to a Web server (and not via a proxy), the host name of the Web server would be written there. This behavior can be reproduced with <strong class="userinput"><code>check_http</code></strong>:</p><a id="I_programlisting3_d1e9256"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_http -H www.swobspace.de</strong></span> \
<span class="strong"><strong>      -I 192.168.1.13 -p 3128 -u http://www.swobspace.de</strong></span>
HTTP OK HTTP/1.0 200 OK - 2553 bytes in 0.002 seconds</pre>

        <p>In order to set the <strong class="userinput"><code>Host:</code></strong> field in the header, you specify the name of a Web server with <span class="strong"><strong>-H</strong></span>. The nonlocal URL is forced by a <strong class="userinput"><code>-u</code></strong>, and specifying <span class="strong"><strong>-I</strong></span> at the same time ensures that the proxy is addressed, and not the Web server itself. Finally you need to select the proxy port, and the proxy test is then complete. Then <strong class="userinput"><code>check_http</code></strong> will send the following HTTP header to the proxy:</p><a id="I_programlisting3_d1e9281"/>
        <pre class="programlisting">GET <span class="strong"><strong>http://www.swobspace.de HTTP/1.0</strong></span>
User-Agent: check_http/v1861 (nagios-plugins 1.4.11)
Connection: close
Host: <span class="strong"><strong>www.swobspace.de</strong></span></pre>

        <p>This test does not use any implementation-specific information of the proxy, so it should work with every Web proxy.</p>

        <p>The command object is defined as follows:</p><a id="I_programlisting3_d1e9292"/>
        <pre class="programlisting">define command{
    command_name<span class="strong"><strong>   check_proxy</strong></span>
    command_line   $USER1$/<span class="strong"><strong>check_http</strong></span> -H www.googl
e.de -u http://www.google.de -I $HOSTADDRESS$ -p $ARG1$
}</pre>

        <p>The proxy computer <strong class="userinput"><code>linuxO1</code></strong> is then tested with the following service:</p><a id="I_programlisting3_d1e9306"/>
        <pre class="programlisting">define service{
    service_description    Webproxy
    host_name              linux01
<span class="strong"><strong>    check_command   check_proxy!3128</strong></span>
    ...
}</pre>

        <p>The parameter <strong class="userinput"><code>3128</code></strong> ensures that the command object <strong class="userinput"><code>check_proxy</code></strong> can read out the port from <strong class="userinput"><code>$ARG1$</code></strong>.</p>
      </div>

      <div class="sect3" title="Proxy test with check_squid">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="proxy_test_with_check_underscore_squid"/>Proxy test with <strong class="userinput"><code>check_squid</code></strong></h3>
        </div>

        <p>The proxy check with <strong class="userinput"><code>check_http</code></strong>, introduced in the last section, works only if the desired Web page is available or is already in the cache. If neither is the case, this test will produce an error, even if the proxy is working in principle.<a class="indexterm" id="IDX-CHP-6-0517"/><a class="indexterm" id="IDX-CHP-6-0518"/><a class="indexterm" id="IDX-CHP-6-0519"/><a class="indexterm" id="IDX-CHP-6-0520"/><a class="indexterm" id="IDX-CHP-6-0521"/><a class="indexterm" id="IDX-CHP-6-0515"/><a class="indexterm" id="IDX-CHP-6-0522"/><a class="indexterm" id="IDX-CHP-6-0516"/></p>

        <p>The plugin <strong class="userinput"><code>check_squid.pl</code></strong> uses a different method, but it is not part of the standard installation, and is to be found in the <span class="strong"><strong>Check Plugins</strong></span> category, under <span class="strong"><strong>Software | HTTP &amp; FTP | Squid Proxy</strong></span>.<sup>[<a class="footnote" href="#ftn.CHP-6-FN-12" id="CHP-6-FN-12">59</a>]</sup></p>

        <p>It makes use of the <span class="emphasis"><em>cache manager</em></span> of the Squid proxy, which is queried by a pseudo protocol. A command is sent in the form<a class="indexterm" id="IDX-CHP-6-0523"/></p><a id="I_programlisting3_d1e9395"/>
        <pre class="programlisting">GET cache_object: //<span class="emphasis"><em>ip_address/command</em></span> HTTP/1.1\n\n</pre>

        <p>to Squid and obtains the desired information. The plugin <strong class="userinput"><code>check_squid.pl</code></strong> uses the <strong class="userinput"><code>info</code></strong> command, which queries a range of statistical usage information:</p><a id="I_programlisting3_d1e9408"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>echo "GET cache_object://192.168.1.13/info HTTP/1.1\n\n"</strong></span> \
    | <span class="strong"><strong>netcat 192.168.1.13 3128</strong></span>
...
File descriptor usage for squid:
         Maximum number of file descriptors:     1024
         Largest file desc currently in use:       18
         Number of file desc currently in use:     15
         Files queued for open:                     0
         Available number of file descriptors:   1009
         Reserved number of file descriptors:     100
         Store Disk files open:                     0
...</pre>

        <p>It is targeted at the number of still-free file descriptors (the third line from the end); you can set a warning or critical limit for this value. The number of file descriptors plays a role when access is made to objects in the Squid cache at the same time. In environments with a high number of parallel accesses to the proxy, it is quite possible that 1024 file descriptors are insufficient. In smaller networks with just a few hundred users, not all of whom are surfing at the same time, the compiled-in value of 1024 will be sufficient.</p>

        <p><code class="literal">Squid configuration</code> Normally Squid allows access to the cache manager only from <strong class="userinput"><code>localhost</code></strong>. So that Nagios can query it over the network, the proxy must be reconfigured accordingly:<a class="indexterm" id="IDX-CHP-6-0524"/></p><a id="I_programlisting3_d1e9430"/>
        <pre class="programlisting">...
acl manager proto cache_object
<span class="strong"><strong>acl nagiosserver 192.168.1.9</strong></span>
<span class="strong"><strong>http_access allow manager nagiosserver</strong></span>
http_access deny manager
<span class="strong"><strong>cachemgr_passwd none info menu</strong></span>
...</pre>

        <p>The necessary changes to the configuration file <strong class="userinput"><code>squid.conf</code></strong> are printed in bold type, and the other relevant lines are already contained in the default file. The first line to be printed defines an access control list (<span class="emphasis"><em>Access Control List</em></span>, <strong class="userinput"><code>acl</code></strong>) called <strong class="userinput"><code>manager</code></strong> by means of the internal protocol <strong class="userinput"><code>cache_object</code></strong>, so it refers to everything that accesses the proxy using the <strong class="userinput"><code>cache_object</code></strong> protocol. This is followed by an access control list for the Nagios server, based on its IP address, here <strong class="userinput"><code>192.168.1.9</code></strong>. The list name <strong class="userinput"><code>nagiosserver</code></strong> may be freely chosen here (as can <strong class="userinput"><code>manager</code></strong> in the first line). With <strong class="userinput"><code>http_access allow</code></strong>, <strong class="userinput"><code>nagiosserver</code></strong> obtains access to the cache manager (<strong class="userinput"><code>manager</code></strong>), before the line</p><a id="I_programlisting3_d1e9482"/>
        <pre class="programlisting">http_access deny manager</pre>

        <p>prohibits access to all others through the <strong class="userinput"><code>cache_object</code></strong> protocol. Finally, <strong class="userinput"><code>cachemgr_passwd</code></strong> provides a password for the cache manager access. If you omit this, with none, then only selected commands should be allowed that have no potential to change things, such as <strong class="userinput"><code>info</code></strong> and <strong class="userinput"><code>menu</code></strong>, which shows all the things that the cache manager can do. After the configuration file has been modified, Squid needs to read it in again:</p><a id="I_programlisting3_d1e9498"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/squid reload</strong></span></pre>

        <p><code class="literal">Applying the plugin</code> The test plugin <strong class="userinput"><code>check_squid.pl</code></strong> itself has the following options:</p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/--hostname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

            <dd>
              <p>This is the server on which Squid is to be tested, specified by IP address or FQDN.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-P</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

            <dd>
              <p>This specifies the port on which Squid is listening. The default is the standard port 3128.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong> <strong class="userinput"><code>/ --password=</code></strong><strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong></span></dt>

            <dd>
              <p>This is the password for access to the cache manager.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>free_descriptors</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>free_descriptors</code></em></code></strong></span></dt>

            <dd>
              <p>This is the number of free file descriptors, where the plugin will issue a warning if the number drops below this. The default is 200.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>free_descriptors</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>free_descriptors</code></em></code></strong></span></dt>

            <dd>
              <p>This is the critical limit for free file descriptors. If the number falls below this, <strong class="userinput"><code>check_squid</code></strong> returns CRITICAL. The default is 50.<a class="indexterm" id="IDX-CHP-6-0525"/><a class="indexterm" id="IDX-CHP-6-0526"/></p>
            </dd>
          </dl>
        </div>

        <p>When <strong class="userinput"><code>check_squid</code></strong> is run, it is usually very unspectacular:</p><a id="I_programlisting3_d1e9616"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_squid.pl -H 192.168.1.13</strong></span>
Squid cache OK (1009 FreeFileDesc)</pre>

        <p>The matching command also presents no problems ...</p><a id="I_programlisting3_d1e9623"/>
        <pre class="programlisting">define command{
    command_name   <span class="strong"><strong>check_squid.pl</strong></span>
    command_line $USER1$/<span class="strong"><strong>check_squid.pl</strong></span> -H $HOSTADDRESS$
}</pre>

        <p>... and the same goes for service definitions:</p><a id="I_programlisting3_d1e9633"/>
        <pre class="programlisting">define service{
   service_description   Squid
   host_name             linux01
   <span class="strong"><strong>check_command  check_squid.pl</strong></span>
   ...
}</pre>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-8" id="ftn.CHP-6-FN-8">55</a>]</sup> Posix regular expressions, see <strong class="userinput"><code>man 7 regex</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-9" id="ftn.CHP-6-FN-9">56</a>]</sup> <a class="ulink" href="http://www.faqs.org/rfcs/rfcl738.html">http://www.faqs.org/rfcs/rfcl738.html</a>, paragraph 2.2</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-10" id="ftn.CHP-6-FN-10">57</a>]</sup> <a class="ulink" href="http://tools.ietf.org/html/rfc2045#section-5">http://tools.ietf.org/html/rfc2045#section-5</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-11" id="ftn.CHP-6-FN-11">58</a>]</sup> This can be checked in the shell with <strong class="userinput"><code>echo $?</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-12" id="ftn.CHP-6-FN-12">59</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/cgi-bin/pages/Detailed/1764.html">http://www.nagiosexchange.org/cgi-bin/pages/Detailed/1764.html</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="6.5 Domain Name Server Under Control">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="domain_name_server_under_control"/>6.5 Domain Name Server Under Control</h1>
    </div>

    <p>Two plugins are also available for testing the <span class="emphasis"><em>Domain Name Service (DNS):</em></span> <strong class="userinput"><code>check_dns</code></strong> and <strong class="userinput"><code>check_dig</code></strong>. While <strong class="userinput"><code>check_dns</code></strong> tests whether a host name can be resolved, using the external <strong class="userinput"><code>nslookup</code></strong> program, <strong class="userinput"><code>check_dig</code></strong> allows any records at all to be queried. Both plugins are part of the standard distribution.<a class="indexterm" id="IDX-CHP-6-0527"/></p>

    <p>The situations in which they are used overlap somewhat. With <strong class="userinput"><code>check_dns</code></strong>, you can also explicitly query a specific DNS server, although this plugin is really for checking whether the name service is available generally.</p>
  </div>


  <div class="sect1" title="6.5.1 DNS check with nslookup">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="dns_check_with_nslookup"/>6.5.1 DNS check with <strong class="userinput"><code>nslookup</code></strong></h1>
    </div>

    <p>The <strong class="userinput"><code>check_dns</code></strong> plugin checks whether a specified host name can be resolved to an IP address. Used locally, the plugin tests the DNS configuration of the computer on which it is run. For the name resolution, it uses the name server configured in <strong class="userinput"><code>/etc/resolv.conf</code></strong>.<a class="indexterm" id="IDX-CHP-6-0528"/><a class="indexterm" id="IDX-CHP-6-0529"/><a class="indexterm" id="IDX-CHP-6-0530"/></p>

    <p>The possible options are just as unspectacular.</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>host</code></em></code></strong> <strong class="userinput"><code>/ --hostname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>host</code></em></code></strong></span></dt>

        <dd>
          <p>This is the host name to be resolved to an IP address.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>dns-server</code></em></code></strong> <strong class="userinput"><code>/ --server=</code></strong><strong class="userinput"><code><em class="replaceable"><code>dns-server</code></em></code></strong></span></dt>

        <dd>
          <p>This switch explicitly specifies the name server to be used. If this option is missing, <strong class="userinput"><code>check_dns</code></strong> uses the name server from <strong class="userinput"><code>/etc/resolv.conf</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-a</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ip_address</code></em></code></strong> <strong class="userinput"><code>/ --expected-address=</code></strong><strong class="userinput"><code><em class="replaceable"><code>ip_address</code></em></code></strong></span></dt>

        <dd>
          <p>The <strong class="userinput"><code><em class="replaceable"><code>ip_address</code></em></code></strong> is the IP address that <strong class="userinput"><code><em class="replaceable"><code>host</code></em></code></strong> should have. If the name service returns a different address, the plugin will raise the alarm with CRITICAL. This option makes sense only if it is necessary for the name server to provide a fixed IP address. Without this option, the plugin will accept every IP address as a reply.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-A / --expect-authority</code></strong></span></dt>

        <dd>
          <p>The name server specified with <strong class="userinput"><code>-s</code></strong> should answer the given query authoritatively, so the corresponding domain must act as a primary or secondary name server. If this is not the case, the plugin returns CRITICAL.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating point</code></em></code></strong> <strong class="userinput"><code>/ - warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating point</code></em></code></strong></span></dt>

        <dd>
          <p>This switch specifies the warning limit for the response time of the name server in seconds (specified as a floating point).</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating point</code></em></code></strong> <strong class="userinput"><code>/ - critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating point</code></em></code></strong></span></dt>

        <dd>
          <p>This switch gives the critical response time of name server in seconds, specified as a floating point.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> <strong class="userinput"><code>/ --timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

        <dd>
          <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds have expired, the plugin interrupts the test and returns the CRITICAL state. The default is <strong class="userinput"><code>10</code></strong> seconds.</p>
        </dd>
      </dl>
    </div>

    <p>For the local test of the DNS configuration (not that for a name server) you just require a host name that is highly unlikely to disappear from the DNS, such as <a class="ulink" href="http://www.google.com">www.google.com</a>:</p><a id="I_programlisting3_d1e9838"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>/check_dns -H www.google.com</strong></span>
DNS OK: 0,009 seconds response time www.google.com returns 216.239.59.99</pre>

    <p>The corresponding command definition appears as follows in this case:</p><a id="I_programlisting3_d1e9845"/>
    <pre class="programlisting">define command{
    command_name <span class="strong"><strong>check_dns</strong></span>
    command_line $USER1$/<span class="strong"><strong>check_dns</strong></span> -H www.google.de
}</pre>

    <p>The following service tests whether the name server configuration for the computer <strong class="userinput"><code>linux01</code></strong> is functioning:</p><a id="I_programlisting3_d1e9858"/>
    <pre class="programlisting">define service{
    service_description      DNS/nslookup
    host_name                linux01
    <span class="strong"><strong>check_command  check_dns</strong></span>
    ...
}</pre>
  </div>


  <div class="sect1" title="6.5.2 Monitoring the name server with dig">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_the_name_server_with_dig"/>6.5.2 Monitoring the name server with <strong class="userinput"><code>dig</code></strong></h1>
    </div>

    <p>The plugin <strong class="userinput"><code>check_dig</code></strong> provides more options for monitoring a name server than <strong class="userinput"><code>check_dns</code></strong>. As the name implies, it is based on the external utility <strong class="userinput"><code>dig</code></strong>, intended for precisely this purpose.<a class="indexterm" id="IDX-CHP-6-0531"/><a class="indexterm" id="IDX-CHP-6-0532"/></p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> / <strong class="userinput"><code>--hostname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

        <dd>
          <p>The <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> is the IP address for the DNS server to be tested. It is also possible to specify a host name (instead of an IP address), but in most cases this makes little sense, because this would first have to be resolved before it can reach the name server.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

        <dd>
          <p>This switch specifies the UDP port to be used. The default is <strong class="userinput"><code>53</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>−1</code></strong> <strong class="userinput"><code><em class="replaceable"><code>hostname</code></em></code></strong> <strong class="userinput"><code>/ --lookup=</code></strong> <strong class="userinput"><code><em class="replaceable"><code>hostuame</code></em></code></strong></span></dt>

        <dd>
          <p>The <strong class="userinput"><code><em class="replaceable"><code>hostname</code></em></code></strong> is the host name to be tested. If no particular computer is looked up, but only the functionality of the DNS server is to be tested, you should specify an address here easily reachable from the Internet, such as <a class="ulink" href="http://www.google.com">www.google.com</a>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-T</code></strong> <strong class="userinput"><code><em class="replaceable"><code>record_type</code></em></code></strong> <strong class="userinput"><code>/ --record_type=</code></strong><strong class="userinput"><code><em class="replaceable"><code>record_type</code></em></code></strong></span></dt>

        <dd>
          <p>This switch specifies the record type to be queried. The default is <strong class="userinput"><code>A</code></strong> (IPv4 address), but often <strong class="userinput"><code>NS</code></strong> (relevant name server), <strong class="userinput"><code>MX</code></strong> (relevant <span class="emphasis"><em>Mail Exchange</em></span>), <strong class="userinput"><code>PTR</code></strong>(<span class="emphasis"><em>Pointer</em></span>; IP address for reverse lookup), or <strong class="userinput"><code>S0A</code></strong>(<span class="emphasis"><em>Source of Authority</em></span>, the administration details of the domain) are also used.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

        <dd>
          <p>This switch sets the warning limit for the response time of the name server in seconds (floating point decimal).</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

        <dd>
          <p>This switch sets the critical response time of the name server in seconds (floating point decimal).</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-a</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --expected_address=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

        <dd>
          <p>This is the address that <strong class="userinput"><code>dig</code></strong> should return in the <span class="emphasis"><em>ANSWER SECTION</em></span>. In contrast to <strong class="userinput"><code>check_dns, check_dig</code></strong> delivers a WARNING only if the IP address does not match, but the reply itself has arrived within the given time limit.<a class="indexterm" id="IDX-CHP-6-0533"/><a class="indexterm" id="IDX-CHP-6-0534"/></p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> <strong class="userinput"><code>/ --timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

        <dd>
          <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds have expired, the plugin breaks off the test and returns the CRITICAL state. The default is <strong class="userinput"><code>10</code></strong> seconds.</p>
        </dd>
      </dl>
    </div>

    <p>The following two examples check the name server <strong class="userinput"><code>194.25.2.129</code></strong>, by requesting it for the IP address of the computer <a class="ulink" href="http://www.swobspace.de.">www.swobspace.de</a> The second example ends with a WARNING, since the reply of the name server for <a class="ulink" href="http://www.swobspace.de">www.swobspace.de</a> returns a different IP address from <strong class="userinput"><code>1.2.3.4</code></strong> in the <strong class="userinput"><code>ANSWER SECTION</code></strong>:</p><a id="I_programlisting3_d1e10113"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_dig -H 194.25.2.129 -l</strong></span> \
<span class="strong"><strong>    www.swobspace.de</strong></span>
DNS OK - 2,107 Sekunden Antwortzeit (www.swobspace.de. 1800 IN A 21
2.227.119.101)
nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_dig -H 194.25.2.129 -l</strong></span> \
<span class="strong"><strong>    www.swobspace.de -a 1.2.3.4</strong></span>
DNS WARNING - 0,094 Sekunden Antwortzeit (Server nicht gefunden in ANSWE
R SECTION)</pre>

    <p>Example 1 is implemented as a command object as follows:</p><a id="I_programlisting3_d1e10129"/>
    <pre class="programlisting">define command{
    command_name <span class="strong"><strong>check_dig</strong></span>
    command_line $USER1$/<span class="strong"><strong>check_dig</strong></span> -H $HOSTADDRESS$ −1 $ARG1$
}</pre>

    <p>In order to test the specific name server <strong class="userinput"><code>linux0l</code></strong>, you look for an address that Nagios should always be able to resolve, such as <a class="ulink" href="http://www.google.com/">www.google.com</a></p><a id="I_programlisting3_d1e10144"/>
    <pre class="programlisting">define service{
   service_description     DNS/dig
   host_name               linux01
   <span class="strong"><strong>check_command    check_dig!www.google.com</strong></span>
   ...
}</pre>
  </div>


  <div class="sect1" title="6.6 Querying the Secure Shell Server">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="querying_the_secure_shell_server"/>6.6 Querying the Secure Shell Server</h1>
    </div>

    <p>Monitoring of Secure Shell servers (irrespective of whether they use protocol version 1 or 2) is taken over by the plugin <strong class="userinput"><code>check_ssh</code></strong> (included in the standard distribution). It is quite a simple construction and just evaluates the SSH handshake. User name and password are not required for the test.<a class="indexterm" id="IDX-CHP-6-0535"/></p>

    <p>Not to be confused with <strong class="userinput"><code>check_sshis</code></strong> the plugin <strong class="userinput"><code>check_by_ssh</code></strong> (see <a class="xref" href="../Text/ch09.html" title="Chapter 9. Executing Plugins via SSH">Chapter 9</a> from page 205), which starts plugins remotely on a different computer.<a class="indexterm" id="IDX-CHP-6-0536"/></p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --hostname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

        <dd>
          <p>Host name or IP address of the computer to which the plugin should set up an SSH connection.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

        <dd>
          <p>This specifies an alternative port. The default is 22.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-r</code></strong> <strong class="userinput"><code><em class="replaceable"><code>version</code></em></code></strong> <strong class="userinput"><code>/ --remote-version=</code></strong><strong class="userinput"><code><em class="replaceable"><code>version</code></em></code></strong></span></dt>

        <dd>
          <p>The version details for the tested Secure Shell must match the specified text instead of <strong class="userinput"><code><em class="replaceable"><code>version</code></em></code></strong>, otherwise a WARNING will be sent (see example below). If the version details contain spaces, the string must be enclosed by double quotes.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> <strong class="userinput"><code>/ --timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

        <dd>
          <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> (by default, <strong class="userinput"><code>10</code></strong>) seconds the plugin breaks off the test and returns the CRITICAL state.</p>
        </dd>
      </dl>
    </div>

    <p>The following example in turn tests the Secure Shell daemons on the local computer and on <strong class="userinput"><code>wobgate</code></strong>, to see whether the current SSH version from Debian Etch is being used:</p><a id="I_programlisting3_d1e10258"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_ssh -H localhost</strong></span> \
<span class="strong"><strong>    -r 'OpenSSH_4.3p2 Debian-9'</strong></span>
SSH OK - OpenSSH_4.3p2 Debian-9 (protocol 2.0)
nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_ssh -H wobgate -r</strong></span> \
<span class="strong"><strong>    'OpenSSH_4.3p2 Debian-9'</strong></span>
SSH WARNING - OpenSSH_3.8.1p1 Debian-8.sarge.6 (protocol 2.0) version mi
smatch, expected 'OpenSSH_4.3p2 Debian-9'</pre>

    <p>The latest version of SSH is not in use on <strong class="userinput"><code>wobgate</code></strong>.</p>

    <p>In heterogeneous environments with various Linux distributions, you will usually use version checking "manually" only for plugin calls, and only rarely integrate them into the Nagios configuration. Instead, it is normally sufficient to use command and service definitions using the following simple pattern:</p><a id="I_programlisting3_d1e10279"/>
    <pre class="programlisting">define command{
    command_name<span class="strong"><strong>     check_ssh</strong></span>
    command_line        $USER1$/<span class="strong"><strong>check_ssh</strong></span> -H $HOSTADDRESS$
}

define service{
    service_description   SSH
    host_name             linux01
    <span class="strong"><strong>    check_command  check_ssh</strong></span>
    ...
}</pre>

    <p>Otherwise you run the risk of having to adjust the version number in the command object after every security update.</p>
  </div>


  <div class="sect1" title="6.7 Generic Network Plugins">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="generic_network_plugins"/>6.7 Generic Network Plugins</h1>
    </div>

    <p>Sometimes no plugin can be found that is precisely geared to the service to be monitored. For such cases, two generic plugins are available: <strong class="userinput"><code>check_tcp</code></strong> and <strong class="userinput"><code>check_udp</code></strong>. Both of them test whether a service is active on the target port for the protocol in question. Although this does not yet guarantee that the service running on the port really is the one in question, in an environment that one adminstrator looks after and configures, this can be sufficiently guaranteed in other ways.<a class="indexterm" id="IDX-CHP-6-0537"/><a class="indexterm" id="IDX-CHP-6-0538"/></p>

    <p>Both plugins send a string to the server and evaluate the reply. This is at its most simple for text-based protocols such as POP or IMAP: these two "specific" plugins, which are tailor-made for these two mail services (see <a class="xref" href="../Text/ch06s03.html#pop_and_imap" title="6.3.2 POP and IMAP">6.3.2 POP and IMAP</a> from page 115), use nothing more than symbolic links to <strong class="userinput"><code>check_tcp</code></strong>, which has already completed the corresponding question-and-answer game with relevant default settings.</p>

    <p>If you know the protocol to be tested and you configure a "quiz" that will fit this (no easy task for binary protocols), a check becomes considerably more than just a port scan. In this way the generic plugins can also be substituted for specific missing plugins.</p>

    <div class="sect2" title="6.7.1 Testing TCP ports">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="testing_tcp_ports"/>6.7.1 Testing TCP ports</h2>
      </div>

      <p><strong class="userinput"><code>check_tcp</code></strong> is concentrated on TCP-based services. In line with its generic nature, it has a large number of options:<a class="indexterm" id="IDX-CHP-6-0539"/><a class="indexterm" id="IDX-CHP-6-0540"/><a class="indexterm" id="IDX-CHP-6-0541"/><a class="indexterm" id="IDX-CHP-6-0542"/><a class="indexterm" id="IDX-CHP-6-0543"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --hostname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>This is the IP address or host name of the computer whose port should be tested.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

          <dd>
            <p>This specifies the target port. In contrast to the plugins that are formed as a symbolic link to <strong class="userinput"><code>check_tcp</code></strong>, this detail is always required.<a class="indexterm" id="IDX-CHP-6-0544"/><a class="indexterm" id="IDX-CHP-6-0545"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

          <dd>
            <p>This sets the warning limit for the response time in seconds.<a class="indexterm" id="IDX-CHP-6-0546"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

          <dd>
            <p>This sets a time limit like <strong class="userinput"><code>-w</code></strong> but specifies the critical limit value.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> <strong class="userinput"><code>/ --send=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p>This is the string that the plugin should send to the server.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-e</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong><strong class="userinput"><code>/ --expect=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p>This is the string that the reply of the server should contain. The plugin does not restrict its search here to the first line.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-E</code></strong> <strong class="userinput"><code>/ --escape</code></strong></span></dt>

          <dd>
            <p>This allows the use of the escape sequences <strong class="userinput"><code>\n</code></strong>, <strong class="userinput"><code>\r</code></strong>, <strong class="userinput"><code>\t</code></strong> or simply <strong class="userinput"><code>\</code></strong> for <strong class="userinput"><code>-s</code></strong> and <strong class="userinput"><code>-e</code></strong>. In all cases <strong class="userinput"><code>-E</code></strong> must be placed in front of the options <strong class="userinput"><code>-s</code></strong> and <strong class="userinput"><code>-e</code></strong> on which it should have an influence.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-A</code></strong> <strong class="userinput"><code>/ --all</code></strong></span></dt>

          <dd>
            <p>If you specify multiple reply strings with <strong class="userinput"><code>-e</code></strong>, the plugin with <strong class="userinput"><code>-A</code></strong> will only return OK if all required reply strings were found. Without this option it is enough for a positive return if just one of several strings is found.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-M</code></strong> <strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong> <strong class="userinput"><code>/ --mismatch=</code></strong><strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong></span></dt>

          <dd>
            <p>How should the plugin react if a returned string does not match what is specified with <strong class="userinput"><code>-e?</code></strong> The default is <strong class="userinput"><code>warn</code></strong>, which means that a WARNING is given. With <strong class="userinput"><code>crit</code></strong>, a false return value could be categorized as CRITICAL, and with <strong class="userinput"><code>ok</code></strong>, as OK.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-q</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> <strong class="userinput"><code>/ --quit=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

          <dd>
            <p>This is the string that requests the service to end the connection.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-m</code></strong> <strong class="userinput"><code><em class="replaceable"><code>bytes</code></em></code></strong> <strong class="userinput"><code>/ --maxbytes=</code></strong><strong class="userinput"><code><em class="replaceable"><code>bytes</code></em></code></strong></span></dt>

          <dd>
            <p>The plugin closes the connection if it has received more than <strong class="userinput"><code><em class="replaceable"><code>bytes</code></em></code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-d</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_decimal</code></em></code></strong> <strong class="userinput"><code>/ --delay=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_decimal</code></em></code></strong></span></dt>

          <dd>
            <p>This is the time period in seconds between sending a string and checking the response.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> <strong class="userinput"><code>/ --timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

          <dd>
            <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> (the default is <strong class="userinput"><code>10</code></strong>) seconds the plugin stops the test and returns the CRITICAL status.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-j</code></strong> <strong class="userinput"><code>/ --jail</code></strong></span></dt>

          <dd>
            <p>Setting this displays the TCP output. For text-based protocols such as POP or IMAP, this is usually "human-readable", but for binary protocols you generally cannot decipher the output, so that <strong class="userinput"><code>-j</code></strong> is appropriate.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-r</code></strong> <strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong> <strong class="userinput"><code>/ --refuse=</code></strong><strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong></span></dt>

          <dd>
            <p>This switch specifies what value the plugin returns if the server rejects the TCP connection. The default is <strong class="userinput"><code>crit</code></strong> (CRITICAL). With <strong class="userinput"><code>ok</code></strong> as the <strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong>, you can test whether a service is available that should not be accessible from outside. The third possible value, <strong class="userinput"><code>warn</code></strong>, ensures that a WARNING is given.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-D</code></strong> <strong class="userinput"><code><em class="replaceable"><code>days</code></em></code></strong> <strong class="userinput"><code>/ --certificate=</code></strong><strong class="userinput"><code><em class="replaceable"><code>days</code></em></code></strong></span></dt>

          <dd>
            <p>This is the time span in days for which a server certificate must at least be valid for the test to run successfully. It is relevant only for SSL connections. Note that there is a danger of confusion: in the <strong class="userinput"><code>check_http</code></strong> plugin this same option is <strong class="userinput"><code>-C</code></strong> (see <a class="xref" href="../Text/ch06s04.html#web_server_control_via_http" title="6.4.2 Web server control via HTTP">6.4.2 Web server control via HTTP</a>). If the time span drops below the time period specified for the server certificate, the plugin returns a WARNING.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-S</code></strong> <strong class="userinput"><code>/ --ssl</code></strong></span></dt>

          <dd>
            <p>SSL/TLS should be used for the connection. The plugin cannot handle STARTTLS<sup>[<a class="footnote" href="#ftn.CHP-6-FN-13" id="CHP-6-FN-13">60</a>]</sup>.</p>
          </dd>
        </dl>
      </div>

      <p>The following example checks on the command line whether a service on the target host <strong class="userinput"><code>192.168.1.89</code></strong> is active on port 5631, the TCP port for the Windows remote-control software, PCAnywhere:</p><a id="I_programlisting3_d1e10725"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_tcp -H 192.168.1.89 -p 5631</strong></span>
TCP OK - 0,061 second response time on port 5631 | time=0,060744s;0,
000000;0,000000;0,000000;10,000000</pre>

      <p>For all services for which the computer name and port detail are sufficient as parameters for the test, the command object is as follows:</p><a id="I_programlisting3_d1e10732"/>
      <pre class="programlisting">define command{
     command_name <span class="strong"><strong>   check_tcp</strong></span>
     command_line       $USER1$/<span class="strong"><strong>check_tcp</strong></span> -H $HOSTADDRESS$ -p $ARG1$
}</pre>

      <p>To monitor the said PCAnywhere on the machine <strong class="userinput"><code>Win0l</code></strong>, the following service definition would be used:</p><a id="I_programlisting3_d1e10745"/>
      <pre class="programlisting">define service{
   service_description   pcAnywhere
   host_name             Win01
   <span class="strong"><strong>check_command  check_tcp!5631</strong></span>
   ...
}</pre>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-13" id="ftn.CHP-6-FN-13">60</a>]</sup> See footnote in <a class="xref" href="../Text/ch06s03.html#pop_and_imap" title="6.3.2 POP and IMAP">6.3.2 POP and IMAP</a>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="6.7.2 Monitoring UDP ports">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_udp_ports"/>6.7.2 Monitoring UDP ports</h1>
    </div>

    <p>It is not so simple to monitor UDP ports, since there is no standard connection setup, such as the <span class="emphasis"><em>three-way-handshake</em></span> for TCP, in the course of which a connection is opened, but data is not yet transferred. For a stateless protocol such as UDP there is no regulated sequence for sent and received packets. The server can reply to a UDP packet sent by the client with a UDP packet, but it is not obliged to do this.<a class="indexterm" id="IDX-CHP-6-0547"/></p>

    <p>If you find an unoccupied port, the requested host normally sends back an ICMP port unreachable message, which evaluates the plugin. If there is no reply, there are two possibilities: either the service on the target port is not reacting to the request, or a firewall is filtering out network traffic (either the UDP traffic itself or the ICMP message). This is why you can never be sure with UDP whether the server behind a particular port really is offering a service or not.</p>

    <p>In order to force a positive response where possible, you normally have to send data to the server, with the option <strong class="userinput"><code>-s</code></strong>, containing some kind of meaningful message for the underlying protocol. Most services will not respond to empty or meaningless packets. This is why you cannot avoid getting to grips with the corresponding protocol, since you will otherwise not be in a position to send meaningful data to the server, to prompt it into giving a reply at all.</p>

    <p>Ever since Nagios plugin version 1.4.4, <strong class="userinput"><code>check_udp</code></strong> has been a symlink to <strong class="userinput"><code>check_tcp</code></strong>, so that <strong class="userinput"><code>check_udp</code></strong> has the same options as <strong class="userinput"><code>check_tcp</code></strong> (see <a class="xref" href="../Text/ch06s08.html" title="6.6 Querying the Secure Shell Server">6.6 Querying the Secure Shell Server</a>). <strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong>, <strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong>, and <strong class="userinput"><code>-e</code></strong> <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> are obligatory entries, even though the integrated online help declares these to be optional.<a class="indexterm" id="IDX-CHP-6-0548"/></p>

    <p>The following example tests whether a service on the target host <strong class="userinput"><code>192.168.1.13</code></strong> is active on the time server (NTP) Port 123. The NTP daemon only replies to packets containing a meaningful request (e.g., to ones whose contents begin with <strong class="userinput"><code>w</code></strong>):</p><a id="I_programlisting3_d1e10818"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_udp -H 192.168.1.13 -p 123 -s "w"</strong></span> \
<span class="strong"><strong>    -e""</strong></span>
UDP OK - 0.001 second response time on port 123 []|time=0.000586s;;;0.00
0000;10.000000</pre>

    <p>The reply remains empty, so the reply string is specified as <strong class="userinput"><code>-e ""</code></strong>. The NTP server does not respond to packets with data not in the protocol form. Normally NTP expects a relatively complex packet<sup>[<a class="footnote" href="#ftn.CHP-6-FN-14" id="CHP-6-FN-14">61</a>]</sup> containing various information. The <strong class="userinput"><code>w</code></strong> used here was found out by trial and error: It does not contain really meaningful data, but it does provoke the server into giving a response.</p>

    <p>The command line command shown above is implemented as follows as a command object:</p><a id="I_programlisting3_d1e10842"/>
    <pre class="programlisting">define command{
    command_name <span class="strong"><strong>check_udp</strong></span>
    command_line $USER1$/<span class="strong"><strong>check_udp</strong></span> -H $HOSTADDRESS$ -p $ARG1$ -s $ARG2$
}</pre>

    <p>Here we pass on the port as the first argument; all the other switches of the plugin are accessed through <strong class="userinput"><code>$ARG2$</code></strong>.</p>

    <p>Checking an NTP time server is then taken over by the following service definition:</p><a id="I_programlisting3_d1e10858"/>
    <pre class="programlisting">define service{
   service_description
   host_name             timesrv
   <span class="strong"><strong>    check_command  check_tcp!123!-s "w" -e ""</strong></span>
   ...
}</pre>

    <p>As in the command line example, Nagios sends the string <strong class="userinput"><code>w</code></strong> to the service to provoke a positive response.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-14" id="ftn.CHP-6-FN-14">61</a>]</sup> The protocol version NTPv3 is described in RFC 1305: <a class="ulink" href="http://rfc.sunsite.dk/rfc/rfcl305.html">http://rfc.sunsite.dk/rfc/rfcl305.html</a>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="6.8 Monitoring Databases">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_databases"/>6.8 Monitoring Databases</h1>
    </div>

    <p>Nagios provides three plugins for monitoring databases: <strong class="userinput"><code>check_pgsql</code></strong> for PostgreSQL, <strong class="userinput"><code>check_mysql</code></strong> for MySQL, and <strong class="userinput"><code>check_oracle</code></strong> for Oracle. The last will not be covered in this book.<sup>[<a class="footnote" href="#ftn.CHP-6-FN-15" id="CHP-6-FN-15">62</a>]</sup> They all have in common the fact that they can be used both locally and over the network. The latter has the advantage that the plugin in question does not have to be installed on the database server. The disadvantage is that you have to get more deeply involved with the subject of authentication, because configuring a secure <span class="emphasis"><em>local</em></span> access to the database is somewhat more simple.<a class="indexterm" id="IDX-CHP-6-0549"/><a class="indexterm" id="IDX-CHP-6-0550"/><a class="indexterm" id="IDX-CHP-6-0551"/></p>

    <p>For less critical systems, network access by the plugin can be done without a password. To do this, the user <strong class="userinput"><code>nagios</code></strong> is set up with its own database in the database management system to be tested, which does not contain any (important) data. Areas accessed by this user can be isolated from other data, stored in the DBMS, through the database's own permissions system.</p>

    <p>Of course, there is nothing stopping you from setting up a password for the user <strong class="userinput"><code>nagios</code></strong>. But if you cannot make use of SSL-encrypted connections, this will be transmitted in plain text for most database connections. In addition, it is stored unencrypted in the Nagios configuration files. In this respect the password does offer some protection, but it is not really that secure.</p>

    <p>As an additional measure, you should certainly restrict the IP address from which a user <strong class="userinput"><code>nagios</code></strong> user can access the database on the Nagios server.</p>

    <p>The plugins introduced here have only read access to the database. <strong class="userinput"><code>check_mysql</code></strong> additionally allows a pure connection check, without read access. A write access to the database is not available in any of the plugins mentioned. For Oracle there is a plugin on Nagios Exchange<sup>[<a class="footnote" href="#ftn.CHP-6-FN-16" id="CHP-6-FN-16">63</a>]</sup> called <strong class="userinput"><code>check_oracle_writeaccess.sh</code></strong>, which also tests the writeability of the database.<a class="indexterm" id="IDX-CHP-6-0552"/></p>

    <div class="sect2" title="6.8.1 PostgreSQL">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="postgresql"/>6.8.1 PostgreSQL</h2>
      </div>

      <p>With the <strong class="userinput"><code>check_pgsql</code></strong> plugin you can establish both local and network connections to the database. Local connections are handled by PostgreSQL via a Unix socket, which is a purely local mechanism. An IP connection is set up by <strong class="userinput"><code>check_pgsql</code></strong> if a target host is explicitly passed to it. The plugin performs a pure connection test to a test database but does not read any data from it.<a class="indexterm" id="IDX-CHP-6-0553"/><a class="indexterm" id="IDX-CHP-6-0554"/><a class="indexterm" id="IDX-CHP-6-0555"/><a class="indexterm" id="IDX-CHP-6-0556"/><a class="indexterm" id="IDX-CHP-6-0557"/><a class="indexterm" id="IDX-CHP-6-0558"/><a class="indexterm" id="IDX-CHP-6-0559"/></p>

      <p>In order that PostgreSQL can be reached over the network, you must start the <strong class="userinput"><code>postmaster</code></strong> program, either with <strong class="userinput"><code>-i</code></strong>, or by setting the parameter <strong class="userinput"><code>tcpip_socket</code></strong> in the configuration file <strong class="userinput"><code>postgresql.conf</code></strong> to the value <strong class="userinput"><code>true</code></strong>.</p>

      <div class="sect3" title="Configuring a monitor-friendly DBMS">
        <div class="titlepage">
          <h3 class="title" id="heading_id_4"><a id="configuring_a_monitor-friendly_dbms"/>Configuring a monitor-friendly DBMS</h3>
        </div>

        <p>In order to separate the data that the user <strong class="userinput"><code>nagios</code></strong> (executing the plugin) gets to see more clearly from other data, you first set up a database user with the same name, and a database to which this user is given access:<a class="indexterm" id="IDX-CHP-6-0560"/></p><a id="I_programlisting3_d1e11012"/>
        <pre class="programlisting">postgres@linux:~$ <span class="strong"><strong>createuser --no-adduser --no-createdb nagios</strong></span>
postgres@linux:~$ <span class="strong"><strong>createdb --owner nagios nagdb</strong></span></pre>

        <p>Of particular importance when creating a database user with the command <strong class="userinput"><code>createuser</code></strong> is the option <strong class="userinput"><code>--no-adduser</code></strong>. To PostgreSQL, the ability to be allowed to create users automatically means that you are the superuser, who can easily get round the various permissions set.<sup>[<a class="footnote" href="#ftn.CHP-6-FN-17" id="CHP-6-FN-17">64</a>]</sup> But <strong class="userinput"><code>nagios</code></strong> should not be given superuser permissions under any circumstances.<a class="indexterm" id="IDX-CHP-6-0561"/></p>

        <p><strong class="userinput"><code>createdb</code></strong> finally creates a new, empty database called <strong class="userinput"><code>nagdb</code></strong>, which belongs to <strong class="userinput"><code>nagios</code></strong>.</p>

        <p>Access to the database can be restricted in the file <strong class="userinput"><code>pg_hba.conf</code></strong>. Depending on the distribution, this can be found either in <strong class="userinput"><code>/etc/postgresql</code></strong> or in the subdirectory <strong class="userinput"><code>./data</code></strong> of the database itself (for example, <strong class="userinput"><code>/var/lib/pgsql/data</code></strong> for SUSE). The following extract restricts access by the database user <strong class="userinput"><code>nagios</code></strong> to a specific database and to the IP address of the Nagios server (instead of the IP address to be completed by <strong class="userinput"><code><em class="replaceable"><code>ip-nagios</code></em></code></strong>):</p><a id="I_programlisting3_d1e11074"/>
        <pre class="programlisting">#type   db     user   ip-address   ip-mask       method options
local   nagdb  nagios                            ident sameuser
host    nagdb  nagios <span class="emphasis"><em>ip-nagios</em></span> 255.255.255.255 ident sameuser</pre>

        <p>The first line is a comment describing the function of the columns. The second line allows the database user <strong class="userinput"><code>nagios</code></strong> access to the database <strong class="userinput"><code>nagdb</code></strong> over a local connection. Even though the authentication method here is called <strong class="userinput"><code>ident</code></strong>, you do not need a local ident daemon for Linux and BSD variants (NetBSD, FreeBSD, etc.).</p>

        <p>The last line describes the same restriction, but this time it is for a TCP/IP connection to the Nagios server. But now PostgreSQL asks the ident daemon of the Nagios server which user has set off the connection request. This means that an ident daemon must be installed on <strong class="userinput"><code><em class="replaceable"><code>ip-nagios</code></em></code></strong>. In this way the DBMS tests whether the user initiating the connection from the Nagios server really is called <strong class="userinput"><code>nagios</code></strong>. It will not permit another user (or a connection from a different host).</p>

        <p>Normally the ident protocol is only partially suited for user authentication. But in the case of the Nagios server you can assume that a host is involved that is under the control of the administrator who can ensure that an ident daemon really is running on port 113.</p>

        <p>There is a huge range of different ident daemons. <strong class="userinput"><code>pidentd</code></strong><sup>[<a class="footnote" href="#ftn.CHP-6-FN-18" id="CHP-6-FN-18">65</a>]</sup> is widely used and is included in most Linux distributions. Normally it is already precon-figured and just needs to be started. But how it is started depends on the distribution; usually <strong class="userinput"><code>inetd</code></strong> or <strong class="userinput"><code>xinetd</code></strong> takes over this task. A glance at the documentation (should) put you straight.</p>

        <p>After modifying the configuration in <strong class="userinput"><code>pg_hba.conf</code></strong> you must stop the DBMS so that it can reload the configuration files. This is best done with the command</p><a id="I_programlisting3_d1e11122"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/postgresql reload</strong></span></pre>

        <p>(a restart is not necessary). If the configuration of the <strong class="userinput"><code>inetd/xinetd</code></strong> was modified, this daemon is reinitialized in the same way.</p>
      </div>

      <div class="sect3" title="The test plugin check_pgsql">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="the_test_plugin_check_underscore_pgsql"/>The test plugin <strong class="userinput"><code>check_pgsql</code></strong></h3>
        </div>

        <p><strong class="userinput"><code>check_pgsql</code></strong> has the following options:<a class="indexterm" id="IDX-CHP-6-0562"/><a class="indexterm" id="IDX-CHP-6-0563"/><a class="indexterm" id="IDX-CHP-6-0564"/></p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --hostname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

            <dd>
              <p>If given this option, the plugin establishes a TCP/IP connection instead of making contact with a local DBMS through a Unix socket.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-P</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

            <dd>
              <p>In contrast to the plugins discussed until now, <strong class="userinput"><code>check_pgsql</code></strong> uses a capital P to specify the port on which PostgreSQL is running. In its default value it is connected to port 5432. This option is only useful if PostgreSQL allows TCP/IP connections.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-d</code></strong> <strong class="userinput"><code><em class="replaceable"><code>database</code></em></code></strong> <strong class="userinput"><code>/ --database=</code></strong><strong class="userinput"><code><em class="replaceable"><code>database</code></em></code></strong></span></dt>

            <dd>
              <p>Specifies the name of the database to which the plugin should connect. If this detail is missing, it uses the standard database <strong class="userinput"><code>template1</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

            <dd>
              <p>This is the warning time in seconds for the performance time for the test.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

            <dd>
              <p>This is the critical limit for the performance time of the test in seconds.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>−1</code></strong> <strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong> <strong class="userinput"><code>/ --logname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong></span></dt>

            <dd>
              <p>This is the name of the user who should establish contact to the database.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>passwd</code></em></code></strong> <strong class="userinput"><code>/ --password=</code></strong><strong class="userinput"><code><em class="replaceable"><code>passwd</code></em></code></strong></span></dt>

            <dd>
              <p>This switch sets the password for access to the database. Since this must be stored in plain text in the service definition, a potential security problem is involved. It is preferable to explicitly define a restricted, password-free access to the database in the PostgreSQL configuration for the user <strong class="userinput"><code>nagios</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> <strong class="userinput"><code>/ --timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

            <dd>
              <p>After 10 seconds have expired, the plugin stops the test and returns the CRITICAL status. This option allows the default value to be changed.</p>
            </dd>
          </dl>
        </div>

        <p>To test the reachability across the network of the database <strong class="userinput"><code>nagdb</code></strong> set up specially for this purpose, this is passed on as a parameter together with the target host (here: <strong class="userinput"><code>linux01</code></strong>):</p><a id="I_programlisting3_d1e11307"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_pgsql -H linux01 -d nagdb</strong></span>
CRITICAL - no connection to 'nagdb' (FATAL: IDENT authentication failed
for user "nagios")</pre>

        <p>The fact that the check went wrong in the example is clearly due to the ident authentication. This happens, for example, if you forget to reload the ident daemon after the configuration has been modified. Once the error has been rectified, the plugin—hopefully—will work better:</p><a id="I_programlisting3_d1e11314"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_pgsql -H linux01 -d nagdb</strong></span>
OK - database nagdb (0 sec.)|time=0,000000s;2,000000;8,000000;0,000000</pre>

        <p>If the database parameter is omitted, <strong class="userinput"><code>check_pgsql</code></strong> will address the database <strong class="userinput"><code>template1</code></strong>:</p><a id="I_programlisting3_d1e11327"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_pgsql -H linux01</strong></span>
CRITICAL - no connection to 'template1' (FATAL: no pg_hba.conf entry fo
r host "172.17.129.2", user "nagios", database "template1", SSL off)</pre>

        <p>A similar result is obtained if you run the test with the correct database, but with the wrong user:</p><a id="I_programlisting3_d1e11334"/>
        <pre class="programlisting">wob@linux:nagios/libexec$ <span class="strong"><strong>./check_pgsql -H linux01 -d nagdb</strong></span>
CRITICAL - no connection to 'nagdb' (FATAL: no pg_hba.conf entry for ho
st "172.17.129.2", user "wob", database "nagdb", SSL off)</pre>

        <p>You should certainly run the last two tests, just to check that the PostgreSQL database really does reject corresponding requests. Otherwise you will have a security leak, and we recommend that you remove settings in the configuration that are too generous.</p>

        <p>If you have created a separate database for the check, there is no reason why you shouldn't write this explicitly in the command definition, instead of using parameters, with <strong class="userinput"><code>$ARG1$</code></strong>:</p><a id="I_programlisting3_d1e11347"/>
        <pre class="programlisting">define command{
    command_name <span class="strong"><strong>check_pgsql</strong></span>
    command_line $USER1$/<span class="strong"><strong>check_pgsql</strong></span> -H $HOSTADDRESS$ -d nagdb
}</pre>

        <p>Then the service definition for <strong class="userinput"><code>linux01</code></strong> is as simple as this:</p><a id="I_programlisting3_d1e11360"/>
        <pre class="programlisting">define service{
    service_description     PostgreSQL
    host_name               linux01
    <span class="strong"><strong>    check_command     check_pgsql</strong></span>
    ...
}</pre>
      </div>
    </div>

    <div class="sect2" title="6.8.2 MySQL">
      <div class="titlepage">
        <h2 class="title" id="heading_id_6"><a id="mysql"/>6.8.2 MySQL</h2>
      </div>

      <p>With the <strong class="userinput"><code>check_mysql</code></strong> plugin, MySQL databases can be tested both locally and across the network. For local connections, it makes contact via a Unix socket, and not via a real network connection.<a class="indexterm" id="IDX-CHP-6-0565"/><a class="indexterm" id="IDX-CHP-6-0566"/><a class="indexterm" id="IDX-CHP-6-0567"/></p>

      <div class="sect3" title="MySQL configuration">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="mysql_configuration"/>MySQL configuration</h3>
        </div>

        <p>In order that the database can be reached across the network, the <strong class="userinput"><code>skip-networking</code></strong> option in the configuration file <strong class="userinput"><code>my.cnf</code></strong> must be commented out. The database should then be running on TCP port 3306, which can be tested with <strong class="userinput"><code>netstat -ant</code></strong>, for example:</p><a id="I_programlisting3_d1e11402"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>netstat -ant | grep 3306</strong></span>
tcp 0 0 0.0.0.0:3306 0.0.0.0:* LISTEN</pre>

        <p>To set up the password-free access to the database relatively securely, a separate <strong class="userinput"><code>nagdb</code></strong> database is created here that does not contain any critical data, and for which the user <strong class="userinput"><code>nagios</code></strong> is given restricted access from the Nagios server. To do this, you connect yourself, as the database user <strong class="userinput"><code>root</code></strong>, to the database <strong class="userinput"><code>mysql</code></strong>, and there you create the database <strong class="userinput"><code>nagdb:</code></strong></p><a id="I_programlisting3_d1e11423"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>mysql --user=root mysql</strong></span>
mysql&gt; <span class="strong"><strong>CREATE DATABASE nagdb;</strong></span></pre>

        <p>If the command <strong class="userinput"><code>mysql --user=root mysql</code></strong> functions without the need to enter a <strong class="userinput"><code>root</code></strong> password, then you have a serious security problem. In that case, anyone—at least from the database server—is able to obtain full access to the database. If this is the case, it is essential that you read the security notes in the MySQL documentation.<sup>[<a class="footnote" href="#ftn.CHP-6-FN-19" id="CHP-6-FN-19">66</a>]</sup></p>

        <p>Recreating a user and the access restrictions can be done in one and the same step:</p><a id="I_programlisting3_d1e11445"/>
        <pre class="programlisting">mysql&gt; <span class="strong"><strong>GRANT select ON nagdb.* TO nagios@ ip-nagios;</strong></span></pre>

        <p>The command sets up the user <strong class="userinput"><code>nagios</code></strong>, if it does not exist. It may only accept connections from the Nagios server with the IP address <strong class="userinput"><code><em class="replaceable"><code>ip-nagios</code></em></code></strong> and obtains access to all tables in the database <strong class="userinput"><code>nagdb</code></strong>, but may execute only the <strong class="userinput"><code>SELECT</code></strong> command there (no <strong class="userinput"><code>INSERT</code></strong>, no <strong class="userinput"><code>UPDATE</code></strong> or <strong class="userinput"><code>DELETE</code></strong>); that is, user <strong class="userinput"><code>nagios</code></strong> only has read access.</p>
      </div>

      <div class="sect3" title="The test plugin check_mysql">
        <div class="titlepage">
          <h3 class="title" id="heading_id_8"><a id="the_test_plugin_check_underscore_mysql"/>The test plugin <strong class="userinput"><code>check_mysql</code></strong></h3>
        </div>

        <p><strong class="userinput"><code>check_mysql</code></strong> has fewer options than its PostgreSQL equivalent—apart from <strong class="userinput"><code>-H</code></strong>, it does not implement any standard flags and has neither a warning not a critical limit for the performance time of the test. For the database-specific options, it uses the same syntax as <strong class="userinput"><code>check_pgsql</code></strong>, except for the user entry:<a class="indexterm" id="IDX-CHP-6-0568"/></p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --hostname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

            <dd>
              <p>This sets the host name or IP address of the database server. If the option <strong class="userinput"><code>-H</code></strong> is omitted, or if it is used in connection with the argument <strong class="userinput"><code>localhost</code></strong>, <strong class="userinput"><code>check_mysql</code></strong> does not set up a network connection but uses a Unix socket. If you want to establish an IP connection to <strong class="userinput"><code>localhost</code></strong>, you must explicitly specify the IP address <strong class="userinput"><code>127.0.0.1</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-P</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

            <dd>
              <p>This is the TCP port on which MySQL is installed. In the default, port 3306 is used.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-d</code></strong> <strong class="userinput"><code><em class="replaceable"><code>database</code></em></code></strong> <strong class="userinput"><code>/ --database=</code></strong><strong class="userinput"><code><em class="replaceable"><code>database</code></em></code></strong></span></dt>

            <dd>
              <p>This is the name of the database to which the plugin should set up a connection. If this option is omitted, it only makes a connection to the database process, without addressing a specific database.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong> <strong class="userinput"><code>/ --username=</code></strong><strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong></span></dt>

            <dd>
              <p>This is the user in whose name the plugin should log in to the DBMS.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>passwd</code></em></code></strong> <strong class="userinput"><code>/ --password=</code></strong><strong class="userinput"><code><em class="replaceable"><code>passwd</code></em></code></strong></span></dt>

            <dd>
              <p>This switch is used to provide the password for logging in to the database.</p>
            </dd>
          </dl>
        </div>

        <p>To set up a connection to the database <strong class="userinput"><code>nagdb</code></strong> as the user <strong class="userinput"><code>nagios</code></strong>, both parameters are passed on to the plugin:</p><a id="I_programlisting3_d1e11604"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_mysql -H dbhost -u nagios -d nagdb</strong></span>
Uptime: 19031 Threads: 2 Questions: 80 Slow queries: 0 Opens: 12
Flush tables: 1 Open tables: 6 Queries per second avg: 0.004</pre>

        <p>In contrast to PostgreSQL, with MySQL you can also make contact without establishing a connection to a specific database:</p><a id="I_programlisting3_d1e11611"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_mysql -H dbhost</strong></span>
Uptime: 19271 Threads: 1 Questions: 84 Slow queries: 0 Opens: 12
Flush tables: 1 Open tables: 6 Queries per second avg: 0.004</pre>

        <p>With a manual connection to the database, with <strong class="userinput"><code>mysql</code></strong>, you can then subsequently change to the desired database, using the MySQL command <strong class="userinput"><code>use</code></strong>:</p><a id="I_programlisting3_d1e11624"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>mysql -u nagios</strong></span>
mysql&gt; <span class="strong"><strong>use nagdb</strong></span>;
Database changed
mysql&gt;</pre>

        <p>With this plugin, a subsequent database change is not possible. Here you must decide from the beginning whether you want to contact a database or whether you just want to establish a connection to the MySQL database system.</p>

        <p>To test a <strong class="userinput"><code>nagdb</code></strong> database set up explicitly for this purpose, you can do without parameters when creating the corresponding command object, and explicitly specify both user and database:</p><a id="I_programlisting3_d1e11640"/>
        <pre class="programlisting">define command{
   command_name <span class="strong"><strong>check_mysql</strong></span>
   command_line $USER1$/<span class="strong"><strong>check_mysql</strong></span> -H $HOSTADDRESS$ -u nagios -d nagdb
}</pre>

        <p>This simplifies the service definition:</p><a id="I_programlisting3_d1e11650"/>
        <pre class="programlisting">define service{
   service_description     MySQL
   host_name               linux01
   <span class="strong"><strong>check_command               check_mysql</strong></span>
   ...
}</pre>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-15" id="ftn.CHP-6-FN-15">62</a>]</sup> The plugin <strong class="userinput"><code>check_oracle</code></strong> assumes the installation of an Oracle Full Client on the Nagios server; it does not work together with the Instant Client and expects its users to have an extensive knowledge of Oracle. To explain all this here is far beyond the scope of this book.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-16" id="ftn.CHP-6-FN-16">63</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/153;3">http://www.nagiosexchange.org/153;3</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-17" id="ftn.CHP-6-FN-17">64</a>]</sup> Permissions in PostgreSQL are given by the database command <strong class="userinput"><code>GRANT</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-18" id="ftn.CHP-6-FN-18">65</a>]</sup> <a class="ulink" href="http://www.lysator.liu.se/~pen/pidentd/">http://www.lysator.liu.se/~pen/pidentd/</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-19" id="ftn.CHP-6-FN-19">66</a>]</sup> To be found at <a class="ulink" href="http://dev.mysql.com/doc/mysql/de/Security.html">http://dev.mysql.com/doc/mysql/de/Security.html</a>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="6.9 Monitoring LDAP Directory Services">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_ldap_directory_services"/>6.9 Monitoring LDAP Directory Services</h1>
    </div>

    <p>For monitoring LDAP directory services, the <strong class="userinput"><code>check_ldap</code></strong> plugin is available. It runs a search query that can be specified anonymously or with authentication. It has the following parameters to do this:<a class="indexterm" id="IDX-CHP-6-0569"/><a class="indexterm" id="IDX-CHP-6-0570"/><a class="indexterm" id="IDX-CHP-6-0571"/></p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --hostname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

        <dd>
          <p>This is the host name or IP address of the LDAP server.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-b</code></strong> <strong class="userinput"><code><em class="replaceable"><code>base_dn</code></em></code></strong> <strong class="userinput"><code>/ --base=</code></strong><strong class="userinput"><code><em class="replaceable"><code>base_dn</code></em></code></strong></span></dt>

        <dd>
          <p>This is the top element (<span class="emphasis"><em>Base Domain Name</em></span>) of the LDAP directory, formed for example from the components of the domain name: <strong class="userinput"><code>dc=swobspace,dc=de</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

        <dd>
          <p>This is the port on which the LDAP server is running. The default is the standard port 389.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-a</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"ldap-attribute"</code></em></code></strong> <strong class="userinput"><code>/ --attr=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"ldap-attribute"</code></em></code></strong></span></dt>

        <dd>
          <p>This switch enables a search according to specific attributes. Thus <strong class="userinput"><code>-a "(objectclass=inetOrgPerson)"</code></strong> searches for all nodes in the directory tree containing the object class <strong class="userinput"><code>inetOrgPerson</code></strong> (normally used for telephone and e-mail directories, for example).</p>

          <p>Specifying attributes in the check is less useful than it may seem. If you search through an LDAP directory for nonexistent attributes, you will normally receive an answer with zero results, but no errors.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-D</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ldap_bind_dn</code></em></code></strong> <strong class="userinput"><code>/ --bin.d=</code></strong><strong class="userinput"><code><em class="replaceable"><code>ldap_bind_dn</code></em></code></strong></span></dt>

        <dd>
          <p>This specifies a bind DN<sup>[<a class="footnote" href="#ftn.CHP-6-FN-20" id="CHP-6-FN-20">67</a>]</sup> for an authenticated connection, such as:</p><a id="I_programlisting3_d1e11783"/>
          <pre class="programlisting">uid=wob,dc=swobspace,dc=de</pre>

          <p>Without this entry, the plugin establishes an anonymous connection.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-P</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ldap_passwd</code></em></code></strong> <strong class="userinput"><code>/ --pass=</code></strong><strong class="userinput"><code><em class="replaceable"><code>ldap_passwd</code></em></code></strong></span></dt>

        <dd>
          <p>This is the password for an authenticated connection. It only makes sense in conjunction with the option <strong class="userinput"><code>-D</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> <strong class="userinput"><code>/ --timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

        <dd>
          <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds have expired (<strong class="userinput"><code>10</code></strong> seconds if this option is not given), the plugin stops the test and returns the CRITICAL status.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>−2</code></strong> <strong class="userinput"><code>/ --ver2</code></strong></span></dt>

        <dd>
          <p>Use LDAP version v2 (the default). If the server does not support this protocol version, the connection will fail. In OpenLDAP from version 2.1, v3 is used by default; to activate protocol version v2, the following line is entered in the configuration file <strong class="userinput"><code>slapd.conf</code></strong>:</p><a id="I_programlisting3_d1e11844"/>
          <pre class="programlisting">allow bind_v2</pre>

          <p>Many clients, such as Mozilla and the Thunderbird address book, are still using LDAP version v2.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>−3 / --ver3</code></strong></span></dt>

        <dd>
          <p>Use LDAP version v3. For many modern LDAP servers such as Open-LDAP, this is now the standard, but they usually also have parallel support for the older version v2, since various clients cannot yet implement v3.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

        <dd>
          <p>If the performance time of the plugin exceeds <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> seconds, it issues a warning.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong></span></dt>

        <dd>
          <p>If the performance time of the plugin exceeds <strong class="userinput"><code><em class="replaceable"><code>floating_point_dec</code></em></code></strong> seconds, it returns CRITICAL.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-T</code></strong> <strong class="userinput"><code>/ --starttls</code></strong></span></dt>

        <dd>
          <p>Uses the STARTTLS intended in LDAPv3.<sup>[<a class="footnote" href="#ftn.CHP-6-FN-21" id="CHP-6-FN-21">68</a>]</sup></p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-S</code></strong> <strong class="userinput"><code>/ --ssl</code></strong></span></dt>

        <dd>
          <p>Uses SSL encrypted LDAP (LDAPS) from LDAPv2 and at the same time sets the port used for this, port 636. Whenever possible you should choose STARTTLS. LDAP with STARTTLS uses the same port as LDAP without SSL encryption; in many cases this allows the unencrypted LDAP access to be configured as a fallback for LDAP with STARTTLS. Such a fallback is not possible for LDAPS due to the different ports.</p>
        </dd>
      </dl>
    </div>

    <p>In the simplest case it is sufficient to query whether the LDAP server really does own the base DN specified with <strong class="userinput"><code>-b</code></strong>:</p><a id="I_programlisting3_d1e11928"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_ldap -H ldap.swobspace.de</strong></span> \
<span class="strong"><strong>    -b "dc=swobspace,c=de"</strong></span>
LDAP OK - 0,002 seconds response time|time=0,002186s;;;0,000000</pre>

    <p>This query corresponds to the following command object:<a class="indexterm" id="IDX-CHP-6-0572"/></p><a id="I_programlisting3_d1e11946"/>
    <pre class="programlisting">define command{
    command_name <span class="strong"><strong>check_ldap</strong></span>
    command_line $USER1$/<span class="strong"><strong>check_ldap</strong></span> -H $HOSTADDRESS$ -b $ARG1$
}</pre>

    <p>Since an LDAP server can handle many LDAP directories with different base DNs, it is recommended that you configure this with parameters:</p><a id="I_programlisting3_d1e11956"/>
    <pre class="programlisting">define service{
   service_description    LDAP
   host_name              linux01
   <span class="strong"><strong>   check_command     check_ldap!dc=swobspace,dc=de</strong></span>
   ...
}</pre>

    <p>If authentication is involved, things get slightly more complicated. On the one hand the plugin is given the bind-DN of the <strong class="userinput"><code>nagios</code></strong> user, with <strong class="userinput"><code>-D</code></strong>. On the other hand, the following example protects the necessary password from curious onlookers by storing this as the macro <strong class="userinput"><code>$USER3$</code></strong> in the file <strong class="userinput"><code>resource.cfg</code></strong>, which may be readable only for the user <strong class="userinput"><code>nagios</code></strong> (see <a class="xref" href="../Text/ch02s14.html" title="2.14 The Resources File resource.cfg">2.14 The Resources File resource.cfg</a>, page 79):</p><a id="I_programlisting3_d1e11981"/>
    <pre class="programlisting">define command{
   command_name <span class="strong"><strong>check_ldap_auth</strong></span>
   command_line $USER1$/<span class="strong"><strong>check_ldap</strong></span> -H $HOSTADDRESS$ -b $ARG1$ -D $ARG2$
-P $USER3$
}</pre>

    <p>Accordingly, the matching service definition contains the base DN and bind DN as arguments, but not the password:</p><a id="I_programlisting3_d1e11992"/>
    <pre class="programlisting">define service{
    service_description     LDAP
    host_name               linux01
<span class="strong"><strong>    check_command check_ldap_auth!dc=swobspace,dc=de!uid=nagios,</strong></span>\
<span class="strong"><strong>    dc=swobspace,dc=de</strong></span>
   ...
}</pre>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-20" id="ftn.CHP-6-FN-20">67</a>]</sup> A bind DN serves to identify the user and refers to the user's nodes in the directory tree, specifying all the overlying nodes. The bind DN in LDAP corresponds in its function more or less to the user name when logging in under Unix.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-21" id="ftn.CHP-6-FN-21">68</a>]</sup> See footnote in <a class="xref" href="../Text/ch06s03.html#pop_and_imap" title="6.3.2 POP and IMAP">6.3.2 POP and IMAP</a>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="6.10 Checking a DHCP Server">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="checking_a_dhcp_server"/>6.10 Checking a DHCP Server</h1>
    </div>

    <p>To monitor DHCP services, the plugin <strong class="userinput"><code>check_dhcp</code></strong> is available. It sends a <strong class="userinput"><code>DHCPDISCOVER</code></strong> via UDP broadcast to the target port 67 and waits for an offer from a DHCP server in the form of a <strong class="userinput"><code>DHCPOFFER</code></strong>, which offers an IP address and further configuration information.<a class="indexterm" id="IDX-CHP-6-0573"/></p>

    <p>Because <strong class="userinput"><code>check_dhcp</code></strong> does not send a <strong class="userinput"><code>DHCPREQUEST</code></strong> after this, the server does not need to reserve the sources and to confirm this reservation with <strong class="userinput"><code>DHCPACK</code></strong>, nor does it need to reject the request with <strong class="userinput"><code>DHCPNACK</code></strong>.</p>

    <div class="sect2" title="Granting the plugin root permissions">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="granting_the_plugin_root_permissions"/>Granting the plugin <strong class="userinput"><code>root</code></strong> permissions</h2>
      </div>

      <div class="sect3" title="Granting the plugin root permissions">
        <div class="titlepage">
          <h3 class="title" id="heading_id_4"><a id="granting_the_plugin_root_permissions-id1"/>Granting the plugin <strong class="userinput"><code>root</code></strong> permissions</h3>
        </div>

        <p>There is a further restriction to the <strong class="userinput"><code>check_dhcp</code></strong>: it requires full access to the network interface and must therefore run with <strong class="userinput"><code>root</code></strong> privileges.</p>

        <p>In order for the user <strong class="userinput"><code>nagios</code></strong> to be able to run the plugin with <strong class="userinput"><code>root</code></strong> permissions, the plugin must belong to the user <strong class="userinput"><code>root</code></strong> and the SUID bit must be set. If you install the plugins from a current tarball, the permissions will be set correctly. Several distributions disable the SUID bit, as it represents a potential danger—it is possible that general <strong class="userinput"><code>root</code></strong> permissions may slip in via buffer overflows in uncleanly programmed code. Here the program owner must be changed manually to the user <strong class="userinput"><code>root</code></strong> so that the SUID bit can be set with <strong class="userinput"><code>chmod</code></strong>. When this is done, only the group <strong class="userinput"><code>nagios</code></strong>, apart from <strong class="userinput"><code>root</code></strong>, is allowed to run the plugin:</p><a id="I_programlisting3_d1e12078"/>
        <pre class="programlisting">linux:nagios/libexec # <span class="strong"><strong>chown root.nagios check_dhcp</strong></span>
linux:nagios/libexec # <span class="strong"><strong>chmod 4750 check_dhcp</strong></span>
linux:nagios/libexec # <span class="strong"><strong>ls -l check_dhcp</strong></span>
-rwsr-x--- 1 root nagios 115095 Jan 8 12:15 check_dhcp</pre>

        <p>The <strong class="userinput"><code>chown</code></strong> command assigns the plugin to the user <strong class="userinput"><code>root</code></strong> and to the group <strong class="userinput"><code>nagios</code></strong>, to whom nobody else should belong apart from the user <strong class="userinput"><code>nagios</code></strong> itself. (The user in whose name the Web server is running should be a member of a different group, such as <strong class="userinput"><code>nagcmd</code></strong>, as is described in <a class="xref" href="../Text/ch01.html" title="Chapter 1. Installation">Chapter 1</a> from page 37.)</p>

        <p>In addition the <strong class="userinput"><code>chmod</code></strong> ensures that nobody apart from <strong class="userinput"><code>root</code></strong> may even read the plugin file, let alone edit it.</p>
      </div>

      <div class="sect3" title="Applying the plugin">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="applying_the_plugin"/>Applying the plugin</h3>
        </div>

        <p><strong class="userinput"><code>check_dhcp</code></strong> only the following options:</p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>server_ip</code></em></code></strong> <strong class="userinput"><code>/ --serverip=</code></strong><strong class="userinput"><code><em class="replaceable"><code>server_ip</code></em></code></strong></span></dt>

            <dd>
              <p>This is the IP address of a DHCP server that the plugin should explicitly query. Without this entry, it is sufficient to have a functioning DHCP server in the network to pass the test satisfactorily. So you have to decide whether you want to test the general availability of the DHCP service or the functionality of a specific DHCP server.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-r</code></strong> <strong class="userinput"><code><em class="replaceable"><code>requested_ip</code></em></code></strong> <strong class="userinput"><code>/ --requestedip=</code></strong><strong class="userinput"><code><em class="replaceable"><code>requested_ip</code></em></code></strong></span></dt>

            <dd>
              <p>With this option the plugin attempts to obtain the IP address <strong class="userinput"><code><em class="replaceable"><code>requested_ip</code></em></code></strong> from the server. If this is not successful because it is already reserved or lies outside the configured area, <strong class="userinput"><code>check_dhcp</code></strong> reacts with a warning.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-i</code></strong> <strong class="userinput"><code><em class="replaceable"><code>interface</code></em></code></strong> <strong class="userinput"><code>/ --interface=</code></strong><strong class="userinput"><code><em class="replaceable"><code>interface</code></em></code></strong></span></dt>

            <dd>
              <p>This selects a specific network interface through which the DHCP request should pass. Without this parameter, the plugin always uses the first network card to be configured (in Linux, usually <strong class="userinput"><code>ethO</code></strong>).</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-m</code></strong> <strong class="userinput"><code><em class="replaceable"><code>mac_address</code></em></code></strong> <strong class="userinput"><code>/ -mac=</code></strong><strong class="userinput"><code><em class="replaceable"><code>mac_address</code></em></code></strong> (from version 1.4.10)</span></dt>

            <dd>
              <p>Uses the specified MAC address in DHCP queries instead of that of the Nagios server. This explicit detail is required if the DHCP server only assigns IP addresses to specific MAC addresses, and the MAC address of the Nagios server is not one of these.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code>/ --unicast</code></strong> (from version 1.4.10)</span></dt>

            <dd>
              <p>Sends a unicast message instead of a broadcast.<sup>[<a class="footnote" href="#ftn.CHP-6-FN-22" id="CHP-6-FN-22">69</a>]</sup> The IP address to which the DHCP request is addressed is specified with <strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>server_ip</code></em></code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> <strong class="userinput"><code>/ --timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

            <dd>
              <p>After <strong class="userinput"><code>10</code></strong> seconds have expired (the default), otherwise <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds, the plugin stops the test and returns the CRITICAL state.</p>
            </dd>
          </dl>
        </div>

        <p>With a configurable warning or critical limit for the performance time, the plugin is of no use. Here you must, where necessary, explicitly set a timeout, which causes the CRITICAL return value to be issued.</p>

        <p>The following example shows that the DHCP service in the network is working:</p><a id="I_programlisting3_d1e12254"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>   ./check_dhcp -i eth0</strong></span>
DHCP ok: Received 1 DHCPOFFER(s), max lease time = 600 sec.</pre>

        <p>The plugin includes only the <strong class="userinput"><code><em class="replaceable"><code>lease time</code></em></code></strong> as additional information, that is, the time for which the client would be assigned an IP address. If you want to see all the information contained in <strong class="userinput"><code>DHCPOFFER</code></strong>, you should use the option <strong class="userinput"><code>-v</code></strong> ("verbose").</p>

        <p>In the next example the plugin explicitly requests a specific IP address (<strong class="userinput"><code>192.168.1.40</code></strong>), but this is not available:</p><a id="I_programlisting3_d1e12276"/>
        <pre class="programlisting">nagios@linux:nagios/libexec$<span class="strong"><strong>   ./check_dhcp -i ethO -r 192.168.1.40</strong></span>
DHCP problem: Received 1 DHCPOFFER(s), requested address (192.168.1.40)
was not offered, max lease time = 600 sec.
nagios@linux:nagios/libexec$ <span class="strong"><strong>echO $?</strong></span>
1</pre>

        <p>The result is a WARNING, as is shown by the output of the status, with <strong class="userinput"><code>$?</code></strong>.</p>

        <p>If you want to test both the availability of the DHCP service overall and the servers in question individually, you need two different commands:</p><a id="I_programlisting3_d1e12292"/>
        <pre class="programlisting">define command{
   command_name <span class="strong"><strong>check_dhcp_service</strong></span>
   command_line $USER1$/<span class="strong"><strong>check_dhcp</strong></span> -i etho
}</pre>

        <p><strong class="userinput"><code>check_dhcp_service</code></strong> grills the DHCP service as a whole by sending a broadcast, to which any DHCP server at all may respond.</p><a id="I_programlisting3_d1e12304"/>
        <pre class="programlisting">define command{
  command_name <span class="strong"><strong>check_dhcp_server</strong></span>
  command_line $USER1$/<span class="strong"><strong>check_dhcp</strong></span> -i etho -s $HOSTADDRESS$
}</pre>

        <p><strong class="userinput"><code>check_dhcp_server</code></strong> on the other hand explicitly tests the DHCP service on a specific server.</p>

        <p>To match this, you can then define one service that monitors DHCP as a whole and another one that tests DHCP for a specific host. Even if the first variation is in principle not host-specific, it still needs to be assigned explicitly to a computer for it to run in Nagios:</p><a id="I_programlisting3_d1e12318"/>
        <pre class="programlisting">define service{
   service_description    DHCP Services
   host_name              linux01
<span class="strong"><strong>   check_command      check_dhcp_service</strong></span>
   ...
}

define service{
   service_description     DHCP Server
   host_name               linux01
<span class="strong"><strong>   check_command     check_dhcp_server</strong></span>
   ...
}</pre>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-22" id="ftn.CHP-6-FN-22">69</a>]</sup> A unicast message is addressed to exactly one IP address, whereas a broadcast message is meant for all stations in the local network.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="6.11 Monitoring UPS with the Network UPS Tools">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_ups_with_the_network_ups_to"/>6.11 Monitoring UPS with the Network UPS Tools</h1>
    </div>

    <p>There are two possibilities for monitoring uninterruptible power supplies (UPS): the <span class="emphasis"><em>Network UPS Tools</em></span> support nearly all standard devices. The <strong class="userinput"><code>apcupsd</code></strong> daemon is specifically tailored to UPS's from the company APC, described in <a class="xref" href="../Text/ch07s10.html" title="7.10 Monitoring UPSs with apcupsd">7.10 Monitoring UPSs with apcupsd</a> from page 182. The plugin <strong class="userinput"><code>check_ups</code></strong> included in Nagios only supports the first implementation.<a class="indexterm" id="IDX-CHP-6-0576"/><a class="indexterm" id="IDX-CHP-6-0577"/><a class="indexterm" id="IDX-CHP-6-0578"/><a class="indexterm" id="IDX-CHP-6-0579"/><a class="indexterm" id="IDX-CHP-6-0574"/><a class="indexterm" id="IDX-CHP-6-0575"/></p>

    <p>The following rule generally applies: no plugin directly accesses the UPS interface. Rather they rely on a corresponding daemon that monitors the UPS and provides status information. This daemon primarily serves the purpose of shutting down the connected servers in time in case of a power failure. But it also always provides status information, which plugins can query and which can be processed by Nagios.</p>

    <p>Both the solution with the Network UPS Tools and that with <strong class="userinput"><code>apcupsd</code></strong> are fundamentally network-capable, that is, the daemon is always queried via TCP/IP (through a proprietary protocol, or alternatively SNMP). But you should be aware here that a power failure may affect the transmission path, so that the corresponding information might no longer even reach Nagios. Monitoring via the network therefore makes sense only if the entire network path is safeguarded properly against power failure. In the ideal scenario, the UPS is connected directly to the Nagios server. Calling the <strong class="userinput"><code>check_ups</code></strong> plugin is no different in this case from that for the network configuration, since even for local use it communicates via TCP/IP—but in this case, with the host <strong class="userinput"><code>localhost</code></strong>.</p>

    <div class="sect2" title="The Network UPS Tools">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="the_network_ups_tools"/>The Network UPS Tools</h2>
      </div>

      <div class="sect3" title="The Network UPS Tools">
        <div class="titlepage">
          <h3 class="title" id="heading_id_4"><a id="the_network_ups_tools-id1"/>The Network UPS Tools</h3>
        </div>

        <p>The Network UPS Tools is a manufacturer-independent package containing tools for monitoring uninterruptible power supplies. Different specific drivers take care of hardware access, so that new power supplies can be easily supported, provided their protocols are known.<a class="indexterm" id="IDX-CHP-6-0580"/></p>

        <p>The remaining functionality is also spread across various programs: while the daemon <strong class="userinput"><code>upsd</code></strong> provides information, the program <strong class="userinput"><code>upsmon</code></strong> shuts down the computers supplied by the UPS in a controlled manner. It takes care both of machines connected via serial interface to the UPS and, in client/ server mode, of computers supplied via the network.<a class="indexterm" id="IDX-CHP-6-0581"/><a class="indexterm" id="IDX-CHP-6-0582"/></p>

        <p><a class="ulink" href="http://www.networkupstools.org/">http://www.networkupstools.org/</a> lists the currently supported models and provides further information on the topic of UPS. Standard distributions already contain the software, but not always with package names that are very obvious: in SuSE and Debian they are known by the name of <strong class="userinput"><code>nut</code></strong>.<a class="indexterm" id="IDX-CHP-6-0583"/></p>

        <p>To query the information provided by the daemon <strong class="userinput"><code>upsd</code></strong>, there is the <strong class="userinput"><code>check_ups</code></strong> plugin from the Nagios Plugin package. It queries the status of the UPS through the network UPS Tools' own network protocol. A subproject also allows it to query the power supplies via SNMP.<sup>[<a class="footnote" href="#ftn.CHP-6-FN-23" id="CHP-6-FN-23">70</a>]</sup> However, further development on it is not taking place at the present time.<a class="indexterm" id="IDX-CHP-6-0584"/></p>

        <p>For purely monitoring purposes via Nagios (without shutting down the computer automatically, depending on the test result), it is sufficient to configure and start the <strong class="userinput"><code>upsd</code></strong> on the host to which the UPS is connected via serial cable. The relevant configuration file in the directory <strong class="userinput"><code>/etc/nut</code></strong> is called <strong class="userinput"><code>ups.conf</code></strong>. If you perform the query via the network, you must normally add an entry for the Nagios server in the (IP-based) access permissions. Detailed information can be found directly in the files themselves or in the documentation included, which in Debian is in the directory <strong class="userinput"><code>/usr/share/doc/nut</code></strong>, and in SuSE, in <strong class="userinput"><code>/usr/share/doc/packages/nut</code></strong>.</p>

        <p>Provided that the Network UPS Tools include a suitable driver for the uninterruptable power supply used, the driver and communication interface are entered in the file <strong class="userinput"><code>ups.conf</code></strong>:</p><a id="I_programlisting3_d1e12447"/>
        <pre class="programlisting"># -- /etc/nut/ups.conf

[upsfw]
    driver = apcsmart
    port = /dev/ttySO
    desc = "Firewalling/DMZ"</pre>

        <p>In the example, a UPS of the company APC is used. Communication takes place on the serial interface <strong class="userinput"><code>/dev/ttySO</code></strong>. A name for the UPS is given in square brackets, with which it is addressed later on: <strong class="userinput"><code>desc</code></strong> can be used to describe the intended purpose of the UPS in more detail, but Nagios ignores this.</p>

        <p>Next you must ensure that the user with whose permissions the Network UPS Tools are running (such as the user <strong class="userinput"><code>nut</code></strong> from the group <strong class="userinput"><code>nut</code></strong>) has full access to the interface <strong class="userinput"><code>/dev/ttySO</code></strong>:</p><a id="I_programlisting3_d1e12468"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>chown nut:nut /dev/ttyS0</strong></span>
user@linux:~$ <span class="strong"><strong>chmod 660 /dev/ttyS0</strong></span></pre>

        <p>In order for Nagios to access information from the UPS via the <strong class="userinput"><code>upsd</code></strong> daemon, corresponding data is entered in an Access Control List in the <strong class="userinput"><code>upsd</code></strong> configuration file <strong class="userinput"><code>upsd.conf</code></strong>:</p><a id="I_programlisting3_d1e12487"/>
        <pre class="programlisting"># -- /etc/nut/upsd.conf

# ACL <span class="emphasis"><em>aclname ipblock</em></span>
ACL all 0.0.0.0/0
ACL localhost 127.0.0.1/32
ACL nagios 172.17.129.2/32

ACCEPT localhost nagios
REJECT all</pre>

        <p>With the keyword <strong class="userinput"><code>ACL</code></strong> you first define hosts and network ranges with their IP address. You must always specify a network block here: <strong class="userinput"><code>/32</code></strong> means that all 32 bits of the netmask are set to 1 (this corresponds to 255.255.255.255), which is therefore a single host address. It is not sufficient just to specify the IP address here.</p>

        <p>An <strong class="userinput"><code>ACCEPT</code></strong> entry allows access for the computer specified in the ACL <strong class="userinput"><code><em class="replaceable"><code>acl-name</code></em></code></strong>. <strong class="userinput"><code>ACCEPT</code></strong> rules may be used more than once. The final <strong class="userinput"><code>REJECT</code></strong> entry then refuses access to all other hosts.</p>

        <p>To conclude the configuration, you should make sure that the UPS daemon is started with every system start. In SuSE this is done via YaST2; in Debian this is taken care of during the installation.</p>
      </div>

      <div class="sect3" title="The check_ups plugin">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="the_check_underscore_ups_plugin"/>The check_ups plugin</h3>
        </div>

        <p>The monitoring plugin itself has the following options:<a class="indexterm" id="IDX-CHP-6-0585"/></p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

            <dd>
              <p>This is the computer on which <strong class="userinput"><code>upsd</code></strong> is installed.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code><em class="replaceable"><code>identifier</code></em></code></strong> <strong class="userinput"><code>/ --ups=</code></strong><strong class="userinput"><code><em class="replaceable"><code>identifier</code></em></code></strong></span></dt>

            <dd>
              <p>This is the name for the UPS in <strong class="userinput"><code>ups.conf</code></strong>, specified in square brackets.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

            <dd>
              <p>This is the number of the port on which the <strong class="userinput"><code>upsd</code></strong> is running. The default is TCP port 3493.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>whole_number</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>whole_number</code></em></code></strong></span></dt>

            <dd>
              <p>This switch defines a warning limit as a whole number. If no variable is given (see <strong class="userinput"><code>-v</code></strong>), <strong class="userinput"><code><em class="replaceable"><code>whole_number</code></em></code></strong> means a response time in seconds; otherwise the value range of the variable (e.g., <strong class="userinput"><code>80</code></strong> for 80% in <strong class="userinput"><code>BATTPCT</code></strong>). Specifying multiple warning limits is currently not possible: the plugin then only uses the last variable and the last warning limit.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>whole_number</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>whole_number</code></em></code></strong></span></dt>

            <dd>
              <p>This option specifies a critical limit in connection with a variable (see <strong class="userinput"><code>-v</code></strong>).</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-v</code></strong> <strong class="userinput"><code><em class="replaceable"><code>variable</code></em></code></strong> <strong class="userinput"><code>/ --variable=</code></strong><strong class="userinput"><code><em class="replaceable"><code>variable</code></em></code></strong></span></dt>

            <dd>
              <p>With this option, specific values of the UPS can be queried. The limit values then referred to this parameter. <strong class="userinput"><code>check_ups</code></strong> currently supports only the following variables:<a class="indexterm" id="IDX-CHP-6-0586"/><a class="indexterm" id="IDX-CHP-6-0587"/></p>

              <div class="variablelist">
                <dl>
                  <dt><span class="term"><strong class="userinput"><code>LINE:</code></strong></span></dt>

                  <dd>
                    <p>input voltage of the UPS.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>TEMP:</code></strong></span></dt>

                  <dd>
                    <p>Temperature of the USV.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>BATTPCT:</code></strong></span></dt>

                  <dd>
                    <p>Remaining battery capacity in percent.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>LOADPCT:</code></strong></span></dt>

                  <dd>
                    <p>Load on the UPS in percent.</p>
                  </dd>
                </dl>
              </div>

              <p>If this option is missing, the plugin only checks the status of the UPS (online or offline).</p>

              <p>Since <strong class="userinput"><code>-v</code></strong> thus has another value, <strong class="userinput"><code>check_ups</code></strong> does not know the obligatory option <strong class="userinput"><code>--verbose</code></strong> (see <a class="xref" href="../Text/ch06.html#standard_options_of_plugins" title="Table 6-2. Standard options of plugins">Table 6-2</a> in page 108), even in its long form.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-T /--temperature</code></strong></span></dt>

            <dd>
              <p>This command issues temperature values in degrees Celsius instead of Fahrenheit.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> <strong class="userinput"><code>/ --timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

            <dd>
              <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds have expired, the plugin stops the test and returns the CRITICAL state. The default is <strong class="userinput"><code>10</code></strong> seconds.</p>
            </dd>
          </dl>
        </div>

        <p>The following example tests the above defined local UPS with the name <strong class="userinput"><code>upsfw</code></strong>. The <strong class="userinput"><code>-T</code></strong> switch ensures that the output of the temperature is given in degrees Celsius:</p><a id="I_programlisting3_d1e12752"/>
        <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_ups -H localhost -u upsfw -T</strong></span>
UPS OK - Status=Online Utility=227.5V Batt=100.0% Load=27.0% Temp=30.6C|
voltage=227500mV;;;0 battery=100%;;;0;100 load=27%;;;0;100 temp=30degF;;
;0</pre>

        <p>If a variable is not used, the plugin returns a CRITICAL if the UPS is switched off (<strong class="userinput"><code>Status=Off</code></strong>) or has reached low battery capacity (<strong class="userinput"><code>Status=0n Battery, Low Battery</code></strong>). <strong class="userinput"><code>check_ups</code></strong> issues a warning if at least one of the three states <strong class="userinput"><code>On Battery</code></strong>, <strong class="userinput"><code>Low Battery</code></strong>, or <strong class="userinput"><code>Replace Battery</code></strong> applies, but this is not sufficient for a CRITICAL status (for example, because of correspondingly set variables). With <strong class="userinput"><code>On Battery</code></strong> the power supply is provided by the battery, with <strong class="userinput"><code>Low Battery</code></strong> the UPS is online with a low battery state, and with <strong class="userinput"><code>Replace Battery</code></strong>, the battery must be replaced.</p>

        <p>If none of these points apply, the plugin issues an OK for the following states:</p>

        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem">
              <p>In the normal <strong class="userinput"><code>online</code></strong> state</p>
            </li>

            <li class="listitem">
              <p>If the UPS is being calibrated (<strong class="userinput"><code>Calibrating</code></strong>)</p>
            </li>

            <li class="listitem">
              <p>If it is currently being bypassed and the power supply is provided directly from the power supply grid (<strong class="userinput"><code>On Bypass</code></strong>)</p>
            </li>

            <li class="listitem">
              <p>If the UPS is overloaded (<strong class="userinput"><code>Overload</code></strong>)</p>
            </li>

            <li class="listitem">
              <p>If the voltage in the power grid is too high and the UPS restricts the voltage to the normal value (<strong class="userinput"><code>Trimming</code></strong>)</p>
            </li>

            <li class="listitem">
              <p>If the voltage in the power grid is too low and is supplemented by the UPS (<strong class="userinput"><code>Boosting</code></strong>)</p>
            </li>

            <li class="listitem">
              <p>If the UPS is currently being charged (<strong class="userinput"><code>Charging</code></strong>)</p>
            </li>

            <li class="listitem">
              <p>If the UPS is currently being discharged (e.g., during a programmed maintenance procedure) (<strong class="userinput"><code>Discharging</code></strong>)</p>
            </li>
          </ul>
        </div>

        <p>Transformed into a command object, the above test for any host looks like this:</p><a id="I_programlisting3_d1e12840"/>
        <pre class="programlisting">define command{
    command_name<span class="strong"><strong>   check_ups</strong></span>
    command_line   $USER1$/<span class="strong"><strong>check_ups</strong></span> -H $HOSTADDRESS$ -u $ARG1$ -T
}</pre>

        <p>The corresponding service definition for the computer <strong class="userinput"><code>linux01</code></strong>, to which the UPS is connected, and for the above defined UPS <strong class="userinput"><code>upsfw</code></strong>, would then look like this:</p><a id="I_programlisting3_d1e12857"/>
        <pre class="programlisting">define service{
   service_description    UPS
   host_name              linux01
<span class="strong"><strong>   check_command     check_ups!upsfw</strong></span>
   ...
}</pre>

        <p>If <strong class="userinput"><code>check_ups</code></strong> is to determine the UPS status by means of the current load, the relevant information is taken from the variable <strong class="userinput"><code>LOADPCT</code></strong>:</p><a id="I_programlisting3_d1e12870"/>
        <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_ups -H linux01 -u upsfw -T -v</strong></span> \
<span class="strong"><strong>    LOADPCT -W 60 -c 80</strong></span>
UPS WARNING - Status=Online Utility=227.5V Batt=100.0% Load=61.9%
Temp=30.6C|voltage=227500mV;;;0 battery=100%;;;0;100 load=61%;60000;
80000;0;100 temp=30degC;;;0</pre>

        <p>With 61 percent, the UPS has a heavier load than specified in the limit value <strong class="userinput"><code>-w</code></strong>, but it does not yet reach the critical area above 80 percent, so there is just a warning. If two error criteria occur, such as a warning limit for a queried variable being exceeded and a critical state simultaneously, because the UPS is losing power (<strong class="userinput"><code>On Battery</code></strong> and <strong class="userinput"><code>Low Battery</code></strong> simultaneously), the most critical state has priority for the return value of the plugin, so here, <strong class="userinput"><code>check_ups</code></strong> would return CRITICAL, and not the WARNING which results from the query of <strong class="userinput"><code>LOADPCT</code></strong>.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-6-FN-23" id="ftn.CHP-6-FN-23">70</a>]</sup> <a class="ulink" href="http://eul.networkupstools.org/server-projects/">http://eul.networkupstools.org/server-projects/</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="6.12 Health Check of an NTP Server with check_ntp_peer">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="health_check_of_an_ntp_server_with_check"/>6.12 Health Check of an NTP Server with <strong class="userinput"><code>check_ntp_peer</code></strong></h1>
    </div>

    <p>The plugin <strong class="userinput"><code>check_ntp_peer</code></strong>, which is included from plugin version 1.4.11, tests the quality of an NTP server. If you want to check the time deviation of a local server against an NTP server, you need to use the plugin <strong class="userinput"><code>check_ntp_time</code></strong>, described in <a class="xref" href="../Text/ch07s07.html#checking_the_system_time_via_ntp" title="7.7.1 Checking the system time via NTP">7.7.1 Checking the system time via NTP</a> in page 177.<a class="indexterm" id="IDX-CHP-6-0589"/><a class="indexterm" id="IDX-CHP-6-0590"/><a class="indexterm" id="IDX-CHP-6-0591"/><a class="indexterm" id="IDX-CHP-6-0592"/><a class="indexterm" id="IDX-CHP-6-0593"/><a class="indexterm" id="IDX-CHP-6-0594"/><a class="indexterm" id="IDX-CHP-6-0595"/><a class="indexterm" id="IDX-CHP-6-0596"/><a class="indexterm" id="IDX-CHP-6-0588"/></p>

    <p>Several parameters characterize the quality: the <span class="emphasis"><em>offset</em></span> describes the time difference from other NTP servers (the reference servers). <span class="emphasis"><em>Jitter</em></span> is a measurement of the fluctuations in the packet delay to a remote reference server, and <span class="emphasis"><em>stratum</em></span> specifies the topological distance from the next atomic clock. Stratum 0 is the atomic clock itself, stratum 1 refers to an NTP server directly connected to an atomic clock. Stratum 2 is an NTP server that obtains its time from an NTP server with stratum 1. The further an NTP server is away from the atomic clock, the higher the stratum value. The imprecision of the server also increases the higher this value is.<a class="indexterm" id="IDX-CHP-6-0597"/></p>

    <p>These parameters can also be queried with the program <strong class="userinput"><code>ntpq</code></strong>, by giving the IP address of the NTP server. The option <strong class="userinput"><code>-p</code></strong> reveals the reference server from which the queried NTP server obtains its time details. The option <strong class="userinput"><code>-n</code></strong> prevents name resolution on the reference servers, thus accelerating the execution of <strong class="userinput"><code>ntpq</code></strong>:<a class="indexterm" id="IDX-CHP-6-0598"/></p><a id="I_programlisting3_d1e12979"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>ntpq -np 192.168.1.13</strong></span>
remote           refid         st  t  when  poll  reach  delay  offset  jitter
127.127.1.1      .LOCL.        10  1   26    64    377    0.000  0.000   0.001
*81.169.141.30   81.169.172.219 3  u    1   128    377   27.515 −4.411   1.219
+217.160.215.119 212.82.32.26   3  u  125   128    377   17.834  1.505   1.069</pre>

    <p>The <strong class="userinput"><code>remote</code></strong> column specifies the reference server that uses the queried NTP server. <strong class="userinput"><code>127.127.1.1</code></strong> here is a special case, and stands for the local system clock. The stratum value (column <strong class="userinput"><code>st</code></strong>), with <strong class="userinput"><code>10</code></strong>, is relatively high, but the local system clock only plays a role if no other NTP source can is reachable. The other two quality parameters, offset and jitter, are located in the last two columns.</p>

    <p>In the simplest case you can run <strong class="userinput"><code>check_ntp_peer</code></strong>, specifying only the NTP server to be checked (option <strong class="userinput"><code>-H</code></strong>):<a class="indexterm" id="IDX-CHP-6-0599"/></p><a id="I_programlisting3_d1e13011"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_ntp_peer -H 192.168.1.13</strong></span>
NTP OK: Offset −0.004411 secs|offset=−0.004411s;60.000000;120.000000;</pre>

    <p>Without further details the plugin checks the time deviation from the reference servers, and the stratum and jitter are not taken into account. All threshold details from <strong class="userinput"><code>check_ntp_peer</code></strong> are specified in the format described in <a class="xref" href="../Text/ch24.html#specifying_thresholds" title="24.1.5 Specifying thresholds">24.1.5 Specifying thresholds</a> from page 557. The plugin has the following options:</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ -host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

        <dd>
          <p>This is the name or IP address of the NTP server to be checked.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/--port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

        <dd>
          <p>This is the UDP port on which the NTP server is listening. The default is port <strong class="userinput"><code>123</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-q</code></strong> <strong class="userinput"><code>/--quiet</code></strong></span></dt>

        <dd>
          <p>This returns UNKNOWN instead of WARNING or CRITICAL if the NTP server is not synchronized.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong> <strong class="userinput"><code>/ -warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong></span></dt>

        <dd>
          <p>This is the warning threshold for the time deviation. A warning is issued if the time deviation between the NTP server and at least one of the reference servers is greater than the specified number of seconds. The default is <strong class="userinput"><code>60</code></strong> seconds.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>seconds</code></em></code></strong> <strong class="userinput"><code>/ -critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>seconds</code></em></code></strong></span></dt>

        <dd>
          <p>This is the critical threshold for the time deviation. If the time of one of the reference servers used deviates by more than <strong class="userinput"><code><em class="replaceable"><code>seconds</code></em></code></strong> seconds (in the default: <strong class="userinput"><code>120</code></strong>) from that of the NTP server, the state becomes CRITICAL.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-W</code></strong> <strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong> <strong class="userinput"><code>/ -swarn=</code></strong><strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong></span></dt>

        <dd>
          <p>This is the warning threshold based on the stratum value. A warning is issued if no reference server is available whose stratum value matches the specified threshold. This means that <strong class="userinput"><code>-W 1:2</code></strong> causes a WARNING if no reference server is available with stratum 1 or stratum 2. Without the detail of this parameter the stratum value is not included in the check.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong> <strong class="userinput"><code>/ -scrit=</code></strong><strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong></span></dt>

        <dd>
          <p>This is the critical threshold based on the stratum value. See <strong class="userinput"><code>-W</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-j</code></strong> <strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong> <strong class="userinput"><code>/ -jwarn=</code></strong><strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong></span></dt>

        <dd>
          <p>This is the warning threshold for the jitter in milliseconds, given in the threshold format. The plugin returns OK if at least one reference server displays a jitter within the specified range. If this option is not given, the jitter is not included in the evaluation; there is no default.<a class="indexterm" id="IDX-CHP-6-0600"/></p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-k</code></strong> <strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong> <strong class="userinput"><code>/ -jcrit=</code></strong><strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong></span></dt>

        <dd>
          <p>This is the critical threshold for the jitter in milliseconds in the threshold format.</p>
        </dd>
      </dl>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;7.&#xA0;Testing Local Resources">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="testing_local_resources"/>Chapter 7. Testing Local Resources</h1>
    </div>

    <p>The plugins introduced in this chapter, originating from the <strong class="userinput"><code>nagios-plugins</code></strong> package,<sup>[<a class="footnote" href="#ftn.CHP-7-FN-1" id="CHP-7-FN-1">71</a>]</sup> test local resources that do not have their own network protocol and therefore cannot be easily queried over the network. They must therefore be locally installed on the computer to be tested. Such plugins on the Nagios server can test only the server itself—with command and service definitions as described in <a class="xref" href="../Text/ch06.html" title="Chapter 6. Plugins for Network Services">Chapter 6</a>.</p>

    <p>To perform such local tests from a central Nagios server on remote hosts, you require further utilities: the plugins are started via a secure shell, or you use the <span class="emphasis"><em>Nagios Remote Plugin Executor</em></span> (NRPE). Using the secure shell is described in <a class="xref" href="../Text/ch09.html" title="Chapter 9. Executing Plugins via SSH">Chapter 9</a> from page 205, and <a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a> (page 213) is devoted to NRPE.</p>

    <p>The definition of command and service depends on the choice of mechanism. If you want to test for free hard drive capacity with the <strong class="userinput"><code>check_by_ssh</code></strong> plugin installed on the Nagios server, which remotely calls <strong class="userinput"><code>check_disk</code></strong> on the target server (see <a class="xref" href="../Text/ch07.html" title="Chapter 7. Testing Local Resources">Chapter 7</a>, page 157), then a special command definition is required for this, which differs somewhat from the definitions given in <a class="xref" href="../Text/ch06.html" title="Chapter 6. Plugins for Network Services">Chapter 6</a> (page 105). What command and service definitions for remotely executed local plugins look like is described in the aforementioned chapters on NRPE and SSH.<a class="indexterm" id="IDX-CHP-7-0601"/><a class="indexterm" id="IDX-CHP-7-0602"/><a class="indexterm" id="IDX-CHP-7-0603"/><a class="indexterm" id="IDX-CHP-7-0604"/></p>

    <p>For the remote query of some local resources you can also use SNMP (see <a class="xref" href="../Text/ch11.html" title="Chapter 11. Collecting Information Relevant for Monitoring with SNMP">Chapter 11</a> from page 227), but the checks are then restricted to the capabilities of the SNMP daemon used. Local plugins are usually more flexible here and provide more options for querying.</p>

    <div class="sect1" title="7.1 Free Hard Drive Capacity">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="free_hard_drive_capacity"/>7.1 Free Hard Drive Capacity</h1>
      </div>

      <p>The question of when the hard drive(s) of a computer may threaten to overflow is answered by the <strong class="userinput"><code>check_disk</code></strong> plugin. It has the following options for specifying thresholds:<a class="indexterm" id="IDX-CHP-7-0605"/><a class="indexterm" id="IDX-CHP-7-0606"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong> /<strong class="userinput"><code>--warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong></span></dt>

          <dd>
            <p>The plugin will give a warning if the free hard drive capacity drops below this limit, expressed as a percentage or as an integer. If you specify percentage, the percent sign <strong class="userinput"><code>%</code></strong> must also be included; floating point decimals such as <strong class="userinput"><code>12.5%</code></strong> are possible. Integer values represent the absolute free space in the unit that defines the <strong class="userinput"><code>--units</code></strong> switch. The default is <strong class="userinput"><code>--units=MB</code></strong>, or megabytes.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong> / <strong class="userinput"><code>--critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong></span></dt>

          <dd>
            <p>If the free hard drive capacity level falls below this as a percentage or integer (see <strong class="userinput"><code>-w</code></strong>), <strong class="userinput"><code>check_disk</code></strong> displays the CRITICAL status. The critical limit must be smaller than the warning limit.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-W</code></strong> <strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong> / <strong class="userinput"><code>-iwarning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong></span></dt>

          <dd>
            <p>The number of free inodes in the file system as a percentage; <strong class="userinput"><code>check_ disk</code></strong> issues a warning if this drops below the limit.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-K</code></strong> <strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong> / <strong class="userinput"><code>-icritical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong></span></dt>

          <dd>
            <p>Like <strong class="userinput"><code>-W</code></strong>, except that this is the critical threshold.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code><em class="replaceable"><code>unit</code></em></code></strong> / <strong class="userinput"><code>--units=</code></strong><strong class="userinput"><code><em class="replaceable"><code>unit</code></em></code></strong></span></dt>

          <dd>
            <p>In what unit do you specify integer limit values? <strong class="userinput"><code>kB</code></strong>, <strong class="userinput"><code>MB</code></strong>, <strong class="userinput"><code>GB</code></strong>, and <strong class="userinput"><code>TB</code></strong> are all possible.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-k</code></strong> / <strong class="userinput"><code>--kilobytes</code></strong></span></dt>

          <dd>
            <p>With this switch, limit values given as whole numbers with <strong class="userinput"><code>-c</code></strong> and <strong class="userinput"><code>-w</code></strong> are to be interpreted as KB. This is the same as <strong class="userinput"><code>--units=kB</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-m</code></strong> / <strong class="userinput"><code>--megabytes</code></strong></span></dt>

          <dd>
            <p>With this switch, whole number limit values with <strong class="userinput"><code>-c</code></strong> and <strong class="userinput"><code>-w</code></strong> are interpreted by the plugin as MB (the default). This is the same as <strong class="userinput"><code>--units=MB</code></strong>.</p>
          </dd>
        </dl>
      </div>

      <p>Before one of the following path selectors is specified, at least one threshold must be given (<strong class="userinput"><code>-w</code></strong>, <strong class="userinput"><code>-c</code></strong>, <strong class="userinput"><code>-W</code></strong>, or <strong class="userinput"><code>-K</code></strong>).</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>path_or_partition</code></em></code></strong> / <strong class="userinput"><code>--path=</code></strong><strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong> or <strong class="userinput"><code>--partition=</code></strong><strong class="userinput"><code><em class="replaceable"><code>partitioin</code></em></code></strong></span></dt>

          <dd>
            <p>This specifies the root directory in file systems or the physical device in partitions (e.g., <strong class="userinput"><code>/dev/sda5</code></strong>). From version 1.4 <strong class="userinput"><code>-p</code></strong> can be called multiple times. If the path is not specified, the plugin tests all file systems (see also <strong class="userinput"><code>-x</code></strong> and <strong class="userinput"><code>-X</code></strong>).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-E</code></strong> / <strong class="userinput"><code>--exact-match</code></strong></span></dt>

          <dd>
            <p>This demands that the root of the file system is included for all paths or partitions specified with <strong class="userinput"><code>-p</code></strong>, otherwise the plugin will issue an error:</p><a id="I_programlisting4_d1e13494"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>df /usr/local</strong></span>
Filesystem 1K-blocks Used Available Use% Mounted on
/dev/md2 9843168 7062980 2280172 76% /usr</pre>

            <p><strong class="userinput"><code>/usr/local</code></strong> is not a file system, but a directory within the <strong class="userinput"><code>/usr</code></strong> file system on the partition <strong class="userinput"><code>/dev/md2</code></strong>. If you call the plugin with the switches <strong class="userinput"><code>-p /usr/local</code></strong> and <strong class="userinput"><code>-E</code></strong>, you will receive an error, since <strong class="userinput"><code>/usr/local</code></strong> is not itself the root of the file system as required by <strong class="userinput"><code>-E</code></strong>:</p><a id="I_programlisting4_d1e13522"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_disk -w 10% -E -p/usr/local</strong></span>
DISK CRITICAL: /usr/local not found</pre>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-x</code></strong> <strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong> / <strong class="userinput"><code>--exclude_device=</code></strong><strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong></span></dt>

          <dd>
            <p>This switch excludes the mount point specified as <strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong> from the test. This option assumes that paths are specified with <strong class="userinput"><code>-p</code></strong> and that they may be run in a plugin call multiple times.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-X</code></strong> <strong class="userinput"><code><em class="replaceable"><code>fs_typ</code></em></code></strong> / <strong class="userinput"><code>--exclude-type=</code></strong><strong class="userinput"><code><em class="replaceable"><code>fs_typ</code></em></code></strong> (from 1.4)</span></dt>

          <dd>
            <p>This switch excludes a specific file system type from the test. It is given the same abbreviation as in the <strong class="userinput"><code>-t</code></strong> option of the <strong class="userinput"><code>mount</code></strong> command. In this way <strong class="userinput"><code>fs_type</code></strong> can take the values <strong class="userinput"><code>ext3</code></strong>, <strong class="userinput"><code>reiserfs</code></strong>, or <strong class="userinput"><code>proc</code></strong>, for example (see also <strong class="userinput"><code>man 8 mount</code></strong>). This option can be used several times in a plugin command.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-R</code></strong> <strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong> / <strong class="userinput"><code>--eregi-path=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong>,<strong class="userinput"><code>--eregi-partition=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong></span></dt>

          <dd>
            <p>From version 1.4.8: a regular expression that selects all paths or partitions with which it matches. Upper/lower case is ignored here. The following example checks all partitions that end with <strong class="userinput"><code>mdO</code></strong> thru <strong class="userinput"><code>md2</code></strong>:</p><a id="I_programlisting4_d1e13620"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_disk -w 10% -r 'md[0-2]$'</strong></span>
DISK OK - free space: / 281 MB (31% inode=80%); /usr 2226 MB (24% i
node=77%);| /=626MB;861;;0;957 /usr=6897MB;8650;;0;9612</pre>

            <p>The swap partition <strong class="userinput"><code>/dev/mdl</code></strong> is ignored here.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-r</code></strong> <strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong> / <strong class="userinput"><code>--ereg-path=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong>, <strong class="userinput"><code>--ereg-partition=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong></span></dt>

          <dd>
            <p>From version 1.4.8: a regular expression to check partitions and/or paths. Like <strong class="userinput"><code>-R</code></strong>, except that it is now case-sensitive.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-A</code></strong> / <strong class="userinput"><code>--all</code></strong></span></dt>

          <dd>
            <p>From version 1.4.10: checks all partitions and file systems. The equivalent of <strong class="userinput"><code>-R '.*'</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-I</code></strong> <strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong> / <strong class="userinput"><code>--ignore-eregi-path=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong>, <strong class="userinput"><code>--ignore-eregi-partition=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong></span></dt>

          <dd>
            <p>From version 1.4.10: a regular expression that excludes paths or partitions that match it from the check. Upper/lower case is ignored.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-i</code></strong> <strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong> / <strong class="userinput"><code>--ignore-ereg-path=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong>, <strong class="userinput"><code>--ignore-ereg-partition=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong></span></dt>

          <dd>
            <p>From version 1.4.10: like <strong class="userinput"><code>-I</code></strong>, except that it is now case-sensitive.</p>
          </dd>
        </dl>
      </div>

      <p>In addition the plugin has the following options:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-e</code></strong> / <strong class="userinput"><code>--errors-only</code></strong></span></dt>

          <dd>
            <p>With this switch, the plugin shows only the file systems or partitions that are in a WARNING or CRITICAL state.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-M</code></strong> / <strong class="userinput"><code>--mountpoint</code></strong></span></dt>

          <dd>
            <p>From version 1.4 on, <strong class="userinput"><code>check_disk</code></strong> by default displays the file system path (e.g., <strong class="userinput"><code>/usr</code></strong>). With <strong class="userinput"><code>-M</code></strong> you are told instead what physical device (e.g., <strong class="userinput"><code>/dev/sda5</code></strong>) is involved.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-C</code></strong> / <strong class="userinput"><code>--clear</code></strong></span></dt>

          <dd>
            <p>From version 1.4 on, <strong class="userinput"><code>-p</code></strong> can be used multiple times. If you want to test several file systems at the same time, but using different limit values, <strong class="userinput"><code>-C</code></strong> can be used to delete old limit values that have been set:</p><a id="I_programlisting4_d1e13769"/>
            <pre class="programlisting">-w 10% -c 5% -p / -p /usr -C -w 500 -c 100 -p /var</pre>

            <p>The order is important here: the limit values are valid for the file system details until they are reset with <strong class="userinput"><code>-C</code></strong>. Then new limits must be set with <strong class="userinput"><code>-w</code></strong> and <strong class="userinput"><code>-c</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>−1</code></strong> / <strong class="userinput"><code>--local</code></strong></span></dt>

          <dd>
            <p>Only checks local file systems, others-file systems mounted via NFS, for example-are ignored.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-L</code></strong> / <strong class="userinput"><code>--stat-remote-fs</code></strong> (ab Version 1.4.10)</span></dt>

          <dd>
            <p>Checks local file systems for the specified thresholds, but checks network file systems only for availability. With this switch you can test, for example, whether a <span class="emphasis"><em>stale file handle</em></span> exists for a path connected via NFS.<sup>[<a class="footnote" href="#ftn.CHP-7-FN-2" id="CHP-7-FN-2">72</a>]</sup></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-g</code></strong> <strong class="userinput"><code><em class="replaceable"><code>group_name</code></em></code></strong> / <strong class="userinput"><code>--group-type=</code></strong><strong class="userinput"><code><em class="replaceable"><code>group_name</code></em></code></strong></span></dt>

          <dd>
            <p>Refers to the thresholds of the sum of all specified partitions and paths. Without this switch the plugin compares each path and each partition separately with the thresholds. <strong class="userinput"><code>-g</code></strong> requires a name to be given, which the plugin includes as additional information in the output:</p><a id="I_programlisting4_d1e13832"/>
            <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_disk -g CLUSTER -w 10%</strong></span>\
 <span class="strong"><strong>   -r 'md[0-3]'</strong></span>
DISK OK - free space: CLUSTER 7437 MB (38% inode=86%);| CLUSTER=11
719MB;18163;;0;20182</pre>

            <p>This option must be placed <span class="emphasis"><em>in front of</em></span> the path specification to which it refers.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> / <strong class="userinput"><code>--timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

          <dd>
            <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds have expired the plugin stops the test and returns the CRITICAL status. The default is <strong class="userinput"><code>10</code></strong> seconds.</p>
          </dd>
        </dl>
      </div>

      <p>Here is a somewhat more extensive example of the use of <strong class="userinput"><code>check_disk</code></strong>:</p><a id="I_programlisting4_d1e13874"/>
      <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_disk -w 10% -c 5% -p / -p /usr</strong></span> \
 <span class="strong"><strong>   -p /var -C -w 5% -c 3% -p /net/emil1/a -p /net/emil1/c -e</strong></span>
DISK WARNING - free space: /net/emil1/c 915 MB (5%);| /=146MB;458;483;0;
509 /usr=1280MB;3633;3835;0;4037 /var=2452MB;3633;3835;0;4037 /net/emil1
/a=1211MB;21593;22048;0;22730 /net/emil1/c=17584MB;17574;17944;0;18499</pre>

      <p>Everything is in order on the file system <strong class="userinput"><code>/</code></strong>, <strong class="userinput"><code>/usr</code></strong>, and <strong class="userinput"><code>/var</code></strong>, since more space is available on them—as can be seen from the performance data—than the limit value of 10 percent (for a warning), and certainly more than 5 percent (for the critical status). The file systems <strong class="userinput"><code>/net/emil1/a</code></strong> and <strong class="userinput"><code>/net/emil1/c</code></strong> encompass significantly larger ranges of data, which is why the limit values are set lower, after the previous ones have been deleted with <strong class="userinput"><code>-C</code></strong>.</p>

      <p><strong class="userinput"><code>-e</code></strong> ensures that Nagios shows only the file systems that really display an error status. In fact the output of the plugin <span class="emphasis"><em>before</em></span> the <strong class="userinput"><code>|</code></strong> sign, with <strong class="userinput"><code>/net/ emil1/c</code></strong>, only displays one single file system. The performance information after the pipe can only be seen on the command line—it contains all file systems tested, as before. This is slightly confusing, because a Nagios plugin restricts its output to a single line, which has been line wrapped here for this printed version.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-1" id="ftn.CHP-7-FN-1">71</a>]</sup> This edition is based on version 1.4.11.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-2" id="ftn.CHP-7-FN-2">72</a>]</sup> The error message <strong class="userinput"><code>NFS stale file handle</code></strong> indicates the non-availability of the NFS path.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="7.2 Utilization of the Swap Space">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="utilization_of_the_swap_space"/>7.2 Utilization of the Swap Space</h1>
    </div>

    <p>The <strong class="userinput"><code>check_swap</code></strong> plugin tests the locally available swap space:<a class="indexterm" id="IDX-CHP-7-0607"/><a class="indexterm" id="IDX-CHP-7-0608"/><a class="indexterm" id="IDX-CHP-7-0609"/><a class="indexterm" id="IDX-CHP-7-0610"/><a class="indexterm" id="IDX-CHP-7-0611"/><a class="indexterm" id="IDX-CHP-7-0612"/></p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong> / <strong class="userinput"><code>--warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong></span></dt>

        <dd>
          <p>The warning limit can be specified as a percentage or as an integer, as with <strong class="userinput"><code>check_disk</code></strong>, but the integer value is specified in <span class="emphasis"><em>bytes</em></span>, not in kilobytes!</p>

          <p>If at least 10 percent should remain free, specify <strong class="userinput"><code>-c 10%</code></strong>. The integer specification refers to the remaining free space, too.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong> / <strong class="userinput"><code>--critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong></span></dt>

        <dd>
          <p>Critical limit, similar to the warning limit.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-a</code></strong> / <strong class="userinput"><code>--allswaps</code></strong></span></dt>

        <dd>
          <p>Tests the threshold values for each swap partition individually.</p>
        </dd>
      </dl>
    </div>

    <p>The following example tests to see whether at least half of the swap space is available. If there is less than 20 percent free swap space, the plugin should return a critical status. After the <strong class="userinput"><code>|</code></strong> sign the program again provides performance data, which is logged by Nagios but not displayed in the message on the Web interface:</p><a id="I_programlisting4_d1e14016"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_swap -w 50% -c 20%</strong></span>
swap OK: 100% free (3906 MB out of 3906 MB) |swap=3906MB;1953;781;0;3906</pre>
  </div>


  <div class="sect1" title="7.3 Testing the System Load">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="testing_the_system_load"/>7.3 Testing the System Load</h1>
    </div>

    <p>The load on a system can be seen from the number of simultaneously running processes, which is tested by the <strong class="userinput"><code>check_load</code></strong> plugin. With the help of the <strong class="userinput"><code>uptime</code></strong> program, it determines the average value for the last minute, the last five minutes, and the last 15 minutes. <strong class="userinput"><code>uptime</code></strong> displays these values in this sequence after the keyword <strong class="userinput"><code>load average</code></strong>:<a class="indexterm" id="IDX-CHP-7-0613"/><a class="indexterm" id="IDX-CHP-7-0614"/><a class="indexterm" id="IDX-CHP-7-0615"/></p><a id="I_programlisting4_d1e14053"/>
    <pre class="programlisting">user@linux:~$ <span class="strong"><strong>uptime</strong></span>
16:33:35 up    7:05, 18 users, load average: 1.87, 1.38, 0.74</pre>

    <p><strong class="userinput"><code>check_loadhas</code></strong> only two options (the two limit values), but these can be specified in two different ways:</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong> / <strong class="userinput"><code>--warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong></span></dt>

        <dd>
          <p>This option specifies the warning limit either as a simple floating point decimal (<strong class="userinput"><code>5.0</code></strong>) or as a comma-separated triplet containing three floating point decimals (<strong class="userinput"><code>10.0,8.0,5.0</code></strong>).</p>

          <p>In the first case, the limit specified applies to all three average values. The plugin issues a warning if (at least) one of these is exceeded. In the second case the triplet allows the limit value to be specified separately for each average value. Here as well, <strong class="userinput"><code>check_load</code></strong> issues a warning as soon as one of the average values exceeds the limit defined for it.<a class="indexterm" id="IDX-CHP-7-0616"/><a class="indexterm" id="IDX-CHP-7-0617"/></p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong> / <strong class="userinput"><code>--critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>limit</code></em></code></strong></span></dt>

        <dd>
          <p>This specifies the critical limit in the same way as <strong class="userinput"><code>-w</code></strong> specifies the warning limit. These critical limit values should be higher than the values for <strong class="userinput"><code>-w</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-r</code></strong> / <strong class="userinput"><code>--percpu</code></strong> (from Version 1.4.9)</span></dt>

        <dd>
          <p>Divides the system load determined by the number of existing CPU kernels, to get a better idea of the load per CPU kernel.</p>
        </dd>
      </dl>
    </div>

    <p>In the following example Nagios would raise the alarm if more than 15 processes were active on average in the last minute, if more than 10 were active on average in the last five minutes, or if eight were active on average in the last 15 minutes. There is a warning for average values of ten, eight, or five processes:</p><a id="I_programlisting4_d1e14137"/>
    <pre class="programlisting">user@linux:local/libexec$ <span class="strong"><strong>./check_load -w 10.0,8.0,5.0 -c 15.0,10.0,8.0</strong></span>
OK - load average: 1.93, 0.95, 0.50| load1=1.930000;10.000000;15.000000;
0.000000  load5=0.950000;8.000000;10.000000;0.000000 load15=0.500000;
5.000000;8.000000;0.000000</pre>
  </div>


  <div class="sect1" title="7.4 Monitoring Processes">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_processes"/>7.4 Monitoring Processes</h1>
    </div>

    <p>The <strong class="userinput"><code>check_procs</code></strong> plugin monitors processes according to various criteria. Usually it is used to monitor the running processes of just one single program. Here the upper and lower limits can also be specified.<a class="indexterm" id="IDX-CHP-7-0618"/><a class="indexterm" id="IDX-CHP-7-0619"/><a class="indexterm" id="IDX-CHP-7-0620"/><a class="indexterm" id="IDX-CHP-7-0621"/><a class="indexterm" id="IDX-CHP-7-0622"/><a class="indexterm" id="IDX-CHP-7-0623"/><a class="indexterm" id="IDX-CHP-7-0624"/><a class="indexterm" id="IDX-CHP-7-0625"/><a class="indexterm" id="IDX-CHP-7-0626"/><a class="indexterm" id="IDX-CHP-7-0627"/><a class="indexterm" id="IDX-CHP-7-0628"/><a class="indexterm" id="IDX-CHP-7-0629"/><a class="indexterm" id="IDX-CHP-7-0630"/><a class="indexterm" id="IDX-CHP-7-0631"/><a class="indexterm" id="IDX-CHP-7-0632"/></p>

    <p><strong class="userinput"><code>nmbd</code></strong>, for example, the name service of Samba, always runs as a daemon with two processes. A larger number of <span class="strong"><strong>nmbd</strong></span> entries in the process table is always a sure sign of a problem; it is commonly encountered, especially in older Samba versions.</p>

    <p>Services such as Nagios itself should only have one main process. This can be seen by the fact that its parent process has the process ID <strong class="userinput"><code>1</code></strong>, marking it as a child of the <strong class="userinput"><code>init</code></strong> process. It was often the case, in the development phase of Nagios 2.0, that several such processes were active in parallel after a failed restart or reload, which led to undesirable side effects. You can test to see whether there really is just one single Nagios main process active, as follows:</p><a id="I_programlisting4_d1e14228"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_procs -c 1:1 -C nagios -p 1</strong></span>
PROCS OK: 1 process with command name 'nagios', PPID = 1</pre>

    <p>The program to be monitored is called <strong class="userinput"><code>nagios</code></strong> (option <strong class="userinput"><code>-C</code></strong>), and its parent process should have the ID <strong class="userinput"><code>1</code></strong> (option <strong class="userinput"><code>-p</code></strong>). Exactly one Nagios process must be running, no more and no less; otherwise the plugin will issue a CRITICAL status. This is specified as a range: <strong class="userinput"><code>-c 1:1</code></strong>.<a class="indexterm" id="IDX-CHP-7-0633"/><a class="indexterm" id="IDX-CHP-7-0634"/></p>

    <p>Another example: between one and four simultaneous processes of the OpenLDAP replication service <strong class="userinput"><code>slurpd</code></strong> should be active:</p><a id="I_programlisting4_d1e14269"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_procs -w 1:4 -c 1:7 -C slurpd</strong></span>
PROCS OK: 1 process with command name 'slurpd'</pre>

    <p>If the actual process number lies between <strong class="userinput"><code>1</code></strong> and <strong class="userinput"><code>4</code></strong>, the plugin returns OK, as is the case here. If it finds between five and seven processes, however, a warning will be given. Outside this range, <strong class="userinput"><code>check_procs</code></strong> categorizes the status as CRITICAL. This is the case here if there are either no processes running at all, or more than seven running.</p>

    <p>Instead of the number of processes of the same program, you can also monitor the CPU load caused by it, its use of memory, or even the CPU runtime used. <strong class="userinput"><code>check_procs</code></strong> has the following options:</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>start: end</code></em></code></strong> / <strong class="userinput"><code>--warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>start: end</code></em></code></strong></span></dt>

        <dd>
          <p>The plugin issues a warning if the actual values lie <span class="emphasis"><em>outside</em></span> the range specified by the start and end value. Without further details, it assumes that it should count processes: <strong class="userinput"><code>-w 2:10</code></strong> means that <strong class="userinput"><code>check_ procs</code></strong> gives a warning if it finds less than two or more than ten processes.</p>

          <p>If you omit one of the two limit values, zero applies as the lower value, or infinite as the upper limit. This means that the range <strong class="userinput"><code>:10</code></strong> is identical to <strong class="userinput"><code>0:10; 10:</code></strong> describes any number larger than or equal to 10. If you just enter a single whole number instead of a range, this represents the maximum. The entry <strong class="userinput"><code>5</code></strong> therefore stands for <strong class="userinput"><code>0:5</code></strong>.</p>

          <p>If you swap the maximum and minimum, the plugin will give a warning if the actual value lies <span class="emphasis"><em>within</em></span> the range, so for <strong class="userinput"><code>-w 10:5</code></strong> this will be if the value is 5, 6, 7, 8, 9, or 10. You may always specify only one interval.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>start : end</code></em></code></strong> / <strong class="userinput"><code>--critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>start : end</code></em></code></strong></span></dt>

        <dd>
          <p>This specifies the critical range, in the same way as for the warning limit.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-m</code></strong> <strong class="userinput"><code><em class="replaceable"><code>type</code></em></code></strong> / <strong class="userinput"><code>--metric=</code></strong><strong class="userinput"><code><em class="replaceable"><code>type</code></em></code></strong></span></dt>

        <dd>
          <p>This switch selects one of the following metrics for the test:</p>

          <div class="variablelist">
            <dl>
              <dt><span class="term"><strong class="userinput"><code>PROCS</code></strong>:</span></dt>

              <dd>
                <p>number of processes (the default if no specific type is given)</p>
              </dd>

              <dt><span class="term"><strong class="userinput"><code>VSZ</code></strong>:</span></dt>

              <dd>
                <p>the virtual size of a process in the memory <span class="emphasis"><em>(virtual memory size)</em></span>, consisting of the main memory space that the process uses exclusively, plus that of the shared libraries used. These only take up memory space once, even if they are used by several different processes. The specification is given in bytes.</p>
              </dd>

              <dt><span class="term"><strong class="userinput"><code>RSS</code></strong>:</span></dt>

              <dd>
                <p>the proportion of main memory in KB that the process actually uses for itself (<span class="emphasis"><em>Resident Set Size</em></span>), that is, <strong class="userinput"><code>VSZ</code></strong> minus the shared memory.</p>
              </dd>

              <dt><span class="term"><strong class="userinput"><code>CPU</code></strong>:</span></dt>

              <dd>
                <p>CPU usage in percent. The plugin here checks the CPU usage for each individual process for morning and critical limits. If one of the processes exceeds the warning limit, Nagios will issue a warning. In the text output the plugin also shows how many processes have exceeded the warning or critical limit.</p>
              </dd>

              <dt><span class="term"><strong class="userinput"><code>ELAPSED</code></strong>:</span></dt>

              <dd>
                <p>The overall time that has passed since the process was started.</p>
              </dd>
            </dl>
          </div>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>flags</code></em></code></strong> / <strong class="userinput"><code>--state=</code></strong><strong class="userinput"><code><em class="replaceable"><code>flags</code></em></code></strong></span></dt>

        <dd>
          <p>This restricts the test to processes with the specified status flag. <sup>[<a class="footnote" href="#ftn.CHP-7-FN-3" id="CHP-7-FN-3">73</a>]</sup> The plugin in the following example gives a warning if there is more than one zombie process (status flag:<strong class="userinput"><code>Z</code></strong>) :</p><a id="I_programlisting4_d1e14475"/>
          <pre class="programlisting">nagios/libexec@linux: $ <span class="strong"><strong>./check_procs -w 1 -c 5 -s Z</strong></span>
PROCS OK: 0 processes with STATE = Z</pre>

          <p>Things become critical here if more than five zombies "block up" the process table. Several states can be queried at the same time by by adding individual flags together, as in <strong class="userinput"><code>-s DSZ</code></strong>. Now Nagios cancels the processes that are in at least one of the states mentioned.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ppid</code></em></code></strong> / <strong class="userinput"><code>--ppid=</code></strong><strong class="userinput"><code><em class="replaceable"><code>ppid</code></em></code></strong></span></dt>

        <dd>
          <p>This switch restricts the test to processes whose parent processes have the <span class="emphasis"><em>parent process ID</em></span> (<strong class="userinput"><code><em class="replaceable"><code>ppid</code></em></code></strong>). The only PPIDs that are known from the beginning, and that do not change, are 0 (started by the kernel, and usually only concerns the init process) and 1 (the init process itself).</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-P</code></strong> <strong class="userinput"><code><em class="replaceable"><code>pcpu</code></em></code></strong> / <strong class="userinput"><code>--pcpu=</code></strong><strong class="userinput"><code><em class="replaceable"><code>pcpu</code></em></code></strong></span></dt>

        <dd>
          <p>This option filters processes according to the percentage of CPU they use :</p><a id="I_programlisting4_d1e14526"/>
          <pre class="programlisting">nagios/libexec@linux: $ <span class="strong"><strong>./check_procs -w 1 -c 5 -P 10</strong></span>
PROCS OK: 1 process with PCPU &gt;= 10,00</pre>

          <p>The plugin in this example takes into account only processes which have at least a ten percent share of CPU usage. As long as there is just one such process (<strong class="userinput"><code>-w 1</code></strong>), it returns OK. If there are between two and five such processes, the return value is a WARNING. With at least six processes, each with a CPU usage of at least ten percent, things get critical.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-r</code></strong> <strong class="userinput"><code><em class="replaceable"><code>rss</code></em></code></strong> / <strong class="userinput"><code>--rss=</code></strong><strong class="userinput"><code><em class="replaceable"><code>rss</code></em></code></strong></span></dt>

        <dd>
          <p>This option filters out processes that occupy at least <strong class="userinput"><code><em class="replaceable"><code>rss</code></em></code></strong> bytes of main memory. It is used like <strong class="userinput"><code>-P</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-z</code></strong> <strong class="userinput"><code><em class="replaceable"><code>vsz</code></em></code></strong> / <strong class="userinput"><code>--vsz=</code></strong><strong class="userinput"><code><em class="replaceable"><code>vsz</code></em></code></strong></span></dt>

        <dd>
          <p>This option filters out processes whose VSZ (see above) is at least <strong class="userinput"><code>vsz</code></strong> bytes. It is used like <strong class="userinput"><code>-P</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong> / <strong class="userinput"><code>--user=</code></strong><strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong></span></dt>

        <dd>
          <p>This option filters out processes that belong to the specified user (see example below).</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-a</code></strong> <strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong> / <strong class="userinput"><code>--argument-array=</code></strong><strong class="userinput"><code><em class="replaceable"><code>"string"</code></em></code></strong></span></dt>

        <dd>
          <p>Filters out commands whose argument list contains <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong>. <strong class="userinput"><code>-a. tex</code></strong>, for example, refers to all processes that work with <strong class="userinput"><code>*. tex files</code></strong>; <strong class="userinput"><code>-a -v</code></strong> to all processess that are called with the -v flag.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>command</code></em></code></strong> / <strong class="userinput"><code>--command=</code></strong><strong class="userinput"><code><em class="replaceable"><code>command</code></em></code></strong></span></dt>

        <dd>
          <p>This causes the process list to be searched for the specified command name. command must exactly match the <strong class="userinput"><code><em class="replaceable"><code>command</code></em></code></strong> specified, without a path (see example below).</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> / <strong class="userinput"><code>--timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

        <dd>
          <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds have expired, the plugin stops the test and returns the CRITICAL status. The default is <strong class="userinput"><code>10</code></strong> seconds.</p>
        </dd>
      </dl>
    </div>

    <p>The following example checks to see whether exactly one process called <strong class="userinput"><code>master</code></strong> is running on a mail server on which the Cyrus IMAPd is installed. No process is just as much an error as more than one process:</p><a id="I_programlisting4_d1e14682"/>
    <pre class="programlisting">user@linux : nagios/libexec$ <span class="strong"><strong>./check_procs -w 1 : 1 -c 1 : 1 -C master</strong></span>
CRITICAL - 2 processes running with command name master</pre>

    <p>The first attempt returns two processes, although only a single Cyrus Master process is running. The reason can be found if you run <strong class="userinput"><code>ps</code></strong>:</p><a id="I_programlisting4_d1e14692"/>
    <pre class="programlisting">user@linux : ~$ <span class="strong"><strong>ps -fC master</strong></span>
UID    PID   PPID   C   STIME   TTY   TIME          CMD
cyrus  431      1   0    2004   ?   00 : 00 : 28    /usr/lib/cyrus/bin/master
root  1042      1   0    2004   ?   00 : 00 : 57    /usr/lib/postfix/master</pre>

    <p>The Postfix mail service also has a process with the same name. To keep an eye just on the master process of the IMAPd, the search is additionally restricted to processes running with the permissions of the user <strong class="userinput"><code>cyrus</code></strong>:</p><a id="I_programlisting4_d1e14702"/>
    <pre class="programlisting">user@linux : nagios/libexec$ <span class="strong"><strong>./check_procs -w 1 : 1 -c 1:1 -C master -u</strong></span> \
<span class="strong"><strong>   cyrus</strong></span>
OK - 1 processes running with command name master, UID = 96 (cyrus)</pre>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-3" id="ftn.CHP-7-FN-3">73</a>]</sup> The following states are possible in Linux: <strong class="userinput"><code>D</code></strong> (uninterruptible waiting, usually a <span class="emphasis"><em>Disk Wait</em></span>), <strong class="userinput"><code>R</code></strong> (running process), <strong class="userinput"><code>S</code></strong> (wait status), <strong class="userinput"><code>T</code></strong> (process halted), <strong class="userinput"><code>W</code></strong> (paging, only up to kernel 2.4), <strong class="userinput"><code>X</code></strong> (a finished, killed process), and <strong class="userinput"><code>Z</code></strong> (zombie). Further information is provided by <strong class="userinput"><code>man ps</code></strong>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="7.5 Checking Log Files">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="checking_log_files"/>7.5 Checking Log Files</h1>
    </div>

    <p>Monitoring log files is not really part of the concept of Nagios. On the one hand, the syslog daemon notices critical events there immediately, so that an error status can be correctly determined. But if the error status continues, this cannot be seen in the log file in most cases.<a class="indexterm" id="IDX-CHP-7-0635"/><a class="indexterm" id="IDX-CHP-7-0636"/></p>

    <p>Correspondingly the plugins described here can determine only whether other, new entries on error events are added. In order to communicate information on a continuing error behavior to Nagios via a log file, the service monitored must log the error status regularly—at least at the same intervals as Nagios reads the log file—and repeatedly. Otherwise the plugin will alternate between returning an error status, and then an OK status, depending on whether the (continuing) error has in the meantime turned up in the log or not.</p>

    <p>Under no circumstances may Nagios repeat its test. The parameter <strong class="userinput"><code>max_check_attempts</code></strong> (see <a class="xref" href="../Text/ch02s03.html" title="2.3 Defining the Machines to Be Monitored, with host">2.3 Defining the Machines to Be Monitored, with host</a>) must have the value <strong class="userinput"><code>1</code></strong>. Otherwise Nagios would first assign the error status as a soft state, would repeat the test, and would almost always arrive at an OK, since it only takes into account new entries during repeat tests. <strong class="userinput"><code>max_check_attempts = 1</code></strong> ensures that Nagios diagnoses a hard state after the first test.</p>

    <p>For events that log an error just once, Nagios has <span class="emphasis"><em>volatile services</em></span>, described in <a class="xref" href="../Text/ch14s05.html#nagios_configuration_colon_volatile_se" title="14.5.2 Nagios configuration: volatile services">14.5.2 Nagios configuration: volatile services</a> from page 309. For services defined in this way, the system treats every error status as if it was occurring for the first time (causing a message to be sent each time, for example).<a class="indexterm" id="IDX-CHP-7-0637"/></p>

    <p>Nagios periodically performs (active) checks with the plugins introduced here. If the entry sought does not reoccur, the plugin returns an OK. This is desired in many cases, and the administrator does not need to worry about the earlier error event. But if an error event needs to be handled in all cases, a simple Nagios check is no longer sufficient, since it will be easily overlooked due to the OK of a subsequent check. A slightly different approach, in which an administrator has to explicitly confirm every error result, is introduced in <a class="xref" href="../Text/ch23.html" title="Chapter 23. Processing Events with the EventDB">Chapter 23</a> in page 531.</p>

    <div class="sect2" title="7.5.1 The standard plugin check.log">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="the_standard_plugin_check.log"/>7.5.1 The standard plugin <strong class="userinput"><code>check.log</code></strong></h2>
      </div>

      <p>With <strong class="userinput"><code>check_log</code></strong>, Nagios provides a simple plugin for monitoring log files. It creates a copy of the tested log file each time it is run. If the log file has changed since the previous call, <strong class="userinput"><code>check_log</code></strong> searches the newly added data for simple text patterns. The plugin does not have any longer options and just has the states OK and CRITICAL :<a class="indexterm" id="IDX-CHP-7-0638"/><a class="indexterm" id="IDX-CHP-7-0639"/><a class="indexterm" id="IDX-CHP-7-0640"/><a class="indexterm" id="IDX-CHP-7-0641"/><a class="indexterm" id="IDX-CHP-7-0642"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-F</code></strong> <strong class="userinput"><code><em class="replaceable"><code>logfile</code></em></code></strong></span></dt>

          <dd>
            <p>This is the name and path of the log file to be tested. It must be readable for the user <strong class="userinput"><code>nagios</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-O</code></strong> <strong class="userinput"><code><em class="replaceable"><code>oldlog</code></em></code></strong></span></dt>

          <dd>
            <p>This is the name and path of the log file copy. The plugin just examines the difference between <strong class="userinput"><code><em class="replaceable"><code>oldlog</code></em></code></strong> and <strong class="userinput"><code><em class="replaceable"><code>logfile</code></em></code></strong> when it is run. Afterward it copies the current log file to <strong class="userinput"><code><em class="replaceable"><code>oldlog. oldlog</code></em></code></strong> must contain the absolute path and be readable for the user <strong class="userinput"><code>nagios</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-q</code></strong> <strong class="userinput"><code><em class="replaceable"><code>query</code></em></code></strong></span></dt>

          <dd>
            <p>This is the pattern searched for in examining the log file. Not found means OK; a match returns the CRITICAL status.</p>
          </dd>
        </dl>
      </div>

      <p>It is recommended that you generally do not use messages of the type <span class="emphasis"><em>recovery notification</em></span> (OK after an error state).<a class="indexterm" id="IDX-CHP-7-0643"/></p>

      <p>An OK in a repeated test just means that no new error in events have occurred since the last test. The <strong class="userinput"><code>notification_options</code></strong> parameter (see <a class="xref" href="../Text/ch02s03.html" title="2.3 Defining the Machines to Be Monitored, with host">2.3 Defining the Machines to Be Monitored, with host</a>) in the service definition should therefore not contain an <strong class="userinput"><code>r</code></strong>.</p>

      <p>The following command examines the file <strong class="userinput"><code>/var/log/auth</code></strong> for failed logins :</p><a id="I_programlisting4_d1e14865"/>
      <pre class="programlisting">nagios@linux : local/libexec$ <span class="strong"><strong>./check_log -F /var/log/auth</strong></span> \
<span class="strong"><strong>     -O /tmp/check_log.badlogin -q "authentication failure"</strong></span>
(1) &lt; Jan 1 18 : 47 : 56 swobspace su[22893]: (pam_unix) authentication
failure; logname=wob uid=200 euid=0 tty=pts/8 ruser=wob rhost= user=root</pre>

      <p>This produces one hit. The plugin does not show its return value in the text, but it can be displayed in the shell with <strong class="userinput"><code>echo $?</code></strong>. In the example, a <strong class="userinput"><code>2</code></strong> for CRITICAL is returned.<a class="indexterm" id="IDX-CHP-7-0644"/></p>

      <p>If you examine the log file for several different events, you must specify a separate <strong class="userinput"><code><em class="replaceable"><code>oldlog</code></em></code></strong> for each log file:</p><a id="I_programlisting4_d1e14892"/>
      <pre class="programlisting">./check_log -F /var/log/messages -O /tmp/check_log.pluto -q "pluto"
./check_log -F /var/log/messages -O /tmp/check_log.ntpd -q "ntpd"</pre>

      <p>Even if you are searching in the same original log file, you cannot avoid using two different <strong class="userinput"><code>oldlogs</code></strong>: otherwise <strong class="userinput"><code>check_log</code></strong> would not work correctly.</p>
    </div>

    <div class="sect2" title="7.5.2 The modern variation: check_logs.pl">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="the_modern_variation_colon_check_logs.pl"/>7.5.2 The modern variation: <strong class="userinput"><code>check_logs.pl</code></strong></h2>
      </div>

      <p>As an alternative, The Nagios Exchange<sup>[<a class="footnote" href="#ftn.CHP-7-FN-4" id="CHP-7-FN-4">74</a>]</sup> provides a completely new plugin for monitoring log files. <strong class="userinput"><code>check_logs.pi</code></strong> represents a further development of the Perl plugin <strong class="userinput"><code>check_log2.pl</code></strong>, which is included in the <strong class="userinput"><code>contrib</code></strong> directory for Nagios plugins but is not installed automatically.<a class="indexterm" id="IDX-CHP-7-0645"/><a class="indexterm" id="IDX-CHP-7-0646"/></p>

      <p><strong class="userinput"><code>check_logs.pl</code></strong> can examine several log files simultaneously for events, in contrast to <strong class="userinput"><code>check_log</code></strong> and <strong class="userinput"><code>check_log2.pl</code></strong>. It requires a configuration file to do this.</p>

      <p>It does have a simple command line mode, but this functions only if you specify a single log file and a single regular expression simultaneously. But the really interesting feature of <strong class="userinput"><code>check_logs.pl</code></strong> is that you can perform several examinations in one go. This is why we will not spend any more time describing the command line mode.</p>

      <p>Initially we create a configuration file with roughly the following contents, preferably in the directory <strong class="userinput"><code>/etc/nagios:</code></strong></p><a id="I_programlisting4_d1e14949"/>
      <pre class="programlisting"># /etc/nagios/check_logs.cfg
$seek_file_template='/var/nagios/$log_file.check_log.seek';

@log_files = (
   {'file_name' ⇒ '/var/log/messages',
   'reg_exp' ⇒ 'ntpd',
   },
   {'file_name' ⇒ '/var/log/warn',
   'reg_exp' ⇒ '(named|dhcpd)',
   },
 );
 1;</pre>

      <p>The Perl variable <strong class="userinput"><code>$seek_file_template</code></strong> contains the path to the file in which the plugin saves the current position of the last search. <strong class="userinput"><code>check_logs.pl</code></strong> remembers here at what point in the log file it should carry on searching the next time it is run. This means that the plugin does not require a copy of the processed log file. Instead of the variable <strong class="userinput"><code>$log_file</code></strong>, it uses the name of the log file to be examined in each case and creates a separate position file for each log file.</p>

      <p>What exactly <strong class="userinput"><code>check_logs.pl</code></strong> is to do is defined by the Perl array <strong class="userinput"><code>@log_files</code></strong>. The entry <strong class="userinput"><code>file_name</code></strong> points to the log file to be tested (with the absolute path), and <strong class="userinput"><code>reg_exp</code></strong> contains the regular expression,<sup>[<a class="footnote" href="#ftn.CHP-7-FN-5" id="CHP-7-FN-5">75</a>]</sup> for which <strong class="userinput"><code>check_logs.pl</code></strong> should search the log file. In the example above this is just a simple text called <strong class="userinput"><code>ntpd</code></strong> in the case of the <strong class="userinput"><code>/var/log/messages</code></strong> log file, but there is an alternative in the case of <strong class="userinput"><code>/var/log/warn</code></strong>: the regular expression <strong class="userinput"><code>(named | dhcpd)</code></strong> matches lines that contain either the text <strong class="userinput"><code>named</code></strong> or the text <strong class="userinput"><code>dhcpd</code></strong>.</p>

      <p>The only specification that the plugin itself requires when it is run is the configuration file (option <strong class="userinput"><code>-c</code></strong>):</p><a id="I_programlisting4_d1e15014"/>
      <pre class="programlisting">nagios@linux : local/libexec$ <span class="strong"><strong>./check_logs.pl -c \</strong></span>
<span class="strong"><strong>/etc/nagios/check_logs.cfg</strong></span>
messages ⇒ OK; warn ⇒ OK;

nagios@linux : local/libexec$ <span class="strong"><strong>./check_logs.pl -c \</strong></span>
<span class="strong"><strong>/etc/nagios/check_logs.cfg</strong></span>
messages ⇒ OK; warn ⇒ (4): Jul  2 14 : 33 : 25 swobspace dhcpd: Configuration file
 errors encountered -- exiting;</pre>

      <p>The first command shows the basic principle: in the text output the plugin for each log file announces separately whether it has found a matching event or not. In the above example it didn't find anything, so it returns OK. In the second command the plugin comes across four relevant entries in the <strong class="userinput"><code>warn</code></strong> log file, but it doesn't find any in <strong class="userinput"><code>/var/log/messages</code></strong>. Because of this, the plugin returns a WARNING; OK is given only if no relevant events were found in any of the log files checked. In its output line, after <strong class="userinput"><code>(4):</code></strong>, the plugin remembers the last of the four lines found.</p>
    </div>

    <div class="sect2" title="7.5.3 The Swiss Army knife: check_logfiles">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="the_swiss_army_knife_colon_check_undersc"/>7.5.3 The Swiss Army knife: <strong class="userinput"><code>check_logfiles</code></strong></h2>
      </div>

      <p>If you have many requirements from a log file check and the tools introduced so far do not meet your needs, then you really should take a look at the plugin <strong class="userinput"><code>check_logfiles</code></strong> by Gerhard Laußer. As well as sophisticated search options, it can handle any rotation methods you please, so that no information will be lost after a rotation. Its range of functions can be extended by scripts, which can be used to restart applications that have crashed, to send SNMP traps, or send passive check results to an NSCA daemon via <strong class="userinput"><code>send_nsca</code></strong> (<a class="xref" href="../Text/ch14s04.html" title="14.4 Sending Test Results to the Server">14.4 Sending Test Results to the Server</a>, page 305).<a class="indexterm" id="IDX-CHP-7-0648"/><a class="indexterm" id="IDX-CHP-7-0647"/></p>

      <p>For simple tasks the plugin can be operated easily from the command line, but to use it in more advanced ways you will need to have some knowledge of Perl: the configuration file that is needed to make use of all the features uses the Perl syntax.</p>

      <p>The plugin<sup>[<a class="footnote" href="#ftn.CHP-7-FN-6" id="CHP-7-FN-6">76</a>]</sup> is unpacked in a suitable directory, for example in <strong class="userinput"><code>/usr/local/src</code></strong>:</p><a id="I_programlisting4_d1e15073"/>
      <pre class="programlisting">linux: local/src <span class="strong"><strong># tar xvzf /</strong></span><span class="bolditalic">pfad-zu</span><span class="strong"><strong>/check_logfiles-2.3.1.2.tar.gz</strong></span>
...
linux: local/src <span class="strong"><strong># cd check_logfiles-2.3.1.2</strong></span>
linux: check_logfiles-2.3.1.2 # .<span class="strong"><strong>/configure \</strong></span>
 <span class="strong"><strong>   --with-seekfiles-dir=/var/tmp \</strong></span>
 <span class="strong"><strong>   --with-protocols-dir=/var/tmp</strong></span>
...
linux: check_logfiles-2.3.1.2 <span class="strong"><strong># make &amp;&amp; make install</strong></span>
...</pre>

      <p>The installation is done with the three commands <strong class="userinput"><code>configure &amp;&amp; make &amp;&amp; make install</code></strong>. <strong class="userinput"><code>--with-seekf iles-dir</code></strong> specifies the directory in which <strong class="userinput"><code>check_logfiles</code></strong> writes status information, and <strong class="userinput"><code>--with-protocol-dir</code></strong> specifies the directory in which <strong class="userinput"><code>check_logfiles</code></strong> explicitly retains matches it has found. When doing this you should select a directory that is not deleted directly after every reboot. Logging can be switched off in the configuration, depending on the check defined.</p>

      <p>On the command line, <strong class="userinput"><code>check_logfiles</code></strong> offers the following options :</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>--tag=</code></strong><strong class="userinput"><code><em class="replaceable"><code>designator</code></em></code></strong></span></dt>

          <dd>
            <p>Indicates individual checks, to make better distinction between them. The names of the variables in the performance data also start with this designator, so that the values can later be reassigned to a check. Specifying <strong class="userinput"><code>--tag</code></strong> is optional, but the author of the plugin generally recommends its use.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--logfile=</code></strong><strong class="userinput"><code><em class="replaceable"><code>logfile</code></em></code></strong></span></dt>

          <dd>
            <p>Specifies the name and path of the log files to be examined. <strong class="userinput"><code>check_logfiles</code></strong> takes note of the last line of the file to be considered during each check, so that it can continue at the same place the next time it is called. In addition, <strong class="userinput"><code>check_logfiles</code></strong> saves other information such as inode and timestamp, so that it can detect log file rotations.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--rotation=</code></strong><strong class="userinput"><code><em class="replaceable"><code>rotation method</code></em></code></strong></span></dt>

          <dd>
            <p>Specifies the rotation procedure for the log file: <strong class="userinput"><code>loglog0log1gz</code></strong> is used if if you want to turn <strong class="userinput"><code><em class="replaceable"><code>logfile</code></em></code></strong> into <strong class="userinput"><code><em class="replaceable"><code>logfile.0</code></em></code></strong> and turn this into <strong class="userinput"><code><em class="replaceable"><code>Logfile.1.gz.</code></em></code></strong></p>

            <p><strong class="userinput"><code>loglog0gzlog1gz</code></strong> means that <strong class="userinput"><code><em class="replaceable"><code>logfile</code></em></code></strong> is first compressed to <strong class="userinput"><code><em class="replaceable"><code>logfile. 0. gz</code></em></code></strong> and is later renamed <strong class="userinput"><code><em class="replaceable"><code>logfile.1.gz.</code></em></code></strong></p>

            <p><strong class="userinput"><code>loglogdate8gz</code></strong> states that <strong class="userinput"><code><em class="replaceable"><code>logfile</code></em></code></strong> will be converted into <strong class="userinput"><code><em class="replaceable"><code>logfile. YYYYMMDD.gz.</code></em></code></strong></p>

            <p><strong class="userinput"><code>loglog01og1</code></strong> describes the rotation method that turns <strong class="userinput"><code><em class="replaceable"><code>logfile</code></em></code></strong> into <strong class="userinput"><code><em class="replaceable"><code>logfile.0</code></em></code></strong> and creates the file <strong class="userinput"><code><em class="replaceable"><code>logfile.1</code></em></code></strong> in the next rotation step.</p>

            <p>hpux in turn describes the variation " <strong class="userinput"><code><em class="replaceable"><code>logfile</code></em></code></strong> is turned into <strong class="userinput"><code>OLD</code></strong><strong class="userinput"><code><em class="replaceable"><code>logfile</code></em></code></strong>".</p>

            <p>If a suitable rotation method is missing, you can specify a regular expression that matches the archived files instead. For Debian, you therefore specify <strong class="userinput"><code>--rotation='</code></strong> <strong class="userinput"><code><em class="replaceable"><code>logfile</code></em>\. (0|[0-9]+\.gz)</code></strong>. This is in case the ending <strong class="userinput"><code>.0</code></strong> is missed during the initial rotation of the file, and if all older archived files end in <strong class="userinput"><code><em class="replaceable"><code>.number</code></em></code></strong><strong class="userinput"><code>.gz</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--criticalpattern=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong></span></dt>

          <dd>
            <p>Regular expression in Perl syntax that triggers a CRITICAL. More detailed information on this is provided by <strong class="userinput"><code>man perlre</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--warningpattern=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong></span></dt>

          <dd>
            <p>Like <strong class="userinput"><code>--criticalpattern</code></strong>, except that the regular expression here triggers a WARNING.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--noprotocol</code></strong></span></dt>

          <dd>
            <p>Switches off logging of matches to a separate file.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--syslogserver</code></strong></span></dt>

          <dd>
            <p>Restricts the evaluation of log files of a syslog server to lines that the server itself has entered.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>--syslogclient=</code></strong><strong class="userinput"><code><em class="replaceable"><code>clientname</code></em></code></strong></span></dt>

          <dd>
            <p>Restricts the evaluation of log files of a syslog server to lines that originate from the syslog client <strong class="userinput"><code><em class="replaceable"><code>clientname</code></em></code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-f</code></strong> <strong class="userinput"><code><em class="replaceable"><code>configfile</code></em></code></strong></span></dt>

          <dd>
            <p>Specifies a configuration file that allows a more extensive configuration than that allowed by just a few command line parameters. A knowledge of Perl is essential for this (see <a class="xref" href="../Text/ch07s05.html#the_swiss_army_knife_colon_check_undersc" title="7.5.3 The Swiss Army knife: check_logfiles">7.5.3 The Swiss Army knife: check_logfiles</a>).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-d</code></strong></span></dt>

          <dd>
            <p>Switches on debugging. Useful for searching for errors; this option should not be used during normal operation.</p>
          </dd>
        </dl>
      </div>

      <p><strong class="userinput"><code>check_logfiles</code></strong> is initialized when it is first called so that it can orient itself. The plugin only takes into account log entries that are subsequently appended to the log file, so it cannot evaluate already existing details.</p>

      <p>For demonstration purposes we will first use the <strong class="userinput"><code>logger</code></strong> program to generate an entry in the file <strong class="userinput"><code>/var/log/messages</code></strong>: <sup>[<a class="footnote" href="#ftn.CHP-7-FN-7" id="CHP-7-FN-7">77</a>]</sup><a class="indexterm" id="IDX-CHP-7-0649"/></p><a id="I_programlisting4_d1e15351"/>
      <pre class="programlisting">user@linux: ~$ <span class="strong"><strong>logger -p daemon.info hellowob</strong></span></pre>

      <p>The log file now contains the following entry:</p><a id="I_programlisting4_d1e15358"/>
      <pre class="programlisting">Dec 16 17 : 46 : 06 swobspace wob: hellowob</pre>

      <p>A simple call of <strong class="userinput"><code>check_logfiles</code></strong> returns the following result :</p><a id="I_programlisting4_d1e15365"/>
      <pre class="programlisting">nagios@linux : nagios/libexec$ <span class="strong"><strong>./check_logfiles --tag=hellowob</strong></span> \
<span class="strong"><strong>     --logfile=/var/log/messages --criticalpattern='hellowob'</strong></span>
CRITICAL - (1 errors in check_logfiles.protocol-2007-12-16-17-46-08) - D
ec 16 17 : 46 : 06 swobspace wob: hellowob |hellowob_lines=2 hellowob_warni
ngs=0 hellowob_criticals=1 hellowob_unknowns=0</pre>

      <p>All variables in the performance data are appended to the <strong class="userinput"><code>hellowob</code></strong> tag so that the respective events can be referenced again, if <strong class="userinput"><code>check_logfiles</code></strong> is to simultaneously search for several different entries.</p>

      <p>Re-running <strong class="userinput"><code>check_logfiles</code></strong> again returns an OK, since none of the 32 newly added entries (<strong class="userinput"><code>hellowob_lines=32</code></strong>) contains the text being sought:</p><a id="I_programlisting4_d1e15389"/>
      <pre class="programlisting">nagios@linux : nagios/libexec$ <span class="strong"><strong>./check_logfiles --tag=hellowob</strong></span> \
<span class="strong"><strong>     --logfile=/var/log/messages --criticalpattern='hellowob'</strong></span>
OK - no errors or warnings |hellowob_lines=32 hellowob_warnings=0 hellow
ob_criticals=0 hellowob_unknowns=0</pre>

      <div class="sect3" title="Configuration Files">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="configuration_files"/>Configuration Files</h3>
        </div>

        <p>Configuration files for <strong class="userinput"><code>check_logfiles</code></strong> basically contain an array consisting of search instructions, each of which are written as an anonymous hash:</p><a id="I_programlisting4_d1e15405"/>
        <pre class="programlisting">@searches = (
   { <span class="emphasis"><em>search_instruction_1</em></span> },
   { <span class="emphasis"><em>search_instruction_2</em></span> },
   ...
   { <span class="emphasis"><em>search_instruction_n</em></span> },
)</pre>

        <p>The array is called <strong class="userinput"><code>@searches</code></strong>; each instruction enclosed in <strong class="userinput"><code>{}</code></strong> is a search instruction. A configuration file for the <strong class="userinput"><code>hellowob</code></strong> example could look like this:</p><a id="I_programlisting4_d1e15427"/>
        <pre class="programlisting">@searches = (
   {
      tag              ⇒ 'hellowob',
      logfile          ⇒ '/var/log/messages',
      criticalpatterns ⇒ 'hellowob',
      rotation         ⇒ 'debian',
      options          ⇒ 'noprotocol,nocase',
    },
)</pre>

        <p>The instructions tag and <strong class="userinput"><code>rotation</code></strong> correspond to the command line parameters of the same name. The instructions <strong class="userinput"><code>criticalpatterns</code></strong> and <strong class="userinput"><code>warningpatterns</code></strong> are notated here -in contrast to the equivalent command line parameter-in the plural. The configuration file also allows multiple details :</p><a id="I_programlisting4_d1e15440"/>
        <pre class="programlisting">criticalpatterns ⇒ ['VIRUS found', 'hellowob'],</pre>

        <p>Instead of a scalar, an anonymous array may also be specified within square brackets. Here are some more instructions for <strong class="userinput"><code>@searches</code></strong>:</p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>archivedir</code></strong></span></dt>

            <dd>
              <p>Archive directory for rotated log files. The default is the directory in which the log file is located.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>type</code></strong></span></dt>

            <dd>
              <p>Specifies the type of log file: <strong class="userinput"><code>rotation</code></strong> is accepted by default if the parameter <strong class="userinput"><code>rotation</code></strong> is set. <strong class="userinput"><code>simple</code></strong> describes log files without rotation, <strong class="userinput"><code>check_logfiles</code></strong> does not continue searching for archived files. <strong class="userinput"><code>virtual</code></strong> indicates files that should always be searched from the beginning, such as sockets or files from the <strong class="userinput"><code>/proc</code></strong> directory in Linux. For AIX, the option <strong class="userinput"><code>errpt</code></strong> is also available: instead of a real file, the plugin now searches for the output of the <strong class="userinput"><code>errpt</code></strong> command.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>criticalpatterns</code></strong></span></dt>

            <dd>
              <p>Like the command line option <strong class="userinput"><code>--criticalpattern</code></strong>, except that now a number of expressions may be specified as an array:</p><a id="I_programlisting4_d1e15497"/>
              <pre class="programlisting">criticalpatterns ⇒ ['.*hallowob.*', '.*hellowob.* ', '!dontcryforme'],</pre>

              <p>The exclamation mark ensures a CRITICAL if no line is found with the text <strong class="userinput"><code>dontcryforme</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>criticalexceptions</code></strong></span></dt>

            <dd>
              <p>Like <strong class="userinput"><code>criticalpatterns</code></strong>, except as an exception: If a line matches an expression from <strong class="userinput"><code>criticalpatterns</code></strong>, a CRITICAL would be triggered. If an expression from <strong class="userinput"><code>criticalexceptions</code></strong> also matches this very same line, this then stops the critical state. The instruction is used to intercept special cases.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>criticalthreshold</code></strong></span></dt>

            <dd>
              <p>Sets a threshold. The value <strong class="userinput"><code>5</code></strong>, for example, means that only every fifth match from <strong class="userinput"><code>criticalpatterns</code></strong> is really counted as CRITICAL. Below this threshold, the result remains OK.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>warningpatterns</code></strong></span></dt>

            <dd>
              <p>Like <strong class="userinput"><code>criticalpatterns</code></strong>, except for warnings.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>warningexceptions</code></strong></span></dt>

            <dd>
              <p>Like <strong class="userinput"><code>criticalexceptions</code></strong>, except for warnings.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>warningthreshold</code></strong></span></dt>

            <dd>
              <p>Like <strong class="userinput"><code>criticalthreshold</code></strong>, except for warnings.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>okpatterns</code></strong></span></dt>

            <dd>
              <p>Sometimes errors can rectify themselves. In such cases the administrator does not want to be woken up by unnecessary alarms.</p>

              <p><strong class="userinput"><code>okpatterns</code></strong> cancels all previous WARNINGs and CRITICALs. It is possible to specify multiple details (see <strong class="userinput"><code>criticalpatterns</code></strong>).</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>script</code></strong></span></dt>

            <dd>
              <p>Allows a script to be executed in case a match is found. To following instructions supplement this: <strong class="userinput"><code>scriptparams</code></strong> passes additional command line options to the script, <strong class="userinput"><code>scriptstdin</code></strong> allows to specify strings that are expected by the script on STDIN, and <strong class="userinput"><code>scriptdelay</code></strong> forces <strong class="userinput"><code>check_logfiles</code></strong> to take a break after the script has been executed.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>options</code></strong></span></dt>

            <dd>
              <p>This instruction allows further settings options to be made, the meanings of which can be negated by placing the prefix <strong class="userinput"><code>no</code></strong> in front of the option:</p>

              <div class="variablelist">
                <dl>
                  <dt><span class="term"><strong class="userinput"><code>script</code></strong></span></dt>

                  <dd>
                    <p>Executes the specified script. The default is <strong class="userinput"><code>noscript</code></strong>.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>smartscript</code></strong></span></dt>

                  <dd>
                    <p>Controls whether the return value of the script and its output should be included in the match list. The default is <strong class="userinput"><code>nosmartscript</code></strong>.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>supersmartscript</code></strong></span></dt>

                  <dd>
                    <p>Defines whether the return value and the output of the script should replace previous matches (the default is <strong class="userinput"><code>nosupersmartscript</code></strong>). The return value <strong class="userinput"><code>0</code></strong> (OK) of the script would, for example, suppress a found match, by overwriting the return value that is normally returned by <strong class="userinput"><code>check_logfiles</code></strong>.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>protocol</code></strong></span></dt>

                  <dd>
                    <p>Controls whether matches are to be retained in a separate log file. (The default is <strong class="userinput"><code>protocol</code></strong>).</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>count</code></strong></span></dt>

                  <dd>
                    <p>Should matches be counted or not? <strong class="userinput"><code>count</code></strong> is the default. If this option is switched off with <strong class="userinput"><code>nocount</code></strong>, you can still use <strong class="userinput"><code>check_logfiles</code></strong> to just execute scripts.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>syslogserver</code></strong></span></dt>

                  <dd>
                    <p>Corresponds to the option <strong class="userinput"><code>--syslogserver</code></strong> (the default is <strong class="userinput"><code>nosyslogserver</code></strong>).</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>syslogclient=string</code></strong></span></dt>

                  <dd>
                    <p>Like <strong class="userinput"><code>--syslogclient</code></strong>, except that an additional filter may be specified, for example, to search only for the files of a specific client (<strong class="userinput"><code>nosyslogclient</code></strong> is the default).</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>perfdata</code></strong></span></dt>

                  <dd>
                    <p>Should performance data be displayed? The default is <strong class="userinput"><code>perfdata</code></strong>.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>logfilenocry</code></strong></span></dt>

                  <dd>
                    <p>If a log file does not exist, <strong class="userinput"><code>check_logfiles</code></strong> outputs UNKNOWN, in accordance with the default, <strong class="userinput"><code>logfilenocry</code></strong>. The parameter <strong class="userinput"><code>nologfilenocry</code></strong> tells the plugin to omit an error message if the log file is missing.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>case nocase</code></strong></span></dt>

                  <dd>
                    <p>ignores upper/lower case. The default, with case, is the opposite of this.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>sticky=seconds</code></strong></span></dt>

                  <dd>
                    <p>With this option <strong class="userinput"><code>check_logfiles</code></strong> notices an error state for the amount of time specified. Normally a subsequent check that does not find any more matches would return an OK, so that the administrator might overlook an important entry.</p>

                    <p>Let us assume that you only accept the truce when there have been no more matches in the log file for two hours. Then the check with <strong class="userinput"><code>sticky=7200</code></strong> will announce an error state for up to two hours. Only after this period has expired will <strong class="userinput"><code>check_logfiles</code></strong> return to an OK, provided that in the meantime no new entry restarts the two-hour time limit.</p>

                    <p>If the search pattern contains <strong class="userinput"><code>okpattern</code></strong>, <strong class="userinput"><code>check_logfiles</code></strong> returns an OK directly after a match, that is, before the specified time has expired.</p>
                  </dd>

                  <dt><span class="term"><strong class="userinput"><code>savethresholdcount</code></strong></span></dt>

                  <dd>
                    <p>If an event does not attain the number of matches required in the <strong class="userinput"><code>*threshold</code></strong> options, no error is announced. The question here is how the matches overall should be handled. <strong class="userinput"><code>savethresholdcount</code></strong> (the default) saves the number of matches until the next check and adds these together until the threshold is reached and an error is triggered. The parameter <strong class="userinput"><code>nosavethresholdcount</code></strong> prevents the event counter from always being reset to zero between two checks.</p>
                  </dd>
                </dl>
              </div>
            </dd>
          </dl>
        </div>

        <p>It is beyond the scope of this book to describe all the possible applications of <strong class="userinput"><code>check_logfiles</code></strong>. For this reason, we refer to the documentation, available in German and English, on the <strong class="userinput"><code>check_logfiles</code></strong> Web site.<sup>[<a class="footnote" href="#ftn.CHP-7-FN-8" id="CHP-7-FN-8">78</a>]</sup></p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-4" id="ftn.CHP-7-FN-4">74</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/54;279">http://www.nagiosexchange.org/54;279</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-5" id="ftn.CHP-7-FN-5">75</a>]</sup> In the form of Perl-compatible regular expressions (PCRE, see <strong class="userinput"><code>man perlre</code></strong>), since <strong class="userinput"><code>check_logs.pi</code></strong> is a Perl script.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-6" id="ftn.CHP-7-FN-6">76</a>]</sup> <a class="ulink" href="http://www.consol.de/opensource/nagios/check-logfiles">http://www.consol.de/opensource/nagios/check-logfiles</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-7" id="ftn.CHP-7-FN-7">77</a>]</sup> We are assuming here that the <strong class="userinput"><code>daemon</code></strong> facility is logged with the <strong class="userinput"><code>info</code></strong> priority in <strong class="userinput"><code>/var/log/messages</code></strong>. This is dependent on the distribution, however. In Debian, such entries land in <strong class="userinput"><code>/var/log/daemon.log</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-8" id="ftn.CHP-7-FN-8">78</a>]</sup> <a class="ulink" href="http://www.consol.com/opensource/nagios/check-logfiles">http://www.consol.com/opensource/nagios/check-logfiles</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="7.6 Keeping Tabs on the Number of Logged-In Users">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="keeping_tabs_on_the_number_of_logged-in"/>7.6 Keeping Tabs on the Number of Logged-In Users</h1>
    </div>

    <p>The plugin <strong class="userinput"><code>check_users</code></strong> is used to monitor the number of logged-in users:<a class="indexterm" id="IDX-CHP-7-0650"/><a class="indexterm" id="IDX-CHP-7-0651"/><a class="indexterm" id="IDX-CHP-7-0652"/><a class="indexterm" id="IDX-CHP-7-0653"/><a class="indexterm" id="IDX-CHP-7-0654"/><a class="indexterm" id="IDX-CHP-7-0655"/></p><a id="I_programlisting4_d1e15821"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_users -w 5 -c 10</strong></span>
USERS CRITICAL - 20 users currently logged in |users=20;5;10;0</pre>

    <p>It has just two options:</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong></span></dt>

        <dd>
          <p>This is the threshold for the number of logged-in users after which the plugin should give a warning.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong></span></dt>

        <dd>
          <p>This is the threshold for a critical state, measured by the number of logged-in users.</p>
        </dd>
      </dl>
    </div>

    <p>The performance data after the <strong class="userinput"><code>|</code></strong> is as usual visible only on the command line; Nagios does not include it in the Web interface.</p>
  </div>


  <div class="sect1" title="7.7 Checking the System Time">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="checking_the_system_time"/>7.7 Checking the System Time</h1>
    </div>

    <div class="sect2" title="7.7.1 Checking the system time via NTP">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="checking_the_system_time_via_ntp"/>7.7.1 Checking the system time via NTP</h2>
      </div>

      <p>The two plugins <strong class="userinput"><code>check_ntp</code></strong> and <strong class="userinput"><code>check_ntp_time</code></strong> compare the clock time of the local computer with that of an available NTP server in the network. If the Nagios server keeps time via NTP accurately enough, so that it can serve as a reference itself, then it can also be used as a network plugin, provided that the host to be checked in the network has an NTP daemon installed.<a class="indexterm" id="IDX-CHP-7-0656"/><a class="indexterm" id="IDX-CHP-7-0657"/></p>

      <p>From plugin version 1.4.11, the plugins <strong class="userinput"><code>check_ntp_time</code></strong> and <strong class="userinput"><code>check_ntp_peer</code></strong> (<a class="xref" href="../Text/ch06s15.html" title="6.12 Health Check of an NTP Server with check_ntp_peer">6.12 Health Check of an NTP Server with check_ntp_peer</a>, page 154) replace <strong class="userinput"><code>check_ntp</code></strong>, which contains the functions of both: the comparison of the local system time with an NTP server described here and the health check of the NTP server itself. The options here apply both to <strong class="userinput"><code>check_ntp</code></strong> and to <strong class="userinput"><code>check_ntp_time</code></strong>.</p>

      <p>In the simplest case, <strong class="userinput"><code>check_ntp</code></strong> is called, specifying the computer (here: <strong class="userinput"><code>ntpserver</code></strong>) whose time should be compared with that of the local computer:</p><a id="I_programlisting4_d1e15922"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_ntp_time -H ntpserver</strong></span>
NTP OK: Offset −0.009505749214 secs|offset=−0.009506s;60.000000;120.0000
00;</pre>

      <p>The deviation determined here amounts to just 9.5 milliseconds, a good value. How much deviation can be tolerated depends on the particular intended use. If you want to compare the log file entries of several different computers, they ought to be NTP-synchronized. Then you can certainly use <strong class="userinput"><code>-w 1 -c 2</code></strong>, that is, assign a deviation of two seconds as critical. In environments in which Kerberos is used for authentication, time synchronization of all hosts involved is also important, but not quite as critical: Microsoft's Active Directory under Windows Server 2003 tolerates a maximum deviation of five minutes, and only when there are larger deviations do real problems arise.</p>

      <p><strong class="userinput"><code>check_ntp_time</code></strong> and <strong class="userinput"><code>check_ntp</code></strong> have the following options:<a class="indexterm" id="IDX-CHP-7-0658"/><a class="indexterm" id="IDX-CHP-7-0659"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>This is the NTP server with which the plugin should compare the local system time.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

          <dd>
            <p>The UDP port on which the NTP server runs. The default is port <strong class="userinput"><code>123</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong></span></dt>

          <dd>
            <p>This is the warning limit, specified in the standard threshold format (<a class="xref" href="../Text/ch24.html#specifying_thresholds" title="24.1.5 Specifying thresholds">24.1.5 Specifying thresholds</a>, page 557). The warning is given if the fluctuation of the local system time is larger than the threshold specified. The default is 60 seconds.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong></span></dt>

          <dd>
            <p>Critical threshold in seconds, specified in the standard threshold format (<a class="xref" href="../Text/ch24.html#specifying_thresholds" title="24.1.5 Specifying thresholds">24.1.5 Specifying thresholds</a>, page 557). If the local system time deviates more than the given number of seconds (in the default setting 120 seconds) from that of the NTP server, the status becomes CRITICAL.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-q / --quiet</code></strong> (only <strong class="userinput"><code>check_ntp_time</code></strong>)</span></dt>

          <dd>
            <p>Returns UNKNOWN instead of CRITICAL if the NTP server-for whatever reason-does not provide an offset.</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="sect2" title="7.7.2 Checking system time with the time protocol">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="checking_system_time_with_the_time_proto"/>7.7.2 Checking system time with the time protocol</h2>
      </div>

      <p>Apart from the <span class="emphasis"><em>Network Time Protocol</em></span> NTP there is another protocol, older and more simple: the <span class="emphasis"><em>Time Protocol</em></span> described in RFC 868, in which communication takes place via TCP port 37. On many Unix systems the corresponding server is integrated into the inet daemon, so you do not have to start a separate daemon. With <strong class="userinput"><code>check_time</code></strong>, Nagios provides an appropriate test plugin.<a class="indexterm" id="IDX-CHP-7-0660"/><a class="indexterm" id="IDX-CHP-7-0661"/><a class="indexterm" id="IDX-CHP-7-0662"/><a class="indexterm" id="IDX-CHP-7-0663"/><a class="indexterm" id="IDX-CHP-7-0664"/></p>

      <p><strong class="userinput"><code>check_time</code></strong> can also be used as a network plugin, in a similar way to <strong class="userinput"><code>check_ntp</code></strong>, but this again assumes that the time service is available for every client. In most cases it will therefore be used as a local plugin that compares its own clock time with that of a central time server (here: <strong class="userinput"><code>timesrv</code></strong>):<a class="indexterm" id="IDX-CHP-7-0665"/><a class="indexterm" id="IDX-CHP-7-0666"/></p><a id="I_programlisting4_d1e16097"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_time -H timesrv -w 10 -c 60</strong></span>
TIME CRITICAL - 1160 second time difference| time=0s;;;0 offset=1160s;10 ;60;0</pre>

      <p>The performance data after the <strong class="userinput"><code>|</code></strong> sign, not shown in the Web interface, contains the response time in seconds, with <strong class="userinput"><code>time</code></strong> (here: zero seconds); <strong class="userinput"><code>offset</code></strong> describes by how much the clock time differs from that of the time server (here: <strong class="userinput"><code>1160</code></strong> seconds). The other values, each separated by a semicolon, provide the warning limit, the critical threshold, and the minimum (see also <a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a> from page 404). Since we have not set any threshold values with the options <strong class="userinput"><code>-W</code></strong> or <strong class="userinput"><code>-C</code></strong>, the corresponding entries for <strong class="userinput"><code>time</code></strong> are empty</p>

      <p><strong class="userinput"><code>check_time</code></strong> has the following options:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --hostname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>This is the host name or IP address of the time server.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

          <dd>
            <p>This is the TCP port specification, if different from the default <strong class="userinput"><code>37</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-u / --udp</code></strong></span></dt>

          <dd>
            <p>Normally the time server is queried via TCP. With <strong class="userinput"><code>-u</code></strong> you can use UDP if the server supports this.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --warning-variance=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

          <dd>
            <p>If the local time deviates more than <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> seconds from that of the time server, the plugin returns a WARNING. <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> is always positive, and this covers clocks that are running both slow and fast.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --critical-variance=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

          <dd>
            <p>If there is more than <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> seconds difference between the local and the time server time, the return value of the plugin is CRITICAL.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-W</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --warning-connect=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

          <dd>
            <p>If the time server needs more than <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> seconds for the response, a WARNING is returned.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --critical-connect=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

          <dd>
            <p>If the time server does not respond within <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> seconds, the plugin reacts with the return value CRITICAL.</p>
          </dd>
        </dl>
      </div>
    </div>
  </div>


  <div class="sect1" title="7.8 Regularly Checking the Status of the Mail Queue">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="regularly_checking_the_status_of_the_mai"/>7.8 Regularly Checking the Status of the Mail Queue</h1>
    </div>

    <p>The <strong class="userinput"><code>check_mailq</code></strong> plugin can be used to monitor the mail queue of a mail server for e-mails that have not yet been delivered. <strong class="userinput"><code>check_mailq</code></strong> runs the program <strong class="userinput"><code>mailq</code></strong> of the mail service installed. Unfortunately each MTA interprets the mail queue differently, so the plugin can evaluate only mail queues from mail services that the programmer has taken into account. These are, specifically: <strong class="userinput"><code>sendmail</code></strong>, <strong class="userinput"><code>qmail</code></strong>, <strong class="userinput"><code>postfix</code></strong>, and <strong class="userinput"><code>exim</code></strong>. The <strong class="userinput"><code>check_mailq</code></strong> plugin has the following options:<a class="indexterm" id="IDX-CHP-7-0667"/><a class="indexterm" id="IDX-CHP-7-0668"/><a class="indexterm" id="IDX-CHP-7-0669"/><a class="indexterm" id="IDX-CHP-7-0670"/><a class="indexterm" id="IDX-CHP-7-0671"/><a class="indexterm" id="IDX-CHP-7-0672"/><a class="indexterm" id="IDX-CHP-7-0673"/><a class="indexterm" id="IDX-CHP-7-0674"/></p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong></span></dt>

        <dd>
          <p>If there are at least <strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong> mails in the mail queue, the plugin gives a warning.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong></span></dt>

        <dd>
          <p>As soon as there are at least <strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong> of mails in the queue waiting to be delivered, then the critical status has been reached.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-W</code></strong> <strong class="userinput"><code><em class="replaceable"><code>number_of_domains</code></em></code></strong> <strong class="userinput"><code>/ --Warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>number_of_domains</code></em></code></strong></span></dt>

        <dd>
          <p>This is the warning limit with respect to the number of recipient domains of a message waiting in the mail queue. Thus <strong class="userinput"><code>-W 3</code></strong> generates a warning if there are any mails in the queue that are addressed to three or more different recipient domains.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>number_of_domains</code></em></code></strong> <strong class="userinput"><code>/ --Critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>number_of_domains</code></em></code></strong></span></dt>

        <dd>
          <p>This is the critical threshold with respect to the number of recipient domains (like <strong class="userinput"><code>-W</code></strong>).</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-M</code></strong> <strong class="userinput"><code><em class="replaceable"><code>daemon</code></em></code></strong> <strong class="userinput"><code>/ --mailserver=</code></strong><strong class="userinput"><code><em class="replaceable"><code>daemon</code></em></code></strong> (from version 1.4)</span></dt>

        <dd>
          <p>This specifies the mail service used. Possible values for <strong class="userinput"><code><em class="replaceable"><code>daemon</code></em></code></strong> are <strong class="userinput"><code>sendmail</code></strong> (the default), <strong class="userinput"><code>qmail</code></strong>, <strong class="userinput"><code>postfix</code></strong>, and <strong class="userinput"><code>exim</code></strong>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> <strong class="userinput"><code>/ --timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

        <dd>
          <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds, the plugin stops the test and returns the CRITICAL status. The default here—as an exception—is <strong class="userinput"><code>15</code></strong> seconds (usually it is 10 seconds).</p>
        </dd>
      </dl>
    </div>

    <p>In the following example, Nagios should give a warning if there are at least five mails in the queue; if the number reaches ten, the status of the MTAs Postfix used here becomes CRITICAL:</p><a id="I_programlisting4_d1e16475"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_mailq -w 5 -c 10 -M postfix</strong></span>
OK: mailq reports queue is empty|unsent=0;5;10;0</pre>

    <p>Since the queue is empty, <strong class="userinput"><code>check_mailq</code></strong> returns OK here.</p>
  </div>


  <div class="sect1" title="7.9 Keeping an Eye on the Modification Date of a File">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="keeping_an_eye_on_the_modification_date"/>7.9 Keeping an Eye on the Modification Date of a File</h1>
    </div>

    <p>With the <strong class="userinput"><code>check_file_age</code></strong> plugin you can monitor not only the last modification date of a file, but also its size. In the simplest case it is just run with the name and path of the file to be monitored:<a class="indexterm" id="IDX-CHP-7-0675"/><a class="indexterm" id="IDX-CHP-7-0676"/><a class="indexterm" id="IDX-CHP-7-0677"/><a class="indexterm" id="IDX-CHP-7-0678"/></p><a id="I_programlisting4_d1e16514"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_file_age /var/log/messages</strong></span>
WARNING - /var/log/syslog/messages is 376 seconds old and 7186250 bytes</pre>

    <p>Here the plugin gives a warning, since the warning limit set is 240 seconds and the critical limit, 600 seconds. The last modification of the file was 376 seconds ago—that is, inside the warning range.</p>

    <p>The file size is taken into account by <strong class="userinput"><code>check_file_age</code></strong> only if a warning limit for the file size (option <strong class="userinput"><code>-W</code></strong>) is explicitly specified. The plugin could then give a warning if the file is smaller than the given limit (in bytes). The defaults for the warning and critical limits here are both zero bytes.</p>

    <p><strong class="userinput"><code>check_file_age</code></strong> has the following options:</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --warning-age=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

        <dd>
          <p>If the file is older than <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong><sup>[<a class="footnote" href="#ftn.CHP-7-FN-9" id="CHP-7-FN-9">79</a>]</sup> (the default is <strong class="userinput"><code>240</code></strong>) seconds, the plugin issues a warning.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --critical-age=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

        <dd>
          <p>A critical status occurs if the file is older than <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> (default: <strong class="userinput"><code>600</code></strong>) seconds.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-W</code></strong> <strong class="userinput"><code><em class="replaceable"><code>size</code></em></code></strong> <strong class="userinput"><code>/ --warning-size=</code></strong><strong class="userinput"><code><em class="replaceable"><code>size</code></em></code></strong></span></dt>

        <dd>
          <p>If the file is smaller than <strong class="userinput"><code><em class="replaceable"><code>size</code></em></code></strong> bytes, the plugin gives a warning. If the option is omitted, <strong class="userinput"><code>0</code></strong> bytes is the limit. In this case <strong class="userinput"><code>check_file_age</code></strong> does not take the file size into account.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>size</code></em></code></strong> <strong class="userinput"><code>/ --critical-size=</code></strong><strong class="userinput"><code><em class="replaceable"><code>size</code></em></code></strong></span></dt>

        <dd>
          <p>A file size smaller than <strong class="userinput"><code><em class="replaceable"><code>size</code></em></code></strong> bytes sets off a critical status. The default is <strong class="userinput"><code>0</code></strong> bytes, which means that the file size is ignored.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-f</code></strong> <strong class="userinput"><code><em class="replaceable"><code>file</code></em></code></strong> <strong class="userinput"><code>/ --file=</code></strong><strong class="userinput"><code><em class="replaceable"><code>file</code></em></code></strong></span></dt>

        <dd>
          <p>The name of the file to be tested. The option may be omitted if you instead—as in the above example—just give the file name itself as an argument.</p>
        </dd>
      </dl>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-9" id="ftn.CHP-7-FN-9">79</a>]</sup> Because <strong class="userinput"><code>check_file_age</code></strong> is a Perl script, it does not matter in this case whether an integer or a floating point decimal is specified. Fractions of a second do not play a role in the file system.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="7.10 Monitoring UPSs with apcupsd">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_upss_with_apcupsd"/>7.10 Monitoring UPSs with apcupsd</h1>
    </div>

    <p>To monitor uninterruptible power supplies (UPS) from the company APC there is the possibility, apart from the Network UPS Tools described in <a class="xref" href="../Text/ch06s14.html" title="6.11 Monitoring UPS with the Network UPS Tools">6.11 Monitoring UPS with the Network UPS Tools</a> from page 149 of using the <strong class="userinput"><code>apcupsd</code></strong> daemon, optimized specifically for use with these UPSs. The software can be obtained from <a class="ulink" href="http://www.apcupsd.com/">http://www.apcupsd.com/</a> and is licensed under the GPL, despite the fact that it is vendor-dependent.<a class="indexterm" id="IDX-CHP-7-0680"/><a class="indexterm" id="IDX-CHP-7-0681"/><a class="indexterm" id="IDX-CHP-7-0682"/><a class="indexterm" id="IDX-CHP-7-0683"/><a class="indexterm" id="IDX-CHP-7-0684"/><a class="indexterm" id="IDX-CHP-7-0685"/><a class="indexterm" id="IDX-CHP-7-0686"/><a class="indexterm" id="IDX-CHP-7-0679"/></p>

    <p>The principal function here is the capacity to be able to shut down systems in the event of power failure, rather than a mere monitoring function with Nagios. For this latter purpose, it is easier to configure the Network UPS Tools.<a class="indexterm" id="IDX-CHP-7-0687"/></p>

    <p>Nearly all Linux distributions contain a working <strong class="userinput"><code>apcupsd</code></strong> package,<sup>[<a class="footnote" href="#ftn.CHP-7-FN-10" id="CHP-7-FN-10">80</a>]</sup> so you don't have to worry about installing it. Nagios does not include an <strong class="userinput"><code>apcupsd</code></strong> plugin, but there is a very simple and effective script available for download at <a class="ulink" href="http://www.negativel.org/check_apc/">http://www.negativel.org/check_apc/</a>: <strong class="userinput"><code>check_apc</code></strong>.<sup>[<a class="footnote" href="#ftn.CHP-7-FN-11" id="CHP-7-FN-11">81</a>]</sup> It is also licensed under the GPL, but it has no network capabilities. The plugin cannot be given a host when it is run, and it also does not support any other types of options. Instead of this, internal commands control its functionality, which are given as the first argument.<a class="indexterm" id="IDX-CHP-7-0688"/><a class="indexterm" id="IDX-CHP-7-0689"/><a class="indexterm" id="IDX-CHP-7-0690"/></p>

    <p>Executing <strong class="userinput"><code>check_apc status</code></strong> tests whether the UPS is online. If this is the case, the plugin returns the OK status, in all other cases it returns CRITICAL:</p><a id="I_programlisting4_d1e16751"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_apc status</strong></span>
UPS OK - ONLINE</pre>

    <p><strong class="userinput"><code>check_apc load</code></strong> <strong class="userinput"><code><em class="replaceable"><code>warn crit</code></em></code></strong> checks the load currently on the UPS and displays it as a percentage of the maximum capacity A warning is given if the load is greater than the warning limits specified in <strong class="userinput"><code><em class="replaceable"><code>warn</code></em></code></strong> (in the following example, 60 percent), CRITICAL if the load is greater than <strong class="userinput"><code><em class="replaceable"><code>crit</code></em></code></strong> (here 80 percent):</p><a id="I_programlisting4_d1e16772"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_apc load 60 80</strong></span>
UPS OK - LOAD: 39%</pre>

    <p>The load status of the UPS is checked by the command <strong class="userinput"><code>check_apc bcharge</code></strong> <strong class="userinput"><code><em class="replaceable"><code>warn crit</code></em></code></strong>. Here the warning limit warn and the critical limit <strong class="userinput"><code><em class="replaceable"><code>crit</code></em></code></strong> are also given in percent. The value <strong class="userinput"><code>100</code></strong> means "fully loaded." The plugin accordingly gives a warning if the load is smaller than the warning limit, and a CRITICAL if the load is smaller than the critical limit:</p><a id="I_programlisting4_d1e16793"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_apc bcharge 50 30</strong></span>
UPS OK - Battery Charge: 100%</pre>

    <p>You can find out how long the saved energy will last with <strong class="userinput"><code>check_apc time</code></strong> <strong class="userinput"><code><em class="replaceable"><code>warn crit</code></em></code></strong>. Here <strong class="userinput"><code>check_apc</code></strong> gives a warning if the remaining time is less than <strong class="userinput"><code><em class="replaceable"><code>warn</code></em></code></strong> minutes, and a CRITICAL if the remaining time is less than <strong class="userinput"><code><em class="replaceable"><code>crit</code></em></code></strong> minutes:</p><a id="I_programlisting4_d1e16819"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_apc time 20 10</strong></span>
UPS OK - Time Left: 30 mins</pre>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-10" id="ftn.CHP-7-FN-10">80</a>]</sup> At least SuSE and Debian use this package name.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-11" id="ftn.CHP-7-FN-11">81</a>]</sup> It can also be obtained at: <a class="ulink" href="http://www.nagiosexchange.org/54;615">http://www.nagiosexchange.org/54;615</a>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="7.11 Nagios Monitors Itself">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="nagios_monitors_itself"/>7.11 Nagios Monitors Itself</h1>
    </div>

    <p>If necessary, Nagios can even monitor itself: the included plugin, <strong class="userinput"><code>check_nagios</code></strong>, tests, on the one hand, whether Nagios processes are running and, on the other hand, the age of the log file <strong class="userinput"><code>nagios.log</code></strong> in the Nagios <strong class="userinput"><code>var</code></strong> directory, for example, <strong class="userinput"><code>/var/nagios/nagios.log</code></strong>.<a class="indexterm" id="IDX-CHP-7-0691"/><a class="indexterm" id="IDX-CHP-7-0692"/><a class="indexterm" id="IDX-CHP-7-0693"/></p>

    <p>Despite this, the question needs to be asked: if Nagios itself is not running, then the system simply cannot perform the plugin, which in turn cannot deliver an error message. The solution to this problem consists in having two Nagios servers, each of which addresses the locally installed plugin on the opposite server, with the help of NRPE (see <a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a> from page 213).</p>

    <p>If you have just one Nagios server you can also run <strong class="userinput"><code>check_nagios</code></strong> alone via cron and have the return value checked using a shell script. In this case, you take action yourself, as shown in <a class="xref" href="../Text/ch07s11.html#running_the_plugin_manually_with_a_scrip" title="7.11.1 Running the plugin manually with a script">7.11.1 Running the plugin manually with a script</a>, so that you are suitably informed of this.</p>

    <p>The plugin has the following options:</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>/path/to/nagios</code></em></code></strong> <strong class="userinput"><code>/ --command=</code></strong><strong class="userinput"><code><em class="replaceable"><code>/path/to/nagios</code></em></code></strong></span></dt>

        <dd>
          <p>This is the complete nagios command, including the path (e.g., <strong class="userinput"><code>-C /usr/local/nagios/bin/nagios</code></strong>).</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-F</code></strong> <strong class="userinput"><code><em class="replaceable"><code>/path/to/logfile</code></em></code></strong> <strong class="userinput"><code>/ --filename=</code></strong><strong class="userinput"><code><em class="replaceable"><code>/path/to/logfile</code></em></code></strong></span></dt>

        <dd>
          <p>This is the path to where the Nagios log file <strong class="userinput"><code>nagios.log</code></strong> is saved. The file is located in the Nagios <strong class="userinput"><code>var</code></strong> directory.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-e</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --expires=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

        <dd>
          <p>This is the maximum age of the log file. If there have been no changes to the file for longer than <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> minutes, <strong class="userinput"><code>check_nagios</code></strong> issues a warning.</p>

          <p>You should make sure that this time specification is large enough: if no errors are currently occurring, Nagios will not log anything in the log file. The only reliable way to obtain a regular entry is with the parameter <strong class="userinput"><code>retention_update_interval</code></strong> in the configuration file <strong class="userinput"><code>nagios.cfg</code></strong> (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). The default value is 60 minutes.<a class="indexterm" id="IDX-CHP-7-0694"/></p>
        </dd>
      </dl>
    </div>

    <p>In the following example the log file should not be older than 60 minutes (this corresponds to the default <span class="emphasis"><em>retention update interval</em></span>; see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>):</p><a id="I_programlisting4_d1e16954"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_nagios -e 60 \</strong></span>
<span class="strong"><strong>   -F /var/nagios/nagios.log -C /usr/local/nagios/bin/nagios</strong></span>
NAGIOS OK: 1 process, status log updated 184 seconds ago</pre>

    <p>With one running Nagios process and a log file last changed 183 seconds (about three minutes) ago, everything is in order here. If the <strong class="userinput"><code>-e</code></strong> parameter is omitted, the plugin always gives a warning.</p>

    <div class="sect2" title="7.11.1 Running the plugin manually with a script">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="running_the_plugin_manually_with_a_scrip"/>7.11.1 Running the plugin manually with a script</h2>
      </div>

      <p>The following example script demonstrates how the plugin is called outside the Nagios environment. It starts <strong class="userinput"><code>check_nagios</code></strong> initially as Nagios does and then evaluates the return value. If the status is not <strong class="userinput"><code>0</code></strong>, it sends an e-mail to the administrator <span class="email"><a class="email" href="mailto:nagios-admin@example.com">nagios-admin@example.com</a></span>, using the external <strong class="userinput"><code>mailx</code></strong> program:<a class="indexterm" id="IDX-CHP-7-0695"/></p><a id="I_programlisting4_d1e16989"/>
      <pre class="programlisting">#!/bin/bash
NAGCHK="/usr/local/nagios/libexec/check_nagios"
PARAMS="-e 60 -F /var/nagios/nagios.log -C /usr/local/nagios/bin/nagios"

INFO='$NAGCHK $PARAMS'
STATUS=$?

case $STATUS in
   0) echo "OK : " $INFO
      ;;
   *) echo "ERROR : " $INFO | \
        /usr/bin/mailx -s "Nagios Error" nagios-admin@example.com
      ;;
esac</pre>

      <p>The script can be run at regular intervals via a cron job—such as every 15 minutes. But then it will also "irritate" the administrator every quarter of an hour with an e-mail. There is certainly room for improvement in this respect—but that would go beyond the scope of this book.</p>
    </div>
  </div>


  <div class="sect1" title="7.12 Hardware Checks with LM Sensors">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="hardware_checks_with_lm_sensors"/>7.12 Hardware Checks with LM Sensors</h1>
    </div>

    <p>Modern mainboards are equipped with sensors that allow you to check the "health" of the system. In the <strong class="userinput"><code>lm-sensors</code></strong><sup>[<a class="footnote" href="#ftn.CHP-7-FN-12" id="CHP-7-FN-12">82</a>]</sup> project it is also possible in Linux to query this data via I2C or SMBus (<span class="emphasis"><em>System Management Bus</em></span>, a I2C special case).<a class="indexterm" id="IDX-CHP-7-0698"/><a class="indexterm" id="IDX-CHP-7-0699"/><a class="indexterm" id="IDX-CHP-7-0696"/><a class="indexterm" id="IDX-CHP-7-0697"/></p>

    <p>To enable this, the kernel must have a suitable driver. Kernel 2.4.x normally requires additional modules, which are included in the software.<sup>[<a class="footnote" href="#ftn.CHP-7-FN-13" id="CHP-7-FN-13">83</a>]</sup> With a little luck, your distribution may include precompiled modules (e.g., SUSE). Kernel 2.6, however, already includes many drivers; here you just compile the entire branch below <strong class="userinput"><code>I2C Hardware Sensors Chip support</code></strong>.</p>

    <p>It would take too much space here to detail the installation of the necessary modules. We will therefore only go into detail for the <strong class="userinput"><code>check_sensors</code></strong> plugin, and assume that the corresponding kernel driver is already loaded as a module. Help is provided during operation with the <strong class="userinput"><code>sensors-detect</code></strong> program from the <strong class="userinput"><code>lm-sensors</code></strong> package, which does a number of tests and then tells you which modules need to be loaded. If all requirements are fulfilled, running the <strong class="userinput"><code>sensors</code></strong> program will produce an output similar to the following one, and shows that the onboard sensors are providing data:<a class="indexterm" id="IDX-CHP-7-0700"/></p><a id="I_programlisting4_d1e17047"/>
    <pre class="programlisting">user@linux:~$ <span class="strong"><strong>sensors</strong></span>
fscher-i2c-0-73
Adapter: SMBus I801 adapter at 2400
Temp1/CPU:       +41.00 C
Temp2/MB:        +45.00 C
Temp3/AUX:       failed
Fan1/PS:           1440 RPM
Fan2/CPU:             0 RPM
Fan3/AUX:             0 RPM
+12V:            +11.86 V
+5V:              +5.10 V
Battery:          +3.07 V</pre>

    <p>The output depends on the hardware, so it will be slightly different for each computer. Here you can see, for example, the CPU and motherboard temperatures (41 and 45 degrees Celsius), the rotation speed of the fans, and the voltages on the 12- and 5-volt circuits and on the battery. Depending on the board design and the manufacturer, some details may be missing; in this example, only the fan for the power supply <strong class="userinput"><code>FAN1/PS</code></strong><sup>[<a class="footnote" href="#ftn.CHP-7-FN-14" id="CHP-7-FN-14">84</a>]</sup> provides information; <strong class="userinput"><code>Fan3/AUX</code></strong> refers to an additional fan inside the computer box that, although it is running, is not recorded by the chipset.</p>

    <p>Apart from the standard options <strong class="userinput"><code>-h</code></strong> (help function), <strong class="userinput"><code>-v</code></strong> (<span class="emphasis"><em>verbose</em></span>), which displays the response of the sensors, and <strong class="userinput"><code>-V</code></strong>, which shows the plugin version, the plugin itself has no special options. Warning and critical limits must be set via the <strong class="userinput"><code>lm-sensors</code></strong> configuration. <strong class="userinput"><code>check_sensors</code></strong> only returns the status given by the onboard sensors:<a class="indexterm" id="IDX-CHP-7-0701"/></p><a id="I_programlisting4_d1e17095"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_sensors</strong></span>
sensor ok</pre>

    <p>If this is called with the <strong class="userinput"><code>-v</code></strong> option, you can see more clearly whether the test works:</p><a id="I_programlisting4_d1e17105"/>
    <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_sensors -v</strong></span>
fscher-i2c-0-73 Adapter: SMBus I801 adapter at 2400 Temp1/CPU: +40.00 C Temp2/MB:
 +45.00 C Temp3/AUX: failed Fan1/PS: 1440 RPM Fan2/CPU: 0 RPM
Fan3/AUX: 0 RPM +12V: +11.86 V +5V: +5.10 V Battery: +3.07 V
sensor ok</pre>

    <p>The output line is only wrapped for printing purposes; the plugin displays verbose information on a single line.</p>

    <p>Alternatively you can use SNMP to access the sensor data: the NET-SNMP package (see <a class="xref" href="../Text/ch11s02.html" title="11.2 NET-SNMP">11.2 NET-SNMP</a> from page 234) provides the data delivered by <strong class="userinput"><code>lm-sensors</code></strong>, and with the SNMP plugin <strong class="userinput"><code>check_snmp</code></strong>, warning limits can also be set from Nagios. This solution is described in <a class="xref" href="../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp" title="11.3.1 The generic SNMP plugin check_snmp">11.3.1 The generic SNMP plugin check_snmp</a> from page 246.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-12" id="ftn.CHP-7-FN-12">82</a>]</sup> <a class="ulink" href="http://www.lm-sensors.nu/">http://www.lm-sensors.nu/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-13" id="ftn.CHP-7-FN-13">83</a>]</sup> <a class="ulink" href="http://secure.netroedge.com/%CB%9Clm78/download.html">http://secure.netroedge.com/˜lm78/download.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-7-FN-14" id="ftn.CHP-7-FN-14">84</a>]</sup> PS stands for <span class="emphasis"><em>power supply</em></span>; but the names displayed can be edited in <strong class="userinput"><code>/etc/sensors.conf</code></strong>.</p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;8.&#xA0;Plugins for Special Tasks">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="plugins_for_special_tasks"/>Chapter 8. Plugins for Special Tasks</h1>
    </div>

    <p>A number of plugins do not really fit into the category of local checks versus remote checks because they themselves do not detect operating states but manipulate the results of other checks or summarize them into new results. These include the plugin <strong class="userinput"><code>check_dummy</code></strong>, which always returns a fixed result in order to create a well-defined environment for test scenarios.</p>

    <p><strong class="userinput"><code>negate</code></strong> (which negates the return value) and <strong class="userinput"><code>urlize</code></strong> (which adds a hyperlink to the text output) manipulate the outputs. Summarizing and processing check results is the task of <strong class="userinput"><code>check_cluster</code></strong> and <strong class="userinput"><code>check_multi</code></strong>. Whereas <strong class="userinput"><code>check_cluster</code></strong> only combines and evaluates existing states, <strong class="userinput"><code>check_multi</code></strong> calls the specified plugins itself and combines their results.</p>

    <div class="sect1" title="8.1 The Dummy Plugin for Tests">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="the_dummy_plugin_for_tests"/>8.1 The Dummy Plugin for Tests</h1>
      </div>

      <p>For tests expected to end with a defined response, the <strong class="userinput"><code>check_dummy</code></strong> plugin can be used. it is given a return value and the desired response text as parameters, and it provides exactly these two responses as a result:<a class="indexterm" id="IDX-CHP-8-0702"/><a class="indexterm" id="IDX-CHP-8-0703"/><a class="indexterm" id="IDX-CHP-8-0704"/><a class="indexterm" id="IDX-CHP-8-0705"/><a class="indexterm" id="IDX-CHP-8-0706"/><a class="indexterm" id="IDX-CHP-8-0707"/><a class="indexterm" id="IDX-CHP-8-0708"/><a class="indexterm" id="IDX-CHP-8-0709"/><a class="indexterm" id="IDX-CHP-8-0710"/><a class="indexterm" id="IDX-CHP-8-0711"/><a class="indexterm" id="IDX-CHP-8-0712"/></p><a id="I_programlisting5_d1e17214"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ ./<span class="strong"><strong>check_dummy 1 "Debugging"</strong></span>
WARNING: Debugging
nagios@linux:nagios/libexec$ <span class="strong"><strong>echo $?</strong></span>
1</pre>

      <p>The output line contains the defined response, preceded by the status in text form. the return value can again be checked with <strong class="userinput"><code>echo $?: 1</code></strong> stands for WARNING.</p>

      <p>Alternatively you can give <strong class="userinput"><code>check_dummy</code></strong> a <strong class="userinput"><code>0</code></strong> (OK), an <strong class="userinput"><code>2</code></strong> (CRITICAL) or a <strong class="userinput"><code>3</code></strong> (UNKNOWN) as the first argument. The second argument, the response text, is optional.</p>
    </div>
  </div>


  <div class="sect1" title="8.2 Negating Plugin Results">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="negating_plugin_results"/>8.2 Negating Plugin Results</h1>
    </div>

    <p>In some situations you may want to test the opposite of what the standard plugin normally tests, such as an interface that should <span class="emphasis"><em>not</em></span> be active, a Web page or a host that should normally <span class="emphasis"><em>not</em></span> be reached. In these cases the program <strong class="userinput"><code>negate</code></strong>, included in the Nagios plugins, provides a way of negating the return value of the original check.<a class="indexterm" id="IDX-CHP-8-0713"/></p>

    <p>Like plugins, <strong class="userinput"><code>negate</code></strong> has an option to specify a timeout in seconds, with <strong class="userinput"><code>-t</code></strong>, after which it should abort the operation. The actual command line must always contain the complete path to the plugin:</p><a id="I_programlisting5_d1e17266"/>
    <pre class="programlisting">negate <span class="emphasis"><em>plugin command</em></span>
negate -t <span class="emphasis"><em>timeout plugin command</em></span></pre>

    <p><strong class="userinput"><code>negate</code></strong> changes the return value of <strong class="userinput"><code>2</code></strong> (CRITICAL) to <strong class="userinput"><code>0</code></strong> (OK) and vice versa. The return codes <strong class="userinput"><code>1</code></strong> (WARNING) and <strong class="userinput"><code>3</code></strong> (UNKNOWN) remain unchanged.</p>

    <p>The following example carries out <strong class="userinput"><code>check_icmp</code></strong> on the host <strong class="userinput"><code>192.0.2.1</code></strong>, which in normal cases should not be reachable:</p><a id="I_programlisting5_d1e17297"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ ./<span class="strong"><strong>negate</strong></span> \
<span class="strong"><strong>    /usr/local/nagios/libexec/check_icmp -H 192.0.2.1</strong></span>
CRITICAL - 192.0.2.1: rta nan, lost 100%| rta=0.000ms;200.000;500.000;0;
pl=100%;40;80;;
nagios@linux:nagios/libexec$ <span class="strong"><strong>echo $?</strong></span>
0</pre>

    <p>The plugin itself returns a CRITICAL in this case with a corresponding text. <strong class="userinput"><code>negate</code></strong> "inverts" the return value; <strong class="userinput"><code>2</code></strong> (CRITICAL) turns into <strong class="userinput"><code>0</code></strong> (OK). Since the text originates from the plugin and is not changed, the information <strong class="userinput"><code>CRITICAL</code></strong> remains here. For Nagios itself, however, nothing but the return value is of any interest.</p>
  </div>


  <div class="sect1" title="8.3 Inserting Hyperlinks with urlize">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="inserting_hyperlinks_with_urlize"/>8.3 Inserting Hyperlinks with <strong class="userinput"><code>urlize</code></strong></h1>
    </div>

    <p>The program <strong class="userinput"><code>urlize</code></strong> represents the text output of a plugin as a hyperlink, if required, so that clicking in the Nagios Web interface on the test result takes you to another Web page. Like <strong class="userinput"><code>negate</code></strong>, <strong class="userinput"><code>urlize</code></strong> functions as a wrapper around the normal plugin command and is included with the other Nagios plugins.<a class="indexterm" id="IDX-CHP-8-0715"/><a class="indexterm" id="IDX-CHP-8-0716"/><a class="indexterm" id="IDX-CHP-8-0717"/><a class="indexterm" id="IDX-CHP-8-0718"/><a class="indexterm" id="IDX-CHP-8-0714"/></p>

    <p>As the first argument it expects a valid URL to which the hyperlink should point. This is followed by the plugin command, including its path:</p><a id="I_programlisting5_d1e17360"/>
    <pre class="programlisting">urlize <span class="emphasis"><em>url plugin command</em></span></pre>

    <p>To avoid problems with spaces in plugin arguments, you can set the complete</p>

    <p><strong class="userinput"><code><em class="replaceable"><code>plugin command</code></em></code></strong> in double quotation marks.</p>

    <p>The hyperlink around the normal plugin output can be easily recognized when running the command manually:</p><a id="I_programlisting5_d1e17373"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ ./<span class="strong"><strong>urlize http://www.swobspace.de \ /usr/local/nagios/
libexec/check_http -H www.swobspace.de</strong></span>
&lt;A href="http://www.swobspace.de"&gt;HTTP OK HTTP/1.1 200 OK - 2802 bytes
in 0.132 seconds |time=0.132491s;;;0.000000 size=2802B;;;0&lt;/A&gt;</pre>

    <p>In version 1.4 <strong class="userinput"><code>urlize</code></strong> also embeds the performance output in the link text, but Nagios cut this off before the representation in the Web interface, together with the end tag. But most browsers do not have any problem with the missing <strong class="userinput"><code>&lt;/A&gt;</code></strong>.</p>
  </div>


  <div class="sect1" title="8.4 Checking Host or Service Clusters as an Entity">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="checking_host_or_service_clusters_as_an"/>8.4 Checking Host or Service Clusters as an Entity</h1>
    </div>

    <p>Plugins normally check an individual host or service, compare the result with the specified thresholds, and then return an appropriate result. On systems with redundant designs (such as in clusters) you can also check the respective host or service individually. In addition, a check of the virtual host or service provides a clue as to whether or not the virtual system as a whole is reachable. The plugin <strong class="userinput"><code>check_cluster</code></strong> allows more complex values to be queried.<a class="indexterm" id="IDX-CHP-8-0719"/><a class="indexterm" id="IDX-CHP-8-0720"/></p>

    <p>As an example, we will take a host cluster consisting of five identical single systems. One of these hosts may fail without any problem, but if a second one fails, the plugin should issue a WARNING. If a third host should fail, a CRITICAL should certainly be signalled.</p>

    <p>The special feature of <strong class="userinput"><code>check_cluster</code></strong> is that it does not actively perform a check itself but determines the return value from already-existing status values from the desired hosts or services. To do this it uses on-demand macros (see <a class="xref" href="../Text/apds02.html" title="D.2 On-Demand Macros">D.2 On-Demand Macros</a> from page 632). Whereas the standard macros always refer to the current host or service, which obviously makes little sense for <strong class="userinput"><code>check_cluster</code></strong>, on-demand macros allow access to all existing information on other hosts or services.<a class="indexterm" id="IDX-CHP-8-0721"/><a class="indexterm" id="IDX-CHP-8-0722"/></p>

    <p>For <strong class="userinput"><code>check_cluster</code></strong> we require the status of various hosts or services. These can be determined through the on-demand macros <strong class="userinput"><code>$HOSTSTATEID:</code></strong><strong class="userinput"><code><em class="replaceable"><code>host</code></em>$</code></strong> and <strong class="userinput"><code>$SERVICESTATEID:</code></strong> <strong class="userinput"><code><em class="replaceable"><code>host</code></em>:</code></strong> <strong class="userinput"><code><em class="replaceable"><code>service_description</code></em>$</code></strong>. They both provide the respective status in numerical form: <strong class="userinput"><code>0</code></strong> for OK; for hosts, <strong class="userinput"><code>1</code></strong> for DOWN and <strong class="userinput"><code>2</code></strong> for UNREACHABLE; for services, <strong class="userinput"><code>1</code></strong> for WARNING, <strong class="userinput"><code>2</code></strong> for CRITICAL, and <strong class="userinput"><code>3</code></strong> for UNKNOWN).<sup>[<a class="footnote" href="#ftn.CHP-8-FN-1" id="CHP-8-FN-1">85</a>]</sup> In each case the host name must be specified, and for <strong class="userinput"><code>$SERVICESTATEID$</code></strong> the service description of the host or service from which Nagios is to obtain the values must also be given.</p>

    <p>The plugin has the following options:</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-s / --service</code></strong></span></dt>

        <dd>
          <p>Handles the status values as the results of service checks, that is, <strong class="userinput"><code>0</code></strong> as OK, <strong class="userinput"><code>1</code></strong> as WARNING and <strong class="userinput"><code>2</code></strong> as CRITICAL<a class="indexterm" id="IDX-CHP-8-0723"/></p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-h / --host</code></strong></span></dt>

        <dd>
          <p>Handles the status values as the results of host checks, that is, <strong class="userinput"><code>0</code></strong> as UP, <strong class="userinput"><code>1</code></strong> as DOWN, and <strong class="userinput"><code>2</code></strong> as UNREACHABLE<a class="indexterm" id="IDX-CHP-8-0724"/></p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-l</code></strong> <strong class="userinput"><code><em class="replaceable"><code>label</code></em></code></strong> <strong class="userinput"><code>/ --label=</code></strong><strong class="userinput"><code><em class="replaceable"><code>label</code></em></code></strong></span></dt>

        <dd>
          <p>Inserts the text specified with <strong class="userinput"><code><em class="replaceable"><code>label</code></em></code></strong> into the text output</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-d</code></strong> <strong class="userinput"><code><em class="replaceable"><code>statusliste</code></em></code></strong> <strong class="userinput"><code>/ --data=</code></strong><strong class="userinput"><code><em class="replaceable"><code>statusliste</code></em></code></strong></span></dt>

        <dd>
          <p>Comma-separated list of the states from which the total result should be determined; here the already mentioned macros are used:</p><a id="I_programlisting5_d1e17557"/>
          <pre class="programlisting">--data=$HOSTSTATEID:srv1$,$HOSTSTATEID:srv2$,$HOSTSTATEID:srv3$</pre>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>schwellwert</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>schwellwert</code></em></code></strong></span></dt>

        <dd>
          <p>Warning threshold in the threshold format,<sup>[<a class="footnote" href="#ftn.CHP-8-FN-2" id="CHP-8-FN-2">86</a>]</sup> with respect to the number of error states. So by specifying <strong class="userinput"><code>-w 0:2</code></strong>, a maximum of two error states are allowed for an OK result. From the third error state, a WARNING is issued.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>threshold</code></em></code></strong></span></dt>

        <dd>
          <p>Like <strong class="userinput"><code>--warning</code></strong>, but refers to the critical threshold</p>
        </dd>
      </dl>
    </div>

    <p>The following call simulates the failure of two out of a total of five existing Web servers. A third server displays a WARNING. This means that we have a total of three error states:</p><a id="I_programlisting5_d1e17607"/>
    <pre class="programlisting">nagios@linux:local/libexec$ ./<span class="strong"><strong>check cluster -s -d 0,2,1,0,2 -w 0:2 -c 0:3</strong></span>
CLUSTER WARNING: Service cluster: 2 ok, 1 warning, 0 unknown, 2 critical</pre>

    <p>The check issues a WARNING because the warning threshold is exceeded (even though the critical threshold is not). The definition of the <strong class="userinput"><code>check_cluster</code></strong> command is kept simple:</p><a id="I_programlisting5_d1e17617"/>
    <pre class="programlisting">define command{
   command_name    check_cluster
   command_line    $USER1$/check_cluster -l $ARG1$ $ARG2$
}</pre>

    <p>The command expects a label as the first argument, and the plugin prefixes it to the text output. Everything else is defined in the second argument in the host or service definition:</p><a id="I_programlisting5_d1e17622"/>
    <pre class="programlisting">define service{
   host_name mycluster
   service_description Web Cluster
   command check_cluster!Web Cluster!--service -d $SERVICESTATEID:srv1:
HTTP$, $SERVICESTATEID:srv2:HTTP$ -w 0:0 -c 0:1
}</pre>

    <p>The service <strong class="userinput"><code>Web Cluster</code></strong> checks the service states of the two services <strong class="userinput"><code>srv1:HTTP</code></strong> and <strong class="userinput"><code>srv2:HTTP</code></strong>. As long as they are both working without errors, the command returns OK. If there is an error state, the result will be a WARNING, and if both services have errors, CRITICAL is returned.</p>

    <p>This completes the possibilities of <strong class="userinput"><code>check_cluster</code></strong>. If you are not satisfied with simply evaluating the number of existing error states, you should take a closer look at the plugin <strong class="userinput"><code>check_multi</code></strong>, which also allows AND and OR operations.<a class="indexterm" id="IDX-CHP-8-0725"/></p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-8-FN-1" id="ftn.CHP-8-FN-1">85</a>]</sup> See <a class="xref" href="../Text/apd.html" title="Appendix D. Macros">Appendix D</a> from page 625.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-8-FN-2" id="ftn.CHP-8-FN-2">86</a>]</sup> For the specification of thresholds, see <a class="xref" href="../Text/ch24.html#specifying_thresholds" title="24.1.5 Specifying thresholds">24.1.5 Specifying thresholds</a> in page 557.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="8.5 Summarizing Checks with check_multi">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="summarizing_checks_with_check_multi"/>8.5 Summarizing Checks with <strong class="userinput"><code>check_multi</code></strong></h1>
    </div>

    <p>There are various reasons for grouping different checks into a single one. On one hand it simplifies work for Nagios, because the system now only needs to manage 1,000 procedures instead of maybe 20,000—this increases performance significantly in many cases. If you summarize checks remotely, Nagios now performs 1 instead of 20 network queries, which results in better network performance. The Nagios administrator may also have an easier time, as the configuration is more concise.<a class="indexterm" id="IDX-CHP-8-0726"/></p>

    <p>The method originally planned for load distribution and reducing checks was via distributed Nagios instances. There are certainly productive installations in which a Nagios instance performs only 50 checks and transmits these to a central Nagios installation. If there are some several hundred Nagios instances, this method does ease the load on the central Nagios installation but not on the administrator, who has a considerable amount of work managing such configurations.<a class="indexterm" id="IDX-CHP-8-0727"/></p>

    <p>The plugin <strong class="userinput"><code>check_multi</code></strong>, by Matthias Flacke, takes a different approach. It performs (almost) any number of checks decentrally and returns just a sum total of the results to the Nagios server (<a class="xref" href="../Text/ch08s05.html#summarizing_checks_with_check" title="Figure 8-1. Summarizing checks with check_multi">Figure 8-1</a>). The plugin is executed remotely; it is called either via NRPE (<a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a> from page 213) or via the plugin <strong class="userinput"><code>check_by_ssh</code></strong> (<a class="xref" href="../Text/ch09.html#the_check_underscore_by_underscore_ssh" title="9.1 The check_by_ssh Plugin">9.1 The check_by_ssh Plugin</a> from page 206).</p>

    <div class="figure">
      <a id="summarizing_checks_with_check"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject5_d1e17682"/><img alt="Summarizing checks with check_multi" src="../Images/tagoreillycom20081104nostarchimages223808.png.jpg"/></div>

      <p class="title">Figure 8-1. Summarizing checks with <code class="userinput">check_multi</code></p>
    </div>

    <p>Information is lost during this process—ultimately, there can be only one return value for each <strong class="userinput"><code>check_multi</code></strong> call. But you gain clarity with the configuration of services, and you acquire—unexpectedly—a nice feature: The checks that must be performed are listed in an NRPE-like configuration file on the corresponding target system on which <strong class="userinput"><code>check_multi</code></strong> is also installed. This makes it possible to delegate certain tasks, such as the maintenance of threshold values, to other (non-Nagios) administrators. They require write access to the relevant <strong class="userinput"><code>check_multi</code></strong> configuration file but do not need to continue grappling—apart from correctly running the plugins used—with a Nagios configuration.</p>

    <p>To be able to pass on as much information as possible, <strong class="userinput"><code>check_multi</code></strong> makes regular use of the multiple-line plugin output format that was introduced with Nagios 3.0 (see <a class="xref" href="../Text/ch08s05.html#multiple-line_plugin_output" title="8.5.1 Multiple-line plugin output">8.5.1 Multiple-line plugin output</a>). This restricts the use of <strong class="userinput"><code>check_multi</code></strong> essentially to Nagios 3.0. Starting from <strong class="userinput"><code>check_multi</code></strong> in version 0.14, there have been approaches to support Nagios 2.x. These are only of limited use, however, since the entire amount of information for plugins in Nagios 2.x is about 300 bytes, and only the first line of the plugin output is utilized.</p>

    <div class="sect2" title="8.5.1 Multiple-line plugin output">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="multiple-line_plugin_output"/>8.5.1 Multiple-line plugin output</h2>
      </div>

      <p>Starting with Nagios 3.0, an expanded output format for plugins has been introduced. Instead of squeezing everything onto a single line, the output may be spread over several lines:<a class="indexterm" id="IDX-CHP-8-0728"/></p><a id="I_programlisting5_d1e17721"/>
      <pre class="programlisting"><span class="emphasis"><em>normal text output</em></span> | <span class="emphasis"><em>optional performance data</em></span>
<span class="emphasis"><em>longtext, 1st line</em></span>
<span class="emphasis"><em>longtext, 2nd line</em></span>
...
<span class="emphasis"><em>longtext, n-th line | performance data, 2nd line</em></span>
<span class="emphasis"><em>performance data, 3rd line</em></span>
...
<span class="emphasis"><em>performance data, n-th line</em></span></pre>

      <p>The first line contains the standard text output, supplemented with performance data if required. This line can still be processed by Nagios 2.x, so it shouldn't be longer than 300 bytes. In the following lines a plugin may supply other text information until the character <strong class="userinput"><code>|</code></strong> closes the text output and allows other performance data to be written. Nagios 3.0 displays the entire text information in the status information generated by <strong class="userinput"><code>extinfo.cgi</code></strong> on the Web interface (see <a class="xref" href="../Text/ch16s02.html#additional_information_and_control_cent" title="16.2.2 Additional information and control center: extinfo.cgi">16.2.2 Additional information and control center: extinfo.cgi</a> from page 339).<a class="indexterm" id="IDX-CHP-8-0729"/></p>

      <p>When accessing text information via macros (See <a class="xref" href="../Text/apd.html#standard_macros" title="D.1 Standard Macros">D.1 Standard Macros</a> from page 627), Nagios splits up the information into two macros: <strong class="userinput"><code>$HOSTOUTPUT$</code></strong> contains the first line of the text information of host checks (that is, the contents of the placeholder <strong class="userinput"><code><em class="replaceable"><code>normal text output</code></em></code></strong>), and <strong class="userinput"><code>$LONGHOSTOUTPUT$</code></strong> contains only the long text. For service checks the macros are called <strong class="userinput"><code>$SERVICEOUTPUT$</code></strong> and <strong class="userinput"><code>$LONGSERVICEOUTPUT$</code></strong>. The <strong class="userinput"><code>LONG*</code></strong> variation of the macro is available only in Nagios 3.0 and later; Nagios 2.x only knows the short version.<a class="indexterm" id="IDX-CHP-8-0730"/><a class="indexterm" id="IDX-CHP-8-0731"/><a class="indexterm" id="IDX-CHP-8-0732"/><a class="indexterm" id="IDX-CHP-8-0733"/></p>

      <p>The performance data from the first line and from the end is summarized by Nagios 3.0 in the macros <strong class="userinput"><code>$HOSTPERFDATA$</code></strong> and <strong class="userinput"><code>$SERVICEPERFDATA$</code></strong>. There is no <strong class="userinput"><code>LONG*</code></strong> variation, as is the case for the output.<a class="indexterm" id="IDX-CHP-8-0734"/><a class="indexterm" id="IDX-CHP-8-0735"/></p>

      <p>The entire output, including performance data, is a maximum of 8 KB long in Nagios 3.0. If Nagios runs a plugin directly, as opposed to indirectly, (for instance, via NRPE or <strong class="userinput"><code>check_by_ssh</code></strong>), you must ensure that the entire 8 KB really are passed across the entire transmission path. This is covered in <a class="xref" href="../Text/ch08s05.html#installation_requirements" title="8.5.2 Installation requirements">8.5.2 Installation requirements</a>.</p>
    </div>

    <div class="sect2" title="8.5.2 Installation requirements">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="installation_requirements"/>8.5.2 Installation requirements</h2>
      </div>

      <p><strong class="userinput"><code>check_multi</code></strong> does not put any restrictions on the size of its output. In order to support enough checks, you should ensure that all the resources used allow at least 8 KB of plugin output. For Nagios version 3.0, the developers have increased the buffer size to to 8 KB, so no adjustments are necessary. For scenarios involving remote use with NRPE or <strong class="userinput"><code>check_by_ssh</code></strong>, you may need to make manual adjustments.<a class="indexterm" id="IDX-CHP-8-0736"/><a class="indexterm" id="IDX-CHP-8-0737"/><a class="indexterm" id="IDX-CHP-8-0738"/><a class="indexterm" id="IDX-CHP-8-0739"/><a class="indexterm" id="IDX-CHP-8-0740"/><a class="indexterm" id="IDX-CHP-8-0741"/><a class="indexterm" id="IDX-CHP-8-0742"/></p>

      <div class="sect3" title="Adjusting buffer sizes for NRPE">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="adjusting_buffer_sizes_for_nrpe"/>Adjusting buffer sizes for NRPE</h3>
        </div>

        <p>By default, NRPE (<a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a>, page 213) transmits no more than 1,024 characters. To make proper use of <strong class="userinput"><code>check_multi</code></strong>, you need to adjust the buffer size in the source code. To do this, you set the appropriate values in the file <strong class="userinput"><code>include/common.h</code></strong> to <strong class="userinput"><code>8192</code></strong>:</p><a id="I_programlisting5_d1e17875"/>
        <pre class="programlisting">#define MAX_INPUT_BUFFER           8192
#define MAX_PACKETBUFFER_LENGTH                    8192</pre>

        <p>Afterward, you must re-compile and re-install the NRPE daemon and the <strong class="userinput"><code>check_nrpe</code></strong> plugin.</p>
      </div>

      <div class="sect3" title="Adjusting buffer sizes for check_by_ssh">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="adjusting_buffer_sizes_for_check_undersc"/>Adjusting buffer sizes for <strong class="userinput"><code>check_by_ssh</code></strong></h3>
        </div>

        <p>The plugin <strong class="userinput"><code>check_by_ssh</code></strong> (<a class="xref" href="../Text/ch09.html#the_check_underscore_by_underscore_ssh" title="9.1 The check_by_ssh Plugin">9.1 The check_by_ssh Plugin</a> from page 206) can handle multiple-line output from plugins in versions 1.4.10 and later, so it can be used unchanged. A patch is required for older versions, which can be found on the <strong class="userinput"><code>check_multi</code></strong> homepage.<sup>[<a class="footnote" href="#ftn.CHP-8-FN-3" id="CHP-8-FN-3">87</a>]</sup></p>
      </div>
    </div>

    <div class="sect2" title="8.5.3 Installation and testing">
      <div class="titlepage">
        <h2 class="title" id="heading_id_7"><a id="installation_and_testing"/>8.5.3 Installation and testing</h2>
      </div>

      <p>After downloading the plugin from the very extensive and well-documented homepage,<sup>[<a class="footnote" href="#ftn.CHP-8-FN-4" id="CHP-8-FN-4">88</a>]</sup> you should unpack it in a directory anywhere, and then change to that directory to carry out an initial test. In the subdirectory <strong class="userinput"><code>contrib</code></strong> of the source code there is a preconfigured file, <strong class="userinput"><code>check_multi.cmd</code></strong>, containing several example checks. When running the plugin, specify this file with the option <strong class="userinput"><code>-f</code></strong>; <strong class="userinput"><code>check_multi</code></strong> will perform all the checks defined there in one go. This output gives you a feeling of how the plugin functions:</p><a id="I_programlisting5_d1e17921"/>
      <pre class="programlisting">user@linux:~$ ./<span class="strong"><strong>check_multi -f contrib/check_multi.cmd</strong></span>
MULTI CRITICAL - 35 plugins checked, 7 critical (network_rsync, proc_acp id,
 proc_httpd, system_syslog, system_users, nagios_system, dummy_critical), 2 warning
 (nagios_tac, dummy_warning), 2 unknown (network_if_ethl, dummy_unknown), 24 ok
[1] network_ping PING OK - Packet loss = 0%, RTA = 0.06 ms
[2] network_interfaces OK: host 'localhost', interfaces up: 6, down: 0, dormant: 0,
 excluded: 0, unused: 0
[3] network_if_eth1 Either a valid snmpkey key (-k) or a ifDescr (-d) must be
 provided)
...
[16] system_load OK - load average: 0.89, 0.71, 0.71
[17] system_mail TCP OK - 0.000 second response time on port 25
[18] system_mailqueue OK: mailq is empty
[19] system_mysql Uptime: 5573 Threads: 1 Questions: 140 Slow queries
: 0 Opens: 137 Flush tables: 1 Open tables: 19 Queries per second avg
: 0.025
[20] system_ntp NTP OK: Offset −0.07118669868 secs
[21] system_portmapper OK: RPC program portmapper version 2 udp running
[22] system_rootdisk DISK OK - free space: / 287 MB (31% inode=81%);
[23] system_ssh SSH OK - OpenSSH_4.3p2 Debian-9 (protocol 2.0)
...
|MULTI::check_multi::plugins=35 time=10.92 network_interfaces::check_ifs tatus::
up=6,down=0,dormant=0,excluded=0,unused=0 system_load::check_load ::
load1=0.890;5.000;10.000;0; load5=0.710;4.000;8.000;0; load15=0.710;3. 000;6.000;0;
 system_mail::
check_tcp::time=0.000225s;;;0.000000;10.000000 system_mailqueue::check_mailq::
unsent=0;2;4;0
 system_ntp::check_ntp::off set=−0.071187s;60.000000;120.000000; system_rootdisk::
check_disk::
/=620M B;909;937;0;957 system_swap::check_swap::swap=3906MB;0;0;0;3906 system_u sers::
check_users::users=25;5;10;0 nagios.org_dns::check_dns::time=0.039 187s;;;
0.000000 nagios.org_http::check_http::time=0.674044s;;;0.000000 s ize=21530B;;;0</pre>

      <p>The first line of the output—starting with <strong class="userinput"><code>MULTI CRITICAL</code></strong>—summarizes all the executed checks. These lines (line-wrapped here for display purposes) are also processed by Nagios 2.x. The output from the individual checks begins on line 2 (starting with <strong class="userinput"><code>[ 1]</code></strong>), which looks exactly like the output of a single call of the plugin currently being run. The performance data is summarized by <strong class="userinput"><code>check_multi</code></strong>, but only at the the end, in a totals line—starting with <strong class="userinput"><code>| MULTI::check_multi::plugins</code></strong>. The individual variables are separated by spaces. The purpose for the variable names, along with their format (which takes some getting used to), is explained in <a class="xref" href="../Text/ch08s05.html#performance_data_and_pnp" title="8.5.6 Performance data and PNP">8.5.6 Performance data and PNP</a> from page 198.</p>
    </div>

    <div class="sect2" title="8.5.4 Configuration file">
      <div class="titlepage">
        <h2 class="title" id="heading_id_8"><a id="configuration_file"/>8.5.4 Configuration file</h2>
      </div>

      <p>The format of the configuration file is based on that of NRPE (<a class="xref" href="../Text/ch10s03.html" title="10.3 NRPE Configuration on the Computer to Be Monitored">10.3 NRPE Configuration on the Computer to Be Monitored</a> from page 218). For <strong class="userinput"><code>check_multi</code></strong>, however, only the commands are defined. Here is an extract from the example file included, <strong class="userinput"><code>check_multi.cmd</code></strong>:</p><a id="I_programlisting5_d1e17955"/>
      <pre class="programlisting">...
command[ network_interfaces ] = check_ifstatus -H localhost
command[ system_load ] = check_load -w 5,4,3 -c 10,8,6
command[ system_mail ] = check_tcp -H localhost -p 25
command[ system_mailqueue ] = check_mailq -w 2 -c 4
command[ system_mysql ] = check_mysql -u admin
command[ system_ntp ] = check_ntp -H ntp1.fau.de
command[ system_portmapper ] = check_rpc -H localhost -C portmapper
command[ system_rootdisk ] = check_disk -w 5% -c 2% -p /
command[ system_ssh ] = check_ssh localhost
...</pre>

      <p>The command <strong class="userinput"><code>command[</code></strong> <strong class="userinput"><code><em class="replaceable"><code>Name_of_check</code></em> ]</code></strong> specifies the name for the appropriate check. This is used in the text output and in the performance data.</p>

      <p>After the equal sign comes the check to be executed. When calling the plugin, path details can be omitted if the plugins are located in the default path, <strong class="userinput"><code>/usr/local/nagios/libexec</code></strong>. Alternatively, you can include the plugin path with the option <strong class="userinput"><code>−1</code></strong> when running <strong class="userinput"><code>check_multi</code></strong>. You can also specify the absolute path in the configuration file, of course.</p>
    </div>

    <div class="sect2" title="8.5.5 Command-line parameters">
      <div class="titlepage">
        <h2 class="title" id="heading_id_9"><a id="command-line_parameters"/>8.5.5 Command-line parameters</h2>
      </div>

      <p><strong class="userinput"><code>check_multi</code></strong> has the following options:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-f</code></strong> <strong class="userinput"><code><em class="replaceable"><code>/path/to/config/file</code></em></code></strong> <strong class="userinput"><code>/ --filename=</code></strong><strong class="userinput"><code><em class="replaceable"><code>/path/to/config/file</code></em></code></strong></span></dt>

          <dd>
            <p>This specifies the configuration file. So that Nagios can find it, you should always specify the complete path. This option does not have a default value; it can be given several times.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-l</code></strong> <strong class="userinput"><code><em class="replaceable"><code>/path/to/the/plugins</code></em></code></strong> <strong class="userinput"><code>/ --libexec=</code></strong><strong class="userinput"><code><em class="replaceable"><code>/path/to/the/plugins</code></em></code></strong></span></dt>

          <dd>
            <p>The default for calling plugins is the path <strong class="userinput"><code>/usr/local/nagios/libexec</code></strong>. If they are located in a different directory, this is specified here with the <strong class="userinput"><code>-l</code></strong> option.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-n</code></strong> <strong class="userinput"><code><em class="replaceable"><code>name</code></em></code></strong> <strong class="userinput"><code>/ --name=</code></strong><strong class="userinput"><code><em class="replaceable"><code>name</code></em></code></strong></span></dt>

          <dd>
            <p>This is the name of a check that <strong class="userinput"><code>check_multi</code></strong> outputs in the text output and in the performance data. The default is an empty string. If you run <strong class="userinput"><code>check_multi</code></strong> on a machine several times with different checks, it is better here to use different names so that they are more clearly separated from each other.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <strong class="userinput"><code><em class="replaceable"><code>sekunden</code></em></code></strong> <strong class="userinput"><code>/ --timeout=</code></strong><strong class="userinput"><code><em class="replaceable"><code>seconds</code></em></code></strong></span></dt>

          <dd>
            <p>This specifies the timeout for an individual check. The default is <strong class="userinput"><code>10</code></strong> seconds.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-T</code></strong> <strong class="userinput"><code><em class="replaceable"><code>seconds</code></em></code></strong> <strong class="userinput"><code>/ --TIMEOUT=</code></strong><strong class="userinput"><code><em class="replaceable"><code>seconds</code></em></code></strong></span></dt>

          <dd>
            <p>For all checks together, <strong class="userinput"><code>check_multi</code></strong> requires a further timeout parameter, which is defined with <strong class="userinput"><code>-T</code></strong> (the default is <strong class="userinput"><code>60</code></strong> seconds).</p>

            <p>This ensures that the call of <strong class="userinput"><code>check_multi</code></strong> will end within the time specified. The plugin does not start any new checks if the starting time and the timeout of a single plugin exceed the timeout of the entire <strong class="userinput"><code>check_multi</code></strong> call.<sup>[<a class="footnote" href="#ftn.CHP-8-FN-5" id="CHP-8-FN-5">89</a>]</sup> Such individual checks are given the status UNKNOWN; in the output, <strong class="userinput"><code>check_multi</code></strong> assigns them the message <strong class="userinput"><code>plugin cancelled due to global timeout</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-r</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --report=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

          <dd>
            <p>This option controls the output behavior of <strong class="userinput"><code>check_multi</code></strong>. The placeholder <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> can take on the following values:</p>

            <div class="itemizedlist">
              <ul class="itemizedlist">
                <li class="listitem">
                  <p><strong class="userinput"><code>1</code></strong> includes the service name for error states in parentheses in the plugin output:</p><a id="I_programlisting5_d1e18153"/>
                  <pre class="programlisting">..., 2 critical (network_rsync, proc_acpid), 1 warning (nagios_tac), 1 unknown
 (if_eth1), dummy_unknown), 24 ok</pre>
                </li>

                <li class="listitem">
                  <p><strong class="userinput"><code>2</code></strong> formats the output as HTML. Here the numbers of the individual checks (e.g., [ <strong class="userinput"><code>3</code></strong>]) are stored along with the color of the respective return value (green for OK, yellow for WARNING, red for CRITICAL, and orange for UNKNOWN).</p>

                  <p>If you use <strong class="userinput"><code>check_multi</code></strong> recursively (a <strong class="userinput"><code>check_multi</code></strong> itself calls other instances of <strong class="userinput"><code>check_multi</code></strong>), the output of the subordinate checks are indented (see <a class="xref" href="../Text/ch08s05.html#recursive_output_of_chech_underscore_mul" title="Figure 8-3. Recursive output of chech_multi on the Extended Infro page of the Nagios Web interface">Figure 8-3</a> in page 202).</p>
                </li>

                <li class="listitem">
                  <p><strong class="userinput"><code>4</code></strong> shows the output of the individual check—if they exist—on STD-ERR.</p>
                </li>

                <li class="listitem">
                  <p><strong class="userinput"><code>8</code></strong> outputs the performance data in the multi-format (see <a class="xref" href="../Text/ch08s05.html#performance_data_and_pnp" title="8.5.6 Performance data and PNP">8.5.6 Performance data and PNP</a> from page 198).</p>
                </li>

                <li class="listitem">
                  <p><strong class="userinput"><code>16</code></strong> has the same function as <strong class="userinput"><code>1</code></strong>, except that states for which there are no check results (e.g., <strong class="userinput"><code>0 unknown</code></strong>) are also included.</p>
                </li>

                <li class="listitem">
                  <p><strong class="userinput"><code>32</code></strong> outputs performance data in the classical format (see <a class="xref" href="../Text/ch08s05.html#performance_data_and_pnp" title="8.5.6 Performance data and PNP">8.5.6 Performance data and PNP</a>).</p>
                </li>

                <li class="listitem">
                  <p><strong class="userinput"><code>128</code></strong> extends the HTML format required by <strong class="userinput"><code>2</code></strong> by including a hyperlink to an installed PNP if performance data is available and the output is in multi-format (<strong class="userinput"><code>8</code></strong>). PNP is described in <a class="xref" href="../Text/ch19s06.html" title="19.6 Smooth Plotting with PNP">19.6 Smooth Plotting with PNP</a> from page 446.</p>
                </li>

                <li class="listitem">
                  <p><strong class="userinput"><code>256</code></strong> displays the output in XML formatting.</p>
                </li>

                <li class="listitem">
                  <p><strong class="userinput"><code>512</code></strong> ensures that the output is Nagios 2.x compatible in order to bring the output below the 300-byte limit.</p>
                </li>
              </ul>
            </div>

            <p>Indivudal values may be combined; the default is 13 (8 + 4 + 1).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>expression</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>expression</code></em></code></strong></span></dt>

          <dd>
            <p>This sets the status WARNING if <strong class="userinput"><code><em class="replaceable"><code>expression</code></em></code></strong> is true, e.g., <strong class="userinput"><code>COUNT (WARNING) &gt; 0</code></strong> (the default). For all states, <strong class="userinput"><code>check_multi</code></strong> separately checks whether or not the corresponding status was determined. Eventually, the status with the highest priority wins out: CRITICAL trumps WARNING, trumps UNKNOWN, trumps OK. The definition and use of expressions is explained in <a class="xref" href="../Text/ch08s05.html#simple_business_process_monitoring" title="8.5.7 Simple business process monitoring">8.5.7 Simple business process monitoring</a> from page 199.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ausdruck</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>expression</code></em></code></strong></span></dt>

          <dd>
            <p>If the expression is true, the status is set to CRITICAL. Eventually, the status with the highest priority wins out (see <strong class="userinput"><code>--warning</code></strong> and <a class="xref" href="../Text/ch08s05.html#simple_business_process_monitoring" title="8.5.7 Simple business process monitoring">8.5.7 Simple business process monitoring</a>).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code><em class="replaceable"><code>expression</code></em></code></strong> <strong class="userinput"><code>/ --unknown=</code></strong><strong class="userinput"><code><em class="replaceable"><code>expression</code></em></code></strong></span></dt>

          <dd>
            <p>If the expression is true, the status UNKNOWN is set. The status with the highest priority (see <strong class="userinput"><code>--warning</code></strong> and <a class="xref" href="../Text/ch08s05.html#simple_business_process_monitoring" title="8.5.7 Simple business process monitoring">8.5.7 Simple business process monitoring</a>) wins out.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-o</code></strong> <strong class="userinput"><code><em class="replaceable"><code>expression</code></em></code></strong> <strong class="userinput"><code>/ --ok=</code></strong><strong class="userinput"><code><em class="replaceable"><code>expression</code></em></code></strong></span></dt>

          <dd>
            <p>If <strong class="userinput"><code><em class="replaceable"><code>ausdruck</code></em></code></strong> is true, the status OK is set. Here the status with the highest priority also wins out (see <strong class="userinput"><code>--warning</code></strong> and <a class="xref" href="../Text/ch08s05.html#simple_business_process_monitoring" title="8.5.7 Simple business process monitoring">8.5.7 Simple business process monitoring</a>).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-v / --verbose</code></strong></span></dt>

          <dd>
            <p>This increases the verbosity of the plugin for debugging purposes. The option can be used up to three times; if specified three times, you will obtain the most detailed information.</p>
          </dd>
        </dl>
      </div>
    </div>

    <div class="sect2" title="8.5.6 Performance data and PNP">
      <div class="titlepage">
        <h2 class="title" id="heading_id_10"><a id="performance_data_and_pnp"/>8.5.6 Performance data and PNP</h2>
      </div>

      <p>In the simple output form for performance data (which can be set with the option <strong class="userinput"><code><em class="replaceable"><code>-r</code></em></code></strong> <strong class="userinput"><code>32</code></strong>), <strong class="userinput"><code>check_multi</code></strong> simply lists all variables provided by the plugins:<a class="indexterm" id="IDX-CHP-8-0743"/><a class="indexterm" id="IDX-CHP-8-0744"/></p><a id="I_programlisting5_d1e18362"/>
      <pre class="programlisting">...|rta=0.111ms;500.000;1000.000;0; pl=0%;5;10;; offset=0.002980s;60.000 000;
120.000000;</pre>

      <p>The performance data for the plugin <strong class="userinput"><code>check_icmp</code></strong> (the average response time <strong class="userinput"><code><em class="replaceable"><code>r</code></em></code></strong><strong class="userinput"><code>ta</code></strong> and the packet loss <strong class="userinput"><code>pl</code></strong>) in this example seamlessly follow the performance data of <strong class="userinput"><code>check_ntp</code></strong> in the form of deviation from the local system time (<strong class="userinput"><code>offset</code></strong>). You can't tell, at first glance, what information comes from which plugin—you have to consult the order in the configuration file and the outputs of the individual checks.</p>

      <p>This is not particularly suitable for automatic processing. <strong class="userinput"><code>check_multi</code></strong> therefore provides an extended output with the default option <strong class="userinput"><code><em class="replaceable"><code>-r</code></em></code></strong><strong class="userinput"><code>8</code></strong>, which is modified specifically to handle PNP (see <a class="xref" href="../Text/ch19s06.html" title="19.6 Smooth Plotting with PNP">19.6 Smooth Plotting with PNP</a> from page 446). When doing this, the plugin adds a service description and the name of the plugin used to the name of the variables. No deviation is made from the standardized format; the label is just given a more extensive form:</p><a id="I_programlisting5_d1e18397"/>
      <pre class="programlisting"><span class="emphasis"><em>servicedescription:: plugin:: label = values [label = calues]</em></span></pre>

      <p>PNP requires information on the plugin executed so that it can select a suitable template for processing the graphics (see <a class="xref" href="../Text/ch19s06.html#how_should_the_graphic_appear_question" title="19.6.5 How should the graphic appear?">19.6.5 How should the graphic appear?</a> from page 454). In addition, <strong class="userinput"><code>check_multi</code></strong> now also provides performance data referring to the overall processing:</p><a id="I_programlisting5_d1e18407"/>
      <pre class="programlisting">|MULTI::check_multi::plugins=5 time=0.18 net_ping::check_icmp::rta=0.048 ms;
500.000;1000.000;0; pl=0%;5;10;; system_ntp::check_ntp::offset=0.0022 66s;60.000000;
120.000000;</pre>

      <p>First <strong class="userinput"><code>check_multi</code></strong> announces that it has called <strong class="userinput"><code>5</code></strong> plugins and has used a total of 0.18 seconds for processing. This is followed by the performance data for the other plugins, each supplemented with the service description and plugin name. If a plugin issues more than one variable, the service description and plugin name are not repeated.</p>
    </div>

    <div class="sect2" title="8.5.7 Simple business process monitoring">
      <div class="titlepage">
        <h2 class="title" id="heading_id_11"><a id="simple_business_process_monitoring"/>8.5.7 Simple business process monitoring</h2>
      </div>

      <p>In order to evaluate business processes, you generally want to know whether a particular process is working—for instance, whether or not a customer can perform online banking. Individual pieces of information on all hosts and services involved are not relevant from this perspective and are also not always useful if systems are designed redundantly in different forms.<a class="indexterm" id="IDX-CHP-8-0745"/><a class="indexterm" id="IDX-CHP-8-0746"/><a class="indexterm" id="IDX-CHP-8-0747"/><a class="indexterm" id="IDX-CHP-8-0748"/><a class="indexterm" id="IDX-CHP-8-0749"/><a class="indexterm" id="IDX-CHP-8-0750"/><a class="indexterm" id="IDX-CHP-8-0751"/><a class="indexterm" id="IDX-CHP-8-0752"/></p>

      <div class="figure">
        <a id="for_the_terminal_server_arm_to_be_reacha"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject5_d1e18459"/><img alt="For the terminal server farm to be reachable from the Internet, an OpenVPN access and a terminal server must be available." src="../Images/tagoreillycom20081104nostarchimages223810.png.jpg"/></div>

        <p class="title">Figure 8-2. For the terminal server farm to be reachable from the Internet, an OpenVPN access and a terminal server must be available.</p>
      </div>

      <p>One example is shown in <a class="xref" href="../Text/ch08s05.html#for_the_terminal_server_arm_to_be_reacha" title="Figure 8-2. For the terminal server farm to be reachable from the Internet, an OpenVPN access and a terminal server must be available.">Figure 8-2</a>: Home office users access a terminal server farm via OpenVPN. For access from the Internet, two connections are available, and with <strong class="userinput"><code>gate1</code></strong> and <strong class="userinput"><code>gate2</code></strong>, two OpenVPN gateways are available. The terminal server farm consists of the eight terminal servers <strong class="userinput"><code>ts01</code></strong> through <strong class="userinput"><code>ts08</code></strong>.</p>

      <p>In order for home office users to be able to work, at least one Internet connection (including the accompanying gateway) must be available, and the server farm must be reachable. The business process can be split into two processes: Our example looks at the Internet access separated from the server farm, and afterward it can connect the two results with one another.</p>

      <p>The condition for a critical status for Internet access could be formulated as follows:</p><a id="I_programlisting5_d1e18484"/>
      <pre class="programlisting">(gate1 &gt; 1 || provider1 &gt; 1) &amp;&amp; (gate2 &gt; 1 || provider2 &gt; 1)</pre>

      <p>Access is unusable if the provider is unreachable or (<strong class="userinput"><code>||</code></strong>) the OpenVPN service is not available on the gateway. But it is sufficient if one of the two access points is functioning (thus the AND logical operator with &amp;&amp;). The syntax is taken from Perl and can equally be processed by <strong class="userinput"><code>check_multi</code></strong>. The configuration file for the Internet check therefore contains four commands and the logocal operators:</p><a id="I_programlisting5_d1e18494"/>
      <pre class="programlisting"># openvpn.cmd
command[ gate1 ] = check_nrpe -H gate1 -c check_openvpn
command[ provider1 ] = check_icmp -H provider1 -c 1000.0,60%
command[ gate2 ] = check_nrpe -H gate2 -c check_openvpn
command[ provider2 ] = check_icmp -H provider2 -c 1000.0,60%

state[warning] = count(CRITICAL) &gt; 0 || count(UNKNOWN) &gt; 0
state[critical] = (gate1 &gt; 1 || provider1 &gt; 1) &amp;&amp; (gate2 &gt; 1 || provider
2 &gt; 1)</pre>

      <p>The two <strong class="userinput"><code>gate*</code></strong> commands each check (via NRPE) whether the gateway of the OpenVPN service is running. The provider test sends ICMP echo packets to the dial-up router of the respective provider. You should take great care here to ensure that routing is correctly set up, that is, that the ICMP packets to the respective provider really are sent across the accompanying connection.</p>

      <p>For a business process, a Boolean expression for individual states is defined in the configuration file, so depending on requirements, there may be one for CRITICAL, one for WARNING, and, if necessary, one for UNKNOWN as well. The syntax and the operators are passed on to Perl as specified and are described in detail in the Perl online documentation (<strong class="userinput"><code>man</code></strong> <strong class="userinput"><code><em class="replaceable"><code>per</code></em></code></strong><strong class="userinput"><code>lop</code></strong>). Before evaluating the expression, <strong class="userinput"><code>check_multi</code></strong> undertakes the following substitutions:</p>

      <div class="itemizedlist">
        <ul class="itemizedlist">
          <li class="listitem">
            <p>If the expression contains the name of a check previously defined with <strong class="userinput"><code>command</code></strong>, the return value of this check will be used instead. Let's assume that check <strong class="userinput"><code>gatel</code></strong> returns <strong class="userinput"><code>2</code></strong> and check <strong class="userinput"><code>providerl</code></strong> returns <strong class="userinput"><code>1</code></strong>. Then the partial expression shown above will become</p><a id="I_programlisting5_d1e18535"/>
            <pre class="programlisting">state [critical] = (2 &gt; 1 || 1 &gt; 1) ...</pre>

            <p>Within the brackets, the first condition is true, and through the subsequent OR (<strong class="userinput"><code>||</code></strong> in Perl syntax) the partial expression evaluates to true.</p>
          </li>

          <li class="listitem">
            <p>The function <strong class="userinput"><code>count</code></strong> determines the number of all checks that provided the return value given as an argument.</p>
          </li>

          <li class="listitem">
            <p>Instead of the numerical value of a status, the text form (UNKNOWN, WARNING, CRITICAL, WARNING, OK) can also be included in the expression (so you can write something like <strong class="userinput"><code>gate1 &gt; WARNING</code></strong>). This detail is replaced by <strong class="userinput"><code>check_multi</code></strong> with the numerical value before the expression is evaluated.</p>
          </li>
        </ul>
      </div>

      <p>The WARNING status is set in <strong class="userinput"><code>openvpn.cmd</code></strong> if at least one critical status occurs, at least one check delivers UNKNOWN, or at least one check returns WARNING. The CRITICAL status appears if both accesses should fail (because of the AND logical operator between the two partial expressions in brackets). The partial expressions on their own are true if either of the <strong class="userinput"><code>gate</code></strong> or <strong class="userinput"><code>provider</code></strong> checks delivers a CRITICAL (return value <strong class="userinput"><code>2</code></strong>) or an UNKNOWN (return value <strong class="userinput"><code>3</code></strong>). The condition for the UNKNOWN status can be omitted since UNKNOWN results always lead to the WARNING status.</p>

      <p>The second partial process—the function of the terminal server farm—is described in the configuration file <strong class="userinput"><code>terminalserver.cmd</code></strong>:</p><a id="I_programlisting5_d1e18579"/>
      <pre class="programlisting"># terminalserver.cmd
command[ ts01 ] = check_tcp -H ts01 -p 3389
command[ ts02 ] = check_tcp -H ts02 -p 3389
command[ ts03 ] = check_tcp -H ts03 -p 3389
command[ ts04 ] = check_tcp -H ts04 -p 3389
command[ ts05 ] = check_tcp -H ts05 -p 3389
command[ ts06 ] = check_tcp -H ts06 -p 3389
command[ ts07 ] = check_tcp -H ts07 -p 3389
command[ ts08 ] = check_tcp -H ts08 -p 3389

state[ warning ] = count(CRITICAL) &gt; 0 || count(UNKNOWN) &gt; 0 || count(WA
RNING) &gt; 0
state[ critical ] = ts01 &gt;= CRITICAL || count(CRITICAL) &gt; 3</pre>

      <p>The individual checks here consist of only a primitive TCP check of the RDP port 3389 in order to keep the example relatively simple. WARNING should be indicated if at least one CRITICAL or at least one UNKNOWN occurs so that the administrator has the opportunity to fix the problem at an early stage. The condition for the CRITICAL status stipulates that <strong class="userinput"><code>ts01</code></strong> must not be CRITICAL because a very specific application is running there which is not available on the other servers. In addition, no more than three terminal servers may fail, as otherwise the load on the other servers may increase so heavily that useful work would no longer be possible.</p>

      <div class="figure">
        <a id="recursive_output_of_chech_underscore_mul"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject5_d1e18592"/><img alt="Recursive output of chech_multi on the Extended Infro page of the Nagios Web interface" src="../Images/tagoreillycom20081104nostarchimages223812.png.jpg"/></div>

        <p class="title">Figure 8-3. Recursive output of <code class="userinput">chech_multi</code> on the Extended Infro page of the Nagios Web interface</p>
      </div>

      <p>The two checks of the partial processes are summarized by a <strong class="userinput"><code>check_multi</code></strong> call into a single result (the lines are wrapped for display purposes):</p><a id="I_programlisting5_d1e18602"/>
      <pre class="programlisting"># homeoffice.cmd
command[ openvpn ] = check_multi -f /etc/nagios/check_multi/openvpn.cmd
-r31
command[ terminalserver ] = check_multi -f /etc/nagios/check_multi/termi
nalserver.cmd -r31</pre>

      <p>So that the Extended Info page of Nagios (<a class="xref" href="../Text/ch08s05.html#recursive_output_of_chech_underscore_mul" title="Figure 8-3. Recursive output of chech_multi on the Extended Infro page of the Nagios Web interface">Figure 8-3</a>) is more presentable, the details of the respective plugin names are omitted (through the missing option <strong class="userinput"><code>-n</code></strong>; the recursive HTML output of <strong class="userinput"><code>check_multi</code></strong> adds the name of the check called anyway). The <strong class="userinput"><code>-r 31</code></strong> detail sets all reporting functions from 1 to 16, including HTML formatting (<strong class="userinput"><code><em class="replaceable"><code>-r</code></em></code></strong> <strong class="userinput"><code>2</code></strong>). Special conditions for a status are not formulated, so a WARNING of a partial process leads to a WARNING in the overlying check, and a CRITICAL leads to a CRITICAL.</p>

      <p><a class="xref" href="../Text/ch08s05.html#recursive_output_of_chech_underscore_mul" title="Figure 8-3. Recursive output of chech_multi on the Extended Infro page of the Nagios Web interface">Figure 8-3</a> shows the two partial processes quite clearly separated. The serial numbers of the checks are stored with the respective status colors, which are unfortunately not visible in this black-and-white book. A complex color example of recursive display in the Extended Info Web page can be found on the homepage of the plugin.<sup>[<a class="footnote" href="#ftn.CHP-8-FN-6" id="CHP-8-FN-6">90</a>]</sup></p>

      <p>For the sake of completeness, here is the definition of command and service for Nagios. The former is kept deliberately simple, and all the details for the command line are repeated in the service definition:</p><a id="I_programlisting5_d1e18634"/>
      <pre class="programlisting">define command{
   command_name check_multi
   command_line $USER1$/check_multi $ARG1$
}

define service{
   host_name           elix01
   service_description homeoffice
   check_command check_multi!-f /etc/nagios/check_multi/homeoffice.cmd -n
   homeoffice -r 31
   ...
}</pre>

      <p>If the mapping of business processes with <strong class="userinput"><code>check_multi</code></strong> isn't enough for you, you should take a look at the somewhat more complex addon <span class="emphasis"><em>Nagios Business Process View and Nagios Business Impact Analysis</em></span> from the Sparda-Datenverarbeitung eG, Nuremberg, Germany, which is available on the Nagios-Exchange.<sup>[<a class="footnote" href="#ftn.CHP-8-FN-7" id="CHP-8-FN-7">91</a>]</sup></p>

      <p>In contrast to <strong class="userinput"><code>check_multi</code></strong>, which appears as the only Nagios service and which also needs to be managed only once by Nagios, this addon uses services already defined in Nagios, which means that Nagios performs each individual check as usual. It retrieves the results of individual checks, links these, and displays them on its own Web interface.</p>

      <p>When doing so, the result of such links—business processes, so to speak—can be redefined in Nagios as a separate service so that it is possible, for instance, to use the notification logic of Nagios. Furthermore, the addon includes a mode with which it can simulate a "what would happen if" scenario. Individual services are set to an expected status, and the effects can be seen via the Web interface.</p>

      <p><strong class="userinput"><code>check_multi</code></strong> and the Nagios Business Process View and Nagios Business Impact Analysis addon are thus not in competition. Depending on the intended use, either <strong class="userinput"><code>check_multi</code></strong> will reduce the complexity of the services represented in Nagios and therefore will reduce the number of checks performed, or the addon will allow a more detailed view of overall events, though it does demand that all services are individually mapped in Nagios.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-8-FN-3" id="ftn.CHP-8-FN-3">87</a>]</sup> <a class="ulink" href="http://www.my-plugin.de/wiki/de/projects/check_multi/installation#c%20heck_by_ssh">http://www.my-plugin.de/wiki/de/projects/check_multi/installation#c heck_by_ssh</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-8-FN-4" id="ftn.CHP-8-FN-4">88</a>]</sup> <a class="ulink" href="http://www.my-plugin.de/wiki/de/projects/check_multi/start">http://www.my-plugin.de/wiki/de/projects/check_multi/start</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-8-FN-5" id="ftn.CHP-8-FN-5">89</a>]</sup> Let us assume that 53 have passed since <strong class="userinput"><code>check_multi</code></strong> was called, but not all planned individual checks have yet been processed. The total from starting time and individual timeout (53 + 10 = 63) exceeds the timeout of the <strong class="userinput"><code>check_multi</code></strong> call, so <strong class="userinput"><code>check_multi</code></strong> does not start any further checks.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-8-FN-6" id="ftn.CHP-8-FN-6">90</a>]</sup> <a class="ulink" href="http://www.my-plugin.de/wiki/de/projects/check_multi/screenshot#ser-vice_extended_info_rekursiv">http://www.my-plugin.de/wiki/de/projects/check_multi/screenshot#ser-vice_extended_info_rekursiv</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-8-FN-7" id="ftn.CHP-8-FN-7">91</a>]</sup> <a class="ulink" href="http://www.nagioserchange.org/22;1088">http://www.nagioserchange.org/22;1088</a></p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;9.&#xA0;Executing Plugins via SSH">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="executing_plugins_via_ssh"/>Chapter 9. Executing Plugins via SSH</h1>
    </div>

    <p>Local plugins, that is, programs that only run tests locally because there are no network protocols available, must be installed on the target system and started there. They check processes, CPU load, or how much free hard disk capacity is still available, among other things.</p>

    <p>But if you still want to execute these plugins from the Nagios server, it is recommended that you use the secure shell, especially if any kind of Unix system is installed on the machine to be tested—a Secure Shell daemon will almost always be running on such a target system, and you do not require any special permissions to run most plugins. The Nagios administrator needs nothing more than an account, which he can use from the Nagios server. On the server itself, the <strong class="userinput"><code>check_by_ssh</code></strong> plugin must be installed.<a class="indexterm" id="IDX-CHP-9-0753"/><a class="indexterm" id="IDX-CHP-9-0754"/></p>

    <p>In heterogeneous environments the Secure Shell itself often create conditions that may cause problems: depending on the operating system, an SSH daemon may be in use that returns a false return code<sup>[<a class="footnote" href="#ftn.CHP-9-FN-1" id="CHP-9-FN-1">92</a>]</sup> or is so old that it cannot handle the SSH protocol version 2.0. In this case it is better to install the current OpenSSH version.<sup>[<a class="footnote" href="#ftn.CHP-9-FN-2" id="CHP-9-FN-2">93</a>]</sup> In pure Linux environments with up-to-date and maintained installations, such problems generally do not occur.<a class="indexterm" id="IDX-CHP-9-0755"/></p>

    <div class="sect1" title="9.1 The check_by_ssh Plugin">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="the_check_underscore_by_underscore_ssh"/>9.1 The <strong class="userinput"><code>check_by_ssh</code></strong> Plugin</h1>
      </div>

      <p><strong class="userinput"><code>check_by_ssh</code></strong> is run on the Nagios server and establishes a Secure Shell connection to a remote computer so that it can perform local tests on it. The programs run on the remote machine are to a large extent local plugins (see <a class="xref" href="../Text/ch07.html" title="Chapter 7. Testing Local Resources">Chapter 7</a> from page 157); the use of <strong class="userinput"><code>check_by_ssh</code></strong> is not just restricted to these, however.<a class="indexterm" id="IDX-CHP-9-0756"/><a class="indexterm" id="IDX-CHP-9-0757"/><a class="indexterm" id="IDX-CHP-9-0758"/><a class="indexterm" id="IDX-CHP-9-0759"/></p>

      <p>The plugin sends a complete command line to the remote computer and then waits for a plugin-compatible response: a response status between <strong class="userinput"><code>0</code></strong> (OK) and <strong class="userinput"><code>3</code></strong> (UNKNOWN), as well as a one-line text information for the administrator (<a class="xref" href="../Text/ch06.html" title="Chapter 6. Plugins for Network Services">Chapter 6</a>).</p>

      <p>If you run network plugins via <strong class="userinput"><code>check_by_ssh</code></strong> in order to perform tests on other computers, these are known as <span class="emphasis"><em>indirect checks</em></span>, which will be explained in the context of the <span class="emphasis"><em>Nagios Remote Plugin Executor</em></span> in <a class="xref" href="../Text/ch10s06.html" title="10.6 Indirect Checks">10.6 Indirect Checks</a> from page 224.<a class="indexterm" id="IDX-CHP-9-0760"/></p>

      <p>The following example shows how <strong class="userinput"><code>check_by_ssh</code></strong> can be used to check the swap partition on the target computer:</p><a id="I_programlisting6_d1e18768"/>
      <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_by_ssh</strong></span> -H <span class="bolditalic">target_computer</span>  \
<span class="strong"><strong>    -i /etc/nagios/.ssh/id_dsa \</strong></span>
<span class="strong"><strong>        -C "/usr/local/nagios/libexec/check_swap -w 50% -c 10%"</strong></span>
SWAP OK: 100% free (972 MB out of 972 MB) |swap=972MB;486;97;0;972</pre>

      <p>The command is similar to that for a secure shell, in the form of</p><a id="I_programlisting6_d1e18784"/>
      <pre class="programlisting">ssh -i <span class="emphasis"><em>private_key target_computer "command"</em></span></pre>

      <p>The fact that a separate private key—not the default private key in the home directory—is used, is optional and is described in detail in <a class="xref" href="../Text/ch09s02.html" title="9.2 Configuring SSH">9.2 Configuring SSH</a> from page 208. The command to be run is specified in <strong class="userinput"><code>check_by_ssh</code></strong>—in contrast to the secure shell <strong class="userinput"><code>ssh</code></strong>—with the option <strong class="userinput"><code>-C</code></strong>, the plugin is always specified with an absolute path.</p>

      <p><strong class="userinput"><code>check_by_sshhas</code></strong> the following options:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --hostname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>The host name or IP address of the computer to which the plugin should set up an SSH connection.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>command</code></em></code></strong> <strong class="userinput"><code>/--command=</code></strong><strong class="userinput"><code><em class="replaceable"><code>command</code></em></code></strong></span></dt>

          <dd>
            <p>The command to be run on the remote computer, that is, the plugin with its complete path and all the necessary parameters:</p><a id="I_programlisting6_d1e18840"/>
            <pre class="programlisting">-C "/usr/local/nagios/libexec/check_disk -w 10% -c 5% -e -m"</pre>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>−1 /--proto1</code></strong></span></dt>

          <dd>
            <p>Force version 1 of the secure shell protocol.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>−2 /--proto2</code></strong></span></dt>

          <dd>
            <p>Force version 2 of the secure shell protocol.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-o</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ssh_option</code></em></code></strong> <strong class="userinput"><code>/--ssh-option=</code></strong><strong class="userinput"><code><em class="replaceable"><code>ssh_option</code></em></code></strong> (from version 1.4.6)</span></dt>

          <dd>
            <p>Passes an SSH option to the secure shell on the target host. To specify multiple options, use of the switch is repeated.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-i</code></strong> <strong class="userinput"><code><em class="replaceable"><code>keyfile</code></em></code></strong> <strong class="userinput"><code>/--ldentlty=</code></strong><strong class="userinput"><code><em class="replaceable"><code>keyfile</code></em></code></strong></span></dt>

          <dd>
            <p>Which file should be used instead of the standard key file containing the private key of the user <strong class="userinput"><code>nagios?</code></strong> For one option, which is recommended, see <a class="xref" href="../Text/ch09s02.html#checking_the_ssh_connection_and_check_un" title="9.2.3 Checking the SSH connection and check_by_ssh">9.2.3 Checking the SSH connection and check_by_ssh</a>, page 210.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/--port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

          <dd>
            <p>This specifies the port if the Secure Shell daemon on the target server is not listening on the standard TCP port 22.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-l</code></strong> <strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong> <strong class="userinput"><code>/--logname=</code></strong><strong class="userinput"><code><em class="replaceable"><code>user</code></em></code></strong></span></dt>

          <dd>
            <p>User name on the target host. [<strong class="userinput"><code>-S</code></strong> <strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong> /<strong class="userinput"><code>--skip-stdout=<em class="replaceable"><code>number</code></em></code></strong> (from version 1.4.9)]</p>

            <p>Ignores the specified number of lines at the beginning of the output to STDOUT. If this option is omitted, the entire output is ignored.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-E</code></strong> <strong class="userinput"><code><em class="replaceable"><code>number</code></em></code></strong> <strong class="userinput"><code>/--skip-stderr=</code></strong><strong class="userinput"><code><em class="replaceable"><code>lines</code></em></code></strong> (from version 1.4.9)</span></dt>

          <dd>
            <p>Like <strong class="userinput"><code>--skip-stdout</code></strong>, but refers only to the output of STDERR.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_decimal</code></em></code></strong> <strong class="userinput"><code>/--warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_decimal</code></em></code></strong></span></dt>

          <dd>
            <p>If the response to the command to be executed takes more than <span class="emphasis"><em>floating_point_decimal</em></span> seconds, the plugin will issue a warning.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>floating_point_decimal</code></em></code></strong> <strong class="userinput"><code>/--critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>floating_point_decimal</code></em></code></strong></span></dt>

          <dd>
            <p>The critical value in seconds concerning the response time of the command to be executed.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-f</code></strong><sup>[<a class="footnote" href="#ftn.CHP-9-FN-3" id="CHP-9-FN-3">94</a>]</sup></span></dt>

          <dd>
            <p>Starts a background process without opening an interactive terminal (tty).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-t</code></strong> <span class="emphasis"><em>timeout</em></span> /<strong class="userinput"><code>--timeout=</code></strong><span class="emphasis"><em>timeout</em></span></span></dt>

          <dd>
            <p>After <span class="emphasis"><em>timeout</em></span> seconds have expired, the plugin stops the test and returns the CRITICAL status. The default is <strong class="userinput"><code>10</code></strong> seconds.</p>
          </dd>
        </dl>
      </div>

      <p>In addition to this, <strong class="userinput"><code>check_by_ssh</code></strong> has parameters available, <strong class="userinput"><code>-o</code></strong>, <strong class="userinput"><code>-s</code></strong> and <strong class="userinput"><code>-n</code></strong>, enabling it to write the result in <span class="emphasis"><em>passive mode</em></span> to the <span class="emphasis"><em>interface for external commands</em></span> (see <a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a> from page 292). The mode is named this way because Nagios does not receive the information itself but reads it indirectly from the interface.<a class="indexterm" id="IDX-CHP-9-0761"/><a class="indexterm" id="IDX-CHP-9-0762"/></p>

      <p>This procedure has the advantage of being able to run several separate commands simultaneously over a single SSH connection. This may cause the command definition to be rather complicated, however. Since the plugins themselves are called and executed as programs on the target server, it hardly matters whether the SSH connection is established once or three times. For this reason it is better to use a simple command definition rather than the passive mode.</p>

      <p>But if you still want to find more information about this, you can look in the online help, which is called with <strong class="userinput"><code>check_by_ssh -h</code></strong>.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-9-FN-1" id="ftn.CHP-9-FN-1">92</a>]</sup> In the <strong class="userinput"><code>nagios-users</code></strong> mailing list it was reported that <strong class="userinput"><code>Sun_SSH_1.0</code></strong> returns a return code of 255 instead of 0, which makes it unsuitable for the deployment described here.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-9-FN-2" id="ftn.CHP-9-FN-2">93</a>]</sup> <a class="ulink" href="http://www.openssh.org/">http://www.openssh.org/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-9-FN-3" id="ftn.CHP-9-FN-3">94</a>]</sup> There is currently no long form for this option.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="9.2 Configuring SSH">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="configuring_ssh"/>9.2 Configuring SSH</h1>
    </div>

    <p>So that Nagios can run plugins over the secure shell remotely and automatically, it—or, strictly speaking, the user <strong class="userinput"><code>nagios</code></strong> on the Nagios server—must not be distracted by any password queries. This is avoided with a login via a Public Key mechanism.<a class="indexterm" id="IDX-CHP-9-0763"/><a class="indexterm" id="IDX-CHP-9-0764"/></p>

    <div class="sect2" title="9.2.1 Generating SSH key pairs on the Nagios server">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="generating_ssh_key_pairs_on_the_nagios_s"/>9.2.1 Generating SSH key pairs on the Nagios server</h2>
      </div>

      <p>The key pair required to do this is stored by the key generator <strong class="userinput"><code>ssh-keygen</code></strong> by default in the subdirectory <strong class="userinput"><code>.ssh</code></strong> of the respective user's home directory (for the user <strong class="userinput"><code>nagios</code></strong>, this therefore corresponds to the installation guide in <a class="xref" href="../Text/ch01s02.html" title="1.2 Compiling Source Code">1.2 Compiling Source Code</a> from page 39, that is, <strong class="userinput"><code>/usr/local/nagios</code></strong>). If it is also sent on its way with the <strong class="userinput"><code>-f</code></strong> <strong class="userinput"><code><em class="replaceable"><code>private_keyfile</code></em></code></strong> option (without path specification), it will land in the current working directory, which in the following example is <strong class="userinput"><code>/etc/nagios/.ssh</code></strong>:</p><a id="I_programlisting6_d1e19121"/>
      <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>mkdir /etc/nagios/.ssh</strong></span>
nagios@linux:~$ <span class="strong"><strong>cd /etc/nagios/.ssh</strong></span>
nagios@linux:/etc/nagios/.ssh$ <span class="strong"><strong>ssh-keygen -b 1024 -f id_dsa -t dsa -N"</strong></span>
Generating public/private dsa key pair.
Your identification has been saved in id_dsa.
Your public key has been saved in id_dsa.pub.
The key fingerprint is:
02:0b:5a:16:9c:b4:fe:54:24:9c:fd:c3:12:8f:69:5c nagios@nagserv</pre>

      <p>The length of the key here is 1024 bits, and DSA is used to encrypt the keys. <strong class="userinput"><code>-N' '</code></strong> ensures that the private key in <strong class="userinput"><code>id_dsa</code></strong> does not receive separate password protection: this option forces an empty password.</p>
    </div>

    <div class="sect2" title="9.2.2 Setting up the user nagios on the target host">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="setting_up_the_user_nagios_on_the_target"/>9.2.2 Setting up the user <strong class="userinput"><code>nagios</code></strong> on the target host</h2>
      </div>

      <p>Similar to the configuration on the Nagios server, the group and the user <strong class="userinput"><code>nagios</code></strong> are also set up on the computer to be monitored:<a class="indexterm" id="IDX-CHP-9-0765"/><a class="indexterm" id="IDX-CHP-9-0766"/><a class="indexterm" id="IDX-CHP-9-0767"/></p><a id="I_programlisting6_d1e19162"/>
      <pre class="programlisting">target_computer:~ # <span class="strong"><strong>groupadd -g 9000 nagios</strong></span>
target_computer:~ # <span class="strong"><strong>useradd -u 9000 -g nagios -d /home/nagios -m \</strong></span>
<span class="strong"><strong>  -c "Nagios Admin" nagios</strong></span>
target_computer:~ # <span class="strong"><strong>mkdir /home/nagios/.ssh</strong></span></pre>

      <p>The target computer is given the directory <strong class="userinput"><code>/home/nagios</code></strong> as the home directory, where a subdirectory <strong class="userinput"><code>.ssh</code></strong> is created. In this the administrator (or another user<sup>[<a class="footnote" href="#ftn.CHP-9-FN-4" id="CHP-9-FN-4">95</a>]</sup>) saves the public key generated on the Nagios server <strong class="userinput"><code>/etc/nagios/.ssh/id_dsa.pub</code></strong>, in a file called <strong class="userinput"><code>authorized_keys</code></strong>:<a class="indexterm" id="IDX-CHP-9-0768"/><a class="indexterm" id="IDX-CHP-9-0769"/></p><a id="I_programlisting6_d1e19209"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>scp /etc/nagios/.ssh/id_dsa.pub</strong></span> \
<span class="bolditalic">    target_computer</span><span class="strong"><strong>:/home/nagios/.ssh/authorized_keys</strong></span></pre>

      <p>Now the user <strong class="userinput"><code>nagios</code></strong> does not require its own password on the target server. You just need to make sure that on the target server the <strong class="userinput"><code>.ssh</code></strong> directory, together with <strong class="userinput"><code>authorized_keys</code></strong>, belongs to the user <strong class="userinput"><code>nagios</code></strong>:</p><a id="I_programlisting6_d1e19232"/>
      <pre class="programlisting">target_computer:~ # <span class="strong"><strong>chown -R nagios.nagios /home/nagios/.ssh</strong></span>
target_computer:~ # <span class="strong"><strong>chmod 700 /home/nagios/.ssh</strong></span></pre>
    </div>

    <div class="sect2" title="9.2.3 Checking the SSH connection and check_by_ssh">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="checking_the_ssh_connection_and_check_un"/>9.2.3 Checking the SSH connection and <strong class="userinput"><code>check_by_ssh</code></strong></h2>
      </div>

      <p>With this configuration you should first check whether the secure shell connection is working properly. The test is performed as the user <strong class="userinput"><code>nagios</code></strong>, since Nagios makes use of this during the checks:<a class="indexterm" id="IDX-CHP-9-0770"/><a class="indexterm" id="IDX-CHP-9-0771"/></p><a id="I_programlisting6_d1e19255"/>
      <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>ssh -i /etc/nagios/.ssh/id_dsa</strong></span> <span class="bolditalic">target_computer</span> <span class="strong"><strong>w</strong></span>
18:02:09 up 128 days, 10:03, 8 users, load average: 0.01, 0.02, 0.00
USER     TTY      FROM          LOGIN@  IDLE   JCPU   PCPU WHAT
wob      pts/1    linux01:S.1   08Sep04 1:27   4.27s  0.03s -bin/tcsh
...</pre>

      <p>The <strong class="userinput"><code>-i</code></strong> option explicitly specifies the path to the private key file. If the command <strong class="userinput"><code>w</code></strong> to be run on the target computer does not provide any output or if the opposite SSH daemon requests a password, then the login via public key is not working. In this case you must first find and eliminate the error before you can move on to testing <strong class="userinput"><code>check_by_ssh</code></strong>.</p>

      <p>In this next step, you run the local plugin on the target computer, with <strong class="userinput"><code>check_by_ssh</code></strong>, which later on is run automatically, from the command line of the Nagios server. Make sure that the plugin paths are correct in each case. The path to the private key file of the user <strong class="userinput"><code>nagios</code></strong> on the server is specified with <strong class="userinput"><code>-i</code></strong>:</p><a id="I_programlisting6_d1e19288"/>
      <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>/usr/local/nagios/libexec/check_by_ssh</strong></span> \
 <span class="strong"><strong>-H</strong></span> <span class="bolditalic">target_computer</span> <span class="strong"><strong>-i /etc/nagios/.ssh/id_dsa</strong></span> \
 <span class="strong"><strong>-C "/usr/local/nagios/libexec/check_disk -w 10% -c 5% -e -m"</strong></span>
DISK CRITICAL [2588840 kB (5%) free on /net/linux04/b] [937152 kB (5%)
free on /net/linux04/c]</pre>

      <p>In the example, <strong class="userinput"><code>check_by_ssh</code></strong> should start the <strong class="userinput"><code>/usr/local/nagios/libexec/check_disk</code></strong> plugin on the target computer with the options <strong class="userinput"><code>-w 10% -c 5% -e -m</code></strong>. If this does not work, then this is first run locally on the target host with the same parameter. By doing this you can rule out that the problem lies in the plugin command itself and not in the secure shell connection.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-9-FN-4" id="ftn.CHP-9-FN-4">95</a>]</sup> ... but not the user <strong class="userinput"><code>nagios</code></strong>, because when an account is created, <strong class="userinput"><code>useradd</code></strong> first sets an invalid password here, which we do not change into a valid one. This means that you cannot currently log in to the target computer as <strong class="userinput"><code>nagios</code></strong>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="9.3 Nagios Configuration">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="nagios_configuration-id1"/>9.3 Nagios Configuration</h1>
    </div>

    <p>The matching command object is again defined in the file <strong class="userinput"><code>checkcommands.cfg</code></strong>; similar to <strong class="userinput"><code>check_local_disk</code></strong>, it should be named <strong class="userinput"><code>check_ssh_disk</code></strong>:</p><a id="I_programlisting6_d1e19330"/>
    <pre class="programlisting"># check_ssh_disk command definition
define command{
    command_name<span class="strong"><strong>  check_ssh_disk</strong></span>
    command_line     $USER1$/<span class="strong"><strong>check_by_ssh</strong></span> -H $HOSTADDRESS$ \
                     -i /etc/nagios/.ssh/id_dsa \
                     -C "$USER1$/check_disk -w $ARG1$ -c $ARG2$ -p $ARG3$"
}</pre>

    <p>The command line stored in <strong class="userinput"><code>command_line</code></strong> first runs <strong class="userinput"><code>check_by_ssh; $USER1$</code></strong> contains the local plugin path on the Nagios server. Next come the arguments—the IP address of the target host (parameter <strong class="userinput"><code>-H</code></strong>), the private key file (parameter <strong class="userinput"><code>-i</code></strong>) and finally, with the <strong class="userinput"><code>-C</code></strong> parameter, the complete command that the target host should carry out. If the plugin path on the target host and on the Nagios server are identical, then you can also use the <strong class="userinput"><code>$USER1$</code></strong> macro in it; otherwise the plugin path on the target computer is given explicitly.</p>

    <p>Setting up the command is no different here to the one in <strong class="userinput"><code>check_local_disk</code></strong> in <a class="xref" href="../Text/ch07.html#free_hard_drive_capacity" title="7.1 Free Hard Drive Capacity">7.1 Free Hard Drive Capacity</a> in page 158. This means that apart from the warning and critical limits, we explicitly specify a file system or a hard drive partition, with the <strong class="userinput"><code>-p</code></strong> parameter.</p>

    <p>The command <strong class="userinput"><code>check_ssh_disk</code></strong> defined in this way is applied as follows, here on a computer called <strong class="userinput"><code>linux02</code></strong>:</p><a id="I_programlisting6_d1e19377"/>
    <pre class="programlisting">define service{
    host_name       linux02
    service_description FS_root
    ...
   <span class="strong"><strong>check_command   check_ssh_disk</strong></span>!10%!5%!/
    ...
}</pre>

    <p>The service object defined in this way ensures that Nagios checks its <strong class="userinput"><code>/</code></strong> file system. The warning limit lies at 10 percent, the critical limit at 5 percent.</p>

    <p>If you use the <strong class="userinput"><code>check_by_ssh</code></strong> plugin with <strong class="userinput"><code>check_ssh_disk</code></strong>, as in the example here, you must make sure that the plugin path is identical on all target hosts. This is also worth doing for reasons of simplicity, though it is not always possible in practice. The following service definition, for this reason, gives the plugin path to the target computer as an additional argument:</p><a id="I_programlisting6_d1e19395"/>
    <pre class="programlisting">define service{
    host_name       linux02
    service_description FS_root
    ...
    check_command   check_ssh_disk!<span class="strong"><strong>/usr/lib/nagios/plugins</strong></span>!10%!5%!/
    ...
}</pre>

    <p>In order for this to work, you must change the command line in the command definition, passed on with <strong class="userinput"><code>-C</code></strong>, as follows:</p><a id="I_programlisting6_d1e19406"/>
    <pre class="programlisting">-C "$ARG1$/check_disk -w $ARG2$ -c $ARG3$ -p $ARG4$"</pre>

    <p>Caution: this causes the numbers of each of the <strong class="userinput"><code>$ARGx</code></strong> macros for <strong class="userinput"><code>-w</code></strong>, <strong class="userinput"><code>-c</code></strong>, and <strong class="userinput"><code>-p</code></strong> to be shifted by one.</p>
  </div>


  <div class="chapter" title="Chapter&#xA0;10.&#xA0;The Nagios Remote Plugin Executor (NRPE)">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_nagios_remote_plugin_executor_open_p"/>Chapter 10. The Nagios Remote Plugin Executor (NRPE)</h1>
    </div>

    <p>The <span class="emphasis"><em>Nagios Remote Plugin Executor</em></span> (or in short, NRPE) as the name suggests, executes programs on a remote host. These are usually plugins that test the corresponding computer locally and therefore must be installed on it. The use of NRPE is not restricted to local plugins; any plugins at all can be executed, including those intended to test network services—for example, to indirectly test computers that are not reachable from the Nagios server (as shown in <a class="xref" href="../Text/ch10s06.html" title="10.6 Indirect Checks">10.6 Indirect Checks</a> from page 224).<a class="indexterm" id="IDX-CHP-10-0772"/></p>

    <p>While a genuine user account must be available on the remote computer when the secure shell is used (see <a class="xref" href="../Text/ch09.html" title="Chapter 9. Executing Plugins via SSH">Chapter 9</a>), which can also be used to do other things than just start plugins, NRPE is restricted exclusively to explicitly configured tests. If you want to, or are forced to, do without a login shell on the target host, it is better to use NRPE, even if there is somewhat more configuration work involved than with the secure shell. In addition to the Nagios configuration and the installation of the <strong class="userinput"><code>check_nrpe</code></strong> plugin on the Nagios server, the following tasks remain on the target system:</p>

    <div class="itemizedlist">
      <ul class="itemizedlist">
        <li class="listitem">
          <p>The program <strong class="userinput"><code>nrpe</code></strong> must be installed.</p>
        </li>

        <li class="listitem">
          <p>The inet daemon there (<strong class="userinput"><code>inetd</code></strong> or <strong class="userinput"><code>xinetd</code></strong>) must be configured with administrator privileges.</p>
        </li>

        <li class="listitem">
          <p>All the plugins called via NRPE must be installed.<a class="indexterm" id="IDX-CHP-10-0773"/></p>
        </li>
      </ul>
    </div>

    <div class="sect1" title="10.1 Installation">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="installation-id2"/>10.1 Installation</h1>
      </div>

      <p>NRPE and the plugins are installed from the sources, or you can fall back on the packages provided by the distributor. You should use at least version 2.0 of NRPE, since this is incompatible with its predecessors. Starting with version 2.6, NRPE has the switch <strong class="userinput"><code>-u</code></strong>. If the NRPE service on the target system is not reachable, the plugin <strong class="userinput"><code>check_nrpe</code></strong> on the Nagios server returns an UNKNOWN for this switch. Starting with version 2.8, NRPE supports the multi-line output of plugins that was introduced with Nagios 3.0 (see <a class="xref" href="../Text/ch08s05.html#multiple-line_plugin_output" title="8.5.1 Multiple-line plugin output">8.5.1 Multiple-line plugin output</a> from page 193). At the time this book went to press, the current version was 2.12, dated 26. 03. 2008.<a class="indexterm" id="IDX-CHP-10-0774"/><a class="indexterm" id="IDX-CHP-10-0775"/><a class="indexterm" id="IDX-CHP-10-0776"/></p>

      <p>All established distributions include the plugin collection from at least version 1.4. Whether you need the most up-to-date version depends on your expectations of the respective plugins.</p>

      <div class="sect2" title="10.1.1 Distribution-specific packages">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="distribution-specific_packages"/>10.1.1 Distribution-specific packages</h2>
        </div>

        <p>SuSE Linux 10.3 includes the packages <strong class="userinput"><code>nagios-nrpe-2.10-4.1.i586.rpm, nagios-plugins-1.4.10-12.1.i586.rpm</code></strong>, and <strong class="userinput"><code>nagios-plugins-extras −1.4.10-12.1.i586.rpm.nagios-nrpe</code></strong> contains both the daemon and the plugin <strong class="userinput"><code>check_nrpe. nagios-plugins-extras</code></strong> installs several additional plugins, such as database checks, FPing test or Radius test, which can be omitted, depending on your specific monitoring needs.</p>

        <p>For the sake of simplicity, the design packages are installed via YAST2<sup>[<a class="footnote" href="#ftn.CHP-10-FN-1" id="CHP-10-FN-1">96</a>]</sup> or <strong class="userinput"><code>rpm -ihv</code></strong> <strong class="userinput"><code><em class="replaceable"><code>package</code></em></code></strong>. the second method is also open to Fedora users.</p>

        <p>For Fedora Core and Red Hat Enterprise Linux, Dag Wieers has made available corresponding Nagios packages of several versions.<sup>[<a class="footnote" href="#ftn.CHP-10-FN-2" id="CHP-10-FN-2">97</a>]</sup></p>

        <p>Debian/Sarge distributes the NRPE daemon and the NRPE plugin <strong class="userinput"><code>check_nrpe</code></strong> in two different packages called <strong class="userinput"><code>nagios-nrpe-server</code></strong> and <strong class="userinput"><code>nagios-nrpe-plugin</code></strong>, which can be installed separately via <strong class="userinput"><code>apt-get install</code></strong> <strong class="userinput"><code><em class="replaceable"><code>package</code></em></code></strong>. If you want to do without local documentation, you can omit the package <strong class="userinput"><code>nagios-nrpe-doc</code></strong> and just add the plugin package <strong class="userinput"><code>nagios-plugins</code></strong> to the target hosts.</p>

        <p>The paths for the program <strong class="userinput"><code>nrpe</code></strong>, the configuration file <strong class="userinput"><code>nrpe.cfg</code></strong>, and the plugin directory are listed in <a class="xref" href="../Text/ch10.html#installation_paths_for_nrpe_and_plugins" title="Table 10-1. Installation paths for NRPE and plugins">Table 10-1</a>.<a class="indexterm" id="IDX-CHP-10-0777"/></p>

        <div class="table">
          <a id="installation_paths_for_nrpe_and_plugins"/>

          <p class="title">Table 10-1. Installation paths for NRPE and plugins</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Installation paths for NRPE and plugins">
              <colgroup>
                <col/>
                <col/>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Distribution<a class="indexterm" id="IDX-CHP-10-0778"/></p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>NRPE program</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Configuration file</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Plugins</p>
                  </th>
                </tr>
              </thead>

              <tfoot>
                <tr>
                  <th class="sgc-1" colspan="4" valign="top">
                    <p><sup>[<a class="footnote" href="#ftn.CHP-10-TFN-3" id="CHP-10-TFN-3">a</a>]</sup></p>
                  </th>
                </tr>

                <tr>
                  <th class="sgc-1" colspan="4" valign="top">
                    <p><sup>[<a class="footnote" href="#ftn.CHP-10-TFN-4" id="CHP-10-TFN-4">b</a>]</sup></p>
                  </th>
                </tr>
              </tfoot>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p>Self-compiled<sup>[<a class="footnoteref" href="../Text/ch10.html#ftn.CHP-10-TFN-3">a</a>]</sup></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/usr/local/sbin/nrpe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/etc/nagios/nrpe.cfg</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/usr/local/nagios/libexec</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>SuSE</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/usr/bin/nrpe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/etc/nagios/nrpe.cfg</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/usr/lib/nagios/plugins</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>Debian</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/usr/sbin/nrpe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/etc/nagios/nrpe.cfg</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/usr/lib/nagios/plugins</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>Fedora<sup>[<a class="footnoteref" href="../Text/ch10.html#ftn.CHP-10-TFN-4">b</a>]</sup></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/usr/sbin/nrpe</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/etc/nagios/nrpe.cfg</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>/usr/lib/nagios/plugins</code></strong></p>
                  </td>
                </tr>
              </tbody>

              <tbody class="footnotes">
                <tr>
                  <td colspan="4">
                    <div class="footnote">
                      <p><sup>[<a class="para" href="#CHP-10-TFN-3" id="ftn.CHP-10-TFN-3">a</a>]</sup> Recommended.</p>
                    </div>

                    <div class="footnote">
                      <p><sup>[<a class="para" href="#CHP-10-TFN-4" id="ftn.CHP-10-TFN-4">b</a>]</sup> From the packages provided by Dag Wieers.</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="sect2" title="10.1.2 Installation from the source code">
        <div class="titlepage">
          <h2 class="title" id="heading_id_5"><a id="installation_from_the_source_code"/>10.1.2 Installation from the source code</h2>
        </div>

        <p>The plugins are installed on the computers to be monitored exactly as described in <a class="xref" href="../Text/ch01s04.html" title="1.4 Installing and Testing Plugins">1.4 Installing and Testing Plugins</a> from page 43 for the Nagios server.</p>

        <p>The NRPE source code is obtained from the Nagios homepage.<sup>[<a class="footnote" href="#ftn.CHP-10-FN-5" id="CHP-10-FN-5">98</a>]</sup> The directory <strong class="userinput"><code>/usr/local/src</code></strong><sup>[<a class="footnote" href="#ftn.CHP-10-FN-6" id="CHP-10-FN-6">99</a>]</sup> is ideal for unloading the sources.</p><a id="I_programlisting7_d1e19700"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>mkdir /usr/local/src</strong></span>
linux:~ # <span class="strong"><strong>cd /usr/local/src</strong></span>
linux:local/src # <span class="strong"><strong>tar xvzf</strong></span> /<span class="bolditalic">path/to</span>/<span class="strong"><strong>nrpe-2.11.tar.gz</strong></span></pre>

        <p>In the new directory that has been created, you run the <strong class="userinput"><code>configure</code></strong> command:</p><a id="I_programlisting7_d1e19721"/>
        <pre class="programlisting">linux:local/src # <span class="strong"><strong>cd nrpe-2.11</strong></span>
linux:src/rnpe-2.11 # <span class="strong"><strong>./configure --sysconfdir=/etc/nagios --enable-ssl</strong></span></pre>

        <p>The recommended path specifications are listed in <a class="xref" href="../Text/ch10.html#installation_paths_for_nrpe_and_plugins" title="Table 10-1. Installation paths for NRPE and plugins">Table 10-1</a>. The only difference from the default settings are for the directory in which the NRPE configuration file is stored (<strong class="userinput"><code>configure</code></strong> option <strong class="userinput"><code>--sysconfdir</code></strong>).</p>

        <p>Accordingly, we can leave out the entry for <strong class="userinput"><code>--with-nrpe-user</code></strong> and <strong class="userinput"><code>--with-nrpe-group</code></strong> in the <strong class="userinput"><code>configure</code></strong> command. Both options are relevant only if the <strong class="userinput"><code>nrpe</code></strong> program is running as a daemon, and they can be overwritten in the configuration file. If the inet daemon is used, you should specify the user with whose permissions <strong class="userinput"><code>nrpe</code></strong> should start in the configuration file for the inet daemon.</p>

        <p><strong class="userinput"><code>--enable-ssl</code></strong> ensures that NRPE communicates over an SSL-encrypted channel. This will only work, of course, if both <strong class="userinput"><code>nrpe</code></strong> on the target host and <strong class="userinput"><code>check_nrpe</code></strong> on the Nagios server have both been compiled accordingly.</p>

        <p>The command <strong class="userinput"><code>make all</code></strong> compiles the programs <strong class="userinput"><code>nrpe</code></strong> and <strong class="userinput"><code>check_nrpe</code></strong>, but it does <span class="emphasis"><em>not</em></span> copy them from <strong class="userinput"><code>/usr/local/src/nrpe-2.11/src</code></strong> to the corresponding system directories. Since there is no <strong class="userinput"><code>make install</code></strong>, you must do this yourself, following the details in <a class="xref" href="../Text/ch10.html#installation_paths_for_nrpe_and_plugins" title="Table 10-1. Installation paths for NRPE and plugins">Table 10-1</a>: you need to have <strong class="userinput"><code>nrpe</code></strong> on the computer to be monitored and the <strong class="userinput"><code>check_nrpe</code></strong> plugin on the Nagios server.</p>

        <p>If the Nagios server and the target host used the same platform, you can compile both programs on one computer (e.g., the server) and then copy <strong class="userinput"><code>nrpe</code></strong> together with its configuration file to the computer to be monitored, instead of separately compiling <strong class="userinput"><code>check_nrpe</code></strong> on the Nagios server and <strong class="userinput"><code>nrpe</code></strong> on the target system.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-10-FN-1" id="ftn.CHP-10-FN-1">96</a>]</sup> On the command line, using <strong class="userinput"><code>yast -i</code></strong> <strong class="userinput"><code><em class="replaceable"><code>package</code></em></code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-10-FN-2" id="ftn.CHP-10-FN-2">97</a>]</sup> <a class="ulink" href="http://dag.wieers.com/">http://dag.wieers.com/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-10-FN-5" id="ftn.CHP-10-FN-5">98</a>]</sup> <a class="ulink" href="http://www.nagios.org/download/">http://www.nagios.org/download/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-10-FN-6" id="ftn.CHP-10-FN-6">99</a>]</sup> The subdirectory <strong class="userinput"><code>src</code></strong> may need to be created first.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="10.2 Starting via the inet Daemon">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="starting_via_the_inet_daemon"/>10.2 Starting via the inet Daemon</h1>
    </div>

    <p>It is best to start the program <strong class="userinput"><code>nrpe</code></strong> on the machine to be monitored via the inet daemon rather than as a separate daemon, since the Nagios server only performs the tests occasionally, and <strong class="userinput"><code>nrpe</code></strong> does not need to load any large resources.<a class="indexterm" id="IDX-CHP-10-0779"/><a class="indexterm" id="IDX-CHP-10-0780"/></p>

    <p>If you have a choice, you should use the more modern <strong class="userinput"><code>xinetd</code></strong>. But to keep work to a minimum, the inet daemon will normally be used, as it is already running on the target system. In order that NRPE can be started as a service via <strong class="userinput"><code>inetd</code></strong> or <strong class="userinput"><code>xinetd</code></strong>, the <strong class="userinput"><code>nrpe</code></strong> service is defined in the file <strong class="userinput"><code>/etc/services</code></strong>:</p><a id="I_programlisting7_d1e19843"/>
    <pre class="programlisting">nrpe 5666/tcp # Nagios Remote Plugin Executor NRPE</pre>

    <p>Even if this has been installed as a package, you should still check to see whether this entry exists. By default, NRPE uses TCP port 5666.</p>

    <div class="sect2" title="10.2.1 xinetd configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="xinetd_configuration"/>10.2.1 <strong class="userinput"><code>xinetd</code></strong> configuration</h2>
      </div>

      <p>If <strong class="userinput"><code>xinetd</code></strong> is used, a separate file is stored in the directory <strong class="userinput"><code>/etc/xinetd.d</code></strong>. for each service to be started, so for <strong class="userinput"><code>nrpe</code></strong> it is best to create a file called <strong class="userinput"><code>nrpe</code></strong> or <strong class="userinput"><code>nagios-nrpe</code></strong>:</p><a id="I_programlisting7_d1e19870"/>
      <pre class="programlisting"># /etc/xinetd.d/nrpe
# description: NRPE
# default: on
service nrpe
{
   flags           =    REUSE
   socket_type     =    stream
   wait            =    no
   user            =    <span class="emphasis"><em>nobody</em></span>
   group           =    <span class="emphasis"><em>nogroup</em></span>
   server          =    <span class="emphasis"><em>/usr/local/sbin/nrpe</em></span>
   server_args     =    -c /<span class="emphasis"><em>etc/nagios/nrpe.cfg</em></span> --inetd
   log_on_failure  +=    USERID
   disable         =    no
   only_from       =    <span class="emphasis"><em>127.0.0.1 ip_of_the_nagios_server</em></span>
}</pre>

      <p>The values printed in italics are passed on to your own environment; instead of the placeholder <strong class="userinput"><code><em class="replaceable"><code>ip_of_the_nagios_server</code></em></code></strong> you should enter, for example for <strong class="userinput"><code>only_from</code></strong>, the IP address of your own Nagios server. The NRPE access from outside is then restricted to this computer and to <strong class="userinput"><code>local-host</code></strong> (<strong class="userinput"><code>127.0.0.1</code></strong>). The latter address allows local tests; multiple IP addresses are separated by a space. However, this restrictive configuration functions only if <strong class="userinput"><code>xinetd</code></strong> has been compiled with support for the TCP wrapper (this is normally the case).</p>

      <p>Under no circumstances should NRPE run with the permissions of a privileged user—<strong class="userinput"><code>nobody</code></strong> is therefore a sensible value. The <strong class="userinput"><code>server</code></strong> parameter specifies the complete path to the program <strong class="userinput"><code>nrpe;</code></strong> for <strong class="userinput"><code>server_args</code></strong> you should enter the matching path to the configuration file. After this modification, the configuration of <strong class="userinput"><code>xinetd</code></strong> is reloaded, with</p><a id="I_programlisting7_d1e19922"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/xinetd reload</strong></span></pre>
    </div>

    <div class="sect2" title="10.2.2 inetd configurationt">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="inetd_configurationt"/>10.2.2 <strong class="userinput"><code>inetd</code></strong> configurationt</h2>
      </div>

      <p>In the standard <strong class="userinput"><code>inetd</code></strong>, the following line is added to the configuration file <strong class="userinput"><code>/etc/inetd.conf</code></strong>:<a class="indexterm" id="IDX-CHP-10-0781"/><a class="indexterm" id="IDX-CHP-10-0782"/></p><a id="I_programlisting7_d1e19948"/>
      <pre class="programlisting">nrpe stream tcp nowait <span class="emphasis"><em>nobody</em></span> /usr/sbin/tcpd <span class="emphasis"><em>/usr/local/sbin/nrpe</em></span> -c/
<span class="emphasis"><em>etc/nagios/nrpe.cfg</em></span> --inetd</pre>

      <p>The line has been split up for reasons of space, but in the configuration file this must all be in a single line. Here the TCP wrapper <strong class="userinput"><code>tcpd</code></strong> is used. If this is not intended, you simply leave out this entry<sup>[<a class="footnote" href="#ftn.CHP-10-FN-7" id="CHP-10-FN-7">100</a>]</sup> Here you should also explicitly enter the user <strong class="userinput"><code>nobody</code></strong>, the complete path to the binary <strong class="userinput"><code>nrpe</code></strong>, and the configuration file, also with its complete path. These strings, printed above in italics, should be adjusted to your own system, where necessary. After the configuration change, <strong class="userinput"><code>inetd</code></strong> is reloaded:</p><a id="I_programlisting7_d1e19991"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/inetd reload</strong></span></pre>
    </div>

    <div class="sect2" title="10.2.3 Is the Inet daemon watching on the NRPE port?">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="is_the_inet_daemon_watching_on_the_nrp"/>10.2.3 Is the Inet daemon watching on the NRPE port?</h2>
      </div>

      <p>A simple test shows whether the inet daemon wants to respond to queries on port 5666:<a class="indexterm" id="IDX-CHP-10-0783"/></p><a id="I_programlisting7_d1e20005"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>netstat -lnt | grep ':5666'</strong></span>
...
tcp  0  0 0.0.0.0:5666     0.0.0.0:*   LISTEN
...</pre>

      <p>The program <strong class="userinput"><code>netstat</code></strong> uses option <strong class="userinput"><code>−1</code></strong> to display all the ports on which a service is waiting for incoming queries, that is, a service which is in the <strong class="userinput"><code>LISTEN</code></strong> state. Option <strong class="userinput"><code>-n</code></strong> suppresses the name resolution of hosts and ports and speeds up the display of information, and <strong class="userinput"><code>-t</code></strong> restricts the otput to TCP ports.<a class="indexterm" id="IDX-CHP-10-0784"/></p>

      <p>The test shows only whether the inet daemon was properly configured and newly started, for instance, whether the <strong class="userinput"><code>nrpe</code></strong> service is correctly entered in <strong class="userinput"><code>/etc/services</code></strong>. It does not clarify whether the paths to the NRPE daemon and its configuration file are correct. Errors like this are announced by the inet daemon only when a concrete access attempt takes place on NRPE port 5666. The subsequent complete function test is carried out only after the NRPE daemon has been configured. This is described in <a class="xref" href="../Text/ch10s04.html" title="10.4 NRPE Function Test">10.4 NRPE Function Test</a> from page 221.<a class="indexterm" id="IDX-CHP-10-0785"/></p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-10-FN-7" id="ftn.CHP-10-FN-7">100</a>]</sup> <strong class="userinput"><code>inetd</code></strong> does not have a built-in method to allow access to services only from specific IP addresses. This function is added in the TCP wrapper <strong class="userinput"><code>tcpd</code></strong>. The access configuration is then taken over by the files <strong class="userinput"><code>/etc/hosts.allow</code></strong> and <strong class="userinput"><code>/etc/hosts.deny</code></strong>. More information on this is given by <strong class="userinput"><code>man host_access</code></strong>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="10.3 NRPE Configuration on the Computer to Be Monitored">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="nrpe_configuration_on_the_computer_to_be"/>10.3 NRPE Configuration on the Computer to Be Monitored</h1>
    </div>

    <p>When compiling NRPE, the file <strong class="userinput"><code>nrpe.cfg</code></strong> is created in the source directory, which contains several parameters as well as the commands to run NRPE. These are copied manually to the configuration directory, which normally first has to be created on the target computer:<a class="indexterm" id="IDX-CHP-10-0786"/><a class="indexterm" id="IDX-CHP-10-0787"/></p><a id="I_programlisting7_d1e20062"/>
    <pre class="programlisting">linux:src/rnpe-2.11 # <span class="strong"><strong>mkdir /etc/nagios</strong></span>
linux:src/rnpe-2.11 # <span class="strong"><strong>cp nrpe.cfg /etc/nagios/</strong></span>.</pre>

    <p>Distribution-specific packages are unpacked from the location specified in <a class="xref" href="../Text/ch10.html#installation_paths_for_nrpe_and_plugins" title="Table 10-1. Installation paths for NRPE and plugins">Table 10-1</a> in page 215.</p>

    <p><strong class="userinput"><code>nrpe</code></strong> is given the permissions of the user at runtime specified in the inet daemon configuration, which in our case is that of <strong class="userinput"><code>nobody</code></strong>. Therefore <strong class="userinput"><code>nrpe.cfg</code></strong> needs to be readable for this user. As long as the file does not contain any passwords (these really should not be used) or other critical information, then read permissions for all can be allowed.</p>

    <p>The configuration file contains many comments; the following command displays the active parameters:<sup>[<a class="footnote" href="#ftn.CHP-10-FN-8" id="CHP-10-FN-8">101</a>]</sup></p><a id="I_programlisting7_d1e20104"/>
    <pre class="programlisting">user@linux:~$ <span class="strong"><strong>egrep -v '^#|^$' nrpe.cfg | less</strong></span>
server_port=5666
allowed_hosts=127.0.0.1
nrpe_user=nobody
nrpe_group=nogroup
dont_blame_nrpe=0
debug=0
command_timeout=60
...</pre>

    <p>The parameters <strong class="userinput"><code>server_port</code></strong>, <strong class="userinput"><code>allowed_hosts</code></strong>, <strong class="userinput"><code>nrpe_user</code></strong>, and <strong class="userinput"><code>nrpe_group</code></strong> are only relevant if <strong class="userinput"><code>nrpe</code></strong> is working as a daemon. When the inet daemon is used, the program ignores these values since they have already been determined by the <strong class="userinput"><code>(x) indetd</code></strong> configuration.</p>

    <p>The entry <strong class="userinput"><code>dont_blame_nrpe=0</code></strong> prevents <strong class="userinput"><code>nrpe</code></strong> from accepting parameters, thus closing a potential security hole. <strong class="userinput"><code>debug=l</code></strong> allows extensive logging, useful if you are looking for errors (<strong class="userinput"><code>debug=0</code></strong> switches off the output for debugging information), and <strong class="userinput"><code>command_timeout</code></strong> specifies a timespan in seconds after which <strong class="userinput"><code>nrpe</code></strong> abruptly interrupts a plugin that has hung. Comments in the configuration file explain all these parameters as well.</p>

    <p>After this, the commands are defined that are to be executed by NRPE. The configuration file <strong class="userinput"><code>nrpe.cfg</code></strong> already contains some, but first they all have to be commented out, and only those commands activated that really are intended for use.</p>

    <p>The keyword <strong class="userinput"><code>command</code></strong> is followed in square brackets by the name with which <strong class="userinput"><code>check_nrpe</code></strong> should call the command. After the equals sign (=), the corresponding plugin command is specified, with its complete path:<sup>[<a class="footnote" href="#ftn.CHP-10-FN-9" id="CHP-10-FN-9">102</a>]</sup></p><a id="I_programlisting7_d1e20184"/>
    <pre class="programlisting">command[check_users]=/usr/local/nagios/libexec/check_users -w 5 -c 10
command[check_load]=/usr/lib/nagios/libexec/check_load -w 8,5,3 -c 15,10,7
command[check_zombies]=/usr/lib/nagios/libexec/check_procs -w :1 -c :2 -s Z</pre>

    <p>With the path, care must be taken that this really does point to the local plugin directory. In the directory specified here, <strong class="userinput"><code>/usr/local/nagios/libexec</code></strong>, the self-compiled plugins are located<sup>[<a class="footnote" href="#ftn.CHP-10-FN-10" id="CHP-10-FN-10">103</a>]</sup>; and for installations from distribution packages the path is usually <strong class="userinput"><code>/usr/lib/nagios/plugins</code></strong>.</p>

    <p>From the Nagios server, the command just defined, <strong class="userinput"><code>check_users</code></strong> is now run on the <span class="emphasis"><em>target computer</em></span> via <strong class="userinput"><code>check_nrpe</code></strong>:</p><a id="I_programlisting7_d1e20209"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_nrpe -H</strong></span> <span class="bolditalic">target_host</span> <span class="strong"><strong>-c check_users</strong></span></pre>

    <div class="sect2" title="10.3.1 Passing parameters on to local plugins">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="passing_parameters_on_to_local_plugins"/>10.3.1 Passing parameters on to local plugins</h2>
      </div>

      <p>The method described so far has one disadvantage: for each test on the target system, a separately defined command is required for this. Here is the example of a server on which the plugin <strong class="userinput"><code>check_disk</code></strong> (see <a class="xref" href="../Text/ch07.html#free_hard_drive_capacity" title="7.1 Free Hard Drive Capacity">7.1 Free Hard Drive Capacity</a> from page 158) is required to monitor nine file systems:<a class="indexterm" id="IDX-CHP-10-0788"/><a class="indexterm" id="IDX-CHP-10-0789"/><a class="indexterm" id="IDX-CHP-10-0790"/><a class="indexterm" id="IDX-CHP-10-0791"/></p><a id="I_programlisting7_d1e20251"/>
      <pre class="programlisting">command[check_disk_a]=<span class="emphasis"><em>path/to/</em></span>check_disk -w 5% -c 2% -p /net/linux01/a
command[check_disk_b]=<span class="emphasis"><em>path/to/</em></span>check_disk -w 4% -c 2% -p /net/linux01/b
command[check_disk_c]=<span class="emphasis"><em>path/to/</em></span>check_disk -w 5% -c 2% -p /net/linux01/c
command[check_disk_d]=<span class="emphasis"><em>path/to/</em></span>check_disk -w 5% -c 2% -p /net/linux01/d
command[check_disk_root]=<span class="emphasis"><em>path/to/</em></span>check_disk -w 10% -c 5% -p /
command[check_disk_usr]=<span class="emphasis"><em>path/to/</em></span>check_disk -w 10% -c 5% -p /usr
command[check_disk_var]=<span class="emphasis"><em>path/to/</em></span>check_disk -w 10% -c 5% -p /var
command[check_disk_home]=<span class="emphasis"><em>path/to/</em></span>check_disk -w 10% -c 5% -p /home
command[check_disk_tmp]=<span class="emphasis"><em>path/to/</em></span>check_disk -w 10% -c 5% -p /tmp</pre>

      <p>To avoid all this work, NRPE can also be configured so that parameters may be passed on to <strong class="userinput"><code>check_nrpe</code></strong>:</p><a id="I_programlisting7_d1e20286"/>
      <pre class="programlisting">dont_blame_nrpe=1
...
command[check_disk]=<span class="emphasis"><em>path/to/</em></span>check_disk -w $ARG1$ -c $ARG2$ -p $ARG3$</pre>

      <p>In order for this to work, the NRPE <strong class="userinput"><code>configure</code></strong> script must be run with the option</p>

      <p><strong class="userinput"><code>--enable-command-args</code></strong>. The reason for this inconvenient procedure is that passing parameters on is a fundamental risk, since it cannot be ruled out that a certain choice of parameters could cause an (as yet unknown) buffer overflow, allowing the target system to be penetrated.</p>

      <p>If you still decide on this, despite all the security risks, you should use a TCP wrapper (see <a class="xref" href="../Text/ch10s02.html#inetd_configurationt" title="10.2.2 inetd configurationt">10.2.2 inetd configurationt</a>, page 217), to ensure that only the Nagios server itself is allowed to send commands to NRPE.</p>

      <p>If the plugin provides the corresponding options, there is sometimes a third method, however: the above-mentioned problem can also be solved by getting <strong class="userinput"><code>check_disk</code></strong>, if necessary, to test all file systems with one single command:</p><a id="I_programlisting7_d1e20309"/>
      <pre class="programlisting">user@linux:nagios/libexec$ <span class="strong"><strong>./check_disk -w 10% -c 4% -e -m</strong></span>
DISK WARNING [2588840 kB (5%) free on /net/linux1/b] [937160 kB (5%) free on
 /net/linux1/c]</pre>

      <p>The <strong class="userinput"><code>-e</code></strong> parameter persuades the plugin to display only those file systems that produced a warning or an error. One restriction remains: the warning and critical limits are, by necessity, the same for all file systems.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-10-FN-8" id="ftn.CHP-10-FN-8">101</a>]</sup> The regular expression <strong class="userinput"><code>^#|^$</code></strong> matches all lines that either begin with a comment sign <strong class="userinput"><code>#</code></strong> or that consist of an empty line. The option <strong class="userinput"><code>-v</code></strong> ensures that <strong class="userinput"><code>egrep</code></strong> shows all lines that are <span class="emphasis"><em>not</em></span> matched by this.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-10-FN-9" id="ftn.CHP-10-FN-9">102</a>]</sup> The <strong class="userinput"><code>check_users</code></strong> command is explained in <a class="xref" href="../Text/ch07s06.html" title="7.6 Keeping Tabs on the Number of Logged-In Users">7.6 Keeping Tabs on the Number of Logged-In Users</a> from page 177, <strong class="userinput"><code>check_load</code></strong> is explained in <a class="xref" href="../Text/ch07s03.html" title="7.3 Testing the System Load">7.3 Testing the System Load</a> from page 162, and <a class="xref" href="../Text/ch07s04.html" title="7.4 Monitoring Processes">7.4 Monitoring Processes</a> from page 163 deals with <strong class="userinput"><code>check_procs</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-10-FN-10" id="ftn.CHP-10-FN-10">103</a>]</sup> ... provided you have followed the instructions in the book.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="10.4 NRPE Function Test">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="nrpe_function_test"/>10.4 NRPE Function Test</h1>
    </div>

    <p>For a concluding function test, the plugin <strong class="userinput"><code>check_nrpe</code></strong> on the Nagios server is called. The command <strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>target</code></em></code></strong> <strong class="userinput"><code>host</code></strong> returns the IP address specified for the server on which the NRPE service has just been installed:<a class="indexterm" id="IDX-CHP-10-0792"/></p><a id="I_programlisting7_d1e20342"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_nrpe -H swobspace</strong></span>
CHECK_NRPE: Error - Could not complete SSL handshake.</pre>

    <p>The error message given here occurs very frequently and causes confusion almost as often because although problems may occur with the SSL handshake, the cause is to be found elsewhere in most cases. You only have an SSL problem if the SSL versions used by the plugin <strong class="userinput"><code>check_nrpe</code></strong> and the <strong class="userinput"><code>NRPE daemon</code></strong> addressed are incompatible or if one of the two software packages was compiled without SSL and the other was compiled with SSL.</p>

    <p>Otherwise, the cause will lie elsewhere: The problem could be caused by an error in the configuration file, the inet daemon being unable to find the NRPE program or configuration file, or access permissions for the file <strong class="userinput"><code>nrpe.cfg</code></strong> that are not sufficient. You would also receive the error message mentioned if the Nagios server cannot access the NRPE service at all via the inetd configuration. In this case, you need to check the parameter <strong class="userinput"><code>only_from</code></strong> for <strong class="userinput"><code>xinetd</code></strong> or the same restrictions via the <strong class="userinput"><code>tcpd</code></strong> for <strong class="userinput"><code>inetd</code></strong>.</p>

    <p>You can search for the exact cause of error in the syslog files, particularly in the file <strong class="userinput"><code>messages</code></strong>, and depending on the distribution, also in <strong class="userinput"><code>warn.log</code></strong>, <strong class="userinput"><code>daemon.log</code></strong>, or another log file:</p><a id="I_programlisting7_d1e20383"/>
    <pre class="programlisting">linux:~ # <span class="strong"><strong>grep nrpe /var/log/messages</strong></span>
...
nrpe[19844]: Unable to open config file '/etc/nagios/nrpe.cfg' for reading
nrpe[19844]: Config file '/etc/nagios/nrpe.cfg' contained errors, aborting...
...</pre>

    <p>In this example, the file <strong class="userinput"><code>nrpe.cfg</code></strong> is either not in the path being searched or <strong class="userinput"><code>nrpe</code></strong> cannot open it. Since <strong class="userinput"><code>nrpe</code></strong> is running with the permissions of the user <strong class="userinput"><code>nobody</code></strong>, it must also be able to read the configuration file.</p>

    <p>A successful call of <strong class="userinput"><code>check_nrpe</code></strong> will then provide the version of the installed NRPE service:</p><a id="I_programlisting7_d1e20407"/>
    <pre class="programlisting">nagios@linux:nagios/libexec$ <span class="strong"><strong>./check_nrpe -H swobspace</strong></span>
NRPE v2.11</pre>
  </div>


  <div class="sect1" title="10.5 Nagios Configuration">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="nagios_configuration-id2"/>10.5 Nagios Configuration</h1>
    </div>

    <p>Commands that "trigger" local plugins on remote computers via <strong class="userinput"><code>check_nrpe</code></strong> are defined as before in the file <strong class="userinput"><code>checkcommands.cfg</code></strong> on the Nagios server.<a class="indexterm" id="IDX-CHP-10-0793"/></p>

    <div class="sect2" title="10.5.1 NRPE without passing parameters on">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="nrpe_without_passing_parameters_on"/>10.5.1 NRPE without passing parameters on</h2>
      </div>

      <p>If no parameters are passed on to the target plugin, things will look like this:</p><a id="I_programlisting7_d1e20433"/>
      <pre class="programlisting">define command{
    command_name check_nrpe
    command_line $USER1$/<span class="strong"><strong>check_nrpe</strong></span> -H $HOSTADDRESS$ -c $ARG1$
}</pre>

      <p>As the only argument, Nagios passes the command here that NRPE is to execute. If the <strong class="userinput"><code>check_nrpe</code></strong> plugin on the Nagios server is located in a different directory to the other plugins, you must enter the correct path instead of <strong class="userinput"><code>$USER1$</code></strong>.</p>

      <p>A service to be tested via NRPE uses the command just defined, <strong class="userinput"><code>check_nrpe</code></strong>, as <strong class="userinput"><code>check_command</code></strong>. As an argument, the command is specified that was defined in <strong class="userinput"><code>nrpe.cfg</code></strong> on the target system (here: <strong class="userinput"><code>linux04</code></strong>):</p><a id="I_programlisting7_d1e20460"/>
      <pre class="programlisting">define service{
    host_name           linux04
    service_description FS_var
    ...
   check_command check_nrpe!check_disk_var
   ...
}</pre>
    </div>

    <div class="sect2" title="10.5.2 Passing parameters on in NRPE">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="passing_parameters_on_in_nrpe"/>10.5.2 Passing parameters on in NRPE</h2>
      </div>

      <p>In order to address the command defined in <a class="xref" href="../Text/ch10s03.html#passing_parameters_on_to_local_plugins" title="10.3.1 Passing parameters on to local plugins">10.3.1 Passing parameters on to local plugins</a> in page 220<a class="indexterm" id="IDX-CHP-10-0794"/></p><a id="I_programlisting7_d1e20474"/>
      <pre class="programlisting">command[check_disk]=<span class="emphasis"><em>path/to/</em></span>check_disk -w $ARG1$ -c $ARG2$ -p $ARG3$</pre>

      <p>from the Nagios server, the <strong class="userinput"><code>check_nrpe</code></strong> is given the corresponding arguments through the option <strong class="userinput"><code>-a</code></strong>:</p><a id="I_programlisting7_d1e20487"/>
      <pre class="programlisting">define command{
    command_name check_nrpe
    command_line $USER1$/<span class="strong"><strong>check_nrpe</strong></span> -H $HOSTADDRESS$ -c $ARG1$ -a $ARG2$
}</pre>

      <p>So that <strong class="userinput"><code>$ARG2$</code></strong> can correctly transport the parameters for the remote plugin, these are separated by spaces in the service definition. in addition, you should ensure that the order is correct:</p><a id="I_programlisting7_d1e20497"/>
      <pre class="programlisting">define service{
    host_name           linux04
    service_description FS_var
    ...
 <span class="strong"><strong>check_command check_nrpe!check_disk!10% 5% /var</strong></span>
    ...
}</pre>

      <p>The locally installed <strong class="userinput"><code>check_disk</code></strong> on <strong class="userinput"><code>linux04</code></strong> distributes the three strings <strong class="userinput"><code>10%, 5%</code></strong>, and /var to its own three macros <strong class="userinput"><code>$ARG1$</code></strong>, <strong class="userinput"><code>$ARG2$</code></strong>, and <strong class="userinput"><code>$ARG3$</code></strong> for the command defined in <strong class="userinput"><code>nrpe.cfg</code></strong>.</p>
    </div>

    <div class="sect2" title="10.5.3 Optimizing the configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="optimizing_the_configuration"/>10.5.3 Optimizing the configuration</h2>
      </div>

      <p>If the NRPE commands are given identical names on all target systems, then all NRPE commands with the same name can be included in a single service definition. When doing this you can make use of the possibility of specifying several hosts, or even an entire group of hosts:</p><a id="I_programlisting7_d1e20531"/>
      <pre class="programlisting">define service{
    host_name       <span class="strong"><strong>linux04,linux02,linux11</strong></span>
    service_description FS_var
    ...
    check_command check_nrpe!check_disk_var
    ...
}</pre>

      <p>With the command <strong class="userinput"><code>check_disk_var</code></strong>, defined at the beginning of <a class="xref" href="../Text/ch10s03.html#passing_parameters_on_to_local_plugins" title="10.3.1 Passing parameters on to local plugins">10.3.1 Passing parameters on to local plugins</a> in page 220, Nagios now checks the <strong class="userinput"><code>/var</code></strong> file systems on the computers <strong class="userinput"><code>linux04</code></strong>, <strong class="userinput"><code>linux02</code></strong>, and <strong class="userinput"><code>linux11</code></strong>. If other file systems are to be included in the test, a separate service is created for each one, thus avoiding the security problem involved in passing parameters on. If you use the option of testing all file systems at the same time, with the <strong class="userinput"><code>check_disk</code></strong> plugin (see <a class="xref" href="../Text/ch07.html#free_hard_drive_capacity" title="7.1 Free Hard Drive Capacity">7.1 Free Hard Drive Capacity</a>), then ultimately, one single service definition is sufficient to monitor all file systems on all Linux servers— provided you have a corresponding NRPE configuration on the target system:</p><a id="I_programlisting7_d1e20561"/>
      <pre class="programlisting">define service{
 <span class="strong"><strong>hostgroup_name     linux-servers</strong></span>
    service_description Disks
    ...
    check_command check_nrpe!check_disk
    ...
}</pre>
    </div>
  </div>


  <div class="sect1" title="10.6 Indirect Checks">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="indirect_checks"/>10.6 Indirect Checks</h1>
    </div>

    <p>NRPE executes not just local plugins, but any plugins that are available. If you use network plugins via NRPE, these are referred to as <span class="emphasis"><em>indirect checks</em></span>, as illustrated graphically in <a class="xref" href="../Text/ch10s06.html#indirect_checks_with_nrpe" title="Figure 10-1. Indirect checks with NRPE">Figure 10-1</a>.<a class="indexterm" id="IDX-CHP-10-0795"/><a class="indexterm" id="IDX-CHP-10-0796"/><a class="indexterm" id="IDX-CHP-10-0797"/><a class="indexterm" id="IDX-CHP-10-0798"/><a class="indexterm" id="IDX-CHP-10-0799"/></p>

    <div class="figure">
      <a id="indirect_checks_with_nrpe"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject7_d1e20598"/><img alt="Indirect checks with NRPE" src="../Images/tagoreillycom20081104nostarchimages223814.png"/></div>

      <p class="title">Figure 10-1. Indirect checks with NRPE</p>
    </div>

    <p>If every network service was tested directly across the firewall, it would have to open all the required ports. In the example, these would be the ports for SMTP, HTTP, LDAP, PostgreSQL, and SSH. If the checks are performed indirectly from a computer that is behind the firewall, on the other hand, then it is sufficient just to have the port for NRPE (TCP port 5666) open on the firewall. As long as it is configured via NRPE, the NRPE server behind the firewall can perform any tests it wants.</p>

    <p>Whether the effort involved in indirect checks is greater than that for direct ones is dependent on the specific implementation: if this means that you would have to "drill holes into your firewall," then the additional work on the NRPE server may be worthwhile. But if the ports involved are open anyway, then the direct test can usually be recommended; this would make additional configuration work on an NRPE host unnecessary.</p>
  </div>


  <div class="chapter" title="Chapter&#xA0;11.&#xA0;Collecting Information Relevant for Monitoring with SNMP">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="collecting_information_relevant_for_moni"/>Chapter 11. Collecting Information Relevant for Monitoring with SNMP</h1>
    </div>

    <p>SNMP stands for <span class="emphasis"><em>Simple Network Management Protocol</em></span>, a protocol defined above all to monitor and manage network devices. This means being able to have not only read access, but also write access to network devices, so that you can turn a specific port on a switch on or off, or intervene in other ways.<a class="indexterm" id="IDX-CHP-11-0800"/></p>

    <p>Nearly all network-capable devices that can also be addressed via TCP/IP can handle SNMP, and not just switches and routers. For Unix systems there are SNMP daemons; even Windows servers contain an SNMP implementation in their standard distribution, although this must be explicitly installed. But even uninterruptible power supplies (UPSs) or network-capable sensors are SNMP-capable.</p>

    <p>If you are using Nagios, then at some point you can't avoid coming into contact with SNMP, because although you usually have a great choice of querying techniques for Unix and Windows systems, when it comes to hardware-specific components such as switches, without their own sophisticated operating system, then SNMP is often the only way to obtain information from the network device. SNMP certainly does not have a reputation of being easy to understand, which among other things lies in the fact that it is intended for communication between programs, and machine processing is in the foreground. In addition, you generally do not make direct contact with the protocol and with the original information, since even modems or routers provide a simple-to-operate interface that disguises the complexity of the underlying SNMP.</p>

    <p>If you want to use SNMP with Nagios, you cannot avoid getting involved with the information structure of the protocol. <a class="xref" href="../Text/ch11.html#introduction_to_snmp" title="11.1 Introduction to SNMP">11.1 Introduction to SNMP</a> therefore provides a short introduction to SNMP. <a class="xref" href="../Text/ch11s02.html" title="11.2 NET-SNMP">11.2 NET-SNMP</a> from page 234 introduces NET-SNMP, probably the most widely used implementation for SNMP on Unix systems. On the one hand it shows how to obtain an overview of the information structure of a network device with command-line tools, and on the other it describes the configuration of the SNMP daemon in Linux. Finally, <a class="xref" href="../Text/ch11s03.html" title="11.3 Nagios's Own SNMP Plugins">11.3 Nagios's Own SNMP Plugins</a> from page 246 is devoted to the concrete use of SNMP with Nagios.</p>

    <div class="sect1" title="11.1 Introduction to SNMP">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="introduction_to_snmp"/>11.1 Introduction to SNMP</h1>
      </div>

      <p>Although SNMP contains the P for "protocol" in its name, this does not stand for a protocol alone, but is used as a synonym for the <span class="emphasis"><em>Internet Standard Management Framework</em></span>. This consists of the following components:<a class="indexterm" id="IDX-CHP-11-0801"/><a class="indexterm" id="IDX-CHP-11-0802"/><a class="indexterm" id="IDX-CHP-11-0803"/><a class="indexterm" id="IDX-CHP-11-0804"/></p>

      <div class="itemizedlist">
        <ul class="itemizedlist">
          <li class="listitem">
            <p>Manageable network nodes that can be controlled remotely via SNMP. A specific implementation of an SNMP engine, whether by software or hardware, is referred to as an <span class="emphasis"><em>agent</em></span>.</p>
          </li>

          <li class="listitem">
            <p>At least one SNMP unit consisting of applications with which the agents can be managed. This unit is referred to as a <span class="emphasis"><em>manager</em></span>.</p>
          </li>

          <li class="listitem">
            <p>A protocol with which agent and manager can exchange information: the <span class="emphasis"><em>Simple Network Management Protocol</em></span> (SNMP).</p>
          </li>

          <li class="listitem">
            <p>A well-defined information structure, so that any managers and agents can understand each other: the so-called <span class="emphasis"><em>Management Information Base</em></span>, or in short, MIB.<a class="indexterm" id="IDX-CHP-11-0805"/></p>
          </li>
        </ul>
      </div>

      <p>The framework assigns the manager the active role. The agent itself just waits passively for incoming commands. In addition, so-called <span class="emphasis"><em>traps</em></span> extend the application possibilities of SNMP: these are messages that the agent actively sends to a single manager or a whole group of managers, for example if predefined limit values are exceeded or if functions of the network device fail.</p>

      <p>As agents, SNMP engines implemented by the manufacturer are used for hardware-specific devices (switches, routers). For Linux and general Unix systems, the NET-SNMP implementation is available (see <a class="xref" href="../Text/ch11s02.html" title="11.2 NET-SNMP">11.2 NET-SNMP</a>), for Windows servers there is equivalent software already included with the operating system.</p>

      <p>In combination with Nagios, there are two possibilities. With respect to Nagios in the active role, corresponding Nagios plugins, as the manager, ask the agents for the desired information. The other way round, Nagios can also passively receive incoming SNMP traps using utilities and process these. <a class="xref" href="../Text/ch14s06.html" title="14.6 Application Example II: Processing SNMP Traps">14.6 Application Example II: Processing SNMP Traps</a> from page 312 is devoted to this topic.</p>

      <p>An understanding of the SNMP information structure, the so-called <span class="emphasis"><em>Management Information Base</em></span> (MIB), is critical if you want to use SNMP with Nagios successfully. For this reason this section will focus on this. The protocol itself is only mentioned briefly to illustrate the differences between different protocol versions.</p>

      <p>If you want to get involved more deeply with SNMP, we refer you to the numerous <span class="emphasis"><em>Request for Comments</em></span> (RFCs) describing SNMP. The best place to start would be in RFC 3410, "Introduction and Applicability Statements for Internet Standard Management Framework", and RFC 3411: "An Architecture for Describing Simple Network Management Protocol (SNMP) Management Frameworks." Apart from an introduction and numerous crosslinks, you will also find references there to the original documents of the older versions, today referred to as SNMPv1 and SNMPv2.<a class="indexterm" id="IDX-CHP-11-0806"/></p>

      <div class="sect2" title="11.1.1 The Management Information Base">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="the_management_information_base"/>11.1.1 The Management Information Base</h2>
        </div>

        <p>The SNMP information structure consists of a hierarchical namespace construction of numbers. <a class="xref" href="../Text/ch11.html#snmp_namespace_using_the_example_of_the" title="Figure 11-1. SNMP namespace using the example of the MIB-II interfaces">Figure 11-1</a> shows an extract from this. The tree structure is similar to those of other hierarchical directory services, such as DNS or LDAP.<a class="indexterm" id="IDX-CHP-11-0807"/><a class="indexterm" id="IDX-CHP-11-0808"/><a class="indexterm" id="IDX-CHP-11-0809"/><a class="indexterm" id="IDX-CHP-11-0810"/></p>

        <p>Its root is called <strong class="userinput"><code>1 (iso)</code></strong> and stands for the <span class="emphasis"><em>International Organization for Standardization</em></span>. The next level, <strong class="userinput"><code>3 (org)</code></strong> shown in <a class="xref" href="../Text/ch11.html#snmp_namespace_using_the_example_of_the" title="Figure 11-1. SNMP namespace using the example of the MIB-II interfaces">Figure 11-1</a> provides a space for general, national and international organizations. Beneath this is <strong class="userinput"><code>6 (dod)</code></strong> for the U.S. <span class="emphasis"><em>Department of Defense</em></span>. The general (IP-based) <strong class="userinput"><code>internet</code></strong> owes its assignment as a subitem <strong class="userinput"><code>1 (internet)</code></strong> of <strong class="userinput"><code>dod</code></strong> to its origin as a military project.<a class="indexterm" id="IDX-CHP-11-0811"/></p>

        <p>If you bring together the corresponding numbers from left to right and separate them with the dot, then for the <strong class="userinput"><code>internet</code></strong> node in the tree, you arrive at the designation <strong class="userinput"><code>1.3.6.1</code></strong>. Such nodes are referred to in general as <span class="emphasis"><em>object identifiers</em></span> (OID). Their syntax is used not only in SNMP but also in the definition of LDAP objects and attributes, for example.<a class="indexterm" id="IDX-CHP-11-0812"/></p>

        <p>The OID <strong class="userinput"><code>1.3.6.1</code></strong> is not exactly easily readable for humans, which is why other notation methods have gained acceptance: both <strong class="userinput"><code>iso.org.dod.internet</code></strong> and the combination <strong class="userinput"><code>iso(1).org(3).dod(6).internet(1)</code></strong> is allowed. Because this would quickly make readable descriptions infinitely long if the tree were deep enough, another abbreviated notation method has become established: as long as the term remains unique, you may simply write <strong class="userinput"><code>internet</code></strong> instead of <strong class="userinput"><code>1.3.6.1</code></strong>.</p>

        <p>The important thing here is that the communication between manager and agent is exclusively of a numerical nature. Whether the manager also allows text input or is capable of issuing information as text instead of as a numeric OID depends on the implementation in each case. The information on individual nodes is provided by the manufacturer of the SNMP agent as a Management Information Base (MIB) in file form.</p>

        <div class="figure">
          <a id="snmp_namespace_using_the_example_of_the"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject8_d1e20803"/><img alt="SNMP namespace using the example of the MIB-II interfaces" src="../Images/tagoreillycom20081104nostarchimages223816.png"/></div>

          <p class="title">Figure 11-1. SNMP namespace using the example of the MIB-II interfaces</p>
        </div>

        <p>The data stored in the MIB includes contact information (who designed the MIB; usually the manufacturer of the device will be given here), the definition of individual subnodes and attributes, and the data types used. If an MIB file also describes the individual subnodes and attributes, this puts the manager in a position to supply the user with additional information on the meaning and purpose of the entry in question.</p>

        <p>Below <strong class="userinput"><code>internet</code></strong>, the next level is divided into various namespaces. The management node <strong class="userinput"><code>1.3.6.1.2</code></strong> is especially important for SNMP, that is, <strong class="userinput"><code>iso(1) .org(3) .dod(6) .internet(1) .mgmt(2)</code></strong>. The namespace here is described by RFC 1155, "Structure and Identification of Management Information for TCP/IP-based Internets."</p>

        <p>In order for manager and agent to be able to understand each other, the manager needs to know how the agent structures its data. This is where the <span class="emphasis"><em>Management Information Base, Version II</em></span> comes into play. SNMP requests information from the agents on their implementation; with this, every manager can access the most important parameters of the agent, without a previous exchange of MIB definitions. The <span class="emphasis"><em>Management Information Base II</em></span>, or MIB-II (or mib-2) for short, can be found in the namespace at <strong class="userinput"><code>1.3.6.1.2.1</code></strong> or <strong class="userinput"><code>iso(1).org(3).dod(6).internet(1).mgmt(2).mib-2(1)</code></strong>. Since it is well-defined and unique, OIDs lying beneath that are usually described in short, starting with MIB-II or mib-2.<a class="indexterm" id="IDX-CHP-11-0813"/></p>

        <p>Manufacturer-specific information can also be defined in your own Management Information Base. Corresponding MIBs are located beneath <strong class="userinput"><code>internet.private.enterprise</code></strong>. Once an OID has been described in an MIB, the meaning of this entry may never be changed. The description format for an MIB is standardized by RFC 1212, which is the reason that special MIBs, included by a vendor for its agents, can be integrated into almost any manager.</p>

        <div class="sect3" title="MIB-II">
          <div class="titlepage">
            <h3 class="title" id="heading_id_5"><a id="mib-ii"/>MIB-II</h3>
          </div>

          <p>MIB-II, the Management Information Base, which is obligatory for all SNMP agents, contains several information groups. The most important of these are summarized in <a class="xref" href="../Text/ch11.html#mib-ii_groups_open_parenthesis_a_selecti" title="Table 11-1. MIB-II groups (a selection)">Table 11-1</a>. The notation <strong class="userinput"><code>mib-2.</code></strong><strong class="userinput"><code><em class="replaceable"><code>x</code></em></code></strong> stands for <strong class="userinput"><code>1.3.6.1.2.1.</code></strong><strong class="userinput"><code><em class="replaceable"><code>x</code></em></code></strong>.<a class="indexterm" id="IDX-CHP-11-0814"/><a class="indexterm" id="IDX-CHP-11-0815"/><a class="indexterm" id="IDX-CHP-11-0816"/><a class="indexterm" id="IDX-CHP-11-0817"/><a class="indexterm" id="IDX-CHP-11-0818"/><a class="indexterm" id="IDX-CHP-11-0819"/></p>

          <div class="table">
            <a id="mib-ii_groups_open_parenthesis_a_selecti"/>

            <p class="title">Table 11-1. MIB-II groups (a selection)</p>

            <div class="table-contents">
              <table class="sgc-3" summary="MIB-II groups (a selection)">
                <colgroup>
                  <col/>
                  <col/>
                  <col/>
                </colgroup>

                <thead>
                  <tr>
                    <th class="sgc-1" valign="bottom">
                      <p>Group</p>
                    </th>

                    <th class="sgc-1" valign="bottom">
                      <p>OID</p>
                    </th>

                    <th class="sgc-1" valign="bottom">
                      <p>Description</p>
                    </th>
                  </tr>
                </thead>

                <tbody>
                  <tr>
                    <td class="sgc-2" valign="top">
                      <p>system</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>mib-2.1</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>Information on the device, (e.g., the location, contact partner, or uptime)</p>
                    </td>
                  </tr>

                  <tr>
                    <td class="sgc-2" valign="top">
                      <p>interfaces</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>mib-2.2</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>Information on the network interfaces (Name, interface type, status, statistics etc.)</p>
                    </td>
                  </tr>

                  <tr>
                    <td class="sgc-2" valign="top">
                      <p>at</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>mib-2.3</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>Assignment of physical addresses (e.g., of MAC addresses) to the IP address <span class="emphasis"><em>(Address Translation Table)</em></span></p>
                    </td>
                  </tr>

                  <tr>
                    <td class="sgc-2" valign="top">
                      <p>ip</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>mib-2.4</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>Routing tables and IP packet statistics</p>
                    </td>
                  </tr>

                  <tr>
                    <td class="sgc-2" valign="top">
                      <p>icmp</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>mib-2.5</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>Statistics on individual ICMP packet types</p>
                    </td>
                  </tr>

                  <tr>
                    <td class="sgc-2" valign="top">
                      <p>tcp</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>mib-2.6</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>Open ports and existing TCP connections</p>
                    </td>
                  </tr>

                  <tr>
                    <td class="sgc-2" valign="top">
                      <p>udp</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>mib-2.7</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>ditto for UDP</p>
                    </td>
                  </tr>

                  <tr>
                    <td class="sgc-2" valign="top">
                      <p>host</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>mib-2.25</p>
                    </td>

                    <td class="sgc-2" valign="top">
                      <p>Information on storage media, devices, running processes and their use of resources</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <p>How you specifically handle information stored in the MIB-II can be explained using the example of the <span class="emphasis"><em>interfaces</em></span> group: <a class="xref" href="../Text/ch11.html#snmp_namespace_using_the_example_of_the" title="Figure 11-1. SNMP namespace using the example of the MIB-II interfaces">Figure 11-1</a> shows how they are split up into the two OID <strong class="userinput"><code>interfaces.if Number</code></strong> and <strong class="userinput"><code>interfaces.if Table</code></strong>. This is because one network node initially reveals an unknown number of interfaces. This number is taken up by <strong class="userinput"><code>ifNumber</code></strong>. Before looking at these interfaces more closely, a manager can get the information from <strong class="userinput"><code>ifNumber</code></strong> about how many there really are.</p>

          <p><strong class="userinput"><code>ifTable</code></strong> then contains the actual information on the different interfaces. To obtain this information for a specific interface, the manager queries all the entries in which the last number is the same, like this:</p><a id="I_programlisting8_d1e21019"/>
          <pre class="programlisting">ifEntry.ifIndex.1 = INTEGER: 1
ifEntry.ifDescr.1 = STRING: eth0
ifEntry.ifType.1 = INTEGER: ethernetCsmacd(6)
ifEntry.ifMtu.1 = INTEGER: 1500
ifEntry.ifSpeed.1 = Gauge32: 100000000
ifEntry.ifPhysAddress.1 = STRING: 0:30:5:6b:70:70
ifEntry.ifAdminStatus.1 = INTEGER: up(1)
ifEntry.ifOperStatus.1 = INTEGER: up(1)</pre>

          <p><strong class="userinput"><code>ifIndex</code></strong> describes the device-internal index—SNMP always starts counting from <strong class="userinput"><code>1</code></strong>, switches start counting here from <strong class="userinput"><code>100</code></strong>. <strong class="userinput"><code>ifDescr</code></strong> contains the name of the interface, here <strong class="userinput"><code>eth0</code></strong>—this is obviously a Linux machine. It can be assumed from the next four entries that a normal 100-Mbit Ethernet interface is involved.<a class="indexterm" id="IDX-CHP-11-0820"/></p>

          <p>The interface type <strong class="userinput"><code>ifType</code></strong> is given as <strong class="userinput"><code>ethernetCsmacd</code></strong>,<sup>[<a class="footnote" href="#ftn.CHP-11-FN-1" id="CHP-11-FN-1">104</a>]</sup> that is, Ethernet. <strong class="userinput"><code>ifMtu</code></strong> specifies the <span class="emphasis"><em>Maximum Transfer Unit</em></span>, which in local networks is always 1,500 bytes for Ethernet. The interface speed <strong class="userinput"><code>ifSpeed</code></strong> is 100,000,000 bits here, that is, 100 Mbit. And <strong class="userinput"><code>ifPhysAddress</code></strong> contains the physical network address, also called the MAC address.</p>

          <p><strong class="userinput"><code>ifAdminStatus</code></strong> reveals whether the admin has switched the interface on (<strong class="userinput"><code>up</code></strong>) or off (<strong class="userinput"><code>down</code></strong>) via the configuration. <strong class="userinput"><code>ifOperStatus</code></strong> on the other hand specifies the actual status, since even interfaces activated by an administrator are not necessarily connected to a device, or even switched on.</p>

          <p>There is a similar picture for the second interface:</p><a id="I_programlisting8_d1e21085"/>
          <pre class="programlisting">ifEntry.ifIndex.2 = INTEGER: 2
ifEntry.ifDescr.2 = STRING: lo
ifEntry.ifType.2 = INTEGER: softwareLoopback(24)
ifEntry.ifMtu.2 = INTEGER: 16436
ifEntry.ifSpeed.2 = Gauge32: 10000000
ifEntry.ifPhysAddress.2 = STRING:
ifEntry.ifAdminStatus.2 = INTEGER: up(1)
ifEntry.ifOperStatus.2 = INTEGER: up(1)
...</pre>

          <p>This is not an Ethernet card here, however, but a local loopback device.</p>
        </div>
      </div>

      <div class="sect2" title="11.1.2 SNMP protocol versions">
        <div class="titlepage">
          <h2 class="title" id="heading_id_6"><a id="snmp_protocol_versions"/>11.1.2 SNMP protocol versions</h2>
        </div>

        <p>The first SNMP version and <span class="emphasis"><em>Internet Standard Management Framework</em></span> were described back in 1988 in RFCs 1065–1067; the current documentation on this version, named SNMPv1, can be found in RFC 1155–1157. It is still used today, since higher versions are fundamentally backward-compatible.<a class="indexterm" id="IDX-CHP-11-0821"/><a class="indexterm" id="IDX-CHP-11-0822"/><a class="indexterm" id="IDX-CHP-11-0823"/><a class="indexterm" id="IDX-CHP-11-0824"/><a class="indexterm" id="IDX-CHP-11-0825"/><a class="indexterm" id="IDX-CHP-11-0826"/><a class="indexterm" id="IDX-CHP-11-0827"/><a class="indexterm" id="IDX-CHP-11-0828"/><a class="indexterm" id="IDX-CHP-11-0829"/></p>

        <p>The big disadvantage of SNMPv1 is that this version allows only unsatisfactory authentication in precisely three stages: no access, read access, and full access for read and write operations. Two simple passwords, the so-called <span class="emphasis"><em>communities</em></span>, provide a little protection here: they divide users into one community with read permissions, and the second one with read and write permissions. No further differentiation is possible. If this was not enough, the community is transmitted in plain text, making it an easy prey for sniffer tools.</p>

        <p>Further development on the second version, SNMPv2, was intended to solve problems concerning the display of value ranges, error events, and the performance if there are mass requests (RFC 1905). This RFC was never fully implemented, however. The only relatively complete implementation that was used in practice is known as the <span class="emphasis"><em>Community-based SNMPv2</em></span>, or SNMPv2c for short (RFC 1901-1908). The current version, SNMPv3 (RFC 3411–3418), has the status of an Internet standard. Agents with SNMPv3 implementations always understand requests from SNMPv1.<a class="indexterm" id="IDX-CHP-11-0830"/><a class="indexterm" id="IDX-CHP-11-0831"/></p>

        <p>Apart from extended protocol operations, there are no fundamental differences between SNMPv1 and SNMPv2c. This is probably also the reason why SNMPv2 could not really gain a foothold. The hoped-for increase in security was certainly missing in this version. It is only the extensions of the framework in SNMPv3 which allow more precise access control, but this is much more complicated than the two community strings in SNMPv1. RFC 3414 describes the <span class="emphasis"><em>user-based security model</em></span> (USM), RFC 3415 the <span class="emphasis"><em>view-based access control model</em></span> (VACM).</p>

        <p>When accessing an SNMP agent, you must tell all tools, including plugins, which protocol version is to be used. In Nagios you exclusively require read access. If this is restricted to the required information and you only allow the access from the Nagios server, you need have no qualms about doing without the extended authentication of SNMPv3. It is only important that you configure the agent—if possible—so that it completely prevents write accesses, or at least demands a password. You should never use this: since it is transmitted in plain text, there is always a danger that somebody may be listening, and misuse the password later on.</p>

        <p>In NET-SNMP, write accesses can be completely prevented, access can be restricted to specific hosts, and information revealed can be limited. For other agents implemented in hardware such as switches and routers, you must weigh up whether you really need SNMPv3, assuming the manufacturer has made this available. SNMPv1, however, is available for all SNMP devices.<a class="indexterm" id="IDX-CHP-11-0832"/><a class="indexterm" id="IDX-CHP-11-0833"/></p>

        <p>We will therefore only explain access via SNMPv1 below, and assume that this is generally read access only. If you still want to get involved with SNMPv3, we refer you to the NET-SNMP documentation.<sup>[<a class="footnote" href="#ftn.CHP-11-FN-2" id="CHP-11-FN-2">105</a>]</sup></p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-1" id="ftn.CHP-11-FN-1">104</a>]</sup> <span class="emphasis"><em>Carrier Sense</em></span> (CS) means that each network interface checks to see whether the line is free, based on the network signal (in contrast to Token Ring, for example, where the network card may use the line only if it explicitly receives a token); <span class="emphasis"><em>Multiple Access</em></span> (MA) means that several network cards may access a common network medium simultaneously.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-2" id="ftn.CHP-11-FN-2">105</a>]</sup> <a class="ulink" href="http://net-snmp.sourceforge.net/docs/FAQ.html#How_do_I_use_SNMPv">http://net-snmp.sourceforge.net/docs/FAQ.html#How_do_I_use_SNMPv</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="11.2 NET-SNMP">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="net-snmp"/>11.2 NET-SNMP</h1>
    </div>

    <p>Probably the most widely used SNMP implementation for Linux and other UNIX systems is NET-SNMP <sup>[<a class="footnote" href="#ftn.CHP-11-FN-3" id="CHP-11-FN-3">106</a>]</sup> and was originally conceived at Carnegie-Mellon University Wes Hardaker, a system administrator at the University of California in Davis, continued developing the code and first published it under the name UCD-SNMP (Version 3.0).<a class="indexterm" id="IDX-CHP-11-0834"/><a class="indexterm" id="IDX-CHP-11-0835"/><a class="indexterm" id="IDX-CHP-11-0836"/><a class="indexterm" id="IDX-CHP-11-0837"/></p>

    <p>With version 5.0 the project finally got the name NET-SNMP. But various distributions still call the package UCD-SNMP, in part because it contains version 4.2, in part because the maintainer has simply not gotten around to renaming it.</p>

    <p>NET-SNMP consists of a set of command line tools, a graphical browser (<strong class="userinput"><code>tkmib</code></strong>), an agent (<strong class="userinput"><code>snmpd</code></strong>, see <a class="xref" href="../Text/ch11s02.html#the_net-snmp_daemon" title="11.2.2 The NET-SNMP daemon">11.2.2 The NET-SNMP daemon</a> in page 238) and a library, which now forms the basis of nearly all SNMP implementations in the Open Source field.</p>

    <p>All common distributions include corresponding packages. In SuSE this is called <strong class="userinput"><code>net-snmp</code></strong> and contains all the components; Debian packs the tools in the package <strong class="userinput"><code>snmp</code></strong>, and the daemon in the package <strong class="userinput"><code>snmpd</code></strong>. At the time of going to press, version 5.4.1 was the current version, but an older 5.x version will do the job for our purposes. Their outputs differ to some extent, but the exact options can be looked up where necessary in the man page.</p>

    <div class="sect2" title="11.2.1 Tools for SNMP requests">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="tools_for_snmp_requests"/>11.2.1 Tools for SNMP requests</h2>
      </div>

      <p>For read access, the programs <strong class="userinput"><code>snmpget</code></strong>, <strong class="userinput"><code>snmpgetnext</code></strong> and <strong class="userinput"><code>snmpwalk</code></strong> are used. <strong class="userinput"><code>snmpget</code></strong> specifically requests a single OID and returns a single value from it. <strong class="userinput"><code>snmpgetnext</code></strong> displays the next variable existing in the Management Information Base, including its value:<a class="indexterm" id="IDX-CHP-11-0838"/><a class="indexterm" id="IDX-CHP-11-0839"/><a class="indexterm" id="IDX-CHP-11-0840"/><a class="indexterm" id="IDX-CHP-11-0841"/><a class="indexterm" id="IDX-CHP-11-0842"/><a class="indexterm" id="IDX-CHP-11-0843"/></p><a id="I_programlisting8_d1e21295"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpget -v1 -c public localhost ifDescr.1</strong></span>
IF-MIB::ifDescr.1 = STRING: eth0
user@linux:~$ <span class="strong"><strong>snmpgetnext -v1 -c public localhost ifDescr.1</strong></span>
IF-MIB::ifDescr.2 = STRING: lo
user@linux:~$ <span class="strong"><strong>snmpgetnext -v1 -c public localhost ifDescr.3</strong></span>
IF-MIB::ifType.1 = INTEGER: ethernetCsmacd(6)</pre>

      <p>The option <strong class="userinput"><code>-v1</code></strong> instructs <strong class="userinput"><code>snmpget</code></strong> to use SNMPv1 as the protocol. With <strong class="userinput"><code>-c</code></strong> you specify the read community an; in this case then, the password is <strong class="userinput"><code>public</code></strong>. This is followed by the computer to be queried, here <strong class="userinput"><code>localhost</code></strong>, and finally there is the OID whose value we would like to find out.</p>

      <p>The NET-SNMP tools are masters of OID abbreviation: without special instructions, they always assume that an OID is involved which lies inside the MIB-II. For unique entries such as <strong class="userinput"><code>ifDescr.1</code></strong>, this is sufficient. But whether the various SNMP plugins for Nagios can also handle this depends on the specific implementation; it is best to try out cases on an individual basis. To be on the safe side, it is better to use complete OIDs, either numerical in readable form. The latter is obtained if you instruct <strong class="userinput"><code>snmpget</code></strong> to display the full OID:<a class="indexterm" id="IDX-CHP-11-0844"/></p><a id="I_programlisting8_d1e21336"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpget -v1 -On -c public localhost ifDescr.1</strong></span>
.1.3.6.1.2.1.2.2.1.2.1 = STRING: eth0
user@linux:~$ <span class="strong"><strong>snmpget -v1 -Of -c public localhost ifDescr.1</strong></span>
.iso.org.dod.internet.mgmt.mib-2.interfaces.ifTable.ifEntry.ifDescr.1 = STRING: eth0</pre>

      <p>The <strong class="userinput"><code>-On</code></strong> option provides the numerical OID, <strong class="userinput"><code>-Of</code></strong> the text version. In this way you can easily find out the complete OID, for plugins which cannot handle the abbreviation. It is important to remember here: each OID always starts with a period. If you omit this, there will always be a plugin which doesn't work properly.</p>

      <p>In order to obtain the entire information stored in the MIB-II, it is better to use <strong class="userinput"><code>snmpwalk</code></strong>. As the name suggests, the program takes a walk through the Management Information Base, either in its entirety or in a specified part of the tree. If you would like to find out about all the entries beneath the node <strong class="userinput"><code>mib-2.interfaces</code></strong> (<a class="xref" href="../Text/ch11.html#snmp_namespace_using_the_example_of_the" title="Figure 11-1. SNMP namespace using the example of the MIB-II interfaces">Figure 11-1</a> in page 230), you simply give <strong class="userinput"><code>snmpwalk</code></strong> the required OID:</p><a id="I_programlisting8_d1e21365"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -c public localhost mib-2.interfaces</strong></span>
IF-MIB::ifNumber.0 = INTEGER: 3
IF-MIB::ifIndex.1 = INTEGER: 1
IF-MIB::ifIndex.2 = INTEGER: 2
IF-MIB::ifIndex.3 = INTEGER: 3
IF-MIB::ifDescr.1 = STRING: eth0
IF-MIB::ifDescr.2 = STRING: lo
IF-MIB::ifDescr.3 = STRING: eth1
IF-MIB::ifType.1 = INTEGER: ethernetCsmacd(6)
...</pre>

      <p><strong class="userinput"><code>snmpwalk</code></strong> hides the exact structure slightly (links to <strong class="userinput"><code>ifTable</code></strong> and <strong class="userinput"><code>ifEntry</code></strong> are missing, for example, see <a class="xref" href="../Text/ch11.html#snmp_namespace_using_the_example_of_the" title="Figure 11-1. SNMP namespace using the example of the MIB-II interfaces">Figure 11-1</a>), so that it is better to use <strong class="userinput"><code>-Of:</code></strong></p><a id="I_programlisting8_d1e21384"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -Of -c public localhost mib-2.interfaces</strong></span>
...mib-2.interfaces.ifNumber.0 = INTEGER: 3
...mib-2.interfaces.ifTable.ifEntry.ifIndex.1 = INTEGER: 1
...mib-2.interfaces.ifTable.ifEntry.ifIndex.2 = INTEGER: 2
...mib-2.interfaces.ifTable.ifEntry.ifIndex.3 = INTEGER: 3
...mib-2.interfaces.ifTable.ifEntry.ifDescr.1 = STRING: eth0
...mib-2.interfaces.ifTable.ifEntry.ifDescr.2 = STRING: lo
...mib-2.interfaces.ifTable.ifEntry.ifDescr.3 = STRING: eth1
...mib-2.interfaces.ifTable.ifEntry.ifType.1 = INTEGER: ethernetCsmacd(6)</pre>

      <p>The three dots ... in the version here abbreviated for print stand for <strong class="userinput"><code>.iso.org.dod.internet.mgmt</code></strong>.</p>

      <p>As the next step, you could take a look around your own network and query the Management Information Bases available there. Normally you will get quite far with the read community <strong class="userinput"><code>public</code></strong>, since this is often the default setting. So you should also try out the community string <strong class="userinput"><code>private</code></strong>, which is the default set by many vendors. An extremely dubious practice, by the way: anyone who knows a bit about SNMP and who has access to the network can use this to manipulate device settings, such as switching off certain ports or the entire switch. But even with all the other default passwords, you should take the trouble to change them. Entire password lists can be found on the Internet, sorted by vendors and devices—easily found through Google.</p>

      <p>Whether you also change the preset read community (such as <strong class="userinput"><code>public</code></strong>) depends on the information available on it and on your own security requirements. But the read-write community should under no circumstances retain the default setting. In addition it is recommended that you switch off SNMP completely for devices that are neither queried nor administrated via SMNP, just to be on the safe side.</p>

      <div class="sect3" title="Taking a graphic walk with mbrowse">
        <div class="titlepage">
          <h3 class="title" id="heading_id_4"><a id="taking_a_graphic_walk_with_mbrowse"/>Taking a graphic walk with <strong class="userinput"><code>mbrowse</code></strong></h3>
        </div>

        <p>A graphical interface is often recommended for interactive research and for initial explorations of the Management Information Base, such as the SNMP browser <strong class="userinput"><code>mbrowse</code></strong><sup>[<a class="footnote" href="#ftn.CHP-11-FN-4" id="CHP-11-FN-4">107</a>]</sup> (see <a class="xref" href="../Text/ch11s02.html#snmp_browser_mbrowse" title="Figure 11-2. SNMP browser mbrowse">Figure 11-2</a>). This is not a component of NET-SNMP, but most Linux distributions provide an <strong class="userinput"><code>mbrowse</code></strong> package for installation.<a class="indexterm" id="IDX-CHP-11-0845"/></p>

        <div class="figure">
          <a id="snmp_browser_mbrowse"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject8_d1e21434"/><img alt="SNMP browser mbrowse" src="../Images/tagoreillycom20081104nostarchimages223818.png"/></div>

          <p class="title">Figure 11-2. SNMP browser <code class="userinput">mbrowse</code></p>
        </div>

        <p>If you highlight an entry and click on the <strong class="userinput"><code>Walk</code></strong> button, the lower window displays the same output as <strong class="userinput"><code>snmpwalk</code></strong>. The graphical display, however, allows better orientation—it is easier to see in which partial tree you are currently located. It is also interesting that <strong class="userinput"><code>mbrowse</code></strong> shows the numeric OID of each selected object, in <strong class="userinput"><code>Object Identifier</code></strong>.</p>
      </div>
    </div>

    <div class="sect2" title="11.2.2 The NET-SNMP daemon">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="the_net-snmp_daemon"/>11.2.2 The NET-SNMP daemon</h2>
      </div>

      <p>The NET-SNMP daemon <strong class="userinput"><code>snmpd</code></strong> works as an SNMP agent for Linux and other Unix systems; that is, it answers requests from a manager and also provides a way of making settings to the Linux system via write accesses, such as manipulating the routing table.<a class="indexterm" id="IDX-CHP-11-0846"/><a class="indexterm" id="IDX-CHP-11-0847"/><a class="indexterm" id="IDX-CHP-11-0848"/><a class="indexterm" id="IDX-CHP-11-0849"/><a class="indexterm" id="IDX-CHP-11-0850"/></p>

      <div class="sect3" title="Supported Mangement Information Bases">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="supported_mangement_information_bases"/>Supported Mangement Information Bases</h3>
        </div>

        <p>The agent initially provides information on the MIB-II described in RFC 1213 (<a class="xref" href="../Text/ch11.html#the_management_information_base" title="11.1.1 The Management Information Base">11.1.1 The Management Information Base</a> from page 229), but also the host extensions belonging to this from RFC 2790 (host MIB). <a class="xref" href="../Text/ch11s02.html#components_of_the_host_resources_mib" title="Table 11-2. Components of the Host Resources MIB mib-2.host (RFC 2790)">Table 11-2</a> summarizes the groups of the host MIB, and the most important MIB-II groups are introduced in <a class="xref" href="../Text/ch11.html#mib-ii_groups_open_parenthesis_a_selecti" title="Table 11-1. MIB-II groups (a selection)">Table 11-1</a> (page 231).<a class="indexterm" id="IDX-CHP-11-0851"/><a class="indexterm" id="IDX-CHP-11-0852"/><a class="indexterm" id="IDX-CHP-11-0853"/><a class="indexterm" id="IDX-CHP-11-0854"/><a class="indexterm" id="IDX-CHP-11-0855"/><a class="indexterm" id="IDX-CHP-11-0856"/></p>

        <p>If you are interested in a detailed description of the MIB-II, including the host MIB, we refer you to <a class="ulink" href="http://www.snmplink.org/">http://www.snmplink.org/</a>. There you can surf through a huge number of MIBs and download them if you wish.</p>

        <p>In addition to the basic MIB-II, the NET-SNMP implementation has its own extension at <strong class="userinput"><code>private.enterprises.ucdavis</code></strong> (UCD-SNMP-MIB). The directives given in <a class="xref" href="../Text/ch11s02.html#extract_from_the_ucd-snmp-mib" title="Table 11-3. Extract from the UCD-SNMP-MIB">Table 11-3</a> refer to instructions in the configuration file <strong class="userinput"><code>snmpd.conf</code></strong> (see <a class="xref" href="../Text/ch11s02.html#supported_mangement_information_bases" title="Supported Mangement Information Bases">Supported Mangement Information Bases</a>). Some of the information here is also given in the Host Resources MIB.<a class="indexterm" id="IDX-CHP-11-0857"/><a class="indexterm" id="IDX-CHP-11-0858"/><a class="indexterm" id="IDX-CHP-11-0859"/></p>

        <div class="table">
          <a id="components_of_the_host_resources_mib"/>

          <p class="title">Table 11-2. Components of the Host Resources <code class="userinput">MIB mib-2.host</code> (RFC 2790)</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Components of the Host Resources MIB mib-2.host (RFC 2790)">
              <colgroup>
                <col/>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Group</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>OID</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Description</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p>hrSystem</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>host.1</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>System time and uptime of the host, logged-in users, and number of active processes</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>hrStorage</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>host.2</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Details on all storage media such as swap, hard drives, removable media, and main memory</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>hrDevice</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>host.3</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>List of available devices and their properties: apart from details on the processor, network interfaces, printer and DVD-/CD-ROM drives, there is also information on hard drives, their partitioning, file systems, mount points and file system types</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>hrSWRun</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>host.4</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>All running processes including PID and command line parameters</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>hrSWRunPerf</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>host.5</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>CPU usage and memory usage for the processes from hrSWRun</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>hrSWInstalled</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>host.6</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Installed software; the information originates from the RPM database (unfortunately this does not work in Debian).</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="table">
          <a id="extract_from_the_ucd-snmp-mib"/>

          <p class="title">Table 11-3. Extract from the UCD-SNMP-MIB</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Extract from the UCD-SNMP-MIB">
              <colgroup>
                <col/>
                <col/>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p><strong class="userinput"><code>Group</code></strong></p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p><strong class="userinput"><code>OID</code></strong></p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p><strong class="userinput"><code>Directive</code></strong></p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p><strong class="userinput"><code>description</code></strong></p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p>prTable</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>ucdavis.2</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>proc</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>details of running processes</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>memory</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>ucdavis.4</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>-</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Memory and Swap space load, as in the program <strong class="userinput"><code>free</code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>extTable</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>ucdavis.8</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>exec</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Information on self-defined commands in the configuration file <sup>[<a class="footnote" href="#ftn.CHP-11-FN-5" id="CHP-11-FN-5">a</a>]</sup></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>dskTable</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>ucdavis.9</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>disk</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Information on file systems, see example in the text</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>laTable</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>ucdavis.10</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>load</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>System load</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>ucdExper-</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>ucdavis.13</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>-</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Experimental extension containing an entry with lm-sensor information, among other things</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>fileTable</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>ucdavis.15</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>file</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Information on files to be explicitly monitored</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>version</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>ucdavis.100 -</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>-</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Details on the NET-SNMP version and the parameters with which the daemon was compiled</p>
                  </td>
                </tr>
              </tbody>

              <tbody class="footnotes">
                <tr>
                  <td colspan="4">
                    <div class="footnote">
                      <p><sup>[<a class="para" href="#CHP-11-FN-5" id="ftn.CHP-11-FN-5">a</a>]</sup> Any executable programs can be used here.</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <p>While <strong class="userinput"><code>mib-2.host</code></strong> only specifies absolute values, such as for file systems, UCD-SNMP-MIB also allows threshold values to be set for agent pages, which then explicitly generate an error value (<strong class="userinput"><code>dskErrorFlag</code></strong>) with error text (<strong class="userinput"><code>dskErrorMsg</code></strong>):</p><a id="I_programlisting8_d1e21792"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -c public localhost ucdavis.dskTable |\ grep '.2 ='</strong></span>
UCD-SNMP-MIB::dskIndex.2 = INTEGER: 2
UCD-SNMP-MIB::dskPath.2 = STRING: /net/swobspace/b
UCD-SNMP-MIB::dskDevice.2 = STRING: /dev/md6
UCD-SNMP-MIB::dskMinimum.2 = INTEGER: −1
UCD-SNMP-MIB::dskMinPercent.2 = INTEGER: 10
UCD-SNMP-MIB::dskTotal.2 = INTEGER: 39373624
UCD-SNMP-MIB::dskAvail.2 = INTEGER: 1694904
UCD-SNMP-MIB::dskUsed.2 = INTEGER: 35678636
UCD-SNMP-MIB::<span class="strong"><strong>dskPercent</strong></span>.2 = INTEGER: 95
UCD-SNMP-MIB::dskPercentNode.2 = INTEGER: 1
UCD-SNMP-MIB::<span class="strong"><strong>dskErrorFlag</strong></span>.2 = INTEGER: 1
UCD-SNMP-MIB::<span class="strong"><strong>dskErrorMsg</strong></span>.2 = STRING: /net/swobspace/b: less than 10% free (= 95%)</pre>

        <p>The <strong class="userinput"><code>grep '. 2 ='</code></strong> filters all entries on the second device from the <strong class="userinput"><code>snmpwalk</code></strong> output, the Linux software-RAID <strong class="userinput"><code>/dev/md6</code></strong>. The entry <strong class="userinput"><code>dskPercent</code></strong> shows the current load of this data medium. An error exists if <strong class="userinput"><code>dskErrorFlag</code></strong> contains the value 1 instead of 0; <strong class="userinput"><code>dskErrorMsg</code></strong> adds a readable message to the error message. It can be assumed from this that the agent is being configured so that it will announce an error if free capacity falls below 10 percent.<a class="indexterm" id="IDX-CHP-11-0860"/></p>
      </div>

      <div class="sect3" title="The configuration file snmpd.conf">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="the_configuration_file_snmpd.conf"/>The configuration file <strong class="userinput"><code>snmpd.conf</code></strong></h3>
        </div>

        <p>Configuring the agent is done in the file <strong class="userinput"><code>snmpd.conf</code></strong>, which is either located in the directory <strong class="userinput"><code>/etc</code></strong> directly (the case for SUSE) or in <strong class="userinput"><code>/etc/snmp</code></strong> (Debian), depending on the distribution.<a class="indexterm" id="IDX-CHP-11-0862"/><a class="indexterm" id="IDX-CHP-11-0863"/><a class="indexterm" id="IDX-CHP-11-0864"/><a class="indexterm" id="IDX-CHP-11-0865"/><a class="indexterm" id="IDX-CHP-11-0866"/><a class="indexterm" id="IDX-CHP-11-0867"/><a class="indexterm" id="IDX-CHP-11-0868"/><a class="indexterm" id="IDX-CHP-11-0869"/><a class="indexterm" id="IDX-CHP-11-0870"/><a class="indexterm" id="IDX-CHP-11-0871"/><a class="indexterm" id="IDX-CHP-11-0872"/><a class="indexterm" id="IDX-CHP-11-0873"/><a class="indexterm" id="IDX-CHP-11-0874"/><a class="indexterm" id="IDX-CHP-11-0861"/></p>

        <p><code class="literal">Authentication and security</code> As the first step towards a finely tuned access control, you first need to define who should have access to which community:</p><a id="I_programlisting8_d1e21921"/>
        <pre class="programlisting">#(1) source addressesQuelladressen
com2sec localnet 192.168.1.0/24 public
com2sec localhost 127.0.0.1 public
com2sec nagiossrv 192.168.1.9 public</pre>

        <p><strong class="userinput"><code>com2sec</code></strong> links the source IP addresses to a community string (the SNMP password). This keyword is followed by an alias for the IP address range, the address range itself, and then a freely selectable community string, for which we will use <strong class="userinput"><code>public</code></strong> here, to keep things simple.<sup>[<a class="footnote" href="#ftn.CHP-11-FN-6" id="CHP-11-FN-6">108</a>]</sup>. <strong class="userinput"><code>192.168.1.0/24</code></strong> refers to the local network; the Nagios server itself has the IP address <strong class="userinput"><code>192.168.1.9</code></strong>. If you set access permissions for the alias <strong class="userinput"><code>localnet</code></strong> later on, they will apply to the entire local network <strong class="userinput"><code>192.168.1.0/24</code></strong>, but if you reference <strong class="userinput"><code>nagiossrv</code></strong> when doing this, they will only apply to the Nagios server itself.</p>

        <p>Then the defined computers and networks are assigned via their aliases to groups which have different security models:</p><a id="I_programlisting8_d1e21952"/>
        <pre class="programlisting"># (2) assignment of group - security model - source-IP alias
group Local     v1     localhost
group Nagios    v1     nagiossrv</pre>

        <p>The keyword <strong class="userinput"><code>group</code></strong> is followed first by a freely selectable group name: here we define the group <strong class="userinput"><code>Local</code></strong> with the security model <strong class="userinput"><code>v1</code></strong>, which belongs to the address range defined as <strong class="userinput"><code>localhost</code></strong>, and the group <strong class="userinput"><code>Nagios</code></strong> with the same security model contained in the Nagios server.</p>

        <p>You can choose from <strong class="userinput"><code>v1</code></strong> (SNMPv1), <strong class="userinput"><code>v2c</code></strong> (community-based SNMPv2), and <strong class="userinput"><code>usm</code></strong> (the <span class="emphasis"><em>User Model</em></span> from SNMPv3) as the security model. If you assign a computer or a network several security models at the same time, then separate entries with the same group name are required:</p><a id="I_programlisting8_d1e21985"/>
        <pre class="programlisting">group Nagios     v1     nagiossrv
     group Nagios     usm    nagiossrv</pre>

        <p>With the definition of views (keyword <strong class="userinput"><code>view</code></strong>) the view from the outside can be restricted precisely to partial trees of the Management Information Base. Each view here is also given a name for referencing:</p><a id="I_programlisting8_d1e21993"/>
        <pre class="programlisting">#(3) View definition for partial trees of the SNMP namespace
     view all included .1
     view system included .iso.org.dod.internet.mgmt.mib-2.system</pre>

        <p>The reference <strong class="userinput"><code>included</code></strong> includes the following partial tree in the view. Thus the view <strong class="userinput"><code>all</code></strong> covers the entire tree (<strong class="userinput"><code>.1</code></strong>). If you want to exclude certain partial trees in this, then the keyword <strong class="userinput"><code>excluded</code></strong> is used:</p><a id="I_programlisting8_d1e22009"/>
        <pre class="programlisting">view all included   .1
     view all excluded   .iso.org.dod.internet.private</pre>

        <p>The partial tree beneath <strong class="userinput"><code>private</code></strong> in <strong class="userinput"><code>all</code></strong> is now blocked, such as the MIB <strong class="userinput"><code>ucdavis (private.enterprises.ucdavis</code></strong>).</p>

        <p>One interesting feature is the mask; it specifies in hexadecimal notation which nodes correspond exactly to the subtree:</p><a id="I_programlisting8_d1e22024"/>
        <pre class="programlisting">view all     included .iso.org.dod.internet.mgmt     F8</pre>

        <p>All places of the queried OID, for which the mask contains a 1 in binary notation, must be identical in the queried partial tree to the OID specified here, <strong class="userinput"><code>.iso.org.dod.internet.mgmt</code></strong>, otherwise the daemon will refuse access and not provide any information. <strong class="userinput"><code>.iso.org.dod.internet.mgmt</code></strong> is written numerically as <strong class="userinput"><code>.1.3.6.1.2</code></strong>.</p>

        <p>Thanks to the mask <strong class="userinput"><code>F8</code></strong>,<sup>[<a class="footnote" href="#ftn.CHP-11-FN-7" id="CHP-11-FN-7">109</a>]</sup> binary 11111000, the first five places from the left in the OID must always be <strong class="userinput"><code>.iso.org.dod.internet.mgmt</code></strong>. If somebody queried an OID (such as the <strong class="userinput"><code>private</code></strong> tree <strong class="userinput"><code>.1.3.6.1.4</code></strong>), which deviates from this, the agent would remain silent and not provide any information. If you leave out the mask detail, <strong class="userinput"><code>FF</code></strong> will be used.</p>

        <p>If you have defined the alias, community, security model, and view, you just need to bring them together for the purpose of access control. This is done with the <strong class="userinput"><code>access</code></strong> instruction:</p><a id="I_programlisting8_d1e22076"/>
        <pre class="programlisting"># (4) Definition of the access control
access   Local   any   noauth   exact   all   none   none
access   NagiosGrp   any   noauth    exact   all    none   none</pre>

        <p>The access restrictions are bound to the group. The <strong class="userinput"><code>context</code></strong> column remains empty (<strong class="userinput"><code>'""</code></strong>), since only SNMPv3 requires it.<sup>[<a class="footnote" href="#ftn.CHP-11-FN-8" id="CHP-11-FN-8">110</a>]</sup>. As the security model, you then normally choose <strong class="userinput"><code>any</code></strong>, but you may define a specific model with <strong class="userinput"><code>v1</code></strong>, <strong class="userinput"><code>v2c</code></strong> or <strong class="userinput"><code>usm</code></strong>, since several different security models may be assigned to a group, as shown in the discussion of "Authentication and Security" at the beginning of this Section. The fifth column specifies the security level, which is also of interest only for SNMPv3. In the other two security models (we are only using <strong class="userinput"><code>v1</code></strong>), <strong class="userinput"><code>noauth</code></strong> is given here. The fourth last column also has just one meaning in SNMPv3. But since you must enter a valid value forSNMPv1 and SNMPv2c as well, then <strong class="userinput"><code>exact</code></strong> is chosen here.</p>

        <p>The last two columns specify which view should be used for which access (read or write). In the example, the groups <strong class="userinput"><code>Local</code></strong> and <strong class="userinput"><code>NagiosGrp</code></strong> obtain read access for the view <strong class="userinput"><code>all</code></strong>, but no write access. The final column defines whether the agent should send SNMP traps—that is, active messages, to the manager—for events that occur within the range of validity of the view. <a class="xref" href="../Text/ch14s06.html" title="14.6 Application Example II: Processing SNMP Traps">14.6 Application Example II: Processing SNMP Traps</a> from page 312 goes into more detail about SNMP traps.</p>

        <p>With the configuration described here, you can now exclusively access the Nagios server and <strong class="userinput"><code>localhost</code></strong> via SNMPv1 for information. The server access can be restricted further by defining a view that makes only parts of the MIB visible. But you should only try this once the configuration described is working, to avoid logical errors and time-consuming debugging.</p>

        <p><code class="literal">System and local information</code> The partial tree <strong class="userinput"><code>mib-2.system</code></strong> provides information on the system itself and on the available (that is, implemented) MIBs. With <strong class="userinput"><code>syslocation</code></strong> you can specify where a system is located in the company or on the campus, and after the keyword <strong class="userinput"><code>syscontact</code></strong> you enter the e-mail address of the administrator responsible:</p><a id="I_programlisting8_d1e22144"/>
        <pre class="programlisting">#(5) mib-2.system
syslocation Server room Martinstr., 2nd rack from the left
syscontact root &lt;wob@swobspace.de&gt;</pre>

        <p>As long as you do not redefine the parameters <strong class="userinput"><code>sysname</code></strong> and <strong class="userinput"><code>sysdescr</code></strong> at this point, the corresponding MIBs in the default will reveal the host name and/or the system and kernel specification, corresponding to <strong class="userinput"><code>uname -a</code></strong>:</p><a id="I_programlisting8_d1e22157"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -c public localhost system</strong></span>
system.sysDescr.0 = STRING: Linux swobspace 2.6.10 #20 SMP Mon Dec 27 11:55:25 CET
 2004 i686
system.sysObjectID.0 = OID: NET-SNMP-MIB::netSnmpAgentOIDs.10
system.sysUpTime.0 = Timeticks: (1393474) 3:52:14.74
system.sysContact.0 = STRING: root &lt;wob@swobspace.de&gt;
system.sysName.0 = STRING: swobspace
system.sysLocation.0 = STRING: Serverraum Martinstr., 2. Rack von links</pre>

        <p><code class="literal">Defining processes to be monitored</code> Processes that you want to monitor using SNMP are specified with the <strong class="userinput"><code>proc</code></strong> directive, and if required you can specify the minimum or maximum number of processes:</p><a id="I_programlisting8_d1e22169"/>
        <pre class="programlisting"># (6) Processes: enterprises.ucdavis.procTable
# proc <span class="emphasis"><em>process maximum minimum</em></span>
# proc <span class="emphasis"><em>process maximum</em></span>
# proc <span class="emphasis"><em>process</em></span>
proc sshd
proc nmbd 2 1
proc smbd
proc slapd</pre>

        <p>If the entry for maximum and minimum is missing, at least one process must be running. If only the minimum is omitted, NET-SNMP will define this with zero processes. The corresponding entries end up in the MIB <strong class="userinput"><code>ucdavis.prTable</code></strong>; in case of error you will receive an error flag (<strong class="userinput"><code>prError-Flag</code></strong> and an error description (<strong class="userinput"><code>prErrMessage</code></strong>) (which unfortunately you cannot define yourself):</p><a id="I_programlisting8_d1e22191"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -c public localhost prTable</strong></span>
...
prTable.prIndex.4 = INTEGER: 4
prTable.prNames.4 = STRING: slapd
prTable.prMin.4 = INTEGER: 0
prTable.prMax.4 = INTEGER: 0
prTable.prCount.4 = INTEGER: 0
prTable.<span class="strong"><strong>prErrorFlag</strong></span>.4 = INTEGER: 1
prTable.<span class="strong"><strong>prErrMessage</strong></span>.4 = STRING: No slapd process running.
...</pre>

        <p><strong class="userinput"><code>ucdavis. prTable</code></strong> only reveals the configured processes; on the other hand it allows <strong class="userinput"><code>mib-2.host.hrSWRun</code></strong> and <strong class="userinput"><code>mib-2.host.hrSWRunPerf</code></strong> in general to query all running processes. If you want to prevent this, the view must exclude the area you do not want.</p>

        <p><code class="literal">Your own commands</code> With the <strong class="userinput"><code>exec</code></strong> directive you can specify commands in the extension <strong class="userinput"><code>ucdavis.extTable</code></strong>, which the agent will execute in the corresponding queries. The result then appears in the relevant entries. In the following example the agent calls <strong class="userinput"><code>/bin/echo</code></strong> if it is asked for <strong class="userinput"><code>ucdavis.extTable</code></strong>:</p><a id="I_programlisting8_d1e22229"/>
        <pre class="programlisting"># (7) your own commands: enterprises.ucdavis.extTable
# exec <span class="emphasis"><em>name command arguments</em></span>
exec echotest /bin/echo hello world</pre>

        <p>The program to be executed must appear with its absolute path in the configuration. Running <strong class="userinput"><code>snmpwalk</code></strong> provides only the following:</p><a id="I_programlisting8_d1e22239"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -c public localhost extTable</strong></span>
extTable.extEntry.extIndex.1 = INTEGER: 1
extTable.extEntry.extNames.1 = STRING: echotest
extTable.extEntry.extCommand.1 = STRING: /bin/echo hello world
extTable.extEntry.extResult.1 = INTEGER: 0
extTable.extEntry.extOutput.1 = STRING: hello world
...</pre>

        <p><strong class="userinput"><code>extTable.extEntry.extResult</code></strong> contains the return value of the command executed, and <strong class="userinput"><code>extTable.extEntry.extOutput</code></strong> contains the text output.</p>

        <p>With the <strong class="userinput"><code>exec</code></strong> directive you can thus query everything that a local script or program can find out. This could be a security problem, however: if the programs used are susceptible to buffer overflows, this feature could be misused as a starting point for a denial-of-service attack.</p>

        <p><code class="literal">Monitoring hard drive capacity</code> The <strong class="userinput"><code>disk</code></strong> directive is suitable for monitoring file systems. The keyword <strong class="userinput"><code>disk</code></strong> is followed by the path for a mount point, and then the minimum hard drive space in KB or in percent that should be available. If you omit the capacity entry, at least 100 MB must be available; otherwise an error message will be given.</p>

        <p>In the following example the free capacity in the <strong class="userinput"><code>/</code></strong> file system should not drop below <strong class="userinput"><code>10%</code></strong> and on <strong class="userinput"><code>/usr</code></strong>, at least 800 MB <sup>[<a class="footnote" href="#ftn.CHP-11-FN-9" id="CHP-11-FN-9">111</a>]</sup> should remain free:</p><a id="I_programlisting8_d1e22281"/>
        <pre class="programlisting">#(8) File systems: enterprises.ucdavis.dskTable
#disk <span class="emphasis"><em>mount point</em></span>
#disk <span class="emphasis"><em>mount point</em></span> minimum_capacity_in_KB
#disk <span class="emphasis"><em>mountpoint</em></span> minimum_capacity_in_percent%
disk / 10%
disk /usr 819200
disk /data 50%</pre>

        <p>As far as the data partition <strong class="userinput"><code>/data</code></strong> is concerned, the alarm should be raised if free capacity falls below <strong class="userinput"><code>50%. dskErrorFlag</code></strong> in this case contains the value 1 instead of 0, and <strong class="userinput"><code>dskErrorMsg</code></strong> contains an error text:</p><a id="I_programlisting8_d1e22303"/>
        <pre class="programlisting">...
UCD-SNMP-MIB::dskPercent.3 = INTEGER: 65
UCD-SNMP-MIB::<span class="strong"><strong>dskErrorFlag</strong></span>.3 = INTEGER: 1
UCD-SNMP-MIB::<span class="strong"><strong>dskErrorMsg</strong></span>.3 = STRING: /data: less than 50% free (= 65%)</pre>

        <p><strong class="userinput"><code>dskPercent</code></strong> reveals a current load of <strong class="userinput"><code>65%</code></strong>. Instead of the partial tree configured here, <strong class="userinput"><code>ucdavis.dskTable, mib-2.host.hrStorage</code></strong> also provides an overview of all file systems, even those not explicitly defined. These are missing percentage details, however, and you do not receive an error status or error message, as supplied by <strong class="userinput"><code>ucdavis.dskTable</code></strong>.</p>

        <p>You should think hard about whether you set the warning limit in the NET-SNMP or in the Nagios configuration. In the first case you must configure the values on each individual host. If you query the percentage load, however, with the <strong class="userinput"><code>check_snmp</code></strong> plugin (see <a class="xref" href="../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp" title="11.3.1 The generic SNMP plugin check_snmp">11.3.1 The generic SNMP plugin check_snmp</a> from page 246), then you set warning and critical limits centrally on the Nagios server, saving yourself a lot of work if you make changes later on. The <strong class="userinput"><code>includeAHDisks</code></strong> directive adds all existing file systems to the <strong class="userinput"><code>dskTable</code></strong> table:</p><a id="I_programlisting8_d1e22338"/>
        <pre class="programlisting">includeAllDisks 10%</pre>

        <p>It requires a minimum limit to be specified in percent, and also returns error values. An absolute specification in KB is not possible here. If you set warning and error limits centrally for <strong class="userinput"><code>check_snmp</code></strong>; (see <a class="xref" href="../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp" title="11.3.1 The generic SNMP plugin check_snmp">11.3.1 The generic SNMP plugin check_snmp</a> from page 246) the error attributes <strong class="userinput"><code>dskErrorFlag</code></strong> and <strong class="userinput"><code>dskErrorMsg</code></strong> are not queried, so that the value set here as the minimum limit can be ignored.</p>

        <p><code class="literal">System load</code> The <strong class="userinput"><code>load</code></strong> directive queries the CPU load. As the limit values, you specify the average values for one minute, and optionally for five and 15 minutes:</p><a id="I_programlisting8_d1e22360"/>
        <pre class="programlisting"># (9) System Load: enterprises.ucdavis.laTable
# load <span class="emphasis"><em>max1</em></span>
# load <span class="emphasis"><em>max1 max5</em></span>
# load <span class="emphasis"><em>max1 max5 max15</em></span>
load 5 3 2</pre>

        <p>If the values are overstepped, <strong class="userinput"><code>laErrorFlag</code></strong> will contain the status <strong class="userinput"><code>1</code></strong> (otherwise: <strong class="userinput"><code>0</code></strong>) and <strong class="userinput"><code>laErrMessage</code></strong> will have the text of the error message.</p>

        <p>In a system that exceeds one of the specified limits, <strong class="userinput"><code>snmpwalk</code></strong> returns the following:</p><a id="I_programlisting8_d1e22390"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -c public localhost laTable</strong></span>
...
UCD-SNMP-MIB::laNames.1 = STRING: Load-1
UCD-SNMP-MIB::laNames.2 = STRING: Load-5
UCD-SNMP-MIB::laNames.3 = STRING: Load-15
UCD-SNMP-MIB::laLoad.1 = STRING: 5.31
UCD-SNMP-MIB::laLoad.2 = STRING: 2.11
UCD-SNMP-MIB::laLoad.3 = STRING: 0.77
...
UCD-SNMP-MIB::laLoadInt.1 = INTEGER: 530
UCD-SNMP-MIB::laLoadInt.2 = INTEGER: 210
UCD-SNMP-MIB::laLoadInt.3 = INTEGER: 77
UCD-SNMP-MIB::laLoadFloat.1 = Opaque: Float: 5.310000
UCD-SNMP-MIB::laLoadFloat.2 = Opaque: Float: 2.110000
UCD-SNMP-MIB::laLoadFloat.3 = Opaque: Float: 0.770000
UCD-SNMP-MIB::laErrorFlag.1 = INTEGER: 1
UCD-SNMP-MIB::laErrorFlag.2 = INTEGER: 0
UCD-SNMP-MIB::laErrorFlag.3 = INTEGER: 0
UCD-SNMP-MIB::laErrMessage.1 = STRING: 1 min Load Average too high (=5.31)
UCD-SNMP-MIB::laErrMessage.2 = STRING:
UCD-SNMP-MIB::laErrMessage.3 = STRING:</pre>

        <p>From <strong class="userinput"><code>laLoadlnt.1</code></strong> we are told the one-minute average value for the system <strong class="userinput"><code>load</code></strong> as an integer, from <strong class="userinput"><code>laLoad.l</code></strong> as a string, and from <strong class="userinput"><code>laLoadFloat.1</code></strong> as a floating-point decimal. <strong class="userinput"><code>laErrorFlag.1</code></strong> contains the corresponding error status, <strong class="userinput"><code>laErrMessage.1</code></strong> the corresponding error message. The same applies for the other two averages.</p>

        <p>You can also use the <strong class="userinput"><code>check_snmp</code></strong> plugin here to query the floating-point decimal values just as accurately, and specify limit values centrally.<a class="indexterm" id="IDX-CHP-11-0875"/><a class="indexterm" id="IDX-CHP-11-0876"/></p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-3" id="ftn.CHP-11-FN-3">106</a>]</sup> <a class="ulink" href="http://net-snmp.sourceforge.net/">http://net-snmp.sourceforge.net/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-4" id="ftn.CHP-11-FN-4">107</a>]</sup> <a class="ulink" href="http://www.kill-9.org/mbrowse/">http://www.kill-9.org/mbrowse/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-6" id="ftn.CHP-11-FN-6">108</a>]</sup> See also page 236</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-7" id="ftn.CHP-11-FN-7">109</a>]</sup> F= 1.2<sup>3</sup>+1.2<sup>2</sup>+1.2<sup>1</sup> +1.2<sup>0</sup> = 1111, 8=1000</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-8" id="ftn.CHP-11-FN-8">110</a>]</sup> Corresponding descriptions on SNMPv3 would go beyond the bounds of this book</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-9" id="ftn.CHP-11-FN-9">111</a>]</sup> 1024KB * 800</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="11.3 Nagios's Own SNMP Plugins">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="nagios_apostrophy_s_own_snmp_plugins"/>11.3 Nagios's Own SNMP Plugins</h1>
    </div>

    <p>Among the standard Nagios plugins there are three programs with which data can be obtained via SNMP: a generic plugin that queries any OIDs you want, and two Perl scripts that are specialized in interface data of network cards and the ports of switches, routers and so forth. In addition to this, the directory <strong class="userinput"><code>contrib</code></strong> contains the source code of other SNMP plugins that are not automatically installed. Apparently these are no longer maintained and cannot run without major adjustments to the code.<a class="indexterm" id="IDX-CHP-11-0877"/><a class="indexterm" id="IDX-CHP-11-0878"/><a class="indexterm" id="IDX-CHP-11-0879"/></p>

    <p><a class="ulink" href="http://www.nagiosexchange.org/">http://www.nagiosexchange.org/</a> also provides some useful specialized plugins, some of which are introduced in <a class="xref" href="../Text/ch11s04.html" title="11.4 Other SNMP-based Plugins">11.4 Other SNMP-based Plugins</a> from page 255. The following descriptions are limited, for reasons of space, to SNMPv1/2 queries; for SNMPv3-specific options, we refer you to the online help for the corresponding plugin.</p>

    <div class="sect2" title="11.3.1 The generic SNMP plugin check_snmp">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="the_generic_snmp_plugin_check_snmp"/>11.3.1 The generic SNMP plugin <strong class="userinput"><code>check_snmp</code></strong></h2>
      </div>

      <p>With <strong class="userinput"><code>check_snmp</code></strong> a generic plugin is available that queries all available information via SNMP, according to your requirements. However, its operation does require a degree of care, since as a generic plugin, it has no idea of specifically what data it is querying.<a class="indexterm" id="IDX-CHP-11-0880"/><a class="indexterm" id="IDX-CHP-11-0881"/><a class="indexterm" id="IDX-CHP-11-0882"/></p>

      <p>For this reason as well, its output looks quite meager; specialized plugins provide more convenience here. But since these don't exist for every purpose, <strong class="userinput"><code>check_snmp</code></strong> is then quite justified. It calls the program <strong class="userinput"><code>snmpget</code></strong> auf, which means that the NET-SNMP tools must be installed.<a class="indexterm" id="IDX-CHP-11-0883"/><a class="indexterm" id="IDX-CHP-11-0884"/></p>

      <p>It provides the following options:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong>/ <strong class="userinput"><code>--host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>This is the host name or IP address of the SNMP agent to be queried.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-o</code></strong> <strong class="userinput"><code><em class="replaceable"><code>OID</code></em></code></strong> /<strong class="userinput"><code>--oid=</code></strong><strong class="userinput"><code><em class="replaceable"><code>OID</code></em></code></strong></span></dt>

          <dd>
            <p>This is the object identifier to be queried, either as a complete numerical OID or as a string, which is interpreted by <strong class="userinput"><code>snmpget</code></strong> (e.g., <strong class="userinput"><code>system.sysName.O</code></strong>).</p>

            <p>Attention: in contrast to <strong class="userinput"><code>snmpwalk</code></strong>, you must always specify the end nodes containing the information.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

          <dd>
            <p>This is the alternative port on which the SNMP agent is running. The default is UDP port 161.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong> <strong class="userinput"><code>/ --community=</code></strong><strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong></span></dt>

          <dd>
            <p>This is the community string for read access. The default value is <strong class="userinput"><code>public</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>start:end</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>start:end</code></em></code></strong></span></dt>

          <dd>
            <p>If the queried value lies within the range specified by <span class="emphasis"><em>start</em></span> and <span class="emphasis"><em>end</em></span>, <strong class="userinput"><code>check_snmp</code></strong> does not give out a warning. For <strong class="userinput"><code>-w 0:90</code></strong> it must therefore be larger than 0 and smaller than 90.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>start:end</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>start:end</code></em></code></strong></span></dt>

          <dd>
            <p>If the query value lies outside the range, the plugin gives out CRITICAL. If the warning and critical limits overlap, the critical limit always has priority</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> <strong class="userinput"><code>/ --string=</code></strong><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong></span></dt>

          <dd>
            <p>The contents of the queried OID must correspond exactly to the specified <span class="emphasis"><em>string</em></span>, otherwise <strong class="userinput"><code>check_snmp</code></strong> will give out an error.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-r</code></strong> <strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong> <strong class="userinput"><code>/ --ereg=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong></span></dt>

          <dd>
            <p>This option checks the contents of the queried OID to see whether the regular expression <span class="emphasis"><em>regexp</em></span><sup>[<a class="footnote" href="#ftn.CHP-11-FN-10" id="CHP-11-FN-10">112</a>]</sup> is matched. If this is the case, the plugin returns OK, otherwise CRITICAL.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-R</code></strong> <strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong> <strong class="userinput"><code>/ --erexi=</code></strong><strong class="userinput"><code><em class="replaceable"><code>regexp</code></em></code></strong></span></dt>

          <dd>
            <p>As <strong class="userinput"><code>-r</code></strong>, except that there is no case distinction.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>−1</code></strong> <strong class="userinput"><code><em class="replaceable"><code>prefix</code></em></code></strong> <strong class="userinput"><code>/ --label=</code></strong><strong class="userinput"><code><em class="replaceable"><code>prefix</code></em></code></strong></span></dt>

          <dd>
            <p>A string that is placed in front of the plugin response. The default is <strong class="userinput"><code>SNMP</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> <strong class="userinput"><code>/ --units=</code></strong><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong></span></dt>

          <dd>
            <p>SNMP only has simple values, not units. A string that is specified instead of <span class="emphasis"><em>string</em></span> is extended by the plugin in the text output so that it serves the value as a unit. Because only text is involved here, you can also specify <strong class="userinput"><code>apples</code></strong> or <strong class="userinput"><code>pears</code></strong>, for example, as "units".</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-d</code></strong> <strong class="userinput"><code><em class="replaceable"><code>delimiter</code></em></code></strong> <strong class="userinput"><code>/ --delimiter=</code></strong><strong class="userinput"><code><em class="replaceable"><code>delimiter</code></em></code></strong></span></dt>

          <dd>
            <p>This character separates the OID in the <strong class="userinput"><code>snmpget</code></strong> output from the value. The default is =.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-D</code></strong> <strong class="userinput"><code><em class="replaceable"><code>delimiter</code></em></code></strong> <strong class="userinput"><code>/ --output-</code></strong> <strong class="userinput"><code>delimiter=</code></strong><strong class="userinput"><code><em class="replaceable"><code>delimiter</code></em></code></strong></span></dt>

          <dd>
            <p>The plugin is able to query several OIDs simultaneously. The result values are separated with <span class="emphasis"><em>delimiter</em></span>, which in the default is a space.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-m</code></strong> <strong class="userinput"><code><em class="replaceable"><code>mibs</code></em></code></strong> <strong class="userinput"><code>/ --miblist=</code></strong><strong class="userinput"><code><em class="replaceable"><code>mibs</code></em></code></strong></span></dt>

          <dd>
            <p>This specifies the MIBs that should be loaded for <strong class="userinput"><code>snmpget</code></strong>. The default is <strong class="userinput"><code>ALL.-m +UCD-DEMO-MIB</code></strong><sup>[<a class="footnote" href="#ftn.CHP-11-FN-11" id="CHP-11-FN-11">113</a>]</sup>. loads <span class="emphasis"><em>in addition</em></span>, <strong class="userinput"><code>-m UCD-DEMO-MIB</code></strong> &lt;without the <strong class="userinput"><code>+</code></strong> sign&gt; <span class="emphasis"><em>only</em></span> loads the specified MIB.<sup>[<a class="footnote" href="#ftn.CHP-11-FN-12" id="CHP-11-FN-12">114</a>]</sup>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-P</code></strong> <strong class="userinput"><code><em class="replaceable"><code>version</code></em></code></strong> <strong class="userinput"><code>/ --protocol=</code></strong><strong class="userinput"><code><em class="replaceable"><code>version</code></em></code></strong></span></dt>

          <dd>
            <p>Defines the SNMP protocol version. The values for <span class="emphasis"><em>version</em></span> are <strong class="userinput"><code>1</code></strong> or <strong class="userinput"><code>3</code></strong>. Without this option, SNMPv1 is used.</p>
          </dd>
        </dl>
      </div>

      <p>SNMP provides almost unlimited possibilities, so the following examples can merely convey a feeling for other plugins used.</p>

      <div class="sect3" title="Testing hard drive capacity via SNMP">
        <div class="titlepage">
          <h3 class="title" id="heading_id_4"><a id="testing_hard_drive_capacity_via_snmp"/>Testing hard drive capacity via SNMP</h3>
        </div>

        <p>The following command queries the load of a file system and to do this accesses the partial tree <strong class="userinput"><code>ucdavis.dskTable</code></strong> of a locally running NET-SNMP agent:<a class="indexterm" id="IDX-CHP-11-0885"/><a class="indexterm" id="IDX-CHP-11-0886"/><a class="indexterm" id="IDX-CHP-11-0887"/><a class="indexterm" id="IDX-CHP-11-0888"/></p><a id="I_programlisting8_d1e22894"/>
        <pre class="programlisting">nagios@linux:local/libexec$ ./<span class="strong"><strong>check_snmp -H swobspace -C public \</strong></span>
<span class="strong"><strong>      -o dskTable.dskEntry.dskPercent.2 -w 0:90 -c 0:95 -u percent</strong></span> SNMP WARNING
 - *95* percent</pre>

        <p>The query applies to the percentage load of the file system with the index number 2. As long as no more than 90 percent of the hard drive space is then occupied, the test should return OK; here a warning will be returned if it is between 91 and 95 percent, and critical status if it goes beyond this. Thanks to the <strong class="userinput"><code>-u</code></strong> option, <strong class="userinput"><code>check_snmp</code></strong> adds the description <strong class="userinput"><code>percent</code></strong> to the output of the figure determined.</p>

        <p>Nevertheless, the plugin does not tell the whole truth: a test check with <strong class="userinput"><code>df</code></strong> shows a 96 percent load, which comes from the fact that this program correctly rounded up the actual 95.8 percent load, while integer values in SNMP are seldom rounded up, but simply cut off. So you just have to live with slight inaccuracies as long as the MIB does not provide any floatingpoint decimals.</p>

        <p>If you would like things to be more detailed, you can use the option <strong class="userinput"><code>−1: −1 'SNMP-DISK: /net/swobspace/b'</code></strong> causes other, self-defined information to be added to the output of the above command:</p><a id="I_programlisting8_d1e22923"/>
        <pre class="programlisting">SNMP-DISK: /net/swobspace/b WARNING - *95* percent</pre>

        <p>The above query can be more generally run through a command object such as the following:</p><a id="I_programlisting8_d1e22927"/>
        <pre class="programlisting">define command{
    command_name <span class="strong"><strong>check_snmp</strong></span>
    command_line $USER1$/<span class="strong"><strong>check_snmp</strong></span> -H $HOSTADDRESS$ -C $USER3$ -P 1 -o $ARG1$
 -w $ARG2$ -c $ARG3$ -l $ARG4$
}</pre>

        <p>This definition assumes that the value being queried is numerical, and not Boolean (see <a class="xref" href="../Text/ch11s03.html#monitoring_network_interfaces" title="Monitoring network interfaces">Monitoring network interfaces</a>), otherwise specifying a warning and critical value simultaneously would make no sense. We store the community here in the macro <strong class="userinput"><code>$USER3$</code></strong>.<sup>[<a class="footnote" href="#ftn.CHP-11-FN-13" id="CHP-11-FN-13">115</a>]</sup>. this is followed by the protocol version (<strong class="userinput"><code>-P 1</code></strong> stands for SNMPv1), the OID, the warning and critical limits, and a prefix.<a class="indexterm" id="IDX-CHP-11-0889"/></p>

        <p>The call for this command in service definitions is then made in the form</p><a id="I_programlisting8_d1e22960"/>
        <pre class="programlisting">check_snmp! <span class="emphasis"><em>oid! warn! critical !prefix</em></span></pre>

        <p>If you want to specifically monitor the load of the file system with the index number 2 on the computer <strong class="userinput"><code>swobspace</code></strong> through <strong class="userinput"><code>dskTable</code></strong>, then the following definition would be used:</p><a id="I_programlisting8_d1e22972"/>
        <pre class="programlisting">define service{
   service_description    SNMP-DISK-a
   host_name              swobspace
<span class="strong"><strong>     check_command check_snmp!dskTable.dskEntry.dskPercent.2!0:90!0:95!DIS</strong></span>
<span class="strong"><strong>   K: /net/swobspace/a</strong></span>
...
}</pre>

        <p>Even though the <strong class="userinput"><code>check_command</code></strong> line is wrapped here, in practice all parameters must be on a single line, separated by an exclamation point <strong class="userinput"><code>!</code></strong> (without spaces before or after the delimiter).</p>
      </div>

      <div class="sect3" title="Measuring temperature via lm-sensors">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="measuring_temperature_via_lm-sensors"/>Measuring temperature via <strong class="userinput"><code>lm-sensors</code></strong></h3>
        </div>

        <p>The next test checks the CPU temperature of the host. For the sensor, the package <strong class="userinput"><code>lm-sensors</code></strong><sup>[<a class="footnote" href="#ftn.CHP-11-FN-14" id="CHP-11-FN-14">116</a>]</sup> is used here, which accesses corresponding chips on modern mainboards. As soon as <strong class="userinput"><code>lm-sensors</code></strong> is active, it allows the NET-SNMP agents to read out the corresponding information from the partial tree <strong class="userinput"><code>ucdavis.ucdExperimental.lmSensors:</code></strong><a class="indexterm" id="IDX-CHP-11-0890"/><a class="indexterm" id="IDX-CHP-11-0891"/><a class="indexterm" id="IDX-CHP-11-0892"/><a class="indexterm" id="IDX-CHP-11-0893"/><a class="indexterm" id="IDX-CHP-11-0894"/><a class="indexterm" id="IDX-CHP-11-0895"/><a class="indexterm" id="IDX-CHP-11-0896"/><a class="indexterm" id="IDX-CHP-11-0897"/></p><a id="I_programlisting8_d1e23045"/>
        <pre class="programlisting">nagios@linux:local/libexec$ ./<span class="strong"><strong>check_snmp -H localhost -C public \ -o
 lmTempSensorsValue.1 -w 25000:45000 -c 20000:48000 \ -u 'degrees Celsius (* 1000)'
 -l 'Temp1/CPU'</strong></span>
     Temp1/CPU OK - 41000 degrees Celsius (* 1000)</pre>

        <p>The output depends on the chipset: here you must multiply the query values by the factor 1000. Accordingly, you have no other alternative but to adjust the warning and critical limits to the main board you are using. In the example, the CPU temperature, 41 degrees Celsius, is "on a green light": if it were to drop below 25 degrees or rise above 45 degrees, it would cause a warning, while below 20 or above 48 degrees, this would be critical.</p>
      </div>

      <div class="sect3" title="Regular expressions and comparing fixed strings">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="regular_expressions_and_comparing_fixed"/>Regular expressions and comparing fixed strings</h3>
        </div>

        <p>You can check whether the text <strong class="userinput"><code>swobspace</code></strong> occurs in the system name as follows:</p><a id="I_programlisting8_d1e23060"/>
        <pre class="programlisting">nagios@linux:local/libexec$ ./<span class="strong"><strong>check_snmp -H localhost -C public \ -o system.sysName.0
 -r swobspace</strong></span>
     SNMP OK - "swobspace"</pre>

        <p>Instead of defining the string being searched for, with <strong class="userinput"><code>-r</code></strong> as the regular expression, you could also use the <strong class="userinput"><code>-s</code></strong> option. Then the text must match exactly, however, which may be quite tricky, since everything counts that <strong class="userinput"><code>snmpget</code></strong> outputs after the delimiter, <strong class="userinput"><code>=</code></strong>.</p>
      </div>

      <div class="sect3" title="Monitoring network interfaces">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="monitoring_network_interfaces"/>Monitoring network interfaces</h3>
        </div>

        <p>The final example queries whether the first network interface of a Cisco router is in operation:<a class="indexterm" id="IDX-CHP-11-0898"/><a class="indexterm" id="IDX-CHP-11-0899"/><a class="indexterm" id="IDX-CHP-11-0900"/><a class="indexterm" id="IDX-CHP-11-0901"/></p><a id="I_programlisting8_d1e23100"/>
        <pre class="programlisting">nagios@linux:local/libexec$ <span class="strong"><strong>./check_snmp -H cisco1 -C public</strong></span> \
<span class="strong"><strong>-o ifOperStatus.1 -w 1:1 -l 'SNMP: Port Status for Port 1 is: '</strong></span>
SNNP: Port Status for Port 1 is: OK - 1</pre>

        <p>The information sought can be found in <strong class="userinput"><code>ifOperStatus</code></strong>. Here we are querying port 1. While <strong class="userinput"><code>ifOperStatus</code></strong> gives out the operating status, <strong class="userinput"><code>ifAdmin-Status</code></strong> reveals whether the interface is administratively switched on or off.<a class="indexterm" id="IDX-CHP-11-0902"/><a class="indexterm" id="IDX-CHP-11-0903"/></p>

        <p>When specifying the warning limit here, we use the range <strong class="userinput"><code>1:1</code></strong>, so that the plugin gives out a warning if the interface is physically switched off, and the return value is thus 0. We will do without the definition of a critical status here, since there are only two states, "on" or "off." If the plugin returns a CRITICAL when the interface is switched off, you should use <strong class="userinput"><code>-c 1:1</code></strong> and omit <strong class="userinput"><code>-w</code></strong> entirely.</p>

        <p>If you just want to query the status of network interfaces, you should certainly take a look at the plugins <strong class="userinput"><code>check_ifstatus</code></strong> and <strong class="userinput"><code>check_ifoperstatus</code></strong>, described below, which provide slightly more operating convenience.</p>

        <p>If MIB-II or MIB <strong class="userinput"><code>ucdavis</code></strong> do not provide the desired information, you could also take a look at the MIB provided by the manufacturer. You can find out from <strong class="userinput"><code>mib-2.system</code></strong> in which partial tree the overall MIB is hidden:</p><a id="I_programlisting8_d1e23156"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -c public konica01 system</strong></span>
system.sysDescr.0 = Konica IP Controller
system.sysObjectID.0 = OID: enterprises.2364
...</pre>

        <p>The example involves a network-capable Konica photocopying machine called <strong class="userinput"><code>konica01.system.sysObjectID.0</code></strong> reveals that <strong class="userinput"><code>enterprises.2364</code></strong> serves as the entry point for device specific details. With <strong class="userinput"><code>snmpwalk</code></strong> you can then obtain further information:</p><a id="I_programlisting8_d1e23172"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -c public konica01 enterprises.2364</strong></span>
...
enterprises.2364.1.2.6.1.1.5.1.1 = "Ready to Print"
...</pre>

        <p>In the concrete case of this photocopier, you can query the current device status through <strong class="userinput"><code>enterprises.2364.1.2.6.1.1.5.1.1</code></strong>. Manufacturers usually store information on the implemented MIBs, so that you are not restricted to just guessing.</p>
      </div>
    </div>

    <div class="sect2" title="11.3.2 Checking several interfaces simultaneously">
      <div class="titlepage">
        <h2 class="title" id="heading_id_8"><a id="checking_several_interfaces_simultaneous"/>11.3.2 Checking several interfaces simultaneously</h2>
      </div>

      <p>Active network components such as switches usually have quite a large number of ports, and it would be very time-consuming to check every single one of them. Here the <strong class="userinput"><code>check_ifstatus</code></strong> plugin is very useful, since it tests all ports simultaneously. It retrieves the information necessary for this via SNMP, and has the following options:<a class="indexterm" id="IDX-CHP-11-0904"/><a class="indexterm" id="IDX-CHP-11-0905"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>This is the host name or IP address of the SNMP agent to be queried.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong> <strong class="userinput"><code>/ --community=</code></strong><strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong></span></dt>

          <dd>
            <p>This sets the community string for read access.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

          <dd>
            <p>This parameter is the alternative port on which the SNMP agent is running. The default is UDP port 161.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-v</code></strong> <strong class="userinput"><code><em class="replaceable"><code>version</code></em></code></strong> <strong class="userinput"><code>/ --snmp_version=</code></strong><strong class="userinput"><code><em class="replaceable"><code>version</code></em></code></strong></span></dt>

          <dd>
            <p>This parameter specifies the SNMP version (<strong class="userinput"><code>1</code></strong>, <strong class="userinput"><code>2</code></strong>, or <strong class="userinput"><code>3</code></strong>) for the query.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-x</code></strong> <strong class="userinput"><code><em class="replaceable"><code>list</code></em></code></strong> <strong class="userinput"><code>/ --exclude=</code></strong><strong class="userinput"><code><em class="replaceable"><code>list</code></em></code></strong></span></dt>

          <dd>
            <p>Use this to specify a comma-separated list of interface types that should not be queried (see example below).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code><em class="replaceable"><code>list</code></em></code></strong> <strong class="userinput"><code>/ --unused_ports=</code></strong><strong class="userinput"><code><em class="replaceable"><code>list</code></em></code></strong></span></dt>

          <dd>
            <p>Use this to specify a comma-separated list of all ports that should be excluded from the test. Like <strong class="userinput"><code>-x</code></strong>, the list consists of the indices of the interfaces which are determined from <strong class="userinput"><code>if Index: -u 13,14,15,16</code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-M</code></strong> <strong class="userinput"><code><em class="replaceable"><code>bytes</code></em></code></strong> <strong class="userinput"><code>/ --maxmsgsize=</code></strong><strong class="userinput"><code><em class="replaceable"><code>bytes</code></em></code></strong></span></dt>

          <dd>
            <p>This is the maximum size of the SNMP data packets; the default is <strong class="userinput"><code>1472</code></strong> bytes.</p>
          </dd>
        </dl>
      </div>

      <p>With exclusion lists it is possible to exclude certain interface types or port numbers from the test, perhaps because these are not occupied, or are connected to PCs or other devices that are not always running.</p>

      <p>With the following query we can find out, for example, which interface types are gathered together on the Cisco switch here named <strong class="userinput"><code>cisco01</code></strong>:</p><a id="I_programlisting8_d1e23343"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -c public cisco01 ifType</strong></span>
...
interfaces.ifTable.ifEntry.ifType.12 = ethernetCsmacd(6)
interfaces.ifTable.ifEntry.ifType.13 = other(1)
interfaces.ifTable.ifEntry.ifType.14 = propVirtual(53)
...</pre>

      <p>If the interface types <strong class="userinput"><code>other(1)</code></strong> and <strong class="userinput"><code>propVirtual(53)</code></strong> should now be excluded, the plugin is sent off with the two figures, separated by a comma, as the exclusion list <strong class="userinput"><code>-x 1,53</code></strong>:</p><a id="I_programlisting8_d1e23359"/>
      <pre class="programlisting">nagios@linux:local/libexec$ <span class="strong"><strong>./check_ifstatus -C public -H cisco01</strong></span> \
 <span class="strong"><strong>-x 1,53</strong></span>
CRITICAL: host 'cisco01', interfaces up: 2, down: 10, dormant: 0,
excluded: 4, unused: 0&lt;BR&gt;GigabitEthernet0/2: down
&lt;BR&gt;GigabitEthernet0/3: down &lt;BR&gt;GigabitEthernet0/4: down
&lt;BR&gt;GigabitEthernet0/10: down &lt;BR&gt;GigabitEthernet0/5: down
&lt;BR&gt;GigabitEthernet0/11: down &lt;BR&gt;GigabitEthernet0/6: down
&lt;BR&gt;GigabitEthernet0/7: down &lt;BR&gt;GigabitEthernet0/8: down
&lt;BR&gt;GigabitEthernet0/9: down &lt;BR&gt; |up=2, down=10, dormant=0, excluded=4, unu
sed=0</pre>

      <p>In reality, this plugin also does <span class="emphasis"><em>not</em></span> display its output over several lines, as the line wrap here may suggest. The fact that this information appears on the Nagios Web interface in a relatively clear form is because the HMTL formatting element <strong class="userinput"><code>&lt;BR&gt;</code></strong> is thrown in. This causes the output for each port to be displayed on a separate line. The <strong class="userinput"><code>|</code></strong> character defines the beginning of the performance data, which does not appear at all in the Web interface.</p>

      <p>A query of this type is implemented as a command object as follows:</p><a id="I_programlisting8_d1e23380"/>
      <pre class="programlisting">define command{
    command_name <span class="strong"><strong>check_ifstatus</strong></span>
    command_line $USER1$/<span class="strong"><strong>check_ifstatus</strong></span> -H $HOSTADDRESS$ -C
        $USER3$
 -x $ARG1$
}</pre>

      <p>Here the macro <strong class="userinput"><code>$USER3$</code></strong> is also used to define the community string in the file <strong class="userinput"><code>resource.cfg</code></strong>. Altogether, 32 <strong class="userinput"><code>$USERx$</code></strong> macros are available, of which the first two usually contain path details, and the others can be used in any way you want.</p>

      <p>If you would prefer to exclude ports rather than interface types, you can use the <strong class="userinput"><code>-u</code></strong> option instead of <strong class="userinput"><code>-x</code></strong> in the definition.</p>

      <p>If Nagios is to monitor the switch <strong class="userinput"><code>cisco01</code></strong>, as shown above, excluding the two interface types <strong class="userinput"><code>1</code></strong> and <strong class="userinput"><code>53</code></strong>, the corresponding service definition begins as follows:</p><a id="I_programlisting8_d1e23419"/>
      <pre class="programlisting">define service{
   service_description   Interfaces
   host_name             cisco01
<span class="strong"><strong>check_command         check_ifstatus!1, 53</strong></span>
   ...
}</pre>
    </div>

    <div class="sect2" title="11.3.3 Testing the operating status of individual interfaces">
      <div class="titlepage">
        <h2 class="title" id="heading_id_9"><a id="testing_the_operating_status_of_individu"/>11.3.3 Testing the operating status of individual interfaces</h2>
      </div>

      <p>To test an individual interface, you can use either the generic plugin <strong class="userinput"><code>check_snmp</code></strong> or <strong class="userinput"><code>check_ifoperstatus</code></strong>, which specifically tests the operating status (<strong class="userinput"><code>ifOperStatus</code></strong>) of the network card. The advantage of this over the generic plugin consists above all in its ease of use: instead of an index for the port, you can also specify its description here—for example, <strong class="userinput"><code>eth0</code></strong>.<a class="indexterm" id="IDX-CHP-11-0906"/><a class="indexterm" id="IDX-CHP-11-0907"/></p>

      <p><strong class="userinput"><code>check_ifoperstatus</code></strong> has the following options:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>This is the host name or IP address of the SNP agent to be queried.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong> <strong class="userinput"><code>/ --community=</code></strong><strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong></span></dt>

          <dd>
            <p>This parameter gives the community string for read access.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

          <dd>
            <p>As long as the SNMP agent is not running on UDP port 161, the port is specified with this option.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-k</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ifIndex</code></em></code></strong> <strong class="userinput"><code>/ --key=</code></strong><strong class="userinput"><code><em class="replaceable"><code>ifIndex</code></em></code></strong></span></dt>

          <dd>
            <p><span class="emphasis"><em>ifIndex</em></span> is the number of the network interface to be queried (such as the network card of a computer or the port of a switch).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-d</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ifDescr</code></em></code></strong> <strong class="userinput"><code>/ --descr=</code></strong><strong class="userinput"><code><em class="replaceable"><code>ifDescr</code></em></code></strong></span></dt>

          <dd>
            <p>Instead of the index key, the plugin processes the name of the interface from <span class="emphasis"><em>ifDescr</em></span> (see below).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-v</code></strong> <strong class="userinput"><code><em class="replaceable"><code>version</code></em></code></strong> <strong class="userinput"><code>/ --snmp_version=</code></strong><strong class="userinput"><code><em class="replaceable"><code>version</code></em></code></strong></span></dt>

          <dd>
            <p>This specifies the SNMP version (<strong class="userinput"><code>1, 2</code></strong>, or <strong class="userinput"><code>3</code></strong>) for the query.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong> <strong class="userinput"><code>/ --warn=</code></strong><strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong></span></dt>

          <dd>
            <p>This option selects the return value if the interface is dormant. The <span class="emphasis"><em>return_value</em></span> can be <strong class="userinput"><code>i</code></strong> (ignore the dormant status and return OK!), <strong class="userinput"><code>w</code></strong> (WARNING) or <strong class="userinput"><code>c</code></strong> (CRITICAL, the default).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-D</code></strong> <strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong> <strong class="userinput"><code>/ --admin-down=</code></strong><strong class="userinput"><code><em class="replaceable"><code>return_value</code></em></code></strong></span></dt>

          <dd>
            <p>What value (<strong class="userinput"><code>i</code></strong>, <strong class="userinput"><code>w</code></strong> or <strong class="userinput"><code>c</code></strong>) should the plugin return if the interface has been shut down administratively? The default, <strong class="userinput"><code>w</code></strong>, issues a warning, <strong class="userinput"><code>c</code></strong> returns CRITICAL, and <strong class="userinput"><code>i</code></strong> returns OK.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-M</code></strong> <strong class="userinput"><code><em class="replaceable"><code>bytes</code></em></code></strong> <strong class="userinput"><code>/ --maxmsgsize=</code></strong><strong class="userinput"><code><em class="replaceable"><code>bytes</code></em></code></strong></span></dt>

          <dd>
            <p>This is the maximum size of the SNMP data packets; the default is <strong class="userinput"><code>1472</code></strong> bytes.</p>
          </dd>
        </dl>
      </div>

      <p>On a system called <strong class="userinput"><code>igate</code></strong>, on which <strong class="userinput"><code>snmpwalk</code></strong> finds the following interfaces ...</p><a id="I_programlisting8_d1e23658"/>
      <pre class="programlisting">...
interfaces.ifTable.ifEntry.ifDescr.3 = ipsec0
interfaces.ifTable.ifEntry.ifDescr.4 = ipsec1

...
interfaces.ifTable.ifEntry.ifDescr.7 = eth0
interfaces.ifTable.ifEntry.ifDescr.8 = eth1
interfaces.ifTable.ifEntry.ifDescr.9 = eth2
interfaces.ifTable.ifEntry.ifDescr.10 = ppp0</pre>

      <p>the first Ethernet card is tested either with <strong class="userinput"><code>-k 7</code></strong> or with <strong class="userinput"><code>-d etho</code></strong>. Since the plugin in the second case has to query all <strong class="userinput"><code>ifDescr</code></strong> entries to determine the index itself, this variation generates a somewhat higher network load. It can be especially useful if not all network interfaces are active on a host, causing its index to change.</p>

      <p>The plugin itself reveals which index this port currently has:</p><a id="I_programlisting8_d1e23673"/>
      <pre class="programlisting">nagios@linux:local/libexec$ <span class="strong"><strong>./check_ifoperstatus -H igate -c public \</strong></span>
<span class="strong"><strong> -d eth0</strong></span>
OK: Interface eth0 (index 7) is up.</pre>

      <p>As the command object in the Nagios configuration, the call looks like this:</p><a id="I_programlisting8_d1e23683"/>
      <pre class="programlisting">define command{
    command_name <span class="strong"><strong>check_ifoperstatus</strong></span>
    command_line $USER1$/<span class="strong"><strong>check_ifoperstatus</strong></span> -H $HOSTADDRESS$ -C $USER
3$ -d $ARG1$
}</pre>

      <p>The <strong class="userinput"><code>$USER3$</code></strong> macro again contains the community string, defined in the file <strong class="userinput"><code>resource.cfg</code></strong>. The service definition for <strong class="userinput"><code>igate</code></strong> specifies the name of the interface to be tested as a plugin argument:</p><a id="I_programlisting8_d1e23703"/>
      <pre class="programlisting">define service{
   service_description   Interface eth0
   host_name             igate
<span class="strong"><strong>check_command         check_ifoperstatus!eth0</strong></span>
}</pre>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-10" id="ftn.CHP-11-FN-10">112</a>]</sup> POSIX regular expression, see <strong class="userinput"><code>man 7 regex</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-11" id="ftn.CHP-11-FN-11">113</a>]</sup> <strong class="userinput"><code>UCD-DEMO-MIB</code></strong> is an MIB included for demonstration purposes</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-12" id="ftn.CHP-11-FN-12">114</a>]</sup> See also the online help, with <strong class="userinput"><code>man snmpcmd</code></strong></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-13" id="ftn.CHP-11-FN-13">115</a>]</sup> The <strong class="userinput"><code>$USERx$</code></strong> macros are defined in the resource file <strong class="userinput"><code>resource.cfg</code></strong></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-14" id="ftn.CHP-11-FN-14">116</a>]</sup> <a class="ulink" href="http://www.lm-sensors.nu/">http://www.lm-sensors.nu/</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="11.4 Other SNMP-based Plugins">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="other_snmp-based_plugins"/>11.4 Other SNMP-based Plugins</h1>
    </div>

    <p>Apart form the SNMP plugins from the Nagios Plugin package, the Nagios community provides a large variety of other plugins for special purposes. Most of them can be found at <strong class="userinput"><code><a class="ulink" href="http://www.nagiosexchange.org/">http://www.nagiosexchange.org/</a></code></strong> in the category <code class="literal">Check Plugins | SNMP</code>.<sup>[<a class="footnote" href="#ftn.CHP-11-FN-15" id="CHP-11-FN-15">117</a>]</sup><a class="indexterm" id="IDX-CHP-11-0908"/></p>

    <div class="sect2" title="11.4.1 Monitoring hard drive space and processes with nagios-snmp-plugins">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="monitoring_hard_drive_space_and_processe"/>11.4.1 Monitoring hard drive space and processes with <strong class="userinput"><code>nagios-snmp-plugins</code></strong></h2>
      </div>

      <p>One of these is the package <strong class="userinput"><code>nagios-snmp-plugins</code></strong>,<sup>[<a class="footnote" href="#ftn.CHP-11-FN-16" id="CHP-11-FN-16">118</a>]</sup> which exists not only as source code but also as an RPM package (for Red Hat and Fedora). It contains two very easy-to-use plugins: <strong class="userinput"><code>check_snmp_disk</code></strong> and <strong class="userinput"><code>check_snmp_proc</code></strong>.<a class="indexterm" id="IDX-CHP-11-0911"/><a class="indexterm" id="IDX-CHP-11-0912"/><a class="indexterm" id="IDX-CHP-11-0913"/><a class="indexterm" id="IDX-CHP-11-0914"/><a class="indexterm" id="IDX-CHP-11-0909"/><a class="indexterm" id="IDX-CHP-11-0910"/><a class="indexterm" id="IDX-CHP-11-0915"/><a class="indexterm" id="IDX-CHP-11-0916"/></p>

      <p>Both absolutely require the NET-SNMP agent as the partner on the other side (see <a class="xref" href="../Text/ch11s02.html#the_net-snmp_daemon" title="11.2.2 The NET-SNMP daemon">11.2.2 The NET-SNMP daemon</a> from page 238) and use <strong class="userinput"><code>ucdavis.dskTable</code></strong> and <strong class="userinput"><code>ucdavis.prTable</code></strong> to test the processes and file systems specified in the configuration file <strong class="userinput"><code>snmpd.conf</code></strong>. Its options are restricted to specifying the host and the community string:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p>This is the host name or IP address of the NET-SNMP agent to be queried.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong> <strong class="userinput"><code>/ --community=</code></strong><strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong></span></dt>

          <dd>
            <p>This is the community string for read access.</p>
          </dd>
        </dl>
      </div>

      <p>The next example tests the available capacity of the <strong class="userinput"><code>/data</code></strong> file system; <strong class="userinput"><code>public</code></strong> is again used as the community string:</p><a id="I_programlisting8_d1e23845"/>
      <pre class="programlisting">nagios@linux:local/libexec$ <span class="strong"><strong>./check_snmp_disk -H swobspace -C public</strong></span>
/data: less than 50% free (= 95%) (/dev/md6)</pre>

      <p>The configuration of the NET-SNMP agent specifies, with the <strong class="userinput"><code>disk</code></strong> directive (<a class="xref" href="../Text/ch11s02.html#the_configuration_file_snmpd.conf" title="The configuration file snmpd.conf">The configuration file snmpd.conf</a>), <strong class="userinput"><code>50%</code></strong> as the threshold for this file system. In this case the plugin accordingly returns a CRITICAL. It can only distinguish between an error and OK; it does not have a WARNING status.</p>

      <p>Using <strong class="userinput"><code>check_snmp_proc</code></strong> is just as easy:</p><a id="I_programlisting8_d1e23865"/>
      <pre class="programlisting">nagios@linux:local/libexec$ <span class="strong"><strong>./check_snmp_proc -H localhost -C public</strong></span>
No slapd process running.</pre>

      <p>The plugin again tests the processes defined in the configuration of the NET-SNMP agent with the <strong class="userinput"><code>proc</code></strong> directive (<a class="xref" href="../Text/ch11s02.html#the_configuration_file_snmpd.conf" title="The configuration file snmpd.conf">The configuration file snmpd.conf</a>). The process <strong class="userinput"><code>slapd</code></strong> is missing here, which is why a CRITICAL is returned. The return value is revealed by <strong class="userinput"><code>echo $?</code></strong>.</p>

      <p>The corresponding command objects are defined in a similar unspectacular way:</p><a id="I_programlisting8_d1e23886"/>
      <pre class="programlisting">define command{
    command_name<span class="strong"><strong>   check_snmp_proc</strong></span>
    command_line      $USER1$/<span class="strong"><strong>check_snmp_proc</strong></span> -H $HOSTADDRESS$ -C $USER3$
}

define command{
    command_name <span class="strong"><strong>   check_snmp_disk</strong></span>
    command_line       $USER1$/<span class="strong"><strong>check_snmp_disk</strong></span> -H $HOSTADDRESS$ -C $USER3$
}</pre>

      <p>This definition also assumes that the community string is stored in the <strong class="userinput"><code>$USER3$</code></strong> macro in the file <strong class="userinput"><code>resource.cfg</code></strong>. In order to query the NET-SMTPD on the computer <strong class="userinput"><code>linux01</code></strong> for its hard drive load, the following service object is defined:</p><a id="I_programlisting8_d1e23911"/>
      <pre class="programlisting">define service{
   service_description   DISK
   host_name             linux01
<span class="strong"><strong>check_command         check_snmp_disk</strong></span>
   ...
}</pre>
    </div>

    <div class="sect2" title="11.4.2 Observing the load on network interfaces with check-iftraffic">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="observing_the_load_on_network_interfaces"/>11.4.2 Observing the load on network interfaces with <strong class="userinput"><code>check-iftraffic</code></strong></h2>
      </div>

      <p>The MIB-II contains only numbers that provide information on the load on network interfaces, but no average values for the used bandwidth, for example. If the vendor has not specifically made such an entry available in his MIB, then you will always have to make a note of the last counter status and the timestamp, so that you can work out the relative usage yourself.<a class="indexterm" id="IDX-CHP-11-0918"/><a class="indexterm" id="IDX-CHP-11-0919"/><a class="indexterm" id="IDX-CHP-11-0917"/></p>

      <p><strong class="userinput"><code><a class="ulink" href="http://www.nagiosexchange.org/">http://www.nagiosexchange.org/</a></code></strong> introduces two plugins that take over this task. The Perl-based plugin <strong class="userinput"><code>check_traffic</code></strong><sup>[<a class="footnote" href="#ftn.CHP-11-FN-17" id="CHP-11-FN-17">119</a>]</sup> writes the query values into a <span class="emphasis"><em>round-robin database</em></span> (RRD, see <a class="xref" href="../Text/ch19s02.html" title="19.2 Graphs for the Web with Nagiosgraph">19.2 Graphs for the Web with Nagiosgraph</a>), which makes it somewhat more complex to handle.<a class="indexterm" id="IDX-CHP-11-0920"/></p>

      <p>The same purpose is achieved, but with more simple means, by the <strong class="userinput"><code>check_iftraffic.pl</code></strong> plugin.<sup>[<a class="footnote" href="#ftn.CHP-11-FN-18" id="CHP-11-FN-18">120</a>]</sup>. It has the following options:<a class="indexterm" id="IDX-CHP-11-0921"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

          <dd>
            <p><em class="replaceable"><code>address</code></em> is the host name or IP address of the NET-SNMP agent that is to be queried.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong> <strong class="userinput"><code>/ --community=</code></strong><strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong></span></dt>

          <dd>
            <p><strong class="userinput"><code><em class="replaceable"><code>password</code></em></code></strong> is the community string for read access. The default is public.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-i</code></strong> <strong class="userinput"><code><em class="replaceable"><code>ifDescr</code></em></code></strong> <strong class="userinput"><code>/ --interface=</code></strong><strong class="userinput"><code><em class="replaceable"><code>ifDescr</code></em></code></strong></span></dt>

          <dd>
            <p>From the interface name <strong class="userinput"><code><em class="replaceable"><code>ifDescr</code></em></code></strong> the plugin determines the index so that it can access other values (e. g., the counter states).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-b</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --bandwith=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

          <dd>
            <p>This is the maximum bandwidth of the interface in bits (see <strong class="userinput"><code>-u</code></strong>).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-u</code></strong> <strong class="userinput"><code><em class="replaceable"><code>unit</code></em></code></strong> <strong class="userinput"><code>/ --units=</code></strong><strong class="userinput"><code><em class="replaceable"><code>unit</code></em></code></strong></span></dt>

          <dd>
            <p>This is the unit for bandwidth specification with <strong class="userinput"><code>-b</code></strong>. Possible values are <strong class="userinput"><code>g</code></strong> (Gbit), <strong class="userinput"><code>m</code></strong> (Mbit), <strong class="userinput"><code>k</code></strong> (kbit) and the default <strong class="userinput"><code>b</code></strong> (bit): <strong class="userinput"><code>-b 100 -u m</code></strong> corresponds to 100 Megabits (Fast Ethernet).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --warning=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

          <dd>
            <p>If traffic exceeds this warning limit in percent (default: <strong class="userinput"><code>85</code></strong> percent), the plugin issues a WARNING.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>integer</code></em></code></strong></span></dt>

          <dd>
            <p>This is the critical threshold in percent (default: <strong class="userinput"><code>92</code></strong> percent).</p>
          </dd>
        </dl>
      </div>

      <p>The plugin saves the timestamp and counter status of the interface queried in files in <strong class="userinput"><code>/tmp</code></strong>, to which it adds the prefix <strong class="userinput"><code>traffic</code></strong>. So if you are using a different user ID than <strong class="userinput"><code>nagios</code></strong> for the manual test on the command line, you should delete the files <strong class="userinput"><code>/tmp/traffic</code></strong><strong class="userinput"><code><em class="replaceable"><code>_interface_computer</code></em></code></strong> before activating the appropriate Nagios service.</p>

      <p>The following command line example queries the Fast Ethernet network interface <strong class="userinput"><code>etho</code></strong> on the computer <strong class="userinput"><code>linux01</code></strong>, which in theory has a bandwidth of 100 Mbit:</p><a id="I_programlisting8_d1e24151"/>
      <pre class="programlisting">nagios@linux:local/libexec$ <span class="strong"><strong>./check_iftraffic.pl -H linux01 -i etho \</strong></span>
<span class="strong"><strong>-b 100 -u m</strong></span>
Total RX Bytes: 60.32 MB, Total TX Bytes: 26.59 MB&lt;br&gt; Average Traffic:
1.14 kB/s (0.0%) in, 777.93 B/s (0.0%) out | inUsage=0.0,85,98 outUsage
=0.0,85,98</pre>

      <p>The amount of data transmitted here is reported separately by the plugin, depending on the direction, and here it announces 60.32 (<strong class="userinput"><code>RX</code></strong>, "received") and 26.59 MB (<strong class="userinput"><code>TX</code></strong>, "transmitted"). The text contains the HTML element <strong class="userinput"><code>&lt;br&gt;</code></strong> (line break), to display the output in the Nagios Web interface on two lines. This is followed by the average transmission rate, again separated for incoming and outgoing data traffic. The performance data (see <a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a>, page 404) after the <strong class="userinput"><code>|</code></strong> sign contain only the average load as a percentage, each separated by incoming and outgoing values. The numbers <strong class="userinput"><code>85</code></strong> and <strong class="userinput"><code>98</code></strong> are the default values for the warning and critical limits.<a class="indexterm" id="IDX-CHP-11-0922"/><a class="indexterm" id="IDX-CHP-11-0923"/></p>

      <p>The corresponding command object is implemented as follows:</p><a id="I_programlisting8_d1e24194"/>
      <pre class="programlisting">define command{
    command_name<span class="strong"><strong>   check_iftraffic</strong></span>
    command_line      $USER1$/<span class="strong"><strong>check_iftraffic.pl</strong></span> -H $HOSTADDRESS$ -C $USER3$
-i $ARG1$ -b $ARG2$ -u m
}</pre>

      <p>If the definition is taken over literally, you must define the community string in the <strong class="userinput"><code>$USER3$</code></strong> macro. If you only generally use <strong class="userinput"><code>public</code></strong> as the password, it is better to write <strong class="userinput"><code>-C public</code></strong> instead of <strong class="userinput"><code>-C $USER3$</code></strong>.</p>

      <p>To simplify the call of the command within the following service definition, we set the unit to Mbit/second (<strong class="userinput"><code>-u m</code></strong>).</p><a id="I_programlisting8_d1e24222"/>
      <pre class="programlisting">define service{
   service_description   Traffic load eth0
   host_name             linux01
<span class="strong"><strong>check_command         check_iftraffic!eth0!100</strong></span>
   ...
   max_check_attempts    1
   normal_check_interval 5
   retry_check_interval  5
   ...
}</pre>

      <p><strong class="userinput"><code>check_iftraffic</code></strong> calculates the bandwidth used by comparing two counter states at different times. Because Nagios does not test exactly down to the second, the check interval you choose should not be too small. The <span class="emphasis"><em>Multi Router Traffic Grapher</em></span>,<sup>[<a class="footnote" href="#ftn.CHP-11-FN-19" id="CHP-11-FN-19">121</a>]</sup> which displays the bandwidth used in graphic form, normally works at five-minute intervals.</p>

      <p>If you select <strong class="userinput"><code>max_check_attempts</code></strong> other than <strong class="userinput"><code>1</code></strong>, you should make sure that the retry interval (<strong class="userinput"><code>retry_check_interval</code></strong>) is the same as the normal check interval. For <strong class="userinput"><code>max_check_attempts 1</code></strong> this makes no difference, but you have to define a <strong class="userinput"><code>retry_check_interval</code></strong> at some time or other.</p>
    </div>

    <div class="sect2" title="11.4.3 The manubulon.com plugins for special application purposes">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="the_manubulon.com_plugins_for_s"/>11.4.3 The <a class="ulink" href="http://manubulon.com">manubulon.com</a> plugins for special application purposes</h2>
      </div>

      <p>The Nagios Exchange, with the SNMP plugins to be found under <a class="ulink" href="http://www.manubulon.com/nagios/">http://www.manubulon.com/nagios/</a> (see <a class="xref" href="../Text/ch11s04.html#the_manubulon.com-snmp_plu" title="Table 11-4. The manubulon.com-SNMP plugins">Table 11-4</a>), also includes some that are customized to a specific application, such as querying hard drive space. They are relatively simple to use.<a class="indexterm" id="IDX-CHP-11-0924"/><a class="indexterm" id="IDX-CHP-11-0925"/><a class="indexterm" id="IDX-CHP-11-0926"/><a class="indexterm" id="IDX-CHP-11-0927"/><a class="indexterm" id="IDX-CHP-11-0928"/></p>

      <div class="table">
        <a id="the_manubulon.com-snmp_plu"/>

        <p class="title">Table 11-4. The <a class="ulink" href="http://manubulon.com">manubulon.com</a>-SNMP plugins</p>

        <div class="table-contents">
          <table class="sgc-3" summary="The manubulon.com-SNMP plugins">
            <colgroup>
              <col/>
              <col/>
            </colgroup>

            <thead>
              <tr>
                <th class="sgc-1" valign="bottom">
                  <p>Plugin</p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Description</p>
                </th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_sn.mp_storage.pl</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Query of storage devices (hard drives, swap space, main memory, etc.)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_snmp_int.pl</code></strong><a class="indexterm" id="IDX-CHP-11-0929"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Interface status and load</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_snmp_process.pl</code></strong><a class="indexterm" id="IDX-CHP-11-0930"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>processes: status, CPU and memory usage</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_snmp_load.pl</code></strong><a class="indexterm" id="IDX-CHP-11-0931"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>System load</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_snmp_mem.pl</code></strong><a class="indexterm" id="IDX-CHP-11-0932"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>main memory and swap usage</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_snmp_vrrp.pl</code></strong><a class="indexterm" id="IDX-CHP-11-0933"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>querying a Nokia-VRRP cluster <sup>[<a class="footnote" href="#ftn.CHP-11-FN-20" id="CHP-11-FN-20">a</a>]</sup><a class="indexterm" id="IDX-CHP-11-0934"/></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_snmp_cpfw.pl</code></strong><a class="indexterm" id="IDX-CHP-11-0935"/><a class="indexterm" id="IDX-CHP-11-0936"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>querying a Checkpoint firewall-1<sup>[<a class="footnote" href="#ftn.CHP-11-FN-21" id="CHP-11-FN-21">b</a>]</sup></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_snmp_env.pl</code></strong><a class="indexterm" id="IDX-CHP-11-0937"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>tests environment parameters of switches such as temperature, power supply unit, and fan (Cisco, Foundry, and others)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>check_snmp_win.pl</code></strong><a class="indexterm" id="IDX-CHP-11-0938"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Queries Windows services via SNMP<a class="indexterm" id="IDX-CHP-11-0939"/><a class="indexterm" id="IDX-CHP-11-0940"/><a class="indexterm" id="IDX-CHP-11-0941"/></p>
                </td>
              </tr>
            </tbody>

            <tbody class="footnotes">
              <tr>
                <td colspan="2">
                  <div class="footnote">
                    <p><sup>[<a class="para" href="#CHP-11-FN-20" id="ftn.CHP-11-FN-20">a</a>]</sup> The abbreviation VRRP stands for <span class="emphasis"><em>Virtual Router Redundancy Protocol</em></span>.</p>
                  </div>

                  <div class="footnote">
                    <p><sup>[<a class="para" href="#CHP-11-FN-21" id="ftn.CHP-11-FN-21">b</a>]</sup> <a class="ulink" href="http://www.checkpoint.com/products/firewall-1/">http://www.checkpoint.com/products/firewall-1/</a></p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p>We will introduce two of the plugins—<strong class="userinput"><code>check_snmp_storage.pl</code></strong> and check <strong class="userinput"><code>_snmp_load.pl</code></strong>—in detail here.</p>

      <div class="sect3" title="Keeping checks on storage media with check_snmp_storage">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="keeping_checks_on_storage_media_with"/>Keeping checks on storage media with <strong class="userinput"><code>check_snmp_storage</code></strong></h3>
        </div>

        <p>While the <strong class="userinput"><code>check_snmp_disk</code></strong> plugin, introduced in <a class="xref" href="../Text/ch11s04.html#monitoring_hard_drive_space_and_processe" title="11.4.1 Monitoring hard drive space and processes with nagios-snmp-plugins">11.4.1 Monitoring hard drive space and processes with nagios-snmp-plugins</a> from page 256, only checks the file systems entered in the NET-SNMP configuration, <strong class="userinput"><code>check_snmp_storage.pl</code></strong> is capable of querying any storage media—even swap space or main memory—without previous configuration on the target host. <strong class="userinput"><code>check_snmp_storage.pl</code></strong> tests the partial tree <strong class="userinput"><code>mib-2</code></strong>. host here, while <strong class="userinput"><code>check_snmp_mem.pl</code></strong> uses <strong class="userinput"><code>ucdavis.memory</code></strong>, so that it remains restricted to NET-SNMP.<a class="indexterm" id="IDX-CHP-11-0942"/><a class="indexterm" id="IDX-CHP-11-0943"/><a class="indexterm" id="IDX-CHP-11-0944"/><a class="indexterm" id="IDX-CHP-11-0945"/><a class="indexterm" id="IDX-CHP-11-0946"/><a class="indexterm" id="IDX-CHP-11-0947"/><a class="indexterm" id="IDX-CHP-11-0948"/><a class="indexterm" id="IDX-CHP-11-0949"/></p>

        <p>The fact that you do not have to battle with OIDs, but instead can work with descriptions of the <strong class="userinput"><code>swap space</code></strong> type to specify the type of the storage medium, provides a certain level of convenience. These can be queried with <strong class="userinput"><code>snmpwalk</code></strong> as follows:</p><a id="I_programlisting8_d1e24512"/>
        <pre class="programlisting">user@linux:~$ <span class="strong"><strong>snmpwalk -v1 -c public swobspace hrStorageDescr</strong></span>
hrStorageDescr.2 = STRING: Real Memory
hrStorageDescr.3 = STRING: Swap Space
hrStorageDescr.4 = STRING: /
...
hrStorageDescr.11 = STRING: /net/swobspace/b</pre>

        <p>When the plugin is called, the text specified after the <strong class="userinput"><code>STRING</code></strong>: is sufficient or—if unique—a part of this:</p><a id="I_programlisting8_d1e24522"/>
        <pre class="programlisting">nagios@linux:local/libexec$ <span class="strong"><strong>./check_snmp_storage.pl -H swobspace \</strong></span>
 <span class="strong"><strong>-C public -m /net/swobspace/b -w 90 -c 95</strong></span>
/net/swobspace/b : 91 %used (34842MB/38451MB) (&lt; 90) : WARNING
nagios@linux:local/libexec$ <span class="strong"><strong>./check_snmp_storage.pl -H swobspace \</strong></span>
 <span class="strong"><strong>-C public -m "Swap" -w 50 -c 75 -f</strong></span>
Swap Space : 0 %used (0MB/3906MB) (&lt; 50) : OK | 'Swap Space'=0MB;1953;
2930;0;3906</pre>

        <p>In the second example, it is sufficient to specify <strong class="userinput"><code>Swap</code></strong>, in order to query the data for <strong class="userinput"><code>Swap Space</code></strong>, since the pattern is unique. The <strong class="userinput"><code>-f</code></strong> option ensures that <strong class="userinput"><code>check_snmp_storage.pl</code></strong> will include performance data in its output.</p>

        <p><strong class="userinput"><code>-w</code></strong> and <strong class="userinput"><code>-c</code></strong> specify in normal fashion the warning or critical limits in percent of the available memory space. The following overview lists all the options:</p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

            <dd>
              <p>This is the host name or IP address of the NET-SNMP agent that is to be queried.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> <strong class="userinput"><code>/ --community=</code></strong><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong></span></dt>

            <dd>
              <p>This is the community string for read access.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

            <dd>
              <p><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> specifies an alternative port if the SNMP agent is not running on the default UDP port 161.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-m</code></strong> <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> <strong class="userinput"><code>/ --name=</code></strong><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong></span></dt>

            <dd>
              <p><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> contains a description of the device to be queried, corresponding to its description in <strong class="userinput"><code>hrStorageDescr</code></strong> (see above), such as <strong class="userinput"><code>-m "Swap Space"</code></strong> for swap devices, <strong class="userinput"><code>-m "Real Memory"</code></strong> for the main memory, or <strong class="userinput"><code>-m "/usr"</code></strong> for the partition mounted under <strong class="userinput"><code>/usr</code></strong> in the file tree.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>percent</code></em></code></strong> <strong class="userinput"><code>/ --warn=</code></strong><strong class="userinput"><code><em class="replaceable"><code>percent</code></em></code></strong></span></dt>

            <dd>
              <p>A warning is given in the default if the proportion of used memory is larger than the specified threshold. Other warning limits can be defined with the <strong class="userinput"><code>-T</code></strong> parameter.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>crit</code></em></code></strong> <strong class="userinput"><code>/ --critical=</code></strong><strong class="userinput"><code><em class="replaceable"><code>crit</code></em></code></strong></span></dt>

            <dd>
              <p>In the default, the status is categorized as critical if the proportion of used memory is larger than the specified critical limit. Other critical limits can also be specified with the <strong class="userinput"><code>-T</code></strong> parameter.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-T</code></strong> <strong class="userinput"><code><em class="replaceable"><code>option</code></em></code></strong> <strong class="userinput"><code>/ --type=</code></strong><strong class="userinput"><code><em class="replaceable"><code>option</code></em></code></strong></span></dt>

            <dd>
              <p>What do the critical and the warning thresholds refer to?</p>
            </dd>
          </dl>
        </div>

        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem">
              <p><strong class="userinput"><code>pu</code></strong> (<span class="emphasis"><em>percent used</em></span>): used capacity in percent</p>
            </li>

            <li class="listitem">
              <p><strong class="userinput"><code>pl</code></strong> (<span class="emphasis"><em>percent left</em></span>): free capacity in percent</p>
            </li>

            <li class="listitem">
              <p><strong class="userinput"><code>bu</code></strong> (<span class="emphasis"><em>bytes used</em></span>): used capacity in megabytes</p>
            </li>

            <li class="listitem">
              <p><strong class="userinput"><code>bl</code></strong> (<span class="emphasis"><em>bytes left</em></span>): free capacity in megabytes</p>
            </li>
          </ul>
        </div>

        <p>The default is -<strong class="userinput"><code>T pu</code></strong>.</p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>-r</code></strong> <strong class="userinput"><code>/ --noregexp</code></strong></span></dt>

            <dd>
              <p>Normally the description in the <strong class="userinput"><code>-m</code></strong> parameter is treated as a regular expression. For example, <strong class="userinput"><code>/var</code></strong> here stands for all file systems containing <strong class="userinput"><code>/var</code></strong>, for example <strong class="userinput"><code>/var and /var/spool/imap</code></strong>, provided that these are really two independent file systems. The <strong class="userinput"><code>-r</code></strong> option switches off the regular expression capability, so that specifying <strong class="userinput"><code>/var</code></strong> will then match this file system exactly, but not <strong class="userinput"><code>/var/spool/imap</code></strong>, for example.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-s</code></strong> <strong class="userinput"><code>/ --sum</code></strong></span></dt>

            <dd>
              <p>Instead of performing individual tests for several specified storage media, the total occupied space is added up and compared to the total capacity. It is then determined whether thresholds are exceeded.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-i</code></strong> <strong class="userinput"><code>/ --index</code></strong></span></dt>

            <dd>
              <p>With <strong class="userinput"><code>-m</code></strong>, a text is normally specified, which turns up again in the description <strong class="userinput"><code>hrStorageDescr</code></strong>. With the <strong class="userinput"><code>-i</code></strong> option, the index table is used instead of the description. Here the Regexp capability also applies: <strong class="userinput"><code>-m 2</code></strong> matches all the entries containing the number <strong class="userinput"><code>2</code></strong> in the index (that is, <strong class="userinput"><code>2, 12, 20</code></strong>, etc.). It then makes sense to use the <strong class="userinput"><code>-r</code></strong> option at the same time.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-e</code></strong> <strong class="userinput"><code>/ --exclude</code></strong></span></dt>

            <dd>
              <p>Now all the memories that are matched by the <strong class="userinput"><code>-m</code></strong> specification are excluded from the test, the remaining ones are included in the test.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-f</code></strong> <strong class="userinput"><code>/--perfparse</code></strong></span></dt>

            <dd>
              <p>This option provides an additional output of performance data that is not shown in the Web interface but can be evaluated by additonal tools (see <a class="xref" href="../Text/ch19.html" title="Chapter 19. Graphic Display of Performance Data">Chapter 19</a>).</p>
            </dd>
          </dl>
        </div>
      </div>

      <div class="sect3" title="Testing system load with check_snmp_load">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="testing_system_load_with"/>Testing system load with <strong class="userinput"><code>check_snmp_load</code></strong></h3>
        </div>

        <p>The plugin compares either the average system load in form of averages of 1 min, 5 min, and 15 min, or the CPU load in percent.<a class="indexterm" id="IDX-CHP-11-0952"/><a class="indexterm" id="IDX-CHP-11-0953"/><a class="indexterm" id="IDX-CHP-11-0954"/><a class="indexterm" id="IDX-CHP-11-0955"/><a class="indexterm" id="IDX-CHP-11-0956"/><a class="indexterm" id="IDX-CHP-11-0957"/><a class="indexterm" id="IDX-CHP-11-0950"/><a class="indexterm" id="IDX-CHP-11-0951"/></p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong> <strong class="userinput"><code>/ --host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

            <dd>
              <p>This is the host name or IP address of the NET-SNMP agent to be queried.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-C</code></strong> <strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong> <strong class="userinput"><code>/ --community=</code></strong><strong class="userinput"><code><em class="replaceable"><code>string</code></em></code></strong></span></dt>

            <dd>
              <p>This is the community string for read access.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> <strong class="userinput"><code>/ --port=</code></strong><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

            <dd>
              <p><strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong> is the alternative UDP port on which the SNMP agent is running. The default is UDP port 161.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-w</code></strong> <strong class="userinput"><code><em class="replaceable"><code>warning_limit</code></em></code></strong> <strong class="userinput"><code>/ --warn=</code></strong><strong class="userinput"><code><em class="replaceable"><code>warning_limit</code></em></code></strong></span></dt>

            <dd>
              <p>The warning limit is given either as a simple integer value in percent (e.g., <strong class="userinput"><code>90</code></strong>) or as an integer triplet separated by commas, which defines the thresholds for the system load average for one, five, and 15 minutes (e.g., <strong class="userinput"><code>8,5,5</code></strong>). The percentage load, on the other hand, always refers to the CPU load of the last minute.</p>

              <p>If the plugin queries a NET-SNMP agent, you <span class="emphasis"><em>must</em></span> additionally specify the <strong class="userinput"><code>-L</code></strong> option in the second variation, for the percentage, <strong class="userinput"><code>-N</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>critical_limit</code></em></code></strong> <strong class="userinput"><code>/ --crit=</code></strong><strong class="userinput"><code><em class="replaceable"><code>critical_limit</code></em></code></strong></span></dt>

            <dd>
              <p>This specifies a critical limit; the syntax is the same as that for <strong class="userinput"><code>-w</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-L</code></strong> <strong class="userinput"><code>/ --linux</code></strong></span></dt>

            <dd>
              <p>This option specifies that the plugin queries the system mode of a Linux system via NET-SNMP.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-A</code></strong> <strong class="userinput"><code>/ --as400</code></strong></span></dt>

            <dd>
              <p>This option specifies that the CPU loaded on an AS/400 machine is queried.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-I</code></strong> <strong class="userinput"><code>/ --cisco</code></strong></span></dt>

            <dd>
              <p>This option specifies that the CPU load of a Cisco network component is involved.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-N</code></strong> <strong class="userinput"><code>/ --netsnmp</code></strong></span></dt>

            <dd>
              <p>If the plugin queries the percentage CPU load of a Linux system via NET-SNMP, the <strong class="userinput"><code>-N</code></strong> option must be specified.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>-f</code></strong> <strong class="userinput"><code>/--perfparse</code></strong></span></dt>

            <dd>
              <p>This option ensures the output of performance data that is not displayed in the Web interface, but can be evaluated by additional tools (see <a class="xref" href="../Text/ch19.html" title="Chapter 19. Graphic Display of Performance Data">Chapter 19</a>).</p>
            </dd>
          </dl>
        </div>

        <p>The following example queries the system load on the computer <strong class="userinput"><code>swobspace</code></strong> via NET-SNMP and specifies threshold values for the one-, five-, and fifteen-minute averages:</p><a id="I_programlisting8_d1e25058"/>
        <pre class="programlisting">nagios@linux:local/libexec$ <span class="strong"><strong>./check_snmp_load.pl -H swobspace \</strong></span>
 <span class="strong"><strong>-C public -w 1,2,3 -c 3,5,6 -L</strong></span>
Load : 0.05 0.07 0.06 : OK
nagios@linux:local/libexec$ <span class="strong"><strong>./check_snmp_load.pl -H swobspace \</strong></span>
<span class="strong"><strong>-C public -N -w 80 -c 90 -f</strong></span>
CPU used 3.0 : &lt; 80 : OK | cpu_prct_used=3%;80;90</pre>

        <p>The second example involves the percentage CPU load on the same machine. Here we additionally request performance data, which as usual repeats not only the measured value but also the thresholds.<a class="indexterm" id="IDX-CHP-11-0958"/><a class="indexterm" id="IDX-CHP-11-0959"/></p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-15" id="ftn.CHP-11-FN-15">117</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/SNMP.51.0.html">http://www.nagiosexchange.org/SNMP.51.0.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-16" id="ftn.CHP-11-FN-16">118</a>]</sup> <a class="ulink" href="ftp://ftp.hometree.net/pub/nagios-snmp-plugins/">ftp://ftp.hometree.net/pub/nagios-snmp-plugins/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-17" id="ftn.CHP-11-FN-17">119</a>]</sup> <a class="ulink" href="http://nagios.sourceforge.net/download/contrib/misc/check_traffic/">http://nagios.sourceforge.net/download/contrib/misc/check_traffic/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-18" id="ftn.CHP-11-FN-18">120</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org//51;37">http://www.nagiosexchange.org//51;37</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-11-FN-19" id="ftn.CHP-11-FN-19">121</a>]</sup> <a class="ulink" href="http://www.mrtg.org/">http://www.mrtg.org/</a></p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;12.&#xA0;The Nagios Notification System">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_nagios_notification_system"/>Chapter 12. The Nagios Notification System</h1>
    </div>

    <p>What would be the point of system and network monitoring if it did not inform the right contact partner when things went wrong? Hardly any system or network administrator can afford to keep an eye on the Nagios Web interface continually and wait for changes in status to occur. A practical working system must inform the admin actively (push information), so that the admin has time to devote to other things and needs to intervene only when Nagios raises the alarm.</p>

    <p>Whether a notification system does its job in practice or not is ultimately decided by how well it can be adjusted to the requirements of a specific situation. What may already be a critical error for one person may, for another, not be normal but still tolerable, and nothing is worse than being bombarded with supposed error messages that are not even seen as errors in a certain environment. An excess of wrong information can make the administrator careless, and at some point the real problems get lost in a flood of false messages.</p>

    <p>Nagios provides a sophisticated notification system allowing your own environment to be fine-tuned to your own requirements. The wide range of settings at first seem confusing, but once you have understood the basic principle, everything becomes much clearer.</p>

    <p>The efforts to keep Nagios small and modular also apply to the notification system: sending a message is again left by the system to external programs: from a simple e-mail through SMS, down to hardware solutions—such as a real traffic light on the server cabinet—anything is possible.</p>

    <div class="sect1" title="12.1 Who Should be Informed of What, When?">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="who_should_be_informed_of_what_comma_wh"/>12.1 Who Should be Informed of What, When?</h1>
      </div>

      <p>In order for Nagios to send meaningful messages, the administrator must answer four questions:</p>

      <div class="itemizedlist">
        <ul class="itemizedlist">
          <li class="listitem">
            <p>When should the system generate a message?</p>
          </li>

          <li class="listitem">
            <p>When should it be delivered?</p>
          </li>

          <li class="listitem">
            <p>Whom should the system inform?</p>
          </li>

          <li class="listitem">
            <p>How should the message be sent?</p>
          </li>
        </ul>
      </div>

      <div class="figure">
        <a id="an_overview_of_the_notification_system"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject9_d1e25116"/><img alt="An overview of the notification system" src="../Images/tagoreillycom20081104nostarchimages223820.png"/></div>

        <p class="title">Figure 12-1. An overview of the notification system</p>
      </div>

      <p><a class="xref" href="../Text/ch12.html#an_overview_of_the_notification_system" title="Figure 12-1. An overview of the notification system">Figure 12-1</a> gives a rough outline of the concept. The service and host check generate the message, which then runs through various filters,<sup>[<a class="footnote" href="#ftn.CHP-12-FN-1" id="CHP-12-FN-1">122</a>]</sup> which usually refer to the time. The <span class="emphasis"><em>contact</em></span> refers to the person whom Nagios should inform. If the message has passed all tests, the system hands it to an external program, which informs the respective contact.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-12-FN-1" id="ftn.CHP-12-FN-1">122</a>]</sup> Strictly speaking, filters defined in the host or service prevent a message from being created, instead of filtering already generated messages. To keep things simple, however, we pretend that Nagios has created a message that is then discarded by a corresponding filter.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="12.2 When Does a Message Occur?">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="when_does_a_message_occur_question"/>12.2 When Does a Message Occur?</h1>
    </div>

    <p>Each message is preceded by a host or service check, which determines the current status. In the following two cases it generates a message:</p>

    <div class="itemizedlist">
      <ul class="itemizedlist">
        <li class="listitem">
          <p>One hard state changes to another hard state.<a class="indexterm" id="IDX-CHP-12-0960"/></p>
        </li>

        <li class="listitem">
          <p>One computer or service remains in a hard error state. (The test therefore confirms a problem that already exists.)</p>
        </li>
      </ul>
    </div>

    <p>To remind you: the <strong class="userinput"><code>max_check_attempts</code></strong> parameter (see <a class="xref" href="../Text/ch02s03.html" title="2.3 Defining the Machines to Be Monitored, with host">2.3 Defining the Machines to Be Monitored, with host</a> and <a class="xref" href="../Text/ch02s05.html" title="2.5 Defining Services to Be Monitored with service">2.5 Defining Services to Be Monitored with service</a>) defines in host and service objects how often a test should be repeated before Nagios categorizes a new status as "hard." If it is set to <strong class="userinput"><code>1</code></strong>, this is immediately the case and is followed by the corresponding message. With a value greater than 1, the system repeats the test that number of times, and only if they all come to the same new result—such as determining the CRITICAL error status—does the status finally change to the new hard state, thus triggering a new notification.<a class="indexterm" id="IDX-CHP-12-0961"/></p>

    <p>As long as Nagios has not exhausted the specified number of repeats, a soft state exists. If the old status reoccurs before these have finished, the administrator remains uninformed unless he looks at the Web interface or in the log file. Ultimately the administrator is only interested in genuine unsolved problems. On the other hand, to assess availability as such, it normally does matter if a service is not available for minutes on end, which is why the soft states are also taken into account in the evaluation.<a class="indexterm" id="IDX-CHP-12-0962"/></p>
  </div>


  <div class="sect1" title="12.3 The Message Filter">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_message_filter"/>12.3 The Message Filter</h1>
    </div>

    <p>Even if you define on a systemwide basis that Nagios may bring attention to errors not just through the Web interface and log files but also via e-mail and/or SMS, filter parameters in the host and service definition may in individual cases cancel out these basic decisions. In all cases the final word is had by the filters defined for the relevant contact. Which parameters play a role on each of these three levels (systemwide, host/service, contact), is described in <a class="xref" href="../Text/ch12s03.html#the_filter_sequence_in_the_nagios_notif" title="Figure 12-2. The filter sequence in the Nagios notification system (some parameters are only available starting with Nagios version 3.0)">Figure 12-2</a>.</p>

    <p>If a filter stops a notification, the filter chain ends "in a vacuum," so to speak—filter options further down in the hierarchy remain unaccounted for—and Nagios does not generate any message.</p>

    <div class="figure">
      <a id="the_filter_sequence_in_the_nagios_notif"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject9_d1e25178"/><img alt="The filter sequence in the Nagios notification system (some parameters are only available starting with Nagios version 3.0)" src="../Images/tagoreillycom20081104nostarchimages223822.png.jpg"/></div>

      <p class="title">Figure 12-2. The filter sequence in the Nagios notification system (some parameters are only available starting with Nagios version 3.0)</p>
    </div>

    <div class="sect2" title="12.3.1 Switching messages on and off systemwide">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="switching_messages_on_and_off_systemwid"/>12.3.1 Switching messages on and off systemwide</h2>
      </div>

      <p>With the <strong class="userinput"><code>enable_notifications</code></strong> parameter in the central configuration file <strong class="userinput"><code>nagios.cfg</code></strong>, you can in principal define whether Nagios should send messages at all. Only if it is set to <strong class="userinput"><code>1</code></strong> will the notification system work:<a class="indexterm" id="IDX-CHP-12-0963"/><a class="indexterm" id="IDX-CHP-12-0964"/></p><a id="I_programlisting9_d1e25203"/>
      <pre class="programlisting">enable_notifications=1</pre>
    </div>

    <div class="sect2" title="12.3.2 Enabling and suppressing computer and service-related messages">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="enabling_and_suppressing_computer_and_s"/>12.3.2 Enabling and suppressing computer and service-related messages</h2>
      </div>

      <p>When defining a host or service, various parameters can influence the messaging system. Here you can define, for example, at what time Nagios should send messages, whether the contact person is regularly informed of error states, and about which states or changes in state he should be informed (just CRITICAL, or WARNING as well, etc.).<a class="indexterm" id="IDX-CHP-12-0965"/><a class="indexterm" id="IDX-CHP-12-0966"/><a class="indexterm" id="IDX-CHP-12-0967"/><a class="indexterm" id="IDX-CHP-12-0968"/><a class="indexterm" id="IDX-CHP-12-0969"/><a class="indexterm" id="IDX-CHP-12-0970"/><a class="indexterm" id="IDX-CHP-12-0971"/><a class="indexterm" id="IDX-CHP-12-0972"/></p>

      <p>The switch <strong class="userinput"><code>notifications_enabled</code></strong> determines whether this specific computer or service is important enough for the admin to be informed of errors not just through the Web interface, but also in other ways as well. If this is so, the parameter must be set to <strong class="userinput"><code>1</code></strong>:<a class="indexterm" id="IDX-CHP-12-0973"/></p><a id="I_programlisting9_d1e25255"/>
      <pre class="programlisting">notifications_enabled=1</pre>

      <p>This is also the case in the default, so that you have to set the value explicitly to <strong class="userinput"><code>0</code></strong> at this point to stop separate notifications.</p>

      <div class="sect3" title="Taking downtimes into account">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="taking_downtimes_into_account"/>Taking downtimes into account</h3>
        </div>

        <p>At times when a specific service or host is intentionally not available, Nagios should certainly not send any error messages through the network. The configuration of corresponding maintenance periods (<span class="emphasis"><em>downtime scheduling</em></span>) is only possible through the Web interface and is described in <a class="xref" href="../Text/ch16s03.html" title="16.3 Planning Downtimes">16.3 Planning Downtimes</a> from page 359.</p>
      </div>

      <div class="sect3" title="What states and changes of state are worth a notification?">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="what_states_and_changes_of_state_are"/>What states and changes of state are worth a notification?</h3>
        </div>

        <p>If a regular test shows that service or computer is changing its data continuously, this is called <span class="emphasis"><em>flapping</em></span> in Nagios (see also <a class="xref" href="../Text/apb.html" title="Appendix B. Rapidly Alternating States: Flapping">Appendix B</a> from page 611). If the <strong class="userinput"><code>flap_detection_enabled</code></strong> parameter is set to <strong class="userinput"><code>1</code></strong>, the system tries to detect this situation.</p>

        <p>Whether Nagios sends a message in this case depends on the <strong class="userinput"><code>notification_options</code></strong> filter. This decides on which states or changes of state Nagios will inform the contact involved. In host definitions it can have the following combinations of values, separated by commas: <strong class="userinput"><code>d</code></strong> (switched off or crashed, <span class="emphasis"><em>down</em></span>), <strong class="userinput"><code>u</code></strong> (<span class="emphasis"><em>unreachable</em></span>), <strong class="userinput"><code>r</code></strong> (computer again reachable, <span class="emphasis"><em>recovered</em></span>), and <strong class="userinput"><code>f</code></strong> (quickly alternating state, <span class="emphasis"><em>flapping</em></span>). Starting with Nagios 3.0, there is an additional value <strong class="userinput"><code>s</code></strong>, which is used to send notifications if a planned maintenance period is about to start, end, or is canceled.</p>

        <p>For service objects, <strong class="userinput"><code>notification_options</code></strong> recognizes the following states: <strong class="userinput"><code>c</code></strong> (CRITICAL), <strong class="userinput"><code>w</code></strong> (WARNING), <strong class="userinput"><code>u</code></strong> (UNKNOWN, unknown problem), <strong class="userinput"><code>r</code></strong> (service again reachable, <span class="emphasis"><em>recovered</em></span>), and <strong class="userinput"><code>f</code></strong> (<span class="emphasis"><em>flapping</em></span>). From Nagios 3.0 onward, the value s is also available for sending notifications on planned maintenance periods.</p>

        <p>Nagios correspondingly informs the admin of the state of the service whose definition is contained in the line</p><a id="I_programlisting9_d1e25350"/>
        <pre class="programlisting">notification_options=c,r</pre>

        <p>only if this is critical or was recreated after an error state. Messages involving a WARNING or flapping are discarded by the system.</p>

        <p>If <strong class="userinput"><code>notification_options</code></strong> is set to <strong class="userinput"><code>n</code></strong> (<span class="emphasis"><em>none</em></span>), Nagios will generally not send a message concerning this computer or service.</p>
      </div>

      <div class="sect3" title="When should Nagios send messages?">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="when_should_nagios_send_messages_que"/>When should Nagios send messages?</h3>
        </div>

        <p>At what time should a message be sent? This can be defined with the <strong class="userinput"><code>notification_period</code></strong> parameter:<a class="indexterm" id="IDX-CHP-12-0974"/><a class="indexterm" id="IDX-CHP-12-0975"/><a class="indexterm" id="IDX-CHP-12-0976"/><a class="indexterm" id="IDX-CHP-12-0977"/><a class="indexterm" id="IDX-CHP-12-0978"/><a class="indexterm" id="IDX-CHP-12-0979"/></p><a id="I_programlisting9_d1e25397"/>
        <pre class="programlisting">notification_period=24x7h</pre>

        <p><strong class="userinput"><code>notification_period</code></strong> expects a time object (see <a class="xref" href="../Text/ch02s10.html" title="2.10 Defining a Time Period with timeperiod">2.10 Defining a Time Period with timeperiod</a> from page 74) as the value; <strong class="userinput"><code>24x7h</code></strong> is such a value and stands for "round the clock."</p>

        <p>Outside the specified time period, Nagios suppresses possible messages, but does not simply discard them, in contrast to the other filters. Instead of this, the system places the message in a kind of queue and sends it as soon as the notification period begins (<span class="emphasis"><em>rescheduling</em></span>). This means that the relevant contact will certainly get to hear about the problem. Nagios also ensures that the admin receives the message only once, even if multiple messages on the same event were generated outside the time period.</p>

        <p><strong class="userinput"><code>notification_period</code></strong> is the only time-controlled filter in which a message is not lost, despite filtering. With all the other time filters, the message never reaches its destination outside the specified period of time.</p>

        <p>With an <span class="emphasis"><em>interval check</em></span>, Nagios can be instructed to report at regular intervals on problems that persist for a longer time:<a class="indexterm" id="IDX-CHP-12-0980"/></p><a id="I_programlisting9_d1e25425"/>
        <pre class="programlisting">notification_interval=120</pre>

        <p>If a state persists that Nagios should normally report, corresponding to the <strong class="userinput"><code>notification_option</code></strong> parameter—CRITICAL, for example—for along time, the system would grant this wish, in the example, every 120 time units (normally, minutes). In other words it suppresses the notification that is generated anyway with every check, after a corresponding notification until the specified time has elapsed. If nothing has changed in the state until then, it then sends the corresponding notification.<a class="indexterm" id="IDX-CHP-12-0981"/></p>

        <p>If you set <strong class="userinput"><code>notification_interval</code></strong> to <strong class="userinput"><code>0</code></strong>, Nagios will send a notification of this only once. You should be careful when doing this, however: filters defined for the contact can also reject messages. If you normally generate just one single message, which might arrive at the relevant admin outside the admin's chosen contact time period, then the admin will never be told anything about the problem, even if it persists into working hours.</p>

        <p>Starting with Nagios 3.0, the parameter <strong class="userinput"><code>first_notification_delay</code></strong> allows the delayed sending of a notification. With the setting<a class="indexterm" id="IDX-CHP-12-0982"/></p><a id="I_programlisting9_d1e25452"/>
        <pre class="programlisting">first_notification_delay=15</pre>

        <p>Nagios sends notification only after 15 time units (usually minutes) have expired. If the system administrator responsible for handling the problem posts an acknowledgement within the delay period (<a class="xref" href="../Text/ch16.html#taking_responsibility_for_problems" title="16.1.2 Taking responsibility for problems">16.1.2 Taking responsibility for problems</a> from page 332), the notification will not be sent, but if the administrator does not react in time, then Nagios sends the first notification once the delay period has expired. This option is useful for avoiding unneeded notifications when administrators use the Web interface to check on the system periodically during their regular working hours.</p>
      </div>

      <div class="sect3" title="Whose concern is the message?">
        <div class="titlepage">
          <h3 class="title" id="heading_id_8"><a id="whose_concern_is_the_message_question"/>Whose concern is the message?</h3>
        </div>

        <p>The contact group defined in the host or service object does not itself belong to the message filters, but it still decides on who is informed and who is not:<a class="indexterm" id="IDX-CHP-12-0983"/></p><a id="I_programlisting9_d1e25466"/>
        <pre class="programlisting">contact_group=admins</pre>

        <p>What contacts belong to the specified group (here: <strong class="userinput"><code>admins</code></strong>) is defined by the corresponding <strong class="userinput"><code>contact_group</code></strong> object in its definition object (see also <a class="xref" href="../Text/ch02s08.html" title="2.8 The Message Recipient: contactgroup">2.8 The Message Recipient: contactgroup</a> from page 72):</p><a id="I_programlisting9_d1e25478"/>
        <pre class="programlisting"># -- /etc/nagios/global/contactgroups.cfg
define contactgroup{
    contactgroup_name  admins
    alias              administrators
 <span class="strong"><strong>members</strong></span>     <span class="strong"><strong>nagios,wob,mwi</strong></span>
}</pre>

        <p>The specified contact group, though, merely makes a rough preselection: which of the contacts specified in it actually receive the message depends on the filter functions in the definition of the individual contact. In this way you can ensure that one employee is only notified during normal office hours, another one round-the-clock, and that one of them is kept up to date about all changes in status, and the other one is informed only of a selection (for example, only CRITICAL but not WARNING).</p>
      </div>
    </div>

    <div class="sect2" title="12.3.3 Person-related filter options">
      <div class="titlepage">
        <h2 class="title" id="heading_id_9"><a id="person-related_filter_options"/>12.3.3 Person-related filter options</h2>
      </div>

      <p>When defining the <strong class="userinput"><code>contact</code></strong> objects, the method is also specified in which Nagios delivers the notification in specific cases (see <a class="xref" href="../Text/ch12s04.html" title="12.4 External Notification Programs">12.4 External Notification Programs</a> from page 275). It can be described separately for host and service problems. Several parallel methods are also possible, such as via e-mail <span class="emphasis"><em>and</em></span> SMS.<a class="indexterm" id="IDX-CHP-12-0984"/></p>

      <p>Since the contact-related filters are specifically for the corresponding contact object, it can certainly be useful to define several contacts for one and the same recipient that differ in individual parameters, such as a contact object that keeps the person informed via e-mail of all problems during normal working hours, and a second one for SMS messages concerning critical events outside working hours.</p>

      <div class="sect3" title="What should Nagios inform you about?">
        <div class="titlepage">
          <h3 class="title" id="heading_id_10"><a id="what_should_nagios_inform_you_about"/>What should Nagios inform you about?</h3>
        </div>

        <p>The events for which somebody should be informed can be specified not only by host or service, but also by contact. Host and service-related states are defined separately here:</p><a id="I_programlisting9_d1e25513"/>
        <pre class="programlisting">host_notification_options=d,u,r
service_notification_options=c,r,u</pre>

        <p>The possible values are the same as those for the host-service parameter <strong class="userinput"><code>notification_options</code></strong> (<a class="xref" href="../Text/ch12s03.html#enabling_and_suppressing_computer_and_s" title="12.3.2 Enabling and suppressing computer and service-related messages">12.3.2 Enabling and suppressing computer and service-related messages</a>).</p>

        <p>From Nagios 3.0 onward you can normally switch notifications for host and service on and off via an additional parameter:</p><a id="I_programlisting9_d1e25524"/>
        <pre class="programlisting">host_notifications_enabled=1
service_notifications_enabled=1</pre>

        <p>The value 0 prevents the corresponding messages, and the value 1 ensures that the messages are sent. At first glance this corresponds to the value <strong class="userinput"><code>n</code></strong> (no notification) for the accompanying option parameter.</p>

        <p>The two <strong class="userinput"><code>*_notifications_enabled</code></strong> parameters can also be switched on and off with the external commands <strong class="userinput"><code>ENABLE/DISABLE_CONTACT_HOST_NOTIFICATIONS</code></strong> and <strong class="userinput"><code>ENABLE/DISABLE_C0NTACT_SVC_N0TIFICATI0NS</code></strong><sup>[<a class="footnote" href="#ftn.CHP-12-FN-2" id="CHP-12-FN-2">123</a>]</sup> via the interface for external commands (<a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a> from page 292). This can be done with a script where the contact is concerned, without having to alter the preset <strong class="userinput"><code>*_notification_options</code></strong>.</p>
      </div>

      <div class="sect3" title="When do messages reach the recipient?">
        <div class="titlepage">
          <h3 class="title" id="heading_id_11"><a id="when_do_messages_reach_the_recipient"/>When do messages reach the recipient?</h3>
        </div>

        <p>The final filter in the filter chain again refers to time periods. If a message is produced in the time period specified here, Nagios notifies the contact; otherwise it discards the message. The notification window can again be set separately for hosts and services, and as a value it expects a <strong class="userinput"><code>timeperiod</code></strong> object defined elsewhere:<a class="indexterm" id="IDX-CHP-12-0985"/><a class="indexterm" id="IDX-CHP-12-0986"/><a class="indexterm" id="IDX-CHP-12-0987"/></p><a id="I_programlisting9_d1e25573"/>
        <pre class="programlisting">host_notification_period=24x7
service_notification_period=workhours</pre>
      </div>
    </div>

    <div class="sect2" title="12.3.4 Case examples">
      <div class="titlepage">
        <h2 class="title" id="heading_id_12"><a id="case_examples"/>12.3.4 Case examples</h2>
      </div>

      <div class="sect3" title="Letting you know once, but doing this reliably">
        <div class="titlepage">
          <h3 class="title" id="heading_id_13"><a id="letting_you_know_once_comma_but_doing"/>Letting you know once, but doing this reliably</h3>
        </div>

        <p>What should you do if only a single message should be sent for each change in status of the service, but this message must always reach the relevant recipient during working hours? We can illustrate the solution to this problem through the example of the <strong class="userinput"><code>admins</code></strong> contact group to which the contact <strong class="userinput"><code>wob</code></strong> is assigned, ...</p><a id="I_programlisting9_d1e25589"/>
        <pre class="programlisting">define contactgroup{
 <span class="strong"><strong>contactgroup_name   admins</strong></span>
    alias               Local Site Administrators
 <span class="strong"><strong>members             wob</strong></span>
}</pre>

        <p>... and to the <strong class="userinput"><code>PING</code></strong> service for the computer <strong class="userinput"><code>linux01</code></strong>:</p><a id="I_programlisting9_d1e25605"/>
        <pre class="programlisting">define service{
   host_name                  linux01
   service_description        PING
   check_command              check_ping!100.0,20%!500.0,60%
   max_check_attempts         3
   normal_check_interval      2
   retry_check_interval       1
   check_period               24x7
<span class="strong"><strong>notification_interval      0</strong></span>
<span class="strong"><strong>notification_period        workhours</strong></span>
<span class="strong"><strong>notification_options       w,u,c,r,f</strong></span>
<span class="strong"><strong>contact_groups             admins</strong></span>
}</pre>

        <p><strong class="userinput"><code>notification_interval 0</code></strong> normally forces Nagios not to produce any repeat messages. The <strong class="userinput"><code>notification_period</code></strong> ensures the desired time period through the <strong class="userinput"><code>timeperiod</code></strong> object <strong class="userinput"><code>workhours</code></strong>: if Nagios raises the alarm at other times, the inbuilt <span class="emphasis"><em>rescheduling</em></span> is used, that is, the notification is sent on its way only if the specified time period again applies. It is definitely not discarded.<a class="indexterm" id="IDX-CHP-12-0988"/><a class="indexterm" id="IDX-CHP-12-0989"/></p>

        <p>In order for Nagios to be active in all changes of state, the <strong class="userinput"><code>notification_options</code></strong> must always cover all possible events for services.</p>

        <p>To guarantee that the contact <strong class="userinput"><code>wob</code></strong> always receives the messages, it is essential that the <strong class="userinput"><code>service_notification_period</code></strong> in the corresponding <strong class="userinput"><code>contact</code></strong> object is <strong class="userinput"><code>24x7</code></strong>:</p><a id="I_programlisting9_d1e25661"/>
        <pre class="programlisting">define contact{
   <span class="strong"><strong>contact_name                 wob</strong></span>
   alias                        Wolfgang
   host_notification_period     24x7
   host_notification_options    d,u,r
   <span class="strong"><strong>service_notification_period  24x7</strong></span>
   <span class="strong"><strong>service_notification_options w,u,c,r,f</strong></span>
}</pre>

        <p>A restricted time filter at this position could, under certain circumstances, lead to the loss of each of the individual messages. The same applies for the values of <strong class="userinput"><code>service_notification_options</code></strong>: only if all are entered here as well will no message be lost.</p>
      </div>

      <div class="sect3" title="Informing different admins at different times">
        <div class="titlepage">
          <h3 class="title" id="heading_id_14"><a id="informing_different_admins_at_differen"/>Informing different admins at different times</h3>
        </div>

        <p>If you want to inform different persons at different times about different events, you may not restrict either the <strong class="userinput"><code>notification_period</code></strong> or the <strong class="userinput"><code>notification_options</code></strong> of a host or service:<a class="indexterm" id="IDX-CHP-12-0990"/><a class="indexterm" id="IDX-CHP-12-0991"/></p><a id="I_programlisting9_d1e25694"/>
        <pre class="programlisting">define service{
   ...
<span class="strong"><strong>notification_interval    120</strong></span>
<span class="strong"><strong>notification_period      24x7</strong></span>
<span class="strong"><strong>notification_options     w,u,c,r,f</strong></span>
   ...
}</pre>

        <p>Filtering takes place exclusively for individual contacts. For this to work on a time level you must ensure that Nagios generates a message regularly (here every 120 time units, normally minutes) if error states persist.</p>

        <p>If admin A is to be informed only during his working hours, and then only of changes to critical or OK states, A's contact object will be sent with the following parameters:</p><a id="I_programlisting9_d1e25709"/>
        <pre class="programlisting">define contact{
   ...
<span class="strong"><strong>service_notification_period     workhours</strong></span>
<span class="strong"><strong>service_notification_options    c,r</strong></span>
   ...
}</pre>

        <p>There is also a second and not quite so obvious difference to the first example: let us assume that the service reports the CRITICAL status at 7:30 in the morning, which will persist for several hours. The <strong class="userinput"><code>workhours</code></strong> object is defined so that it describes the time from Monday to Friday between 8:00 and 18:00. In the above example, Nagios holds back the message (rescheduling), until the time period defined in it has been reached. The administrator therefore receives a corresponding message at 8:00.</p>

        <p>In the case described here, no rescheduling takes place, Nagios generates a corresponding message every two hours, which is filtered out if the contact is currently taking a "break." The system correspondingly discards the message at 7:30, but allows the next message two hours later to pass through. The administrator therefore does not receive the corresponding information until 9:30, provided that the problem still exists at this point in time.</p>

        <p>Which of the two solutions is more suitable depends on specific requirements. For an e-mail notification, for example, it makes little difference if the administrator receives mails round-the-clock but reads them only when sitting in his office. A filter for Nagios messages in the mail client, sorting them in reverse chronological order (the most current mail first) makes sense in this case. Sitting in front of the screen, the administrator can also take a quick look at the Web interface when problems are announced, to check whether anything has changed.</p>

        <p>If the methods of differentiation described so far are not sufficient, then escalation management, described in <a class="xref" href="../Text/ch12s05.html" title="12.5 Escalation Management">12.5 Escalation Management</a>, may be of further help.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-12-FN-2" id="ftn.CHP-12-FN-2">123</a>]</sup> See <a class="ulink" href="http://www.nagios.org/developerinfo/externalcommands/">http://www.nagios.org/developerinfo/externalcommands/</a>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="12.4 External Notification Programs">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="external_notification_programs"/>12.4 External Notification Programs</h1>
    </div>

    <p>Which external programs deliver the messages is defined by the contact definition.<a class="indexterm" id="IDX-CHP-12-0992"/><a class="indexterm" id="IDX-CHP-12-0993"/><a class="indexterm" id="IDX-CHP-12-0994"/></p>

    <p>Here there are again two parameters to define the commands to be used, one for services and one for hosts:<a class="indexterm" id="IDX-CHP-12-0995"/></p><a id="I_programlisting9_d1e25755"/>
    <pre class="programlisting">define contact{
   ...
   service_notification_commands   notify-by-email,notify-by-sms
   host_notification_commands      host-notify-by-email,host-notify-by-sms
   email                           nagios-admin@localhost
   pager                           +49-1234-56789
address1                root@example.com
    address2                123-456789
   ...
}</pre>

    <p>Both <strong class="userinput"><code>*_notification_commands</code></strong> allow comma-separated lists, so it is permitted to specify more than one command at the same time. The message is then sent simultaneously to the recipient in all the ways defined. The names of the command objects describe these ways: via e-mail and via SMS.<a class="indexterm" id="IDX-CHP-12-0999"/><a class="indexterm" id="IDX-CHP-12-1000"/><a class="indexterm" id="IDX-CHP-12-0996"/><a class="indexterm" id="IDX-CHP-12-0998"/><a class="indexterm" id="IDX-CHP-12-0997"/></p>

    <p>To achieve a better overview, the corresponding commands are not defined together with the plugin commands in the file <strong class="userinput"><code>checkcommands.cfg</code></strong>, but in a separate object file, <strong class="userinput"><code>misccommands.cfg</code></strong>. Nagios loads these like any other file with object definitions, which is why any name can be chosen for them.<a class="indexterm" id="IDX-CHP-12-1001"/><a class="indexterm" id="IDX-CHP-12-1002"/></p>

    <p>The other parameters, <strong class="userinput"><code>email</code></strong>, <strong class="userinput"><code>pager</code></strong>, <strong class="userinput"><code>address1</code></strong>, and <strong class="userinput"><code>address2</code></strong>, can be regarded as variables. The delivery commands access the values set in these through macros. Whether <strong class="userinput"><code>pager</code></strong> contains a telephone number for SMS delivery or an e-mail address pointing to an e-mail SMS gateway is immaterial for the contact definition. The decisive factor is that the value matches the corresponding command that references this variable.<a class="indexterm" id="IDX-CHP-12-1003"/></p>

    <div class="sect2" title="12.4.1 Notification via e-mail">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="notification_via_e-mail"/>12.4.1 Notification via e-mail</h2>
      </div>

      <p>In defining the <strong class="userinput"><code>notify-by-email</code></strong> command, a name and the command line to be executed is specified, as with every other command object. Only its length is unusual, which is why it has had to be line-wrapped several times for this printed version:<a class="indexterm" id="IDX-CHP-12-1004"/><a class="indexterm" id="IDX-CHP-12-1005"/><a class="indexterm" id="IDX-CHP-12-1006"/></p><a id="I_programlisting9_d1e25831"/>
      <pre class="programlisting">define command{
   command_name        notify-by-email
   command_line        /usr/bin/printf "%b" "***** Nagios *****\n\n Notificat
ion Type: $NOTIFICATIONTYPE$\n\nService: $SERVICEDESC$\nHost: $HOSTALIAS
$\nAddress: $HOSTADDRESS$\nState: $SERVICESTATE$\n\nDate/Time: $LONGDATE
TIME$\n\nAdditional Info:\n\n$SERVICEOUTPUT$" | /usr/bin/mail -s "** $N
OTIFICATIONTYPE$ alert - $HOSTALIAS$/$SERVICEDESC$ is $SERVICESTATE$ **"
$CONTACTEMAIL$
}</pre>

      <p>The printed-out command object comes from the included example file <strong class="userinput"><code>misccommands.cfg-sample</code></strong>. The command line defined in it can be reduced in principle to the following pattern:</p><a id="I_programlisting9_d1e25838"/>
      <pre class="programlisting">printf <span class="emphasis"><em>text</em></span> | mail -s <span class="emphasis"><em>"subject" e-mail_address</em></span></pre>

      <p>With the help of the macro, <strong class="userinput"><code>printf</code></strong> generates the message text, which is passed on to the mail program through a pipe. What is caused by the macros specifically used is revealed in <a class="xref" href="../Text/ch12s04.html#macros_used_in_notify-by-email_and_host" title="Table 12-1. Macros used in notify-by-email and host-notify-by-email">Table 12-1</a>.<sup>[<a class="footnote" href="#ftn.CHP-12-FN-3" id="CHP-12-FN-3">124</a>]</sup> Using this, the jumbo line shown above produces messages that look something like this:<a class="indexterm" id="IDX-CHP-12-1007"/><a class="indexterm" id="IDX-CHP-12-1008"/><a class="indexterm" id="IDX-CHP-12-1009"/><a class="indexterm" id="IDX-CHP-12-1010"/></p><a id="I_programlisting9_d1e25882"/>
      <pre class="programlisting">To: wob@swobspace.de
Subject: ** PROBLEM alert - mail-WOB/SMTP is CRITICAL **
Date: Fri, 14 Jan 2005 16:22:47 +0100 (CET)
From: Nagios Admin &lt;nagios@swobspace.de&gt;

***** Nagios *****

Notification Type: PROBLEM

Service: SMTP
Host: mail-WOB
Address: 172.17.168.2
State: CRITICAL

Date/Time: Fri Jan 14 16:22:47 CET 2005

Additional Info:

CRITICAL - Socket timeout after 10 seconds</pre>

      <div class="table">
        <a id="macros_used_in_notify-by-email_and_host"/>

        <p class="title">Table 12-1. Macros used in notify-by-email and host-notify-by-email</p>

        <div class="table-contents">
          <table class="sgc-3" summary="Macros used in notify-by-email and host-notify-by-email">
            <colgroup>
              <col/>
              <col/>
            </colgroup>

            <thead>
              <tr>
                <th class="sgc-1" valign="bottom">
                  <p>Macro<a class="indexterm" id="IDX-CHP-12-1011"/></p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Description</p>
                </th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$CONTACTEMAIL$</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Value of the <strong class="userinput"><code>email</code></strong> parameter from the contact definition</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$LONGDATETIME$</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Long form of data specification, e.g., <strong class="userinput"><code>Fri Jan 14 16:22:47 CET 2005</code></strong></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$HOSTALIAS$</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Value of the <strong class="userinput"><code>alias</code></strong> parameter from the host definition<a class="indexterm" id="IDX-CHP-12-1012"/></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$HOSTADDRESS$</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Value of the <strong class="userinput"><code>address</code></strong> parameter from the host definition<a class="indexterm" id="IDX-CHP-12-1013"/></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$HOSTNAME$</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Value of the <strong class="userinput"><code>host_name</code></strong> parameter from the host definition<a class="indexterm" id="IDX-CHP-12-1014"/></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$HOSTOUTPUT$</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Text output of the last host check</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$HOSTSTATE$</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>State of the host: <strong class="userinput"><code>UP</code></strong>, <strong class="userinput"><code>DOWN</code></strong>, or <strong class="userinput"><code>UNREACHABLE</code></strong></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$NOTIFICATIONTYPE$</code></strong><a class="indexterm" id="IDX-CHP-12-1015"/></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Type of notification: <strong class="userinput"><code>PROBLEM</code></strong> (CRITICAL, WARNING, or UNKNOWN), <strong class="userinput"><code>RECOVERY</code></strong> (OK after error state), <strong class="userinput"><code>ACKNOWLEDGEMENT</code></strong> (an admin has confirmed the error state; see <a class="xref" href="../Text/ch16.html#taking_responsibility_for_problems" title="16.1.2 Taking responsibility for problems">16.1.2 Taking responsibility for problems</a>, page 332), <strong class="userinput"><code>FLAPPINGSTART</code></strong> or <strong class="userinput"><code>FLAPPINGSTOP</code></strong></p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$SERVICEDESC$</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Value of the <strong class="userinput"><code>description</code></strong> parameter in the service definition</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$SERVICEOUTPUT$</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Text output of the last service check</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>$SERVICESTATE$</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>State of the service: <strong class="userinput"><code>OK</code></strong>, <strong class="userinput"><code>WARNING</code></strong>, <strong class="userinput"><code>CRITICAL</code></strong>, <strong class="userinput"><code>UNKNOWN</code></strong></p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p>For the command <strong class="userinput"><code>host-notify-by-email</code></strong>, the command line looks similar, except that now host-related macros are used:<a class="indexterm" id="IDX-CHP-12-1016"/></p><a id="I_programlisting9_d1e26063"/>
      <pre class="programlisting">/usr/bin/printf "%b" "***** Nagios *****\n\nNotification Type:
$NOTIFICATIONTYPE$\nHost: $HOSTNAME$\nState: $HOSTSTATE$\nAddress:
$HOSTADDRESS$\nInfo: $HOSTOUTPUT$\n\nDate/Time: $LONGDATETIME$\n" |
/usr/bin/mail -s "Host $HOSTSTATE$ alert for $HOSTNAME$!" $CONTACTEMAIL$</pre>

      <p>It generates e-mails with the following content:</p><a id="I_programlisting9_d1e26068"/>
      <pre class="programlisting">To: wob@swobspace.de
Subject: Host UP alert for wob-proxy!
Date: Fri, 14 Jan 2005 17:50:21 +0100 (CET)
From: Nagios Admin &lt;nagios@swobspace.de&gt;

***** Nagios *****

Notification Type: RECOVERY
Host: wob-proxy
State: UP
Address: 172.17.168.19
Info: PING OK - Packet loss = 0%, RTA = 69.10 ms

Date/Time: Fri Jan 14 17:50:21 CET 2005</pre>
    </div>

    <div class="sect2" title="12.4.2 Notification via SMS">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="notification_via_sms"/>12.4.2 Notification via SMS</h2>
      </div>

      <p>While the infrastructure necessary for sending e-mails<sup>[<a class="footnote" href="#ftn.CHP-12-FN-4" id="CHP-12-FN-4">125</a>]</sup> is usually available anyway, programs for sending SMS messages such as <strong class="userinput"><code>yaps</code></strong>,<sup>[<a class="footnote" href="#ftn.CHP-12-FN-5" id="CHP-12-FN-5">126</a>]</sup> <strong class="userinput"><code>smssend</code></strong>,<sup>[<a class="footnote" href="#ftn.CHP-12-FN-6" id="CHP-12-FN-6">127</a>]</sup> or <strong class="userinput"><code>smsclient</code></strong><sup>[<a class="footnote" href="#ftn.CHP-12-FN-7" id="CHP-12-FN-7">128</a>]</sup> usually have to be additionally installed. <strong class="userinput"><code>yaps</code></strong> and <strong class="userinput"><code>smsclient</code></strong> require a local modem or ISDN card and "telephone" directly with the cell phone provider (e.g., T-Mobile), <strong class="userinput"><code>smssend</code></strong> establishes a connection to the Internet servers of the cellphone provider and sends the SMS message on this route. With <strong class="userinput"><code>yaps</code></strong> and <strong class="userinput"><code>smsclient</code></strong> you can also use a mail gateway that generates and sends an SMS message from an e-mail.<a class="indexterm" id="IDX-CHP-12-1024"/><a class="indexterm" id="IDX-CHP-12-1017"/><a class="indexterm" id="IDX-CHP-12-1018"/><a class="indexterm" id="IDX-CHP-12-1019"/><a class="indexterm" id="IDX-CHP-12-1020"/><a class="indexterm" id="IDX-CHP-12-1021"/><a class="indexterm" id="IDX-CHP-12-1022"/><a class="indexterm" id="IDX-CHP-12-1023"/><a class="indexterm" id="IDX-CHP-12-1025"/><a class="indexterm" id="IDX-CHP-12-1026"/></p>

      <p>Whichever method you choose, you should be aware of possible interference in sending messages: a connection between the Nagios server and the Internet passes through many hosts, routers, and firewalls. Especially if Nagios is itself monitoring one of the computers involved, things get interesting: if this machine is down, then a message sent via <strong class="userinput"><code>smssend</code></strong> will no longer work either. The same thing applies for e-mail-SMS gateways. Whether a self-made construction is involved, with <strong class="userinput"><code>yaps</code></strong> or <strong class="userinput"><code>smsclient</code></strong>, each of which represents its own SMS gateway, or a telecom installation with a sophisticated unified messaging solution, if the actual sender of the SMS is many nodes removed from the Nagios server (because you have a networked telephone installation with several locations, for example), the chances increase that the message will not reach its destination because of an interrupted connection.<a class="indexterm" id="IDX-CHP-12-1027"/></p>

      <p>For this reason the best solution is an <strong class="userinput"><code>smsclient</code></strong> or <strong class="userinput"><code>yaps</code></strong> installation on the Nagios server itself with a direct telephone access. In larger, networked telephone systems you can also consider giving the telephone access a dedicated, direct line from the telephone system. Whether this is ISDN or analog is just a question here of the technology used.</p>

      <p>To represent the programs mentioned here, we will take a closer look at <strong class="userinput"><code>smsclient</code></strong>, which can be configured very simply, and has an active community On its homepage you can also find a link to a mailing list whose members will be pleased to help in case you have questions.</p>

      <div class="sect3" title="Setting up smsclient">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="setting_up_smsclient"/>Setting up <strong class="userinput"><code>smsclient</code></strong></h3>
        </div>

        <p>While Debian has its own precompiled <strong class="userinput"><code>smsclient</code></strong> package, for SuSE and other distributions you have to compile the software yourself. For historical reasons the program itself is called <strong class="userinput"><code>sms_client</code></strong>; a short subtext is provided with <strong class="userinput"><code>man sms_client</code></strong>.<a class="indexterm" id="IDX-CHP-12-1028"/><a class="indexterm" id="IDX-CHP-12-1029"/><a class="indexterm" id="IDX-CHP-12-1030"/></p>

        <p>The installation from the source code follows the usual procedure:</p><a id="I_programlisting9_d1e26227"/>
        <pre class="programlisting">linux:~ <span class="strong"><strong># cd /usr/local/src</strong></span>
linux:local/src <span class="strong"><strong># tar xvzf /<span class="emphasis"><em>path</em></span>/to/sms_client-2.x.y</strong></span>
linux:local/src <span class="strong"><strong># cd ./sms_client-2.x.y</strong></span>
linux:src/sms_client-2.x.y <span class="strong"><strong># ./configure</strong></span>
linux:src/sms_client-2.x.y <span class="strong"><strong># make &amp;&amp; make install</strong></span></pre>

        <p>The only point worth mentioning here is that the "homemade" <strong class="userinput"><code>configure</code></strong> procedure manages without <strong class="userinput"><code>autoconf</code></strong> and <strong class="userinput"><code>automake</code></strong>.</p>

        <p>The configuration files listed in <a class="xref" href="../Text/ch12s04.html#smsclients_configuration_files" title="Table 12-2. smsclients configuration files">Table 12-2</a> are now located in the directory <strong class="userinput"><code>/etc/sms</code></strong>; the Debian package installs it to <strong class="userinput"><code>/etc/smsclient</code></strong>.</p>

        <div class="table">
          <a id="smsclients_configuration_files"/>

          <p class="title">Table 12-2. <code class="userinput">smsclients</code> configuration files</p>

          <div class="table-contents">
            <table class="sgc-3" summary="smsclients configuration files">
              <colgroup>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>File</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Description</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>sms_addressbook</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Definition of aliases and groups</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>sms_config</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Main configuration file</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>sms_daemons</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Configuration file for the daemon mode of <strong class="userinput"><code>smsclient</code></strong>, in which this can be reached via a proprietary protocol. Is not required.</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>sms_modem</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Modem configuration</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>sms_services</code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>Supported provider</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <p>The file <strong class="userinput"><code>sms_services</code></strong> lists the supported providers and at the same time assigns them to the protocol used. The precise telephone number dialed is specified by the corresponding service file in the directory <strong class="userinput"><code>services</code></strong> (if you have compiled this yourself) or <strong class="userinput"><code>/usr/lib/smsclient/services</code></strong> (for Debian). In case of doubt, you should request the telephone number of your own mobile cell provider. The mailing list can also be of assistance here.</p>

        <p>In the file <strong class="userinput"><code>sms_config</code></strong> you set a default provider, which the program uses for calls when the provider is not specifically given:</p><a id="I_programlisting9_d1e26343"/>
        <pre class="programlisting">SMS_default_service = "d1"</pre>

        <p>Only the configuration of the modem is now missing in the file <strong class="userinput"><code>sms_modem</code></strong>. In principle, however, any modem that functions under Linux can be used. In the following example we address an ISDN card with the Isdn4Linux-HiSax driver:</p><a id="I_programlisting9_d1e26351"/>
        <pre class="programlisting">MDM_lock_dir          = "/var/lock"    # directory for the lock files
MDM_device            = "ttyI0"        # device name of the modem
...
MDM_command_prefix    = "AT"
MDM_init_command      = "Z&amp;E&lt;MSN&gt;"
MDM_dial_command      = "D"
MDM_number_prefix     = "0"            # outside line, if required
...</pre>

        <p><strong class="userinput"><code>/dev/ttyI0</code></strong> is used as the device here; for <strong class="userinput"><code>MDM_init_command</code></strong>, your own MSN is used. This applies particularly to private branch exchanges, which allow a connection only if your own MSN has been correctly specified.</p>

        <p>Since Isdn4Linux does not recognize tone or pulse dialing, we use only <strong class="userinput"><code>D</code></strong> instead of the usual <strong class="userinput"><code>DT</code></strong> as the <strong class="userinput"><code>MDM_dial_command</code></strong>. If the ISDN connection requires an outside line as part of a phone exchange, you should enter the corresponding prefix; otherwise this string remains empty.</p>

        <p><strong class="userinput"><code>smsclient</code></strong> requires write permissions both for the device used and for the log file <strong class="userinput"><code>/var/log/smsclient.log</code></strong>:</p><a id="I_programlisting9_d1e26378"/>
        <pre class="programlisting">linux:~ <span class="strong"><strong># touch /var/log/smsclient.log</strong></span>
linux:~ <span class="strong"><strong># chgrp dialout /usr/bin/sms_client</strong></span>
linux:~ <span class="strong"><strong># chgrp dialout /dev/ttyI0 /var/log/smsclient.log</strong></span>
linux:~ <span class="strong"><strong># chmod 2755 /usr/bin/sms_client</strong></span>
linux:~ <span class="strong"><strong># chmod 664 /dev/ttyI0 /var/log/smsclient.log</strong></span></pre>

        <p>To test this, you should now send—preferably as the user <strong class="userinput"><code>nagios</code></strong>, who will later use <strong class="userinput"><code>smsclient</code></strong>—an SMS message to your own cellphone (here to be reached at the number <strong class="userinput"><code>01604711</code></strong>):</p><a id="I_programlisting9_d1e26405"/>
        <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>sms_client 01604711 "Text"</strong></span>
Dialing SMSC 01712521002...
WARNING: read() Timeout
Connection Established.
Login...
SMSC Acknowledgment received
Login successful
Ready to receive message
Received Message Response: Message 3003123223 send successful - message
submitted for processing&lt;CR&gt;
Successful message submission
Disconnect...
Disconnected from SMSC
Hangup...
d1 Service Time: 17 Seconds
[000] d1:01604711 "Text"
Total Elapsed Time: 17 Seconds</pre>
      </div>

      <div class="sect3" title="Getting Nagios to work together with smsclient">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="getting_nagios_to_work_together_with_sm"/>Getting Nagios to work together with <strong class="userinput"><code>smsclient</code></strong></h3>
        </div>

        <p>If the second argument is missing in <strong class="userinput"><code>smsclient</code></strong>, which contains the message text, the program will read it from STDIN:</p><a id="I_programlisting9_d1e26420"/>
        <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>/bin/printf "%b"</strong></span> <span class="emphasis"><em>message</em></span> | sms_client <span class="emphasis"><em>number</em></span></pre>

        <p>Based on the command <strong class="userinput"><code>notify-by-email</code></strong>, described from page 276, we will use the second variation here for defining the <strong class="userinput"><code>notify-by-sms</code></strong> command:<a class="indexterm" id="IDX-CHP-12-1031"/></p><a id="I_programlisting9_d1e26441"/>
        <pre class="programlisting"># 'notify-by-sms' command definition
define command{
command_name     notify-by-sms
   command_line     /usr/bin/printf "%.150s" "$NOTIFICATIONTYPE$ $HOSTNAM
 E$[$HOSTADDRESS$]/$SERVICEDESC$ is $SERVICESTATE$ /$SHORTDATETIME$/ $SER
 VICEOUTPUT$" | /usr/bin/smsclient $CONTACTPAGER$

}</pre>

        <p>As usual, the entire <strong class="userinput"><code>command_line</code></strong> is written on a single line. Nagios obtains the telephone number (or alias) through the macro <strong class="userinput"><code>$CONTACTPAGER$</code></strong>, which reads out the value of the <strong class="userinput"><code>pager</code></strong> parameter from the contact definition. Since an SMS here may not be longer than 150 characters, we will considerably abbreviate the information, compared to the e-mail message. To be on the safe side (you never know how long the plugin output (<strong class="userinput"><code>$SERVICEOUTPUT$</code></strong>) really is), the <strong class="userinput"><code>printf</code></strong> format specification <strong class="userinput"><code>.150</code></strong> (instead of <strong class="userinput"><code>%b</code></strong>) cuts off the text after 150 characters. Although we then do without the line breaks in the message, by means of <strong class="userinput"><code>\n</code></strong>, an SMS is never formatted cleanly, due to its limited display. Thus <strong class="userinput"><code>notify-by-sms</code></strong> generates a one-line message of the following type:</p><a id="I_programlisting9_d1e26473"/>
        <pre class="programlisting">PROBLEM elimail[172.17.130.1]/UPS is CRITICAL /2005-03-30 17:00:53/ Connection refused</pre>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-12-FN-3" id="ftn.CHP-12-FN-3">124</a>]</sup> A complete list of all macros is contained in the original documentation at <a class="ulink" href="http://localhost/nagios/docs/macros.html">http://localhost/nagios/docs/macros.html</a> (normally to be found in the file system under <strong class="userinput"><code>/usr/local/nagios/share/docs/macros.html</code></strong>). For Nagios 3.0 the corresponding file <strong class="userinput"><code>macrolist.html</code></strong> can also be found in this directory.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-12-FN-4" id="ftn.CHP-12-FN-4">125</a>]</sup> Apart from the <strong class="userinput"><code>/usr/bin/mail</code></strong> client, a local mail server is required.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-12-FN-5" id="ftn.CHP-12-FN-5">126</a>]</sup> <strong class="userinput"><code><a class="ulink" href="http://www.sta.to/ftp/yaps/">http://www.sta.to/ftp/yaps/</a></code></strong></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-12-FN-6" id="ftn.CHP-12-FN-6">127</a>]</sup> <strong class="userinput"><code><a class="ulink" href="http://zekiller.skytech.org/smssend_menu_en.html">http://zekiller.skytech.org/smssend_menu_en.html</a></code></strong></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-12-FN-7" id="ftn.CHP-12-FN-7">128</a>]</sup> <strong class="userinput"><code><a class="ulink" href="http://www.smsclient.org/">http://www.smsclient.org/</a></code></strong></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="12.5 Escalation Management">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="escalation_management"/>12.5 Escalation Management</h1>
    </div>

    <p>Whenever the administrators responsible cannot find a solution in the specified time when important components fail, although Service Level Agreements or other contracts commit the IT department to do this,<sup>[<a class="footnote" href="#ftn.CHP-12-FN-8" id="CHP-12-FN-8">129</a>]</sup> Nagios's ability to escalate notifications makes allowances for conflicts, at least on an organizational level. It can be used to provide multilevel support. For example, Nagios first informs the <span class="emphasis"><em>First Level Support</em></span> (usually the <span class="emphasis"><em>Help Desk</em></span>). If the problem still persists after one day, then the <span class="emphasis"><em>Second Level Support</em></span> is notified, and so on.<a class="indexterm" id="IDX-CHP-12-1032"/><a class="indexterm" id="IDX-CHP-12-1033"/><a class="indexterm" id="IDX-CHP-12-1034"/><a class="indexterm" id="IDX-CHP-12-1035"/><a class="indexterm" id="IDX-CHP-12-1036"/><a class="indexterm" id="IDX-CHP-12-1037"/><a class="indexterm" id="IDX-CHP-12-1038"/><a class="indexterm" id="IDX-CHP-12-1039"/><a class="indexterm" id="IDX-CHP-12-1040"/><a class="indexterm" id="IDX-CHP-12-1041"/><a class="indexterm" id="IDX-CHP-12-1042"/><a class="indexterm" id="IDX-CHP-12-1043"/></p>

    <p>Nagios also makes a distinction here between host- and service-related escalation stages. In essence, both function identically.</p>

    <p>In the escalation, Nagios does not count in time units, but in how many messages it has already sent out. In the following example the system should report on error states of the <strong class="userinput"><code>Database</code></strong> service on <strong class="userinput"><code>linux01</code></strong> every 120 minutes,<sup>[<a class="footnote" href="#ftn.CHP-12-FN-9" id="CHP-12-FN-9">130</a>]</sup> and this, round-the-clock:</p><a id="I_programlisting9_d1e26550"/>
    <pre class="programlisting">define service{
    host_name                linux01
service_description      Database
    notification_period      24x7
    notification_interval    120
    ...
    contact_groups           admins
}</pre>

    <p>The corresponding messages always go to a contact group, so without escalation, that is to <strong class="userinput"><code>admins</code></strong>.</p>

    <div class="figure">
      <a id="nagios_escalates_comma_depending_on_the"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject9_d1e26560"/><img alt="Nagios escalates, depending on the number of messages already sent" src="../Images/tagoreillycom20081104nostarchimages223824.png.jpg"/></div>

      <p class="title">Figure 12-3. Nagios escalates, depending on the number of messages already sent</p>
    </div>

    <p>After the fourth notification, Nagios should switch on the first stage of escalation (as illustrated in <a class="xref" href="../Text/ch12s05.html#nagios_escalates_comma_depending_on_the" title="Figure 12-3. Nagios escalates, depending on the number of messages already sent">Figure 12-3</a>) and, in addition to <strong class="userinput"><code>admins</code></strong>, should notify the <strong class="userinput"><code>second-level</code></strong> contact group. The eighth message triggers the second level, at which Nagios informs the <strong class="userinput"><code>contact_group third-level</code></strong>.</p>

    <p>As shown in <a class="xref" href="../Text/ch12s05.html#nagios_escalates_comma_depending_on_the" title="Figure 12-3. Nagios escalates, depending on the number of messages already sent">Figure 12-3</a>, escalations may certainly overlap. It can also be seen from the graphics that the contact group defined in the service object only applies as long as Nagios does not escalate. As soon as an escalation stage is switched on, the system puts the default contact group out of action.</p>

    <p>If the original contact group—here <strong class="userinput"><code>admins</code></strong>—should also receive a message in the first escalation level, then this must be additionally specified in the escalation definition. If several levels overlap, Nagios informs all the groups involved. In <a class="xref" href="../Text/ch12s05.html#nagios_escalates_comma_depending_on_the" title="Figure 12-3. Nagios escalates, depending on the number of messages already sent">Figure 12-3</a> the eighth to the tenth messages accordingly go both to <strong class="userinput"><code>admins</code></strong> and to <strong class="userinput"><code>second-level</code></strong> and <strong class="userinput"><code>third-level</code></strong>, while only the latter receives message numbers 11 and 12. From message number 13, Nagios keeps only the contact group <strong class="userinput"><code>admins</code></strong> informed, since escalation is no longer defined here.</p>

    <p>The latter takes place via separate <strong class="userinput"><code>serviceescalation</code></strong> (for services) and <strong class="userinput"><code>hostescalation</code></strong> objects (for computers). For a service escalation object, Nagios requires the beginning and the end of exceptional circumstances to be defined, apart from service details (consisting of the <strong class="userinput"><code>service_description</code></strong> and <strong class="userinput"><code>host_name</code></strong>) parameters and the name of the contact groups responsible:</p><a id="I_programlisting9_d1e26617"/>
    <pre class="programlisting">define serviceescalation{
    host_name             linux01
    service_description   Database
    first_notification    4
    last_notification     10
    notification_interval 60
    contact_groups        admins, second-level
}</pre>

    <p>The escalation level defined here starts, as desired, with message No 4 and ends with message No 10. If <strong class="userinput"><code>last_notification</code></strong> is given the value <strong class="userinput"><code>0</code></strong>, the escalation only ends if the service changes back to the OK state.</p>

    <p>In addition you must specify the <strong class="userinput"><code>notification_interval</code></strong> parameter for service escalations: this changes the notification interval (previously <strong class="userinput"><code>120</code></strong> according to the service definition) to <strong class="userinput"><code>60</code></strong> time units. This parameter is also mandatory for a host escalation. The only difference in the definition of a <strong class="userinput"><code>hostescalation</code></strong> object is that instead of the host name, you can also specify one or more host groups (in addition the <strong class="userinput"><code>service_description</code></strong> parameter is dropped, of course).</p>

    <p>The second escalation step is defined in the same way:</p><a id="I_programlisting9_d1e26646"/>
    <pre class="programlisting">define serviceescalation{
    host_name              linux01
    service_description    Database
    first_notification     8
    last_notification      12
    notification_interval  90
    contact_groups         third-level
}</pre>

    <p>If there are overlapping escalations with different <strong class="userinput"><code>notification_intervals</code></strong>, Nagios chooses the smallest defined time unit in each case. Nagios therefore sends messages 8 to 10 at intervals of 60 minutes, numbers 11 and 12 at intervals of 90 minutes, and then the original interval of 120 minutes again applies.</p>

    <p>With <strong class="userinput"><code>escalation_period</code></strong> and <strong class="userinput"><code>escalation_options</code></strong> there are two more setting parameters specially for escalations. Both have the same function as <strong class="userinput"><code>notification_period</code></strong> and <strong class="userinput"><code>notification_options</code></strong> in the host or service definition, but they refer only to the escalation case.</p>

    <p>In contrast to <strong class="userinput"><code>notification_interval</code></strong>, <strong class="userinput"><code>escalation_period</code></strong> <span class="emphasis"><em>does not replace</em></span> the <strong class="userinput"><code>notification_period</code></strong>, but acts in addition to this. From the intersection of <strong class="userinput"><code>notification_period</code></strong> and <strong class="userinput"><code>escalation_period</code></strong>, the actual time period is deduced. Suppose that <strong class="userinput"><code>notification_period</code></strong> refers to the time between 7:00 A:M and 5:00 P.M., and <strong class="userinput"><code>escalation_period</code></strong> to the period from 8:00 A.M. to 8:00 P.M.. Then Nagios will only send out messages in the escalation level between 8:00 A.M. and 5:00 P.M.. You must always remember here that it is only the number of messages that have already been sent that decides whether an escalation level exists. <strong class="userinput"><code>escalation_period</code></strong> and <strong class="userinput"><code>escalation_options</code></strong> only have an effect as additional filters.</p>

    <p>Before these two parameters are used, you should carefully consider what it is you want to achieve with them. To restrict the escalation to a specific time period could under certain circumstances result in it being omitted entirely. If you restrict them to weekdays, for example, this would mean that if the <strong class="userinput"><code>Database</code></strong> service failed during the weekend, Nagios would inform the contact group <strong class="userinput"><code>admins</code></strong> only on Monday morning: over the weekend the system has already sent more than 12 messages, so it no longer even uses its escalation mechanism. If there is a time restriction via <strong class="userinput"><code>escalation_period</code></strong>, you should set <strong class="userinput"><code>last_notification</code></strong> to <strong class="userinput"><code>0</code></strong> to ensure that the escalation really does take place.</p>

    <p>Every case of error is followed at some point in time by a recovery. An intelligent mechanism ensures that Nagios only notifies those contacts of the corresponding recovery who are in charge, depending on the active escalation level, and who also received the last notification to be sent.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-12-FN-8" id="ftn.CHP-12-FN-8">129</a>]</sup> These can also be internal specialist departments.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-12-FN-9" id="ftn.CHP-12-FN-9">130</a>]</sup> To be precise, every 120 time units, whereby the default time unit is 60 seconds.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="12.6 Accounting for Dependencies between Hosts and Services">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="accounting_for_dependencies_between_hos"/>12.6 Accounting for Dependencies between Hosts and Services</h1>
    </div>

    <p>If you test services with local plugins (see <a class="xref" href="../Text/ch07.html" title="Chapter 7. Testing Local Resources">Chapter 7</a>) via NRPE (see <a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a>), all these tests will come to nothing the moment the Plugin Executor fails. With <span class="emphasis"><em>service dependencies</em></span> you can prevent Nagios from flooding the appropriate administrator with messages on the dependent services. Instead of this, the system informs him specifically of the NRPE failure.<a class="indexterm" id="IDX-CHP-12-1044"/><a class="indexterm" id="IDX-CHP-12-1045"/><a class="indexterm" id="IDX-CHP-12-1046"/></p>

    <p>Aa with such service dependencies, Nagios also has <span class="emphasis"><em>host dependencies</em></span>, which suppress messages, depending on individual hosts. Both variations can also be used to specifically "switch off" tests.<a class="indexterm" id="IDX-CHP-12-1047"/></p>

    <div class="sect2" title="12.6.1 The standard case: service dependencies">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="the_standard_case_colon_service_depende"/>12.6.1 The standard case: service dependencies</h2>
      </div>

      <p>Let us take as an example the host <strong class="userinput"><code>linux01</code></strong>, illustrated in <a class="xref" href="../Text/ch12s06.html#the_three_above-mentioned_services_depe" title="Figure 12-4. The three above-mentioned services depend on NRPE">Figure 12-4</a>, on which locally installed plugins, controlled via NRPE, monitor hard drive space (<strong class="userinput"><code>Disks</code></strong> service, see <a class="xref" href="../Text/ch10s05.html#optimizing_the_configuration" title="10.5.3 Optimizing the configuration">10.5.3 Optimizing the configuration</a>), the number of logged-in users (<strong class="userinput"><code>Users</code></strong> service), and the system load (<strong class="userinput"><code>Load</code></strong> service). If NRPE were now to fail, Nagios would announce the CRITICAL state for all three services, although their actual state is unknown, and the real problem is the "NRPE daemon."<a class="indexterm" id="IDX-CHP-12-1048"/><a class="indexterm" id="IDX-CHP-12-1049"/></p>

      <p>In order to solve this contradiction, NRPE is monitored as a separate service and describes the dependencies in a <strong class="userinput"><code>servicedependency</code></strong> object.</p>

      <div class="figure">
        <a id="the_three_above-mentioned_services_depe"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject9_d1e26790"/><img alt="The three above-mentioned services depend on NRPE" src="../Images/tagoreillycom20081104nostarchimages223826.png"/></div>

        <p class="title">Figure 12-4. The three above-mentioned services depend on NRPE</p>
      </div>

      <p>To define the additional service check for NRPE, we make use of the possibility of calling the <strong class="userinput"><code>check_nrpe</code></strong> plugin (see <a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a>) (almost) without any parameters at all. It then simply returns the version of the NRPE daemons being used:</p><a id="I_programlisting9_d1e26802"/>
      <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>/usr/local/nagios/libexec/check_nrpe -H linux01</strong></span>
NRPE v2.0</pre>

      <p>The command defined in <a class="xref" href="../Text/ch10s05.html" title="10.5 Nagios Configuration">10.5 Nagios Configuration</a> in page 222, <strong class="userinput"><code>check_nrpe</code></strong>, requires further arguments and therefore cannot be used for our purposes. For this reason we set up a new command object, <strong class="userinput"><code>test_nrpe</code></strong>, which exclusively tests NRPE:</p><a id="I_programlisting9_d1e26817"/>
      <pre class="programlisting">define command{
    command_name     test_nrpe
    command_line $USER1$/check_nrpe -H $HOSTADDRESS$
}</pre>

      <p>With this, an <strong class="userinput"><code>NRPE</code></strong> service can now be defined:</p><a id="I_programlisting9_d1e26824"/>
      <pre class="programlisting">define service{
    host_name              linux01
    service_description    NRPE
    check_command          test_nrpe
    ...
}</pre>

      <p>The dependencies of the three local services of NRPE are described by the following <strong class="userinput"><code>servicedependency</code></strong> object.</p><a id="I_programlisting9_d1e26832"/>
      <pre class="programlisting">define servicedependency{
    host_name                        linux01
    service_description              NRPE
    dependent_host_name              linux01
    dependent_service_description    Disks, Users, Load
    notification_failure_criteria    c, u
    execution_failure_criteria       n
}</pre>

      <p><strong class="userinput"><code>host_name</code></strong> and <strong class="userinput"><code>service_description</code></strong> define the master service, the failure of which leads to the failure of the services named in <strong class="userinput"><code>dependent_service_description</code></strong> on the computer specified in <strong class="userinput"><code>dependent_host_name</code></strong>. Multiple entries, separated by commas, are possible for all four parameters mentioned. You should bear in mind, however, that each dependent service is dependent on every possible master service.</p>

      <p>The remaining parameters influence service checks and notifications: <strong class="userinput"><code>notification_failure_criteria</code></strong> specifies for which states of the master service notifications involving an error of the dependent services (e.g., <strong class="userinput"><code>Disks</code></strong>) should not appear. Possible values are <strong class="userinput"><code>u</code></strong> (UNKNOWN), <strong class="userinput"><code>w</code></strong> (WARNING), <strong class="userinput"><code>c</code></strong> (CRITICAL), <strong class="userinput"><code>p</code></strong> (PENDING, i.e., an initial check is planned but was so far not yet carried out), <strong class="userinput"><code>o</code></strong> (OK), and <strong class="userinput"><code>n</code></strong> (None).</p>

      <p><strong class="userinput"><code>u</code></strong>, <strong class="userinput"><code>c</code></strong> in the example above means that Nagios does not inform the administrators responsible of "errors" in the services <strong class="userinput"><code>Disks</code></strong>, <strong class="userinput"><code>Users</code></strong>, and <strong class="userinput"><code>Load</code></strong> on <strong class="userinput"><code>linux01</code></strong> if the master service is in the CRITICAL or UNKNOWN state. With an <strong class="userinput"><code>o</code></strong> for OK, the logic can be reversed: here there is no message if there is an error in the dependent service, as long as the master service is in an OK state. Accordingly, <strong class="userinput"><code>n</code></strong> means that Nagios provides a notification irrespective of the status of the master service.</p>

      <p>The <strong class="userinput"><code>execution_failure_criteria</code></strong> parameter controls tests, depending on the state of the master service. The details <strong class="userinput"><code>u</code></strong> (UNKNOWN), <strong class="userinput"><code>w</code></strong> (WARNING), <strong class="userinput"><code>c</code></strong> (CRITICAL), <strong class="userinput"><code>p</code></strong> (PENDING), <strong class="userinput"><code>o</code></strong> (OK), and <strong class="userinput"><code>n</code></strong> (None), as with <strong class="userinput"><code>notification_failure_criteria</code></strong>, refer to states of the master service for which there should be no check. In the example, <strong class="userinput"><code>n</code></strong> is specified, so that Nagios tests <strong class="userinput"><code>Disks</code></strong>, <strong class="userinput"><code>Users</code></strong>, and <strong class="userinput"><code>Load</code></strong> even if NRPE fails.</p>

      <p>Nagios therefore suppresses messages, but since it still carries out the service checks on the dependent services, the Web interface always shows the current status of these.</p>

      <p>The details for <strong class="userinput"><code>notification_failure_criteria</code></strong> interact with the <span class="emphasis"><em>Freshness mechanism</em></span> of passive tests (see <a class="xref" href="../Text/ch13s04.html" title="13.4 Reacting to Out-of-Date Information of Passive Checks">13.4 Reacting to Out-of-Date Information of Passive Checks</a> from page 295). If <strong class="userinput"><code>check_freshness</code></strong> is used in the service definition, and if Nagios considers the most recently determined status to be out of date, it will carry out active tests even if it ought to suppress them, according to the service dependency.</p>

      <div class="sect3" title="Inheritance">
        <div class="titlepage">
          <h3 class="title" id="heading_id_4"><a id="inheritance"/>Inheritance</h3>
        </div>

        <p>Nagios does not automatically inherit dependencies. An example of this is shown in <a class="xref" href="../Text/ch12s06.html#multilevel_dependencies_for_services" title="Figure 12-5. Multilevel dependencies for services">Figure 12-5</a>: on the internal side of a firewall, the system should query various resources via SNMP. For security reasons, the test is performed indirectly via NRPE, that is, the Nagios server runs the SNMP plugins, which are installed on a host inside the file, indirectly via NRPE.<a class="indexterm" id="IDX-CHP-12-1050"/><a class="indexterm" id="IDX-CHP-12-1051"/><a class="indexterm" id="IDX-CHP-12-1052"/><a class="indexterm" id="IDX-CHP-12-1053"/><a class="indexterm" id="IDX-CHP-12-1054"/><a class="indexterm" id="IDX-CHP-12-1055"/><a class="indexterm" id="IDX-CHP-12-1056"/></p>

        <div class="figure">
          <a id="multilevel_dependencies_for_services"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject9_d1e26994"/><img alt="Multilevel dependencies for services" src="../Images/tagoreillycom20081104nostarchimages223828.png"/></div>

          <p class="title">Figure 12-5. Multilevel dependencies for services</p>
        </div>

        <p>The following two <strong class="userinput"><code>servicedependency</code></strong> objects describe a dependency between the <strong class="userinput"><code>SNMP</code></strong> (Master) service and the <strong class="userinput"><code>Disks</code></strong> service (dependent service) on the host <strong class="userinput"><code>linux04</code></strong>, as well as between the <strong class="userinput"><code>NRPE</code></strong> service on <strong class="userinput"><code>linux01</code></strong> and the <strong class="userinput"><code>SNMP</code></strong> service on <strong class="userinput"><code>linux04</code></strong>:</p><a id="I_programlisting9_d1e27026"/>
        <pre class="programlisting">define servicedependency{
    host_name                       linux04
    service_description             SNMP
    dependent_host_name             linux04
    dependent_service_description   Disks
    notification_failure_criteria   c, u
    execution_failure_criteria      c, u
}

define servicedependency{
    host_name                         linux01
    service_description               NRPE
    dependent_host_name               linux04
    dependent_service_description     SNMP
    notification_failure_criteria     c, u
    execution_failure_criteria        c, u
}</pre>

        <p>If the NRPE daemon on <strong class="userinput"><code>linux01</code></strong> fails, Nagios would only recognize the defined dependencies between <strong class="userinput"><code>NRPE</code></strong> and <strong class="userinput"><code>SNMP</code></strong>, but not the implicit dependency between <strong class="userinput"><code>NRPE</code></strong> and <strong class="userinput"><code>Disks</code></strong>. To take these into account as well, the parameter <strong class="userinput"><code>inherits_parent</code></strong> is inserted in the definition of the service dependency between <strong class="userinput"><code>Disks</code></strong> and <strong class="userinput"><code>SNMP</code></strong>:</p><a id="I_programlisting9_d1e27055"/>
        <pre class="programlisting">inherits_parent                  1</pre>

        <p>With this, Nagios tests whether the master service itself (here <strong class="userinput"><code>SNMP</code></strong>) is dependent on another service, thanks to a corresponding <strong class="userinput"><code>servicedependency</code></strong>. If the <strong class="userinput"><code>NRPE</code></strong> service on <strong class="userinput"><code>linux01</code></strong> fails (CRITICAL state), Nagios leaves out the check of <strong class="userinput"><code>Disks</code></strong> on <strong class="userinput"><code>linux04</code></strong>, thanks to <strong class="userinput"><code>execution_failure_criteria c, u</code></strong>, and also does not send any notification of the most recently detected status of <strong class="userinput"><code>Disks</code></strong>.</p>
      </div>

      <div class="sect3" title="Other application cases">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="other_application_cases"/>Other application cases</h3>
        </div>

        <p>Dependency definitions between services are particularly useful if a great deal depends on a single service, so that the actual problem is in danger of disappearing under a flood of error messages. Apart from the already described use in combination with NRPE, this applies for all services that the Nagios server cannot test directly and for which it must use tools instead (NRPE, SNMP, or even <strong class="userinput"><code>NSCLIENT</code></strong> for Windows, see <a class="xref" href="../Text/ch20s02.html#nsclient" title="20.2.1 NSClient">20.2.1 NSClient</a>). If a simple connection to the utility cannot be established and a constant value (version number, system name) cannot be queried, you can still use a generic plugin to address the corresponding port.<a class="indexterm" id="IDX-CHP-12-1057"/><a class="indexterm" id="IDX-CHP-12-1058"/><a class="indexterm" id="IDX-CHP-12-1059"/><a class="indexterm" id="IDX-CHP-12-1060"/><a class="indexterm" id="IDX-CHP-12-1061"/><a class="indexterm" id="IDX-CHP-12-1062"/></p>

        <p>Another example of using service dependencies are the applications that depend on a database: a Web application with dynamic Web pages fails if the underlying database (which may be located somewhere in the network on another host) is not working. A precisely defined dependency between the database service and dynamic Web application also ensures here that the administrator is notified of the actual cause.</p>
      </div>

      <div class="sect3" title="Additional functions in Nagios 3.0">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="additional_functions_in_nagios"/>Additional functions in Nagios 3.0</h3>
        </div>

        <p>Nagios 3.0 includes two innovations: On one hand, the parameter <strong class="userinput"><code>dependency_period</code></strong> now allows a time restriction to be placed on the dependency. The default is <strong class="userinput"><code>7x24h</code></strong>, that is, round the clock.</p>

        <p>On the other hand, Nagios 3.0 makes it easier to define the dependencies between services and dependent services on the same host. Specifying <strong class="userinput"><code>dependent_host_name</code></strong>, as was done in the previous examples, can be omitted if this is identical to <strong class="userinput"><code>host_name</code></strong>. An example of this so-called <span class="emphasis"><em>same-host dependency</em></span> is described in <a class="xref" href="../Text/aph.html#dependency_descriptions" title="H.1.6 Dependency descriptions">H.1.6 Dependency descriptions</a> in page 683.</p>
      </div>
    </div>

    <div class="sect2" title="12.6.2 Only in exceptional cases: host dependencies">
      <div class="titlepage">
        <h2 class="title" id="heading_id_7"><a id="only_in_exceptional_cases_colon_host_de"/>12.6.2 Only in exceptional cases: host dependencies</h2>
      </div>

      <p>Host dependencies function in principle exactly like service dependencies; the <strong class="userinput"><code>hostdependency</code></strong> object is also capable of suppressing messages.</p>

      <p>There are a number of subtle differences in the detail, however. Only explicitly configured regular host checks can be suppressed in which checked intervals are defined as for services. This type of host check should be used only in exceptional circumstances, however, since it can have a significant influence on the performance of Nagios. Normally Nagios decides for itself when it will perform a host check (see <a class="xref" href="../Text/ch04.html#taking_into_account_the_network_topology" title="4.1 Taking into Account the Network Topology">4.1 Taking into Account the Network Topology</a> from page 92).</p>

      <p>In nearly all cases the <strong class="userinput"><code>parents</code></strong> parameter in the host definition is better at describing the dependencies between hosts. As long as Nagios can test individual hosts directly, the system can distinguish much better between DOWN and UNREACHABLE (see <a class="xref" href="../Text/ch04.html#taking_into_account_the_network_topology" title="4.1 Taking into Account the Network Topology">4.1 Taking into Account the Network Topology</a> from page 92). If you do not want any notification for particular hosts, dependent on the network topology, then you should be informed only for DOWN, but not for UNREACHABLE.</p>

      <p>Host dependencies should be used only when Nagios can no longer distinguish between DOWN and UNREACHABLE. This is usually the case when indirect checksthe host check is performed indirectly (e. g., in the figure shown in <a class="xref" href="../Text/ch10s05.html#optimizing_the_configuration" title="10.5.3 Optimizing the configuration">10.5.3 Optimizing the configuration</a>).</p>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;13.&#xA0;Passive Tests with the External Command File">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="passive_tests_with_the_external_command"/>Chapter 13. Passive Tests with the External Command File</h1>
    </div>

    <p>Apart from active service and host checks, Nagios also makes use of passive tests (and combinations of both types of test). While the system itself defines the time for active checks when they are performed, and then initiates them, Nagios in passive mode only processes incoming results.<a class="indexterm" id="IDX-CHP-13-1063"/><a class="indexterm" id="IDX-CHP-13-1064"/><a class="indexterm" id="IDX-CHP-13-1065"/><a class="indexterm" id="IDX-CHP-13-1066"/></p>

    <p>For this to work, an interface is required that allows test results from the outside to be passed on to Nagios, as well as commands that perform checks and feed in the results through the interface. Normally remote hosts send their test results, determined by shell scripts, via the <span class="emphasis"><em>Nagios Service Check Acceptor</em></span> (NSCA), which is introduced in the next chapter (<a class="xref" href="../Text/ch14.html" title="Chapter 14. The Nagios Service Check Acceptor (NSCA)">Chapter 14</a>), to the Nagios server.<a class="indexterm" id="IDX-CHP-13-1067"/></p>

    <p>Passive checks are used in particular with distributed monitoring, in which noncentral Nagios servers send all their results to a central Nagios instance. This subject is discussed in <a class="xref" href="../Text/ch15.html" title="Chapter 15. Distributed Monitoring">Chapter 15</a>. Another field in which they are used is in the processing of asynchronous events, the time of which Nagios cannot define itself. One example of this is a backup script that sends a result to Nagios (OK or CRITICAL) when it has completed a data backup, and another example is processing SNMP traps (see <a class="xref" href="../Text/ch14s06.html" title="14.6 Application Example II: Processing SNMP Traps">14.6 Application Example II: Processing SNMP Traps</a>).<a class="indexterm" id="IDX-CHP-13-1068"/><a class="indexterm" id="IDX-CHP-13-1069"/></p>

    <div class="sect1" title="13.1 The Interface for External Commands">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="the_interface_for_external_commands"/>13.1 The Interface for External Commands</h1>
      </div>

      <p>The interface for external commands, known in Nagios jargon as <span class="emphasis"><em>External Command Files</em></span>, consists of a named pipe (FIFO)<sup>[<a class="footnote" href="#ftn.CHP-13-FN-1" id="CHP-13-FN-1">131</a>]</sup> in the subdirectory <strong class="userinput"><code>rw</code></strong> of the Nagios <strong class="userinput"><code>var</code></strong> directory:<a class="indexterm" id="IDX-CHP-13-1070"/><a class="indexterm" id="IDX-CHP-13-1071"/><a class="indexterm" id="IDX-CHP-13-1072"/><a class="indexterm" id="IDX-CHP-13-1073"/><a class="indexterm" id="IDX-CHP-13-1074"/></p><a id="I_programlisting10_d1e27256"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>ls -lF /var/nagios/rw</strong></span>
prw-rw---- 1 nagios nagcmd 0 Dec 19 10:56 nagios.cmd|</pre>

      <p>The pipe, marked in the <strong class="userinput"><code>ls</code></strong> output with <strong class="userinput"><code>p</code></strong>, correctly sets up the <strong class="userinput"><code>make install-commandmode</code></strong> command during installation. For reasons of security it is essential that you ensure that only the group <strong class="userinput"><code>nagcmd</code></strong> can read from and write to the pipe. Anyone who has access here can control Nagios remotely via commands, and can, if they want, shut it down entirely.<a class="indexterm" id="IDX-CHP-13-1075"/></p>

      <p>Commands that Nagios accepts from the External Command File have the following form:<a class="indexterm" id="IDX-CHP-13-1076"/></p><a id="I_programlisting10_d1e27283"/>
      <pre class="programlisting">[<span class="emphasis"><em>timestamp</em></span>] <span class="emphasis"><em>command;arguments</em></span></pre>

      <p>As the timestamp in square brackets, Nagios expects the current time in epoch seconds, that is the number of seconds which have elapsed in the UTC time zone since January 1, 1970. This is followed by a space, then a command followed by a matching number of arguments, separated by a semicolon.</p>

      <p>The interface makes extensive use of this mechanism, allowing its users to make various settings via mouse click. A detailed description of all possible commands is provided by the online documentation.<sup>[<a class="footnote" href="#ftn.CHP-13-FN-2" id="CHP-13-FN-2">132</a>]</sup> An example script for each command can be found there, which can be copied to a file with cut-and-paste and used after a few path adjustments have been made.</p>

      <p>In this chapter we will limit ourselves to the two processing commands with which computers deliver the results of passive checks to the Nagios server, <strong class="userinput"><code>PROCESS_SERVICE_CHECK_RESULT</code></strong> and <strong class="userinput"><code>PROCESS_HOST_CHECK_RESULT</code></strong>.<a class="indexterm" id="IDX-CHP-13-1077"/><a class="indexterm" id="IDX-CHP-13-1078"/></p>

      <p>For reasons of security, the processing of external commands must be explicitly switched on in the main configuration file <strong class="userinput"><code>nagios.cfg</code></strong> with the directive <strong class="userinput"><code>check_external_commands=1</code></strong>:<a class="indexterm" id="IDX-CHP-13-1079"/></p><a id="I_programlisting10_d1e27323"/>
      <pre class="programlisting"># /etc/nagios/nagios.cfg
...
check_external_commands=1
command_check_interval=-1
command_file=/var/nagios/rw/nagios.cmd
...</pre>

      <p>The <strong class="userinput"><code>command_check_interval</code></strong> determines that Nagios checks the interface for existing commands every so many seconds. <strong class="userinput"><code>−1</code></strong> means "as often as possible." <strong class="userinput"><code>command_file</code></strong> specifies the path to the named pipe.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-13-FN-1" id="ftn.CHP-13-FN-1">131</a>]</sup> A named pipe is a buffer to which a process can write something, which can then be read by another process. Whatever is written first is also read first: <span class="emphasis"><em>First In, First Out</em></span> (FIFO). Since this involves space in the main memory, a named pipe does not need any space on the hard drive.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-13-FN-2" id="ftn.CHP-13-FN-2">132</a>]</sup> <a class="ulink" href="http://www.nagios.org/developerinfo/externalcommands/">http://www.nagios.org/developerinfo/externalcommands/</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="13.2 Passive Service Checks">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="passive_service_checks"/>13.2 Passive Service Checks</h1>
    </div>

    <p>In order for Nagios to be able to accept passive service checks via the interface, this must be explicitly allowed in the global configuration and in the corresponding service definition. The corresponding entry in <strong class="userinput"><code>nagios.cfg</code></strong> is<a class="indexterm" id="IDX-CHP-13-1080"/><a class="indexterm" id="IDX-CHP-13-1081"/><a class="indexterm" id="IDX-CHP-13-1082"/></p><a id="I_programlisting10_d1e27360"/>
    <pre class="programlisting"># /etc/nagios/nagios.cfg
...
accept_passive_service_checks=1
...</pre>

    <p>In the service definition you can select whether you want to perform active checks in parallel to the passive ones. Active checks are only possible, of course, if Nagios can query the information itself. The following example allows passive checks and stops all active ones:</p><a id="I_programlisting10_d1e27364"/>
    <pre class="programlisting">define service{
    host_name                             linux01
    service_description                   Disks
    passive_checks_enabled                1
    active_checks_enabled                 0
    check_command                         check_dummy
    check_period                          none
    ...
}</pre>

    <p>An exception is normally made for <span class="emphasis"><em>freshness checks</em></span> (see <a class="xref" href="../Text/ch13s04.html" title="13.4 Reacting to Out-of-Date Information of Passive Checks">13.4 Reacting to Out-of-Date Information of Passive Checks</a> from page 295)—here Nagios makes use of the command defined in <strong class="userinput"><code>check_command</code></strong>. To ban active checks entirely, the <strong class="userinput"><code>check_period</code></strong> parameter is set to <strong class="userinput"><code>none</code></strong>. The check command does not play a role in this case, so you can just enter a dummy check here, for example (which like all other commands has to be defined, of course).</p>

    <p>On the computer to be tested passively (in this example, <strong class="userinput"><code>linux01</code></strong>) you must ensure, via NSCA (see <a class="xref" href="../Text/ch14.html" title="Chapter 14. The Nagios Service Check Acceptor (NSCA)">Chapter 14</a>), that it contacts the Nagios server through the interface for external commands. There it writes the command for passive service checks in the following one-line form:</p><a id="I_programlisting10_d1e27389"/>
    <pre class="programlisting">[<span class="emphasis"><em>timestamp</em></span>] PROCESS_SERVICE_CHECK_RESULT; <span class="emphasis"><em>host-name;service;</em></span>
<span class="emphasis"><em>return value; plugin output</em></span></pre>

    <p>The timestamp can be created in a shell script, for example with <strong class="userinput"><code>date</code></strong>:<a class="indexterm" id="IDX-CHP-13-1083"/></p><a id="I_programlisting10_d1e27407"/>
    <pre class="programlisting">user@linux:~$ <span class="strong"><strong>date +%s</strong></span>
1112435763</pre>

    <p>A simple script that passes on the result of a passive service check on the Nagios server itself to the Nagios installed there, could look like this:</p><a id="I_programlisting10_d1e27415"/>
    <pre class="programlisting">#!/bin/bash
EXTCMDFILE="/var/nagios/rw/nagios.cmd"
TIME='date +%s'
HOST=$1
SRV=$2
RESULT=$3
OUTPUT=$4
CMD="[$TIME] PROCESS_SERVICE_CHECK_RESULT;$HOST;$SRV;$RESULT;$OUTPUT"

/bin/echo $CMD &gt;&gt; $EXTCMDFILE</pre>

    <p>When it is run it expects the parameters in the correct sequence:</p><a id="I_programlisting10_d1e27419"/>
    <pre class="programlisting"><span class="emphasis"><em>name_of_script</em></span> linux01 Disks 0 'Disks ok: everything in order :-)'</pre>

    <p>After the host and service names, the test status follows as a digit, and finally the output text. If the service name contains spaces, then it should also be set in quotation marks.</p>
  </div>


  <div class="sect1" title="13.3 Passive Host Checks">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="passive_host_checks"/>13.3 Passive Host Checks</h1>
    </div>

    <p>Passive host checks follow the same principle as passive service checks, except that they involve computers and not services. To allow them globally, the <strong class="userinput"><code>accept_passive_host_checks</code></strong> parameter is set in <strong class="userinput"><code>nagios.cfg</code></strong> to 1:<a class="indexterm" id="IDX-CHP-13-1084"/><a class="indexterm" id="IDX-CHP-13-1085"/></p><a id="I_programlisting10_d1e27444"/>
    <pre class="programlisting"># /etc/nagios/nagios.cfg
...
accept_passive_host_checks=1
...</pre>

    <p>In addition, the host definition for the computer to be monitored passively must allow this kind of host check:</p><a id="I_programlisting10_d1e27448"/>
    <pre class="programlisting">define host{
    host_name                       linux01
    passive_checks_enabled          1
    active_checks_enabled           0
    check_period                    none
    check_command                   check_dummy
    ...
}</pre>

    <p>In this example it simultaneously forbids active checks.</p>

    <p>The command to be sent through the external interface with which the computer delivers its test results differs here only marginally from the syntax used in the service check command already introduced:</p><a id="I_programlisting10_d1e27454"/>
    <pre class="programlisting">[<span class="emphasis"><em>timestamp</em></span>] PROCESS_HOST_CHECK_RESULT;<span class="emphasis"><em>hostname;return value; plugin output</em></span></pre>

    <p>Active and passive host checks differ in one important respect: with passive checks, Nagios is no longer in a position to distinguish between DOWN and UNREACHABLE (see <a class="xref" href="../Text/ch04.html#taking_into_account_the_network_topology" title="4.1 Taking into Account the Network Topology">4.1 Taking into Account the Network Topology</a> from page 92). If you still want to take account of network topology dependencies when making notifications and to give specific information on the actual host that is down, you must make use of host dependencies in this case (see <a class="xref" href="../Text/ch12s06.html#only_in_exceptional_cases_colon_host_de" title="12.6.2 Only in exceptional cases: host dependencies">12.6.2 Only in exceptional cases: host dependencies</a> from page 289).<a class="indexterm" id="IDX-CHP-13-1086"/></p>
  </div>


  <div class="sect1" title="13.4 Reacting to Out-of-Date Information of Passive Checks">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="reacting_to_out-of-date_information_of"/>13.4 Reacting to Out-of-Date Information of Passive Checks</h1>
    </div>

    <p>It lies in the nature of passive checks that Nagios is content with the information delivered. Nagios has no influence over when and at what intervals the remote host delivers them. It may even be the case that the information does not arrive at all.<a class="indexterm" id="IDX-CHP-13-1087"/><a class="indexterm" id="IDX-CHP-13-1088"/><a class="indexterm" id="IDX-CHP-13-1089"/><a class="indexterm" id="IDX-CHP-13-1090"/></p>

    <p>In order to classify the "knowledge state" of the server as out of date, Nagios has the ability to become active itself, with a <span class="emphasis"><em>freshness check</em></span>. Like passive checks, freshness checking must be enabled both globally and in the relevant serviceable host object. To do this, you need to set the following global parameters in the file <strong class="userinput"><code>nagios.cfg</code></strong>:</p><a id="I_programlisting10_d1e27499"/>
    <pre class="programlisting"># /etc/nagios/nagios.cfg
...
check_service_freshness=1
service_freshness_check_interval=60
check_host_freshness=0
host_freshness_check_interval=60
...</pre>

    <p>The value <strong class="userinput"><code>0</code></strong> in <strong class="userinput"><code>check_host_freshness</code></strong> and the value <strong class="userinput"><code>1</code></strong> in <strong class="userinput"><code>check_service_freshness</code></strong> ensure that Nagios carries out freshness checks only for services, and not for hosts. The check interval defines the intervals at which the server updates its information, in this case, every 60 seconds. When Nagios really becomes active in the case of a specific service or host depends on the threshold value, which you can set in the appropriate service or host definition with the <strong class="userinput"><code>freshness_threshold</code></strong> parameter:<sup>[<a class="footnote" href="#ftn.CHP-13-FN-3" id="CHP-13-FN-3">133</a>]</sup></p><a id="I_programlisting10_d1e27531"/>
    <pre class="programlisting">define service{
    host_name                 linux01
    service_description       Disks
    passive_checks_enabled    1
    active_checks_enabled     0
    check_freshness           1
    freshness_threshold       3600
    check_command             service_is_stale
    ...
}</pre>

    <p>So in this example Nagios performs the freshness check for this service only if the last transmitted value is older than 3600 seconds (one hour). Then Nagios starts the command defined in <strong class="userinput"><code>check_command</code></strong>, even if active checks have been switched off in the corresponding host or service definition, or even globally.<a class="indexterm" id="IDX-CHP-13-1091"/></p>

    <p>If you define the command named here in the example, <strong class="userinput"><code>service_is_stale</code></strong>, so that Nagios really does check the service or host, then Nagios will perform active tests even if active checking is switched off, but always only if passive results are overdue for longer than the threshold value set.</p>

    <p>If active checks are not possible or not wanted, you can ensure, using a pseudo-test, that Nagios will explicitly signal an error status, so that the administrator's attention is drawn to it. Otherwise Nagios will always display the last status to be received. If this was OK, then it will not necessarily be noticed that current results have not been arriving for some time. The following pseudo-test script delivers an appropriate error message with <strong class="userinput"><code>echo</code></strong>, and with <strong class="userinput"><code>exit 2</code></strong> delivers the return value for CRITICAL, so that the administrator can react accordingly:<a class="indexterm" id="IDX-CHP-13-1092"/></p><a id="I_programlisting10_d1e27559"/>
    <pre class="programlisting">#!/bin/bash
/bin/echo "CRITICAL: no current results of the service"
exit 2</pre>

    <p>If you start the script from the plugin directory as <strong class="userinput"><code>service_is_stale. sh</code></strong>, the Nagios command <strong class="userinput"><code>service_is_stale</code></strong> will be defined as follows:</p><a id="I_programlisting10_d1e27570"/>
    <pre class="programlisting">define command{
   command_name         service_is_stale
   command_line         $USER1$/service_is_stale.sh
}</pre>

    <p>If the results for the service <strong class="userinput"><code>Disks</code></strong> on <strong class="userinput"><code>linux01</code></strong> fail to appear for longer than one hour, Nagios will run the script <strong class="userinput"><code>service_is_stale.sh</code></strong>, which always returns CRITICAL, irrespective of what data <strong class="userinput"><code>linux01</code></strong> last sent. This CRITICAL status is only ended when the host passes on new and more positive results to the server through a passive check.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-13-FN-3" id="ftn.CHP-13-FN-3">133</a>]</sup> If you do not explicitly specify <strong class="userinput"><code>freshness_threshold</code></strong>, the value set for <strong class="userinput"><code>normal_check_interval</code></strong> will be used in the hard state, and if there is a soft state, the value <strong class="userinput"><code>retry_check_interval</code></strong> will serve as the default.</p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;14.&#xA0;The Nagios Service Check Acceptor (NSCA)">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_nagios_service_check_acceptor"/>Chapter 14. The Nagios Service Check Acceptor (NSCA)</h1>
    </div>

    <p>In order to send service and host checks across the network to the central Nagios server, a transmission mechanism is required. This is provided by the <span class="emphasis"><em>Nagios Service Check Acceptor</em></span> (NSCA). It consists of two components: a client program <strong class="userinput"><code>send_nsca</code></strong>, which accepts the results of a service or host check on the remote host and sends them to the Nagios server, and the NSCA daemon <strong class="userinput"><code>nsca</code></strong>, which runs on the server, receives data from the client, processes this for the External Command File interface (see <a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>), and passes this data on to it (<a class="xref" href="../Text/ch14.html#how_the_nsca_functions" title="Figure 14-1. How the NSCA functions">Figure 14-1</a>).<a class="indexterm" id="IDX-CHP-14-1094"/><a class="indexterm" id="IDX-CHP-14-1093"/><a class="indexterm" id="IDX-CHP-14-1095"/></p>

    <p>The Nagios Service Check Acceptor was originally developed to enable distributed monitoring in which decentralized Nagios servers can send their results to a central Nagios server (see <a class="xref" href="../Text/ch15.html" title="Chapter 15. Distributed Monitoring">Chapter 15</a> from page 317). In principle, the data that <strong class="userinput"><code>send_nsca</code></strong> sends to the Nagios server can come from any applications you like.<a class="indexterm" id="IDX-CHP-14-1096"/></p>

    <p>Sending commands across the network to the central Nagios instance is not insignificant, from a security point of view, since Nagios could be completely switched off using the External Command File. This is why NSCA sends the data in encrypted form, and clients must have the correct key to obtain access to the interface. This prevents an arbitrary network participant from being able to run any commands at all on the Nagios server.<a class="indexterm" id="IDX-CHP-14-1097"/></p>

    <div class="figure">
      <a id="how_the_nsca_functions"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject11_d1e27636"/><img alt="How the NSCA functions" src="../Images/tagoreillycom20081104nostarchimages223830.png"/></div>

      <p class="title">Figure 14-1. How the NSCA functions</p>
    </div>

    <div class="sect1" title="14.1 Installation">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="installation-id3"/>14.1 Installation</h1>
      </div>

      <p>NSCA version 2.7.2, current at the time of going to press, was published in the spring of 2007; the chances are therefore quite high that the distribution you are using contains a current package. The source code<sup>[<a class="footnote" href="#ftn.CHP-14-FN-1" id="CHP-14-FN-1">134</a>]</sup> is quite easy to compile yourself, however. As a prerequisite, you need to have the library <strong class="userinput"><code>libmcrypt</code></strong> installed, together with the relevant header files,<sup>[<a class="footnote" href="#ftn.CHP-14-FN-2" id="CHP-14-FN-2">135</a>]</sup> or else the integrated encryption cannot be used.<a class="indexterm" id="IDX-CHP-14-1099"/><a class="indexterm" id="IDX-CHP-14-1098"/></p>

      <p>In the unpacked source directory, you should run the included <strong class="userinput"><code>configure</code></strong> script, specifying the Nagios configuration and <strong class="userinput"><code>var</code></strong> directories:</p><a id="I_programlisting11_d1e27681"/>
      <pre class="programlisting">linux:local/src # <span class="strong"><strong>tar xvzf</strong></span><span class="bolditalic">/path/to/</span><span class="strong"><strong>nsca-2.7.2.tar.gz</strong></span>
...
linux:local/src # <span class="strong"><strong>cd nsca-2.7.2</strong></span>
linux:src/nsca-2.7.2 # <span class="strong"><strong>./configure --sysconfdir=/etc/nagios \</strong></span>
<span class="strong"><strong>--localstatedir=/var/nagios</strong></span>
...
<span class="strong"><strong>***</strong></span> Configuration summary for nsca 2.7.2 07-03-2007 <span class="strong"><strong>***</strong></span>:

 General Options:
 --------------------------
 NSCA port: 5667
 NSCA user: nagios
 NSCA group: nagios
...</pre>

      <p>At the end it displays output, showing the permissions with which the NSCA user starts by default, if not otherwise specified in the configuration. Normally the NSCA daemon waits on TCP port 5667.</p>

      <p>A final <strong class="userinput"><code>make all</code></strong> compiles the two programs <strong class="userinput"><code>nsca</code></strong> and <strong class="userinput"><code>send_nsca</code></strong>. They are now located in the subdirectory <strong class="userinput"><code>src</code></strong> and need to be copied manually to a suitable directory:</p><a id="I_programlisting11_d1e27722"/>
      <pre class="programlisting">linux:src/nsca-2.7.2 # <span class="strong"><strong>cp src/nsca /usr/local/sbin/</strong></span>.
linux:src/nsca-2.7.2 # <span class="strong"><strong>scp src/send_nsca</strong></span> <span class="bolditalic">remote host</span><span class="strong"><strong>: /usr/local/bin/</strong></span>.</pre>

      <p><strong class="userinput"><code>nsca</code></strong> is copied to the Nagios server, preferably to the directory <strong class="userinput"><code>/usr/local/ sbin. send_nsca</code></strong> belongs on the remote host that is to send its test results to the Nagios server. If this computer has a different operating system version or platform, it is possible that the client to run there will need to be recompiled. Both programs each require their own configuration file, which is best stored in the directory <strong class="userinput"><code>/etc/nagios:</code></strong></p><a id="I_programlisting11_d1e27744"/>
      <pre class="programlisting">linux:src/nsca-2.7.2 # <span class="strong"><strong>cp nsca.cfg /etc/nagios/</strong></span>.
linux:src/nsca-2.7.2 # <span class="strong"><strong>scp send_nsca.cfg</strong></span> <span class="bolditalic">remote_host</span><span class="strong"><strong>: /etc/nagios/</strong></span>.</pre>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-1" id="ftn.CHP-14-FN-1">134</a>]</sup> <a class="ulink" href="http://www.nagios.org/download/">http://www.nagios.org/download/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-2" id="ftn.CHP-14-FN-2">135</a>]</sup> The corresponding binary package usually contains <strong class="userinput"><code>-dev</code></strong> or <strong class="userinput"><code>-devel</code></strong> in its name.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="14.2 Configuring the Nagios Server">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="configuring_the_nagios_server"/>14.2 Configuring the Nagios Server</h1>
    </div>

    <div class="sect2" title="14.2.1 The configuration file nsca.cfg">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="the_configuration_file_nsca.cfg"/>14.2.1 The configuration file <strong class="userinput"><code>nsca.cfg</code></strong></h2>
      </div>

      <p>For NSCA to work, the External Command File interface on the Nagios server must be activated in the configuration file <strong class="userinput"><code>/etc/nagios/nagios.cfg</code></strong> (<a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>, page 292) and the corresponding data entered in the NSCA configuration file <strong class="userinput"><code>nsca.cfg:</code></strong><a class="indexterm" id="IDX-CHP-14-1101"/><a class="indexterm" id="IDX-CHP-14-1102"/><a class="indexterm" id="IDX-CHP-14-1103"/><a class="indexterm" id="IDX-CHP-14-1104"/><a class="indexterm" id="IDX-CHP-14-1105"/><a class="indexterm" id="IDX-CHP-14-1106"/><a class="indexterm" id="IDX-CHP-14-1100"/></p><a id="I_programlisting11_d1e27804"/>
      <pre class="programlisting"># /etc/nagios/nsca.cfg
server_port=5667
server_address=192.168.1.1
allowed_hosts=127.0.0.1
nsca_user=nagios
nsca_group=nagios
debug=0
command_file=/var/nagios/rw/nagios.cmd
alternate_dump_file=/var/nagios/rw/nsca.dump
aggregate_writes=0
append_to_file=0
max_packet_age=30
password=verysecret
decryption_method=10</pre>

      <p>The parameters <strong class="userinput"><code>server_port</code></strong>, <strong class="userinput"><code>server_address</code></strong>, <strong class="userinput"><code>allowed_hosts</code></strong>, <strong class="userinput"><code>nsca_user</code></strong>, and <strong class="userinput"><code>nsca_group</code></strong> take effect only if <strong class="userinput"><code>nsca</code></strong> is started as a daemon. If it is started as an inet daemon, the values set in its configuration apply to the NSCA server address and the port on which the NSCA is listening, the IP addresses of the hosts that are allowed to access the interface,<sup>[<a class="footnote" href="#ftn.CHP-14-FN-3" id="CHP-14-FN-3">136</a>]</sup> and the users and group with whose permissions the Service Check Acceptor runs.</p>

      <p>The <strong class="userinput"><code>debug</code></strong> parameter makes it easier to search for errors, but it should normally be switched off (value <strong class="userinput"><code>0</code></strong>). If it is set to <strong class="userinput"><code>1</code></strong>, NSCA writes debugging information in the syslog.</p>

      <p>The named pipe is defined by the entry <strong class="userinput"><code>command_file</code></strong>. If you specify an alternative output file, with <strong class="userinput"><code>alternate_dump_file</code></strong>, this serves as a fallback in case the named pipe given does not exist. Before version 2.0, Nagios removed the pipe each time it was shut down, but this should not happen anymore.</p>

      <p>If it is set to <strong class="userinput"><code>1</code></strong>, <strong class="userinput"><code>aggregate_writes</code></strong> ensures that NSCA collects all the incoming commands just once and then passes these on to the interface as a block. If the value at this position is <strong class="userinput"><code>0</code></strong>, then NSCA sends on each incoming command immediately to the External Command File.</p>

      <p><strong class="userinput"><code>append_to_file</code></strong> can have the values <strong class="userinput"><code>0</code></strong> (opens the External Command File in write mode) or <strong class="userinput"><code>1</code></strong> (opens it in the append mode), and it should always be set to <strong class="userinput"><code>0</code></strong>.<sup>[<a class="footnote" href="#ftn.CHP-14-FN-4" id="CHP-14-FN-4">137</a>]</sup></p>

      <p>Client messages older than <strong class="userinput"><code>max_packet_age</code></strong> seconds are discarded by NSCA, to avoid replay attacks. This value may not be larger than 900 seconds (15 minutes) and should be as small as possible.</p>

      <p>The last two parameters refer to the encryption of the communication. <strong class="userinput"><code>password</code></strong> contains the actual key, which is identical for clients, and which must be entered in the configuration for the clients (see <a class="xref" href="../Text/ch14s03.html" title="14.3 Client-side Configuration">14.3 Client-side Configuration</a> in page 304). Because the key is written in the file in plain text, <strong class="userinput"><code>nsca.cfg</code></strong> should be readable only for the user with whose permissions the NSCA is running, which in our case is <strong class="userinput"><code>nagios:</code></strong><a class="indexterm" id="IDX-CHP-14-1107"/></p><a id="I_programlisting11_d1e27902"/>
      <pre class="programlisting">linux:/etc/nagios # <span class="strong"><strong>chown nagios.nagios nsca.cfg</strong></span>
linux:/etc/nagios # <span class="strong"><strong>chmod 400 nsca.cfg</strong></span></pre>

      <p>Finally, <strong class="userinput"><code>decryption_method</code></strong> defines the encryption algorithm. The default is <strong class="userinput"><code>1</code></strong> (XOR), which is almost as insecure as <strong class="userinput"><code>0</code></strong> (no encryption). <strong class="userinput"><code>10</code></strong> stands for LOKI97, which is regarded as secure.<sup>[<a class="footnote" href="#ftn.CHP-14-FN-5" id="CHP-14-FN-5">138</a>]</sup> The list of all possible algorithms is contained in the supplied configuration file, which contains many old algorithms and some newer ones, such as DES (<strong class="userinput"><code>2</code></strong>), Triple-DES (<strong class="userinput"><code>3</code></strong>), Blowfish (<strong class="userinput"><code>8</code></strong>), and Rijndael (AES).<sup>[<a class="footnote" href="#ftn.CHP-14-FN-6" id="CHP-14-FN-6">139</a>]</sup></p>
    </div>

    <div class="sect2" title="14.2.2 Configuring the inet daemon">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="configuring_the_inet_daemon"/>14.2.2 Configuring the inet daemon</h2>
      </div>

      <p>If you want to start <strong class="userinput"><code>nsca</code></strong> with the inet daemon, the following entry is added in the file <strong class="userinput"><code>/etc/services:</code></strong><a class="indexterm" id="IDX-CHP-14-1108"/></p><a id="I_programlisting11_d1e27964"/>
      <pre class="programlisting">nsca 5667/tcp # Nagios Service Check Acceptor (NSCA)</pre>

      <div class="sect3" title="xinetd configuration">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="xinetd_configuration-id1"/><strong class="userinput"><code>xinetd</code></strong> configuration</h3>
        </div>

        <p>If the newer <strong class="userinput"><code>xinetd</code></strong> is used, the file <strong class="userinput"><code>nagios-nsca</code></strong> is created in the directory <strong class="userinput"><code>/etc/xinetd.d</code></strong> with the following contents:</p><a id="I_programlisting11_d1e27982"/>
        <pre class="programlisting"># /etc/xinetd.d/nsca
# description: NSCA
# default: on
service nsca
{
   flags           = REUSE
   socket_type     = stream
   wait            = no
   user            = <span class="strong"><strong>nagios</strong></span>
   group           = <span class="strong"><strong>nagios</strong></span>
   server          = <span class="strong"><strong>/usr/local/sbin/nsca</strong></span>
   server_args     = -c <span class="strong"><strong>/etc/nagios/nsca.cfg</strong></span> --inetd
   log_on_failure  += USERID
   disable         = no
   only_from       = <span class="strong"><strong>127.0.0.1</strong></span> <span class="bolditalic">ip1 ip2</span>... <span class="emphasis"><em>ipn</em></span>
}</pre>

        <p>The values printed in bold type for the user and group with whose permissions the NSCA should run, and the path to the NSCA daemon <strong class="userinput"><code>nsca</code></strong> (parameter <strong class="userinput"><code>server</code></strong>) and the corresponding configuration file, are adjusted if necessary to your own environment. The line <strong class="userinput"><code>only_from</code></strong>, as an equivalent to the <strong class="userinput"><code>nsca.cfg</code></strong> parameter <strong class="userinput"><code>allowed_hosts</code></strong>, takes in all the IP addresses, separated by spaces, from which the NSCA may be addressed. Distributions that include NSCA as a finished package and install <strong class="userinput"><code>xinetd</code></strong> by default, include a ready-to-use <strong class="userinput"><code>xinetd</code></strong> configuration file, where you only need to adjust this last parameter.</p>

        <p>In order for the new configuration to become effective, the <strong class="userinput"><code>xinetd</code></strong> init script is run with the <strong class="userinput"><code>reload</code></strong> argument:</p><a id="I_programlisting11_d1e28038"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/xinetd reload</strong></span></pre>
      </div>

      <div class="sect3" title="inetd configuration">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="inetd_configuration"/>inetd configuration</h3>
        </div>

        <p>If the standard <strong class="userinput"><code>inetd</code></strong> command is run, the following line is added (line-wrapped for the printed version) in the configuration file <strong class="userinput"><code>/etc/inetd.conf:</code></strong><a class="indexterm" id="IDX-CHP-14-1109"/><a class="indexterm" id="IDX-CHP-14-1110"/><a class="indexterm" id="IDX-CHP-14-1111"/></p><a id="I_programlisting11_d1e28065"/>
        <pre class="programlisting">nsca stream tcp nowait <span class="strong"><strong>nagios</strong></span> /usr/sbin/tcpd
<span class="strong"><strong>     /usr/local/sbin/nsca</strong></span> -c <span class="strong"><strong>/etc/nagios/nsca.cfg</strong></span> --inetd</pre>

        <p>If you want to leave out the TCP wrapper <strong class="userinput"><code>tcpd</code></strong>, you just omit the string <strong class="userinput"><code>/usr/sbin/tcpd</code></strong>. In this case you must also explicitly specify the user (<strong class="userinput"><code>nagios</code></strong>) with whose permissions the NSCA starts, the complete path to the binary <strong class="userinput"><code>nsca</code></strong>, and the configuration file with its absolute path. So that the Internet daemon can take account of the modification, its configuration must be reloaded:</p><a id="I_programlisting11_d1e28090"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/inetd reload</strong></span></pre>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-3" id="ftn.CHP-14-FN-3">136</a>]</sup> If you want to define more than one IP address for <strong class="userinput"><code>allowed_hosts</code></strong>, they are separated by a comma.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-4" id="ftn.CHP-14-FN-4">137</a>]</sup> The append mode only makes sense if the External Command File is replaced for debugging purposes with a simple file.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-5" id="ftn.CHP-14-FN-5">138</a>]</sup> <a class="ulink" href="http://en.wikipedia.org/wiki/L0KI97">http://en.wikipedia.org/wiki/L0KI97</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-6" id="ftn.CHP-14-FN-6">139</a>]</sup> Rijndael-128: <strong class="userinput"><code>14</code></strong>; Rijndael-192: <strong class="userinput"><code>15</code></strong>; Rijndael-256: <strong class="userinput"><code>16</code></strong></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="14.3 Client-side Configuration">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="client-side_configuration"/>14.3 Client-side Configuration</h1>
    </div>

    <p>The configuration file <strong class="userinput"><code>send_nsca.cfg</code></strong> on the client side must contain the same encryption parameters as the file on the Nagios server:<a class="indexterm" id="IDX-CHP-14-1112"/></p><a id="I_programlisting11_d1e28105"/>
    <pre class="programlisting">password=verysecret
decryption_method=10</pre>

    <p>Since the key is also written here in plain text, it should not be readable for just any user. For this reason it is best to create a user <strong class="userinput"><code>nagios</code></strong> and a group <strong class="userinput"><code>nagios</code></strong> on the client side:</p><a id="I_programlisting11_d1e28115"/>
    <pre class="programlisting">linux:~ # <span class="strong"><strong>groupadd -g 9000 nagios</strong></span>
linux:~ # <span class="strong"><strong>useradd -u 9000 -g nagios -d /usr/local/nagios</strong></span> \
<span class="strong"><strong>       -c "Nagios Admin" nagios</strong></span></pre>

    <p>You should now protect the file <strong class="userinput"><code>send_nsca.cfg</code></strong> so that only the user <strong class="userinput"><code>nagios</code></strong> can read it, and ensure, using the SUID mechanism, that the program <strong class="userinput"><code>send_nsca</code></strong> always runs under the user ID of this user. If you now grant execute permission to the group <strong class="userinput"><code>nagios</code></strong>, only its members may execute the NSCA client program:</p><a id="I_programlisting11_d1e28139"/>
    <pre class="programlisting">linux:~ # <span class="strong"><strong>chown nagios.nagios /etc/nagios/send_nsca.cfg</strong></span>
linux:~ # <span class="strong"><strong>chown nagios.nagios /usr/bin/send_nsca</strong></span>
linux:~ # <span class="strong"><strong>chmod 400 /etc/nagios/send_nsca.cfg</strong></span>
linux:~ # <span class="strong"><strong>chmod 4710 /usr/bin/send_nsca</strong></span>
linux:~ # <span class="strong"><strong>ls -l /usr/bin/send_nsca</strong></span>
-rws--x--- 1 nagios nagios 83187 Apr 2 17:56 /usr/local/bin/send_nsca</pre>
  </div>


  <div class="sect1" title="14.4 Sending Test Results to the Server">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="sending_test_results_to_the_server"/>14.4 Sending Test Results to the Server</h1>
    </div>

    <p>The client program <strong class="userinput"><code>send_nsca</code></strong> reads the details of a host or service check from the standard input, which the administrator must format as follows:<sup>[<a class="footnote" href="#ftn.CHP-14-FN-7" id="CHP-14-FN-7">140</a>]</sup><a class="indexterm" id="IDX-CHP-14-1113"/></p><a id="I_programlisting11_d1e28170"/>
    <pre class="programlisting"><span class="emphasis"><em>host-name\tservice\treturn value\toutput</em></span>
<span class="emphasis"><em>host-name\treturn value\toutput</em></span></pre>

    <p><strong class="userinput"><code>send_nsca</code></strong> sends this to the Nagios server. The first line describes the format for service checks and the second line, that for host checks. The placeholder <strong class="userinput"><code><em class="replaceable"><code>return value</code></em></code></strong> is replaced by the status determined, that is, <strong class="userinput"><code>0</code></strong> for OK, <strong class="userinput"><code>1</code></strong> for WARNING, <strong class="userinput"><code>2</code></strong> for CRITICAL, and <strong class="userinput"><code>3</code></strong> for UNKNOWN. By <strong class="userinput"><code><em class="replaceable"><code>output</code></em></code></strong>, a one-line text is meant, of the type that plugins provide as a support for the administrator. As the separator, a tab sign is used (<strong class="userinput"><code>\t</code></strong>).</p>

    <p>In order to make a complete command from this that can be understood by the external command, the NSCA daemon first prefixes the timestamp and the matching command (<strong class="userinput"><code>PROCESS_SERVICE_CHECK_RESULT</code></strong> or <strong class="userinput"><code>PROCESS. HOST_CHECK_RESULT</code></strong>). This is why only these two commands can be sent using NSCA.<a class="indexterm" id="IDX-CHP-14-1114"/></p>

    <p><strong class="userinput"><code>send_nsca</code></strong> itself has the following options:</p>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code>-H</code></strong> <strong class="userinput"><code><em class="replaceable"><code>address</code></em></code></strong></span></dt>

        <dd>
          <p>This is the host name or IP address of the Nagios server to be addressed by NSCA.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-d</code></strong> <strong class="userinput"><code><em class="replaceable"><code>delimiter</code></em></code></strong></span></dt>

        <dd>
          <p>This is the delimiter for the input; the default is a tab sign. The following example page uses the semicolon as a <span class="emphasis"><em>delimiter</em></span>.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-c</code></strong> <strong class="userinput"><code><em class="replaceable"><code>path/to_the/configuration_file</code></em></code></strong></span></dt>

        <dd>
          <p>This parameter specifies the path to the configuration file <strong class="userinput"><code>send_nsca.cfg</code></strong>. Since no path has been compiled into the client, <strong class="userinput"><code>send_nsca</code></strong> expects by default to find the file in the current directory. For this reason it makes sense to specify the absolute path with this option.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-p</code></strong> <strong class="userinput"><code><em class="replaceable"><code>port</code></em></code></strong></span></dt>

        <dd>
          <p>This defines an alternative port if the default, the TCP port 5667, is not used.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code>-to</code></strong> <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong></span></dt>

        <dd>
          <p>After <strong class="userinput"><code><em class="replaceable"><code>timeout</code></em></code></strong> seconds (by default, <strong class="userinput"><code>10</code></strong>) <strong class="userinput"><code>send_nsca</code></strong> aborts the connection attempt to the NSCA daemon, if no connection is established.</p>
        </dd>
      </dl>
    </div>

    <p>With simple test scripts such as the following one, the functionality of the NSCA can be tested. A service is chosen as the test object, which is in a state other than UNKNOWN (e.g., OK), in this case, <strong class="userinput"><code>nmbd</code></strong> on the host <strong class="userinput"><code>linux0l:</code></strong><a class="indexterm" id="IDX-CHP-14-1115"/></p><a id="I_programlisting11_d1e28306"/>
    <pre class="programlisting">#!/bin/bash
CFG="/etc/nagios/send_nsca.cfg"
CMD="linux01;nmbd;3;UNKNOWN - just one NSCA test"

/bin/echo $CMD | /usr/local/bin/send_nsca -H nagios -d ';' -c $CFG</pre>

    <p>The script puts it, from Nagios's point of view, into the UNKNOWN status. After it is run, you should discover if the transfer was successful:</p><a id="I_programlisting11_d1e28310"/>
    <pre class="programlisting">nagios@linux:~$ <span class="strong"><strong>bash./test_nsca</strong></span>
1 data packet(s) sent to host successfully.</pre>

    <p>As soon as Nagios processes the command and you have reloaded the page in your browser, the Web interface displays the UNKNOWN status for the selected service. With the next active check, the previous status will be recovered.</p>

    <p>Because it is so simple to send Nagios check results with <strong class="userinput"><code>send_nsca</code></strong>, it is essential that you protect the NSCA from misuse, as already demonstrated. On the client, you should restrict access to the client program <strong class="userinput"><code>send_nsca</code></strong> and to its configuration file and you should make sure that you have secure encryption, and on the server explicitly define the sender and IP addresses that are to be allowed.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-7" id="ftn.CHP-14-FN-7">140</a>]</sup> Normally you have to ensure that test scripts you have written yourself produce the correct output; if you use Nagios plugins, you must reformat their output accordingly. Since the latter can be run much better directly with NRPE, this should be the exception to the rule.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="14.5 Application Example I: Integrating syslog and Nagios">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="application_example_i_colon_integrating"/>14.5 Application Example I: Integrating syslog and Nagios</h1>
    </div>

    <p>Linux and Unix systems as a rule log system-relevant events through syslog. Sooner or later you will probably want Nagios to also inform the administrator of important syslog events. To do this, you require passive service checks, NSCA for transmitting the results to the Nagios server, and a method of filtering individual block entries.<a class="indexterm" id="IDX-CHP-14-1116"/><a class="indexterm" id="IDX-CHP-14-1117"/></p>

    <p>If you are using <strong class="userinput"><code>syslog-ng</code></strong><sup>[<a class="footnote" href="#ftn.CHP-14-FN-8" id="CHP-14-FN-8">141</a>]</sup> instead of the standard BSD syslog, you can make use of its ability to set filters and to format the output using templates. The use of NSCA compensates for the fact that the program cannot itself transmit data in encrypted form.</p>

    <p>This connection to Nagios is supplemented by programs to evaluate log files, such as <strong class="userinput"><code>logcheck</code></strong>,<sup>[<a class="footnote" href="#ftn.CHP-14-FN-9" id="CHP-14-FN-9">142</a>]</sup> which is contained in almost every Linux distribution, but it does not replace them. This is because Nagios can send individual e-mails for each event, but not for a summary of events, as <strong class="userinput"><code>logcheck</code></strong> does (usually once per hour). In addition to this, the Web interface always displays the last event in each case.<a class="indexterm" id="IDX-CHP-14-1118"/></p>

    <div class="sect2" title="14.5.1 Preparing syslog-ng for use with Nagios">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="preparing_syslog-ng_for_use_with_nagios"/>14.5.1 Preparing <strong class="userinput"><code>syslog-ng</code></strong> for use with Nagios</h2>
      </div>

      <p>Apart from the source code, the <strong class="userinput"><code>syslog-ng</code></strong> homepage<sup>[<a class="footnote" href="#ftn.CHP-14-FN-10" id="CHP-14-FN-10">143</a>]</sup> also provides a detailed manual, which is why we shall only discuss the basic principle at this point. The software differentiates between the <strong class="userinput"><code>source</code></strong>, <strong class="userinput"><code>filter</code></strong>, and <strong class="userinput"><code>destination</code></strong>. All three objects can be combined in any form; they are defined in the configuration file <strong class="userinput"><code>/etc/syslog-ng/syslog-ng.conf:</code></strong><a class="indexterm" id="IDX-CHP-14-1119"/><a class="indexterm" id="IDX-CHP-14-1120"/></p><a id="I_programlisting11_d1e28405"/>
      <pre class="programlisting"># /etc/syslog-ng/syslog-ng.conf
source local {
   unix-stream("/dev/log");
   internal();
   file("/proc/kmsg" log_prefix("kernel: "));
};

destination console_10 {
   file("/dev/tty10");
};

filter f_messages {
   not facility(auth, authpriv) and
   level(info.. alert);
};

log {
   source(local);
   filter(f_messages);
   destination(console_10);
};</pre>

      <p>This example defines three sources at the same time: <strong class="userinput"><code>unix-stream</code></strong> reads from the socket <strong class="userinput"><code>/dev/log</code></strong>, through which most programs send their messages to the syslog. <strong class="userinput"><code>internal</code></strong> is the name of the source <strong class="userinput"><code>syslog-ng</code></strong> feeds with internal messages, and from the file <strong class="userinput"><code>/proc/kmsg</code></strong> syslog receives <strong class="userinput"><code>kernel</code></strong> messages. These are given the <strong class="userinput"><code>kernel:</code></strong> prefix, so that they can be be distinguished from normal log entries.</p>

      <p>The <strong class="userinput"><code>destination</code></strong> definition ensures that all syslog output appears on the console <strong class="userinput"><code>ttyl0</code></strong> (this can be displayed with <span class="inlinemediaobject"><a id="I_inlinemediaobject11_d1e28439"/><img alt="14.5.1 Preparing syslog-ng for use with Nagios" src="../Images/tagoreillycom20081104nostarchimages223832.png"/></span>-<span class="inlinemediaobject"><a id="I_inlinemediaobject11_d1e28445"/><img alt="14.5.1 Preparing syslog-ng for use with Nagios" src="../Images/tagoreillycom20081104nostarchimages223834.png"/></span>).</p>

      <p><strong class="userinput"><code>filter</code></strong> defines what messages should reach this destination, if any. In the case of the <strong class="userinput"><code>f_messages</code></strong> filter, this is all messages matching the category (the <strong class="userinput"><code>level</code></strong>) <strong class="userinput"><code>info</code></strong> and that syslog does not provide with the stamp (the <strong class="userinput"><code>facility</code></strong>; see <strong class="userinput"><code>man syslog.conf</code></strong> and <strong class="userinput"><code>man 3 syslog</code></strong>) <strong class="userinput"><code>auth</code></strong> or <strong class="userinput"><code>authpriv</code></strong>. Alternatively <strong class="userinput"><code>syslog-ng</code></strong> filters according to a search pattern, with the instruction <strong class="userinput"><code>match</code></strong> (<strong class="userinput"><code>"<em class="replaceable"><code>pattern</code></em>"</code></strong>), according to the program doing the logging (<strong class="userinput"><code>program</code></strong>(<strong class="userinput"><code>"<em class="replaceable"><code>program name</code></em>"</code></strong>)) and according to the source host (<strong class="userinput"><code>host</code></strong> (<strong class="userinput"><code>"<em class="replaceable"><code>hostname</code></em>"</code></strong>)).</p>

      <p>Finally the keyword <strong class="userinput"><code>log</code></strong> links the source, filter, and destination. Multiple specifications are possible here, so several sources and destinations can be specified in a single statement:</p><a id="I_programlisting11_d1e28516"/>
      <pre class="programlisting">log {
   source1); <span class="emphasis"><em>source2</em></span>;...
<span class="emphasis"><em>   filter1; filter2</em></span>;...
<span class="emphasis"><em>   destination1</em></span>; <span class="emphasis"><em>destination2</em></span>;...
}</pre>

      <p>If you specify several filters in a <strong class="userinput"><code>log</code></strong> statement, <strong class="userinput"><code>syslog-ng</code></strong> only allows data through that matches all filter criteria (AND link).</p>

      <p>To integrate this into Nagios, use is made of the option of defining a program as a target, which is called for every event:</p><a id="I_programlisting11_d1e28540"/>
      <pre class="programlisting">destination d_nagios_warn {
   program("/usr/local/nagios/misc/send_syslog.sh"
   template("$HOST;syslog-ng;1;WARNING: $MSG\n") template_escape(no));
};

destination d_nagios_crit {
   program("/usr/local/nagios/misc/send_syslog.sh"
   template("$HOST;syslog-ng;2;CRITICAL: $MSG\n") template_escape(no));
};</pre>

      <p>The <strong class="userinput"><code>template</code></strong> directive formats the output so that it is suitable for <strong class="userinput"><code>send_nsca</code></strong>, using a semicolon as the delimiter: host and service names (<strong class="userinput"><code>syslog-ng</code></strong>) are followed by the state (<strong class="userinput"><code>1</code></strong> = WARNING; <strong class="userinput"><code>2</code></strong> = CRITICAL), and then the actual output text is given. Apart from <strong class="userinput"><code>$H0ST</code></strong> and <strong class="userinput"><code>$MSG</code></strong>, <strong class="userinput"><code>syslog-ng</code></strong> has a series of further macros, which are described individually in the documentation on the homepage. The parameter <strong class="userinput"><code>template_escape</code></strong> protects quotation marks in the text and is intended principally for SQL commands, so in this case it can be set to <strong class="userinput"><code>no</code></strong>.</p>

      <p>The following script <strong class="userinput"><code>send_syslog.sh</code></strong> uses the bash function <strong class="userinput"><code>read</code></strong> to read from the standard input line by line, and for each line read it calls up <strong class="userinput"><code>send_nsca</code></strong>, which sends on the data—as described in this chapter—as a passive test result to Nagios:</p><a id="I_programlisting11_d1e28587"/>
      <pre class="programlisting">#!/bin/bash
while read -r line; do
    echo $line | /usr/bin/send_nsca -H nagsrv -d ';' \
              -c /etc/nagios/send_nsca.cfg \
               1&gt;/usr/local/nagios/var/send_syslog.log 2&gt;&amp;1
done</pre>

      <p>Because a semicolon is used as a delimiter, we specify this explicitly with the option <strong class="userinput"><code>-d</code></strong>. The status report that each <strong class="userinput"><code>send_nsca</code></strong> command displays on the standard output is diverted by the script into a separate log file (<strong class="userinput"><code>/usr/local/nagios/var/send_syslog.log</code></strong>).</p>

      <p>Thanks to the <strong class="userinput"><code>program</code></strong> instruction in the syslog configuration, <strong class="userinput"><code>syslog-ng</code></strong> starts the script automatically. This is also the reason that the <strong class="userinput"><code>send_nsca</code></strong> command is in an endless loop: this means that <strong class="userinput"><code>syslog-ng</code></strong> does not run an external program every time there is a relevant event.</p>
    </div>

    <div class="sect2" title="14.5.2 Nagios configuration: volatile services">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="nagios_configuration_colon_volatile_se"/>14.5.2 Nagios configuration: volatile services</h2>
      </div>

      <p>In Nagios slang, "volatile" refers to services that show an error state only once. This refers to devices, for example, that automatically reset the state when an error is queried—which means that the error cannot be reproduced. The same applies for syslog entries: if a check following an error state returns an error, this will always be a second event. So we don't have a continuing error state here, but a problem that has again occurred.<a class="indexterm" id="IDX-CHP-14-1122"/><a class="indexterm" id="IDX-CHP-14-1121"/></p>

      <p>For continuing error states, Nagios normally does not send any further messages for the time being. With the <strong class="userinput"><code>is_volatile</code></strong> parameter, however, it treats every error as if it had just occurred. Nagios logs the state, sends a notification, and implements the event handler—provided it is defined—(see <a class="xref" href="../Text/apc.html" title="Appendix C. Event Handlers">Appendix C</a> from page 619).<a class="indexterm" id="IDX-CHP-14-1123"/></p>

      <p>For <strong class="userinput"><code>syslog-ng</code></strong>, this means that each entry is seen as an independent event. In order that Nagios sees things in this way as well, the corresponding service definition contains the <strong class="userinput"><code>is_volatile</code></strong> parameter:</p><a id="I_programlisting11_d1e28645"/>
      <pre class="programlisting">define service{
    host_name               linux01
    service_description     syslog-ng
 <span class="strong"><strong>   active_checks_enabled   0</strong></span>
 <span class="strong"><strong>   passive_checks_enabled  1</strong></span>
 <span class="strong"><strong>   check_freshness         0</strong></span>
 <span class="strong"><strong>   is_volatile             1</strong></span>
 <span class="strong"><strong>   max_check_attempts      1</strong></span>
    normal_check_interval   1
    retry_check_interval    1
    check_command           check_dummy!3!active check
    check_period            none
    contact_groups          localadmins
    notification_options    w,c,u
    notification_interval   480
    notification_period     24x7
}</pre>

      <p>Since the Nagios server should not test anything on its own, <strong class="userinput"><code>active_checks_enabled 0</code></strong> switches off active service checks. However, <span class="emphasis"><em>freshness checking</em></span> (see <a class="xref" href="../Text/ch13s04.html" title="13.4 Reacting to Out-of-Date Information of Passive Checks">13.4 Reacting to Out-of-Date Information of Passive Checks</a> from page 295) can always cause Nagios to perform active tests. To prevent this, we set the <strong class="userinput"><code>check_freshness</code></strong> parameter in this case explicitly to <strong class="userinput"><code>0</code></strong>.<a class="indexterm" id="IDX-CHP-14-1124"/></p>

      <p>This service definition does not really require the parameters <strong class="userinput"><code>check_command</code></strong> and <strong class="userinput"><code>check_period</code></strong>, but since these are mandatory parameters, they must still be specified: as <strong class="userinput"><code>check_command</code></strong>, the plugin <strong class="userinput"><code>check_dummy</code></strong> (see <a class="xref" href="../Text/ch08.html#the_dummy_plugin_for_tests" title="8.1 The Dummy Plugin for Tests">8.1 The Dummy Plugin for Tests</a> in page 188) is used.</p>

      <p>It is also important that <strong class="userinput"><code>max_check_attempts</code></strong> is set to <strong class="userinput"><code>1</code></strong>, so that a transmitted error state immediately triggers a hard state. With a value larger than <strong class="userinput"><code>1</code></strong>, Nagios would wait for further error results here before categorizing the problem state as a hard state.</p>

      <p>The <strong class="userinput"><code>notification_options</code></strong> parameter ensures that the system informs the specified contact group of all error states (WARNING, CRITICAL, and UNKNOWN). The <strong class="userinput"><code>notification_interval</code></strong>, which defines the interval between two notifications for a continuing error state, is actually superfluous, since Nagios, thanks to <strong class="userinput"><code>is_volatile 1</code></strong>, provides notification of every event immediately, irrespective of what the previous state looked like. But since it is a mandatory parameter, <strong class="userinput"><code>notification_interval</code></strong> still has to be specified.</p>
    </div>

    <div class="sect2" title="14.5.3 Resetting error states manually">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="resetting_error_states_manually"/>14.5.3 Resetting error states manually</h2>
      </div>

      <p>Events that are taken into account by the syslog filter always inform you of only one current state, which is why the syslog service in Nagios never displays an OK state on its own (<a class="xref" href="../Text/ch14s05.html#the_syslog-ng_service_in_an_error_state" title="Figure 14-2. The syslog-ng service in an error state">Figure 14-2</a>).<a class="indexterm" id="IDX-CHP-14-1125"/></p>

      <div class="figure">
        <a id="the_syslog-ng_service_in_an_error_state"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject11_d1e28739"/><img alt="The syslog-ng service in an error state" src="../Images/tagoreillycom20081104nostarchimages223836.png.jpg"/></div>

        <p class="title">Figure 14-2. The <code class="userinput">syslog-ng</code> service in an error state</p>
      </div>

      <p>This problem can be solved with the Web interface, which allows a passive check result to be generated manually.<a class="indexterm" id="IDX-CHP-14-1126"/><a class="indexterm" id="IDX-CHP-14-1127"/></p>

      <p>If you click on the service name in <a class="xref" href="../Text/ch14s05.html#the_syslog-ng_service_in_an_error_state" title="Figure 14-2. The syslog-ng service in an error state">Figure 14-2</a>, the extended status information will be shown (<a class="xref" href="../Text/ch14s05.html#the_arrow_points_to_the_possibility_of" title="Figure 14-3. The arrow points to the possibility of &quot;generating&quot; a passive test result for the syslog-ng service">Figure 14-3</a>). There you will find the entry <strong class="userinput"><code>Submit passive check result for this service</code></strong>, with which a test result can be sent manually (<a class="xref" href="../Text/ch14s05.html#creating_a_passive_check_result_sysl" title="Figure 14-4. Creating a passive check result syslog-ng">Figure 14-4</a>). In this way the <strong class="userinput"><code>syslog-ng</code></strong> service can be reset to its normal state. Since the Web interface always shows only the most recent error state, but not individual error messages, you must look through the e-mail messages to see whether other errors have occurred apart from those errors displayed by Nagios in the Web interface.</p>

      <div class="figure">
        <a id="the_arrow_points_to_the_possibility_of"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject11_d1e28776"/><img alt="The arrow points to the possibility of &quot;generating&quot; a passive test result for the syslog-ng service" src="../Images/tagoreillycom20081104nostarchimages223838.png.jpg"/></div>

        <p class="title">Figure 14-3. The arrow points to the possibility of "generating" a passive test result for the <code class="userinput">syslog-ng</code> service</p>
      </div>

      <p>You can also define your own service for each syslog event, of course. This may sometimes be quite time-consuming, but it does allow you to separate various messages and their processing states in the Web interface. If the filter in <strong class="userinput"><code>syslog-ng</code></strong> is restricted so that a syslog service object always refers to just one resource to be monitored, you can also leave out the <strong class="userinput"><code>is_volatile</code></strong> parameter.<a class="indexterm" id="IDX-CHP-14-1128"/></p>

      <div class="figure">
        <a id="creating_a_passive_check_result_sysl"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject11_d1e28797"/><img alt="Creating a passive check result syslog-ng" src="../Images/tagoreillycom20081104nostarchimages223840.png.jpg"/></div>

        <p class="title">Figure 14-4. Creating a passive check result <code class="userinput">syslog-ng</code></p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-8" id="ftn.CHP-14-FN-8">141</a>]</sup> The "ng" stands here for <span class="emphasis"><em>next generation</em></span>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-9" id="ftn.CHP-14-FN-9">142</a>]</sup> <a class="ulink" href="http://sourceforge.net/projects/logcheck/">http://sourceforge.net/projects/logcheck/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-10" id="ftn.CHP-14-FN-10">143</a>]</sup> <a class="ulink" href="http://www.balabit.com/products/syslog_ng/">http://www.balabit.com/products/syslog_ng/</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="14.6 Application Example II: Processing SNMP Traps">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="application_example_ii_colon_processing"/>14.6 Application Example II: Processing SNMP Traps</h1>
    </div>

    <p>Asynchronous messages that are sent by an SNMP agent (see <a class="xref" href="../Text/ch11.html#introduction_to_snmp" title="11.1 Introduction to SNMP">11.1 Introduction to SNMP</a> from page 228) to a central management unit, called <span class="emphasis"><em>traps</em></span> in SNMP jargon, can be processed by Nagios in a way similar to the Nagios Service Check Acceptor (NSCA). In addition, it allows SNMP traps to be accepted on a host other than the Nagios server itself.<a class="indexterm" id="IDX-CHP-14-1129"/><a class="indexterm" id="IDX-CHP-14-1130"/><a class="indexterm" id="IDX-CHP-14-1131"/></p>

    <p>Processing SNMP traps with Nagios is particularly worthwhile if the system monitors the network almost completely, and only a few devices or services restrict their communication just to SNMP and SNMP traps. Nagios, or the Open Source tool OpenNMS,<sup>[<a class="footnote" href="#ftn.CHP-14-FN-11" id="CHP-14-FN-11">144</a>]</sup> are no substitutes for real commercial SNMP management systems.<a class="indexterm" id="IDX-CHP-14-1132"/></p>

    <p>In many cases, SNMP traps are vendor-specific, so that you cannot avoid getting to grips with the appropriate documentation and the vendor-specific MIB (<span class="emphasis"><em>Management Information Base</em></span>; see <a class="xref" href="../Text/ch11.html#the_management_information_base" title="11.1.1 The Management Information Base">11.1.1 The Management Information Base</a> from page 229).</p>

    <div class="sect2" title="14.6.1 Receiving traps with snmptrapd">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="receiving_traps_with_snmptrapd"/>14.6.1 Receiving traps with <strong class="userinput"><code>snmptrapd</code></strong></h2>
      </div>

      <p>In order to receive SNMP traps, you require a special Unix/Linux daemon that generates messages for Nagios from them. The software package NET-SNMP, described in <a class="xref" href="../Text/ch11s02.html#the_net-snmp_daemon" title="11.2.2 The NET-SNMP daemon">11.2.2 The NET-SNMP daemon</a> from page 238, includes the daemon <strong class="userinput"><code>snmptrapd</code></strong>.<a class="indexterm" id="IDX-CHP-14-1134"/><a class="indexterm" id="IDX-CHP-14-1133"/><a class="indexterm" id="IDX-CHP-14-1135"/></p>

      <p>In the following scenario, <strong class="userinput"><code>snmptrapd</code></strong> is installed on a third host (neither the computer generating the trap, nor the Nagios server). It evaluates the information received by means of a script and forwards it with NSCA to the Nagios server.<sup>[<a class="footnote" href="#ftn.CHP-14-FN-12" id="CHP-14-FN-12">145</a>]</sup></p>

      <p>In the <strong class="userinput"><code>snmptrapd</code></strong> configuration file <strong class="userinput"><code>/etc/snmp/snmptrapd.conf</code></strong>, each trap type is given a separate entry, the syntax of which corresponds to one of the following lines:<a class="indexterm" id="IDX-CHP-14-1136"/></p><a id="I_programlisting11_d1e28888"/>
      <pre class="programlisting">traphandle <span class="emphasis"><em>oid program</em></span>
traphandle <span class="emphasis"><em>oid program arguments</em></span>
traphandle default <span class="emphasis"><em>program</em></span>
traphandle default <span class="emphasis"><em>program arguments</em></span></pre>

      <p>The keyword <strong class="userinput"><code>traphandle</code></strong> is followed either by the object identifier of the desired trap, or by the keyword <strong class="userinput"><code>default</code></strong>. In the second case the entry applies to all traps that do not have their own configuration entry. Finally the program that should run if a relevant trap arrives is specified.</p>

      <p>In addition you can also include arguments used with this program. But you must be a bit careful when doing this. Quotation marks are passed on by <strong class="userinput"><code>snmptrapd</code></strong> as characters and spaces are always used as delimiters. This means that you cannot pass on any arguments containing spaces, which you should bear in mind when assigning name services in Nagios.</p>

      <p><strong class="userinput"><code>snmpdtrapd</code></strong> gives this program information via the standard output in the following format:</p><a id="I_programlisting11_d1e28918"/>
      <pre class="programlisting"><span class="emphasis"><em>hostname</em></span>
<span class="emphasis"><em>ip-address</em></span>
<span class="emphasis"><em>oid value</em></span>
...</pre>

      <p>The first line contains the <span class="emphasis"><em>fully qualified domain name</em></span> of the host that sends the message and the second, its IP address. Then one or more OID-value pairs are given, each on a separate line. A particular event is very often linked to a unique OID-value pair, so that the program can often omit the evaluation of the OID-value pair entirely.</p>

      <p>In the following <strong class="userinput"><code>snmptrapd.conf</code></strong> example, the lines are wrapped for readability Each <strong class="userinput"><code>traphandle</code></strong> instruction <span class="emphasis"><em>must</em></span> be entered on a single line:</p><a id="I_programlisting11_d1e28945"/>
      <pre class="programlisting"># snmptrapd.conf
traphandle SNMPv2-MIB::coldStart /usr/local/nagios/libexec/eventhandler/
handle-trap SNMP cold-start
traphandle NET-SNMP-AGENT-MIB::nsNotifyRestart /usr/local/nagios/libexec
/eventhandler/handle-trap SNMP restart
traphandle NET-SNMP-AGENT-MIB::nsNotifyShutdown /usr/local/nagios/libexe
c/eventhandler/handle-trap SNMP shutdown
traphandle default /usr/local/nagios/libexec/eventhandler/handle-trap SN
MP unknown</pre>

      <p>The traps used here are sent by the SNMP agent <strong class="userinput"><code>snmpd</code></strong> from the NET-SNMP package by default, as long as a destination was specified in <strong class="userinput"><code>snmpd.conf:</code></strong><a class="indexterm" id="IDX-CHP-14-1137"/></p><a id="I_programlisting11_d1e28957"/>
      <pre class="programlisting"># snmpd.conf
trapsink <span class="emphasis"><em>name_or_ip_of_the_nagios-server</em></span></pre>

      <p>If a trap arrives with the OID <strong class="userinput"><code>SNMPv2-MIB::coldStart</code></strong>, for example, <strong class="userinput"><code>snmptrapd</code></strong> starts the script <strong class="userinput"><code>handle-trap</code></strong> with the argument <strong class="userinput"><code>cold-start</code></strong>. In this way it does not have to search first for the necessary information from the OID-value pairs. However, this shortcut only works with trap OID names that describe their function.</p>
    </div>

    <div class="sect2" title="14.6.2 Passing on traps to NSCA">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="passing_on_traps_to_nsca"/>14.6.2 Passing on traps to NSCA</h2>
      </div>

      <p>The script <strong class="userinput"><code>handle-trap</code></strong>, which is run by <strong class="userinput"><code>snmptrapd</code></strong>, breaks down the information passed on and hands it over, correctly formatted, to <strong class="userinput"><code>send_nsca:</code></strong></p><a id="I_programlisting11_d1e28988"/>
      <pre class="programlisting">#!/bin/bash

NAGIOS="nagsrv"
LOGFILE="/usr/local/nagios/var/handle-trap.log"

read HOST &amp;&amp; echo "host: $HOST" &gt;&gt; $LOGFILE
read IPADDR &amp;&amp; echo "ip: $IPADDR" &gt;&gt; $LOGFILE

case $IPADDR in
   192.168.201.4)
      HOSTNAME="irouter"
   ;;
   *)
      # silent discard from unknown hosts
      exit 0
   ;;
esac

if [ -z "$1" ]; then
   echo "usage: $0 &lt;service&gt; &lt;key&gt;"
   echo "usage: $0 &lt;service&gt; &lt;key&gt;" &gt;&gt; $LOGFILE
   exit 1
else
   SERVICE="$1"
fi

if [ ! -z "$2" ]; then
   SWITCH="$2"
fi


case $SWITCH in
   "cold-start")
      OUTPUT="snmpd: Cold Start"
      STATE=0
   restart)
      OUTPUT="snmpd: Restart"
      STATE=1
      ;;
   shutdown)
      OUTPUT="snmpd: Shutdown"
      STATE=2
      ;;
   *)
      OUTPUT="Unknown Trap"
      STATE=1
      ;;
esac

CMD="$HOSTNAME;$SERVICE;$STATE;$OUTPUT"

echo "$CMD" &gt;&gt; $LOGFILE

echo "$CMD" | /usr/bin/send_nsca -H $NAGIOS -d ';' \
              -c /etc/nagios/send_nsca.cfg &gt;&gt; $LOGFILE 2&gt;&amp;1</pre>

      <p>First it saves the log file and the name of the Nagios server <strong class="userinput"><code>nagsrv</code></strong>, each in a separate variable. The first <strong class="userinput"><code>case</code></strong> statement specifies the host name used by Nagios for the IP address passed on (and temporarily stored in <strong class="userinput"><code>IPADDR</code></strong>). <strong class="userinput"><code>HOST</code></strong> normally contains the fully qualified domain name, which also cannot be used directly, and sometimes also just contains one IP address, so that it is better to use the latter here. The explicit test also allows it to discard traps from undesired hosts. Finally, matching traps land without further authentication on the Nagios server.<sup>[<a class="footnote" href="#ftn.CHP-14-FN-13" id="CHP-14-FN-13">146</a>]</sup></p>

      <p>The following <strong class="userinput"><code>if</code></strong> statement determines whether a service name was also given to the script. If this is the case, then it is saved in the <strong class="userinput"><code>SERVICE</code></strong> variable. If there was a second argument, the procedure is similar. Depending on the value, the next <strong class="userinput"><code>case $SWITCH</code></strong> instruction defines the output text and the desired status for Nagios.</p>

      <p>The command for NSCA is finally assembled and the <strong class="userinput"><code>CMD</code></strong> variable is passed on by the script to <strong class="userinput"><code>send_nsca</code></strong>. As in previous examples, a semicolon is used as the delimiter, which must be specified in <strong class="userinput"><code>send_nsca</code></strong> with the option <strong class="userinput"><code>-d</code></strong>.</p>
    </div>

    <div class="sect2" title="14.6.3 The matching service definition">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="the_matching_service_definition"/>14.6.3 The matching service definition</h2>
      </div>

      <p>As in the <strong class="userinput"><code>syslog-ng</code></strong> example (<a class="xref" href="../Text/ch14s05.html#preparing_syslog-ng_for_use_with_nagios" title="14.5.1 Preparing syslog-ng for use with Nagios">14.5.1 Preparing syslog-ng for use with Nagios</a>), we again define the service on the Nagios server as a purely passive one:<a class="indexterm" id="IDX-CHP-14-1138"/><a class="indexterm" id="IDX-CHP-14-1139"/></p><a id="I_programlisting11_d1e29050"/>
      <pre class="programlisting">define service{
    host_name                    irouter
    service_description          SNMP
 <span class="strong"><strong>active_checks_enabled  0</strong></span>
 <span class="strong"><strong>passive_checks_enabled 1</strong></span>
 <span class="strong"><strong>check_freshness        0</strong></span>
 <span class="strong"><strong>max_check_attempts     1</strong></span>
    is_volatile                   1
   ...
}</pre>

      <p>Since soft states do not make any sense in a single trap message, we should set <strong class="userinput"><code>max_check_attempts</code></strong> back to <strong class="userinput"><code>1</code></strong>. Whether the parameter <strong class="userinput"><code>is_volatile</code></strong> is used or not depends on the purpose to which the service is put. As long as you define a separate service for each error category, there is no problem in omitting <strong class="userinput"><code>is_volatile</code></strong>. But if you form different error categories using a single service, you should <strong class="userinput"><code>set is_volatile 1</code></strong>, because in this case the previous error will seldom have anything to do with the new one. <a class="xref" href="../Text/ch14s05.html#nagios_configuration_colon_volatile_se" title="14.5.2 Nagios configuration: volatile services">14.5.2 Nagios configuration: volatile services</a> in page 309 is devoted to the subject of volatile services.<a class="indexterm" id="IDX-CHP-14-1140"/></p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-11" id="ftn.CHP-14-FN-11">144</a>]</sup> <a class="ulink" href="http://www.opennms.org/">http://www.opennms.org/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-12" id="ftn.CHP-14-FN-12">145</a>]</sup> If you install the <strong class="userinput"><code>snmptrapd</code></strong> on the Nagios server itself, you do not need NSCA and you can send a correspondingly formatted command, as described in <a class="xref" href="../Text/ch13s02.html" title="13.2 Passive Service Checks">13.2 Passive Service Checks</a> from page 293 directly to the interface for external commands.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-14-FN-13" id="ftn.CHP-14-FN-13">146</a>]</sup> Although SNMPv3 does provide authentication for SNMP traps, this would go beyond the scope of this book.</p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;15.&#xA0;Distributed Monitoring">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="distributed_monitoring"/>Chapter 15. Distributed Monitoring</h1>
    </div>

    <p>Passive service and host checks can be used to create a scenario in which several noncentral Nagios instances send their results to a central server. In general they transfer their results using the Nagios Service Check Acceptor (see <a class="xref" href="../Text/ch14.html" title="Chapter 14. The Nagios Service Check Acceptor (NSCA)">Chapter 14</a>); the central Nagios instance receives them through the External Command File interface and continues processing them as passive checks (see <a class="xref" href="../Text/ch13.html" title="Chapter 13. Passive Tests with the External Command File">Chapter 13</a> from page 291).</p>

    <p>What is now missing is the mechanism that prepares each test result of a noncentral Nagios instance to be sent with NSCA. For such cases, Nagios provides the commands OCSP ("Obsessive Compulsive Service Processor") and OCHP ("Obsessive Compulsive Host Processor"), two commands designed specifically for distributed monitoring. In contrast to <span class="emphasis"><em>event handler</em></span> (see <a class="xref" href="../Text/apc.html" title="Appendix C. Event Handlers">Appendix C</a> from page 619), which shows changes in status and only passes on check results if the status has changed, these two commands obsessively pass on every test result (<a class="xref" href="../Text/ch15.html#distributed_monitoring_with_nagios" title="Figure 15-1. Distributed monitoring with Nagios">Figure 15-1</a>).<a class="indexterm" id="IDX-CHP-15-1141"/><a class="indexterm" id="IDX-CHP-15-1142"/><a class="indexterm" id="IDX-CHP-15-1143"/></p>

    <div class="figure">
      <a id="distributed_monitoring_with_nagios"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject12_d1e29117"/><img alt="Distributed monitoring with Nagios" src="../Images/tagoreillycom20081104nostarchimages223842.png"/></div>

      <p class="title">Figure 15-1. Distributed monitoring with Nagios</p>
    </div>

    <div class="sect1" title="15.1 Switching On the OCSP/OCHP Mechanism">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="switching_on_the_ocsp_solidus_ochp_mec"/>15.1 Switching On the OCSP/OCHP Mechanism</h1>
      </div>

      <p>In order to use OCSP/OCHP, several steps are necessary. The mechanism is initially switched on (only) on the noncentral Nagios servers in the global configuration file <strong class="userinput"><code>/etc/nagios/nagios.cfg</code></strong>, where a global command for hosts (OCHP) and services (OCSP) is defined. This causes the noncentral Nagios instance to send every result to the central server.<a class="indexterm" id="IDX-CHP-15-1144"/></p>

      <p>In the service and host definitions you can additionally set whether the corresponding service or host should use the mechanism or not. For the central Nagios server to be able to use the results transferred, each service or host on it must finally be defined once again.</p>

      <p>You should only switch on the two parameters <strong class="userinput"><code>obsess_over_services</code></strong> and <strong class="userinput"><code>obsess_over_hosts</code></strong> in <strong class="userinput"><code>nagios.cfg</code></strong> if you really do want distributed monitoring:<a class="indexterm" id="IDX-CHP-15-1145"/><a class="indexterm" id="IDX-CHP-15-1146"/></p><a id="I_programlisting12_d1e29154"/>
      <pre class="programlisting"># /etc/nagios/nagios.cfg
...
obsess_over_services=1
ocsp_command=submit_service_check
ocsp_timeout=5
obsess_over_hosts=1
ochp_command=submit_host_check
ochp_timeout=5</pre>

      <p>Every time a new test result arrives on the Nagios server, it calls the command object defined with <strong class="userinput"><code>ocsp_command</code></strong> or <strong class="userinput"><code>ochp_command</code></strong>. This causes an additional load on resources.<a class="indexterm" id="IDX-CHP-15-1147"/><a class="indexterm" id="IDX-CHP-15-1148"/><a class="indexterm" id="IDX-CHP-15-1149"/><a class="indexterm" id="IDX-CHP-15-1150"/></p>

      <p>The two timeouts prevent Nagios from spending too much time on one command. If processing does not terminate (because the command itself does not receive a timeout and the central Nagios server does not react), then the process table of the noncentral Nagios instance would fill very quickly, and might overflow.</p>

      <p>If you want to selectively exclude test results for specific services and hosts from transmission to the central Nagios server, the following parameters are used:</p><a id="I_programlisting12_d1e29180"/>
      <pre class="programlisting">define host{
  ...
   obsess_over_hosts=0
  ...
}

define service{
  ...
   obsess_over_services=0
  ...
}</pre>

      <p>With a value of <strong class="userinput"><code>1</code></strong> the local Nagios instance sends the results of the host or service check to the central server, but with a value of <strong class="userinput"><code>0</code></strong>, this does not happen. The <strong class="userinput"><code>1</code></strong> is the default for both <strong class="userinput"><code>obsess_over_hosts</code></strong> and <strong class="userinput"><code>obsess_over_services</code></strong>; if results are <span class="emphasis"><em>not</em></span> to be transferred, then you have to specify the two parameters. This is always recommended if the central location is only responsible for particular things, and the remaining administration is carried out on site.<a class="indexterm" id="IDX-CHP-15-1151"/><a class="indexterm" id="IDX-CHP-15-1152"/></p>
    </div>
  </div>


  <div class="sect1" title="15.2 Defining OCSP/OCHP Commands">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="defining_ocsp_solidus_ochp_commands"/>15.2 Defining OCSP/OCHP Commands</h1>
    </div>

    <p>Defining the two commands with which the noncentral instances send their results to the Nagios main server in most cases involves scripts that are based on <strong class="userinput"><code>send_nsca</code></strong> (see also the example in <a class="xref" href="../Text/ch14s04.html" title="14.4 Sending Test Results to the Server">14.4 Sending Test Results to the Server</a>). For services, such a script would look like the following one, in this case called <strong class="userinput"><code>submit_service_check:</code></strong><a class="indexterm" id="IDX-CHP-15-1153"/></p><a id="I_programlisting12_d1e29224"/>
    <pre class="programlisting">#!/bin/bash
# Script submit_service_check

PRINTF="/usr/bin/printf"
CMD="/usr/local/bin/send_nsca"
CFG="/etc/nagios/send_nsca.cfg"
HOST=$1
SRV=$2
RESULT=$3
OUTPUT=$4

$PRINTF "%b" "$HOST\t$SRV\t$RESULT\t$OUTPUT\n" | $CMD -H nagios -c $CFG</pre>

    <p>When run, the command expects four parameters on the command line in the correct order: the host monitored, the service name, the return value for the plugin opened (<strong class="userinput"><code>0</code></strong> for OK, <strong class="userinput"><code>1</code></strong> for WARNING, etc.), and the one-line info text that is issued by the plugin. To format the data we use the <strong class="userinput"><code>printf</code></strong> function (<strong class="userinput"><code>man printf</code></strong>). The newly formatted string is finally passed on to <strong class="userinput"><code>send_nsca</code></strong>.</p>

    <p>The equivalent script for OCHP (stored here in the file <strong class="userinput"><code>submit_host_check</code></strong>) looks something like this:</p><a id="I_programlisting12_d1e29248"/>
    <pre class="programlisting">#!/bin/bash
# Script submit_host_check

PRINTF="/usr/bin/printf"
CMD="/usr/local/bin/send_nsca"
CFG="/etc/nagios/send_nsca.cfg"
HOST=$1
RESULT=$2
OUTPUT=$3

$PRINTF "%b" "$HOST\t$RESULT\t$OUTPUT\n" | $CMD -H nagios -c $CFG</pre>

    <p>The only thing missing is the specification of the service description.</p>

    <p>It is best to store the two scripts, in conformity with the Nagios documentation, in a subdirectory <strong class="userinput"><code>eventhandlers</code></strong> (which normally needs to be created) in the plugin directory (usually <strong class="userinput"><code>/usr/local/nagios/libexec</code></strong>, but for some distributions this will be <strong class="userinput"><code>/usr/lib/nagios/plugins</code></strong>). You can retrieve this from the definition of the matching command object using the macro <strong class="userinput"><code>$USER1$</code></strong>. This is best defined in the <strong class="userinput"><code>misccommands.cfg file:</code></strong><a class="indexterm" id="IDX-CHP-15-1154"/></p><a id="I_programlisting12_d1e29271"/>
    <pre class="programlisting">define command{
    command_name submit_service_check
    command_line <span class="strong"><strong>$USER1$/eventhandlers/submit_service_check</strong></span> $HOSTNAME$ '$
 SERVICEDESC$' $SERVICESTATEID$ '$SERVICEOUTPUT$'

define command{
   command_name submit_host_check
   command_line <span class="strong"><strong>$USER1$/eventhandlers/submit_host_check</strong></span> $HOSTNAME$ $HO STSTATEID$
 '$HOSTOUTPUT$'</pre>

    <p>If you use a separate file for this, you must make sure that Nagios will load this file by adding an entry to <strong class="userinput"><code>/etc/nagios/nagios.cfg</code></strong>. The single quotes surrounding the <strong class="userinput"><code>$SERVICEDESC$</code></strong> macro and the two output macros in the <strong class="userinput"><code>command_line</code></strong> line are important. Their values sometimes contain empty spaces, which the command line would interpret as delimiters without the quotes.</p>
  </div>


  <div class="sect1" title="15.3 Practical Scenarios">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="practical_scenarios"/>15.3 Practical Scenarios</h1>
    </div>

    <p>One application for distributed monitoring is the monitoring of branches or external offices in which a noncentral Nagios installation is limited to running service and host checks and sending the results to the central instance. The noncentral instances do not need further Nagios functions, such as the notification system or the Web interface.<a class="indexterm" id="IDX-CHP-15-1155"/></p>

    <p>On the other hand, if administrators look after the networks at the distributed locations, while the central IT department only looks after special services, then the noncentral Nagios server is set up as a normal, full-fledged installation and selectively forwards only those check results over the OCSP/OCHP mechanism to the central office for which the specialists there are responsible.</p>

    <p>Whatever the case, you must ensure that the host and service definition is available both noncentrally and centrally. This can be done quite simply using templates (<a class="xref" href="../Text/ch02s11.html" title="2.11 Templates">2.11 Templates</a> in page 75) and the <strong class="userinput"><code>cfg_dir</code></strong> directive (<a class="xref" href="../Text/ch02.html#the_main_configuration_file_nagios.cfg" title="2.1 The Main Configuration File nagios.cfg">2.1 The Main Configuration File nagios.cfg</a>, page 55): you set up the definition so that the configuration files can be copied 1:1.<a class="indexterm" id="IDX-CHP-15-1156"/></p>

    <div class="sect2" title="15.3.1 Avoiding redundancy in configuration files">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="avoiding_redundancy_in_configuration_f"/>15.3.1 Avoiding redundancy in configuration files</h2>
      </div>

      <p>In the following example we assume that the noncentral servers only perform host and service checks and send the results to the central server, and do not provide any other Nagios functions. The following directories are set up on the central host:</p><a id="I_programlisting12_d1e29319"/>
      <pre class="programlisting">/etc/nagios/global
/etc/nagios/local
/etc/nagios/sites
/etc/nagios/sites/bonn
/etc/nagios/sites/Frankfurt
/etc/nagios/sites/berlin
...</pre>

      <p>Each of the configurations used for a location lands in the directory <strong class="userinput"><code>/etc/nagios/sites/</code></strong><strong class="userinput"><code><em class="replaceable"><code>location</code></em></code></strong>. After <strong class="userinput"><code>global</code></strong>, all the definitions follow that can be used identically at all locations (e.g., the command definitions in <strong class="userinput"><code>checkcommands.cfg</code></strong>). The directory <strong class="userinput"><code>local</code></strong> takes in specific definitions for the central server definitions. These include the templates for services and hosts, where distinction must be made between central and noncentral.</p>

      <p>This directory is also created separately on the noncentral servers: only the folders <strong class="userinput"><code>global</code></strong> and <strong class="userinput"><code>sites/</code></strong><strong class="userinput"><code><em class="replaceable"><code>location</code></em></code></strong> are copied from the central instance to the branch offices.</p>

      <p>The three directories are read in with the <strong class="userinput"><code>cfg_dir</code></strong> directive in <strong class="userinput"><code>/etc/nagios/nagios.cfg:</code></strong></p><a id="I_programlisting12_d1e29356"/>
      <pre class="programlisting"># -- /etc/nagios/nagios.cfg
...
cfg_dir=/etc/nagios/global
cfg_dir=/etc/nagios/local
cfg_dir=/etc/nagios/sites
...</pre>

      <p>Only settings that are identical for the noncentral and central page are used in the service definition:</p><a id="I_programlisting12_d1e29360"/>
      <pre class="programlisting"># -- /etc/nagios/sites/bonn/services.cfg
define service{
    host_name            bonn01
    service_description  HTTP
 <span class="strong"><strong>   use        bonn-svc-template</strong></span>
   ...
    check_command                      check_http
   ...
}</pre>

      <p>The location-dependent parameters are dealt with by the templates.</p>
    </div>

    <div class="sect2" title="15.3.2 Defining templates">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="defining_templates"/>15.3.2 Defining templates</h2>
      </div>

      <p>In order that service definitions are identical on both the central and non-central servers, the local templates must have the same names as the central ones. In addition you should ensure that the obligatory parameters (see <a class="xref" href="../Text/ch02.html" title="Chapter 2. Nagios Configuration">Chapter 2</a> from page 53) are also all entered, even if they are not even required at one of the locations, because together, the template and service definitions must cover all obligatory parameters.<a class="indexterm" id="IDX-CHP-15-1157"/><a class="indexterm" id="IDX-CHP-15-1158"/><a class="indexterm" id="IDX-CHP-15-1159"/><a class="indexterm" id="IDX-CHP-15-1160"/></p>

      <p>The following example shows a service template for one of the noncentral locations:</p><a id="I_programlisting12_d1e29394"/>
      <pre class="programlisting"># -- On-Site configuration for the Bonn location
define service{
    name               bonn-svc-template
    register           0
 <span class="strong"><strong>   max_check_attempts     3</strong></span>
 <span class="strong"><strong>   normal_check_interval  5</strong></span>
 <span class="strong"><strong>   retry_check_interval   1</strong></span>
 <span class="strong"><strong>   active_checks_enabled  1</strong></span>
    passive_checks_enabled           1
 <span class="strong"><strong>   check_period            24×7</strong></span>
 <span class="strong"><strong>   obsess_over_services     1</strong></span>
    notification_interval              0
    notification_period                none
    notification_options               n
 <span class="strong"><strong>   notifications_enabled    0</strong></span>
    contact_groups                     dummy
}</pre>

      <p>The parameters that are important for the noncentral page are printed in bold type. Besides the parameters that refer to the test itself, the parameter <strong class="userinput"><code>obsess_over_services</code></strong> must also not be left out. This ensures that the check results are sent to the central server.<a class="indexterm" id="IDX-CHP-15-1161"/></p>

      <p><strong class="userinput"><code>notifications_enabled</code></strong> switches off notification in this case, since the local admins do not need to worry about error messages from services that are centrally monitored. Alternatively this can be done globally in the non-central <strong class="userinput"><code>/etc/nagios/nagios.cfg</code></strong>.</p>

      <p><strong class="userinput"><code>register 0</code></strong> ensures that the template is used exclusively as a template, so that Nagios does not interpret it as a separate service definition.</p>

      <p>The counterpart with the same name on the central server looks something like this:</p><a id="I_programlisting12_d1e29439"/>
      <pre class="programlisting"># -- Service template for the central Nagios server
define service{
    name            bonn-svc-template
    register        0

    max_check_attempts            3
    normal_check_interval         5
    retry_check_interval          1
    active_checks_enabled         0
 <span class="strong"><strong>passive_checks_enabled     1</strong></span>
 <span class="strong"><strong>check_period           none</strong></span>
 <span class="strong"><strong>check_freshness        0</strong></span>
obsess_over_services   0
<span class="strong"><strong>notification_interval 480</strong></span>
 <span class="strong"><strong>notification_period   24×7</strong></span>
 <span class="strong"><strong>notification_options u,c,r</strong></span>
 <span class="strong"><strong>notifications_enabled 1</strong></span>
 <span class="strong"><strong>contact_groups        admins</strong></span>
}</pre>

      <p>The parameter <strong class="userinput"><code>passive_checks_enabled</code></strong> is of importance here, as well as the configuration of the notification system. On the central side, the parameters involving the test itself come into play only if freshness checking is used (see <a class="xref" href="../Text/ch13s04.html" title="13.4 Reacting to Out-of-Date Information of Passive Checks">13.4 Reacting to Out-of-Date Information of Passive Checks</a> from page 295). This works only if the central Nagios server is itself in a position to actively test all services if there is any doubt. Since the <strong class="userinput"><code>check_command</code></strong> in this simple template solution is given in the location-dependent service definition, which is identical on the non-central and central servers, this will work only if the same command object can be used both centrally and noncentrally—if the object definitions in <strong class="userinput"><code>global/checkcommands.cfg</code></strong> match on both sides.</p>

      <p>In the example, however, we completely switch off active tests of services at the Bonn location, with <strong class="userinput"><code>check_period none</code></strong> and <strong class="userinput"><code>check_freshness</code></strong> set to 0. The system described so far can also be applied to host checks, of course.</p>
    </div>
  </div>
</body></html>