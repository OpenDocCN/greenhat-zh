- en: Chapter 1. FLOW FUNDAMENTALS
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第1章. 流的基本概念
- en: '![image with no caption](httpatomoreillycomsourcenostarchimages651574.png.jpg)'
  id: totrans-1
  prefs: []
  type: TYPE_IMG
  zh: '![无标题图片](httpatomoreillycomsourcenostarchimages651574.png.jpg)'
- en: I'll assume at this point that you're sold on the idea that flows can solve
    your problems. Now, let's get specific about what flows are, what they're good
    for, and how you can implement and analyze them. This chapter focuses on the flows
    commonly found on TCP/IP networks, specifically, TCP, UDP, and ICMP flows.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 我假设到这一点，你已经接受了流可以解决你的问题的想法。现在，让我们具体了解一下流是什么，它们有什么好处，以及你如何实现和分析它们。本章重点介绍在TCP/IP网络上常见的流，特别是TCP、UDP和ICMP流。
- en: This chapter assumes you have a basic understanding of TCP/IP and tries to drag
    you into a deeper understanding of it. If you find yourself growing confused,
    I suggest you consult an introductory book such as Charles M. Kozierok's *The
    TCP/IP Guide* (No Starch Press, 2005). I also encourage you to spend quality time
    with a packet sniffer watching TCP/IP transactions in the real world because there's
    no better way to learn network protocols than observing them carrying out real
    work.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章假设你已具备TCP/IP的基本理解，并试图帮助你更深入地理解它。如果你发现自己越来越困惑，我建议你查阅Charles M. Kozierok的*《TCP/IP指南》*（No
    Starch Press，2005年）。我也鼓励你花些时间与数据包嗅探器一起观察现实世界中的TCP/IP事务，因为没有比观察它们执行实际工作更好的学习网络协议的方法了。
- en: Note
  id: totrans-4
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Experienced network administrators might find that this chapter repeats topics
    they already know. If you already understand three-way handshake and if seeing
    `0x2` makes you think "TCP reset," then you might be tempted to skip this chapter.
    This chapter covers the material from a flow-based perspective, however, so if
    you decide to skip ahead, don't come sniveling to me when you get confused.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 经验丰富的网络管理员可能会发现本章重复了他们已经知道的主题。如果你已经理解了三次握手，如果看到`0x2`让你想到“TCP重置”，那么你可能想跳过这一章。然而，本章从基于流的角度覆盖了这些材料，所以如果你决定跳过，当你困惑时不要来找我哭诉。
- en: What Is a Flow?
  id: totrans-6
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 什么是流？
- en: Strictly speaking, a *flow* is a series of packets that share the same source
    and destination IP addresses, source and destination ports, and IP protocol. This
    is also called a *five-tuple IP flow*. The word *flow* is also sometimes used
    to mean an aggregate of individual flows. A *flow record* is a summary of information
    about a flow, recording which hosts communicated with which other hosts, when
    this communication occurred, how the traffic was transmitted, and other basic
    information about the network conversation. A flow analysis system collects flow
    information and gives you a system to search, filter, and print flow information.
    Flow records summarize every connection on your network.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 严格来说，一个*流*是一系列具有相同源和目的IP地址、源和目的端口以及IP协议的分组。这也被称为*五元组IP流*。*流*这个词有时也用来指单个流的聚合。*流记录*是关于流的信息摘要，记录了哪些主机与哪些其他主机通信，何时发生这种通信，如何传输流量，以及关于网络对话的其他基本信息。流分析系统收集流信息，并为你提供一个系统来搜索、过滤和打印流信息。流记录总结了网络上每个连接。
- en: Do you want to know what kind of traffic is filling your Internet T1, what a
    client PC is doing, or what kind of errors are reaching a server? Check the flow
    records. Want to know what happened on the network yesterday between 3 **am**
    and 3:05 **am**, when the file server mysteriously crashed and rebooted? Check
    yesterday's flow records.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 你想知道哪种流量正在填充你的互联网T1，客户端PC在做什么，或者哪种错误正在到达服务器吗？检查流记录。想知道昨天凌晨3点到3点05分之间网络发生了什么，当时文件服务器神秘地崩溃并重新启动吗？检查昨天的流记录。
- en: The good news is that most network hardware can report traffic as flows. Having
    that hardware send flow information to a recording host imposes only a small overhead;
    you don't need to install anything.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 好消息是，大多数网络硬件都可以报告流量作为流。让这种硬件将流信息发送到记录主机只会产生很小的开销；你不需要安装任何东西。
- en: Because flow records do not include the data exchanged by a network connection,
    flow records are small. For example, as I write this, my data center has a DS3,
    several T1s, a gigabit Ethernet backbone, and assorted smaller subnets and DMZs.
    Still, three complete years of flow records use less than 100GB of disk space.
    Granted, that's not trivial, but it's a small amount of disk space by modern standards
    and far less than that required to capture the complete contents of every exchange.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 由于流量记录不包括网络连接交换的数据，因此流量记录很小。例如，在我写这篇文章的时候，我的数据中心有一个DS3，几个T1，一个千兆以太网骨干网，以及各种较小的子网和DMZ。尽管如此，三年完整的流量记录使用的磁盘空间不到100GB。当然，这不算小，但按照现代标准，这只是一小部分磁盘空间，远低于捕获每个交换完整内容所需的磁盘空间。
- en: Even with gigabytes of data, flow records do not allow unlimited troubleshooting.
    Anyone who has ever used a packet sniffer to watch a telnet or unencrypted web
    session understands that everything that traverses the network can be captured,
    analyzed, and reconstructed. A snooper can see exactly which websites a user visits,
    what files the user downloads, what the user transmits back to the site, and any
    usernames and passwords used in the exchange. Flow records do not contain this
    data; they simply tell the network administrator that a client visited a website
    running at a particular IP address, how many connections the user made to that
    site, how much data was exchanged, but not the contents of those exchanges.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 即使有数GB的数据，流量记录也不允许无限的故障排除。任何曾经使用数据包嗅探器来监视telnet或未加密Web会话的人都知道，网络中穿越的所有内容都可以被捕获、分析和重建。一个监听者可以看到用户访问了哪些网站，用户下载了哪些文件，用户向网站发送了什么内容，以及交换中使用的任何用户名和密码。流量记录不包含这些数据；它们只是告诉网络管理员，一个客户端访问了运行在特定IP地址上的网站，用户与该网站建立了多少连接，交换了多少数据，但不是这些交换的内容。
- en: Recording only flow information rather than complete packets might sound limited,
    but the NSA performs similar analysis on phone records to catch criminals and
    terrorists. Similarly, the wireless wiretapping at AT&T was discovered through
    netflow analysis. Knowing who talked to whom, when they talked, and how much each
    party said is terribly valuable.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 仅记录流量信息而不是完整的数据包可能听起来有限，但国家安全局（NSA）正是通过对电话记录进行类似分析来捕捉罪犯和恐怖分子。同样，AT&T的无线窃听是通过网络流量分析发现的。知道谁和谁交谈，交谈的时间以及每一方说了多少是非常宝贵的。
- en: FLOWS VS. SESSIONS
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 流量与会话的比较
- en: 'Different protocols describe network interaction with words such as *session*,
    *transaction*, and *conversation*. How do these differ from a flow? Remember that
    all traffic in a flow is going in the same direction. When a client connects to
    a web server and downloads a file, it creates a simple HTTP session. However,
    this one session (that is, this one transaction) is actually two flows: one going
    from the client to the server and another one going from the server to the client.
    Each flow mirrors the other.'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 不同的协议使用诸如*会话*、*事务*和*对话*等词汇来描述网络交互。这些与流量有何不同？请记住，流量中的所有流量都是同一方向流动的。当客户端连接到Web服务器并下载文件时，它创建了一个简单的HTTP会话。然而，这个会话（即这个事务）实际上是两个流量：一个从客户端到服务器，另一个从服务器到客户端。每个流量都反映了另一个。
- en: Flow System Architecture
  id: totrans-15
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 流量系统架构
- en: 'A typical flow-based management system has three components: a sensor (or sensors),
    a collector, and a reporting system. Components can be combined as well, as you''ll
    learn in [Chapter 2](ch02.html "Chapter 2. COLLECTORS AND SENSORS").'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 典型的基于流量的管理系统有三个组件：一个传感器（或多个传感器）、一个收集器和报告系统。组件也可以组合，正如你将在[第2章](ch02.html "第2章。收集器和传感器")中学到的。
- en: A *sensor*, also known as a *probe*, is a device that listens to the network
    and captures traffic data. The sensor may be a switch, router, or firewall with
    integrated flow export capability, or it might be a piece of software listening
    to an Ethernet tap or a switch port in monitor mode. The sensor tracks network
    connections, and after it believes a connection has finished or the connection
    reaches a timeout, it transmits the data.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 一种称为*探针*的*传感器*是一种监听网络并捕获流量数据的设备。传感器可能是一个具有集成流量导出功能的交换机、路由器或防火墙，或者它可能是一段软件，监听以太网分接或监控模式下的交换机端口。传感器跟踪网络连接，并在它认为连接已完成或连接达到超时后，传输数据。
- en: The *collector* is software that receives sensor records and writes them to
    disk. The collector is an absolutely critical piece of your flow-based management
    infrastructure. Unfortunately, there's no universally accepted on-disk format
    for storing flow records. This complicates analysis and restricts the reporting
    tools you can use, but you'll learn how to work around that in this book.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: '*收集器*是接收传感器记录并将它们写入磁盘的软件。收集器是您基于流的网络管理基础设施中绝对关键的部分。不幸的是，没有一种通用的磁盘格式被普遍接受用于存储流量记录。这使分析变得复杂，并限制了您可以使用报告工具的范围，但您将在本书中学习如何克服这一点。'
- en: Finally, the *reporting system* reads the collector files and produces human-friendly
    reports. The reporting system must understand the file format used by the collector.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，*报告系统*读取收集器文件并生成易于理解的报告。报告系统必须理解收集器使用的文件格式。
- en: You can find many different implementations of each component of a flow-based
    management system. Each hardware vendor's higher-end equipment has a flow sensor,
    and many people have written or implemented flow sensors for their preferred operating
    system. Several different collectors have come into prominence and faded, such
    as cflowd, and many people who wanted to demonstrate their mastery of the latest
    cool scripting language have written reporting systems to meet their particular
    needs.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以找到许多基于流的管理系统中每个组件的不同实现。每个硬件供应商的高端设备都配备了流量传感器，许多人也为他们偏好的操作系统编写或实现了流量传感器。一些不同的收集器曾经突出，后来又消失，例如cflowd，许多想要展示他们对最新酷脚本语言掌握的人也编写了满足他们特定需求的报告系统。
- en: A newcomer might look at the vast array of options and decide that flow management
    is too complicated to even begin to attempt. What's worse, much of this software
    is obsolete, but Internet mailing list archives from, say, 1998 strongly recommend
    it. The neophyte can spend hours tracking down software only to discover that
    it can no longer be built with a modern compiler. Additionally, many possible
    combinations are subtly incompatible.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 新手可能会看到众多选项，从而认为流量管理过于复杂，甚至不敢尝试。更糟糕的是，其中许多软件已经过时，但1998年的互联网邮件列表存档却强烈推荐它们。新手可能会花费数小时追踪这些软件，最终发现它们无法用现代编译器构建。此外，许多可能的组合存在细微的不兼容性。
- en: This situation is beyond frustrating, and it makes many people abandon investigations
    into flow-based network management after only a couple hours.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 这种情况令人沮丧不已，许多人在仅仅几小时后就会放弃对基于流的网络管理的研究。
- en: This book presents a single set of software components that work together. The
    components either are still actively developed or have a widespread user base.
    The core platform is the flow-tools tool kit ([http://code.google.com/p/flow-tools/](http://code.google.com/p/flow-tools/)).
    Flow-tools has been the standard freely available flow collector and reporting
    software for many years now and is compatible with all common sensors. Additionally,
    many reporting tools leverage flow-tools' data format when correctly configured.
    You'll learn how to make flow-tools integrate with some other popular tools in
    this book.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 本书介绍了一套单一的软件组件，它们可以协同工作。这些组件要么仍在积极开发中，要么拥有广泛的用户基础。核心平台是flow-tools工具包（[http://code.google.com/p/flow-tools/](http://code.google.com/p/flow-tools/））。多年来，flow-tools一直是标准化的免费流量收集和报告软件，并且与所有常见传感器兼容。此外，许多报告工具在正确配置的情况下会利用flow-tools的数据格式。你将在本书中学习如何使flow-tools与其他一些流行的工具集成。
- en: The History of Network Flow
  id: totrans-24
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 网络流量历史
- en: High-speed router and switch hardware directs traffic without going to the operating
    system, in other words, without making each forwarding decision in software. Decisions
    on packet routing are made at the lowest level possible, generally within the
    hardware itself. Circa 1996, Cisco invented a method by which routing decisions
    were guided by flows. Subsequently, the value of flow information was realized,
    and it was made accessible to network administrators as a feature called NetFlow.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 高速路由器和交换机硬件在不对操作系统进行操作的情况下直接引导流量，换句话说，即不在软件中做出每个转发决策。数据包路由的决策在可能的最底层做出，通常在硬件内部。大约在1996年，思科发明了一种通过流量引导路由决策的方法。随后，流量信息的价值得到了认可，并作为名为NetFlow的功能提供给网络管理员。
- en: NetFlow Versions
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: NetFlow版本
- en: NetFlow has undergone several revisions through its history.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: NetFlow在其历史中经历了多次修订。
- en: NetFlow Version 1
  id: totrans-28
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: NetFlow版本1
- en: NetFlow version 1 was the earliest Cisco release. Other vendors reverse-engineered
    the NetFlow reporting protocol and released their own NetFlow-compatible reporting
    systems. A few vendors still support NetFlow version 1, and if this is all you
    have, it will still solve many problems for you. It contains only the minimal
    flow information.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: NetFlow版本1是思科最早的发布版本。其他供应商对NetFlow报告协议进行了逆向工程，并发布了他们自己的兼容NetFlow的报告系统。一些供应商仍然支持NetFlow版本1，如果你只有这个版本，它仍然可以解决你许多问题。它只包含最少的流量信息。
- en: NetFlow Version 5
  id: totrans-30
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: NetFlow版本5
- en: The oldest widely deployed flow record format is NetFlow version 5\. Many vendors,
    such as Juniper and Nokia, implemented this protocol.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 最古老的广泛部署的流量记录格式是NetFlow版本5。许多供应商，如Juniper和Nokia，实现了此协议。
- en: 'NetFlow version 5 includes seven key values: source IP address, destination
    IP address, source port (TCP and UDP protocols only), destination port, IP protocol,
    the interface the flow arrived on the system on, and the IP type of service. It
    also includes information about BGP, the exporter IP address, and a few other
    traffic characteristics. Although flow records have become more detailed over
    the years, NetFlow version 5 suffices for most environments.'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: NetFlow版本5包括七个关键值：源IP地址、目的IP地址、源端口（仅TCP和UDP协议）、目的端口、IP协议、流量到达系统上的接口，以及IP服务类型。它还包括有关BGP、导出器IP地址以及一些其他流量特性的信息。尽管随着时间的推移，流量记录变得越来越详细，但NetFlow版本5对于大多数环境来说已经足够了。
- en: NetFlow Version 7
  id: totrans-33
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: NetFlow版本7
- en: NetFlow version 7 is supported only by high-end Cisco Catalyst switches. Its
    flow record format includes switching and routing information not available in
    version 5, such as the IP address of the next hop address for the flow. If you
    have hardware that supports NetFlow version 7, this book will show you how to
    take advantage of it.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: NetFlow版本7仅由高端思科Catalyst交换机支持。其流量记录格式包括版本5中不可用的交换和路由信息，例如流量的下一跳地址的IP地址。如果你有支持NetFlow版本7的硬件，这本书将向你展示如何利用它。
- en: NetFlow Version 8
  id: totrans-35
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: NetFlow版本8
- en: NetFlow version 8 is a cluster of similar formats that aggregate information.
    If you have many high-bandwidth connections and you must minimize the amount of
    resources you spend collecting and analyzing flow records, NetFlow version 8 might
    be useful. Cisco is the only vendor that supports it, however, and it's used only
    rarely. Given our ever-increasing computing power and disk capacity, however,
    NetFlow version 8 is usually not compelling.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: NetFlow版本8是一组类似的格式，用于汇总信息。如果你有很多高带宽连接，并且必须最小化你用于收集和分析流量记录的资源量，NetFlow版本8可能很有用。然而，只有思科支持它，并且它很少使用。然而，鉴于我们不断增长的计算能力和磁盘容量，NetFlow版本8通常并不具有吸引力。
- en: NetFlow Version 9
  id: totrans-37
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: NetFlow版本9
- en: NetFlow version 9 is Cisco's final version. It is template-based and extensible,
    meaning that third-party vendors can add arbitrary information into a NetFlow
    record. Version 9 is also the first version to support IP version 6 (IPv6). NetFlow
    version 9 is deployed in only a few commercial products.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: NetFlow版本9是思科的最终版本。它是基于模板且可扩展的，这意味着第三方供应商可以将任意信息添加到NetFlow记录中。版本9也是第一个支持IPv6（IP版本6）的版本。NetFlow版本9仅在少数商业产品中部署。
- en: NetFlow Competition
  id: totrans-39
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: NetFlow竞赛
- en: As Cisco deployed more and more NetFlow versions, other networking companies
    saw the benefit of exporting and reporting on flow data. For example, Cisco developed
    NetFlow based on the needs of its own customers, which were not necessarily the
    needs of the global networking community. Other vendors implemented similar flow-based
    reporting based on the needs of their customers. As a result, NetFlow competitors
    appeared, the best known of which is sFlow. Some equipment from vendors such as
    3Com, HP, Extreme, and Juniper support sFlow.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 随着思科部署越来越多的NetFlow版本，其他网络公司看到了导出和报告流量数据的好处。例如，思科根据其客户的需要开发了NetFlow，这些需要并不一定是全球网络社区的需要。其他供应商根据其客户的需要实现了基于流的类似报告。因此，NetFlow的竞争对手出现了，其中最著名的是sFlow。来自3Com、HP、Extreme和Juniper等供应商的一些设备支持sFlow。
- en: Note
  id: totrans-41
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: sFlow is specifically not NetFlow because Cisco owns that word. People began
    to refer to *flow export* instead of *NetFlow* about the same time that sFlow
    was released.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: sFlow特别不是NetFlow，因为思科拥有这个词。大约在sFlow发布的同时，人们开始使用*流量导出*而不是*NetFlow*。
- en: As the number of competitors grew, the networking community saw the advantages
    of a common standards-defined flow export protocol. Current efforts focus on this
    standards-based approach.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 随着竞争对手数量的增加，网络社区看到了一个共同标准定义的流导出协议的优势。当前的工作重点集中在这种基于标准的方法上。
- en: The Latest Standards
  id: totrans-44
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 最新标准
- en: In the early 2000s, the Internet Engineering Task Force created a working group
    to define flow formats and prevent further flow format fragmentation. The working
    group chose to use NetFlow version 9 as the base protocol, with minor changes
    to make it friendlier. Cisco is still involved but now as a member rather than
    the sole controlling interest.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 在2000年代初，互联网工程任务组创建了一个工作组来定义流格式并防止进一步的流格式碎片化。该工作组选择使用NetFlow版本9作为基本协议，并进行了少量修改以使其更友好。思科仍然参与其中，但现在作为成员而不是唯一的控制利益方。
- en: The latest version of the network flow standard is called IP Flow Information
    eXport (IPFIX). Although many hardware vendors are implementing IPFIX support
    as well as support for older versions, the format is rarely deployed. IPFIX is
    much more complicated than earlier flow versions and uses more system resources.
    The differences between earlier NetFlow versions are evolutionary, but NetFlow
    version 9 and IPFIX represent dramatic breaks from earlier versions. People are
    also investigating using IPFIX to manage non-network data, such as security events.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 网络流标准的最新版本被称为IP流信息导出（IPFIX）。尽管许多硬件供应商也在实施IPFIX支持以及旧版本的支持，但该格式很少被部署。IPFIX比早期的流版本更复杂，并且使用更多的系统资源。早期NetFlow版本之间的差异是渐进式的，但NetFlow版本9和IPFIX代表了与早期版本的重大突破。人们也在研究使用IPFIX来管理非网络数据，例如安全事件。
- en: The solutions you'll explore in this book address NetFlow versions 1 through
    7\. Versions 8 and 9 are rarely needed, and although IPv6 requires NetFlow version
    9 or newer, most of the world is not interested in IPv6 and will remain disinterested
    until IP version 4 address space shortages become intolerable. Once IPv6 is no
    longer optional, I expect vendors to jump directly to IPFIX. When IPFIX becomes
    more widespread, I have no doubt that the user community will add IPFIX support
    to the tools covered in this book.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 本书将探讨的解决方案涵盖了NetFlow版本1至7。版本8和9很少需要，尽管IPv6需要NetFlow版本9或更高版本，但世界上大多数人对IPv6不感兴趣，并且将保持这种不感兴趣的态度，直到IPv4地址空间短缺变得无法忍受。一旦IPv6不再是可选的，我预计供应商将直接跳到IPFIX。当IPFIX变得更加普遍时，我毫不怀疑用户社区将把IPFIX支持添加到本书涵盖的工具中。
- en: NETFLOW VS. FLOW EXPORT
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: NETFLOW VS. FLOW EXPORT
- en: Sometimes in this book I use the word *NetFlow*; other times I use *flow management*
    or *flow export*. The difference between them is that Cisco owns the word NetFlow,
    while other vendors support a NetFlow-compatible flow export technology. You might
    be using NetFlow, or you might be using a NetFlow-compatible flow export system,
    depending on your equipment. The difference is only semantic, but whenever possible,
    I avoid annoying any multinational firm that could crush me like a bug.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书中，有时我会使用“*NetFlow*”这个词；有时我会使用“*流管理*”或“*流导出*”。它们之间的区别是，思科拥有“NetFlow”这个词，而其他供应商支持与NetFlow兼容的流导出技术。你可能在使用NetFlow，或者你可能在使用一个与NetFlow兼容的流导出系统，这取决于你的设备。这种区别只是语义上的，但只要可能，我都会避免惹恼任何可能像压扁虫子一样压垮我的跨国公司。
- en: Flows in the Real World
  id: totrans-50
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 现实世界中的流
- en: '"A *flow* is a series of packets that all share the same source and destination
    IP addresses, source and destination ports, and IP protocol." What the heck does
    that mean, really? Let''s pull this description apart and see what it really means
    in a few places in the real world. I''ll start with the simplest network traffic,
    a ping request and response, and then proceed to more complicated examples of
    DNS and HTTP requests.'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: “*流*是一系列所有共享相同的源和目的IP地址、源和目的端口以及IP协议的分组。”这到底是什么意思呢？让我们拆解这个描述，看看它在现实世界的几个地方真正意味着什么。我将从最简单的网络流量开始，一个ping请求和响应，然后继续到更复杂的DNS和HTTP请求的例子。
- en: ICMP Flows
  id: totrans-52
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ICMP流
- en: Although ICMP is most commonly associated with ping requests, it also carries
    the most basic instructions for Internet routing and management. Certain individual
    flows, such as ICMP redirects, can carry useful information, but to keep things
    simple, I'll cover the common ping.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管ICMP最常与ping请求相关联，但它也携带了互联网路由和管理的基本指令。某些个别流，如ICMP重定向，可以携带有用的信息，但为了简单起见，我将涵盖常见的ping。
- en: ICMP has no TCP-style flags and does not have ports like TCP and UDP do. Instead,
    ICMP packets are assigned an *ICMP type* and an optional *ICMP code*. The ICMP
    type identifies the general purpose of the packet. Ping requests and response
    messages have their own ICMP types, and an ICMP type might have associated ICMP
    codes that offer more detail. (You'll learn more about ICMP types and codes in
    [Chapter 3](ch03.html "Chapter 3. VIEWING FLOWS").)
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: ICMP没有TCP风格的标志，也没有TCP和UDP那样的端口。相反，ICMP数据包被分配一个*ICMP类型*和一个可选的*ICMP代码*。ICMP类型标识了数据包的一般用途。ping请求和响应消息有自己的ICMP类型，并且一个ICMP类型可能关联有提供更多详细信息的ICMP代码。（你将在[第3章](ch03.html
    "第3章. 查看数据流")中了解更多关于ICMP类型和代码的内容。）
- en: To ping a server, the client creates an ICMP packet with a source address of
    the client and a destination address of the server. The client sets the ICMP type
    to 8, or `echo-request`, and sends the packet onto the network. This ping packet
    is the entirety of the first flow.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 要ping服务器，客户端会创建一个包含客户端源地址和服务器目标地址的ICMP数据包。客户端将ICMP类型设置为8，或`echo-request`，并将数据包发送到网络。这个ping数据包是第一个数据流的全部内容。
- en: In response, the server creates an ICMP packet with the server's source address,
    the client's destination address, and an ICMP type of 0, or `echo-response`. This
    is the complete second flow.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 作为回应，服务器创建了一个包含服务器源地址、客户端目标地址以及ICMP类型为0，或`echo-response`的ICMP数据包。这是完整的第二个数据流。
- en: That said, if your client sends multiple ping requests, the flow system assigns
    subsequent pings to the same flow. A Windows system, for example, normally sends
    five ping requests and expects five ping replies. Your flow system records a single
    flow containing five requests and a separate flow containing five responses.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 话虽如此，如果你的客户端发送多个ping请求，流系统会将后续的ping分配到同一个数据流。例如，Windows系统通常发送五个ping请求并期望得到五个ping响应。你的流系统记录一个包含五个请求和一个包含五个响应的单个数据流。
- en: A flow sensor has no way of knowing when ICMP flows are complete, because the
    traffic contains no internal markers that say "No further packets will arrive."
    The sensor holds ICMP flows in memory until a timeout expires, at which point
    the sensor marks the flows as complete and transmits them to the collector.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 流传感器无法知道ICMP数据流何时完成，因为流量中没有内部标记表明“不会再有数据包到达”。传感器将ICMP数据流保留在内存中，直到超时时间到期，此时传感器将数据流标记为完成并将它们传输到收集器。
- en: UDP Flows
  id: totrans-59
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: UDP数据流
- en: 'Now consider a basic DNS request to see how UDP flows function. UDP sessions
    are slightly more complex than ICMP flows: Although UDP doesn''t use types and
    codes like ICMP and doesn''t have flags like TCP, UDP uses TCP-style port numbers.
    Also, UDP has no built-in concept of a session or transaction, which is why people
    describe it as *connectionless*. UDP does carry useful application-level data,
    however, and most UDP traffic is part of some sort of session or transaction.
    The most common UDP flows on the average network are DNS requests. A DNS request
    is among the simplest possible network requests and produces the shortest flows
    you''ll see. Other UDP network protocols, such as bootp, generate many more packets
    per flow, but to understand flows, you''ll look at the humble DNS request here.'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 现在考虑一个基本的DNS请求，以了解UDP数据流是如何工作的。UDP会话比ICMP数据流稍微复杂一些：尽管UDP不像ICMP那样使用类型和代码，也不像TCP那样有标志，但UDP使用TCP风格的端口号。此外，UDP没有内置的会话或事务概念，这就是为什么人们将其描述为*无连接*。然而，UDP确实携带有用的应用层数据，并且大多数UDP流量都是某种会话或事务的一部分。在普通网络上最常见的UDP数据流是DNS请求。DNS请求是可能的最简单的网络请求之一，并产生最短的数据流。其他UDP网络协议，如bootp，在每个数据流中生成更多的数据包，但为了理解数据流，你将在这里查看谦逊的DNS请求。
- en: A client connecting to a DNS server creates a UDP packet with a source IP of
    the client and a destination IP of the server. As with TCP, the UDP request originates
    from an unused port on the client side and uses the standard DNS port 53 as its
    destination. A simple DNS query, such as a request for the address of [www.nostarch.com](http://www.nostarch.com),
    fits entirely within one packet. This single packet is the start of the third
    sample flow.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 当一个客户端连接到DNS服务器时，它会创建一个包含客户端源IP地址和服务器目标IP地址的UDP数据包。与TCP类似，UDP请求从客户端的一个未使用端口发起，并使用标准的DNS端口53作为目标端口。一个简单的DNS查询，例如请求[www.nostarch.com](http://www.nostarch.com)的地址，可以完全包含在一个数据包中。这个单一的数据包是第三个示例数据流的开始。
- en: The fourth flow begins when a server responds by creating a UDP packet with
    a source IP of the server and a destination IP of the client. Similarly, the source
    and destination ports are reversed from the packet sent by the client. A DNS response
    containing the information for a typical site also fits entirely within one packet.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 第四个流开始于服务器通过创建一个源IP为服务器、目标IP为客户端的UDP数据包来响应。同样，源端口和目标端口与客户端发送的数据包相反。包含典型网站信息的DNS响应也完全包含在一个数据包中。
- en: These flows are now complete, and no more traffic will be passed as part of
    them. You can see these flows in [Figure 1-1](ch01s04.html#udp_network_transaction_with_flow_member
    "Figure 1-1. UDP network transaction with flow memberships").
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 这些流现在已经完成，不会再有流量作为它们的一部分传输。你可以在[图1-1](ch01s04.html#udp_network_transaction_with_flow_member
    "图1-1. UDP网络事务与流成员")中看到这些流。
- en: '![UDP network transaction with flow memberships](httpatomoreillycomsourcenostarchimages651576.png.jpg)'
  id: totrans-64
  prefs: []
  type: TYPE_IMG
  zh: '![UDP网络事务与流成员](httpatomoreillycomsourcenostarchimages651576.png.jpg)'
- en: Figure 1-1. UDP network transaction with flow memberships
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 图1-1. UDP网络事务与流成员
- en: Because UDP is connectionless, the network traffic contains no markers to tell
    an observer that a particular conversation is complete. The packets have no TCP-esque
    FIN flag that announces "I'm done, so hang up now," so a flow sensor has no way
    to know that the flows are complete. The sensor holds those flows in memory until
    a timeout expires, at which point the sensor marks the flows as complete and transmits
    them to the collector.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 因为UDP是无连接的，网络流量中不包含标记来告诉观察者某个特定的会话已经完成。数据包没有TCP式的FIN标志来宣布“我完成了，所以现在挂断”，因此流量传感器无法知道这些流已经完成。传感器将这些流保存在内存中，直到超时时间到期，此时传感器将流标记为完成并将它们传输到收集器。
- en: TCP Flows
  id: totrans-67
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: TCP流
- en: The most complicated network flows that I'll cover are TCP flows, such as those
    used by web servers and browsers. The TCP protocol includes ports such as those
    used by UDP but also includes internal flags that indicate the state of the connection.
    TCP tells the client and the server whether a connection is being requested, ongoing,
    or being torn down. For example, now that you have an IP address for [www.nostarch.com](http://www.nostarch.com),
    let's look at a web client requesting a single, static, simple web object from
    that site.^([[1](#ftn.CHP-1-FN-1)])
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 我将涵盖的最复杂的网络流是TCP流，例如那些由Web服务器和浏览器使用的流。TCP协议包括UDP使用的端口，还包括指示连接状态的内部标志。TCP告诉客户端和服务器连接是被请求、进行中还是正在拆除。例如，现在你有了[www.nostarch.com](http://www.nostarch.com)的IP地址，让我们看看一个Web客户端从这个网站请求单个、静态、简单的Web对象。[^([1](#ftn.CHP-1-FN-1))]
- en: The fifth flow begins when a client connecting to a web server sends a single
    packet to the server with a source IP of the client and a destination IP of the
    server. The client allocates an unused port on the local system for exclusive
    use by this connection, which is the packet's *source port*. Web servers typically
    run on port 80, so this is the packet's destination port. On the first packet
    in the connection, the client sets the synchronization (SYN) request flag (this
    initial packet is usually referred to as a *SYN request*). The client is contacting
    the server, saying "Hey, can I talk to you?"
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 第五个流开始于一个连接到Web服务器的客户端向服务器发送一个数据包，该数据包的源IP是客户端，目标IP是服务器。客户端在本地系统上分配一个未使用的端口，用于此连接的专用，这就是数据包的*源端口*。Web服务器通常运行在端口80上，因此这是数据包的目标端口。在连接的第一个数据包中，客户端设置同步（SYN）请求标志（这个初始数据包通常被称为*SYN请求*）。客户端正在联系服务器，说“嘿，我能和你说话吗？”
- en: When the server receives a SYN request on port 80 and decides to accept the
    connection, it prepares a *response packet*. This response packet has a source
    address of the server and a destination address of the client. The source port
    is 80, the port requested by the client; the destination port is the earlier packet's
    source port.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 当服务器在端口80上接收到SYN请求并决定接受连接时，它准备一个*响应数据包*。这个响应数据包的源地址是服务器，目标地址是客户端。源端口是80，客户端请求的端口；目标端口是之前数据包的源端口。
- en: The sixth flow is the packet sent as a response to a SYN packet, so the server
    sets the acknowledgment (ACK) flag. Because the server hasn't sent any packets
    in this TCP/IP conversation before, it also sets the SYN flag to request synchronization
    (commonly called the *SYN-ACK packet*).
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 第六个流是作为对SYN数据包的响应发送的数据包，因此服务器设置了确认（ACK）标志。因为服务器在此TCP/IP会话之前没有发送任何数据包，它还设置了SYN标志以请求同步（通常称为*SYN-ACK数据包*）。
- en: A second flow in one network transaction? Yep. Remember, a single flow shares
    the same source and destination IP addresses, among other things. You have one
    flow with a source address of the client and a second with the source address
    of the server. The source port of one flow matches the destination port of the
    other flow, permitting you to match the two together, but these are two separate
    flows. Flows let you determine how much traffic goes in each direction in any
    given transaction.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 一个网络事务中的第二个流？是的。记住，单个流共享相同的源和目的 IP 地址，以及其他一些内容。你有一个来自客户端的源地址和一个来自服务器的源地址的流。一个流的源端口与另一个流的目的端口相匹配，允许你将它们匹配起来，但这些都是两个独立的流。流让你能够确定在任何给定事务中每个方向的流量有多少。
- en: 'When the client receives the server''s response, it matches the incoming packet
    with the connection it''s trying to establish with that server. The client responds
    with a packet to the server from the assigned local port. The connection is now
    synchronized: Both the client and the server know the IP addresses involved in
    the connection and the port numbers on each side (as well as sequence numbers
    and other assorted characteristics that uniquely identify this connection). Because
    this packet is part of an existing connection, the SYN flag is not required. The
    client must acknowledge the SYN request the server included in its last packet,
    however, so this next packet includes the ACK flag.'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 当客户端收到服务器的响应时，它会将传入的数据包与它试图与该服务器建立的连接进行匹配。客户端向服务器发送一个从分配的本地端口发出的数据包。现在连接已经同步：客户端和服务器都知道连接中涉及的
    IP 地址以及每边的端口号（以及唯一标识此连接的序列号和其他一些特性）。然而，由于这个数据包是现有连接的一部分，因此不需要 SYN 标志。但是，客户端必须确认服务器在其最后的数据包中包含的
    SYN 请求，因此这个下一个数据包包括 ACK 标志。
- en: This packet from client to server might be the third in the transaction, but
    it's the second sent by the client to the server. It shares the source and destination
    IP addresses and port numbers of the first packet in the transaction, both of
    which are using the same IP protocol (TCP). This third packet is the second packet
    in the first flow. ([Figure 1-2](ch01s04.html#tcp_three-way_handshake_with_flow_member
    "Figure 1-2. TCP three-way handshake with flow memberships") illustrates this
    three-way handshake, noting the flows to which each packet is assigned.)
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 从客户端到服务器的这个数据包可能是事务中的第三个数据包，但它是由客户端发送给服务器的第二个数据包。它共享事务中第一个数据包的源和目的 IP 地址以及端口号，这两个数据包都使用相同的
    IP 协议（TCP）。这个第三个数据包是第一个流中的第二个数据包。（[图 1-2](ch01s04.html#tcp_three-way_handshake_with_flow_member
    "图 1-2. 带有流成员的 TCP 三次握手"）展示了这个三次握手，并指出每个数据包分配到的流。）
- en: '![TCP three-way handshake with flow memberships](httpatomoreillycomsourcenostarchimages651578.png.jpg)'
  id: totrans-75
  prefs: []
  type: TYPE_IMG
  zh: '![带有流成员的 TCP 三次握手](httpatomoreillycomsourcenostarchimages651578.png.jpg)'
- en: Figure 1-2. TCP three-way handshake with flow memberships
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 图 1-2. 带有流成员的 TCP 三次握手
- en: Now that a connection exists, the client may transmit actual data, such as an
    HTTP GET request. The GET request is part of the first flow, from client to server.
    The server's response, including any HTML, images, or error codes, becomes part
    of the second flow, from server to client. Packets now stream back and forth,
    including ACKs as required to acknowledge receipt of earlier packets.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 现在连接已经建立，客户端可以传输实际数据，例如 HTTP GET 请求。GET 请求是第一个流的一部分，从客户端到服务器。服务器的响应，包括任何 HTML、图像或错误代码，成为第二个流的一部分，从服务器到客户端。数据包现在来回流动，包括必要的
    ACK 以确认先前数据包的接收。
- en: At the end of the transaction, one side or the other sends a packet with the
    "finish" (FIN) flag set. This packet is called a *FIN request*, and it marks the
    end of the TCP/IP session. The other system sends an ACK and then a FIN of its
    own. The client sends an ACK to the final FIN, closing the connection. The flow
    sensor sees the FINs and ACKs, terminates both flows, and immediately transmits
    the TCP flow records to the collector.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 事务结束时，任一方发送一个设置了“完成” (FIN) 标志的数据包。这个数据包被称为 *FIN 请求*，它标志着 TCP/IP 会话的结束。另一系统发送一个
    ACK 然后发送它自己的 FIN。客户端向最后的 FIN 发送 ACK，关闭连接。流量传感器看到 FIN 和 ACK，终止两个流，并立即将 TCP 流记录传输到收集器。
- en: Other Protocols
  id: totrans-79
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 其他协议
- en: Flow management systems can track protocols other than ICMP, UDP, and TCP, but
    these three protocols comprise the overwhelming majority of network traffic. Your
    flow system will record traffic for protocols such as the AH and ESP protocols
    used for IPSec VPNs, but flows do not record the internal characteristics of this
    traffic.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 流量管理系统可以跟踪除ICMP、UDP和TCP之外的协议，但这三个协议构成了网络流量的绝大多数。你的流量系统将记录用于IPSec VPN的AH和ESP协议等协议的流量，但流量不会记录这种流量的内部特征。
- en: For these less common protocols, a flow system records the protocol, time, number
    of packets, and other vital flow information.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这些不太常见的协议，流量系统会记录协议、时间、数据包数量以及其他重要的流量信息。
- en: '* * *'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[1](#CHP-1-FN-1)]) Of course, the No Starch Press website is fully dynamic,
    interactive, and individually generated for each viewer by a sophisticated self-modifying
    artificial intelligence, and it doesn't have any simple "individual objects."
    You should check it out. Buy something while you're there.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[1](#CHP-1-FN-1)]) 当然，No Starch Press网站是完全动态的、交互式的，并且由一个复杂的自我修改人工智能为每个观众单独生成，它没有任何简单的“个体对象”。你应该去看看。在那里买些东西吧。
- en: Flow Export and Timeouts
  id: totrans-84
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 流量导出和超时
- en: Most medium to high-end routers and switches store flow data, but they don't
    necessarily provide a way for a human being to look at the flow data locally.
    Instead, to analyze flow records, you must first *export* the flow records from
    the hardware to a computer. Flow sensors export their records when the corresponding
    network activity is complete or when a timeout expires.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数中高端路由器和交换机存储流量数据，但它们并不一定提供一种让人类可以在本地查看流量数据的方法。相反，为了分析流量记录，你必须首先从硬件中将流量记录*导出*到计算机上。流量传感器在网络活动完成或超时到期时导出它们的记录。
- en: The exported record is not necessarily a complete TCP/IP session, however. For
    example, downloading an ISO image from an Internet site can take a very long time,
    and that session will probably be represented in several consecutive flow records.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 导出的记录不一定是完整的TCP/IP会话。例如，从互联网网站下载ISO镜像可能需要非常长的时间，而这个会话可能会在几个连续的流量记录中表示。
- en: Why break long-running sessions into multiple records? Suppose your router exported
    flow records only when each TCP/IP session finished. Now assume that one of your
    users started a large download likely to saturate your Internet connection for
    several hours. As the network administrator, you'll quickly get a call complaining
    that the Internet is really, really slow. To solve this problem, you'll want to
    identify what's happened on your network over the past few minutes, not just once
    the big download is complete. By breaking up the records of long-running connections
    into discrete flow records every few minutes, the router lets you view the data
    in close to real time. You can look at the flow records while this big download
    is still going on and identify the issue before it lasts all day. You can either
    shut down the offending user or, if the user is an executive or on the IT team,
    inform the caller the Internet will be slow for a while because of solar radiation
    interference and that they just have to wait.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么要把长时间运行的会话拆分成多个记录呢？假设你的路由器只在每个TCP/IP会话结束时导出流量记录。现在假设你的一个用户开始了一个可能需要几个小时才能耗尽你的互联网连接的大型下载。作为网络管理员，你很快会接到一个电话，抱怨互联网真的非常慢。为了解决这个问题，你将希望识别出过去几分钟内你网络上的情况，而不仅仅是当大下载完成时。通过将长时间运行的连接记录拆分成每几分钟一个的离散流量记录，路由器让你能够几乎实时地查看数据。你可以在这个大下载仍在进行时查看流量记录，并在问题持续一整天之前识别出问题。你可以关闭违规用户，或者如果用户是高管或IT团队成员，你可以通知打电话的人，由于太阳辐射干扰，互联网将暂时变慢，他们只需等待即可。
- en: Network hardware creates flow records based on a configured *timeout*, or the
    maximum amount of time the device can track an individual flow. When a particular
    connection lasts as long as the timeout, the device exports a flow record and
    creates a new record. For example, if your router had a one-minute flow timeout,
    it would export a record of the big download every minute. Although this record
    would not include the complete TCP session, you could look at your flow records
    and say, "During this minute, the biggest bandwidth user was this particular workstation
    downloading from this particular website." You have time to intervene if necessary.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 网络硬件根据配置的*超时时间*或设备跟踪单个流量的最大时间来创建流量记录。当一个特定连接持续的时间与超时时间相同，设备就会导出流量记录并创建一个新的记录。例如，如果你的路由器有一个一分钟的超时时间，它就会每分钟导出一次大下载的记录。尽管这个记录不会包括完整的TCP会话，但你可以通过查看你的流量记录来说，“在这分钟内，最大的带宽使用者是这台特定的工作站从这个特定的网站下载。”如果你需要，你有时间进行干预。
- en: Timeouts also help manage flow records for UDP, ICMP, and other non-TCP flows.
    The network device would create a flow record for each of these transactions.
    When the timeout expires, the device exports the flow record. Although a network
    device can't tell exactly when a UDP flow is finished, the timeout guarantees
    that the record of that is eventually exported.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 超时还有助于管理UDP、ICMP和其他非TCP流量的流量记录。网络设备将为这些交易中的每一个创建流量记录。当超时时间到期时，设备导出流量记录。尽管网络设备无法确切知道UDP流量何时结束，但超时保证了该记录最终会被导出。
- en: You can change the timeout to fit your needs. I'll discuss the reasons for doing
    so later in this book, but you should know that changing the timeout impacts system
    resources. Increasing the timeout increases the memory and CPU the device needs
    for flow tracking.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以更改超时时间以适应你的需求。我将在本书的后面部分讨论这样做的原因，但你应该知道更改超时时间会影响系统资源。增加超时时间会增加设备进行流量跟踪所需的内存和CPU。
- en: Packet-Sampled Flows
  id: totrans-91
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 数据包采样流量
- en: Flow export first appeared on routers with very limited hardware resources.
    On many of these devices, as interface bandwidths increased, tracking every packet
    required more horsepower than the router or tap could supply. Instead, the hardware
    *sampled* packets to create flow data, recording and exporting only a specified
    fraction of the traffic passing through the device. This flow data was necessarily
    incomplete.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 流量导出最初出现在硬件资源非常有限的路由器上。在这些设备中，随着接口带宽的增加，跟踪每个数据包所需的计算能力超过了路由器或分接器能够提供的。相反，硬件*采样*数据包来创建流量数据，只记录和导出通过设备的数据流中指定的一部分。这种流量数据必然是不完整的。
- en: Today, most hardware can track most or all flows going through a machine in
    most small and medium-sized environments.^([[2](#ftn.CHP-1-FN-2)]) Once you start
    to get into 10 gigabit networks, sampling 1 in 100 or 1 in 1,000 packets is the
    norm. As hardware capacity increases, we'll sample more fully, but bandwidth will
    increase similarly. Once terabit Ethernet becomes commonplace, I expect we'll
    have the capacity to perform flow capture on 10 gigabit Ethernet, if we'd even
    want that much data!
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 今天，大多数硬件可以在大多数小型和中型环境中跟踪通过机器的大部分或所有流量.^([[2](#ftn.CHP-1-FN-2)]) 一旦你开始进入10千兆网络，对每100个或每1000个数据包进行采样就成为了常态。随着硬件容量的增加，我们将进行更全面的采样，但带宽也会相应增加。一旦太比特以太网变得普遍，我预计我们将有在10千兆以太网上进行流量捕获的能力，即使我们真的需要那么多的数据！
- en: Should you sample your network flows or record all of them? If at all possible,
    you should record all traffic that passes through your network. You should sample
    only if your hardware cannot support complete flow tracking. Sampling some data
    is better than not having any data, but recording as much detail as possible is
    far more useful for troubleshooting.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该采样你的网络流量还是记录所有流量？如果可能的话，你应该记录通过你的网络的所有流量。只有当你的硬件无法支持完整的流量跟踪时，你才应该进行采样。采样一些数据比没有数据要好，但尽可能记录更多细节对于故障排除来说更有用。
- en: You should now have a good idea of how a flow system works, how its components
    fit together, and how to assemble a flow analysis system. Let's start with your
    flow-tools collector and your first sensor.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在应该对流量系统的工作方式、其组件如何组合以及如何组装流量分析系统有一个很好的了解。让我们从你的流量工具收集器和你的第一个传感器开始。
- en: '* * *'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[2](#CHP-1-FN-2)]) I had a conversation with one of the senior techs at the
    Internet Software Consortium (ISC) about its flow export system. The ISC samples
    from its multiple gigabit Internet uplinks. If you, like ISC, have an amount of
    bandwidth that can be described only as " You have *got* to be (bleep)ing kidding,"
    you'll probably need to sample as well.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[2](#CHP-1-FN-2)]) 我与互联网软件联盟（ISC）的一位资深技术专家就其流量导出系统进行了交谈。ISC 从其多个千兆比特的互联网上行链路中采样。如果你，像ISC一样，拥有的带宽只能用“你肯定是在开玩笑吧（哔哔）”来形容，你可能也需要进行采样。
