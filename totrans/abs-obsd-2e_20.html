<html><head></head><body><section class="chapter" epub:type="chapter" id="upgrading" title="Chapter&#xA0;20.&#xA0;Upgrading"><div class="titlepage"><div><div><h2 class="title">Chapter 20. Upgrading</h2></div></div></div><div class="epigraph" epub:type="epigraph"><div class="literallayout"><p><span class="emphasis"><em>The latest source code?</em></span><br/>
<span class="emphasis"><em>Fugu extraordinary!</em></span><br/>
<span class="emphasis"><em>Be brave and swallow.</em></span></p></div></div><p><span class="inlinemediaobject"><a id="inline_id00021"/><img alt="" src="httpatomoreillycomsourcenostarchimages1616079.png"/></span> Here’s an ugly truth: If upgrades are hard, sysadmins try their best to avoid them. And that can cause security problems. Operating system upgrades can cause software that has worked well for years to develop nervous tics or stop working altogether. Fixing add-on packages that don’t work on the new operating system version can require days of troubleshooting. Server upgrades can make even seasoned sysadmins wish that they had a simpler job, such as performing as a carnival sideshow, stuffing weasels into their trousers.</p><p>While you can probably deal with a bit of odd behavior in a desktop after an upgrade, your servers and firewalls must behave exactly as expected. It’s common to delay upgrades until the system is so old that it can be replaced with a new machine running the new release, but that’s both terrible system administration practice and completely unacceptable security practice. Computers connected to the Internet must be patched, maintained, and upgraded, or an intruder will almost certainly compromise them.</p><p><a class="indexterm" id="idx0317"/><a class="indexterm" id="idx1622"/><a class="indexterm" id="idx2072"/><a class="indexterm" id="idx2511"/><a class="indexterm" id="idx2594"/><a class="indexterm" id="idx2595"/>Fortunately, the OpenBSD upgrade process is simpler than those used by many other Unix-like operating systems. With proper preparation, you can upgrade OpenBSD with a minimum of difficulty.</p><div class="sect1" title="Why Upgrade?"><div class="titlepage"><div><div><h2 class="title" id="why_upgrade" style="clear: both">Why Upgrade?</h2></div></div></div><p>Because you don’t have a choice.</p><p>Security researchers, programmers, and skilled intruders continuously discover new ways to penetrate previously secure systems. Although OpenBSD has suffered only two vulnerabilities in a default installation that permitted an intruder to compromise the system, that doesn’t mean that a two-year-old OpenBSD version is secure.</p><p>The OpenBSD Project provides security updates for only the two most recent releases. For example, when OpenBSD 5.3 comes out, OpenBSD 5.1 will be “end-of-lifed” and lose support from developers. If someone figures out how to break into a default OpenBSD 5.1 installation after 5.3 comes out, the developers might not provide fixes. You might adjust new security patches to work on older versions of the code, but you will find that backporting fixes becomes increasingly difficult.</p><p>Software not enabled in the default installation can also have problems. For example, in November 2011, the OpenBSD Project released a patch for a problem in the included BIND <code class="literal">named(8)</code> name server. OpenBSD does not ship with <code class="literal">named</code> enabled, so this wasn’t a problem in the default installation, but it was certainly a security problem in a function that you might have chosen to enable.</p><p>In order to protect your system, you must understand how to apply security patches, either by applying the patch or by upgrading the entire system. But before we get to the upgrade process itself, let’s look at your choices for OpenBSD versions.</p></div><div class="sect1" title="OpenBSD Versions"><div class="titlepage"><div><div><h2 class="title" id="openbsd_versions" style="clear: both">OpenBSD Versions</h2></div></div></div><p>Developers all over the world continually make minor changes to OpenBSD’s source code. If you download the source code in the morning and again in the afternoon, you’ll get two slightly different versions. In fact, at any given time, you can get a few different versions of OpenBSD: <span class="emphasis"><em>-current</em></span>, <span class="emphasis"><em>snapshots</em></span>, <span class="emphasis"><em>releases</em></span>, and <span class="emphasis"><em>-stable</em></span>.</p><div class="sect2" title="OpenBSD-current"><div class="titlepage"><div><div><h3 class="title" id="openbsd-current">OpenBSD-current</h3></div></div></div><p>OpenBSD-current is the most recent development version of OpenBSD, containing code that is making its public debut. Developers test each other’s work and then get approval to commit code to the tree. Eventually, they must put their work out for the public to test, review, and debug.</p><p>OpenBSD-current is where the public can access the newest code. If a change would temporarily break web servers, games, database servers, or whatever is running on -current, but the change is for the long-term good, the change will go into -current. Those programs will probably work again before the next OpenBSD release, but there’s no requirement that every third-party program work perfectly at all times on -current.</p><div class="note" title="Note"><h3 class="title"><a id="ch20note01"/>Note</h3><p><a class="indexterm" id="idx1072"/><a class="indexterm" id="idx1947"/><a class="indexterm" id="idx2160"/><a class="indexterm" id="idx2599"/><a class="indexterm" id="idx2600"/>The developers expect -current itself to work at all times, and they consider breaks serious problems. You might need to recompile Firefox, or the port maintainer might need to rewrite a makefile, but the core operating system is expected to run at all times.</p></div><p>With these caveats, why would you possibly want to run -current? One excellent reason is to test the new OpenBSD in your environment. If today’s -current panics under certain conditions, but last week’s didn’t, the OpenBSD folks want to know that.</p><p>(All the OpenBSD folks run -current on their laptops, and they run firewalls on -current.) If you can exercise -current in the real world, with a real workload, they want you to do so. Having real users run -current is the only way that OpenBSD can be tested before the official releases come out.</p></div><div class="sect2" title="OpenBSD Snapshots"><div class="titlepage"><div><div><h3 class="title" id="openbsd_snapshots">OpenBSD Snapshots</h3></div></div></div><p>Every few days, the OpenBSD team uploads a release from the latest -current code to the mirror servers. This is an interim release called a <span class="emphasis"><em>snapshot</em></span>, which is identified only by the date of its release. A snapshot is simply the state of -current at a particular time. While the developers try not to build a snapshot on a day that -current is notably fouled up, guess who’s in charge of the snapshot quality-assurance process. That’s you.</p><p>Snapshots are provided for installation and testing convenience. Installing and testing a snapshot is easier than building -current on your own. Also, if you can reproduce a bug on a specific snapshot, the developers know exactly which version of the code you are running. It’s much easier to identify a problem as appeared “in the July 15 2013 snapshot” than in a -current you built yourself from “code downloaded from server X at about 3:17 <span class="smallcaps">PM</span> EST on July 15, 2013.”</p><div class="note" title="Note"><h3 class="title"><a id="ch20note02"/>Note</h3><p>Snapshots can contain uncommitted code not in -current. The patches for the changes are not usually available.</p></div><p>You can get snapshots installation media from any mirror site, in the <span class="emphasis"><em>/pub/OpenBSD/snapshots</em></span> directory. If you want to run -current, the recommended way to start is by installing the most recent snapshot you can get your hands on and upgrading from there.</p></div><div class="sect2" title="OpenBSD Releases"><div class="titlepage"><div><div><h3 class="title" id="openbsd_releases">OpenBSD Releases</h3></div></div></div><p>Every six months, the pace of OpenBSD development is deliberately slowed. Developers spend time polishing new features, and Theo makes increasingly forceful requests for beta testers of the newest snapshots. When the OpenBSD team is satisfied that the software is of adequate quality, the source code tree is tagged, and a high-quality snapshot is built. This snapshot is called a <span class="emphasis"><em>release</em></span> and is issued a number like 5.2, 5.3, and so on. This is almost certainly what you installed on your first OpenBSD machine. A new release appears every May and November.</p><p><a class="indexterm" id="idx2221"/><a class="indexterm" id="idx2601"/><a class="indexterm" id="idx2606"/>OpenBSD numbers releases sequentially, starting with 2.0 and incrementing .1 with every release. Unlike most software products, a .0 release has no special meaning. It’s just another spot along a long path—a milestone hit every five years.</p><p>The release is the best-supported version of OpenBSD. Everything is expected to work, and the development team stands behind its releases. If a serious security problem is discovered in a release, OpenBSD will release a patch, or <span class="emphasis"><em>errata</em></span>, for it.</p></div><div class="sect2" title="OpenBSD-stable"><div class="titlepage"><div><div><h3 class="title" id="openbsd-stable">OpenBSD-stable</h3></div></div></div><p>OpenBSD-stable is an OpenBSD release with all errata and very minor patches included. The developers deliberately hold the number of changes to each -stable version to the absolute bare minimum. A stable version is referred to as its base release plus -stable, such as 5.4-stable, 5.5-stable, and so on.</p><p>What sort of changes are merged back into -stable? Security fixes and errata go in automatically. Other than security issues, any patches added to -stable must be simple, short, and obviously correct. Patches that dramatically affect a small number of users might go in. For example, if all systems with a specific network card panic at random intervals, a patch might go into -stable (accompanied by various developers asking why no one with that network card ran snapshots before the release).</p><p>You won’t get new functions in -stable. It won’t come with any new device drivers or packet-filtering features. The API will not change. In general, -stable is expected to never get worse.</p><p>The only way to get OpenBSD-stable is to update the system from source.</p></div><div class="sect2" title="Which Version Should You Use?"><div class="titlepage"><div><div><h3 class="title" id="which_version_should_you_use">Which Version Should You Use?</h3></div></div></div><p>OpenBSD’s release system combines the best features of open source development and commercial releases. Users have access to both the bleeding-edge experimental code and the stable, polished releases. Look at your requirements and choose your poison.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>If you’re running OpenBSD in a production environment, either use a release with the applicable security errata or track -stable. The developers encourage more experienced users to use snapshots or -current, but that choice is up to you.</p></li><li class="listitem"><p>If you are evaluating OpenBSD for use in a production environment, install the version you intend to use.</p></li><li class="listitem"><p>If you’re just learning about Unix-like systems, or if you want a quiet OpenBSD experience, use a release and apply applicable errata.</p></li><li class="listitem"><p><a class="indexterm" id="idx0195"/><a class="indexterm" id="idx1567"/><a class="indexterm" id="idx1620"/><a class="indexterm" id="idx1627"/><a class="indexterm" id="idx1939"/><a class="indexterm" id="idx2510"/>If you’re an operating system developer or experienced sysadmin, feel free to jump right in to -current or snapshots. You can either handle any problems you encounter or use those problems as an excuse to expand your knowledge. Many people find that they can use -current in production, if they do not need packages. These are usually more experienced users who want firewalls.</p></li><li class="listitem"><p>Hobbyists can run anything they want!</p></li></ul></div><p>Remember the limitations of your chosen branch. A release is a good place to start, but you can gradually upgrade your system to -stable, and then to -current, as your understanding expands. Many developers started out as interested hobbyists.</p></div></div><div class="sect1" title="The OpenBSD Upgrade Process"><div class="titlepage"><div><div><h2 class="title" id="the_openbsd_upgrade_process" style="clear: both">The OpenBSD Upgrade Process</h2></div></div></div><p>An OpenBSD upgrade has three distinct phases: installing the newer versions of the operating system files, updating the local configuration, and updating obsolete add-on software packages. Each is a separate part that requires independent handling.</p><p>An upgrade requires installation media. The best upgrade media is the new release CD or an Internet mirror. You can also upgrade OpenBSD by building and installing the source code directly on the machine to be upgraded, but doing so is more difficult and risky than upgrading from the official release. Much of the information for upgrading from a network or CD applies to upgrading via source code.</p><div class="note" title="Note"><h3 class="title"><a id="ch20note03"/>Note</h3><p>OpenBSD supports upgrading only one major release at a time. You cannot upgrade directly from, say, 5.3 to 5.5; you must upgrade from 5.3 to 5.4, and then to 5.5. The more releases you need to upgrade through, the more reason to reinstall. You would spend more time serially upgrading three or four releases than you would reinstalling.</p></div><p>Before upgrading, back up any data you actually care about. The upgrade process extracts new files over the existing operating system, and could overwrite something important. The installer generally works, but human beings are fallible. Back up!</p><div class="sect2" title="Following the Upgrade Guide"><div class="titlepage"><div><div><h3 class="title" id="following_the_upgrade_guide">Following the Upgrade Guide</h3></div></div></div><p>As OpenBSD evolves, basic system features change. This wouldn’t be a big issue, except when interdependent changes create a chicken-and-egg or bootstrap problem. If you just blindly run the upgrade process and don’t handle any other required changes, you’ll find that your new system fails in unpredictable ways.<sup>[<a class="footnote" epub:type="noteref" href="#ftn.id310014" id="id310014">42</a>]</sup> If you’re building the system from source, these problems might prevent the build from completing.</p><p><a class="indexterm" id="idx0188"/><a class="indexterm" id="idx0836"/><a class="indexterm" id="idx1663"/><a class="indexterm" id="idx1851"/><a class="indexterm" id="idx2185"/>All of these potential problems should be solvable by anyone building the system from source, but it’s nice to have them documented. Conveniently, OpenBSD provides an <span class="emphasis"><em>Upgrade Guide</em></span> for each release, documenting the steps needed to take a system from one release to the next.</p><p>The <span class="emphasis"><em>Upgrade Guide</em></span> is divided into chunks by the type of upgrade you are performing. The simplest upgrade is for people using official OpenBSD files, such as a network or CD upgrade. If you’re building from source, the instructions quickly grow in complexity. Follow the instructions in the order in which they appear. Most upgrade prerequisites are typical system administration tasks. The following are the most common requirements.</p><div class="note" title="Note"><h3 class="title"><a id="ch20note04"/>Note</h3><p>Instructions in the <span class="emphasis"><em>Upgrade Guide</em></span> supersede anything I say in this chapter. I could just sprinkle the words “unless specified otherwise in the <span class="emphasis"><em>Upgrade Guide</em></span>” in every paragraph for the rest of this section, but then my editor would slap me. The OpenBSD documentation is the final word in OpenBSD system administration, including the upgrade process.</p></div><div class="sect3" title="Install Programs"><div class="titlepage"><div><div><h4 class="title" id="install_programs">Install Programs</h4></div></div></div><p>Especially when you are building from source, bootstrap tools such as <code class="literal">gcc(1)</code> and <code class="literal">perl(1)</code> might need to be built with the upgraded tool. When upgrading from source, you might need to install these bootstrap tools before beginning to compile the new version of OpenBSD. The <span class="emphasis"><em>Upgrade Guide</em></span> notes these requirements.</p><p>If your attempt to build OpenBSD from source fails, reread the <span class="emphasis"><em>Upgrade Guide</em></span> before troubleshooting. Starting from the closest available binary release or snapshot will probably solve your problem.</p></div><div class="sect3" title="Remove Programs and Files"><div class="titlepage"><div><div><h4 class="title" id="remove_programs_and_files">Remove Programs and Files</h4></div></div></div><p>OpenBSD removes programs from the base system when they become obsolete or dangerous, or when their functions are integrated into other programs. When you upgrade, you must manually remove these programs. This is necessary because old software left on an upgraded system can pose a security risk. Also, some files and directories might become superfluous in a new OpenBSD version. You can remove these programs, files, or directories once the upgrade is complete.</p></div><div class="sect3" title="Prepare Package Upgrades"><div class="titlepage"><div><div><h4 class="title" id="prepare_package_upgrades">Prepare Package Upgrades</h4></div></div></div><p>When you upgrade OpenBSD, you must upgrade the installed packages as well, because you can’t reliably run packages built for old versions of OpenBSD on newer versions. (Doing so <span class="emphasis"><em>might</em></span> work, but there’s no guarantee.) The <span class="emphasis"><em>Upgrade Guide</em></span> includes notes on upgrading specific installed packages, and you should take some of those actions before beginning the upgrade.</p><p>For example, the <span class="emphasis"><em>Upgrade Guide</em></span> for the newest OpenBSD version says that the PostgreSQL port had a major version upgrade. You must do a database dump and restore as part of the upgrade. The old version of PostgreSQL might not run well on the new OpenBSD, so perform the database dump before starting the system upgrade.</p><p><a class="indexterm" id="idx1568"/><a class="indexterm" id="idx2149"/><a class="indexterm" id="idx2504"/><a class="indexterm" id="idx2508"/>Your packages might not require any pre-upgrade work, but it’s much easier to check beforehand than to finish the operating system upgrade, and then need to fall back because you didn’t prepare some third-party package.</p></div><div class="sect3" title="System Configuration"><div class="titlepage"><div><div><h4 class="title" id="system_configuration">System Configuration</h4></div></div></div><p>The preceding tasks are the most common requirements for upgrading, but you might need to change other system files before or after the upgrade process itself. Read the <span class="emphasis"><em>Upgrade Guide</em></span>, or your programs might not run as expected.</p></div></div><div class="sect2" title="Customizing Upgrades"><div class="titlepage"><div><div><h3 class="title" id="customizing_upgrades-id00001">Customizing Upgrades</h3></div></div></div><p>The upgrade script supports the <span class="emphasis"><em>siteXX.tgz</em></span> file discussed in <a class="xref" href="ch23.html" title="Chapter 23. Customizing OpenBSD">Chapter 23</a>. If the file exists in the installation media, you can choose to install it during the upgrade.</p><p>You can also run a custom post-upgrade script as part of the upgrade. When the upgrade completes, the script checks for the file <span class="emphasis"><em>/upgrade.site</em></span>. If the upgrader finds this file, it executes this script as the last step of the upgrade. Copy <span class="emphasis"><em>/upgrade.site</em></span> to the system before starting the upgrade. <a class="xref" href="ch23.html" title="Chapter 23. Customizing OpenBSD">Chapter 23</a> discusses <span class="emphasis"><em>upgrade.site</em></span> in more detail.</p></div></div><div class="sect1" title="Upgrading from Official Media"><div class="titlepage"><div><div><h2 class="title" id="upgrading_from_official_media" style="clear: both">Upgrading from Official Media</h2></div></div></div><p>After reading the <span class="emphasis"><em>Upgrade Guide</em></span>, get your installation media for the new version of OpenBSD and boot from it. If you plan to upgrade over a network, you should need only the new installation kernel <span class="emphasis"><em>bsd.rd</em></span>. You can just grab this via FTP (or you could grab the entire directory along with it and run the upgrade from your local disk). Here, I grab the newest snapshot kernel from my root directory:</p><a id="I_programlisting20_id493010"/><pre class="programlisting"># <span class="strong"><strong>cd /</strong></span>
# <span class="strong"><strong>ftp ftp://ftp3.usa.openbsd.org/pub/OpenBSD/snapshots/amd64/bsd.rd</strong></span>
Connected to plier.ucar.edu.
…</pre><p>After you get the snapshot kernel, go to your console and boot into the new kernel.</p><a id="I_programlisting20_id493029"/><pre class="programlisting">&gt;&gt; OpenBSD/amd64 BOOT 3.18
boot&gt;  <span class="strong"><strong>boot bsd.rd</strong></span>
booting hd0a:bsd.rd: 2993636+916428+2864232+0+531344 [89+320016+207017]=0xb799f0
entry point at 0x1001e0 [7205c766, 34000004, 24448b12, a608a304]
…
root on rd0a swap on rd0b dump on rd0b
erase ^?, werase ^W, kill ^U, intr ^C, status ^T
Welcome to the OpenBSD/amd64 5.3 installation program.
(I)nstall, (U)pgrade or (S)hell? <span class="strong"><strong>U</strong></span></pre><p><a class="indexterm" id="idx0257"/><a class="indexterm" id="idx0840"/><a class="indexterm" id="idx0889"/><a class="indexterm" id="idx1481"/><a class="indexterm" id="idx1987"/><a class="indexterm" id="idx2509"/>Enter <span class="strong"><strong><code class="literal">U</code></strong></span> to upgrade. The upgrade process looks much like the installation process covered in <a class="xref" href="ch03.html" title="Chapter 3. Installation Walk-Through">Chapter 3</a>. Defaults appear inside square brackets. Accept the defaults by pressing <span class="smallcaps">ENTER</span>.</p><a id="I_programlisting20_id493117"/><pre class="programlisting">Terminal type? [vt220] <span class="strong"><strong>1</strong></span>
Available disks are: sd0 sd1 sd2.
Which one is the root disk? (or 'done') [sd0] <span class="strong"><strong>2</strong></span>
Root filesystem? [sd0a] <span class="strong"><strong>3</strong></span>
Checking root filesystem (fsck -fp /dev/sd0a)…OK.
Mounting root filesystem (mount -o ro /dev/sd0a /mnt)…OK.
Do you want to do any manual network configuration? [no] <span class="strong"><strong>4</strong></span>
Force checking of clean non-root filesystems? [no] <span class="strong"><strong>5</strong></span>
fsck -p e4bf0318329fe596.a…OK.
…</pre><p>Always use the default terminal, unless you know exactly when you shouldn’t. Commodity hardware usually uses vt220, as shown here at <span class="strong"><strong>1</strong></span>, but the default terminal is platform-specific.</p><p>The upgrade needs to read your root partition to learn where to install files. It can’t conclusively identify your actual root disk <span class="strong"><strong>2</strong></span> and partition <span class="strong"><strong>3</strong></span> unless you tell it to do that.</p><p>The upgrade script will configure your network according to the existing settings that you should hope are correct. If you need to adjust the network at every boot, the upgrade script gives you a chance to reconfigure the network at <span class="strong"><strong>4</strong></span>.</p><p>If you shut down the machine via <code class="literal">reboot</code> or <code class="literal">shutdown</code>, your filesystems should be clean. If you unceremoniously pulled the power plug because you were going to upgrade the machine and no longer cared about your filesystems, OpenBSD will notice and clean your filesystems. To deep-check clean filesystems, you can force running <code class="literal">fsck(8)</code> at <span class="strong"><strong>5</strong></span>. The upgrade script preens clean filesystems to check for obvious errors before proceeding.</p><div class="sect2" title="Upgrading Over the Network"><div class="titlepage"><div><div><h3 class="title" id="upgrading_over_the_network">Upgrading Over the Network</h3></div></div></div><p>The default upgrade method is CD. I want to do this upgrade over the network, so here’s how I continue:</p><a id="I_programlisting20_id493230"/><pre class="programlisting">Location of sets? (cd disk ftp http or 'done') [cd] ftp <span class="strong"><strong>1</strong></span>
HTTP/FTP proxy URL? (e.g. 'http://proxy:8080', or 'none') [none] <span class="strong"><strong>2</strong></span>
Server? (hostname, list#, 'done' or '?') [ftp5.usa.openbsd.org] <span class="strong"><strong>ftp3.usa.openbsd.org</strong></span> <span class="strong"><strong>3</strong></span>
Server directory? [pub/OpenBSD/snapshots/amd64] <span class="strong"><strong>4</strong></span>
Login? [anonymous] <span class="strong"><strong>5</strong></span></pre><p>I choose <code class="literal">ftp</code> as the location of the sets at <span class="strong"><strong>1</strong></span>. I don’t need to go through a proxy server to access the FTP server, so I leave that space blank at <span class="strong"><strong>2</strong></span>.</p><p><a class="indexterm" id="idx0590"/><a class="indexterm" id="idx0830"/>The default OpenBSD FTP server is perfectly fine, but if you’ve identified a really fast mirror, you might use that. I use my preferred mirror site at <span class="strong"><strong>3</strong></span>.</p><p>Every <span class="emphasis"><em>bsd.rd</em></span> installer knows the server directory to install from at <span class="strong"><strong>4</strong></span>. I change the server directory only if I have set up a local mirror. Similarly, every OpenBSD mirror permits anonymous FTP. I change the username and enter a password only if I’m using a local mirror at <span class="strong"><strong>5</strong></span>.</p></div><div class="sect2" title="Choosing File Sets"><div class="titlepage"><div><div><h3 class="title" id="choosing_file_sets-id00002">Choosing File Sets</h3></div></div></div><p>Next comes a chance to choose which sets to upgrade.</p><a id="I_programlisting20_id493357"/><pre class="programlisting">Select sets by entering a set name, a file name pattern or 'all'. De-select
sets by prepending a '-' to the set name, file name pattern or 'all'. Selected
sets are labelled '[X]'.
    [X] bsd           [X] base51.tgz    [X] game51.tgz    [X] xfont51.tgz
    [X] bsd.rd        [X] comp51.tgz    [X] xbase51.tgz   [X] xserv51.tgz
    [X] bsd.mp        [X] man51.tgz     [X] xshare51.tgz
Set name(s)? (or 'abort' or 'done') [done]</pre><p>You must upgrade every file set installed on your machine, or the machine will behave unpredictably. If you didn’t install some sets during your original installation, you don’t need to install them now. For most machines, I recommend installing all sets.</p><div class="note" title="Note"><h3 class="title"><a id="ch20note05"/>Note</h3><p>Notice that two sets are missing: <span class="emphasis"><em>etcXX.tgz</em></span> and <span class="emphasis"><em>xetcXX.tgz</em></span>. These files belong in <span class="emphasis"><em>/etc</em></span> and are legitimately edited by system administrators. The upgrade script cannot know if a file should be replaced, edited, or ignored. You must update <span class="emphasis"><em>/etc</em></span> yourself.</p></div><p>The upgrade script downloads and extracts the selected file sets, and then asks you to verify that you’re finished selecting file sets. If so, it remakes all your device nodes to fit with the new kernel.</p><p>At this point, you can reboot into your new OpenBSD userland except that userland might not work quite right because you haven’t updated <span class="emphasis"><em>/etc</em></span> yet.</p></div></div><div class="sect1" title="Updating /etc"><div class="titlepage"><div><div><h2 class="title" id="updating_etc" style="clear: both">Updating /etc</h2></div></div></div><p>The <span class="emphasis"><em>/etc</em></span> directory contains system and program configuration information. When a program changes, its configuration file might also change. If you try to run a new program with an obsolete configuration file, the program will not run correctly.</p><p>You absolutely must update <span class="emphasis"><em>/etc</em></span> before running your system—arguably the most annoying part of an upgrade. No automated process can possible know how your system should behave. Only you can know that, which means that you must compare the contents of your existing <span class="emphasis"><em>/etc</em></span> to the same files in a new, stock <span class="emphasis"><em>/etc</em></span>. OpenBSD provides tools to make the process less annoying.</p><p>Before you begin, if your system performs complicated functions, such as a database or packet filtering, boot into single-user mode. (Although single-user mode is not strictly necessary, I’ve had software behave badly during a half-completed upgrade, so I now routinely update <span class="emphasis"><em>/etc</em></span> in single-user mode.)</p><a id="I_programlisting20_id493454"/><pre class="programlisting">&gt;&gt; OpenBSD/amd64 BOOT 3.19
boot&gt; <span class="strong"><strong>boot -s</strong></span>
booting hd0a:/bsd: 5687720+1608588+939456+0+644288 [80+502320+325975]=0xd43b98
…
Enter pathname of shell or RETURN for sh:
#</pre><p><a class="indexterm" id="idx0591"/><a class="indexterm" id="idx0851"/><a class="indexterm" id="idx1401"/><a class="indexterm" id="idx2310"/><a class="indexterm" id="idx2507"/>While I’m a long-time <code class="literal">tcsh</code> user,<sup>[<a class="footnote" epub:type="noteref" href="#ftn.id427066" id="id427066">43</a>]</sup> I always use the default shell in single-user mode. If you want to use an alternate shell, it must be statically linked and available on the root partition.</p><div class="sect2" title="Mounting Filesystems"><div class="titlepage"><div><div><h3 class="title" id="mounting_filesystems">Mounting Filesystems</h3></div></div></div><p>Now mount all your filesystems. If you upgraded via the network, start the network now.</p><a id="I_programlisting20_id493547"/><pre class="programlisting"># <span class="strong"><strong>mount -a</strong></span>
# <span class="strong"><strong>/bin/sh /etc/netstart</strong></span>
WARNING: inconsistent config - check /etc/sysctl.conf for IPv6 autoconf
#</pre><p>I’ve hardly begun, and here’s a warning already. How fantastic! Perhaps this IPv6 error is from the upgrade, or maybe it’s a lingering misconfiguration I never noticed before. Either way, this is a good time to identify and fix the problem.</p><p>Verify that you’re on the network by pinging a couple of hosts.</p><p>You need the files <span class="emphasis"><em>etcXX.tgz</em></span> and <span class="emphasis"><em>xetcXX.tgz</em></span> for your new release. If you have the CD, the files are in the release directory. If not, fetch them over the network. (I always get these file sets from the same server I upgraded from, just to eliminate any chance of a difference in the files.)</p><a id="I_programlisting20_id493585"/><pre class="programlisting"># <span class="strong"><strong>cd /tmp</strong></span>
# <span class="strong"><strong>ftp ftp://ftp3.usa.openbsd.org/pub/OpenBSD/snapshots/amd64/etc51.tgz</strong></span>
# <span class="strong"><strong>ftp ftp://ftp3.usa.openbsd.org/pub/OpenBSD/snapshots/amd64/xetc51.tgz</strong></span></pre><p>You are now ready to update <span class="emphasis"><em>/etc</em></span>.</p></div><div class="sect2" title="Using sysmerge(8) to Compare /etc Files"><div class="titlepage"><div><div><h3 class="title" id="using_sysmerge8_to_compare_etc_files">Using sysmerge(8) to Compare /etc Files</h3></div></div></div><p>The <code class="literal">sysmerge(8)</code> program compares your existing <span class="emphasis"><em>/etc</em></span> to the <span class="emphasis"><em>/etc</em></span> in the installation set, points out differences, and lets you replace your installed file with the new one, keep your file, or merge the two.</p><p>Use <code class="literal">-s</code> to tell <code class="literal">sysmerge</code> where the new <span class="emphasis"><em>etcXX.tgz</em></span> file is, and <code class="literal">-x</code> to point to the new <span class="emphasis"><em>xetcXX.tgz</em></span>. I put both of these files in <span class="emphasis"><em>/tmp</em></span>.</p><a id="I_programlisting20_id493666"/><pre class="programlisting"># <span class="strong"><strong>sysmerge -s /tmp/etc51.tgz -x /tmp/xetc51.tgz</strong></span></pre><p><code class="literal">sysmerge</code> will handle the easy changes itself, but leave you to take care of files that need your intervention.</p><div class="sect3" title="Easy sysmerge Updates"><div class="titlepage"><div><div><h4 class="title" id="easy_sysmerge_updates">Easy sysmerge Updates</h4></div></div></div><p>If your system is only lightly modified, you should see something like this:</p><a id="I_programlisting20_id493696"/><pre class="programlisting">===&gt; Populating temporary root under /var/tmp/sysmerge.daiHKukKfE/temproot
===&gt; Starting comparison
===&gt; Updating /etc/inetd.conf
===&gt; Updating /etc/login.conf
…</pre><p>I haven’t changed these files, so <code class="literal">sysmerge</code> automatically updates them for me.</p><a id="I_programlisting20_id493709"/><pre class="programlisting">…
===&gt; Installing /etc/nginx/fastcgi_params
===&gt; Installing /etc/nginx/koi-utf
…</pre><p>I didn’t have these files on my system, so <code class="literal">sysmerge</code> installs them for me.</p><p>These examples are easy cases. In cases where you’ve edited an <span class="emphasis"><em>/etc</em></span> file, <code class="literal">sysmerge</code> will need your help.</p></div><div class="sect3" title="sysmerge and Edited Files"><div class="titlepage"><div><div><h4 class="title" id="sysmerge_and_edited_files">sysmerge and Edited Files</h4></div></div></div><p>Say you’ve edited a file, and the file version has changed. Does your local change reflect the update, does it conflict, or can the two coexist? <code class="literal">sysmerge</code> can’t tell if it should overwrite the installed file with a new version, leave it unchanged, or merge the two, so it displays the differences between the old and new files.</p><a id="I_programlisting20_id493756"/><pre class="programlisting">  ===&gt; Displaying differences between ./etc/mail/aliases and installed version:
<span class="strong"><strong>1</strong></span> --- /etc/mail/aliases   Sun Jun  9 04:50:04 2013
<span class="strong"><strong>2</strong></span> +++ ./etc/mail/aliases  Wed Oct 23 17:06:02 2013
  @@ -1,5 +1,5 @@
   #
<span class="strong"><strong>3</strong></span> -#      $OpenBSD: aliases,v 1.36 2010/09/22 13:01:10 deraadt Exp $
<span class="strong"><strong>4</strong></span> +#      $OpenBSD: aliases,v 1.37 2012/10/13 07:42:39 dcoppa Exp $
   #
   #  Aliases in this file will NOT be expanded in the header from
   #  Mail, but WILL be visible over networks or from /usr/libexec/mail.local.
  @@ -32,6 +32,7 @@
   _identd: /dev/null
   _iked: /dev/null
   _isakmpd: /dev/null
<span class="strong"><strong>5</strong></span> +_iscsid: /dev/null
   _kadmin: /dev/null
   _kdc: /dev/null
   _ldapd: /dev/null
  @@ -69,7 +70,7 @@
   sshd:   /dev/null
   # Well-known aliases -- these should be filled in!
<span class="strong"><strong>6</strong></span> -root: mwlucas@blackhelicopters.org
<span class="strong"><strong>7</strong></span> +# root:
   # manager:
   # dumper:</pre><p>If you’ve changed the file, <code class="literal">sysmerge</code> presents the differences between the old and new files with a few surrounding lines of context. In this example, the <span class="emphasis"><em>/etc/mail/aliases</em></span> file on my system is dated June 9 at <span class="strong"><strong>1</strong></span>, and the new version is from October 23 at <span class="strong"><strong>2</strong></span>. Lines that exist in the new version of the file but not in the installed one are prefaced with a plus sign (<code class="literal">+</code>). Lines that exist in the installed file but not in the new one are prefaced with a minus sign (<code class="literal">-</code>).</p><p>This example shows that the OpenBSD version of this file changed from 1.36 at <span class="strong"><strong>3</strong></span> to 1.37 at <span class="strong"><strong>4</strong></span>. That’s not terribly surprising, and for system administration purposes, not a terribly vital piece of information. But the new version has a new alias, directing email addressed to the user <code class="literal">_iscsid</code> to <span class="emphasis"><em>/dev/null</em></span> at <span class="strong"><strong>5</strong></span>. This could be important, so I want the new alias on my system.</p><p>Next, we see a difference between the files, where I’ve forwarded email addressed to root to my personal email at <span class="strong"><strong>6</strong></span>, but the new version of the file has no such redirection at <span class="strong"><strong>7</strong></span>. I want the old version of this line but the new version of another line, and while I don’t particularly care about the OpenBSD version numbers, I would prefer the newer one. I could hand assemble an aliases file, but after <code class="literal">sysmerge</code> prints out the differences, it offers to help.</p><a id="I_programlisting20_id493897"/><pre class="programlisting"><span class="strong"><strong>1</strong></span> Use 'd' to delete the temporary ./etc/mail/aliases
<span class="strong"><strong>2</strong></span> Use 'i' to install the temporary ./etc/mail/aliases
<span class="strong"><strong>3</strong></span> Use 'm' to merge the temporary and installed versions
<span class="strong"><strong>4</strong></span> Use 'v' to view the diff results again
   Default is to leave the temporary file to deal with by hand
  How should I deal with this? [Leave it for later] <span class="strong"><strong>m</strong></span></pre><p><code class="literal">sysmerge</code> offers the following choices:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>If I delete the temporary aliases file, <code class="literal">sysmerge</code> throws away the new file <span class="strong"><strong>1</strong></span>. This is fine if my existing aliases file is adequate, but in this case, I want part of the new file.</p></li><li class="listitem"><p>If I install the temporary aliases file, I overwrite my changes <span class="strong"><strong>2</strong></span>. Unless I go back in and change the aliases file again, my custom mail forwarding will stop working. I don’t want this to happen.</p></li><li class="listitem"><p><a class="indexterm" id="idx1354"/>I can merge the old and new files <span class="strong"><strong>3</strong></span>, choosing the best fit from each file, which is the option I’ll pick.</p></li><li class="listitem"><p>I could look at the differences again <span class="strong"><strong>4</strong></span>. This has the advantage of putting off an actual decision.</p></li></ul></div><p>To merge the old and new files, I enter <span class="strong"><strong><code class="literal">m</code></strong></span>. Note that the merge function requires close attention to detail. A mistake here can make your system hang as it tries to go into multiuser mode.</p><p>When you merge, <code class="literal">sysmerge</code> takes your input and builds a combined file. Lines that are identical in both versions are automatically added to the new file. When lines differ, <code class="literal">sysmerge</code> walks you through the differences and lets you choose a version.</p><p>The new version of the line appears on the right, and the installed version is on the left. Enter <span class="strong"><strong><code class="literal">l</code></strong></span> or <span class="strong"><strong><code class="literal">1</code></strong></span> to choose the version on the left side, or <span class="strong"><strong><code class="literal">r</code></strong></span> or <span class="strong"><strong><code class="literal">2</code></strong></span> to choose the version on the right.</p><a id="I_programlisting20_id494059"/><pre class="programlisting"># $OpenBSD: aliases,v 1.36 2010/09/22 13:01:10 de | # $OpenBSD: aliases,v 1.37 2012/10/13 07:42:39 dc
%<span class="strong"><strong>r</strong></span></pre><p>The version number has updated, though it’s in a comment, which won’t affect how the alias file updates. Still, as I’m merging the files anyway, I might as well get the new version number. I enter <span class="strong"><strong><code class="literal">r</code></strong></span> to choose the version on the right.</p><a id="I_programlisting20_id494081"/><pre class="programlisting">                               &gt; _iscsid: /dev/null
%<span class="strong"><strong>r</strong></span></pre><p>There is no equivalent to this line in the installed file, as this alias exists only in the new file. Again, I choose <span class="strong"><strong><code class="literal">r</code></strong></span> to include this line in my file.</p><a id="I_programlisting20_id494101"/><pre class="programlisting">root: mwlucas@blackhelicopters.org    | # root:
%<span class="strong"><strong>l</strong></span></pre><p>Here, I want the entry from the installed file, on the left-hand side. I choose <span class="strong"><strong><code class="literal">l</code></strong></span>.</p><p>Once I’ve gone through all of the entries, <code class="literal">sysmerge</code> offers me more choices. These include comparing the merged and installed files, comparing the merged and new files, starting over, viewing the merged file, redoing the merge, and installing the merged file.</p><a id="I_programlisting20_id494130"/><pre class="programlisting">  Use 'e' to edit the merged file
  Use 'i' to install the merged file
  Use 'n' to view a diff between the merged and new files
  Use 'o' to view a diff between the old and merged files
  Use 'r' to re-do the merge
  Use 'v' to view the merged file
  Use 'x' to delete the merged file and go back to previous menu
  Default is to leave the temporary file to deal with by hand
===&gt; How should I deal with the merged file? [Leave it for later] <span class="strong"><strong>i</strong></span></pre><p><a class="indexterm" id="idx1649"/><a class="indexterm" id="idx1666"/><a class="indexterm" id="idx1811"/><a class="indexterm" id="idx1935"/><a class="indexterm" id="idx2311"/><a class="indexterm" id="idx2506"/>I did everything correctly, so I install the merged file (although I should probably view the merged file first, and then install it).</p><p>My biggest difficulty with <code class="literal">sysmerge</code> comes in differentiating my left and my right. Worse, the L key is on the right side, and the R key is on the left. (Go ahead now, laugh, but just wait until you mix that up.)</p></div><div class="sect3" title="Finishing sysmerge"><div class="titlepage"><div><div><h4 class="title" id="finishing_sysmerge">Finishing sysmerge</h4></div></div></div><p>When <code class="literal">sysmerge</code> finishes installing the files, it checks the permissions on the <span class="emphasis"><em>/etc</em></span> files, and tells you where to find the log and that the system might need a reboot. A purist might tell you that you don’t need to reboot, but usually you should go ahead and do it. Rebooting after changing core system files prevents a variety of problems, and rebooting as part of an upgrade isn’t unreasonable. You can wait to reboot until after you upgrade your packages, as long as everything works.</p><a id="I_programlisting20_id494224"/><pre class="programlisting">…
===&gt; Comparison complete
===&gt; Checking directory hierarchy permissions (running mtree(8))
===&gt; Output log available at /var/tmp/sysmerge.daiHKukKfE/sysmerge.log
        *** WARNING: some new/updated file(s) may require a reboot
# <span class="strong"><strong>reboot</strong></span></pre><p>You now have an updated OpenBSD base system. Be aware that new or changed files can change system behavior, but usually you won’t notice. The <span class="emphasis"><em>Upgrade Guide</em></span> usually notes any changes average users are likely to notice. Still, only you know what your system does and how you want it to behave.</p><p>Upgrading your installed packages is a separate task.</p></div></div></div><div class="sect1" title="Updating Installed Packages"><div class="titlepage"><div><div><h2 class="title" id="updating_installed_packages" style="clear: both">Updating Installed Packages</h2></div></div></div><p>Packages run reliably only on the version of OpenBSD for which they’re compiled. If you’re using packages, then updating your third-party software is very easy. (If you build your own software from the ports collection, you can still update but it won’t be as easy.)</p><p>First, check the <span class="emphasis"><em>Upgrade Guide</em></span> again. It describes any intrusive changes to major software. Take any actions it recommends before continuing.</p><div class="sect2" title="Updating the Package Repository"><div class="titlepage"><div><div><h3 class="title" id="updating_the_package_repository">Updating the Package Repository</h3></div></div></div><p>Before upgrading your packages, check your <code class="literal">$PKG_PATH</code> environment variable. It almost certainly references the package directory for your previous version of OpenBSD.</p><a id="I_programlisting20_id494290"/><pre class="programlisting"># <span class="strong"><strong>echo $PKG_PATH</strong></span>
ftp://ftp11.usa.openbsd.org/pub/OpenBSD/5.2/packages/i386/</pre><p><a class="indexterm" id="idx0406"/><a class="indexterm" id="idx1360"/><a class="indexterm" id="idx1653"/><a class="indexterm" id="idx1805"/><a class="indexterm" id="idx2484"/>Find the package repository for your new version of OpenBSD. You can probably just update the release number in your shell’s dotfile, but go to the mirror site and make sure that the packages for that release are present.</p><p>If you upgrade from release to release, you can use the <code class="literal">uname(1)</code> command to set your <code class="literal">PKG_PATH</code> in your dotfile. For example, if <span class="emphasis"><em>ftp11.usa.openbsd.org</em></span> is your favorite mirror site, use a line like this for <code class="literal">sh</code>-based dotfiles.</p><a id="I_programlisting20_id494364"/><pre class="programlisting">export PKG_PATH=ftp://ftp11.usa.openbsd.org/pub/OpenBSD/`uname -r`/packages/`uname -m'/</pre></div><div class="sect2" title="Using the Upgrade Command"><div class="titlepage"><div><div><h3 class="title" id="using_the_upgrade_command">Using the Upgrade Command</h3></div></div></div><p>To upgrade your installed packages, use <code class="literal">pkg_add</code> with the <code class="literal">-i</code> and <code class="literal">-u</code> flags.</p><a id="I_programlisting20_id494393"/><pre class="programlisting"># <span class="strong"><strong>pkg_add -iu</strong></span>
quirks-1.73-&gt;1.77: ok
apr-1.4.6-&gt;1.4.6p0: ok
apr-util-1.4.1-ldap:cyrus-sasl-2.1.25p3-&gt;2.1.25p3: ok
apr-util-1.4.1-ldap:openldap-client-2.4.31-&gt;2.4.31: ok
apr-util-1.4.1-ldap:libiconv-1.14-&gt;1.14: ok
…</pre><p>The <code class="literal">-i</code> flag tells <code class="literal">pkg_add</code> to work in interactive mode and ask you about any ambiguities. The <code class="literal">-u</code> flag means “update.”</p><p>This upgrader recurses through each of your add-on software packages and its dependencies, uninstalling the old version and installing the new. If you want to see more verbose and detailed messages about the package-updating process, add the <code class="literal">-v</code> flag.</p><div class="sect3" title="Package Options"><div class="titlepage"><div><div><h4 class="title" id="package_options">Package Options</h4></div></div></div><p>If the dependencies for a package have changed and you now have multiple options, <code class="literal">pkg_add</code> presents your choices.</p><a id="I_programlisting20_id494446"/><pre class="programlisting">Ambiguous: choose dependency for foomatic-db-engine-4.0.8p2:
 a       0: curl-7.26.0
         1: wget-1.13.4
Your choice: <span class="strong"><strong>1</strong></span></pre><p>The package <code class="literal">foomatic-db-engine</code> can use either <code class="literal">curl</code> or <code class="literal">wget</code>. Of the two, I prefer <code class="literal">wget</code>, so I enter <code class="literal">1</code>. Pressing <span class="smallcaps">ENTER</span> tells <code class="literal">pkg_add</code> to use the default.</p></div><div class="sect3" title="Package Messages"><div class="titlepage"><div><div><h4 class="title" id="package_messages">Package Messages</h4></div></div></div><p>Once all of the packages have been updated, <code class="literal">pkg_add</code> displays any messages from the upgraded packages.</p><a id="I_programlisting20_id494508"/><pre class="programlisting">Read shared items: ok
You may wish to update your font path for /usr/local/share/ghostscript/fonts
Look in /usr/local/share/doc/pkg-readmes for extra documentation.
…</pre><p><a class="indexterm" id="idx0218"/><a class="indexterm" id="idx1590"/>Some of the installation instructions will tell you to clear out cached files from the older version of the software, as in this CUPS example.</p><a id="I_programlisting20_id494540"/><pre class="programlisting">--- -cups-1.5.3p4 -------------------
You should also run rm -rf /var/log/cups/*
You should also run rm -rf /var/cache/cups
You should also run rm -rf /var/spool/cups
…</pre><p>Other times, software might jump versions. For example, OpenBSD lets you install multiple versions of PHP, Python, and other scripting languages, but after upgrading, you must decide which is your preferred default.</p><a id="I_programlisting20_id494550"/><pre class="programlisting">--- +python-2.7.3p1 -------------------
If you want to use this package as your default system python, as root
create symbolic links like so (overwriting any previous default):
 ln -sf /usr/local/bin/python2.7 /usr/local/bin/python
 ln -sf /usr/local/bin/python2.7-2to3 /usr/local/bin/2to3
 ln -sf /usr/local/bin/python2.7-config /usr/local/bin/python-config
 ln -sf /usr/local/bin/pydoc2.7  /usr/local/bin/pydoc
…</pre><p>You may also need to change some system configuration after an upgrade.</p><a id="I_programlisting20_id494560"/><pre class="programlisting">--- +tk-8.5.12 -------------------
You may wish to add /usr/local/lib/tcl/tk8.5/man to /etc/man.conf
…</pre><p>The package maintainers put these messages into the package for your benefit. Read them, and if you’re in doubt, follow their instructions.</p><p>If all of your software is installed via packages, the upgrade process should be painless and transparent. I would like to tell you about all the problems and edge cases, except I’ve never been able to trigger any. Upgrading packages from the official release media just works. Packages built from the ports tree, however, are more complicated to upgrade, as I discuss in <a class="xref" href="ch20.html#upgrading_ports" title="Upgrading Ports">Upgrading Ports</a>.</p></div></div></div><div class="sect1" title="Why Build Your Own OpenBSD?"><div class="titlepage"><div><div><h2 class="title" id="why_build_your_own_openbsd" style="clear: both">Why Build Your Own OpenBSD?</h2></div></div></div><p>Building your own upgrade from OpenBSD’s source is intended only for advanced users and those interested in developing OpenBSD and advanced users. You must be comfortable reading and compiling source code, debugging problems, and restoring from backup before even trying to build OpenBSD from source. In OpenBSD’s earlier days, I found upgrading from source to be the easiest way to move forward, but now upgrading via snapshot is much easier and much less error-prone. If there’s any way you can use an official binary release to install what you’re looking for, do so.</p><p><a class="indexterm" id="idx0114"/><a class="indexterm" id="idx0217"/><a class="indexterm" id="idx0310"/><a class="indexterm" id="idx1589"/>When you build OpenBSD from source, you are building the distribution sets that you installed via FTP or CD. The files might not be bundled up in distributions, but their contents will be the same. You still must merge your configuration files with <code class="literal">sysmerge</code>, and you will still need to update your installed software. The only thing building OpenBSD gets you is the latest version of the branch you’re following.</p><p>I know of three reasons to build your own OpenBSD from source: to get OpenBSD-stable, to get the latest OpenBSD-current, or to highly customize OpenBSD. OpenBSD-stable is available only as source code. No official installation media is available for -stable, so if you want to go from 5.4-release to 5.4-stable, you must build it from source. If you want the absolutely latest OpenBSD code—newer than the latest snapshot—you must build it. And if you want to highly customize OpenBSD, you must build it from source.</p></div><div class="sect1" title="Preparations for Building Your Own OpenBSD"><div class="titlepage"><div><div><h2 class="title" id="preparations_for_building_your_own_openb" style="clear: both">Preparations for Building Your Own OpenBSD</h2></div></div></div><p>Building OpenBSD takes up about 4GB of disk, 2GB in <span class="emphasis"><em>/usr/src</em></span> and 2GB in <span class="emphasis"><em>/usr/obj</em></span>. OpenBSD creates these directories as separate partitions by default, but if you designed your own disk-partition scheme, make sure you have enough space.</p><p>You must build on your target platform. Don’t try to cross-compile by, for example, building VAX binaries on an amd64 box. OpenBSD developers use cross-compiling to bring up a new hardware platform, but once the platform is up and running, all development happens on the native hardware. Code produced by cross-compiling might not be identical to code produced by the compiler running on the native platform.</p><div class="sect2" title="Preparing the Base Operating System"><div class="titlepage"><div><div><h3 class="title" id="preparing_the_base_operating_system">Preparing the Base Operating System</h3></div></div></div><p>Your first step is to prepare the base operating system. You can build OpenBSD on only an OpenBSD installation similar to what you’re trying to build, which means you need to install the closest binary set to your target platform on your build machine. If you’re trying to build OpenBSD 5.4-stable, start by installing 5.4-release on your build machine. If you’re trying to build the latest OpenBSD-current, upgrade your build machine to the newest snapshot first.</p><p>Why start from the closest available binary release? For one, that’s how the OpenBSD developers do it; the code is meant to be built from a very recent OpenBSD. Although the system changes only slowly, those changes can add up. OpenBSD-stable is built only on the OpenBSD release it’s based on, or on a -stable release following that base release.</p><p>Also, OpenBSD-current occasionally has “flag days,” where a critical system change makes building the source code difficult. These might be compiler or linker upgrades, library or kernel changes, or just about anything else. While the OpenBSD team documents what you need to do to get over these humps, those documents are more like notes for people who know what they’re doing than user-friendly instructions.</p><p><a class="indexterm" id="idx0216"/><a class="indexterm" id="idx0273"/><a class="indexterm" id="idx0319"/><a class="indexterm" id="idx1143"/><a class="indexterm" id="idx1818"/><a class="indexterm" id="idx1849"/><a class="indexterm" id="idx2161"/><a class="indexterm" id="idx2200"/><a class="indexterm" id="idx2209"/><a class="indexterm" id="idx2223"/><a class="indexterm" id="idx2314"/><a class="indexterm" id="idx2540"/><a class="indexterm" id="idx2561"/><a class="indexterm" id="idx2565"/><a class="indexterm" id="idx2570"/><a class="indexterm" id="idx2577"/><a class="indexterm" id="idx2578"/><a class="indexterm" id="idx2597"/><a class="indexterm" id="idx2603"/><a class="indexterm" id="idx2674"/><a class="indexterm" id="idx2694"/>These flag days are announced on the OpenBSD mailing lists. You can try to follow those notes and build OpenBSD over these barriers, but when you get sick of beating your head against a flag-day change, upgrade to a snapshot to get over the hump. (Many OpenBSD developers also use snapshots to get over flag-day changes; inability to compile OpenBSD through a flag day is not a threat to your manhood or womanhood.)</p></div><div class="sect2" title="Getting Source Code"><div class="titlepage"><div><div><h3 class="title" id="getting_source_code">Getting Source Code</h3></div></div></div><p>Now get the OpenBSD source code. If you have already installed these files, and you need to upgrade to a more recent version, see <a class="xref" href="ch20.html#updating_source_code" title="Updating Source Code">Updating Source Code</a>.</p><p>For those installing the source code for the first time, the OpenBSD project provides recent code snapshots in four compressed tar files: the userland (<span class="emphasis"><em>src.tar.gz</em></span>), kernel (<span class="emphasis"><em>sys.tar.gz</em></span>), X Windows (<span class="emphasis"><em>xenocara.tar.gz</em></span>), and ports (<span class="emphasis"><em>ports.tar.gz</em></span>). All must be kept synchronized, which means that you cannot use a -current ports tree atop a -stable userland and kernel. Get the file that’s closest to what you want to build.</p><p>If you’re building -stable, you can grab all four files from the release directory of the binary you installed. For example, if you’re building OpenBSD 5.4-stable, you’ll find <span class="emphasis"><em>src.tar.gz</em></span>, <span class="emphasis"><em>sys.tar.gz</em></span>, <span class="emphasis"><em>xenocara.tar.gz</em></span>, and <span class="emphasis"><em>ports.tar.gz</em></span> on your CD or on an OpenBSD mirror under <span class="emphasis"><em>/pub/OpenBSD/5.4/</em></span>.</p><p>If you’re building -current, you’re better off starting with a newer snapshot of the source code. On the OpenBSD mirror sites, under <span class="emphasis"><em>/pub/OpenBSD</em></span>, you’ll find recent copies of <span class="emphasis"><em>src.tar.gz</em></span> and <span class="emphasis"><em>sys.tar.gz</em></span>. Grab the most recent ones of those. You still need the <span class="emphasis"><em>xenocara.tar.gz</em></span> and <span class="emphasis"><em>ports.tar.gz</em></span> files from the most recent OpenBSD release, as those files are not updated as frequently.</p><p>Verify that the directories <span class="emphasis"><em>/usr/src</em></span>, <span class="emphasis"><em>/usr/obj</em></span>, <span class="emphasis"><em>/usr/xenocara</em></span>, <span class="emphasis"><em>/usr/xobj</em></span>, and <span class="emphasis"><em>/usr/ports</em></span> are empty. Then extract <span class="emphasis"><em>src.tar.gz</em></span> and <span class="emphasis"><em>sys.tar.gz</em></span> under <span class="emphasis"><em>/usr/src</em></span>, and Xenocara and <span class="emphasis"><em>ports</em></span> directly under <span class="emphasis"><em>/usr</em></span>. Here, I’ve copied all the tarballs to my home directory:</p><a id="I_programlisting20_id494995"/><pre class="programlisting"># <span class="strong"><strong>cd /usr/src</strong></span>
# <span class="strong"><strong>tar -xzpf $HOME/src.tar.gz</strong></span>
# <span class="strong"><strong>tar -xzpf $HOME/sys.tar.gz</strong></span>
# <span class="strong"><strong>cd /usr</strong></span>
# <span class="strong"><strong>tar -xzpf $HOME/ports.tar.gz</strong></span>
# <span class="strong"><strong>tar -xzpf $HOME/xenocara.tar.gz</strong></span></pre><p>This gives you a known good base to start from. If you’re looking to build your own OpenBSD, you probably don’t want to build a version that’s available for installation now; you want to build a version that’s not available for installation. This means you want to update the source code to either -current or -stable.</p></div><div class="sect2" title="Updating Source Code"><div class="titlepage"><div><div><h3 class="title" id="updating_source_code">Updating Source Code</h3></div></div></div><p><a class="indexterm" id="idx0277"/><a class="indexterm" id="idx0340"/><a class="indexterm" id="idx1837"/><a class="indexterm" id="idx1958"/><a class="indexterm" id="idx2199"/><a class="indexterm" id="idx2206"/><a class="indexterm" id="idx2224"/><a class="indexterm" id="idx2366"/><a class="indexterm" id="idx2604"/><a class="indexterm" id="idx2665"/><a class="indexterm" id="idx2679"/><a class="indexterm" id="idx2692"/><a class="indexterm" id="idx2696"/>OpenBSD uses Concurrent Versions System (CVS) for source code management. CVS is an older, somewhat traditional version control system. While many projects have moved from CVS to newer, shinier, and perhaps more glamorous systems, CVS meets the OpenBSD Project’s needs.</p><p>OpenBSD has a single central source-code repository: the master CVS server. Only developers and mirror sites have access to this server. When a developer wants to make new OpenBSD code available, he <span class="emphasis"><em>commits</em></span> the changes to this central repository, and other developers can see his changes at this point.</p><p>The master CVS server tracks all changes ever made to the OpenBSD source, as well as who made those changes. Mirror sites capture these changes and make them available to the users in a matter of hours. As a user, you can use CVS to update your local source code to the latest version from a mirror site.</p><div class="sect3" title="Source Code Repositories and Tags"><div class="titlepage"><div><div><h4 class="title" id="source_code_repositories_and_tags">Source Code Repositories and Tags</h4></div></div></div><p>OpenBSD’s source code is divided into <span class="emphasis"><em>repositories</em></span>, or collections of code for particular subsystems. You need to download and synchronize only the collections that you want to use.</p><p>The OpenBSD CVS repository includes four collections: <code class="literal">src</code> (userland and kernel source), <code class="literal">ports</code> (the ports collection), <code class="literal">xenocara</code> (X Windows), <code class="literal">www</code> (the website), and the obsolete <code class="literal">X11</code> and <code class="literal">XF4</code> X Windows collections. While X11 and XF4 are still kept for historical purposes, you should never need to use that code. The <code class="literal">www</code> repository is of interest to the website editors and contributors. In order to build a recent OpenBSD, you must update your <code class="literal">src</code>, <code class="literal">ports</code>, and <code class="literal">xenocara</code> collections to the latest versions of your chosen branch.</p><p>A <span class="emphasis"><em>tag</em></span> is a label for a particular version of a repository. OpenBSD uses tags to differentiate between -stable, -release, and -current. For example, the source code of every single OpenBSD release ever made includes the file <span class="emphasis"><em>/usr/src/etc/master.passwd</em></span>. But the version of <span class="emphasis"><em>master.passwd</em></span> shipped with OpenBSD 2.0 differs wildly from that shipped with OpenBSD 5.3! CVS uses tags to differentiate the various versions of this and every other file. By using tags, you can ask CVS for the version of any file that shipped with any OpenBSD release.</p><p>The tag for any -stable version of OpenBSD is the string <code class="literal">OPENBSD</code> and the version number, separated by underscores. For example, the tag for OpenBSD 5.4 is <code class="literal">OpenBSD_5_4</code>. Note the two underscores: there is no <code class="literal">OPENBSD_54</code> or <code class="literal">OPENBSD5_4</code>. If you use a tag that does not exist, rather than updating your local source code files, you’ll delete them. (While you should download the source code for a release, rather than updating to it via CVS, an OpenBSD release appends the string <code class="literal">_BASE</code> to the tag, as in <code class="literal">OPENBSD-5_4_BASE</code>.) That said, OpenBSD-current is special in that it has no tag and it includes the latest version of all source code in all repositories.</p><p><a class="indexterm" id="idx0059"/><a class="indexterm" id="idx0278"/><a class="indexterm" id="idx0341"/><a class="indexterm" id="idx1374"/><a class="indexterm" id="idx2225"/><a class="indexterm" id="idx2605"/>All of the repositories are designed to be updated synchronously. If, for example, you update the source code repository to -current and leave your ports and Xenocara at their -release or -stable versions, your system will behave unpredictably. As with learning to juggle chainsaws, you’re welcome to try it, but don’t whine.</p></div><div class="sect3" title="CVS Mirrors"><div class="titlepage"><div><div><h4 class="title" id="cvs_mirrors">CVS Mirrors</h4></div></div></div><p>You can use anonymous CVS to update your source code to the latest version. Start by choosing a convenient anonymous CVS server from the list at <span class="emphasis"><em><a class="ulink" href="http://www.OpenBSD.org/anoncvs.html" target="_top">http://www.OpenBSD.org/anoncvs.html</a></em></span>. There are mirrors all over the world, but choose one on your continent for better performance. (I use <span class="emphasis"><em>anoncvs13.usa.openbsd.org</em></span><sup>[<a class="footnote" epub:type="noteref" href="#ftn.id444809" id="id444809">44</a>]</sup> in my examples.)</p><p>Tracking OpenBSD-current is slightly different than tracking OpenBSD-stable. We’ll start with -stable, and then see how -current differs.</p></div><div class="sect3" title="Updating to -stable"><div class="titlepage"><div><div><h4 class="title" id="updating_to_stable">Updating to -stable</h4></div></div></div><p>The first time you update your source code, you must specify the anonymous CVS server on the command line.</p><a id="I_programlisting20_id495430"/><pre class="programlisting"># <span class="strong"><strong>cd /usr</strong></span>
# <span class="strong"><strong>cvs -qd anonymous@<span class="emphasis"><em>server</em></span>:/cvs get -r<span class="emphasis"><em>OPENBSD_tag</em></span> -P src</strong></span></pre><p>CVS is very picky about the order of its command-line arguments, and many flags are position-dependent. Don’t change the order of arguments unless you know what you’re doing.</p><p>Substitute your preferred server and the release tag you want to get into this command. For example, to update my OpenBSD 5.1 source tree to the latest stable version from <span class="emphasis"><em>anoncvs13.openbsd.org</em></span>, I would run the following:</p><a id="I_programlisting20_id495466"/><pre class="programlisting">  # <span class="strong"><strong>cd /usr</strong></span>
  # <span class="strong"><strong>cvs -qd anonymous@anoncvs13.openbsd.org:/cvs get -rOPENBSD_5_1 -P src</strong></span>
  The authenticity of host 'anoncvs13.usa.openbsd.org (192.0.2.217)' can't be established.
<span class="strong"><strong>1</strong></span> ECDSA key fingerprint is d3:b2:b5:68:87:3b:f6:93:21:fd:28:ea:cc:b6:e1:13.
  Are you sure you want to continue connecting (yes/no)? yes
  Warning: Permanently added 'anoncvs1.usa.openbsd.org,149.20.54.217' (ECDSA) to the list of known hosts.</pre><p>Because OpenBSD runs CVS over SSH the first time you run <code class="literal">cvs</code>, it asks you to verify the CVS mirror’s host key. Compare the <span class="strong"><strong>1</strong></span> key fingerprint given by your client to the fingerprint listed on the CVS mirror list. If they match, you’re talking to the actual CVS server. If the fingerprints don’t match, something is wrong, which could be a problem at the server, a skipped website update, or an actual security problem at the mirror. If the key fingerprints don’t match, choose a different CVS mirror. (SSH will cache this key, and future updates won’t ask you to verify the key unless it changes.)</p><p><a class="indexterm" id="idx0320"/><a class="indexterm" id="idx2222"/><a class="indexterm" id="idx2598"/><a class="indexterm" id="idx2602"/>There’s a pause when CVS starts comparing the source code on your disk to the source code on the server, and just about when you think that something has gone wrong, you’ll probably see actual source code updates, like this:</p><a id="I_programlisting20_id495552"/><pre class="programlisting">U bin/systrace/intercept-translate.c
U lib/libssl/src/crypto/mem.c
U lib/libssl/src/crypto/asn1/a_d2i_fp.c
U lib/libssl/src/crypto/buffer/buffer.c
U sys/conf/newvers.sh
U sys/netinet6/ip6_output.c
U usr.sbin/nsd/query.c</pre><p>This is complete CVS update output for updating OpenBSD 5.1 release to -stable. In all, there were seven changes. When the OpenBSD guys say “minimal changes in -stable,” they mean it.</p><p>Repeat this for <span class="emphasis"><em>/usr/ports</em></span> and <span class="emphasis"><em>/usr/xenocara</em></span>.</p><a id="I_programlisting20_id495573"/><pre class="programlisting"># <span class="strong"><strong>cd /usr</strong></span>
# <span class="strong"><strong>cvs -qd anonymous@anoncvs13.openbsd.org:/cvs get -rOPENBSD_5_1 -P ports</strong></span>
# <span class="strong"><strong>cvs -qd anonymous@anoncvs13.openbsd.org:/cvs get -rOPENBSD_5_1 -P xenocara</strong></span></pre><p>A source tree records the last server updated from, and on subsequent updates, you can drop the server from the command line. The source tree also knows which repository within the server it’s supposed to update from, so you don’t need to specify it.</p><a id="I_programlisting20_id495600"/><pre class="programlisting"># <span class="strong"><strong>cd /usr/src</strong></span>
# <span class="strong"><strong>cvs -q up -rOPENBSD_5_1 -Pd</strong></span></pre><p>Run this same command any time you want the latest -stable source code.</p></div><div class="sect3" title="Updating to -current"><div class="titlepage"><div><div><h4 class="title" id="updating_to_current">Updating to -current</h4></div></div></div><p>The process for updating your source code to -current is much the same as updating to -stable, but the command line differs slightly. The first time you update your source tree, you must specify the server name.</p><a id="I_programlisting20_id495634"/><pre class="programlisting"># <span class="strong"><strong>cd /usr</strong></span>
# <span class="strong"><strong>cvs -qd anonymous@<span class="emphasis"><em>server</em></span>:/cvs get -P src</strong></span></pre><p>This <code class="literal">cvs</code> command gives you the latest -current source code. For example, if I want to update my source code from <span class="emphasis"><em>anoncvs13.openbsd.org</em></span>, I run this:</p><a id="I_programlisting20_id495664"/><pre class="programlisting"># <span class="strong"><strong>cd /usr</strong></span>
# <span class="strong"><strong>cvs -qd anonymous@anoncvs13.openbsd.org:/cvs get -P src</strong></span></pre><p><a class="indexterm" id="idx1158"/>You should get the SSH key fingerprint verification message, and see the same type of messages that you would get updating to -stable.</p><p>The first time you run CVS to update a specific set of source code, <code class="literal">cvs</code> records which server the source code came from. For subsequent updates to the latest -current source code, you can skip the server name and shorten the command, as follows:</p><a id="I_programlisting20_id495701"/><pre class="programlisting"># <span class="strong"><strong>cd /usr/src</strong></span>
# <span class="strong"><strong>cvs -q up -Pd</strong></span></pre><p>Now you need to build the new source code into program code.</p><p>You build -stable and -current in the same way, but -current has more potential issues, so we’ll start by building -stable.</p></div></div></div><div class="sect1" title="Building OpenBSD-stable"><div class="titlepage"><div><div><h2 class="title" id="building_openbsd-stable" style="clear: both">Building OpenBSD-stable</h2></div></div></div><p>Building OpenBSD-stable requires building and installing a new kernel, building and installing a new userland, and building and installing the new Xenocara.</p><div class="sect2" title="Upgrading the Kernel"><div class="titlepage"><div><div><h3 class="title" id="upgrading_the_kernel">Upgrading the Kernel</h3></div></div></div><p>Building an upgraded kernel is like building a custom kernel, as discussed in <a class="xref" href="ch19.html" title="Chapter 19. Building Custom Kernels">Chapter 19</a>. Basically, the process boils down to this:</p><a id="I_programlisting20_id495756"/><pre class="programlisting"># <span class="strong"><strong>cd /usr/src/sys/arch/<span class="emphasis"><em>platform</em></span>/conf/</strong></span>
# <span class="strong"><strong>config GENERIC</strong></span>
# <span class="strong"><strong>cd ../compile/GENERIC</strong></span>
# <span class="strong"><strong>make clean &amp;&amp; make</strong></span>
# <span class="strong"><strong>make install</strong></span></pre><p>(If I planned to build OpenBSD regularly on this machine, I would script this.)</p><div class="note" title="Note"><h3 class="title"><a id="ch20note06"/>Note</h3><p><a class="xref" href="ch19.html" title="Chapter 19. Building Custom Kernels">Chapter 19</a> is full of warnings about difficulties compiling a custom kernel. These don’t apply to building the <span class="emphasis"><em>GENERIC</em></span> kernel on -stable. Remember that -stable includes only security fixes and obviously correct small changes. ABI, API, configuration, and syntax changes are absolutely forbidden. If this kernel build fails, you probably corrupted your source tree somehow. Remove everything in <span class="emphasis"><em>/usr/src</em></span> and start over.</p></div><p>After building and installing the new kernel, reboot. You must run the new kernel to build the new userland.</p></div><div class="sect2" title="Building the Userland"><div class="titlepage"><div><div><h3 class="title" id="building_the_userland">Building the Userland</h3></div></div></div><p><a class="indexterm" id="idx1948"/><a class="indexterm" id="idx2312"/><a class="indexterm" id="idx2539"/><a class="indexterm" id="idx2673"/><a class="indexterm" id="idx2688"/>To build and install everything outside the kernel, remove any old builds and re-create the object directories. Also, make sure that the installed OpenBSD system has all of the necessary directories. Skipping this step will make the build fail and corrupt your source tree.</p><a id="I_programlisting20_id495883"/><pre class="programlisting"># <span class="strong"><strong>rm -rf /usr/obj/*</strong></span>
# <span class="strong"><strong>cd /usr/src</strong></span>
# <span class="strong"><strong>make obj</strong></span>
# <span class="strong"><strong>cd /usr/src/etc</strong></span>
# <span class="strong"><strong>env DESTDIR=/ make distrib-dirs</strong></span></pre><p>Now you can build and install the userland.</p><a id="I_programlisting20_id495918"/><pre class="programlisting"># <span class="strong"><strong>cd /usr/src</strong></span>
# <span class="strong"><strong>make build</strong></span></pre><p>Building userland can take several days on an antique system, but should take only an hour or two on more modern hardware. When the process finishes, you should have the new userland installed on the local system.</p><div class="note" title="Note"><h3 class="title"><a id="ch20note07"/>Note</h3><p>Installing -stable simplifies the userland part of the upgrade. There’s no need to merge any new <span class="emphasis"><em>/etc/</em></span> files with <code class="literal">sysmerge</code> (but there’s no harm in running <code class="literal">sysmerge</code> either, just to check that your configuration is indeed valid), or to re-create your device nodes, as they won’t change. OpenBSD-stable contains very minor changes from the release on which it’s based.</p></div></div><div class="sect2" title="Building Xenocara"><div class="titlepage"><div><div><h3 class="title" id="building_xenocara">Building Xenocara</h3></div></div></div><p>The X Window System might or might not change during -stable. If your CVS update shows no changes in -stable, you don’t need to rebuild it, but if any of the files in <span class="emphasis"><em>/usr/xenocara</em></span> have changed, you’re better off rebuilding X. The build process is completely routine for Xenocara-stable.</p><a id="I_programlisting20_id495979"/><pre class="programlisting"># <span class="strong"><strong>cd /usr/xenocara</strong></span>
# <span class="strong"><strong>rm -rf /usr/xobj/*</strong></span>
# <span class="strong"><strong>make bootstrap</strong></span>
# <span class="strong"><strong>make obj</strong></span>
# <span class="strong"><strong>make build</strong></span></pre><p>This builds and installs the new X on your system.</p></div><div class="sect2" title="Building a Release"><div class="titlepage"><div><div><h3 class="title" id="building_a_release">Building a Release</h3></div></div></div><p>This is all very nice if you want to upgrade only one machine. But what if you have several machines to upgrade to your custom OpenBSD build? You don’t want to go building -stable on your firewalls or your web server.</p><p><a class="indexterm" id="idx0416"/><a class="indexterm" id="idx0451"/><a class="indexterm" id="idx1278"/><a class="indexterm" id="idx1945"/><a class="indexterm" id="idx1949"/><a class="indexterm" id="idx2397"/>If you need to upgrade multiple machines, build your OpenBSD on one machine, and install that build on multiple machines by building your own <span class="emphasis"><em>release</em></span>. This will take less time than you needed to build your upgrade and use under a gigabyte of disk space.</p><p>A release is what the OpenBSD Project puts on the mirror sites for you to install. It’s a few kernels, tarballs containing the userland files, the index file, and so on. Using these files, you can upgrade your other hosts just as you would perform the official media upgrade discussed earlier this chapter. Building a release is the easiest way to upgrade several OpenBSD hosts to identical versions.</p><p>Before you can build a release, you must build both the base OpenBSD system and Xenocara. You could skip Xenocara if you don’t want any X on any of your hosts, but a surprising number of third-party programs need the X libraries. It’s easier to build X and not install it on selected hosts than to go back and rebuild the whole release because you didn’t build Xenocara the first time.</p><p>The release process installs OpenBSD in a temporary root directory and then bundles that installation into the release tarballs and related files. Next, it repeats the process with the X software. It assumes that you have the OpenBSD source code in <span class="emphasis"><em>/usr/src</em></span> and a completed build in <span class="emphasis"><em>/usr/obj</em></span>, as well as the Xenocara source in <span class="emphasis"><em>/usr/xenocara</em></span> and a completed build in <span class="emphasis"><em>/usr/xobj</em></span>. You can change the build process to get around these requirements, as documented in <code class="literal">release(8)</code>, but you should accept the defaults.</p><p>You’ll need to define three directories: one to store your release, one for your temporary OpenBSD root directory, and one for your temporary Xenocara root directory. You can reuse the temporary root directories, but I keep them for reference. I use <span class="emphasis"><em>/home/releasedir</em></span> as my release directory, <span class="emphasis"><em>/home/destdir</em></span> as my temporary OpenBSD root, and <span class="emphasis"><em>/home/xdestdir</em></span> as the Xenocara temporary root.</p><div class="warning" epub:type="warning" title="Warning"><h3 class="title"><a id="ch20note08"/>Warning</h3><p>You can use any partition with sufficient free space, except for <span class="emphasis"><em>/mnt</em></span> because the release process uses this partition. Similarly, building a release builds ISO and floppy images using the first <code class="literal">vnode</code> device, <span class="emphasis"><em>/dev/vnd0</em></span>. If you have any disk images mounted using that device (see <a class="xref" href="ch09.html" title="Chapter 9. More Filesystems">Chapter 9</a>), the release process will fail. If you must mount a disk image while building a release, use a <code class="literal">vnode</code> device other than <span class="emphasis"><em>/dev/vnd0</em></span>.</p></div><p>The release process has three steps: bundling the base system, bundling Xenocara, and indexing the results.</p><div class="sect3" title="Bundling the Base System"><div class="titlepage"><div><div><h4 class="title" id="bundling_the_base_system">Bundling the Base System</h4></div></div></div><p>OpenBSD’s build system includes all of the glue that you need to build a release. First, do a <code class="literal">make build</code> of your new OpenBSD so that you’re running the same version you want to build a release for. Next, define the temporary OpenBSD root and the release directory in your environment as <code class="literal">$DESTDIR</code> and <code class="literal">$RELEASEDIR</code>, respectively.</p><div class="note" title="Note"><h3 class="title"><a id="ch20note09"/>Note</h3><p><a class="indexterm" id="idx0417"/><a class="indexterm" id="idx1944"/><a class="indexterm" id="idx1946"/><a class="indexterm" id="idx2689"/>Verify that the temporary OpenBSD root and the release directories are empty before you start. While the release process can overwrite files from an old build, the directories might have obsolete files that you don’t want included in the new release.</p></div><a id="I_programlisting20_id496262"/><pre class="programlisting"># <span class="strong"><strong>echo $DESTDIR</strong></span>
/home/destdir
# <span class="strong"><strong>echo $RELEASEDIR</strong></span>
/home/releasedir</pre><p>Once you have this ready, building the release involves only a few commands.</p><a id="I_programlisting20_id496281"/><pre class="programlisting"># <span class="strong"><strong>cd /usr/src/etc &amp;&amp; make release</strong></span>
# <span class="strong"><strong>cd /usr/src/distrib/sets &amp;&amp; sh checkflist</strong></span></pre><p>Take a look in your release directory. You should see the following items:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Three kernels (<span class="emphasis"><em>bsd</em></span>, <span class="emphasis"><em>bsd.mp</em></span>, and <span class="emphasis"><em>bsd.rd</em></span>)</p></li><li class="listitem"><p>Three floppy boot images if you’re building for i386, or one if it’s for amd64 (other architectures vary)</p></li><li class="listitem"><p>Two ISO images</p></li><li class="listitem"><p>Five file sets for the OpenBSD base system</p></li></ul></div><p>These files are functionally identical to those distributed by the OpenBSD project, except they’re based on your custom build.</p><p>Once you’ve finished building releases, be sure to remove the <code class="literal">$RELEASEDIR</code> and <code class="literal">$DESTDIR</code> variables from your environment because they can mess up other software builds. You can’t successfully build Xenocara with them still set.</p></div><div class="sect3" title="Bundling Xenocara"><div class="titlepage"><div><div><h4 class="title" id="bundling_xenocara">Bundling Xenocara</h4></div></div></div><p>As with bundling the base system, you must first complete a Xenocara build. Confirm that your system has the same version of Xenocara installed that you want included in your release, and then set the <code class="literal">RELEASEDIR</code> and <code class="literal">DESTDIR</code> environment variables. <code class="literal">RELEASEDIR</code> should be identical to that used to bundle the base system, but <code class="literal">DESTDIR</code> should differ.</p><div class="note" title="Note"><h3 class="title"><a id="ch20note10"/>Note</h3><p>You could reuse <code class="literal">DESTDIR</code>, but that will erase everything from your temporary base system installation. Leave those files around until you’re sure you have a solid release.</p></div><a id="I_programlisting20_id496397"/><pre class="programlisting"># <span class="strong"><strong>echo $DESTDIR</strong></span>
/home/xdestdir
# <span class="strong"><strong>echo $RELEASEDIR</strong></span>
/home/releasedir</pre><p>Now go into the Xenocara source and bundle the release.</p><a id="I_programlisting20_id496416"/><pre class="programlisting"># <span class="strong"><strong>cd /usr/xenocara</strong></span>
# <span class="strong"><strong>make release</strong></span></pre><p><a class="indexterm" id="idx0318"/><a class="indexterm" id="idx1027"/><a class="indexterm" id="idx1950"/><a class="indexterm" id="idx1951"/><a class="indexterm" id="idx2596"/>Xenocara isn’t much smaller than the base system. It takes a while to bundle up, so this is a good time to go to lunch.  When you get back, you should find five new files in your release directory, all tarballs beginning with <span class="emphasis"><em>x</em></span>.</p><p>Before you quit for the day, remove <code class="literal">RELEASEDIR</code> and <code class="literal">DESTDIR</code> from your environment.</p></div><div class="sect3" title="Indexing the Release"><div class="titlepage"><div><div><h4 class="title" id="indexing_the_release">Indexing the Release</h4></div></div></div><p>Copy your release to your local FTP or web server, and create an index of the contents. (Only HTTP installs and upgrades need an index file.) The OpenBSD installer and upgrade software will use this index during the installation.</p><a id="I_programlisting20_id496506"/><pre class="programlisting"># <span class="strong"><strong>/bin/ls -l &gt; index.txt</strong></span></pre><p>Make the web or FTP site accessible from the machines you want to upgrade.</p></div></div><div class="sect2" title="Using the Release"><div class="titlepage"><div><div><h3 class="title" id="using_the_release">Using the Release</h3></div></div></div><p>Upgrade or install using this release just as you would use an official release. Copy <span class="emphasis"><em>bsd.rd</em></span> to a machine to be upgraded, and then boot into that kernel. When the installer asks where to get the file sets, give the location of your release. Extract and reboot!</p></div></div><div class="sect1" title="Building OpenBSD-current"><div class="titlepage"><div><div><h2 class="title" id="building_openbsd-current" style="clear: both">Building OpenBSD-current</h2></div></div></div><p>Building OpenBSD-current is exactly like building -stable, except when it isn’t. OpenBSD-current can change wildly, and building it from source is considered an advanced activity. The only time I actually build -current is if I need to test some new functionality or a patch offered by an OpenBSD developer.</p><p>The two big problems are the radical changes in -current and merging <span class="emphasis"><em>/etc</em></span>.</p><div class="sect2" title="Following -current"><div class="titlepage"><div><div><h3 class="title" id="following_current">Following -current</h3></div></div></div><p>When you follow -current, keep a close eye on OpenBSD’s changes by tracking the Following -current web page at <span class="emphasis"><em>http://www.OpenBSD.org/faq/current.html</em></span>. This is where the OpenBSD developers list all of the changes likely to impact people trying to build -current. Not all changes apply to all systems, but any change listed that applies to your system requires special handling.</p><p><a class="indexterm" id="idx0588"/><a class="indexterm" id="idx1292"/><a class="indexterm" id="idx1355"/><a class="indexterm" id="idx1828"/>The entries are chronological, and include everything since the last release. Just concern yourself with entries dated on or after the date of the source code used to build your snapshot. For example, if you built a snapshot dated January 30, and you want to build -current on the following February 5, check the web page for any entries between those two dates, inclusive. Earlier changes are already incorporated in the installed snapshot.</p><p>Some changes will require your intervention before you even try to build the system. For example, if you have new unprivileged usernames, they will need to be in place before a <code class="literal">make build</code> can succeed—after all, a program owned by user <code class="literal">_fdisk</code> can’t be installed unless that user is in place.</p><p>If you don’t understand an entry on this page, do not upgrade!</p></div><div class="sect2" title="Merging /etc"><div class="titlepage"><div><div><h3 class="title" id="merging_etc">Merging /etc</h3></div></div></div><p>When you upgrade to a new -stable, you can be sure that the files in <span class="emphasis"><em>/etc/</em></span> haven’t changed. When you track -current, those critical system files might well change. Any critical changes are usually noted in the Following -current website, but it’s best to use <code class="literal">sysmerge(8)</code> to merge in all <span class="emphasis"><em>/etc</em></span> changes. You can give <code class="literal">sysmerge</code> the path to the system source instead of the <span class="emphasis"><em>etc.tgz</em></span> file set.</p><a id="I_programlisting20_id496676"/><pre class="programlisting"># <span class="strong"><strong>sysmerge -s /usr/src</strong></span></pre><p>See the section about <code class="literal">sysmerge</code> earlier in this chapter for detailed information.</p></div></div><div class="sect1" title="Upgrading Ports"><div class="titlepage"><div><div><h2 class="title" id="upgrading_ports" style="clear: both">Upgrading Ports</h2></div></div></div><p>If you use OpenBSD-provided packages, upgrading your system is as easy as running <code class="literal">pkg_add -ui</code>. If you built your third-party packages from source using the ports collection, however, there’s no easy way to upgrade. You must rebuild those packages. There is no automated way to do this, but the <code class="literal">make update</code> command in a port can rebuild a specific port.</p><p>Presumably, you built your own packages because the OpenBSD-provided packages lacked some option or flavor you needed. In that case, you probably only needed to build one or two packages from source. All of the software required by that package could be installed from official OpenBSD sources. You should upgrade everything possible via packages and rebuild only what is strictly necessary.</p><p>Now that you can upgrade OpenBSD any way you want, let’s look at OpenBSD’s packet filter.</p></div><div class="footnotes" epub:type="footnotes"><br/><hr style="width: 100; align: left;"/><div class="footnote" epub:type="footnote" id="ftn.id310014"><p><sup>[<a class="para" href="#id310014">42</a>] </sup>Henning Brauer tells me that many upgrade failures aren’t really unpredictable; they’re merely “unsupported and untested” code paths. To most of us, that’s “unpredictable,” but you’re welcome to predict them yourself.</p></div><div class="footnote" epub:type="footnote" id="ftn.id427066"><p><sup>[<a class="para" href="#id427066">43</a>] </sup>I know, I know, your shell is superior to mine. I was given tcsh as my first shell almost 30 years ago, and my fingers are too habituated to it to change. I’ll concede your superiority if you’ll stop telling me about it.</p></div><div class="footnote" epub:type="footnote" id="ftn.id444809"><p><sup>[<a class="para" href="#id444809">44</a>] </sup>Again, there is no <span class="emphasis"><em>anoncvs13.usa.openbsd.org</em></span>. Find a server close to you. Stop blindly copying my examples. It’s like you think I know what I’m doing or something!</p></div></div></section></body></html>