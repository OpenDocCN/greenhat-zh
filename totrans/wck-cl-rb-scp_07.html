<html><head></head><body>
  <div class="sgc-1" id="filepos559796"/>&#13;
&#13;
  <h1 class="calibre1" id="calibre_pb_348"><span class="calibre2"><a class="calibre7" shape="rect"/>Chapter 7. SERVERS AND SCRAPERS</span></h1>&#13;
&#13;
  <div class="calibre3"><a class="calibre17" shape="rect"/><img alt="SERVERS AND SCRAPERS" class="calibre23" src="../Images/00001.jpg"/></div>&#13;
&#13;
  <p class="calibre4">A powerful aspect of Ruby is that you can use it to develop ways to automate interactions with resources on the Web. This chapter gives a brief overview of how to play with web pages and concludes with a set of client/server scripts that can securely pass and execute commands. Interacting with and extracting data from the Web is important because there is a wealth of information available—this is known as <span><em class="italic">data mining</em></span>. Instead of mining for gold, we will look at different ways to mine for significant data and turn it into meaningful information.<a class="calibre17" shape="rect"/></p>&#13;


  <div class="calibre3 calibre3 calibre3 calibre3">
    <h1 class="calibre1" id="calibre_pb_349"><span class="calibre2"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos561173"/>Define</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_350"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos561453"/>Define</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>define.rb</h3>
      </div>

      <p class="calibre4">This script will query the Web to retrieve the first definition of any user-specified word. The website being queried is <a class="calibre6" href="http://www.dictionary.com/" shape="rect">http://www.dictionary.com/</a><a class="calibre17" shape="rect"/>, and like any script that interacts with the Web, there is risk of this script breaking if the web designers make any changes. The purpose of the script is to retrieve the data you specifically want. Using Dictionary.com is just a means to demonstrate that skill, although this is a slick example.<a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_351"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos562667"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><img alt="" class="calibre23" src="../Images/00002.jpg"/> require "open-uri"<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       unless ARGV[0]<br class="calibre20"/>&#13;
           puts "You must supply a word to <a class="calibre17" shape="rect"/>define."<br class="calibre20"/>&#13;
           puts "USAGE: ruby define.rb &lt;word to define&gt;"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> word = ARGV[0].strip<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> url = "http://dictionary.reference.com/search?q=#{word}"<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       begin<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>     open(url) do |source|<br class="calibre20"/>&#13;
           source.each_line do |x|<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>         if x =~ /No results found/<br class="calibre20"/>&#13;
               puts "\nPlease check spelling, no definition was found."<br class="calibre20"/>&#13;
               exit<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00007.jpg"/>         if x =~ /(1\.)&lt;\/td&gt;&lt;td valign="top"&gt;(.*)&lt;\/td/<br class="calibre20"/>&#13;
               puts "\n#{$1} #{$2}"<br class="calibre20"/>&#13;
               exit<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00008.jpg"/>     puts "Sorry, unable to find a definition."<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
       rescue =&gt; e<br class="calibre20"/>&#13;
           puts "An error occurred, please try again."<br class="calibre20"/>&#13;
           puts e<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_352"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos564621"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">Execute this script by typing:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby define.rb</code></strong> <em class="italic"><code class="calibre19">word to define</code></em></tt></span>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">I chose to define the word <span><em class="italic">Ruby</em></span> in this example. Unfortunately, <span><em class="italic">the most wicked programming language</em></span> was not the first result returned!</p>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_353"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos565624"/>The Results</span></h2>
    </div>

    <p class="calibre4">The script will display the definition of any word supplied. If the definition can't be found, the user will be asked to check the spelling—perhaps the word doesn't exist.</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">1.a red variety of corundum, used as a gem.</tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_354"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos566309"/>How It Works</span></h2>
    </div>

    <p class="calibre4">Once again, we encounter the fantastic <a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/>library open-uri <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. Whenever a script deals with web interaction, there are a handful of useful libraries; I prefer open-uri because it abstracts even more of the network connection details than other libraries. After the required library is identified, some error checking is performed. I hope you're used to this code block by now. The first variable is called <code class="calibre19">word</code> and will hold the word that the user wants to <a class="calibre17" shape="rect"/>define <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. Next, the Dictionary.com URL is hardcoded into the variable <code class="calibre19">url</code> with the addition of the user-supplied word <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. Thanks to the webmasters at Dictionary.com, appending a word to the URL will automatically return the definition.</p>

    <p class="calibre4">Next, we start a <code class="calibre19">begin/rescue</code> statement due to the volatile nature of web requests. <a class="calibre17" shape="rect"/>HTTP requests are often answered with various error messages; dealing with those messages appropriately is the key to success in this script. Now that we've deployed our <code class="calibre19">begin/rescue</code> safety net, we are ready to ask Dictionary.com for the definition. open-uri lets us simply type <code class="calibre19">open()</code>, pass the URL to the method, and retrieve a web page <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. I smile every time I use the <code class="calibre19">open</code> method because getting a web page is so easy.<a class="calibre17" shape="rect"/></p>

    <p class="calibre4">The <code class="calibre19">open</code> method is followed by a block that manipulates the source code returned by the web server. Because we are looking for a particular line (the word's definition), we start another block of code that breaks the source code down line by line. Dictionary.com will display the message <span><em class="italic">No results found</em></span> if a word cannot be defined. If the script finds these words (but no definition) while analyzing the source code, it reminds the user to check the spelling of the word as a helpful hint, and then exits <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. However, if the definition is found, the script will begin isolating exactly where the definition resides in the source code. A regular expression is used to pinpoint the exact text.</p>

    <p class="calibre4">The important part of the regular expression is the <code class="calibre19">1</code>. Dictionary.com uses this as an annotation for the first definition, which is what we are interested in. Using parentheses in the regular expression allows the script to group certain areas of any line that match the expression <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00007.jpg"/></span>. The groups are stored in the variables <code class="calibre19">[$1]</code> through <code class="calibre19">[$n]</code>. The line after the regular expression outputs the definition. If neither the definition nor <span><em class="italic">No results found</em></span> are located in the source code, a different message is displayed, letting the user know the definition could not be found <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00008.jpg"/></span>. If any error(s) occurred during the definition process, our <code class="calibre19">rescue</code> block kicks off and specifies what error(s) occurred.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_355"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos570988"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">One way to hack this script is by adding a <a class="calibre17" shape="rect"/>proxy between the user and the request to the web server. If you are using a proxy, you must do this. If you are curious about the web traffic from Ruby, the proxy will give you a little insight. See the documentation for open-uri; the syntax will look something like <code class="calibre19">open(url, :proxy =&gt; "http://127.0.0.1:8080")</code>. I don't normally have a proxy in place when I'm surfing the Web, but when doing web development, I find it helpful to watch the traffic in case any errors are encountered.</p>

    <p class="calibre4">In this instance, I use the free <a class="calibre17" shape="rect"/>web proxy <a class="calibre17" shape="rect"/>Paros (<a class="calibre6" href="http://www.parosproxy.org/" shape="rect">http://www.parosproxy.org/</a>). Paros is installed locally on my machine, and I can watch as my web requests are made and subsequent responses are received. I have saved many hours of debugging by having Paros involved in my development. I am very partial to Paros, but there are many other proxies from which to choose, so take a look around.<a class="calibre17" shape="rect"/></p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_356"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos572428">
    <h1 class="calibre1" id="calibre_pb_357"><span class="calibre2"><a class="calibre7" shape="rect"/>Automated SMS</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_358"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos572916"/>Automated SMS</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>sms.rb</h3>
      </div>

      <p class="calibre4">This <a class="calibre17" shape="rect"/>script sends an SMS <a class="calibre17" shape="rect"/>message to whatever mobile phone number you choose. I caution you not to abuse the functionality, but you do have to try it. The premise is to automate the use of a site that sends SMS messages to people for you. Instead of grabbing static web content, this script will actually automate filling out and submitting a web form.<a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_359"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos574003"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> require 'win32ole'<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> ie = WIN32OLE.new('InternetExplorer.Application')<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> ie.navigate("http://toolbar.google.com/send/sms/index.php")<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       ie.visible = true<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> sleep 1 until ie.readyState() == 4<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/> ie.document.all["mobile_user_id"].value ="5712013623"<br class="calibre20"/>&#13;
       ie.document.all["carrier"].value ="TMOBILE"<br class="calibre20"/>&#13;
       ie.document.all["subject"].value ="***Ruby Rulez***"<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/> ie.document.all.tags("textarea").each do |i|<br class="calibre20"/>&#13;
           i.value = "Thanks for the hard work, Matz!"<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00007.jpg"/> ie.document.all.send_button.click</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_360"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos575321"/>Running the Code</span></h2>
    </div>

    <p class="calibre4">Execute this script by typing:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby googleS2P.rb</code></strong></tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_361"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos575915"/>The Results</span></h2>
    </div>

    <p class="calibre4">The script doesn't output anything, but if successful, the phone attached to the phone number supplied should notify you of an incoming message. I've used fictitious data, but feel free to edit it for your amusement.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_362"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos576488"/>How It Works</span></h2>
    </div>

    <p class="calibre4">If you own a computer with Windows and have never played with the library <a class="calibre17" shape="rect"/>win32ole, you need to make time for it, because Windows automation is interesting and fun. Not only can you manipulate Internet Explorer (IE), as demonstrated in this script, but you can also manipulate any of the Microsoft Office products, as well as other Windows applications.</p>

    <div class="calibre3">
      <hr class="calibre21"/>
    </div>

    <div class="calibre3">
      <h3 class="calibre24" id="heading_id_2"><span class="calibre18"><a class="calibre7" shape="rect"/>Note</span></h3>

      <p class="calibre4"><span class="calibre18"><span><em class="italic">There are several other libraries available for website automation that are extremely helpful for regression and quality assurance testing of web applications. One of the more popular examples is Watir (pronounced</em></span> Water <span><em class="italic">). Details for Watir can be found at</em></span> <a class="calibre6" href="http://wtr.rubyforge.org/" shape="rect">http://wtr.rubyforge.org/</a>.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></span></p>
    </div>

    <div class="calibre3">
      <hr class="calibre21"/>
    </div>

    <p class="calibre4">A new <code class="calibre19">win32ole</code> object is created with the IE handle passed as an argument <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. This lets win32ole know what application will be under its control. Using the built-in methods associated with IE, <code class="calibre19">navigate</code> obviously goes to the specified URL, which is <a class="calibre6" href="http://toolbar.google.com/send/sms/index.php/" shape="rect">http://toolbar.google.com/send/sms/index.php/</a> <a class="calibre17" shape="rect"/><span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. The next line specifies an attribute of the IE window. If you chose not to watch the script work its magic, you can change this line to <code class="calibre19">false</code>, and the IE window will disappear into the background. Then you'd only be able to see its presence in the task list. Because I like to see the script executing, I've set this value to <code class="calibre19">true</code>. The Internet Explorer application pops up fast, so you have to be ready.</p>

    <p class="calibre4">Next is the page load conditional loop. As you know, websites do not load their content instantaneously. To prevent the script from submitting its information prematurely, this line tells the script to go to sleep for one second and then to check back for the correct <code class="calibre19">readyState</code> code, which is <code class="calibre19">4</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. Being premature is never a good thing, and it would break the script in this instance. Once the IE document has been fully loaded, the script is ready to fill in the appropriate fields.</p>

    <p class="calibre4">The script knows which fields to look for by the attribute names. If you were to look at the source code of the website, you'd see objects called <code class="calibre19">mobile_user_id</code>, <code class="calibre19">carrier</code>, <code class="calibre19">subject</code>, and so on. We use this information to specify what input goes where <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. Most of the HTML used in the website fits the standards, but for some reason, the name field of the text area is not put in quotation marks. That means we can't use the previous method to access the area. Since we saw there was only one text area in the source code, we search for it and input our data once it's found. Nothing too fancy, but a little different than the norm <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>.</p>

    <p class="calibre4">All that's left to do after the information is in place is to virtually click the send button. Google is great for properly naming buttons, so we just grab the button name and tell it to use the <code class="calibre19">click</code> method. <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00007.jpg"/></span>. That's all there is to it—Ruby is so cool!</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_363"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos581500">
    <h1 class="calibre1" id="calibre_pb_364"><span class="calibre2"><a class="calibre7" shape="rect"/>Link Scrape</span></h1>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_365"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos581986"/>Link Scrape</span></h2>&#13;
    </div>&#13;
&#13;
    <div class="calibre3">&#13;
      <div class="calibre3 calibre3 calibre3">&#13;
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>linkScrape.rb</h3>&#13;
      </div>&#13;
&#13;
      <p class="calibre4"><a class="calibre17" shape="rect"/>Scraping <a class="calibre17" shape="rect"/>links off of web pages has many uses. As with any problem, there are many ways to solve it. In <a class="calibre6" href="../Text/dummy_split_073.html#filepos190170" shape="rect">Chapter 2</a> we wrote a script to validate links on a website. Because of the need to validate the links, the script required far more lines of code than if it had needed to simply scrape all of the <a class="calibre17" shape="rect"/>links. We aren't going to be building a web spider, but I'll cover some of the basic components—the first of which is a link scraper.<a class="calibre17" shape="rect"/></p>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_366"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos583259"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><img alt="" class="calibre23" src="../Images/00002.jpg"/> require 'mechanize'<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       unless ARGV[0]<br class="calibre20"/>&#13;
           puts "You must supply a website."<br class="calibre20"/>&#13;
           puts "USAGE: ruby <a class="calibre17" shape="rect"/>linkScrape.rb &lt;url to scrape&gt;"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> agent = WWW::Mechanize.new<br class="calibre20"/>&#13;
       agent.set_proxy('localhost',8080)<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       begin<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/>     page = agent.get(ARGV[0].strip)<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
           page.links.each do |l|<br class="calibre20"/>&#13;
               if l.href.split("")[0] =='/'<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>             puts "#{ARGV[0]}#{l.href}"<br class="calibre20"/>&#13;
               else<br class="calibre20"/>&#13;
                   puts l.href<br class="calibre20"/>&#13;
               end<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
       rescue =&gt; e<br class="calibre20"/>&#13;
           puts "An error occurred."<br class="calibre20"/>&#13;
           puts e<br class="calibre20"/>&#13;
           retry<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_367"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos584827"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">Execute this script by typing:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby linkScrape.rb</code></strong> <em class="italic"><code class="calibre19">http://url_to_scrape.com/</code></em></tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_368"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos585517"/>The Results</span></h2>
    </div>

    <p class="calibre4">The script will output a list of all the links found on the page with the specified URL. I've scraped <a class="calibre6" href="http://www.nostarch.com/main_menu.htm/" shape="rect">http://www.nostarch.com/main_menu.htm/</a>.</p>

    <div class="calibre3">
      <table border="1" class="calibre26">
        <colgroup class="calibre27" span="1">
          <col class="calibre28" span="1"/>
          <col class="calibre28" span="1"/>
        </colgroup>

        <tbody class="calibre33">
          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre18">index.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">interactive.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">catalog.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">gimp.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">wheretobuy.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">inkscape.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">about.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">js2.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">jobs.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">eblender.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">media.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">oophp.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><a class="calibre6" href="http://www.nostarch.com/blog/" shape="rect">http://www.nostarch.com/blog/</a></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">wpdr.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><a class="calibre6" href="http://ww6.aitsafe.com/cf/review/" shape="rect">http://ww6.aitsafe.com/cf/review/</a></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">webbots.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">.cfm?userid=8948354</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">google.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">abs_bsd2.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">growingsoftware.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">openbsd.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">rootkits.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">freebsdserver.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">hacking2.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">debian.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">voip.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">howlinuxworks.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">firewalls.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">appliance.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">securityvisualization.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">lcbk2.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">silence.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">lme.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">stcb4.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">nongeeks.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">scsi2.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">lps.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">cisco.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">mug.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">cablemodem.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">ubuntu_3.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">xbox.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">imap.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">insidemachine.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">pf.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">nero7.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">postfix.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">wireless.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">webmin.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">creative.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">endingspam.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">ebaypg.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">cluster.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">ebapsg.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">nagios.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">geekgoddess.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">nagios_2e.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">wikipedia.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">pgp.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">indtb.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">packet.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">sayno.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">tcpip.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">networkknowhow.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">assembly.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">sharing.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">debugging.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">apple2.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">qt4.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">newmac.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">vb2005.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">cult_mac.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">vsdotnet.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">ipod.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">codecraft.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">art_of_raw.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">hownotc.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">firstlego.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">idapro.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">flego.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">mugperl.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">legotrains.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">gnome.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">sato.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">plg.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">nxt.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">ruby.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">nxtonekit.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">vbexpress.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">zoo.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">wcj.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">legobuilder.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">wcps.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">nxtig.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">wcphp.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">vlego.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">wcruby.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">mg_databases.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">wcss.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">mg_statistics.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">greatcode.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">eli.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">greatcode2.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">index.htm</span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32">wpc.htm</span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"/>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_369"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos605751"/>How It Works</span></h2>
    </div>

    <p class="calibre4">Compare the code above with "#10 Web Page Link Validator" on <a class="calibre6" href="../Text/dummy_split_076.html#filepos194055" shape="rect">The Code</a>—quite a difference, right? Always think through a problem and remember to solve the problem in the simplest way possible. Some of the most elegant solutions are amazingly simple. This is a basic website link scraper without regard for validity or anything else. The <a class="calibre17" shape="rect"/>mechanize library is another one commonly used when interacting with the Internet <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. Aside from the usual error-handling statement, a new mechanize object is created which is called <code class="calibre19">agent</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. The object is then customized for future use, so the proxy is set to my local Paros proxy. If you don't want to use a proxy, then simply remove this line. Next, <code class="calibre19">agent</code> uses the method <code class="calibre19">get</code> to retrieve the web content <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. The cool part about mechanize is the way web content is automatically categorized. Finding specific elements in the web content using mechanize makes the Ruby coder's life that much better.<a class="calibre17" shape="rect"/></p>

    <p class="calibre4">Within <code class="calibre19">page</code>, the array <code class="calibre19">links</code> is found. Thanks to mechanize, the <a class="calibre17" shape="rect"/>links have already been parsed. As with any array, we can use the <code class="calibre19">each</code> method and iterate through each of its elements. Don't forget that <code class="calibre19">link</code> not only contains the URL of each link but also other attributes defined in the original source code. We are only interested in the <code class="calibre19">href</code> attribute, so that is what is output to the console <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. If you are going to be <a class="calibre17" shape="rect"/>scraping a large website, I'd encourage you to save the output to a file, but that's your call. After the links have been printed, the script exits cleanly.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_370"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos608733"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">There are several other wicked cool web tools, such as <a class="calibre17" shape="rect"/>Hpricot (<a class="calibre6" href="http://code.whytheluckystiff.net/hpricot/" shape="rect">http://code.whytheluckystiff.net/hpricot/</a>) and <a class="calibre17" shape="rect"/>Rubyful Soup (<a class="calibre6" href="http://www.crummy.com/software/RubyfulSoup/" shape="rect">http://www.crummy.com/software/RubyfulSoup/</a>), that can accomplish this parsing in a similar fashion. I encourage you to experiment with each one to find the tool that suits your needs.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_371"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos609487">
    <h1 class="calibre1" id="calibre_pb_372"><span class="calibre2"><a class="calibre7" shape="rect"/>Image Scrape</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_373"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos609974"/>Image Scrape</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>imageScrape.rb</h3>
      </div>

      <p class="calibre4">This script will scrape every image from the page at a user-supplied URL. The image files will include data residing on the host machine in addition to <a class="calibre17" shape="rect"/>images linked from other web servers.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_374"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos610944"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> require "open-uri"<br class="calibre20"/>&#13;
       require "pathname"<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       unless ARGV[0]<br class="calibre20"/>&#13;
           puts "You must supply a URL to scrape <a class="calibre17" shape="rect"/>images."<br class="calibre20"/>&#13;
           puts "USAGE: ruby <a class="calibre17" shape="rect"/>imageScrape.rb &lt;url to scrape&gt;"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       url = ARGV[0].strip<br class="calibre20"/>&#13;
       begin<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/><br class="calibre20"/>&#13;
           open(url, "User-Agent" =&gt; "Mozilla/4.0 (compatible; MSIE 5.5; Windows 98)")<br class="calibre20"/>&#13;
       do |source|<br class="calibre20"/>&#13;
               source.each_line do |x|<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/>             if x =~ /&lt;img src="(.+.[jpeg|gif])"\s+/<br class="calibre20"/>&#13;
                       name = $1.split('"').first<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/>                 name = url + name if Pathname.new(name).absolute?<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>                 copy = name.split('/').last<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>                 File.open(copy, 'wb') do |f|<br class="calibre20"/>&#13;
                           f.write(open(name).read)<br class="calibre20"/>&#13;
                       end<br class="calibre20"/>&#13;
                   end<br class="calibre20"/>&#13;
               end<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
       rescue =&gt; e<br class="calibre20"/>&#13;
           puts "An error occurred, please try again."<br class="calibre20"/>&#13;
           puts e</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_375"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos613126"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">Execute this script by typing:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby imageScrape.rb</code></strong> <em class="italic"><code class="calibre19">http://url_to_scrape.com/</code></em></tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_376"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos613817"/>The Results</span></h2>
    </div>

    <p class="calibre4">The script will download all the links found within the specified URL. I've scraped <a class="calibre6" href="http://www.ruby-lang.org/" shape="rect">http://www.ruby-lang.org/</a>, and it grabbed two images, <span><em class="italic">logo.gif</em></span> (a Ruby logo) and <span><em class="italic">download.gif</em></span> (an image that links to a download of Ruby).</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_377"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos614598"/>How It Works</span></h2>
    </div>

    <p class="calibre4">For the task of extracting images from a website, the first step is to retrieve the website where the images are located. Using the open-uri method <code class="calibre19">open</code>, the web page source code is conveniently saved into our variable <code class="calibre19">source</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. As you recall from your HTML coding days, images are embedded into web documents using <code class="calibre19">&lt;img src=</code><em class="italic"><code class="calibre19">foo.jpg</code></em><code class="calibre19">&gt;</code> <a class="calibre17" shape="rect"/>tags. In the script, we've used a regular expression that analyzes each line of the source code and finds this specific tag <a class="calibre17" shape="rect"/><span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span><a class="calibre17" shape="rect"/>. From the results of the regular expression, the script can identify the location of any <a class="calibre17" shape="rect"/>images found.</p>

    <p class="calibre4">Once we have the location of an image, we need <a class="calibre17" shape="rect"/>to determine if the image was linked from another site or if it is located on the host site. Most HTML is coded with a slash in front of any <a class="calibre17" shape="rect"/>images that are on the local web server; this is also known as an <span><em class="italic">absolute path</em></span>. The <code class="calibre19">name</code> variable holds the image path. If the image path is absolute, the script prepends the original URL to the image name in order to make the image's complete address. The absolute check happens when I create a new <code class="calibre19">Pathname</code> object and use the <code class="calibre19">absolute?</code> method <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. Even though the path to the image may have changed, the image's local name will be the same stored in <code class="calibre19">copy</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>.<a class="calibre17" shape="rect"/></p>

    <p class="calibre4">After an appropriate address for the image is created, the script leverages the open-uri virtual file handling to read in the contents of the image and output it to a file with the name stored in <code class="calibre19">copy</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. This process is repeated for every image found in a web document. The results are stored in the same directory from which the script is run.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_378"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos617953"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">You could use a pre-built HTML parser like mechanize, Hpricot, or Rubyful Soup. These may be even more accurate than the regular expression used above. You could also save the images in the same type of directory structure as they were found of the web server. There are lots of possibilities, but this script will get you started.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_379"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos618471">
    <h1 class="calibre1" id="calibre_pb_380"><span class="calibre2"><a class="calibre7" shape="rect"/>Scraper</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_381"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos618953"/>Scraper</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>scrape.rb</h3>
      </div>

      <p class="calibre4">Scraping, in its most basic form, is the action of pulling data from another website through normal HTTP queries. The scraper script is a culmination of the previous scripts. It combines the prior techniques discussed in previous scripts into one large script with a few more features. This script allows for a one-stop shop in basic website scraping. This script is not a bot, because it requires user interaction for each scrape; but with a few minor tweaks, this script could be completely automated.<a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_382"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos620113"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> require 'rio'<br class="calibre20"/>&#13;
       require 'open-uri'<br class="calibre20"/>&#13;
       require 'uri'<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       unless ARGV[0] and ARGV[1]<br class="calibre20"/>&#13;
           puts "You must specify an operation and URL."<br class="calibre20"/>&#13;
           puts "USAGE: scrape.rb [page|images|links] &lt;url to scrape&gt;"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> case ARGV[0]<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       when "page"<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/>     rio(ARGV[1]) &gt; rio("#{URI.parse(ARGV[1].strip).host}.html")<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> when "images"<br class="calibre20"/>&#13;
           begin<br class="calibre20"/>&#13;
               open(url, "User-Agent" =&gt; "Mozilla/4.0 (compatible; MSIE 5.5; Windows<br class="calibre20"/>&#13;
       98)") do |source|<br class="calibre20"/>&#13;
               source.each_line do |x|<br class="calibre20"/>&#13;
                   if x =~ /&lt;img src="(.+.[jpeg|gif])"\s+/<br class="calibre20"/>&#13;
                       name = $1.split('"').first<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
                       name = url + name if Pathname.new(name).absolute?<br class="calibre20"/>&#13;
                           copy = name.split('/').last<br class="calibre20"/>&#13;
                      <br class="calibre20"/>&#13;
                       File.open(copy, 'wb') do |f|<br class="calibre20"/>&#13;
                           f.write(open(name).read)<br class="calibre20"/>&#13;
                       end<br class="calibre20"/>&#13;
                   end<br class="calibre20"/>&#13;
               end<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
           rescue =&gt; e<br class="calibre20"/>&#13;
               puts "An error occurred, please try again."<br class="calibre20"/>&#13;
               puts e<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       when "links"<br class="calibre20"/>&#13;
           links = File.open("links.txt","w+b")<br class="calibre20"/>&#13;
           begin<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/><br class="calibre20"/>&#13;
              open(ARGV[1], "User-Agent" =&gt; "Mozilla/4.0 (compatible; MSIE 5.5; Windows<br class="calibre20"/>&#13;
       98)") do |source|<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>             links.puts URI.extract(source, ['http', 'https'])<br class="calibre20"/>&#13;
              end<br class="calibre20"/>&#13;
           rescue =&gt; e<br class="calibre20"/>&#13;
               puts "An error occurred, please try again."<br class="calibre20"/>&#13;
               puts e<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
           links.close<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       else<br class="calibre20"/>&#13;
           puts "You entered an invalid instruction, please try again."<br class="calibre20"/>&#13;
           puts "USAGE: scrape.rb [page|images|links] &lt;url to scrape&gt;"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_383"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos623593"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">Execute this script by typing:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby scrape.rb [</code></strong><em class="italic"><code class="calibre19">page|images|links</code></em><strong class="calibre22"><code class="calibre19">]</code></strong> <em class="italic"><code class="calibre19">http://url_to_scrape.com/</code></em></tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_384"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos624435"/>The Results</span></h2>
    </div>

    <p class="calibre4">The script's output will be different for each method chosen. You can see an example from the previous script.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_385"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos624901"/>How It Works</span></h2>
    </div>

    <p class="calibre4">The script has three options. You can scrape <code class="calibre19">links</code>, <code class="calibre19">images</code>, or an entire web <code class="calibre19">page</code>. A <code class="calibre19">case</code> statement is used to handle the different options <a class="calibre17" shape="rect"/><span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span><a class="calibre17" shape="rect"/>. You could have used an <code class="calibre19">if/else</code> statement, but the <code class="calibre19">case</code> statement is cleaner. If the page is selected, the <code class="calibre19">rio</code> command is used to copy the web page source code and save it to an HTML file on the local machine <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. <code class="calibre19">rio</code> handles so many of the dirty details that this task can be accomplished in just one line!<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>

    <p class="calibre4">Next is the image scrape <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. This section of the code is a copy of "#45 Image Scrape" on <a class="calibre6" href="../Text/dummy_split_310.html#filepos605751" shape="rect">How It Works</a>, so I won't review the details. If you have any questions, you can refer to the previous script.</p>

    <p class="calibre4">The final <code class="calibre19">case</code> statement is to grab the links. Unlike other methods used, I've reinvented the wheel to show another method for <a class="calibre17" shape="rect"/>extracting URLs. This link-scraping method uses the <code class="calibre19">open</code> method from open-uri to retrieve the source code <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span> and follows up with the <code class="calibre19">URI.extract</code> method, which hunts down HTTP or HTTPS links <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. The results are saved into a text file called <span><em class="italic">links.txt</em></span>.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_386"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos627604">
    <h1 class="calibre1" id="calibre_pb_387"><span class="calibre2"><a class="calibre7" shape="rect"/>Encrypted Client</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_388"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos628095"/>Encrypted Client</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>RSA_client.rb</h3>
      </div>

      <p class="calibre4">Three principles are commonly used when describing information technology and security. The three principles are <a class="calibre17" shape="rect"/>confidentiality, <a class="calibre17" shape="rect"/>integrity, and <a class="calibre17" shape="rect"/>availability. Each of these security components affects how a user interacts with data. The following two scripts will integrate RSA encryption for confidentiality and a SHA1 hash for integrity. The data will then be transmitted over a network using a TCP connection.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_389"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos629329"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> require 'socket'<br class="calibre20"/>&#13;
       require 'digest/sha1'<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       begin<br class="calibre20"/>&#13;
           print "Starting client..."<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/>     client = TCPSocket.new('localhost', 8887)<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
           puts "connected!\n\n"<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/>     temp = nil<br class="calibre20"/>&#13;
           5.times do<br class="calibre20"/>&#13;
               temp &lt;&lt; client.gets<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
           puts "Received public 1024 RSA key!\n\n"<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/>     public_key = OpenSSL::PKey::RSA.new(temp)<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
           msg = '<a class="calibre17" shape="rect"/>mpg123*"C:\Program Files\Windows Media Player\<a class="calibre17" shape="rect"/>mplayer2.exe"*ruby.mp3'<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>     sha1 = Digest::SHA1.hexdigest(msg)<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>     command = public_key.public_encrypt("#{sha1}*#{msg}")<br class="calibre20"/>&#13;
           print "Sending the command...."<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00007.jpg"/>     <a class="calibre17" shape="rect"/>client.send(command,0)<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
           puts "sent!"<br class="calibre20"/>&#13;
       rescue =&gt; e<br class="calibre20"/>&#13;
           puts "Something terrible happened...."<br class="calibre20"/>&#13;
           puts e<br class="calibre20"/>&#13;
           retry<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       client.close</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_390"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos631282"/>Running the Code</span></h2>
    </div>

    <p class="calibre4">Execute this script by typing:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby RSA_client.rb</code></strong></tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_391"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos631877"/>The Results</span></h2>
    </div>

    <p class="calibre4">Below is the output from a successful connection and command issue.</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Starting client...connected!<br class="calibre20"/>
      <br class="calibre20"/>
      Received public 1024 RSA key!<br class="calibre20"/>
      <br class="calibre20"/>
      Sending the command...sent!</tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_392"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos632518"/>How It Works</span></h2>
    </div>

    <p class="calibre4">The client begins by opening a <a class="calibre17" shape="rect"/>TCP connection to a specified IP address and port number <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. If the connection is successful, <span><em class="italic">connected</em></span> is output to <code class="calibre19">$stdout</code>. Next, the client expects to receive a 1024-bit RSA public encryption key from the server. The key is stored in a variable called <code class="calibre19">temp</code> because it is really only a cryptic string object until it is converted into an OpenSSL RSA key object <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. Once <code class="calibre19">public_key</code> is initialized and contains the public RSA key, the script confirms the key was received and is ready to encrypt data <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>.</p>

    <p class="calibre4">The script will send data that contains a music program, either mpg123 for Linux or mplayer2.exe, which is the classic Windows media player. In addition to the music program, a music file, <span><em class="italic">ruby.mp3</em></span>, is also sent. The file is already located on the server, so this will simply tell the server to play the song. Each portion of the command string is delimited by an asterisk (*). You can get as creative as you want with this command, or even the data in general, as it will all be <a class="calibre17" shape="rect"/>encrypted and sent to the server.</p>

    <p class="calibre4"><a class="calibre17" shape="rect"/>Data encryption is the next step. The command string described above is stored in a variable called <code class="calibre19">msg</code> and will be <a class="calibre17" shape="rect"/>encrypted with the server's public RSA key. Before we encrypt the <a class="calibre17" shape="rect"/>data, the script will run the message through a SHA1 hash and store the resulting hash in <code class="calibre19">sha1</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. This hash will be used after transmission on the server side. Remember that hash functions are one way, so if the data is tampered with during transmission, the before and after hash values won't be the same.</p>

    <p class="calibre4">Next, the value in <code class="calibre19">sha1</code> and <code class="calibre19">msg</code> are concatenated with a splat in between. The result is <a class="calibre17" shape="rect"/>encrypted using the RSA key method <code class="calibre19">public_encrypt</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. As you might have guessed, the method encrypts the data using a public RSA key. Only the corresponding private RSA key can be used to decrypt the message.<a class="calibre17" shape="rect"/></p>

    <p class="calibre4">Finally, the encrypted message is sent to the server, and the connection is closed <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00007.jpg"/></span>. If anything goes wrong during the encryption or transmission phases of the script, our trusty <code class="calibre19">begin/rescue</code> block is there to save the day. If all goes well, the server will pop open an awesome tune about Ruby! Can life get any better than listening to songs about Ruby?<a class="calibre17" shape="rect"/></p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_393"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos636610">
    <h1 class="calibre1" id="calibre_pb_394"><span class="calibre2"><a class="calibre7" shape="rect"/>Encrypted Server</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_395"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos637101"/>Encrypted Server</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>RSA_server.rb</h3>
      </div>

      <p class="calibre4">Now that you have seen the <a class="calibre17" shape="rect"/>client and all of its magic, it's time to analyze the server. The server receives the data, checks that the SHA1 hash is valid, decrypts the data, and, finally, executes the command string based on the payload transmitted.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_396"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos638096"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> require 'socket'<br class="calibre20"/>&#13;
       require 'digest/sha1'<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> priv_key = OpenSSL::PKey::RSA.new(1024)<br class="calibre20"/>&#13;
       pub_key = priv_key.public_key<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       host = ARGV[0] || 'localhost'<br class="calibre20"/>&#13;
       port = (ARGV[1] || 8887).to_i<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> server = TCPServer.new(host, port)<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> while session = server.accept<br class="calibre20"/>&#13;
           begin<br class="calibre20"/>&#13;
               puts "Connection made...sending public key.\n\n"<br class="calibre20"/>&#13;
               puts pub_key<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>         session.print pub_key<br class="calibre20"/>&#13;
               puts "Public key sent, waiting on data...\n\n"<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>         temp = session.recv(10000)<br class="calibre20"/>&#13;
               puts "Received data..."<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00007.jpg"/>         msg = priv_key.private_decrypt(temp)<br class="calibre20"/>&#13;
           rescue =&gt; e<br class="calibre20"/>&#13;
               puts "Something terrible happened while receiving and decrypting."<br class="calibre20"/>&#13;
               puts e<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00008.jpg"/>     command = msg.split("*")<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
           serv_hash = command[0]<br class="calibre20"/>&#13;
           nix_app = command[1]<br class="calibre20"/>&#13;
           win_app = command[2]<br class="calibre20"/>&#13;
           file = command[3]<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00009.jpg"/><br class="calibre20"/>&#13;
           if Digest::SHA1.hexdigest("#{nix_app}*#{win_app}*#{file}")==serv_hash<br class="calibre20"/>&#13;
               puts "Message integrity confirmed..."<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00011.jpg"/>         if RUBY_PLATFORM.include?('mswin32')<br class="calibre20"/>&#13;
                   puts "Executing windows command: #{win_app} #{file}"<br class="calibre20"/>&#13;
                   `#{win_app} #{file}`<br class="calibre20"/>&#13;
                   exit<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00012.jpg"/>         else<br class="calibre20"/>&#13;
                   puts "Executing Linux command: #{nix_app} #{file}"<br class="calibre20"/>&#13;
                   `#{nix_app} #{file}`<br class="calibre20"/>&#13;
                   exit<br class="calibre20"/>&#13;
               end<br class="calibre20"/>&#13;
           else<br class="calibre20"/>&#13;
               puts "The message could not be validated!"<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_397"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos641307"/>Running the Code</span></h2>
    </div>

    <p class="calibre4">Execute this script by typing:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby RSA_<a class="calibre17" shape="rect"/>server.rb</code></strong></tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_398"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos641940"/>The Results</span></h2>
    </div>

    <p class="calibre4">Below is the output from a successful connection and command issue.</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Connection made...sending public key.<br class="calibre20"/>
      <br class="calibre20"/>
      -----BEGIN RSA PUBLIC KEY-----<br class="calibre20"/>
      MIGJAoGBAMe12IJIyVULS/OLlHeekhZNyh2YhuGfJSwEozw2Z6GfaRjZg7s0cwqb<br class="calibre20"/>
      B/Z+MMUPIjCmiH38pkKzh5GhA8zcRSWEFtssa8HcyIowA5ftZM27/6diYz9kNueI<br class="calibre20"/>
      NO2kvlkqwU5KUOKnLISJnrZAlTbJMqio24dn3PNm27kgae8+KdrHAgMBAAE=<br class="calibre20"/>
      -----END RSA PUBLIC KEY-----<br class="calibre20"/>
      Public key sent, waiting on data...<br class="calibre20"/>
      <br class="calibre20"/>
      Received data...<br class="calibre20"/>
      Message integrity confirmed...<br class="calibre20"/>
      Executing windows command: "C:\Program Files\Windows Media Player\mplayer2.exe" ruby.mp3</tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_399"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos642984"/>How It Works</span></h2>
    </div>

    <p class="calibre4">The script first generates a unique, private RSA key <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. From the private key, a public RSA key is also generated using the RSA key method <code class="calibre19">public_key</code>. Every time this script is run, a new key pair is created. If someone sends data encrypted with an old public key, the script won't be able to decrypt the message.</p>

    <p class="calibre4">After the RSA keys have been created, a TCP server is initialized <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. The server can be run with command-line arguments for the host and port, or it can use the default values provided. After the server is created, it begins listening for incoming connections. A <code class="calibre19">while</code> loop is used to regulate the various sessions in the script <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. Because the script is not multithreaded, only one connection at a time is allowed.</p>

    <p class="calibre4">When the client is executed, it connects to the server. This connection starts a new session, and the first action is to respond with the server's public RSA key <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. The RSA key is small, so it happens quickly. The script then waits for data to be sent by the client. While it waits, the client receives the public RSA key and encrypts the message to be sent. The <code class="calibre19">temp</code> variable captures any data received by the server's TCP connection, up to 10,000 bytes <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. Only after data is received will the script proceed.</p>

    <p class="calibre4">Using the RSA <code class="calibre19">private_decrypt</code> method, the value located in <code class="calibre19">temp</code> is decrypted and stored in <code class="calibre19">msg</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00007.jpg"/></span>. If any errors occur during the receipt and decryption of the command string, our <code class="calibre19">rescue</code> clause will catch the error and output some useful information that will help us troubleshoot the issue.</p>

    <p class="calibre4">If you recall from "#47 Encrypted Client" on <a class="calibre6" href="../Text/dummy_split_324.html#filepos624901" shape="rect">How It Works</a>, the command string was delimited by asterisks (*). So, to get the command string into the pieces we need, the <code class="calibre19">split</code> method is used with a splat as the break point in the string <code class="calibre19">msg</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00008.jpg"/></span>. The results are saved to <code class="calibre19">command</code>, which is an array of strings. Since we built the string in the client script, we know what the order will be. First is the SHA1 hash; next, the Linux application, followed by the windows application; and, finally, the file to be used.</p>

    <p class="calibre4">A SHA1 hash is created using the Linux application string, Windows application string, and filename <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00009.jpg"/></span>. Asterisks are added in between each of the strings to recreate the original hashed string. The results of this hash are then compared against <code class="calibre19">serv_hash</code>, which contains the SHA1 hash sent by the client. If the values are not equal, then something must have happened to the data during transmission. The data can no longer be trusted, so the program exits. Hopefully, the values will match up so the script can continue.</p>

    <p class="calibre4">If the message integrity has been confirmed, then the last decision is to pick which application to run. Ruby provides an easy way of determining the platform being used. You simply ask it using <code class="calibre19">RUBY_PLATFORM</code>. The result for a Windows machine is <code class="calibre19">i386-mswin32</code>. Using the handy <code class="calibre19">include?</code> method, the script checks to see if the string returned by <code class="calibre19">RUBY_PLATFORM</code> contains <code class="calibre19">mswin32</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00011.jpg"/></span>. If this statement is <code class="calibre19">true</code>, the Windows command is executed. If not, then the Linux application is executed <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00012.jpg"/></span>. Either way, if everything else works out, the music application should launch and begin playing <span><em class="italic">ruby.mp3</em></span>. The script exits after the music application has been terminated. So, that's how to covertly communicate while maintaining your data integrity.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_400"/>
</body></html>