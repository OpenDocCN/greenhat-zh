- en: Chapter 3. GEOCODING
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '![image with no caption](httpatomoreillycomsourcenostarchimages671943.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: I've demonstrated some fun map examples in the first two chapters of this book,
    but there's been an elephant in the room. Those latitude and longitude points
    I explained in [Describe a Point on the Earth](ch01s02.html "Describe a Point
    on the Earth") in [Describe a Point on the Earth](ch01s02.html "Describe a Point
    on the Earth") are obviously useful to a computer, but not to humans. How often
    have you been invited to a party at a location designated by only geographic coordinates?
  prefs: []
  type: TYPE_NORMAL
- en: In this chapter, I'll show how you can take something that makes sense to you—addresses,
    city names, and even postal codes—and turn them into the latitude and longitude
    points that Mapstraction needs. The conversion is called *geocoding*, and we'll
    look at several methods you can put to use in your own mapping projects.
  prefs: []
  type: TYPE_NORMAL
- en: How Do Geocoders Work?
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: At first glance, a geocoder looks like an oracle. You pass it an address, it
    looks into its crystal ball, and then it replies with a pair of numbers. Like
    magic, the coordinates, when plotted on a map, are exactly where the address is
    located. Let's take a look behind the curtain and see how a geocoder works.
  prefs: []
  type: TYPE_NORMAL
- en: As with most magic, you may be disappointed to find out that most geocoding
    is really just estimation. Geocoding isn't elegant—it's sort of brute force.
  prefs: []
  type: TYPE_NORMAL
- en: 'First, the geocoder breaks the address into pieces. For example, consider Graceland''s
    address:'
  prefs: []
  type: TYPE_NORMAL
- en: 3734 Elvis Presley Blvd, Memphis, TN
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Street number, Street name, Suffix, City, State
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: The city is important because, believe it or not, other cities have an Elvis
    Presley Blvd. When you think of even more common names (say, Main Street), you
    can see how this step becomes important. In fact, within cities a road's suffix
    can be an issue, with a single street name being an Avenue, Street, Circle, and
    more. If you think those variations are confusing while navigating, think about
    how they confuse a geocoder.
  prefs: []
  type: TYPE_NORMAL
- en: A street name match might be the toughest part of fixing a location. Dealing
    with misspellings and other ways of formatting a name can be difficult. Like many
    other major cities, my hometown of Portland, Oregon, has a street named after
    Martin Luther King, Jr. The street, both in Portland and in other cities, is commonly
    referred to as *MLK*. Whether a geocoder should recognize this abbreviation is
    debatable, but that gives you an idea of the sort of things you have to consider.
  prefs: []
  type: TYPE_NORMAL
- en: Now that you've zeroed in on the correct street and know its city, you need
    to find the actual address on the street. Storing every last address in the world
    isn't necessary and would be difficult since new ones are created all the time.
    Instead, most geocoders use street segments, as shown in [Figure 3-1](ch03.html#geocoders_use_street_segments_to_estimat
    "Figure 3-1. Geocoders use street segments to estimate location.").
  prefs: []
  type: TYPE_NORMAL
- en: '![Geocoders use street segments to estimate location.](httpatomoreillycomsourcenostarchimages671983.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 3-1. Geocoders use street segments to estimate location.
  prefs: []
  type: TYPE_NORMAL
- en: Using our Graceland example, we might know that a segment of Elvis Presley Blvd
    begins at 3700 and ends at 3799\. We also know the latitude and longitude points
    at each end of the segment. Using those pieces of information, we can estimate
    that Graceland, at 3734, is about a third of the way between 3700 and 3799\. Using
    the two points, the geocoder can then calculate an approximate location.
  prefs: []
  type: TYPE_NORMAL
- en: JavaScript vs. HTTP Geocoding
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, I will cover two major methods of retrieving latitude and
    longitude results from an address: via a JavaScript geocoding API or via a geocoding
    web service over HTTP. On the surface, these methods are very similar because
    the data that comes back is the same. The difference is in what you can do with
    the results.'
  prefs: []
  type: TYPE_NORMAL
- en: '*JavaScript geocoders* call an external server with client-side code, meaning
    the code runs in the browser. This method is the same one used by Mapstraction
    and every mapping API. In this sense, JavaScript geocoders are extremely convenient
    for the web-mapping developer.'
  prefs: []
  type: TYPE_NORMAL
- en: '*HTTP geocoders* also call an external server, but do so from your server,
    so the code runs outside the browser. This method is similar to the one used by
    PHP, the web programming language I''ve employed to show examples in [Chapter 9](ch09.html
    "Chapter 9. GO SERVER-SIDE"). In fact, you might use PHP to interpret the results
    from an HTTP geocoder.'
  prefs: []
  type: TYPE_NORMAL
- en: Why would you use one type of geocoder over another? The quality of the data
    is similar, assuming the geocoders come from the same provider (i.e., Google).
    A JavaScript geocoder is usually just a wrapper for a server-side geocoder. In
    other words, both types end up calling upon the same dataset.
  prefs: []
  type: TYPE_NORMAL
- en: The decision about which geocoder to use comes down to how much freedom you
    want with input and output. You can use a JavaScript geocoder in only a narrow
    band of ways. The input likely comes from the user via a form. The output almost
    certainly goes to a web page or to a map on the web page.
  prefs: []
  type: TYPE_NORMAL
- en: Most of your location data will end up on a map, of course. You may want to
    do many things before that happens, however. Gaining control of the output is
    the biggest reason why you would use an HTTP geocoder. When the result is retrieved
    server-side, you have the option to store it to a database, cache the data, share
    the data over SMS or email, or send it off to a third-party service. Some of these
    options may be possible with a JavaScript geocoder, but they aren't easy to implement
    because they are outside the JavaScript geocoder's normal use—inside the browser.
  prefs: []
  type: TYPE_NORMAL
- en: By using an HTTP geocoder, you control where you get your input. For example,
    you might retrieve it from a database, a third-party service, or a list of addresses.
    With a JavaScript geocoder, the input likely comes directly from data the user
    enters in an input box on a website. For many uses, that's all you'll need, but
    other times you'll want more freedom.
  prefs: []
  type: TYPE_NORMAL
- en: If you spend enough time producing web maps, you'll probably combine JavaScript
    and HTTP geocoding. The rest of this chapter will focus on the different services
    you can use as you convert human-readable addresses to geographic coordinates
    (and vice versa).
  prefs: []
  type: TYPE_NORMAL
- en: '#12: Geocode with JavaScript'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: When you want geocoding that stays within the web browser, you use JavaScript,
    the same programming language used by Mapstraction and every mapping provider
    it supports. You can retrieve a city name or address from a user and send it off
    to be geocoded. The response goes to a JavaScript callback function that you declare.
  prefs: []
  type: TYPE_NORMAL
- en: 'As with mapping APIs, you can choose your own JavaScript geocoder. Predictably,
    I''ll show Mapstraction''s geocoder, which will use whichever provider you specify
    and give you the same flexibility that you get from using Mapstraction for creating
    maps: Write the code once and easily switch between providers.'
  prefs: []
  type: TYPE_NORMAL
- en: Because not every map requires geocoding, the geocoder is kept separate from
    the main Mapstraction code. Also, not every provider has a geocoder, so each is
    stored individually. In this example, we'll be using Google. You can download
    `mxn.google.geocoder.js` from [http://mapstraction.com/](http://mapstraction.com/).
  prefs: []
  type: TYPE_NORMAL
- en: 'You include the Mapstraction geocoder in your code much like you include your
    mapping provider and Mapstraction proper. Add this line (assuming the file is
    in the current directory) within the `<head>` section of your basic map:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'With the script included, use this code to initialize the map, geocode an address,
    and mark the result on the map:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: As with most map examples in this book, I use the `create_map` function to initialize
    the map. You can name this function whatever you want, as long as the function
    is called when the page loads.
  prefs: []
  type: TYPE_NORMAL
- en: To create the Mapstraction geocoder object, we need to provide a callback function
    ❶ and tell Mapstraction which provider ❷ we want to use (the provider's JavaScript
    still needs to be included). The callback function receives the geocoded results.
    First, we need to give an address or city name to the geocoder.
  prefs: []
  type: TYPE_NORMAL
- en: We create a generic JavaScript object ❸ to hold the textual location information.
    Then, we add attributes for the parts of the address. The names may be slightly
    odd because Mapstraction is attempting to work not just in your country but around
    the world.
  prefs: []
  type: TYPE_NORMAL
- en: Once the address's parts are filled in, you can send it to the geocoder ❹. Then,
    your callback function will be passed the results as a location object, which
    itself has some attributes of interest. Most important is the `LatLonPoint` of
    the address ❺. In this example, I've used the point to create a new marker.
  prefs: []
  type: TYPE_NORMAL
- en: The marker needs a description, which I'll put inside a message box. I'm using
    the full address ❻, which the geocoder has cleaned up. As you can see in [Figure 3-2](ch03s03.html#geocoded_results_of_no_starch_press_offi
    "Figure 3-2. Geocoded results of No Starch Press offices"), the geocoder has added
    the ZIP Code, converted "Street" to "St" and refers to the country as "USA" instead
    of "US."
  prefs: []
  type: TYPE_NORMAL
- en: '![Geocoded results of No Starch Press offices](httpatomoreillycomsourcenostarchimages671985.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 3-2. Geocoded results of No Starch Press offices
  prefs: []
  type: TYPE_NORMAL
- en: Of course, this example is only so useful. The address is hard-coded. You will
    likely be taking input from a user.
  prefs: []
  type: TYPE_NORMAL
- en: Geocode User Input
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: JavaScript geocoders most commonly require user input to be helpful. Let's tweak
    the code from the previous section to take a textual location from an input box
    and geocode it.
  prefs: []
  type: TYPE_NORMAL
- en: 'To start, you''ll need a place for the user to enter data. Let''s add a form
    to our HTML, either above or below the map `div`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'Now we need to do something when the user types in an address or city name.
    Here''s a new version of the `create_map` function with a few changes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: We can't geocode until we get input, which won't happen until the user submits
    the form. So we wait for submission ❶ and then jump into action with an anonymous
    function. We could have used a named function, but with only a few lines writing
    the code inline is easiest.
  prefs: []
  type: TYPE_NORMAL
- en: In the previous section, I separated each piece of the address. In the case
    of input from a user, that is not always possible. Instead, I've provided the
    entire value of the input box to the geocoder ❷.
  prefs: []
  type: TYPE_NORMAL
- en: The callback function, `add_point`, can remain the same. Enter an address and
    it adds a marker to the geocoded point. Do it again and now you have two markers.
    This geocoding could get addicting.
  prefs: []
  type: TYPE_NORMAL
- en: '#13: Geocode with an HTTP Web Service'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: JavaScript is convenient when you want to geocode in the browser. You gain more
    control of your geocoding by using a web service, however. The addresses can come
    from anywhere, including a list of places. The results can be stored anywhere,
    including a database, so you can access them anytime and plot them on a map.
  prefs: []
  type: TYPE_NORMAL
- en: Several geocoders are available to choose from, including one each from Google
    and Yahoo!. The input for each is slightly different, as are the results. In the
    next sections, I outline how to use these two geocoders and point you to a few
    others.
  prefs: []
  type: TYPE_NORMAL
- en: Use Google's Geocoding Web Service
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Google is the king of the web-mapping world, so of course, Google has a geocoding
    web service. You can use it to convert an address or city into latitude and longitude
    points and grab the result in one of several data formats. As an added benefit,
    Google pretties up the address for you and provides multiple options when the
    query is ambiguous.
  prefs: []
  type: TYPE_NORMAL
- en: 'One of the additional freedoms of using a web service to geocode is that you
    can look at results in a web browser, without writing any actual code. Check out
    the following URL in your browser:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: The parameters you can send to Google are shown in bold, along with all possible
    parameters that are shown in [Table 3-1](ch03s04.html#google_geocoder_parameters
    "Table 3-1. Google Geocoder Parameters"). The entire address is passed as the
    `q` query argument. You could also simply include a city name or postal code here.
  prefs: []
  type: TYPE_NORMAL
- en: Table 3-1. Google Geocoder Parameters
  prefs: []
  type: TYPE_NORMAL
- en: '| Parameter | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| `q` | *Required*. Query to search, such as address or city name |'
  prefs: []
  type: TYPE_TB
- en: '| `sensor` | *Required*. Whether from a mobile device: `true` or `false` |'
  prefs: []
  type: TYPE_TB
- en: '| `output` | Format of results: `json` (default), `xml`, `kml`, or `csv` |'
  prefs: []
  type: TYPE_TB
- en: '| `gl` | Country code as a top-level domain. E.g., `us`, `ca`, `uk` |'
  prefs: []
  type: TYPE_TB
- en: The `output` we want is XML, which can be read by most any programming language.
    And unless you are using this geocoder from a mobile device, set `sensor` to false.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now let''s look at the XML results from the above call to Google''s HTTP geocoder:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'The results are actually in *Keyhole Markup Language* (KML), a flavor of XML
    (see [#55: Use KML](ch08s04.html "#55: Use KML") in [#55: Use KML](ch08s04.html
    "#55: Use KML")). The coordinates and other information about the geocoded place
    are stored as Placemarks. In our example, we only have one Placemark ❶, because
    only one result is possible for a complete address. In ambiguous cases (say we
    searched for simply "Springfield"—many places have that name), the best result
    will be listed as the first Placemark, with others receiving incremented ids (i.e.,
    p2, p3, etc.).'
  prefs: []
  type: TYPE_NORMAL
- en: In fact, if you want your application to show possible results, as [http://maps.google.com/](http://maps.google.com/)
    does, use the full formatted address ❷ of each Placemark. You can see here that
    Google cleaned up even my specific address, converting the "Street" to "St" and
    adding the postal code.
  prefs: []
  type: TYPE_NORMAL
- en: The pieces of the address can also be accessed individually, yet the tag names
    might seem strange to you. That's because Google has made them generic, so the
    tags aren't confusing to people not in the United States. The state abbreviation
    ❸ is called an *Administrative Area Name*, for example.
  prefs: []
  type: TYPE_NORMAL
- en: Accessing the values individually makes showing just the city ❹ or only the
    address ❺ easier. Also, accessing them individually is a quick way to determine
    a place's postal code ❻ (called a ZIP Code in the US).
  prefs: []
  type: TYPE_NORMAL
- en: Finally, the most important part of geocoding is the latitude and longitude
    points. These points are stored together within a single tag ❼. You can use a
    split function (one using PHP is shown in the next section) to retrieve the coordinates'
    individual pieces.
  prefs: []
  type: TYPE_NORMAL
- en: Did you notice that Google provides three numbers instead of just two? The third
    represents altitude and is a property of the KML format. The geocoder does not
    send this value, so it will always be zero.
  prefs: []
  type: TYPE_NORMAL
- en: If you need help bringing these geocoder results into your applications, [Chapter 9](ch09.html
    "Chapter 9. GO SERVER-SIDE") can show you how to do so in PHP. Or, if you only
    need the coordinates, read on to see Google's approach to really simple geocoding.
  prefs: []
  type: TYPE_NORMAL
- en: Alternate Data Formats
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: I love XML, but it's not always the preferred data format. Google's web service
    geocoder gives you a choice of several formats, including JavaScript Object Notation
    (JSON) and comma-separated values (CSV). The latter is great when you want "just
    the facts."
  prefs: []
  type: TYPE_NORMAL
- en: 'Plop an `output` argument in the URL and set its value to be the desired format,
    for example:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'Here, we ask for CSV. Unlike other result formats, we don''t get a rewritten
    address, a postal code, or any other niceties. We do, however, get the four most
    important values separated by commas:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: The first part is the code from the server. A `200` means we have a good result.
    Anything else, and we likely have an error.
  prefs: []
  type: TYPE_NORMAL
- en: The second part is a number that represents the granularity of our result. Is
    it street-level (an address), postal-level, or city-level? The possible results
    are roughly equivalent to zoom levels, as shown in [Table 3-2](ch03s04.html#levels_codes_for_geocoding_accuracy
    "Table 3-2. Levels Codes for Geocoding Accuracy").
  prefs: []
  type: TYPE_NORMAL
- en: Table 3-2. Levels Codes for Geocoding Accuracy
  prefs: []
  type: TYPE_NORMAL
- en: '| Code | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| 0 | Unknown |'
  prefs: []
  type: TYPE_TB
- en: '| 1 | Country |'
  prefs: []
  type: TYPE_TB
- en: '| 2 | State (or similar region) |'
  prefs: []
  type: TYPE_TB
- en: '| 3 | County (or other subregion) |'
  prefs: []
  type: TYPE_TB
- en: '| 4 | City |'
  prefs: []
  type: TYPE_TB
- en: '| 5 | Postal code |'
  prefs: []
  type: TYPE_TB
- en: '| 6 | Street |'
  prefs: []
  type: TYPE_TB
- en: '| 7 | Intersection |'
  prefs: []
  type: TYPE_TB
- en: '| 8 | Address |'
  prefs: []
  type: TYPE_TB
- en: '| 9 | Building (such as landmarks) |'
  prefs: []
  type: TYPE_TB
- en: The last two numbers of the CSV results might look familiar. They are the latitude
    and longitude points (in that order). These results are probably the most important
    because geocoding is all about turning a city name or address into plotable coordinates.
  prefs: []
  type: TYPE_NORMAL
- en: 'Here''s some simple PHP code that calls out to the Google geocoder web service,
    parses the CSV results, and saves the coordinates to variables:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: This code is just a snippet to give you an idea of how to separate simple CSV
    results like those in this example. If you run this code, nothing will happen
    because all I have shown here is storing the results in variables.
  prefs: []
  type: TYPE_NORMAL
- en: To begin, we create a variable to hold the URL we'll use to call Google. Because
    the variable is long and this book's pages are only so wide, I split it into two
    lines ❶, but to PHP, the variable is all one text string.
  prefs: []
  type: TYPE_NORMAL
- en: 'The URL is then passed to the `get_url` function ❷, one I will show you how
    to write in [#61: Retrieve a Web Page](ch09s03.html "#61: Retrieve a Web Page")
    in [#61: Retrieve a Web Page](ch09s03.html "#61: Retrieve a Web Page"). You''ll
    need to include a file with that code or paste a copy of the function near the
    bottom of your PHP file.'
  prefs: []
  type: TYPE_NORMAL
- en: Once we have a result from Google, we explode the text ❸ into several pieces,
    all stored in a single array variable. Because a comma is used to separate the
    data, that's the delimiter we'll use to split the text.
  prefs: []
  type: TYPE_NORMAL
- en: With the pieces stored as elements of an array, we're almost ready to get our
    latitude and longitude. We need to make sure the array variable has four results
    ❹, as expected. Also, the first number in the results needs to be `200` ❺, the
    code for a good result.
  prefs: []
  type: TYPE_NORMAL
- en: Because arrays in PHP start counting at the zeroth spot, our latitude and longitude
    are stored as the second and third indexes of the explode result variable. With
    very little PHP code and even less text, you've now successfully turned an address
    into geographic coordinates.
  prefs: []
  type: TYPE_NORMAL
- en: Use Yahoo!'s Geocoding Web Service
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Though Google may get the lion's share of the press, Yahoo's geo-developer tools
    are exceptional. Such is the case with its easy-to-use, full-featured geocoding
    web service. You pass a city name or full address and Yahoo! spits out simple
    XML with coordinates and other geographic data.
  prefs: []
  type: TYPE_NORMAL
- en: 'Because the result is just plain XML, you can check it out in your web browser
    to get a feel for how the service works. Visit this URL:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: The arguments are shown in bold. You'll need your API key as the `appid`. This
    ID is the same as for the Yahoo! Maps API. I showed you how to sign up for an
    ID in [Create a Yahoo! Map](ch01s03.html#create_a_yahoo_exclamation_map "Create
    a Yahoo! Map") in [Create a Yahoo! Map](ch01s03.html#create_a_yahoo_exclamation_map
    "Create a Yahoo! Map").
  prefs: []
  type: TYPE_NORMAL
- en: 'In this example, the pieces of the address are segmented into `street`, `city`,
    and `state`. You can also use a single argument for an address, similar to Google''s
    geocoder:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: The `location` argument contains all the pieces in the previous example but
    puts them in one place. If you are receiving an address as input from a user,
    you will prefer this option unless you have a way to separate the address into
    pieces (such as multiple form fields).
  prefs: []
  type: TYPE_NORMAL
- en: 'No matter which way you call the API, the results will be formatted the same
    way:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: Compared to Google's XML results, these results are very simple. The latitude
    and longitude are shown separately, as are the pieces of the address (even if
    you send the location as one string of text, Yahoo! separates things out for you).
    Each field makes sense as long as you are geocoding addresses or cities in the
    United States. In Canada, for example, you have to know that provinces are stored
    in the `<state>` tag.
  prefs: []
  type: TYPE_NORMAL
- en: If your search has ambiguous results, such as a non-unique city name, Yahoo!
    will put the best result first. Other results will follow inside their own `<Result>`
    tag.
  prefs: []
  type: TYPE_NORMAL
- en: 'Because you''re working with simple XML here, you can parse them as you would
    any other XML. [#52: Use XML](ch08.html#number_symble_52_colon_use_xml "#52: Use
    XML") in [#52: Use XML](ch08.html#number_symble_52_colon_use_xml "#52: Use XML")
    shows this process in PHP and JavaScript. If you want other formats, Yahoo! does
    provide results as JSON or Serialized PHP. The first is covered in [#53: Use JSON](ch08s02.html
    "#53: Use JSON") in [#53: Use JSON](ch08s02.html "#53: Use JSON"), whereas the
    second is explained at [http://developer.yahoo.com/common/phpserial.html/](http://developer.yahoo.com/common/phpserial.html/).'
  prefs: []
  type: TYPE_NORMAL
- en: Other Geocoding Web Services
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The previous examples show the two most likely choices for geocoders, but you
    have other options, especially if you are willing to pay for the service. Why
    shell out dough when Google and Yahoo! give away geocoding? Your choice really
    comes down to the terms of service and rate limits, which can restrict your use
    of a geocoder for high traffic, commercial purposes.
  prefs: []
  type: TYPE_NORMAL
- en: You won't necessarily need to crush that piggy bank to use a for-pay geocoder.
    For example, *geocoder.us* only charges a quarter of a US cent to geocode an address.
    For an up-to-date list of geocoder services, see [http://mapscripting.com/geocoders/](http://mapscripting.com/geocoders/).
  prefs: []
  type: TYPE_NORMAL
- en: '#14: Reverse Geocoding: Get an Address from a Point'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: So far we have used human-readable information—a city name or address—to retrieve
    latitude and longitude points, which are easier for a computer to understand.
    From time to time, you may want to go the other way. If all you have is a set
    of coordinates, you can use them to reverse geocode to get the address and other
    geographic information that will make sense to a human.
  prefs: []
  type: TYPE_NORMAL
- en: Regular geocoding is complicated and imprecise, but reverse geocoding is more
    so. First, the geocoder finds the street that is closest to the coordinates; then,
    it determines which address belongs to that point. Truthfully, the result is more
    often a range of addresses.
  prefs: []
  type: TYPE_NORMAL
- en: 'Reverse geocoding may seem a little silly given that it is imperfect. But as
    location becomes more prevalent on the Web, reverse geocoding will become more
    common. For example, consider [#48: Get Location Using JavaScript](ch07s02.html
    "#48: Get Location Using JavaScript") in [#48: Get Location Using JavaScript](ch07s02.html
    "#48: Get Location Using JavaScript"). In many cases, the GPS or other device
    reporting someone''s whereabouts will only provide the latitude and longitude
    points. That information is enough to plot it on a map, but not enough to make
    much sense to humans viewing the information.'
  prefs: []
  type: TYPE_NORMAL
- en: In the following sections, I'll show two services, both from Google, that will
    provide reverse geocoding, helping you create geographic information from computer-readable
    data.
  prefs: []
  type: TYPE_NORMAL
- en: Reverse Geocode with JavaScript
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you use Google as your mapping provider, reverse geocoding can happen within
    your JavaScript code without even loading Mapstraction's geocoder (which only
    supports *forward* geocoding). In this example, we'll still use Mapstraction because
    the reverse geocoding is only a small part of a map's code.
  prefs: []
  type: TYPE_NORMAL
- en: Let's create a basic Mapstraction map, with Google as the provider. We'll convert
    the center of the map to a Google point and send it off to be reverse geocoded.
  prefs: []
  type: TYPE_NORMAL
- en: 'Assuming you have your HTML set up as in [Create a Mapstraction Map](ch01s03.html#create_a_mapstraction_map
    "Create a Mapstraction Map") in [Create a Mapstraction Map](ch01s03.html#create_a_mapstraction_map
    "Create a Mapstraction Map"), here is the JavaScript to create the map and call
    the Google geocoder:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: As promised, much of this code is comprised of Mapstraction functions. The Google-specific
    calls are separated out. For example, we create a geocoder object ❶ and then make
    the call to get the location. Even this contains some Mapstraction, as we use
    it to get the center of the map ❷ and convert that point to one Google understands.
  prefs: []
  type: TYPE_NORMAL
- en: With the call to the geocoder, we need to provide a callback function ❸. This
    function is used when the result comes back from Google. Because we created a
    named function, we also need to create the function with that name.
  prefs: []
  type: TYPE_NORMAL
- en: The `found_address` function takes one argument, which is the results object
    that Google's geocoder sends to us. Once we've determined we have a good response
    ❹ (a status code of `200`), we can grab the point ❺, which contains our coordinates.
  prefs: []
  type: TYPE_NORMAL
- en: You might wonder why the point is even necessary, seeing as this is the piece
    of data that you started with. In many cases, Google isn't able to find an address
    at your *exact* point (imagine the center of a large park, for example), so it
    chooses one nearby. In that case, you'll want to know the point it used, so you
    can plot accordingly.
  prefs: []
  type: TYPE_NORMAL
- en: Google might actually send multiple results, which would be stored in the `response.Placemark`
    array. The first is its best guess and probably the one to use, though in some
    situations you could allow the user to select the most accurate result.
  prefs: []
  type: TYPE_NORMAL
- en: Most of the remaining code in `found_address` will look familiar, as it's standard
    Mapstraction functions from [Chapter 2](ch02.html "Chapter 2. PLOTTING MARKERS
    AND MESSAGE BOXES"). We put a marker at the location Google returned. Then, we
    use the most important piece of information, the address ❻, as the message inside
    the marker's box.
  prefs: []
  type: TYPE_NORMAL
- en: To get a good feel for reverse geocoding, try changing the coordinates you pass
    to Google by altering the center of the map. Or, read on to make a map that reverse
    geocodes wherever you click.
  prefs: []
  type: TYPE_NORMAL
- en: Reverse Geocode in a Click
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Want to play around with reverse geocoding? Attempting to click exactly on your
    own address to see how close you can come to your exact location can be fun. Also,
    giving yourself quick access to reverse geocoding can be a good developer tool
    to get a better idea of how the process works.
  prefs: []
  type: TYPE_NORMAL
- en: 'You can use most of the previous example. In fact, `found_address` can stay
    exactly the same. Replace the `create_map` function with this slightly altered
    version:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: I added some zoom controls ❶ to the map, so you can find specific places to
    click (in San Francisco, unless you change the map's center or scroll the map
    to another location). Then I wrote some code that waits for a click event ❷ on
    the map. When the click occurs, it calls an anonymous, inline function. This function
    could be named, but with only a few simple lines, writing it inline is easier.
  prefs: []
  type: TYPE_NORMAL
- en: Within the anonymous function, we make a call to the Google geocoder very similar
    to the one we used before. In this instance, we pass the point where the user
    clicked ❸ instead of the center of the map. Note that we need to convert the point
    to the proprietary Google coordinate type because Mapstraction captures the clickpoint
    but then needs to pass it off to a Google geocoder. Mapstraction speaks Google,
    but Google does not speak Mapstraction.
  prefs: []
  type: TYPE_NORMAL
- en: Because the other code is the same, clicking the map adds a marker with the
    address in an opened message box. Click a few more times and additional markers
    will appear on the map, containing the geographic information provided by the
    reverse geocoder.
  prefs: []
  type: TYPE_NORMAL
- en: Are you beginning to see the usefulness of a reverse geocoder? In the next section,
    you'll be able to access that data outside of JavaScript, with Google's HTTP geocoder.
  prefs: []
  type: TYPE_NORMAL
- en: Reverse Geocode with Google's Web Service
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: As I've mentioned elsewhere in this chapter, power and flexibility come from
    being able to control the input and output of a geocoder. You can have the same
    freedom using the reverse geocoding provided by Google's web service.
  prefs: []
  type: TYPE_NORMAL
- en: 'With a tiny tweak to the URL, Google''s geocoder becomes a reverse geocoder:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'We''re still using the `q` query argument, as we did in the Google portion
    of [#13: Geocode with an HTTP Web Service](ch03s04.html "#13: Geocode with an
    HTTP Web Service") in [#13: Geocode with an HTTP Web Service](ch03s04.html "#13:
    Geocode with an HTTP Web Service"). Instead of passing an address, we send the
    latitude and longitude, in that order and separated by a comma (bolded in the
    above URL).'
  prefs: []
  type: TYPE_NORMAL
- en: 'The results are virtually the same as with the forward geocoder:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: The biggest difference is that you are bound to have multiple Placemarks, because
    reverse geocoding is much less precise than standard geocoding. Otherwise, the
    content you receive within each Placemark is the same, right down to the postal
    code—as, of course, is the address (or range), which is the entire point of the
    process in the first place.
  prefs: []
  type: TYPE_NORMAL
- en: No longer will you have to leave users attempting to decipher strange numbers
    that are made for a computer to understand. Whether you choose JavaScript or a
    server-side web service, you can go from coordinates to text with a quick call
    to a reverse geocoder.
  prefs: []
  type: TYPE_NORMAL
- en: '#15: Get Postal Code Coordinates'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Have you ever been to a website that asked you to enter your ZIP Code to find
    a store's nearest location? Probably yes, I'd guess. This section will help you
    take the first step toward creating something like that yourself. You need a way
    to turn a postal code into geographic coordinates.
  prefs: []
  type: TYPE_NORMAL
- en: You may be thinking that a large area cannot be turned into a single geographic
    point. You're right, though the same could be said about any address where the
    geocode result tends to be a point near the street. What about your backyard?
  prefs: []
  type: TYPE_NORMAL
- en: Remember, geocoding is not a precise science. For an address, a point is chosen
    that makes sense. For a postal code, the most logical point is somewhere near
    the center. Even the center is difficult to determine for the amorphous boundaries
    of some places, however. Hence, the latitude and longitude represent a spot *near*
    the center.
  prefs: []
  type: TYPE_NORMAL
- en: 'The easiest method for getting coordinates of a postal code is to search using
    a geocoding service. For example, if you wanted to look up the most famous ZIP
    Code in Beverly Hills using a Yahoo! geocoder, you''d use this URL:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'And your results would look something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: Note that the precision is ZIP-level and the address tag is empty. Otherwise,
    the results are similar to what gets returned when you search for a complete address.
  prefs: []
  type: TYPE_NORMAL
- en: Install a Postal Code Database
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you need to perform a lot of lookups, or want faster access to the results,
    having a database table to geocode postal codes without the use of another service
    makes sense. The United States has fewer than 50,000 ZIP Codes, a reasonably small
    number of records to store and access. Other countries have more unique postal
    codes (Canada, for example, has nearly a million, which is still small enough
    to be worth it).
  prefs: []
  type: TYPE_NORMAL
- en: You will need a database to keep your postal codes and their corresponding coordinates.
    In [Chapter 9](ch09.html "Chapter 9. GO SERVER-SIDE"), I describe how to install
    MySQL and import data from a CSV file. The book's website contains links where
    you can download postal code databases for free. See [http://mapscripting.com/postal-code-database](http://mapscripting.com/postal-code-database).
  prefs: []
  type: TYPE_NORMAL
- en: 'The fields contained in the databases will vary, but here''s an example structure
    of a US ZIP Code database:'
  prefs: []
  type: TYPE_NORMAL
- en: '| **ZIP Code** The postal code |'
  prefs: []
  type: TYPE_TB
- en: '| **name** A textual description of this ZIP Code, such as neighborhood or
    city name |'
  prefs: []
  type: TYPE_TB
- en: '| **latitude** The north/south portion of the coordinates |'
  prefs: []
  type: TYPE_TB
- en: '| **longitude** The east/west portion of the coordinates |'
  prefs: []
  type: TYPE_TB
- en: A very basic database may not even contain a name field, as the most important
    part of a postal code database is converting from the code to a point.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: You'll want to pay attention to whether the ZIP Code field is stored as text
    or a number. Some prefer text because text can better represent ZIP Codes that
    begin with a zero. Databases are able to search for numbers more efficiently,
    however, so you'll need to make sure to strip off any zeros at the beginning of
    user input.
  prefs: []
  type: TYPE_NORMAL
- en: 'With a full database of postal codes loaded into the `zipcoord` table (a name
    I made up), the SQL to find the coordinates for Beverly Hills, 90210, would look
    something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'You should only get one set of coordinates from that database call because
    only one 90210 postal code exists. To learn more about accessing the SQL results
    with PHP, see [#65: Use MySQL from PHP](ch09s07.html "#65: Use MySQL from PHP")
    in [#65: Use MySQL from PHP](ch09s07.html "#65: Use MySQL from PHP").'
  prefs: []
  type: TYPE_NORMAL
- en: 'Now that you can get postal code coordinates, you''re ready to do something
    with them. At the beginning of this project, I mentioned websites that have a
    search box to find locations near your ZIP Code. Combine your postal code result
    with [#46: Get Nearest Locations from Your Own Database](ch06s11.html "#46: Get
    Nearest Locations from Your Own Database") in [#46: Get Nearest Locations from
    Your Own Database](ch06s11.html "#46: Get Nearest Locations from Your Own Database"),
    and you''ll have built a store locator, just like you''ve seen on those sites.'
  prefs: []
  type: TYPE_NORMAL
