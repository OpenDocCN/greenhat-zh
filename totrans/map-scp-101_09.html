<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;GO SERVER-SIDE"><div class="titlepage"><div><div><h1 class="title"><a id="go_server-side"/>Chapter 9. GO SERVER-SIDE</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject9_d1e10284"/><img src="httpatomoreillycomsourcenostarchimages671943.png.jpg" alt="image with no caption"/></div></div><p>Mapping APIs are popular because they bring a lot of power to the web browser that used to be much more difficult for the average developer to achieve. Plenty of situations still exist, however, where your application will benefit from scripts that run <span class="emphasis"><em>outside</em></span> of the browser. This is when you'll need to go server-side.<a id="IDX-CHP-9-0001" class="indexterm"/></p><p>In this chapter, we'll look at two popular technologies that run on a server: PHP, a programming language used mostly to output web pages; and MySQL, a database for storing text, numbers, and a whole lot more. As opposed to the numerous other available technologies, I've chosen these two for their ubiquity—almost all web hosts support them. They are also solid platforms used by many including, most notably, Yahoo!.</p><p>Entire books have been devoted to PHP and MySQL, together and separately. I'll only provide a very quick primer to get you started. Then we'll dive into how each can help you make better maps, including storing locations and finding the nearest locations from your database.</p><div class="sect1" title="#59: Install PHP"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_59_colon_install_php"/>#59: Install PHP</h1></div></div></div><p>PHP is an extremely popular programming language for easily creating dynamic web pages and applications. You can install it on your computer for testing or on a server for sharing with the world. In fact, if you have web hosting on a server, PHP may already be installed.<a id="IDX-CHP-9-0002" class="indexterm"/><a id="IDX-CHP-9-0003" class="indexterm"/><a id="IDX-CHP-9-0004" class="indexterm"/><a id="IDX-CHP-9-0005" class="indexterm"/><a id="IDX-CHP-9-0006" class="indexterm"/></p><p>You need to use PHP in conjunction with a web server, the most common of which is Apache. Requests come from a web browser to your web server, which then looks to see if the page being requested uses PHP. If it does, then the page is sent to PHP for processing.</p><p>Next I show several ways to install PHP—or to determine if it is already installed. In only one situation will you have to also worry about installing Apache. Read on and we'll get you up to speed with PHP.</p><div class="sect2" title="Check Your Web Host for PHP"><div class="titlepage"><div><div><h2 class="title"><a id="check_your_web_host_for_php"/>Check Your Web Host for PHP</h2></div></div></div><p>If you already have web hosting, you almost certainly have PHP installed already. The easiest way to check is to create a simple PHP file and then try accessing it with a web browser.</p><p>You'll want to put this new file where you already know HTML files can be accessed. Your site administrator (who could also confirm whether you are able to access PHP) can point you to your public directory where web pages are stored.</p><p>Create a new PHP file in your web directory and add these few lines:</p><a id="I_programlisting9_d1e10338"/><pre class="programlisting">&lt;?php
  print phpinfo();
?&gt;</pre><p>Easy enough. Give the file a name ending in <span class="emphasis"><em>.php</em></span> (I creatively chose <span class="emphasis"><em>test.php</em></span>), and then from your web browser, go to its public web address. For example, I might go to <span class="emphasis"><em>mapscripting.com/test.php</em></span>.</p><p>If you see your own code when you load that file, then you probably don't have PHP. You'll need to ask your administrator to install it or find another way to use PHP. You'll know PHP is installed, however, if you see an information page like the one shown in <a class="xref" href="ch09.html#the_php_info_dumped_by_my_local_machine" title="Figure 9-1. The PHP info dumped by my local machine">Figure 9-1</a>. Remember to delete the file from your server when you're done.</p><div class="figure"><a id="the_php_info_dumped_by_my_local_machine"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e10358"/><img src="httpatomoreillycomsourcenostarchimages672087.png.jpg" alt="The PHP info dumped by my local machine"/></div></div><p class="title">Figure 9-1. The PHP info dumped by my local machine</p></div><p>If you're new to PHP, you might want to skip ahead to <a class="xref" href="ch09s02.html" title="#60: A Quick PHP Introduction">#60: A Quick PHP Introduction</a> in <a class="xref" href="ch09.html#install_php_yourself" title="Install PHP Yourself">Install PHP Yourself</a>. Otherwise, you need to check whether you have MySQL installed, too (see <a class="xref" href="ch09s04.html" title="#62: Install MySQL">#62: Install MySQL</a> in <a class="xref" href="ch09s03.html#include_your_function_in_other_scripts" title="Include Your Function in Other Scripts">Include Your Function in Other Scripts</a>), or connect PHP to MySQL (see <a class="xref" href="ch09s07.html" title="#65: Use MySQL from PHP">#65: Use MySQL from PHP</a> in <a class="xref" href="ch09s07.html" title="#65: Use MySQL from PHP">#65: Use MySQL from PHP</a>).<a id="IDX-CHP-9-0007" class="indexterm"/></p></div><div class="sect2" title="Use a Packaged Installation of PHP"><div class="titlepage"><div><div><h2 class="title"><a id="use_a_packaged_installation_of_php"/>Use a Packaged Installation of PHP</h2></div></div></div><p>The easiest way to install PHP on your own computer is to download a package for your operating system. The upside to this method is that you'll also get Apache and MySQL at the same time, which is useful.</p><p>The names of the packages are patterned after the popular server architecture, <span class="emphasis"><em>LAMP</em></span>, which stands for <span class="bolditalic">L</span><span class="emphasis"><em>inux</em></span>, <span class="bolditalic">A</span><span class="emphasis"><em>pache</em></span>, <span class="bolditalic">M</span><span class="emphasis"><em>ySQL</em></span>, and <span class="bolditalic">P</span><span class="emphasis"><em>HP</em></span>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Windows (WAMP): <a class="ulink" href="http://www.wampserver.com/">http://www.wampserver.com/</a><a id="IDX-CHP-9-0008" class="indexterm"/></p></li><li class="listitem"><p>Macintosh (MAMP): <a class="ulink" href="http://www.mamp.info/">http://www.mamp.info/</a><a id="IDX-CHP-9-0009" class="indexterm"/></p></li></ul></div><p>Either of these packages should install on your computer without needing much information from you (though you may have to enter an administrator password).</p><p>Open WAMP/MAMP once the install process has completed. The program should open two windows. First, it will open a small status dashboard, as shown in <a class="xref" href="ch09.html#the_mamp_console" title="Figure 9-2. The MAMP console">Figure 9-2</a>. Second, the application will also create a new web browser window pointed at <span class="emphasis"><em>localhost</em></span>, the name of the server on your own computer. By default, you'll see a welcome screen.<a id="IDX-CHP-9-0010" class="indexterm"/></p><div class="figure"><a id="the_mamp_console"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e10442"/><img src="httpatomoreillycomsourcenostarchimages672089.png.jpg" alt="The MAMP console"/></div></div><p class="title">Figure 9-2. The MAMP console</p></div><p>You'll want to change the directory that WAMP/MAMP uses to look for your files. To do this, click the <span class="strong"><strong>Preferences</strong></span> button, which will open a new pane with more options. Click the Apache (web server) tab, and then select a new document root, as shown in <a class="xref" href="ch09.html#change_the_mamp_document_root" title="Figure 9-3. Change the MAMP document root.">Figure 9-3</a>.</p><div class="figure"><a id="change_the_mamp_document_root"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e10457"/><img src="httpatomoreillycomsourcenostarchimages672091.png.jpg" alt="Change the MAMP document root."/></div></div><p class="title">Figure 9-3. Change the MAMP document root.</p></div></div><div class="sect2" title="Install PHP Yourself"><div class="titlepage"><div><div><h2 class="title"><a id="install_php_yourself"/>Install PHP Yourself</h2></div></div></div><p>If you're using an operating system for which a package is not available, you'll need to install PHP yourself. Too many variations exist to describe in this chapter, but many tutorials are available on the Internet to help you.<a id="IDX-CHP-9-0011" class="indexterm"/></p><p>The PHP website is the first place to start: <a class="ulink" href="http://php.org/">http://php.org/</a>.<a id="IDX-CHP-9-0012" class="indexterm"/></p></div></div></div>
<div class="sect1" title="#60: A Quick PHP Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_60_colon_a_quick_php_intro"/>#60: A Quick PHP Introduction</h1></div></div></div><p>Some very thick books—much thicker than this one—are dedicated to teaching you how to program with PHP. This project will provide the boost necessary to use PHP in some of your mapping projects. It will not, however, make you a master.</p><p>In the sections that follow you'll learn the very basics about structuring PHP code. I'll also show you how to use conditionals, often called <span class="emphasis"><em>if statements</em></span>. Next, you'll learn how to work with arrays and then use loops. Finally, I'll show how to create your own functions to reduce the amount of PHP you need to write.<a id="IDX-CHP-9-0013" class="indexterm"/></p><div class="sect2" title="The Nitty Gritty"><div class="titlepage"><div><div><h2 class="title"><a id="the_nitty_gritty"/>The Nitty Gritty</h2></div></div></div><p>PHP code is usually added to a file that ends with a <span class="emphasis"><em>.php</em></span> extension. When the program is finished running, the output is most often HTML (though it can also be XML, JSON, or any text that can be transferred using HTTP). As such, PHP can be interspersed with plain HTML.</p><p>The PHP portions of the code are surrounded by a special <span class="emphasis"><em>twi-character blocks</em></span>, <code class="literal">&lt;?php</code> and <code class="literal">?&gt;</code>. For example, try this small bit of code, which combines PHP and HTML:<a id="IDX-CHP-9-0014" class="indexterm"/><a id="IDX-CHP-9-0015" class="indexterm"/><a id="IDX-CHP-9-0016" class="indexterm"/><a id="IDX-CHP-9-0017" class="indexterm"/><a id="IDX-CHP-9-0018" class="indexterm"/><a id="IDX-CHP-9-0019" class="indexterm"/><a id="IDX-CHP-9-0020" class="indexterm"/><a id="IDX-CHP-9-0021" class="indexterm"/><a id="IDX-CHP-9-0022" class="indexterm"/><a id="IDX-CHP-9-0023" class="indexterm"/><a id="IDX-CHP-9-0024" class="indexterm"/></p><a id="I_programlisting9_d1e10549"/><pre class="programlisting">&lt;html&gt;
&lt;body&gt;
&lt;?php
  print "This text comes from PHP!";
?&gt;
&lt;/body&gt;
&lt;/html&gt;</pre><p>This code is abbreviated HTML, of course. But from it, you should get an idea of how PHP works. And the code will load into a browser and simply display the text within the quotes, which is output by PHP's <code class="literal">print</code> function. Note the semicolon—most lines of PHP end with a semicolon. Exceptions exist, however; if you write a command on a single line, chances are it needs a <code class="literal">;</code> at the end.</p><p>Variables store values that can be changed or accessed later. They can hold numbers, text, and more and usually have a descriptive name, always starting with a dollar sign. For example, <code class="literal">$mynum</code> could be a variable for holding a single number.</p><p>Here is some code similar to the previous code, but containing a few variables:</p><a id="I_programlisting9_d1e10566"/><pre class="programlisting">&lt;html&gt;
  &lt;body&gt;
  &lt;?php
❶   $msg = "This is text";
❷   $mynum = 5 + 1;
❸   $msg = $msg . " and a number: " . $mynum;
    print $msg;
  ?&gt;
  &lt;/body&gt;
  &lt;/html&gt;</pre><p>When you run this example, it produces the following output:</p><a id="I_programlisting9_d1e10570"/><pre class="programlisting">This is text and a number: 6</pre><p>The code starts with a text variable ❶, often called a <span class="emphasis"><em>string</em></span>. This variable starts the line that will eventually be the code's output. Next, you create a number variable ❷. I could have simply set this variable to 6, but I wanted to show how to add two numbers together.</p><p>In the final line ❸ before outputting our message, I set the string equal to itself and then concatenate it with more text, before finally tacking the number onto the end. Note that to combine strings, you use a period, but to combine numbers, use a plus sign.</p><p>If we replaced the plus in line ❷ with a period, the number output at the end of the message would be <code class="literal">51</code> (five followed by a one, instead of the number five added to the number one). If we replaced the first period in line ❸ with a plus sign, the entire message would be <code class="literal">06</code>, because the number representation of text is zero.<a id="IDX-CHP-9-0025" class="indexterm"/><a id="IDX-CHP-9-0026" class="indexterm"/></p><p>Using the correct operator to combine numbers and text is important because the operator you use can change your output a great deal.</p></div><div class="sect2" title="Taking Input"><div class="titlepage"><div><div><h2 class="title"><a id="taking_input"/>Taking Input</h2></div></div></div><p>You can accept input from the user in two ways: from the URL itself or through a form. Regardless of which possibility you choose, the method for accessing this data within PHP is very similar.</p><p>If input is being passed in the URL, you'll see something like this:</p><a id="I_programlisting9_d1e10605"/><pre class="programlisting">yourfile.php?msg=Hello+there&amp;num=42</pre><p>To get at this info, you'll need to use a special PHP variable called <code class="literal">$_GET</code>. <code class="literal">$_GET</code> is an associative array, which is a collection of key-value pairs accessed using bracket syntax. Generally, you'll want to take the value from this array and put it into a new variable.</p><p>For example, here is some PHP to access the two pieces of input:</p><a id="I_programlisting9_d1e10617"/><pre class="programlisting">&lt;html&gt;
  &lt;body&gt;
  &lt;?php
    if ($_GET["msg"] != "" &amp;&amp; $_GET["num"] != "") {
❶     $msg = $_GET["msg"];
❷     $mynum = $_GET["num"];
❸     print "Your message is " . $msg . " and your number is " . $mynum;
    }
  ?&gt;
  &lt;/body&gt;
  &lt;/html&gt;</pre><p>Here's the output of this PHP program:</p><a id="I_programlisting9_d1e10621"/><pre class="programlisting">Your message is Hello there and your number is 42</pre><p>To grab the message ❶, I put the key used in the URL (i.e., <strong class="userinput"><code>msg</code></strong><code class="literal">=Hello+there</code>) inside brackets after the <code class="literal">$_GET</code> variable.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>The name of the variables do not need to match the names used in the URL, though they can.</p></div><p>Now I want to get at the number, which is the <code class="literal">num=42</code> section of the URL. I use the same method as in the previous code ❷, even though this is a number. Finally, I print out both of my new variables, along with some descriptive text ❸. Notice the periods used to concatenate the portions of the output.<a id="IDX-CHP-9-0027" class="indexterm"/><a id="IDX-CHP-9-0028" class="indexterm"/><a id="IDX-CHP-9-0029" class="indexterm"/><a id="IDX-CHP-9-0030" class="indexterm"/><a id="IDX-CHP-9-0031" class="indexterm"/><a id="IDX-CHP-9-0032" class="indexterm"/><a id="IDX-CHP-9-0033" class="indexterm"/><a id="IDX-CHP-9-0034" class="indexterm"/></p><p>Retrieving data from a form is very similar. Instead of <code class="literal">$_GET</code>, you use the variable <code class="literal">$_POST</code>. The only tricky part is that the form must have been sent to this page using the <code class="literal">action</code> attribute in HTML.</p></div><div class="sect2" title="If This Is True, Then Do That"><div class="titlepage"><div><div><h2 class="title"><a id="if_this_is_true_comma_then_do_that"/>If This Is True, Then Do That</h2></div></div></div><p>Your PHP programs need to make decisions. Because they aren't able to do this on their own, you need to tell them how to decide what to do. You do this using a <span class="emphasis"><em>conditional</em></span>—or <span class="emphasis"><em>if</em></span> statement.</p><p>We'll build upon the previous example, where we received input in the URL, but we'll just use the number portion. We want to look at the number and provide different output if the number is a double digit number (10 or greater).</p><p>Our URL will look something like this: <span class="emphasis"><em>yourfile.php?num=42</em></span>.</p><p>And here is the code, including our two conditions:</p><a id="I_programlisting9_d1e10707"/><pre class="programlisting">&lt;html&gt;
  &lt;body&gt;
  &lt;?php
❶   $mynum = $_GET["num"];
    if (is_numeric($mynum)) {
❷   if ($mynum &lt; 10) {
      print "Your number is less than 10!";
    }
❸   else {
      print "You have double digits!";
    }
    }
  ?&gt;
  &lt;/body&gt;
  &lt;/html&gt;</pre><p>First, we grab the number that was passed in the URL ❶. This number is stored in a variable that can now be used in the rest of the program. We use this variable to create an <code class="literal">if</code> statement ❷, which checks if the number is less than 10. If it is, a message to that effect is output.</p><p>Notice the curly braces, <code class="literal">{</code> and <code class="literal">}</code>, after the <code class="literal">if</code> statement. These hold all the code that is run when the <code class="literal">if</code> statement holds true. Otherwise, everything in the curly braces after the <code class="literal">else</code> ❸ is run instead. You can have an <code class="literal">if</code> without an <code class="literal">else</code>, but in this case, we want to do something in either of the cases, not just one.</p><div class="table"><a id="comparison_operators"/><p class="title">Table 9-1. Comparison Operators</p><div class="table-contents"><table summary="Comparison Operators" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Operator<a id="IDX-CHP-9-0035" class="indexterm"/><a id="IDX-CHP-9-0036" class="indexterm"/><a id="IDX-CHP-9-0037" class="indexterm"/><a id="IDX-CHP-9-0038" class="indexterm"/><a id="IDX-CHP-9-0039" class="indexterm"/></p></th><th style="text-align: left" valign="bottom"><p>Description</p></th><th style="text-align: left" valign="bottom"><p>When used</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p>==</p></td><td style="text-align: left" valign="top"><p>Equal</p></td><td style="text-align: left" valign="top"><p>Numbers or text</p></td></tr><tr><td style="text-align: left" valign="top"><p>!=</p></td><td style="text-align: left" valign="top"><p>Not equal</p></td><td style="text-align: left" valign="top"><p>Numbers or text</p></td></tr><tr><td style="text-align: left" valign="top"><p>&gt;</p></td><td style="text-align: left" valign="top"><p>Greater than</p></td><td style="text-align: left" valign="top"><p>Mostly numbers</p></td></tr><tr><td style="text-align: left" valign="top"><p>&lt;</p></td><td style="text-align: left" valign="top"><p>Less than</p></td><td style="text-align: left" valign="top"><p>Mostly numbers</p></td></tr><tr><td style="text-align: left" valign="top"><p>&gt;=</p></td><td style="text-align: left" valign="top"><p>Greater than or equal</p></td><td style="text-align: left" valign="top"><p>Mostly numbers</p></td></tr><tr><td style="text-align: left" valign="top"><p>&lt;=</p></td><td style="text-align: left" valign="top"><p>Less than or equal</p></td><td style="text-align: left" valign="top"><p>Mostly numbers</p></td></tr></tbody></table></div></div><p>There are six operators, shown in <a class="xref" href="ch09s02.html#comparison_operators" title="Table 9-1. Comparison Operators">Table 9-1</a>, to use when comparing variables. The operators are most useful to compare numbers, but can also be used to compare text.</p></div><div class="sect2" title="Quite the Array"><div class="titlepage"><div><div><h2 class="title"><a id="quite_the_array"/>Quite the Array</h2></div></div></div><p>So far I've shown two types of variables: text and numbers. Two other common types are available, which I'll introduce in this section.</p><p>The first is an <span class="emphasis"><em>array</em></span>. An array is a single variable that holds many other variables so you don't have to name them individually. A simple array tracks the values it holds by index, which starts counting at zero. You can declare an array like so:</p><a id="I_programlisting9_d1e10852"/><pre class="programlisting">$beatles = array("John", "Paul", "George", "Ringo");</pre><p>In this example, I used text. An array can also hold numbers, or a combination of numbers and text. It can also hold other arrays and objects, but let's keep it simple for now. Notice that the <code class="literal">array</code> function takes any number of values, separated by commas.</p><p>Here is the line of code to print George (the third option):</p><a id="I_programlisting9_d1e10861"/><pre class="programlisting">print $beatles[2];</pre><p>Notice the index is 2, instead of 3. That's because the index starts at 0. And the index goes inside square brackets <code class="literal">[</code> and <code class="literal">]</code> when accessing the values.</p><p>The other kind of array I want to show you is called an <span class="emphasis"><em>associative array</em></span>. Instead of using an index to track the values inside the array, it uses a textual key.<a id="IDX-CHP-9-0040" class="indexterm"/></p><p>For example, you could access George using an associative array in this way:</p><a id="I_programlisting9_d1e10881"/><pre class="programlisting">print $beatles["guitarist"];</pre><p>We still use the bracket notation, but instead of our index, we use our text key. And here is how that associative array may have been declared:<a id="IDX-CHP-9-0041" class="indexterm"/><a id="IDX-CHP-9-0042" class="indexterm"/><a id="IDX-CHP-9-0043" class="indexterm"/></p><a id="I_programlisting9_d1e10895"/><pre class="programlisting">$beatles = array("singer" =&gt; "John", "bassist" =&gt; "Paul",
                 "guitarist" =&gt; "George", "drummer" =&gt; "Ringo");</pre><p>As with a standard array, the items are separated by commas inside the <code class="literal">array</code> function. In this case, however, <code class="literal">key =&gt; value</code> pairs are used to declare how each item in the array will be accessed.</p><p>In the next section, I'll show how you could loop through array values.</p></div><div class="sect2" title="Feelin' Loopy"><div class="titlepage"><div><div><h2 class="title"><a id="feelin_apostrophy_loopy"/>Feelin' Loopy</h2></div></div></div><p>If you want to do the same thing many times, you can achieve this by using a loop structure. This section will include the <code class="literal">for</code> and <code class="literal">foreach</code> loops in PHP. We'll visit each value in an array and output its contents.<a id="IDX-CHP-9-0044" class="indexterm"/><a id="IDX-CHP-9-0045" class="indexterm"/></p><p>Consider this simple array:</p><a id="I_programlisting9_d1e10930"/><pre class="programlisting">$bandmates = array("Simon", "Garfunkel");</pre><p>Now let's loop through it and print out each name:</p><a id="I_programlisting9_d1e10934"/><pre class="programlisting">$upperBound = count($bandmates) - 1;
  for ($idx = 0; $idx &lt;= ❶$upperBound; ❷$idx++) {
❸   print $bandmates[$idx];
❹   if ($idx &lt; $upperBound) {
      print " and ";
    }
  }</pre><p>When you run this code, it will print out the name of the band:</p><a id="I_programlisting9_d1e10938"/><pre class="programlisting">Simon and Garfunkel</pre><p>We do this by creating an index variable, starting at zero. The program goes through the loop until that index variable is no longer less than the total number of items in the array ❶. The increment operator <code class="literal">++</code> is used to increase the index by one each time ❷.</p><p>To print the name simply means accessing the current index in the array variable ❸. Then, it also prints some text between the names, but only when the index is less than the total number minus one ❹. Because the total number is two, this will only happen during the first time through the loop, when zero is less than one.</p><p>If you add your last name as a third item in the <code class="literal">$bandmates</code> variable and run the code again, you'll see another <code class="literal">and</code> thrown in (and you'll have put yourself in the band).</p><p>Let's use another loop to go through an associative array. We'll stick with the same band, but focus our attention on their hair instead. Is it straight or curly? Consider this associative array:<a id="IDX-CHP-9-0046" class="indexterm"/><a id="IDX-CHP-9-0047" class="indexterm"/></p><a id="I_programlisting9_d1e10966"/><pre class="programlisting">$bandhair = array("straight" =&gt; "Simon", "curly" =&gt; "Garfunkel");</pre><p>Now let's loop through this array to share what we know about their hair:</p><a id="I_programlisting9_d1e10970"/><pre class="programlisting">foreach ($bandhair as $description =&gt; $name) {
  print $name . " has " . $description . " hair. ";
}</pre><p>Finally, here's the output:</p><a id="I_programlisting9_d1e10974"/><pre class="programlisting">Simon has straight hair. Garfunkel has curly hair.</pre><p>In this case, we're accessing both the key and the value in each element of the associative array. Then, at each step, we're printing them both out.</p></div><div class="sect2" title="Get Functional"><div class="titlepage"><div><div><h2 class="title"><a id="get_functional"/>Get Functional</h2></div></div></div><p>Creating your own functions in PHP can save you time typing. You'll also find it's good practice. The way you create PHP functions is quite similar to JavaScript, so you may be closer than you realize to being able to use your own functions.<a id="IDX-CHP-9-0048" class="indexterm"/><a id="IDX-CHP-9-0049" class="indexterm"/></p><p>For this example, we'll create a function that takes a number as input and returns that same number quadrupled. This function may not be especially useful, but it is just simple enough to teach how functions work in PHP.</p><p>Within your PHP brackets, <code class="literal">&lt;?php</code> and <code class="literal">?&gt;</code>, include this code:</p><a id="I_programlisting9_d1e11003"/><pre class="programlisting">function quadruple(❶$somenum) {
❷   $newnum = $somenum * 4;
❸   return $newnum;
  }</pre><p>Like I said, a simple function: It contains a name and is passed a single variable ❶. This variable is local to just this function, meaning it doesn't have to exist elsewhere. You can name the variable whatever you want.</p><p>Then I created another variable ❷ to hold the quadrupled value. This variable is also local, so we're just using it inside the function. Note that the multiplication operator is an asterisk. Armed with our new value, we need to pass it back out ❸ to whichever line of code called our new <code class="literal">quadruple</code> function.</p><p>Now let's call our function. And to show how useful this function is, we'll call it on several numbers in a row using an array and a loop. Create a new PHP file with this code:<a id="IDX-CHP-9-0050" class="indexterm"/><a id="IDX-CHP-9-0051" class="indexterm"/></p><a id="I_programlisting9_d1e11022"/><pre class="programlisting">&lt;html&gt;
  &lt;body&gt;
  &lt;?php
    $allnums = array(4, 18, 21);
    foreach ($allnums as ❶$thisnum) {
❷   $quadnum = quadruple($thisnum);
    print $thisnum . " quadrupled is " . $quadnum . "! ";
  }

  function quadruple($somenum) {
    $newnum = $somenum * 4;
    return $newnum;
  }
  ?&gt;
  &lt;/body&gt;
  &lt;/html&gt;</pre><p>Here I've used a <code class="literal">foreach</code> loop on a regular, nonassociative array. To do this, I simply use one value ❶ instead of a key-value pair. Then, for every item in the array, I use the new function to quadruple the number ❷.</p><p>When all is said and done, here is the output:</p><a id="I_programlisting9_d1e11032"/><pre class="programlisting">4 quadrupled is 16! 18 quadrupled is 72! 21 quadrupled is 84!</pre><p>And with that, you know the basics of PHP. You've interspersed it with HTML. You learned several types of variables: numbers, text, arrays, and associative arrays. You can help your code think with conditionals, and you can use loops and functions to keep your code small and reusable.</p><p>To learn how to grab web pages or connect PHP to a web service, continue to the next section. And to connect PHP to a database, you'll want <a class="xref" href="ch09s07.html" title="#65: Use MySQL from PHP">#65: Use MySQL from PHP</a> in <a class="xref" href="ch09s07.html" title="#65: Use MySQL from PHP">#65: Use MySQL from PHP</a>.</p></div></div>
<div class="sect1" title="#61: Retrieve a Web Page"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_61_colon_retrieve_a_web"/>#61: Retrieve a Web Page</h1></div></div></div><p>One of the most common reasons to use a server-side language like PHP is to be able to make calls to web services. Some services provide a result that can be read directly into the browser with JavaScript. Taking these calls server-side gives you more freedom to use or store the results, however.</p><p>Calling a web service is exactly like loading a web page. You pass a URL to a server, and it responds with code (HTML for a web page, usually XML for a web service). In PHP, the code is put into a string variable, which holds a bunch of text. From there, you can do whatever you want with the web page—print it out, cut it apart, parse it into data, store it away. But first, let's just work on <span class="emphasis"><em>getting</em></span> the web page.<a id="IDX-CHP-9-0052" class="indexterm"/><a id="IDX-CHP-9-0053" class="indexterm"/></p><p>PHP 5 comes with a standard library called <span class="emphasis"><em>cUrl</em></span>. The library is all about making network connections. In earlier versions of PHP, you might have used the <code class="literal">file</code> function to do this, which was kind of duct-taped on. Switch to cUrl—it's made for doing URL grabbing.<a id="IDX-CHP-9-0054" class="indexterm"/></p><p>Of course, the <code class="literal">file</code> function is so easy. Just one line and you had the content from a web page. As you'll see, cUrl is a little bit more involved. Let's make our own function, however, so we can reuse it in many places (as I have done several times in this book). Then we'll have all the convenience of <code class="literal">file</code> with the power of cUrl.</p><p>In an empty PHP file, add the following code:</p><a id="I_programlisting9_d1e11079"/><pre class="programlisting">&lt;?php
  // Additional code may go here

  // cUrl function
  function get_url(❶$url) {
❷   $c = curl_init();
❸   curl_setopt($c, CURLOPT_URL, $url);
❹   curl_setopt($c, CURLOPT_RETURNTRANSFER, 1);
    $content = trim(❺curl_exec($c));
❻   curl_close($c);
❼   return $content;
  }
  ?&gt;</pre><p>Our function, which I've named <code class="literal">get_url</code>, has one parameter, the URL ❶. This input is what it needs to do its job, which is to fetch a web page. Once inside the function, we need to initialize a cUrl object ❷, so we can begin using it.</p><p>Now let's tell cUrl what we need by setting options. First, we tell it the URL we want to fetch ❸. Then we explain that we want to get back the content the URL will send ❹. Some people use cUrl to send information only, in which case they don't care about the reply. We do.</p><p>Notice that each time we set options, we passed the <code class="literal">$c</code> variable that we created when we initialized cUrl. That variable is important because it keeps track of the options we set and the status of our cUrl session.</p><p>With the options set, we make the call to the URL ❺ with the content stored in a normal variable. First, we run it through the <code class="literal">trim</code> function to remove any spaces or carriage returns from the beginning and end of the file. Otherwise, we get the exact data that a web browser would get.</p><p>Now we'll clean up our mess, so we tell cUrl that we're done ❻. Then the most important part: We return the content ❼ from this function. This is how we get the results of the web page out of the function and into whatever variable we declare.</p><p>Let's test our new function. Below the <code class="literal">Additional code may go here</code> line, let's add this line, which will grab the home page of the book's website:<a id="IDX-CHP-9-0055" class="indexterm"/><a id="IDX-CHP-9-0056" class="indexterm"/><a id="IDX-CHP-9-0057" class="indexterm"/></p><a id="I_programlisting9_d1e11117"/><pre class="programlisting">$htmlcode = get_url("http://mapscripting.com");
print $htmlcode;</pre><p>If you load your PHP file into a browser, you should get a web page. The web page is coming from your new function! Open <a class="ulink" href="http://mapscripting.com/">http://mapscripting.com/</a> in another browser window, and you'll see almost the same thing, though styles and images might be missing from your copy—that's because you're only loading the HTML.</p><p>What's the big deal with using PHP to show the stripped-down version of this book's website? It isn't a big deal; this is just a proof of concept. The really great stuff comes when you download XML from a web service. I show more of how that works in <a class="xref" href="ch08.html#number_symble_52_colon_use_xml" title="#52: Use XML">#52: Use XML</a> in <a class="xref" href="ch08.html#number_symble_52_colon_use_xml" title="#52: Use XML">#52: Use XML</a>.</p><div class="sect2" title="Include Your Function in Other Scripts"><div class="titlepage"><div><div><h2 class="title"><a id="include_your_function_in_other_scripts"/>Include Your Function in Other Scripts</h2></div></div></div><p>One way to make your <code class="literal">get_url</code> function accessible in other PHP scripts you write is to copy and paste it in every time. Of course, cutting and pasting each time is the hard way and difficult to keep up-to-date if you change the function; you would have to change it everywhere that you pasted it.</p><p>Instead, create an include file that you can call from other scripts. Take the previous code, not including the two lines we used to test the function, and put them in a new file. I named the file <span class="emphasis"><em>net_func.inc.php</em></span>, thinking I might add more network-related functions down the road. I gave a non-<span class="emphasis"><em>.php</em></span> extension to the file because I didn't want it to be mistaken for something that can be shown directly to a web browser.</p><p>Now start a new PHP file, so you can test including your new function file:</p><a id="I_programlisting9_d1e11147"/><pre class="programlisting">&lt;?php
include("net_func.inc.php");
$htmlcode = get_url("http://mapscripting.com");
print $htmlcode;
?&gt;</pre><p>The results from this test should be the same as the previous test. Only now the code for the <code class="literal">get_url</code> function is separate from the code that calls it, which will allow us to use it easily in many places.</p></div></div>
<div class="sect1" title="#62: Install MySQL"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_62_colon_install_mysql"/>#62: Install MySQL</h1></div></div></div><p>MySQL is a popular database platform that is available across most operating systems. You can install it on your own computer, and you can also run it on a web server, which means using it as a data source for applications is easy.<a id="IDX-CHP-9-0058" class="indexterm"/></p><p>For the uninitiated, a <span class="emphasis"><em>database</em></span> contains one or more tables that are used to store data. At a very crude level, you can think of a database as a spreadsheet, like a Microsoft Excel file, that can be accessed in part or whole and filtered for only the stuff you care about. Instead of worksheets, you have tables. Every row of a worksheet is a new <span class="emphasis"><em>database record</em></span>. The columns across the top of most worksheets are the <span class="emphasis"><em>database fields</em></span>—they describe the data that goes in that column. In fact, when people talk about databases, they often speak about rows and columns.<a id="IDX-CHP-9-0059" class="indexterm"/><a id="IDX-CHP-9-0060" class="indexterm"/><a id="IDX-CHP-9-0061" class="indexterm"/><a id="IDX-CHP-9-0062" class="indexterm"/><a id="IDX-CHP-9-0063" class="indexterm"/><a id="IDX-CHP-9-0064" class="indexterm"/></p><p>The SQL part of MySQL stands for <span class="emphasis"><em>structured query language</em></span>, the syntax to communicate with a database server. MySQL and many other database servers use a standard set of statements (called SQL-92), though each also has its own dialect.</p><p>You will find MySQL most useful when combined with some other technologies. The examples in this chapter use PHP for a programming language and Apache for a web server. Read on, however, to get the details about using MySQL by itself.</p><div class="sect2" title="Check Your Web Host for MySQL"><div class="titlepage"><div><div><h2 class="title"><a id="check_your_web_host_for_mysql"/>Check Your Web Host for MySQL</h2></div></div></div><p>If you have web hosting, you may have MySQL installed already. You'll want to look in your control panel or double-check with your administrator that MySQL is available and set up for your account. Ask about one or both of these two common methods for using MySQL:</p><table border="0" summary="Simple list" class="simplelist"><tr><td><span class="strong"><strong>phpMyAdmin</strong></span> A web dashboard for accessing MySQL. As the name implies, PHP must also be installed. By using this method, you can create database tables and look at data in a visual, point-and-click manner that beginners often prefer.</td></tr><tr><td><span class="strong"><strong>Command Interpreter</strong></span> A command-line utility that lets you access MySQL from a text interface. Creating database tables and all other operations occur via typed commands.</td></tr></table><p>All examples in this chapter will be shown using both methods. In some cases, the differences are minimal because you will need to type commands into phpMyAdmin as well.<a id="IDX-CHP-9-0065" class="indexterm"/></p><p>If MySQL is installed, you're ready to move on to <a class="xref" href="ch09s05.html" title="#63: Store Locations to a Database">#63: Store Locations to a Database</a> in <a class="xref" href="ch09s04.html#install_mysql_yourself" title="Install MySQL Yourself">Install MySQL Yourself</a>.</p></div><div class="sect2" title="Use a Packaged Installation of MySQL"><div class="titlepage"><div><div><h2 class="title"><a id="use_a_packaged_installation_of_mysql"/>Use a Packaged Installation of MySQL</h2></div></div></div><p>To install MySQL on your own computer, the easiest method is to download a package for your operating system that is ready to go. When you follow this route, you'll also get PHP and Apache at the same time, which is useful.</p><p>The names of the packages are patterned after the popular server architecture, LAMP, which stands for <span class="bolditalic">L</span><span class="emphasis"><em>inux</em></span>, <span class="bolditalic">A</span><span class="emphasis"><em>pache</em></span>, <span class="bolditalic">M</span><span class="emphasis"><em>ySQL</em></span>, and <span class="bolditalic">P</span><span class="emphasis"><em>HP</em></span>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Windows (WAMP): <a class="ulink" href="http://www.wampserver.com/">http://www.wampserver.com/</a><a id="IDX-CHP-9-0066" class="indexterm"/></p></li><li class="listitem"><p>Macintosh (MAMP): <a class="ulink" href="http://www.mamp.info/">http://www.mamp.info/</a><a id="IDX-CHP-9-0067" class="indexterm"/></p></li></ul></div><p>Either of these packages should install on your computer without much information from you (though you may have to enter an administrator password).<a id="IDX-CHP-9-0068" class="indexterm"/><a id="IDX-CHP-9-0069" class="indexterm"/></p><p>Open WAMP/MAMP once the install process has completed. The program should create a new web browser window pointed at <span class="emphasis"><em>localhost</em></span>, the name of the server on your own computer. By default, a welcome screen will appear, as shown in <a class="xref" href="ch09s04.html#the_mamp_welcome_screen" title="Figure 9-4. The MAMP welcome screen">Figure 9-4</a>.</p><div class="figure"><a id="the_mamp_welcome_screen"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e11293"/><img src="httpatomoreillycomsourcenostarchimages672093.png.jpg" alt="The MAMP welcome screen"/></div></div><p class="title">Figure 9-4. The MAMP welcome screen</p></div><p>To administer your MySQL installation, click the <span class="strong"><strong>phpMyAdmin</strong></span> link. Now you're ready for the next project.</p></div><div class="sect2" title="Install MySQL Yourself"><div class="titlepage"><div><div><h2 class="title"><a id="install_mysql_yourself"/>Install MySQL Yourself</h2></div></div></div><p>If you're using an operating system that does not have a package available, you will need to install MySQL yourself. Too many variations exist to describe in this chapter, but many tutorials are available on the Internet to help you out.</p><p>The MySQL website is the first place to start: <a class="ulink" href="http://mysql.org/">http://mysql.org/</a>.</p><p>When you are up and running, keep on reading for geographic-specific instructions.</p></div></div>
<div class="sect1" title="#63: Store Locations to a Database"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_63_colon_store_locations"/>#63: Store Locations to a Database</h1></div></div></div><p>To build extremely powerful mapping applications, you'll want to use a database. By maintaining your own data, your site will be quicker and you can do more interesting things. First, however, you'll need to create the database and add some locations to it. This section will describe how to get started with a MySQL location database.</p><p>At this point, we need to get our jargon straight. That data, which lives in a database, actually resides in a database <span class="emphasis"><em>table</em></span>. Before you can create a table, you need to have a database. MySQL is a database management system that can contain many individual databases, which themselves have many tables.<a id="IDX-CHP-9-0070" class="indexterm"/><a id="IDX-CHP-9-0071" class="indexterm"/><a id="IDX-CHP-9-0072" class="indexterm"/></p><div class="sect2" title="Create a New Database"><div class="titlepage"><div><div><h2 class="title"><a id="create_a_new_database"/>Create a New Database</h2></div></div></div><p>If you're using MySQL through a hosting provider, you likely already have a database assigned to you. Even your database contains other tables already (say, for blogging software), you can still use it for this project. We will simply be creating an additional database table.<a id="IDX-CHP-9-0073" class="indexterm"/><a id="IDX-CHP-9-0074" class="indexterm"/></p><p>If you don't have a database, creating one is easy in phpMyAdmin. From the main screen, simply type the name of your database into the form (I chose <span class="emphasis"><em>mapscripting</em></span>) and click the <span class="strong"><strong>Create</strong></span> button (see <a class="xref" href="ch09s05.html#create_a_new_database-id1" title="Figure 9-5. Create a new database.">Figure 9-5</a>). Or, using the MySQL Command Interpreter, type <strong class="userinput"><code>create database("mapscripting");</code></strong>.</p><div class="figure"><a id="create_a_new_database-id1"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e11370"/><img src="httpatomoreillycomsourcenostarchimages672095.png.jpg" alt="Create a new database."/></div></div><p class="title">Figure 9-5. Create a new database.</p></div><p>Once completed, you need to select the database name, by clicking it or typing <strong class="userinput"><code>\u mapscripting</code></strong> in the interpreter. Now you're ready to create the database table.</p></div><div class="sect2" title="Create a Database Table"><div class="titlepage"><div><div><h2 class="title"><a id="create_a_database_table"/>Create a Database Table</h2></div></div></div><p>Now that you have a database, you can begin adding tables. I'm keeping this example simple, so we're only going to have one table.</p><p>To create a new table in phpMyAdmin, you fill out the form on the database's main page. You need to give the table a name and choose a number of fields. I'm calling my table <span class="emphasis"><em>places</em></span>, and it will have four fields, which are types of values that every place will contain. Click the <span class="strong"><strong>Go</strong></span> button to further define the table.</p><p>As you can see in <a class="xref" href="ch09s05.html#create_a_table_with_four_fields" title="Figure 9-6. Create a table with four fields.">Figure 9-6</a>, we need to name each field and give it a type. The four fields I'm adding to our basic place table are <span class="emphasis"><em>id</em></span> (unique identifier), <span class="emphasis"><em>label</em></span> (a name for the place), <span class="emphasis"><em>latitude</em></span>, and <span class="emphasis"><em>longitude</em></span>.</p><div class="figure"><a id="create_a_table_with_four_fields"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e11412"/><img src="httpatomoreillycomsourcenostarchimages672097.png.jpg" alt="Create a table with four fields."/></div></div><p class="title">Figure 9-6. Create a table with four fields.</p></div><p>The identifier is a good idea for any database table because it makes distinguishing one piece of data from another easy. I've made the identifier a <span class="emphasis"><em>bigint</em></span>, meaning it is an integer that can get very large (up to 9 quintillion—that's 18 zeros). We don't want to worry about counting the number ourselves, however, so we need to make sure MySQL does it for us.</p><p>Look on the far right in phpMyAdmin (you may need to scroll horizontally), and you'll find the Extra column. Select the drop-down for the <code class="literal">id</code> row and choose <span class="strong"><strong>auto_increment</strong></span>. Then, also click the option directly to the right, the one with the icon that looks like a key. See <a class="xref" href="ch09s05.html#make_the_identifier_field_auto-increment" title="Figure 9-7. Make the identifier field auto-increment.">Figure 9-7</a> for an example. Selecting this will make the identifier the primary key. Both of these steps are necessary for MySQL to do the counting for you.</p><p>The remaining fields are fairly simple. The label is a short (100 character) description of the place and then the location is stored as two floating point (decimal) numbers: latitude and longitude, no doubt quite familiar to you by now.</p><p>Click the <span class="strong"><strong>Save</strong></span> button and you've created a table. To do the same in the Command Interpreter (or using phpMyAdmin's SQL window), type the following:</p><a id="I_programlisting9_d1e11439"/><pre class="programlisting">CREATE TABLE places (id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
                     label VARCHAR(100), latitude FLOAT, longitude FLOAT);</pre><p>Now that you have a table, let's start adding data to it.</p><div class="figure"><a id="make_the_identifier_field_auto-increment"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e11447"/><img src="httpatomoreillycomsourcenostarchimages672099.png.jpg" alt="Make the identifier field auto-increment."/></div></div><p class="title">Figure 9-7. Make the identifier field auto-increment.</p></div></div><div class="sect2" title="Add Data to Your Places Table"><div class="titlepage"><div><div><h2 class="title"><a id="add_data_to_your_places_table"/>Add Data to Your Places Table</h2></div></div></div><p>Your places table, with its four fields, is sitting happily inside your database, but you have a problem. The table is empty. It doesn't have any data. Let's add some.<a id="IDX-CHP-9-0075" class="indexterm"/><a id="IDX-CHP-9-0076" class="indexterm"/><a id="IDX-CHP-9-0077" class="indexterm"/></p><p>Within phpMyAdmin, click the table name and then the Insert tab. You should see another form (as shown in <a class="xref" href="ch09s05.html#enter_values_in_your_places_table" title="Figure 9-8. Enter values in your places table.">Figure 9-8</a>) with four fields. This time, instead of names, which are already listed, you'll enter values.</p><p>Leaving the <code class="literal">id</code> value empty is important. MySQL will create that value because it's counting (auto-incrementing) for us. In the other boxes, type a descriptive name, followed by latitude and longitude. Then click <span class="strong"><strong>Go</strong></span>.</p><p>You don't have to add data via phpMyAdmin. You can also use plain SQL (such as in the Command Interpreter). To add Old Faithful to the <code class="literal">places</code> table, type the following:</p><a id="I_programlisting9_d1e11487"/><pre class="programlisting">insert into places (label, latitude, longitude)
            values ('Old Faithful geyser', 44.46054, −110.82834);</pre><p>Notice that I don't include the <code class="literal">id</code> here at all. I want MySQL to deal with it. The other three fields are first listed by name and then by the values I want to add to them.</p><p>After performing these tasks, you've added a single place to your places database table. Add a few more, varying the labels, latitude, and longitude. You have yourself an up-and-coming location database now. Within phpMyAdmin, click the Browse tab to see your places, or type this SQL in the Command Interpreter: <strong class="userinput"><code>select * from places;</code></strong>.</p><div class="figure"><a id="enter_values_in_your_places_table"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e11502"/><img src="httpatomoreillycomsourcenostarchimages672101.png.jpg" alt="Enter values in your places table."/></div></div><p class="title">Figure 9-8. Enter values in your places table.</p></div><p>Now you can do something interesting with the location database, such as plot locations from a database or get the nearest locations from a database.<a id="IDX-CHP-9-0078" class="indexterm"/><a id="IDX-CHP-9-0079" class="indexterm"/><a id="IDX-CHP-9-0080" class="indexterm"/><a id="IDX-CHP-9-0081" class="indexterm"/></p></div></div>
<div class="sect1" title="#64: Import Data from a Spreadsheet"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_64_colon_import_data_from"/>#64: Import Data from a Spreadsheet</h1></div></div></div><p>If you're sold on getting your location data into a database (and I hope you are), you'll want a way to make it easy. Filling out form after form or writing out SQL inserts by hand is tedious. In this section, I'll show how to use a spreadsheet, convert it to CSV, and then import it directly into MySQL.</p><p>Earlier I compared a database table to a spreadsheet. Both have columns, which in a database are also referred to as field names. Both have rows, which we call database records. The easiest way to prepare a lot of data for a database is to use a spreadsheet, such as Excel or OpenOffice Calc. Work on your spreadsheet as you normally would. <a class="xref" href="ch09s06.html#a_database_table_is_similar_to_a_spreads" title="Figure 9-9. A database table is similar to a spreadsheet.">Figure 9-9</a> shows an example of how the places database I created in the previous project might look as a spreadsheet.<a id="IDX-CHP-9-0082" class="indexterm"/><a id="IDX-CHP-9-0083" class="indexterm"/></p><p>Make sure you have a few rows filled out, and then save a copy of your spreadsheet. Instead of saving as the normal spreadsheet format, scroll through your list of file types, and choose <span class="strong"><strong>Comma-Separated, .csv</strong></span>. This format is a simple, universal one for storing data.</p><p>I chose the name <span class="emphasis"><em>places.csv</em></span> for my file, which looks like this when I open it in a plain-text editor:</p><a id="I_programlisting9_d1e11554"/><pre class="programlisting">"label","latitude","longitude"
"Old Faithful geyser",44.46054,-110.82834
"St. Louis Arch",38.62470,-90.18510</pre><div class="figure"><a id="a_database_table_is_similar_to_a_spreads"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e11559"/><img src="httpatomoreillycomsourcenostarchimages672103.png.jpg" alt="A database table is similar to a spreadsheet."/></div></div><p class="title">Figure 9-9. A database table is similar to a spreadsheet.</p></div><p>Now you're ready to import this comma-separated values (CSV) version of the database table. Within phpMyAdmin, navigate to the places table and click the Import tab. First, you'll select the file to import, so click the <span class="strong"><strong>Browse</strong></span> button and choose your CSV file. If your file has a header row, as mine does, be sure to fill out the form to skip one record because you don't want to import the field names as values.</p><p>Scroll down to the File Import section. It is probably set to SQL because that's the main way MySQL expects to read in files. Choose <span class="strong"><strong>CSV</strong></span> instead. Then fill out the options as shown in <a class="xref" href="ch09s06.html#import_a_comma-separated_file_into_mysql" title="Figure 9-10. Import a comma-separated file into MySQL.">Figure 9-10</a>. Fields are terminated by a comma; fields are enclosed by a double quote character; and fields are escaped by backslash. You can let line terminators be determined automatically.</p><div class="figure"><a id="import_a_comma-separated_file_into_mysql"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e11579"/><img src="httpatomoreillycomsourcenostarchimages672105.png.jpg" alt="Import a comma-separated file into MySQL."/></div></div><p class="title">Figure 9-10. Import a comma-separated file into MySQL.</p></div><p>The final option is a list of fields to import. If you are importing every field in the table, you may not need to enter these. We have an automatically generated identifier, however, so we need to specify the columns we are importing, which is everything except the <code class="literal">id</code> column.</p><p>Click the <span class="strong"><strong>Go</strong></span> button and your data should be imported. To check, click the Browse tab, which will show you the current contents of the places table.</p><p>You can also import using the Command Interpreter:<a id="IDX-CHP-9-0084" class="indexterm"/><a id="IDX-CHP-9-0085" class="indexterm"/><a id="IDX-CHP-9-0086" class="indexterm"/></p><a id="I_programlisting9_d1e11612"/><pre class="programlisting">LOAD DATA LOCAL INFILE 'places.csv' INTO TABLE places
FIELDS TERMINATED BY ',' ENCLOSED BY '"' LINES TERMINATED BY '\n'
IGNORE 1 LINES (label, latitude, longitude);</pre><p>The CSV file will need to be accessible to the machine running MySQL. If you're using the interpreter on a server, you'll need to upload the file to the server.</p><p>Using a spreadsheet to create your data is the easiest method when you have more than just a few records. Also, you may find plenty of other data available in this format, so knowing how to import from CSV can help you use other people's data, as well.</p></div>
<div class="sect1" title="#65: Use MySQL from PHP"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_65_colon_use_mysql_from"/>#65: Use MySQL from PHP</h1></div></div></div><p>Many programming languages have ways to connect to MySQL. PHP includes many functions in its default installation, making PHP and MySQL a popular pair. In this section, I'll introduce you to the most common functions for accessing your MySQL database from PHP.</p><p>The following example assumes you have a location database table like the one we created in <a class="xref" href="ch09s05.html" title="#63: Store Locations to a Database">#63: Store Locations to a Database</a> in <a class="xref" href="ch09s04.html#install_mysql_yourself" title="Install MySQL Yourself">Install MySQL Yourself</a> with at least one place added to the database. Once you have your table ready to go, let's write some PHP to grab all the place descriptions.</p><p>Create a new PHP file with the following content:</p><a id="I_programlisting9_d1e11632"/><pre class="programlisting">&lt;?php
❶ $db = <strong class="userinput"><code>mysql_connect</code></strong>('localhost', 'username', 'password');
❷ <strong class="userinput"><code>mysql_select_db</code></strong>('mapscripting', $db);
  $sql = "select label from places";
❸ $res = <strong class="userinput"><code>mysql_query</code></strong>($sql, $db);
  while (❹$row = <strong class="userinput"><code>mysql_fetch_assoc</code></strong>($res)) {
    print ❺$row["label"];
  }
❻ <strong class="userinput"><code>mysql_close</code></strong>($db);
  ?&gt;</pre><p>Everything that begins with <code class="literal">mysql_</code> (shown in bold) is a function associated with accessing MySQL from PHP. Many more functions are listed at <a class="ulink" href="http://php.net/mysql">http://php.net/mysql</a>.</p><p>In this example, you first connect to MySQL using a server, username, and password ❶, which are likely provided by your site administrator. If you're using MAMP, you can find the login info on your installation's start page. These values establish the connection to MySQL and ensure not just anybody can access your data.</p><p>Because MySQL can have many different databases, we need to tell it which one to use ❷. Here I've chosen the mapscripting database I created previously. Also, I pass along the database connection variable from the previous line.</p><p>Now we're ready to get some data from the database. We use SQL to do this, similar to what happens behind the scenes on the Browse tab in phpMyAdmin. When using MySQL with PHP, you need to write the SQL yourself, which I've put into the variable <code class="literal">$sql</code>, which gets passed to a query ❸ along with the database connection variable.<a id="IDX-CHP-9-0087" class="indexterm"/><a id="IDX-CHP-9-0088" class="indexterm"/><a id="IDX-CHP-9-0089" class="indexterm"/><a id="IDX-CHP-9-0090" class="indexterm"/><a id="IDX-CHP-9-0091" class="indexterm"/></p><p>You can fetch data from a query in many ways, all using the object that is returned from the previous line. In this example, we use a <code class="literal">while</code> loop to look at each result one at a time. Whenever the <code class="literal">$row</code> variable no longer has a value, the <code class="literal">while</code> loop will end.</p><p>The value for each result is an associative array ❹, so the results are stored as key-value pairs. The table's field name is the key, so we put that inside square brackets to get at the value ❺. To finish, we close the connection to the database ❻, which frees up resources.</p><p>When you run this PHP code, you should see the description of every place you added print out, one after another, in no particular format. The output may not be pretty, but you have now made a very simple connection to your MySQL database from PHP. Better yet, any data you want can now be connected to the Web. Are you feeling powerful yet? You should be.</p><p>Continue reading to do something a bit more useful with the data in your location database.</p></div>
<div class="sect1" title="#66: Plot Locations from a Database"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_66_colon_plot_locations"/>#66: Plot Locations from a Database</h1></div></div></div><p>This project is the one you've been waiting for. You patiently put in your time learning the basics of MySQL and PHP. All you really wanted to do was put some points on a map without having to hand code it. Once you master the skills in this project, your mapping projects will be much more powerful because they'll be driven by data.</p><p>Believe it or not, you already have the knowledge necessary to plot locations from a database. The concepts we'll be using combine <a class="xref" href="ch09s07.html" title="#65: Use MySQL from PHP">#65: Use MySQL from PHP</a> in <a class="xref" href="ch09s07.html" title="#65: Use MySQL from PHP">#65: Use MySQL from PHP</a> and the parsing portion of a data formats project, <a class="xref" href="ch08s02.html" title="#53: Use JSON">#53: Use JSON</a> in <a class="xref" href="ch08s02.html" title="#53: Use JSON">#53: Use JSON</a>, which put the JavaScript framework jQuery to work for us.</p><p>This project has two parts: creating the JSON on the server using our database and interpreting the JSON in the browser. Let's go at 'em in that order.</p><div class="sect2" title="Output All Places as JSON"><div class="titlepage"><div><div><h2 class="title"><a id="output_all_places_as_json"/>Output All Places as JSON</h2></div></div></div><p>We'll be using PHP that is only slightly more advanced than what you've written in other projects. Rather than printing out each result as we come across it, we'll store it. Once we have all the data, we'll print it out as JSON with help from a built-in PHP function.</p><p>Whenever you are getting data from your database, consider what you need. Here, we're going to be plotting our locations on a map, so we'll need, at the very least, the latitude and longitude of each place. Having a description of each, too, would be nice so we'll also grab our label. Depending on what you're doing, you might also like the unique <code class="literal">id</code>.</p><p>How many rows do you want? For our example, let's get them all. Bear in mind that if your table is very large, you could be setting your users up for quite a long download. In that case, you might choose to only get the nearest locations from a database, but that's another project. Onward!</p><p>Create a new PHP file and add the following code:</p><a id="I_programlisting9_d1e11739"/><pre class="programlisting">&lt;?php
  $db = mysql_connect('localhost', 'username', 'password');
  mysql_select_db('mapscripting', $db);
❶ $sql = "select label, latitude, longitude from places";
  $res = mysql_query($sql, $db);
❷ $allrows = array();
  while ($row = mysql_fetch_assoc($res)) {
❸   array_push($allrows, $row);
  }
  mysql_close($db);
❹ print json_encode($allrows);
  ?&gt;</pre><p>We begin with connection details and then go straight to the SQL ❶. I have listed the three field names we want to get from the database. Before looping through the results, I've created an empty array ❷. We'll use this to hold all the results.</p><p>As we loop through every row that the database returns, we use a PHP function to "push" the result to the end of our array ❸. You may remember that each result from the database is itself an associative array, with values stored with field names as keys. So the array containing all the rows is really an array <span class="emphasis"><em>of arrays</em></span>. A bit confusing, perhaps, but perfectly suited for JSON.</p><p>After all of the results are stored in our massive array, we'll convert the variable to JSON text and print it out. We can do all of that in one single line ❹, assuming we have the JSON extensions (included in all recent PHP installations).</p><p>Here is the JSON output from my database, which has two rows:</p><a id="I_programlisting9_d1e11752"/><pre class="programlisting">[
  {"label":"Old Faithful geyser","latitude":"44.4605","longitude":"-110.828"},
  {"label":"St. Louis Arch","latitude":"38.6247","longitude":"-90.1851"}
]</pre><p>Very likely your results will be all squished together on one line, but I've split up the pieces to make more sense of them. When we parse this into JavaScript, we'll have an array (defined by square brackets) of objects (defined by curly brackets).</p><p>Once the data is put into JavaScript, we'll be able to plot it on a map. Let's get going.</p></div><div class="sect2" title="Plot Places from JSON"><div class="titlepage"><div><div><h2 class="title"><a id="plot_places_from_json"/>Plot Places from JSON</h2></div></div></div><p>Using PHP we have output all the places in our location database as JSON. Now we need to create a map that reads in the data and creates a new marker for every place. On the surface, this map is just like any other map we've created before. In this case, however, we won't even initialize the map until we hear back from the database.<a id="IDX-CHP-9-0092" class="indexterm"/><a id="IDX-CHP-9-0093" class="indexterm"/><a id="IDX-CHP-9-0094" class="indexterm"/><a id="IDX-CHP-9-0095" class="indexterm"/><a id="IDX-CHP-9-0096" class="indexterm"/></p><p>Before we get to parsing the JSON results, we need to include the jQuery JavaScript framework. Add the following to the header code of a basic Mapstraction map:</p><a id="I_programlisting9_d1e11787"/><pre class="programlisting">&lt;script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"&gt;&lt;/script&gt;</pre><p>Now replace any JavaScript code with the following function to initialize the map:</p><a id="I_programlisting9_d1e11791"/><pre class="programlisting">var mapstraction;
    function create_map() {
❶     $.getJSON("allplaces.php", function(jobj) {
❷       mapstraction = new Mapstraction('mymap', 'google');
❸       for (var i=0; i &lt; jobj.length; i++) {
❹         var place = jobj[i];
          var mk = new Marker(new LatLonPoint(place.latitude, place.longitude));
          mk.setInfoBubble(place.label);
          mapstraction.addMarker(mk);
        }
        mapstraction.autoCenterAndZoom();
      });
    }</pre><p>Unlike other times we've used a <code class="literal">create_map</code> function, we don't start by making a new Mapstraction map. We save this for later, once we've received data. Instead, the first thing we do is use jQuery to create an Ajax call to our PHP file (which I've called <span class="emphasis"><em>allplaces.php</em></span>) ❶.</p><p>Once we have a result, <span class="emphasis"><em>then</em></span> we create the map ❷, so we can start adding the data to it. Here, we've used a <code class="literal">for</code> loop to go through each place ❸. We can then save that object ❹, which has three attributes: label, latitude, and longitude. Those values are used to create a marker and give the marker a message box.</p><p>Finally, outside of the <code class="literal">for</code> loop (so it only happens once), we automatically center the map based on our markers. <a class="xref" href="ch09s08.html#database-driven_places_map" title="Figure 9-11. Database-driven places map">Figure 9-11</a> shows what my map, which has two landmarks as places, looks like.</p><p>If I add a third place to the database and reload the page, I'll have a third marker. That's the beauty of a database-driven map!</p><div class="figure"><a id="database-driven_places_map"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e11821"/><img src="httpatomoreillycomsourcenostarchimages672107.png.jpg" alt="Database-driven places map"/></div></div><p class="title">Figure 9-11. Database-driven places map</p></div></div></div>
<div class="sect1" title="#67: Get Nearest Locations from a Database"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_67_colon_get_nearest_locat"/>#67: Get Nearest Locations from a Database</h1></div></div></div><p>In <a class="xref" href="ch06.html" title="Chapter 6. EXPLORE PROXIMITY">Chapter 6</a>, we looked at several projects concerning what's nearby. I showed how to calculate the distance between two points and how to determine the closest marker to a point. Arguably more useful is what we'll be doing in this project: getting the nearest location to a point from a list of many possibilities stored in a database.<a id="IDX-CHP-9-0097" class="indexterm"/><a id="IDX-CHP-9-0098" class="indexterm"/><a id="IDX-CHP-9-0099" class="indexterm"/></p><p>To be able to look at locations in a database, we need to have something in the database in the first place. For this example, we'll be using the places database table from <a class="xref" href="ch09s05.html" title="#63: Store Locations to a Database">#63: Store Locations to a Database</a> in <a class="xref" href="ch09s04.html#install_mysql_yourself" title="Install MySQL Yourself">Install MySQL Yourself</a>. Although we've been using MySQL as an engine, most databases will work with the SQL statements that follow.</p><p>Because we're looking for the nearest locations to a single point, we need to determine what that point is. I've chosen a point near me in Portland with a latitude of 45.517 and a longitude of −122.649. Now we'll plug this into the Haversine formula—that's the same bit of trigonometry that we used in <a class="xref" href="ch06.html" title="Chapter 6. EXPLORE PROXIMITY">Chapter 6</a> to determine distance. There, we used JavaScript, and in this example, we'll use SQL.</p><p>From either the MySQL Command Interpreter, or in phpMyAdmin, type the following query:<a id="IDX-CHP-9-0100" class="indexterm"/><a id="IDX-CHP-9-0101" class="indexterm"/><a id="IDX-CHP-9-0102" class="indexterm"/></p><a id="I_programlisting9_d1e11871"/><pre class="programlisting">SELECT *,
  <strong class="userinput"><code>( 6371❶ * ACOS( COS( RADIANS( 45.517 ) ) * COS( RADIANS( latitude ) ) *</code></strong>
  <strong class="userinput"><code>COS( RADIANS( longitude ) - RADIANS( - 122.649 ) ) + SIN( RADIANS( 45.517 ) ) *</code></strong>
  <strong class="userinput"><code>SIN( RADIANS( latitude ) ) ) ) AS dist</code></strong>
FROM places
ORDER BY dist;</pre><p>Here we're selecting all the fields from the places table, plus an additional field, described by the entire section in bold. That's a lot of code! This code calculates the distance between our point and the points in the database using the latitude and longitude values stored with each place.</p><p>The distance, which becomes a column named dist, is in kilometers. As with the previous implementation of the Haversine formula, we multiply by the earth's radius, which is 6,371 km. For miles, replace the number ❶ with its mile equivalent (3,958).</p><p>When you run the SQL query, your results will be those shown in <a class="xref" href="ch09s09.html#results_of_nearest_place_in_sql" title="Table 9-2. Results of Nearest Place in SQL">Table 9-2</a>. Because we ordered by distance, the places nearest to our point come first in the table. Therefore, the nearest place to the point we selected is Old Faithful geyser. Of course, more useful examples will be from a places database with many locations all within the same city. Then, based on a point within that city, you can find the closest places, which will likely be within a few miles.</p><div class="table"><a id="results_of_nearest_place_in_sql"/><p class="title">Table 9-2. Results of Nearest Place in SQL</p><div class="table-contents"><table summary="Results of Nearest Place in SQL" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>ID</p></th><th style="text-align: left" valign="bottom"><p>Label</p></th><th style="text-align: left" valign="bottom"><p>Latitude</p></th><th style="text-align: left" valign="bottom"><p>Longitude</p></th><th style="text-align: left" valign="bottom"><p>Distance</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p>1</p></td><td style="text-align: left" valign="top"><p>Old Faithful geyser</p></td><td style="text-align: left" valign="top"><p>44.46</p></td><td style="text-align: left" valign="top"><p>− 110.83</p></td><td style="text-align: left" valign="top"><p>936.12</p></td></tr><tr><td style="text-align: left" valign="top"><p>2</p></td><td style="text-align: left" valign="top"><p>St. Louis Gateway Arch</p></td><td style="text-align: left" valign="top"><p>38.62</p></td><td style="text-align: left" valign="top"><p>− 90.19</p></td><td style="text-align: left" valign="top"><p>2765.97</p></td></tr></tbody></table></div></div><div class="sect2" title="Improve Your Query's Performance"><div class="titlepage"><div><div><h2 class="title"><a id="improve_your_query_apostrophy_s_performa"/>Improve Your Query's Performance</h2></div></div></div><p>Database experts will have some big problems with the SQL we used in the previous section. You know all that math we used: COS this and RADIANS that? Those are being calculated for each row in the database, even if the value isn't changing. The result is a query that will not make your server very happy once you've stored many places. In computer science terminology, the query has <span class="emphasis"><em>poor performance</em></span>.</p><p>Let's improve performance by storing some values that won't change in SQL variables. The process is similar to PHP variables, but the syntax is a bit different. Alter the query from the previous section to look like this:</p><a id="I_programlisting9_d1e11959"/><pre class="programlisting">SET @earthRadius = 6371;
  SET @lat = 45.517;
  SET @lon = −122.649;
❶ SET @radLat = RADIANS(@lat);
  SET @radLon = RADIANS(@lon);
  SET @cosLat = COS(@radLat);
  SET @sinLat = SIN(@radLat);
  SELECT *,
    <strong class="userinput"><code>( @earthRadius * ACOS( @cosLat * COS(RADIANS(latitude)) *</code></strong>
    <strong class="userinput"><code>COS( RADIANS(longitude) - @radLon ) + @sinLat *</code></strong>
    <strong class="userinput"><code>SIN(RADIANS(latitude)) ) ) AS dist</code></strong>
  FROM places
  ORDER BY dist;</pre><p>The <code class="literal">SET</code> command is used to store a value into a variable. The variables themselves start with the <code class="literal">@</code> sign. The first three variables are used to hold numbers that were previously written directly into the query, making the distance portion of the query (again, in bold) easier to read.<a id="IDX-CHP-9-0103" class="indexterm"/><a id="IDX-CHP-9-0104" class="indexterm"/><a id="IDX-CHP-9-0105" class="indexterm"/><a id="IDX-CHP-9-0106" class="indexterm"/><a id="IDX-CHP-9-0107" class="indexterm"/><a id="IDX-CHP-9-0108" class="indexterm"/><a id="IDX-CHP-9-0109" class="indexterm"/></p><p>The other four variables, beginning with ❶, also improve readability and make the query considerably shorter. Even better, performance improves as well. The values stored in the variables are only calculated once—when the variable is created.</p><p>A number of calculations are still happening as the query runs, which will bog down your server. Code like <code class="literal">COS(RADIANS(latitude))</code> can be avoided, but only if we change our database table. In the next section, I'll show you how you can further improve your query's performance.</p></div><div class="sect2" title="Precalculate Values in New Columns"><div class="titlepage"><div><div><h2 class="title"><a id="precalculate_values_in_new_columns"/>Precalculate Values in New Columns</h2></div></div></div><p>The changes you're making to your SQL won't be noticeable until you have many locations stored in your database. The flip-side is that with many locations stored applying this query becomes more interesting, which could attract more users to your site. And that's definitely not the time you want your server to be slow.</p><p>Some things <span class="emphasis"><em>have</em></span> to be calculated on-the-fly, otherwise the result would be the same for every location. You'll be returning different results for every pair of latitude and longitude coordinates. We'll focus on precalculating these three values from the previous section:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">COS(RADIANS(latitude))</code></p></li><li class="listitem"><p><code class="literal">RADIANS(longitude)</code></p></li><li class="listitem"><p><code class="literal">SIN(RADIANS(latitude))</code></p></li></ul></div><p>For every place stored in the database, these values will be different. Once the values are set, however, they will remain the same. That's a perfect case for adding three columns to your table. We'll name them <code class="literal">cosRadLat</code>, <code class="literal">radLon</code>, and <code class="literal">sinRadLat</code> and make them all type <code class="literal">FLOAT</code>.</p><p>Here's the SQL version to add these columns through the Command Interpreter:</p><a id="I_programlisting9_d1e12051"/><pre class="programlisting">ALTER TABLE places ADD cosRadLat FLOAT, ADD radLon FLOAT, ADD sinRadLat FLOAT;</pre><p>Once you've added these three columns, you need to fill in the values for all the places currently in your table:<a id="IDX-CHP-9-0110" class="indexterm"/><a id="IDX-CHP-9-0111" class="indexterm"/><a id="IDX-CHP-9-0112" class="indexterm"/></p><a id="I_programlisting9_d1e12070"/><pre class="programlisting">UPDATE places set
  cosRadLat = COS(RADIANS(latitude)),
  radLon = RADIANS(longitude),
  sinRadLat = SIN(RADIANS(latitude));</pre><p>Finally, now that you've added values to new columns in your table, you can use this optimized query to get the nearest locations from your database:</p><a id="I_programlisting9_d1e12074"/><pre class="programlisting">SET @earthRadius = 6371;
SET @lat = 45.517;
SET @lon = −122.649;
SET @radLat = RADIANS(@lat);
SET @radLon = RADIANS(@lon);
SET @cosLat = COS(@radLat);
SET @sinLat = SIN(@radLat);
SELECT label, latitude, longitude
  <strong class="userinput"><code>( @earthRadius * ACOS( @cosLat * cosRadLat *</code></strong>
  <strong class="userinput"><code>COS( radLon - @radLon ) + @sinLat *</code></strong>
  <strong class="userinput"><code>sinRadLat ) ) AS dist</code></strong>
FROM places
ORDER BY dist;</pre><p>The result is an even shorter, much faster query. A few calculations still need to happen on the fly, but the rest has been precalculated and stored in either variables or columns in the places table.</p><p>The only other change is that we are explicitly naming the fields to select, which is another database best practice. Plus, now that we added the three precalculated columns, we don't want to muddy our results with those additional values. Those numbers are just to improve speed and aren't particularly useful outside of that.</p></div></div>
<div class="sect1" title="#68: Get Nearest Locations to a Postal Code"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_68_colon_get_nearest_locat"/>#68: Get Nearest Locations to a Postal Code</h1></div></div></div><p>Big businesses often have store locators on their website. To use one, you type in your postal code and then you get a list of locations nearest yours. In this project, I'll show you how to perform the SQL database calls to reproduce this feature on your own site.</p><p>On one hand, the code to find places near a postal code is the same as the previous project. All you need to do is determine the latitude and longitude point of a particular postal code, which you can get from most geocoder services, and you'll be able to find the closest places.</p><p>Of course, having a postal code table in your own database is even more useful. This process is described in <a class="xref" href="ch03s06.html" title="#15: Get Postal Code Coordinates">#15: Get Postal Code Coordinates</a> in <a class="xref" href="ch03s06.html" title="#15: Get Postal Code Coordinates">#15: Get Postal Code Coordinates</a>, and I have links to database sources at <a class="ulink" href="http://mapscripting.com/postal-code-database">http://mapscripting.com/postal-code-database</a>. Installing your own database will save one step in the process, so you can find the ZIP Code's coordinates and its closest places in one call to the database.</p><p>Create a new database table, which I'll be calling <span class="emphasis"><em>postals</em></span>. It will have three columns: <span class="emphasis"><em>code</em></span>, <span class="emphasis"><em>latitude</em></span>, and <span class="emphasis"><em>longitude</em></span>. As you can see in <a class="xref" href="ch09s10.html#create_a_zip_code_table" title="Figure 9-12. Create a ZIP Code table.">Figure 9-12</a>, the postal code itself is a five-character string (<span class="emphasis"><em>varchar</em></span>) because that's what is used in the United States, where ZIP Codes are five digits.</p><div class="figure"><a id="create_a_zip_code_table"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject9_d1e12128"/><img src="httpatomoreillycomsourcenostarchimages672109.png.jpg" alt="Create a ZIP Code table."/></div></div><p class="title">Figure 9-12. Create a ZIP Code table.</p></div><p>The postal code is represented as text to account for the situation when the code starts with a zero. If you store the code as a number, which is more efficient, you will need to account for the starting zero with every lookup. Latitude and longitude are floating point numbers, just as they are in the places database.</p><p>Here is the SQL version to create this table in the command interpreter:</p><a id="I_programlisting9_d1e12137"/><pre class="programlisting">CREATE TABLE postals(code VARCHAR(5), latitude FLOAT, longitude FLOAT);</pre><p>Now you're ready to add some postal codes to your database. You can do a few by hand just for this test, using a geocoder to determine the correct latitude and longitude points. A better long-term solution would be to download a full postal code database and use <a class="xref" href="ch09s06.html" title="#64: Import Data from a Spreadsheet">#64: Import Data from a Spreadsheet</a> in <a class="xref" href="ch09s06.html" title="#64: Import Data from a Spreadsheet">#64: Import Data from a Spreadsheet</a>.</p><p>At this point, your database should have two tables: <span class="emphasis"><em>places</em></span> and <span class="emphasis"><em>postals</em></span>. We'll use both together in one SQL call to determine the nearest places.</p><p>From either the MySQL Command Interpreter or phpMyAdmin, type the following query:</p><a id="I_programlisting9_d1e12156"/><pre class="programlisting">SELECT <strong class="userinput"><code>@lat:=latitude, @lon:=longitude</code></strong> FROM postals WHERE code='90210';
SET @earthRadius = 6371;
SET @radLat = RADIANS(@lat);
SET @radLon = RADIANS(@lon);
SET @cosLat = COS(@radLat);
SET @sinLat = SIN(@radLat);
SELECT label, latitude, longitude
  ( @earthRadius * ACOS( @cosLat * cosRadLat *
  COS( radLon - @radLon ) + @sinLat *
  sinRadLat ) ) AS dist
FROM places
ORDER BY dist;</pre><p>Most of the query is the same as the optimized version from the previous project. Instead of hard-coding the latitude and longitude, the first line selects it from our <span class="emphasis"><em>postals</em></span> database. The portion in bold stores the coordinates in the <code class="literal">@lat</code> and <code class="literal">@lon</code> variables.</p><p>The results of our example query are shown in <a class="xref" href="ch09s10.html#results_of_nearest_place_sql-id1" title="Table 9-3. Results of Nearest Place SQL">Table 9-3</a>. Again, because I've chosen a location on the west coast of the United States, Old Faithful geyser is closest. As for finding places near a point, the really interesting stuff comes when you have many places all within one city.</p><div class="table"><a id="results_of_nearest_place_sql-id1"/><p class="title">Table 9-3. Results of Nearest Place SQL</p><div class="table-contents"><table summary="Results of Nearest Place SQL" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Label</p></th><th style="text-align: left" valign="bottom"><p>Latitude</p></th><th style="text-align: left" valign="bottom"><p>Longitude</p></th><th style="text-align: left" valign="bottom"><p>Distance</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p>Old Faithful geyser</p></td><td style="text-align: left" valign="top"><p>44.46</p></td><td style="text-align: left" valign="top"><p>− 110.83</p></td><td style="text-align: left" valign="top"><p>1322.32</p></td></tr><tr><td style="text-align: left" valign="top"><p>St. Louis Gateway Arch</p></td><td style="text-align: left" valign="top"><p>38.62</p></td><td style="text-align: left" valign="top"><p>− 90.19</p></td><td style="text-align: left" valign="top"><p>2566.23</p></td></tr></tbody></table></div></div></div></body></html>