<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;More Complex Utilities and Tricks, Part II"><div class="titlepage"><div><div><h1 class="title"><a id="more_complex_utilities_and_tricks_-id001"/>Chapter 10. More Complex Utilities and Tricks, Part II</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject10_d1e17158"/><img alt="image with no caption" src="httpatomoreillycomsourcenostarchimages686190.png.jpg"/></div></div><p>In this chapter, I’ll describe an important functional technique called the <span class="emphasis"><em>callback</em></span>, in which a general-purpose method uses a Proc to determine its specific result. We’ve actually seen this plenty of times before, because it’s built right into many Ruby methods. Let’s say we want to double every number in a list. That’s easy. We just use <code class="literal">[0, 1, 2].map { |x| x * 2 }</code> and get <code class="literal">[0, 2, 4]</code> as the result. If we want to find all numbers greater than 1, we use <code class="literal">[0, 1, 2].find_all { |x| x &gt; 1 }</code> and get [2] instead.<a class="indexterm" id="idx-CHP-10-0996"/><a class="indexterm" id="idx-CHP-10-0997"/><a class="indexterm" id="idx-CHP-10-0998"/></p><p>All we’re doing in either case is using a general purpose method like <code class="literal">map</code> or <code class="literal">find_all</code> that takes a block, like <code class="literal">{ |x| x * 2 }</code> or <code class="literal">{ |x| x &gt; 1 }</code>, and bases its output on the results of that block. The <code class="literal">map</code> method performs the block’s operation on every member of its calling object, while <code class="literal">find_all</code> returns a collection that only contains members that passed the test that the block describes. In both cases, the specifics are completely determined by the block. Conceptually, that’s all a callback is. Let’s see a specific useful example that uses Procs instead of blocks to describe callbacks.</p><div class="sect1" title="#37 Overnight DJ (radio_player1.rb)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp37_overnight_dj_radio_player1rb"/>#37 Overnight DJ (radio_player1.rb)</h1></div></div></div><p>One of my friends has had a very colorful employment history. He’s been a DJ and general manager of a <a class="indexterm" id="idx-CHP-10-0999"/>radio station, a union organizer, a journalist and translator in Japan, and a professional nightclub musician.<sup>[<a class="footnote" href="#ftn.CHP-10-FNOTE-1" id="CHP-10-FNOTE-1">28</a>]</sup> Back when he was running a jazz radio station, he had a problem: His station relied heavily on volunteers and automation, as many jazz stations do, and the station operators would set up an automated computer system to play sound files overnight. The drawback was that the system had no logging, so if a listener heard something he or she liked at 2:47 AM, the operators couldn’t find out what the specific tune was. No one was at the station to take a phone call, and the next morning, there was no log of what sound file was played when, so no one could track down what was playing at a specific time that morning before anyone came in.</p><p>Enter <code class="literal">radio_player1.rb</code> and <code class="literal">radio_player2.rb</code>. These programs demonstrate a solution to this type of problem. The <code class="literal">radio_player1.rb</code> script gets us started with the basics, including an explanation of how Ruby uses callbacks, and <code class="literal">radio_player2.rb</code> does the real heavy lifting, including logging. Note that <code class="literal">radio_player1.rb</code> doesn’t really do any playback, it just demonstrates the techniques.<a class="indexterm" id="idx-CHP-10-1001"/></p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id036"/>The Code</h2></div></div></div><a id="I_programlisting10_d1e17254"/><pre class="programlisting">  #a/usr/bin/env ruby
  # radio_player1.rb

❶ PLAY_FILE_PROC = lambda do |filename|    <em class="lineannotation"><span class="lineannotation">Callbacks</span></em>
    puts "I'm playing #{filename}."
  end

❷ DONT_PLAY_FILE_PROC = lambda do |filename|
    puts "I'm not playing #{filename}. So there."
  end

❸ class RadioPlayer

❹   DIRS_TO_IGNORE = ['.', '..', 'CVS']    <em class="lineannotation"><span class="lineannotation">CVS</span></em>

❺   PICK_FROM_DIR_PROC = lambda do |dir, callback_proc, dir_filter|

      puts "I'm inside #{dir}" if $DEBUG
❻       (Dir.open(dir).entries - DIRS_TO_IGNORE).sort.each do |filename|

❼         if ((filename =~ dir_filter) or not dir_filter)
            item = "#{dir}/#{filename}"
            puts "#{item} passes the filter" if $DEBUG

❽           if File.directory?(item)
              puts "#{item} is a directory" if $DEBUG
              PICK_FROM_DIR_PROC.call(
                item, callback_proc, dir_filter
              )
          else
            puts "#{item} is a file" if $DEBUG
            callback_proc.call(item)
          end

        end

      end

    end

❾   def self.<a class="indexterm" id="idx-CHP-10-1002"/>walk(dir, callback_proc, dir_filter=nil)
      puts
      puts "I'm walking #{dir} using filter #{dir_filter.inspect}" if $DEBUG
      PICK_FROM_DIR_PROC.call(dir, callback_proc, dir_filter)
    end

  end

❿ dir = 'extras/soundfiles'
  callback   = (ARGV[0] == 'play') ? PLAY_FILE_PROC : DONT_PLAY_FILE_PROC
  dir_filter = ARGV[1] ? Regexp.new(ARGV[1]) : nil
  <a class="indexterm" id="idx-CHP-10-1003"/>RadioPlayer.walk(dir, callback, dir_filter)
  puts</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id035"/>How It Works</h2></div></div></div><p>First, we define our callbacks as Proc Constants. At ❶, we have the <code class="literal">PLAY_FILE_PROC</code>, and at ❷, we have the <code class="literal">DONT_PLAY_FILE_PROC</code>. Since <code class="literal">radio_player1.rb</code> is just a demonstration script, both of these Procs merely report what they would do instead of actually doing anything. Think of them as “dry run” testing examples. At ❸ we define a new class called <code class="literal">RadioPlayer</code>. We’ll detail that class soon, but for now, it’ll be easier to understand how this script works if we skip down to ❿, where we see how the class is used.<a class="indexterm" id="idx-CHP-10-1004"/></p><p>We define a variable called <code class="literal">dir</code>, with the value <code class="literal">‘extras/soundfiles’</code>. That’s where I stored the audio files used by this example; it’s analogous to the directory that contains the radio station’s songs, sound bites, station identification, and so forth. We then set the value of a variable called <code class="literal">callback</code>. It stores the appropriate Proc, either <code class="literal">PLAY_FILE_PROC</code> or <code class="literal">DONT_PLAY_FILE_PROC</code>. If the first argument to the script (<code class="literal">ARGV[0]</code>) is <code class="literal">‘play’</code>, it uses <code class="literal">PLAY_FILE_PROC</code>. Otherwise, it uses <code class="literal">DONT_PLAY_FILE_PROC</code>. Next, we define a variable called <code class="literal">dir_filter</code>, which is either a defined RegExp instance or <code class="literal">nil</code>. As the name suggests, this filters directories within the main <code class="literal">dir</code> soundfile directory. If <code class="literal">dir_filter</code> is <code class="literal">nil</code>, it does no filtering, and it assumes the entire contents of <code class="literal">dir</code> are available for playing. We then call the <code class="literal">walk</code> (❾) class method of <code class="literal">RadioPlayer</code> with the arguments <code class="literal">dir, callback</code>, and <code class="literal">dir_filter</code>.</p><p>The <code class="literal">self.walk</code> method takes three arguments: <code class="literal">dir, callback_proc</code>, and <code class="literal">dir_filter</code>. The first two are mandatory, while <code class="literal">dir_filter</code> is optional, defaulting to <code class="literal">nil</code>. It prints an empty line with <code class="literal">puts</code>, and if the <a class="indexterm" id="idx-CHP-10-1005"/>script is called with the <code class="literal">-d</code> flag (which sets <code class="literal">$DEBUG</code> to <code class="literal">true</code>), <code class="literal">self.walk</code> also prints some boilerplate indicating what it’s doing. It then executes a <code class="literal">call</code> to a Proc Constant called <code class="literal">PICK_FROM_DIR_PROC</code>, using the same three arguments—<code class="literal">dir, callback_proc</code>, and <code class="literal">dir_filter</code>.<a class="indexterm" id="idx-CHP-10-1006"/></p><p>Now, to understand what that means, we’ll describe the <code class="literal">RadioPlayer</code> class at ❸. It has two Constants: <code class="literal">DIRS_TO_IGNORE</code> and <code class="literal">PICK_FROM_DIR_PROC. DIRS_TO_IGNORE</code> (❹) lists the directories that the script should not care about. It includes the current directory (<code class="literal">‘.’</code>), the directory up a level (<code class="literal">‘..’</code>), and the directory used by CVS.</p><div class="note" title="Note"><h3 class="title"><a id="note-59"/>Note</h3><p><span class="emphasis"><em>Concurrent Versions System (CVS) is a program that keeps track of different versions of files. It’s most often used for software development. You can read more about it at</em></span> <a class="ulink" href="http://www.nongnu.org/cvs">http://www.nongnu.org/cvs</a>.<a class="indexterm" id="idx-CHP-10-1007"/></p></div><p>The second Constant within <code class="literal">RadioPlayer</code> is <code class="literal">PICK_FROM_DIR_PROC</code> (❺), which is a Proc that picks from directories. We create it in the usual way with <code class="literal">lambda</code> and define it to take three arguments: <code class="literal">dir, callback_proc</code>, and <code class="literal">dir_filter</code>. These correspond to the three arguments to <code class="literal">walk</code> (❾) that we described at the bottom of this script at ❿.</p><p>Now we get to see what these arguments end up being used for. The <code class="literal">PICK_FROM_DIR_PROC</code> Constant has several debugging lines that <code class="literal">puts</code> a given message if <code class="literal">$DEBUG</code> is set to <code class="literal">true</code>. I won’t detail each of them, as they should be fairly self explanatory. We start by looping through <code class="literal">each</code> sorted <code class="literal">filename</code>, based on the <code class="literal">entries</code> within <code class="literal">dir</code>, minus the <code class="literal">DIRS_TO_IGNORE</code> (❻). Next, we verify that either the <code class="literal">filename</code> matches the <code class="literal">dir_filter</code> with a regular expression test, or there is no <code class="literal">dir_filter</code> in place (❼). Assuming we should proceed, we assign the interpolated String <code class="literal">“#{dir}/#{filename}”</code> into a local variable called <code class="literal">item</code>. We’ll be using <code class="literal">item</code> frequently enough that it’s worthwhile to set it once and reuse it, rather than recalculate it every time.</p><p>Next, we use the <code class="literal">File.directory?</code> predicate (❽) to determine whether or not <code class="literal">item</code> is a directory. If it is a directory, we need to pick from that directory as well, so we recursively call <code class="literal">PICK_FROM_DIR_PROC</code>, with the arguments <code class="literal">item, callback_proc</code>, and <code class="literal">dir_filter</code>. The current value of <code class="literal">item</code> now becomes the value of <code class="literal">dir</code> in the new recursive call, so when we get to the assignment into <code class="literal">item</code> within the recursive call, that item consists of a String like the following: <code class="literal">“#{top_dir}/{next_dir}/#{filename}”</code>, and so on. This keeps happening until we reach a non-directory <code class="literal">filename</code>. What happens then?</p><p>In this case we consult the <code class="literal">else</code> clause within the <code class="literal">if</code> block at ❽. Here, we finally call the <code class="literal">callback_proc</code>, with <code class="literal">item</code> as the argument. Let’s assume that we are using <code class="literal">PLAY_FILE_PROC</code> as the <code class="literal">callback_proc</code>. We’ll therefore <code class="literal">puts</code> a message saying that we’re playing <code class="literal">filename</code>. This happens for every terminal (non-directory) <code class="literal">filename</code> within the execution of <code class="literal">self.walk</code> (❾). Let’s see it in action. First let’s see the contents of <code class="literal">extras/soundfiles</code>:<a class="indexterm" id="I_indexterm10_d1e17572"/></p><a id="I_programlisting10_d1e17575"/><pre class="programlisting">$ ls -R extras/soundfiles/
extras/soundfiles/:
01-Neal_And_Jack_And_Me.ogg  CVS  legal  promo
extras/soundfiles/CVS:
Entries  Repository  Root

extras/soundfiles/legal:
CVS  legal1  legal2

extras/soundfiles/legal/CVS:
CVS  Entries  Repository  Root

extras/soundfiles/legal/CVS/CVS:
Entries  Repository  Root

extras/soundfiles/promo:
CVS  promo1  promo2

extras/soundfiles/promo/CVS:
CVS  Entries  Repository  Root

extras/soundfiles/promo/CVS/CVS:
Entries  Repository  Root</pre><p>Other than those CVS directories I mentioned, we have a file called <code class="literal">01-Neal_And_Jack_And_Me.ogg</code> at the top level, a directory called <code class="literal">legal</code> with the files <code class="literal">legal1</code> and <code class="literal">legal2</code>, and a directory called <code class="literal">promo</code> with the files <code class="literal">promo1</code> and <code class="literal">promo2</code>. Now, let’s run <code class="literal">radio_player1.rb</code> with various arguments.</p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id033"/>The Results</h2></div></div></div><a id="I_programlisting10_d1e17608"/><pre class="programlisting">$ ruby -w <a class="indexterm" id="idx-CHP-10-1008"/>radio_player1.rb

I'm not playing extras/soundfiles/01-Neal_And_Jack_And_Me.ogg. So there.
I'm not playing extras/soundfiles/legal/legal1. So there.
I'm not playing extras/soundfiles/legal/legal2. So there.
I'm not playing extras/soundfiles/promo/promo1. So there.
I'm not playing extras/soundfiles/promo/promo2. So there.</pre><p>We provided no <code class="literal">ARGV[0]</code>, so it assumed <code class="literal">DONT_PLAY_FILE_PROC</code> for the callback. It also had no <code class="literal">dir_filter</code>, so it “not played” every file within <code class="literal">extras/soundfiles</code>, except within the directories we told it to ignore—maybe it’s silly to explicitly “not play” sound files, but I just wanted a callback that could show in an obvious fashion that it was being called. Let’s see some more.</p><a id="I_programlisting10_d1e17630"/><pre class="programlisting">$ ruby -w radio_player1.rb play legal

I'm playing extras/soundfiles/legal/legal1.
I'm playing extras/soundfiles/legal/legal2.</pre><p>Here, <code class="literal">ARGV[0]</code> is <code class="literal">‘play’</code>, and <code class="literal">ARGV[1]</code> limits available files to those matching <code class="literal">/legal/</code>. It worked.</p><a id="I_programlisting10_d1e17646"/><pre class="programlisting">$ ruby -w <a class="indexterm" id="idx-CHP-10-1009"/>radio_player1.rb play

I'm playing extras/soundfiles/01-Neal_And_Jack_And_Me.ogg.
I'm playing extras/soundfiles/legal/legal1.
I'm playing extras/soundfiles/legal/legal2.
I'm playing extras/soundfiles/promo/promo1.
I'm playing extras/soundfiles/promo/promo2.</pre><p>It worked again.</p></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id025"/>Hacking the Script</h2></div></div></div><p>The most basic hack of this script is to call it with the <code class="literal">-d</code> command-line option. That tells you where the script is at any given point, and it may reveal some useful information as you try different arguments, create your own files and directories with <code class="literal">extras/soundfiles</code>, or do whatever other customization you think is appropriate.</p><p>The beauty of callbacks is that you can hack your program by simply using a different one. The overall structure of the manner in which you do some particular operation stays the same, while the specific operation being done can change, often quite drastically. We’ll see an example of that in the next script.</p></div></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-10-FNOTE-1" id="ftn.CHP-10-FNOTE-1">28</a>] </sup>Now he blogs and podcasts at <a class="ulink" href="http://thejasoncraneshow.com">http://thejasoncraneshow.com</a>.<a class="indexterm" id="idx-CHP-10-1000"/></p></div></div></div>
<div class="sect1" title="#38 Better Overnight DJ (radio_player2.rb)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp38_better_overnight_dj_radio_player"/>#38 Better Overnight DJ (radio_player2.rb)</h1></div></div></div><p>This script, <code class="literal">radio_player2.rb</code>, is an improvement on <code class="literal">radio_player1.rb</code>. Instead of placeholder Procs, it will actually play sound files, as well as log playback with specific times.<a class="indexterm" id="idx-CHP-10-1010"/><a class="indexterm" id="idx-CHP-10-1011"/><a class="indexterm" id="I_indexterm10_d1e17686"/><a class="indexterm" id="I_indexterm10_d1e17689"/></p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id037"/>The Code</h2></div></div></div><a id="I_programlisting10_d1e17697"/><pre class="programlisting">  #a/usr/bin/env ruby
  # radio_player2.rb


❶ LOG_FILE = '/tmp/radio_player2.log'

❷ PLAYERS = {
    '.mp3' =&gt; 'mpg321',
    '.ogg' =&gt; 'ogg123',
    ''     =&gt; 'ls'
  }

❸ # these are variables, local to Kernel.
  # They work just as well as constants.
  <a class="indexterm" id="idx-CHP-10-1012"/>play_file_proc = lambda do |filename|    <em class="lineannotation"><span class="lineannotation">Callbacks</span></em>
❹   ext = File.extname(filename)
❺   system("#{PLAYERS[ext]} #{filename}") if PLAYERS[ext]
❻   File.open(LOG_FILE, 'a') do |log|
      log.puts([Time.now, filename].join("\t") + "\n")
    end
  end

  <a class="indexterm" id="idx-CHP-10-1013"/>dont_play_file_proc = lambda do |filename|
    puts "I'm not playing #{filename}. So there."
  end

  class RadioPlayer

    DIRS_TO_IGNORE = ['.', '..', 'CVS']

    PICK_FROM_DIR_PROC = lambda do |dir, callback_proc, dir_filter|

      (Dir.open(dir).entries - DIRS_TO_IGNORE).sort.each do |filename|

        if ((filename =~ dir_filter) or not dir_filter)
          item = "#{dir}/#{filename}"

          if File.directory?(item)
            PICK_FROM_DIR_PROC.call(
              item, callback_proc, dir_filter
            )
          else
            callback_proc.call(item)
          end

        end

      end

    end

    def self.walk(dir, callback_proc, dir_filter=nil)
      puts
      PICK_FROM_DIR_PROC.call(dir, callback_proc, dir_filter)
    end

  end

  dir = 'extras/soundfiles'
  callback   = (ARGV[0] == 'play') ? play_file_proc : dont_play_file_proc
  dir_filter = ARGV[1] ? Regexp.new(ARGV[1]) : nil
  RadioPlayer.walk(dir, callback, dir_filter)
  puts</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id036"/>How It Works</h2></div></div></div><p>For this section, I’ll merely detail the changes between <code class="literal">radio_player1.rb</code> and <code class="literal">radio_player2.rb</code>. The first change is the definition of the <code class="literal">LOG_FILE</code> Constant at ❶. As you might expect, this is the filename into which <code class="literal">radio_player2.rb</code> writes logging <a class="indexterm" id="idx-CHP-10-1014"/>messages. Next, we declare a Hash Constant called <code class="literal">PLAYERS</code> at ❷, with keys of file extensions for particular types of soundfiles and values of the names of programs that one might use to play those types of files on a Unix system.<a class="indexterm" id="idx-CHP-10-1015"/></p><p>Next, we define our Procs at ❸, this time as variables rather than Constants. There’s no particular reason to use variables instead of Constants, as the comment notes. I just wanted to show that either approach works well for our purposes. Aside from being variables rather than Constants, the playing Proc is substantively different.</p><p>The <code class="literal">play_file_proc</code> acts as a closure, binding the <code class="literal">PLAYERS</code> Hash inside itself. It establishes the extension (and therefore, type) of its <code class="literal">filename</code> argument as <code class="literal">ext</code> at ❹. It then tries to play that filename using <code class="literal">system</code> at ❺, but only if the <code class="literal">PLAYERS</code> Hash has an appropriate player for that file extension. I made sure that <code class="literal">PLAYERS</code> had an entry for no file extension at all, so <code class="literal">radio_player2.rb</code> could still demonstrate that it was either playing or not playing the dummy files like <code class="literal">legal1</code> and <code class="literal">promo2</code> that have no file extension. Since I just wanted to show the dummy files, I decided that the Unix command <code class="literal">ls</code>, which just lists files, was the appropriate value to use in <code class="literal">PLAYERS</code>.<a class="indexterm" id="idx-CHP-10-1016"/></p><p>The <code class="literal">radio_player2.rb</code> script also logs playback within the <code class="literal">play_file_proc</code>. At ❻, it opens a new file for appending, using <code class="literal">‘a’</code> as the second argument to <code class="literal">File.open</code>. It then refers to that <a class="indexterm" id="idx-CHP-10-1017"/>log file as <code class="literal">log</code>, and uses <code class="literal">log</code>’s <code class="literal">puts</code> method to append the current <code class="literal">Time</code> and the <code class="literal">filename</code> being played, separated by tabs, all followed by a carriage return. Whenever we use <code class="literal">radio_player2.rb</code>, we can check the contents of <code class="literal">LOG_FILE</code> to see what’s been played.</p><p>The only other differences are the removal of the debugging messages and referring to the Procs by the lowercase variable names rather than the all-caps Constant names. Let’s see this version in action.</p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id034"/>The Results</h2></div></div></div><p>Let’s try a basic playback of everything.</p><a id="I_programlisting10_d1e17835"/><pre class="programlisting">$ ruby -w radio_player2.rb play


Audio Device:   OSS audio driver output

Playing: extras/soundfiles/01-Neal_And_Jack_And_Me.ogg
Ogg Vorbis stream: 2 channel, 44100 Hz
Title: Neal and Jack and Me
Artist: <a class="indexterm" id="idx-CHP-10-1018"/>King Crimson
Album: Beat
Date: 1982
Track number: 01
Tracktotal: 08
Genre: Prog Rock
Composer: Belew, Bruford, Fripp, Levin
Musicbrainz_albumid: 5ddbe867-ebce-445d-a175-d90516e426da
Musicbrainz_albumartistid: b38225b8-8e5f-42aa-bcdc-7bae5b5bdab3
Musicbrainz_artistid: b38225b8-8e5f-42aa-bcdc-7bae5b5bdab3
Musicbrainz_trackid: 30a23275-11ef-4f07-bdc8-0192ae34e67d
Done.
extras/soundfiles/legal/legal1
extras/soundfiles/legal/legal2
extras/soundfiles/promo/promo1
extras/soundfiles/promo/promo2</pre><p>That command-line call played the Ogg file (again, from my favorite band <a class="indexterm" id="idx-CHP-10-1019"/>King Crimson) using a <code class="literal">system</code> call with <code class="literal">ogg123</code>, the appropriate value within <code class="literal">PLAYERS</code> for the <code class="literal">.ogg</code> extension, and then it “played” the other files with <code class="literal">ls</code>, the appropriate <code class="literal">PLAYERS</code> value for files with no extension at all.</p><p>Now let’s filter, with fake playback.</p><a id="I_programlisting10_d1e17868"/><pre class="programlisting">$ ruby -w <a class="indexterm" id="idx-CHP-10-1020"/>radio_player2.rb play legal

extras/soundfiles/legal/legal1
extras/soundfiles/legal/legal2</pre><p>And again, without fake playback.</p><a id="I_programlisting10_d1e17876"/><pre class="programlisting">$ ruby -w <a class="indexterm" id="idx-CHP-10-1021"/>radio_player2.rb dont legal

I'm not playing extras/soundfiles/legal/legal1. So there.
I'm not playing extras/soundfiles/legal/legal2. So there.</pre><p>Notice that playback merely lists the dummy files, while non-playback executes the full <code class="literal">dont_play_file_proc</code>, including the immature <code class="literal">So there.</code> suffix.</p></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id026"/>Hacking the Script</h2></div></div></div><p>The value of <code class="literal">LOG_FILE</code> is Unix-specific. Windows users (or anyone else) can certainly change that filename to something more appropriate for their operating system. Also, if you prefer a more robust system for the dummy files, you could give them their own extension, like <code class="literal">dummy</code>, and change <code class="literal">PLAYERS</code> so that the key for <code class="literal">‘ls’</code> is that new extension.<a class="indexterm" id="I_indexterm10_d1e17909"/><a class="indexterm" id="I_indexterm10_d1e17912"/></p></div></div>
<div class="sect1" title="#39 Numbers by Name (to_lang.rb)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp39_numbers_by_name_to_langrb"/>#39 Numbers by Name (to_lang.rb)</h1></div></div></div><p>In previous scripts, notably <a class="xref" href="ch05s02.html" title="#16 Adding Commas to Numbers (commify.rb)">#16 Adding Commas to Numbers (commify.rb)</a> on page 75 and <a class="xref" href="ch05s03.html" title="#17 Roman Numerals (roman_numeral.rb)">#17 Roman Numerals (roman_numeral.rb)</a> on page 81, we talked about how numbers can be represented in a variety of ways. Both of those scripts showed meaningful ways of representing Integers as Strings, other than the handy but trivially different <code class="literal">to_s</code> method. This script, <code class="literal">to_lang.rb</code>, extends that discussion by representing Integers as Strings consisting of how those numbers are spoken in two real-world languages: English and Spanish.<a class="indexterm" id="idx-CHP-10-1022"/><a class="indexterm" id="idx-CHP-10-1023"/><a class="indexterm" id="idx-CHP-10-1024"/></p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id038"/>The Code</h2></div></div></div><p>This code is broken into three separate files, for reasons that I will make clear in <a class="xref" href="ch10s03.html#how_it_works-id037" title="How It Works">How It Works</a> on page 198.</p><div class="sect3" title="representable_in_english.rb"><div class="titlepage"><div><div><h3 class="title"><a id="representable_in_englishrb"/>representable_in_english.rb</h3></div></div></div><a id="I_programlisting10_d1e17956"/><pre class="programlisting">  =begin rdoc
  This is intended for use with <a class="indexterm" id="idx-CHP-10-1025"/>to_lang.rb
  =end

❶ module Representable_In_English

  =begin rdoc
  Return a &lt;b&gt;Hash&lt;/b&gt; whose keys are &lt;b&gt;Integer&lt;/b&gt;s and whose values
  are the words representing the same values.
  =end
❷   def create_english()
      need_ones_in_english.merge(dont_need_ones_in_english)

    end

❸   def special_replacements_in_english(num_as_string)
      add_hyphens_to_tens(num_as_string).strip
    end

❹   def to_english()    <em class="lineannotation"><span class="lineannotation">Syntactic Sugar</span></em>
      to_lang('english')
    end

❺   alias :to_en :to_english

❻   private

❼   def add_hyphens_to_tens(num_as_string)
      num_as_string.sub(/ty/, 'ty-').sub(/-?- ?/, '-')
    end

❽   def need_ones_in_english()
      return {
        10 ** 9 =&gt; 'billion',
        10 ** 6 =&gt; 'million',
        10 ** 3 =&gt; 'thousand',
        100     =&gt; 'hundred',
      }
    end

❾   def dont_need_ones_in_english()
      return {
        90 =&gt; 'ninety',
        80 =&gt; 'eighty',
        70 =&gt; 'seventy',
        60 =&gt; 'sixty',
        50 =&gt; 'fifty',
        40 =&gt; 'forty',
        30 =&gt; 'thirty',
        20 =&gt; 'twenty',
        19 =&gt; 'nineteen',
        18 =&gt; 'eighteen',
        17 =&gt; 'seventeen',
        16 =&gt; 'sixteen',
        15 =&gt; 'fifteen',
        14 =&gt; 'fourteen',
        13 =&gt; 'thirteen',
        12 =&gt; 'twelve',
        11 =&gt; 'eleven',
        10 =&gt; 'ten',
         9 =&gt; 'nine',
         8 =&gt; 'eight',
         7 =&gt; 'seven',
         6 =&gt; 'six',
         5 =&gt; 'five',
         4 =&gt; 'four',
         3 =&gt; 'three',
         2 =&gt; 'two',
         1 =&gt; 'one',
         0 =&gt; '',
      }
    end

  end</pre><p>Next will be a very similar <a class="indexterm" id="idx-CHP-10-1026"/>file, also storing a module/mixin definition. The only meaningful differences pertain to the choice of language: this one details Spanish, rather than English.<a class="indexterm" id="idx-CHP-10-1027"/></p></div><div class="sect3" title="representable_in_spanish.rb"><div class="titlepage"><div><div><h3 class="title"><a id="representable_in_spanishrb"/>representable_in_spanish.rb</h3></div></div></div><a id="I_programlisting10_d1e17977"/><pre class="programlisting">  =begin rdoc
  This is intended for use with <a class="indexterm" id="idx-CHP-10-1028"/>to_lang.rb
  =end

❶ module Representable_In_Spanish

  =begin rdoc
  Return a &lt;b&gt;Hash&lt;/b&gt; whose keys are &lt;b&gt;Integer&lt;/b&gt;s and whose values
  are the words representing the same values.
  =end
❷   def create_spanish()
      need_ones_in_spanish.merge(dont_need_ones_in_spanish)
    end

❸   def special_replacements_in_spanish(num_as_string)
      add_hyphens_to_tens(num_as_string).strip
    end

❹   def to_spanish()    <em class="lineannotation"><span class="lineannotation">Syntactic Sugar</span></em>
      to_lang('spanish')
    end

❺   alias :to_es :to_spanish

❻   private

❼   def add_hyphens_to_tens(num_as_string)
      num_as_string.sub(/ta/, 'ta-').sub(/-?- ?/, '-')
    end

❽   def need_ones_in_spanish()
      return {
        10 ** 12 =&gt; 'billon',
        10 ** 9  =&gt; 'mil millones',
        10 ** 6  =&gt; 'millon',
        10 ** 3  =&gt; 'mil',
        100      =&gt; 'ciento',
      }
    end

❾   def dont_need_ones_in_spanish()
      return {
        90 =&gt; 'noventa',
        80 =&gt; 'ochenta',
        70 =&gt; 'setenta',
        60 =&gt; 'sesenta',
        50 =&gt; 'cincuenta',
        40 =&gt; 'cuarenta',
        30 =&gt; 'treinta',
        20 =&gt; 'veinte',
        19 =&gt; 'diecinueve',
        18 =&gt; 'dieciocho',
        17 =&gt; 'diecisiete',
        16 =&gt; 'dieciseis',
        15 =&gt; 'quince',
        14 =&gt; 'catorce',
        13 =&gt; 'trece',
        12 =&gt; 'doce',
        11 =&gt; 'once',
        10 =&gt; 'deiz',
         9 =&gt; 'nueve',
         8 =&gt; 'ocho',
         7 =&gt; 'siete',
         6 =&gt; 'seis',
         5 =&gt; 'cinco',
         4 =&gt; 'cuatro',
         3 =&gt; 'tres',
         2 =&gt; 'dos',
         1 =&gt; 'uno',
         0 =&gt; '', # 'cero'
       }
     end

  end</pre><p>Finally, we have the code that directly gives Integers the ability to represent themselves in spoken languages. It does so through the use of the modules above, as you’ll see.<a class="indexterm" id="idx-CHP-10-1029"/></p></div><div class="sect3" title="to_lang.rb"><div class="titlepage"><div><div><h3 class="title"><a id="to_langrb"/>to_lang.rb</h3></div></div></div><a id="I_programlisting10_d1e17994"/><pre class="programlisting">  #!/usr/bin/env ruby -w
  # <a class="indexterm" id="idx-CHP-10-1030"/>to_lang.rb

  =begin rdoc
  Implement representation of numbers in human languages:
  1 =&gt; 'one',
  2 =&gt; 'two',
  etc.

  This is an generalized extension of ideas shown for the
  specific case of roman numerals in roman_numeral.rb

  Note that similar work has already been done at
  http://www.deveiate.org/projects/Linguistics/wiki/English
  This version focuses only on converting numbers to multiple
  language targets, and pedantically considers "and" to be
  the pronunciation of the decimal point.
  =end

  class Integer

❶   require 'representable_in_english'    <em class="lineannotation"><span class="lineannotation">Requiring Our Own Mixins</span></em>
    require 'representable_in_spanish'

❷   include Representable_In_English
    include Representable_In_Spanish

❸   EMPTY_STRING = ''
    SPACE        = ' '

❹   @@lang_of ||= Hash.new()

❺   def need_ones?(lang)    <em class="lineannotation"><span class="lineannotation">The<strong class="userinput"><code> send</code></strong> Method</span></em>
      send("need_ones_in_#{lang}").keys.include?(self)
    end

❻   def to_lang(lang)
      return EMPTY_STRING if self.zero?

      @@lang_of[lang] ||= send("create_#{lang}")

      base      = get_base(lang)
      mult      = (self / base).to_i
      remaining = (self - (mult * base))

      raw_output = [
        mult_prefix(base, mult, lang),
        @@lang_of[lang][base],
        remaining.to_lang(lang)
      ].join(SPACE)

      return send(
      "special_replacements_in_#{lang}",
      raw_output)
    end

❼   private

❽   def get_base(lang)
      return self if @@lang_of[lang][self]
      @@lang_of[lang].keys.sort.reverse.detect do |k|
        k &lt;= self
      end
    end

❾   def mult_prefix(base, mult, lang)
      return mult.to_lang(lang) if mult &gt; 1
      return 1.to_lang(lang)    if base.need_ones?(lang)
      return EMPTY_STRING
    end

  end</pre></div></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id037"/>How It Works</h2></div></div></div><p>Let’s examine each file in turn. Since <code class="literal">representable_in_english.rb</code> and <code class="literal">representable_in_spanish.rb</code> are so similar, we can deal with them simultaneously.<a class="indexterm" id="idx-CHP-10-1031"/></p><div class="sect3" title="The Two Mixins"><div class="titlepage"><div><div><h3 class="title"><a id="the_two_mixins"/>The Two Mixins</h3></div></div></div><p>Both <code class="literal">representable_in_english.rb</code> and <code class="literal">representable_in_spanish.rb</code> are <span class="emphasis"><em>mixins</em></span>, the mechanism Ruby uses to give shared behavior to classes with different ancestry, like giving both bats and birds the ability to fly. In our case, instead of giving organisms the ability to fly, we’re giving the object we mix our mixins into the ability to represent itself in some human languages: English and Spanish, in this case.<a class="indexterm" id="idx-CHP-10-1032"/></p><p>We define the appropriate Module, in both <code class="literal">representable_in_english.rb</code> and <code class="literal">representable_in_spanish.rb</code>, at ❶. I’ll keep the numbered callouts in the code in parallel across these two files throughout this example. At ❷, we define our <code class="literal">create_english</code> or <code class="literal">create_spanish</code> methods. The purpose of either method is to return a Hash whose keys are Integers and whose values are the representation of those Integers in the module’s language. The resulting Hash’s pairs will form our base cases, and we’ll use them very similarly to the ones we used in the <code class="literal">roman_numeral.rb</code> <a class="indexterm" id="idx-CHP-10-1033"/>script in <a class="xref" href="ch05.html" title="Chapter 5. Number Utilities">Chapter 5</a>. Then at ❸, we define a special replacements method, customized and named for the language. Every language is likely to have some special treatment, even beyond what we can do with the differences in the Hash returned by <code class="literal">create_english</code> or <code class="literal">create_spanish</code>. So far, all we need to do is add hyphens to numbers with tens components. To accomplish that task, we call the <code class="literal">add_hyphens_to_tens</code> method, which we define at ❼.<a class="indexterm" id="idx-CHP-10-1034"/><a class="indexterm" id="idx-CHP-10-1035"/></p><p>At ❹ and ❺, we add some of what programmers call <span class="emphasis"><em>syntactic sugar</em></span>, or a simplification of a language’s syntax. The term <span class="emphasis"><em>syntactic</em></span> sugar can have a negative connotation, but it doesn’t have to. It generally refers to a shortcut that a programmer uses to more easily accomplish a commonly needed technique, such as adding method aliases with <code class="literal">alias</code>. It’s relatively easy to add syntactic sugar to Ruby, as our examples show. We can add methods like <code class="literal">to_english</code> or <code class="literal">to_spanish</code> by calling <code class="literal">to_lang</code> (soon to be defined in <code class="literal">to_lang.rb</code>) with the appropriate <code class="literal">lang</code> argument.<sup>[<a class="footnote" href="#ftn.CHP-10-FNOTE-2" id="CHP-10-FNOTE-2">29</a>]</sup> We can also use <code class="literal">alias</code> to make <code class="literal">to_en</code> refer to <code class="literal">to_english</code>, and <code class="literal">to_es</code> refer to <code class="literal">to_spanish</code>.</p><p>Some of our methods can be private, so we declare that at ❻. We’ve already discussed <code class="literal">add_hyphens_to_tens</code> ❼, so we can move on to <code class="literal">need_ones_in_english</code> and <code class="literal">need_ones_in_spanish</code> ❽. This method returns a Hash whose keys are Integers and whose values are the representation of those Integers in the module’s language. This should sound familiar. What makes the pairs in this Hash notable is a characteristic they all share: They all need the prefix <span class="emphasis"><em>one</em></span> (in the appropriate language) when there is in fact only one of those numbers. The number <span class="emphasis"><em>100</em></span> is pronounced <span class="emphasis"><em>one hundred</em></span> in English, for example.<a class="indexterm" id="idx-CHP-10-1039"/><a class="indexterm" id="idx-CHP-10-1040"/></p><p>“Of course!” you might think. However, contrast the Hashes returned by <code class="literal">need_ones_in_english</code> ❽ and <code class="literal">dont_need_ones_in_english</code> ❾. The Integer keys of the Hash created at ❾ do not need the <span class="emphasis"><em>one</em></span> prefix. You don’t say <span class="emphasis"><em>one twenty</em></span> for <span class="emphasis"><em>20</em></span>, for example, so we need a way to differentiate between numbers that need the prefix and those that don’t. The different methods at ❽ and ❾ are our way to do so. When we want all of them together and when we don’t care about the prefix issue we can simply <code class="literal">merge</code> the two Hashes together. This is exactly what we will do in the <code class="literal">to_lang.rb</code> file, which we’re about to examine.</p></div><div class="sect3" title="The Main Code"><div class="titlepage"><div><div><h3 class="title"><a id="the_main_code"/>The Main Code</h3></div></div></div><p>The first thing we do in <code class="literal">to_lang.rb</code> is open the Integer class, since we want to add new behavior to Integers. At ❶, we <code class="literal">require</code> the mixin files just discussed, and at ❷, we <code class="literal">include</code> them within the Integer class, giving all Integers the methods defined in the mixin files, including both aliases. We also want some Constants, mainly for convenient text manipulation, so we define those at ❸. We close off the pre-methods section by defining a class variable called <code class="literal">@@lang_of</code> at ❹. It’s a Hash that will eventually store the merged result of the two Hashes from the mixins’ markers at ❽ and ❾. Since we define it with <code class="literal">||=</code>, it is only defined in the first Integer instantiated, and then it is shared among all of them.</p><p>At ❺, we define a predicate called <code class="literal">need_ones?</code>, which takes a <code class="literal">lang</code> argument and simply makes a call to either <code class="literal">need_ones_in_english</code> (defined in <code class="literal">representable_in_english.rb</code>) or <code class="literal">need_ones_in_spanish</code> (defined in <code class="literal">representable_in_spanish.rb</code>), as appropriate to the <code class="literal">lang</code> argument. It doesn’t matter which of the files the called method is defined in, because they are both included at ❷ in <code class="literal">to_lang.rb</code>.<a class="indexterm" id="idx-CHP-10-1041"/></p><p>Our main workhorse method <code class="literal">to_lang</code>, appears at ❻; this method takes a single, mandatory <code class="literal">lang</code> argument. It returns early with the <code class="literal">EMPTY_STRING</code> <a class="indexterm" id="idx-CHP-10-1042"/>if <code class="literal">self</code> is zero. This means that if we call <code class="literal">0.to_lang(‘english’)</code>, we get the empty string as the result, instead of the String <code class="literal">‘zero’</code>. (See <a class="xref" href="ch10s03.html#hacking_the_script-id027" title="Hacking the Script">Hacking the Script</a><a class="indexterm" id="idx-CHP-10-1043"/> on page 202 for a way to change that.) Assuming the case should proceed beyond that, <code class="literal">to_lang</code> then sets the value of <code class="literal">@@lang_of[lang]</code>. The <code class="literal">@@lang_of</code> class variable had already been declared as a Hash when the first Integer was instantiated, but only as a Hash with no keys or values. The value put into <code class="literal">@@lang_of[lang]</code> is the result of calling a method called <a class="indexterm" id="idx-CHP-10-1044"/>send with the argument <code class="literal">“create_#{lang}”</code>, which you should recognize as an interpolating String.</p><p>The <code class="literal">send</code> method takes any number of arguments, the first of which must be an expression that evaluates to the <a class="indexterm" id="idx-CHP-10-1045"/>name of a method. It then calls that method with the rest of the arguments. This allows you to do exactly what we’re doing here, which is <a class="indexterm" id="idx-CHP-10-1046"/>dynamically calling a method whose name you don’t yet know. You could work around this by having a test on the <code class="literal">lang</code> argument, and there are many ways to do so. Instead of a traditional method like <code class="literal">create_english</code> or <code class="literal">create_spanish</code>, you could use <a class="indexterm" id="idx-CHP-10-1047"/>Procs as <a class="indexterm" id="idx-CHP-10-1048"/>Hash values, as we’ve done many times since <a class="xref" href="ch06.html" title="Chapter 6. Functionalism with Blocks and Procs">Chapter 6</a>. You could also do something like this:</p><a id="I_programlisting10_d1e18339"/><pre class="programlisting">@@lang_of = if (lang == 'english')
  create_english()
else
  create_spanish()
end</pre><p>Note that we take advantage of the fact that all statements in Ruby return the last expression evaluated, including the <code class="literal">if</code> statement. You have many different options for calling a method whose name you don’t know, but the point is that it doesn’t need to be that difficult. Ruby provides us with the <code class="literal">send</code> method, which is incredibly useful and appropriate.</p><p>At this point, <code class="literal">@@lang_of[lang]</code> will contain the Hash that is the <code class="literal">merge</code>d result of both <code class="literal">need_ones_in_english</code> and <code class="literal">dont_need_ones_in_english</code> (for English) or <code class="literal">need_ones_in_spanish</code> and <code class="literal">dont_need_ones_in_spanish</code> (for Spanish.) Let’s take a cue from <code class="literal">send</code> and express those as <code class="literal">“need_ones_in#{lang}”</code> and <code class="literal">“dont_need_ones_in#{lang}”</code>. We then want to create some local variables called <code class="literal">base, mult</code>, and <code class="literal">remaining</code>.</p><p>The <code class="literal">base</code> variable is the highest Integer key within <code class="literal">@@lang_of[lang]</code> that is equal to or less than <code class="literal">self</code>. We get it from the <code class="literal">get_base</code> method, defined at ❽, which finds the first key in a reverse-sorted version of <code class="literal">@@lang_of[lang]</code> that is equal to or less than <code class="literal">self</code>. It does this via the <code class="literal">detect</code> method (which I like to think of as “find first”). It also has a return guard, where it returns <code class="literal">self</code> if <code class="literal">self</code> is actually one of the keys of <code class="literal">@@lang_of[lang]</code>.<a class="indexterm" id="idx-CHP-10-1049"/></p><p>The <code class="literal">mult</code> variable is simply how many times <code class="literal">base</code> can go into <code class="literal">self</code>, rounded down to the nearest Integer. The <code class="literal">remaining</code> variable is whatever’s left. We then want to create <code class="literal">raw_output</code>, a String that holds the eventual output, before we make any of the special replacements already mentioned in <a class="xref" href="ch10s03.html#the_two_mixins" title="The Two Mixins">The Two Mixins</a> on page 198. The <code class="literal">raw_output</code> String will consist of something representing <code class="literal">(base * mult)</code>, a space, and then the result of making a recursive call to <code class="literal">to_lang</code> on whatever is left (<code class="literal">remaining.to_lang(lang)</code>).</p><p>We accomplish that by constructing an Array. The first element is the output of a method called <code class="literal">mult_prefix</code>, defined at ❾; it takes the arguments <code class="literal">base, mult</code>, and <code class="literal">lang</code>. If <code class="literal">mult</code> is greater than one, we know we need to have a prefix: the number <span class="emphasis"><em>200</em></span> is pronounced <span class="emphasis"><em>two hundred</em></span>, so we need the <span class="emphasis"><em>two</em></span>. If <code class="literal">base</code> needs a one (as described already, pertaining to the <code class="literal">need_ones?</code> predicate), we know that we need to have <span class="emphasis"><em>one</em></span> as a prefix, such as for <span class="emphasis"><em>one hundred</em></span> or <span class="emphasis"><em>one thousand</em></span>. Finally, in all other cases, we return a prefix that is the <code class="literal">EMPTY_STRING</code>, so the number <span class="emphasis"><em>20</em></span> is pronounced <span class="emphasis"><em>twenty</em></span> rather than <span class="emphasis"><em>one twenty</em></span>, and <span class="emphasis"><em>5</em></span> is <span class="emphasis"><em>five</em></span> rather than <span class="emphasis"><em>one five</em></span>. That’s the multiple prefix and the first part of our eventual output.<sup>[<a class="footnote" href="#ftn.CHP-10-FNOTE-3" id="CHP-10-FNOTE-3">30</a>]</sup></p><p>Next, we need whatever <code class="literal">base</code> is, as pronounced in <code class="literal">lang</code>. We get that via <code class="literal">@@lang_of[lang][base]</code>. Finally, we need the rest of the number, which we get via <code class="literal">remaining.to_lang(lang)</code>. This keeps happening recursively, with a smaller Integer calling <code class="literal">to_lang</code> and appending its results, until <code class="literal">base</code> is <code class="literal">0</code>. Then <code class="literal">to_lang</code> returns the <code class="literal">EMPTY_STRING</code> due to its return guard, and the entire output is concatenated together within the first calling to <code class="literal">remaining.to_lang</code>.</p><p>That’s the Array. You’ll notice that <code class="literal">to_lang</code> joins that Array on a <code class="literal">SPACE</code>, so that the words in <code class="literal">raw_output</code> are separated by spaces, which is normal. Before we’re done, we want to call our special replacements method (whichever one is appropriate for <code class="literal">lang</code>) on <code class="literal">raw_output</code>, and <code class="literal">return</code> the result of doing that. Since we again have a method <a class="indexterm" id="idx-CHP-10-1051"/>name that depends on <code class="literal">lang</code>, we’ll use <code class="literal">send</code>.</p></div></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id035"/>The Results</h2></div></div></div><p>Let’s take it out for a spin. I’ve written a simple test <a class="indexterm" id="idx-CHP-10-1052"/>script called <code class="literal">test_lang.rb</code> that I stored inside the <code class="literal">tests</code> directory. It uses <code class="literal">Test::Unit::TestCase</code> again, in a manner similar to the way we tested the temperature converter in <a class="xref" href="ch07.html" title="Chapter 7. Using, Optimizing, and Testing Functional Techniques">Chapter 7</a>. Here’s its code:<a class="indexterm" id="idx-CHP-10-1053"/></p><a id="I_programlisting10_d1e18620"/><pre class="programlisting">#!/usr/bin/env ruby
# test_lang.rb

require 'to_lang'
require 'test/unit'

class Tester &lt; Test::Unit::TestCase

  def test_langs()

    tests = {
      'en' =&gt; {
        1     =&gt; 'one',
        5     =&gt; 'five',
        9     =&gt; 'nine',
        11    =&gt; 'eleven',
        51    =&gt; 'fifty one',
        100   =&gt; 'one hundred',
        101   =&gt; 'one hundred one',
        257   =&gt; 'two hundred fifty seven',
        1000  =&gt; 'one thousand',
        1001  =&gt; 'one thousand one',
        90125 =&gt; 'ninety thousand one hundred twenty five',
      },
      'es' =&gt; {
        1     =&gt; 'uno',
        5     =&gt; 'cinco',
        9     =&gt; 'nueve',
        11    =&gt; 'once',
        51    =&gt; 'cincuenta-uno',
        100   =&gt; 'uno ciento',
        101   =&gt; 'uno ciento uno',
        257   =&gt; 'dos ciento cincuenta-siete',
        1000  =&gt; 'uno mil',
        1001  =&gt; 'uno mil uno',
        90125 =&gt; 'noventa-mil uno ciento veinte cinco',
      }
    }
    %w[ en es ].each do |lang|
      general_tester( tests, lang )
    end
  end

  private

  def general_tester(tests, lang)
    tests[lang].each_key do |num|
      assert_equal( num.send("to_#{lang}"), tests[lang][num] )
    end
  end

end</pre><p>And here’s its output:</p><a id="I_programlisting10_d1e18624"/><pre class="programlisting">Loaded suite tests/test_lang
Started
.
Finished in 0.004543 seconds.

1 tests, 22 assertions, 0 failures, 0 errors</pre></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id027"/>Hacking the Script</h2></div></div></div><p>We could modify <code class="literal">to_lang</code> to allow the pronunciation of zero, instead of returning the <code class="literal">EMPTY_STRING</code> Constant. In order to do that and still work with the recursion, we’ll need to send another optional argument into <code class="literal">to_lang</code> that keeps track of the recursion <a class="indexterm" id="idx-CHP-10-1054"/>depth (how many levels of recursion we have performed). We only care about distinguishing between the first call to <code class="literal">to_lang</code> and the rest of the calls. We could then <code class="literal">return</code> the <code class="literal">EMPTY_STRING</code> if <code class="literal">self</code> is zero and it’s the first call to <code class="literal">to_lang</code>; we can skip the return guard in all other cases. We’d also need to change the value for <code class="literal">0</code> in both <code class="literal">dont_need_ones_in_english</code> and <code class="literal">dont_need_ones_in_spanish</code>.<a class="indexterm" id="idx-CHP-10-1055"/></p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-10-FNOTE-2" id="ftn.CHP-10-FNOTE-2">29</a>] </sup>Note that our definitions of <code class="literal">to_english</code> and <code class="literal">to_spanish</code> essentially curry <code class="literal">to_lang</code>, making new curried methods that are simpler to call (i.e., that take fewer arguments) by making assumptions, namely which language to convert into.<a class="indexterm" id="idx-CHP-10-1036"/><a class="indexterm" id="idx-CHP-10-1037"/><a class="indexterm" id="idx-CHP-10-1038"/></p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-10-FNOTE-3" id="ftn.CHP-10-FNOTE-3">30</a>] </sup>All of these specific examples assume English, of course. Substitute the Spanish terms when <code class="literal">lang</code> is <code class="literal">‘spanish’</code>.<a class="indexterm" id="idx-CHP-10-1050"/></p></div></div></div>
<div class="sect1" title="#40 Elegant Maps and Injects (symbol.rb)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp40_elegant_maps_and_injects_symbolr"/>#40 Elegant Maps and Injects (symbol.rb)</h1></div></div></div><p>I’ll close this chapter with a tiny script that I didn’t even write. I certainly wish I had, because it’s remarkably useful, especially for making your use of <code class="literal">map, inject</code>, and similar methods much more elegant. It’s an example of the best kind of syntactic sugar, and it comes directly from the <a class="indexterm" id="idx-CHP-10-1056"/>Ruby Extensions Project at <a class="ulink" href="http://extensions.rubyforge.org">http://extensions.rubyforge.org</a>. This script and all other scripts at that site are licensed under the same terms as Ruby itself, which is what allows me to use it in this chapter.<sup>[<a class="footnote" href="#ftn.CHP-10-FNOTE-4" id="CHP-10-FNOTE-4">31</a>]</sup> The code is extremely simple.</p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id039"/>The Code</h2></div></div></div><a id="I_programlisting10_d1e18706"/><pre class="programlisting">#!/usr/bin/env ruby    <em class="lineannotation"><span class="lineannotation"><strong class="userinput"><code>Symbol.to_<a class="indexterm" id="idx-CHP-10-1060"/>proc</code></strong></span></em>
class Symbol
  def to_proc()
    Proc.new { |obj, *args| obj.<a class="indexterm" id="idx-CHP-10-1061"/>send(self, *args) }
  end
end</pre><p>What’s the point of this? It lets you use <code class="literal">uc_words = lc_words.map(&amp;:upcase)</code> to accomplish the same thing as <code class="literal">uc_words = lc_words.map { |word| word.upcase }</code>. In both cases, the <code class="literal">uc_words</code> variable now contains uppercase versions of all the words in <code class="literal">lc_words</code>. As I said, it’s basically just syntactic sugar, but it’s very, very nice and clever.</p></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id038"/>How It Works</h2></div></div></div><p>First of all, this script creates a Proc using <code class="literal">Proc.new</code> that takes an object called <code class="literal">obj</code> and a variable number of <code class="literal">args</code>. Remember from <code class="literal">to_lang.rb</code> that <code class="literal">obj.send(methodname)</code> is the same as <code class="literal">obj.methodname</code>, so these are equivalent, with an Array <code class="literal">a</code>:</p><a id="I_programlisting10_d1e18763"/><pre class="programlisting">a.send(push, some_item)
a.push(some_item)</pre><p>The remaining arguments (represented by <code class="literal">*args</code>) are also passed along to <code class="literal">obj</code>, which is using <code class="literal">each</code> or <code class="literal">map</code> or some other iterating method.</p><p>Secondly, you may remember previous discussion about how to convert between Procs and blocks using the ampersand (<code class="literal">&amp;</code>), but we can also use the ampersand to cast more than blocks into Procs. Doing so calls a method called <code class="literal">to_proc</code>, which you can see we’ve overridden. We end up using a double character prefix of <code class="literal">&amp;:</code>, because a colon is already the prefix for a Symbol. When we use the expression <code class="literal">&amp;:some_name</code>, what we mean is <span class="emphasis"><em>the expression returned by the</em></span> <em class="replaceable"><code>to_proc</code></em> method of the Symbol named <em class="replaceable"><code>some_name</code></em>.</p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id036"/>The Results</h2></div></div></div><p>Let’s see it in action in irb.</p><a id="I_programlisting10_d1e18808"/><pre class="programlisting">irb -r symbol.rb
irb(main):001:0&gt; digits = (0..9).to_a
=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
irb(main):002:0&gt; digits.inject(&amp;:+)
=&gt; 45
irb(main):003:0&gt; digits.map(&amp;:inspect)
=&gt; ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"]
irb(main):004:0&gt; require 'to_lang'
=&gt; true
irb(main):005:0&gt; digits.map(&amp;:to_en)
=&gt; ["", "one", "two", "three", "four", "five", "six", "seven", "eight",
"nine"]</pre></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id028"/>Hacking the Script</h2></div></div></div><p>This script is already a very elegant hack. Note that you need to use <code class="literal">Proc.new</code> rather than <code class="literal">lambda</code>, because you want it to be able to handle a variable number of <code class="literal">args</code>.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-10-FNOTE-4" id="ftn.CHP-10-FNOTE-4">31</a>] </sup>Those terms are made explicit at <a class="ulink" href="http://www.ruby-lang.org/en/about/license.txt">http://www.ruby-lang.org/en/about/license.txt</a><a class="indexterm" id="idx-CHP-10-1057"/><a class="indexterm" id="idx-CHP-10-1058"/><a class="indexterm" id="idx-CHP-10-1059"/></p></div></div></div>
<div class="sect1" title="Chapter Recap"><div class="titlepage"><div><div><h1 class="title"><a id="chapter_recap-id008"/>Chapter Recap</h1></div></div></div><p>What was new in this chapter?</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Callbacks</p></li><li class="listitem"><p>CVS</p></li><li class="listitem"><p>Mixins in action</p></li><li class="listitem"><p>Calling methods with variable names via <code class="literal">send</code></p></li><li class="listitem"><p>Syntactic sugar</p></li><li class="listitem"><p><code class="literal">Symbol.to_proc</code></p></li></ul></div><p>That’s it for this chapter. It tended to focus less on completely new concepts and more on new applications for familiar things, but it still managed to introduce more than a few novel ideas. The next chapter focuses on web programming, a venue in which Ruby has become quite popular.<a class="indexterm" id="I_indexterm10_d1e18853"/></p></div></body></html>