<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;PERL, FLOWSCAN, AND CFLOW.PM"><div class="titlepage"><div><div><h1 class="title"><a id="perl_comma_flowscan_comma_and_cflow.pm"/>Chapter 6. PERL, FLOWSCAN, AND CFLOW.PM</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e9438"/><img alt="image with no caption" src="httpatomoreillycomsourcenostarchimages651574.png.jpg"/></div></div><p>Welcome to the most troublesome part of a flow-tools implementation: the Perl module. Perl is popular for quickly creating reporting tools and web interfaces. One of the most user-friendly flow-reporting tools, FlowScan, is built on Perl, but unfortunately, the Perl module for working with flow files, <span class="emphasis"><em>Cflow.pm</em></span>, is difficult to install correctly. This isn't because of Perl but because flow collectors all have different on-disk storage formats. Your <span class="emphasis"><em>Cflow.pm</em></span> installation must know how to read flow-tools flow files.<a class="indexterm" id="IDX-CHP-6-0001"/><a class="indexterm" id="IDX-CHP-6-0002"/><a class="indexterm" id="IDX-CHP-6-0003"/><a class="indexterm" id="IDX-CHP-6-0004"/></p><p><span class="emphasis"><em>Cflow.pm</em></span> is named after the obsolete flow collector cflowd. When the cflowd project shut down, cflowd's authors recommended migrating to flow-tools. <span class="emphasis"><em>Cflow.pm</em></span> was modified to include optional support for flow-tools. Many mailing list archive messages and lots of documentation refer to cflowd and <span class="emphasis"><em>Cflow.pm</em></span> and don't necessarily differentiate between the two. You need <span class="emphasis"><em>Cflow.pm</em></span>, not cflowd.<a class="indexterm" id="IDX-CHP-6-0005"/></p><div class="sect1" title="Installing Cflow.pm"><div class="titlepage"><div><div><h1 class="title"><a id="installing_cflow.pm"/>Installing Cflow.pm</h1></div></div></div><p>Historically, correctly installing <span class="emphasis"><em>Cflow.pm</em></span> has been the most difficult and annoying part of any flow analysis implementation. Internet searches will uncover all sorts of articles and mailing list archives discussing <span class="emphasis"><em>Cflow.pm</em></span> installation issues, including a series of articles by this author. The new flow-tools release has a specific process for installing <span class="emphasis"><em>Cflow.pm</em></span>. Use the recommended process, and test your <span class="emphasis"><em>Cflow.pm</em></span> immediately after installation. Do not proceed if your <span class="emphasis"><em>Cflow.pm</em></span> install does not give sensible results.</p><div class="sect2" title="Testing Cflow.pm"><div class="titlepage"><div><div><h2 class="title"><a id="testing_cflow.pm"/>Testing Cflow.pm</h2></div></div></div><p>The <span class="emphasis"><em>Cflow.pm</em></span> kit includes a command-line tool for accessing flow files, <code class="literal">flowdumper</code>. It's not as powerful or as flexible as the tools included in flow-tools, but it does test <span class="emphasis"><em>Cflow.pm</em></span>. If <code class="literal">flowdumper</code> prints the contents of your flow files correctly, your <span class="emphasis"><em>Cflow.pm</em></span> install is working. Just run <strong class="userinput"><code>flowdumper -s</code></strong>, and give it the name of a flow file.<a class="indexterm" id="IDX-CHP-6-0006"/><a class="indexterm" id="IDX-CHP-6-0007"/><a class="indexterm" id="IDX-CHP-6-0008"/></p><a id="I_programlisting6_d1e9536"/><pre class="programlisting"># <strong class="userinput"><code>flowdumper -s ft-v05.2011-12-14*</code></strong>
2011/12/16 23:59:42 69.134.229.81.51459 -&gt; 192.0.2.37.443 6(PUSH|ACK) 1 81
2011/12/16 23:59:43 192.0.2.4.10690 -&gt; 198.6.1.1.53 17 1 81
2011/12/16 23:59:43 192.0.2.37.443 -&gt; 69.134.229.81.51459 6(ACK) 1 40
...</pre><p>The <code class="literal">-s</code> tells <code class="literal">flowdumper</code> to print a summary of each flow on one line. Each line represents a flow. You'll see the source and destination addresses and ports, the protocol number, the TCP flags, the number of packets, and the number of octets.</p><p>If your <span class="emphasis"><em>Cflow.pm</em></span> install is faulty, <code class="literal">flowdumper</code> returns either silently or with an error. You cannot proceed with Perl modules or FlowScan until you resolve any error.</p><div class="sidebar"><a id="failure_lurks_here"/><p class="title">FAILURE LURKS HERE</p><p>Correct <span class="emphasis"><em>Cflow.pm</em></span> installation seems to be the single most common reason flow management projects fail. Test <span class="emphasis"><em>Cflow.pm</em></span> immediately upon installation. Do not proceed with any software that uses <span class="emphasis"><em>Cflow.pm</em></span> until <code class="literal">flowdumper</code> gives correct answers. You have been warned.</p></div></div><div class="sect2" title="Install from Operating System Package"><div class="titlepage"><div><div><h2 class="title"><a id="install_from_operating_system_package"/>Install from Operating System Package</h2></div></div></div><p>Some operating system vendors include <span class="emphasis"><em>Cflow.pm</em></span> packages that may include flow-tools support. Install the package, and test <code class="literal">flowdumper</code>. If it doesn't work, uninstall the package before proceeding.</p></div><div class="sect2" title="Install from Source"><div class="titlepage"><div><div><h2 class="title"><a id="install_from_source"/>Install from Source</h2></div></div></div><p>Get the <span class="emphasis"><em>Cflow.pm</em></span> source code, <span class="emphasis"><em>Cflow-1.053.tar.gz</em></span>, from <a class="ulink" href="http://net.doit.wisc.edu/~plonka/Cflow/">http://net.doit.wisc.edu/~plonka/Cflow/</a> and extract it. Do not follow the building instructions included with the <span class="emphasis"><em>Cflow.pm</em></span> source, however. Flow-tools has changed since Cflow.pm was released, and to build it use the instructions in flow-tools' <span class="emphasis"><em>contrib/README</em></span> file.<a class="indexterm" id="IDX-CHP-6-0009"/><a class="indexterm" id="IDX-CHP-6-0010"/><a class="indexterm" id="IDX-CHP-6-0011"/></p><p>Go into the extracted <span class="emphasis"><em>Cflow.pm</em></span> source and run</p><a id="I_programlisting6_d1e9621"/><pre class="programlisting"># <strong class="userinput"><code>perl Makefile.PL CCFLAGS='-DOSU' LIBS='-lft'</code></strong>
# <strong class="userinput"><code>make</code></strong>
# <strong class="userinput"><code>make install</code></strong></pre><p>Test <code class="literal">flowdumper</code> right now. If it doesn't work, proceed to the next section.<a class="indexterm" id="IDX-CHP-6-0012"/></p></div><div class="sect2" title="Installing from Source with a Big Hammer"><div class="titlepage"><div><div><h2 class="title"><a id="installing_from_source_with_a_big_hammer"/>Installing from Source with a Big Hammer</h2></div></div></div><p>If your installation from default source fails, this should work. (Unix and Perl purists will scream in moral outrage, and they're welcome to fix the real problem.)</p><p>In the <span class="emphasis"><em>Cflow-1.053</em></span> source directory, open <span class="emphasis"><em>Makefile.PL</em></span> in a text editor. Find this section of code:</p><a id="I_programlisting6_d1e9652"/><pre class="programlisting">sub find_flow_tools {
   my($ver, $dir);
   my($libdir, $incdir);
❶  if (-f '../../lib/libft.a') {
   ...</pre><p>The ❶ reference to <span class="emphasis"><em>libft.a</em></span> is the source of all the trouble. If all else fails, hard-code the path to <span class="emphasis"><em>libft.a</em></span>. My test system has <span class="emphasis"><em>/usr/local/lib/libft.a</em></span>, so I would change this source code to read as follows:</p><a id="I_programlisting6_d1e9665"/><pre class="programlisting">if (-f '/usr/local/lib/libft.a') {</pre><p>Then build and install <span class="emphasis"><em>Cflow.pm</em></span> as shown in the earlier <a class="xref" href="ch06.html#install_from_source" title="Install from Source">Install from Source</a> section. <code class="literal">flowdumper</code> will now show data.</p><p>If none of these methods work for you, contact the flow-tools mailing list with a full description of your problem, including output from the failed builds.</p></div></div></div>
<div class="sect1" title="flowdumper and Full Flow Information"><div class="titlepage"><div><div><h1 class="title"><a id="flowdumper_and_full_flow_information"/>flowdumper and Full Flow Information</h1></div></div></div><p>Although <code class="literal">flowdumper</code> is generally less useful than <code class="literal">flow-print</code>, it has some unique features. You've already used the summary feature (<code class="literal">-s</code>) to test <span class="emphasis"><em>Cflow.pm</em></span>. (<code class="literal">flowdumper</code> can also accept Perl instructions on the command line, but if you're sufficiently skilled in Perl to do that, you can read the <code class="literal">flowdumper</code> manual page.)</p><p>If you don't use the summary feature, <code class="literal">flowdumper</code> prints all the information the flow file includes for every flow.</p><a id="I_programlisting6_d1e9708"/><pre class="programlisting"># <strong class="userinput"><code>flowdumper ft-*</code></strong>
 FLOW
     index:          0xc7ffff
❶    router:         192.0.2.12
❷    src IP:         158.43.128.72
     dst IP:         192.0.2.37
     input ifIndex:  9
     output ifIndex: 1
     src port:       53
     dst port:       34095
     pkts:           1
     bytes:          130
❸    IP nexthop:     192.0.2.37
     start time:     Sat Dec 31 23:54:42 2011
     end time:       Sat Dec 31 23:54:42 2011
     protocol:       17
     tos:            0x0
❹    src AS:         702
     dst AS:         0
     src masklen:    16
     dst masklen:    25
     TCP flags:      0x0
     engine type:    0
     engine id:      0
 ...</pre><p>You've seen most of this flow information previously, but the interesting thing here is that <code class="literal">flowdumper</code> shows everything in the flow record, including data fields that are irrelevant in most environments. You'll see the sensor address (❶), the source and destination addresses (❷), and so on. You'll also see that the sensor is exporting information such as next-hop data (❸), BGP routing data (❹), and such. Although you usually wouldn't want to try to use complete <code class="literal">flowdumper</code> output for day-to-day management, it lets you verify that your system is collecting all the data you think it should. A more useful system for day-to-day reporting, however, is FlowScan.<a class="indexterm" id="IDX-CHP-6-0013"/><a class="indexterm" id="IDX-CHP-6-0014"/></p></div>
<div class="sect1" title="FlowScan and CUFlow"><div class="titlepage"><div><div><h1 class="title"><a id="flowscan_and_cuflow"/>FlowScan and CUFlow</h1></div></div></div><p>Although the text-based flow reports demonstrated in <a class="xref" href="ch05.html" title="Chapter 5. REPORTING AND FOLLOW-UP ANALYSIS">Chapter 5</a> are clearly useful, even nontechnical people easily understand visual representations of traffic. <a class="xref" href="ch07.html" title="Chapter 7. FLOWVIEWER">Chapter 7</a> and <a class="xref" href="ch08.html" title="Chapter 8. AD HOC FLOW VISUALIZATION">Chapter 8</a> demonstrate graphing arbitrary data, but much of the time graphing nonarbitrary data is sufficient. Every network administrator already has a pretty good idea of what constitutes the most common traffic on their network. For example, if you run a web farm, you probably care more about HTTP and HTTPS traffic than you do that of other services. If you manage an office network, you might care a lot about CIFS and printer traffic. Much of the time you can get adequate results by graphing the stuff you know about and lumping what you don't know about into an "other" category. That's what FlowScan is for.</p><p>FlowScan is an engine for extracting and aggregating flow data. It provides a web interface that displays graphs depicting network traffic that the network administrator previously deemed interesting. These graphs are suitable for display to users, staff, and customers who would be confused by the more detailed flow reports.<a class="indexterm" id="IDX-CHP-6-0015"/><a class="indexterm" id="IDX-CHP-6-0016"/><a class="indexterm" id="IDX-CHP-6-0017"/></p><p>FlowScan is built on <span class="emphasis"><em>Cflow.pm</em></span> and uses the Round Robin Database (RRD), just like MRTG and Cacti. RRD is a fixed-size database that retains data over the long term by compressing and averaging older entries. In other words, RRD gives a pretty good view of recent traffic, a decent view of traffic a few months past, and only a high-level view of last year's traffic. This suffices more often than you'd think, however. Most users want to know why the Internet was slow for the last hour or perhaps how today's traffic compares to last year's traffic. FlowScan will answer these questions, though it cannot explain exactly why the Internet was slow on the afternoon of October 3 a year ago.<a class="indexterm" id="IDX-CHP-6-0018"/></p><p>FlowScan's modular framework lets network administrators choose from a variety of reporting methods. Of those, I'll cover the popular CUFlow module.</p></div>
<div class="sect1" title="FlowScan Prerequisites"><div class="titlepage"><div><div><h1 class="title"><a id="flowscan_prerequisites"/>FlowScan Prerequisites</h1></div></div></div><p>FlowScan has the following requirements:<a class="indexterm" id="IDX-CHP-6-0019"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Web server, such as any recent version of Apache</p></li><li class="listitem"><p>Perl</p></li><li class="listitem"><p>Korn shell or pdksh (<a class="ulink" href="http://www.cs.mun.ca/~michael/pdksh/">http://www.cs.mun.ca/~michael/pdksh/</a>)</p></li><li class="listitem"><p>RRDtool (<a class="ulink" href="http://oss.oetiker.ch/rrdtool/">http://oss.oetiker.ch/rrdtool/</a>) with Perl shared module support</p></li><li class="listitem"><p>The Boulder::Stream Perl module</p></li><li class="listitem"><p>The ConfigReader::DirectiveStyle Perl module</p></li><li class="listitem"><p>The HTML::Table Perl module</p></li><li class="listitem"><p>The Net::Patricia Perl module</p></li><li class="listitem"><p><span class="emphasis"><em>Cflow.pm</em></span></p></li></ul></div><p>You can install most of these from operating system packages. Although the FlowScan documentation includes warnings about installing the RRDtool Perl module <code class="literal">RRDs.pm</code>, RRDTool has included this module for some time now.<a class="indexterm" id="IDX-CHP-6-0020"/><a class="indexterm" id="IDX-CHP-6-0021"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>Be sure to test your <span class="emphasis"><em>Cflow.pm</em></span> install before starting on FlowScan.</p></div></div>
<div class="sect1" title="Installing FlowScan and CUFlow"><div class="titlepage"><div><div><h1 class="title"><a id="installing_flowscan_and_cuflow"/>Installing FlowScan and CUFlow</h1></div></div></div><p>FlowScan was originally written to work with the obsolete cflowd collector. If you install FlowScan from an operating system package, the package will probably want to install cflowd and its obsolete compiler libraries, as well as other clutter as dependencies. Other times, the operating system providers have edited the FlowScan software to make the most common use case easier but more unusual uses much more difficult. For these reasons, I recommend installing FlowScan by hand. To do so, follow these steps:<a class="indexterm" id="IDX-CHP-6-0022"/><a class="indexterm" id="IDX-CHP-6-0023"/></p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Download FlowScan from its author's website at <a class="ulink" href="http://net.doit.wisc.edu/~plonka/FlowScan/">http://net.doit.wisc.edu/~plonka/FlowScan/</a>.</p></li><li class="listitem"><p>Download a copy of version 1.6 or newer of the FlowScan Perl module from <a class="ulink" href="http://net.doit.wisc.edu/~plonka/list/flowscan/archive/att-0848/01-FlowScan.pm">http://net.doit.wisc.edu/~plonka/list/flowscan/archive/att-0848/01-FlowScan.pm</a> or by searching Google for <span class="emphasis"><em>flowscan.pm 1.6</em></span>. (You can also check the Links section of this book's website.)</p></li><li class="listitem"><p>Extract the FlowScan tarball, and go into the build directory.</p></li><li class="listitem"><p>The FlowScan author recommends installing FlowScan in the directory where you keep your flow files. Use this directory as the <code class="literal">prefix</code> in the <code class="literal">configure</code> command. (If you do not choose a location, FlowScan will install directories, configuration files, and Perl modules in <code class="literal">/usr/local/bin</code>, which is less than desirable.)</p><a id="I_programlisting6_d1e9869"/><pre class="programlisting"># <strong class="userinput"><code>cd FlowScan-1.006</code></strong>
# <strong class="userinput"><code>./configure --prefix=/var/db/flows/test</code></strong>
# <strong class="userinput"><code>make install</code></strong></pre><p>The directory <span class="emphasis"><em>/var/db/flows/test/bin</em></span> should now contain your FlowScan software.</p></li><li class="listitem"><p>You'll also need FlowScan's tiny configuration file, <span class="emphasis"><em>flowscan.cf</em></span>, which isn't automatically installed. It's in the unpacked FlowScan source in the <span class="emphasis"><em>cf</em></span> directory. Copy this template to the FlowScan <span class="emphasis"><em>bin</em></span> directory.</p></li><li class="listitem"><p>Finally, upgrade the existing <span class="emphasis"><em>FlowScan.pm</em></span> file. Version 1.5, which ships with FlowScan, supports cflowd only, but version 1.6 and newer can read <code class="literal">flow-capture</code> files. Copy version 1.6 right over <span class="emphasis"><em>bin/FlowScan.pm</em></span>.</p></li></ol></div><div class="sect2" title="FlowScan User, Group, and Data Directories"><div class="titlepage"><div><div><h2 class="title"><a id="flowscan_user_comma_group_comma_and_data"/>FlowScan User, Group, and Data Directories</h2></div></div></div><p>With FlowScan installed, create a user called <span class="emphasis"><em>flowscan</em></span> just for FlowScan, and give that user ownership of the FlowScan <span class="emphasis"><em>bin</em></span> directory. Also give the group permissions on the directory so that network administrators can edit FlowScan configuration files without have to enter the root password.<a class="indexterm" id="IDX-CHP-6-0024"/><a class="indexterm" id="IDX-CHP-6-0025"/></p><p>FlowScan needs two directories at the same level as the <span class="emphasis"><em>bin</em></span> directory: one, called <span class="emphasis"><em>flowscandata</em></span>, for incoming flow data files, and the other, <span class="emphasis"><em>flowscanrrd</em></span>, for flow RRD records. Set the sticky bit on these directories so that incoming files are owned by the flowscan user as follows:</p><a id="I_programlisting6_d1e9940"/><pre class="programlisting"># <strong class="userinput"><code>chown -R flowscan:flowscan bin</code></strong>
# <strong class="userinput"><code>chmod g+w bin</code></strong>
# <strong class="userinput"><code>chmod g+ws flowscandata</code></strong>
# <strong class="userinput"><code>chown flowscan:flowscan flowscandata flowscanrrd</code></strong>
# <strong class="userinput"><code>chmod g+ws flowscandata/ flowscanrrd/</code></strong></pre><p>Now add your network administrators to the <code class="literal">flowscan</code> group so that they can configure FlowScan without the need for root access.<a class="indexterm" id="IDX-CHP-6-0026"/><a class="indexterm" id="IDX-CHP-6-0027"/><a class="indexterm" id="IDX-CHP-6-0028"/><a class="indexterm" id="IDX-CHP-6-0029"/><a class="indexterm" id="IDX-CHP-6-0030"/><a class="indexterm" id="IDX-CHP-6-0031"/><a class="indexterm" id="IDX-CHP-6-0032"/><a class="indexterm" id="IDX-CHP-6-0033"/></p></div><div class="sect2" title="FlowScan Startup Script"><div class="titlepage"><div><div><h2 class="title"><a id="flowscan_startup_script"/>FlowScan Startup Script</h2></div></div></div><p>Your operating system might include its own startup scripts for FlowScan. If so, check the script's instructions to learn how to configure it. If not, FlowScan includes startup scripts for Linux and Solaris in the <span class="emphasis"><em>rc</em></span> directory. In this section, I'll show how to configure the Linux script. (The Solaris script is very similar, and these scripts should work with minor modifications on any modern operating system.) The top of the file includes four variables that you'll need to set.<a class="indexterm" id="IDX-CHP-6-0034"/><a class="indexterm" id="IDX-CHP-6-0035"/></p><a id="I_programlisting6_d1e10007"/><pre class="programlisting">❶ bindir=/var/db/flows/test/bin
❷ scandir=/var/db/flows/flowscandata
❸ logfile=/var/log/flowscan.log
❹ user=flowscan</pre><p>The <span class="emphasis"><em>bindir</em></span> directory (❶) contains the FlowScan files and <span class="emphasis"><em>flowscan.cf</em></span>.</p><p>The <span class="emphasis"><em>scandir</em></span> directory (❷) is where FlowScan checks for new data files.</p><p>Put the <span class="emphasis"><em>logfile</em></span> directory (❸) anywhere you like. I prefer to have all my logs in <span class="emphasis"><em>/var/log</em></span>. You must <code class="literal">touch</code> the logfile before running FlowScan and give the flowscan user permission to change the file,</p><p>Finally, tell FlowScan what user (❹) will run flowscan.</p><p>The second section of this file contains paths to a variety of standard commands. These should be correct for most Unix-like systems, but if you have trouble, verify each separately.</p><p>Once you've made your changes, have your system startup script run the FlowScan startup script as an argument to <code class="literal">/bin/sh</code>. (Depending on your system startup process, you might have to add the line <code class="literal">#!/bin/sh</code> to the top of the script.)</p></div><div class="sect2" title="Configuring FlowScan"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_flowscan"/>Configuring FlowScan</h2></div></div></div><p>The <span class="emphasis"><em>flowscan.cf</em></span> file has only four configuration values: <code class="literal">FlowFileGlob</code>, <code class="literal">ReportClasses</code>, <code class="literal">WaitSeconds</code>, and <code class="literal">Verbose</code>.</p><p><code class="literal">FlowFileGlob</code> tells FlowScan which files to process. Use it to tell FlowScan the directory to examine and the type of file to try to process. Here, I'm examining any <code class="literal">flow-capture</code> files in the directory <span class="emphasis"><em>/var/db/flows/test/flowscandata</em></span>:</p><a id="I_programlisting6_d1e10075"/><pre class="programlisting">FlowFileGlob /var/db/flows/test/flowscandata/ft-v*[0-9]</pre><p><code class="literal">ReportClasses</code> lists all the report modules you're using. FlowScan comes with two modules, CampusIO and SubNetIO. These are not very configurable and do not really represent modern traffic patterns, so you'll use CUFlow.</p><a id="I_programlisting6_d1e10081"/><pre class="programlisting">ReportClasses CUFlow</pre><p>Now you tell FlowScan how often to check the directory for files. The CUFlow module assumes that FlowScan runs every five minutes. Don't change this; just use the default.<a class="indexterm" id="IDX-CHP-6-0036"/><a class="indexterm" id="IDX-CHP-6-0037"/><a class="indexterm" id="IDX-CHP-6-0038"/><a class="indexterm" id="IDX-CHP-6-0039"/><a class="indexterm" id="IDX-CHP-6-0040"/><a class="indexterm" id="IDX-CHP-6-0041"/><a class="indexterm" id="IDX-CHP-6-0042"/><a class="indexterm" id="IDX-CHP-6-0043"/><a class="indexterm" id="IDX-CHP-6-0044"/></p><a id="I_programlisting6_d1e10122"/><pre class="programlisting">WaitSeconds 300</pre><p>Finally, verbose logging can help during setup. Set this to 0 once you have FlowScan running. For now, set it to 1.</p><a id="I_programlisting6_d1e10126"/><pre class="programlisting">Verbose 1</pre><p>You've finished configuring FlowScan, but it won't do anything until you set up a reporting module. Let's set up CUFlow and then return to FlowScan.<a class="indexterm" id="IDX-CHP-6-0045"/></p></div><div class="sect2" title="Configuring CUFlow: CUFlow.cf"><div class="titlepage"><div><div><h2 class="title"><a id="configuring_cuflow_colon_cuflow.cf"/>Configuring CUFlow: CUFlow.cf</h2></div></div></div><p>CUFlow is more configurable than FlowScan's default modules, but it assumes that all traffic it processes is either entering or leaving your network. This makes FlowScan suitable for use on border routers, site MPLS routers, and so on, but not as useful for monitoring traffic that begins and terminates on your network. Transit carriers will have limited use for CUFlow, but even a big ISP has some local networks.</p><p>To install CUFlow, download it from <a class="ulink" href="http://www.columbia.edu/acis/networks/advanced/CUFlow/CUFlow.html">http://www.columbia.edu/acis/networks/advanced/CUFlow/CUFlow.html</a>, and then extract and copy the files <span class="emphasis"><em>CUFlow.cf</em></span> and <span class="emphasis"><em>CUFLow.pm</em></span> to your FlowScan <span class="emphasis"><em>bin</em></span> directory.</p><p><span class="emphasis"><em>CUFlow.cf</em></span> includes a variety of statements to tell FlowScan what data to look for and how to process it. Edit these to match your network, as follows.</p><div class="sect3" title="Subnet"><div class="titlepage"><div><div><h3 class="title"><a id="subnet"/>Subnet</h3></div></div></div><p>The <code class="literal">Subnet</code> statement tells CUFlow the addresses on your local network. CUFlow uses this to determine whether traffic is inbound or outbound. Flows with a source on this network are considered outbound, while flows with a destination on this network are inbound.</p><a id="I_programlisting6_d1e10165"/><pre class="programlisting">Subnet 192.0.2.0/24</pre><p>You can have multiple <code class="literal">Subnet</code> statements, as needed.</p></div><div class="sect3" title="Network"><div class="titlepage"><div><div><h3 class="title"><a id="network"/>Network</h3></div></div></div><p><code class="literal">Network</code> statements include hosts and ranges that you want to track separately. You can have any number of <code class="literal">Network</code> statements, and one address can appear in multiple <code class="literal">Network</code> statements. List either individual hosts or networks with a slash to indicate netmask. Be sure to give each network a one-word name.</p><a id="I_programlisting6_d1e10185"/><pre class="programlisting">Network 192.0.2.4                proxy
Network 192.0.2.128/26           dmz
Network 192.0.2.36,192.0.2.37    mailservers</pre></div><div class="sect3" title="OutputDir"><div class="titlepage"><div><div><h3 class="title"><a id="outputdir"/>OutputDir</h3></div></div></div><p>The <code class="literal">OutputDir</code> directive tells CUFlow where to store its RRD data files. Do not store your records in a web-accessible location or in your <code class="literal">flow-capture</code> log directory. Instead, store them in the <span class="emphasis"><em>flowscanrrd</em></span> directory next to the <span class="emphasis"><em>bin</em></span> directory that you created for these records.<a class="indexterm" id="IDX-CHP-6-0046"/><a class="indexterm" id="IDX-CHP-6-0047"/><a class="indexterm" id="IDX-CHP-6-0048"/><a class="indexterm" id="IDX-CHP-6-0049"/><a class="indexterm" id="IDX-CHP-6-0050"/><a class="indexterm" id="IDX-CHP-6-0051"/></p><a id="I_programlisting6_d1e10235"/><pre class="programlisting">OutputDir /var/db/flows/test/flowscanrrd</pre><p>Each FlowScan module must have its own output directory. If you choose to run multiple FlowScan modules, create additional RRD directories as necessary.</p></div><div class="sect3" title="Scoreboard"><div class="titlepage"><div><div><h3 class="title"><a id="scoreboard"/>Scoreboard</h3></div></div></div><p>CUFlow can also compute the most active sites within a flow file and present a scoreboard of the host addresses that have passed the greatest number of flows, octets, and packets. The <code class="literal">Scoreboard</code> option takes three arguments: the number of addresses in your "most active" list, a directory to store those lists in, and the filename of the most current list, as shown here:</p><a id="I_programlisting6_d1e10247"/><pre class="programlisting">Scoreboard ❶ 10 ❷ /var/www/flowscan/topten ❸ /var/www/flowscan/topten/topten.html</pre><p>Here the scoreboard computes the top 10 hosts (❶), storing the old data in the directory <span class="emphasis"><em>/var/www/flowscan/topten/</em></span> (❷), and puts the most recent data in the file <span class="emphasis"><em>/var/www/flowscan/topten/topten.html</em></span> (❸). You must create the <span class="emphasis"><em>Scoreboard</em></span> directory, give your flowscan user ownership of the directory, and configure your web server to permit access to the current and historical pages.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Do not put your scoreboard files in the same directory as your flow files. Your flow files should be nowhere near files served by a web server.</p></div></div><div class="sect3" title="AggregateScore"><div class="titlepage"><div><div><h3 class="title"><a id="aggregatescore"/>AggregateScore</h3></div></div></div><p>CUFlow can also track the most active hosts over time using <code class="literal">AggregateScore</code>. Configure the <code class="literal">AggregateScore</code> option much the same as the <code class="literal">Scoreboard</code> option with the number of hosts to present, a file to store long-term totals, and a web page for the results, as shown here. (Be sure to put the aggregated data file someplace inaccessible to your web server, such as your RRD data directory.)</p><a id="I_programlisting6_d1e10277"/><pre class="programlisting">AggregateScore ❶ 10 ❷ /var/db/flows/test/
flowscanrrd/agg.dat ❸ /var/www/flowscan/overall.html</pre><p>Here I'm presenting the top 10 busiest hosts (❶) in the flow history, storing the long-term data in the directory <span class="emphasis"><em>/var/db/flows/test/flowscanrrd/agg.dat</em></span> (❷), and presenting an HTML page of the top 10 in <span class="emphasis"><em>/var/www/flowscan/overall.html</em></span> (❸).</p><p>Again, you must create the directories beforehand, and FlowScan must have permission to write files in them.</p></div><div class="sect3" title="Router"><div class="titlepage"><div><div><h3 class="title"><a id="router"/>Router</h3></div></div></div><p>If you have multiple flow sensors sending data to the same collector (such as two routers in a BGP/HSRP cluster), identify different sensors with <code class="literal">Router</code> statements as shown here. CUFlow can separate data from different sensors so that you can see how much traffic each handles.<a class="indexterm" id="IDX-CHP-6-0052"/><a class="indexterm" id="IDX-CHP-6-0053"/><a class="indexterm" id="IDX-CHP-6-0054"/><a class="indexterm" id="IDX-CHP-6-0055"/><a class="indexterm" id="IDX-CHP-6-0056"/><a class="indexterm" id="IDX-CHP-6-0057"/><a class="indexterm" id="IDX-CHP-6-0058"/></p><a id="I_programlisting6_d1e10332"/><pre class="programlisting">Router 192.0.2.2    rocky
Router 192.0.2.3    bullwinkle</pre><p>Here you identify each router by IP address and give it a human-friendly name. The friendly name will appear in the web interface.</p></div><div class="sect3" title="Service"><div class="titlepage"><div><div><h3 class="title"><a id="service"/>Service</h3></div></div></div><p><code class="literal">Service</code> statements define TCP/IP ports that you want to track separately. CUFlow will generate a separate RRD file for each port or set of ports tracked by a <code class="literal">Service</code> statement, with each appearing in a separate color in the web interface.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Increasing the number of <code class="literal">Service</code> statements increases the processing power and disk I/O CUFlow consumes, so don't just copy <span class="emphasis"><em>/etc/services</em></span> here!</p></div><p><code class="literal">CUFlow.cf</code> includes some examples that you can edit to fit your needs. For example, users on my network are not allowed to use Gnutella or eDonkey, so I comment them out of the file. Here are some example <code class="literal">Service</code> statements:</p><a id="I_programlisting6_d1e10362"/><pre class="programlisting">Service 20-21/tcp ftp
Service 22/tcp ssh
Service 53/udp,53/tcp dns</pre><p>The first <code class="literal">Service</code> statement, FTP, uses two TCP ports. The second is much simpler and uses only a single TCP port. The third runs on both TCP and UDP.</p><p>If you're not sure which ports to track, run some command-line reports to identify the most heavily used ports on your network.</p></div><div class="sect3" title="Protocol"><div class="titlepage"><div><div><h3 class="title"><a id="protocol"/>Protocol</h3></div></div></div><p>The <code class="literal">Protocol</code> statement is very similar to <code class="literal">Service</code>, except for Layer 3 instead of Layer 4.</p><a id="I_programlisting6_d1e10383"/><pre class="programlisting">Protocol 1 icmp
Protocol 6 tcp
Protocol 17 udp</pre><p>If you have IPSec VPNs, you might want to track protocols 50-51 (ESP and AH). PPTP users are probably interested in protocol 47 (GRE).</p></div><div class="sect3" title="AS"><div class="titlepage"><div><div><h3 class="title"><a id="as"/>AS</h3></div></div></div><p>BGP-based sites might be interested in tracking traffic to or from particular networks by AS number. Again, each AS entry here takes processing time. Don't just dump the complete list of AS assignments here!<a class="indexterm" id="IDX-CHP-6-0059"/><a class="indexterm" id="IDX-CHP-6-0060"/><a class="indexterm" id="IDX-CHP-6-0061"/><a class="indexterm" id="IDX-CHP-6-0062"/></p><a id="I_programlisting6_d1e10414"/><pre class="programlisting">AS 7853,13385,36377,16748,33542,36196,14668    Comcast
AS 65535                                       Lucas
AS 701-705                                     UUnetLegacy</pre><p>Software flow sensors such as <code class="literal">softflowd</code> do not export BGP information, so don't bother with AS analysis when using a software sensor.</p><p>Now that you've configured CUFlow, let's get some data to it.</p></div></div><div class="sect2" title="Rotation Programs and flow-capture"><div class="titlepage"><div><div><h2 class="title"><a id="rotation_programs_and_flow-capture"/>Rotation Programs and flow-capture</h2></div></div></div><p>FlowScan checks a single directory for flow files: <span class="emphasis"><em>/var/db/flows/flowscandata</em></span>. If FlowScan doesn't find any files, it goes back to sleep for five minutes. This <code class="literal">flow-capture</code> system logs data to files stored in a directory hierarchy. For example, the files for February 17, 2011, are stored in the directory <span class="emphasis"><em>/var/db/flows/test/2011/2011-02/2011-02-17</em></span>. How can you get these files into your <span class="emphasis"><em>/var/db/flows/flowscandata</em></span> directory? You can use a <code class="literal">flow-capture</code> log rotation script.<a class="indexterm" id="IDX-CHP-6-0063"/></p><p><code class="literal">flow-capture</code>'s <code class="literal">-R</code> option runs a script when a flow file is closed and a new temp file created. For example, to run the script <code class="literal">/usr/local/bin/flow-rotate.sh</code> on each new logfile, you would run <code class="literal">flow-capture</code> as follows:</p><a id="I_programlisting6_d1e10462"/><pre class="programlisting"># <strong class="userinput"><code>flow-capture -p /var/run/flow-capture.pid -R /usr/local/bin/flow-rotate.sh -n 287 \</code></strong>
<strong class="userinput"><code>-w /var/db/flows -S 5 10.10.10.10/172.16.16.16/5678</code></strong></pre><p><code class="literal">flow-capture</code> gives the rotation program one argument: the name of the closed logfile relative to the flow directory. For example, as I write this, the <code class="literal">flow-capture</code> in my test lab is writing to the file <span class="emphasis"><em>tmp-v05.2011-02-17.152001-0500</em></span> in today's directory. At 3:25 <span class="keycap"><strong>pm</strong></span>, <code class="literal">flow-capture</code> will close this temporary file, rename it <span class="emphasis"><em>ft-v05.2011-02-17.152001-0500</em></span>, and create a new <span class="emphasis"><em>tmp-</em></span> file. At this point, <code class="literal">flow-capture</code> will run any script specified by <code class="literal">-R</code> with the path to the current file. It's as if you ran this command on every logfile as soon as it was closed.</p><a id="I_programlisting6_d1e10498"/><pre class="programlisting"># <strong class="userinput"><code>flow-rotate.sh  2011/2011-02/2011-02-17/ft-v05.2011-02-17.152001-0500</code></strong></pre><p>Your script needs to take this name and perform any necessary post-processing on the flow data file. First, you want to copy the flow file to your data directory. Start with the following shell script:</p><a id="I_programlisting6_d1e10504"/><pre class="programlisting">#!/bin/sh

cp $1 /var/db/flows/test/flowscandata/</pre><p>Second, once you have the filename, copying the file to the <span class="emphasis"><em>flowscan</em></span> data directory is simple.<a class="indexterm" id="IDX-CHP-6-0064"/><a class="indexterm" id="IDX-CHP-6-0065"/></p><p>Now give this script as an argument to <code class="literal">flow-capture -R</code>, and then verify that the flow file is copied to the FlowScan data directory.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Make your rotation scripts very simple. Remember that this script will run every five minutes, and if it generates extensive logs or sends email, you'll get those messages 288 times a day.</p></div></div><div class="sect2" title="Running FlowScan"><div class="titlepage"><div><div><h2 class="title"><a id="running_flowscan"/>Running FlowScan</h2></div></div></div><p>Now it's time to start FlowScan by running its startup script. The FlowScan logfile should have an entry like this:<a class="indexterm" id="IDX-CHP-6-0066"/></p><a id="I_programlisting6_d1e10539"/><pre class="programlisting">2011/02/17 17:29:07 working on file ❶ /var/db/flows/test/
flowscandata/ft-v05.2011-02-17.172501-0400...
  2011/02/17 17:29:10 flowscan-1.020 CUFlow: Cflow::find took
 ❷ 3 wallclock secs (3.36 usr +  0.00 sys =  3.36 CPU) for
 ❸ 615816 flow file bytes, ❹ flow hit ratio: 31593/31599
  2011/02/17 17:29:12 flowscan-1.020 CUFlow: report took
 ❺ 1 wallclock secs (0.00 usr  0.00 sys +  0.12 cusr  0.04 csys =  0.16 CPU)
❻ Sleep 300...</pre><p>In this output, FlowScan started (❶) processing the file your log rotation program copied to the data directory. You can see at ❷ how long FlowScan searched the file for data and at ❸ the file size.</p><p>The most interesting thing here, though, is the flow hit ratio at ❹. This ratio tells you how many flows in the file matched your <code class="literal">Subnet</code> statement. You should have an overwhelming number of matches. Here, I'm matching 31,593 out of 31,599 flows in the file, which is acceptable. (Broadcast traffic and misconfigured hosts probably account for the small number of nonmatching flows.) You can also see at ❺ how long FlowScan took to write the RRD files.<a class="indexterm" id="IDX-CHP-6-0067"/></p><p>Finally, at ❻ FlowScan runs out of files to process, and it goes to sleep for five minutes. When it awakens, it will process any files it finds in the data directory.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>If your log messages do not look like this, you have made an error. Check your permissions, and then google for the error. Someone has almost certainly made the same mistake before. They always have.</p></div></div><div class="sect2" title="FlowScan File Handling"><div class="titlepage"><div><div><h2 class="title"><a id="flowscan_file_handling"/>FlowScan File Handling</h2></div></div></div><p>FlowScan deletes flow files when it finishes processing them. This is desirable behavior when you've copied the file to a FlowScan-specific data directory, because although disk space is cheap these days, saving two copies of every flow file is a bit much!</p><p>If you don't want FlowScan to delete processed files, create a <span class="emphasis"><em>saved</em></span> directory in the FlowScan data directory, and FlowScan will move processed files to this directory. This retention is not hierarchical, however: You'll add 288 files to this directory daily, 2,016 files weekly, and 104,832 in a year. After a while, a simple <code class="literal">ls</code> command will take surprisingly long to complete. I recommend that you let FlowScan discard processed files and rely on your originals instead.<a class="indexterm" id="IDX-CHP-6-0068"/><a class="indexterm" id="IDX-CHP-6-0069"/><a class="indexterm" id="IDX-CHP-6-0070"/><a class="indexterm" id="IDX-CHP-6-0071"/><a class="indexterm" id="IDX-CHP-6-0072"/><a class="indexterm" id="IDX-CHP-6-0073"/><a class="indexterm" id="IDX-CHP-6-0074"/><a class="indexterm" id="IDX-CHP-6-0075"/></p></div><div class="sect2" title="Displaying CUFlow Graphs"><div class="titlepage"><div><div><h2 class="title"><a id="displaying_cuflow_graphs"/>Displaying CUFlow Graphs</h2></div></div></div><p>CUFlow includes a CGI script to display graphs called <span class="emphasis"><em>CUGrapher.pl</em></span>. This script converts the RRD data into graphs. To use this script, copy it to your web server's CGI directory, and then set two variables near the top of the script to generate your graphs as follows:<a class="indexterm" id="IDX-CHP-6-0076"/></p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Set the <code class="literal">$rrddir</code> variable to the directory where you have stored your FlowScan RRD files.</p><a id="I_programlisting6_d1e10618"/><pre class="programlisting">my $rrddir = "/var/db/flows/test/flowscanrrd";</pre></li><li class="listitem"><p>Set the site or company name name with the <code class="literal">$organization</code> variable.</p><a id="I_programlisting6_d1e10626"/><pre class="programlisting">my $organization = "Obey Lucas in All Things";</pre></li><li class="listitem"><p>Now point your web browser at the CGI script, and you should see something like <a class="xref" href="ch06s05.html#initial_cuflow_menu" title="Figure 6-1. Initial CUFlow menu">Figure 6-1</a>.</p><div class="figure"><a id="initial_cuflow_menu"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject6_d1e10636"/><img alt="Initial CUFlow menu" src="httpatomoreillycomsourcenostarchimages651586.png.jpg"/></div></div><p class="title">Figure 6-1. Initial CUFlow menu</p></div></li></ol></div><p>Check the checkbox beneath All Svcs, and check the Total checkbox on the far right, as shown in <a class="xref" href="ch06s05.html#initial_cuflow_menu" title="Figure 6-1. Initial CUFlow menu">Figure 6-1</a>. This will display a FlowScan graph of all the TCP/IP services used on this network, somewhat like <a class="xref" href="ch06s05.html#services_in_cuflow" title="Figure 6-2. Services in CUFlow">Figure 6-2</a>.</p><p>Each protocol you defined in <span class="emphasis"><em>CUFlow.cf</em></span> has its own color, as shown in the legend at the bottom of the screen. The legend in the example in <a class="xref" href="ch06s05.html#services_in_cuflow" title="Figure 6-2. Services in CUFlow">Figure 6-2</a> shows the colors assigned to RTSP, HTTP, SMTP, and so on. Whitespace indicates traffic that isn't listed as a service in <span class="emphasis"><em>CUFlow.cf</em></span>. Next to each color you'll see the total amount of traffic for that protocol.</p><div class="figure"><a id="services_in_cuflow"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject6_d1e10660"/><img alt="Services in CUFlow" src="httpatomoreillycomsourcenostarchimages651588.png.jpg"/></div></div><p class="title">Figure 6-2. Services in CUFlow</p></div><p>Further, positive numbers show traffic leaving your network, and negative numbers show traffic entering the network. For example, at the start of this graph (at the far left), you have 140Kbps leaving the network and 80Kbps entering. Most of the outgoing traffic consists of known services. The large amount of whitespace in the incoming traffic includes traffic that CUFlow hasn't been told to categorize. To identify the traffic in this whitespace, examine the flow files themselves.<a class="indexterm" id="IDX-CHP-6-0077"/><a class="indexterm" id="IDX-CHP-6-0078"/><a class="indexterm" id="IDX-CHP-6-0079"/><a class="indexterm" id="IDX-CHP-6-0080"/><a class="indexterm" id="IDX-CHP-6-0081"/><a class="indexterm" id="IDX-CHP-6-0082"/><a class="indexterm" id="IDX-CHP-6-0083"/></p><p>CUFlow lets you generate graphs for protocols, networks, and services over various time periods, but it will report on only one protocol, network, or service at a time. Also, CUFlow adds all your selections together. For example, if you select TCP from the Protocol column, HTTP from the Service column, and your web server from the Network column, the result will be a meaningless graph that includes all TCP traffic, all HTTP traffic, and all of your web server's traffic, combined. To create a more specific graph, such as all the HTTP traffic to a particular server, you must use a more flexible tool such as FlowViewer (<a class="xref" href="ch07.html" title="Chapter 7. FLOWVIEWER">Chapter 7</a>). Alternatively, if you will need to check this graph repeatedly, split your flow records, and run multiple FlowScan and CUFlow instances.<a class="indexterm" id="IDX-CHP-6-0084"/></p></div></div>
<div class="sect1" title="Flow Record Splitting and CUFlow"><div class="titlepage"><div><div><h1 class="title"><a id="flow_record_splitting_and_cuflow"/>Flow Record Splitting and CUFlow</h1></div></div></div><p>CUFlow is a useful tool for graphing the most common network situations, but it has its limitations. For example, you cannot select from multiple columns to, say, see how much HTTP traffic your web servers have sent; you can see only the total amount of HTTP traffic or the total amount of web server traffic. Also, you cannot perform true ad hoc reporting with CUFlow, but you can configure it to represent the most common questions about your network.</p><p>CUFlow's limitations hit home in certain environments. At one time I ran a data center that provided services to remote sites over a private MPLS network. Each plant had a T1 or E1, while the data center had a DS3. Every site got all of its services from the main data center. I had flow exports and CUFlow on the headquarters DS3, which reported on traffic going to the central mail servers, file servers, proxy servers, and so on, and I wanted to offer management access to graphs that showed how much traffic each plant used and what that traffic was. Most of the plants did not have equipment capable of exporting flow data, however.</p><p>I provided useful (but imperfect) results by splitting plant flow information out of the DS3 flow records and running a separate FlowScan instance for each plant. I say "imperfect" because these results wouldn't display plant-to-plant traffic, for example. However, because the overwhelming majority of each plant's offsite traffic went to the central data center, it provided a good guess at what traffic was on the circuit.</p><p>Splitting flow records is applicable to many environments. For example, web farms don't have remote sites, but they probably have major customers who would each like their own FlowScan pages. You can deliver those separate pages by first splitting the flows into multiple data sets and then setting up a separate FlowScan instance for each data set.</p><div class="sect2" title="Splitting Flows"><div class="titlepage"><div><div><h2 class="title"><a id="splitting_flows"/>Splitting Flows</h2></div></div></div><p>To split your flow data into smaller data sets, use <code class="literal">flow-nfilter</code>. You probably already have a filter for each subset of data, but you'll need to be sure that the filter covers both incoming and outgoing traffic. For example, to pull only flow data that includes the addresses 192.0.2.0/24, you could use this primitive filter:</p><a id="I_programlisting6_d1e10728"/><pre class="programlisting">filter-primitive site1
    type ip-address-prefix
    permit 192.0.2.0/24

filter-definition site1
    match ip-source-address site1
    or
    match ip-destination-address site1</pre><p>Next, use <code class="literal">flow-print</code> to verify that the filter passes flows for only these addresses, and use <code class="literal">flow-cat</code> and <code class="literal">flow-nfilter</code> to create a flow file that contains this data only.</p><a id="I_programlisting6_d1e10741"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat ft-v05.2011-02-18.112001-0500 | flow-nfilter -F</code></strong> ❶ <strong class="userinput"><code>site1 &gt;</code></strong>
 ❷ <strong class="userinput"><code>ft-v05.site1</code></strong></pre><p>The file <span class="emphasis"><em>ft-v05.site1</em></span> (❷) is a flow file that contains only the flows permitted by the <code class="literal">site1</code> filter (❶). Verify this with <code class="literal">flow-print</code>.</p></div><div class="sect2" title="Scripting Flow Record Splitting"><div class="titlepage"><div><div><h2 class="title"><a id="scripting_flow_record_splitting"/>Scripting Flow Record Splitting</h2></div></div></div><p>FlowScan expects a steady supply of flow files. You should not manually run <code class="literal">flow-cat</code> and <code class="literal">flow-nfilter</code> for every new flow file. Instead, use a flow rotation script to filter each new flow file into the smaller data set, as in this example:<a class="indexterm" id="IDX-CHP-6-0085"/><a class="indexterm" id="IDX-CHP-6-0086"/><a class="indexterm" id="IDX-CHP-6-0087"/><a class="indexterm" id="IDX-CHP-6-0088"/><a class="indexterm" id="IDX-CHP-6-0089"/><a class="indexterm" id="IDX-CHP-6-0090"/><a class="indexterm" id="IDX-CHP-6-0091"/><a class="indexterm" id="IDX-CHP-6-0092"/><a class="indexterm" id="IDX-CHP-6-0093"/><a class="indexterm" id="IDX-CHP-6-0094"/></p><a id="I_programlisting6_d1e10816"/><pre class="programlisting">#!/bin/sh
 PATH=/bin:/usr/bin:/usr/local/bin

 #for our primary flowscan instance
 cp $1 /var/db/flows/test/flowscandata

 #for flowscan on a data subset
 flow-cat /var/db/flows/test/$1 | \
     flow-nfilter ❶ -f /usr/local/etc/flow-tools/site1-filter.cfg -F site1 &gt; \
❷    /var/db/flows/site1/flowscandata/</pre><p>The beginning of this script is the same as the flow rotation script you used to copy the flow file to your existing FlowScan instance. (You don't want to break what already works!) The last command splits out the flows for one particular site and creates a flow file of that data in a separate directory. Use <code class="literal">flow-nfilter</code>'s <code class="literal">-f</code> argument (❶) to use a nonstandard flow filter definition file, remembering that if your flow filter file has an incomplete or invalid rule, <code class="literal">flow-nfilter</code> will not run.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>If you happen to be editing your filter rules when the rotation script runs, the script will fail. It's best to have a separate filter definition file just for splitting out these flows.</p></div><p>Each instance of FlowScan needs its own incoming data directory (❷), as discussed at length in the next section. Add lines to this script for each FlowScan instance on a subset of your data, and be sure to restart <code class="literal">flow-capture</code> each time you change the rotation script.</p></div><div class="sect2" title="Filtered CUFlow and Directory Setup"><div class="titlepage"><div><div><h2 class="title"><a id="filtered_cuflow_and_directory_setup"/>Filtered CUFlow and Directory Setup</h2></div></div></div><p>Give each FlowScan instance its own directory. The main flows are collected in <span class="emphasis"><em>/var/db/flows/test</em></span>, so use a directory like <span class="emphasis"><em>/var/db/flows/site1</em></span>. This directory needs three subdirectories: <span class="emphasis"><em>flowscandata</em></span> (for incoming filtered flow files), <span class="emphasis"><em>flowscanrrd</em></span> (for RRD files created from processed flow files), and <span class="emphasis"><em>bin</em></span> (for this FlowScan instance). Be sure that the flowscan user can write to these directories.<a class="indexterm" id="IDX-CHP-6-0095"/></p><p>Copy everything in your original FlowScan <span class="emphasis"><em>bin</em></span> directory into the <span class="emphasis"><em>bin</em></span> directory for this FlowScan instance in order to get all of the updated modules. Then, to set up your new instance, edit <span class="emphasis"><em>flowscan.cf</em></span> by changing <code class="literal">FlowFileGlob</code> to give the path to the data directory for your new instance.</p><p>Now, because each FlowScan instance needs a separate directory under your web server in order to store its scoreboard and top hosts lists, create that directory, and then edit <span class="emphasis"><em>CUFlow.cf</em></span> to change the <span class="emphasis"><em>OutputDir</em></span>, <span class="emphasis"><em>Scoreboard</em></span>, and <span class="emphasis"><em>AggregateScore</em></span> directories and files to point to that directory. Finally, give each FlowScan instance its own startup script by copying the existing startup script, editing it to match your new instance, and assigning a new logfile to it. (Remember that the logfile must exist, and the flowscan user must be able to write to it before you start FlowScan.) Now start your second FlowScan instance. If there's a problem, you should see it in the logfile.<a class="indexterm" id="IDX-CHP-6-0096"/><a class="indexterm" id="IDX-CHP-6-0097"/></p><p>Although it may be tempting to create separate FlowScan instances for every group of servers or even every host on your network, doing so increases system load and maintenance overhead. FlowScan runs every five minutes, and if your server needs more than five minutes to completely process hundreds of FlowScan instances, your system will become unusable.</p><div class="sidebar"><a id="treading_into_perl"/><p class="title">TREADING INTO PERL</p><p>FlowScan and CUFlow don't cut it for everyone. For those of you who would rather roll your own, the rest of this chapter discusses how to write your own Perl modules to read flow records. The following code fragments assume that you have a basic, working knowledge of Perl, but not many people are network engineers, systems administrators, <span class="emphasis"><em>and</em></span> Perl programmers. If you're not comfortable reading line noise and couldn't care less about exporting variables or functions, skip to the next chapter.<a class="indexterm" id="IDX-CHP-6-0098"/></p></div></div></div>
<div class="sect1" title="Using Cflow.pm"><div class="titlepage"><div><div><h1 class="title"><a id="using_cflow.pm"/>Using Cflow.pm</h1></div></div></div><p>Perl is a popular language for systems administration and web development. The <span class="emphasis"><em>Cflow.pm</em></span> module lets you write Perl that reads flow files directly.</p><div class="sect2" title="A Sample Cflow.pm Script"><div class="titlepage"><div><div><h2 class="title"><a id="a_sample_cflow.pm_script"/>A Sample Cflow.pm Script</h2></div></div></div><p>Here's a simple <span class="emphasis"><em>Cflow.pm</em></span> Perl script that prints out all UDP port 500 (Checkpoint ISAKMP, used in IPSec VPNs) flows, stripped down from the script provided in the <span class="emphasis"><em>Cflow.pm</em></span> documentation. This script takes the name of one or more flow files as arguments.</p><a id="I_programlisting6_d1e10933"/><pre class="programlisting">#!/usr/bin/perl

❶ use Cflow qw(:flowvars find);
❷ find (\&amp;wanted, @ARGV);

❸ sub wanted {
      return unless (($srcport == 500 &amp;&amp; $dstport == 500 ) &amp;&amp; $udp == $protocol);
      printf("%s %15.15s.%-5hu %15.15s.%-5hu %2hu %10u %10u\n",
             $localtime, $srcip, $srcport, $dstip,
             $dstport, $protocol, $pkts, $bytes)
  }</pre><p>This script first includes <span class="emphasis"><em>Cflow.pm</em></span> (❶), and then it exports the flow variable names and the <code class="literal">find()</code> function from that module. The meat of <span class="emphasis"><em>Cflow.pm</em></span> (❷) consists of the <code class="literal">find()</code> and <code class="literal">wanted()</code> functions. When you feed a flow file to the script, <code class="literal">find()</code> sends each flow in the file to the <code class="literal">wanted()</code> function. In the <code class="literal">wanted()</code> function (❸), the script performs whatever functions you program in for each individual flow.<a class="indexterm" id="IDX-CHP-6-0099"/><a class="indexterm" id="IDX-CHP-6-0100"/></p><p><span class="emphasis"><em>Cflow.pm</em></span> offers many variables to access flow data. Although the meaning of many of these variables is easy to guess, such as <code class="literal">$srcport</code>, <code class="literal">$dstport</code>, <code class="literal">$protocol</code>, and so on, I list them in <a class="xref" href="ch06s07.html#cflow.pm_variables-id1" title="Table 6-1. Cflow.pm Variables">Table 6-1</a>.<a class="indexterm" id="IDX-CHP-6-0101"/></p><p><code class="literal">Find()</code> and <code class="literal">wanted()</code> allow you to use <span class="emphasis"><em>Cflow.pm</em></span> as the engine to feed flow data into a database, RRD, or hash file; flag interesting flows that fit patterns unique to your environment (that you can't easily filter for); and so on.</p></div><div class="sect2" title="Cflow.pm Variables"><div class="titlepage"><div><div><h2 class="title"><a id="cflow.pm_variables"/>Cflow.pm Variables</h2></div></div></div><p><a class="xref" href="ch06s07.html#cflow.pm_variables-id1" title="Table 6-1. Cflow.pm Variables">Table 6-1</a> shows the variables for evaluating flows offered by <span class="emphasis"><em>Cflow.pm</em></span>.</p><div class="table"><a id="cflow.pm_variables-id1"/><p class="title">Table 6-1. <span class="emphasis"><em>Cflow.pm</em></span> Variables</p><div class="table-contents"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; " summary="Cflow.pm Variables"><colgroup><col/><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Variable</p></th><th style="text-align: left" valign="bottom"><p>Meaning</p></th><th style="text-align: left" valign="bottom"><p>Sample Output</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">$unix_secs</code></p></td><td style="text-align: left" valign="top"><p>Epochal seconds of the flow start time</p></td><td style="text-align: left" valign="top"><p>1229490004</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$exporter</code></p></td><td style="text-align: left" valign="top"><p>Sensor IP address as a long (decimal)</p></td><td style="text-align: left" valign="top"><p>1430200323</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$exporterip</code></p></td><td style="text-align: left" valign="top"><p>Sensor IP address as a dotted quad</p></td><td style="text-align: left" valign="top"><p>192.0.2.3</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$localtime</code></p></td><td style="text-align: left" valign="top"><p>Epoch time converted to local time</p></td><td style="text-align: left" valign="top"><p>2011/12/16 23:59:43</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$srcaddr</code></p></td><td style="text-align: left" valign="top"><p>Source IP address as a long (decimal)</p></td><td style="text-align: left" valign="top"><p>1430200341</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$srcip</code></p></td><td style="text-align: left" valign="top"><p>Source IP address as a dotted quad</p></td><td style="text-align: left" valign="top"><p>192.0.2.27</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$dstaddr</code></p></td><td style="text-align: left" valign="top"><p>Destination IP address as a long (decimal)</p></td><td style="text-align: left" valign="top"><p>1166468433</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$dstip</code></p></td><td style="text-align: left" valign="top"><p>Destination IP address as a dotted quad</p></td><td style="text-align: left" valign="top"><p>69.134.229.81</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$input_if</code></p></td><td style="text-align: left" valign="top"><p>Input interface index</p></td><td style="text-align: left" valign="top"><p>2</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$output_if</code></p></td><td style="text-align: left" valign="top"><p>Output interface index</p></td><td style="text-align: left" valign="top"><p>9</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$srcport</code></p></td><td style="text-align: left" valign="top"><p>TCP or UDP source port number or equivalent</p></td><td style="text-align: left" valign="top"><p>53</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$dstport</code></p></td><td style="text-align: left" valign="top"><p>TCP or UDP destination port number or equivalent</p></td><td style="text-align: left" valign="top"><p>46819</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMPType</code></p></td><td style="text-align: left" valign="top"><p>ICMP type (high byte of $dstport, for ICMP flows only)</p></td><td style="text-align: left" valign="top"><p>3</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMPCode</code></p></td><td style="text-align: left" valign="top"><p>ICMP code (low byte of $dstport, for ICMP flows only)</p></td><td style="text-align: left" valign="top"><p>1</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMPTypeCode</code></p></td><td style="text-align: left" valign="top"><p>Human-friendly name for ICMP type and code</p></td><td style="text-align: left" valign="top"><p>HOST_UNREACH</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$pkts</code></p></td><td style="text-align: left" valign="top"><p>Packets in flow</p></td><td style="text-align: left" valign="top"><p>5</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$bytes</code></p></td><td style="text-align: left" valign="top"><p>Octets sent in duration</p></td><td style="text-align: left" valign="top"><p>138</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$nexthop</code></p></td><td style="text-align: left" valign="top"><p>Next-hop router's IP address as a long (decimal)</p></td><td style="text-align: left" valign="top"><p>1398215405</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$nexthopip</code></p></td><td style="text-align: left" valign="top"><p>Next-hop router's IP address as a dotted quad</p></td><td style="text-align: left" valign="top"><p>12.61.8.12</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$starttime</code></p></td><td style="text-align: left" valign="top"><p>Epoch seconds in local time at start of flow</p></td><td style="text-align: left" valign="top"><p>1229489984</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$start_msecs</code></p></td><td style="text-align: left" valign="top"><p>Milliseconds portion of start time</p></td><td style="text-align: left" valign="top"><p>131</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$endtime</code></p></td><td style="text-align: left" valign="top"><p>Epoch seconds in local time at end of flow</p></td><td style="text-align: left" valign="top"><p>1229489985</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$end_msecs</code></p></td><td style="text-align: left" valign="top"><p>Milliseconds portion of end time</p></td><td style="text-align: left" valign="top"><p>871</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$protocol</code></p></td><td style="text-align: left" valign="top"><p>TCP/IP protocol number</p></td><td style="text-align: left" valign="top"><p>17</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$tos</code></p></td><td style="text-align: left" valign="top"><p>Type of service</p></td><td style="text-align: left" valign="top"><p>0</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$tcp_flags</code></p></td><td style="text-align: left" valign="top"><p>Bitwise OR of all TCP flags, or 0x10 for non-TCP flows</p></td><td style="text-align: left" valign="top"><p>16</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$TCPFlags</code></p></td><td style="text-align: left" valign="top"><p>Human-friendly representation of tcp_flags</p></td><td style="text-align: left" valign="top"><p>ACK</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$raw</code></p></td><td style="text-align: left" valign="top"><p>The entire original raw flow format</p></td><td style="text-align: left" valign="top"><p><span class="emphasis"><em>binary</em></span></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$reraw</code></p></td><td style="text-align: left" valign="top"><p>The modified raw flow file format, for writing to a new file</p></td><td style="text-align: left" valign="top"><p><span class="emphasis"><em>binary</em></span></p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$Bps</code></p></td><td style="text-align: left" valign="top"><p>Minimum bytes per second for this flow</p></td><td style="text-align: left" valign="top"><p>40</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$pps</code></p></td><td style="text-align: left" valign="top"><p>Minimum packets per second for this flow</p></td><td style="text-align: left" valign="top"><p>5</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$src_as</code></p></td><td style="text-align: left" valign="top"><p>BGP source AS of the current flow</p></td><td style="text-align: left" valign="top"><p>701</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$dst_as</code></p></td><td style="text-align: left" valign="top"><p>BGP destination AS of the current flow</p></td><td style="text-align: left" valign="top"><p>11512</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$src_mask</code></p></td><td style="text-align: left" valign="top"><p>Source address prefix mask bits</p></td><td style="text-align: left" valign="top"><p>/23</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$dst_mask</code></p></td><td style="text-align: left" valign="top"><p>Destination address prefix mask bits</p></td><td style="text-align: left" valign="top"><p>/16</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$engine_type</code></p></td><td style="text-align: left" valign="top"><p>Type of flow switching engine (vendor-specific)</p></td><td style="text-align: left" valign="top"><p>1</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$engine_id</code></p></td><td style="text-align: left" valign="top"><p>Engine ID of the flow switching engine (vendor-specific)</p></td><td style="text-align: left" valign="top"><p>0</p></td></tr></tbody></table></div></div><p>To use these variables, you must first preface them with <code class="literal">Cflow::</code> or export them from <span class="emphasis"><em>Cflow.pm</em></span> as I did at the top of the sample script.</p></div><div class="sect2" title="Other Cflow.pm Exports"><div class="titlepage"><div><div><h2 class="title"><a id="other_cflow.pm_exports"/>Other Cflow.pm Exports</h2></div></div></div><p><span class="emphasis"><em>Cflow.pm</em></span> also exports the symbolic names for TCP flags and ICMP types and codes. You might find these names, shown in <a class="xref" href="ch06s07.html#exported_tcp_flag_symbolic_names" title="Table 6-2. Exported TCP Flag Symbolic Names">Table 6-2</a>, easier to work with than raw numbers, especially in complicated scripts.<a class="indexterm" id="IDX-CHP-6-0102"/><a class="indexterm" id="IDX-CHP-6-0103"/></p><div class="table"><a id="exported_tcp_flag_symbolic_names"/><p class="title">Table 6-2. Exported TCP Flag Symbolic Names</p><div class="table-contents"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; " summary="Exported TCP Flag Symbolic Names"><colgroup><col/><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Variable</p></th><th style="text-align: left" valign="bottom"><p>Meaning</p></th><th style="text-align: left" valign="bottom"><p>Value</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">$TH_FIN</code></p></td><td style="text-align: left" valign="top"><p>FIN</p></td><td style="text-align: left" valign="top"><p>1</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$TH_SYN</code></p></td><td style="text-align: left" valign="top"><p>SYN</p></td><td style="text-align: left" valign="top"><p>2</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$TH_RST</code></p></td><td style="text-align: left" valign="top"><p>RST</p></td><td style="text-align: left" valign="top"><p>4</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$TH_PUSH</code></p></td><td style="text-align: left" valign="top"><p>PUSH</p></td><td style="text-align: left" valign="top"><p>8</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$TH_ACK</code></p></td><td style="text-align: left" valign="top"><p>ACK</p></td><td style="text-align: left" valign="top"><p>16</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$TH_URG</code></p></td><td style="text-align: left" valign="top"><p>URG</p></td><td style="text-align: left" valign="top"><p>32</p></td></tr></tbody></table></div></div><p>Make the TCP flags accessible by exporting <code class="literal">tcpflags</code>. Similarly, export <code class="literal">icmptypes</code> and <code class="literal">icmpcodes</code> to use their symbolic names, as shown in <a class="xref" href="ch06s07.html#exported_icmp_type_symbolic_names" title="Table 6-3. Exported ICMP Type Symbolic Names">Table 6-3</a>.<a class="indexterm" id="IDX-CHP-6-0104"/><a class="indexterm" id="IDX-CHP-6-0105"/><a class="indexterm" id="IDX-CHP-6-0106"/></p><div class="table"><a id="exported_icmp_type_symbolic_names"/><p class="title">Table 6-3. Exported ICMP Type Symbolic Names</p><div class="table-contents"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; " summary="Exported ICMP Type Symbolic Names"><colgroup><col/><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Variable</p></th><th style="text-align: left" valign="bottom"><p>Meaning</p></th><th style="text-align: left" valign="bottom"><p>Value</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_ECHOREPLY</code></p></td><td style="text-align: left" valign="top"><p>Echo reply</p></td><td style="text-align: left" valign="top"><p>0</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_DEST_UNREACH</code></p></td><td style="text-align: left" valign="top"><p>Destination unreachable</p></td><td style="text-align: left" valign="top"><p>3</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_SOURCE_QUENCH</code></p></td><td style="text-align: left" valign="top"><p>Source quench</p></td><td style="text-align: left" valign="top"><p>4</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_REDIRECT</code></p></td><td style="text-align: left" valign="top"><p>Redirect</p></td><td style="text-align: left" valign="top"><p>5</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_ECHO</code></p></td><td style="text-align: left" valign="top"><p>Echo request</p></td><td style="text-align: left" valign="top"><p>8</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_TIME_EXCEEDED</code></p></td><td style="text-align: left" valign="top"><p>Time exceeded</p></td><td style="text-align: left" valign="top"><p>11</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_PARAMETERPROB</code></p></td><td style="text-align: left" valign="top"><p>Error not covered by other ICMP types</p></td><td style="text-align: left" valign="top"><p>12</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_TIMESTAMP</code></p></td><td style="text-align: left" valign="top"><p>Timestamp request</p></td><td style="text-align: left" valign="top"><p>13</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_TIMESTAMPREPLY</code></p></td><td style="text-align: left" valign="top"><p>Timestamp response</p></td><td style="text-align: left" valign="top"><p>14</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_INFO_REQUEST</code></p></td><td style="text-align: left" valign="top"><p>Network info request (obsolete)</p></td><td style="text-align: left" valign="top"><p>15</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_INFO_REPLY</code></p></td><td style="text-align: left" valign="top"><p>Network info reply (obsolete)</p></td><td style="text-align: left" valign="top"><p>16</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_ADDRESS</code></p></td><td style="text-align: left" valign="top"><p>Netmask request</p></td><td style="text-align: left" valign="top"><p>17</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_ADDRESSREPLY</code></p></td><td style="text-align: left" valign="top"><p>Netmask request response</p></td><td style="text-align: left" valign="top"><p>18</p></td></tr></tbody></table></div></div><p>Symbolic names are included for ICMP codes for ICMP types 3 (unreachable, <a class="xref" href="ch06s07.html#exported_icmp_type_3_code_symbolic_names" title="Table 6-4. Exported ICMP Type 3 Code Symbolic Names">Table 6-4</a>), 5 (redirects, <a class="xref" href="ch06s07.html#exported_icmp_type_11_code_symbolic_name" title="Table 6-5. Exported ICMP Type 11 Code Symbolic Names">Table 6-5</a>), and 11 (time exceeded, <a class="xref" href="ch06s07.html#exported_icmp_type_11_code_symbolic_name" title="Table 6-5. Exported ICMP Type 11 Code Symbolic Names">Table 6-5</a>).</p><div class="table"><a id="exported_icmp_type_3_code_symbolic_names"/><p class="title">Table 6-4. Exported ICMP Type 3 Code Symbolic Names</p><div class="table-contents"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; " summary="Exported ICMP Type 3 Code Symbolic Names"><colgroup><col/><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Variable</p></th><th style="text-align: left" valign="bottom"><p>Meaning</p></th><th style="text-align: left" valign="bottom"><p>Value</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_NET_UNREACH</code></p></td><td style="text-align: left" valign="top"><p>Network unreachable</p></td><td style="text-align: left" valign="top"><p>0</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_HOST_UNREACH</code></p></td><td style="text-align: left" valign="top"><p>Host unreachable</p></td><td style="text-align: left" valign="top"><p>1</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_PROT_UNREACH</code></p></td><td style="text-align: left" valign="top"><p>Protocol unreachable</p></td><td style="text-align: left" valign="top"><p>2</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_PORT_UNREACH</code></p></td><td style="text-align: left" valign="top"><p>UDP port unreachable</p></td><td style="text-align: left" valign="top"><p>3</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_FRAG_NEEDED</code></p></td><td style="text-align: left" valign="top"><p>fragmentation needed</p></td><td style="text-align: left" valign="top"><p>4</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_SR_FAILED</code></p></td><td style="text-align: left" valign="top"><p>Source routing failed</p></td><td style="text-align: left" valign="top"><p>5</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_NET_UNKNOWN</code></p></td><td style="text-align: left" valign="top"><p>Network not known</p></td><td style="text-align: left" valign="top"><p>6</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_HOST_UNKNOWN</code></p></td><td style="text-align: left" valign="top"><p>Host not known</p></td><td style="text-align: left" valign="top"><p>7</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_HOST_ISOLATED</code></p></td><td style="text-align: left" valign="top"><p>Source host isolated</p></td><td style="text-align: left" valign="top"><p>8</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_NET_ANO</code></p></td><td style="text-align: left" valign="top"><p>Network administratively prohibited</p></td><td style="text-align: left" valign="top"><p>9</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_HOST_ANO</code></p></td><td style="text-align: left" valign="top"><p>Host administratively prohibited</p></td><td style="text-align: left" valign="top"><p>10</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_NET_UNR_TOS</code></p></td><td style="text-align: left" valign="top"><p>Network unreachable at this type of service</p></td><td style="text-align: left" valign="top"><p>11</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_HOST_UNR_TOS</code></p></td><td style="text-align: left" valign="top"><p>Host unreachable at this type of service</p></td><td style="text-align: left" valign="top"><p>12</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_PKT_FILTERED</code></p></td><td style="text-align: left" valign="top"><p>Communication prohibited by filtering</p></td><td style="text-align: left" valign="top"><p>13</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_PREC_VIOLATION</code></p></td><td style="text-align: left" valign="top"><p>Host precedence violation</p></td><td style="text-align: left" valign="top"><p>14</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_PREC_CUTOFF</code></p></td><td style="text-align: left" valign="top"><p>Precedence cutoff in effect</p></td><td style="text-align: left" valign="top"><p>15</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_REDIRECT_NET</code><a class="indexterm" id="IDX-CHP-6-0107"/><a class="indexterm" id="IDX-CHP-6-0108"/><a class="indexterm" id="IDX-CHP-6-0109"/><a class="indexterm" id="IDX-CHP-6-0110"/></p></td><td style="text-align: left" valign="top"><p>Redirect for network</p></td><td style="text-align: left" valign="top"><p>0</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_REDIRECT_HOST</code></p></td><td style="text-align: left" valign="top"><p>Redirect for host</p></td><td style="text-align: left" valign="top"><p>1</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_REDIRECT_NETTOS</code></p></td><td style="text-align: left" valign="top"><p>Redirect for network and type of service</p></td><td style="text-align: left" valign="top"><p>2</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_REDIRECT_HOSTTOS</code></p></td><td style="text-align: left" valign="top"><p>Redirect for host and type of service</p></td><td style="text-align: left" valign="top"><p>3</p></td></tr></tbody></table></div></div><div class="table"><a id="exported_icmp_type_11_code_symbolic_name"/><p class="title">Table 6-5. Exported ICMP Type 11 Code Symbolic Names</p><div class="table-contents"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; " summary="Exported ICMP Type 11 Code Symbolic Names"><colgroup><col/><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Variable</p></th><th style="text-align: left" valign="bottom"><p>Meaning</p></th><th style="text-align: left" valign="bottom"><p>Value</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_EXC_TTL</code></p></td><td style="text-align: left" valign="top"><p>Time to live exceeded in transit</p></td><td style="text-align: left" valign="top"><p>0</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">$ICMP_EXC_FRAGTIME</code></p></td><td style="text-align: left" valign="top"><p>Fragment reassembly time exceeded</p></td><td style="text-align: left" valign="top"><p>1</p></td></tr></tbody></table></div></div><div class="note" title="Note"><h3 class="title">Note</h3><p>Between the values available for every flow, TCP flags, and ICMP types and codes, you can add code to perform flow analysis.</p></div></div><div class="sect2" title="Acting on Every File"><div class="titlepage"><div><div><h2 class="title"><a id="acting_on_every_file"/>Acting on Every File</h2></div></div></div><p><span class="emphasis"><em>Cflow.pm</em></span> supports actions after processing a flow file, such as freeing memory, reinitializing variables, or perhaps moving a file to an archive directory. If you include it in your script, <span class="emphasis"><em>Cflow.pm</em></span> will call the <code class="literal">perfile()</code> function once per flow file. Include the reference to <code class="literal">perfile</code> in your <code class="literal">find()</code> function immediately after your <code class="literal">wanted</code> reference.</p><a id="I_programlisting6_d1e12068"/><pre class="programlisting">#!/usr/bin/perl
use Cflow qw(:flowvars find );
find (\&amp;wanted, \&amp;perfile, @ARGV);

sub wanted {
}

sub perfile {
    print "working on \"$_[0]\"...\n";
}</pre><p>This code example prints the filename once per file.</p></div><div class="sect2" title="Return Value"><div class="titlepage"><div><div><h2 class="title"><a id="return_value"/>Return Value</h2></div></div></div><p>The <code class="literal">find()</code> function returns the ratio of the number of flows that matched the <code class="literal">wanted()</code> function. For example, here I'm returning the number of ICMP flows in the flow file:</p><a id="I_programlisting6_d1e12083"/><pre class="programlisting">#!/usr/bin/perl
use Cflow qw(find :flowvars );
$hitrate = find (\&amp;wanted, @ARGV);

sub wanted {
    return unless (1 == $protocol);
    $icmp++;
}

print "hitrate is $hitrate\n";</pre><p>Running this generates output such as the following:<a class="indexterm" id="IDX-CHP-6-0111"/><a class="indexterm" id="IDX-CHP-6-0112"/></p><a id="I_programlisting6_d1e12095"/><pre class="programlisting">hitrate is 34/4140</pre><p>Thirty-four of the 4,140 flows in the input file were ICMP flows.</p></div><div class="sect2" title="Verbose Mode"><div class="titlepage"><div><div><h2 class="title"><a id="verbose_mode"/>Verbose Mode</h2></div></div></div><p><span class="emphasis"><em>Cflow.pm</em></span> generates error messages by default. To disable this, set <code class="literal">verbose</code> to <code class="literal">0</code> as follows:</p><a id="I_programlisting6_d1e12112"/><pre class="programlisting">use Cflow qw(find :flowvars );
verbose(0);
...</pre><p>Every time I set this, I usually end up wishing that I hadn't because it generates lots and lots of output, obscuring useful data. Still, it's useful for debugging.</p><p>Now that you understand how to do simple web-based reports, you'll learn how to do hard ones.</p></div></div></body></html>