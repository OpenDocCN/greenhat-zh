<html><head></head><body>

<div class="calibre1"><div class="calibre1"><a name="procmail_3.22" class="calibre8" id="procmail_3.22"/>
<div class="calibre24" id="calibre_pb_0"/><h2 id="title-ID0EDOAO" class="docPrefaceTitle">Chapter 25. PROCMAIL 3.22</h2>
<h4 class="calibre32"><a class="calibre2" target="_blank" href="HTTP://WWW.PROCMAIL.ORG">HTTP://WWW.PROCMAIL.ORG</a></h4>
<a name="summary-id24" class="calibre8" id="summary-id24"/>
<h3 class="docSection1Title" id="-100000">25.1. SUMMARY</h3>
<p class="docText1"><a name="Procmail is" class="calibre8" id="Procmail is"/>Procmail is a mail filter, or <span class="docEmphasis1"><a name="Agent " class="calibre8" id="Agent "/>Mail Delivery Agent (MDA)</span><a name="incoming email" class="calibre8" id="incoming email"/>, that is used to process incoming email in accordance with a set of specified rules or actions. These actions can include forwarding email to a different address, routing flagged spam messages into a Junk folder, sending auto-reply messages, and so forth. Processing can be applied to all incoming messages, or limited to messages that contain certain tags or strings.<a name="IDX-CHP-25-0365" class="calibre8" id="IDX-CHP-25-0365"/><a name="IDX-CHP-25-0366" class="calibre8" id="IDX-CHP-25-0366"/><a name="IDX-CHP-25-0367" class="calibre8" id="IDX-CHP-25-0367"/><a name="IDX-CHP-25-0368" class="calibre8" id="IDX-CHP-25-0368"/><a name="IDX-CHP-25-0369" class="calibre8" id="IDX-CHP-25-0369"/><a name="IDX-CHP-25-0370" class="calibre8" id="IDX-CHP-25-0370"/><a name="IDX-CHP-25-0371" class="calibre8" id="IDX-CHP-25-0371"/><a name="IDX-CHP-25-0372" class="calibre8" id="IDX-CHP-25-0372"/></p>
<p class="docText1"><a name="Procmail rules" class="calibre8" id="Procmail rules"/>Setting up Procmail rules can be challenging for new users. The "<a class="calibre2" href="resources.html#resources">Resources</a><a name="that host" class="calibre8" id="that host"/>" section lists sites that host numerous examples and recipes to help with configuration. This guide will provide details on using Procmail to divert flagged spam into a separate Junk folder.</p>
<p class="docText1"><a name="In " class="calibre8" id="In "/>Procmail was originally created by Stephen R. van den Berg in 1990. In 1998, Philip Guenther became Procmail's maintainer; he continues to lead development efforts.</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="resources-id24" class="calibre8" id="resources-id24"/>
<h3 class="docSection1Title" id="-100000">25.2. RESOURCES</h3>
<p class="docText1"><span class="b"><a name="Procmail Documentation" class="calibre8" id="Procmail Documentation"/>Procmail Documentation Project</span></p>
<p class="docText1"><a class="calibre2" target="_blank" href="http://pm-doc.sourceforge.net">http://pm-doc.sourceforge.net</a></p>
<p class="docText1"><span class="b">Procmail FAQ (Era Eriksson)</span></p>
<p class="docText1"><a class="calibre2" target="_blank" href="http://partmaps.org/era/procmail/mini-faq.html">http://partmaps.org/era/procmail/mini-faq.html</a></p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="required-id24" class="calibre8" id="required-id24"/>
<h3 class="docSection1Title" id="-100000">25.3. REQUIRED</h3>
<p class="docText1"><img border="0" id="" src="N2QyLy9jZ3QvODFzcGVtaTlnNTRmOTk1N2kzMWFyczMvZzAwcC5uVQ--.jpg" alt="" class="calibre33"/><a name="FreeBSD " class="calibre8" id="FreeBSD "/> FreeBSD 7.0-RELEASE (see "<a class="calibre2" href="freebsd_7.0_split_000.html#freebsd_7.0">FreeBSD 7.0</a>")</p>
<p class="docText1"><img border="0" id="" src="N2QyLy9jZ3QvODFzcGVtaTlnNTRmOTk1N2kzMWFyczMvZzAwcC5uVQ--.jpg" alt="" class="calibre33"/><a name="collection " class="calibre8" id="collection "/> Updated ports collection (see "<a class="calibre2" href="freebsd_ports_collection.html#freebsd_ports_collection">FreeBSD Ports Collection</a>")</p>
<p class="docText1"><img border="0" id="" src="N2QyLy9jZ3QvODFzcGVtaTlnNTRmOTk1N2kzMWFyczMvZzAwcC5uVQ--.jpg" alt="" class="calibre33"/> Postfix SMTP server (see "<a class="calibre2" href="postfix_smtp_server_2.5.1.html#postfix_smtp_server_2.5.1">Postfix SMTP Server 2.5.1</a>")</p>
<p class="docText1"><img border="0" id="" src="N2QyLy9jZ3QvODFzcGVtaTlnNTRmOTk1N2kzMWFyczMvZzAwcC5uVQ--.jpg" alt="" class="calibre33"/> SpamAssassin (see "<a class="calibre2" href="spamassassin_3.2.4.html#spamassassin_3.2.4">SpamAssassin 3.2.4</a>")</p>
<p class="docText1"><img border="0" id="" src="N2QyLy9jZ3QvODFzcGVtaTlnNTRmOTk1N2kzMWFyczMvZzAwcC5uVQ--.jpg" alt="" class="calibre33"/> Internet connection</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="preparation-id24" class="calibre8" id="preparation-id24"/>
<h3 class="docSection1Title" id="-100000">25.4. PREPARATION</h3>
<p class="docText1"><a name="Become the" class="calibre8" id="Become the"/>Become the superuser.</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="install-id24" class="calibre8" id="install-id24"/>
<h3 class="docSection1Title" id="-100000">25.5. INSTALL</h3>
<p class="docText1"><a name="To begin" class="calibre8" id="To begin"/>To begin the Procmail installation process, enter the following commands:</p>
<pre class="calibre30"># <b class="calibre28">cd /usr/ports/mail/procmail</b>
# <b class="calibre28">make config ; make install clean</b>
# <b class="calibre28">rehash</b></pre>
<p class="docText1"><a name="process will" class="calibre8" id="process will"/>The installation process will pause to allow you to add directories to the test-lock routines. We'll accept the default, so press [enter] to continue.</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="configure-id24" class="calibre8" id="configure-id24"/>
<h3 class="docSection1Title" id="-100000">25.6. CONFIGURE</h3>
<p class="docText1"><a name="Once the" class="calibre8" id="Once the"/>Once the installation is complete, it is time to configure Procmail for use on your system.<a name="IDX-CHP-25-0373" class="calibre8" id="IDX-CHP-25-0373"/></p>
<div class="calibre34"><ol class="docList" type="1"><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="global configuration" class="calibre8" id="global configuration"/>Create a global configuration file (i.e., one that affects all users) to route email flagged as spam by SpamAssassin to a subfolder of each user's inbox, called Junk:</p><pre class="calibre30"># <b class="calibre28">ee /usr/local/etc/procmailrc</b></pre>
<p class="docText1">Add the following lines:</p><pre class="calibre30"># Environment Variables
MAILDIR=$HOME/Maildir/
DEFAULT=$HOME/Maildir/
DROPPRIVS = yes
LOGFILE=$HOME/proc.log
# Spam to Junk Recipe
:0
*^X-Spam-Status: Yes
.Junk/</pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Save and exit.</p></div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Add a line to Postfix's <span class="docEmphasis1">main.cf</span><a name="the Local" class="calibre8" id="the Local"/> file to specify Procmail as the Local Mail Delivery Agent. Open <span class="docEmphasis1">main.cf</span>:</p><pre class="calibre30"># <b class="calibre28">ee /usr/local/etc/postfix/main.cf</b></pre><br class="calibre1"/>
<p class="docText1"><a name="the bottom" class="calibre8" id="the bottom"/>Scroll to the bottom of <span class="docEmphasis1">main.cf</span><a name="this line" class="calibre8" id="this line"/> using [ctrl-U] and add this line:</p><pre class="calibre30">mailbox_command = /usr/local/bin/procmail</pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1">Save, exit, and reload Postfix's configuration:</p><pre class="calibre30"># <b class="calibre28">postfix reload</b></pre><br class="calibre1"/>
</div></li></ol></div>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="testing-id15" class="calibre8" id="testing-id15"/>
<h3 class="docSection1Title" id="-100000">25.7. TESTING</h3>
<p class="docText1"><a name="In this" class="calibre8" id="In this"/>In this section, we'll perform tests to confirm that Procmail delivers mail to users' mailboxes correctly.<a name="IDX-CHP-25-0374" class="calibre8" id="IDX-CHP-25-0374"/><a name="IDX-CHP-25-0375" class="calibre8" id="IDX-CHP-25-0375"/></p>
<div class="calibre34"><ol class="docList" type="1"><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="test spam" class="calibre8" id="test spam"/>Send a test spam message into the mail system. First, open a telnet connection:</p><pre class="calibre30"># <b class="calibre28">telnet localhost 25 </b>

Connected to localhost.
Escape character is '^]'.
220 <i class="docEmphasis1">host.example.com </i> ESMTP Postfix</pre>
<hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> Your hostname should appear instead of <a class="calibre2" target="_blank" href="http://host.example.com">host.example.com</a>.</span><hr size="1" noshade="noshade" class="calibre27"/><p class="docText1"><a name="for" class="calibre8" id="for"/>Enter the following (substituting your domain for <a class="calibre2" target="_blank" href="http://example.com">example.com</a>):</p><pre class="calibre30"><b class="calibre28">mail from: test@</b><span class="docEmphBoldItalic">example.com</span>
250 Ok

<b class="calibre28">rcpt to: spamd@</b><span class="docEmphBoldItalic">example.com</span>
250 Ok</pre><br class="calibre1"/>
<hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> You can specify a different recipient if you like. The spamd account will be present on your system if you used the SpamAssassin guide in this book.</span><hr size="1" noshade="noshade" class="calibre27"/><p class="docText1"><a name="following lines" class="calibre8" id="following lines"/>Next, enter the following lines as shown, pressing [enter] after each line.</p><hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> The long string is known as the <span class="docEmphasis1">GTUBE (Generic Test for Unsolicited Bulk Email)</span>. It will cause SpamAssassin to flag the message as spam.<a name="IDX-CHP-25-0376" class="calibre8" id="IDX-CHP-25-0376"/></span><hr size="1" noshade="noshade" class="calibre27"/><pre class="calibre30"><b class="calibre28">data </b>
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
<b class="calibre28">Subject: This is Spam </b>
<b class="calibre28">XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X </b>
<b class="calibre28">. </b>
250 Ok: queued as <i class="docEmphasis1">1242EC120 </i></pre><br class="calibre1"/>
<hr size="1" noshade="noshade" class="calibre27"/><span><i class="docEmphasis1"><b class="calibre28">Note:</b></i> The italicized ID tag will be different in your output.</span><hr size="1" noshade="noshade" class="calibre27"/><p class="docText1">Finally, close the connection:</p><pre class="calibre30"><b class="calibre28">quit</b></pre><br class="calibre1"/>
</div></li><li class="calibre16"><div class="calibre35"><p class="docText1"><a name="system a" class="calibre8" id="system a"/>Give the mail system a minute to process the message, then examine the Procmail log file in the recipient's home directory:</p><pre class="calibre30"># <b class="calibre28">cat /var/spool/spamd/proc.log</b></pre><br class="calibre1"/>
<p class="docText1"><a name="to this" class="calibre8" id="to this"/>If Procmail processed the message successfully, you should see output similar to this:<a name="IDX-CHP-25-0377" class="calibre8" id="IDX-CHP-25-0377"/></p><pre class="calibre30">From test@example.com Mon Nov 17 13:40:00 2008
  Folder: .Junk/new/1195508418.1125_0.host.example.com     2606</pre><br class="calibre1"/>
</div></li></ol></div>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="config_files-id24" class="calibre8" id="config_files-id24"/>
<h3 class="docSection1Title" id="-100000">25.8. CONFIG FILES</h3>
<p class="docText1"><span class="b">/usr/local/etc/procmailrc</span><a name="IDX-CHP-25-0378" class="calibre8" id="IDX-CHP-25-0378"/><a name="IDX-CHP-25-0379" class="calibre8" id="IDX-CHP-25-0379"/></p>
<p class="docText1"><a name="The global" class="calibre8" id="The global"/>The global Procmail configuration file. This file also contains recipes for processing mail messages.</p>
<p class="docText1"><span class="b">/usr/home/</span><span class="docEmphBoldItalic">username</span><span class="b">/.procmailrc</span></p>
<p class="docText1"><a name="The recipes" class="calibre8" id="The recipes"/>User-specific Procmail configuration file. The recipes in this file are processed after processing the recipes in <span class="docEmphasis1">/usr/local/etc/procmailrc</span>. By default, environment variables from <span class="docEmphasis1">/usr/local/etc/procmailrc</span><a name="and should" class="calibre8" id="and should"/> carry over to this file and should not be specified again. All folders are relative to the user's Maildir folder.</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="log_files-id13" class="calibre8" id="log_files-id13"/>
<h3 class="docSection1Title" id="-100000">25.9. LOG FILES</h3>
<p class="docText1"><span class="b">/usr/home/</span><span class="docEmphBoldItalic">username</span><span class="b">/proc.log</span></p>
<p class="docText1"><a name="Contains a" class="calibre8" id="Contains a"/>Contains a log of messages processed by Procmail for <span class="docEmphasis1">username</span></p>
<p class="docText1"><span class="b">/var/log/maillog</span></p>
<p class="docText1"><a name="of email" class="calibre8" id="of email"/>General log of email activity</p>
</div></div>




<div class="calibre1"><div class="calibre1"><a name="notes-id18" class="calibre8" id="notes-id18"/>
<h3 class="docSection1Title" id="-100000">25.10. NOTES</h3>
<p class="docText1"><a name="For examples" class="calibre8" id="For examples"/>For examples of Procmail recipes, see the procmailex manual page:</p>
<pre class="calibre30"># <b class="calibre28">man procmailex</b></pre>
</div></div>

</body></html>