<html><head></head><body><section class="chapter" epub:type="chapter" id="system_maintenance" title="Chapter&#xA0;15.&#xA0;System Maintenance"><div class="titlepage"><div><div><h2 class="title">Chapter 15. System Maintenance</h2></div></div></div><div class="epigraph" epub:type="epigraph"><div class="literallayout"><p><span class="emphasis"><em>When hardware complains,</em></span><br/>
<span class="emphasis"><em>OpenBSD listens.</em></span><br/>
<span class="emphasis"><em>You should listen too.</em></span></p></div></div><p><a class="indexterm" id="idx2018"/><a class="indexterm" id="idx2329"/><a class="indexterm" id="idx2339"/><a class="indexterm" id="idx2369"/><span class="inlinemediaobject"><a id="inline_id00016"/><img alt="" src="httpatomoreillycomsourcenostarchimages1616079.png"/></span> No computer runs itself. If it did, you would be out of a job. Even the best-configured server generates a constant low burn of maintenance needs.</p><p>OpenBSD includes a variety of tools to make maintenance easier, to alert you when maintenance is needed, and to tell you about the system’s status. Every day, week, and month, OpenBSD performs maintenance tasks and notifies you of the results. OpenBSD takes daily backups of critical system features and files, and uses them to monitor system integrity. It can manage its own log files, keep its own time, and alert you when the hardware is failing.</p><p>All of this starts with scheduled maintenance.</p><div class="sect1" title="Scheduled Tasks"><div class="titlepage"><div><div><h2 class="title" id="scheduled_tasks" style="clear: both">Scheduled Tasks</h2></div></div></div><p>OpenBSD includes scheduled tasks that run once a day, week, and month. These jobs run as root and email the results to root. The daily maintenance script is the most complicated; the monthly script is the simplest.</p><p><a class="indexterm" id="idx0362"/><a class="indexterm" id="idx0363"/><a class="indexterm" id="idx0568"/><a class="indexterm" id="idx0582"/><a class="indexterm" id="idx1991"/><a class="indexterm" id="idx2020"/><a class="indexterm" id="idx2075"/><a class="indexterm" id="idx2341"/>If a server runs well, I might not log in to it for weeks or even months. In fact, I’ve had a few servers run for more than a year without a human being ever logging in to it. I read the daily reports from the machine and say “Yep, it’s okay,” and get on with my day, confident that what the regular status reports don’t tell me the monitoring system will.</p><p>The scheduled maintenance jobs email their results to the local root user, but if no one ever logs in to the machine, no one will see those results. Always set an email alias for root in <span class="emphasis"><em>/etc/aliases</em></span>, so that these messages go to someone who will actually read them.</p><p>Reading every email message from every machine every day is annoying, but much less annoying than finding out that I have a bad service by a user telling me about it. These messages often alert me to system problems before anyone (including me) notices them. Sites with hundreds of machines often write scripts to parse incoming email messages and flag interesting details.</p><p>You should send maintenance email to the person ultimately responsible for the system—whoever is most interested in system changes and most likely to be aware of any day-to-day system changes. If you delegate the job of reading maintenance email to a minion who is less aware of the system, he will either annoy you with endless questions about what you did yesterday or learn to ignore anything actually in the status mail messages.</p><p>Here, we’ll take a look at how the daily, weekly, and monthly routines work. Complete documentation of the maintenance jobs appears in <code class="literal">daily(8)</code>.</p><div class="sect2" title="Daily Maintenance"><div class="titlepage"><div><div><h3 class="title" id="daily_maintenance">Daily Maintenance</h3></div></div></div><p>The daily maintenance job starts by running any custom maintenance jobs (covered at the end of this section) from <span class="emphasis"><em>/etc/daily.local</em></span>. Daily maintenance includes checking partitions, running the reminder service <code class="literal">calendar(1)</code>, running <code class="literal">rdist(1)</code>, removing scratch files, and a few other boring things.</p><p>OpenBSD can also do a few other interesting things as part of its daily maintenance:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Create a backup root filesystem, <span class="emphasis"><em>/altroot</em></span>.</p></li><li class="listitem"><p>Perform system security checks.</p></li><li class="listitem"><p>Back up vital system files in <span class="emphasis"><em>/var/backup</em></span>.</p></li><li class="listitem"><p>Check for changes in vital system files.</p></li><li class="listitem"><p>Check filesystem integrity.</p></li><li class="listitem"><p>Run <code class="literal">rdist(1)</code>.</p></li></ul></div><p>I discussed <span class="emphasis"><em>/altroot</em></span> in <a class="xref" href="ch09.html" title="Chapter 9. More Filesystems">Chapter 9</a> because it requires a dedicated filesystem partition. Each of the other tasks can be configured later.</p><div class="sect3" title="Security Checks"><div class="titlepage"><div><div><h4 class="title" id="security_checks">Security Checks</h4></div></div></div><p>Some things that go wrong don’t necessarily mean your system has experienced an intrusion, but are nonetheless suspicious. The daily security check looks for a whole slew of misconfigurations and problems that arise from either malice or incompetence. You can read the list of checks in <code class="literal">security(8)</code>, but they break down into fairly broad categories:</p><div class="blockquote" title="Device node changes and privileges"><blockquote class="blockquote" title="Device node changes and privileges"><div class="blockquote-title">Device node changes and privileges</div><p>New device nodes, changed permissions on device nodes, new software packages, and new or altered disks or partitions might indicate malicious activity or might just be normal system management. The security script flags all of these. If you made such changes, you’ll nod and go on with your day. If you requested a minion perform the change and the change doesn’t appear, this is when you ask them what they did all day yesterday. If you didn’t make a change that appears, you want to know about it.</p></blockquote></div><div class="blockquote" title="Insecure NFS exports"><blockquote class="blockquote" title="Insecure NFS exports"><div class="blockquote-title">Insecure NFS exports</div><p>OpenBSD includes a lot of software to export filesystems and run commands remotely. These services, like printing and NFS, should not allow access from any host just anywhere, but only from hosts you approve. The security job checks for configurations that permit global access.</p></blockquote></div><div class="blockquote" title="Misconfigured accounts"><blockquote class="blockquote" title="Misconfigured accounts"><div class="blockquote-title">Misconfigured accounts</div><p>Another popular attack route has been the password database and related files. Accounts without passwords, duplicate entries, improperly closed accounts, and so on could all be used to compromise a system. The script checks for these issues.</p></blockquote></div><div class="blockquote" title="Permissions"><blockquote class="blockquote" title="Permissions"><div class="blockquote-title">Permissions</div><p>Poor permissions can lead to privilege escalation. For example, is there a new <code class="literal">setuid</code> or <code class="literal">setgid</code> file on the system? If so, the security script notifies you. If you installed that file with those privileges, you’re okay. If it’s unexpected, you should investigate.</p></blockquote></div><div class="blockquote" title="User environment"><blockquote class="blockquote" title="User environment"><div class="blockquote-title">User environment</div><p>If you can change a user’s environment, whether that’s root or another account, you can trick him into giving away his authentication credentials or running suspect commands. If an intruder can edit a user’s dotfiles, like <span class="emphasis"><em>.cshrc</em></span> or <span class="emphasis"><em>.login</em></span>, he can change which versions of a command he runs. Perhaps his shell is set to run a program that asks the user for his password and sends it to the intruder’s anonymous email account. By having correct permissions on home directories, dotfiles, mail files, and so on, you make this class of attack more difficult. The security script verifies that permissions are set up correctly.</p></blockquote></div><p>Note that the security check is <span class="emphasis"><em>not</em></span> an intrusion-detection system. The changes it checks for are the sort that script kiddies and newbie intruders are most likely to make, but skilled intruders familiar with OpenBSD could get around it. They could even replace the security check with a shell script that sends a daily email message that looks like an innocuous security check.</p><p><a class="indexterm" id="idx0104"/><a class="indexterm" id="idx0576"/><a class="indexterm" id="idx2583"/>Fortunately, competent intruders are relatively rare. Just keep in mind that receiving a security check with no mention of problems is encouraging, but it’s not proof that your server is secure.</p></div><div class="sect3" title="Vital File Backup and Testing"><div class="titlepage"><div><div><h4 class="title" id="vital_file_backup_and_testing">Vital File Backup and Testing</h4></div></div></div><p>The daily security check tests for changes in the files listed in <span class="emphasis"><em>/etc/changelist</em></span> and rotates their backups, since these files are generally critical system files, such as <span class="emphasis"><em>/etc/master.passwd</em></span>, <span class="emphasis"><em>/etc/boot.conf</em></span>, and <span class="emphasis"><em>/var/cron/tabs/root</em></span>. It also checks for changes to disk partitioning and mounted filesystems, as well as changes to device nodes.</p><p>Look in <span class="emphasis"><em>/var/backups</em></span>, and you’ll see files like this:</p><a id="I_programlisting15_id474956"/><pre class="programlisting">…
etc_fstab.backup
etc_fstab.current
etc_ftpchroot.current
etc_ftpusers.current
…</pre><p>The files ending in <span class="emphasis"><em>.current</em></span> are copies of these files as they existed when the daily maintenance job was last run. The files ending in <span class="emphasis"><em>.backup</em></span> are the previous version of those files.</p><p>The first time the security script runs, it copies all of these files to <span class="emphasis"><em>/var/backup</em></span>. Following that initial setup, the security script checks the original file against the current copy for changes. If the file changes, the previous version of the file is copied to the <span class="emphasis"><em>.backup</em></span> filename, and the new version is copied to the <span class="emphasis"><em>.current</em></span> file.</p><p>In the preceding example, the list shows that I edited my <span class="emphasis"><em>/etc/fstab</em></span> at some time, prompting the security script to move its copy of the old filesystem table to a <span class="emphasis"><em>.backup</em></span> file. I have never edited <span class="emphasis"><em>/etc/ftpchroot</em></span> or <span class="emphasis"><em>/etc/ftpusers</em></span>, so there is no <span class="emphasis"><em>.backup</em></span> version of these files, but only the <span class="emphasis"><em>.current</em></span> one.</p><p>The security script doesn’t copy all of the files that it watches. For example, files containing private keys or that might contain private keys are not copied, but the security script does take a checksum. (Files monitored by checksum have a plus sign before their name in <span class="emphasis"><em>/etc/changelist</em></span>.) There’s no reason to manually edit <span class="emphasis"><em>/etc/ssh/ssh_host_ecdsa_key</em></span>, and if the file changes, either you know why or you need to restore from a trusted backup.</p><p><span class="emphasis"><em>/etc/changelist</em></span> is itself listed in <span class="emphasis"><em>/etc/changelist</em></span>. This seems recursive, but the system backs up the list of files you want backed up, and also notifies you when someone adds or removes a file in <span class="emphasis"><em>/etc/changelist</em></span>.</p></div><div class="sect3" title="Adding Vital Files"><div class="titlepage"><div><div><h4 class="title" id="adding_vital_files">Adding Vital Files</h4></div></div></div><p>You can add files to the change list and even use wildcards to back up all the files in a directory. But note that if you did use wildcards in <span class="emphasis"><em>/etc/changelist</em></span>, you won’t be notified when a file is removed.</p><p><a class="indexterm" id="idx0300"/><a class="indexterm" id="idx0579"/><a class="indexterm" id="idx0833"/><a class="indexterm" id="idx0846"/><a class="indexterm" id="idx1926"/>Consider this example of using wildcards. In <a class="xref" href="ch13.html" title="Chapter 13. Software Management">Chapter 13</a>, I added the <code class="literal">apache2</code> port to one of my machines. I put the configuration files in <span class="emphasis"><em>/etc/apache2</em></span>. I could add a line like this to the change list:</p><a id="I_programlisting15_id475124"/><pre class="programlisting">/etc/apache2/*</pre><p>This would automatically copy all files in the <span class="emphasis"><em>apache2</em></span> configuration directory to <span class="emphasis"><em>/var/backup</em></span> and test them for changes. However, I would not be notified when files are removed from this directory. If you’re using a configuration mechanism that says, “include all the <span class="emphasis"><em>.conf</em></span> files in such-and-such directory,” this might not be desirable. A better option would be to list each file individually and update the list when you add critical files.</p><p>One of the most convenient things about the file-integrity check is that it automatically creates a local backup of critical system files. That means that if you decide to learn how to use <code class="literal">vipw(8)</code> and utterly trash your user database in doing so, you can grab yesterday’s copy out of <span class="emphasis"><em>/var/backups</em></span>, install it, and no one will be the wiser. The same applies to every other critical system file.</p></div><div class="sect3" title="Filesystem Integrity Checks"><div class="titlepage"><div><div><h4 class="title" id="filesystem_integrity_checks">Filesystem Integrity Checks</h4></div></div></div><p>You can’t run a full-on Unix File System (UFS) check while a system is in multiuser mode, but you can have <code class="literal">fsck(8)</code> perform filesystem integrity checks to try to identify problems before they’re serious. Doing so won’t fix any problems, but it will notify you that they exist so you can schedule downtime for repairs.</p><p>To enable these checks, set <code class="literal">CHECKFILESYSTEMS</code> to <code class="literal">1</code> in <span class="emphasis"><em>/etc/daily.local</em></span>.</p></div><div class="sect3" title="Copying Files with rdist"><div class="titlepage"><div><div><h4 class="title" id="copying_files_with_rdist">Copying Files with rdist</h4></div></div></div><p>The <code class="literal">rdist(1)</code> program is used to copy files to other servers, letting you maintain identical copies of critical files on many servers. If you’re interested in using it, see <code class="literal">rdistd(8)</code>.</p></div><div class="sect3" title="Silencing /etc/daily"><div class="titlepage"><div><div><h4 class="title" id="silencing_etc_daily">Silencing /etc/daily</h4></div></div></div><p>Some of us have monitoring systems that track a server’s disk, network, and other basic information. If you don’t need this sort of information to appear in your daily status mail, set <code class="literal">VERBOSESTATUS</code> to <code class="literal">0</code> in <span class="emphasis"><em>/etc/daily.local</em></span>. This turns off these parts of daily maintenance, reducing the amount you need to read.</p><p>If the remaining daily maintenance doesn’t generate any output, the server should not send a status email that day. In environments where you don’t trust the monitoring system, you could use the daily status messages to assure you that the system is running as expected. OpenBSD gives you the choice.</p></div></div><div class="sect2" title="Weekly Maintenance"><div class="titlepage"><div><div><h3 class="title" id="weekly_maintenance">Weekly Maintenance</h3></div></div></div><p><a class="indexterm" id="idx1235"/><a class="indexterm" id="idx1386"/><a class="indexterm" id="idx2019"/><a class="indexterm" id="idx2021"/><a class="indexterm" id="idx2022"/><a class="indexterm" id="idx2030"/><a class="indexterm" id="idx2340"/><a class="indexterm" id="idx2342"/><a class="indexterm" id="idx2343"/><a class="indexterm" id="idx2344"/><a class="indexterm" id="idx2642"/>The weekly script is simpler than the daily script with only three common functions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>First, it runs the custom weekly script <span class="emphasis"><em>/etc/weekly.local</em></span>.</p></li><li class="listitem"><p>Second, it updates the <code class="literal">locate(1)</code> database.</p></li><li class="listitem"><p>Finally, it rebuilds the <code class="literal">whatis(1)</code> man page database.</p></li></ul></div></div><div class="sect2" title="Monthly Maintenance"><div class="titlepage"><div><div><h3 class="title" id="monthly_maintenance">Monthly Maintenance</h3></div></div></div><p>OpenBSD doesn’t need any generic monthly maintenance, but for consistency, the <span class="emphasis"><em>/etc/monthly</em></span> script runs the custom script <span class="emphasis"><em>/etc/monthly.local</em></span>.</p></div><div class="sect2" title="Custom Maintenance Scripts"><div class="titlepage"><div><div><h3 class="title" id="custom_maintenance_scripts">Custom Maintenance Scripts</h3></div></div></div><p>Each maintenance script runs a custom script before performing any other tasks. You can put any tasks you need in <span class="emphasis"><em>/etc/daily.local</em></span>, <span class="emphasis"><em>/etc/weekly.local</em></span>, and <span class="emphasis"><em>/etc/monthly.local</em></span>. These commands are run by root, so don’t use them for tasks that should be performed by another user. If your database needs to be backed up, create a separate script, and have the unprivileged user running your database run that script via <code class="literal">cron(8)</code>.</p><p>Some sites use the scheduled maintenance jobs to run complex software that perform site-specific duties. For example, I know of one security firm that collects data from hundreds of machines, and uses the daily jobs to send that data to a central management system. Really, you can use the local scripts any way you choose.</p><p>If you have a maintenance task that can run under another user account, but you want to attach it to the scheduled maintenance jobs, you can have the local script call another script. Start that script by using <code class="literal">su(1)</code> to switch users and drop privileges.</p><p>Custom maintenance scripts may be most useful for altering the way the standard maintenance scripts perform their work. For example, say you have a system with many scratch directories containing temporary files. The weekly maintenance script updates the locate database, but you don’t want these scratch files included in locate results. You could use a custom maintenance script to remove all the scratch files immediately before <span class="emphasis"><em>/etc/weekly</em></span> creates the new locate database, and schedule this as a separate task. By adding it to <span class="emphasis"><em>/etc/weekly.local</em></span>, you would know that it will finish before <span class="emphasis"><em>/etc/weekly</em></span> runs any other tasks.</p></div></div><div class="sect1" title="System Logs"><div class="titlepage"><div><div><h2 class="title" id="system_logs" style="clear: both">System Logs</h2></div></div></div><p>The system log used by Unix-like operating systems has become the industry standard for logging, but that’s not necessarily a good thing, because the log mechanism can be cantankerous. Once you properly configure log collection and rotation, however, OpenBSD’s logging system mostly manages itself.</p><p><a class="indexterm" id="idx0084"/><a class="indexterm" id="idx0093"/><a class="indexterm" id="idx0308"/><a class="indexterm" id="idx0360"/><a class="indexterm" id="idx0806"/><a class="indexterm" id="idx0900"/><a class="indexterm" id="idx1136"/><a class="indexterm" id="idx1207"/><a class="indexterm" id="idx1239"/><a class="indexterm" id="idx1247"/><a class="indexterm" id="idx1268"/><a class="indexterm" id="idx1324"/><a class="indexterm" id="idx1527"/><a class="indexterm" id="idx2306"/><a class="indexterm" id="idx2307"/><a class="indexterm" id="idx2326"/><a class="indexterm" id="idx2348"/><a class="indexterm" id="idx2532"/><a class="indexterm" id="idx2580"/>OpenBSD uses the standard logging system for Unix-like (and many embedded) systems, <code class="literal">syslog(3)</code>. The syslog protocol marks messages with a facility and a priority, and hands those messages to a daemon.</p><p>Any program can write to the local <code class="literal">syslogd(8)</code> server, but the key in log management is deciding how those messages are sorted and stored. OpenBSD’s <code class="literal">syslogd</code> can sort messages based on facility, priority, and source program.</p><div class="sect2" title="Facilities"><div class="titlepage"><div><div><h3 class="title" id="facilities">Facilities</h3></div></div></div><p>A <span class="emphasis"><em>facility</em></span> indicates the source of a message. In most cases, each program that needs a separate log file uses a different facility. Many programs or protocols, such as FTP, have facilities dedicated to them. The syslog protocol also has a variety of generic facilities that you can use as you wish.</p><p><a class="xref" href="ch15.html#standard_openbsd_facilities" title="Table 15-1. Table 15-1: Standard OpenBSD Facilities">Table 15-1</a> lists the standard facilities and provides some notes on their usage.</p><div class="table"><a id="standard_openbsd_facilities"/><div class="table-title">Table 15-1. Table 15-1: Standard OpenBSD Facilities</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="c1"/><col class="c2"/></colgroup><thead><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Facility</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Usage</p></td></tr></thead><tbody><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">auth</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Public information about authentication, such as when someone logged on or when someone uses <code class="literal">su</code>.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">authpriv</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Private information about user authentication, normally accessible only to privileged users.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">cron</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Messages from the system scheduler <code class="literal">cron(8)</code>.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">daemon</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>A catchall for processes that neither need nor require a dedicated facility.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">ftp</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Messages from FTP and Trivial File Transfer Protocol (TFTP) servers.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">kern</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Kernel-generated messages.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">local0</code> through <code class="literal">local7</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>These facilities are provided for the sysadmin. Many programs let sysadmins configure their facility. Use these eight facilities for such programs.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">lpr</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Messages from the printing system.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">mail</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Messages from mail servers.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">mark</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>This special facility writes a message every 20 minutes.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">news</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Messages from Usenet news servers.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">syslog</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Messages from the syslog server itself.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p><code class="literal">user</code></p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>The catchall message facility. If a userland program doesn’t specify a logging facility, the messages wind up here.</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; "><p><code class="literal">uucp</code></p></td><td style="vertical-align: top; "><p>Messages from the Unix-to-Unix Copy Protocol (UUCP) servers. You will probably never encounter this pre-Internet email protocol.</p></td></tr></tbody></table></div></div><p>While most programs have sensible defaults, it’s your job as the system administrator to manage which programs log to which facilities. If possible, use the local facilities for your server-specific daemons. While it’s entirely possible to use facilities for purposes other than originally intended, try not to reassign the <code class="literal">uucp</code> facility to some other daemon unless you really have no other option.</p></div><div class="sect2" title="Priority"><div class="titlepage"><div><div><h3 class="title" id="priority">Priority</h3></div></div></div><p><a class="indexterm" id="idx0770"/><a class="indexterm" id="idx1240"/><a class="indexterm" id="idx1241"/><a class="indexterm" id="idx1868"/><a class="indexterm" id="idx2192"/><a class="indexterm" id="idx2290"/><a class="indexterm" id="idx2327"/><a class="indexterm" id="idx2328"/><a class="indexterm" id="idx2349"/><a class="indexterm" id="idx2350"/>A log message’s priority represents its importance. Programs usually send their logging data to <code class="literal">syslogd</code>, but <code class="literal">syslogd</code> decides what to retain and what to discard. You get to decide how much detail you want in your logs. Use the following nine <code class="literal">syslog</code> levels to decide what to record and what to discard (in order from most to least important):</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none"><p title="emerg"><span class="title"><strong><span class="strong"><strong><code class="literal">emerg</code></strong></span></strong></span>. System emergency. This message appears on every active terminal. The computer might be crashing, or it may have some other error that requires immediate attention.</p></li><li class="listitem" style="list-style-type: none"><p title="alert"><span class="title"><strong><span class="strong"><strong><code class="literal">alert</code></strong></span></strong></span>. An emergency. The system can continue to function, but attend to this error very soon.</p></li><li class="listitem" style="list-style-type: none"><p title="critical"><span class="title"><strong><span class="strong"><strong><code class="literal">critical</code></strong></span></strong></span>. Critical problems. These indicate serious errors, such as hard-drive failures.</p></li><li class="listitem" style="list-style-type: none"><p title="err"><span class="title"><strong><span class="strong"><strong><code class="literal">err</code></strong></span></strong></span>. Errors. These are in regard to problems that require attention but won’t destroy your system.</p></li><li class="listitem" style="list-style-type: none"><p title="warning"><span class="title"><strong><span class="strong"><strong><code class="literal">warning</code></strong></span></strong></span>. Miscellaneous warnings. These could be attended to, but will not prevent the process that generated them from running normally.</p></li><li class="listitem" style="list-style-type: none"><p title="notice"><span class="title"><strong><span class="strong"><strong><code class="literal">notice</code></strong></span></strong></span>. Important information, such as daemon startup and shutdown notifications.</p></li><li class="listitem" style="list-style-type: none"><p title="info"><span class="title"><strong><span class="strong"><strong><code class="literal">info</code></strong></span></strong></span>. Basic information. This usually includes transactional data, such as individual messages in a mail server or individual queries to a web server.</p></li><li class="listitem" style="list-style-type: none"><p title="debug"><span class="title"><strong><span class="strong"><strong><code class="literal">debug</code></strong></span></strong></span>. Trivia. This level is usually of interest only to programmers, but occasionally useful to sysadmins trying to figure out why a program is behaving in a certain way. Debugging logs can contain anything, including information that violates user privacy, such as plaintext passwords.</p></li><li class="listitem" style="list-style-type: none"><p title="none"><span class="title"><strong><span class="strong"><strong><code class="literal">none</code></strong></span></strong></span>. Don’t log anything from this facility here. This is most commonly used to exclude information from log files, as discussed shortly.</p></li></ul></div><p>By combining levels with priority, you can sort log messages into individual files or other targets.</p></div><div class="sect2" title="Sorting Messages via syslogd(8)"><div class="titlepage"><div><div><h3 class="title" id="sorting_messages_via_syslogd8">Sorting Messages via syslogd(8)</h3></div></div></div><p><code class="literal">syslogd</code> compares received messages to entries in <span class="emphasis"><em>/etc/syslog.conf</em></span>. This file has two columns: the first (the <span class="emphasis"><em>selector</em></span>) describes a type of log message, and the second (the <span class="emphasis"><em>action</em></span>) tells <code class="literal">syslogd</code> what to do when a message matches the description. Neither column can have whitespace; whitespace can appear only between the columns. For example, here’s a line from the default <span class="emphasis"><em>syslog.conf</em></span>:</p><a id="I_programlisting15_id476345"/><pre class="programlisting">daemon.info            /var/log/daemon</pre><p><a class="indexterm" id="idx0001"/><a class="indexterm" id="idx0077"/><a class="indexterm" id="idx0807"/><a class="indexterm" id="idx2325"/>Any log message that has a facility of daemon and a priority of <code class="literal">info</code> or higher is appended to the file <span class="emphasis"><em>/var/log/daemon</em></span>. Of course, if all logs were so easily managed, this would be a short section.</p><p><code class="literal">syslogd</code> compares all log messages to all <span class="emphasis"><em>syslog.conf</em></span> entries. If a log message matches multiple selectors, it is sent to all matching destinations.</p><div class="sect3" title="Wildcards"><div class="titlepage"><div><div><h4 class="title" id="wildcards">Wildcards</h4></div></div></div><p>You can use wildcards in either the facility or priority. For example, this line logs every message from the mail facility:</p><a id="I_programlisting15_id476418"/><pre class="programlisting">mail.*            /var/log/maillog</pre><p>To capture messages of a given priority or higher from all facilities, use an asterisk (<code class="literal">*</code>). Here’s how to send all priority <code class="literal">err</code> and higher messages to the console:</p><a id="I_programlisting15_id476434"/><pre class="programlisting">*.err    /dev/console</pre><p>You can also use a double-wildcard to send all log messages to one place.</p><a id="I_programlisting15_id476442"/><pre class="programlisting">*.*    /var/log/all.log</pre><p>Logging everything to one location isn’t terribly useful or wise. You should <span class="emphasis"><em>not</em></span> send <code class="literal">authpriv</code> debugging to a world-readable file.</p></div><div class="sect3" title="Excluding Information"><div class="titlepage"><div><div><h4 class="title" id="excluding_information">Excluding Information</h4></div></div></div><p>Use the <code class="literal">none</code> level to exclude information from a log. For example, the following line excludes private authentication information from an otherwise all-inclusive log.</p><a id="I_programlisting15_id476475"/><pre class="programlisting">*.*;authpriv.none    /var/log/most.log</pre><p>The semicolon (<code class="literal">;</code>) allows you to combine selection criteria on a single line.</p><div class="warning" epub:type="warning" title="Warning"><h3 class="title"><a id="ch15note01"/>Warning</h3><p>If you combine entries with a semicolon like this, do not put whitespace after the semicolon. The only whitespace can appear between the selector and the destination.</p></div></div><div class="sect3" title="Combining Facilities"><div class="titlepage"><div><div><h4 class="title" id="combining_facilities">Combining Facilities</h4></div></div></div><p>You can combine multiple facilities in a single entry by using commas. Here’s how to capture all messages of <code class="literal">info</code> priority or higher from several facilities:</p><a id="I_programlisting15_id476515"/><pre class="programlisting">auth,daemon,syslog,user.info    @loghost</pre><p>Any log message from the <code class="literal">auth</code>, <code class="literal">daemon</code>, <code class="literal">syslog</code>, and <code class="literal">user</code> facilities, and of priority <code class="literal">info</code> or higher, is sent across the network to the host <code class="literal">loghost</code>.</p></div><div class="sect3" title="Marking Time"><div class="titlepage"><div><div><h4 class="title" id="marking_time">Marking Time</h4></div></div></div><p><a class="indexterm" id="idx1325"/><a class="indexterm" id="idx1879"/><a class="indexterm" id="idx2322"/><a class="indexterm" id="idx2432"/>While all log messages have a timestamp, you might want a marker in a log file to indicate that time has passed. The special facility <code class="literal">mark</code> creates a message every 20 minutes, letting you add an extra timestamp to a file. Here’s how to add a timestamp to the mail log every 20 minutes:</p><a id="I_programlisting15_id476591"/><pre class="programlisting">mail.info;mark.info    /var/log/maillog</pre></div><div class="sect3" title="Local Facilities"><div class="titlepage"><div><div><h4 class="title" id="local_facilities">Local Facilities</h4></div></div></div><p>The eight facilities <code class="literal">local0</code> through <code class="literal">local7</code> are for your use. Many programs can be configured to use a specific facility, so you can aim them at a particular file. I’ve configured a daemon to use the facility <code class="literal">local7</code>. Here, I send messages from that facility to a file:</p><a id="I_programlisting15_id476621"/><pre class="programlisting">local7.*    /var/log/postgres.log</pre><p>Some programs have a hard-coded preference for a specific facility. For example, the flow-tools package (see my book <span class="emphasis"><em>Network Flow Analysis</em></span>, No Starch Press, 2010) has facility <code class="literal">local6</code> hard-wired into the code. Don’t be shocked when you see something like this. Fortunately, OpenBSD’s <code class="literal">syslogd</code> can filter based on program name, so you can easily filter your logs despite this sort of daftness.</p></div><div class="sect3" title="Selecting by Program Name"><div class="titlepage"><div><div><h4 class="title" id="selecting_by_program_name">Selecting by Program Name</h4></div></div></div><p>If you’re out of facilities, you can use the name of the program generating the syslog messages as a selector. Using a program name requires two lines: The first contains the program name with a leading exclamation mark, and the second sets up logging. OpenBSD offers the following example of <code class="literal">sudo(8)</code> logging:</p><a id="I_programlisting15_id476663"/><pre class="programlisting">!sudo
*.*    /var/log/sudo</pre><p>All log messages from <code class="literal">sudo</code> go to the specified log file.</p><p>You can also select by program name and stop all subsequent selections of matching messages by using two exclamation points (<code class="literal">!!</code>) before the program name. This example sends all messages from <code class="literal">sudo</code> to <span class="emphasis"><em>/var/log/sudo</em></span>, but prevents <code class="literal">sudo</code> messages from going to any other log.</p><a id="I_programlisting15_id476694"/><pre class="programlisting">!!sudo
   *.*    /var/log/sudo
!*
…</pre><p><a class="indexterm" id="idx0835"/><a class="indexterm" id="idx1236"/><a class="indexterm" id="idx2182"/><a class="indexterm" id="idx2321"/><a class="indexterm" id="idx2345"/><a class="indexterm" id="idx2551"/>The <code class="literal">!*</code> after the end of the <code class="literal">sudo</code> entry is a way to say “all programs”—in other words, don’t sort by program name anymore. You need this only if you use the double-exclamation-point “stop processing matching messages here” syntax.</p></div></div><div class="sect2" title="Log Actions"><div class="titlepage"><div><div><h3 class="title" id="log_actions">Log Actions</h3></div></div></div><p>Now that you know how to sort your log messages into different buckets, let’s see how to take different actions with those messages. Messages can be written to a file, piped to a program, sent to another host, or written to users.</p><div class="sect3" title="Logging to Files"><div class="titlepage"><div><div><h4 class="title" id="logging_to_files">Logging to Files</h4></div></div></div><p>Most of our examples so far send log messages to a file, giving the full path to the file as the action. Here’s how to send all of the messages from facility <code class="literal">local6</code> to a log file:</p><a id="I_programlisting15_id476796"/><pre class="programlisting">local6.*    /var/log/flowtools</pre><p>You can also send the messages to a device by giving the full path to the device node, but this will make sense to very few devices, such as the console. This is because writing the log message to the disk device <span class="emphasis"><em>/dev/wd0d</em></span> will not store the message on disk.</p></div><div class="sect3" title="Logging to a Program"><div class="titlepage"><div><div><h4 class="title" id="logging_to_a_program">Logging to a Program</h4></div></div></div><p>To send selected logs to a program, use a pipe (<code class="literal">|</code>) and the full path to the program, like this:</p><a id="I_programlisting15_id476826"/><pre class="programlisting">*.*    |/usr/local/bin/logsurfer</pre><p>The logging system should start the destination program, and then feed log messages into the program’s standard input.</p></div><div class="sect3" title="Notifying Users"><div class="titlepage"><div><div><h4 class="title" id="notifying_users">Notifying Users</h4></div></div></div><p>You can also direct log messages to logged-in users by listing multiple users in a comma-separated list. For example, to send a message to all users, use an asterisk.</p><a id="I_programlisting15_id476850"/><pre class="programlisting">*.emerg    *
*.info    lasnyder</pre><p>This example will notify all logged-in users of real emergencies, but deeply annoy <code class="literal">lasnyder</code>.<sup>[<a class="footnote" epub:type="noteref" href="#ftn.id367882" id="id367882">41</a>]</sup></p></div><div class="sect3" title="Logging to a Remote Host"><div class="titlepage"><div><div><h4 class="title" id="logging_to_a_remote_host">Logging to a Remote Host</h4></div></div></div><p><a class="indexterm" id="idx0002"/><a class="indexterm" id="idx1220"/><a class="indexterm" id="idx1222"/><a class="indexterm" id="idx1223"/><a class="indexterm" id="idx1237"/><a class="indexterm" id="idx1953"/><a class="indexterm" id="idx2309"/><a class="indexterm" id="idx2323"/><a class="indexterm" id="idx2346"/>I usually have a logging host that collects log messages from everywhere—not only from my OpenBSD boxes, but from all my other Unix-like systems, as well as routers, switches, and anything else that speaks syslog. This reduces my maintenance needs and conserves disk space. And, since, every log message includes a hostname, I can easily sort them out later.</p><p>To send messages to another host, use the <code class="literal">@</code> symbol.</p><a id="I_programlisting15_id476976"/><pre class="programlisting">*.info    @loghost.blackhelicopters.org</pre><p>This dumps everything of priority <code class="literal">info</code> and above to my logging host.</p><p>Your logging host must accept syslog messages from the network. If your host is an OpenBSD machine, run <code class="literal">syslogd</code> with the <code class="literal">-u</code> flag. And be sure to protect your log host with a packet filter, so random hosts can’t write logs to it and fill up your disks.</p></div></div><div class="sect2" title="Customizing syslogd"><div class="titlepage"><div><div><h3 class="title" id="customizing_syslogd">Customizing syslogd</h3></div></div></div><p>OpenBSD runs <code class="literal">syslogd</code> by default, and you can customize how <code class="literal">syslogd</code> behaves. Common customizations include adding more log sockets and listening to the network.</p><div class="sect3" title="Adding Extra Log Sockets"><div class="titlepage"><div><div><h4 class="title" id="adding_extra_log_sockets">Adding Extra Log Sockets</h4></div></div></div><p>Programs write log messages to the socket <span class="emphasis"><em>/dev/log</em></span>, but software inside a <code class="literal">chroot</code> won’t be able to access that device. To have a program that’s locked inside a <code class="literal">chroot</code> send messages to <code class="literal">syslogd</code>, you must put an additional log socket at <span class="emphasis"><em>/dev/log</em></span> inside the <code class="literal">chroot</code>.</p><p>For example, since the integrated BIND DNS server is <code class="literal">chroot</code>ed into <span class="emphasis"><em>/var/named</em></span>, the DNS server expects to find the log socket at <span class="emphasis"><em>/dev/log</em></span>, which means that the new log socket should be at <span class="emphasis"><em>/var/named/dev/log</em></span>. To create this log socket, use <code class="literal">syslogd</code>’s <code class="literal">-a</code> option, and give the full path to the log socket in <span class="emphasis"><em>/etc/rc.conf.local</em></span>.</p><a id="I_programlisting15_id477090"/><pre class="programlisting">syslogd_flags="-a /var/named/dev/log"</pre><p>You can use about 20 additional logging sockets.</p></div><div class="sect3" title="Listening to the Network"><div class="titlepage"><div><div><h4 class="title" id="listening_to_the_network">Listening to the Network</h4></div></div></div><p>If you want your OpenBSD box to act as a log host, accepting logs from remote hosts, use the <code class="literal">-u</code> flag.</p><a id="I_programlisting15_id477115"/><pre class="programlisting">syslogd_flags="-u"</pre><p>Because the syslog protocol has no access control, anyone with access to port 514/UDP on the log host can write to your log files.</p><div class="note" title="Note"><h3 class="title"><a id="ch15note02"/>Note</h3><p><a class="indexterm" id="idx0547"/><a class="indexterm" id="idx1212"/><a class="indexterm" id="idx1219"/><a class="indexterm" id="idx1238"/><a class="indexterm" id="idx1347"/><a class="indexterm" id="idx2289"/><a class="indexterm" id="idx2324"/><a class="indexterm" id="idx2334"/><a class="indexterm" id="idx2347"/>Filling a host’s logs with junk to fill the hard disk is an old attack. Use OpenBSD’s packet filtering system (discussed in <a class="xref" href="ch21.html" title="Chapter 21. Packet Filtering">Chapter 21</a> and <a class="xref" href="ch22.html" title="Chapter 22. Advanced PF">Chapter 22</a>) to protect your logging host.</p></div></div></div><div class="sect2" title="Syslog and Embedded Systems"><div class="titlepage"><div><div><h3 class="title" id="syslog_and_embedded_systems">Syslog and Embedded Systems</h3></div></div></div><p>OpenBSD supports writing log messages to an in-memory buffer, which allows logging on systems that have no writable disk, such as diskless systems and embedded routers and firewalls. <code class="literal">syslogd</code> retains these logs in a memory buffer, and clients can connect to <code class="literal">syslogd</code> through a reporting socket and read the logs. As you would expect, logs in memory disappear when <code class="literal">syslogd</code> is shut down.</p><p>To use <code class="literal">syslogd</code> for reporting, first provide a reporting socket with the <code class="literal">-s</code> option and give it a full path to a reporting socket. Here’s an <span class="emphasis"><em>rc.conf.local</em></span> entry for a reporting socket in <span class="emphasis"><em>/var/run/syslog</em></span>:</p><a id="I_programlisting15_id477271"/><pre class="programlisting">syslogd_flags="-s /var/run/syslog"</pre><p>To log to the buffer, make a <span class="emphasis"><em>syslog.conf</em></span> action. Specify logging to a buffer with a colon (<code class="literal">:</code>), the number of kilobytes to give the buffer, another colon, and the name of the memory buffer. (The maximum buffer size is 256KB.)</p><p>For example, here we capture all log messages of <code class="literal">err</code> priority or higher and write them to the 128KB memory buffer called <code class="literal">errors</code>:</p><a id="I_programlisting15_id477300"/><pre class="programlisting">*.err    :128:errors</pre><p>Use <code class="literal">syslogc(8)</code> to read a memory buffer, and use the <code class="literal">-s</code> option to tell <code class="literal">syslogc</code> where to find <code class="literal">syslogd</code>’s reporting socket, and provide the name of the log buffer. Here’s how to read the reporting socket <span class="emphasis"><em>/var/run/syslog</em></span> and read the <code class="literal">errors</code> buffer:</p><a id="I_programlisting15_id477331"/><pre class="programlisting">$ <span class="strong"><strong>syslogc -s /var/run/syslog errors</strong></span></pre><p>If you’ve forgotten the name of the buffer you want to read, ask <code class="literal">syslogc</code> to query the list of available memory logs with <code class="literal">-q</code>. Be sure to provide the reporting socket.</p><div class="note" title="Note"><h3 class="title"><a id="ch15note03"/>Note</h3><p>Even if you’re not a programmer, you can still use real syslog features. Logging to syslog is available to shell scripts via the <code class="literal">logger(1)</code> program. See the <code class="literal">logger</code> man page for details.</p></div></div></div><div class="sect1" title="Log File Maintenance"><div class="titlepage"><div><div><h2 class="title" id="log_file_maintenance" style="clear: both">Log File Maintenance</h2></div></div></div><p>You can capture logs. Fantastic! Now just let the log files grow until they fill your hard disk and leave room for nothing else, right? Or you can discard old logs and have the system keep the logs to a manageable size. This is called <span class="emphasis"><em>log rotation</em></span>.</p><p><a class="indexterm" id="idx0679"/><a class="indexterm" id="idx1215"/><a class="indexterm" id="idx1529"/><a class="indexterm" id="idx2337"/>Look at the system messages log, <span class="emphasis"><em>/var/log/messages</em></span>, and you should see six <span class="emphasis"><em>messages</em></span> files: <span class="emphasis"><em>messages</em></span>, <span class="emphasis"><em>messages.0.gz</em></span>, <span class="emphasis"><em>messages.1.gz</em></span>, <span class="emphasis"><em>messages.2.gz</em></span>, <span class="emphasis"><em>messages.3.gz</em></span>, and <span class="emphasis"><em>messages.4.gz</em></span>. The plain <span class="emphasis"><em>messages</em></span> file is the current log file. The other files are older logs; <span class="emphasis"><em>messages.0.gz</em></span> is the newest, and <span class="emphasis"><em>messages.4.gz</em></span> is the oldest.</p><p>When the current log file hits either a certain age or a specific size, log rotation discards the oldest log file (<span class="emphasis"><em>messages.4.gz</em></span>), and the second-oldest file, <span class="emphasis"><em>messages.3.gz</em></span>, is renamed to <span class="emphasis"><em>messages.4.gz</em></span>; <span class="emphasis"><em>messages.2.gz</em></span> is renamed to <span class="emphasis"><em>messages.3.gz</em></span>; and so on. The existing <span class="emphasis"><em>messages</em></span> file is renamed to <span class="emphasis"><em>messages.0</em></span> and compressed, and a new <span class="emphasis"><em>messages</em></span> file is created.</p><p>The <code class="literal">newsyslog(8)</code> program rotates log files, restarts daemons, runs commands, shuffles old files into other directories, and handles all routine tasks. <code class="literal">root</code> runs <code class="literal">newsyslog</code> once per hour via <code class="literal">cron(8)</code>. When <code class="literal">newsyslog</code> starts, it reads <span class="emphasis"><em>/etc/newsyslog.conf</em></span> and examines each log file listed. If the conditions for rotating the log file are met, the log is rotated and other configured actions are taken.</p><div class="sect2" title="newsyslog.conf Fields"><div class="titlepage"><div><div><h3 class="title" id="newsyslog_conf_fields">newsyslog.conf Fields</h3></div></div></div><p><span class="emphasis"><em>newsyslog.conf</em></span> uses one line per log file. Each line has seven fields, like this:</p><a id="I_programlisting15_id477554"/><pre class="programlisting">/var/log/authlog        root:wheel      640  7     *    168   Z</pre><p>From left to right, the fields are log file, owner, permissions, number of files to retain, size, time, and flags. After the flags field, you might see a number of optional arguments. We’ll look at each of the fields in order.</p><div class="sect3" title="Log File"><div class="titlepage"><div><div><h4 class="title" id="log_file">Log File</h4></div></div></div><p>The first entry on each line is the full path to the log file to be processed (<code class="literal">/var/log/authlog</code> in this example). This must exactly match the current log file.</p></div><div class="sect3" title="Owner"><div class="titlepage"><div><div><h4 class="title" id="owner">Owner</h4></div></div></div><p>The second field (<code class="literal">root:wheel</code> in our example) lists the log file’s owner and group, separated by a colon. This field is optional, and is not present in many of the default entries.</p><p>By default, log files are owned by the root user and the <code class="literal">wheel</code> group, but <code class="literal">newsyslog</code> can change the owner of log files. While changing ownership isn’t common, you might want to explicitly declare it for specific files.</p><p>You can choose to change only the owner or only the group. In these cases, use a colon with a name on only one side of it, such as <code class="literal">:wheel</code> or <code class="literal">root:</code>. You must always include the colon if you’re changing ownership.</p></div><div class="sect3" title="Permissions"><div class="titlepage"><div><div><h4 class="title" id="permissions">Permissions</h4></div></div></div><p>The third field (<code class="literal">640</code> in our example) gives the rotated file’s permissions in standard octal notation, as discussed in <code class="literal">chmod(1)</code>. This field is optional, and it is not present in many default entries.</p></div><div class="sect3" title="Count"><div class="titlepage"><div><div><h4 class="title" id="count">Count</h4></div></div></div><p><a class="indexterm" id="idx1128"/><a class="indexterm" id="idx2424"/>The fourth field specifies the number of archived log files that <span class="emphasis"><em>newsyslog</em></span> keeps. In our example, <span class="emphasis"><em>/var/log/messages</em></span> has the current log file and five archives, numbered 0 through 4. <span class="emphasis"><em>newsyslog.conf</em></span> has a count of <code class="literal">5</code> for <span class="emphasis"><em>/var/log/messages</em></span>.</p></div><div class="sect3" title="Size"><div class="titlepage"><div><div><h4 class="title" id="size">Size</h4></div></div></div><p>The fifth field is a file size in kilobytes. When <code class="literal">newsyslog</code> runs, it checks the size of the log file. If the log is larger than the size given here, <code class="literal">newsyslog</code> rotates the log. If you don’t want the file size to affect when <code class="literal">newsyslog</code> rotates the file, put an asterisk here.</p></div><div class="sect3" title="Time"><div class="titlepage"><div><div><h4 class="title" id="time">Time</h4></div></div></div><p>To rotate the log based on time, use the sixth field, which has four possible values: an asterisk, a number, and a time in one of two standard formats. If you rotate the log based on size rather than age, put an asterisk here. If you put a number here, you are specifying a number of hours after which the log will rotate. Our example of <span class="emphasis"><em>/var/log/authlog</em></span> rotates every 168 hours.</p><p>The time formats—ISO 8601 restricted and <code class="literal">newsyslog</code>-specific—are a little more complicated.</p><div class="blockquote" title="ISO 8601 restricted"><blockquote class="blockquote" title="ISO 8601 restricted"><div class="blockquote-title">ISO 8601 restricted</div><p>A time entry beginning with an <code class="literal">@</code> symbol is in the ISO 8601 restricted time format. The ISO 8601 restricted time format is used by <code class="literal">newsyslog</code> on most Unix-like systems, because it was the time format used in MIT’s primordial <code class="literal">newsyslog</code>. The ISO 8601 format is a bit obtuse, but every Unix-like operating system I’m aware of supports it.</p><p>A full date in ISO 8601 format is 14 digits with a <code class="literal">T</code> in the middle. The first four digits are the year, the next two are the month, and the next two are the day of the month. (The <code class="literal">T</code> serves as a sort of decimal point, separating whole days from fractions of a day.) The next two digits are hours, the next two are minutes, and the last two are seconds. For example, the date September 13, 2013, at 3:18 and 58 seconds <span class="smallcaps">PM</span> is expressed as <code class="literal">20130913T151858</code>. (Specifying a specific date and time to rotate a log wouldn’t be terribly useful because the log would rotate only once.)</p><p>You can choose to specify only the fields near the <code class="literal">T</code>, leaving fields farther away blank. Again, if you think of the <code class="literal">T</code> as a decimal point, you don’t need to write 5.87 as 005.8700; the leading and trailing zeros are irrelevant.</p><p>In the case of <code class="literal">newsyslog</code>, empty fields are wildcards. For example, <code class="literal">4T00</code> matches midnight on the fourth day of every month, and <code class="literal">T23</code> matches the twenty-third hour, or 11 <span class="smallcaps">PM</span>, every day. If <span class="emphasis"><em>newsyslog.conf</em></span> lists the time <code class="literal">@T2359</code>, the log rotates at 11:59 <span class="smallcaps">PM</span> every day. (Of course, <code class="literal">newsyslog</code> runs once an hour, so the log won’t rotate exactly then.)</p><p>As with <code class="literal">cron(8)</code>, specify time units in detail. For example, <code class="literal">@9T</code>, the ninth day of the month, rotates the log once an hour, every hour, on the ninth day of the month, which would mean it rotates the log all day on that day. It would probably be better to specify a time of <code class="literal">@9T01</code>, which would rotate the log at 1 <span class="smallcaps">AM</span> on the ninth day of the month. You don’t need to specify times any more closely than the hour, as <code class="literal">newsyslog</code> runs only hourly.</p></blockquote></div><div class="blockquote" title="newsyslog times"><blockquote class="blockquote" title="newsyslog times"><div class="blockquote-title">newsyslog times</div><p>Because ISO 8601 time doesn’t let you easily specify weekly jobs, and it’s impossible to specify the last day of the month, OpenBSD includes a <code class="literal">newsyslog</code>-specific time format that lets you easily specify these common times.</p><p>Any entry with a leading dollar sign (<code class="literal">$</code>) is written in <span class="emphasis"><em>month week day</em></span> format.</p><p>This particular format uses three identifiers: <span class="emphasis"><em><code class="literal">M</code></em></span> (day of month), <span class="emphasis"><em><code class="literal">W</code></em></span> (day of week), and <span class="emphasis"><em><code class="literal">H</code></em></span> (hour of day). Each identifier is followed by a number indicating the unit you’re using. Hours range from <code class="literal">0</code> to <code class="literal">23</code>, and days run from <code class="literal">0</code> (Sunday) to <code class="literal">6</code> (Saturday). Days of the month start at <code class="literal">1</code> and go to <code class="literal">31</code>, with <code class="literal">L</code> or <code class="literal">l</code> representing the last day of the month. For example, to rotate a log on the fifth of each month at noon, use <code class="literal">$M5H12</code>. To start the month-end accounting at 11 <span class="smallcaps">PM</span> on the last day of the month, use <code class="literal">$MLH23</code>.</p><p>If you don’t specify an hour, the time defaults to midnight on the chosen day. And if a <span class="emphasis"><em>newsyslog.conf</em></span> entry lists both a time and a size for file rotation, <code class="literal">newsyslog</code> rotates the log if either requirement is met.</p></blockquote></div></div><div class="sect3" title="Flags"><div class="titlepage"><div><div><h4 class="title" id="flags">Flags</h4></div></div></div><p>The seventh field, which is optional, instructs <code class="literal">newsyslog</code> on special processing for the file itself. OpenBSD uses four flags:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none"><p title="Z"><span class="title"><strong><span class="strong"><strong><code class="literal">Z</code></strong></span></strong></span>. Compress the file with <code class="literal">gzip(1)</code>.</p></li><li class="listitem" style="list-style-type: none"><p title="B"><span class="title"><strong><span class="strong"><strong><code class="literal">B</code></strong></span></strong></span>. Do not add a “log file turned over” message to the file (for binary files).</p></li><li class="listitem" style="list-style-type: none"><p title="F"><span class="title"><strong><span class="strong"><strong><code class="literal">F</code></strong></span></strong></span>. Follow symlinks.</p></li><li class="listitem" style="list-style-type: none"><p title="M"><span class="title"><strong><span class="strong"><strong><code class="literal">M</code></strong></span></strong></span>. A user is monitoring this log.</p></li></ul></div><p>While the <code class="literal">B</code> and <code class="literal">Z</code> flags are not, strictly speaking, mutually incompatible, most log files need only one of them, and most binary files don’t compress well anyway. (The default <span class="emphasis"><em>newsyslog.conf</em></span> compresses the packet filtering log file, but that’s something of an oddity.) If you see the <code class="literal">Z</code> flag with the <code class="literal">M</code> flag, the old log file will be sent to the user before the log is compressed.</p></div></div><div class="sect2" title="Monitoring Logs"><div class="titlepage"><div><div><h3 class="title" id="monitoring_logs">Monitoring Logs</h3></div></div></div><p><a class="indexterm" id="idx1213"/><a class="indexterm" id="idx1214"/><a class="indexterm" id="idx1216"/><a class="indexterm" id="idx1234"/><a class="indexterm" id="idx1798"/><a class="indexterm" id="idx2138"/><a class="indexterm" id="idx2139"/><a class="indexterm" id="idx2271"/><a class="indexterm" id="idx2335"/><a class="indexterm" id="idx2336"/><a class="indexterm" id="idx2338"/>OpenBSD’s <code class="literal">newsyslog</code> can email logs to a user before rotating them. If you carefully control how you sort your logs, this feature can be useful. For example, <code class="literal">sudo(8)</code> logs successful uses at priority <code class="literal">notice</code>, but failed uses at priority <code class="literal">alert</code>. You might split these into separate log files in <span class="emphasis"><em>syslog.conf</em></span>, like this:</p><a id="I_programlisting15_id478101"/><pre class="programlisting">!sudo
*.*         /var/log/sudo
*.alert    /var/log/sudofail</pre><p>The file <span class="emphasis"><em>/var/log/sudofail</em></span> should now contain only <code class="literal">sudo</code> failures, such as users entering incorrect passwords or exceeding their privileges.</p><p>Now you could tell <code class="literal">newsyslog</code> to check for monitored logs by running it with the <code class="literal">-m</code> flag. (<code class="literal">newsyslog</code> runs as one of root’s cron jobs.)</p><p>To have the <code class="literal">sudo</code> failure log emailed to you every time the log rotates, you can put your account in the monitor field.</p><a id="I_programlisting15_id478256"/><pre class="programlisting">/var/log/sudofail    root:wheel    640    30    *    $H06    ZM    mwlucas</pre><p>This assumes that email to the account <code class="literal">mwlucas</code> on this machine reaches me. The simplest way to ensure that would be to forward the email in <span class="emphasis"><em>/etc/mail/aliases</em></span>.</p><div class="note" title="Note"><h3 class="title"><a id="ch15note04"/>Note</h3><p>If you’re serious about watching these kinds of failures, monitor logs on a logging host that end users cannot access. A user who becomes root on the local machine can edit logs before they are emailed and rotated.</p></div></div><div class="sect2" title="Adding a PID File"><div class="titlepage"><div><div><h3 class="title" id="adding_a_pid_file">Adding a PID File</h3></div></div></div><p>If <code class="literal">newsyslog</code> tries to rotate and compress a file, but the process writing the file is still writing to the file, the file can become corrupted. Some programs need a right proper slapping before they will let go of their log files. How? Just list a PID file here, and <code class="literal">newsyslog</code> will send that process ID a <code class="literal">SIGHUP</code> (like a <code class="literal">kill -1</code>).</p><p>Note that PID files are not a terribly secure way to identify specific processes because they are subject to race conditions and other attacks. If the server has a command for rotating its logs, that’s probably a wiser choice than signaling a process indicated in a PID file.</p></div><div class="sect2" title="Signal Name"><div class="titlepage"><div><div><h3 class="title" id="signal_name">Signal Name</h3></div></div></div><p>To send a signal other than <code class="literal">SIGHUP</code> to a process with a PID file, use a different <span class="emphasis"><em>signal name</em></span>. The signal name must begin with <code class="literal">SIG</code> and be specified by name. You can find a full list of signals in <code class="literal">signal(3)</code>, but the software documentation should tell you which signal the process needs to release in order to restart its log file. This field is optional, but if you use it, you must enter a full path to a PID file immediately before it.</p></div><div class="sect2" title="Command to Execute"><div class="titlepage"><div><div><h3 class="title" id="command_to_execute">Command to Execute</h3></div></div></div><p><a class="indexterm" id="idx0261"/><a class="indexterm" id="idx0684"/><a class="indexterm" id="idx1509"/><a class="indexterm" id="idx1557"/><a class="indexterm" id="idx1631"/><a class="indexterm" id="idx2351"/><a class="indexterm" id="idx2353"/>Rather than signaling a process, you can have <code class="literal">newsyslog</code> run a command when rotating logs by giving the full path to the command in double quotes. While this field is optional, it cannot be combined with a PID file. You can use a PID file or a command name, but not both.</p></div></div><div class="sect1" title="System Time"><div class="titlepage"><div><div><h2 class="title" id="system_time" style="clear: both">System Time</h2></div></div></div><p>There’s no excuse for a system having incorrect time. Once you set the time zone, having OpenBSD correct its own clock on an ongoing basis from any number of freely available network time servers is easy. Virtual machines in particular are notorious for skewing clocks, but time correction works on them as well, so as I said, no excuse.</p><p>OpenBSD includes its own NTP client, OpenNTPD, which is written to be safe and secure. Before <code class="literal">ntpd(8)</code> can do anything though, it needs some configuration.</p><div class="sect2" title="Configuring ntpd(8)"><div class="titlepage"><div><div><h3 class="title" id="configuring_ntpd8">Configuring ntpd(8)</h3></div></div></div><p>OpenBSD comes with a perfectly acceptable generic <code class="literal">ntpd</code> configuration that uses public time servers. If your host is on the public Internet and you only want to set your system time, not provide time to other hosts, use the defaults. Otherwise, you must customize <span class="emphasis"><em>/etc/ntpd.conf</em></span> by selecting time sources and deciding if <code class="literal">ntpd</code> will accept time requests from other machines.</p><div class="sect3" title="Time Redundancy"><div class="titlepage"><div><div><h4 class="title" id="time_redundancy">Time Redundancy</h4></div></div></div><p>NTP gets the time by querying remote servers. If you have a single server, that time is assumed to be correct. However, if you have multiple time servers, the times are not simply averaged. If one time server is wildly off from all of the other time servers, the results from that server are discarded, and a median from the remainder is selected. If you have only two time servers, and the times obtained from them differ, <code class="literal">ntpd</code> can’t determine which one is correct. To help <code class="literal">ntpd</code> make sensible decisions, always list at least three time servers.</p></div><div class="sect3" title="Time Sources"><div class="titlepage"><div><div><h4 class="title" id="time_sources">Time Sources</h4></div></div></div><p>Choose your time sources with the <code class="literal">server</code>, <code class="literal">servers</code>, and <code class="literal">sensor</code> keywords.</p><p>The <code class="literal">server</code> option tells <code class="literal">ntpd</code> to get the time from a single server, which might have multiple IP addresses. If that’s the case, <code class="literal">ntpd</code> tries to use the first IP address. If the first address doesn’t work, it tries the second, and so on, until it gets an answer. Use the <code class="literal">server</code> option if you have specific time servers to use, and be sure to list at least three time servers.</p><a id="I_programlisting15_id478550"/><pre class="programlisting">server time1.blackhelicopters.org
server time2.blackhelicopters.org
server time3.blackhelicopters.org</pre><p><a class="indexterm" id="idx0685"/><a class="indexterm" id="idx0955"/><a class="indexterm" id="idx2425"/>The <code class="literal">servers</code> option tells <code class="literal">ntpd</code> to get the time from multiple hosts that share a common hostname. The default <span class="emphasis"><em>ntpd.conf</em></span> includes this entry:</p><a id="I_programlisting15_id478591"/><pre class="programlisting">servers pool.ntp.org</pre><p>The host <span class="emphasis"><em>pool.ntp.org</em></span> has four IP addresses, and <code class="literal">ntpd</code> will try to get time from all of those hosts.</p><p>If you have a hardware time sensor, you can tell <code class="literal">ntpd</code> to read time from it. Hardware time sensors include <code class="literal">nmea(4)</code>, <code class="literal">udcf(4)</code>, and <code class="literal">mbg(4)</code>. The <code class="literal">sensor</code> option tells <code class="literal">ntpd</code> to use a hardware sensor. If you’ve invested in a hardware time sensor, you might be sufficiently concerned about time to measure the distance between the transmitter and the receiver, and adjust the time based on the speed of light delay. The <code class="literal">correction</code> keyword lets you specify a number of microseconds that your sensor is behind.</p><p>As I wrote this, a 40-millisecond (ms) delay caused a furor in the scientific world when researchers thought they might have seen a neutrino go faster than light, so we’ll put a 40 ms correction into our time sensor.</p><a id="I_programlisting15_id478645"/><pre class="programlisting">sensor nmea0 correction 40000</pre><div class="note" title="Note"><h3 class="title"><a id="ch15note05"/>Note</h3><p>Be warned that OpenBSD is not a real-time operating system. You should not be measuring neutrino speed with it anyway!</p></div></div><div class="sect3" title="Serving Time"><div class="titlepage"><div><div><h4 class="title" id="serving_time">Serving Time</h4></div></div></div><p>I run time servers on only closed networks, where very few hosts have access to the public Internet. I would also run time servers if I had hardware time sensors, but most of the time, I just use the public time servers.</p><p>To have <code class="literal">ntpd</code> answer time queries from other hosts, use the <code class="literal">listen on</code> directive. You can either specify an IP address or use an asterisk to say “every IP on the system.”</p><a id="I_programlisting15_id478685"/><pre class="programlisting">listen on 192.0.2.87
listen on 2001:db8::aaaa</pre><p>Because <code class="literal">ntpd</code> has no access controls, any host that can connect to port 123/UDP can get time from this server. If this worries you, use packet filtering (discussed in <a class="xref" href="ch21.html" title="Chapter 21. Packet Filtering">Chapter 21</a> and <a class="xref" href="ch22.html" title="Chapter 22. Advanced PF">Chapter 22</a>) to limit time checks to hosts on your network. The author of OpenNTP served time to his entire company and to the public on a MicroVAX 3100 with 16MB (yes, that’s an <span class="emphasis"><em>M</em></span>) of RAM without the NTP process using more than 5 percent of the processor, so the load imposed by NTP is negligible on modern systems.</p><p><a class="indexterm" id="idx0715"/><a class="indexterm" id="idx0952"/><a class="indexterm" id="idx1510"/><a class="indexterm" id="idx1558"/><a class="indexterm" id="idx2330"/>Now that <code class="literal">ntpd</code> is configured, let’s use it.</p></div></div><div class="sect2" title="Using ntpd(8)"><div class="titlepage"><div><div><h3 class="title" id="using_ntpd8">Using ntpd(8)</h3></div></div></div><p>You can correct time slowly or do it in one fell swoop. I recommend fully correcting time at boot, and then letting <code class="literal">ntpd</code> slowly adjust the system clock as the system runs. This corrects time before anything relies on it, but keeps everything synchronized on an ongoing basis.</p><p>To correct time when starting <code class="literal">ntpd</code>, use the <code class="literal">-s</code> flag.</p><a id="I_programlisting15_id478796"/><pre class="programlisting"># <span class="strong"><strong>ntpd -s</strong></span></pre><p>You’ll get a command prompt back once <code class="literal">ntpd</code> receives a response from a time server and adjusts the clock. At boot, this delays other software starting so that it has the correct time, and when you check your clock, you should see the correct time. You can configure this at boot with <code class="literal">ntpd_flags</code> in <span class="emphasis"><em>/etc/rc.conf.local</em></span>.</p><a id="I_programlisting15_id478822"/><pre class="programlisting">ntpd_flags='-s'</pre><p>If the clock is off on a running system and you’re running software that would be corrupted by the clock moving backward or a time jump forward (as with many databases), you might need to tell <code class="literal">ntpd</code> to correct the clock more slowly. To do so, run <code class="literal">ntpd</code> without any flags, or set it in <span class="emphasis"><em>rc.conf.local</em></span> to have it run in this mode at boot.</p><div class="note" title="Note"><h3 class="title"><a id="ch15note06"/>Note</h3><p>Your starting time may be so far off that it will be impossible to make a gradual adjustment to the correct time in any reasonable period. To fix the clock, schedule a clock change when you can shut down your sensitive software, and make sure NTP runs afterwards so that the problem remains fixed. It’s better to fix your clock right away and be done with it.</p></div></div></div><div class="sect1" title="Hardware Sensors"><div class="titlepage"><div><div><h2 class="title" id="hardware_sensors" style="clear: both">Hardware Sensors</h2></div></div></div><p>Sensors are physical probes that check the health and status of hardware. Manufacturers have put more and more sensors in hardware, providing low-level hardware information to the operating systems. OpenBSD supports a wide variety of hardware sensors, and uses the <code class="literal">sensorsd</code> daemon to query them and act upon error states.</p><p>Resolving many hardware errors requires shutting down the machine, but advance warning that a component has stopped working changes a hardware failure from an unexpected middle-of-the-day catastrophe to an after-hours annoyance. Some hardware, such as hot-swappable hard drives, can be replaced without interrupting service once you know the hardware has failed.</p><div class="sect2" title="Device Drivers"><div class="titlepage"><div><div><h3 class="title" id="device_drivers-id00001">Device Drivers</h3></div></div></div><p><a class="indexterm" id="idx0429"/><a class="indexterm" id="idx0434"/><a class="indexterm" id="idx0954"/><a class="indexterm" id="idx1066"/><a class="indexterm" id="idx1101"/><a class="indexterm" id="idx1855"/><a class="indexterm" id="idx1915"/><a class="indexterm" id="idx2332"/><a class="indexterm" id="idx2396"/>Each physical sensor has a device driver. The device driver extracts information from the hardware and publishes it in a sysctl (discussed in <a class="xref" href="ch18.html" title="Chapter 18. Kernel Configuration">Chapter 18</a>). <code class="literal">sensorsd</code> reads the sysctl values and can act when they change or cross critical values. For example, here are the sensor-related sysctl values from my laptop:</p><a id="I_programlisting15_id478973"/><pre class="programlisting">$ <span class="strong"><strong>sysctl hw.sensors</strong></span>
hw.sensors.acpitz0.temp0=67.00 degC (zone temperature)
hw.sensors.acpiac0.indicator0=On (power supply)
hw.sensors.acpibat0.volt0=11.10 VDC (voltage)
hw.sensors.acpibat0.volt1=12.35 VDC (current voltage)
hw.sensors.acpibat0.power0=0.00 W (rate)
hw.sensors.acpibat0.watthour0=2.61 Wh (last full capacity)
hw.sensors.acpibat0.watthour1=0.30 Wh (warning capacity)
hw.sensors.acpibat0.watthour2=0.06 Wh (low capacity)
hw.sensors.acpibat0.watthour3=9.57 Wh (remaining capacity), OK
hw.sensors.acpibat0.raw0=2 (battery full), OK
hw.sensors.cpu0.temp0=81.00 degC</pre><p>This comparatively simple and generic hardware has two temperature sensors and all kinds of power sensors. You can get hundreds of lines of sensor output, depending on your hardware.</p><p>Many RAID controllers have their own sensors, and will report when an array has failed. Here, we see three virtual disks provided by an AMI RAID controller:</p><a id="I_programlisting15_id478997"/><pre class="programlisting">hw.sensors.ami0.drive0=online (sd0), OK
hw.sensors.ami0.drive1=degraded (sd1), WARNING
hw.sensors.ami0.drive2=failed (sd2), CRITICAL</pre><p>If you didn’t have sensors, you would need to look at the blinking lights on the drive enclosure. Or you could listen for the really annoying “beep, beep, beep,” which is <span class="emphasis"><em>so</em></span> easy to hear over the roar of 5,000 server fans, the air conditioners, and someone else’s hardware that has been beeping every time you’ve come in for the last six months.</p><div class="note" title="Note"><h3 class="title"><a id="ch15note07"/>Note</h3><p>Some sensors require the Intelligent Platform Management Interface (IPMI). This is a kernel feature that’s disabled by default in OpenBSD, because it makes some machines behave really badly. <a class="xref" href="ch18.html" title="Chapter 18. Kernel Configuration">Chapter 18</a> discusses enabling IPMI.</p></div><p>The device drivers attach to sensors automatically, and the values get into the kernel automatically, but to do anything with these results in any automated manner, you need <code class="literal">sensorsd(8)</code>, or you need to configure an external SNMP-based management system and use <code class="literal">snmpd(8)</code>. We’ll look at using <code class="literal">sensorsd(8)</code> here. Using <code class="literal">snmpd(8)</code> is discussed in <a class="xref" href="ch16.html" title="Chapter 16. Network Servers">Chapter 16</a>.</p></div><div class="sect2" title="Sensor Configuration"><div class="titlepage"><div><div><h3 class="title" id="sensor_configuration">Sensor Configuration</h3></div></div></div><p><a class="indexterm" id="idx0741"/><a class="indexterm" id="idx0953"/><a class="indexterm" id="idx2082"/><a class="indexterm" id="idx2331"/>The sensors daemon <code class="literal">sensorsd(8)</code> watches sensor monitoring data. It logs changes and can execute commands if needed. Because all hardware is different and all environments are different, by default, <code class="literal">sensorsd</code> notices changes only in sensor readings. To take action, you must configure <code class="literal">sensorsd</code> in <span class="emphasis"><em>/etc/sensorsd.conf</em></span>.</p><div class="sect3" title="Sensor Types"><div class="titlepage"><div><div><h4 class="title" id="sensor_types">Sensor Types</h4></div></div></div><p>OpenBSD supports many types of sensors, as listed in <a class="xref" href="ch15.html#supported_sensor_types" title="Table 15-2. Table 15-2: Supported Sensor Types">Table 15-2</a>.</p><div class="table"><a id="supported_sensor_types"/><div class="table-title">Table 15-2. Table 15-2: Supported Sensor Types</div><div class="table-contents"><table style="border-collapse: collapse; border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="c1"/><col class="c2"/></colgroup><thead><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>Name</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Function</p></td></tr></thead><tbody><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>temp</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Temperature (C)</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>fan</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Fan speed (RPM)</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>volt</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>DC voltage</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>acvolt</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>AC voltage</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>resistance</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Ohms resistance</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>power</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Wattage</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>current</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Amperage</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>watthour</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Power capacity</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>amphour</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Power capacity</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>indicator</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Device-dependent yes/no</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>raw</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Device-dependent value</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>percentage</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Device-dependent percentage</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>illuminance</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Lighting</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>drive</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Hard drives</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>timedelta</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Time difference between operating system and hardware</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>humidity</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Percent humidity</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; "><p>frequency</p></td><td style="vertical-align: top; border-bottom: 0.5pt solid ; "><p>Microhertz</p></td></tr><tr><td style="vertical-align: top; border-right: 0.5pt solid ; "><p>angle</p></td><td style="vertical-align: top; "><p>Microdegrees</p></td></tr></tbody></table></div></div><p>You’ll need to check your hardware manual in order to learn how to use some of these sensors effectively.</p><p>Some sensors appear to overlap. For example, why does OpenBSD have all those separate values for power, when you could probably do some math and get a common power gauge? The reason is that these are the values that the actual sensors report, and the developers would prefer to give you the actual measurements. OpenBSD does perform some data rationalization, but only for simple data; all temperature sensors are normalized to degrees Celsius, for example.</p><p><a class="indexterm" id="idx2085"/>Now let’s see what you can do with these sensors.</p></div><div class="sect3" title="Settings in sensorsd.conf"><div class="titlepage"><div><div><h4 class="title" id="settings_in_sensorsd_conf">Settings in sensorsd.conf</h4></div></div></div><p>The file <span class="emphasis"><em>sensorsd.conf</em></span> has example entries, but because environments differ so widely, they’re all commented out. It uses a <code class="literal">termcap</code>-style configuration syntax, much like <span class="emphasis"><em>/etc/remote</em></span> (see <a class="xref" href="ch05.html" title="Chapter 5. The Boot Process">Chapter 5</a>) or <span class="emphasis"><em>/etc/login.access</em></span> (see <a class="xref" href="ch06.html" title="Chapter 6. User Management">Chapter 6</a>), with colons separating the terms in an entry. Each entry starts with the sensor to be measured, followed by attribute names and settings.</p><p>For example, here’s an entry for a temperature sensor in the default <span class="emphasis"><em>sensorsd.conf</em></span>:</p><a id="I_programlisting15_id479589"/><pre class="programlisting">hw.sensors.lm0.temp0:high=50C</pre><p>For the sensor <code class="literal">lm0.temp0</code>, the attribute <code class="literal">high</code> is set to <code class="literal">50C</code>.</p><p><code class="literal">sensorsd</code> supports four attributes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none"><p title="high"><span class="title"><strong><span class="strong"><strong><code class="literal">high</code></strong></span></strong></span>. An upper limit</p></li><li class="listitem" style="list-style-type: none"><p title="low"><span class="title"><strong><span class="strong"><strong><code class="literal">low</code></strong></span></strong></span>. A lower limit</p></li><li class="listitem" style="list-style-type: none"><p title="command"><span class="title"><strong><span class="strong"><strong><code class="literal">command</code></strong></span></strong></span>. A command to run when a limit is crossed or a state changes</p></li><li class="listitem" style="list-style-type: none"><p title="istatus"><span class="title"><strong><span class="strong"><strong><code class="literal">istatus</code></strong></span></strong></span>. Ignore this status</p></li></ul></div><p>The values reported for a sensor type depend on what makes sense. Where high and low limits make sense for temperature and voltage, some sensors report specific values instead. The RAID controller shown earlier reports drives as degraded, failed, or healthy. A hard-drive sensor that reports a scalar value isn’t useful, as you want to know if a RAID container is healthy or if drives have failed. There’s no middle ground.</p><p>You can have both high and low values for a single sensor. For example, whereas temperature might not have a low value in most data centers, voltage certainly will. I work in all sorts of weird places, and not all of them have clean power.</p><a id="I_programlisting15_id479684"/><pre class="programlisting">hw.sensors.acpibat0.volt0:low=11.0V:high=13.0V</pre><p>With a line like this, if the electricity supply to my laptop drops below 11 volts or goes above 13 volts, I will know.</p><p>Some systems might have dozens of sensors of a given type, which could make configuration tricky. If my motherboard has 15 temperature sensors, I don’t want to configure each separately. Fortunately, you can configure sensors en masse by type, and since I don’t care which temperature sensor goes above 80 degrees Celsius (if any of them do, I want an alarm), that works.</p><a id="I_programlisting15_id479699"/><pre class="programlisting">temp:high=80C</pre><p><a class="indexterm" id="idx0956"/><a class="indexterm" id="idx1131"/><a class="indexterm" id="idx2333"/><a class="indexterm" id="idx2585"/>When this rule is applied, <code class="literal">sensorsd</code> first looks for a configuration item for a specific sensor. If it doesn’t find that specific rule, it looks for a general rule. You can have one rule for most of your temperature sensors, and then override it for specific sensors, like this:</p><a id="I_programlisting15_id479746"/><pre class="programlisting">hw.sensors.lm0.temp5:high=90C
temp=80C</pre><p>This rule says that most of my temperature sensors alarm at 80 degrees, but one specific sensor doesn’t alarm until 90 degrees.</p><p>I care about temperature, but I don’t care if my fancy keyboard sees that there’s no light and wants to trigger its back lighting. You can ignore a sensor, or a type of sensor, with the <code class="literal">istatus</code> keyword.</p><a id="I_programlisting15_id479763"/><pre class="programlisting">illuminance:istatus</pre><p>You should categorically ignore certain types of alarms based on your environment and gear. Make up your own mind.</p></div><div class="sect3" title="Sensors Triggering Action"><div class="titlepage"><div><div><h4 class="title" id="sensors_triggering_action">Sensors Triggering Action</h4></div></div></div><p>Having an entry in <span class="emphasis"><em>/var/log/daemon</em></span> for when a hard drive fails is nice, but it would be better if the system would send email, page you, or trigger your monitoring system. It should do something—<span class="emphasis"><em>anything</em></span>—that doesn’t require you to log in and look at a log file. Fortunately, <code class="literal">sensorsd</code> can run arbitrary commands upon detecting a problem or crossing a threshold, using the <code class="literal">command</code> attribute.</p><p>Thanks to the wide variety of sensors and their possible error states and conditions, <code class="literal">sensorsd</code> doesn’t have a fine-grained “run this command for an error, but run that other command for recovery.” There are too many possible error states and conditions for this to make any sense. Instead, <code class="literal">sensorsd</code> runs a single command upon crossing any threshold or upon any state change, including when it starts up and the state of an individual sensor goes from “unknown” to whatever it starts at.</p><p>Consider this <span class="emphasis"><em>sensorsd.conf</em></span> entry:</p><a id="I_programlisting15_id479823"/><pre class="programlisting">temp:high=80C:command=/sbin/reboot</pre><p>At first glance, this reads “If the temperature is high, reboot the machine.” You think that will unquestionably kill whatever runaway process is saturating your heat-generating CPU (completely setting aside the fact that other hardware besides CPUs generate heat), but <code class="literal">sensorsd</code> will run the command whenever the temperature state changes. The state changes at boot time, when the first temperature reading is taken, which means that your system will boot, and then immediately reboot. Your script needs intelligence.</p><p><a class="indexterm" id="idx2084"/>To make scripting easier, <code class="literal">sensorsd</code> has a set of variables it can pass to a script:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none"><p title="%1"><span class="title"><strong><span class="strong"><strong><code class="literal">%1</code></strong></span></strong></span>. Is the value within the limit set in <span class="emphasis"><em>sensorsd.conf</em></span>? This can be one of <code class="literal">below</code>, <code class="literal">above</code>, <code class="literal">within</code>, <code class="literal">invalid</code>, or <code class="literal">uninitialized</code>.</p></li><li class="listitem" style="list-style-type: none"><p title="%n"><span class="title"><strong><span class="strong"><strong><code class="literal">%n</code></strong></span></strong></span>. Sensor number.</p></li><li class="listitem" style="list-style-type: none"><p title="%s"><span class="title"><strong><span class="strong"><strong><code class="literal">%s</code></strong></span></strong></span>. Sensor status.</p></li><li class="listitem" style="list-style-type: none"><p title="%x"><span class="title"><strong><span class="strong"><strong><code class="literal">%x</code></strong></span></strong></span>. Which device the sensor sits on.</p></li><li class="listitem" style="list-style-type: none"><p title="%t"><span class="title"><strong><span class="strong"><strong><code class="literal">%t</code></strong></span></strong></span>. Sensor type.</p></li><li class="listitem" style="list-style-type: none"><p title="%2"><span class="title"><strong><span class="strong"><strong><code class="literal">%2</code></strong></span></strong></span>. Sensor’s current value.</p></li><li class="listitem" style="list-style-type: none"><p title="%3"><span class="title"><strong><span class="strong"><strong><code class="literal">%3</code></strong></span></strong></span>. Sensor’s low limit</p></li><li class="listitem" style="list-style-type: none"><p title="%4"><span class="title"><strong><span class="strong"><strong><code class="literal">%4</code></strong></span></strong></span>. Sensor’s high limit.</p></li></ul></div><p>You might run a temperature command like this:</p><a id="I_programlisting15_id479991"/><pre class="programlisting">temp:high=80C:command=/usr/local/script/temp %1 %2 %n</pre><p>Your script <span class="emphasis"><em>/usr/local/script/temp</em></span> would take three arguments: the error condition, the temperature, and the sensor name. Your script would check these values and see if a reboot is warranted.</p><p>With <code class="literal">sensorsd</code>, proper timekeeping, and log file management, your OpenBSD system can largely look after itself.</p><p>In the next chapter, we’ll look at how OpenBSD can take care of other hosts.</p></div></div></div><div class="footnotes" epub:type="footnotes"><br/><hr style="width: 100; align: left;"/><div class="footnote" epub:type="footnote" id="ftn.id367882"><p><sup>[<a class="para" href="#id367882">41</a>] </sup>Hey, I was running out of ways to annoy lasnyder—plausible ways, at least.</p></div></div></section></body></html>