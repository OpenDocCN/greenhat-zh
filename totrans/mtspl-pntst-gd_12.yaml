- en: Chapter 12. Karmetasploit
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Karmetasploit is Metasploit’s implementation of KARMA, a set of wireless security
    tools developed by Dino Dai Zovi and Shane Macaulay. KARMA takes advantage of
    a vulnerability inherent in the way Windows XP and Mac OS X operating systems
    search for networks: When each system boots, it sends beacons looking for networks
    to which it has connected previously.'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: An attacker using KARMA sets up a fake access point on his computer and then
    listens for and responds to these beacons from the target, pretending to be whatever
    wireless network the client is looking for. Because most client computers are
    configured to connect automatically to wireless networks they have already used,
    KARMA can be used to gain complete control of a client’s network traffic, thus
    allowing an attacker to launch client-side attacks, capture passwords, and so
    forth. With the prevalence of poorly secured corporate wireless networks, an attacker
    using KARMA can sit in a nearby parking lot, adjacent office, or similar, and
    gain access to a target’s network with little effort. You can read more about
    the original implementation of KARMA at [http://trailofbits.com/karma/](http://trailofbits.com/karma/).
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: Karmetasploit is the Metasploit Framework implementation of the KARMA attack.
    It implements various “evil” services including DNS, POP3, IMAP4, SMTP, FTP, SMB,
    and HTTP. These services accept and respond to most requests from clients and
    will serve up all kinds of malicious fun. (The various modules are in the *modules/auxiliary/server*
    directory of the Metasploit root directory.)
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
- en: Configuration
  id: totrans-4
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Karmetasploit requires very little configuration. To begin, we configure a
    DHCP server to be used to hand out IP addresses to wireless targets. Back|Track
    includes a DHCP server, but we will need to create a custom configuration file
    for it to use with Karmetasploit, as shown in the following listing:'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-6
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: We back up our original *dhcpd.conf* file by entering **`cp /etc/dhcp3/dhcpd.conf/etc/dhcp3/dhcpd.conf.back`**,
    and then we create a new file containing the data shown at ![](../images/00002.gif),
    which will serve addresses in the range of 10.0.0.100 to 10.0.0.254 ![](../images/00004.gif).
    (If you are unfamiliar with DHCP configurations, don’t worry; as long as your
    new *dhcpd.conf* looks similar to this it should work fine.)
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, we download the KARMA resource file, because as of this writing it’s
    not included in the regular Metasploit trunk:'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-9
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'When we open the KARMA resource file *karma.rc*, we can see the sequence of
    events that occur when it runs, as shown here:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-11
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'After loading the database (`db_connect postgres:toor@127.0.0.1/msfbook`) in
    which to store its results, KARMA loads the `browser_autopwn` server as shown
    at ![](../images/00002.gif). This is a handy way to attempt a number of exploits
    against a browser in an untargeted manner. A handful of the browser-based exploits
    in the Frame-work contain the directive `include Msf::Exploit::Remote::BrowserAutopwn`:
    Exploits that contain that include line will be attempted when the autopwn server
    is accessed.'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: At ![](../images/00004.gif) and ![](../images/00005.gif), the local IP address
    is set to `10.0.0.1`, which coincides with the default DHCP configuration. Then,
    in lines ![](../images/00006.gif) and on, the various servers are configured and
    started. (To get a complete picture of what occurs in this attack, read the resource
    file.)
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, we place our wireless card in monitor mode. The way in which we do this
    depends on our wireless card’s chipset. The wireless card in the following example
    uses the RT73 chipset. We use `airmon-ng start wlan0` to place it in monitor mode:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: '* * *'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-17
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If your card uses a different chipset from the one used in this example, visit
    the Aircrack-ng website ([http://www.aircrack-ng.org/](http://www.aircrack-ng.org/))
    for specifics on how to place your card in monitor mode.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: Launching the Attack
  id: totrans-20
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The `airbase-ng` component of the Aircrack-ng suite is used to create Karmeta-sploit’s
    fake access point. In the next example, we configure the `airbase-ng` access point
    to respond to all probes (`-P`), to beacon every 30 seconds (`-C 30`) with the
    ESSID Free Wi-Fi (`-e "Free WiFi"`), and to be verbose (`-v`) using the interface
    `mon0`:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-22
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: As you can see at ![](../images/00002.gif), Airbase-ng creates a new interface
    called *at0*. Karmetasploit will use this interface.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, we turn on the *at0* interface and start the DHCP server:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The *at0* interface is turned on using the IP address of `10.0.0.1` shown at
    ![](../images/00002.gif), and the DHCP server is started using the configuration
    file we created earlier, also using *at0* as shown at ![](../images/00004.gif).
    To make sure that the DHCP server is running, we run a quick `ps aux` at ![](../images/00005.gif).
    Finally, we tail the *messages* log file at ![](../images/00006.gif) to see when
    IP addresses are being handed out.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: 'Now that the entire Karmetasploit configuration is complete, we can load the
    resource file from within *msfconsole* using `resource karma.rc` as shown next.
    (Note that we can also pass the resource file to *msfconsole* via the command
    line by entering `msfconsole -r karma.rc`.) Let’s see it in action:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: As you can see, a great deal is happening with the resource file. In this listing,
    the `LHOST` address is set to *10.0.0.1* at ![](../images/00002.gif), the POP3
    service (among others) is started at ![](../images/00004.gif), the *autopwn* exploits
    are loaded at ![](../images/00005.gif), and payloads are configured at ![](../images/00006.gif).
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
- en: Credential Harvesting
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'When a client connects to our malicious access point, the messages file we
    are tailing will show us when an IP address is handed out. This is our cue to
    switch back to *msfconsole* to see what is happening. Here, we see that a client
    connects and is assigned an IP address:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The first thing our target does is open an email client. Karmetasploit is waiting,
    as shown here:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: The POP3 server configured by Metasploit intercepts the target’s email username
    and password at ![](../images/00002.gif), because all DNS requests are intercepted
    by the DNS server that Karmetasploit set up for us.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
- en: Getting a Shell
  id: totrans-36
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: At this point, the user has no new messages, so he decides to do some web browsing.
    When the browser opens, a *captive portal* is presented to the user, as shown
    in [Figure 12-1](part0016.html#karmetasploit_captive_portal).
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: '![Karmetasploit captive portal](../images/00047.jpeg)Figure 12-1. Karmetasploit
    captive portal'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
- en: As the user sits in front of his computer wondering what’s going on, Karmetasploit
    is busy configuring the attack to capture cookies; set up fake email, DNS, and
    other servers; and launch exploits against the client’s browser — all the result
    of the magic contained in our *karma.rc* file.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: Of course, some degree of luck is involved in this attack. The browser will
    display a “Loading” page while exploits are launched. If the user is impatient,
    he may simply close the browser window, which will stop our exploits.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, you can see the massive amount of output that results from this attack:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-42
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: In this output, you can see at ![](../images/00002.gif) that Metasploit first
    lets the client know that various popular websites are in fact located on the
    attacking machine. Then, at ![](../images/00004.gif), it uses JavaScript to determine
    the target’s operating system and browser, and responds at ![](../images/00005.gif)
    with exploits based on that fingerprint. At ![](../images/00006.gif) the client
    is presented with a malicious ActiveX control, resulting in the familiar yellow
    prompt bar in Internet Explorer, shown at the top of [Figure 12-1](part0016.html#karmetasploit_captive_portal).
    You can also see buried in the output at ![](../images/00007.gif) that an exploit
    was launched against the client. After a brief period, you see at ![](../images/00026.gif)
    that the exploit was successful and a Meterpreter session has been opened on the
    target PC!
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: Returning to *msfconsole*, we can interact with the session that was created
    and check to see what permissions we have obtained on the target. Remember, when
    you exploit a browser it’s always a good idea to migrate your process out of the
    web browser in case it gets closed.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Because this is a default installation of Windows XP SP2 with the very insecure
    Internet Explorer 6 installed (both of which are highly out of date), the client
    didn’t even need to accept and install the malicious ActiveX control.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
- en: Wrapping Up
  id: totrans-47
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Attacks against wireless networks have been a popular topic for quite some time.
    Although this attack can take a bit of setup, imagine its success against a number
    of similarly configured clients located in a high-traffic or public area. This
    approach to attacking wireless clients is often popular because it’s easier than
    a brute force attack against a well-secured wireless infrastructure.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 对无线网络的攻击已经是一个热门话题有一段时间了。尽管这种攻击需要一些设置，但想象一下它在位于高流量或公共区域的大量类似配置客户端中的成功率。这种攻击无线客户端的方法之所以受欢迎，通常是因为它比针对高度安全的无线基础设施的暴力攻击要容易。
- en: Now that you’ve seen how easy it is to conduct this sort of attack, you’ll probably
    think twice about using public wireless networks. Are you sure that the coffee
    shop is offering “free public Wi-Fi”? Or perhaps someone is running Karmetasploit?
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经看到进行这类攻击是多么容易，你可能会对使用公共无线网络三思而后行。你确定咖啡馆提供的真的是“免费公共Wi-Fi”吗？或者可能有人在运行Karmetasploit？
