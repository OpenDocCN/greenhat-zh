<html><head></head><body>

<div class="calibre21" id="calibre_pb_0"/><div class="calibre1" id="calibre_toc_101">
<a name="ch07" class="calibre6" id="ch07"/>
<div class="calibre1">
<h2 class="lot-title" id="calibre_pb_1"><a name="105" class="calibre16" id="105"/><a name="ch07lev1sec10" class="calibre16" id="ch07lev1sec10"/><span class="chapter-titlelabel">Program 90: </span>It's As Easy As Rolling off a Log</h2><p class="b24-bookeditorial">In order to track a memory leak, our clever programmer decided to put in logging information into <span>new</span> and <span>delete</span> by redefining the global functions. Although C++ allows this, his program still crashes. Why?</p>
<div class="calibre1">
<pre class="literallayout-normal">
  1 /************************************************
  2  * simple debugging library that overrides the  *
  3  * standard new and delete operators so that we *
  4  * log all results.                             *
  5  ************************************************/
  6 #include &lt;iostream&gt;
  7 #include &lt;fstream&gt;
  8 #include &lt;cstdlib&gt;
  9
 10 // Define the file to write the log data to
 11 std::ofstream log_file("mem.log");
 12
 13 /************************************************
 14  * operator new -- Override the system new so   *
 15  *      that it logs the operation.  This is    *
 16  *      useful for debugging.                   *
 17  *                                              *
 18  * Note: We have verified that the real new     *
 19  *      calls malloc on this system.            *
 20  *                                              *
 21  * Returns a pointer to the newly created area. *
 22  ************************************************/
 23 void *operator new(
 24     // Size of the memory to allocate
 25     const size_t size
 26 )
 27 {
 28     // Result of the malloc
 29     void *result = (void *)malloc(size);
 30
 31     log_file &lt;&lt;
 32         result &lt;&lt; " =new(" &lt;&lt;
 33         size &lt;&lt; ")" &lt;&lt; std::endl;
 34
 35     return (result);
 36 }
 37
 38 /************************************************
 39  * operator delete -- Override the system       *
 40  *      delete to log the operation.   This is  *
 41  *      useful for debugging.                   *
 42  *                                              *
 43  * Note: We have verified that the real delete  *
 44  *      calls free on this system.              *
 45  ************************************************/
 46 void operator delete(
 47     void *data // Data to delete
 48 )
 49 {
 50     log_file &lt;&lt; data &lt;&lt; " Delete" &lt;&lt; std::endl;
 51     free (data);
 52 }
 53
 54 // Dummy main
 55 int main()
 56 {
 57     return (0);
 58 }
</pre>
</div>
<p class="b24-bookeditorial">(Next <a href="LiB0120.html#348" target="_parent" class="calibre2">Hint 212</a>. <a href="LiB0121.html#608" target="_parent" class="calibre2">Answer 110</a>.)</p>
<div class="calibre1">
<table class="calibre3" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr class="calibre4">
<td class="bluecell"><span class="calibre22"><b class="calibre13"><img src="_1.gif" alt="Start Sidebar" border="0" class="calibre23"/></b></span></td>
</tr>
</table>
<p class="b24-bookeditorial">Law of advanced programming languages: Make it possible for programmers to write in English, and you will find the programmers cannot write in English.</p>
<table class="calibre3" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr class="calibre4">
<td class="bluecell"><span class="calibre22"><b class="calibre13"><img src="_1.gif" alt="End Sidebar" border="0" class="calibre23"/></b></span></td>
</tr>
</table>
</div>
<table class="calibre3" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr class="calibre4">
<td height="16" class="calibre8"/>
</tr>
</table>
</div>
</div>



</body></html>