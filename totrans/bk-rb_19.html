<html><head></head><body><div class="chapter" title="Chapter&#xA0;19.&#xA0;Ruby on Rails"><div class="titlepage"><div><div><h1 class="title"><a id="ruby_on_rails"/>Chapter 19. Ruby on Rails</h1></div></div></div><div class="informalfigure"><a id="image_no_caption-id23"/><div class="mediaobject"><a id="I_mediaobject19_d1e21949"/><img src="httpatomoreillycomsourcenostarchimages860138.png.jpg" alt="image with no caption"/></div></div><p>Rails has become so closely connected with Ruby that it is now quite commonplace for people to talk about programming “in” Ruby on Rails as though “Ruby on Rails” were the name of the programming language.</p><p>In fact, Rails is a framework—a set of tools and code libraries—that can be used in cahoots with Ruby. It gives you the ability to develop database-driven websites that respond to user interaction. For example, users might enter and save data on one page and search for data on other pages. This makes Rails suitable for creating dynamic websites that generate web pages “on the fly” rather than loading up static, predesigned pages. Typical applications include collaborative sites such as online communities, multi-author books or wikis, shopping sites, discussion forums, and blogs.</p><p>I’ll provide a hands-on guide to creating a blog shortly. First, though, let’s take a closer look at the nitty-gritty details of the Rails framework.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>This chapter will give you a taste of developing in Ruby on Rails. Bear in mind, however, that Rails is a big and complex framework, and I will cover only the fundamental features. At the time of writing, Rails 3 is the latest version, but Rails 2 is still widely used; therefore, both versions are covered in this chapter.<a id="IDX-CHP-19-0001" class="indexterm"/><a id="IDX-CHP-19-0002" class="indexterm"/><a id="IDX-CHP-19-0003" class="indexterm"/></p></div><div class="sect1" title="Installing Rails"><div class="titlepage"><div><div><h1 class="title"><a id="installing_rails"/>Installing Rails</h1></div></div></div><p>Rails is not a standard part of Ruby, so you may need to install it as a separate operation. Note that Ruby and Rails ship as standard with some operating systems, such as Mac OS X. There is, however, no guarantee that these are the latest versions, and you may want to update the default installation manually.<a id="IDX-CHP-19-0004" class="indexterm"/></p><div class="sect2" title="Do It Yourself . . ."><div class="titlepage"><div><div><h2 class="title"><a id="do_it_yourself"/>Do It Yourself . . .</h2></div></div></div><p>There are various ways in which Rails can be installed. The easiest way is to use an all-in-one installer (some alternatives are described in this chapter). However, you may also install Rails and the tools it requires one at a time. Rails may be installed using the Ruby Gems “package manager.” As long as you are connected to the Internet, Ruby Gems will go online to find and install the latest version of Rails.<a id="IDX-CHP-19-0005" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>For Ruby Gems documentation, go to <a class="ulink" href="http://docs.rubygems.org/">http://docs.rubygems.org/</a>.</p></div><p>At the command prompt, enter the following:</p><a id="I_programlisting19_d1e21999"/><pre class="programlisting">gem install rails</pre><p>If, instead of installing the latest version, you want to install a specific version of Rails, you should append <code class="literal">--version=</code> followed by the appropriate version number when entering the previous command. For example, to install Rails 2.3.8, enter the following:</p><a id="I_programlisting19_d1e22006"/><pre class="programlisting">gem install rails --version=2.3.8</pre><p>Alternatively, you can download and install Rails from the Ruby on Rails website, <a class="ulink" href="http://www.rubyonrails.org/">http://www.rubyonrails.org/</a>. Most Rails applications require a database, which you will need to install as a separate operation. Many people use either SQLite or the free MySQL database server. MySQL is the more powerful of the two systems and is used on many professional websites. However, many people find SQLite simpler to use for local development of Ruby applications. Installation of SQLite varies according to which operating system is being used. SQLite3 is pre-installed on Mac OS X Leopard.<a id="IDX-CHP-19-0006" class="indexterm"/></p><p>Installation of SQLite3 can be notably tricky on Windows. You should begin by running this command at the command line:</p><a id="I_programlisting19_d1e22017"/><pre class="programlisting">gem install sqlite3-ruby</pre><p>Pay close attention to the message that is displayed when this executes. This tells you which version of the SQLite3 DLL you need to install and the web address from which you can download it. This DLL is a requirement. Failure to install it will mean that SQLite3 will not be available for use with Rails. This message will state something like this:<a id="IDX-CHP-19-0007" class="indexterm"/><a id="IDX-CHP-19-0008" class="indexterm"/><a id="IDX-CHP-19-0009" class="indexterm"/><a id="IDX-CHP-19-0010" class="indexterm"/></p><a id="I_programlisting19_d1e22036"/><pre class="programlisting">You've installed the binary version of sqlite3-ruby.
 It was built using SQLite3 version 3.7.3.
 It's recommended to use the exact same version to avoid potential issues.

 At the time of building this gem, the necessary DLL files where available
 in the following download:

 http://www.sqlite.org/sqlitedll-3_7_3.zip

 You can put the sqlite3.dll available in this package in your Ruby bin
 directory, for example C:\Ruby\bin</pre><p>Be sure to follow the instructions, download the correct DLL, and copy it into the <span class="emphasis"><em>\bin</em></span> directory beneath your Ruby installation.</p><p>Refer to the SQLite site for more information on SQLite: <a class="ulink" href="http://www.sqlite.org/docs.html">http://www.sqlite.org/docs.html</a>. You can find installation help on MySQL in <a class="xref" href="apb.html" title="Appendix B. Installing MySQL for Ruby on Rails">Appendix B</a> of this book. Many other database servers can also be used including Microsoft SQL Server, PostgresSQL, and Oracle.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>If you plan to install or update Rails from scratch or if you need to update the version pre-installed with your operating system, you should refer to Rails Guides website at <a class="ulink" href="http://guides.rubyonrails.org/getting_started.html">http://guides.rubyonrails.org/getting_started.html</a>. These guides provide detailed OS-specific information relating to Rails 3. Several Rails wikis also provide information on supporting older versions of Rails—for example, <a class="ulink" href="http://en.wikibooks.org/wiki/Ruby_on_Rails">http://en.wikibooks.org/wiki/Ruby_on_Rails</a>.</p></div></div><div class="sect2" title="Or Use an “All-in-One” Installer"><div class="titlepage"><div><div><h2 class="title"><a id="or_use_an_lall-in-oner_installer"/>Or Use an “All-in-One” Installer</h2></div></div></div><p>Various all-in-one Ruby and Rails setup programs are available. These include the Bitnami RubyStack installers for Windows, Linux, and Mac: <a class="ulink" href="http://www.bitnami.org/stack/rubystack/">http://www.bitnami.org/stack/rubystack/</a>. Windows users can also use the Rails installer from RubyForge: <a class="ulink" href="http://www.rubyforge.org/frs/?group_id=167">http://www.rubyforge.org/frs/?group_id=167</a>. These installers provide their own installation guides.</p></div></div></div>
<div class="sect1" title="Model-View-Controller"><div class="titlepage"><div><div><h1 class="title"><a id="model-view-controller"/>Model-View-Controller</h1></div></div></div><p>A Rails application is divided into three main areas: the Model, the View, and the Controller. Put simply, the Model is the data part—the database and any programmatic operations (such as calculations) that are done upon that data. The View is what the end user sees; in Rails terms, that generally means the web pages that appear in the browser. The Controller is the programming logic—the “glue” that joins the Model to the View.</p><p>The Model-View-Controller methodology is used in various forms by all kinds of programming languages and frameworks. It is more fully described in <a class="xref" href="ch19s10.html#digging_deeper-id18" title="Digging Deeper">Digging Deeper</a> in <a class="xref" href="ch19s10.html#digging_deeper-id18" title="Digging Deeper">Digging Deeper</a>. For the sake of brevity, I will henceforward call it MVC.</p></div>
<div class="sect1" title="A First Ruby on Rails Application"><div class="titlepage"><div><div><h1 class="title"><a id="a_first_ruby_on_rails_application"/>A First Ruby on Rails Application</h1></div></div></div><p>Without more ado, let’s start programming with Rails. I’ll assume you have Rails installed, along with a web server. I happen to be using the WEBrick server, which is installed as standard with Rails, but you may use some other server such as Apache, LightTPD, or Mongrel. You can find more information on web servers in <a class="xref" href="apd.html" title="Appendix D. Ruby and Rails Development Software">Appendix D</a>.<a id="IDX-CHP-19-0011" class="indexterm"/><a id="IDX-CHP-19-0012" class="indexterm"/><a id="IDX-CHP-19-0013" class="indexterm"/><a id="IDX-CHP-19-0014" class="indexterm"/><a id="IDX-CHP-19-0015" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>A web server is a program that delivers data, such as web pages, using the Hypertext Transfer Protocol (HTTP). You don’t need to understand how this works. You just need to be aware that you need a web server for use with Rails.</p></div><p>This chapter assumes you are using only the “raw” Rails development tools—programs that are executed from the command line—plus, at the very least, a text editor and a web browser; as a consequence, you will find that you frequently have to enter commands at the system prompt. If you are using an integrated development environment for Rails, you will probably be able to accomplish these tasks much more easily using the tools provided by the IDE.</p><p>Unlike the source code examples supplied for the other chapters in this book, the sample code for the Ruby on Rails applications in this chapter is not complete and “ready to run.” There are three reasons for this:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Each Rails application comprises a great many files and folders, most of which are autogenerated by Rails, so it would be pointless to distribute them separately.</p></li><li class="listitem"><p>I would also have to supply the data for each database, and you would have to import it prior to using it. Importing databases is often more difficult than creating your own.</p></li><li class="listitem"><p>Not only is it simpler to create Rails applications yourself, but doing so will also help you understand how Rails works. I have, however, supplied some sample files—component parts of a complete application—with which you can compare your own code in case you run into problems.</p></li></ul></div></div>
<div class="sect1" title="Create a Rails Application"><div class="titlepage"><div><div><h1 class="title"><a id="create_a_rails_application"/>Create a Rails Application</h1></div></div></div><p>For the sake of simplicity, this first application will not use a database at all. This will let you explore the View and the Controller without having to worry about the complexities of the Model.</p><p>To begin, open a system prompt (on Windows, select the Start menu, and enter <strong class="userinput"><code>cmd</code></strong> into the Run or Search box). Navigate to a directory into which you intend to place your Rails applications. Let’s assume this is <span class="emphasis"><em>C:\railsapps</em></span>. Check that Rails is installed and that its home directory is on the system path. To do this, enter the following:<a id="IDX-CHP-19-0016" class="indexterm"/><a id="IDX-CHP-19-0017" class="indexterm"/></p><a id="I_programlisting19_d1e22134"/><pre class="programlisting">rails</pre><p>If all is well, you should now see a screenful of help about using the <code class="literal">rails</code> command. If you don’t see this, there is a problem with your Rails installation that you need to fix before continuing. Refer to <a class="xref" href="ch19.html#installing_rails" title="Installing Rails">Installing Rails</a> in <a class="xref" href="ch19.html#installing_rails" title="Installing Rails">Installing Rails</a>.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>When there are any differences in the commands or code for Rails 2 and Rails 3, these will be indicated in the text with the Rails version number—Rails 2 or Rails 3—in the margin next to the example.</p></div><p>Assuming Rails is working, you can now create an application. Enter this:</p><p><span class="emphasis"><em>Rails 3</em></span></p><a id="I_programlisting19_d1e22153"/><pre class="programlisting">rails new helloworld</pre><p><span class="emphasis"><em>Rails 2</em></span></p><a id="I_programlisting19_d1e22158"/><pre class="programlisting">rails helloworld</pre><p>After a bit of whirring of your hard disk, you should see a list of the files that Rails has just created (the actual list is quite long, and some of the items created are different in Rails 2 and Rails 3):</p><a id="I_programlisting19_d1e22163"/><pre class="programlisting">create  app
create  app/controllers/application_controller.rb
create  app/helpers/application_helper.rb
create  app/mailers
create  app/models
create  app/views/layouts/application.html.erb
create  config
<em class="replaceable"><code>(etcetera)</code></em></pre><p>Take a look at these files using your computer’s file manager. Beneath the directory in which you ran the Rails command (<span class="emphasis"><em>\helloworld</em></span>), you will see that several new directories have been created: <span class="emphasis"><em>\app</em></span>, <span class="emphasis"><em>\config</em></span>, <span class="emphasis"><em>\db</em></span>, and so on. Some of these have subdirectories. The <span class="emphasis"><em>\app</em></span> directory, for example, contains <span class="emphasis"><em>\controllers</em></span>, <span class="emphasis"><em>\helpers</em></span>, <span class="emphasis"><em>\models</em></span>, and <span class="emphasis"><em>\views</em></span>. The <span class="emphasis"><em>\views</em></span> directory itself contains a subdirectory, <span class="emphasis"><em>\layouts</em></span>.</p><p>The directory structure in a Rails application is far from random; the directories (or <span class="emphasis"><em>folders</em></span>) and the names of the files they contain define the relationships between the various parts of the application. The idea behind this is that by adopting a well-defined file-and-folder structure, you can avoid the necessity of writing lots of configuration files to link the various bits of the application together. There is a simplified guide to the default directory structure of Rails in <a class="xref" href="ch19s10.html#digging_deeper-id18" title="Digging Deeper">Digging Deeper</a> in <a class="xref" href="ch19s10.html#digging_deeper-id18" title="Digging Deeper">Digging Deeper</a>.</p><p>Now, at the system prompt, change the directory to the top-level folder (<span class="emphasis"><em>\helloworld</em></span>) of your newly generated Rails application. Assuming you are still in the <span class="emphasis"><em>C:\railsapps</em></span> directory and you named the Rails application <span class="emphasis"><em>helloworld</em></span>, as suggested earlier, you would (on Windows) enter this command to change to that directory:<a id="IDX-CHP-19-0018" class="indexterm"/><a id="IDX-CHP-19-0019" class="indexterm"/><a id="IDX-CHP-19-0020" class="indexterm"/></p><a id="I_programlisting19_d1e22236"/><pre class="programlisting">cd helloworld</pre><p>Now run the server. If (like me) you are using WEBrick, you should enter the following:<a id="IDX-CHP-19-0021" class="indexterm"/></p><p><span class="emphasis"><em>Rails 3</em></span></p><a id="I_programlisting19_d1e22248"/><pre class="programlisting">rails server</pre><p><span class="emphasis"><em>Rails 2</em></span></p><a id="I_programlisting19_d1e22253"/><pre class="programlisting">ruby script/server</pre><p>Note that servers other than WEBrick may be started in different ways, and if the previous does not work, you will need to consult the server’s documentation. You should now see something similar to the following:</p><a id="I_programlisting19_d1e22258"/><pre class="programlisting">=&gt; Booting WEBrick...
=&gt; Rails application started on http://0.0.0.0:3000
=&gt; Ctrl-C to shutdown server; call with --help for options
[2006-11-20 13:46:01] INFO  WEBrick 1.3.1
[2006-11-20 13:46:01] INFO  ruby 1.8.4 (2005-12-24) [i386-mswin32]
[2006-11-20 13:46:01] INFO  WEBrick::HTTPServer#start: pid=4568 port=3000</pre><div class="sidebar"><a id="problems_question"/><p class="title">Problems?</p><p>If, instead of seeing a message confirming that the server has started, you see error messages, check that you have entered the server command exactly as shown for the version of Rails being used, and check that it is run from within the appropriate directory: <span class="emphasis"><em>\helloworld</em></span>.</p><p>If you still have problems, it is possible that the default port (3000) is already in use—for example, if you already have an Apache server installed on the same PC. In that case, try some other value such as <code class="literal">3003</code>, placing this number after <code class="literal">-p</code> when you run the script:</p><a id="I_programlisting19_d1e22276"/><pre class="programlisting">rails server -p3003</pre><a id="I_programlisting19_d1e22278"/><pre class="programlisting">ruby script/server -p3003</pre><p>If you see error messages that include the text <code class="literal">no such file to load -- sqlite3</code>, be sure you have correctly installed SQLite3 as explained in <a class="xref" href="ch19.html#installing_rails" title="Installing Rails">Installing Rails</a> in <a class="xref" href="ch19.html#installing_rails" title="Installing Rails">Installing Rails</a>. If you are attempting to use MySQL and the error message includes the text <code class="literal">no such file to load–mysql</code>, refer to <a class="xref" href="apb.html" title="Appendix B. Installing MySQL for Ruby on Rails">Appendix B</a>.<a id="IDX-CHP-19-0022" class="indexterm"/><a id="IDX-CHP-19-0023" class="indexterm"/></p></div><p><span class="emphasis"><em>Rails 3</em></span></p><p><span class="emphasis"><em>Rails 2</em></span></p><p>Now fire up a web browser. Enter the host name, followed by a colon and the port number, into its address bar. The host name should (normally) be <span class="emphasis"><em>localhost</em></span>, and the port number should match the one used when starting the server, or else it defaults to 3000. Here is an example:<a id="IDX-CHP-19-0024" class="indexterm"/><a id="IDX-CHP-19-0025" class="indexterm"/></p><a id="I_programlisting19_d1e22328"/><pre class="programlisting">http://localhost:3000/</pre><p>The browser should now display a page welcoming you aboard Rails. If not, verify that your server is running on the port specified in the URL.</p><div class="informalfigure"><a id="image_no_caption-id24"/><div class="mediaobject"><a id="I_mediaobject19_d1e22333"/><img src="httpatomoreillycomsourcenostarchimages860169.png.jpg" alt="image with no caption"/></div></div></div>
<div class="sect1" title="Create a Controller"><div class="titlepage"><div><div><h1 class="title"><a id="create_a_controller"/>Create a Controller</h1></div></div></div><p>As mentioned earlier, a Controller is where much of your Ruby code will live. It is the part of the application that sits between the View (what appears in the browser) and the Model (what happens to the data). Because this is a “Hello world” application, let’s create a Controller to say “hello.” In the spirit of originality, I’ll call this the <span class="emphasis"><em>SayHello</em></span> controller. Once again, you can create this by running a script at the system prompt. You will need to open another command window in the directory from which you previously ran the server script (for example, <span class="emphasis"><em>C:\railsapps\helloworld</em></span>). You can’t reuse your existing command window because the server is running in that one, and you would need to close it down to get back to the prompt—and that would stop your Rails application from working!<a id="IDX-CHP-19-0026" class="indexterm"/><a id="IDX-CHP-19-0027" class="indexterm"/></p><p>At the prompt, enter this (be sure to use the capitalization of <code class="literal">SayHello</code> as shown):</p><p><span class="emphasis"><em>Rails 3</em></span></p><a id="I_programlisting19_d1e22365"/><pre class="programlisting">rails generate controller SayHello</pre><p><span class="emphasis"><em>Rails 2</em></span></p><a id="I_programlisting19_d1e22370"/><pre class="programlisting">ruby script/generate controller SayHello</pre><p>After a few moments, you will be informed that various files and directories have been created, including the following:<a id="IDX-CHP-19-0028" class="indexterm"/></p><a id="I_programlisting19_d1e22379"/><pre class="programlisting">app/views/say_hello
app/controllers/say_hello_controller.rb
test/functional/say_hello_controller_test.rb
app/helpers/say_hello_helper.rb</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>The <code class="literal">generate controller</code> script also creates the file <span class="emphasis"><em>application_controller.rb</em></span> in Rails 3 or <span class="emphasis"><em>application.rb</em></span> in Rails 2, which is the controller for the entire application, plus a folder, <span class="emphasis"><em>/views/say_hello</em></span>, which you will make use of shortly.<a id="IDX-CHP-19-0029" class="indexterm"/><a id="IDX-CHP-19-0030" class="indexterm"/><a id="IDX-CHP-19-0031" class="indexterm"/></p></div><p>Notice how Rails has parsed the name <code class="literal">SayHello</code> into two lowercase words, <code class="literal">say</code> and <code class="literal">hello</code>, separated by an underscore, and it has used this name as the first part of the generated Ruby files such as <code class="literal">say_hello_controller.rb</code>. This is just one example of the “configuration by convention” approach that Rails uses.<a id="IDX-CHP-19-0032" class="indexterm"/></p><p>Locate the controller file <span class="emphasis"><em>say_hello_controller.rb</em></span>, which has been created in <span class="emphasis"><em>\helloworld\app\controllers</em></span>. Open this file in a text editor. This empty method has been autogenerated:</p><a id="I_programlisting19_d1e22438"/><pre class="programlisting">class SayHelloController &lt; ApplicationController
end</pre><p>Inside this class you can write some code to be executed when a certain page is displayed. Edit the class definition to match the following:</p><a id="I_programlisting19_d1e22442"/><pre class="programlisting">class SayHelloController &lt; ApplicationController
    def index
        render :text =&gt; "Hello world"
    end

    def bye
        render :text =&gt; "Bye bye"
    end
end</pre><p>This now contains two methods, <code class="literal">index</code> and <code class="literal">bye</code>. Each method contains a single line of code. In spite of the fact that I have omitted parentheses (a parentheses-light style of coding is favored by many Rails developers), you can probably deduce that <code class="literal">render</code> is a method that takes a hash as an argument; the hash itself contains a key-value pair comprising a symbol and a string. For parentheses-lovers, the <code class="literal">index</code> method can be rewritten like this:</p><a id="I_programlisting19_d1e22458"/><pre class="programlisting">def index
   render( { :text =&gt; "Hello world" } )
end</pre><p>And there you have your first real Rails application. To try it, you need to go back to the web browser and enter the full “address” of the two functions you just wrote. But first you may need to restart your server. Just press <span class="keycap">ctrl</span>-C in the command window where the server is running. When the server exits, restart by entering the following:<a id="IDX-CHP-19-0033" class="indexterm"/><a id="IDX-CHP-19-0034" class="indexterm"/><a id="IDX-CHP-19-0035" class="indexterm"/></p><p><span class="emphasis"><em>Rails 3</em></span></p><a id="I_programlisting19_d1e22483"/><pre class="programlisting">rails server</pre><p><span class="emphasis"><em>Rails 2</em></span></p><a id="I_programlisting19_d1e22488"/><pre class="programlisting">ruby script/server</pre><p>There’s just one more thing you have to do in Rails 3. You need to tell it how to find a “route” specified by an address entered into web browser. This step is not required for Rails 2. In Rails 3, open the <span class="emphasis"><em>routes.rb</em></span> file in your <span class="emphasis"><em>helloworld\config\</em></span> folder. Now edit it to match the following (or simply uncomment the line of code that you’ll find at the bottom of the file):</p><a id="I_programlisting19_d1e22499"/><pre class="programlisting">match ':controller(/:action(/:id(.:format)))'</pre><p>You are now ready to test the application. To do so, you just need to enter an address to access a controller method. The address takes the form of the host and port (the same as you entered previously—for example, <span class="emphasis"><em>http://localhost:3000</em></span>), plus the name of the controller (<span class="emphasis"><em>/say_hello</em></span>) and finally the name of a specific method (<span class="emphasis"><em>/index</em></span> or <span class="emphasis"><em>/bye</em></span>). Try entering these, as shown next, into your browser’s address field, once again ensuring that you are using the appropriate port number if it is not 3000:</p><a id="I_programlisting19_d1e22515"/><pre class="programlisting">http://localhost:3000/say_hello/index
http://localhost:3000/say_hello/bye</pre><p>Your browser should display “Hello world” and “Bye bye” respectively for each address. If all is working at this point, you can bathe in the warm glow of having created your first Ruby on Rails application. If however, you are seeing MySQL database errors, read <a class="xref" href="apbs04.html" title="Can’t Find the Database?">Can’t Find the Database?</a> in <a class="xref" href="apbs03.html" title="Configuring MySQL">Configuring MySQL</a> and fix the problem before continuing.</p><p>Incidentally, Rails uses the <code class="literal">index</code> method as a default so you can use the index view as your home page and omit that part of the URL when entering the address into the browser:</p><a id="I_programlisting19_d1e22528"/><pre class="programlisting">http://localhost:3000/say_hello</pre></div>
<div class="sect1" title="Anatomy of a Simple Rails Application"><div class="titlepage"><div><div><h1 class="title"><a id="anatomy_of_a_simple_rails_application"/>Anatomy of a Simple Rails Application</h1></div></div></div><p>Before moving on, let’s take a closer look at the class that you have created in this application. Rails has named the class by appending <span class="emphasis"><em>Controller</em></span> to the name you specified when running the controller generator script (<code class="literal">HelloWorld</code>), and it has made it a descendant of the ApplicationController class:</p><a id="I_programlisting19_d1e22542"/><pre class="programlisting">class SayHelloController &lt; ApplicationController</pre><p>But what exactly is the ApplicationController class? You may recall that I mentioned that the <code class="literal">generate controller</code> script you ran earlier silently created a file called <span class="emphasis"><em>application_controller.rb</em></span> (Rails 3) or <span class="emphasis"><em>application.rb</em></span> (Rails 2) inside the <span class="emphasis"><em>/app/controllers</em></span> folder. This file is the application controller, and if you open it, you will see that it contains a class called as follows:<a id="IDX-CHP-19-0036" class="indexterm"/><a id="IDX-CHP-19-0037" class="indexterm"/><a id="IDX-CHP-19-0038" class="indexterm"/></p><a id="I_programlisting19_d1e22572"/><pre class="programlisting">ApplicationController &lt; ActionController::Base</pre><p>So, the SayHelloController class descends from the ApplicationController class that itself descends from the Base class in the <code class="literal">ActionController</code> module. You can prove this by climbing back through the hierarchy and asking each class to display itself. This, incidentally, also gives you the chance to try doing some real Ruby programming in the SayHelloController class.</p><p>Just edit the contents of <span class="emphasis"><em>say_hello_controller.rb</em></span> file to match the following (or copy and paste the code from the <span class="emphasis"><em>sayhello1.rb</em></span> file in the code archive for this chapter):</p><p><span class="emphasis"><em>sayhello1.rb</em></span></p><a id="I_programlisting19_d1e22590"/><pre class="programlisting">class SayHelloController &lt; ApplicationController
    def showFamily( aClass, msg )
       if (aClass != nil) then
            msg += "&lt;br /&gt;#{aClass}"
            showFamily( aClass.superclass, msg )
       else
           render :text =&gt; msg
       end
    end

    def index
        showFamily( self.class, "Class Hierarchy of self..." )
    end
end</pre><p>To see the result, enter this address into your browser (once again, change the port number if necessary):</p><a id="I_programlisting19_d1e22594"/><pre class="programlisting">http://localhost:3000/say_hello</pre><p>Your web browser should now display the following (in Rails 3):</p><a id="I_programlisting19_d1e22599"/><pre class="programlisting">Class Hierarchy of self...
SayHelloController
ApplicationController
ActionController::Base
ActionController::Metal
AbstractController::Base
Object
BasicObject</pre><p>In Rails 2 it will display the following:<a id="IDX-CHP-19-0039" class="indexterm"/><a id="IDX-CHP-19-0040" class="indexterm"/><a id="IDX-CHP-19-0041" class="indexterm"/></p><a id="I_programlisting19_d1e22616"/><pre class="programlisting">Class Hierarchy of self...
SayHelloController
ApplicationController
ActionController::Base
Object</pre><p>Don’t worry about the actual class ancestry; the internal implementation details of the Rails framework are not of immediate interest. The important thing to understand is that a controller is a real Ruby object that inherits behavior from the ApplicationController class and its ancestors. Any Rails controller class you write or that is autogenerated by running scripts can contain normal Ruby code, just like all the other classes you’ve written in previous chapters. Within a controller, you can use all the usual Ruby classes such as strings and hashes.</p><p>But bear in mind that the end result needs to be displayed in a web page. This has certain consequences. For example, instead of putting linefeeds (<code class="literal">"\n"</code>) into strings, you should use HTML paragraph (<code class="literal">&lt;P&gt;</code>) or break (<code class="literal">&lt;br /&gt;</code>) tags, and it is only permissible to call <code class="literal">render</code> once each time a page is displayed, which explains why I’ve constructed a string in the course of calling the method recursively and then passed this to the <code class="literal">render</code> method right at the end:</p><a id="I_programlisting19_d1e22637"/><pre class="programlisting">def showFamily( aClass, msg )
    if (aClass != nil) then
        msg += "&lt;br /&gt;#{aClass}"
        showFamily( aClass.superclass, msg )
    else
       render :text =&gt; msg
    end
end</pre></div>
<div class="sect1" title="The Generate Controller Script Summarized"><div class="titlepage"><div><div><h1 class="title"><a id="the_generate_controller_script_summarize"/>The Generate Controller Script Summarized</h1></div></div></div><p>Before moving on, let’s consolidate the fundamental details of running the Rails <code class="literal">generate controller</code> script and learn a few extra tricks you can use when creating views. Each time a new controller is generated, it creates a Ruby code file in the <span class="emphasis"><em>app/controllers</em></span> directory, with a name matching the name you entered but all in lowercase, with any noninitial capitals that you specified being preceded by an underscore and <span class="emphasis"><em>_controller</em></span> appended. So, if you entered <span class="emphasis"><em>SayHello</em></span>, the controller file will be called <span class="emphasis"><em>say_hello_controller.rb</em></span>. The controller will contain a class definition such as <code class="literal">SayHelloController</code>. You may subsequently add to this class some “view methods” such as <code class="literal">index</code> and <code class="literal">bye</code>. Alternatively, you may use the <code class="literal">generate</code> script to create one or more empty view methods automatically by including those view names when you execute the script.<a id="IDX-CHP-19-0042" class="indexterm"/></p><p>For example, you could run this script:<a id="IDX-CHP-19-0043" class="indexterm"/><a id="IDX-CHP-19-0044" class="indexterm"/><a id="IDX-CHP-19-0045" class="indexterm"/><a id="IDX-CHP-19-0046" class="indexterm"/></p><p><span class="emphasis"><em>Rails 3</em></span></p><a id="I_programlisting19_d1e22700"/><pre class="programlisting">rails generate controller SayHello index bye</pre><p><span class="emphasis"><em>Rails 2</em></span></p><a id="I_programlisting19_d1e22705"/><pre class="programlisting">ruby script/generate controller SayHello index bye</pre><p>Rails will now create the file <span class="emphasis"><em>say_hello_controller.rb</em></span>, containing this code:</p><a id="I_programlisting19_d1e22712"/><pre class="programlisting">class SayHelloController &lt; ApplicationController
    def index
    end

    def bye
    end
end</pre><p>Whether or not you specify views, a folder in the <span class="emphasis"><em>/views</em></span> directory is created with a name matching the controller (<span class="emphasis"><em>views/say_hello</em></span>). In fact, the script also creates a few other files including some more Ruby files in the <span class="emphasis"><em>/helpers</em></span> folder, but in our simple application you can ignore these files.<a id="IDX-CHP-19-0047" class="indexterm"/></p><p>If you specified view names when running the controller script, some files with matching names and the extension <span class="emphasis"><em>.html.erb</em></span> will be added to the appropriate view folder. For instance, if you entered the following command:</p><a id="I_programlisting19_d1e22736"/><pre class="programlisting">ruby script/generate controller SayHello xxx</pre><p>the <span class="emphasis"><em>/views/say_hello</em></span> directory should now contain a file called <span class="emphasis"><em>xxx.html.erb</em></span>. If, on the other hand, you entered the following:</p><a id="I_programlisting19_d1e22746"/><pre class="programlisting">ruby script/generate controller Blather xxx bye snibbit</pre><p>the <span class="emphasis"><em>views/blather</em></span> directory should now contain three files: <span class="emphasis"><em>xxx.html.erb</em></span>, <span class="emphasis"><em>bye.html.erb</em></span>, and <span class="emphasis"><em>snibbit.html.erb</em></span>.</p></div>
<div class="sect1" title="Create a View"><div class="titlepage"><div><div><h1 class="title"><a id="create_a_view"/>Create a View</h1></div></div></div><p>It would be possible to create an entire application by coding everything inside a Controller and doing all the formatting inside view methods. However, you would soon end up with some pretty ugly web pages. To apply more formatting, you need to create a View that more accurately defines the layout of a web page.</p><p>You can think of a View as an HTML page that will be displayed when someone logs onto a specific web address—in which case, the name of the View forms the final part of the address as in the previous examples where the <span class="emphasis"><em>/index</em></span> and <span class="emphasis"><em>/bye</em></span> parts of the URL took you to views that displayed data supplied by the <code class="literal">index</code> and <code class="literal">bye</code> methods in the Controller.</p><p>You can create HTML view “templates” that match these web addresses and the corresponding method names. Using an HTML (or plaintext) editor, create a file named <span class="emphasis"><em>index.html.erb</em></span> in the <span class="emphasis"><em>\app\views\say_hello</em></span> directory, if such a template does not already exist. Remember, as explained previously (in <a class="xref" href="ch19s07.html" title="The Generate Controller Script Summarized">The Generate Controller Script Summarized</a> in <a class="xref" href="ch19s07.html" title="The Generate Controller Script Summarized">The Generate Controller Script Summarized</a>), you can optionally autocreate one or more view templates when you initially generate the Controller.<a id="IDX-CHP-19-0048" class="indexterm"/><a id="IDX-CHP-19-0049" class="indexterm"/><a id="IDX-CHP-19-0050" class="indexterm"/><a id="IDX-CHP-19-0051" class="indexterm"/><a id="IDX-CHP-19-0052" class="indexterm"/><a id="IDX-CHP-19-0053" class="indexterm"/></p><p>Now that you have a view template, you can edit it in order to control the way data is displayed in the web page. That means you won’t need to display plain, unformatted text using the <code class="literal">render</code> method in the Controller from now on. But, with the View being out of the Controller’s control (so to speak), how can the Controller pass data to the View? In turns out that it can do this by assigning data to an instance variable.</p><p>Edit the code in <span class="emphasis"><em>say_hello_controller.rb</em></span> (or delete it and paste in the code from the file <span class="emphasis"><em>sayhello2.rb</em></span>, supplied in the source code archive) so that it matches the following:</p><p><span class="emphasis"><em>sayhello2.rb</em></span></p><a id="I_programlisting19_d1e22840"/><pre class="programlisting">class SayHelloController &lt; ApplicationController
    def showFamily( aClass, msg )
       if (aClass != nil) then
            msg += "&lt;li&gt;#{aClass}&lt;/li&gt;"
            showFamily( aClass.superclass, msg )
       else
           return msg
       end
    end

    def index
        @class_hierarchy = "&lt;ul&gt;#{showFamily( self.class, "" )}&lt;/ul&gt;"
    end
end</pre><p>This version calls the <code class="literal">showFamily()</code> method in order to build up a string inside two HTML “unordered list” tags, <code class="literal">&lt;ul&gt;</code> and <code class="literal">&lt;/ul&gt;</code>. Each time a class name is found, it is placed between two HTML “list item” tags, <code class="literal">&lt;li&gt;</code> and <code class="literal">&lt;/li&gt;</code>. The complete string forms a valid HTML fragment, and the <code class="literal">index</code> method simply assigns this string a variable named <code class="literal">@class_hierarchy</code>.</p><div class="sidebar"><a id="html_tags_in_the_controller_question"/><p class="title">HTML Tags in the Controller?</p><p>Some Ruby on Rails developers object to having <span class="emphasis"><em>any</em></span> HTML tags, no matter how -trivial, included in the Controller code. In my opinion, if you intend to display the end results in a web page, it little matters where you put the odd <code class="literal">&lt;p&gt;</code>, <code class="literal">&lt;ul&gt;</code>, or <code class="literal">&lt;li&gt;</code> tag. Although the MVC paradigm encourages strong separation between the program code of the Controller and the layout definition of the View, you will inevitably have to make some compromises—at the very least by putting some program code into the View. Avoiding the use of HTML tags in the Controller is, largely, an aesthetic rather than a pragmatic objection. I personally have no very strong views on the subject, though (be warned!) other people do.</p></div><p>All you need to do now is to find some way of putting that HTML fragment into a fully formed HTML page. That’s where the View comes in. Open the view file you just created, <span class="emphasis"><em>index.html.erb</em></span>, in the <span class="emphasis"><em>app/views/say_hello</em></span> folder. According to the Rails naming convention, this is the default view (the “index” page) that is partnered with the <span class="emphasis"><em>say_hello_controller.rb</em></span> file. Since Rails works out relationships based on file, folder, class, and method names, you don’t have to load or require any files by name or write any configuration details.<a id="IDX-CHP-19-0054" class="indexterm"/><a id="IDX-CHP-19-0055" class="indexterm"/><a id="IDX-CHP-19-0056" class="indexterm"/><a id="IDX-CHP-19-0057" class="indexterm"/><a id="IDX-CHP-19-0058" class="indexterm"/></p><p>In the <span class="emphasis"><em>index.html.erb</em></span> file, add this:</p><a id="I_programlisting19_d1e22928"/><pre class="programlisting">&lt;h1&gt;This is the Controller's Class Hierarchy&lt;/h1&gt;
&lt;%= @class_hierarchy %&gt;</pre><p>The first line is nothing more than plain HTML formatting that defines the text enclosed by the <code class="literal">&lt;h1&gt;&lt;/h1&gt;</code> tags as a heading. The next line is more interesting. It contains the variable <code class="literal">@class_hierarchy</code>. Look back at the <code class="literal">index</code> method in <span class="emphasis"><em>say_hello_controller.rb</em></span>, and you’ll see that this is the variable to which you assigned a string. Here in the View, <code class="literal">@class_hierarchy</code> is placed between two odd-looking delimiters: <code class="literal">&lt;%=</code> and <code class="literal">%&gt;</code>. These are special Rails tags. They are used to embed bits of Ruby that will be executed prior to displaying a web page in the browser. The page that is finally displayed will be a fully formed HTML page that includes any HTML fragments from the view template plus the results, after execution, of any embedded Ruby code. Try it now, by entering the page address into your browser:</p><a id="I_programlisting19_d1e22954"/><pre class="programlisting">http://localhost:3000/say_hello/</pre><p>This should now display the heading “This is the Controller’s Class Hierarchy” in big, bold letters followed by a list of classes each element of which is preceded by a dot. In Rails 2, this is what you’ll see:</p><a id="I_programlisting19_d1e22958"/><pre class="programlisting">• SayHelloController
• ApplicationController
• ActionController::Base
• Object</pre><p>However, in Rails 3, you seem to have a problem. Instead of a list, the HTML tags are rendered literally like this:</p><a id="I_programlisting19_d1e22962"/><pre class="programlisting">&lt;ul&gt;&lt;li&gt;SayHelloController&lt;/li&gt;&lt;li&gt;ApplicationController&lt;/
li&gt;&lt;li&gt;ActionController::Base&lt;/li&gt;&lt;li&gt;ActionController::Metal&lt;/
li&gt;&lt;li&gt;AbstractController::Base&lt;/li&gt;&lt;li&gt;Object&lt;/li&gt;&lt;li&gt;BasicObject&lt;/li&gt;&lt;/ul&gt;</pre><p>This definitely is not what you want. The explanation for this is that the default treatment of HTML tags embedded in strings has changed between Rails 2 and Rails 3. In Rails 2, tags were passed through to the View unmodified. In Rails 3, substitution is done to ensure that HTML tags are displayed on the screen rather than rendered by the browser. For example, the <code class="literal">&lt;li&gt;</code> tag is changed to <code class="literal">&amp;lt;li&amp;gt;</code> where <code class="literal">&amp;lt;</code> and <code class="literal">&amp;gt;</code> are the HTML codes for angle brackets (<code class="literal">&lt;</code> and <code class="literal">&gt;</code>). To ensure that HTML tags are not substituted in this way, you need to use the <code class="literal">raw</code> method, passing to it a string argument. This is <span class="emphasis"><em>index.html.erb</em></span> rewritten for Rails 3:<a id="IDX-CHP-19-0059" class="indexterm"/><a id="IDX-CHP-19-0060" class="indexterm"/><a id="IDX-CHP-19-0061" class="indexterm"/></p><a id="I_programlisting19_d1e23004"/><pre class="programlisting">&lt;h1&gt;This is the Controller's Class Hierarchy&lt;/h1&gt;
&lt;%= raw( @class_hierarchy ) %&gt;</pre><p>Now when you log onto the address <a class="ulink" href="http://localhost:3000/say_hello">http://localhost:3000/say_hello</a> in Rails 3, you should see class names shown as a bulleted list with no HTML tags displayed.<a id="IDX-CHP-19-0062" class="indexterm"/></p><p>You could, if you want, remove all the HTML from the view file by creating the heading in the Controller and assigning the resulting string to another variable. You can do this by editing the <code class="literal">index</code> method in <span class="emphasis"><em>say_hello_controller.rb</em></span> to this:</p><a id="I_programlisting19_d1e23024"/><pre class="programlisting">def index
    @heading = "&lt;h1&gt;This is the Controller's Class Hierarchy&lt;/h1&gt;"
    @class_hierarchy = "&lt;ul&gt;#{showFamily( self.class, "" )}&lt;/ul&gt;"
end</pre><p>Then edit the view file <span class="emphasis"><em>(/app/views/say_hello/index.html.erb</em></span>) to match the code shown next (or cut and paste the code from the sample file into <span class="emphasis"><em>index.html.erb</em></span>) for use with Rails 3:</p><p><span class="emphasis"><em>say_hello_rails3.html.erb</em></span></p><a id="I_programlisting19_d1e23037"/><pre class="programlisting">&lt;%= raw( @heading ) %&gt;
&lt;%= raw( @class_hierarchy ) %&gt;</pre><p>For Rails 2, use this code:</p><p><span class="emphasis"><em>say_hello.html.erb</em></span></p><a id="I_programlisting19_d1e23044"/><pre class="programlisting">&lt;%= @heading %&gt;
&lt;%= @class_hierarchy %&gt;</pre><p>If you do this, the end result, as displayed in the web page, will remain unchanged. All that’s happened is that some formatting has been moved out of the view template and into the Controller.</p></div>
<div class="sect1" title="Rails Tags"><div class="titlepage"><div><div><h1 class="title"><a id="rails_tags"/>Rails Tags</h1></div></div></div><p>There are two variations on the Rails tags that you can place into Rails HTML Embedded Ruby (ERb) template files. The ones you’ve used so far include an equal sign in the opening delimiter: <code class="literal">&lt;%=</code>.<a id="IDX-CHP-19-0063" class="indexterm"/></p><p>These tags cause Rails not only to evaluate Ruby expressions but also to display the results in a web page. If you omit the equals sign from the opening delimiter, then the code will be evaluated, but the result will not be displayed: <code class="literal">&lt;%</code>.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>ERb files contain a mix of HTML markup and Ruby code between tags such as <code class="literal">&lt;%=</code> and <code class="literal">%&gt;</code>. Rails processes these files before the final pages are displayed in the web browser, executing the embedded Ruby and constructing the HTML page as a result.<a id="IDX-CHP-19-0064" class="indexterm"/><a id="IDX-CHP-19-0065" class="indexterm"/><a id="IDX-CHP-19-0066" class="indexterm"/></p></div><p>If you want, you can place quite long pieces of code—your entire Ruby program even!—between <code class="literal">&lt;%</code> and <code class="literal">%&gt;</code> tags and then use <code class="literal">&lt;%=</code> and <code class="literal">%&gt;</code> when you want to display something in the web page. In fact, you could rewrite your application by omitting the Controller entirely and putting everything into the View. Try it by editing <span class="emphasis"><em>app/views/say_hello/index.html.erb</em></span> to match the following (or copy and paste the code from the file <span class="emphasis"><em>embed_ruby_rails2.html.erb</em></span> or <span class="emphasis"><em>embed_ruby_rails3.html.erb</em></span> according to the Rails version being used):</p><p><span class="emphasis"><em>embed_ruby_rails3.rhtml</em></span><a id="IDX-CHP-19-0067" class="indexterm"/><a id="IDX-CHP-19-0068" class="indexterm"/></p><a id="I_programlisting19_d1e23119"/><pre class="programlisting">&lt;% def showFamily( aClass, msg )
     if (aClass != nil) then
        msg += "&lt;li&gt;#{aClass}&lt;/li&gt;"
        showFamily( aClass.superclass, msg )
     else
       return msg
     end
   end %&gt;

&lt;%= raw( "&lt;ul&gt;#{showFamily( self.class, "" )}&lt;/ul&gt;" ) %&gt;</pre><p>In this particular case, the text displayed in the web page will be slightly different from before since it now shows the class hierarchy of the <span class="emphasis"><em>view’s</em></span> class, rather than that of the controller’s class. As you will see, the view descends from the ActionView::Base class.</p><p>You can also divide a contiguous block of code by placing the individual lines between <code class="literal">&lt;%</code> and <code class="literal">%&gt;</code> tags instead of placing the entire block between a single pair. The advantage of doing this is that it lets you put standard HTML tags outside the individually delimited lines of Ruby code. You could, for instance, put this into a view:</p><a id="I_programlisting19_d1e23134"/><pre class="programlisting">&lt;% arr = ['h','e','l','l','o',' ','w','o','r','l','d'] %&gt;

&lt;% # sort descending from upper value down to nil
reverse_sorted_arr = arr.sort{
    |a,b|
        b.to_s &lt;=&gt; a.to_s
    } %&gt;

&lt;% i = 1 %&gt;
&lt;ul&gt;
&lt;% reverse_sorted_arr.each{ |item| %&gt;
&lt;li&gt;&lt;%= "Item [#{i}] = #{item}" %&gt;&lt;/li&gt;
&lt;% i += 1 %&gt;
&lt;% } %&gt;
&lt;/ul&gt;</pre><p>Here, I’ve assigned an array of chars to the variable, <code class="literal">arr</code>, between one set of tags. I’ve written a block to reverse-sort the array and assigned the result to another variable between a second set of tags. Then I’ve assigned 1 to the variable, <code class="literal">i</code>; and finally I’ve written this method:</p><a id="I_programlisting19_d1e23145"/><pre class="programlisting">reverse_sorted_arr.each{ |item|
    "Item [#{i}] = #{item}"
    i += 1
}</pre><p>But instead of enclosing the method between a single set of <code class="literal">&lt;% %&gt;</code> tags, I’ve enclosed each separate line within its own pair of tags. Why should I do this? Well, there are two reasons. First, I want the string in the middle of the block to be displayed on the web page, so I need to use the <code class="literal">&lt;%=</code> tag there:</p><a id="I_programlisting19_d1e23155"/><pre class="programlisting">&lt;%= "Item [#{i}] = #{item}" %&gt;</pre><p>And second, I want the whole set of strings to be displayed as an HTML list. So, I’ve placed the <code class="literal">&lt;ul&gt;</code> and <code class="literal">&lt;/ul&gt;</code> tags before and after the Ruby code block, and I’ve placed the line of code that displays each array item inside <code class="literal">&lt;li&gt;</code> and <code class="literal">&lt;/li&gt;</code> tags. Notice that these tags are <span class="emphasis"><em>inside</em></span> the Ruby code block but <span class="emphasis"><em>outside</em></span> the embedded Ruby tags on this particular line:</p><a id="I_programlisting19_d1e23178"/><pre class="programlisting">&lt;li&gt;&lt;%= "Item [#{i}] = #{item}" %&gt;&lt;/li&gt;</pre><p>So, by dividing up a contiguous block of Ruby code into separately delimited lines, I am no longer forced to construct strings to contain HTML tags. Instead, I have been able to do the useful trick of mixing HTML into the Ruby code itself. To be honest, I haven’t really mixed it in at all—the Ruby code is still closed off inside the tags; what I’ve done is told Rails to mix in the HTML at specific points prior to displaying the page in a web browser.</p><p>Incidentally, you may find it interesting to compare the version of the application that puts all the embedded Ruby code into the view (<span class="emphasis"><em>index.html.erb</em></span>) with the previous version in which the code was all put into the Controller (the version of <span class="emphasis"><em>say_hello_controller.rb</em></span> supplied in the sample file <span class="emphasis"><em>sayhello2.rb</em></span>) and only tiny bits of embedded Ruby (a couple of variables) were placed into the view:</p><a id="I_programlisting19_d1e23193"/><pre class="programlisting">&lt;%= @heading %&gt;
&lt;%= @class_hierarchy %&gt;</pre><p>You will probably agree that the first version, in which the programming logic was put into the Controller rather than embedded into the View, is neater. On the whole, Ruby code belongs in Ruby code files, and HTML formatting belongs in HTML files. Although embedded Ruby provides an easy way of letting a View and a Controller communicate, it is generally better to keep embedded Ruby code short and simple and put more complex Ruby code into Ruby code files.</p></div>
<div class="sect1" title="Let&#x2019;s Make a Blog!"><div class="titlepage"><div><div><h1 class="title"><a id="letas_make_a_blog_exclamation"/>Let’s Make a Blog!</h1></div></div></div><p>For many people, the one thing that really “turned them on” to Ruby on Rails was the 20-minute demo given by Rails’s creator, David Heinemeier Hansson, in which he showed how to create a simple weblog. That demo was originally done using Rails 1 and has since been updated (and changed somewhat) for Rails 2 and Rails 3. You can watch the latest demos online at <a class="ulink" href="http://www.rubyonrails.com/screencasts/">http://www.rubyonrails.com/screencasts/</a>.<a id="IDX-CHP-19-0069" class="indexterm"/><a id="IDX-CHP-19-0070" class="indexterm"/><a id="IDX-CHP-19-0071" class="indexterm"/><a id="IDX-CHP-19-0072" class="indexterm"/><a id="IDX-CHP-19-0073" class="indexterm"/></p><p>A blog is a great way to show how easy it is to create a fairly complex application using Rails. In the remainder of this chapter, I’ll explain how you can create a very simple blog application. I’ll use a feature called <span class="emphasis"><em>migrations</em></span>, which will cut out a lot of the hard work of creating the database structure of the Model.</p><p>Bear in mind that I have tried to keep the creation of this application as simple as possible. It is not an exact duplication of David Heinemeier Hansson’s tutorial, and it has only a subset of the features of a fully functional blog (there are no user comments and no administration interface, for example). Once you have completed my blog application, you may want to study the screencast tutorials mentioned earlier. These will show you alternative ways of producing similar results, and they will also take you further toward the creation of a more complex blog.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>You can compare the code of your blog application with one I created. My code is supplied in the <span class="emphasis"><em>\blog</em></span> subdirectory of the code accompanying this chapter. This blog application is not “ready to run,” however, because it requires a database that you will have to create. You should create your own blog application by following the instructions given in the chapter. You may use the supplied code as a reference to check that the files you create match the ones I created.</p></div><p>Open a command prompt in the directory in which you keep your Rails applications (for example, <span class="emphasis"><em>C:\railsapps</em></span>), and execute a command to create an application called Blog:</p><p><span class="emphasis"><em>Rails 3</em></span></p><a id="I_programlisting19_d1e23242"/><pre class="programlisting">rails new blog</pre><p><span class="emphasis"><em>Rails 2</em></span></p><a id="I_programlisting19_d1e23247"/><pre class="programlisting">rails blog</pre><div class="sect2" title="Create the Database"><div class="titlepage"><div><div><h2 class="title"><a id="create_the_database"/>Create the Database</h2></div></div></div><p>Now let’s create a database. Here I am assuming you are using either the SQLite3 or MySQL database. As said earlier, SQLite3 is regarded as the standard database system for local development with Rails 3, and it is easier to set up and use. MySQL, on the other hand, is an industry-standard database that is more likely to be used for deployment on a website. If you are using SQLite3, you won’t need to take any special actions to create the database—Rails does it for you. You can skip straight to <a class="xref" href="ch19s10.html#scaffolding" title="Scaffolding">Scaffolding</a> in <a class="xref" href="ch19s10.html#creating_a_mysql_database" title="Creating a MySQL Database">Creating a MySQL Database</a>. If you are using MySQL, you should follow the steps outlined in the next sections.</p></div><div class="sect2" title="Creating a MySQL Database"><div class="titlepage"><div><div><h2 class="title"><a id="creating_a_mysql_database"/>Creating a MySQL Database</h2></div></div></div><p>If you are using MySQL, open a MySQL prompt by running the MySQL Command Line Client from the MySQL program group. When prompted, enter your MySQL password. Now you should see this prompt:<a id="IDX-CHP-19-0074" class="indexterm"/><a id="IDX-CHP-19-0075" class="indexterm"/><a id="IDX-CHP-19-0076" class="indexterm"/><a id="IDX-CHP-19-0077" class="indexterm"/><a id="IDX-CHP-19-0078" class="indexterm"/><a id="IDX-CHP-19-0079" class="indexterm"/></p><a id="I_programlisting19_d1e23288"/><pre class="programlisting">mysql&gt;</pre><p>Enter the following at the prompt (be sure to put the semicolon at the end):</p><a id="I_programlisting19_d1e23292"/><pre class="programlisting">create database blog_development;</pre><p>MySQL should reply “Query OK” to confirm that the database has been created. Now ensure that your database configuration file for your Rails application contains the appropriate entries for the development database. If you are using some other database (not MySQL), your configuration entries must refer to that database.</p><p>Go to the folder in which Rails created your new blog application, and open the file <span class="emphasis"><em>database.yml</em></span> in the <span class="emphasis"><em>\config\</em></span> subdirectory. Assuming you are using MySQL, enter <span class="emphasis"><em>mysql</em></span> as the adapter, <span class="emphasis"><em>localhost</em></span> as the host, your MySQL username (for example, <span class="emphasis"><em>root</em></span>), and your password, if you have one. The database name should match the database you just created. Here is an example (where you would enter an actual password instead of <em class="replaceable"><code>mypassword</code></em>):<a id="IDX-CHP-19-0080" class="indexterm"/></p><a id="I_programlisting19_d1e23322"/><pre class="programlisting">development:
  adapter: mysql
  host: localhost
  username: root
  database: blog_development
  password: <em class="replaceable"><code>mypassword</code></em></pre><div class="note" title="Note"><h3 class="title">Note</h3><p>If the server is running when you make changes to <span class="emphasis"><em>database.yml</em></span>, you should restart the server afterward!</p></div><p>It is common to have multiple configurations—for example, for development, test, and production. For the sake of simplicity, here you will create a development configuration only; you may comment out any other entries in <span class="emphasis"><em>database.yml</em></span>.</p></div><div class="sect2" title="Scaffolding"><div class="titlepage"><div><div><h2 class="title"><a id="scaffolding"/>Scaffolding</h2></div></div></div><p>You are going to use a feature called <span class="emphasis"><em>scaffolding</em></span> to create a model, views, and controllers all in one go. Scaffolding is a convenient way of getting a simple application up and running quickly. Move into the new <span class="emphasis"><em>\blog</em></span> directory, and enter the following at the system prompt:<a id="IDX-CHP-19-0081" class="indexterm"/><a id="IDX-CHP-19-0082" class="indexterm"/></p><p><span class="emphasis"><em>Rails 3</em></span></p><a id="I_programlisting19_d1e23359"/><pre class="programlisting">rails generate scaffold post title:string body:text created_at:datetime</pre><p><span class="emphasis"><em>Rails 2</em></span></p><a id="I_programlisting19_d1e23364"/><pre class="programlisting">ruby script/generate scaffold post title:string body:text created_at:datetime</pre><p>This tells the scaffold generator to create a model comprising Ruby code to access a database table called <span class="emphasis"><em>post</em></span> with three columns, <span class="emphasis"><em>title</em></span>, <span class="emphasis"><em>body</em></span>, and <span class="emphasis"><em>created_at</em></span>, each of which has the data type (<span class="emphasis"><em>string</em></span>, <span class="emphasis"><em>text</em></span> and <span class="emphasis"><em>datetime</em></span>) specified after the colon. To create the database structure based on this model, you need to run a “migration” to update the database table itself.<a id="IDX-CHP-19-0083" class="indexterm"/><a id="IDX-CHP-19-0084" class="indexterm"/><a id="IDX-CHP-19-0085" class="indexterm"/></p></div><div class="sect2" title="Migration"><div class="titlepage"><div><div><h2 class="title"><a id="migration"/>Migration</h2></div></div></div><p>The scaffold script has created a database migration file for you. Navigate to the <span class="emphasis"><em>\db\migrate</em></span> directory. You will see that this contains a numbered migration file whose name ends with <span class="emphasis"><em>_create_posts.rb</em></span>. If you open this file, you can see how the table structure is represented in Ruby code:</p><a id="I_programlisting19_d1e23414"/><pre class="programlisting">def self.up
    create_table :posts do |t|
        t.string :title
        t.text :body
        t.datetime :created_at

        t.timestamps
    end
end</pre><p>An application may, over time, gain numerous migrations, each of which contains information on a specific iteration of the Model—changes and additions made to the table structure of the database. Experienced Rails developers can use migrations selectively to activate different versions of the Model. Here, however, you will use this migration to create the initial structure of the database.</p><p>At the system prompt in your application’s main directory (for example, <span class="emphasis"><em>/blog</em></span>), you can use the <code class="literal">rake</code> tool to run the migration. Enter this command:<a id="IDX-CHP-19-0086" class="indexterm"/></p><a id="I_programlisting19_d1e23429"/><pre class="programlisting">rake db:migrate</pre><p>After a few moments, you should see a message stating that the <code class="literal">rake</code> task has completed and that CreatePosts has been migrated.</p></div><div class="sect2" title="Partials"><div class="titlepage"><div><div><h2 class="title"><a id="partials"/>Partials</h2></div></div></div><p>Now let’s create a new partial view template. A <span class="emphasis"><em>partial</em></span> is a fragment of a web page template that Rails may insert, at runtime, into one or more complete web pages. If, for example, you plan to have the same data entry form in multiple pages on your site, you could create that form inside a partial template. The names of partial templates begin with an underscore.</p><div class="sidebar"><a id="mysql_errors_question"/><p class="title">MySQL Errors?</p><p>If you are using MySQL and you see errors when you run <code class="literal">rake</code>, first verify that MySQL is installed, as explained in <a class="xref" href="apb.html" title="Appendix B. Installing MySQL for Ruby on Rails">Appendix B</a>. Also watch out for any error messages that begin with something like the following:<a id="IDX-CHP-19-0087" class="indexterm"/><a id="IDX-CHP-19-0088" class="indexterm"/></p><a id="I_programlisting19_d1e23466"/><pre class="programlisting">rake aborted!
!!! Missing the mysql gem. Add it to your Gemfile: gem 'mysql', '2.8.1'</pre><p>If you see this, you will need to add the specified entry to a file named <span class="emphasis"><em>Gemfile</em></span>, which you will find in the top-level directory of your application (for example, <span class="emphasis"><em>\blog</em></span>). For example, given the previous message, you would need to add this text to G<span class="emphasis"><em>emfile</em></span>:<a id="IDX-CHP-19-0089" class="indexterm"/></p><a id="I_programlisting19_d1e23482"/><pre class="programlisting">gem 'mysql', '2.8.1'</pre></div><p>Create a new file called <span class="emphasis"><em>_post.html.erb</em></span> in your <span class="emphasis"><em>\app\views\posts\</em></span> directory. Open this file, and edit its contents to match the following (or you may copy the <span class="emphasis"><em>_post.html.erb</em></span> from the sample project in the source code archive):</p><p><span class="emphasis"><em>_post.html.erb</em></span></p><a id="I_programlisting19_d1e23498"/><pre class="programlisting">&lt;div&gt;
&lt;h2&gt;&lt;%= link_to post.title, :action =&gt; 'show', :id =&gt; post %&gt;&lt;/h2&gt;
&lt;p&gt;&lt;%= post.body %&gt;&lt;/p&gt;
&lt;p&gt;&lt;small&gt;
&lt;%= post.created_at.to_s %&gt;
&lt;/small&gt;&lt;/p&gt;
&lt;/div&gt;</pre><p>Save your changes. Then open the file named <span class="emphasis"><em>show.html.erb</em></span>. This file was automatically created by the scaffold script. Delete the following “boilerplate” code from the file:</p><a id="I_programlisting19_d1e23505"/><pre class="programlisting">&lt;b&gt;Title:&lt;/b&gt;
 &lt;%=h @post.title %&gt;
&lt;/p&gt;

&lt;p&gt;
 &lt;b&gt;Body:&lt;/b&gt;
 &lt;%=h @post.body %&gt;
&lt;/p&gt;

&lt;p&gt;
 &lt;b&gt;Created at:&lt;/b&gt;
 &lt;%=h @post.created_at %&gt;
&lt;/p&gt;</pre><p>And replace it with this:<a id="IDX-CHP-19-0090" class="indexterm"/><a id="IDX-CHP-19-0091" class="indexterm"/><a id="IDX-CHP-19-0092" class="indexterm"/></p><a id="I_programlisting19_d1e23524"/><pre class="programlisting">&lt;%= render :partial =&gt; "post", :object =&gt; @post %&gt;</pre><p>This tells Rails to render the <code class="literal">_post</code> partial template at this point. The code in <span class="emphasis"><em>show.html.erb</em></span> should now look like this:</p><a id="I_programlisting19_d1e23535"/><pre class="programlisting">&lt;%= render :partial =&gt; "post", :object =&gt; @post %&gt;

&lt;%= link_to 'Edit', edit_post_path(@post) %&gt; |
&lt;%= link_to 'Back', posts_path %&gt;</pre></div><div class="sect2" title="Test It!"><div class="titlepage"><div><div><h2 class="title"><a id="test_it_exclamation"/>Test It!</h2></div></div></div><p>And that’s it! Now you are ready to test your application. First, run the server. At the prompt in the <span class="emphasis"><em>\blog</em></span> directory, enter this:</p><p><span class="emphasis"><em>Rails 3</em></span></p><a id="I_programlisting19_d1e23548"/><pre class="programlisting">rails server</pre><p><span class="emphasis"><em>Rails 2</em></span></p><a id="I_programlisting19_d1e23553"/><pre class="programlisting">ruby script/server</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>Recall that if you are not using the default port, 3000, you will need to specify the actual port number after <code class="literal">-p</code> as explained earlier in this chapter, for example: <code class="literal">rails server -p3003</code>.</p></div><p>Go into your web browser, and enter the following address (again, use the actual port number if this is not 3000):</p><a id="I_programlisting19_d1e23566"/><pre class="programlisting">http://localhost:3000/posts</pre><p>You should see your page with its index page active. This is what should appear:</p><div class="informalfigure"><a id="image_no_caption-id25"/><div class="mediaobject"><a id="I_mediaobject19_d1e23571"/><img src="httpatomoreillycomsourcenostarchimages860173.png" alt="image with no caption"/></div></div><p>Now click the New Post link. In the New Post page, enter a title and some body text. Then click <span class="strong"><strong>Create</strong></span>.</p><div class="informalfigure"><a id="image_no_caption-id26"/><div class="mediaobject"><a id="I_mediaobject19_d1e23583"/><img src="httpatomoreillycomsourcenostarchimages860177.png.jpg" alt="image with no caption"/></div></div><p>The next page that displays is the Show page. This is defined by the combination of the <span class="emphasis"><em>show.html.erb</em></span> view and the <span class="emphasis"><em>_post.html.erb</em></span> partial. Now carry on entering posts and clicking the links to navigate through the various defined views.</p><div class="informalfigure"><a id="image_no_caption-id27"/><div class="mediaobject"><a id="I_mediaobject19_d1e23597"/><img src="httpatomoreillycomsourcenostarchimages860181.png.jpg" alt="image with no caption"/></div></div><div class="note" title="Note"><h3 class="title">Note</h3><p>As mentioned earlier, this chapter assumes you are using Rails “in the raw,” by entering all the necessary commands at the system prompt. Some IDEs provide a more integrated environment, which allows you to generate and code your application using built-in tools and utilities. You will find an overview of some Ruby and Rails IDEs in <a class="xref" href="apd.html" title="Appendix D. Ruby and Rails Development Software">Appendix D</a>.</p></div><div class="sidebar"><a id="digging_deeper-id18"/><p class="title">Digging Deeper</p><p>The three letters “MVC” are fundamental to understanding how Rails works. Here I explain the underlying concepts. You will also learn about the Rails directory structure and alternative Ruby frameworks.<a id="IDX-CHP-19-0093" class="indexterm"/><a id="IDX-CHP-19-0094" class="indexterm"/><a id="IDX-CHP-19-0095" class="indexterm"/><a id="IDX-CHP-19-0096" class="indexterm"/><a id="IDX-CHP-19-0097" class="indexterm"/><a id="IDX-CHP-19-0098" class="indexterm"/></p><p><span class="bolditalic">MVC</span></p><p>As explained earlier, Rails adopts the Model-View-Controller (MVC) paradigm. Put simply, these may be thought of as the database (Model), the display (View), and the programming logic (Controller).<a id="IDX-CHP-19-0099" class="indexterm"/><a id="IDX-CHP-19-0100" class="indexterm"/><a id="IDX-CHP-19-0101" class="indexterm"/><a id="IDX-CHP-19-0102" class="indexterm"/><a id="IDX-CHP-19-0103" class="indexterm"/></p><p>Although these three component parts are, in theory, separate entities, there is, in practice, inevitably a degree of overlap. For instance, some calculations may be done in the Model with others done in the Controller; operations that affect the formatting of data could happen in the Controller or in the View. There are no hard-and-fast rules—just a general principle that, as much as possible, operations “close to the data” should happen in the Model, operations “close to the display” should happen in the View, and everything else should go into the Controller.</p><p>That’s MVC in theory. Now let’s see how it is implemented by Rails.</p><p><span class="strong"><strong>Model</strong></span></p><p>The Model in Ruby on Rails is a combination of tables in a database—handled by a database server such as MySQL—and a matching set of Ruby classes to work upon those tables. For example, in a blog you might have a database containing a table called Posts. In that case, the Rails model would also contain a Ruby class named Post (notice that Rails works with plurals—the Posts table can contain many Post objects). The Ruby Post class would typically contain methods to find, save, or load individual Post records from the Posts database. This combination of database tables and corresponding Ruby classes comprises a Rails Model.</p><p><span class="strong"><strong>View</strong></span></p><p>The View is pretty much what it sounds like—the visual representation of a Ruby on Rails application. It is (typically but not necessarily) created in the form of HTML templates with some Ruby code mixed in. In fact, other view types (for example, a graphical view made using Adobe’s Flex or Microsoft’s Silverlight) are possible, but the Rails default is HTML. These templates, which generally have the extension <span class="emphasis"><em>.html.erb</em></span> (but may also use the extension <span class="emphasis"><em>.rhtml</em></span> that was the Rails 1 default), are not loaded directly into a web browser—after all, web browsers haven’t any way of running Ruby code. Instead, they are preprocessed by a separate tool that executes the Ruby code in order to interact with the Model (finding or editing data as necessary); then, as an end result, it creates a new HTML page whose basic layout is defined by an ERb template but whose actual data (that is, the blog posts, shopping cart items, or whatever) are provided by the Model. This makes it possible to create highly dynamic web pages that change as a user interacts with them.<a id="IDX-CHP-19-0104" class="indexterm"/><a id="IDX-CHP-19-0105" class="indexterm"/><a id="IDX-CHP-19-0106" class="indexterm"/></p><p><span class="strong"><strong>Controller</strong></span></p><p>The Controller takes the form of Ruby code files that act as go-betweens that link the Model and the View. For example, in the web page (the View), a user might click a button to add a new post to a blog; using ordinary HTML, this button submits a value named <code class="literal">Create</code>. This causes a method named <code class="literal">create</code>, in a <code class="literal">post</code> “controller” (a file of Ruby code) to save the new blog entry (some text) that has been entered in the web page (the View) into the database (the data repository of the Model).<a id="IDX-CHP-19-0107" class="indexterm"/><a id="IDX-CHP-19-0108" class="indexterm"/></p><p><span class="bolditalic">The Rails Folders</span></p><p>This is a simplified guide to the top-level folders generated by Rails, with a brief description of the files and folders they contain:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/></colgroup><tbody><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>app</em></span></p></td><td style="text-align: left" valign="top"><p>This contains the code specific to this application. Subfolders may include <span class="emphasis"><em>app\controllers</em></span>, <span class="emphasis"><em>app\models</em></span>, <span class="emphasis"><em>app\views</em></span>, <span class="emphasis"><em>app\helpers</em></span>, and <span class="emphasis"><em>app\mailers</em></span>.</p></td></tr><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>config</em></span></p></td><td style="text-align: left" valign="top"><p>This contains configuration files for the Rails environment, the routing map, the database, and other dependencies; database configuration is put into the file <span class="emphasis"><em>database.yml</em></span>.</p></td></tr><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>db</em></span></p></td><td style="text-align: left" valign="top"><p>This contains the database schema in <span class="emphasis"><em>schema.rb</em></span> and may contain code that works on the data in the database. If migrations have been applied, it will also contain migration files in the <span class="emphasis"><em>\migrate</em></span> subdirectory.</p></td></tr><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>doc</em></span></p></td><td style="text-align: left" valign="top"><p>This may contain RDOC documentation (see <a class="xref" href="apa.html" title="Appendix A. Documenting Ruby with RDoc">Appendix A</a> for more on RDOC).</p></td></tr><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>lib</em></span></p></td><td style="text-align: left" valign="top"><p>This may contain code libraries (that is, code that does not logically belong in <span class="emphasis"><em>\controllers, \models</em></span>, or <span class="emphasis"><em>\helpers</em></span>) for the application.</p></td></tr><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>log</em></span></p></td><td style="text-align: left" valign="top"><p>This may contain error logs.</p></td></tr><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>public</em></span></p></td><td style="text-align: left" valign="top"><p>This directory contains “static” files that may be used by the web server. It has subdirectories for <span class="emphasis"><em>images</em></span>, <span class="emphasis"><em>stylesheets</em></span>, and <span class="emphasis"><em>javascripts</em></span>.</p></td></tr><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>script</em></span></p></td><td style="text-align: left" valign="top"><p>This contains scripts that Rails uses to perform various tasks such as generating certain file types and running the web server.</p></td></tr><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>test</em></span></p></td><td style="text-align: left" valign="top"><p>This may contain tests generated by Rails or specified by the user.</p></td></tr><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>tmp</em></span></p></td><td style="text-align: left" valign="top"><p>This contains temporary files used by Rails.</p></td></tr><tr><td style="text-align: left" valign="top"><p><span class="emphasis"><em>vendor</em></span></p></td><td style="text-align: left" valign="top"><p>This may contain third-party libraries that do not form part of the default Rails installation.</p></td></tr></tbody></table></div><p><span class="bolditalic">Other Ruby Frameworks</span></p><p>Rails may be the most famous Ruby framework, but it certainly is not the only one. Others such as Ramaze and Sinatra also have a dedicated following. A framework called Merb was once seen as the closest competitor to Rails. However, in December 2008, the Rails and Merb teams announced they would be collaborating on the next iteration of Rails, and it was that collaboration that resulted in Rails 3.<a id="IDX-CHP-19-0109" class="indexterm"/><a id="IDX-CHP-19-0110" class="indexterm"/><a id="IDX-CHP-19-0111" class="indexterm"/><a id="IDX-CHP-19-0112" class="indexterm"/></p><p>If you are interested in exploring other Ruby frameworks, follow these links:<a id="IDX-CHP-19-0113" class="indexterm"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Ramaze: <a class="ulink" href="http://www.ramaze.net/">http://www.ramaze.net/</a></p></li><li class="listitem"><p>Sinatra: <a class="ulink" href="http://www.sinatrarb.com/">http://www.sinatrarb.com/</a></p></li><li class="listitem"><p>Waves: <a class="ulink" href="http://www.rocket.ly/waves">http://www.rocket.ly/waves</a><a id="IDX-CHP-19-0114" class="indexterm"/></p></li></ul></div><p>Bear in mind that open source Ruby frameworks have a tendency to come and go, waxing and waning according to the enthusiasm or other commitments of the core developers. The Ramaze team maintains a list of Ruby frameworks on its home wiki: <a class="ulink" href="http://wiki.ramaze.net/Home#other-frameworks">http://wiki.ramaze.net/Home#other-frameworks</a>.</p></div></div></div></body></html>