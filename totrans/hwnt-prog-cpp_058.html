<html><head></head><body>

<div class="calibre21" id="calibre_pb_0"/><div class="calibre1" id="calibre_toc_64">
<a name="ch04" class="calibre6" id="ch04"/>
<div class="calibre1">
<h2 class="lot-title" id="calibre_pb_1"><a name="66" class="calibre16" id="66"/><a name="ch04lev1sec30" class="calibre16" id="ch04lev1sec30"/><span class="chapter-titlelabel">Program 56: </span>The Magic Is Gone from the Program</h2><p class="b24-bookeditorial">The following program is designed to see if two files in two directories contain a magic number.</p>
<p class="b24-bookeditorial">In our test case, we have the files:</p>
<div class="calibre1">
<pre class="literallayout-normal">
         first/first
         second/second
</pre>
</div>
<p class="b24-bookeditorial">Both these files contain the magic number.</p>
<p class="b24-bookeditorial">What does the program output and why?</p>
<div class="calibre1">
<pre class="literallayout-normal">
  1 /************************************************
  2  * scan_dir -- Scan directories for magic files *
  3  *      and report the results.                 *
  4  *                                              *
  5  * Test on the directories "first" and "second".*
  6  ************************************************/
  7 #include &lt;iostream&gt;
  8 #include &lt;dirent.h&gt;
  9 #include &lt;fcntl.h&gt;
 10 #include &lt;unistd.h&gt;
 11 const long int MAGIC = 0Ã—464c457f; // Linux executable magic #
 12 /************************************************
 13  * next_file -- find a list of files with magic *
 14  *      numbers that match the given number.    *
 15  *                                              *
 16  * Returns the name of the file or              *
 17  *      NULL if no more files.                  *
 18  ************************************************/
 19 char *next_file(
 20     DIR  *dir           // Directory to scan
 21 ) {
 22     // Current entry in the dir
 23     struct dirent *cur_ent;
 24
 25     while (1) {
 26
 27         cur_ent = readdir(dir);
 28         if (cur_ent == NULL)
 29             return (NULL);
 30
 31         int fd = open(cur_ent-&gt;d_name, 0_RDONLY);
 32         if (fd &lt; 0) {
 33             // Can't get the file so try again
 34             continue;
 35         }
 36
 37         int magic;      // The file's magic number
 38
 39         // Size of the header read
 40         int read_size =
 41             read(fd, &amp;magic, sizeof(magic));
 42
 43         if (read_size != sizeof(magic)) {
 44             close(fd);
 45             continue;
 46         }
 47
 48         if (magic == MAGIC) {
 49             close(fd);
 50             return (cur_ent-&gt;d_name);
 51         }
 52         close(fd);
 53     }
 54 }
 55 /************************************************
 56  * scan_dir -- Scan a directory for the files   *
 57  *      we want.                                *
 58  ************************************************/
 59 char *scan_dir(
 60     const char dir_name[] // Directory name to use
 61 ) {
 62     // Directory to scan
 63     DIR *dir_info = opendir(dir_name);
 64     if (dir_info == NULL)
 65         return (NULL);
 66
 67     chdir(dir_name);
 68
 69     // Name of the file we just found
 70     char *name = next_file(dir_info);
 71     closedir(dir_info);
 72
 73     chdir("..");        // Undo the original chdir
 74
 75     return (name);
 76 }
 77
 78 int main() {
 79     // Find a file in the directory "first"
 80     char *first_ptr = scan_dir("first");
 81
 82     // Find a file in the directory "second"
 83     char *second_ptr = scan_dir("second");
 84
 85     // Print the information about the dir first
 86     if (first_ptr == NULL) {
 87         std::cout &lt;&lt; "First: NULL ";
 88     } else {
 89         std::cout &lt;&lt; "First: " &lt;&lt; first_ptr &lt;&lt; " ";
 90     }
 91     std::cout &lt;&lt; '\n';
 92
 93     // Print the information about the dir second
 94     if (second_ptr == NULL) {
 95         std::cout &lt;&lt; "Second: NULL ";
 96     } else {
 97         std::cout &lt;&lt; "Second: " &lt;&lt; second_ptr &lt;&lt; "  ";
 98     }
 99     std::cout &lt;&lt; '\n';
100     return (0);
101 }
</pre>
</div>
<p class="b24-bookeditorial">(Next <a href="LiB0120.html#222" target="_parent" class="calibre2">Hint 86</a>. <a href="LiB0121.html#598" target="_parent" class="calibre2">Answer 100</a>.)</p>
<div class="calibre1">
<table class="calibre3" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr class="calibre4">
<td class="bluecell"><span class="calibre22"><b class="calibre13"><img src="_1.gif" alt="Start Sidebar" border="0" class="calibre23"/></b></span></td>
</tr>
</table>
<p class="b24-bookeditorial">Real Software Engineers work from 9 to 5, because that is the way the job is described in the formal spec. Working late would feel like using an undocumented external procedure.</p>
<table class="calibre3" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr class="calibre4">
<td class="bluecell"><span class="calibre22"><b class="calibre13"><img src="_1.gif" alt="End Sidebar" border="0" class="calibre23"/></b></span></td>
</tr>
</table>
</div>
<table class="calibre3" border="0" cellspacing="0" cellpadding="0" width="100%">
<tr class="calibre4">
<td height="16" class="calibre8"/>
</tr>
</table>
</div>
</div>



</body></html>