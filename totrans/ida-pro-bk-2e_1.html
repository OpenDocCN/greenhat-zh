<html><head></head><body><div class="part" title="Part&#xA0;I.&#xA0;Introduction to IDA"><div class="titlepage"><div><div><h1 class="title"><a id="introduction_to_ida"/>Part I. Introduction to IDA</h1></div></div></div><div class="partintro" id="id2913591" title="Introduction to IDA"><div/><p/></div></div>
<div class="chapter" title="Chapter&#xA0;1.&#xA0;Introduction to Disassembly"><div class="titlepage"><div><div><h1 class="title"><a id="introduction_to_disassembly"/>Chapter 1. Introduction to Disassembly</h1></div></div></div><div class="informalfigure"><a id="image_no_caption-id1"/><div class="mediaobject"><a id="I_mediaobject1_d1e326"/><img alt="image with no caption" src="httpatomoreillycomsourcenostarchimages854059.png.jpg"/></div></div><p>You may be wondering what to expect in a book dedicated to IDA Pro. While obviously IDA-centric, this book is not intended to come across as <span class="emphasis"><em>The IDA Pro User’s Manual</em></span>. Instead, we intend to use IDA as the enabling tool for discussing reverse engineering techniques that you will find useful in analyzing a wide variety of software, ranging from vulnerable applications to malware. When appropriate, we will provide detailed steps to be followed in IDA for performing specific actions related to the task at hand. As a result we will take a rather roundabout walk through IDA’s capabilities, beginning with the basic tasks you will want to perform upon initial examination of a file and leading up to advanced uses and customization of IDA for more challenging reverse engineering problems. We make no attempt to cover all of IDA’s features. We do, however, cover the features that you will find most useful in meeting your reverse engineering challenges. This book will help make IDA the most potent weapon in your arsenal of tools.<a class="indexterm" id="IDX-CHP-1-0001"/></p><p>Prior to diving into any IDA specifics, it will be useful to cover some of the basics of the disassembly process as well as review some other tools available for reverse engineering of compiled code. While none of these tools offers the complete range of IDA’s capabilities, each does address specific subsets of IDA functionality and offer valuable insight into specific IDA features. The remainder of this chapter is dedicated to understanding the disassembly process.<a class="indexterm" id="IDX-CHP-1-0002"/><a class="indexterm" id="IDX-CHP-1-0003"/><a class="indexterm" id="IDX-CHP-1-0004"/><a class="indexterm" id="IDX-CHP-1-0005"/><a class="indexterm" id="IDX-CHP-1-0006"/><a class="indexterm" id="IDX-CHP-1-0007"/><a class="indexterm" id="IDX-CHP-1-0008"/><a class="indexterm" id="IDX-CHP-1-0009"/></p><div class="sect1" title="Disassembly Theory"><div class="titlepage"><div><div><h1 class="title"><a id="disassembly_theory"/>Disassembly Theory</h1></div></div></div><p>Anyone who has spent any time at all studying programming languages has probably learned about the various generations of languages, but they are summarized here for those who may have been sleeping.</p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>First-generation languages</strong></span></span></dt><dd><p>These are the lowest form of language, generally consisting of ones and zeros or some shorthand form such as hexadecimal, and readable only by binary ninjas. Things are confusing at this level because it is often difficult to distinguish data from instructions since everything looks pretty much the same. First-generation languages may also be referred to as <span class="emphasis"><em>machine languages</em></span>, and in some cases <span class="emphasis"><em>byte code</em></span>, while machine language programs are often referred to as <span class="emphasis"><em>binaries</em></span>.<a class="indexterm" id="IDX-CHP-1-0010"/><a class="indexterm" id="IDX-CHP-1-0011"/></p></dd><dt><span class="term"><span class="strong"><strong>Second-generation languages</strong></span></span></dt><dd><p>Also called <span class="emphasis"><em>assembly languages</em></span>, second-generation languages are a mere table lookup away from machine language and generally map specific bit patterns, or operation codes (opcodes), to short but memorable character sequences called <span class="emphasis"><em>mnemonics</em></span>. Occasionally these mnemonics actually help programmers remember the instructions with which they are associated. An <span class="emphasis"><em>assembler</em></span> is a tool used by programmers to translate their assembly language programs into machine language suitable for execution.<a class="indexterm" id="IDX-CHP-1-0012"/><a class="indexterm" id="IDX-CHP-1-0013"/><a class="indexterm" id="IDX-CHP-1-0014"/><a class="indexterm" id="IDX-CHP-1-0015"/><a class="indexterm" id="IDX-CHP-1-0016"/></p></dd><dt><span class="term"><span class="strong"><strong>Third-generation languages</strong></span></span></dt><dd><p>These languages take another step toward the expressive capability of natural languages by introducing keywords and constructs that programmers use as the building blocks for their programs. Third-generation languages are generally platform independent, though programs written using them may be platform dependent as a result of using features unique to a specific operating system. Often-cited examples include FORTRAN, COBOL, C, and Java. Programmers generally use compilers to translate their programs into assembly language or all the way to machine language (or some rough equivalent such as byte code).<a class="indexterm" id="IDX-CHP-1-0017"/><a class="indexterm" id="IDX-CHP-1-0018"/></p></dd><dt><span class="term"><span class="strong"><strong>Fourth-generation languages</strong></span></span></dt><dd><p>These exist but aren’t relevant to this book and will not be discussed.</p></dd></dl></div></div></div>
<div class="sect1" title="The What of Disassembly"><div class="titlepage"><div><div><h1 class="title"><a id="the_what_of_disassembly"/>The What of Disassembly</h1></div></div></div><p>In a traditional software development model, compilers, assemblers, and linkers are used by themselves or in combination to create executable programs. In order to work our way backwards (or reverse engineer programs), we use tools to undo the assembly and compilation processes. Not surprisingly, such tools are called <span class="emphasis"><em>disassemblers</em></span> and <span class="emphasis"><em>decompilers</em></span>, and they do pretty much what their names imply. A disassembler undoes the assembly process, so we should expect assembly language as the output (and therefore machine language as input). Decompilers aim to produce output in a high-level language when given assembly or even machine language as input.<a class="indexterm" id="IDX-CHP-1-0019"/><a class="indexterm" id="IDX-CHP-1-0020"/><a class="indexterm" id="IDX-CHP-1-0021"/><a class="indexterm" id="IDX-CHP-1-0022"/></p><p>The promise of “source code recovery” will always be attractive in a competitive software market, and thus the development of usable decompilers remains an active research area in computer science. The following are just a few of the reasons that decompilation is difficult:<a class="indexterm" id="IDX-CHP-1-0023"/></p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>The compilation process is lossy</strong></span>.</span></dt><dd><p>At the machine language level there are no variable or function names, and variable type information can be determined only by how the data is used rather than explicit type declarations. When you observe 32 bits of data being transferred, you’ll need to do some investigative work to determine whether those 32 bits represent an integer, a 32-bit floating point value, or a 32-bit pointer.</p></dd><dt><span class="term"><span class="strong"><strong>Compilation is a many-to-many operation</strong></span>.</span></dt><dd><p>This means that a source program can be translated to assembly language in many different ways, and machine language can be translated back to source in many different ways. As a result, it is quite common that compiling a file and immediately decompiling it may yield a vastly different source file from the one that was input.</p></dd><dt><span class="term"><span class="strong"><strong>Decompilers are very language and library dependent</strong></span>.</span></dt><dd><p>Processing a binary produced by a Delphi compiler with a decompiler designed to generate C code can yield very strange results. Similarly, feeding a compiled Windows binary through a decompiler that has no knowledge of the Windows programming API may not yield anything useful.</p></dd><dt><span class="term"><span class="strong"><strong>A nearly perfect disassembly capability is needed in order to accurately decompile a binary</strong></span>.</span></dt><dd><p>Any errors or omissions in the disassembly phase will almost certainly propagate through to the decompiled code.</p></dd></dl></div><p>Hex-Rays, the most sophisticated decompiler on the market today, will be reviewed in <a class="xref" href="ch23.html" title="Chapter 23. Real-World IDA Plug-ins">Chapter 23</a>.</p></div>
<div class="sect1" title="The Why of Disassembly"><div class="titlepage"><div><div><h1 class="title"><a id="the_why_of_disassembly"/>The Why of Disassembly</h1></div></div></div><p>The purpose of disassembly tools is often to facilitate understanding of programs when source code is unavailable. Common situations in which disassembly is used include these:<a class="indexterm" id="IDX-CHP-1-0024"/><a class="indexterm" id="IDX-CHP-1-0025"/><a class="indexterm" id="IDX-CHP-1-0026"/><a class="indexterm" id="IDX-CHP-1-0027"/><a class="indexterm" id="IDX-CHP-1-0028"/><a class="indexterm" id="IDX-CHP-1-0029"/><a class="indexterm" id="IDX-CHP-1-0030"/><a class="indexterm" id="IDX-CHP-1-0031"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Analysis of malware</p></li><li class="listitem"><p>Analysis of closed-source software for vulnerabilities</p></li><li class="listitem"><p>Analysis of closed-source software for interoperability</p></li><li class="listitem"><p>Analysis of compiler-generated code to validate compiler performance/correctness</p></li><li class="listitem"><p>Display of program instructions while debugging</p></li></ul></div><p>The subsequent sections will explain each situation in more detail.</p><div class="sect2" title="Malware Analysis"><div class="titlepage"><div><div><h2 class="title"><a id="malware_analysis"/>Malware Analysis</h2></div></div></div><p>Unless you are dealing with a script-based worm, malware authors seldom do you the favor of providing the source code to their creations. Lacking source code, you are faced with a very limited set of options for discovering exactly how the malware behaves. The two main techniques for malware analysis are dynamic analysis and static analysis. <span class="emphasis"><em>Dynamic analysis</em></span> involves allowing the malware to execute in a carefully controlled environment (sandbox) while recording every observable aspect of its behavior using any number of system instrumentation utilities. In contrast, <span class="emphasis"><em>static analysis</em></span> attempts to understand the behavior of a program simply by reading through the program code, which, in the case of malware, generally consists of a disassembly listing.</p></div><div class="sect2" title="Vulnerability Analysis"><div class="titlepage"><div><div><h2 class="title"><a id="vulnerability_analysis-id1"/>Vulnerability Analysis</h2></div></div></div><p>For the sake of simplification, let’s break the entire security-auditing process into three steps: vulnerability discovery, vulnerability analysis, and exploit development. The same steps apply whether you have source code or not; however, the level of effort increases substantially when all you have is a binary. The first step in the process is to discover a potentially exploitable condition in a program. This is often accomplished using dynamic techniques such as fuzzing,<sup>[<a class="footnote" href="#ftn.CHP-1-FN-1" id="CHP-1-FN-1">1</a>]</sup> but it can also be performed (usually with much more effort) via static analysis. Once a problem has been discovered, further analysis is often required to determine whether the problem is exploitable at all and, if so, under what conditions.<a class="indexterm" id="IDX-CHP-1-0032"/><a class="indexterm" id="IDX-CHP-1-0033"/></p><p>Disassembly listings provide the level of detail required to understand exactly how the compiler has chosen to allocate program variables. For example, it might be useful to know that a 70-byte character array declared by a programmer was rounded up to 80 bytes when allocated by the compiler. Disassembly listings also provide the only means to determine exactly how a compiler has chosen to order all of the variables declared globally or within functions. Understanding the spatial relationships among variables is often essential when attempting to develop exploits. Ultimately, by using a disassembler and a debugger together, an exploit may be developed.<a class="indexterm" id="IDX-CHP-1-0034"/><a class="indexterm" id="IDX-CHP-1-0035"/><a class="indexterm" id="IDX-CHP-1-0036"/><a class="indexterm" id="IDX-CHP-1-0037"/><a class="indexterm" id="IDX-CHP-1-0038"/><a class="indexterm" id="IDX-CHP-1-0039"/><a class="indexterm" id="IDX-CHP-1-0040"/><a class="indexterm" id="IDX-CHP-1-0041"/><a class="indexterm" id="IDX-CHP-1-0042"/></p></div><div class="sect2" title="Software Interoperability"><div class="titlepage"><div><div><h2 class="title"><a id="software_interoperability"/>Software Interoperability</h2></div></div></div><p>When software is released in binary form only, it is very difficult for competitors to create software that can interoperate with it or to provide plug-in replacements for that software. A common example is driver code released for hardware that is supported on only one platform. When a vendor is slow to support or, worse yet, refuses to support the use of its hardware with alternative platforms, substantial reverse engineering effort may be required in order to develop software drivers to support the hardware. In these cases, static code analysis is almost the only remedy and often must go beyond the software driver to understand embedded firmware.</p></div><div class="sect2" title="Compiler Validation"><div class="titlepage"><div><div><h2 class="title"><a id="compiler_validation"/>Compiler Validation</h2></div></div></div><p>Since the purpose of a compiler (or assembler) is to generate machine language, good disassembly tools are often required to verify that the compiler is doing its job in accordance with any design specifications. Analysts may also be interested in locating additional opportunities for optimizing compiler output and, from a security standpoint, ascertaining whether the compiler itself has been compromised to the extent that it may be inserting back doors into generated code.</p></div><div class="sect2" title="Debugging Displays"><div class="titlepage"><div><div><h2 class="title"><a id="debugging_displays"/>Debugging Displays</h2></div></div></div><p>Perhaps the single most common use of disassemblers is to generate listings within debuggers. Unfortunately, disassemblers embedded within debuggers tend to be fairly unsophisticated. They are generally incapable of batch disassembly and sometimes balk at disassembling when they cannot determine the boundaries of a function. This is one of the reasons why it is best to use a debugger in conjunction with a high-quality disassembler to provide better situational awareness and context during debugging.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-1-FN-1" id="ftn.CHP-1-FN-1">1</a>] </sup><span class="emphasis"><em>Fuzzing</em></span> is a vulnerability-discovery technique that relies on generating large numbers of unique inputs for programs in the hope that one of those inputs will cause the program to fail in a manner that can be detected, analyzed, and ultimately exploited.</p></div></div></div>
<div class="sect1" title="The How of Disassembly"><div class="titlepage"><div><div><h1 class="title"><a id="the_how_of_disassembly"/>The How of Disassembly</h1></div></div></div><p>Now that you’re well versed in the purposes of disassembly, it’s time to move on to how the process actually works. Consider a typical daunting task faced by a disassembler: <span class="emphasis"><em>Take these 100KB, distinguish code from data, convert the code to assembly language for display to a user, and please don’t miss anything along the way</em></span>. We could tack any number of special requests on the end of this, such as asking the disassembler to locate functions, recognize jump tables, and identify local variables, making the disassembler’s job that much more difficult.</p><p>In order to accommodate all of our demands, any disassembler will need to pick and choose from a variety of algorithms as it navigates through the files that we feed it. The quality of the generated disassembly listing will be directly related to the quality of the algorithms utilized and how well they have been implemented. In this section we will discuss two of the fundamental algorithms in use today for disassembling machine code. As we present these algorithms, we will also point out their shortcomings in order to prepare you for situations in which your disassembler appears to fail. By understanding a disassembler’s limitations, you will be able to manually intervene to improve the overall quality of the disassembly output.<a class="indexterm" id="IDX-CHP-1-0043"/><a class="indexterm" id="IDX-CHP-1-0044"/></p><div class="sect2" title="A Basic Disassembly Algorithm"><div class="titlepage"><div><div><h2 class="title"><a id="a_basic_disassembly_algorithm"/>A Basic Disassembly Algorithm</h2></div></div></div><p>For starters, let’s develop a simple algorithm for accepting machine language as input and producing assembly language as output. In doing so, we will gain an understanding of the challenges, assumptions, and compromises that underlie an automated disassembly process.</p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>Step 1</strong></span></span></dt><dd><p>The first step in the disassembly process is to identify a region of code to disassemble. This is not necessarily as straightforward as it may seem. Instructions are generally mixed with data, and it is important to distinguish between the two. In the most common case, disassembly of an executable file, the file will conform to a common format for executable files such as the <span class="emphasis"><em>Portable Executable (PE)</em></span> format used on Windows or the <span class="emphasis"><em>Executable and Linking Format (ELF)</em></span> common on many Unix-based systems. These formats typically contain mechanisms (often in the form of hierarchical file headers) for locating the sections of the file that contain code and entry points<sup>[<a class="footnote" href="#ftn.CHP-1-FN-2" id="CHP-1-FN-2">2</a>]</sup> into that code.<a class="indexterm" id="IDX-CHP-1-0045"/></p></dd><dt><span class="term"><span class="strong"><strong>Step 2</strong></span></span></dt><dd><p>Given an initial address of an instruction, the next step is to read the value contained at that address (or file offset) and perform a table lookup to match the binary opcode value to its assembly language mnemonic. Depending on the complexity of the instruction set being disassembled, this may be a trivial process, or it may involve several additional operations such as understanding any prefixes that may modify the instruction’s behavior and determining any operands required by the instruction. For instruction sets with variable-length instructions, such as the Intel x86, additional instruction bytes may need to be retrieved in order to completely disassemble a single instruction.</p></dd><dt><span class="term"><span class="strong"><strong>Step 3</strong></span></span></dt><dd><p>Once an instruction has been fetched and any required operands decoded, its assembly language equivalent is formatted and output as part of the disassembly listing. It may be possible to choose from more than one assembly language output syntax. For example, the two predominant formats for x86 assembly language are the Intel format and the AT&amp;T format.</p><div class="sidebar"><a id="x86_assembly_syntax_colon_atat_vs._intel"/><p class="title">X86 ASSEMBLY SYNTAX: AT&amp;T VS. INTEL</p><p>There are two main syntaxes used for assembly source code: AT&amp;T and Intel. Even though they are second-generation languages, the two vary greatly in syntax from variable, constant, and register access to segment and instruction size overrides to indirection and offsets. The AT&amp;T assembly syntax is distinguished by its use of the % symbol to prefix all register names, the use of $ as a prefix for literal constants (also called <span class="emphasis"><em>immediate operands</em></span>), and its operand ordering in which the source operand appears as the left-hand operand and the destination operand appears on the right. Using AT&amp;T syntax, the instruction to add four to the EAX register would read: <code class="literal">add $0x4,%eax</code>. The GNU Assembler (Gas) and many other GNU tools, including gcc and gdb, utilize AT&amp;T syntax.<a class="indexterm" id="IDX-CHP-1-0046"/><a class="indexterm" id="IDX-CHP-1-0047"/><a class="indexterm" id="IDX-CHP-1-0048"/><a class="indexterm" id="IDX-CHP-1-0049"/><a class="indexterm" id="IDX-CHP-1-0050"/><a class="indexterm" id="IDX-CHP-1-0051"/></p><p>Intel syntax differs from AT&amp;T in that it requires no register or literal prefixes and the operand ordering is reversed such that the source operand appears on the right and the destination appears on the left. The same add instruction using the Intel syntax would read: <code class="literal">add eax,0x4</code>. Assemblers utilizing Intel syntax include the Microsoft Assembler (MASM), Borland’s Turbo Assembler (TASM), and the Netwide Assembler (NASM).<a class="indexterm" id="IDX-CHP-1-0052"/><a class="indexterm" id="IDX-CHP-1-0053"/><a class="indexterm" id="IDX-CHP-1-0054"/><a class="indexterm" id="IDX-CHP-1-0055"/></p></div></dd><dt><span class="term"><span class="strong"><strong>Step 4</strong></span></span></dt><dd><p>Following the output of an instruction, we need to advance to the next instruction and repeat the previous process until we have disassembled every instruction in the file.</p></dd></dl></div><p>Various algorithms exist for determining where to begin a disassembly, how to choose the next instruction to be disassembled, how to distinguish code from data, and how to determine when the last instruction has been disassembled. The two predominant disassembly algorithms are <span class="emphasis"><em>linear sweep</em></span> and <span class="emphasis"><em>recursive descent</em></span>.</p></div><div class="sect2" title="Linear Sweep Disassembly"><div class="titlepage"><div><div><h2 class="title"><a id="linear_sweep_disassembly"/>Linear Sweep Disassembly</h2></div></div></div><p>The linear sweep disassembly algorithm takes a very straightforward approach to locating instructions to disassemble: Where one instruction ends, another begins. As a result, the most difficult decision faced is where to begin. The usual solution is to assume that everything contained in sections of a program marked as code (typically specified by the program file’s headers) represents machine language instructions. Disassembly begins with the first byte in a code section and moves, in a linear fashion, through the section, disassembling one instruction after another until the end of the section is reached. No effort is made to understand the program’s control flow through recognition of nonlinear instructions such as branches.<a class="indexterm" id="IDX-CHP-1-0056"/><a class="indexterm" id="IDX-CHP-1-0057"/></p><p>During the disassembly process, a pointer can be maintained to mark the beginning of the instruction currently being disassembled. As part of the disassembly process, the length of each instruction is computed and used to determine the location of the next instruction to be disassembled. Instruction sets with fixed-length instructions (MIPS, for example) are somewhat easier to disassemble, as locating subsequent instructions is straightforward.<a class="indexterm" id="IDX-CHP-1-0058"/></p><p>The main advantage of the linear sweep algorithm is that it provides complete coverage of a program’s code sections. One of the primary disadvantages of the linear sweep method is that it fails to account for the fact that data may be comingled with code. This is evident in <a class="xref" href="ch01s04.html#linear_sweep_disassembly-id1" title="Example 1-1. Linear sweep disassembly">Example 1-1</a>, which shows the output of a function disassembled with a linear sweep disassembler. This function contains a switch statement, and the compiler used in this case has elected to implement the switch using a jump table. Furthermore, the compiler has elected to embed the jump table within the function itself. The <code class="literal">jmp</code> statement at <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e812"/><img alt="" src="httpatomoreillycomsourcenostarchimages854061.png"/></span>, <code class="literal">401250</code>, references an address table starting at <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e821"/><img alt="" src="httpatomoreillycomsourcenostarchimages854063.png"/></span>, <code class="literal">401257</code>. Unfortunately, the disassembler treats <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e831"/><img alt="" src="httpatomoreillycomsourcenostarchimages854063.png"/></span> as if it were an instruction and incorrectly generates the corresponding assembly language representation:<a class="indexterm" id="IDX-CHP-1-0059"/><a class="indexterm" id="IDX-CHP-1-0060"/><a class="indexterm" id="IDX-CHP-1-0061"/><a class="indexterm" id="IDX-CHP-1-0062"/></p><div class="example"><a id="linear_sweep_disassembly-id1"/><p class="title">Example 1-1. Linear sweep disassembly</p><div class="example-contents"><pre class="programlisting">40123f:    55                       push   ebp
  401240:    8b ec                    mov    ebp,esp
  401242:    33 c0                    xor    eax,eax
  401244:    8b 55 08                 mov    edx,DWORD PTR [ebp+8]
  401247:    83 fa 0c                 cmp    edx,0xc
  40124a:    0f 87 90 00 00 00        ja     0x4012e0
<img alt="" src="httpatomoreillycomsourcenostarchimages854061.png"/> 401250:    ff 24 95 57 12 40 00     jmp    DWORD PTR [edx*4+0x401257]
<img alt="" src="httpatomoreillycomsourcenostarchimages854063.png"/> 401257:    e0 12                    loopne 0x40126b
  401259:    40                       inc    eax
  40125a:    00 8b 12 40 00 90        add    BYTE PTR [ebx-0x6fffbfee],cl
  401260:    12 40 00                 adc    al,BYTE PTR [eax]
  401263:    95                       xchg   ebp,eax
  401264:    12 40 00                 adc    al,BYTE PTR [eax]
  401267:    9a 12 40 00 a2 12 40     call   0x4012:0xa2004012
  40126e:    00 aa 12 40 00 b2        add    BYTE PTR [edx-0x4dffbfee],ch
  401274:    12 40 00                 adc    al,BYTE PTR [eax]
  401277:    ba 12 40 00 c2           mov    edx,0xc2004012
  40127c:    12 40 00                 adc    al,BYTE PTR [eax]
  40127f:    ca 12 40                 lret   0x4012
  401282:    00 d2                    add    dl,dl
  401284:    12 40 00                 adc    al,BYTE PTR [eax]
  401287:    da 12                    ficom  DWORD PTR [edx]
  401289:    40                       inc    eax
  40128a:    00 8b 45 0c eb 50        add    BYTE PTR [ebx+0x50eb0c45],cl
  401290:    8b 45 10                 mov    eax,DWORD PTR [ebp+16]
  401293:    eb 4b                    jmp    0x4012e0</pre></div></div><p>If we examine successive 4-byte groups as little-endian<sup>[<a class="footnote" href="#ftn.CHP-1-FN-3" id="CHP-1-FN-3">3</a>]</sup> values beginning at <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e872"/><img alt="" src="httpatomoreillycomsourcenostarchimages854063.png"/></span>, we see that each represents a pointer to a nearby address that is in fact the destination for one of various jumps (<code class="literal">004012e0</code>, <code class="literal">0040128b</code>, <code class="literal">00401290</code>, . . .). Thus, the <code class="literal">loopne</code> instruction at <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e891"/><img alt="" src="httpatomoreillycomsourcenostarchimages854063.png"/></span> is not an instruction at all. Instead, it indicates a failure of the linear sweep algorithm to properly distinguish embedded data from code.</p><p>Linear sweep is used by the disassembly engines contained in the GNU debugger (gdb), Microsoft’s WinDbg debugger, and the <code class="literal">objdump</code> utility.</p></div><div class="sect2" title="Recursive Descent Disassembly"><div class="titlepage"><div><div><h2 class="title"><a id="recursive_descent_disassembly"/>Recursive Descent Disassembly</h2></div></div></div><p>Recursive descent takes a different approach to locating instructions. Recursive descent focuses on the concept of control flow, which determines whether an instruction should be disassembled or not based on whether it is referenced by another instruction. To understand recursive descent, it is helpful to classify instructions according to how they affect the CPU instruction pointer.<a class="indexterm" id="IDX-CHP-1-0063"/><a class="indexterm" id="IDX-CHP-1-0064"/><a class="indexterm" id="IDX-CHP-1-0065"/><a class="indexterm" id="IDX-CHP-1-0066"/><a class="indexterm" id="IDX-CHP-1-0067"/></p><div class="sect3" title="Sequential Flow Instructions"><div class="titlepage"><div><div><h3 class="title"><a id="sequential_flow_instructions"/>Sequential Flow Instructions</h3></div></div></div><p>Sequential flow instructions pass execution to the instruction that immediately follows. Examples of sequential flow instructions include simple arithmetic instructions, such as <code class="literal">add</code>; register-to-memory transfer instructions, such as <code class="literal">mov</code>; and stack-manipulation operations, such as <code class="literal">push</code> and <code class="literal">pop</code>. For such instructions, disassembly proceeds as with linear sweep.<a class="indexterm" id="IDX-CHP-1-0068"/><a class="indexterm" id="IDX-CHP-1-0069"/><a class="indexterm" id="IDX-CHP-1-0070"/><a class="indexterm" id="IDX-CHP-1-0071"/></p></div><div class="sect3" title="Conditional Branching Instructions"><div class="titlepage"><div><div><h3 class="title"><a id="conditional_branching_instructions"/>Conditional Branching Instructions</h3></div></div></div><p>Conditional branching instructions, such as the x86 <code class="literal">jnz</code>, offer two possible execution paths. If the condition evaluates to true, the branch is taken, and the instruction pointer must be changed to reflect the target of the branch. However, if the condition is false, execution continues in a linear fashion, and a linear sweep methodology can be used to disassemble the next instruction. As it is generally not possible in a static context to determine the outcome of a conditional test, the recursive descent algorithm disassembles both paths, deferring disassembly of the branch target instruction by adding the address of the target instruction to a list of addresses to be disassembled at a later point.<a class="indexterm" id="IDX-CHP-1-0072"/><a class="indexterm" id="IDX-CHP-1-0073"/></p></div><div class="sect3" title="Unconditional Branching Instructions"><div class="titlepage"><div><div><h3 class="title"><a id="unconditional_branching_instructions"/>Unconditional Branching Instructions</h3></div></div></div><p>Unconditional branches do not follow the linear flow model and therefore are handled differently by the recursive descent algorithm. As with the sequential flow instructions, execution can flow to only one instruction; however, that instruction need not immediately follow the branch instruction. In fact, as seen in <a class="xref" href="ch01s04.html#linear_sweep_disassembly-id1" title="Example 1-1. Linear sweep disassembly">Example 1-1</a>, there is no requirement at all for an instruction to immediately follow an unconditional branch. Therefore, there is no reason to disassemble the bytes that follow an unconditional branch.</p><p>A recursive descent disassembler will attempt to determine the target of the unconditional jump and add the destination address to the list of addresses that have yet to be explored. Unfortunately, some unconditional branches can cause problems for recursive descent disassemblers. When the target of a jump instruction depends on a runtime value, it may not be possible to determine the destination of the jump using static analysis. The x86 instruction <code class="literal">jmp eax</code> demonstrates this problem. The <code class="literal">eax</code> register contains a value only when the program is actually running. Since the register contains no value during static analysis, we have no way to determine the target of the jump instruction, and consequently, we have no way to determine where to continue the disassembly process.</p></div><div class="sect3" title="Function Call Instructions"><div class="titlepage"><div><div><h3 class="title"><a id="function_call_instructions"/>Function Call Instructions</h3></div></div></div><p>Function call instructions operate in a manner very similar to unconditional jump instructions (including the inability of the disassembler to determine the target of instructions such as <code class="literal">call eax</code>), with the additional expectation that execution usually returns to the instruction immediately following the call instruction once the function completes. In this regard, they are similar to conditional branch instructions in that they generate two execution paths. The target address of the call instruction is added to a list for deferred disassembly, while the instruction immediately following the call is disassembled in a manner similar to linear sweep.<a class="indexterm" id="IDX-CHP-1-0074"/><a class="indexterm" id="IDX-CHP-1-0075"/><a class="indexterm" id="IDX-CHP-1-0076"/><a class="indexterm" id="IDX-CHP-1-0077"/><a class="indexterm" id="IDX-CHP-1-0078"/><a class="indexterm" id="IDX-CHP-1-0079"/></p><p>Recursive descent can fail if programs do not behave as expected when returning from called functions. For example, code in a function can deliberately manipulate the return address of that function so that upon completion, control returns to a location different from the one expected by the disassembler. A simple example is shown in the following incorrect listing, where function <code class="literal">foo</code> simply adds 1 to the return address before returning to the caller.</p><a id="I_programlisting1_d1e1028"/><pre class="programlisting">foo                 proc near
  FF 04 24          inc     dword ptr [esp]  ; increments saved return addr
  C3                retn
foo                 endp
; -------------------------------------
bar:
  E8 F7 FF FF FF    call    foo
  05 89 45 F8 90    <img alt="" src="httpatomoreillycomsourcenostarchimages854061.png"/>add   eax, 90F84589h</pre><p>As a result, control does not actually pass to the <code class="literal">add</code> instruction at <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e1041"/><img alt="" src="httpatomoreillycomsourcenostarchimages854061.png"/></span> following the call to <code class="literal">foo</code>. A proper disassembly appears below:</p><a id="I_programlisting1_d1e1050"/><pre class="programlisting">foo                 proc near
  FF 04 24          inc     dword ptr [esp]
  C3                retn
foo                 endp
; -------------------------------------
bar:
  E8 F7 FF FF FF    call    foo
  05                db    5 ;formerly the first byte of the add instruction
  89 45 F8          <img alt="" src="httpatomoreillycomsourcenostarchimages854063.png"/>mov   [ebp-8], eax
  90                nop</pre><p>This listing more clearly shows the actual flow of the program in which function <code class="literal">foo</code> actually returns to the <code class="literal">mov</code> instruction at <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e1066"/><img alt="" src="httpatomoreillycomsourcenostarchimages854063.png"/></span>. It is important to understand that a linear sweep disassembler will also fail to properly disassemble this code, though for slightly different reasons.</p></div><div class="sect3" title="Return Instructions"><div class="titlepage"><div><div><h3 class="title"><a id="return_instructions"/>Return Instructions</h3></div></div></div><p>In some cases, the recursive descent algorithm runs out of paths to follow. A function return instruction (x86 <code class="literal">ret</code>, for example) offers no information about what instruction will be executed next. If the program were actually running, an address would be taken from the top of the runtime stack, and execution would resume at that address. Disassemblers do not have the benefit of access to a stack. Instead, disassembly abruptly comes to a halt. It is at this point that the recursive descent disassembler turns to the list of addresses it has been setting aside for deferred disassembly. An address is removed from this list, and the disassembly process is continued from this address. This is the recursive process that lends the disassembly algorithm its name.</p><p>One of the principle advantages of the recursive descent algorithm is its superior ability to distinguish code from data. As a control flow–based algorithm, it is much less likely to incorrectly disassemble data values as code. The main disadvantage of recursive descent is the inability to follow indirect code paths, such as jumps or calls, which utilize tables of pointers to look up a target address. However, with the addition of some heuristics to identify pointers to code, recursive descent disassemblers can provide very complete code coverage and excellent recognition of code versus data. <a class="xref" href="ch01s04.html#recursive_descent_disassembly-id1" title="Example 1-2. Recursive descent disassembly">Example 1-2</a> shows the output of a recursive descent disassembler used on the same switch statement shown earlier in <a class="xref" href="ch01s04.html#linear_sweep_disassembly-id1" title="Example 1-1. Linear sweep disassembly">Example 1-1</a>.<a class="indexterm" id="IDX-CHP-1-0080"/></p><div class="example"><a id="recursive_descent_disassembly-id1"/><p class="title">Example 1-2. Recursive descent disassembly</p><div class="example-contents"><pre class="programlisting">0040123F   push ebp
00401240   mov  ebp, esp
00401242   xor  eax, eax
00401244   mov  edx, [ebp+arg_0]
00401247   cmp  edx, 0Ch             ; switch 13 cases
0040124A   ja   loc_4012E0           ; default
0040124A                             ; jumptable 00401250 case 0
00401250   jmp  ds:off_401257[edx*4] ; switch jump
00401250 ; ---------------------------------------------------
00401257 off_401257:
00401257   dd offset loc_4012E0  ; DATA XREF: sub_40123F+11r
00401257   dd offset loc_40128B  ; jump table for switch statement
00401257   dd offset loc_401290
00401257   dd offset loc_401295
00401257   dd offset loc_40129A
00401257   dd offset loc_4012A2
00401257   dd offset loc_4012AA
00401257   dd offset loc_4012B2
00401257   dd offset loc_4012BA
00401257   dd offset loc_4012C2
00401257   dd offset loc_4012CA
00401257   dd offset loc_4012D2
00401257   dd offset loc_4012DA
0040128B ; ---------------------------------------------------
0040128B
0040128B loc_40128B:             ; CODE XREF: sub_40123F+11j
0040128B                         ; DATA XREF: sub_40123F:off_401257o
0040128B   mov  eax, [ebp+arg_4] ; jumptable 00401250 case 1
0040128E   jmp  short loc_4012E0 ; default
0040128E                         ; jumptable 00401250 case 0</pre></div></div><p>Note that the table of jump destinations has been recognized and formatted accordingly. IDA Pro is the most prominent example of a recursive descent disassembler. An understanding of the recursive descent process will help us recognize situations in which IDA may produce less than optimal disassemblies and allow us to develop strategies to improve IDA’s output.</p></div></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-1-FN-2" id="ftn.CHP-1-FN-2">2</a>] </sup>A <span class="emphasis"><em>program entry point</em></span> is simply the address of the instruction to which the operating system passes control once a program has been loaded into memory.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-1-FN-3" id="ftn.CHP-1-FN-3">3</a>] </sup>A CPU is described as either big-endian or little-endian depending on whether the CPU saves the most significant byte of a multibyte value first (big-endian) or whether it stores the least significant byte first (little-endian).</p></div></div></div>
<div class="sect1" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="summary"/>Summary</h1></div></div></div><p>Is deep understanding of disassembly algorithms essential when using a disassembler? No. Is it useful? Yes! Battling your tools is the last thing you want to spend time doing while reverse engineering. One of the many advantages of IDA is that, unlike most other disassemblers, it offers you plenty of opportunity to guide and override its decisions. The net result is that the finished product, an accurate disassembly, will be far superior to anything else available.</p><p>In the next chapter we will review a variety of existing tools that prove useful in many reverse engineering situations. While not directly related to IDA, many of these tools have influenced and been influenced by IDA, and they help to explain the wide variety of informational displays available in the IDA user interface.</p></div>
<div class="chapter" title="Chapter&#xA0;2.&#xA0;Reversing and Disassembly Tools"><div class="titlepage"><div><div><h1 class="title"><a id="reversing_and_disassembly_tools"/>Chapter 2. Reversing and Disassembly Tools</h1></div></div></div><div class="informalfigure"><a id="image_no_caption-id2"/><div class="mediaobject"><a id="I_mediaobject2_d1e1107"/><img alt="image with no caption" src="httpatomoreillycomsourcenostarchimages854059.png.jpg"/></div></div><p>With some disassembly background under our belts, and before we begin our dive into the specifics of IDA Pro, it will be useful to understand some of the other tools that are used for reverse engineering binaries. Many of these tools predate IDA and continue to be useful for quick glimpses into files as well as for double-checking the work that IDA does. As we will see, IDA rolls many of the capabilities of these tools into its user interface to provide a single, integrated environment for reverse engineering. Finally, although IDA does contain an integrated debugger, we will not cover debuggers here as <a class="xref" href="ch24.html" title="Chapter 24. The IDA Debugger">Chapter 24</a>, <a class="xref" href="ch25.html" title="Chapter 25. Disassembler/Debugger Integration">Chapter 25</a>, and <a class="xref" href="ch26.html" title="Chapter 26. Additional Debugger Features">Chapter 26</a> are dedicated to the topic.</p><div class="sect1" title="Classification Tools"><div class="titlepage"><div><div><h1 class="title"><a id="classification_tools"/>Classification Tools</h1></div></div></div><p>When first confronted with an unknown file, it is often useful to answer simple questions such as “What is this thing?” The first rule of thumb when attempting to answer that question is to <span class="emphasis"><em>never</em></span> rely on a filename extension to determine what a file actually is. That is also the second, third, and fourth rules of thumb. Once you have become an adherent of the <span class="emphasis"><em>file extensions are meaningless</em></span> line of thinking, you may wish to familiarize yourself with one or more of the following utilities.<a class="indexterm" id="IDX-CHP-2-0001"/><a class="indexterm" id="IDX-CHP-2-0002"/><a class="indexterm" id="IDX-CHP-2-0003"/><a class="indexterm" id="IDX-CHP-2-0004"/><a class="indexterm" id="IDX-CHP-2-0005"/><a class="indexterm" id="IDX-CHP-2-0006"/><a class="indexterm" id="IDX-CHP-2-0007"/><a class="indexterm" id="IDX-CHP-2-0008"/><a class="indexterm" id="IDX-CHP-2-0009"/></p><div class="sect2" title="file"><div class="titlepage"><div><div><h2 class="title"><a id="file"/>file</h2></div></div></div><p>The <code class="literal">file</code> command is a standard utility, included with most *NIX-style operating systems and with the Cygwin<sup>[<a class="footnote" href="#ftn.CHP-2-FN-1" id="CHP-2-FN-1">4</a>]</sup> or MinGW<sup>[<a class="footnote" href="#ftn.CHP-2-FN-2" id="CHP-2-FN-2">5</a>]</sup> tools for Windows. <code class="literal">File</code> attempts to identify a file’s type by examining specific fields within the file. In some cases <code class="literal">file</code> recognizes common strings such as <span class="emphasis"><em>#!/bin/sh</em></span> (a shell script) or <span class="emphasis"><em>&lt;html&gt;</em></span> (an HTML document). Files containing non-ASCII content present somewhat more of a challenge. In such cases, <code class="literal">file</code> attempts to determine whether the content appears to be structured according to a known file format. In many cases it searches for specific tag values (often referred to as magic numbers<sup>[<a class="footnote" href="#ftn.CHP-2-FN-3" id="CHP-2-FN-3">6</a>]</sup>) known to be unique to specific file types. The hex listings below show several examples of magic numbers used to identify some common file types.<a class="indexterm" id="IDX-CHP-2-0010"/><a class="indexterm" id="IDX-CHP-2-0011"/></p><a id="I_programlisting2_d1e1221"/><pre class="programlisting">Windows PE executable file
00000000   <strong class="userinput"><code>4D 5A</code></strong> 90 00  03 00 00 00  04 00 00 00  FF FF 00 00  <strong class="userinput"><code>MZ</code></strong>..............
00000010   B8 00 00 00  00 00 00 00  40 00 00 00  00 00 00 00  ........@.......

Jpeg image file
00000000   <strong class="userinput"><code>FF D8</code></strong> FF E0  00 10 <strong class="userinput"><code>4A 46  49 46</code></strong> 00 01  01 01 00 60  ......<strong class="userinput"><code>JFIF</code></strong>.....`
00000010   00 60 00 00  FF DB 00 43  00 0A 07 07  08 07 06 0A  .`.....C........

Java .class file
00000000   <strong class="userinput"><code>CA FE BA BE</code></strong>  00 00 00 32  00 98 0A 00  2E 00 3E 08  .......2......&gt;.
00000010   00 3F 09 00  40 00 41 08  00 42 0A 00  43 00 44 0A  .?..@.A..B..C.D.</pre><p><code class="literal">file</code> has the capability to identify a large number of file formats, including several types of ASCII text files and various executable and data file formats. The magic number checks performed by <code class="literal">file</code> are governed by rules contained in a <span class="emphasis"><em>magic file</em></span>. The default magic file varies by operating system, but common locations include <span class="emphasis"><em>/usr/share/file/magic</em></span>, <span class="emphasis"><em>/usr/share/misc/magic</em></span>, and <span class="emphasis"><em>/etc/magic</em></span>. Please refer to the documentation for <code class="literal">file</code> for more information concerning magic files.<a class="indexterm" id="IDX-CHP-2-0012"/></p><div class="sidebar"><a id="the_cygwin_environment"/><p class="title">THE CYGWIN ENVIRONMENT</p><p>Cygwin is a set of utilities for the Windows operating system that provides a Linux-style command shell and associated programs. During installation, users can choose from a large number of standard packages, including compilers (gcc, g++), interpreters (Perl, Python, Ruby), networking utilities (<code class="literal">nc</code>, <code class="literal">ssh</code>), and many others. Once Cygwin has been installed, many programs written for use with Linux can be compiled and executed on Windows systems.<a class="indexterm" id="IDX-CHP-2-0013"/></p></div><p>In some cases, <code class="literal">file</code> can distinguish variations within a given file type. The following listing demonstrates <code class="literal">file</code>’s ability to identify not only several variations of ELF binaries but also information pertaining to how the binary was linked (statically or dynamically) and whether the binary was stripped or not.<a class="indexterm" id="IDX-CHP-2-0014"/></p><a id="I_programlisting2_d1e1293"/><pre class="programlisting">idabook# <strong class="userinput"><code>file ch2_ex_*</code></strong>
ch2_ex.exe:                  MS-DOS executable PE  for MS Windows (console)
                             Intel 80386 32-bit
ch2_ex_upx.exe:              MS-DOS executable PE  for MS Windows (console)
                             Intel 80386 32-bit, UPX compressed
ch2_ex_freebsd:              ELF 32-bit LSB executable, Intel 80386,
                             version 1 (FreeBSD), for FreeBSD 5.4,
                             dynamically linked (uses shared libs),
                             FreeBSD-style, not stripped
ch2_ex_freebsd_static:       ELF 32-bit LSB executable, Intel 80386,
                             version 1 (FreeBSD), for FreeBSD 5.4,
                             statically linked, FreeBSD-style, not stripped
ch2_ex_freebsd_static_strip: ELF 32-bit LSB executable, Intel 80386,
                             version 1 (FreeBSD), for FreeBSD 5.4,
                             statically linked, FreeBSD-style, stripped
ch2_ex_linux:                ELF 32-bit LSB executable, Intel 80386,
                             version 1 (SYSV), for GNU/Linux 2.6.9,
                             dynamically linked (uses shared libs),
                             not stripped
ch2_ex_linux_static:         ELF 32-bit LSB executable, Intel 80386,
                             version 1 (SYSV), for GNU/Linux 2.6.9,
                             statically linked, not stripped
ch2_ex_linux_static_strip:   ELF 32-bit LSB executable, Intel 80386,
                             version 1 (SYSV), for GNU/Linux 2.6.9,
                             statically linked, stripped
ch2_ex_linux_stripped:       ELF 32-bit LSB executable, Intel 80386,
                             version 1 (SYSV), for GNU/Linux 2.6.9,
                             dynamically linked (uses shared libs), stripped</pre><div class="sidebar"><a id="stripping_binary_executable_files"/><p class="title">STRIPPING BINARY EXECUTABLE FILES</p><p>Stripping a binary is the process of removing symbols from the binary file. Binary object files contain symbols as a result of the compilation process. Some of these symbols are utilized during the linking process to resolve references between files when creating the final executable file or library. In other cases, symbols may be present to provide additional information for use with debuggers. Following the linking process, many of the symbols are no longer required. Options passed to the linker can cause the linker to remove the unnecessary symbols at build time. Alternatively, a utility named <code class="literal">strip</code> may be used to remove symbols from existing binary files. While a stripped binary will be smaller than its unstripped counterpart, the behavior of the stripped binary will remain unchanged.<a class="indexterm" id="IDX-CHP-2-0015"/><a class="indexterm" id="IDX-CHP-2-0016"/><a class="indexterm" id="IDX-CHP-2-0017"/><a class="indexterm" id="IDX-CHP-2-0018"/></p></div><p><code class="literal">file</code> and similar utilities are not foolproof. It is quite possible for a file to be misidentified simply because it happens to bear the identifying marks of some file format. You can see this for yourself by using a hex editor to modify the first four bytes of any file to the Java magic number sequence: <code class="literal">CA FE BA BE</code>. The <code class="literal">file</code> utility will incorrectly identify the newly modified file as <span class="emphasis"><em>compiled Java class data</em></span>. Similarly, a text file containing only the two characters <code class="literal">MZ</code> will be identified as an <span class="emphasis"><em>MS-DOS executable</em></span>. A good approach to take in any reverse engineering effort is to never fully trust the output of any tool until you have correlated that output with several tools and manual analysis.</p></div><div class="sect2" title="PE Tools"><div class="titlepage"><div><div><h2 class="title"><a id="pe_tools"/>PE Tools</h2></div></div></div><p>PE Tools<sup>[<a class="footnote" href="#ftn.CHP-2-FN-4" id="CHP-2-FN-4">7</a>]</sup> is a collection of tools useful for analyzing both running processes and executable files on Windows systems. <a class="xref" href="ch02.html#the_pe_tools_utility" title="Figure 2-1. The PE Tools utility">Figure 2-1</a> shows the primary interface offered by PE Tools, which displays a list of active processes and provides access to all of the PE Tools utilities.<a class="indexterm" id="IDX-CHP-2-0019"/><a class="indexterm" id="IDX-CHP-2-0020"/></p><div class="figure"><a id="the_pe_tools_utility"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject2_d1e1361"/><img alt="The PE Tools utility" src="httpatomoreillycomsourcenostarchimages854065.png"/></div></div><p class="title">Figure 2-1. The PE Tools utility</p></div><p>From the process list, users can dump a process’s memory image to a file or utilize the PE Sniffer utility to determine what compiler was used to build the executable or whether the executable was processed by any known obfuscation utilities. The Tools menu offers similar options for analysis of disk files. Users can view a file’s PE header fields by using the embedded PE Editor utility, which also allows for easy modification of any header values. Modification of PE headers is often required when attempting to reconstruct a valid PE from an obfuscated version of that file.<a class="indexterm" id="IDX-CHP-2-0021"/><a class="indexterm" id="IDX-CHP-2-0022"/><a class="indexterm" id="IDX-CHP-2-0023"/><a class="indexterm" id="IDX-CHP-2-0024"/><a class="indexterm" id="IDX-CHP-2-0025"/><a class="indexterm" id="IDX-CHP-2-0026"/><a class="indexterm" id="IDX-CHP-2-0027"/></p><div class="sidebar"><a id="binary_file_obfuscation"/><p class="title">BINARY FILE OBFUSCATION</p><p><span class="emphasis"><em>Obfuscation</em></span> is any attempt to obscure the true meaning of something. When applied to executable files, obfuscation is any attempt to hide the true behavior of a program. Programmers may employ obfuscation for a number of reasons. Commonly cited examples include protecting proprietary algorithms and obscuring malicious intent. Nearly all forms of malware utilize obfuscation in an effort to hinder analysis. Tools are widely available to assist program authors in generating obfuscated programs. Obfuscation tools and techniques and their associated impact on the reverse engineering process will be discussed further in <a class="xref" href="ch21.html" title="Chapter 21. Obfuscated Code Analysis">Chapter 21</a>.</p></div></div><div class="sect2" title="PEiD"><div class="titlepage"><div><div><h2 class="title"><a id="peid"/>PEiD</h2></div></div></div><p>PEiD<sup>[<a class="footnote" href="#ftn.CHP-2-FN-5" id="CHP-2-FN-5">8</a>]</sup> is another Windows tool whose primary purposes are to identify the compiler used to build a particular Windows PE binary and to identify any tools used to obfuscate a Windows PE binary. <a class="xref" href="ch02.html#the_peid_utility" title="Figure 2-2. The PEiD utility">Figure 2-2</a> shows the use of PEiD to identify the tool (ASPack in this case) used to obfuscate a variant of the Gaobot<sup>[<a class="footnote" href="#ftn.CHP-2-FN-6" id="CHP-2-FN-6">9</a>]</sup> worm.<a class="indexterm" id="IDX-CHP-2-0028"/><a class="indexterm" id="IDX-CHP-2-0029"/></p><div class="figure"><a id="the_peid_utility"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject2_d1e1428"/><img alt="The PEiD utility" src="httpatomoreillycomsourcenostarchimages854067.png.jpg"/></div></div><p class="title">Figure 2-2. The PEiD utility</p></div><p>Many additional capabilities of PEiD overlap those of PE Tools, including the ability to summarize PE file headers, collect information on running processes, and perform basic disassembly.<a class="indexterm" id="IDX-CHP-2-0030"/><a class="indexterm" id="IDX-CHP-2-0031"/><a class="indexterm" id="IDX-CHP-2-0032"/></p></div></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-1" id="ftn.CHP-2-FN-1">4</a>] </sup>See <a class="ulink" href="http://www.cygwin.com/">http://www.cygwin.com/</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-2" id="ftn.CHP-2-FN-2">5</a>] </sup>See <a class="ulink" href="http://www.mingw.org/">http://www.mingw.org/</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-3" id="ftn.CHP-2-FN-3">6</a>] </sup>A <span class="emphasis"><em>magic number</em></span> is a special tag value required by some file format specifications whose presence indicates conformance to such specifications. In some cases humorous reasons surround the selection of magic numbers. The <code class="literal">MZ</code> tag in MS-DOS executable file headers represents the initials of Mark Zbikowski, one of the original architects of MS-DOS, while the hex value <code class="literal">0xcafebabe</code>, the well-known magic number associated with Java <span class="emphasis"><em>.class</em></span> files, was chosen because it is an easily remembered sequence of hex digits.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-4" id="ftn.CHP-2-FN-4">7</a>] </sup>See <a class="ulink" href="http://petools.org.ru/petools.shtml">http://petools.org.ru/petools.shtml</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-5" id="ftn.CHP-2-FN-5">8</a>] </sup>See <a class="ulink" href="http://peid.info/">http://peid.info/</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-6" id="ftn.CHP-2-FN-6">9</a>] </sup>See <a class="ulink" href="http://securityresponse.symantec.com/security_response/writeup.jsp?docid=2003-112112-1102-99">http://securityresponse.symantec.com/security_response/writeup.jsp?docid=2003-112112-1102-99</a>.</p></div></div></div>
<div class="sect1" title="Summary Tools"><div class="titlepage"><div><div><h1 class="title"><a id="summary_tools"/>Summary Tools</h1></div></div></div><p>Since our goal is to reverse engineer binary program files, we are going to need more sophisticated tools to extract detailed information following initial classification of a file. The tools discussed in this section, by necessity, are far more aware of the formats of the files that they process. In most cases, these tools understand a very specific file format, and the tools are utilized to parse input files to extract very specific information.</p><div class="sect2" title="nm"><div class="titlepage"><div><div><h2 class="title"><a id="nm"/>nm</h2></div></div></div><p>When source files are compiled to object files, compilers must embed information regarding the location of any global (external) symbols so that the linker will be able to resolve references to those symbols when it combines object files to create an executable. Unless instructed to strip symbols from the final executable, the linker generally carries symbols from the object files over into the resulting executable. According to the man page, the purpose of the <code class="literal">nm</code> utility is to “list symbols from object files.”<a class="indexterm" id="IDX-CHP-2-0033"/><a class="indexterm" id="IDX-CHP-2-0034"/></p><p>When <code class="literal">nm</code> is used to examine an intermediate object file (a <span class="emphasis"><em>.o</em></span> file rather than an executable), the default output yields the names of any functions and global variables declared in the file. Sample output of the <code class="literal">nm</code> utility is shown below:</p><a id="I_programlisting2_d1e1478"/><pre class="programlisting">idabook# <strong class="userinput"><code>gcc -c ch2_example.c</code></strong>
idabook# <strong class="userinput"><code>nm ch2_example.o</code></strong>
         U __stderrp
         U exit
         U fprintf
00000038 T get_max
00000000 t hidden
00000088 T main
00000000 D my_initialized_global
00000004 C my_unitialized_global
         U printf
         U rand
         U scanf
         U srand
         U time
00000010 T usage
idabook#</pre><p>Here we see that <code class="literal">nm</code> lists each symbol along with some information about the symbol. The letter codes are used to indicate the type of symbol being listed. In this example, we see the following letter codes, which we will now explain:</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/></colgroup><tbody><tr><td style="text-align: left" valign="top"><p><strong class="userinput"><code>U</code></strong></p></td><td style="text-align: left" valign="top"><p>An undefined symbol, usually an external symbol reference.</p></td></tr><tr><td style="text-align: left" valign="top"><p><strong class="userinput"><code>T</code></strong></p></td><td style="text-align: left" valign="top"><p>A symbol defined in the text section, usually a function name.</p></td></tr><tr><td style="text-align: left" valign="top"><p><strong class="userinput"><code>t</code></strong></p></td><td style="text-align: left" valign="top"><p>A local symbol defined in the text section. In a C program, this usually equates to a static function.</p></td></tr><tr><td style="text-align: left" valign="top"><p><strong class="userinput"><code>D</code></strong></p></td><td style="text-align: left" valign="top"><p>An initialized data value.</p></td></tr><tr><td style="text-align: left" valign="top"><p><strong class="userinput"><code>C</code></strong></p></td><td style="text-align: left" valign="top"><p>An uninitialized data value.</p></td></tr></tbody></table></div><div class="note" title="Note"><h3 class="title">Note</h3><p>Uppercase letter codes are used for global symbols, whereas lowercase letter codes are used for local symbols. A full explanation of the letter codes can be found in the man page for <code class="literal">nm</code>.<a class="indexterm" id="IDX-CHP-2-0035"/><a class="indexterm" id="IDX-CHP-2-0036"/><a class="indexterm" id="IDX-CHP-2-0037"/></p></div><p>Somewhat more information is displayed when <code class="literal">nm</code> is used to display symbols from an executable file. During the link process, symbols are resolved to virtual addresses (when possible), which results in more information being available when <code class="literal">nm</code> is run. Truncated example output from <code class="literal">nm</code> used on an executable is shown here:</p><a id="I_programlisting2_d1e1562"/><pre class="programlisting">idabook# <strong class="userinput"><code>gcc -o ch2_example ch2_example.c</code></strong>
idabook# <strong class="userinput"><code>nm ch2_example</code></strong>
         &lt;. . .&gt;
         U exit
         U fprintf
080485c0 t frame_dummy
08048644 T get_max
0804860c t hidden
08048694 T main
0804997c D my_initialized_global
08049a9c B my_unitialized_global
08049a80 b object.2
08049978 d p.0
         U printf
         U rand
         U scanf
         U srand
         U time
0804861c T usage
idabook#</pre><p>At this point, some of the symbols (<code class="literal">main</code>, for example) have been assigned virtual addresses, new ones (<code class="literal">frame_dummy</code>) have been introduced as a result of the linking process, some (<code class="literal">my_unitialized_global</code>) have had their symbol type changed, and others remain undefined as they continue to reference external symbols. In this case, the binary we are examining is dynamically linked, and the undefined symbols are defined in the shared C library. More information regarding <code class="literal">nm</code> can be found in its associated man page.</p></div><div class="sect2" title="ldd"><div class="titlepage"><div><div><h2 class="title"><a id="ldd"/>ldd</h2></div></div></div><p>When an executable is created, the location of any library functions referenced by that executable must be resolved. The linker has two methods for resolving calls to library functions: <span class="emphasis"><em>static linking</em></span> and <span class="emphasis"><em>dynamic linking</em></span>. Command-line arguments provided to the linker determine which of the two methods is used. An executable may be statically linked, dynamically linked, or both.<sup>[<a class="footnote" href="#ftn.CHP-2-FN-7" id="CHP-2-FN-7">10</a>]</sup><a class="indexterm" id="IDX-CHP-2-0038"/><a class="indexterm" id="IDX-CHP-2-0039"/><a class="indexterm" id="IDX-CHP-2-0040"/><a class="indexterm" id="IDX-CHP-2-0041"/><a class="indexterm" id="IDX-CHP-2-0042"/><a class="indexterm" id="IDX-CHP-2-0043"/><a class="indexterm" id="IDX-CHP-2-0044"/><a class="indexterm" id="IDX-CHP-2-0045"/><a class="indexterm" id="IDX-CHP-2-0046"/></p><p>When static linking is requested, the linker combines an application’s object files with a copy of the required library to create an executable file. At runtime, there is no need to locate the library code because it is already contained within the executable. Advantages of static linking are that (1) it results in slightly faster function calls and (2) distribution of binaries is easier because no assumptions need be made regarding the availability of library code on users’ systems. Disadvantages of static linking include (1) larger resulting executables and (2) greater difficulty upgrading programs when library components change. Programs are more difficult to update because they must be relinked every time a library is changed. From a reverse engineering perspective, static linking complicates matters somewhat. If we are faced with the task of analyzing a statically linked binary, there is no easy way to answer the questions “Which libraries are linked into this binary?” and “Which of these functions is a library function?” <a class="xref" href="ch12.html" title="Chapter 12. Library Recognition Using FLIRT Signatures">Chapter 12</a> will discuss the challenges encountered while reverse engineering statically linked code.</p><p>Dynamic linking differs from static linking in that the linker has no need to make a copy of any required libraries. Instead, the linker simply inserts references to any required libraries (often <span class="emphasis"><em>.so</em></span> or <span class="emphasis"><em>.dll</em></span> files) into the final executable, usually resulting in much smaller executable files. Upgrading library code is much easier when dynamic linking is utilized. Since a single copy of a library is maintained and that copy is referenced by many binaries, replacing the single outdated library with a new version instantly updates every binary that makes use of that library. One of the disadvantages of using dynamic linking is that it requires a more complicated loading process. All of the necessary libraries must be located and loaded into memory, as opposed to loading one statically linked file that happens to contain all of the library code. Another disadvantage of dynamic linking is that vendors must distribute not only their own executable file but also all library files upon which that executable depends. Attempting to execute a program on a system that does not contain all the required library files will result in an error.</p><p>The following output demonstrates the creation of dynamically and statically linked versions of a program, the size of the resulting binaries, and the manner in which <code class="literal">file</code> identifies those binaries:</p><a id="I_programlisting2_d1e1650"/><pre class="programlisting">idabook# <strong class="userinput"><code>gcc -o ch2_example_dynamic ch2_example.c</code></strong>
idabook# <strong class="userinput"><code>gcc -o ch2_example_static ch2_example.c --static</code></strong>
idabook# <strong class="userinput"><code>ls -l ch2_example_*</code></strong>
-rwxr-xr-x  1 root  wheel    6017 Sep 26 11:24 ch2_example_dynamic
-rwxr-xr-x  1 root  wheel  167987 Sep 26 11:23 ch2_example_static
idabook# <strong class="userinput"><code>file ch2_example_*</code></strong>
ch2_example_dynamic: ELF 32-bit LSB executable, Intel 80386, version 1
        (FreeBSD), dynamically linked (uses shared libs), not stripped
ch2_example_static:  ELF 32-bit LSB executable, Intel 80386, version 1
        (FreeBSD), statically linked, not stripped
idabook#</pre><p>In order for dynamic linking to function properly, dynamically linked binaries must indicate which libraries they depend on along with the specific resources that are required from each of those libraries. As a result, unlike statically linked binaries, it is quite simple to determine the libraries on which a dynamically linked binary depends. The <code class="literal">ldd</code> (<span class="emphasis"><em>list dynamic dependencies</em></span>) utility is a simple tool used to list the dynamic libraries required by any executable. In the following example, <code class="literal">ldd</code> is used to determine the libraries on which the Apache web server depends:<a class="indexterm" id="IDX-CHP-2-0047"/><a class="indexterm" id="IDX-CHP-2-0048"/><a class="indexterm" id="IDX-CHP-2-0049"/><a class="indexterm" id="IDX-CHP-2-0050"/><a class="indexterm" id="IDX-CHP-2-0051"/><a class="indexterm" id="IDX-CHP-2-0052"/><a class="indexterm" id="IDX-CHP-2-0053"/></p><a id="I_programlisting2_d1e1703"/><pre class="programlisting">idabook# <strong class="userinput"><code>ldd /usr/local/sbin/httpd</code></strong>
/usr/local/sbin/httpd:
        libm.so.4 =&gt; /lib/libm.so.4 (0x280c5000)
        libaprutil-1.so.2 =&gt; /usr/local/lib/libaprutil-1.so.2 (0x280db000)
        libexpat.so.6 =&gt; /usr/local/lib/libexpat.so.6 (0x280ef000)
        libiconv.so.3 =&gt; /usr/local/lib/libiconv.so.3 (0x2810d000)
        libapr-1.so.2 =&gt; /usr/local/lib/libapr-1.so.2 (0x281fa000)
        libcrypt.so.3 =&gt; /lib/libcrypt.so.3 (0x2821a000)
        libpthread.so.2 =&gt; /lib/libpthread.so.2 (0x28232000)
        libc.so.6 =&gt; /lib/libc.so.6 (0x28257000)
idabook#</pre><p>The <code class="literal">ldd</code> utility is available on Linux and BSD systems. On OS X systems, similar functionality is available using the <code class="literal">otool</code> utility with the <code class="literal">–L</code> option: <code class="literal">otool -L</code> <em class="replaceable"><code>filename</code></em>. On Windows systems, the <code class="literal">dumpbin</code> utility, part of the Visual Studio tool suite, can be used to list dependent libraries: <code class="literal">dumpbin /dependents</code> <em class="replaceable"><code>filename</code></em>.</p></div><div class="sect2" title="objdump"><div class="titlepage"><div><div><h2 class="title"><a id="objdump"/>objdump</h2></div></div></div><p>Whereas <code class="literal">ldd</code> is fairly specialized, <code class="literal">objdump</code> is extremely versatile. The purpose of <code class="literal">objdump</code> is to “display information from object files.”<sup>[<a class="footnote" href="#ftn.CHP-2-FN-8" id="CHP-2-FN-8">11</a>]</sup> This is a fairly broad goal, and in order to accomplish it, <code class="literal">objdump</code> responds to a large number (30+) of command-line options tailored to extract various pieces of information from object files. <code class="literal">objdump</code> can be used to display the following data (and much more) related to object files:</p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>Section headers</strong></span></span></dt><dd><p>Summary information for each of the sections in the program file.</p></dd><dt><span class="term"><span class="strong"><strong>Private headers</strong></span></span></dt><dd><p>Program memory layout information and other information required by the runtime loader, including a list of required libraries such as that produced by <code class="literal">ldd</code>.</p></dd><dt><span class="term"><span class="strong"><strong>Debugging information</strong></span></span></dt><dd><p>Extracts any debugging information embedded in the program file.<a class="indexterm" id="IDX-CHP-2-0054"/><a class="indexterm" id="IDX-CHP-2-0055"/><a class="indexterm" id="IDX-CHP-2-0056"/><a class="indexterm" id="IDX-CHP-2-0057"/><a class="indexterm" id="IDX-CHP-2-0058"/><a class="indexterm" id="IDX-CHP-2-0059"/><a class="indexterm" id="IDX-CHP-2-0060"/><a class="indexterm" id="IDX-CHP-2-0061"/><a class="indexterm" id="IDX-CHP-2-0062"/></p></dd><dt><span class="term"><span class="strong"><strong>Symbol information</strong></span></span></dt><dd><p>Dumps symbol table information in a manner similar to the <code class="literal">nm</code> utility.</p></dd><dt><span class="term"><span class="strong"><strong>Disassembly listing</strong></span></span></dt><dd><p><code class="literal">objdump</code> performs a linear sweep disassembly of sections of the file marked as code. When disassembling x86 code, <code class="literal">objdump</code> can generate either AT&amp;T or Intel syntax, and the disassembly can be captured as a text file. Such a text file is called a disassembly <span class="emphasis"><em>dead listing</em></span>, and while these files can certainly be used for reverse engineering, they are difficult to navigate effectively and even more difficult to modify in a consistent and error-free manner.</p></dd></dl></div><p><code class="literal">objdump</code> is available as part of the GNU binutils<sup>[<a class="footnote" href="#ftn.CHP-2-FN-9" id="CHP-2-FN-9">12</a>]</sup> tool suite and can be found on Linux, FreeBSD, and Windows (via Cygwin). <code class="literal">objdump</code> relies on the Binary File Descriptor library (libbfd), a component of binutils, to access object files and thus is capable of parsing file formats supported by libbfd (ELF and PE among others). For ELF-specific parsing, a utility named <code class="literal">readelf</code> is also available. <code class="literal">readelf</code> offers most of the same capabilities as <code class="literal">objdump</code>, and the primary difference between the two is that <code class="literal">readelf</code> does not rely upon libbfd.<a class="indexterm" id="IDX-CHP-2-0063"/><a class="indexterm" id="IDX-CHP-2-0064"/></p></div><div class="sect2" title="otool"><div class="titlepage"><div><div><h2 class="title"><a id="otool"/>otool</h2></div></div></div><p><code class="literal">otool</code> is most easily described as an <code class="literal">objdump</code>-like utility for OS X, and it is useful for parsing information about OS X Mach-O binaries. The following listing demonstrates how <code class="literal">otool</code> displays the dynamic library dependencies for a Mach-O binary, thus performing a function similar to <code class="literal">ldd</code>.<a class="indexterm" id="IDX-CHP-2-0065"/><a class="indexterm" id="IDX-CHP-2-0066"/><a class="indexterm" id="IDX-CHP-2-0067"/></p><a id="I_programlisting2_d1e1906"/><pre class="programlisting">idabook# <strong class="userinput"><code>file osx_example</code></strong>
osx_example: Mach-O executable ppc
idabook# <strong class="userinput"><code>otool -L osx_example</code></strong>
osx_example:
        /usr/lib/libstdc++.6.dylib (compatibility
 version 7.0.0, current version 7.4.0)
        /usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 1.0.0)
        /usr/lib/libSystem.B.dylib (compatibility
 version 1.0.0, current version 88.1.5)</pre><p><code class="literal">otool</code> can be used to display information related to a file’s headers and symbol tables and to perform disassembly of the file’s code section. For more information regarding the capabilities of <code class="literal">otool</code>, please refer to the associated man page.</p></div><div class="sect2" title="dumpbin"><div class="titlepage"><div><div><h2 class="title"><a id="dumpbin"/>dumpbin</h2></div></div></div><p><code class="literal">dumpbin</code> is a command-line utility included with Microsoft’s Visual Studio suite of tools. Like <code class="literal">otool</code> and <code class="literal">objdump</code>, <code class="literal">dumpbin</code> is capable of displaying a wide range of information related to Windows PE files. The following listing shows how <code class="literal">dumpbin</code> displays the dynamic dependencies of the Windows calculator program in a manner similar to <code class="literal">ldd</code>.<a class="indexterm" id="IDX-CHP-2-0068"/><a class="indexterm" id="IDX-CHP-2-0069"/><a class="indexterm" id="IDX-CHP-2-0070"/><a class="indexterm" id="IDX-CHP-2-0071"/><a class="indexterm" id="IDX-CHP-2-0072"/><a class="indexterm" id="IDX-CHP-2-0073"/><a class="indexterm" id="IDX-CHP-2-0074"/><a class="indexterm" id="IDX-CHP-2-0075"/><a class="indexterm" id="IDX-CHP-2-0076"/><a class="indexterm" id="IDX-CHP-2-0077"/></p><a id="I_programlisting2_d1e1978"/><pre class="programlisting">$ <strong class="userinput"><code>dumpbin /dependents calc.exe</code></strong>
Microsoft (R) COFF/PE Dumper Version 8.00.50727.762
Copyright (C) Microsoft Corporation.  All rights reserved.

Dump of file calc.exe

File Type: EXECUTABLE IMAGE

  Image has the following dependencies:

    SHELL32.dll
    msvcrt.dll
    ADVAPI32.dll
    KERNEL32.dll
    GDI32.dll
    USER32.dll</pre><p>Additional <code class="literal">dumpbin</code> options offer the ability to extract information from various sections of a PE binary, including symbols, imported function names, exported function names, and disassembled code. Additional information related to the use of <code class="literal">dumpbin</code> is available via the Microsoft Developer Network (MSDN).<sup>[<a class="footnote" href="#ftn.CHP-2-FN-10" id="CHP-2-FN-10">13</a>]</sup><a class="indexterm" id="IDX-CHP-2-0078"/></p></div><div class="sect2" title="c++filt"><div class="titlepage"><div><div><h2 class="title"><a id="c_plus_plus_filt"/>c++filt</h2></div></div></div><p>Languages that allow function overloading must have a mechanism for distinguishing among the many overloaded versions of a function since each version has the same name. The following C++ example shows the prototypes for several overloaded versions of a function named <code class="literal">demo</code>:</p><a id="I_programlisting2_d1e2007"/><pre class="programlisting">void demo(void);
void demo(int x);
void demo(double x);
void demo(int x, double y);
void demo(double x, int y);
void demo(char* str);</pre><p>As a general rule, it is not possible to have two functions with the same name in an object file. In order to allow overloading, compilers derive unique names for overloaded functions by incorporating information describing the type sequence of the function arguments. The process of deriving unique names for functions with identical names is called <span class="emphasis"><em>name mangling</em></span>.<sup>[<a class="footnote" href="#ftn.CHP-2-FN-11" id="CHP-2-FN-11">14</a>]</sup> If we use <code class="literal">nm</code> to dump the symbols from the compiled version of the preceding C++ code, we might see something like the following (filtered to focus on versions of <code class="literal">demo</code>):<a class="indexterm" id="IDX-CHP-2-0079"/></p><a id="I_programlisting2_d1e2029"/><pre class="programlisting">idabook# <strong class="userinput"><code>g++ -o cpp_test cpp_test.cpp</code></strong>
idabook# <strong class="userinput"><code>nm cpp_test | grep demo</code></strong>
0804843c T _Z4demoPc
08048400 T _Z4demod
08048428 T _Z4demodi
080483fa T _Z4demoi
08048414 T _Z4demoid
080483f4 T _Z4demov</pre><p>The C++ standard does not define standards for name-mangling schemes, leaving compiler designers to develop their own. In order to decipher the mangled variants of <code class="literal">demo</code> shown here, we need a tool that understands our compiler’s (g++ in this case) name-mangling scheme. This is precisely the purpose of the <code class="literal">c++filt</code> utility. <code class="literal">c++filt</code> treats each input word as if it were a mangled name and then attempts to determine the compiler that was used to generate that name. If the name appears to be a valid mangled name, it outputs the demangled version of the name. When <code class="literal">c++filt</code> does not recognize a word as a mangled name, it simply outputs the word with no changes.</p><p>If we pass the results of <code class="literal">nm</code> from the preceding example through <code class="literal">c++filt</code>, it is possible to recover the demangled function names, as seen here:</p><a id="I_programlisting2_d1e2059"/><pre class="programlisting">idabook# <strong class="userinput"><code>nm cpp_test | grep demo | c++filt</code></strong>
0804843c T demo(char*)
08048400 T demo(double)
08048428 T demo(double, int)
080483fa T demo(int)
08048414 T demo(int, double)
080483f4 T demo()</pre><p>It is important to note that mangled names contain additional information about functions that <code class="literal">nm</code> does not normally provide. This information can be extremely helpful in reversing engineering situations, and in more complex cases, this extra information may include data regarding class names or function-calling conventions.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-7" id="ftn.CHP-2-FN-7">10</a>] </sup>For more information on linking, consult John R. Levine, <span class="emphasis"><em>Linkers and Loaders</em></span> (San Francisco: Morgan Kaufmann, 2000).</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-8" id="ftn.CHP-2-FN-8">11</a>] </sup>See <a class="ulink" href="http://www.sourceware.org/binutils/docs/binutils/objdump.html#objdump/">http://www.sourceware.org/binutils/docs/binutils/objdump.html#objdump/</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-9" id="ftn.CHP-2-FN-9">12</a>] </sup>See <a class="ulink" href="http://www.gnu.org/software/binutils/">http://www.gnu.org/software/binutils/</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-10" id="ftn.CHP-2-FN-10">13</a>] </sup>See <a class="ulink" href="http://msdn.microsoft.com/en-us/library/c1h23y6c(VS.71).aspx">http://msdn.microsoft.com/en-us/library/c1h23y6c(VS.71).aspx</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-11" id="ftn.CHP-2-FN-11">14</a>] </sup>For an overview of name mangling, refer to <a class="ulink" href="http://en.wikipedia.org/wiki/Name_mangling">http://en.wikipedia.org/wiki/Name_mangling</a>.</p></div></div></div>
<div class="sect1" title="Deep Inspection Tools"><div class="titlepage"><div><div><h1 class="title"><a id="deep_inspection_tools"/>Deep Inspection Tools</h1></div></div></div><p>So far, we have discussed tools that perform a cursory analysis of files based on minimal knowledge of those files’ internal structure. We have also seen tools capable of extracting specific pieces of data from files based on very detailed knowledge of a file’s structure. In this section we discuss tools designed to extract specific types of information independently of the type of file being analyzed.<a class="indexterm" id="IDX-CHP-2-0080"/><a class="indexterm" id="IDX-CHP-2-0081"/></p><div class="sect2" title="strings"><div class="titlepage"><div><div><h2 class="title"><a id="strings"/>strings</h2></div></div></div><p>It is occasionally useful to ask more generic questions regarding file content, questions that don’t necessarily require any specific knowledge of a file’s structure. One such question is “Does this file contain any embedded strings?” Of course, we must first answer the question “What exactly constitutes a string?” Let’s loosely define a <span class="emphasis"><em>string</em></span> as a consecutive sequence of printable characters. This definition is often augmented to specify a minimum length and a specific character set. Thus, we could specify a search for all sequences of at least four consecutive ASCII printable characters and print the results to the console. Searches for such strings are generally not limited in any way by the structure of a file. You can search for strings in an ELF binary just as easily as you can search for strings in a Microsoft Word document.<a class="indexterm" id="IDX-CHP-2-0082"/></p><p>The <code class="literal">strings</code> utility is designed specifically to extract string content from files, often without regard for the format of those files. Using <code class="literal">strings</code> with its default settings (7-bit ASCII sequences of at least four characters) might yield something like the following:<a class="indexterm" id="IDX-CHP-2-0083"/></p><a id="I_programlisting2_d1e2106"/><pre class="programlisting">idabook# <strong class="userinput"><code>strings ch2_example</code></strong>
/lib/ld-linux.so.2
__gmon_start__
libc.so.6
_IO_stdin_used
exit
srand
puts
time
printf
stderr
fwrite
scanf
__libc_start_main
GLIBC_2.0
PTRh
[^_]
usage: ch2_example [max]
A simple guessing game!
Please guess a number between 1 and %d.
Invalid input, quitting!
Congratulations, you got it in %d attempt(s)!
Sorry too low, please try again
Sorry too high, please try again</pre><p>Unfortunately, while we see some strings that look like they might be output by the program, other strings appear to be function names and library names. We should be careful not to jump to any conclusions regarding the behavior of the program. Analysts often fall into the trap of attempting to deduce the behavior of a program based on the output of <code class="literal">strings</code>. Remember, the presence of a string within a binary in no way indicates that the string is ever used in any manner by that binary.<a class="indexterm" id="IDX-CHP-2-0084"/><a class="indexterm" id="IDX-CHP-2-0085"/><a class="indexterm" id="IDX-CHP-2-0086"/><a class="indexterm" id="IDX-CHP-2-0087"/><a class="indexterm" id="IDX-CHP-2-0088"/><a class="indexterm" id="IDX-CHP-2-0089"/><a class="indexterm" id="IDX-CHP-2-0090"/></p><p>Some final notes on the use of <code class="literal">strings</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>When using <code class="literal">strings</code> on executable files, it is important to remember that, by default, only the loadable, initialized sections of the file will be scanned. Use the <code class="literal">-a</code> command-line argument to force <code class="literal">strings</code> to scan the entire input file.</p></li><li class="listitem"><p><code class="literal">strings</code> gives no indication of where, within a file, a string is located. Use the <code class="literal">-t</code> command-line argument to have <code class="literal">strings</code> print file offset information for each string found.</p></li><li class="listitem"><p>Many files utilize alternate character sets. Utilize the <code class="literal">-e</code> command-line argument to cause <code class="literal">strings</code> to search for wide characters such as 16-bit Unicode.</p></li></ul></div></div><div class="sect2" title="Disassemblers"><div class="titlepage"><div><div><h2 class="title"><a id="disassemblers"/>Disassemblers</h2></div></div></div><p>As mentioned earlier, a number of tools are available to generate dead listing–style disassemblies of binary object files. PE, ELF, and Mach-O binaries can be disassembled using <code class="literal">dumpbin</code>, <code class="literal">objdump</code>, and <code class="literal">otool</code>, respectively. None of those, however, can deal with arbitrary blocks of binary data. You will occasionally be confronted with a binary file that does not conform to a widely used file format, in which case you will need tools capable of beginning the disassembly process at user-specified offsets.</p><p>Two examples of such <span class="emphasis"><em>stream disassemblers</em></span> for the x86 instruction set are <code class="literal">ndisasm</code> and <code class="literal">diStorm</code>.<sup>[<a class="footnote" href="#ftn.CHP-2-FN-12" id="CHP-2-FN-12">15</a>]</sup> <code class="literal">ndisasm</code> is a utility included with the Netwide Assembler (NASM).<sup>[<a class="footnote" href="#ftn.CHP-2-FN-13" id="CHP-2-FN-13">16</a>]</sup> The following example illustrates the use of <code class="literal">ndisasm</code> to disassemble a piece of shellcode generated using the Metasploit framework.<sup>[<a class="footnote" href="#ftn.CHP-2-FN-14" id="CHP-2-FN-14">17</a>]</sup><a class="indexterm" id="IDX-CHP-2-0091"/><a class="indexterm" id="IDX-CHP-2-0092"/></p><a id="I_programlisting2_d1e2234"/><pre class="programlisting">idabook# <strong class="userinput"><code>./msfpayload linux/x86/shell_findport CPORT=4444 R &gt; fs</code></strong>
idabook# <strong class="userinput"><code>ls -l fs</code></strong>
-rw-r--r-- 1 ida ida 62 Dec 11 15:49 fs
idabook# <strong class="userinput"><code>ndisasm -u fs</code></strong>
00000000  31D2              xor edx,edx
00000002  52                push edx
00000003  89E5              mov ebp,esp
00000005  6A07              push byte +0x7
00000007  5B                pop ebx
00000008  6A10              push byte +0x10
0000000A  54                push esp
0000000B  55                push ebp
0000000C  52                push edx
0000000D  89E1              mov ecx,esp
0000000F  FF01              inc dword [ecx]
00000011  6A66              push byte +0x66
00000013  58                pop eax
00000014  CD80              int 0x80
00000016  66817D02115C      cmp word [ebp+0x2],0x5c11
0000001C  75F1              jnz 0xf
0000001E  5B                pop ebx
0000001F  6A02              push byte +0x2
00000021  59                pop ecx
00000022  B03F              mov al,0x3f
00000024  CD80              int 0x80
00000026  49                dec ecx
00000027  79F9              jns 0x22
00000029  52                push edx
0000002A  682F2F7368        push dword 0x68732f2f
0000002F  682F62696E        push dword 0x6e69622f
00000034  89E3              mov ebx,esp
00000036  52                push edx
00000037  53                push ebx
00000038  89E1              mov ecx,esp
0000003A  B00B              mov al,0xb
0000003C  CD80              int 0x80</pre><p>The flexibility of stream disassembly is useful in many situations. One scenario involves the analysis of computer network attacks in which network packets may contain shellcode. Stream disassemblers can be used to disassemble the portions of the packet that contain shellcode in order to analyze the behavior of the malicious payload. Another situation involves the analysis of ROM images for which no layout reference can be located. Portions of the ROM will contain data, while other portions will contain code. Stream disassemblers can be used to disassemble just those portions of the image thought to be code.<a class="indexterm" id="IDX-CHP-2-0093"/><a class="indexterm" id="IDX-CHP-2-0094"/></p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-12" id="ftn.CHP-2-FN-12">15</a>] </sup>See <a class="ulink" href="http://www.ragestorm.net/distorm/">http://www.ragestorm.net/distorm/</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-13" id="ftn.CHP-2-FN-13">16</a>] </sup>See <a class="ulink" href="http://nasm.sourceforge.net/">http://nasm.sourceforge.net/</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-2-FN-14" id="ftn.CHP-2-FN-14">17</a>] </sup>See <a class="ulink" href="http://www.metasploit.com/">http://www.metasploit.com/</a>.</p></div></div></div>
<div class="sect1" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="summary-id1"/>Summary</h1></div></div></div><p>The tools discussed in this chapter are not necessarily the best of their breed. They do, however, represent tools commonly available for anyone who wishes to reverse engineer binary files. More important, they represent the types of tools that motivated much of the development of IDA. In the coming chapters, we will discuss such tools. An awareness of these tools will greatly enhance your understanding of the IDA user interface and the many informational displays that IDA offers.</p></div>
<div class="chapter" title="Chapter&#xA0;3.&#xA0;IDA Pro Background"><div class="titlepage"><div><div><h1 class="title"><a id="ida_pro_background"/>Chapter 3. IDA Pro Background</h1></div></div></div><div class="informalfigure"><a id="image_no_caption-id3"/><div class="mediaobject"><a id="I_mediaobject3_d1e2262"/><img alt="image with no caption" src="httpatomoreillycomsourcenostarchimages854059.png.jpg"/></div></div><p>The Interactive Disassembler Professional, better and heretofore known as <span class="emphasis"><em>IDA Pro</em></span> or simply <span class="emphasis"><em>IDA</em></span> is a product of Hex-Rays,<sup>[<a class="footnote" href="#ftn.CHP-3-FN-1" id="CHP-3-FN-1">18</a>]</sup> located in Liège, Belgium. The programming genius behind IDA is Ilfak Guilfanov, better known as simply <span class="emphasis"><em>Ilfak</em></span>. IDA began its life over a decade ago as an MS-DOS, console-based application, which is significant in that it helps us understand something about the nature of IDA’s user interface. Among other things, non-GUI versions of IDA ship for all IDA-supported platforms<sup>[<a class="footnote" href="#ftn.CHP-3-FN-2" id="CHP-3-FN-2">19</a>]</sup> and continue to use the console-style interface derived from the original DOS versions.</p><p>At its heart, IDA is a recursive descent disassembler; however, a substantial amount of effort has gone into developing logic to augment the recursive-descent process. In order to overcome one of the larger shortcomings of recursive descent, IDA employs a large number of heuristic techniques to identify additional code that may not have been found during the recursive-descent process. Beyond the disassembly process itself, IDA goes to great lengths not only to distinguish data disassemblies from code disassemblies but also to determine exactly what type of data is being represented by those data disassemblies. While the code that you view in IDA is in assembly language, one of the fundamental goals of IDA is to paint a picture as close to source code as possible. IDA makes every effort to annotate generated disassemblies with not only datatype information but also derived variable and function names. These annotations minimize the amount of raw hex and maximize the amount of symbolic information presented to the user.<a class="indexterm" id="IDX-CHP-3-0001"/><a class="indexterm" id="IDX-CHP-3-0002"/><a class="indexterm" id="IDX-CHP-3-0003"/></p><div class="sect1" title="Hex-Rays’ Stance on Piracy"><div class="titlepage"><div><div><h1 class="title"><a id="hex-raysa_stance_on_piracy"/>Hex-Rays’ Stance on Piracy</h1></div></div></div><p>As an IDA user you should be aware of several facts. IDA is Hex-Rays’ flagship product; accordingly, it is very sensitive about unauthorized distribution of IDA. In the past, the company has seen a direct cause and effect relationship between releases of pirated versions of IDA and declining sales. The former publisher of IDA, DataRescue, has even gone so far as to post the names of pirates to its Hall of Shame.<sup>[<a class="footnote" href="#ftn.CHP-3-FN-3" id="CHP-3-FN-3">20</a>]</sup> IDA thus utilizes several antipiracy techniques in an effort to curb piracy and enforce licensing restrictions.<a class="indexterm" id="IDX-CHP-3-0004"/><a class="indexterm" id="IDX-CHP-3-0005"/></p><p>The first technique to be aware of: Each copy of IDA is watermarked in order to uniquely tie it to its purchaser. If a copy of IDA turns up on a warez site, Hex-Rays has the ability to track that copy back to the original buyer, who will then be blacklisted from future sales. It is not uncommon to find discussions related to “leaked” copies of IDA on the IDA support forums at Hex-Rays.</p><p>Another technique IDA uses to enforce its licensing policies involves scanning for additional copies of IDA running on the local network. When the Windows version of IDA is launched, a UDP packet is broadcast on port 23945, and IDA waits for responses to see whether other instances of IDA running under the same license key are present on the same subnet. The number of responses is compared to the number of seats to which the license applies, and if too many copies are found on the network, IDA will refuse to start. Do note, however, that it is permissible to run multiple instances of IDA on a single computer with a single license.</p><p>The final method of license enforcement centers on the use of key files tied to each purchaser. At startup, IDA searches for a valid <span class="emphasis"><em>ida.key</em></span> file. Failure to locate a valid key file will cause IDA to shut down immediately. Key files are also used in determining eligibility for upgraded copies of IDA. In essence, <span class="emphasis"><em>ida.key</em></span> represents your purchase receipt, and you should safeguard it to ensure that you remain eligible for future upgrades.<a class="indexterm" id="IDX-CHP-3-0006"/></p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-1" id="ftn.CHP-3-FN-1">18</a>] </sup>For many years, IDA was marketed by DataRescue; however, in January 2008, Ilfak moved marketing and sales of IDA to his own company, Hex-Rays.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-2" id="ftn.CHP-3-FN-2">19</a>] </sup>Currently supported platforms are Windows, Linux, and OS X.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-3" id="ftn.CHP-3-FN-3">20</a>] </sup>The Hall of Shame has been migrated to the Hex-Rays website: <a class="ulink" href="http://www.hex-rays.com/idapro/hallofshame.html">http://www.hex-rays.com/idapro/hallofshame.html</a>.</p></div></div></div>
<div class="sect1" title="Obtaining IDA Pro"><div class="titlepage"><div><div><h1 class="title"><a id="obtaining_ida_pro"/>Obtaining IDA Pro</h1></div></div></div><p>First and foremost, IDA is not free software. The folks at Hex-Rays make their living in part through the sales of IDA. A limited-functionality, freeware<sup>[<a class="footnote" href="#ftn.CHP-3-FN-4" id="CHP-3-FN-4">21</a>]</sup> version of IDA is available for people who wish to familiarize themselves with its basic capabilities, but it doesn’t keep pace with the most recent versions. The freeware version, discussed more extensively in <a class="xref" href="apa.html" title="Appendix A. Using IDA Freeware 5.0">Appendix A</a>, is a stripped-down edition of IDA 5.0 (the current version being 6.1). Along with the freeware version, Hex-Rays also distributes a restricted-functionality demonstration copy<sup>[<a class="footnote" href="#ftn.CHP-3-FN-5" id="CHP-3-FN-5">22</a>]</sup> of the current version. If the rave reviews that are found anywhere reverse engineering is discussed are not sufficient to convince you to purchase a copy, then spending some time with either the freeware or demo version will surely help you realize that IDA, and the customer support that comes along with it, is well worth owning.<a class="indexterm" id="IDX-CHP-3-0007"/><a class="indexterm" id="IDX-CHP-3-0008"/><a class="indexterm" id="IDX-CHP-3-0009"/><a class="indexterm" id="IDX-CHP-3-0010"/><a class="indexterm" id="IDX-CHP-3-0011"/><a class="indexterm" id="IDX-CHP-3-0012"/></p><div class="sect2" title="IDA Versions"><div class="titlepage"><div><div><h2 class="title"><a id="ida_versions"/>IDA Versions</h2></div></div></div><p>As of version 6.0, IDA is available in GUI and console versions for Windows, Linux, and OS X. IDA makes use of the Qt cross-platform GUI libraries to provide a consistent user interface on all three platforms. From a functionality standpoint, IDA Pro is offered in two versions: standard and advanced. The two versions differ primarily in the number of processor architectures for which they support disassembly. A quick look at the list of supported processors<sup>[<a class="footnote" href="#ftn.CHP-3-FN-6" id="CHP-3-FN-6">23</a>]</sup> shows that the standard version (approximately USD540 as of this writing) supports more than 30 processor families, while the advanced version (at almost twice the price) supports more than 50. Additional architectures supported in the advanced version include x64, AMD64, MIPS, PPC, and SPARC, among others.</p></div><div class="sect2" title="IDA Licenses"><div class="titlepage"><div><div><h2 class="title"><a id="ida_licenses"/>IDA Licenses</h2></div></div></div><p>Two licensing options are available when you purchase IDA. From the Hex-Rays website:<sup>[<a class="footnote" href="#ftn.CHP-3-FN-7" id="CHP-3-FN-7">24</a>]</sup> “Named licenses are linked to a specific end-user and may be used on as many computers as that particular end-user uses,” while “Computer licenses are linked to a specific computer and may be used by different end-users on that computer provided only one user is active at any time.” Note that while a single named license entitles you to install the software on as many computers as you like, you are the only person who may run those copies of IDA, and, for a single license, IDA may be running on only one of those computers at any given time.<a class="indexterm" id="IDX-CHP-3-0013"/><a class="indexterm" id="IDX-CHP-3-0014"/><a class="indexterm" id="IDX-CHP-3-0015"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>Unlike many other software licenses for proprietary software, IDA’s license specifically grants users the right to reverse engineer IDA.</p></div></div><div class="sect2" title="Purchasing IDA"><div class="titlepage"><div><div><h2 class="title"><a id="purchasing_ida"/>Purchasing IDA</h2></div></div></div><p>Prior to version 6.0, IDA purchases included a Windows GUI version along with console versions for Windows, Linux, and OS X. Beginning with version 6.0, purchasers must specify exactly which operating system they wish to run their copy of IDA on. Each copy of IDA 6.<span class="emphasis"><em>x</em></span> includes console and Qt-based GUI versions for the specified operating system only. Additional licenses for alternate operating systems are available for a reduced price. You can purchase IDA through authorized distributors listed on the IDA sales web page or directly from Hex-Rays by fax or email. Purchased copies can be delivered via CD or downloaded, and they entitle the buyer to a year of support and upgrades. In addition to the IDA installer, the CD distribution contains a variety of extras such as the IDA software development kit (SDK) and other utilities. Users who opt to download their purchased copy of IDA typically receive only the installer bundle and are required to download other components separately.<a class="indexterm" id="IDX-CHP-3-0016"/><a class="indexterm" id="IDX-CHP-3-0017"/><a class="indexterm" id="IDX-CHP-3-0018"/><a class="indexterm" id="IDX-CHP-3-0019"/><a class="indexterm" id="IDX-CHP-3-0020"/><a class="indexterm" id="IDX-CHP-3-0021"/></p><p>Hex-Rays has been known to restrict sales to specific countries based on its experiences with piracy in those countries. It also maintains a blacklist of users who have violated the terms of licensing for IDA and may refuse to do business with such users and/or their employers.</p></div><div class="sect2" title="Upgrading IDA"><div class="titlepage"><div><div><h2 class="title"><a id="upgrading_ida"/>Upgrading IDA</h2></div></div></div><p>The IDA Help menu contains an option to check for an available upgrade. Additionally, IDA will automatically issue warnings that your support period is about to expire based on the expiration date contained in your key file. The upgrade process typically involves submitting your <span class="emphasis"><em>ida.key</em></span> file to Hex-Rays, which will then validate your key and provide you with details on how to obtain your upgraded version. Should you find that your version of IDA is too old to be eligible for an upgrade, be sure to take advantage of Hex-Rays’ reduced upgrade pricing for holders of expired keys.</p><div class="warning" title="Warning"><h3 class="title">Warning</h3><p>Failure to maintain close control over your key file could result in an unauthorized user requesting your allotted upgrade, preventing you from upgrading your copy of IDA.<a class="indexterm" id="IDX-CHP-3-0022"/><a class="indexterm" id="IDX-CHP-3-0023"/></p></div><p>As a final note on upgrading any version of IDA, we highly recommend backing up your existing IDA installation or installing your upgrade to a completely different directory in order to avoid losing any configuration files that you may have modified. You will need to edit the corresponding files in your upgrade version to re-enable any changes that you have previously made. Similarly you will need to move, recompile, or otherwise obtain new versions of any custom IDA plug-ins that you may have been using (more about plug-ins and the plug-in installation process in <a class="xref" href="ch17.html" title="Chapter 17. The IDA Plug-in Architecture">Chapter 17</a>).</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-4" id="ftn.CHP-3-FN-4">21</a>] </sup>See <a class="ulink" href="http://www.hex-rays.com/idapro/idadownfreeware.htm">http://www.hex-rays.com/idapro/idadownfreeware.htm</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-5" id="ftn.CHP-3-FN-5">22</a>] </sup>See <a class="ulink" href="http://www.hex-rays.com/idapro/idadowndemo.htm">http://www.hex-rays.com/idapro/idadowndemo.htm</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-6" id="ftn.CHP-3-FN-6">23</a>] </sup>See <a class="ulink" href="http://www.hex-rays.com/idapro/idaproc.htm">http://www.hex-rays.com/idapro/idaproc.htm</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-7" id="ftn.CHP-3-FN-7">24</a>] </sup>See <a class="ulink" href="http://www.hex-rays.com/idapro/idaorder.htm">http://www.hex-rays.com/idapro/idaorder.htm</a>.</p></div></div></div>
<div class="sect1" title="IDA Support Resources"><div class="titlepage"><div><div><h1 class="title"><a id="ida_support_resources"/>IDA Support Resources</h1></div></div></div><p>As an IDA user, you may wonder where you can turn for help when you have IDA-related questions. If we do our job well enough, this book will suffice in most situations. When you find yourself needing additional help, though, here are some popular resources:<a class="indexterm" id="IDX-CHP-3-0024"/><a class="indexterm" id="IDX-CHP-3-0025"/><a class="indexterm" id="IDX-CHP-3-0026"/><a class="indexterm" id="IDX-CHP-3-0027"/><a class="indexterm" id="IDX-CHP-3-0028"/><a class="indexterm" id="IDX-CHP-3-0029"/><a class="indexterm" id="IDX-CHP-3-0030"/></p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>Official help documentation</strong></span></span></dt><dd><p>IDA ships with a menu-activated help system, but it is primarily an overview of the IDA user interface and the scripting subsystem. No help is available for the IDA SDK, nor is much help available when you have questions like “How do I do <span class="emphasis"><em>x</em></span>?”</p></dd><dt><span class="term"><span class="strong"><strong>Hex-Rays’ support page and forums</strong></span></span></dt><dd><p>Hex-Rays hosts a support page<sup>[<a class="footnote" href="#ftn.CHP-3-FN-8" id="CHP-3-FN-8">25</a>]</sup> that offers links to various IDA-related resources, including online forums available to licensed users. Users will find that Ilfak and other core Hex-Rays programmers are frequent contributors to the forums. The forums are also a good starting point for unofficial support of the SDK, since many experienced IDA users are more than willing to offer assistance based on their personal experiences.</p><p>Questions concerning use of the SDK are often answered with “Read the include files.” The SDK is officially unsupported with a purchase of IDA; however, Hex-Rays does offer a yearly support plan for an annual fee of USD10,000 (yep, that’s right: $10K). An excellent resource to familiarize yourself with the SDK is “IDA Plug-in Writing in C/C++” by Steve Micallef.<sup>[<a class="footnote" href="#ftn.CHP-3-FN-9" id="CHP-3-FN-9">26</a>]</sup></p></dd><dt><span class="term"><span class="strong"><strong>OpenRCE.org</strong></span></span></dt><dd><p>A vibrant reverse engineering community exists at <a class="ulink" href="http://www.openrce.org/">http://www.openrce.org/</a>, which contains numerous articles related to novel uses of IDA along with active user forums. Similar to the forums at Hex-Rays, OpenRCE.org attracts a large number of experienced IDA users who are often more than willing to share their advice on how to resolve almost any problem you may encounter with IDA.<a class="indexterm" id="IDX-CHP-3-0031"/><a class="indexterm" id="IDX-CHP-3-0032"/></p></dd><dt><span class="term"><span class="strong"><strong>RCE Forums</strong></span></span></dt><dd><p>The Reverse Code Engineering (RCE) forums at <a class="ulink" href="http://www.woodmann.com/">http://www.woodmann.com/</a> contain countless posts related to the use of IDA Pro. The focus of the forums is much broader than the use of IDA Pro, however, with wide coverage of many tools and techniques useful to the binary reverse engineer.</p></dd><dt><span class="term"><span class="strong"><strong>The IDA Palace</strong></span></span></dt><dd><p>Though it has had problems finding a permanent residence, the IDA Palace<sup>[<a class="footnote" href="#ftn.CHP-3-FN-10" id="CHP-3-FN-10">27</a>]</sup> is a website dedicated to hosting information on IDA-related resources. Visitors can expect to find links to various papers related to IDA usage along with scripts and plug-ins for extending IDA’s capabilities.<a class="indexterm" id="IDX-CHP-3-0033"/><a class="indexterm" id="IDX-CHP-3-0034"/><a class="indexterm" id="IDX-CHP-3-0035"/><a class="indexterm" id="IDX-CHP-3-0036"/><a class="indexterm" id="IDX-CHP-3-0037"/><a class="indexterm" id="IDX-CHP-3-0038"/><a class="indexterm" id="IDX-CHP-3-0039"/><a class="indexterm" id="IDX-CHP-3-0040"/></p></dd><dt><span class="term"><span class="strong"><strong>Ilfak’s blog</strong></span></span></dt><dd><p>Finally, Ilfak’s blog<sup>[<a class="footnote" href="#ftn.CHP-3-FN-11" id="CHP-3-FN-11">28</a>]</sup> often contains postings detailing the use of IDA to solve various problems ranging from general disassembly to debugging and malware analysis. Additionally, postings by other Hex-Rays team members often detail some of the latest IDA features, as well as features that are under development.<a class="indexterm" id="IDX-CHP-3-0041"/></p></dd></dl></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-8" id="ftn.CHP-3-FN-8">25</a>] </sup>See <a class="ulink" href="http://www.hex-rays.com/idapro/idasupport.htm">http://www.hex-rays.com/idapro/idasupport.htm</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-9" id="ftn.CHP-3-FN-9">26</a>] </sup>See <a class="ulink" href="http://www.binarypool.com/idapluginwriting/idapw.pdf">http://www.binarypool.com/idapluginwriting/idapw.pdf</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-10" id="ftn.CHP-3-FN-10">27</a>] </sup>See <a class="ulink" href="http://old.idapalace.net/">http://old.idapalace.net/</a>.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-3-FN-11" id="ftn.CHP-3-FN-11">28</a>] </sup>See <a class="ulink" href="http://www.hexblog.com/">http://www.hexblog.com/</a>.</p></div></div></div>
<div class="sect1" title="Your IDA Installation"><div class="titlepage"><div><div><h1 class="title"><a id="your_ida_installation"/>Your IDA Installation</h1></div></div></div><p>Once you calm down from the initial excitement of receiving your shiny, new IDA CD and get down to the task of installing IDA, you will see that your CD contains directories named <span class="emphasis"><em>utilities</em></span> and <span class="emphasis"><em>sdk</em></span> containing various add-on utilities and the IDA software development kit, respectively. These will be discussed in detail later in the book. In the root directory of the CD you will find an installation binary. For Windows users, this binary is a traditional Windows installer executable. For Linux and OS X users, the installation binary is a gzipped <span class="emphasis"><em>.tar</em></span> file.<a class="indexterm" id="IDX-CHP-3-0042"/><a class="indexterm" id="IDX-CHP-3-0043"/><a class="indexterm" id="IDX-CHP-3-0044"/></p><div class="sect2" title="Windows Installation"><div class="titlepage"><div><div><h2 class="title"><a id="windows_installation"/>Windows Installation</h2></div></div></div><p>Installing IDA on Windows is very straightforward. IDA’s Windows installer requires a password that is supplied with your CD or via email if you have downloaded your copy of IDA. Launching the Windows installer walks you through several informational dialogs, only one of which requires any thought. As shown in <a class="xref" href="ch03s04.html#choosing_your_installation_location" title="Figure 3-1. Choosing your installation location">Figure 3-1</a>, you will be offered the opportunity to specify an installation location or to accept the default suggested by the installer. Regardless of whether you choose the default or specify an alternate location, for the remainder of this book we will refer to your chosen install location as <code class="literal">&lt;IDADIR&gt;</code>. In your IDA directory, you will find your key file, <span class="emphasis"><em>ida.key</em></span>, along with the following IDA executables:<a class="indexterm" id="IDX-CHP-3-0045"/><a class="indexterm" id="IDX-CHP-3-0046"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="emphasis"><em>idag.exe</em></span> is the Windows native GUI version of IDA. Beginning with version 6.2, this file will cease to be shipped with IDA.<a class="indexterm" id="IDX-CHP-3-0047"/></p></li><li class="listitem"><p><span class="emphasis"><em>idaq.exe</em></span> is the Windows Qt GUI version of IDA (versions 6.0 and later).<a class="indexterm" id="IDX-CHP-3-0048"/></p></li><li class="listitem"><p><span class="emphasis"><em>idaw.exe</em></span> is the Windows text-mode version of IDA.<a class="indexterm" id="IDX-CHP-3-0049"/></p></li></ul></div><div class="figure"><a id="choosing_your_installation_location"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject3_d1e2704"/><img alt="Choosing your installation location" src="httpatomoreillycomsourcenostarchimages854069.png.jpg"/></div></div><p class="title">Figure 3-1. Choosing your installation location</p></div><p>With the move to the Qt cross-platform GUI library in IDA version 6.0, the native Windows version of IDA (<span class="emphasis"><em>idag.exe</em></span>) has been deprecated and will cease to ship with IDA beginning with version 6.2.<a class="indexterm" id="IDX-CHP-3-0050"/><a class="indexterm" id="IDX-CHP-3-0051"/><a class="indexterm" id="IDX-CHP-3-0052"/><a class="indexterm" id="IDX-CHP-3-0053"/><a class="indexterm" id="IDX-CHP-3-0054"/><a class="indexterm" id="IDX-CHP-3-0055"/><a class="indexterm" id="IDX-CHP-3-0056"/><a class="indexterm" id="IDX-CHP-3-0057"/><a class="indexterm" id="IDX-CHP-3-0058"/></p></div><div class="sect2" title="OS X and Linux Installation"><div class="titlepage"><div><div><h2 class="title"><a id="os_x_and_linux_installation"/>OS X and Linux Installation</h2></div></div></div><p>For installation on either OS X or Linux, <code class="literal">gunzip</code> and <code class="literal">untar</code> the appropriate archive to a location of your choosing. On a Linux system, it might look like this:</p><a id="I_programlisting3_d1e2763"/><pre class="programlisting"># <strong class="userinput"><code>tar -xvzf ida61l.tgz</code></strong></pre><p>On an OS X system, it will look like this:</p><a id="I_programlisting3_d1e2769"/><pre class="programlisting"># <strong class="userinput"><code>tar -xvzf ida61m.tgz</code></strong></pre><p>In either case, you will have a top-level directory named <span class="emphasis"><em>ida</em></span> that contains all required files.</p><p>For both OS X and Linux, the name of the GUI version is <span class="emphasis"><em>idaq</em></span> and the name of the console version is <span class="emphasis"><em>idal</em></span>. The appearance of the console version is very similar to the Windows console version of IDA, which is shown in <a class="xref" href="ch03s04.html#the_console_version_of_ida_pro" title="Figure 3-2. The console version of IDA Pro">Figure 3-2</a>. Linux users may need to verify (using <code class="literal">ldd</code>) that all shared libraries required by IDA are available on their systems. One plug-in in particular, IDAPython, expects to find Python version 2.6 installed. You may need to upgrade your Python installation or create symbolic links as necessary to satisfy IDA requirements.</p><div class="figure"><a id="the_console_version_of_ida_pro"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject3_d1e2794"/><img alt="The console version of IDA Pro" src="httpatomoreillycomsourcenostarchimages854071.png.jpg"/></div></div><p class="title">Figure 3-2. The console version of IDA Pro</p></div></div><div class="sect2" title="IDA and SELinux"><div class="titlepage"><div><div><h2 class="title"><a id="ida_and_selinux"/>IDA and SELinux</h2></div></div></div><p>If you are a Linux user that has SELinux enabled, you may find that IDA complains it “cannot enable executable stack as shared object” when attempting to load your desired processor module. The <code class="literal">execstack</code> command may be used to fix this problem on a per module basis as shown here:<a class="indexterm" id="IDX-CHP-3-0059"/><a class="indexterm" id="IDX-CHP-3-0060"/><a class="indexterm" id="IDX-CHP-3-0061"/><a class="indexterm" id="IDX-CHP-3-0062"/><a class="indexterm" id="IDX-CHP-3-0063"/><a class="indexterm" id="IDX-CHP-3-0064"/><a class="indexterm" id="IDX-CHP-3-0065"/><a class="indexterm" id="IDX-CHP-3-0066"/><a class="indexterm" id="IDX-CHP-3-0067"/><a class="indexterm" id="IDX-CHP-3-0068"/></p><a id="I_programlisting3_d1e2846"/><pre class="programlisting">execstack -c &lt;IDADIR&gt;/procs/pc.ilx</pre></div><div class="sect2" title="32-bit vs. 64-bit IDA"><div class="titlepage"><div><div><h2 class="title"><a id="bit_vs._64-bit_ida"/>32-bit vs. 64-bit IDA</h2></div></div></div><p>Users of the advanced version of IDA will notice that they have two versions of each IDA executable, such as <span class="emphasis"><em>idag.exe</em></span> and <span class="emphasis"><em>idag64.exe</em></span> or <span class="emphasis"><em>idaq</em></span> and <span class="emphasis"><em>idaq64</em></span>. The distinction between the versions is that <span class="emphasis"><em>idax64</em></span> is capable of disassembling 64-bit code; however, all of the IDA executables themselves are 32-bit code. As a result, users running IDA on 64-bit platforms need to ensure that any supporting software required by IDA is available in a 32-bit version. For example, 64-bit Linux users must ensure that a 32-bit version of Python is installed if they wish to use IDAPython for scripting. Consult the documentation for your operating system for details on mixing 32- and 64-bit software.<a class="indexterm" id="IDX-CHP-3-0069"/></p></div><div class="sect2" title="The IDA Directory Layout"><div class="titlepage"><div><div><h2 class="title"><a id="the_ida_directory_layout"/>The IDA Directory Layout</h2></div></div></div><p>Instant familiarity with the contents of your IDA installation is by no means a requirement before you start using IDA. However, since our attention is turned to your new IDA install for the moment, let’s take an initial look at the basic layout. An understanding of the IDA directory structure will become more important as you progress to using the more advanced features of IDA covered later in the book. A brief description of each of the subdirectories within the IDA installation follows (for Windows and Linux users, these are found under <span class="emphasis"><em>&lt;IDADIR&gt;</em></span>; for OS X users, these will be found under <span class="emphasis"><em>&lt;IDA-DIR&gt;/idaq.app/Contents/MacOS</em></span>):<a class="indexterm" id="IDX-CHP-3-0070"/><a class="indexterm" id="IDX-CHP-3-0071"/><a class="indexterm" id="IDX-CHP-3-0072"/><a class="indexterm" id="IDX-CHP-3-0073"/><a class="indexterm" id="IDX-CHP-3-0074"/><a class="indexterm" id="IDX-CHP-3-0075"/><a class="indexterm" id="IDX-CHP-3-0076"/><a class="indexterm" id="IDX-CHP-3-0077"/><a class="indexterm" id="IDX-CHP-3-0078"/><a class="indexterm" id="IDX-CHP-3-0079"/><a class="indexterm" id="IDX-CHP-3-0080"/><a class="indexterm" id="IDX-CHP-3-0081"/><a class="indexterm" id="IDX-CHP-3-0082"/><a class="indexterm" id="IDX-CHP-3-0083"/><a class="indexterm" id="IDX-CHP-3-0084"/></p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>cfg</strong></span></span></dt><dd><p>The <span class="emphasis"><em>cfg</em></span> directory contains various configuration files, including the basic IDA configuration file <span class="emphasis"><em>ida.cfg</em></span>, the GUI configuration file <span class="emphasis"><em>idagui.cfg</em></span>, and the text-mode user interface configuration file <span class="emphasis"><em>idatui.cfg</em></span>. Some of the more useful configuration capabilities of IDA will be covered in <a class="xref" href="ch11.html" title="Chapter 11. Customizing IDA">Chapter 11</a>.<a class="indexterm" id="IDX-CHP-3-0085"/><a class="indexterm" id="IDX-CHP-3-0086"/><a class="indexterm" id="IDX-CHP-3-0087"/></p></dd><dt><span class="term"><span class="strong"><strong>idc</strong></span></span></dt><dd><p>The <span class="emphasis"><em>idc</em></span> directory contains the core files required by IDA’s built-in scripting language, IDC. Scripting with IDC will be covered in more detail in <a class="xref" href="ch15.html" title="Chapter 15. IDA Scripting">Chapter 15</a>.</p></dd><dt><span class="term"><span class="strong"><strong>ids</strong></span></span></dt><dd><p>The <span class="emphasis"><em>ids</em></span> directory contains symbol files (<span class="emphasis"><em>IDS files</em></span> in IDA parlance) that describe the content of shared libraries that may be referenced by binaries loaded into IDA. These IDS files contain summary information that lists all entries that are exported from a given library. These entries describe the type and number of parameters that a function requires, the return type (if any) of a function, and the calling convention utilized by the function.<a class="indexterm" id="IDX-CHP-3-0088"/></p></dd><dt><span class="term"><span class="strong"><strong>loaders</strong></span></span></dt><dd><p>The <span class="emphasis"><em>loaders</em></span> directory contains IDA extensions that are used during the file-loading process to recognize and parse known file formats such as PE or ELF files. IDA loaders will be discussed in more detail in <a class="xref" href="ch18.html" title="Chapter 18. Binary Files and IDA Loader Modules">Chapter 18</a>.</p></dd><dt><span class="term"><span class="strong"><strong>plugins</strong></span></span></dt><dd><p>The <span class="emphasis"><em>plugins</em></span> directory contains IDA modules designed to provide additional, and in most cases user-defined, behavior for IDA. IDA plug-ins will be discussed in greater detail in <a class="xref" href="ch17.html" title="Chapter 17. The IDA Plug-in Architecture">Chapter 17</a>.</p></dd><dt><span class="term"><span class="strong"><strong>procs</strong></span></span></dt><dd><p>The <span class="emphasis"><em>procs</em></span> directory contains the processor modules supported by the installed version of IDA. Processor modules provide the machine-language-to-assembly-language translation capability within IDA and are responsible for generating the assembly language displayed in the IDA user interface. IDA processor modules will be discussed in more detail in <a class="xref" href="ch19.html" title="Chapter 19. IDA Processor Modules">Chapter 19</a>.</p></dd><dt><span class="term"><span class="strong"><strong>sig</strong></span></span></dt><dd><p>The <span class="emphasis"><em>sig</em></span> directory contains signatures for existing code that IDA utilizes for various pattern-matching operations. It is through such pattern matching that IDA can identify sequences of code as known library code, potentially saving you significant amounts of time in the analysis process. The signatures are generated using IDA’s Fast Library Identification and Recognition Technology (FLIRT), which will be covered in more detail in <a class="xref" href="ch12.html" title="Chapter 12. Library Recognition Using FLIRT Signatures">Chapter 12</a>.<a class="indexterm" id="IDX-CHP-3-0089"/></p></dd><dt><span class="term"><span class="strong"><strong>til</strong></span></span></dt><dd><p>The <span class="emphasis"><em>til</em></span> directory contains type library information that IDA uses to record the layout of data structures specific to various compiler libraries. Customizing IDA type libraries will be discussed further in <a class="xref" href="ch13.html" title="Chapter 13. Extending IDA’s Knowledge">Chapter 13</a>.<a class="indexterm" id="IDX-CHP-3-0090"/><a class="indexterm" id="IDX-CHP-3-0091"/><a class="indexterm" id="IDX-CHP-3-0092"/><a class="indexterm" id="IDX-CHP-3-0093"/><a class="indexterm" id="IDX-CHP-3-0094"/></p></dd></dl></div></div></div>
<div class="sect1" title="Thoughts on IDA&#x2019;s User Interface"><div class="titlepage"><div><div><h1 class="title"><a id="thoughts_on_idaas_user_interface"/>Thoughts on IDA’s User Interface</h1></div></div></div><p>IDA’s MS-DOS heritage remains evident to this day. Regardless of the interface (text or GUI) that you happen to be using, IDA makes extensive use of hotkeys. While this is not necessarily a bad thing, it can yield unexpected results if you believe that you are in a text-entry mode and find that nearly every keystroke leads IDA to perform some hotkey action. For example, this can happen while using the GUI if you position the cursor to make a change and are expecting that anything you type will appear at the cursor location (IDA is not your mother’s word processor).<a class="indexterm" id="IDX-CHP-3-0095"/></p><p>From a data-entry perspective, IDA accepts virtually all of its input via dialogs, so if you are attempting to enter any data at all into IDA, do make sure you see a dialog in which to enter that data. The one exception is IDA’s hex-editing feature, which is only available via the Hex View window.<a class="indexterm" id="IDX-CHP-3-0096"/></p><p>A final point worth remembering is this: <span class="emphasis"><em>There is no undo in IDA!</em></span> If you inadvertently press a key that happens to initiate a hotkey action, do not waste any time searching for an undo feature within IDA’s menu system—you will not find one. Nor will you find a command history list to help you determine what it was you just did.<a class="indexterm" id="IDX-CHP-3-0097"/><a class="indexterm" id="IDX-CHP-3-0098"/></p></div>
<div class="sect1" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="summary-id2"/>Summary</h1></div></div></div><p>With the mundane details out of the way, it is time to move on to using IDA to accomplish something useful. Over the course of the next few chapters, you will discover how to use IDA to perform basic file analysis, learn how to interpret the IDA data displays, and learn how to manipulate those displays to further your understanding of a program’s behavior.</p></div></body></html>