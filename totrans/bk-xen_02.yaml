- en: Chapter 2. GETTING STARTED
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '![image with no caption](httpatomoreillycomsourcenostarchimages333191.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Fascinating though the theoretical underpinnings and implementation details
    of Xen are, we should probably move on to working directly with Xen for a bit
    of practice. There is, after all, no substitute for experience.
  prefs: []
  type: TYPE_NORMAL
- en: So! Welcome to Xen. This chapter is an easy quick start aimed at gently introducing
    Xen to one of your machines. We will hold your hand and not let it go.
  prefs: []
  type: TYPE_NORMAL
- en: Because this is a detailed walk-through, we're going to give focused, specific
    instructions, deviating from our normal policy of being vague and distro-agnostic.
    For the purposes of this chapter, we'll assume you're installing CentOS 5.x with
    the *server* defaults and using its built-in Xen support.
  prefs: []
  type: TYPE_NORMAL
- en: If you're using something else, this chapter will probably still be useful,
    but you might have to improvise a bit—the goals will be the same but the steps
    will probably be different.
  prefs: []
  type: TYPE_NORMAL
- en: RED HAT VS. CENTOS VS. FEDORA
  prefs: []
  type: TYPE_NORMAL
- en: So what is this CentOS, and why are we using it? The short answer is that CentOS,
    the *Community ENTerprise OS*, is an RPM-based distro derived from Red Hat Enterprise
    Linux with all of Red Hat's trademarks stripped out. We're focusing on it here
    because it's well supported by Xen, reasonably generic in structure, and fairly
    popular. Additionally, it's more stable than Fedora and a lot cheaper than Red
    Hat's official product, Red Hat Enterprise Linux (*RHEL* for short).
  prefs: []
  type: TYPE_NORMAL
- en: We have difficulty recommending Fedora for production use simply because the
    release cycle is unrealistically fast. While Red Hat handpicks updates for stability,
    Fedora operates as Red Hat's pressure cooker. Fedora applies the same sort of
    philosophy as Red Hat to picking kernel patches and such, but they release far
    more often. (If you've ever run a stock 2.6 kernel, you know that *someone* needs
    to handpick updates, be it you or your distro overlords, to get anything like
    enterprise performance.^([[14](#ftn.CHP-2-FNOTE-1)])) Fedora releases could be
    considered alpha versions of the next RHEL, and therefore, like any alpha software,
    we hesitate to rely on it.
  prefs: []
  type: TYPE_NORMAL
- en: The reason we suggest CentOS rather than Red Hat Enterprise Linux is simply
    that RHEL is quite expensive. (Especially by Linux standards.) It may well be
    worth it if you want support—but we'll stick to CentOS. It's a good product, benefiting
    from Red Hat's years of work with Linux, and it's stable and easy to manage.
  prefs: []
  type: TYPE_NORMAL
- en: Red Hat's effort shows to particular advantage in the work they've done integrating
    Xen. Red Hat has taken Xen and done a fair amount of work to make it a product.
    Thankfully, because Xen is open source, everyone benefits.
  prefs: []
  type: TYPE_NORMAL
- en: 'In general, the goals for this walk-through are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: Make sure your hardware can run Xen.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Install a basic OS.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Install Xen.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Familiarize yourself with the Xen environment.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Install a domU.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Log in to your domU and configure it to make sure everything works.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Rest.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Hardware Compatibility
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: First, make sure that your hardware's up to the task of running Xen. (It almost
    certainly is.)
  prefs: []
  type: TYPE_NORMAL
- en: All you need is a Pentium Pro or better, 512MiB of memory,^([[15](#ftn.CHP-2-FNOTE-2)])
    and a few hundred MiB of hard drive space. If you can't manage that, dig some
    change out of your couch cushions and buy a machine. The PPro came out in, what,
    1996? Haven't you heard? This Is The Future.
  prefs: []
  type: TYPE_NORMAL
- en: At present, Xen runs only on x86 (that is, Intel and AMD) processors and IBM's
    PowerPC. X86_64—the 64-bit extension to the x86 instruction set—is supported on
    both AMD and Intel processors. Xen also supports Intel's Itanium. For the sake
    of this walk-through, we'll assume that you're using an x86 or x86_64 machine.
  prefs: []
  type: TYPE_NORMAL
- en: Our test box, for example—chosen to be as common as possible—was a three-year-old
    Dell, with a Pentium 4, 1GB of RAM, and a quantity of hard drive space beyond
    my wildest imaginings. Personally, I think it's all so fast it makes me sick.
  prefs: []
  type: TYPE_NORMAL
- en: Anyway, so you've got a machine capable of running Xen. Congratulations. First,
    it needs a basic operating system that Xen can run on top of.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Run on top of *is probably not the best way of characterizing Xen's interaction
    with the dom0 OS, in view of the fact that the dom0 kernel runs on the hypervisor,
    but it is a convenient and frequently used phrase. We beg your patience, Constant
    Reader*.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[14](#CHP-2-FNOTE-1)]) We recognize that some people may disagree with this
    opinion.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[15](#CHP-2-FNOTE-2)]) The absolute minimum would probably be 128MiB, but
    CentOS itself requires 256, and each domU will also require a significant amount
    of memory.
  prefs: []
  type: TYPE_NORMAL
- en: Installing CentOS
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: First, we'll install CentOS in a completely ordinary way. Put the install medium
    in the drive, boot from it, and install it according to your preference. We opted
    to accept the default partitioning, which creates a small */boot* partition and
    devotes the rest of the drive to an LVM group, with a logical volume for swap
    and a volume for root. We also accepted the default configuration for the GRUB
    boot loader and the default network config.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '*Now would also be a good time to make sure you have some sort of Internet
    access*.'
  prefs: []
  type: TYPE_NORMAL
- en: Set your time zone and enter a root password. We're just running through the
    standard CentOS install process at this point—it's probably familiar territory.
    Follow the prompts as usual.
  prefs: []
  type: TYPE_NORMAL
- en: Next comes package selection. We chose the **virtualization server** package
    group, since that's the one that includes the Xen hypervisor and supporting tools,
    and left the rest blank. If you'd like to, you can also choose other package groups
    to install, like the GNOME desktop or server-gui set of packages, without modifying
    any of the steps in this section.
  prefs: []
  type: TYPE_NORMAL
- en: Select **Next**. Now the machine will install the packages you've selected.
    This may take a while, varying with package selection and install medium. It took
    us about 15 minutes to install from a DVD. When that's done, the machine will
    reboot and give you the chance to do postinstall configuration—firewall, services,
    SELinux, and so on.
  prefs: []
  type: TYPE_NORMAL
- en: At this point you may wish to do other system configuration related stuff, not
    directly related to Xen. Feel free.
  prefs: []
  type: TYPE_NORMAL
- en: Now, we're ready to create a virtual machine. But first let's look at Xen's
    boot messages and get familiar with the Xen environment.
  prefs: []
  type: TYPE_NORMAL
- en: THE LIVECD
  prefs: []
  type: TYPE_NORMAL
- en: So, you downloaded the LiveCD? May as well try it. It's pretty slick, but when
    it's booted, it's just another operating system. This captures what makes Xen
    so fascinating—its sheer banality. After all this work, you wind up sitting in
    front of a Linux box. Yes, it will pretend to be multiple Linux boxes on demand,
    but there's not really much "there" there, to borrow a well-turned phrase from
    Gertrude Stein.
  prefs: []
  type: TYPE_NORMAL
- en: The LiveCD does showcase some useful features, though. For example, it uses
    a copy-on-write filesystem to give each Xen domain persistent writable storage
    across VM reboots. The LiveCD also has some neat scripts that use the XenBus to
    pop up a VNC console automatically on domU startup. (See [Chapter 14](ch14.html
    "Chapter 14. TIPS") for more information on that.)
  prefs: []
  type: TYPE_NORMAL
- en: It's a nice demo, but it's not really useful for production, and it doesn't
    give you the sort of hands-on experience that comes with setting up a machine.
    The other problem is that the LiveCD hasn't been updated in a while. The last
    version (as of this writing) is two years old and is based on Xen 3.0.3\. There
    have since been some changes to Xen.
  prefs: []
  type: TYPE_NORMAL
- en: Booting with Xen features extra Xen-specific boot output, as shown in [Figure 2-1](ch02s02.html#success_the_xen_kernel_wants_to_have_a_c
    "Figure 2-1. Success! The Xen kernel wants to have a conversation with us.").
  prefs: []
  type: TYPE_NORMAL
- en: '![Success! The Xen kernel wants to have a conversation with us.](httpatomoreillycomsourcenostarchimages333205.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 2-1. Success! The Xen kernel wants to have a conversation with us.
  prefs: []
  type: TYPE_NORMAL
- en: After GRUB loads, it loads the Xen hypervisor, which then takes control of the
    hardware and outputs its initialization lines (starting with `(XEN)`). Then it
    loads the dom0 kernel, which takes over and spews the familiar Linux boot messages
    that we know and tolerate. (Note that you may not see these messages if you're
    using the VGA console, since they go by rather quickly. You can type `xm dmesg`
    to see them at any time.)
  prefs: []
  type: TYPE_NORMAL
- en: After the system boots, you should be looking at the normal login prompt, with
    nary a sign that you're running in a Xen virtual machine. (Albeit a specially
    privileged virtual machine.) Now would be a great time to log in, if you haven't
    already.
  prefs: []
  type: TYPE_NORMAL
- en: Getting Familiar with Your Xen System
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Before we start creating virtual machines, let's take a brief look at the Xen
    configuration files in the dom0\. We'll be referring to these a lot in future
    chapters, so now might be a good time to take a quick tour.
  prefs: []
  type: TYPE_NORMAL
- en: First, there's the Xen configuration directory, */etc/xen*. Most, though not
    all, of the Xen configuration happens via files here or in the *scripts* subdirectory.
  prefs: []
  type: TYPE_NORMAL
- en: The main Xen config file is *xend-config.sxp*. This where you'd perform tasks
    like enabling migration or specifying the network backend. For now, we'll be content
    with the defaults.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '*If you''re planning on using this Xen installation for anything besides this
    walk-through, now is a good time to set the* *`(dom-min-mem)`* *option in* xend-config.sxp
    *to something sensible. We use* *`(dom-min-mem 1024)`*. *See [Chapter 14](ch14.html
    "Chapter 14. TIPS") for more details*.'
  prefs: []
  type: TYPE_NORMAL
- en: The */etc/xen/scripts* directory contains scripts to handle tasks like setting
    up virtual devices.
  prefs: []
  type: TYPE_NORMAL
- en: Finally, domain configuration files live in */etc/xen*. For example, you can
    take a look at *xmexample1* to see a liberally commented sample config.
  prefs: []
  type: TYPE_NORMAL
- en: The */etc/init.d* directory contains scripts to start and stop Xen-related services.
    The Xen control daemon, `xend`, runs as a standard service from the */etc/init.d/xend*
    script. Although you probably won't need to modify it, this can be a handy place
    to change `xend` 's parameters. It's also the easiest way to restart `xend`, by
    running `/etc/init.d/xend restart`. The *xendomains* script may also be of interest—it
    automatically saves domains when the system shuts down and restores them when
    it boots up.
  prefs: []
  type: TYPE_NORMAL
- en: There's also */boot/grub/menu.lst*. This file tells the bootloader, GRUB, to
    boot the Xen kernel, relegating the dom0 Linux kernel to a "module" line. Here
    you'd change the boot parameters for both Xen and Linux. For example, you might
    want to specify a fixed memory allocation for dom0 using the `dom0_mem` hypervisor
    option, or increase the number of network loopback devices via the Linux `nloopbacks`
    option.
  prefs: []
  type: TYPE_NORMAL
- en: domU data itself, if you're using file-backed virtual disks under CentOS and
    following the default prompts for `virt-install`, resides in */var/lib/xen/images*.
    Other distros and frontends are likely to have different defaults.
  prefs: []
  type: TYPE_NORMAL
- en: Management with xm
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The main command that you''ll use to interact with Xen is `xm`. This tool has
    a wide variety of subcommands. First, since we''re still looking around the environment,
    try `xm list`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: The output of `xm list` shows the running domains and their attributes. Here
    we see that only one domain is running, Domain-0 (abbreviated *dom0* throughout
    the book) with ID 0, 934MiB of memory, and two VCPUS. It's in the "running" state
    and has used 37.6 seconds of CPU time since boot.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '*Red Hat doesn''t officially support* `xm`, *although they unofficially expect
    it to continue working through RHEL 5*.x. *For this reason*, `xm` ''*s documentation
    may advertise capabilities that don''t work on RHEL or CentOS. The supported management
    tool on RHEL and friends is* *`virsh`*, *for* virtualization shell.'
  prefs: []
  type: TYPE_NORMAL
- en: You might also try `xm info` for more information on the hypervisor. We'll introduce
    more `xm` subcommands in later chapters, and there's a complete list in [Appendix A](apa.html
    "Appendix A. XM REFERENCE").
  prefs: []
  type: TYPE_NORMAL
- en: Making a DomU
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: For the moment, since we want to create a domU, the `xm` subcommand we're most
    interested in is `create`. However, before we can create a domain, we need to
    create an OS image for it to boot from and use as storage.
  prefs: []
  type: TYPE_NORMAL
- en: Because this is an initial walk-through, we're going to install our Xen image
    using Red Hat's `virt-install` tool. For information on building your own domU
    images, take a look at [Chapter 3](ch03.html "Chapter 3. PROVISIONING DOMUS").
  prefs: []
  type: TYPE_NORMAL
- en: Begin by starting `virt-install`. It'll start in interactive mode, and have
    a bit of a conversation with you, as shown. Our inputs are shown in bold. (If
    you decided to install the GUI, you can also use the graphical `virt-manager`
    tool. The prompts will look very similar.)
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'The machine then begins an interactive network install of CentOS. We won''t
    go into the details of its operation for now—suffice it to say that great pains
    have been taken to preserve the appearance of installing an OS on a physical machine.
    As such, the install process should eerily resemble the one we performed at the
    start of this chapter. Follow its prompts. (For the curious, we discuss `virt-install`
    and its accompanying tools more thoroughly in Chapters [Chapter 3](ch03.html "Chapter 3. PROVISIONING
    DOMUS") and [Chapter 6](ch06.html "Chapter 6. DOMU MANAGEMENT: TOOLS AND FRONTENDS").)'
  prefs: []
  type: TYPE_NORMAL
- en: Once you've made your selections and gone through the install, the machine will
    reboot. Log in, and then shut the machine down via `shutdown -h now` (remember,
    it's an ordinary Linux box) so that we can look a bit more at things from the
    dom0 end.
  prefs: []
  type: TYPE_NORMAL
- en: Anatomy of a Domain Configuration File
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Let's take a moment to examine the config file that `virt-install` generated
    for us. As we've mentioned already, the config file is */etc/xen/<domain name>*
    by convention.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: As you see, the file consists of simple name=value pairs, with Python-style
    lists in square brackets. Note the values that we specified in the `virt-install`
    session, plugged into appropriate places—the name, the memory amount, and the
    disk image. `virt-install` also fills in some network configuration, specifying
    a MAC address and dom0-level bridge device.
  prefs: []
  type: TYPE_NORMAL
- en: We'll examine many of the config file parameters more deeply in subsequent chapters.
    For now, let's just move on to seeing the effects of these values on our domain.
  prefs: []
  type: TYPE_NORMAL
- en: Configuring the DomU
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Finally, start the image! We'll run `xm` with the `create` subcommand, which
    expects a config file name as an argument. We can omit the path, since it defaults
    to looking in */etc/xen*.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: Since we passed the `-c` option to `xm create`, it'll immediately connect us
    to the domain's console, so that we can interact with the bootloader. Hit ENTER
    to boot with default options, and watch it go.
  prefs: []
  type: TYPE_NORMAL
- en: Once it boots, you should be looking at the console of a shiny new Xen domU,
    as illustrated in [Figure 2-2](ch02s05.html#we_assure_you_that_this_is_the_domu_cons
    "Figure 2-2. We assure you that this is the domU console."). Log in as root and
    frolic.
  prefs: []
  type: TYPE_NORMAL
- en: Start by looking at the output of the `dmesg` command within the domU. Note
    that the disk and network devices are Xen's special paravirtualized devices.
  prefs: []
  type: TYPE_NORMAL
- en: '![We assure you that this is the domU console.](httpatomoreillycomsourcenostarchimages333207.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 2-2. We assure you that this is the domU console.
  prefs: []
  type: TYPE_NORMAL
- en: 'You can also take a look at the domU''s networking, which is essentially indistinguishable
    from that of a normal Linux system:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: Note that we're using standard commands—one of the major features of Xen is
    that most of the management takes place via familiar Linux commands. This makes
    it easy to customize your Xen environment, usually by making changes to the support
    scripts. Furthermore, standard commands will generally behave in expected ways—for
    example, you can give yourself a new IP address via `ifconfig`, and it'll work
    just as it would on a physical machine.^([[16](#ftn.CHP-2-FNOTE-3)])
  prefs: []
  type: TYPE_NORMAL
- en: Let's return to the dom0 for a moment, just to take a look at the running domain
    from outside. To break out of the domU's console, type CTRL-]. You can reconnect
    at any time by running `xm console <domU name or id>` from the dom0.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now that we''re back in the dom0, we can note that our new domain shows up
    in `xm list`, consuming memory and CPU time:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'And that it''s got a visible network device:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'Some points to mention about the network device: First, it''s got a dummy MAC
    address. You can see the actual MAC address of the virtual Ethernet device from
    within the domU. Second, the counters are reversed—the domain''s actually downloaded
    100MiB, and transmitted 2.7\. Third, both IPv4 and IPv6 "just work" with the default
    setup. We go into further detail in [Chapter 5](ch05.html "Chapter 5. NETWORKING").'
  prefs: []
  type: TYPE_NORMAL
- en: From here you can treat the domain just like any other Linux box. You can set
    up users on it, SSH into it, or access its console via `xm console`. You can reboot
    it via the `xm reboot` command, and shut it down using `xm shutdown`.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[16](#CHP-2-FNOTE-3)]) The administrator can disable this, however. You'll
    still be able to change the IP from the domU, but the dom0 will block traffic
    from the new IP. See [Chapter 5](ch05.html "Chapter 5. NETWORKING") for details.
  prefs: []
  type: TYPE_NORMAL
- en: You're Finished. Have a Cookie.
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now that you've got a domain, read the next chapter.
  prefs: []
  type: TYPE_NORMAL
- en: If it didn't work … what a fabulous opportunity to examine [Chapter 15](ch15.html
    "Chapter 15. TROUBLESHOOTING"). We are sorry. Please email us and mention that
    our directions need work.
  prefs: []
  type: TYPE_NORMAL
