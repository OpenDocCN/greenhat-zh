- en: 'Chapter 8. BEYOND LINUX: USING XEN WITH OTHER UNIX-LIKE OSS'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第 8 章。超越 Linux：使用 Xen 与其他类 Unix OSS
- en: '![image with no caption](httpatomoreillycomsourcenostarchimages333191.png.jpg)'
  id: totrans-1
  prefs: []
  type: TYPE_IMG
  zh: '![无标题图片](httpatomoreillycomsourcenostarchimages333191.png.jpg)'
- en: One major benefit of paravirtualization which we've thus far ignored is the
    ability to run multiple operating systems on a single paravirtualized physical
    machine. Although Linux is the most popular OS to run under Xen, it's not the
    only option available. Several other Unix-like OSs can run as a dom0, and rather
    more have been modified to run as paravirtualized domUs.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 我们之前忽略的一个主要优势是能够在单个虚拟化物理机上运行多个操作系统。尽管 Linux 是在 Xen 下运行的最受欢迎的操作系统，但并非唯一的选择。几个其他类
    Unix 操作系统可以作为 dom0 运行，而且更多已经被修改为作为虚拟化 domUs 运行。
- en: Apart from Linux, only Solaris and NetBSD are capable of functioning as a dom0
    with current versions of Xen. Some work has been done with the other BSDs and
    with Plan9, but these OSs either can only work as a domU or can only work with
    older Xen versions. Support is evolving rapidly, however. (FreeBSD seems especially
    close to having functional Xen bits.)
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 除了 Linux 之外，只有 Solaris 和 NetBSD 能够在当前版本的 Xen 中作为 dom0 运行。其他 BSD 和 Plan9 也进行了一些工作，但这些操作系统要么只能作为
    domU 运行，要么只能与较旧的 Xen 版本一起工作。然而，支持正在迅速发展。（FreeBSD 似乎已经非常接近拥有功能性的 Xen 位元。）
- en: In this chapter, we'll focus on Solaris and NetBSD. Partially this is because
    they have mature Xen support, with active community involvement and ongoing development.
    Most importantly, though, it's because we have run them in production. In a later
    chapter, we'll discuss Windows.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将重点关注 Solaris 和 NetBSD。部分原因是它们拥有成熟的 Xen 支持，包括积极的社区参与和持续的开发。但最重要的是，我们已经在生产环境中运行了它们。在后续章节中，我们将讨论
    Windows。
- en: Solaris
  id: totrans-5
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Solaris
- en: Sun has been pushing Xen virtualization heavily in recent community releases
    of OpenSolaris, and their effort shows. Solaris works well as both a dom0 and
    a domU, with closely integrated Xen support. The only caveat is that, as of this
    writing, OpenSolaris does not support Xen 3.3 and paravirt_ops domUs.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: Sun 在最近发布的 OpenSolaris 社区版本中大力推广 Xen 虚拟化，并且他们的努力得到了体现。Solaris 既可以作为 dom0 也可以作为
    domU 运行，并且与 Xen 集成紧密。唯一的缺点是，截至本文撰写时，OpenSolaris 不支持 Xen 3.3 和 paravirt_ops domUs。
- en: Note
  id: totrans-7
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*Sun doesn''t actually call their shipping version of Xen* Xen. *They use the
    term* xVM *for marketing purposes, and include the unrelated VirtualBox under
    the xVM label. We''re going to continue to call it Xen, however, because it''s
    the name we''re used to*.'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: '*Sun 实际上并没有将他们提供的 Xen 版本称为 Xen*。*他们使用 *xVM* 这个术语进行市场营销，并将无关的 VirtualBox 包含在
    xVM 标签下。然而，我们将继续称其为 Xen，因为我们已经习惯了这个名字*。'
- en: Only the x86 version of Solaris supports Xen—Solaris/SPARC uses alternate virtualization
    technologies.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 只有 x86 版本的 Solaris 支持 Xen——Solaris/SPARC 使用其他虚拟化技术。
- en: VIRTUALIZATION WITH SOLARIS
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 Solaris 进行虚拟化
- en: Sun, being traditionally a "medium iron" company, has emphasized virtualization
    for a long time, with a few different, complementary technologies to implement
    virtualization at different levels. Here's an overview of their non-Xen virtualization
    offerings.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: Sun 作为一家传统的“中等铁”公司，长期以来一直强调虚拟化，并采用了几种不同的、互补的技术来实现不同层次的虚拟化。以下是它们非 Xen 虚拟化产品概述。
- en: On new UltraSparc Niagara-based systems, pure hardware virtualization is provided
    by means of Logical Domains, or LDoms. These are a successor to the *Dynamic System
    Domains* found on earlier Sun Enterprise platforms, which allowed you to devote
    CPU and memory boards to independent OS instances. Similarly, on a reasonably
    new SPARC box, you can partition the CPU and memory to run multiple, independent
    operating systems, using the processor's hardware virtualization support.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 在基于新 UltraSparc Niagara 的系统上，纯硬件虚拟化是通过逻辑域（LDoms）或 LDoms 提供的。这些是早期 Sun Enterprise
    平台上发现的 *动态系统域* 的后继者，允许你将 CPU 和内存板分配给独立的操作系统实例。同样，在相对较新的 SPARC 机器上，你可以使用处理器的硬件虚拟化支持来分区
    CPU 和内存，以运行多个独立的操作系统。
- en: On x86, Sun addresses full virtualization by way of their VirtualBox product.
    VirtualBox executes guest code directly where possible and emulates when necessary,
    much like VMware.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 在 x86 上，Sun 通过他们的 VirtualBox 产品解决全虚拟化问题。VirtualBox 尽可能直接执行客户代码，并在必要时进行模拟，这与
    VMware 类似。
- en: Finally, Sun addresses OS-level virtualization through Solaris Zones,^([[45](#ftn.CHP-8-FNOTE-1)])
    which are themselves an interesting, lightweight virtualization option. Like other
    OS-level virtualization platforms, Zones provide a fair amount of separation between
    operating environments with very little overhead.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，Sun通过Solaris Zones解决了操作系统级别的虚拟化问题，^([[45](#ftn.CHP-8-FNOTE-1))) Zones本身是一个有趣且轻量级的虚拟化选项。与其他操作系统级别的虚拟化平台一样，Zones在操作环境之间提供了相当大的隔离，同时开销很小。
- en: Sun even offers the option to run Linux binaries under Solaris on x86_64, via
    *lx* branded Zones. (These *lx* branded Zones provide a thin compatibility layer
    between the Solaris kernel and Linux userspace. Pretty cool.) However, the Linux
    emulation isn't perfect. For example, since *lx* branded Zones use the same Solaris
    kernel that's running on the actual hardware, you can't load Linux device drivers.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: Sun甚至提供了在x86_64上的Solaris下运行Linux二进制文件的选择，通过*lx*品牌的Zones。(*lx*品牌的Zones在Solaris内核和Linux用户空间之间提供了一个薄薄的兼容层。相当酷。)然而，Linux仿真并不完美。例如，由于*lx*品牌的Zones使用与实际硬件上运行的相同Solaris内核，因此你不能加载Linux设备驱动程序。
- en: Getting Started with Solaris
  id: totrans-16
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Solaris入门
- en: To run Solaris under Xen, you'll need to get a copy of Solaris. There are several
    versions, so make sure that you pick the right one.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 要在Xen下运行Solaris，你需要获取一份Solaris的副本。有几个版本，所以请确保你选择正确的版本。
- en: You do not want Solaris 10, which is the current Sun version of Solaris. Although
    it's a fine OS, it doesn't have Xen support because its development lags substantially
    behind the bleeding edge. (In this it caters to its market segment. We are personally
    acquainted with people who are running Solaris 8—a welcome contrast to the prevailing
    Linux view that software more than six months old is some sort of historical curiosity.)
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 你不希望使用Solaris 10，这是当前Sun的Solaris版本。尽管它是一个不错的操作系统，但由于其开发落后于前沿，它没有Xen支持。（在这方面，它迎合了其市场细分。我们认识一些运行Solaris
    8的人——与普遍的Linux观点形成鲜明对比，即六个月以上的软件是一种历史遗迹。）
- en: Fortunately, Solaris 10 isn't the only option. Solaris Express acts as a preview
    of the next official Solaris version, and it's a perfectly capable OS for Xen
    in its own right. It incorporates Xen, but is still a bit behind the latest development.
    It's also not as popular as OpenSolaris.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 幸运的是，Solaris 10并非唯一的选择。Solaris Express作为下一个官方Solaris版本的预览，本身就是一个完全能够胜任Xen的操作系统。它集成了Xen，但仍然略落后于最新的开发。它也不像OpenSolaris那样受欢迎。
- en: Finally, there's OpenSolaris. Sun released huge tracts of Solaris source code
    a while ago under the Common Development and Distribution License^([[46](#ftn.CHP-8-FNOTE-2)])
    (CDDL), and the community's been pounding on it ever since. OpenSolaris is the
    result—it's much like Sun's release of Solaris but with new technology and a much
    faster release cycle. Think of the relationship between the two as like Red Hat
    Enterprise Linux and Fedora, only more so.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，还有OpenSolaris。Sun在一段时间前根据通用开发与分发许可协议^([[46](#ftn.CHP-8-FNOTE-2)))（CDDL）发布了大量的Solaris源代码，自那以后社区一直在对其进行开发。OpenSolaris就是其结果——它类似于Sun发布的Solaris，但采用了新技术和更快的发布周期。将两者之间的关系想象成类似于Red
    Hat Enterprise Linux和Fedora，只是更加紧密。
- en: Both Solaris Express and OpenSolaris incorporate Xen support. Solaris Express
    has the Xen packages included on the DVD, while OpenSolaris requires you to download
    Xen as an add-on. Both of them provide a fairly polished experience. Although
    there are other distros based on the released Solaris code, none of them are particularly
    Xen-oriented, so the officially blessed distros are probably the best place to
    start.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: Solaris Express和OpenSolaris都集成了Xen支持。Solaris Express在DVD上包含了Xen软件包，而OpenSolaris则需要你作为附加组件下载Xen。它们都提供了相当完善的体验。尽管有其他基于发布版Solaris代码的发行版，但它们都没有特别针对Xen，因此官方认可的发行版可能是开始的最佳选择。
- en: RUNNING SOLARIS EXPRESS
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 运行Solaris Express
- en: We had some trouble deciding whether to focus on OpenSolaris or Solaris Express
    while we were writing this chapter. We decided to go with OpenSolaris because
    it seemed more popular, based on a completely unscientific poll of our friends.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 在撰写本章时，我们遇到了一些困难，决定是专注于OpenSolaris还是Solaris Express。我们决定选择OpenSolaris，因为它似乎更受欢迎，这是基于我们对朋友进行的一次完全非科学的调查。
- en: However, Solaris Express is still a perfectly fine OS with excellent Xen support,
    so we've also included some notes on setting it up.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，Solaris Express仍然是一个功能完善的操作系统，拥有出色的Xen支持，因此我们也包括了一些关于如何设置它的说明。
- en: Believe it or not, Xen support should exist pretty much out of the box.^([[47](#ftn.CHP-8-FNOTE-3)])
    When you install Solaris Express on a system that supports Xen, it installs a
    Xen kernel and gives you the option to boot it from GRUB—just select **Solaris
    xVM** and off you go. (The included Xen version is 3.1.4 as of snv_107.)
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 信不信由你，Xen 支持应该几乎完全预装.^([[47](#ftn.CHP-8-FNOTE-3)]) 当您在支持 Xen 的系统上安装 Solaris
    Express 时，它会安装一个 Xen 内核，并为您提供从 GRUB 启动它的选项——只需选择 **Solaris xVM** 然后出发。（包含的 Xen
    版本为 3.1.4，截至 snv_107。）
- en: From there, you can install domUs normally. It's even got `virt-manager`. Take
    a look at the next section for more details on setting up domUs. Most of these
    steps will apply to Solaris Express and OpenSolaris equally well.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 从那里，您可以正常安装 domUs。它甚至有 `virt-manager`。请参阅下一节以获取有关设置 domUs 的更多详细信息。这些步骤中的大多数将同样适用于
    Solaris Express 和 OpenSolaris。
- en: In general, there are three possible configurations of (Open)Solaris that are
    of interest in our discussion of Xen.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 通常情况下，在关于 Xen 的讨论中，有三个可能的 (Open)Solaris 配置值得关注。
- en: First, we have the Solaris dom0.
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 首先，我们有 Solaris dom0。
- en: Second, there's the Solaris domU on a Solaris dom0\. This is a fairly straightforward
    setup.
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 第二，有一个 Solaris domU 在 Solaris dom0 上。这是一个相当直接的设置。
- en: Finally, you can run a Solaris domU under Linux with a minimum^([[48](#ftn.CHP-8-FNOTE-4)])
    of fuss.
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最后，您可以在 Linux 下以最小的麻烦运行 Solaris domU。
- en: Solaris Dom0
  id: totrans-31
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Solaris Dom0
- en: Let's start by setting up an OpenSolaris dom0, since you'll need one for the
    next section. (Although we suppose this applies only if you're doing something
    crazy like running through all our examples in order.)
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从设置 OpenSolaris dom0 开始，因为您将在下一节中需要它。（尽管我们认为这仅适用于您在做一些疯狂的事情，比如按顺序运行我们所有的示例。）
- en: Note that we're going to be using `pfexec`, the Solaris equivalent of `sudo`,^([[49](#ftn.CHP-8-FNOTE-5)])
    for these examples, so it's not necessary to be root for these steps.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，我们将使用 `pfexec`，这是 Solaris 的 `sudo` 等效物，^([[49](#ftn.CHP-8-FNOTE-5)]) 在这些示例中，因此不需要以
    root 身份执行这些步骤。
- en: First, download the distribution from [http://opensolaris.org/os/downloads/](http://opensolaris.org/os/downloads/).
    Follow the directions to unpack and burn it, and boot from the CD, just like virtually
    any other OS install.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，从 [http://opensolaris.org/os/downloads/](http://opensolaris.org/os/downloads/)
    下载发行版。按照指示解包并刻录到 CD 上，然后从 CD 启动，就像安装任何其他操作系统一样。
- en: The OpenSolaris LiveCD will probably be a familiar experience to anyone who's
    installed Ubuntu. It 's really quite similar, with a standard GNOME desktop, some
    productivity software, and a cute *Install OpenSolaris* icon on the desktop. Double-click
    the **Install OpenSolaris** icon to launch the installer, then follow its directions.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: OpenSolaris LiveCD 对于安装过 Ubuntu 的人来说可能很熟悉。它实际上非常相似，有一个标准的 GNOME 桌面，一些生产力软件，以及一个可爱的
    *安装 OpenSolaris* 图标在桌面上。双击 **安装 OpenSolaris** 图标以启动安装程序，然后按照其指示操作。
- en: When the installer finishes, it'll prompt you to reboot.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 当安装程序完成时，它会提示您重新启动。
- en: Setting Up Xen
  id: totrans-37
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 设置 Xen
- en: If, once you reboot, you notice that you don't have Xen available, don't panic.
    OpenSolaris, unlike Solaris Express, doesn't include the Xen packages in the initial
    install. (Everything had to fit on a CD, after all.) You will have to install
    and set them up manually.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您重新启动后注意到您没有 Xen 可用，请不要慌张。与 Solaris Express 不同，OpenSolaris 在初始安装中不包括 Xen 软件包。（毕竟，所有内容都必须适合在
    CD 上。）您将需要手动安装和设置它们。
- en: First, we create a ZFS boot environment. (If you're not familiar with boot environments,
    substitute the word *snapshot*. The idea is, if you break your system trying to
    install Xen, you can reboot into the original environment and try again.)
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们创建一个 ZFS 引导环境。（如果您不熟悉引导环境，可以将单词 *快照* 替换掉。想法是，如果您在尝试安装 Xen 时破坏了系统，您可以重新启动到原始环境并再次尝试。）
- en: '[PRE0]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Next, we use the OpenSolaris `pkg` command to install the Xen packages in the
    new boot environment.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们使用 OpenSolaris 的 `pkg` 命令在新引导环境中安装 Xen 软件包。
- en: '[PRE1]'
  id: totrans-42
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'As of OpenSolaris 2008.11, the xvm-gui package cluster provides all the necessary
    Xen packages. Previous versions may require you to install the packages individually.
    If you need to do that, you should be able to get away with running:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 截至 OpenSolaris 2008.11，xvm-gui 软件包集群提供了所有必要的 Xen 软件包。之前的版本可能需要您单独安装这些软件包。如果您需要这样做，您应该能够通过运行以下命令来解决问题：
- en: '[PRE2]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: These packages provide Xen (with HVM), `virt-install`, and `virt-install` 's
    dependencies.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 这些软件包提供了 Xen（带有 HVM）、`virt-install` 以及 `virt-install` 的依赖项。
- en: Next, we need to update GRUB to boot the Xen kernel properly.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们需要更新 GRUB 以正确引导 Xen 内核。
- en: 'Under OpenSolaris, *menu.lst* is at */rpool/boot/grub/menu.lst*. Edit the xvm
    menu item to look something like the following:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 在 OpenSolaris 中，*menu.lst* 位于 */rpool/boot/grub/menu.lst*。编辑 xvm 菜单项，使其看起来像以下内容：
- en: '[PRE3]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Note that we're using extensions to GRUB that enable variables in *menu.lst*,
    such as `$ISADIR` (for Instruction Set Architecture). Apart from that, it's a
    fairly normal Xen GRUB config, with the hypervisor, kernel, and ramdisk.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，我们正在使用扩展 GRUB，它允许在 *menu.lst* 中使用变量，例如 `$ISADIR`（用于指令集架构）。除此之外，它是一个相当正常的
    Xen GRUB 配置，包括虚拟机管理程序、内核和 ramdisk。
- en: Reboot.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 重新启动。
- en: Solaris SMF
  id: totrans-51
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Solaris SMF
- en: When you begin to configure a Solaris dom0, you'll probably notice immediately
    that some files aren't quite where you expect. For one thing, Solaris doesn't
    have an */etc/xen* directory, nor does it have the customary scripts in */etc/init.d*.
    The various support scripts in */etc/xen/scripts* instead live in */usr/lib/xen/scripts*.
    You can keep domain configurations wherever you like. (We actually make an */etc/xen*
    directory and put domain configurations in it.)
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 当你开始配置 Solaris dom0 时，你可能会立即注意到一些文件并不完全在你预期的位置。首先，Solaris 没有名为 */etc/xen* 的目录，也没有在
    */etc/init.d* 中的常规脚本。各种支持脚本位于 */etc/xen/scripts* 中，而不是 */usr/lib/xen/scripts*。你可以将域配置放在你喜欢的任何位置。（我们实际上创建了一个
    */etc/xen* 目录并将域配置放在里面。）
- en: 'Instead of relying on the standard Xen config files, Solaris handles configuration
    and service startup via its own management framework, SMF (Service Management
    Facility). You can examine and change `xend` ''s settings using the `svccfg` command:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 与依赖标准的 Xen 配置文件不同，Solaris 通过其自身的管理框架 SMF（服务管理设施）来处理配置和服务启动。你可以使用 `svccfg` 命令检查和更改
    `xend` 的设置：
- en: '[PRE4]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'This will output a list of properties for the `xend` service. For example,
    to enable migration:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 这将输出 `xend` 服务的属性列表。例如，要启用迁移：
- en: '[PRE5]'
  id: totrans-56
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'You may have to enable the Xen-related services manually using `svcadm`, particularly
    if you initially booted the non-Xen kernel. To look at which services are stopped,
    use `svcs`:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能需要使用 `svcadm` 手动启用与 Xen 相关的服务，尤其是如果你最初启动的是非 Xen 内核。要查看哪些服务已停止，请使用 `svcs`：
- en: '[PRE6]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'If the Xen services are stopped for maintenance or disabled, you can enable
    them using `svcadm`:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 如果 Xen 服务因维护或禁用而停止，你可以使用 `svcadm` 启用它们：
- en: '[PRE7]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: From that point, you should be able to use Solaris as a perfectly normal dom0
    OS. It's even got libvirt. Have fun.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 从那个点开始，你应该能够将 Solaris 作为完全正常的 dom0 操作系统使用。它甚至有 libvirt。祝您玩得开心。
- en: Creating a Solaris DomU
  id: totrans-62
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 创建 Solaris DomU
- en: You didn't really think it would be that easy, did you? There are a couple of
    small caveats to note—things that make Xen under Solaris a slightly different
    animal than from under Linux. We'll start by creating a Solaris domU on a Solaris
    dom0, then extend our discussion to a Solaris domU on a Linux dom0.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 你真的以为这会那么简单吗？有几个小细节需要注意——这些细节使得在 Solaris 下运行的 Xen 与在 Linux 下有所不同。我们将从在 Solaris
    dom0 上创建一个 Solaris domU 开始，然后扩展我们的讨论到在 Linux dom0 上的 Solaris domU。
- en: ZFS Backing Devices
  id: totrans-64
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ZFS 后备设备
- en: First, we suggest handling virtual block devices a bit differently under Solaris.
    Although you can create domU filesystems as plain loopback-mounted files, ZFS
    is probably a better option. It's been praised far and wide, even winning some
    grudging accolades from Linus Torvalds. It is, in fact, ideal for this sort of
    thing, and the generally accepted way to manage disks under Solaris—even more
    so now that OpenSolaris uses a ZFS root filesystem.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们建议在 Solaris 下以不同的方式处理虚拟块设备。虽然你可以创建 domU 文件系统作为普通的循环回挂载文件，但 ZFS 可能是一个更好的选择。它受到了广泛的赞誉，甚至赢得了
    Linus Torvalds 一些不情愿的赞誉。实际上，它非常适合这类事情，并且是管理 Solaris 下磁盘的通常方法——尤其是在 OpenSolaris
    使用 ZFS 根文件系统之后。
- en: 'ZFS is pretty simple, at least to get started with. Users of LVM should find
    that creating a pool and filesystem are familiar tasks, even though the commands
    are slightly different. Here we''ll make a pool, create a ZFS filesystem within
    the pool, and set the size of the filesystem:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: ZFS 非常简单，至少开始时是这样的。LVM 的用户会发现创建池和文件系统是熟悉的任务，尽管命令略有不同。在这里，我们将创建一个池，在池内创建一个 ZFS
    文件系统，并设置文件系统的大小：
- en: '[PRE8]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Now we can define a domain that uses the `phy:` device */dev/zvol/dsk/guests/escalus*
    for its backing store, as shown in the config file.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们可以定义一个使用 `phy:` 设备 */dev/zvol/dsk/guests/escalus* 作为其后备存储的域，如配置文件所示。
- en: We'll leave further subtleties of ZFS administration to Sun's documentation.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将把 ZFS 管理的更细微之处留给 Sun 的文档。
- en: Installing a DomU via PyGRUB
  id: totrans-70
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 通过 PyGRUB 安装 DomU
- en: 'The last thing to do before creating the domU is to write an appropriate config
    file. Here''s ours:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建 domU 之前要做的最后一件事是编写适当的配置文件。这是我们的配置文件：
- en: '[PRE9]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Note that the disk specifier works differently than with Linux domUs. Rather
    than using symbolic device names, as under Linux:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，磁盘指定符与 Linux domUs 的工作方式不同。我们不是使用符号设备名称，就像在 Linux 下：
- en: '[PRE10]'
  id: totrans-74
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'we instead specify the disk number:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 我们不是指定磁盘号，而是：
- en: '[PRE11]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Here we're installing Solaris from an ISO image (*os200805.iso*) using PyGRUB
    to pull the correct kernel and initrd off the CD image, boot that, and proceed
    with a normal install.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们使用 PyGRUB 从 ISO 图像 (*os200805.iso*) 安装 Solaris，从 CD 图像中提取正确的内核和 initrd，引导它，然后进行正常安装。
- en: Note
  id: totrans-78
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*One thing to watch out for is that domU networking will only work if you''re
    using a GLD3-based network driver. The drivers that ship with Solaris are all
    fine in this regard—however, you may have trouble with third-party drivers*.'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: '*需要注意的一点是，domU 网络只有在您使用基于 GLD3 的网络驱动程序时才会工作。Solaris 中的驱动程序在这方面都没有问题——然而，您可能会遇到第三方驱动程序的问题*。'
- en: Once the install's done, we shut the machine down and remove the disk entry
    for the CD.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 安装完成后，我们关闭机器并移除 CD 的磁盘条目。
- en: At this point your Solaris domU should be ready to go. Setting up a Linux domU
    is equally straightforward, since standard Linux domU images and kernels should
    work unmodified under Solaris.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，您的 Solaris domU 应该已经准备好使用了。在 Linux 下创建 domU 同样简单直接，因为标准的 Linux domU 镜像和内核在
    Solaris 下无需修改即可工作。
- en: Next, we'll look at setting up a Solaris domU under Linux.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们将探讨在 Linux 下设置 Solaris domU。
- en: Creating a Solaris DomU Under Linux
  id: totrans-83
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在 Linux 下创建 Solaris DomU
- en: For the most part, a domU is independent of the dom0 OS, and thus the install
    under Linux uses much the same installation procedure as under Solaris. There
    are only a few pitfalls for the unwary.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 对于大多数情况，domU 与 dom0 操作系统是独立的，因此 Linux 下的安装过程与 Solaris 下的安装过程几乎相同。只有少数几个容易忽视的陷阱。
- en: First, you might have a bit more work to do to ensure that the domain can find
    an appropriate kernel. The Solaris image will complain bitterly, and in fact will
    not boot, with a Linux kernel.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，您可能需要做一些额外的工作来确保域可以找到适当的内核。Solaris 镜像会痛苦地抱怨，实际上不会使用 Linux 内核启动。
- en: If you're using PyGRUB on a Xen 3.1 or later system, you shouldn't need to do
    anything special. PyGRUB itself will load the appropriate files from OpenSolaris
    installation media without further intervention, just as in the previous example.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您在 Xen 3.1 或更高版本系统上使用 PyGRUB，您不需要做任何特殊操作。PyGRUB 本身将从 OpenSolaris 安装介质中加载适当的文件，无需进一步干预，就像上一个示例一样。
- en: If you're not using PyGRUB, or if you're using the stock RHEL5.1 hypervisor,
    you'll need to extract the kernel and miniroot (initrd, for Linux people) from
    the OpenSolaris install package and place them somewhere that Xen can load them.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您不使用 PyGRUB，或者您使用的是标准的 RHEL5.1 虚拟机管理程序，您需要从 OpenSolaris 安装包中提取内核和 miniroot（对于
    Linux 用户来说是 initrd）并将其放置在 Xen 可以加载它们的地方。
- en: '[PRE12]'
  id: totrans-88
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Just as under Solaris, begin by writing a config file. We'll set up this config
    file to load the installer from the CD, and later alter it to boot our newly installed
    domU. Note that we're grabbing the kernel from the ISO, using the kernel and ramdisk
    options to specify the files we need.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 就像在 Solaris 下一样，首先编写一个配置文件。我们将设置这个配置文件以从 CD 加载安装程序，稍后将其修改为引导新安装的 domU。请注意，我们正在从
    ISO 中获取内核，使用内核和 ramdisk 选项来指定我们需要的文件。
- en: '[PRE13]'
  id: totrans-90
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Make sure to create your backing store (*/dev/verona/rosaline* in this case).
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 确保创建您的后备存储（在这个例子中是 */dev/verona/rosaline*）。
- en: Now create the domain. Next step, installation.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 现在创建域。下一步，安装。
- en: Although OpenSolaris has a perfectly functional console when running as a domU,
    it unfortunately does not include a text mode installer. It does, however, include
    a VNC server and SSH server, either of which can be used to get a remote graphical
    display. Here's how to set up VNC.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管 OpenSolaris 作为 domU 运行时有一个功能齐全的控制台，但它不幸地不包括文本模式安装程序。然而，它确实包括一个 VNC 服务器和 SSH
    服务器，任一都可以用来获取远程图形显示。以下是设置 VNC 的方法。
- en: Log in at the domU console with username *jack* and password *jack*.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 使用用户名 *jack* 和密码 *jack* 登录到 domU 控制台。
- en: Once you're in locally, set up your network. (If you're using DHCP, it'll probably
    already be set up for you, but it doesn't hurt to make sure.)
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦您本地登录，设置您的网络。（如果您使用 DHCP，它可能已经为您设置好了，但确保这一点并无害处。）
- en: '[PRE14]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'You can see that our network is in fine shape, with the address 192.168.2.128\.
    If it''s not set up already, assign an address manually:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以看到，我们的网络状况良好，地址为 192.168.2.128。如果尚未设置，请手动分配地址：
- en: '[PRE15]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'The VNC server should already be running. To enable remote access to it, run
    the `vncpasswd` command:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: VNC 服务器应该已经运行。要启用对它的远程访问，运行 `vncpasswd` 命令：
- en: '[PRE16]'
  id: totrans-100
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: '`vncpasswd` will ask you to make up a password and enter it twice. Use this
    password to connect to the VNC server using your favorite VNC client. You should
    be greeted with an OpenSolaris desktop.'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: '`vncpasswd`将要求您创建一个密码并输入两次。使用此密码通过您喜欢的VNC客户端连接到VNC服务器。您应该会看到一个OpenSolaris桌面。'
- en: Finally, click the **Install OpenSolaris** icon on the desktop and proceed with
    the graphical install.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，点击桌面上的**安装OpenSolaris**图标，继续图形安装。
- en: OpenSolaris DomU Postinstall Configuration
  id: totrans-103
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: OpenSolaris DomU安装后配置
- en: 'Once the installer has done its work, you''ll be ready to shut down the domain
    and move to the next step: setting up the dom0 to load a kernel from a ZFS filesystem.'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦安装程序完成其工作，您就可以关闭域并进入下一步：设置dom0以从ZFS文件系统加载内核。
- en: The problem is that in Xen 3.3, PyGRUB's version of `libfsimage` isn't able
    to handle recent versions of ZFS directly. Our solution was to download the Xen-unstable
    source tree (as of this writing, Xen 3.4-rc) from [http://xenbits.xen.org/](http://xenbits.xen.org/)
    and build PyGRUB from that. (Alternatively, you can mount the install media, extract
    the kernel and microroot, specify these manually in the config file, and pass
    the correct "extra" line to the kernel—that works just as well.)
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 问题在于在Xen 3.3中，PyGRUB的`libfsimage`版本无法直接处理ZFS的最新版本。我们的解决方案是从[http://xenbits.xen.org/](http://xenbits.xen.org/)下载Xen不稳定源代码树（截至本文写作时，Xen
    3.4-rc）并从中构建PyGRUB。（或者，您可以挂载安装介质，提取内核和microroot，在配置文件中手动指定这些内容，并将正确的“extra”行传递给内核——这也同样有效。）
- en: '[PRE17]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Now we update the domain config file. Since we went to all the trouble of updating
    PyGRUB, we''ll use it directly here:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们更新域配置文件。由于我们费尽周折更新了PyGRUB，我们在这里直接使用它：
- en: '[PRE18]'
  id: totrans-108
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Note
  id: totrans-109
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*PV-GRUB, at this time, isn''t able to load an OpenSolaris kernel properly.
    Use PyGRUB instead*.'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: '*PV-GRUB，目前，无法正确加载OpenSolaris内核。请使用PyGRUB代替*。'
- en: 'Start your new domain as usual with `xm`:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`xm`启动您的新的域：
- en: '[PRE19]'
  id: totrans-112
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: '* * *'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[45](#CHP-8-FNOTE-1)]) We tend to use the terms *Zone* and *Container* interchangeably.
    Technically, a Solaris Container implements system resource controls on top of
    Zones.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[45](#CHP-8-FNOTE-1)]) 我们倾向于将*Zone*和*Container*互换使用。技术上讲，Solaris Container在Zones之上实现了系统资源控制。
- en: ^([[46](#CHP-8-FNOTE-2)]) The CDDL is a free software license that's GPL-incompatible
    but generally inoffensive.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[46](#CHP-8-FNOTE-2)]) CDDL是一个与GPL不兼容的自由软件许可证，但通常是无害的。
- en: '^([[47](#CHP-8-FNOTE-3)]) That''s another reason we gloss over Solaris Express:
    Focusing on it would not, in the words of Douglas Adams, "make for nice fat books
    such as the American market thrives on."'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[47](#CHP-8-FNOTE-3)]) 这也是我们忽略Solaris Express的另一个原因：专注于它并不会，用道格拉斯·亚当斯的话说，“产生像美国市场那样繁荣的厚重的书籍。”
- en: ^([[48](#CHP-8-FNOTE-4)]) The temptation exists to write "elegant minimum,"
    but it's simply not so.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[48](#CHP-8-FNOTE-4)]) 写出“优雅的最小化”的诱惑存在，但这只是不切实际的。
- en: '^([[49](#CHP-8-FNOTE-5)]) Anyone planning to take offense to the comparison
    of `pfexec` and `sudo`: Please assume that we have been utterly convinced by your
    rhetoric and carry on with your day-to-day life.'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[49](#CHP-8-FNOTE-5)]) 任何计划对`pfexec`和`sudo`的比较表示不满的人：请假设我们已经完全被您的论点说服，继续您日常的生活。
- en: NetBSD
  id: totrans-119
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: NetBSD
- en: NetBSD is a popular choice for a dom0 OS because of its small and versatile
    design, which is a good match for the *dedicated virtualization server* model
    that Xen encourages. In our experience, a dom0 running NetBSD will use less memory
    and be at least as stable as one running Linux.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: NetBSD由于其小巧和灵活的设计而成为dom0操作系统的热门选择，这与Xen鼓励的*专用虚拟化服务器*模式相匹配。根据我们的经验，运行NetBSD的dom0将使用更少的内存，并且至少与运行Linux的dom0一样稳定。
- en: However, Linux people often make the mistake of assuming that NetBSD is exactly
    like Linux. It's not—it's kind of close, but NetBSD is the product of an evolution
    as long as Linux's, and it requires some practice to work with. In this section,
    we're going to assume that you're familiar with NetBSD's idiosyncrasies; we're
    only going to cover the Xen-related differences.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，Linux用户常常犯下这样的错误，认为NetBSD与Linux完全相同。事实并非如此——它有点相似，但NetBSD是一个与Linux一样漫长的进化产物，并且需要一些实践才能使用。在本节中，我们假设您熟悉NetBSD的怪癖；我们只将涵盖与Xen相关的差异。
- en: NetBSD's Historical Xen Support
  id: totrans-122
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: NetBSD的历史Xen支持
- en: NetBSD has supported Xen for a very long time—since NetBSD version 3.0, which
    incorporated support for Xen2 as dom0 and as a domU. This Xen2 support is quite
    stable. However, it has the obvious drawback of being Xen2, which lacks the Xen3
    features like live migration and HVM. It's also 32 bit only, and doesn't support
    PAE (Physical Address Extension). (We've used this version quite a bit. The first
    Xen setup we used for hosting at prgmr.com was a dual Xeon running NetBSD 3.1
    and Xen2, supporting Linux and NetBSD domUs.) NetBSD 3.1 introduced support for
    Xen 3.0.*x*—but only as a domU.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: NetBSD 很早就支持 Xen 了——从 NetBSD 版本 3.0 开始，该版本集成了对 Xen2 作为 dom0 和 domU 的支持。这种 Xen2
    支持相当稳定。然而，它有一个明显的缺点，那就是它是 Xen2，缺乏 Xen3 的特性，如实时迁移和 HVM。它也仅支持 32 位，不支持 PAE（物理地址扩展）。（我们相当多地使用了这个版本。我们最初在
    prgmr.com 提供托管服务时使用的第一个 Xen 设置是一个双 Xeon 运行 NetBSD 3.1 和 Xen2，支持 Linux 和 NetBSD
    domUs。）NetBSD 3.1 引入了对 Xen 3.0.*x* 的支持——但仅作为 domU。
- en: NetBSD 4.0 added Xen 3.1 support as both a domU and a dom0, and it also introduced
    support for HVM. The only remaining problem with NetBSD 4.0 was that it, like
    its predecessors, it did not support PAE or x86_64, which means that it was unable
    to use more than 4GB of memory. It also could not run as a domU on a 64-bit or
    PAE system, such as is used by Amazon's EC2\. That last bit was the real killer—it
    meant NetBSD 4 required a non-PAE 32-bit hypervisor, which in turn limited you
    to 4GB of address space, which translates about 3.5GB of physical memory. (This
    limitation is so significant that Xen.org doesn't even distribute a non-PAE binary
    package anymore.)
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: NetBSD 4.0 添加了对 Xen 3.1 的支持，既可以作为 domU 也可以作为 dom0，并且还引入了对 HVM 的支持。NetBSD 4.0
    剩下的唯一问题是，像其前辈一样，它不支持 PAE 或 x86_64，这意味着它无法使用超过 4GB 的内存。它也无法在 64 位或 PAE 系统上作为 domU
    运行，例如亚马逊的 EC2 所使用的系统。最后这一点才是真正的杀手——这意味着 NetBSD 4 需要一个非 PAE 的 32 位虚拟机管理程序，这反过来又限制了您只能有
    4GB 的地址空间，这大约相当于 3.5GB 的物理内存。（这个限制如此显著，以至于 Xen.org 甚至不再分发非 PAE 的二进制软件包。）
- en: Finally, the new and shiny NetBSD 5 adds PAE support for NetBSD domUs, x86-64
    support for both dom0 and domUs, and support for 32-bit domUs on 64-bit dom0s
    (*32-on-64* in Xen parlance). Work is still being done to add features to bring
    NetBSD Xen support into feature parity with Linux's Xen support, but NetBSD is
    already a perfectly viable platform.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，全新的 NetBSD 5 为 NetBSD domUs 添加了 PAE 支持，为 dom0 和 domUs 添加了 x86-64 支持，并在 64
    位 dom0 上支持 32 位 domUs（在 Xen 术语中称为 *32-on-64*）。仍在努力添加功能，以使 NetBSD Xen 支持与 Linux
    的 Xen 支持功能对等，但 NetBSD 已经是一个完全可行的平台。
- en: Installing NetBSD as a Dom0
  id: totrans-126
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 将 NetBSD 作为 Dom0 安装
- en: 'The basic steps to get started using NetBSD with Xen are pretty much the same
    as for any other OS: Download it, install it, and make it work. Again, we''re
    assuming that you''re familiar with the basic NetBSD install procedure, so we''re
    just going to outline these directions briefly.'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 Xen 开始使用 NetBSD 的基本步骤与任何其他操作系统几乎相同：下载它，安装它，并让它工作。再次强调，我们假设您熟悉基本的 NetBSD 安装程序，所以我们只是简要概述这些说明。
- en: Begin by downloading NetBSD and installing it as usual. (We opted to download
    and burn the ISO at [http://mirror.planetunix.net/pub/NetBSD/iso/5.0/amd64cd-5.0.iso](http://mirror.planetunix.net/pub/NetBSD/iso/5.0/amd64cd-5.0.iso).)
    Configure the system according to your preference.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 首先下载 NetBSD 并像往常一样安装它。（我们选择从 [http://mirror.planetunix.net/pub/NetBSD/iso/5.0/amd64cd-5.0.iso](http://mirror.planetunix.net/pub/NetBSD/iso/5.0/amd64cd-5.0.iso)
    下载并烧录 ISO。）根据您的偏好配置系统。
- en: Note
  id: totrans-129
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: ftp:// *and* http:// *are interchangeable on all of the* [ftp.netbsd.org](http://ftp.netbsd.org)
    *URLs*. http:// *gets through firewalls better, and* ftp:// *is slightly faster.
    Pick one. Also, you often get significantly better speeds using a mirror rather
    than the netbsd.org site. If your FTP install fails partway through, the first
    thing to do is to try another mirror*.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: ftp:// *和* http:// *在所有 [ftp.netbsd.org](http://ftp.netbsd.org) *URLs* 上是可互换的。http://
    *通过防火墙更好，而* ftp:// *稍微快一点。选择一个。此外，使用镜像而不是 netbsd.org 网站通常会获得显著更好的速度。如果您的 FTP 安装在中间失败，首先要尝试另一个镜像*。
- en: 'However you install NetBSD, go through the installer and reboot into your new
    system. Next, install the Xen kernel and supporting tools using the NetBSD ports
    system, `pkgsrc`. Get `pkgsrc` at [http://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc.tar.gz](http://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc.tar.gz).
    Untar *pkgsrc.tar.gz*, then install Xen:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 无论您如何安装 NetBSD，都要通过安装程序并重新启动到您的新系统。接下来，使用 NetBSD 的端口系统 `pkgsrc` 安装 Xen 内核和相关工具。从
    [http://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc.tar.gz](http://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc.tar.gz)
    获取 `pkgsrc`。解压 *pkgsrc.tar.gz*，然后安装 Xen：
- en: '[PRE20]'
  id: totrans-132
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'After installing the Xen tools, NetBSD will remind you to create the Xen device
    nodes:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 安装Xen工具后，NetBSD会提醒您创建Xen设备节点：
- en: '[PRE21]'
  id: totrans-134
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Now that Xen is installed, our next task is to install GRUB in place of the
    standard NetBSD bootloader so that we can perform the multistage boot that Xen
    requires:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 现在Xen已经安装，我们的下一个任务是安装GRUB以替换标准NetBSD引导加载程序，以便我们可以执行Xen所需的分阶段引导：
- en: '[PRE22]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Our next step is to download and install NetBSD Xen kernels—we're already running
    off standard NetBSD kernels, and we've got the hypervisor installed, but we still
    need kernels for the dom0 and domUs. Download *netbsd-XEN3_DOM0.gz*, *netbsd-XEN3_DOMU.gz*,
    and *netbsd-INSTALL_XEN3_DOMU.gz* from your favorite NetBSD mirror. (We used [http://mirror.planetunix.net/pub/NetBSD/NetBSD-5.0/](http://mirror.planetunix.net/pub/NetBSD/NetBSD-5.0/).)
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 我们下一步是下载和安装NetBSD Xen内核——我们已经在标准NetBSD内核上运行，并且已经安装了虚拟机管理程序，但我们仍然需要dom0和domUs的内核。从您最喜欢的NetBSD镜像下载
    *netbsd-XEN3_DOM0.gz*，*netbsd-XEN3_DOMU.gz* 和 *netbsd-INSTALL_XEN3_DOMU.gz*。（我们使用了[http://mirror.planetunix.net/pub/NetBSD/NetBSD-5.0/](http://mirror.planetunix.net/pub/NetBSD/NetBSD-5.0/)。）
- en: 'Now that we have suitable Xen kernels to go with the hypervisor and supporting
    tools that we installed in the previous step, we can set up GRUB in the usual
    way:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经有了适合与我们在上一步中安装的虚拟机管理程序和辅助工具配合使用的Xen内核，我们可以像往常一样设置GRUB：
- en: '[PRE23]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'Edit */grub/menu.lst* so that it boots the Xen kernel and loads NetBSD as a
    module. Here''s a complete file, with comments (adapted from a NetBSD example
    at [http://www.netbsd.org/ports/xen/howto.html](http://www.netbsd.org/ports/xen/howto.html)):'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 编辑 */grub/menu.lst*，使其引导Xen内核并将NetBSD作为模块加载。以下是一个完整的文件，包含注释（改编自NetBSD示例[http://www.netbsd.org/ports/xen/howto.html](http://www.netbsd.org/ports/xen/howto.html)）：
- en: '[PRE24]'
  id: totrans-141
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: The important bits are the kernel name, `XEN3_DOM0`, and the root device, which
    we specify using NetBSD syntax.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 重要的部分是内核名称，`XEN3_DOM0`，以及我们使用NetBSD语法指定的根设备。
- en: Note
  id: totrans-143
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*We''ve also set up this config file to use the serial console. No matter which
    operating system you use, we strongly recommend using a serial console with Xen,
    even if you prefer to use a KVM or other method of remote management normally.
    See [Chapter 14](ch14.html "Chapter 14. TIPS") for more discussion of the many
    and varied uses of the serial console*.'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: '*我们也设置了此配置文件以使用串行控制台。无论您使用哪种操作系统，我们都强烈建议在Xen中使用串行控制台，即使您通常更喜欢使用KVM或其他远程管理方法。有关串行控制台多种多样用途的更多讨论，请参阅[第14章](ch14.html
    "第14章。技巧")*。'
- en: 'Copy over the basic Xen config files to the directory where the Xen tools will
    expect to find them:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 将基本的Xen配置文件复制到Xen工具期望找到它们的目录中：
- en: '[PRE25]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: Now that we have all the parts of a NetBSD dom0, we need to start `xenbackendd`
    and `xend` (in that order, or it won't work).
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经拥有了NetBSD dom0的所有部分，我们需要启动 `xenbackendd` 和 `xend`（按此顺序，否则将无法工作）。
- en: '[PRE26]'
  id: totrans-148
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Finally, to get networking to work, create */etc/ifconfig.bridge0* with these
    contents:'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，为了使网络工作，创建 */etc/ifconfig.bridge0* 并包含以下内容：
- en: '[PRE27]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'At this point you''re most likely done. Reboot to test, or start the Xen services
    manually:'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，您可能已经完成了。重新启动以测试，或手动启动Xen服务：
- en: '[PRE28]'
  id: totrans-152
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'You should now be able to run `xm list`:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 您现在应该能够运行 `xm list`：
- en: '[PRE29]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: Installing NetBSD as a DomU
  id: totrans-155
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 安装NetBSD作为DomU
- en: Installing NetBSD as a domU is easy, even with a Linux dom0\. In fact, because
    NetBSD's INSTALL kernels include a ramdisk with everything necessary to complete
    the installation, we can even do it without modifying the configuration from the
    dom0, given a sufficiently versatile PyGRUB or PV-GRUB setup.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 即使在Linux dom0上，安装NetBSD作为domU也很简单。事实上，由于NetBSD的INSTALL内核包含一个ramdisk，其中包含完成安装所需的一切，因此，只要PyGRUB或PV-GRUB设置足够灵活，我们甚至可以在不修改dom0配置的情况下完成安装。
- en: For this discussion, we assume that you've got a domU of some sort already set
    up—perhaps one of the generic prgmr.com Linux domains. In this domU, you'll need
    to have a small boot partition that GRUB^([[50](#ftn.CHP-8-FNOTE-6)]) can read.
    This is where we'll store the kernel and GRUB configuration.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这次讨论，我们假设您已经设置了一个某种类型的domU——可能是prgmr.com Linux域的通用域之一。在这个domU中，您需要一个小的引导分区，以便GRUB^([[50](#ftn.CHP-8-FNOTE-6)])可以读取。这就是我们将存储内核和GRUB配置的地方。
- en: 'First, from within your domain, download the NetBSD kernels:'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，在您的域内，下载NetBSD内核：
- en: '[PRE30]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: Then, edit the domain's GRUB menu (most likely at */boot/grub/menu.lst*) to
    load the INSTALL kernel on next reboot. (On the reboot after that, when the installation's
    done, you'll select the NetBSD run option.)
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，编辑域的GRUB菜单（最可能是 */boot/grub/menu.lst*），以便在下次重新启动时加载INSTALL内核。（在那次重新启动之后，当安装完成时，您将选择NetBSD运行选项。）
- en: '[PRE31]'
  id: totrans-161
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: Reboot, selecting the **NetBSD install** option.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 重新启动，选择**NetBSD安装**选项。
- en: As if by magic, your domain will begin running the NetBSD installer, until you
    end up in a totally ordinary NetBSD install session. Go through the steps of the
    NetBSD FTP install. There's some very nice documentation at [http://netbsd.org/docs/guide/en/chap-exinst.html](http://netbsd.org/docs/guide/en/chap-exinst.html).
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 就像魔法一样，你的域将开始运行 NetBSD 安装程序，直到你进入一个完全普通的 NetBSD 安装会话。按照 NetBSD FTP 安装的步骤进行。在
    [http://netbsd.org/docs/guide/en/chap-exinst.html](http://netbsd.org/docs/guide/en/chap-exinst.html)
    有一些非常好的文档。
- en: Note
  id: totrans-164
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*At this point you have to be careful not to overwrite your boot device. For
    example, prgmr.com gives you only a single physical block device, from which you''ll
    need to carve a* /boot *partition in addition to the normal filesystem layout*.'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: '*在这个阶段，你必须小心不要覆盖你的引导设备。例如，prgmr.com 只给你一个物理块设备，你需要从这个设备中划分出一个* /boot *分区，除了正常的文件系统布局之外*。'
- en: 'The only sticky point is that you have to be careful to set up a boot device
    that PyGRUB can read, in the place where PyGRUB expects it. (If you have multiple
    physical devices, PyGRUB will try to boot from the first one.) Since we''re installing
    within the standard prgmr.com domU setup, we only have a single physical block
    device to work with, which we''ll carve into separate */boot* and */* partitions.
    Our disklabel, with a *32 MB FFS /boot* partition, looks like this:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 唯一需要注意的是，你必须小心设置一个 PyGRUB 可以读取的引导设备，在 PyGRUB 期望的位置。（如果你有多个物理设备，PyGRUB 将尝试从第一个设备启动。）由于我们是在标准的
    prgmr.com domU 设置中安装，我们只有一个物理块设备可以操作，我们将将其划分为单独的 */boot* 和 */* 分区。我们的 disklabel，包含一个
    *32 MB FFS /boot* 分区，看起来是这样的：
- en: '[PRE32]'
  id: totrans-167
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: Once the install's done, reboot. Select the regular kernel in PyGRUB, and your
    domU should be ready to go.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 安装完成后，重新启动。在 PyGRUB 中选择常规内核，你的 domU 应该就可以使用了。
- en: 'After NetBSD''s booted, if you want to change the bootloader configuration,
    you can mount the *ext2* partition thus:'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 在 NetBSD 启动后，如果你想更改引导加载程序配置，你可以这样挂载 *ext2* 分区：
- en: '[PRE33]'
  id: totrans-170
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: This will allow you upgrade the domU kernel. Just remember that, whenever you
    want to upgrade the kernel, you need to mount the partition that PyGRUB loads
    the kernel from and make sure to update that kernel and *menu.lst*. It would also
    be a good idea to install the NetBSD kernel in the usual place, in the root of
    the domU filesystem, but it isn't strictly necessary.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 这将允许你升级 domU 内核。只需记住，每次你想升级内核时，你需要挂载 PyGRUB 加载内核的分区，并确保更新那个内核和 *menu.lst*。将
    NetBSD 内核安装到 domU 文件系统的根目录中也是一个好主意，但这并不是严格必要的。
- en: And there you have it—a complete, fully functional NetBSD domU, without any
    intervention from the dom0 at all. (If you have dom0 access, you can specify the
    install kernel on the `kernel=` line of the domain config file in the usual way—but
    what would be the fun of that?)
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 就这样，你就有了一个完整、完全功能的 NetBSD domU，没有任何 dom0 的干预。（如果你有 dom0 访问权限，你可以像往常一样在域配置文件的
    `kernel=` 行上指定安装内核——但那样有什么乐趣呢？）
- en: '* * *'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[50](#CHP-8-FNOTE-6)]) More accurately, of course, your GRUB simulator. If
    this is PyGRUB, it relies on `libfsimage`.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[50](#CHP-8-FNOTE-6)]) 当然，更准确地说，是你的 GRUB 模拟器。如果是 PyGRUB，它依赖于 `libfsimage`。
- en: 'Beyond Paravirtualization: HVM'
  id: totrans-175
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 超越Para虚拟化：HVM
- en: In this chapter, we have outlined the general steps necessary to use Solaris
    and NetBSD as both dom0 and domU operating systems. This isn't meant to exhaustively
    list the operating systems that work with Xen—in particular, we haven't mentioned
    Plan9 or FreeBSD at all—but it does give you a good idea of the sort of differences
    that you might encounter and easy recipes for using at least two systems other
    than Linux.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们概述了使用 Solaris 和 NetBSD 作为 dom0 和 domU 操作系统的必要步骤。这并不是要详尽无遗地列出与 Xen 兼容的操作系统——特别是，我们完全没有提到
    Plan9 或 FreeBSD——但它确实给你一个很好的概念，你可能遇到的不同类型以及至少使用两个系统（除了 Linux 之外）的简单方法。
- en: 'Furthermore, they each have their own advantages: NetBSD is a very lightweight
    operating system, much better than Linux at handling low-memory conditions. This
    comes in handy with Xen. Solaris isn''t as light, but it is extremely robust and
    has interesting technologies, such as ZFS. Both of these OSs can support any OS
    as domU, as long as it''s been modified to work with Xen. That''s virtualization
    in action, if you like.'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，它们各自都有它们的优势：NetBSD 是一个非常轻量级的操作系统，在处理低内存条件方面比 Linux 更好。这对于 Xen 来说非常有用。Solaris
    不那么轻量，但它非常健壮，并且拥有有趣的技术，如 ZFS。这两个操作系统都可以支持任何操作系统作为 domU，只要它已经被修改为与 Xen 兼容。如果你喜欢，这就是虚拟化的实际应用。
- en: Note
  id: totrans-178
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: '*The new Linux paravirt_ops functionality that is included in the kernel.org
    kernels requires Xen hypervisor version 3.3 or later, so it works with NetBSD
    but not OpenSolaris*.'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: '*包含在kernel.org内核中的新Linux paravirt_ops功能需要Xen虚拟机管理程序版本3.3或更高版本，因此它与NetBSD兼容，但不与OpenSolaris兼容*。'
- en: 'Finally, the addition of hardware virtualization extensions to recent processors
    means that virtually any OS can be used as a domU, even if it hasn''t been modified
    specifically to work with Xen. We discuss Xen''s support for these extensions
    in [Chapter 12](ch12.html "Chapter 12. HVM: BEYOND PARAVIRTUALIZATION") and then
    describe using HVM to run Windows under Xen in [Chapter 13](ch13.html "Chapter 13. XEN
    AND WINDOWS"). Stay tuned.'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，最近处理器中硬件虚拟化扩展的添加意味着几乎任何操作系统都可以用作domU，即使它没有专门修改过以与Xen一起工作。我们在[第12章](ch12.html
    "第12章。HVM：超越Para虚拟化")中讨论了Xen对这些扩展的支持，然后在[第13章](ch13.html "第13章。XEN和Windows")中描述了如何使用HVM在Xen下运行Windows。敬请关注。
