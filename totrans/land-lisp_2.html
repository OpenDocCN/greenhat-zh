<html><head></head><body><div class="part" title="Part&#xA0;II.&#xA0;Lisp is Symmetry"><div class="titlepage"><div><div><h1 class="title"><a id="lisp_is_symmetry"/>Part II. Lisp is Symmetry</h1></div></div></div><div class="partintro" title="Lisp is Symmetry" id="id2817829"><div/><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject_d1e3401"/><img src="httpatomoreillycomsourcenostarchimages782344.png.jpg" alt="image with no caption"/></div></div></div></div>
<div class="chapter" title="Chapter&#xA0;4.&#xA0;Making Decisions with Conditions"><div class="titlepage"><div><div><h1 class="title"><a id="making_decisions_with_conditions"/>Chapter 4. Making Decisions with Conditions</h1></div></div></div><p>In the previous chapters, you learned some basic Lisp commands, as well as some of the philosophy behind Lisp. In this chapter, we’ll be looking in detail at commands for handling conditions. The elegance of these commands shows that the unusual philosophy and design of Lisp has real practical benefits.<a id="IDX-CHP-4-0001" class="indexterm"/><a id="IDX-CHP-4-0002" class="indexterm"/><a id="IDX-CHP-4-0003" class="indexterm"/><a id="IDX-CHP-4-0004" class="indexterm"/><a id="IDX-CHP-4-0005" class="indexterm"/></p><div class="sect1" title="The Symmetry of nil and ()"><div class="titlepage"><div><div><h1 class="title"><a id="the_symmetry_of_nil_and_open_parenthesis"/>The Symmetry of nil and ()</h1></div></div></div><p>One thing is particularly striking when we look at how Lisp commands and data structures work: They are imbued with symmetry in every conceivable way. This symmetry can give your Lisp code a certain elegance that other languages cannot have, and Lisp’s simple syntax is an important factor in making this symmetry possible.</p><div class="sect2" title="Empty Equals False"><div class="titlepage"><div><div><h2 class="title"><a id="empty_equals_false"/>Empty Equals False</h2></div></div></div><p>Since the Lisp philosophy strongly emphasizes the use of lists to store and manipulate information, it will come as no surprise that the design of Common Lisp favors behaviors that make it easy to slice and dice such lists. The most profound design decision made in Common Lisp, with regard to lists, is that it automatically treats an empty list as a false value when evaluating a condition:<a id="IDX-CHP-4-0006" class="indexterm"/><a id="IDX-CHP-4-0007" class="indexterm"/><a id="IDX-CHP-4-0008" class="indexterm"/><a id="IDX-CHP-4-0009" class="indexterm"/></p><a id="I_programlisting1_d1e3466"/><pre class="programlisting">&gt; <strong class="userinput"><code>(if '()</code></strong>
      <strong class="userinput"><code>'i-am-true</code></strong>
      <strong class="userinput"><code>'i-am-false)</code></strong>

I-AM-FALSE

&gt; <strong class="userinput"><code>(if '(1)</code></strong>
      <strong class="userinput"><code>'i-am-true</code></strong>
      <strong class="userinput"><code>'i-am-false)</code></strong>

I-AM-TRUE</pre><p>This example shows that when we pass the empty list <code class="literal">()</code> into an <code class="literal">if</code> form, it evaluates as a false value, whereas a list that contains an item evaluates as true.</p><p>Because we can easily detect an empty list, we can process lists using <span class="emphasis"><em>recursion</em></span>. With this technique, we can take items from the front of a list and send the rest of the list back to the same function until the list is empty. (It’s a good thing that detecting empty lists is so easy, because so many functions in Lisp end up being list-eaters.)<a id="IDX-CHP-4-0010" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e3504"/><img src="httpatomoreillycomsourcenostarchimages782394.png" alt="image with no caption"/></div></div><p>Let’s look at a common list-eating function, which calculates the length of a list.<a id="IDX-CHP-4-0011" class="indexterm"/><a id="IDX-CHP-4-0012" class="indexterm"/><a id="IDX-CHP-4-0013" class="indexterm"/></p><a id="I_programlisting1_d1e3528"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun my-length (list)</code></strong>
     <strong class="userinput"><code>(if list</code></strong>
         <strong class="userinput"><code>(1+ (my-length (cdr list)))</code></strong>
         <strong class="userinput"><code>0))</code></strong>

&gt; <strong class="userinput"><code>(my-length '(list with four symbols))</code></strong>

4</pre><p>This function is written in classic Lisp style. It calls itself recursively as it chomps items off the front of the list. Calling yourself in this way is not only allowed in Lisp, but is often strongly encouraged. Lists in Lisp are recursive (conses of conses of conses . . .), so the act of consuming a list maps naturally onto functions that are recursive.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Calling yourself recursively can sometimes make for slow code. In <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>, we’ll rewrite the <code class="literal">my-length</code> function using a special, potentially faster, type of recursion.</p></div></div><div class="sect2" title="The Four Disguises of ()"><div class="titlepage"><div><div><h2 class="title"><a id="the_four_disguises_of_open_parenthesis_c"/>The Four Disguises of ()</h2></div></div></div><p>Not only does the empty list evaluate to false, but it is the <span class="emphasis"><em>only</em></span> false value in Common Lisp. <span class="emphasis"><em>Any value not equivalent to an empty list will be considered a true</em></span> value. This explains why the expression <code class="literal">'(1)</code> in the earlier example was treated as true. However, there are some other expressions in Lisp that are disguises for the one and only empty list:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e3570"/><img src="httpatomoreillycomsourcenostarchimages782038.png" alt="image with no caption"/></div></div><p>We can see that the expressions in this table are equivalent by comparing them with one another:</p><a id="I_programlisting1_d1e3577"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (eq '() nil)  ==&gt; T
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> (eq '() ())   ==&gt; T
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> (eq '() 'nil) ==&gt; T</pre><p>Notice that the only value in the table that seems normal is the quoted list on the left side of the comparisons. The other three all seem to break the rules of Lisp forms that we talked about in the previous chapter.<a id="IDX-CHP-4-0014" class="indexterm"/></p><p>The first two examples are particularly puzzling. They are missing the quotation mark that tells the Lisp environment, “Hey, this item is a piece of data, not code!” In the case of <code class="literal">nil</code>, you would expect that this would actually be the name of a variable that could have some kind of arbitrary value. In the case of the unquoted <code class="literal">()</code>, there’s no way you could tell what would happen. The parentheses look like a form of code that needs to be evaluated, but a Lisp form always has a symbol at the beginning, telling it what to do. What do we do when there’s nothing inside the form at all?<a id="IDX-CHP-4-0015" class="indexterm"/></p><p>The bottom line is that Common Lisp is architected behind the scenes to make sure all four of these values look like an empty list when you use them in your program, allowing most Lisp conditionals to be written with an elegant brevity. For instance, there is a constant named <code class="literal">nil</code> that evaluates to itself and allows you to omit the quotation mark in the first case <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e3617"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. The second case <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e3623"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> is a natural by-product of how Common Lisp parses an empty form. The third case <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e3629"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> is due to a requirement in the Common Lisp spec that says that <code class="literal">()</code> and <code class="literal">nil</code> should be treated the same.</p><p>Although there’s a certain beauty to having all of these values be the same, not every Lisper agrees with this sentiment. After all, are false and empty list really the same kind of thing? The creators of the other popular dialect of Lisp, Scheme, felt differently about this issue, and preferred to keep the concepts of falsity and empty list completely separate, at a slight cost to code brevity.</p></div></div></div>
<div class="sect1" title="The Conditionals: if and Beyond"><div class="titlepage"><div><div><h1 class="title"><a id="the_conditionals_colon_if_and_beyond"/>The Conditionals: if and Beyond</h1></div></div></div><p>Now that you understand how Lisp handles true and false, let’s look at <code class="literal">if</code> and some of the other conditional commands.</p><div class="sect2" title="One Thing at a Time with if"><div class="titlepage"><div><div><h2 class="title"><a id="one_thing_at_a_time_with_if"/>One Thing at a Time with if</h2></div></div></div><p>The <code class="literal">if</code> command can be used to make different things happen when things are true (such as when 1 + 2 = 3) or false (such as when 1 + 2 = 4).</p><a id="I_programlisting1_d1e3660"/><pre class="programlisting">&gt; <strong class="userinput"><code>(if (= (+ 1 2) 3)</code></strong>
      <strong class="userinput"><code>'yup</code></strong>
      <strong class="userinput"><code>'nope)</code></strong>

YUP

&gt; <strong class="userinput"><code>(if (= (+ 1 2) 4)</code></strong>
      <strong class="userinput"><code>'yup</code></strong>
      <strong class="userinput"><code>'nope)</code></strong>

NOPE</pre><p>The <code class="literal">if</code> command can also be used to check whether a list is empty:<a id="IDX-CHP-4-0016" class="indexterm"/><a id="IDX-CHP-4-0017" class="indexterm"/></p><a id="I_programlisting1_d1e3694"/><pre class="programlisting">&gt; <strong class="userinput"><code>(if '(1)</code></strong>
      <strong class="userinput"><code>'the-list-has-stuff-in-it</code></strong>
      <strong class="userinput"><code>'the-list-is-empty)</code></strong>

THE-LIST-HAS-STUFF-IN-IT

&gt; <strong class="userinput"><code>(if '()</code></strong>
      <strong class="userinput"><code>'the-list-has-stuff-in-it</code></strong>
      <strong class="userinput"><code>'the-list-is-empty)</code></strong>

THE-LIST-IS-EMPTY</pre><p>So far, the only way to branch on a condition that we’ve looked at has been the <code class="literal">if</code> command:</p><a id="I_programlisting1_d1e3720"/><pre class="programlisting">&gt; <strong class="userinput"><code>(if (oddp 5)</code></strong>
      <strong class="userinput"><code>'odd-number</code></strong>
      <strong class="userinput"><code>'even-number)</code></strong>

ODD-NUMBER</pre><p>All we’re doing here is checking whether the number 5 is odd, then, depending on the result, evaluating one of the two following expressions in the if form. Since 5 is odd, it evaluates the first such expression, and the form as a whole returns <code class="literal">odd-number</code>.</p><p>There’s a lot happening in this harmless-looking little command—stuff that’s important to understanding Lisp. Here are two important observations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Only one of the expressions after the <code class="literal">if</code> is actually evaluated.</p></li><li class="listitem"><p>We can only do one thing in an <code class="literal">if</code> statement.</p></li></ul></div><p>Usually, when a function is executed in Lisp, all the expressions after the function name are evaluated, before the function itself is evaluated. However, <code class="literal">if</code> does not follow these rules. To see this, consider the following example:</p><a id="I_programlisting1_d1e3757"/><pre class="programlisting">&gt; <strong class="userinput"><code>(if (oddp 5)</code></strong>
    <strong class="userinput"><code>'odd-number</code></strong>
    <strong class="userinput"><code>(/ 1 0))</code></strong>

ODD-NUMBER</pre><p>Any self-respecting, law-abiding Lisp function would kick your butt to the curb if you tried to run this code, because you’re dividing by zero.<a id="IDX-CHP-4-0018" class="indexterm"/></p><p>But <code class="literal">if</code> is not just a function. It’s a <span class="emphasis"><em>special form</em></span>, which gives it special privileges, such as the right to not evaluate all its parameters in the normal way. This makes sense, since the whole point of a condition is to run some stuff but not other stuff. In this case, it just merrily ignores the division by zero, since it’s in the part of the branch that applies only to even numbers. Conditional commands in Lisp are typically special forms.<a id="IDX-CHP-4-0019" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e3785"/><img src="httpatomoreillycomsourcenostarchimages781852.png.jpg" alt="image with no caption"/></div></div><div class="note" title="Note"><h3 class="title">Note</h3><p>Some of the conditional commands may be macros, which are something like user-created special forms. Being a special form usually implies that a command is directly “baked in” to the language. In <a class="xref" href="ch18.html" title="Chapter 16. The Magic of Lisp Macros">Chapter 16</a>, you’ll learn how to write such macros yourself.<a id="IDX-CHP-4-0020" class="indexterm"/><a id="IDX-CHP-4-0021" class="indexterm"/><a id="IDX-CHP-4-0022" class="indexterm"/></p></div><p>Since only one expression inside an <code class="literal">if</code> is ever evaluated, it’s impossible to do two or more separate things inside your branch.</p><p>There is actually a clever style of programming (called <span class="emphasis"><em>functional programming</em></span>, as we’ll discuss in <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>), which considers this a Good Thing. However, for cases when you really want to do more than one thing, you can use a special command, <code class="literal">progn</code>, to wedge in extra commands in a single expression. With <code class="literal">progn</code>, only the last evaluation is returned as the value of the full expression. In this next example, for instance, we use the command to set a special global variable directly inside our conditional branch.<a id="IDX-CHP-4-0023" class="indexterm"/></p><a id="I_programlisting1_d1e3827"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defvar *number-was-odd* nil)</code></strong>

&gt; <strong class="userinput"><code>(if (oddp 5)</code></strong>
      <strong class="userinput"><code>(progn (setf *number-was-odd* t)</code></strong>
             <strong class="userinput"><code>'odd-number)</code></strong>
      <strong class="userinput"><code>'even-number)</code></strong>

ODD-NUMBER

&gt; <strong class="userinput"><code>*number-was-odd*</code></strong>

T</pre><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e3849"/><img src="httpatomoreillycomsourcenostarchimages782500.png" alt="image with no caption"/></div></div></div><div class="sect2" title="Going Beyond if: The when and unless Alternatives"><div class="titlepage"><div><div><h2 class="title"><a id="going_beyond_if_colon_the_when_and_unles"/>Going Beyond if: The when and unless Alternatives</h2></div></div></div><p>Since it’s kind of a pain to use <code class="literal">progn</code> every time you want to do multiple things inside an <code class="literal">if</code>, Lisp has several other commands that include an <span class="emphasis"><em>implicit</em></span> <code class="literal">progn</code>. The most basic of these are <code class="literal">when</code> and <code class="literal">unless</code>:<a id="IDX-CHP-4-0024" class="indexterm"/><a id="IDX-CHP-4-0025" class="indexterm"/><a id="IDX-CHP-4-0026" class="indexterm"/></p><a id="I_programlisting1_d1e3887"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defvar *number-is-odd* nil)</code></strong>
&gt; <strong class="userinput"><code>(when (oddp 5)</code></strong>
        <strong class="userinput"><code>(setf *number-is-odd* t)</code></strong>
        <strong class="userinput"><code>'odd-number)</code></strong>

ODD-NUMBER

&gt; <strong class="userinput"><code>*number-is-odd*</code></strong>

T

&gt; <strong class="userinput"><code>(unless (oddp 4)</code></strong>
          <strong class="userinput"><code>(setf *number-is-odd* nil)</code></strong>
          <strong class="userinput"><code>'even-number)</code></strong>

EVEN-NUMBER

&gt; <strong class="userinput"><code>*number-is-odd*</code></strong>

NIL</pre><p>With <code class="literal">when</code>, all the enclosed expressions are evaluated when the condition is true. With <code class="literal">unless</code>, all the enclosed expressions are evaluated when the condition is false. The trade-off is that these commands can’t do anything when the condition evaluates in the opposite way; they just return <code class="literal">nil</code> and do nothing.</p></div><div class="sect2" title="The Command That Does It All: cond"><div class="titlepage"><div><div><h2 class="title"><a id="the_command_that_does_it_all_colon_cond"/>The Command That Does It All: cond</h2></div></div></div><p>But what do you do if you’re the kind of coder who wants it all? Maybe you just ain’t in a compromisin’ mood and want a function that will do everything! Well, Lisp has you covered.<a id="IDX-CHP-4-0027" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e3937"/><img src="httpatomoreillycomsourcenostarchimages781360.png" alt="image with no caption"/></div></div><p>The <code class="literal">cond</code> form is the classic way to do branching in Lisp. Through the liberal use of parentheses, it allows for an implicit <code class="literal">progn</code>, can handle more than one branch, and can even evaluate several conditions in succession. Since <code class="literal">cond</code> has been around since the Lisp Stone Age, and it’s comprehensive in its abilities, many Lisp programmers consider it to be the one true Lisp conditional.<a id="IDX-CHP-4-0028" class="indexterm"/></p><p>Here’s an example:</p><a id="I_programlisting1_d1e3958"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defvar *arch-enemy* nil)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(defun pudding-eater (person)</code></strong>
<strong class="userinput"><code>        (cond ((eq person 'henry) (setf *arch-enemy* 'stupid-lisp-alien)</code></strong>
                                   <strong class="userinput"><code>'(curse you lisp alien - you ate my pudding))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>               <strong class="userinput"><code>((eq person 'johnny) (setf *arch-enemy* 'useless-old-johnny)</code></strong>
                                   <strong class="userinput"><code>'(i hope you choked on my pudding johnny))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>               <strong class="userinput"><code>(t                  '(why you eat my pudding stranger ?))))</code></strong>


  &gt; <strong class="userinput"><code>(pudding-eater 'johnny)</code></strong>
  (I HOPE YOU CHOKED ON MY PUDDING JOHNNY)
  &gt; <strong class="userinput"><code>*arch-enemy*</code></strong>
  JOHNNY
  &gt; <strong class="userinput"><code>(pudding-eater 'george-clooney)</code></strong>
  (WHY YOU EAT MY PUDDING STRANGER ?)</pre><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e4011"/><img src="httpatomoreillycomsourcenostarchimages779845.png.jpg" alt="image with no caption"/></div></div><p>As you can see, the body of a <code class="literal">cond</code> uses a layer of parentheses to separate the different branches of the condition. Then the first expression of each parenthesized part contains the condition for making that branch active. In our example, we have different branches for each type of pudding thief: one for Henry <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e4021"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, one for Johnny <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e4027"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, and one for everyone else <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e4033"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. We use <code class="literal">eq</code> to compare the supplied person’s name with each potential perpetrator.<a id="IDX-CHP-4-0029" class="indexterm"/><a id="IDX-CHP-4-0030" class="indexterm"/><a id="IDX-CHP-4-0031" class="indexterm"/></p><p>The conditions in a <code class="literal">cond</code> form are always checked from the top down, so the first successful match drives the behavior. In this example, the last branch <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e4059"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> has a condition of <code class="literal">t</code> (for true), guaranteeing that at least the last branch will always be evaluated. This is a common <code class="literal">cond</code> idiom.</p><p>As with <code class="literal">when</code> and <code class="literal">unless</code>, the triggered branch may contain more than one command, since there is an implicit <code class="literal">progn</code>. In this case, the first two branches <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e4082"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e4087"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> set an extra <code class="literal">*arch-enemy*</code> variable, besides supplying a return variable.</p></div><div class="sect2" title="Branching with case"><div class="titlepage"><div><div><h2 class="title"><a id="branching_with_case"/>Branching with case</h2></div></div></div><p>Let’s look at one final Lisp command: the <code class="literal">case</code> form. It is common to use the <code class="literal">eq</code> function for conditionals, and <code class="literal">case</code> lets you supply a value to compare against. Using <code class="literal">case</code>, we can rewrite the previous example as follows:</p><a id="I_programlisting1_d1e4113"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun pudding-eater (person)</code></strong>
         <strong class="userinput"><code>(case person</code></strong>
              <strong class="userinput"><code>((henry)   (setf *arch-enemy* 'stupid-lisp-alien)</code></strong>
                         <strong class="userinput"><code>'(curse you lisp alien - you ate my pudding))</code></strong>
              <strong class="userinput"><code>((johnny)  (setf *arch-enemy* 'useless-old-johnny)</code></strong>
                         <strong class="userinput"><code>'(i hope you choked on my pudding johnny))</code></strong>
              <strong class="userinput"><code>(otherwise '(why you eat my pudding stranger ?))))</code></strong></pre><p>This version of the code is a lot easier on the eyes. The name of the person handled by each part of the <code class="literal">case</code> statement is clearly visible—it’s not hidden inside an equality check. Depending on which version of Lisp you use, a <code class="literal">case</code> statement like this may also be more efficient, especially with longer statements, where larger numbers of cases are handled.<a id="IDX-CHP-4-0032" class="indexterm"/><a id="IDX-CHP-4-0033" class="indexterm"/><a id="IDX-CHP-4-0034" class="indexterm"/><a id="IDX-CHP-4-0035" class="indexterm"/></p><div class="warning" title="Warning"><h3 class="title">Warning</h3><p>Because the <code class="literal">case</code> command uses <code class="literal">eq</code> for comparisons, it is usually used only for branching on symbol values. It cannot be used to branch on string values, among other things. See <a class="xref" href="ch04s04.html" title="Comparing Stuff: eq, equal, and More">Comparing Stuff: eq, equal, and More</a> in <a class="xref" href="ch04s04.html" title="Comparing Stuff: eq, equal, and More">Comparing Stuff: eq, equal, and More</a> for details.</p></div></div></div>
<div class="sect1" title="Cool Tricks with Conditions"><div class="titlepage"><div><div><h1 class="title"><a id="cool_tricks_with_conditions"/>Cool Tricks with Conditions</h1></div></div></div><p>The fundamental design of Lisp lets you get a lot of mileage out of a few simple commands. Specifically, a couple of counterintuitive tricks involving conditions in Lisp can help you write cleaner code. The first involves two new conditional commands. The second takes advantage of Lisp’s simple conception of true and false.</p><div class="sect2" title="Using the Stealth Conditionals and and or"><div class="titlepage"><div><div><h2 class="title"><a id="using_the_stealth_conditionals_and_and_o"/>Using the Stealth Conditionals and and or</h2></div></div></div><p>The conditionals <code class="literal">and</code> and <code class="literal">or</code> are simple mathematical operators, which allow you to manipulate Boolean values in the same way you might manipulate numbers using addition and subtraction.</p><p>For example, here’s how we could use <code class="literal">and</code> to see if three numbers are odd:</p><a id="I_programlisting1_d1e4190"/><pre class="programlisting">&gt; <strong class="userinput"><code>(and (oddp 5) (oddp 7) (oddp 9))</code></strong>

T</pre><p>Because 5, 7, and 9 are odd, the entire expression evaluates as true.</p><p>Similarly, we can use or to see whether at least one of a set of numbers is odd:</p><a id="I_programlisting1_d1e4199"/><pre class="programlisting">&gt; <strong class="userinput"><code>(or (oddp 4) (oddp 7) (oddp 8))</code></strong>

T</pre><p>Because 7 is odd, the <code class="literal">or</code> command still evaluates as true, despite the fact that 4 and 8 are even.</p><p>But there’s something a bit more interesting about <code class="literal">and</code> and <code class="literal">or</code> that you might not notice just by looking at these first two examples. So far, these two commands look like completely ordinary mathematical operators; they do not look like conditional commands, such as <code class="literal">if</code> or <code class="literal">cond</code>. However, they can be used for conditional behavior.</p><p>For instance, here’s how we could use these conditionals to set a global variable to true only when a number is even:</p><a id="I_programlisting1_d1e4225"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter *is-it-even* nil)</code></strong>

*IS-IT-EVEN*

&gt; <strong class="userinput"><code>(or (oddp 4) (setf *is-it-even* t))</code></strong>

T

&gt; <strong class="userinput"><code>*is-it-even*</code></strong>

T</pre><p>If we do the same thing using an odd number, the variable remains unchanged:</p><a id="I_programlisting1_d1e4239"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter *is-it-even* nil)</code></strong>

*IS-IT-EVEN

&gt; <strong class="userinput"><code>(or (oddp 5) (setf *is-it-even* t))</code></strong>

T

&gt; <strong class="userinput"><code>*is-it-even*</code></strong>

NIL</pre><p>This example illustrates that Lisp uses <span class="emphasis"><em>shortcut Boolean evaluation</em></span>. This means that once Lisp determines that an earlier statement in a list of or values is true, it simply returns true and doesn’t bother evaluating the remaining statements. Similarly, once it determines that an earlier statement in a list of <code class="literal">and</code> values is false, it stops without bothering to evaluate the rest of the statements.<a id="IDX-CHP-4-0036" class="indexterm"/></p><p>While this may seem like a minor esoteric observation, it can actually be very useful in many situations. For instance, imagine if you want to save a file to disk, but only if the file was modified, and only when the user wants it to be saved. The basic structure could be written as follows:</p><a id="I_programlisting1_d1e4263"/><pre class="programlisting">(if *file-modified*
    (if (ask-user-about-saving)
        (save-file)))</pre><p>Here, the function <code class="literal">ask-user-about-saving</code> would ask the user about the file, and then return true or false based on the user’s wishes. However, since shortcut Boolean evaluation is guaranteed to be used for Boolean operations under Common Lisp and most other Lisp dialects, we could write this instead:</p><a id="I_programlisting1_d1e4270"/><pre class="programlisting">(and *file-modified* (ask-user-about-saving) (save-file))</pre><p>Using this cleaner style for evaluating conditional code is possible only if you think beyond the typical use of the Boolean operators as simply mathematical operators. This form has an elegant symmetry between the three expressions, which some Lispers may like. However, others would argue that a reader of your code may easily miss the fact that <code class="literal">(save-file)</code> does something beyond returning a Boolean value. A bit of time is required to wrap your head around this more-general conception of what <code class="literal">and</code> and <code class="literal">or</code> actually mean.<a id="IDX-CHP-4-0037" class="indexterm"/><a id="IDX-CHP-4-0038" class="indexterm"/></p><p>A third way to write this code, which is a compromise between the previous approaches, is as follows:</p><a id="I_programlisting1_d1e4293"/><pre class="programlisting">(if (and *file-modified*
         (ask-user-about-saving))
    (save-file)))</pre><p>Many experienced Lispers will consider this version a bit clearer than the previous two versions, because only expressions that are expressly designed to return a Boolean value are treated as part of the condition.</p></div><div class="sect2" title="Using Functions That Return More than Just the Truth"><div class="titlepage"><div><div><h2 class="title"><a id="using_functions_that_return_more_than_ju"/>Using Functions That Return More than Just the Truth</h2></div></div></div><p>Now let’s look at another benefit of Lisp’s simple way of thinking about true and false. As we’ve already discussed, any value in Common Lisp (except for the different variations on <code class="literal">nil</code>) is true. This means that functions that are commonly used in conditions have the option of returning <span class="emphasis"><em>more than just the truth</em></span>.</p><p>For instance, the Lisp command <code class="literal">member</code> can be used to check for list membership for an item:</p><a id="I_programlisting1_d1e4313"/><pre class="programlisting">&gt; <strong class="userinput"><code>(if (member 1 '(3 4 1 5))</code></strong>
      <strong class="userinput"><code>'one-is-in-the-list</code></strong>
      <strong class="userinput"><code>'one-is-not-in-the-list)</code></strong>

'ONE-IS-IN-THE-LIST</pre><p>This seems pretty straightforward. However, once again, there is something happening behind the scenes that you may not expect. Let’s run the <code class="literal">member</code> command in isolation:</p><a id="I_programlisting1_d1e4329"/><pre class="programlisting">&gt; <strong class="userinput"><code>(member 1 '(3 4 1 5))</code></strong>

(1 5)</pre><p>What the heck happened here? Why is it returning <code class="literal">(1 5)</code>?</p><p>Actually, there’s a perfectly rational explanation for this. Whenever a Lisper writes a function that returns true and false, she will think to herself, “Is there anything else I could return other than just t?” Since all non-nil values in Common Lisp evaluate to true, returning some other value is essentially a freebie. The implementers of the <code class="literal">member</code> function decided that some crazy Lisper somewhere may see the value in having the tail of the list for some calculation that uses this function.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Remember from <a class="xref" href="ch03.html" title="Chapter 3. Exploring the Syntax of Lisp Code">Chapter 3</a> that the list <code class="literal">'(3 4 1 5)</code> is the same as the nested contraption <code class="literal">(cons 3 (cons 4 (cons 1 (cons 5 nil))))</code>. This should make it clear why the value <code class="literal">(cons 1 (cons 5 nil))</code> is an easy thing for the <code class="literal">member</code> function to return.</p></div><p>But why doesn’t it just return the value it found, instead of the tail? In fact, this would have been a useful way to define the <code class="literal">member</code> function, because it would allow passing the original value to some other function in such a manner. Unfortunately, one edge case in particular would ruin this plan:<a id="IDX-CHP-4-0039" class="indexterm"/><a id="IDX-CHP-4-0040" class="indexterm"/></p><a id="I_programlisting1_d1e4372"/><pre class="programlisting">&gt; <strong class="userinput"><code>(if (member nil '(3 4 nil 5))</code></strong>
      <strong class="userinput"><code>'nil-is-in-the-list</code></strong>
      <strong class="userinput"><code>'nil-is-not-in-the-list)</code></strong>

'nil-is-in-the-list</pre><p>As you can see in this example, the <code class="literal">member</code> function still gives the correct answer, even when we search for <code class="literal">nil</code> as the member! If the <code class="literal">member</code> function had actually returned <code class="literal">nil</code> (in other words, the original value we were searching for), it would have evaluated as false, and the example would have incorrectly stated that nil isn’t in the list. However, since the <code class="literal">member</code> function returns the tail of the list at the point of the found item, it can be guaranteed to always be a true value. A successful discovery of the desired value will always return a list with at least one value, which we know always evaluates as true.</p><p>One function that really benefits from rich return values is <code class="literal">find-if</code>, as follows:</p><a id="I_programlisting1_d1e4406"/><pre class="programlisting">&gt; <strong class="userinput"><code>(find-if #'oddp '(2 4 5 6))</code></strong>

5

&gt; <strong class="userinput"><code>(if (find-if #'oddp '(2 4 5 6))</code></strong>
      <strong class="userinput"><code>'there-is-an-odd-number</code></strong>
      <strong class="userinput"><code>'there-is-no-odd-number)</code></strong>

'there-is-an-odd-number</pre><p>The <code class="literal">find-if</code> function actually takes another function, in this case <code class="literal">oddp</code>, as a parameter. <code class="literal">find-if</code> will find the first value in the list for which <code class="literal">oddp</code> returns true. In this case, it will find the first number (if any) that is an odd number.</p><p>You can see clearly how <code class="literal">find-if</code> can fill dual roles: either as a retriever of values matching some constraint or as a true/false value inside a condition.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Don’t worry yet about the weird hash mark (<code class="literal">#</code>) in front of <code class="literal">oddp</code> in the example. We’ll discuss the <code class="literal">find-if</code> function, and other so-called higher-order functions, in greater detail in <a class="xref" href="ch08.html" title="Chapter 7. Going Beyond Basic Lists">Chapter 7</a> and <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>.</p></div><p>Alas, the elegant symmetry of the <code class="literal">find-if</code> function has a single, small, ugly wart. If we try our edge case again, searching for a <code class="literal">nil</code> value, we get a rather disappointing result:</p><a id="I_programlisting1_d1e4463"/><pre class="programlisting">&gt; <strong class="userinput"><code>(find-if #'null '(2 4 nil 6))</code></strong>

NIL</pre><p>The <code class="literal">null</code> function, which returns true for any of the <code class="literal">nil</code> values, correctly finds the <code class="literal">nil</code>. Unfortunately, in this one annoying case, we would not want to use <code class="literal">find-if</code> inside a conditional statement, because a correctly found value still returns a result that evaluates as false. The symmetry has been broken.<a id="IDX-CHP-4-0041" class="indexterm"/></p><p>These are the kinds of small things that make even grown Lispers shed a tear.</p></div></div>
<div class="sect1" title="Comparing Stuff: eq, equal, and More"><div class="titlepage"><div><div><h1 class="title"><a id="comparing_stuff_colon_eq_comma_equal_com"/>Comparing Stuff: eq, equal, and More</h1></div></div></div><p>There’s a lot of beautiful symmetry in Lisp. One part of Lisp that isn’t so beautiful, though, involves the commands for comparing things.</p><p>If you want to compare two values in Lisp to find out if they are “the same,” you will find a bewildering assortment of different functions that purport to accomplish this. Of these, <code class="literal">equal</code>, <code class="literal">eql</code>, <code class="literal">eq</code>, <code class="literal">=</code>, <code class="literal">string-equal</code>, and <code class="literal">equalp</code> are the most commonly used. A Lisper must understand the subtleties of these functions intimately in order to know how to compare values correctly.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e4514"/><img src="httpatomoreillycomsourcenostarchimages782684.png" alt="image with no caption"/></div></div><p>Before we start dissecting this madness, let me give you Conrad’s Rule of Thumb for Comparing Stuff. Follow this rule, and though you may not be writing the world’s cleanest Lisp code, you will probably be able to post some samples to a newsgroup without more seasoned Lispers running you out of town with torches and pitchforks.<a id="IDX-CHP-4-0042" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e4525"/><img src="httpatomoreillycomsourcenostarchimages782114.png" alt="image with no caption"/></div></div><p>Symbols should always be compared to other symbols with <code class="literal">eq</code>:<a id="IDX-CHP-4-0043" class="indexterm"/><a id="IDX-CHP-4-0044" class="indexterm"/><a id="IDX-CHP-4-0045" class="indexterm"/><a id="IDX-CHP-4-0046" class="indexterm"/><a id="IDX-CHP-4-0047" class="indexterm"/><a id="IDX-CHP-4-0048" class="indexterm"/></p><a id="I_programlisting1_d1e4557"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter *fruit* 'apple)</code></strong>

*FRUIT*

&gt; <strong class="userinput"><code>(cond ((eq *fruit* 'apple) 'its-an-apple)</code></strong>
        <strong class="userinput"><code>((eq *fruit* 'orange) 'its-an-orange))</code></strong>

ITS-AN-APPLE</pre><p>The <code class="literal">eq</code> function is the simplest of all the Lisp comparison functions, and it’s also very fast. It doesn’t really work for comparing items besides symbols, but if you consider the central role symbols play in Lisp, you’ll realize how useful this function can be. Experienced Lispers might look down on code if it compares two things, known to be symbols, with something other than <code class="literal">eq</code>.</p><div class="note" title="Note"><h3 class="title">Note</h3><p><code class="literal">eq</code> can also be used to compare conses (the links created by the cons command). However, it returns true values only when a cons is compared directly to itself, created by the same cons call. This means, two unrelated conses that “look” exactly the same can fail an eq test. Since <code class="literal">eq</code> can check a cons cell only against itself, using <code class="literal">eq</code> with conses isn’t really that useful for a beginner. However, an advanced Lisper may want to compare conses with <code class="literal">eq</code> under certain circumstances.</p></div><p>If you’re not dealing with two symbols, just use <code class="literal">equal</code>. This command will tell you when two things are <code class="literal">isomorphic</code>, meaning they “look the same.” It works for the whole suite of basic Lisp datatypes, as shown here:</p><a id="I_programlisting1_d1e4599"/><pre class="programlisting">;;comparing symbols
&gt; <strong class="userinput"><code>(equal 'apple 'apple)</code></strong>

T

;;comparing lists
&gt; <strong class="userinput"><code>(equal (list 1 2 3) (list 1 2 3))</code></strong>

T

;;Identical lists created in different ways still compare as the same
&gt; <strong class="userinput"><code>(equal '(1 2 3) (cons 1 (cons 2 (cons 3))))</code></strong>

T

;;comparing integers
&gt; <strong class="userinput"><code>(equal 5 5)</code></strong>

T

;;comparing floating point numbers
&gt; <strong class="userinput"><code>(equal 2.5 2.5)</code></strong>

T

;;comparing strings
&gt; <strong class="userinput"><code>(equal "foo" "foo")</code></strong>

T

;;comparing characters
&gt; <strong class="userinput"><code>(equal #\a #\a)</code></strong>

T</pre><p>As you can see, most items in Lisp can be effectively compared with <code class="literal">equal</code>, including strings and characters (which are discussed in the next chapter).</p><p>Now that you know the bare minimum about Lisp comparisons to fake your way through your next cocktail party, let’s look at all the other comparison commands.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e4631"/><img src="httpatomoreillycomsourcenostarchimages783512.png" alt="image with no caption"/></div></div><p>The <code class="literal">eql</code> command is similar to the <code class="literal">eq</code> command, but unlike <code class="literal">eq</code>, it also handles comparisons of numbers and characters:<a id="IDX-CHP-4-0049" class="indexterm"/><a id="IDX-CHP-4-0050" class="indexterm"/><a id="IDX-CHP-4-0051" class="indexterm"/><a id="IDX-CHP-4-0052" class="indexterm"/><a id="IDX-CHP-4-0053" class="indexterm"/><a id="IDX-CHP-4-0054" class="indexterm"/><a id="IDX-CHP-4-0055" class="indexterm"/><a id="IDX-CHP-4-0056" class="indexterm"/></p><a id="I_programlisting1_d1e4678"/><pre class="programlisting">;;comparing symbols
&gt; <strong class="userinput"><code>(eql 'foo 'foo)</code></strong>

T

;;comparing numbers
&gt; <strong class="userinput"><code>(eql 3.4 3.4)</code></strong>

T

;;comparing characters
&gt; <strong class="userinput"><code>(eql #\a #\a)</code></strong>

T</pre><p>The <code class="literal">equalp</code> command is essentially the same as the <code class="literal">equal</code> command, except that it can handle some difficult comparison cases with a bit of extra sophistication. For instance, it can compare strings with different capitalizations and can compare integers against floating-point numbers:</p><a id="I_programlisting1_d1e4697"/><pre class="programlisting">;;comparing strings with different CAPS
&gt; <strong class="userinput"><code>(equalp "Bob Smith" "bob smith")</code></strong>
T
;;comparing integers against floating point numbers
&gt; <strong class="userinput"><code>(equalp 0 0.0)</code></strong>
T</pre><p>The remaining comparison commands are just specializations for specific datatypes. Otherwise, they are similar to <code class="literal">equal</code>. For instance, the = (equal sign) function handles numbers, <code class="literal">string-equal</code> handles strings, and <code class="literal">char-equal</code> handles characters.<a id="IDX-CHP-4-0057" class="indexterm"/><a id="IDX-CHP-4-0058" class="indexterm"/></p><p>I hope that you can now appreciate just how seriously Lispers take comparisons.</p></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id3"/>What You've Learned</h1></div></div></div><p>In this chapter, we discussed how conditions work in Lisp. Along the way, you learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The values <code class="literal">nil</code>, <code class="literal">'nil</code>, <code class="literal">()</code>, and <code class="literal">'()</code> are all basically the same thing in Common Lisp.</p></li><li class="listitem"><p>Lisp makes it easy to check for empty lists. This makes it simple to write list-eaters.</p></li><li class="listitem"><p>Lisp conditionals, such as the <code class="literal">if</code> command, cause Lisp code to be evaluated only under the right conditions.</p></li><li class="listitem"><p>If you need a conditional command that does everything, then you want to use <code class="literal">cond</code>.</p></li><li class="listitem"><p>Comparing stuff in Lisp is complicated, but you can get by if you just use <code class="literal">eq</code> for comparing symbols and <code class="literal">equal</code> for comparing everything else.</p></li></ul></div></div>
<div class="chapter" title="Chapter&#xA0;5.&#xA0;Building a Text Game Engine"><div class="titlepage"><div><div><h1 class="title"><a id="building_a_text_game_engine"/>Chapter 5. Building a Text Game Engine</h1></div></div></div><p>When you write a program, no matter which programming language you’re using or what your program does, it will probably need to work with text. Sure, one day we may all have Ethernet ports at the base of our skulls (100Mbps Ethernet will have been fully adopted by then, of course). But until the day arrives when you can just exchange thoughts with your MacBook using a direct hookup, you’ll be stuck using alphabetic text for input and output in your software.</p><p>Computers have always had a bit of a tenuous relationship with text. Although we tend to think of text processing as a central task for computer hardware and software (indeed, the 8-bit byte is the standard design element in modern computers, in large part, due to how well suited it is for encoding Western character sets), the truth of the matter is that the human concept of <span class="emphasis"><em>text</em></span> is really alien to a computer.<a id="IDX-CHP-5-0001" class="indexterm"/></p><p>In this chapter, you’ll learn how to use Lisp to manipulate text. You’ll see, once again, that the Lispy approach to solving problems allows you to create code that is full of elegance and symmetry. To demonstrate this approach, we will do something that would seem to make thinking with text unavoidable: build the engine for a simple text adventure game. However, we’ll do this in a way that avoids constraining our code by artificially forcing the human notion of text into its design. This will allow us to write code that focuses on the strengths of a computer.<a id="IDX-CHP-5-0002" class="indexterm"/></p><p>As you read this chapter, remember that handling text is not a computer’s strength. It is a necessary evil best kept to a minimum.</p><div class="sect1" title="The Wizard's Adventure Game"><div class="titlepage"><div><div><h1 class="title"><a id="the_wizard_apostrophy_s_adventure_game"/>The Wizard's Adventure Game</h1></div></div></div><p>In this game, you are a wizard’s apprentice. You’ll explore the wizard’s house. When we complete the game (in <a class="xref" href="ch19.html" title="Chapter 17. Domain-Specific Languages">Chapter 17</a>), you’ll be able to solve puzzles and win a magical donut.</p><div class="sect2" title="Our Game World"><div class="titlepage"><div><div><h2 class="title"><a id="our_game_world"/>Our Game World</h2></div></div></div><p>Here is a picture of our game world:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e4806"/><img src="httpatomoreillycomsourcenostarchimages780116.png" alt="image with no caption"/></div></div><p>As you can see, we can visit three different locations: a living room, an attic, and a garden. Players can move between places using the door and the ladder to the attic.</p><p>Think of this game world as a simple directed graph with three nodes (represented as ellipses) and four edges (represented as arrows):<a id="IDX-CHP-5-0003" class="indexterm"/><a id="IDX-CHP-5-0004" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e4824"/><img src="httpatomoreillycomsourcenostarchimages782728.png.jpg" alt="image with no caption"/></div></div><p>Players move between nodes by traveling along the edges in either direction. Wherever the players are, they can interact with various objects around them.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e4832"/><img src="httpatomoreillycomsourcenostarchimages782136.png.jpg" alt="image with no caption"/></div></div></div><div class="sect2" title="Basic Requirements"><div class="titlepage"><div><div><h2 class="title"><a id="basic_requirements"/>Basic Requirements</h2></div></div></div><p>Our game code will need to handle a few basic things:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Looking around</p></li><li class="listitem"><p>Walking to different locations</p></li><li class="listitem"><p>Picking up objects</p></li><li class="listitem"><p>Performing actions on the objects picked up</p></li></ul></div><p>In this chapter, we’ll address the first three of these requirements. To perform more complex actions on objects, we’ll use the more advanced Lisp techniques covered in later chapters. Because of this, our game engine will be somewhat limited in its abilities until we finish it in <a class="xref" href="ch19.html" title="Chapter 17. Domain-Specific Languages">Chapter 17</a>.</p><p>When looking around in our game world, you will be able to “see” three kinds of things from any location:<a id="IDX-CHP-5-0005" class="indexterm"/><a id="IDX-CHP-5-0006" class="indexterm"/><a id="IDX-CHP-5-0007" class="indexterm"/><a id="IDX-CHP-5-0008" class="indexterm"/><a id="IDX-CHP-5-0009" class="indexterm"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Basic scenery</p></li><li class="listitem"><p>One or more paths to other locations</p></li><li class="listitem"><p>Objects that you can pick up and manipulate</p></li></ul></div><p>Let’s add features for these one at a time.</p></div></div></div>
<div class="sect1" title="Describing the Scenery with an Association List"><div class="titlepage"><div><div><h1 class="title"><a id="describing_the_scenery_with_an_associati"/>Describing the Scenery with an Association List</h1></div></div></div><p>The world inside our adventure game is very simple, containing only three locations. Let’s first create a top-level variable, <code class="literal">*nodes*</code>, to contain descriptions of the locations that exist in our game:</p><a id="I_programlisting2_d1e4902"/><pre class="programlisting">(defparameter *nodes* '((living-room (you are in the living-room.
                            a wizard is snoring loudly on the couch.))
                        (garden (you are in a beautiful garden.
                            there is a well in front of you.))
                        (attic (you are in the attic.
                            there is a giant welding torch in the corner.))))</pre><p>This variable contains a list and description of our three locations. In essence, the <code class="literal">*nodes*</code> variable basically gives us a way to find a piece of data associated with a lookup key. In this case, the key is the name of the place (<code class="literal">living-room</code>, <code class="literal">garden</code>, or <code class="literal">attic</code>), and the data is a text description of the scenery at that place. This type of structure is called an <span class="emphasis"><em>association list</em></span>, or <span class="emphasis"><em>alist</em></span> for short (alists are covered in greater detail in <a class="xref" href="ch08.html" title="Chapter 7. Going Beyond Basic Lists">Chapter 7</a>).</p><p>One thing is rather unusual about the definition of this <code class="literal">*nodes*</code> variable: Even though it contains descriptions of the various locations in our game world, it does not actually contain any text strings. Since Common Lisp has a string datatype, we could have written descriptions using quotes. For instance, we could have written <code class="literal">"You are in a beautiful garden. There is a well in front of you."</code> Instead, we use more fundamental datatypes—symbols and lists—to encode this information.<a id="IDX-CHP-5-0010" class="indexterm"/></p><p>Why wouldn’t we just use strings? As I mentioned at the beginning of this chapter, the manipulation of text is not really a fundamental computing concept. In this game, we’ll manipulate the messages displayed to players based on their interaction with the game world in complicated ways. For most real-world programs, the information you’ll generate as output (such as HTML, PDFs, or even richer graphical formats) will probably be far more complicated than just simple text.</p><p>By keeping your source data structures free from assumptions regarding the output format from the start, your coding can take full advantage of your programming language. Since the easiest things to manipulate in Lisp are symbols and lists, most experienced Lispers will try to focus on these datatypes in the design of their software whenever possible. So, we will stay away from strings in our design. (In the next chapter, we will translate these lists and symbols into properly formatted text.)<a id="IDX-CHP-5-0011" class="indexterm"/><a id="IDX-CHP-5-0012" class="indexterm"/><a id="IDX-CHP-5-0013" class="indexterm"/><a id="IDX-CHP-5-0014" class="indexterm"/><a id="IDX-CHP-5-0015" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>Common Lisp doesn’t force you to represent strings with lists and symbols in this way. If it’s more convenient, you can work with strings directly. (You’ll see examples of working with strings later in the book, especially in <a class="xref" href="ch12.html" title="Chapter 11. Printing Text with the format Function">Chapter 11</a>.) Using lists and symbols as an intermediary for manipulating text is definitely an old-school Lisp technique. However, it can often lead to very elegant code, since list operations are so fundamental to Lisp.</p></div></div>
<div class="sect1" title="Describing the Location"><div class="titlepage"><div><div><h1 class="title"><a id="describing_the_location"/>Describing the Location</h1></div></div></div><p>Now that we’ve created an alist of our game world, we need to create a command to describe a location. To accomplish this, we’ll use the <code class="literal">assoc</code> function to find the correct item in the list using a key:</p><a id="I_programlisting2_d1e4976"/><pre class="programlisting">&gt; <strong class="userinput"><code>(assoc 'garden *nodes*)</code></strong>
(GARDEN (YOU ARE IN A BEAUTIFUL GARDEN. THERE IS A WELL IN FRONT OF YOU.))</pre><p>Using <code class="literal">assoc</code>, we can easily create the <code class="literal">describe-location</code> function:</p><a id="I_programlisting2_d1e4989"/><pre class="programlisting">(defun describe-location (location nodes)
   (cadr (assoc location nodes)))</pre><p>To use this function, we pass in a location and the <code class="literal">*nodes*</code> list:</p><a id="I_programlisting2_d1e4996"/><pre class="programlisting">&gt; <strong class="userinput"><code>(describe-location 'living-room *nodes*)</code></strong>
(YOU ARE IN THE LIVING-ROOM. A WIZARD IS SNORING LOUDLY ON THE COUCH.)</pre><p>Why don’t we just reference the <code class="literal">*nodes*</code> variable directly from the <code class="literal">describe-location</code> function? Because this function is written in the <span class="emphasis"><em>functional programming</em></span> style. In this style, a function will reference only parameters or variables declared in the function itself, and it will do nothing besides return a value, which is the description of the location in this case.<a id="IDX-CHP-5-0016" class="indexterm"/></p><p>By writing functions that don’t reference variables in the “outside world” directly and that don’t perform any actions other than returning a value, you can write code that can easily be tested in isolation. You should try to write your Lisp functions in this style whenever possible. (We will discuss the functional programming style in greater detail in <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>.)</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e5020"/><img src="httpatomoreillycomsourcenostarchimages782164.png.jpg" alt="image with no caption"/></div></div></div>
<div class="sect1" title="Describing the Paths"><div class="titlepage"><div><div><h1 class="title"><a id="describing_the_paths"/>Describing the Paths</h1></div></div></div><p>Now that we have basic descriptions of each location, we need descriptions of paths to other locations as well. We’ll create a second variable, <code class="literal">*edges*</code>, that contains the paths that players can take to move between places on our map. (We use the term <span class="emphasis"><em>edges</em></span> because that’s the proper math term for the lines connecting nodes in a graph.)<a id="IDX-CHP-5-0017" class="indexterm"/><a id="IDX-CHP-5-0018" class="indexterm"/><a id="IDX-CHP-5-0019" class="indexterm"/><a id="IDX-CHP-5-0020" class="indexterm"/><a id="IDX-CHP-5-0021" class="indexterm"/></p><a id="I_programlisting2_d1e5055"/><pre class="programlisting">(defparameter *edges* '((living-room (garden west door)
                                     (attic upstairs ladder))
                        (garden (living-room east door))
                        (attic (living-room downstairs ladder))))</pre><p>Using this structure, we create the <code class="literal">describe-path</code> function, which builds a textual description of a given edge using our symbols system.</p><a id="I_programlisting2_d1e5062"/><pre class="programlisting">(defun describe-path (edge)
  `(there is a ,(caddr edge) going ,(cadr edge) from here.))</pre><p>This <code class="literal">describe-path</code> function looks pretty strange—almost like a piece of data more than a function. Let’s try it, and then figure out how it works.<a id="IDX-CHP-5-0022" class="indexterm"/><a id="IDX-CHP-5-0023" class="indexterm"/><a id="IDX-CHP-5-0024" class="indexterm"/><a id="IDX-CHP-5-0025" class="indexterm"/><a id="IDX-CHP-5-0026" class="indexterm"/><a id="IDX-CHP-5-0027" class="indexterm"/></p><a id="I_programlisting2_d1e5097"/><pre class="programlisting">&gt; <strong class="userinput"><code>(describe-path '(garden west door))</code></strong>
(THERE IS A DOOR GOING WEST FROM HERE.)</pre><p>This function basically returns a piece of data with small bits of calculated information inserted into it. This feature of Lisp, called <span class="emphasis"><em>quasiquoting</em></span>, allows us to create chunks of data that have small pieces of Lisp code embedded in them.<a id="IDX-CHP-5-0028" class="indexterm"/></p><div class="sect2" title="How Quasiquoting Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_quasiquoting_works"/>How Quasiquoting Works</h2></div></div></div><p>To enable quasiquoting, you must use a backquote [<code class="literal">`</code>] not a single quote [<code class="literal">'</code>] when switching from code to data mode. The <code class="literal">describe-path</code> function has just such a backquote in it.</p><p>Both the single quote and backquote in Lisp “flip” a piece of code into data mode, but only a backquote can also be <span class="emphasis"><em>unquoted</em></span> using the comma character, to flip back into code mode.</p><p>With a little imagination, this should make sense to you. After all, a comma does look just like an upside-down backquote, doesn’t it? Here’s how the flip-flop in the <code class="literal">describe-path</code> function works (the parts in code mode are shaded):</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e5135"/><img src="httpatomoreillycomsourcenostarchimages779865.png.jpg" alt="image with no caption"/></div></div><p>Lisp attempts to make list manipulation as easy as possible. Here, you can see how our program, which uses lists of symbols to store our text, can now leverage the quasiquoting feature to construct sentences in a very concise and clear way.</p></div><div class="sect2" title="Describing Multiple Paths at Once"><div class="titlepage"><div><div><h2 class="title"><a id="describing_multiple_paths_at_once"/>Describing Multiple Paths at Once</h2></div></div></div><p>Now let’s use our <code class="literal">describe-path</code> function to create a more advanced function. Since a location may have any number of paths exiting from it, we need a function that can generate descriptions for all edges from a given location by looking up the location from our data structure of edges:</p><a id="I_programlisting2_d1e5150"/><pre class="programlisting">(defun describe-paths (location edges)
  (apply #'append (mapcar #'describe-path (cdr (assoc location edges)))))</pre><p>This function uses a bunch of commands that may seem very exotic to a person not accustomed to the world of Lisp. Many programming languages would use some kind of for-next loop to run through the edges, and then cram the descriptions of each path together using a temporary variable. Lisp uses a much more elegant approach. Let’s see it in action:<a id="IDX-CHP-5-0029" class="indexterm"/><a id="IDX-CHP-5-0030" class="indexterm"/></p><a id="I_programlisting2_d1e5162"/><pre class="programlisting">&gt; <strong class="userinput"><code>(describe-paths 'living-room *edges*)</code></strong>
(THERE IS A DOOR GOING WEST FROM HERE. THERE IS A LADDER GOING UPSTAIRS FROM HERE.)</pre><p>The <code class="literal">describe-paths</code> function takes the following steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Find the relevant edges.</p></li><li class="listitem"><p>Convert the edges to descriptions.</p></li><li class="listitem"><p>Join the descriptions.</p></li></ol></div><p>Let’s see how it performs each of these steps.</p><div class="sect3" title="Finding the Relevant Edges"><div class="titlepage"><div><div><h3 class="title"><a id="finding_the_relevant_edges"/>Finding the Relevant Edges</h3></div></div></div><p>The first, inner part of the <code class="literal">describe-paths</code> function is pretty straightforward. To find the relevant paths and edges leading from the living room, we use <code class="literal">assoc</code> again to look up the location in our list of edges:</p><a id="I_programlisting2_d1e5195"/><pre class="programlisting">&gt; <strong class="userinput"><code>(cdr (assoc 'living-room *edges*))</code></strong>
((GARDEN WEST DOOR) (ATTIC UPSTAIRS LADDER))</pre></div><div class="sect3" title="Converting the Edges to Descriptions"><div class="titlepage"><div><div><h3 class="title"><a id="converting_the_edges_to_descriptions"/>Converting the Edges to Descriptions</h3></div></div></div><p>Next, the edges are converted to descriptions. Here is just the code to accomplish this, shown in isolation:</p><a id="I_programlisting2_d1e5205"/><pre class="programlisting">&gt; <strong class="userinput"><code>(mapcar #'describe-path '((GARDEN WEST DOOR) (ATTIC UPSTAIRS LADDER)))</code></strong>
((THERE IS A DOOR GOING WEST FROM HERE.)
 (THERE IS A LADDER GOING UPSTAIRS FROM HERE.))</pre><p>The <code class="literal">mapcar</code> function is used frequently by Lispers. This function takes another function and a list, and then applies this function to every member of a list. Here’s an example:</p><a id="I_programlisting2_d1e5215"/><pre class="programlisting">&gt; <strong class="userinput"><code>(mapcar #'sqrt '(1 2 3 4 5))</code></strong>
(1 1.4142135 1.7320508 2 2.236068)</pre><p>This example passes the <code class="literal">sqrt</code> (square root) function, along with the <code class="literal">(1 2 3 4 5)</code> list, into <code class="literal">mapcar</code>. As a result, the function generates a list of the square roots of the original numbers by applying <code class="literal">sqrt</code> to every member of the list and creating a new list.</p><p>Functions that take other functions as parameters, such as <code class="literal">mapcar</code>, are very useful and a distinguishing feature of Lisp. Such functions are called <span class="emphasis"><em>higher-order functions</em></span>.<a id="IDX-CHP-5-0031" class="indexterm"/><a id="IDX-CHP-5-0032" class="indexterm"/><a id="IDX-CHP-5-0033" class="indexterm"/><a id="IDX-CHP-5-0034" class="indexterm"/><a id="IDX-CHP-5-0035" class="indexterm"/><a id="IDX-CHP-5-0036" class="indexterm"/><a id="IDX-CHP-5-0037" class="indexterm"/><a id="IDX-CHP-5-0038" class="indexterm"/><a id="IDX-CHP-5-0039" class="indexterm"/><a id="IDX-CHP-5-0040" class="indexterm"/></p><p>Here is another example:</p><a id="I_programlisting2_d1e5281"/><pre class="programlisting">&gt; <strong class="userinput"><code>(mapcar #'car '((foo bar) (baz qux)))</code></strong>
(foo baz)</pre><p>This time, our source list contains two smaller lists. The <code class="literal">car</code> function, which grabs the first item in a list, causes <code class="literal">mapcar</code> to return the first items from each smaller list, <code class="literal">foo</code> and <code class="literal">baz</code>.</p><p>You may be wondering why the function names we pass into <code class="literal">mapcar</code> have the <code class="literal">#'</code> symbols in front of them. This symbol sequence is a shorthand for the <code class="literal">function</code> operator. The Lisp reader (the part of your Lisp environment that reads the code you type) will convert the previous example into the following longer version:</p><a id="I_programlisting2_d1e5312"/><pre class="programlisting">&gt; <strong class="userinput"><code>(mapcar (function car) '((foo bar) (baz qux)))</code></strong>
(foo baz)</pre><p>Common Lisp requires you to use the <code class="literal">function</code> operator when referring to a function as a value directly like this, because the name of a function may conflict with other named items in a program, causing unpredictable errors. For instance, imagine if we added more stuff to the previous example, like this:</p><a id="I_programlisting2_d1e5322"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(let ((car "Honda Civic"))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>    <strong class="userinput"><code>(mapcar #'car '((foo bar) (baz qux))))</code></strong>
  (foo baz)</pre><p>In this version, the <code class="literal">car</code> symbol could have two different meanings. The first meaning of car is that it is a standard function built into Lisp (introduced in <a class="xref" href="ch03.html" title="Chapter 3. Exploring the Syntax of Lisp Code">Chapter 3</a>). However, we’re also creating a local variable named <code class="literal">car</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e5351"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Because we prepended the word <code class="literal">car</code> with <code class="literal">#'</code> in our call to <code class="literal">mapcar</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e5367"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, there is no confusion about which <code class="literal">car</code> we are talking about.</p><p>Now let’s look at the <code class="literal">describe-paths</code> function again:</p><a id="I_programlisting2_d1e5381"/><pre class="programlisting">(defun describe-paths (location edges)
  (apply #'append (mapcar #'describe-path (cdr (assoc location edges)))))</pre><p>Notice how the <code class="literal">append</code> and <code class="literal">describe-path</code> functions are passed in as values to the <code class="literal">apply</code> and <code class="literal">mapcar</code> functions, which are designed to receive and use the functions.</p><p>Common Lisp tracks function names differently from variable names. It has multiple <span class="emphasis"><em>namespaces</em></span>, including one for variables and one for functions. (We’ll learn more about namespaces later, especially in <a class="xref" href="ch18.html" title="Chapter 16. The Magic of Lisp Macros">Chapter 16</a>.) Scheme, the other popular Lisp dialect, doesn’t force you to mark functions with a function operator when using them as values.</p><p>In other words, Scheme has only one namespace for both functions and variables. For instance, in Scheme, you can just write <code class="literal">(map sqrt '(1 2 3 4 5))</code> to generate the square roots of the numbers 1 through 5 without generating an error (<code class="literal">map</code> is the Scheme version of <code class="literal">mapcar</code>). As a result of this design, in Scheme, a variable and a separate function can’t be available in the same block of code. That design decision is one of the great benefits (or curses) of Scheme, depending on your point of view. Because of this difference in the number of namespaces, Scheme is sometimes called a <span class="emphasis"><em>Lisp-1</em></span>, whereas Common Lisp is sometimes referred to as a <span class="emphasis"><em>Lisp-2</em></span>.<a id="IDX-CHP-5-0041" class="indexterm"/><a id="IDX-CHP-5-0042" class="indexterm"/><a id="IDX-CHP-5-0043" class="indexterm"/><a id="IDX-CHP-5-0044" class="indexterm"/></p></div><div class="sect3" title="Joining the Descriptions"><div class="titlepage"><div><div><h3 class="title"><a id="joining_the_descriptions"/>Joining the Descriptions</h3></div></div></div><p>Once we’ve used <code class="literal">mapcar</code> to generate a list of descriptions for all the paths and edges, we need to combine them into a single description. We accomplish this with the <code class="literal">append</code> function, which joins several lists into one big list:</p><a id="I_programlisting2_d1e5449"/><pre class="programlisting">&gt; <strong class="userinput"><code>(append '(mary had) '(a) '(little lamb))</code></strong>
(MARY HAD A LITTLE LAMB)</pre><p>We use the <code class="literal">append</code> function to cram the list of path descriptions into one list that describes the whole enchilada, in one swoop. The problem is that <code class="literal">append</code> needs all of the lists handed to it as separate parameters. In <code class="literal">describe-paths</code>, we have our lists in one big list, not as separate objects we can pass as parameters. Heck, we don’t even know how many paths there may be from any given spot.</p><p>The <code class="literal">apply</code> function solves this problem. You pass it a function and a list of objects, and it pretends that the items in the list are separate objects and passes them to the given function as such. For example, if we have the nested list <code class="literal">'((mary had) (a) (little lamb))</code>, the <code class="literal">apply</code> function will add in that little bit of duct tape needed to make the <code class="literal">append</code> function work with a single big list:</p><a id="I_programlisting2_d1e5479"/><pre class="programlisting">&gt; <strong class="userinput"><code>(apply #'append '((mary had) (a) (little lamb)))</code></strong>
(MARY HAD A LITTLE LAMB)</pre><div class="warning" title="Warning"><h3 class="title">Warning</h3><p>Since the <code class="literal">apply</code> function passes each item in a list as an argument to the <code class="literal">target</code> function, you can run into problems when calling it on very large lists that have thousands of items or more. You can check the value of the <code class="literal">call-arguments-limit</code> variable in the REPL to see the maximum number of allowed arguments to a function. (More recent dialects of Lisp are typically designed to allow argument lists of any size, without an artificial limit.)</p></div><p>You can see how <code class="literal">apply</code> enables the <code class="literal">describe-paths</code> function to build one long list describing all paths leading from a single location. Let’s use this same approach on the path description lists we constructed:</p><a id="I_programlisting2_d1e5504"/><pre class="programlisting">&gt; <strong class="userinput"><code>(apply #'append '((THERE IS A DOOR GOING WEST FROM HERE.)</code></strong>
                    <strong class="userinput"><code>(THERE IS A LADDER GOING UPSTAIRS FROM HERE.)))</code></strong>
(THERE IS A DOOR GOING WEST FROM HERE. THERE IS A LADDER GOING UPSTAIRS FROM HERE.)</pre><p>Now that we’ve looked at each part of the <code class="literal">describe-paths</code> function, let’s review how it works:<a id="IDX-CHP-5-0045" class="indexterm"/><a id="IDX-CHP-5-0046" class="indexterm"/><a id="IDX-CHP-5-0047" class="indexterm"/><a id="IDX-CHP-5-0048" class="indexterm"/><a id="IDX-CHP-5-0049" class="indexterm"/><a id="IDX-CHP-5-0050" class="indexterm"/></p><a id="I_programlisting2_d1e5545"/><pre class="programlisting">(defun describe-paths (location edges)
  (apply #'append (mapcar #'describe-path (cdr (assoc location edges)))))</pre><p>The function takes two parameters: the current player’s location, as well as an alist of edges/paths for the game map. First, it uses <code class="literal">assoc</code> to look up the correct location from the edge alist. Since <code class="literal">assoc</code> returns both the key and the value from the alist, we call <code class="literal">cdr</code> to retrieve only the value. Next, we use <code class="literal">mapcar</code> to map the <code class="literal">describe-path</code> function against each edge that we found. Finally, we concatenate the lists for describing all the paths into one long list by applying <code class="literal">append</code> against the list.</p><p>The programming style used by <code class="literal">describe-path</code> is very typical for Lisp code. It involves passing along a complicated chunk of data and manipulating it in several steps, often using higher-order functions. To become a proficient Lisp programmer, you should try to get comfortable reading code written in this way.</p></div></div></div>
<div class="sect1" title="Describing Objects at a Specific Location"><div class="titlepage"><div><div><h1 class="title"><a id="describing_objects_at_a_specific_locatio"/>Describing Objects at a Specific Location</h1></div></div></div><p>To create the final piece of code to help us visualize our game world, we need to describe the objects on the floor at a given location, which a player can pick up and use.</p><div class="sect2" title="Listing Visible Objects"><div class="titlepage"><div><div><h2 class="title"><a id="listing_visible_objects"/>Listing Visible Objects</h2></div></div></div><p>To do so, we first create a list of the objects:</p><a id="I_programlisting2_d1e5584"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter *objects* '(whiskey bucket frog chain))</code></strong>
*OBJECTS*</pre><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e5590"/><img src="httpatomoreillycomsourcenostarchimages780738.png.jpg" alt="image with no caption"/></div></div><p>We can also create a second variable, <code class="literal">*object-locations*</code>, to track the location of each object in the form of an alist:</p><a id="I_programlisting2_d1e5600"/><pre class="programlisting">(defparameter *object-locations* '((whiskey living-room)
                                   (bucket living-room)
                                   (chain garden)
                                   (frog garden)))</pre><p>Next, we write a function that lists the objects visible from a given location:<a id="IDX-CHP-5-0051" class="indexterm"/><a id="IDX-CHP-5-0052" class="indexterm"/><a id="IDX-CHP-5-0053" class="indexterm"/><a id="IDX-CHP-5-0054" class="indexterm"/><a id="IDX-CHP-5-0055" class="indexterm"/><a id="IDX-CHP-5-0056" class="indexterm"/><a id="IDX-CHP-5-0057" class="indexterm"/><a id="IDX-CHP-5-0058" class="indexterm"/></p><a id="I_programlisting2_d1e5632"/><pre class="programlisting">(defun objects-at (loc objs obj-locs)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (labels ((at-loc-p (obj)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>              (eq (cadr (assoc obj obj-locs)) loc)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>     (remove-if-not #'at-loc-p objs)))</pre><p>This <code class="literal">objects-at</code> function declares a new function named <code class="literal">at-loc-p</code> using the <code class="literal">labels</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e5663"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. (Remember that the <code class="literal">labels</code> function allows you to define functions locally.) Since the <code class="literal">at-loc-p</code> function won’t be used elsewhere, we can just declare it directly within <code class="literal">objects-at</code>, hiding it from the rest of the code in our program.</p><p>The <code class="literal">at-loc-p</code> function takes the symbol for an object and returns <code class="literal">t</code> or <code class="literal">nil</code>, depending on whether that object exists at the location <code class="literal">loc</code>. It does this by looking up the object in the <code class="literal">obj-locs</code> alist. Then, it uses <code class="literal">eq</code> to see whether the location it finds matches the location in question <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e5700"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.</p><p>Why did we name this function <code class="literal">at-loc-p</code>? When a function returns <code class="literal">nil</code> or a truth value, it’s a Common Lisp convention to append a <code class="literal">p</code> to the end of that function’s name. For instance, you can check that the number 5 is odd by calling <code class="literal">(oddp 5)</code>. Such true/false functions are called <span class="emphasis"><em>predicates</em></span>, which is why we use the letter <code class="literal">p</code>.<a id="IDX-CHP-5-0059" class="indexterm"/><a id="IDX-CHP-5-0060" class="indexterm"/></p><p>The <code class="literal">remove-if-not</code> function in the last line of the listing <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e5739"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, as you might expect, removes all things from a list for which a passed-in function (in this case, <code class="literal">at-loc-p</code>) doesn’t return true. Essentially, it returns a filtered list of objects consisting of those items for which <code class="literal">at-loc-p</code> is true.</p><p>Here’s what <code class="literal">object-at</code> looks like in action:</p><a id="I_programlisting2_d1e5756"/><pre class="programlisting">&gt; <strong class="userinput"><code>(objects-at 'living-room *objects* *object-locations*)</code></strong>
(WHISKEY BUCKET)</pre></div><div class="sect2" title="Describing Visible Objects"><div class="titlepage"><div><div><h2 class="title"><a id="describing_visible_objects"/>Describing Visible Objects</h2></div></div></div><p>Now we can write a function to describe the objects visible at a given location:</p><a id="I_programlisting2_d1e5766"/><pre class="programlisting">(defun describe-objects (loc objs obj-loc)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>  (labels ((describe-obj (obj)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>               `(you see a ,obj on the floor.)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>    (apply #'append (mapcar #'describe-obj (objects-at loc objs obj-loc)))))</pre><p>In this listing, <code class="literal">describe-objects</code> first creates the <code class="literal">describe-obj</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e5794"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. This function generates a pretty sentence stating that a given object is on the floor, using quasiquoting <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e5800"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. The main part of the function consists of calling <code class="literal">objects-at</code> to find the objects at the current location, mapping <code class="literal">describe-obj</code> across this list of objects, and finally appending the descriptions into a single list <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e5813"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.</p><p>Let’s try running <code class="literal">describe-objects</code>:<a id="IDX-CHP-5-0061" class="indexterm"/></p><a id="I_programlisting2_d1e5829"/><pre class="programlisting">&gt; <strong class="userinput"><code>(describe-objects 'living-room *objects* *object-locations*)</code></strong>
(YOU SEE A WHISKEY ON THE FLOOR. YOU SEE A BUCKET ON THE FLOOR)</pre><p>Perfect!</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e5837"/><img src="httpatomoreillycomsourcenostarchimages783048.png.jpg" alt="image with no caption"/></div></div></div></div>
<div class="sect1" title="Describing It All"><div class="titlepage"><div><div><h1 class="title"><a id="describing_it_all"/>Describing It All</h1></div></div></div><p>Now we’ll tie all of these description functions into one easy command called <code class="literal">look</code>. Because this will be the actual command players can enter to look around them in the game, <code class="literal">look</code> will need to know a player’s current location. So, we need a variable to track the player’s current position. Let’s call it <code class="literal">*location*</code>:</p><a id="I_programlisting2_d1e5856"/><pre class="programlisting">(defparameter *location* 'living-room)</pre><p>Because the <code class="literal">*location*</code> value is initialized to the <code class="literal">living-room</code> symbol, which occurs at the very start of the game, players will find themselves in the living room of the wizard’s house. At this point, we can write a <code class="literal">look</code> function to describe everything we need by having it call all of our descriptor functions:</p><a id="I_programlisting2_d1e5869"/><pre class="programlisting">(defun look ()
  (append (describe-location *location* *nodes*)
          (describe-paths *location* *edges*)
          (describe-objects *location* *objects* *object-locations*)))</pre><p>Since the <code class="literal">look</code> function uses global variable names (such as <code class="literal">*location*</code>, <code class="literal">*nodes*</code>, and so on), the player won’t need to pass in any funky values in order to look out at the world. However, this also means that the <code class="literal">look</code> function is not in the functional programming style, because functions in the functional programming style reference only parameters or variables declared in the function itself. <code class="literal">*location*</code> and its ilk are global variables, so the <code class="literal">look</code> function doesn’t hold up muster.<a id="IDX-CHP-5-0062" class="indexterm"/><a id="IDX-CHP-5-0063" class="indexterm"/></p><p>Since the player’s location changes as the game progresses, <code class="literal">look</code> will do <span class="emphasis"><em>different things at different times</em></span> in the game. In other words, the things you see when looking around will change depending on your location. In contrast, a function in the functional programming style always returns the same result, as long as the same values are given as parameters. The earlier functions we created, such as <code class="literal">describe-location</code>, <code class="literal">describe-paths</code>, and <code class="literal">describe-objects</code>, always return the same thing, no matter when they are called, <span class="emphasis"><em>as long as their parameters are kept the same</em></span>.</p><p>Now here’s what we see when we use <code class="literal">look</code>:</p><a id="I_programlisting2_d1e5926"/><pre class="programlisting">&gt; <strong class="userinput"><code>(look)</code></strong>
(YOU ARE IN THE LIVING-ROOM OF A WIZARD’S HOUSE.
THERE IS A WIZARD SNORING LOUDLY ON THE COUCH.
THERE IS A DOOR GOING WEST FROM HERE.
THERE IS A LADDER GOING UPSTAIRS FROM HERE.
YOU SEE A WHISKEY ON THE FLOOR.
YOU SEE A BUCKET ON THE FLOOR)</pre><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e5932"/><img src="httpatomoreillycomsourcenostarchimages781300.png.jpg" alt="image with no caption"/></div></div></div>
<div class="sect1" title="Walking Around in Our World"><div class="titlepage"><div><div><h1 class="title"><a id="walking_around_in_our_world"/>Walking Around in Our World</h1></div></div></div><p>Now that we can see things in our world, let’s write some code so that we can walk around. The <code class="literal">walk</code> function (not in the functional style) takes a direction and lets us walk there:<a id="IDX-CHP-5-0064" class="indexterm"/><a id="IDX-CHP-5-0065" class="indexterm"/><a id="IDX-CHP-5-0066" class="indexterm"/><a id="IDX-CHP-5-0067" class="indexterm"/><a id="IDX-CHP-5-0068" class="indexterm"/></p><a id="I_programlisting2_d1e5965"/><pre class="programlisting">(defun walk (direction)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>  (let ((next (find direction
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>                    (cdr (assoc *location* *edges*))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>                    :key #'cadr)))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>  (if next
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>      (progn (setf *location* (car next))
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>             (look))
<img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/>      '(you cannot go that way.))))</pre><p>First, this function looks up the available walking paths in the <code class="literal">*edges*</code> table, using the current location <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6015"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. This is used by the <code class="literal">find</code> function to locate the path marked with the appropriate direction <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6024"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. (<code class="literal">find</code> searches a list for an item, then returns that found item.) The <code class="literal">direction</code> (such as <code class="literal">west</code>, <code class="literal">upstairs</code>, and so on) will be in the <code class="literal">cadr</code> of each path, so we need to tell <code class="literal">find</code> to match the <code class="literal">direction</code> against the <code class="literal">cadr</code> of all the paths in the list.</p><p>We can do this by passing <code class="literal">find</code> a <span class="emphasis"><em>keyword parameter</em></span> <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6064"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. In Common Lisp, many functions (such as <code class="literal">find</code>) have built-in features that can be accessed by passing in special parameters at the end of the function call. For instance, the following code finds the first item in a list that has the symbol <code class="literal">y</code> in the <code class="literal">cadr</code> location:</p><a id="I_programlisting2_d1e6080"/><pre class="programlisting">&gt; <strong class="userinput"><code>(find 'y '((5 x) (3 y) (7 z)) :key #'cadr)</code></strong>
(3 Y)</pre><p>A keyword parameter has two parts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The first is the name (in this case <code class="literal">:key</code>), which begins with a colon. (We’ll discuss the meaning of this colon in more detail in <a class="xref" href="ch08.html" title="Chapter 7. Going Beyond Basic Lists">Chapter 7</a>.)</p></li><li class="listitem"><p>The second is the value, which in this case is <code class="literal">#'cadr</code>.</p></li></ul></div><p>We use keyword parameters the same way in our <code class="literal">walk</code> function to find the proper path based on the given direction.</p><p>Once we have the correct path, we store the result in the variable <code class="literal">next</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6112"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. The <code class="literal">if</code> expression then checks whether <code class="literal">next</code> has a value <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6124"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span> (the <code class="literal">next</code> variable isn’t <code class="literal">nil</code>). If <code class="literal">next</code> has a value, <code class="literal">if</code> adjusts the player’s position because this is a valid direction <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6143"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>. The call to <code class="literal">look</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6153"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span> retrieves the description for the new location and returns it as a value. If the player chooses an invalid direction, <code class="literal">look</code> will generate an admonishment instead of a new description <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6162"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>.</p><p>Here’s what our <code class="literal">walk</code> function looks like now:<a id="IDX-CHP-5-0069" class="indexterm"/><a id="IDX-CHP-5-0070" class="indexterm"/><a id="IDX-CHP-5-0071" class="indexterm"/><a id="IDX-CHP-5-0072" class="indexterm"/><a id="IDX-CHP-5-0073" class="indexterm"/></p><a id="I_programlisting2_d1e6193"/><pre class="programlisting">&gt; <strong class="userinput"><code>(walk 'west)</code></strong>
(YOU ARE IN A BEAUTIFUL GARDEN.
THERE IS A WELL IN FRONT OF YOU.
THERE IS A DOOR GOING EAST FROM HERE.
YOU SEE A CHAIN ON THE FLOOR.
YOU SEE A FROG ON THE FLOOR.)</pre><p>There’s a quote in front of the direction, since the direction name needs to be written in data mode. It’s kind of awkward to force a player to put a quote in a game command, but the interface we are creating now is intended for easy debugging and development. Heck, it’s almost not even worth calling an “interface,” since we just enter the game commands directly into the REPL. In the next chapter, we’ll create a much nicer interface using a custom REPL designed for playing text games that will take care of this wart.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>You could use Lisp <span class="emphasis"><em>macros</em></span> to create a command in a vanilla Lisp REPL that doesn’t require the quote in front of the direction, so that you could just write <code class="literal">(walk west)</code>, for instance. You’ll learn more about macros in <a class="xref" href="ch18.html" title="Chapter 16. The Magic of Lisp Macros">Chapter 16</a>.<a id="IDX-CHP-5-0074" class="indexterm"/></p></div></div>
<div class="sect1" title="Picking Up Objects"><div class="titlepage"><div><div><h1 class="title"><a id="picking_up_objects"/>Picking Up Objects</h1></div></div></div><p>Next, let’s create a command to pick up objects in our world. To do so, we modify the variable <code class="literal">*object-locations*</code> that we’re using to track the location of objects:</p><a id="I_programlisting2_d1e6222"/><pre class="programlisting">(defun pickup (object)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>  (cond ((member object
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>                 (objects-at *location* *objects* *object-locations*))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>         (push (list object 'body) *object-locations*)
           `(you are now carrying the ,object))
          (t '(you cannot get that.))))</pre><p>The <code class="literal">pickup</code> function uses the <code class="literal">member</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6250"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> function to see if the <code class="literal">object</code> is indeed on the floor of the current location. (The <code class="literal">member</code> function checks to see if a particular item is found in a list of items.) We use the <code class="literal">objects-at</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6266"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> to generate the lists of objects at the current location.</p><p>If the object is at the current location, we use the push command <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6274"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> to push a new item onto the <code class="literal">*object-locations*</code> list, consisting of the item and its new location. The new location will just be <code class="literal">body</code>, for the player’s body.</p><p>The <code class="literal">push</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e6291"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> simply adds a new item to the front of a list variable’s list. For example, the following example adds the number <code class="literal">7</code> to the list <code class="literal">1 2 3</code>:</p><a id="I_programlisting2_d1e6303"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter *foo* '(1 2 3))</code></strong>
*FOO*
&gt; <strong class="userinput"><code>(push 7 *foo*)</code></strong>
(7 1 2 3)
&gt; <strong class="userinput"><code>*foo*</code></strong>
(7 1 2 3)</pre><p>This <code class="literal">push</code> command is basically a convenience function built on top of <code class="literal">setf</code>. For example, we could have replaced the preceding <code class="literal">push</code> command with <code class="literal">(setf *foo* (cons 7 *foo*))</code> and obtained the same result. It’s just easier to use <code class="literal">push</code>.<a id="IDX-CHP-5-0075" class="indexterm"/><a id="IDX-CHP-5-0076" class="indexterm"/><a id="IDX-CHP-5-0077" class="indexterm"/><a id="IDX-CHP-5-0078" class="indexterm"/><a id="IDX-CHP-5-0079" class="indexterm"/></p><p>Pushing a new location for an object onto our <code class="literal">*object-locations*</code> alist does seem a bit odd. Since we’re never removing old locations for objects, just pushing new ones, it means that <code class="literal">*object-locations*</code> may contain multiple entries for a single object, and that this list now has two stored locations for the object in question. Fortunately, the <code class="literal">assoc</code> command, which we use to find objects in a given location (within the <code class="literal">objects-at</code> command), always returns the first item it finds in a list. Therefore, using the <code class="literal">push</code> command makes the <code class="literal">assoc</code> command behave as if the value in the list for a given key has been replaced altogether.</p><p>Using the <code class="literal">push</code> and <code class="literal">assoc</code> commands together in this way allows us to pretend that values in an alist are changing, while still preserving old values. Old values are simply suppressed by newer values, thus preserving a history of all old values. The <code class="literal">push</code>/<code class="literal">assoc</code> idiom is a common technique used by Lispers.</p><p>Now let’s walk back to the living room and try to pick up an object:</p><a id="I_programlisting2_d1e6389"/><pre class="programlisting">&gt; <strong class="userinput"><code>(walk 'east)</code></strong>
(YOU ARE IN THE LIVING-ROOM OF A WIZARDS HOUSE. THERE IS A WIZARD SNORING
 LOUDLY ON THE COUCH. THERE IS A DOOR GOING WEST FROM HERE. THERE IS A LADDER
 GOING UPSTAIRS FROM HERE. YOU SEE A WHISKEY ON THE FLOOR. YOU SEE A BUCKET ON
 THE FLOOR.)
&gt; <strong class="userinput"><code>(pickup 'whiskey)</code></strong>
(YOU ARE NOW CARRYING THE WHISKEY)</pre><p>It worked. We’re carrying the whiskey, which means that we can now pick up things in our world!</p></div>
<div class="sect1" title="Checking Our Inventory"><div class="titlepage"><div><div><h1 class="title"><a id="checking_our_inventory"/>Checking Our Inventory</h1></div></div></div><p>Finally, let’s create a function that lets players see an inventory of objects they are carrying:</p><a id="I_programlisting2_d1e6404"/><pre class="programlisting">(defun inventory ()
  (cons 'items- (objects-at 'body *objects* *object-locations*)))</pre><p>This inventory function uses the <code class="literal">objects-at</code> function to retrieve a list of objects at a requested location. What location does it search for? If you remember, when an object was picked up by the player, we changed its location to <code class="literal">'body</code>: This is the location we now use to query.<a id="IDX-CHP-5-0080" class="indexterm"/></p><p>Let’s try out this <code class="literal">inventory</code> function:</p><a id="I_programlisting2_d1e6422"/><pre class="programlisting">&gt; <strong class="userinput"><code>(inventory)</code></strong>
(ITEMS- WHISKEY)</pre><p>As you can see, we are carrying only one item right now: the whiskey bottle we just picked up.</p><p>There you have it! We now have a basic engine for a text adventure game. We can look around the world with <code class="literal">look</code>; walk between places with <code class="literal">walk</code>; pick up objects with <code class="literal">pickup</code>; and check our inventory with <code class="literal">inventory</code>.</p><p>Of course, we don’t really have much of a game, since we can’t <span class="emphasis"><em>do</em></span> anything with the objects we find. We’ll add a mechanism for actually manipulating objects in <a class="xref" href="ch19.html" title="Chapter 17. Domain-Specific Languages">Chapter 17</a>. In the next chapter, we’ll focus on improving our game’s user interface. Even though the REPL is perfect for prototyping our game, adding a custom text game interface will make the game play more seamless for the player.</p></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id4"/>What You've Learned</h1></div></div></div><p>In this chapter, we put together a simple engine for a text adventure game. Along the way, you learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A game world can be represented by a mathematical graph, consisting of <span class="emphasis"><em>nodes</em></span> for the places the player can visit and <span class="emphasis"><em>edges</em></span> for the paths between these places.</p></li><li class="listitem"><p>You can store these nodes in an <span class="emphasis"><em>association list</em></span> (<span class="emphasis"><em>alist</em></span>) called <code class="literal">*nodes*</code>. This <span class="emphasis"><em>alist</em></span> allows you to look up properties of a node/place by using its name. In the case of our game, the property we’re storing is a description of each node/place.</p></li><li class="listitem"><p>You use the assoc function to look up a key (location name in our example) in an alist.</p></li><li class="listitem"><p><span class="emphasis"><em>Quasiquoting</em></span> is a technique that allows you to insert small bits of computer code into larger pieces of data.</p></li><li class="listitem"><p>Some Lisp functions accept other functions as arguments. These are called <span class="emphasis"><em>higher-order functions</em></span>. The <code class="literal">mapcar</code> function is the most popular higher-order function in Common Lisp.</p></li><li class="listitem"><p>To replace a value from an alist, you <code class="literal">push</code> new items onto the list. Only the most recent value will be reported by the <code class="literal">assoc</code> function.</p></li></ul></div></div>
<div class="chapter" title="Chapter&#xA0;6.&#xA0;Interacting with the World: Reading and Printing in Lisp"><div class="titlepage"><div><div><h1 class="title"><a id="interacting_with_the_world_colon_reading"/>Chapter 6. Interacting with the World: Reading and Printing in Lisp</h1></div></div></div><p>So far, we haven’t written any code that directly interacts with the outside world. Instead, all the results generated by commands are just returned as values, which we can see by calling functions from our Lisp REPL.</p><p>However, code can’t just spend its whole life sitting in a black box. At some point, it’s going to need to interact with the world, so it will need a user interface. Luckily, Lisp has much to offer to help you create user interfaces. There are many graphical user interface libraries for different flavors of Common Lisp, as well as libraries for building web interfaces. In fact, we’ll be building our own toy web interface in <a class="xref" href="ch14.html" title="Chapter 13. Let's Create a Web Server!">Chapter 13</a>.<a id="IDX-CHP-6-0001" class="indexterm"/></p><p>In this chapter, we’ll focus on the most basic of all user interfaces, the <span class="emphasis"><em>command-line interface</em></span>.<a id="IDX-CHP-6-0002" class="indexterm"/><a id="IDX-CHP-6-0003" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e6532"/><img src="httpatomoreillycomsourcenostarchimages783418.png" alt="image with no caption"/></div></div><div class="sect1" title="Printing and Reading Text"><div class="titlepage"><div><div><h1 class="title"><a id="printing_and_reading_text"/>Printing and Reading Text</h1></div></div></div><p>For a command-line interface, we need commands that can directly print text from the screen and read in text entered by the user. The two commands that do this are, appropriately enough, <code class="literal">print</code> and <code class="literal">read</code>. As you might expect by now, there is a lot of symmetry between these two commands.<a id="IDX-CHP-6-0004" class="indexterm"/><a id="IDX-CHP-6-0005" class="indexterm"/><a id="IDX-CHP-6-0006" class="indexterm"/><a id="IDX-CHP-6-0007" class="indexterm"/><a id="IDX-CHP-6-0008" class="indexterm"/></p><div class="sect2" title="Printing to the Screen"><div class="titlepage"><div><div><h2 class="title"><a id="printing_to_the_screen"/>Printing to the Screen</h2></div></div></div><p>The <code class="literal">print</code> function simply lets you print stuff to the console:</p><a id="I_programlisting3_d1e6579"/><pre class="programlisting">&gt; <strong class="userinput"><code>(print "foo")</code></strong>

<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> "foo"
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> "foo"</pre><p>Don’t get confused by the fact that calling the <code class="literal">print</code> function caused <code class="literal">"foo"</code> to be printed twice. The first <code class="literal">"foo"</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e6607"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> is what the <code class="literal">print</code> function <span class="emphasis"><em>actually printed</em></span>. The second <code class="literal">"foo"</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e6623"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> is there because, as you know, the REPL always prints the value of any expression that is entered. It so happens that the value of <code class="literal">(print "foo")</code> is <code class="literal">"foo"</code>, causing the word to be shown twice. In the examples that follow in this chapter, I’ll typically omit this extra final value printed by the REPL, just to avoid confusion.</p><p>The <code class="literal">print</code> function is an easy way to print a Lisp value to the screen. However, advanced Lispers often favor a related function called <code class="literal">prin1</code>. To understand the difference, let’s try both of these functions out in the REPL:<a id="IDX-CHP-6-0009" class="indexterm"/><a id="IDX-CHP-6-0010" class="indexterm"/></p><a id="I_programlisting3_d1e6649"/><pre class="programlisting">&gt; <strong class="userinput"><code>(progn (print "this")</code></strong>
         <strong class="userinput"><code>(print "is")</code></strong>
         <strong class="userinput"><code>(print "a")</code></strong>
         <strong class="userinput"><code>(print "test"))</code></strong>

"this"
"is"
"a"
"test"</pre><p>The <code class="literal">print</code> function causes each item to be printed on a separate line. Now, let’s try <code class="literal">prin1</code>:</p><a id="I_programlisting3_d1e6671"/><pre class="programlisting">&gt; <strong class="userinput"><code>(progn (prin1 "this")</code></strong>
         <strong class="userinput"><code>(prin1 "is")</code></strong>
         <strong class="userinput"><code>(prin1 "a")</code></strong>
         <strong class="userinput"><code>(prin1 "test"))</code></strong>
"this""is""a""test"</pre><p>As you can see, <code class="literal">prin1</code> does not put the printed items on separate lines. To be precise, the <code class="literal">print</code> and <code class="literal">prin1</code> commands are the same in every way, except that <code class="literal">print</code> will start a new line before printing a value. Additionally, print places a space character at the end of the printed value.<a id="IDX-CHP-6-0011" class="indexterm"/></p><p>Because <code class="literal">prin1</code> does less, it is really a simpler, more fundamental function. It is more flexible and, therefore, is commonly used in more serious Lisp code. We’ll use the <code class="literal">print</code> function more frequently in this book, but you should be aware of the <code class="literal">prin1</code> command, as well.</p></div><div class="sect2" title="Saying Hello to the User"><div class="titlepage"><div><div><h2 class="title"><a id="saying_hello_to_the_user"/>Saying Hello to the User</h2></div></div></div><p>The following example is a simple function, <code class="literal">say-hello</code>, that you can call from your Lisp prompt. It asks users for their name and responds with a greeting. <span class="emphasis"><em>When you run the program, be sure to type quotes around your name, even if this may seem odd</em></span>.</p><a id="I_programlisting3_d1e6726"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun say-hello ()</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>      <strong class="userinput"><code>(print "Please type your name:")</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>      <strong class="userinput"><code>(let ((name (read)))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>          <strong class="userinput"><code>(print "Nice to meet you, ")</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>          <strong class="userinput"><code>(print name)))</code></strong>
  SAY-HELLO.
  &gt; <strong class="userinput"><code>(say-hello)</code></strong>
  "Please type your name:" <strong class="userinput"><code>"bob"</code></strong>
  "Nice to meet you,"
  "bob"</pre><p>In the first line of the <code class="literal">say-hello</code> function, we print a message asking users for their name <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e6779"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Next, we define a local variable called <code class="literal">name</code>, which is set to the value returned by the <code class="literal">read</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e6791"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. The <code class="literal">read</code> function will cause Lisp to wait for the user to type in something at the REPL. Only after the user has typed something in at the prompt and pressed <span class="keycap">enter</span> will the variable <code class="literal">name</code> be set to the result. Once we know the user’s name, a personalized message is printed, greeting the user <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e6807"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e6812"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.<a id="IDX-CHP-6-0012" class="indexterm"/><a id="IDX-CHP-6-0013" class="indexterm"/><a id="IDX-CHP-6-0014" class="indexterm"/></p><p>As you can see from this simple function, the <code class="literal">print</code> and <code class="literal">read</code> functions do (almost) exactly what you would expect. The <code class="literal">print</code> function prints something on the screen. The <code class="literal">read</code> function lets the user enter something into the program. However, there is one glaring idiosyncrasy in these functions: Every value displayed and entered is surrounded by quotation marks.</p></div><div class="sect2" title="Starting with print and read"><div class="titlepage"><div><div><h2 class="title"><a id="starting_with_print_and_read"/>Starting with print and read</h2></div></div></div><p>When you need to print something on the screen, you should first think of the <code class="literal">print</code> command. If you need to read something in, you should first think of the <code class="literal">read</code> command. Other printing commands let you create the previous example without having superfluous quotes, but whenever you have an input or output task in Lisp, you should ask yourself, “Can <code class="literal">print</code> or <code class="literal">read</code> do the job?” You will save yourself a lot of trouble if you always use these two functions as your starting point.</p><div class="warning" title="Warning"><h3 class="title">Warning</h3><p>The <code class="literal">read</code> command can be dangerous if used in the wrong way. See <a class="xref" href="ch06s05.html" title="The Dangers of read and eval">The Dangers of read and eval</a> in <a class="xref" href="ch06s05.html" title="The Dangers of read and eval">The Dangers of read and eval</a> for details.</p></div><p>The <code class="literal">print</code> and <code class="literal">read</code> functions think about values with the mind of a computer, not the mind of a human. A computer loves having strings of text surrounded by quotes. It doesn’t have a human brain, and consequently, it can’t understand what we mean when we feed it raw textual information. However, if a text fragment is surrounded by quotes, even a dumb old computer can figure out that the value we’re handing it is probably a string of text.</p><p>The <code class="literal">print</code> and <code class="literal">read</code> commands actually take this philosophy to the extreme. Almost any conceivable type of data in Lisp (with the exception of actual functions and some advanced data structures) can be printed and read using these commands, without the slightest bit of loss along the way. You can probably already imagine some scenarios where this feature would be immensely valuable, such as writing some hairy and huge piece of data to a file, and loading it in again at a later date.</p><p>As a simple example, the following code has <span class="emphasis"><em>exactly</em></span> the same design as the previous function, but amazingly, it can read and print a number instead of a string. Notice how the program prints and reads numbers without the use of quotes, since Lisp knows when something is a number just by seeing the number in its raw form.<a id="IDX-CHP-6-0015" class="indexterm"/><a id="IDX-CHP-6-0016" class="indexterm"/><a id="IDX-CHP-6-0017" class="indexterm"/><a id="IDX-CHP-6-0018" class="indexterm"/></p><a id="I_programlisting3_d1e6908"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun add-five ()</code></strong>
      <strong class="userinput"><code>(print "please enter a number:")</code></strong>
      <strong class="userinput"><code>(let ((num (read)))</code></strong>
          <strong class="userinput"><code>(print "When I add five I get")</code></strong>
          <strong class="userinput"><code>(print (+ num 5))))</code></strong>
ADD-FIVE
&gt; <strong class="userinput"><code>(add-five)</code></strong>
"please enter a number:" <strong class="userinput"><code>4</code></strong>
"When I add five I get"
9</pre><p>Let’s look at some more examples of what happens when we use <code class="literal">print</code> to write out values.<a id="IDX-CHP-6-0019" class="indexterm"/></p><a id="I_programlisting3_d1e6942"/><pre class="programlisting"><strong class="userinput"><code>(print '3)</code></strong>     =&gt; 3      <em class="replaceable"><code>An integer</code></em>
<strong class="userinput"><code>(print '3.4)</code></strong>   =&gt; 3.4    <em class="replaceable"><code>A float</code></em>
<strong class="userinput"><code>(print 'foo)</code></strong>   =&gt; FOO
    <em class="replaceable"><code>A symbol. It may be printed in all caps, since Common</code></em>
                          <em class="replaceable"><code>Lisp symbols are blind to letter case.</code></em>
<strong class="userinput"><code>(print '"foo")</code></strong> =&gt; "foo"  <em class="replaceable"><code>A string</code></em>
<strong class="userinput"><code>(print '#\a)</code></strong>   =&gt; #\a    <em class="replaceable"><code>A character</code></em></pre><p>These examples are all really boring, since <code class="literal">print</code> pretty much just prints out exactly what we put in. Note that we put an explicit quote on the front of each value. It could be omitted and would be implicit in all cases but the symbol name, since a symbol can also refer to functions.</p><p>The last example shows how literal characters are entered in Lisp. To create a Lisp character, just place the <code class="literal">#\</code> symbols in front of the actual character. Lisp also has special literals defined for nonvisible characters. The most important for everyday use are <code class="literal">#\newline</code>, <code class="literal">#\tab</code>, and <code class="literal">#\space</code>.<a id="IDX-CHP-6-0020" class="indexterm"/><a id="IDX-CHP-6-0021" class="indexterm"/><a id="IDX-CHP-6-0022" class="indexterm"/><a id="IDX-CHP-6-0023" class="indexterm"/><a id="IDX-CHP-6-0024" class="indexterm"/><a id="IDX-CHP-6-0025" class="indexterm"/><a id="IDX-CHP-6-0026" class="indexterm"/></p><p>A table of output from the <code class="literal">read</code> function would look just as boring as this table for <code class="literal">print</code>, in the same symmetrical way.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>In the examples above I stated that Common Lisp symbols are blind to letter case. While this is true for most strings, it is in fact possible to create case-sensitive symbols by surrounding the symbol with the vertical pipe <code class="literal">|</code>. So the symbol <code class="literal">|CaseSensitiveSymbol|</code> will retain its case. Symbols surrounded by vertical pipes can even contain punctuation. Hence <code class="literal">|even this is a legal Lisp symbol!|</code></p></div></div><div class="sect2" title="Reading and Printing Stuff the Way Humans Like It"><div class="titlepage"><div><div><h2 class="title"><a id="reading_and_printing_stuff_the_way_human"/>Reading and Printing Stuff the Way Humans Like It</h2></div></div></div><p>Of course, our initial little <code class="literal">say-hello</code> function does a pretty awful job of greeting people, even if it has some interesting properties. It would be much better if we had more functions that could make it friendlier for humans. Actually, we can create a (very symmetrical) little table that summarizes what we would like:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e7046"/><img src="httpatomoreillycomsourcenostarchimages782488.png" alt="image with no caption"/></div></div><p>As you can see, Lisp has a command that can print pieces of data in a way that is appealing to humans. The princ function can take any piece of Lisp data, and it tries to print that data in a way humans would prefer. It will do the basic things you might expect: leave off the quotes on a string, print characters in their raw form, and so on. Here are some examples:<a id="IDX-CHP-6-0027" class="indexterm"/></p><a id="I_programlisting3_d1e7056"/><pre class="programlisting"><strong class="userinput"><code>(princ '3)</code></strong>     =&gt; 3
<strong class="userinput"><code>(princ '3.4)</code></strong>   =&gt; 3.4
<strong class="userinput"><code>(princ 'foo)</code></strong>   =&gt; FOO
<strong class="userinput"><code>(princ '"foo")</code></strong> =&gt; foo
<strong class="userinput"><code>(princ '#\a)</code></strong>   =&gt; a</pre><p>Here’s an example of <code class="literal">princ</code>ing a character that has a special meaning:</p><a id="I_programlisting3_d1e7077"/><pre class="programlisting">&gt; <strong class="userinput"><code>(progn (princ "This sentence will be interrupted")</code></strong>
         <strong class="userinput"><code>(princ #\newline)</code></strong>
         <strong class="userinput"><code>(princ "by an annoying newline character."))</code></strong>
This sentence will be interrupted
by an annoying newline character.</pre><p>By its nature, <code class="literal">princ</code> could be used to print any arbitrary output of characters you want. This is fundamentally different from <code class="literal">print</code>. As we’ve discussed, the cool thing about the <code class="literal">print</code> command is that it prints objects in such a way that they can always be “read” back into their internal representation. However, this means <code class="literal">print</code> can’t be used to generate any arbitrary bit of text. On the other hand, <code class="literal">princ</code> can be used to print anything you want.</p><p>Therefore, although <code class="literal">princ</code> can print stuff in a way that humans prefer, it’s a one-way street. Once we’ve printed things with <code class="literal">princ</code>, only a humanlike intelligence could decipher how to change things back into a meaningful, appropriate Lisp data structure. Since computers are too stupid to do this right now, it means our beloved symmetry has been broken.<a id="IDX-CHP-6-0028" class="indexterm"/><a id="IDX-CHP-6-0029" class="indexterm"/><a id="IDX-CHP-6-0030" class="indexterm"/><a id="IDX-CHP-6-0031" class="indexterm"/><a id="IDX-CHP-6-0032" class="indexterm"/></p><p>Of course, we could always cheat and come up with some arbitrary rules for how the computer should interpret what the human enters. An obvious way to do this would be to say to the computer, “Just let the users type in whatever they want until they hit the <span class="keycap">enter</span> key, then treat the whole thing as a string.” The function that does this in Common Lisp is called <code class="literal">read-line</code>. However, it has none of the sophistication of the <code class="literal">read</code>, <code class="literal">print</code>, and <code class="literal">princ</code> functions, since it knows about nothing beyond characters and strings.</p><p>With this new knowledge, we can finally go full circle and create a proper function for greeting someone, without ugly quotes or other oddities:</p><a id="I_programlisting3_d1e7154"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun say-hello ()</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>      <strong class="userinput"><code>(princ "Please type your name:")</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>      <strong class="userinput"><code>(let ((name (read-line)))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>          <strong class="userinput"><code>(princ "Nice to meet you, ")</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>          <strong class="userinput"><code>(princ name)))</code></strong>
  SAY-HELLO
  &gt; <strong class="userinput"><code>(say-hello)</code></strong>
  Please type your name: <strong class="userinput"><code>Bob O'Malley</code></strong>
  Nice to meet you, Bob O'Malley</pre><p>This version of the <code class="literal">say-hello</code> function is similar to our first version. However, when the computer asks users for their name <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7207"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, it now does so without printing quotes around the text string. The same holds true to when we print the greeting <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7213"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7218"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. Also, users can now enter in <span class="emphasis"><em>any</em></span> name (including a name with spaces and quotes), since the <code class="literal">read-line</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7231"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> captures and returns all the text entered until the <span class="keycap">enter</span> key is pressed, without any fuss.</p></div></div></div>
<div class="sect1" title="The Symmetry Between Code and Data in Lisp"><div class="titlepage"><div><div><h1 class="title"><a id="the_symmetry_between_code_and_data_in_li"/>The Symmetry Between Code and Data in Lisp</h1></div></div></div><p>You have seen that Lisp has very elegant and symmetrical facilities for translating raw string data from the outside world and converting it to and from Lisp syntax expressions. But Lisp has an even deeper symmetry. It can treat program code and data interchangeably. A programming language that uses the same data structures to store data and program code is called <span class="emphasis"><em>homoiconic</em></span>.</p><p>You saw an example of homoiconicity in <a class="xref" href="ch03.html" title="Chapter 3. Exploring the Syntax of Lisp Code">Chapter 3</a>, when we discussed code mode and data mode. In that example, we used the quote to change between the two modes:</p><a id="I_programlisting3_d1e7252"/><pre class="programlisting"><strong class="userinput"><code>&gt; '(+ 1 2)</code></strong> ;data mode
(+ 1 2)
<strong class="userinput"><code>&gt; (+ 1 2)</code></strong> ;code mode
3</pre><p>In the previous chapter, we took this concept one step further by using a quasiquote when defining the <code class="literal">describe-path</code> function.<a id="IDX-CHP-6-0033" class="indexterm"/><a id="IDX-CHP-6-0034" class="indexterm"/><a id="IDX-CHP-6-0035" class="indexterm"/><a id="IDX-CHP-6-0036" class="indexterm"/></p><p>But the quoting and quasiquoting facilities in Lisp are somewhat limited in their abilities. What if we generate a piece of Lisp code from scratch somehow and wish to execute it as if it were a piece of code? For example, let’s store a raw chunk of code inside a variable:</p><a id="I_programlisting3_d1e7282"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter *foo* '(+ 1 2))</code></strong>
*FOO*</pre><p>How could we execute the code that’s in the <code class="literal">*foo*</code> variable? We need an even more powerful command to make this possible. This is the <code class="literal">eval</code> command:</p><a id="I_programlisting3_d1e7295"/><pre class="programlisting">&gt; <strong class="userinput"><code>(eval *foo*)</code></strong>
3</pre><p>Because the <code class="literal">eval</code> command is so powerful and yet so simple, it is extremely enticing to beginning Lispers. You want to write a program with self-modifying code? Then <code class="literal">eval</code> will be your best friend. In fact, this is probably the main reason why the artificial intelligence (AI) freaks back in the day loved Lisp so much. Go ahead and try writing some programs that use the <code class="literal">eval</code> command. You’ll find that it’s a lot of fun.</p><p>However, an experienced Lisper will only rarely use <code class="literal">eval</code>. Until you have a few thousand lines of Lisp code under your belt, you really won’t know when it is appropriate to use this extremely powerful command. Often, a beginning Lisper will use the <code class="literal">eval</code> command instead of defining a Lisp macro. We will discuss macros in <a class="xref" href="ch18.html" title="Chapter 16. The Magic of Lisp Macros">Chapter 16</a>.</p><p>The bottom line is that the symmetry of data and code in Lisp pretty much makes Lisp the poster child of homoiconicity. Quoting, quasiquoting, the <code class="literal">eval</code> command, and macros allow you to take advantage of this property in your code.</p><div class="warning" title="Warning"><h3 class="title">Warning</h3><p>Inexperienced use of <code class="literal">eval</code> can pose a security risk. See <a class="xref" href="ch06s05.html" title="The Dangers of read and eval">The Dangers of read and eval</a> in <a class="xref" href="ch06s05.html" title="The Dangers of read and eval">The Dangers of read and eval</a> for more information.</p></div></div>
<div class="sect1" title="Adding a Custom Interface to Our Game Engine"><div class="titlepage"><div><div><h1 class="title"><a id="adding_a_custom_interface_to_our_game_en"/>Adding a Custom Interface to Our Game Engine</h1></div></div></div><p>So far, we’ve been using the Lisp REPL to enter our game commands. It’s amazing how well this works for prototyping our game. But now that you’ve gained an understanding of the basic Common Lisp input and output commands, we can begin to put in place our own custom text game interface, which will be better suited for interacting with the player.<a id="IDX-CHP-6-0037" class="indexterm"/></p><div class="sect2" title="Setting Up a Custom REPL"><div class="titlepage"><div><div><h2 class="title"><a id="setting_up_a_custom_repl"/>Setting Up a Custom REPL</h2></div></div></div><p>Creating your own REPL in Lisp is almost laughably easy. Here’s a simple custom REPL for our game, which lets us call the <code class="literal">look</code> command in exactly the same way as the standard REPL did:<a id="IDX-CHP-6-0038" class="indexterm"/><a id="IDX-CHP-6-0039" class="indexterm"/><a id="IDX-CHP-6-0040" class="indexterm"/><a id="IDX-CHP-6-0041" class="indexterm"/><a id="IDX-CHP-6-0042" class="indexterm"/><a id="IDX-CHP-6-0043" class="indexterm"/></p><a id="I_programlisting3_d1e7377"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun game-repl ()</code></strong>
     <strong class="userinput"><code>(loop (print (eval (read)))))</code></strong>
GAME-REPL
&gt; <strong class="userinput"><code>(game-repl)</code></strong>
<strong class="userinput"><code>(look)</code></strong>

(YOU ARE IN THE LIVING-ROOM. A WIZARD IS SNORING LOUDLY ON THE COUCH. THERE IS
 A DOOR GOING WEST FROM HERE. THERE IS A LADDER GOING UPSTAIRS FROM HERE. YOU
 SEE A WHISKEY ON THE FLOOR.)</pre><p>Stop me if this explanation of <code class="literal">game-repl</code> is confusing: First it <code class="literal">read</code>s a command, then <code class="literal">eval</code>s it, and finally <code class="literal">print</code>s it. The only command you haven’t seen before is <code class="literal">loop</code> (covered in detail in <a class="xref" href="ch11.html" title="Chapter 10. Looping with the loop Command">Chapter 10</a>), which as you might expect, simply loops forever. (In CLISP, you’ll need to hit <span class="keycap">ctrl</span>-C and type <code class="literal">:a</code> to get out of the infinite loop.) As you can see, it’s easy to build your own REPL by simply calling <code class="literal">read</code>, <code class="literal">eval</code>, <code class="literal">print</code>, and <code class="literal">loop</code>.<a id="IDX-CHP-6-0044" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e7434"/><img src="httpatomoreillycomsourcenostarchimages779964.png.jpg" alt="image with no caption"/></div></div><p>Of course, to customize the behavior of our REPL, we’ll want to call our own versions of these functions. Also, we’ll want a way to exit from our game in a more graceful manner. So, let’s redefine <code class="literal">game-repl</code> as follows:<a id="IDX-CHP-6-0045" class="indexterm"/></p><a id="I_programlisting3_d1e7447"/><pre class="programlisting">(defun game-repl ()
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>    (let ((cmd (game-read)))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>        (unless (eq (car cmd) 'quit)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>            (game-print (game-eval cmd))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>            (game-repl))))</pre><p>In this version, we first capture the command the player types using a local variable, <code class="literal">cmd</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7478"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. This way, we can intercept any attempt to call <code class="literal">quit</code> and use it to exit our <code class="literal">game-repl</code>. In other words, we want to continue running our REPL unless the user typed <code class="literal">quit</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7494"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Otherwise, the function <code class="literal">eval</code>s and <code class="literal">print</code>s <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7506"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, but using our custom versions of these functions, which we’ll write shortly. Finally, the <code class="literal">game-repl</code> function calls itself recursively <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7515"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>, causing it to loop back, as long as we had not decided to quit earlier.</p></div><div class="sect2" title="Writing a Custom read Function"><div class="titlepage"><div><div><h2 class="title"><a id="writing_a_custom_read_function"/>Writing a Custom read Function</h2></div></div></div><p>The purpose of our <code class="literal">game-read</code> function is to fix the two annoyances that make the standard Lisp <code class="literal">read</code> function wrong for playing our game:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The standard Lisp <code class="literal">read</code> forces us to put parentheses around our commands. As any old-school text adventure player knows, we should be able to just type <code class="literal">look</code> without any parentheses. To accomplish this, we can just call <code class="literal">read-line</code> and stick in our own parentheses.</p></li><li class="listitem"><p>With <code class="literal">read</code>, we must put a quote in front of any function commands. We should be able to type <code class="literal">walk east</code> without a quote in front of <code class="literal">east</code>. To do this, we’ll stick a quote in front of the parameters after the fact.</p></li></ul></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e7558"/><img src="httpatomoreillycomsourcenostarchimages780882.png.jpg" alt="image with no caption"/></div></div><p>Here’s a definition of <code class="literal">game-read</code> that does both of these things:</p><a id="I_programlisting3_d1e7568"/><pre class="programlisting">(defun game-read ()
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>    (let ((cmd (read-from-string
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>                     (concatenate 'string "(" (read-line) ")"))))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>         (flet ((quote-it (x)
                         (list 'quote x)))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>             (cons (car cmd) (mapcar #'quote-it (cdr cmd))))))</pre><p>The <code class="literal">read-from-string</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7599"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> works just like the <code class="literal">read</code> command, but lets us read a syntax expression (or any other basic Lisp datatype) from a string instead of directly from the console.<a id="IDX-CHP-6-0046" class="indexterm"/><a id="IDX-CHP-6-0047" class="indexterm"/><a id="IDX-CHP-6-0048" class="indexterm"/><a id="IDX-CHP-6-0049" class="indexterm"/><a id="IDX-CHP-6-0050" class="indexterm"/><a id="IDX-CHP-6-0051" class="indexterm"/><a id="IDX-CHP-6-0052" class="indexterm"/><a id="IDX-CHP-6-0053" class="indexterm"/></p><p>The string we use for this is a tweaked version of a string we get from <code class="literal">read-line</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7642"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. We tweak it by adding quotes around it using the <code class="literal">concatenate</code> command, which can be used for concatenating strings together, as well as some parentheses. The result is that the <code class="literal">cmd</code> variable will be set to the player’s requested command and converted into a Lisp syntax expression. For example, if the player types in <code class="literal">walk east</code>, the <code class="literal">cmd</code> variable will be set to the expression <code class="literal">(walk east)</code>, which is a list containing two symbols.</p><p>Next, we define a local function called <code class="literal">quote-it</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7669"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, which we can use to quote any arguments the player has in a command. How exactly does it manage to quote a parameter? Well, it turns out that the single quote is just shorthand for a Lisp command called <code class="literal">quote</code>. This means that <code class="literal">'foo</code> and <code class="literal">(quote foo)</code> are the same. We can quote a raw parameter by simply putting the parameter in a list with the <code class="literal">quote</code> command in front.</p><p>Remember that local functions can be defined with <code class="literal">labels</code> or <code class="literal">flet</code>. Since we are not using any recursion in the <code class="literal">quote-it</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7699"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, we can use the simpler <code class="literal">flet</code> command. The final line in the <code class="literal">game-read</code> function applies <code class="literal">quote-it</code> to every argument in the player’s command. It does this by mapping <code class="literal">quote-it</code> across the <code class="literal">cdr</code> of the <code class="literal">cmd</code> variable <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7724"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span> (and then attaching the first word in the command back on front with <code class="literal">car</code>).</p><p>Let’s try our new function:</p><a id="I_programlisting3_d1e7737"/><pre class="programlisting">&gt; <strong class="userinput"><code>(game-read)</code></strong>
<strong class="userinput"><code>walk east</code></strong>
(WALK 'EAST)</pre><p>As you can see, the <code class="literal">game-read</code> function is able to add parentheses and quotes—just what our game needs!</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Our custom reader has some limitations that a sufficiently boneheaded game player could conceivably bring to the surface. The player could enter a weird string like <code class="literal">"(look"</code>, with mismatched parentheses, and it would cause a Lisp exception in the <code class="literal">game-read</code> command. There’s nothing wrong with this, per se, since the standard <code class="literal">read</code> command will also act strangely when given garbled input. (In this case, it will let you enter another line of input in the hopes that you will eventually supply it with the missing parenthesis.) However, our <code class="literal">game-repl</code> doesn’t handle this situation properly, causing the actual <code class="literal">game-repl</code> to crash. This would be as if you were playing Zork and typed in a command so vile that it took down the Zork game itself. This rare situation could be addressed by having additional exception handling, as discussed in <a class="xref" href="ch14.html" title="Chapter 13. Let's Create a Web Server!">Chapter 13</a>.<a id="IDX-CHP-6-0054" class="indexterm"/></p></div></div><div class="sect2" title="Writing a game-eval Function"><div class="titlepage"><div><div><h2 class="title"><a id="writing_a_game-eval_function"/>Writing a game-eval Function</h2></div></div></div><p>Now that we’ve created a nigh-perfect Lisp reader, let’s think about how we could improve the <code class="literal">eval</code> command. The main problem with using <code class="literal">eval</code> in a game is it allows you to call any Lisp command, even if that command has nothing to do with playing the game. To help protect our program from hackers, we’ll create a <code class="literal">game-eval</code> function that allows only certain commands to be called, as follows:<a id="IDX-CHP-6-0055" class="indexterm"/><a id="IDX-CHP-6-0056" class="indexterm"/><a id="IDX-CHP-6-0057" class="indexterm"/><a id="IDX-CHP-6-0058" class="indexterm"/></p><a id="I_programlisting3_d1e7804"/><pre class="programlisting">(defparameter *allowed-commands* '(look walk pickup inventory))

  (defun game-eval (sexp)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>      (if (member (car sexp) *allowed-commands*)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>          (eval sexp)
          '(i do not know that command.)))</pre><p>The <code class="literal">game-eval</code> function checks if the first word in the entered command is in the list of allowed commands, using the <code class="literal">member</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7826"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. If it is, we then use the standard <code class="literal">eval</code> to execute the player’s command <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e7835"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. By checking that the command called by the player is in the official list, we protect ourselves against any attempts to call malicious commands.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e7842"/><img src="httpatomoreillycomsourcenostarchimages780092.png.jpg" alt="image with no caption"/></div></div><div class="warning" title="Warning"><h3 class="title">Warning</h3><p>Our <code class="literal">game-eval</code> function does not offer 100 percent protection against hacking. See <a class="xref" href="ch06s05.html" title="The Dangers of read and eval">The Dangers of read and eval</a> in <a class="xref" href="ch06s05.html" title="The Dangers of read and eval">The Dangers of read and eval</a> for details.</p></div></div><div class="sect2" title="Writing a game-print Function"><div class="titlepage"><div><div><h2 class="title"><a id="writing_a_game-print_function"/>Writing a game-print Function</h2></div></div></div><p>The final missing piece in our <code class="literal">game-repl</code> system is the <code class="literal">game-print</code> function. Of all the limitations in the Lisp REPL version of our game, one was the most obvious: All the text descriptions printed in the game were in uppercase.</p><p>Last I checked, throughout the current millennium, computers have been able to display both uppercase <span class="emphasis"><em>and</em></span> lowercase characters. By writing our own <code class="literal">game-print</code> function, we can solve this problem.</p><p>Before we step through the <code class="literal">game-print</code> function’s code, let’s look at an example of its output:<a id="IDX-CHP-6-0059" class="indexterm"/><a id="IDX-CHP-6-0060" class="indexterm"/><a id="IDX-CHP-6-0061" class="indexterm"/></p><a id="I_programlisting3_d1e7892"/><pre class="programlisting">&gt; <strong class="userinput"><code>(game-print '(THIS IS A SENTENCE. WHAT ABOUT THIS? PROBABLY.))</code></strong>
This is a sentence. What about this? Probably.</pre><p>As you can see, the <code class="literal">game-print</code> function converts our symbol-based writing into properly capitalized text. By having this function available, we can store the text in our game engine in the most comfortable format possible: lists of symbols. This format makes it easier to manipulate the text. Then, at the point of presentation, we can decorate these symbol lists with presentation details.</p><p>Of course, in this example, the decorations are very simple. All we do is adjust the case. But you can already see some small benefits of separating the presentation details from the data model. For instance, suppose we changed the <code class="literal">describe-path</code> function to write sentences like “Left of here lies a door.” No further changes would be needed; the program would automatically know to capitalize the <span class="emphasis"><em>Left</em></span> at the beginning of the sentence.</p><p>However, the real benefits come into play when you want to use more sophisticated methods of presentation, such as generating HTML code. You might want to incorporate custom semantics for your text game to enhance the appearance of the text, such as changing colors, fonts, and so on. For instance, you could allow your game descriptions to contain phrases such as “You are being attacked by a (red evil demon).” Then you could just catch the keyword <code class="literal">red</code> in the <code class="literal">game-print</code> function to write the enclosed text in red. We will be creating an HTML presentation system similar to this in <a class="xref" href="ch19.html" title="Chapter 17. Domain-Specific Languages">Chapter 17</a>.<a id="IDX-CHP-6-0062" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e7924"/><img src="httpatomoreillycomsourcenostarchimages783352.png.jpg" alt="image with no caption"/></div></div><p>Now we’re ready to look at the <code class="literal">game-print</code> function’s code:</p><a id="I_programlisting3_d1e7934"/><pre class="programlisting">(defun tweak-text (lst caps lit)
   (when lst
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>  (let ((item (car lst))
         (rest (cdr lst)))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (cond ((eq item #\space) (cons item (tweak-text rest caps lit)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>         ((member item '(#\! #\? #\.)) (cons item (tweak-text rest t lit)))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>         ((eq item #\") (tweak-text rest caps (not lit)))
           (lit (cons item (tweak-text rest nil lit)))
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>         ((or caps lit) (cons (char-upcase item) (tweak-text rest nil lit)))
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>         (t (cons (char-downcase item) (tweak-text rest nil nil)))))))

  (defun game-print (lst)
<img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/>   (princ (coerce (tweak-text (coerce (string-trim "() "
<img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/>                                                    (prin1-to-string lst))
                                       'list)
                               t
<img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/>                              nil)
                   'string))
    (fresh-line))</pre><p>The <code class="literal">game-print</code> function and its helper function are a bit more complicated than the other functions we’ve looked at so far. The first important part of the code that is executed is in <code class="literal">game-print</code>, where it converts the symbol list (containing the text whose layout we want to fix) into a string with <code class="literal">prin1-to-string</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8003"/><img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/></span>, one of Lisp’s many <code class="literal">print</code> variants. The <code class="literal">to-string</code> part means this function doesn’t dump the result to the screen, but just returns it as a string. The <code class="literal">1</code> means it will stay on a single line. The standard <code class="literal">print</code> command precedes its output with a newline character and also follows it with a space. The functions <code class="literal">prin1</code> and <code class="literal">prin1-to-string</code> variants don’t add these extra characters.<a id="IDX-CHP-6-0063" class="indexterm"/><a id="IDX-CHP-6-0064" class="indexterm"/><a id="IDX-CHP-6-0065" class="indexterm"/><a id="IDX-CHP-6-0066" class="indexterm"/><a id="IDX-CHP-6-0067" class="indexterm"/></p><p>Next, <code class="literal">game-print</code> converts the string to a list of characters with the <code class="literal">coerce</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8056"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>. By coercing our string into a list, we can reduce the bigger goal of the function into a list-processing problem. This is smack-dab in the Lisp comfort zone. In this case, we’re creating a list of the characters making up the text we want to fix.</p><p>We can now send the data to the list-eater function <code class="literal">tweak-text</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8067"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>. Notice that some of the arguments used in the code of the <code class="literal">game-print</code> function are printed on their own line for clarity. You can easily see which arguments are meant for which commands by looking at the indentation. For instance, the <code class="literal">t</code> and <code class="literal">nil</code> arguments <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8083"/><img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/></span> belong to <code class="literal">tweak-text</code>.</p><p>The <code class="literal">tweak-text</code> function looks at each character in the list and modifies it as needed. At the top of this function, we define two local variables, <code class="literal">item</code> and <code class="literal">rest</code>, which we get by chewing off an item from the front of the sentence we’re tweaking <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8103"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Then, the <code class="literal">tweak-text</code> function uses a <code class="literal">cond</code> to check the character at the top of the list for different conditions <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8116"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.</p><p>The first condition it checks for is whether the character is a space character <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8124"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. If so, it just leaves the space unchanged and processes the next character in the list. If the character is a period, question mark, or exclamation point <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8130"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, we turn on the <code class="literal">cap</code> parameter for the rest of the string (by using the value <code class="literal">t</code> as an argument in the recursive call) to indicate that the next symbol is at the beginning of a sentence and needs a capital letter.</p><p>We also track whether we’ve encountered a quotation mark <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8144"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. We do this because, infrequently, a symbol list is not adequate for encoding English text. Examples include having a comma (commas are not allowed in standard Common Lisp symbols) or product names with nonstandard capitalization. In these cases, we can just fall back on using text strings. Here’s an example:<a id="IDX-CHP-6-0068" class="indexterm"/><a id="IDX-CHP-6-0069" class="indexterm"/><a id="IDX-CHP-6-0070" class="indexterm"/><a id="IDX-CHP-6-0071" class="indexterm"/><a id="IDX-CHP-6-0072" class="indexterm"/><a id="IDX-CHP-6-0073" class="indexterm"/><a id="IDX-CHP-6-0074" class="indexterm"/></p><a id="I_programlisting3_d1e8179"/><pre class="programlisting">&gt; <strong class="userinput"><code>(game-print '(not only does this sentence</code></strong>
<strong class="userinput"><code> have a "comma," it also mentions the "iPad."))</code></strong>
Not only does this sentence have a comma, it also mentions the iPad.</pre><p>Our sample game doesn’t actually need the fallback facility. Nonetheless, this feature allows the <code class="literal">game-print</code> function to handle many basic exceptional text situations that you may encounter if you try to expand the game on your own. We tell the function to treat the capitalization as shown literally by turning on the <code class="literal">lit</code> variable in the recursive call. As long as this value is set, the <code class="literal">tweak-text</code> function prevents the capitalization rules (which start at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8198"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>) from being reached.</p><p>The next thing the <code class="literal">tweak-text</code> function checks is whether the next character is supposed to be capitalized. If it is, we use the <code class="literal">char-upcase</code> function to change the current character to uppercase (if it isn’t already) before processing the next item in the list <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8212"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>.</p><p>If none of the other conditions were met, we know that the current character should be lowercase <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8220"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>, and we can convert it using the <code class="literal">char-downcase</code> function.</p><p>After <code class="literal">tweak-text</code> is finished correcting the text in the character list, the <code class="literal">game-print</code> function coerces it back into a proper string and <code class="literal">princ</code>s it <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e8240"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>. The <code class="literal">fresh-line</code> function at the end of <code class="literal">game-print</code> makes sure that the next item appearing on the screen will start on a fresh line.</p><p>We have now completed the task of printing the original list of symbols to the screen, using a set of decorations appropriate for the needs of an adventure game engine.</p></div></div>
<div class="sect1" title="Trying Out Our Fancy New Game Interface"><div class="titlepage"><div><div><h1 class="title"><a id="trying_out_our_fancy_new_game_interface"/>Trying Out Our Fancy New Game Interface</h1></div></div></div><p>We have now completed all the pieces needed for a custom REPL for our game engine. Simply call the <code class="literal">game-repl</code> function and explore our new game world. Remember that we will be expanding this engine into a full game, with additional commands, in <a class="xref" href="ch19.html" title="Chapter 17. Domain-Specific Languages">Chapter 17</a>.</p><a id="I_programlisting3_d1e8266"/><pre class="programlisting">&gt; <strong class="userinput"><code>(game-repl)</code></strong>
<strong class="userinput"><code>look</code></strong>
You are in the living-room. A wizard is snoring loudly on the couch. There is
 a door going west from here. There is a ladder going upstairs from here. You
 see a whiskey on the floor. You see a bucket on the floor.
<strong class="userinput"><code>walk west</code></strong>
You are in a beautiful garden. There is a well in front of you. There is a
 door going east from here. You see a frog on the floor. You see a chain on
 the floor.
<strong class="userinput"><code>pickup chain</code></strong>
You are now carrying the chain
<strong class="userinput"><code>scratch head</code></strong>
I do not know that command.
<strong class="userinput"><code>pickup chicken</code></strong>
You cannot get that.
<strong class="userinput"><code>walk east</code></strong>
You are in the living-room. A wizard is snoring loudly on the couch. There is
 a door going west from here. There is a ladder going upstairs from here. You
 see a whiskey on the floor. You see a bucket on the floor.
<strong class="userinput"><code>walk upstairs</code></strong>
You are in the attic. There is a giant welding torch in the corner. There is a
 ladder going downstairs from here.
<strong class="userinput"><code>inventory</code></strong>
Items- chain
<strong class="userinput"><code>walk china</code></strong>
You cannot go that way.
<strong class="userinput"><code>walk downstairs</code></strong>
You are in the living-room. A wizard is snoring loudly on the couch. There is
 a door going west from here. There is a ladder going upstairs from here. You
 see a whiskey on the floor. You see a bucket on the floor.
<strong class="userinput"><code>pickup bucket</code></strong>
You are now carrying the bucket
<strong class="userinput"><code>look</code></strong>
You are in the living-room. A wizard is snoring loudly on the couch. There is
 a door going west from here. There is a ladder going upstairs from here. You
 see a whiskey on the floor.
<strong class="userinput"><code>quit</code></strong></pre><p>Success! We now have an extremely flexible text game engine. It can be expanded and debugged within the Lisp REPL. It also has a fully customizable interface to offer the player a seamless text adventure experience. As we put it together, you saw some mind-bending Lisp techniques that let us construct this engine with a minimum of filler code or other overhead.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e8314"/><img src="httpatomoreillycomsourcenostarchimages779944.png.jpg" alt="image with no caption"/></div></div></div>
<div class="sect1" title="The Dangers of read and eval"><div class="titlepage"><div><div><h1 class="title"><a id="the_dangers_of_read_and_eval"/>The Dangers of read and eval</h1></div></div></div><p>We’ve used both the <code class="literal">eval</code> and the <code class="literal">read</code> commands in creating a custom Lisp REPL. These commands are very powerful, but also very dangerous. Using them without taking the proper precautions might allow a hacker to attack your software by running malicious commands.<a id="IDX-CHP-6-0075" class="indexterm"/><a id="IDX-CHP-6-0076" class="indexterm"/><a id="IDX-CHP-6-0077" class="indexterm"/><a id="IDX-CHP-6-0078" class="indexterm"/><a id="IDX-CHP-6-0079" class="indexterm"/><a id="IDX-CHP-6-0080" class="indexterm"/><a id="IDX-CHP-6-0081" class="indexterm"/></p><p>For example, suppose our program needed a function called <code class="literal">format-harddrive</code>. This is <span class="emphasis"><em>not</em></span> a function we would want just any person to have access to, and it could be very dangerous if a hacker somehow tricked our game REPL into calling it.</p><p>The <code class="literal">game-eval</code> function we created earlier in this chapter has some crude safeguards to prevent a player from entering <code class="literal">format-harddrive</code> as a game command. Here’s what happens if we try to run this command in our new game REPL:</p><a id="I_programlisting3_d1e8376"/><pre class="programlisting">&gt; <strong class="userinput"><code>(game-repl)</code></strong>
<strong class="userinput"><code>format-harddrive</code></strong>
I do not know that command.</pre><p>Our <code class="literal">game-eval</code> function will run only commands that are in an approved list. This gives our game a sort of firewall, which lets us access the powers of Lisp to evaluate commands while still preventing the player from hacking the game.</p><p>However, there are also more sophisticated exploits players could try. For instance, they could enter <code class="literal">walk (format-harddrive)</code>. Fortunately, our <code class="literal">game-read</code> function forces all function parameters into data mode by using <code class="literal">quote-it</code>. By using <code class="literal">quote-it</code> in <code class="literal">game-read</code>, the actual code that is executed is <code class="literal">(walk '(format-</code>harddrive)). The quote in front of (<code class="literal">format-hardrive</code>) puts the malicious command into data mode, so nothing bad can happen.</p><p>One attack method that <span class="emphasis"><em>will</em></span> break our program is to use <span class="emphasis"><em>reader macros</em></span>. These are an advanced set of features, built into the Common Lisp <code class="literal">read</code> command, that open another avenue for executing malicious computer code. (Remember that before we use <code class="literal">eval</code> on game commands, they first pass through <code class="literal">read</code>.) An example of a game command that will successfully execute evil code is <code class="literal">walk #.{format-harddrive}</code>.<a id="IDX-CHP-6-0082" class="indexterm"/><a id="IDX-CHP-6-0083" class="indexterm"/></p><p>The bottom line is that you can never be sure that a Lisp program using <code class="literal">eval</code> or <code class="literal">read</code> is completely safe from a hacker. When writing production Lisp code, you should try to avoid these two commands when possible.</p></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id5"/>What You've Learned</h1></div></div></div><p>In this chapter, we created a custom REPL to supercharge our text adventure game. Along the way, you learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The <code class="literal">print</code> and <code class="literal">read</code> functions let you directly communicate with the user through the console. These two functions work in a computer-friendly way.</p></li><li class="listitem"><p>Other input/output functions are not as elegant as <code class="literal">read</code> and <code class="literal">print</code>, but are friendlier for interacting with humans. Examples include <code class="literal">princ</code> and <code class="literal">read-line</code>.</p></li><li class="listitem"><p>A <span class="emphasis"><em>homoiconic</em></span> programming language stores its program code and program data in a similar format. Lisp’s quoting, quasiquoting, <code class="literal">eval</code>, and macro features make it extremely homoiconic.</p></li><li class="listitem"><p>It’s easy to write your own custom REPL.</p></li><li class="listitem"><p>It’s simple to transform your internal Lisp data into the format most suitable for your program’s interface. This makes it easy to separate presentation details from your program’s internal data structures.</p></li></ul></div></div>
<div class="chapter" title="Chapter&#xA0;6.5.&#xA0;lambda: A Function So Important It Deserves Its Own Chapter"><div class="titlepage"><div><div><h1 class="title"><a id="lambda_colon_a_function_so_important_it"/>Chapter 6.5. lambda: A Function So Important It Deserves Its Own Chapter</h1></div></div></div><p>It’s impossible to overstate the importance of the <code class="literal">lambda</code> command in Lisp. In fact, this command is pretty much the entire reason that Lisp exists in the first place.<a id="IDX-CHP-6.5-0001" class="indexterm"/><a id="IDX-CHP-6.5-0002" class="indexterm"/></p><div class="sect1" title="What lambda Does"><div class="titlepage"><div><div><h1 class="title"><a id="what_lambda_does"/>What lambda Does</h1></div></div></div><p>In short, <code class="literal">lambda</code> lets you create a function without giving it a name. For example, let’s say we create a <code class="literal">half</code> function that takes a number and divides it in half. Until now, we’ve written such a function this way:</p><a id="I_programlisting4_d1e8524"/><pre class="programlisting">(defun half (n)
    (/ n 2))</pre><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject4_d1e8527"/><img src="httpatomoreillycomsourcenostarchimages781778.png.jpg" alt="image with no caption"/></div></div><p>It turns out that, in Lisp, functions are actually values that we can view and pass around just as if they were numbers or lists. An experienced Lisp programmer would say that functions are <span class="emphasis"><em>first-class values</em></span> in Lisp. As you saw in <a class="xref" href="ch05.html" title="Chapter 5. Building a Text Game Engine">Chapter 5</a>, you can actually get at the function represented by the word <code class="literal">half</code> by using the function operator:<a id="IDX-CHP-6.5-0003" class="indexterm"/><a id="IDX-CHP-6.5-0004" class="indexterm"/></p><a id="I_programlisting4_d1e8548"/><pre class="programlisting">&gt; <strong class="userinput"><code>#'half</code></strong>
#&lt;FUNCTION HALF ...&gt;</pre><p>The <code class="literal">lambda</code> command just lets you do these same two things in a single step. You can define a function and then get it, without giving your function a name:</p><a id="I_programlisting4_d1e8558"/><pre class="programlisting">&gt; <strong class="userinput"><code>(lambda (n) (/ n 2))</code></strong>
#&lt;FUNCTION :LAMBDA ...&gt;</pre><p>The first parameter to the <code class="literal">lambda</code> command is a parameter list, no different from the parameter list used in <code class="literal">defun</code>. The rest of the parameters are just the commands for the body of the unnamed function.</p><p>Once you have a value representing your unnamed halving function, you can pass it directly to other Common Lisp commands, such as the <code class="literal">mapcar</code> or <code class="literal">apply</code> commands. For instance, we could do the following to elegantly halve all the values in a list:</p><a id="I_programlisting4_d1e8579"/><pre class="programlisting">&gt; <strong class="userinput"><code>(mapcar (lambda (n) (/ n 2)) '(2 4 6))</code></strong>
(1 2 3)</pre><p>Because not all parameters of the <code class="literal">lambda</code> command are evaluated, <code class="literal">lambda</code> itself is not actually a true function. It is something called a <span class="emphasis"><em>macro</em></span>. Remember from <a class="xref" href="ch02.html" title="Chapter 2. Creating Your First Lisp Program">Chapter 2</a> that all parameters to a Lisp function are evaluated before the function itself is evaluated. Macros, on the other hand, have special powers and are allowed to break those rules. You’ll learn more about macros in <a class="xref" href="ch18.html" title="Chapter 16. The Magic of Lisp Macros">Chapter 16</a>.<a id="IDX-CHP-6.5-0005" class="indexterm"/><a id="IDX-CHP-6.5-0006" class="indexterm"/></p><p>Also, to confuse matters a bit, the actual value that <code class="literal">lambda</code> returns is a regular Lisp function—in this case, a function that cuts a number in half. When Lispers talk about lambda functions—which they pretty much do for breakfast, lunch, and dinner—they’re talking about functions created using <code class="literal">lambda</code>. They’re not talking about the <code class="literal">lambda</code> macro itself, which is not a function. Got that?</p><p><code class="literal">lambda</code> lets your programs do very complicated things.</p><p>The <code class="literal">lambda</code> form allows your programming code to take a conceptual leap.</p><p>While most programming languages try to keep the worlds of functions and values separate, Lisp lets you bridge these worlds as desired. For instance, if you want to package up a little ad hoc function and pass it off to another part of your program, <code class="literal">lambda</code> does exactly what you need.</p><p>You will see that most Lisp programs use this command very heavily. The same holds true for the remaining examples in this book.</p></div></div>
<div class="sect1" title="Why lambda Is So Important"><div class="titlepage"><div><div><h1 class="title"><a id="why_lambda_is_so_important"/>Why lambda Is So Important</h1></div></div></div><p>The ability to pass around functions as if they were just plain old pieces of data is incredibly valuable. Once you get used to doing this, you open up all kinds of conceptual possibilities in the design of your programs. Eventually, your programs will start looking very different from programs in more (dare I say) pedestrian languages, such as Java or C. The name for the style of programming that relies heavily on passing functions as values is called higher-order <span class="emphasis"><em>functional programming</em></span>. We will look at this style in more detail in <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>.<a id="IDX-CHP-6.5-0007" class="indexterm"/></p><p>An even more important reason why Lispers go gaga over <code class="literal">lambda</code> is that, as it turns out, in a purely mathematical sense, <code class="literal">lambda</code> is actually the only Lisp command there is!</p><p>Recall that Lisp is unusual among programming languages in that it was derived directly from a mathematical concept called the <span class="emphasis"><em>lambda calculus</em></span>. In short, the lambda calculus is a theoretical programming language that contains only one command: the <code class="literal">lambda</code> command. By having only this single command and using special code transformations, it’s possible to create a fully functioning (though perhaps not practical) programming language.<a id="IDX-CHP-6.5-0008" class="indexterm"/></p><p>The take-home point is that the <code class="literal">lambda</code> special form is the most fundamental command in a Lisp system, and the central concept from which other functions in Lisp derive. In fact, it is the central concept from which the very idea of Lisp itself originated.</p><p>Now that you have a basic understanding of <code class="literal">lambda</code>, you’re ready to tackle some more complicated programming examples that would be hard to write without the anonymous functions this command permits.</p></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id6"/>What You've Learned</h1></div></div></div><p>This short chapter discussed how to create anonymous functions. Here are the main points:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>By using <code class="literal">lambda</code>, you can create a function without needing to give it a name.</p></li><li class="listitem"><p>Many functions in Lisp accept functions as parameters. If you use these functions, you are using a technique called <span class="emphasis"><em>higher-order functional programming</em></span>.</p></li></ul></div></div>
<div class="chapter" title="Chapter&#xA0;7.&#xA0;Going Beyond Basic Lists"><div class="titlepage"><div><div><h1 class="title"><a id="going_beyond_basic_lists"/>Chapter 7. Going Beyond Basic Lists</h1></div></div></div><p>In this chapter, we’ll go beyond basic list concepts. We’ll talk about special kinds of lists, and we’ll write a game that will take list manipulation to a new level.</p><div class="sect1" title="Exotic Lists"><div class="titlepage"><div><div><h1 class="title"><a id="exotic_lists"/>Exotic Lists</h1></div></div></div><p>As you learned in <a class="xref" href="ch03.html" title="Chapter 3. Exploring the Syntax of Lisp Code">Chapter 3</a>, lists in Lisp are built out of cons cells—small data structures that allow you to link together two pieces of data. The right slot in the last cons cell in a list should contain a <code class="literal">nil</code>.<a id="IDX-CHP-7-0001" class="indexterm"/><a id="IDX-CHP-7-0002" class="indexterm"/></p><p>By stringing together several cons cells, you can create a list of any length. For instance, this is how we would use cons cells to create a list of the numbers 1, 2, and 3:</p><a id="I_programlisting5_d1e8721"/><pre class="programlisting">(cons 1 (cons 2 (cons 3 nil)))</pre><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e8724"/><img src="httpatomoreillycomsourcenostarchimages782574.png.jpg" alt="image with no caption"/></div></div><p>Since it’s so cumbersome for humans to think of a chain of cons cells as a list, Lisp has a special, simplified syntax for printing out such lists. You can see this for yourself by evaluating a chain of cons cells in the REPL:<a id="IDX-CHP-7-0003" class="indexterm"/><a id="IDX-CHP-7-0004" class="indexterm"/><a id="IDX-CHP-7-0005" class="indexterm"/></p><a id="I_programlisting5_d1e8742"/><pre class="programlisting">&gt; <strong class="userinput"><code>(cons 1 (cons 2 (cons 3 nil)))</code></strong>
(1 2 3)</pre><p>Lisp uses the simpler list syntax when it parrots our chain back to us in the REPL. It shows our string of cons cells as a list of three items. The important point to remember is that <span class="emphasis"><em>this difference in appearance is entirely superficial</em></span>. No matter how a Lisp list is displayed, fundamentally, it always remains a chain of cons cells.</p><div class="sect2" title="Dotted Lists"><div class="titlepage"><div><div><h2 class="title"><a id="dotted_lists"/>Dotted Lists</h2></div></div></div><p>So, what happens if we deviate from the classic “string of conses” formula? How will a Lisp environment deal with this when printing lists?</p><p>Suppose we try to create a list of the numbers 1, 2, and 3, like this:</p><a id="I_programlisting5_d1e8759"/><pre class="programlisting">(cons 1 (cons 2 3))</pre><p>Here, instead of creating a third cons cell for the third number of our list, we stuff it into the right slot of the previous cell. What would the printed response look like if we were to enter this structure into a Lisp REPL? Let’s try it out:<a id="IDX-CHP-7-0006" class="indexterm"/></p><a id="I_programlisting5_d1e8768"/><pre class="programlisting">&gt; <strong class="userinput"><code>(cons 1 (cons 2 3))</code></strong>
(1 2 . 3)</pre><p>To indicate that the final item in the list wasn’t found in the proper location for a <code class="literal">nil</code>-terminated list, Lisp places a dot in front of this final item. This dot is basically Lisp’s way of saying, “I tried to print this structure you entered using list notation, but the last item in the list didn’t contain the usual <code class="literal">nil</code> I expected; instead, it contained <code class="literal">3</code>.”</p><p>A list in Lisp that ends in something other than a <code class="literal">nil</code> is referred to as a <span class="emphasis"><em>dotted list</em></span>. Dotted lists are kind of an oddity in the Land of Lisp. In and of themselves, they are not that useful a tool for Lisp programming. It would be quite unusual for a Lisp programmer to store data in dotted lists as a regular practice. However, given the pervasiveness of cons cells in Lisp, you will frequently encounter a non-<code class="literal">nil</code> value at the end of a chain of cons cells. That’s why you should become familiar with dotted lists, even if you may never use them directly.</p><p>Another way of thinking about this dot notation is to consider it as simply an alternate syntax for the <code class="literal">cons</code> command, used in data mode. In fact, if we wanted to make life hard for ourselves, we could even create regular, proper lists using the dot notation, like this:</p><a id="I_programlisting5_d1e8800"/><pre class="programlisting">&gt; <strong class="userinput"><code>'(1 . (2 . (3 . nil)))</code></strong>
(1 2 3)</pre><p>Using this line of thinking, the dot appears in a dotted list simply because Lisp is forced to show the final cons cell in order to maintain the consistency of its list-printing mechanism.</p></div><div class="sect2" title="Pairs"><div class="titlepage"><div><div><h2 class="title"><a id="pairs"/>Pairs</h2></div></div></div><p>One common and practical use for dotted lists in Lisp programs is to elegantly represent pairs. For instance, suppose we wanted to represent a pair of the numbers 2 and 3. One way to do this would be to cons together these two numbers:<a id="IDX-CHP-7-0007" class="indexterm"/><a id="IDX-CHP-7-0008" class="indexterm"/></p><a id="I_programlisting5_d1e8820"/><pre class="programlisting">&gt; <strong class="userinput"><code>(cons 2 3)</code></strong>
(2 . 3)</pre><p>Essentially, all we’re doing here is creating a dotted list of length two. As expected, Lisp uses dot notation to display this pair.<a id="IDX-CHP-7-0009" class="indexterm"/><a id="IDX-CHP-7-0010" class="indexterm"/></p><p>Creating pairs in this manner in Lisp is very convenient and efficient. It’s convenient because we can extract members from the pair using the standard <code class="literal">car</code> and <code class="literal">cdr</code> commands. It’s relatively efficient because the Lisp environment needs to allocate only a single cons cell to connect the two items.</p><p>These types of pairs are commonly used in Lisp programs. For instance, you could use them to store the x- and y-coordinates of a point or a key/value pair in a complex data structure. You will see this latter use for pairs when we discuss association lists.</p></div><div class="sect2" title="Circular Lists"><div class="titlepage"><div><div><h2 class="title"><a id="circular_lists"/>Circular Lists</h2></div></div></div><p>Here is the picture we used in <a class="xref" href="ch03.html" title="Chapter 3. Exploring the Syntax of Lisp Code">Chapter 3</a> to illustrate the cons cells that make up the list <code class="literal">'(1 2 3)</code>:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e8856"/><img src="httpatomoreillycomsourcenostarchimages782916.png" alt="image with no caption"/></div></div><p>Now suppose that we created a weird mutant of this list. Let’s have the <code class="literal">cdr</code> of the third cons cell point back to the first cons cell, rather than to <code class="literal">nil</code>:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e8870"/><img src="httpatomoreillycomsourcenostarchimages781690.png" alt="image with no caption"/></div></div><p>Every cons cell in a list theoretically exists as a separate object in memory. Since the <code class="literal">car</code> and <code class="literal">cdr</code> slots in a cell can point to any other object in memory, a cons cell can point to an upstream cons cell of a list. We call this a <span class="emphasis"><em>circular list</em></span>.<a id="IDX-CHP-7-0011" class="indexterm"/><a id="IDX-CHP-7-0012" class="indexterm"/><a id="IDX-CHP-7-0013" class="indexterm"/><a id="IDX-CHP-7-0014" class="indexterm"/><a id="IDX-CHP-7-0015" class="indexterm"/><a id="IDX-CHP-7-0016" class="indexterm"/><a id="IDX-CHP-7-0017" class="indexterm"/><a id="IDX-CHP-7-0018" class="indexterm"/></p><p>But before you experiment with circular lists in any Common Lisp environment, you should run this command:</p><a id="I_programlisting5_d1e8919"/><pre class="programlisting">(setf *print-circle* t)</pre><p>Setting <code class="literal">*print-circle*</code> to true warns Lisp that you plan on playing shenanigans with self-referential data structures, and that it needs to be extra careful when printing on the screen any of the monstrosities you may create. If you were to print a circular list without this variable set, there’s no telling what would happen, but whatever the outcome, it wouldn’t be pretty (unless you find some beauty in stack overflows and infinite loop printing).<a id="IDX-CHP-7-0019" class="indexterm"/></p><p>When you have <code class="literal">*print-circle*</code> set to true, Common Lisp will use more complex printing routines for printing data structures. These routines (which are disabled by default to improve performance) will check to see if you’ve run into a previously seen cons cell, so that printing doesn’t end up putting you into an infinite loop.</p><p>So how would you go about creating a circular list? The most straightforward way is to use the <code class="literal">setf</code> command to put extra stuff in the first parameter, like so:</p><a id="I_programlisting5_d1e8940"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter foo '(1 2 3))</code></strong>
FOO
&gt; <strong class="userinput"><code>(setf (cdddr foo) foo)</code></strong>
#1=(1 2 3 . #1#)</pre><p>In this example, we’ve created an infinite list of <code class="literal">'(1 2 3 1 2 3 1 2 3 ...)</code> by replacing the <code class="literal">nil</code> at the end of a simple list with a reference to the list itself.</p><p>The ability to place complex expressions in the first parameter of a <code class="literal">setf</code> command, as in this example, is very cool, and we’ll explore it in greater detail in <a class="xref" href="ch10.html" title="Chapter 9. Advanced Datatypes and Generic Programming">Chapter 9</a>.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>CLISP (and other Common Lisps) can deal with the printing of circular lists very sensibly. Somehow, it must address the fact that one part of the list refers to another part. As you can see, it uses an esoteric, but quite clever, notation to link the self-referential parts of the expression. However, I’m sure you can also appreciate that, as the complexity of any self-referential data increases, the printed results offered by a Lisp printer for this type of data can become hard for a programmer to grok.<a id="IDX-CHP-7-0020" class="indexterm"/></p></div></div><div class="sect2" title="Association Lists"><div class="titlepage"><div><div><h2 class="title"><a id="association_lists"/>Association Lists</h2></div></div></div><p>One particularly useful data structure that can be created out of cons cells is an <span class="emphasis"><em>association list</em></span>, or <span class="emphasis"><em>alist</em></span> for short. An alist consists of key/value pairs stored in a list.</p><p>By convention, if a key appears multiple times in the list, it is assumed that the first appearance of the key contains the desired value. For instance, here is an alist representing an order for coffee drinks placed by Bill, Lisa, and John:<a id="IDX-CHP-7-0021" class="indexterm"/><a id="IDX-CHP-7-0022" class="indexterm"/><a id="IDX-CHP-7-0023" class="indexterm"/></p><a id="I_programlisting5_d1e8996"/><pre class="programlisting">(defparameter *drink-order* '((bill . double-espresso)
                              (lisa . small-drip-coffee)
                              (john . medium-latte)))</pre><p>To look up the order for a given person, use the function <code class="literal">assoc</code>:</p><a id="I_programlisting5_d1e9003"/><pre class="programlisting">&gt; <strong class="userinput"><code>(assoc 'lisa *drink-order*)</code></strong>
(LISA . SMALL-DRIP-COFFEE)</pre><p>This function searches the list from the beginning for the desired key, and then returns the key/value pair. Now suppose that, before picking up the drink order, Lisa flags you down and opts to change her order to something slightly more decadent. You can change her order using the <code class="literal">push</code> function:<a id="IDX-CHP-7-0024" class="indexterm"/></p><a id="I_programlisting5_d1e9016"/><pre class="programlisting">&gt; <strong class="userinput"><code>(push '(lisa . large-mocha-with-whipped-cream) *drink-order*)</code></strong>
((LISA . LARGE-MOCHA-WITH-WHIPPED-CREAM)
 (BILL . DOUBLE-ESPRESSO)
 (LISA . SMALL-DRIP-COFFEE)
 (JOHN . MEDIUM-LATTE))</pre><p>This function simply adds a new item to the front of an existing list.</p><p>Because, by default, the first reference to a key in an association list takes precedence over later references to the same key, the order Lisa placed for a small drip coffee is superseded by her more recent order:</p><a id="I_programlisting5_d1e9025"/><pre class="programlisting">&gt; <strong class="userinput"><code>(assoc 'lisa *drink-order*)</code></strong>
(LISA . LARGE-MOCHA-WITH-WHIPPED-CREAM)</pre><p>As you can see, alists are a great way to keep track of any changeable collection of key/value pairs. Alists are easy to understand, to manipulate with Lisp functions, and to comprehend when printed out (they’re just lists of pairs, after all).</p><p>Furthermore, once a value is stored in an alist, it remains there forever, making it easy to audit the history of any data. For instance, in our coffee example, the order Lisa placed for her drip coffee is still available even after it has been replaced.</p><p>However, alists do have one serious limitation: They are not a very efficient way to store and retrieve data, unless you’re dealing with very short lists (under a dozen items). Because of this inefficiency, although alists are often one of the first tools in the Lisp programmer’s toolbox, they may be replaced by other types of data structures as a program matures. (In <a class="xref" href="ch10.html" title="Chapter 9. Advanced Datatypes and Generic Programming">Chapter 9</a>, we’ll discuss the performance limitations of list-based data structures, such as alists, in greater detail.)</p></div></div></div>
<div class="sect1" title="Coping with Complicated Data"><div class="titlepage"><div><div><h1 class="title"><a id="coping_with_complicated_data"/>Coping with Complicated Data</h1></div></div></div><p>Cons cells are a great tool for representing a wide variety of list-like structures. In fact, most Lisp programmers, when faced with a programming task that is not bound by performance constraints, will rely on them almost exclusively. Because the manipulation and visualization of structures made of cons cells are central to the design of Lisp, these structures are extremely convenient to use and debug.<a id="IDX-CHP-7-0025" class="indexterm"/><a id="IDX-CHP-7-0026" class="indexterm"/></p><p>In fact, even if you do have performance constraints, structures made of cons cells can often be a great choice. A Lisp compiler can often reduce a change to a cons cell down to a single assembly instruction!</p><div class="sect2" title="Visualizing Tree-like Data"><div class="titlepage"><div><div><h2 class="title"><a id="visualizing_tree-like_data"/>Visualizing Tree-like Data</h2></div></div></div><p>As discussed in <a class="xref" href="ch03.html" title="Chapter 3. Exploring the Syntax of Lisp Code">Chapter 3</a>, the data (and code) in a Lisp program is represented with syntax expressions. In this format, data is represented using nested lists, often with Lisp symbols at the front of each list explaining the structure of the data.</p><p>For example, suppose we wanted to represent the component parts of a house in Lisp:</p><a id="I_programlisting5_d1e9063"/><pre class="programlisting">(defparameter *house* '((walls (mortar (cement)
                                         (water)
                                         (sand))
                                 (bricks))
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>                         (windows (glass)
                                   (frame)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>                                  (curtains))
                          (roof (shingles)
                                (chimney))))</pre><p>This data structure very elegantly captures the hierarchical nature of the parts that make up a house. Since it is structured as a Lisp syntax expression, we can see the lists that make up the levels of the hierarchy. Also, it follows the convention of a syntax expression by putting a symbol at the front of each list. For instance, we can see how the list describing the windows first contains the Lisp symbol <code class="literal">windows</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9082"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, which is then followed by three items, representing the glass, frame, and finally the curtains <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9088"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.</p><p>As you can see, data that is hierarchical and tree-like in nature can be very naturally expressed in this way. In fact, many Lispers consider XML (a popular format for representing hierarchical data) somewhat of a reinvention of the syntax expression format that Lisp pioneered.<a id="IDX-CHP-7-0027" class="indexterm"/><a id="IDX-CHP-7-0028" class="indexterm"/><a id="IDX-CHP-7-0029" class="indexterm"/></p><p>If, however, we move beyond tree-like structures, data stored in a syntax expression can start becoming hard to visualize, even if it’s relatively easy to store the data in cons cells. For instance, suppose we have a mathematical graph stored in a syntax expression. These types of graphs, where any arbitrary node of the graph may be connected to another by an edge, are notoriously hard to visualize in a computer program. Even Lisp’s elegant system for representing cons cells can’t help much for such data. Next, we’ll look at our options for visualizing such graphs.<a id="IDX-CHP-7-0030" class="indexterm"/><a id="IDX-CHP-7-0031" class="indexterm"/><a id="IDX-CHP-7-0032" class="indexterm"/><a id="IDX-CHP-7-0033" class="indexterm"/></p></div><div class="sect2" title="Visualizing Graphs"><div class="titlepage"><div><div><h2 class="title"><a id="visualizing_graphs"/>Visualizing Graphs</h2></div></div></div><p>In mathematics, a <span class="emphasis"><em>graph</em></span> consists of a bunch of nodes connected by edges. These nodes or edges might have additional data associated with them.</p><p>Such graphs can be stored in cons cells, but they are difficult to visualize. We saw this in <a class="xref" href="ch05.html" title="Chapter 5. Building a Text Game Engine">Chapter 5</a>, when we stored the map of the wizard’s house (which consisted of a directed graph) in two alists: one containing the node information and one containing the edge information. I’ve renamed them <code class="literal">*wizard-nodes*</code> and <code class="literal">*wizard-edges*</code> for this chapter, as shown here:<a id="IDX-CHP-7-0034" class="indexterm"/></p><a id="I_programlisting5_d1e9148"/><pre class="programlisting">(defparameter *wizard-nodes* '((living-room (you are in the living-room.
                                a wizard is snoring loudly on the couch.))
                               (garden (you are in a beautiful garden.
                                there is a well in front of you.))
                               (attic (you are in the attic. there
                                is a giant welding torch in the corner.))))
(defparameter *wizard-edges* '((living-room (garden west door)
                                            (attic upstairs ladder))
                               (garden (living-room east door))
                               (attic (living-room downstairs ladder))))</pre><p>As you can see, it is hard to get a decent understanding of the structure of this game world from these raw data tables. Unfortunately, data that has the shape of a graph or contains other properties that go beyond simple tree structures are very common. Wouldn’t it be great if we had a tool that could optimally arrange this data to create a pretty drawing of a graph? Luckily, there is a fantastic open source tool that performs exactly this task, which you’ll try out next.</p></div></div>
<div class="sect1" title="Creating a Graph"><div class="titlepage"><div><div><h1 class="title"><a id="creating_a_graph"/>Creating a Graph</h1></div></div></div><p>Graphviz generates graphs from your data. Indeed, you saw a simple Graphviz representation of the wizard’s house in <a class="xref" href="ch05.html" title="Chapter 5. Building a Text Game Engine">Chapter 5</a>:<a id="IDX-CHP-7-0035" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e9163"/><img src="httpatomoreillycomsourcenostarchimages781548.png" alt="image with no caption"/></div></div><p>Graphviz is open source and available from the Graphviz website (<a class="ulink" href="http://www.graphviz.org/">http://www.graphviz.org/</a>). After you’ve downloaded and installed it, creating a graph is easy. First, you’ll create a DOT file that describes the shape of your graph. For example, in Graphviz, create a file named <span class="emphasis"><em>test.dot</em></span> on your computer and enter the following information:<a id="IDX-CHP-7-0036" class="indexterm"/><a id="IDX-CHP-7-0037" class="indexterm"/><a id="IDX-CHP-7-0038" class="indexterm"/><a id="IDX-CHP-7-0039" class="indexterm"/><a id="IDX-CHP-7-0040" class="indexterm"/></p><a id="I_programlisting5_d1e9194"/><pre class="programlisting">digraph {
   a-&gt;b;
}</pre><p>This defines a directed graph with nodes A and B connected by an arrow. (There are numerous syntax options available in the DOT file format, as documented at the Graphviz website.)</p><p>Now, to generate a graphical bitmap from the DOT file, run <code class="literal">neato</code> (one of the Graphviz utilities) from the command line, as follows:</p><a id="I_programlisting5_d1e9203"/><pre class="programlisting">neato -Tpng -O test.dot</pre><p>This should create a picture in the file <span class="emphasis"><em>test.dot.png</em></span> that looks like this:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e9211"/><img src="httpatomoreillycomsourcenostarchimages782744.png.jpg" alt="image with no caption"/></div></div><p>As you can see, Graphviz is simple to use. It can even generate large, complicated graphs quickly, with only minor graphical glitches. (Since perfect graph layouts are still an unsolved problem in computer science, Graphviz layouts aren’t perfect. They are, however, closer to perfect than you might expect.)</p><p>Now that you have Graphviz up and running, let’s create a library of commands that will let us conveniently draw graphs with Lisp. We can use this to draw some graphs of our adventure game world.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>The graph utilities used in the examples in this chapter perform certain system calls in a way that is not part of the Common Lisp standard. They are available only in the CLISP environment. The code would require some modifications to run within other Lisp systems.</p></div><div class="sect2" title="Generating the DOT Information"><div class="titlepage"><div><div><h2 class="title"><a id="generating_the_dot_information"/>Generating the DOT Information</h2></div></div></div><p>In order to create a graph drawing library, we want to generate a Graphviz DOT file that captures all the details of a graph. To do this, we will need to convert the identifiers of the nodes the player can visit, convert the edges connecting these nodes, and generate labels for every node and edge. We will test our library using the nodes representing the map of the wizard’s world.</p><div class="sect3" title="Converting Node Identifiers"><div class="titlepage"><div><div><h3 class="title"><a id="converting_node_identifiers"/>Converting Node Identifiers</h3></div></div></div><p>When converting nodes into DOT format, the first thing we need to do is to convert the node identifiers into valid DOT identifiers. We do this by writing a <code class="literal">dot-name</code> function:<a id="IDX-CHP-7-0041" class="indexterm"/><a id="IDX-CHP-7-0042" class="indexterm"/><a id="IDX-CHP-7-0043" class="indexterm"/><a id="IDX-CHP-7-0044" class="indexterm"/><a id="IDX-CHP-7-0045" class="indexterm"/><a id="IDX-CHP-7-0046" class="indexterm"/><a id="IDX-CHP-7-0047" class="indexterm"/><a id="IDX-CHP-7-0048" class="indexterm"/></p><a id="I_programlisting5_d1e9267"/><pre class="programlisting">(defun dot-name (exp)
  (substitute-if #\_ (complement #'alphanumericp) (prin1-to-string exp)))</pre><p>A node in DOT format can contain only letters, digits, and the underscore character. To make sure the node identifier we’re using is legal, we’ll change any forbidden characters to underscores. Here are examples of the <code class="literal">dot-name</code> function in use:</p><a id="I_programlisting5_d1e9274"/><pre class="programlisting">&gt; <strong class="userinput"><code>(dot-name 'living-room)</code></strong>
"LIVING_ROOM"
&gt; <strong class="userinput"><code>(dot-name 'foo!)</code></strong>
"FOO_"
&gt; <strong class="userinput"><code>(dot-name '24)</code></strong>
"24"</pre><p>This function accepts any basic Lisp type, which we can then convert to a string using the <code class="literal">prin1-to-string</code> function. We can process the resulting string and substitute underscores as needed.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>For the sake of simplicity, our <code class="literal">dot-name</code> function assumes that no node identifiers differ only in their nonalphanumeric components. For instance, if we had one node called <code class="literal">foo?</code> and another node called <code class="literal">foo*</code>, the <code class="literal">dot-name</code> function would convert them both to <code class="literal">foo</code>, causing the names to clash.</p></div><p>The <code class="literal">substitute-if</code> function substitutes values based on the result of a test function:</p><a id="I_programlisting5_d1e9313"/><pre class="programlisting">&gt; <strong class="userinput"><code>(substitute-if #\e #'digit-char-p "I'm a l33t hack3r!")</code></strong>
"I'm a leet hacker!"</pre><p>The test function in this example, <code class="literal">digit-char-p</code>, tells us if a character in a string is a numerical digit. Test functions like this, which accept a value and determine truth based on that value, are often referred to as <span class="emphasis"><em>predicates</em></span>.<a id="IDX-CHP-7-0049" class="indexterm"/><a id="IDX-CHP-7-0050" class="indexterm"/></p><p>Another interesting property of the <code class="literal">substitute-if</code> function is that we can use it on lists as well:</p><a id="I_programlisting5_d1e9338"/><pre class="programlisting">&gt; <strong class="userinput"><code>(substitute-if 0 #'oddp '(1 2 3 4 5 6 7 8))</code></strong>
'(0 2 0 4 0 6 0 8)</pre><p>Here, all odd numbers in a list have been replaced by the number 0. The <code class="literal">substitute-if</code> function is one example of a <span class="emphasis"><em>generic function</em></span>—a function that can accept multiple datatypes as parameters and handle them appropriately. (Generic programming is discussed in <a class="xref" href="ch10.html" title="Chapter 9. Advanced Datatypes and Generic Programming">Chapter 9</a>.)<a id="IDX-CHP-7-0051" class="indexterm"/></p><p>When we use <code class="literal">substitute-if</code> in our <code class="literal">dot-name</code> function, we substitute only those characters that aren’t alphanumeric. While no predicate that tests for exactly this is available for us in Common Lisp, it is easy to create this predicate on the fly. The following fragment in the <code class="literal">dot-name</code> function creates a predicate function for us with exactly the right behavior:<a id="IDX-CHP-7-0052" class="indexterm"/><a id="IDX-CHP-7-0053" class="indexterm"/><a id="IDX-CHP-7-0054" class="indexterm"/><a id="IDX-CHP-7-0055" class="indexterm"/><a id="IDX-CHP-7-0056" class="indexterm"/><a id="IDX-CHP-7-0057" class="indexterm"/><a id="IDX-CHP-7-0058" class="indexterm"/><a id="IDX-CHP-7-0059" class="indexterm"/><a id="IDX-CHP-7-0060" class="indexterm"/><a id="IDX-CHP-7-0061" class="indexterm"/><a id="IDX-CHP-7-0062" class="indexterm"/></p><a id="I_programlisting5_d1e9411"/><pre class="programlisting">(complement #'alphanumericp)</pre><p>Lisp already has a predicate function that tells us if a character is alphanumeric, called <code class="literal">alphanumericp</code>. However, we want to substitute only characters that are <span class="emphasis"><em>not</em></span> alphanumeric. We can create this opposite (or <span class="emphasis"><em>complement</em></span>) function to <code class="literal">alphanumericp</code> by passing it to a higher-order function named <code class="literal">complement</code>.</p><p>By passing this function into <code class="literal">substitute-if</code>, we get the behavior we want, without needing to use <code class="literal">defun</code> to pollute the top level with a new function just to feed to <code class="literal">substitute-if</code>.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Common Lisp has a function called <code class="literal">substitute-if-not</code> that could have been used in the <code class="literal">dot-name</code> function in lieu of <code class="literal">substitute-if</code> to allow us to leave the <code class="literal">not</code> out of the <code class="literal">lambda</code> function. However, Lisp functions that end in <code class="literal">not</code> are better avoided. They may be removed from future versions in the ANSI Common Lisp standard, which means they are considered deprecated.</p></div></div><div class="sect3" title="Adding Labels to Graph Nodes"><div class="titlepage"><div><div><h3 class="title"><a id="adding_labels_to_graph_nodes"/>Adding Labels to Graph Nodes</h3></div></div></div><p>Now that we can tweak our node identifiers to make them appropriate for DOT, let’s write another function that will generate the label that should appear in the node when it is drawn. The label will consist of the node name and the data linked to the node in the node alist. But we also need to make sure that we are not trying to put too much text in the label. Here is the code that generates the label:</p><a id="I_programlisting5_d1e9468"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (defparameter *max-label-length* 30)

  (defun dot-label (exp)
    (if exp
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>     (let ((s (write-to-string exp :pretty nil)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>       (if (&gt; (length s) *max-label-length*)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>           (concatenate 'string (subseq s 0 (- *max-label-length* 3)) "...")
            s))
      ""))</pre><p><code class="literal">*max-label-length*</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9497"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> is a global variable that determines the maximum number of characters for the label. If a node label is larger than the limit <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9503"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, it gets cropped, and an ellipsis is added to indicate that fact <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9509"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. The <code class="literal">write-to-string</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9518"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> is similar to the <code class="literal">prin1-to-string</code> function we used earlier—it writes an expression to a string.</p><p>The <code class="literal">:pretty</code> parameter is an example of a <span class="emphasis"><em>keyword parameter</em></span>, which is used by certain Lisp functions to let you choose which parameters you want to pass in. In the case of <code class="literal">write-to-string</code>, it tells Lisp not to alter the string to make it pretty. Without this, Lisp would place new lines or tabs into our converted string to make it look more pleasing to the eye. By setting the <code class="literal">:pretty</code> keyword parameter to <code class="literal">nil</code>, we are telling Lisp to output the expression without any decorations. (Having new lines in a label can confuse Graphviz, so we don’t want to give Lisp any ideas.)<a id="IDX-CHP-7-0063" class="indexterm"/><a id="IDX-CHP-7-0064" class="indexterm"/><a id="IDX-CHP-7-0065" class="indexterm"/><a id="IDX-CHP-7-0066" class="indexterm"/><a id="IDX-CHP-7-0067" class="indexterm"/></p></div><div class="sect3" title="Generating the DOT Information for the Nodes"><div class="titlepage"><div><div><h3 class="title"><a id="generating_the_dot_information_for_the_n"/>Generating the DOT Information for the Nodes</h3></div></div></div><p>Now that we can generate both a name and label for each node, we can write a function that takes an alist of nodes and generates the DOT information that encodes them, like so:</p><a id="I_programlisting5_d1e9570"/><pre class="programlisting">(defun nodes-&gt;dot (nodes)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (mapc (lambda (node)
            (fresh-line)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>           (princ (dot-name (car node)))
            (princ "[label=\"")
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>           (princ (dot-label node))
            (princ "\"];"))
          nodes))</pre><p>This function uses <code class="literal">mapc</code> to go through every node in the list of nodes <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9595"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, and <code class="literal">princ</code> prints each node in the DOT format directly to the screen. <code class="literal">mapc</code> is a slightly more efficient variant of <code class="literal">mapcar;</code> the difference is that it does not return the transformed list. The <code class="literal">nodes-&gt;dot</code> function uses the <code class="literal">dot-name</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9617"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> and <code class="literal">dot-label</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9626"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> functions we created to convert the data.</p><p>Later, when we want to generate a file that contains this information, we’ll write a function that takes this data from the console.</p><p>It may seem a bit odd to use the console as an intermediary for generating a file, instead of just writing directly into a file, but this is actually a common paradigm in Lisp. One immediate benefit of this approach is that we can easily debug the code in the REPL, where the printed lines are easy to see.</p><p>Now let’s try using the <code class="literal">nodes-&gt;dot</code> function to generate the DOT information for the nodes in the wizard’s house:</p><a id="I_programlisting5_d1e9641"/><pre class="programlisting">&gt;  <strong class="userinput"><code>(nodes-&gt;dot *wizard-nodes*)</code></strong>
LIVING_ROOM[label="(LIVING-ROOM (YOU ARE IN TH..."];
GARDEN[label="(GARDEN (YOU ARE IN A BEAUT..."];
ATTIC[label="(ATTIC (YOU ARE IN THE ATTI..."];</pre><p>Here, you can see the nodes of the wizard’s house and an abbreviated version of the information attached to each node, shown in DOT format. Notice that we are not interested in the value returned from the <code class="literal">nodes-&gt;dot</code> function—only in the information it prints in the REPL. Lispers would say that we are only interested in the <span class="emphasis"><em>side effects</em></span> of this function. Although <code class="literal">mapc</code> does not return the list, it still causes the code to iterate through the list and generate the same printed output that using <code class="literal">mapcar</code> would have, so it generates the same side effects as <code class="literal">mapcar</code>, a bit more quickly.</p></div><div class="sect3" title="Converting Edges into DOT Format"><div class="titlepage"><div><div><h3 class="title"><a id="converting_edges_into_dot_format"/>Converting Edges into DOT Format</h3></div></div></div><p>The next step is to generate the DOT information for the edges that link our nodes. These will become the arrows in our visual graph. The function <code class="literal">edges-&gt;dot</code> generates the necessary data, again by printing it directly to the console.<a id="IDX-CHP-7-0068" class="indexterm"/><a id="IDX-CHP-7-0069" class="indexterm"/><a id="IDX-CHP-7-0070" class="indexterm"/><a id="IDX-CHP-7-0071" class="indexterm"/><a id="IDX-CHP-7-0072" class="indexterm"/><a id="IDX-CHP-7-0073" class="indexterm"/><a id="IDX-CHP-7-0074" class="indexterm"/></p><a id="I_programlisting5_d1e9700"/><pre class="programlisting">(defun edges-&gt;dot (edges)
  (mapc (lambda (node)
          (mapc (lambda (edge)
                  (fresh-line)
                  (princ (dot-name (car node)))
                  (princ "-&gt;")
                  (princ (dot-name (car edge)))
                  (princ "[label=\"")
                  (princ (dot-label (cdr edge)))
                  (princ "\"];"))
                (cdr node)))
        edges))</pre><p>Let’s use this function to generate the DOT information for the edges of the wizard’s house:</p><a id="I_programlisting5_d1e9704"/><pre class="programlisting">&gt; <strong class="userinput"><code>(edges-&gt;dot *wizard-edges*)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> LIVING_ROOM-&gt;GARDEN[label="(WEST DOOR)"];
  LIVING_ROOM-&gt;ATTIC[label="(UPSTAIRS LADDER)"];
  GARDEN-&gt;LIVING_ROOM[label="(EAST DOOR)"];
  ATTIC-&gt;LIVING_ROOM[label="(DOWNSTAIRS LADDER)"];</pre><p>Here, we can clearly see the relationships between the nodes in the wizard’s house, in the DOT format. For instance, the first line <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9717"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> indicates that the player can walk from the <code class="literal">LIVING_ROOM</code> node to the <code class="literal">GARDEN</code> node by using an edge labeled <code class="literal">(WEST DOOR)</code>.</p></div><div class="sect3" title="Generating All the DOT Data"><div class="titlepage"><div><div><h3 class="title"><a id="generating_all_the_dot_data"/>Generating All the DOT Data</h3></div></div></div><p>To complete our generation of the DOT data, we call both <code class="literal">nodes-&gt;dot</code> and <code class="literal">edges-&gt;dot</code>, and wrap it up with some extra decoration, as follows:</p><a id="I_programlisting5_d1e9743"/><pre class="programlisting">(defun graph-&gt;dot (nodes edges)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>  (princ "digraph{")
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>  (nodes-&gt;dot nodes)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>  (edges-&gt;dot edges)
    (princ "}"))</pre><p>This function ties everything together by defining our graph as a directional graph <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9765"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, and then calling our <code class="literal">nodes-&gt;dot</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9774"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> and <code class="literal">edges-&gt;dot</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9783"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> functions.</p><p>Here’s what the final DOT information for our wizard game looks like, as created by our new library:</p><a id="I_programlisting5_d1e9791"/><pre class="programlisting">&gt; <strong class="userinput"><code>(graph-&gt;dot *wizard-nodes* *wizard-edges*)</code></strong>
digraph{
LIVING_ROOM[label="(LIVING-ROOM (YOU ARE IN TH..."];
GARDEN[label="(GARDEN (YOU ARE IN A BEAUT..."];
ATTIC[label="(ATTIC (YOU ARE IN THE ATTI..."];
LIVING_ROOM-&gt;GARDEN[label="(WEST DOOR)"];
LIVING_ROOM-&gt;ATTIC[label="(UPSTAIRS LADDER)"];
GARDEN-&gt;LIVING_ROOM[label="(EAST DOOR)"];
ATTIC-&gt;LIVING_ROOM[label="(DOWNSTAIRS LADDER)"];}</pre><p>We can now generate a proper Graphviz DOT file that captures all the details of our wizard map that we need to generate a pretty picture. These include the nodes the player can visit, the edges connecting these nodes, and labels for every node and edge.<a id="IDX-CHP-7-0075" class="indexterm"/><a id="IDX-CHP-7-0076" class="indexterm"/><a id="IDX-CHP-7-0077" class="indexterm"/><a id="IDX-CHP-7-0078" class="indexterm"/></p></div></div><div class="sect2" title="Turning the DOT File into a Picture"><div class="titlepage"><div><div><h2 class="title"><a id="turning_the_dot_file_into_a_picture"/>Turning the DOT File into a Picture</h2></div></div></div><p>To turn the DOT file into an actual bitmap, we capture the DOT file data, put it into a file, and then execute the <code class="literal">dot</code> command directly from the system command line, like this:</p><a id="I_programlisting5_d1e9822"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (defun dot-&gt;png (fname thunk)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>  (with-open-file (*standard-output*
                     fname
                     :direction :output
                     :if-exists :supersede)
      (funcall thunk))
    (ext:shell (concatenate 'string "dot -Tpng -O " fname)))</pre><p>This function performs the most critical actions in our graph drawing library, using some advanced Lisp techniques.</p><p>First, to keep this <code class="literal">dot-&gt;png</code> function as reusable as possible, the <code class="literal">graph-&gt;dot</code> function isn’t called directly. Instead, we write <code class="literal">dot-&gt;png</code> to accept a thunk <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9848"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>.</p><div class="sect3" title="Using Thunks"><div class="titlepage"><div><div><h3 class="title"><a id="using_thunks"/>Using Thunks</h3></div></div></div><p>It is common in Lisp to create small functions that have zero arguments. These functions are officially called <span class="emphasis"><em>nullary functions</em></span>. However, Lispers will often create such functions in order to describe a computation that they don’t want to run until later. In this scenario, a function without arguments is commonly called a <span class="emphasis"><em>thunk</em></span> or a <span class="emphasis"><em>suspension</em></span>. In this case, the thunk our <code class="literal">dot-&gt;png</code> function needs would be a function that, when called, prints a DOT file to the console.<a id="IDX-CHP-7-0079" class="indexterm"/><a id="IDX-CHP-7-0080" class="indexterm"/><a id="IDX-CHP-7-0081" class="indexterm"/></p><p>Why is a thunk useful in our <code class="literal">dot-&gt;png</code> function? Remember that the easiest way for us to write and debug <code class="literal">graph-&gt;dot</code> and other DOT file functions is to have them print their results directly to the console. When we call <code class="literal">graph-&gt;dot</code>, it doesn’t return its results as a value, but, instead, prints them at the console as a side effect. Therefore, we can’t just pass the value of <code class="literal">graph-&gt;dot</code> to <code class="literal">dot-&gt;png</code>. Instead, we pass in <code class="literal">graph-&gt;dot</code> as a thunk. Then <code class="literal">dot-&gt;png</code> is responsible for calling <code class="literal">graph-&gt;dot</code>, capturing the results, and sending them to a file.</p><p>Since it is so common to generate textual data with a computer program, this particular technique is used a lot in Lisp code: First, we print stuff right to the console; next, we wrap it in a thunk; finally, we redirect the results to some other location.<a id="IDX-CHP-7-0082" class="indexterm"/><a id="IDX-CHP-7-0083" class="indexterm"/><a id="IDX-CHP-7-0084" class="indexterm"/><a id="IDX-CHP-7-0085" class="indexterm"/></p><p>As you’ll see in <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>, Lispers who follow the functional programming style eschew this technique, because side effects are required when printing to the console.</p></div><div class="sect3" title="Writing to a File"><div class="titlepage"><div><div><h3 class="title"><a id="writing_to_a_file"/>Writing to a File</h3></div></div></div><p>The function <code class="literal">with-open-file</code> enables <code class="literal">dot-&gt;png</code> to write information to a file <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9943"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. To give you a feel for how this function works, here’s an example that creates a new file named <span class="emphasis"><em>testfile.txt</em></span> and writes the text “Hello File!” to it:</p><a id="I_programlisting5_d1e9952"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (with-open-file (my-stream
                   "testfile.txt"
                   :direction :output
                   :if-exists :supersede)
     (princ "Hello File!" my-stream))</pre><p>In this example, you can see that the first item <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e9961"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> passed into <code class="literal">with-open-file</code> becomes the name of a special Common Lisp datatype called a <span class="emphasis"><em>stream</em></span>, which is created for us by <code class="literal">with-open-file</code>.</p></div><div class="sect3" title="Creating a Stream"><div class="titlepage"><div><div><h3 class="title"><a id="creating_a_stream"/>Creating a Stream</h3></div></div></div><p>Printing functions, such as <code class="literal">princ</code>, can accept a stream as an optional parameter. In this case, these printing functions won’t print anything to the console, but instead will print to the stream object.</p><p>It is important to understand that <code class="literal">with-open-file</code> creates a stream variable from a stream variable name, in the same way that <code class="literal">let</code> creates a variable from a variable name:</p><a id="I_programlisting5_d1e9992"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (with-open-file (my-stream ...)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>    ...<em class="replaceable"><code>body has my-stream defined</code></em>...)

<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> (let ((my-variable ...))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>    ...<em class="replaceable"><code>body has my-variable defined</code></em>...)</pre><p>So if we pass the name <code class="literal">my-stream</code> in at the front of the first list to <code class="literal">with-open-file</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10031"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, this is analogous to defining <code class="literal">my-variable</code> at the start of a <code class="literal">let</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10044"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. A variable named <code class="literal">my-stream</code> will be available to us in the body of <code class="literal">with-open-file</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10056"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, in the same way that <code class="literal">my-variable</code> will be available to us in the body of the <code class="literal">let</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10069"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p><p>But don’t worry too much about exactly what a stream is just yet. We’ll be looking at them more closely in <a class="xref" href="ch13.html" title="Chapter 12. Working with Streams">Chapter 12</a>. For now, you just need to know that a stream is an object that can be connected to a file, and we can pass it to functions (such as <code class="literal">princ</code>) to write stuff to the connected file.<a id="IDX-CHP-7-0086" class="indexterm"/></p></div><div class="sect3" title="Understanding Keyword Parameters"><div class="titlepage"><div><div><h3 class="title"><a id="understanding_keyword_parameters"/>Understanding Keyword Parameters</h3></div></div></div><p>The <code class="literal">with-open-file</code> command also makes heavy use of keyword parameters. Let’s look at our previous example of this command again:<a id="IDX-CHP-7-0087" class="indexterm"/><a id="IDX-CHP-7-0088" class="indexterm"/><a id="IDX-CHP-7-0089" class="indexterm"/><a id="IDX-CHP-7-0090" class="indexterm"/></p><a id="I_programlisting5_d1e10105"/><pre class="programlisting">(with-open-file (my-stream
                   "testfile.txt"
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>                  :direction :output
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>                  :if-exists :supersede)
     (princ "Hello File!" my-stream))</pre><p>A keyword parameter has two parts: the name of the parameter and the value of the parameter. The name of the parameter is always a symbol beginning with a colon. This example has two keyword parameters: <code class="literal">:direction</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10124"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, which is set to <code class="literal">:output</code> (we’re only writing to the file and not reading it), and <code class="literal">:if-exists</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10136"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, which is set to <code class="literal">:superseded</code> (if a file by that name already exists, just toss out the old version).</p><p><code class="literal">with-open-file</code> has keyword parameters because opening a file is a complex operation, and many esoteric options are available. If <code class="literal">with-open-file</code> just gave you regular parameters to set all this, every call to <code class="literal">with-open-file</code> would be long and cumbersome due to all the parameters. Also, humans have a hard time looking at a long list of parameters and remembering which one does what.</p><p>As you’ve probably noticed, symbols in Common Lisp sometimes begin with a colon. This includes keyword parameters, which always start with a colon. This is because a regular symbol in Lisp can refer to something else. For instance, we could set a variable <code class="literal">cigar</code> equal to <code class="literal">5</code> and then return it:</p><a id="I_programlisting5_d1e10164"/><pre class="programlisting">&gt; <strong class="userinput"><code>(let ((cigar 5))</code></strong>
     <strong class="userinput"><code>cigar)</code></strong>
5</pre><p>However, sometimes we don’t want a symbol to refer to something else. We want to use the symbol outright, and we want it to have its own meaning. A colon-prepended symbol in Common Lisp (not surprisingly, called a <span class="emphasis"><em>keyword symbol</em></span>) always means itself:</p><a id="I_programlisting5_d1e10177"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>:cigar</code></strong>
  :CIGAR
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> &gt; <strong class="userinput"><code>(let ((:cigar 5))</code></strong>
      <strong class="userinput"><code>:cigar)</code></strong>
  *** - LET: :CIGAR is a constant, may not be used as a variable</pre><p>As you can see, the keyword symbol <code class="literal">:cigar</code> can be evaluated right at the REPL and already has a value <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10204"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Its value is, conveniently, <code class="literal">:cigar</code>. If we try to redefine <code class="literal">:cigar</code> to something else, Common Lisp won’t let us <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10216"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. The fact that it is constant is useful, because a Lisp compiler can potentially optimize this simple type of symbol more than it can optimize other types. Also, we can reduce errors in our code by using keyword symbols in places where we know a symbol just has a meaning in its own right. Sometimes a cigar is just a cigar.</p></div><div class="sect3" title="Capturing the Console Output"><div class="titlepage"><div><div><h3 class="title"><a id="capturing_the_console_output"/>Capturing the Console Output</h3></div></div></div><p>Our <code class="literal">dot-&gt;png</code> sends our data to the file in a slightly different way than is shown in this example: by declaring the name of the stream to be <code class="literal">*standard-output*</code> (a special global variable in Common Lisp that controls the default location to which printing functions send their output). As a result, any printing done inside the thunk will be redirected to our DOT file.<a id="IDX-CHP-7-0091" class="indexterm"/><a id="IDX-CHP-7-0092" class="indexterm"/><a id="IDX-CHP-7-0093" class="indexterm"/><a id="IDX-CHP-7-0094" class="indexterm"/><a id="IDX-CHP-7-0095" class="indexterm"/><a id="IDX-CHP-7-0096" class="indexterm"/><a id="IDX-CHP-7-0097" class="indexterm"/><a id="IDX-CHP-7-0098" class="indexterm"/></p><p>Let’s look at our <code class="literal">dot-&gt;png</code> function again to see this:</p><a id="I_programlisting5_d1e10269"/><pre class="programlisting">(defun dot-&gt;png (fname thunk)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (with-open-file (*standard-output*
                     fname
                     :direction :output
                     :if-exists :supersede)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>     (funcall thunk))
    (ext:shell (concatenate 'string "dot -Tpng -O " fname)))</pre><p>So how exactly does the <code class="literal">dot-&gt;png</code> function cause our DOT data to get saved to a file instead of just going to the console? To answer this, you’ll need to exercise your brain a bit. Also, you’ll need to recall our discussion of local and dynamic variables in <a class="xref" href="ch02.html" title="Chapter 2. Creating Your First Lisp Program">Chapter 2</a>.</p><p>Remember that the let command usually creates a <span class="emphasis"><em>lexical</em></span>, or local, variable. As we’ve discussed, the stream variable created by <code class="literal">with-open-file</code> is analogous to using <code class="literal">let</code> to create a variable. Hence, it usually leads to the creation of a lexical stream variable for us.<a id="IDX-CHP-7-0099" class="indexterm"/></p><p>However, if a dynamic variable already exists with the same name, <code class="literal">let</code> will instead, temporarily, override the value of the dynamic variable to the new value. <code class="literal">*standard-output*</code> is such a dynamic variable. This means that we can temporarily override the value of <code class="literal">*standard-output*</code> to a new value by passing it into our <code class="literal">with-open-file</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10318"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>.</p><p>In the body of the <code class="literal">with-open-file</code>, where we call our thunk <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10329"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, any values printed to the console will now be automagically routed to our file, instead. The surprising thing (enabled by the design of lexical and dynamic variables in Common Lisp) is that this is also true for the <code class="literal">princ</code> statements in our <code class="literal">graph-&gt;dot</code> function, even though they are called indirectly from <code class="literal">dot-&gt;png</code>.</p></div></div><div class="sect2" title="Creating a Picture of Our Graph"><div class="titlepage"><div><div><h2 class="title"><a id="creating_a_picture_of_our_graph"/>Creating a Picture of Our Graph</h2></div></div></div><p>Lastly, we need a function that ties together all the pieces to let us easily create a graph from some nodes and edges:</p><a id="I_programlisting5_d1e10349"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (defun graph-&gt;png (fname nodes edges)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (dot-&gt;png fname
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>             (lambda ()
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>               (graph-&gt;dot nodes edges))))</pre><p>This function takes the name of a DOT file (as the variable <code class="literal">fname</code>), as well as the graph’s nodes and edges <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10379"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, and uses them to generate the graph. To do this, it calls <code class="literal">dot-&gt;png</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10388"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> and creates the appropriate thunk—a <code class="literal">lambda</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10398"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. As is usual for a thunk, it takes no parameters.</p><p>The <code class="literal">graph-&gt;dot</code> function is called inside the thunk <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10409"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span> as a <span class="emphasis"><em>delayed computation</em></span>. Specifically, if we had called <code class="literal">graph-&gt;dot</code> directly, its output would just show up in the console. However, when inside the thunk, it will be called at the leisure of the <code class="literal">dot-&gt;png</code> function, and the output will be used to generate the DOT file with the filename passed in as the first parameter to <code class="literal">graph-&gt;png</code>.<a id="IDX-CHP-7-0100" class="indexterm"/><a id="IDX-CHP-7-0101" class="indexterm"/><a id="IDX-CHP-7-0102" class="indexterm"/><a id="IDX-CHP-7-0103" class="indexterm"/><a id="IDX-CHP-7-0104" class="indexterm"/></p><p>Let’s try out our new function to draw a graph of the wizard’s house!</p><a id="I_programlisting5_d1e10447"/><pre class="programlisting">(graph-&gt;png "wizard.dot" *wizard-nodes* *wizard-edges*)</pre><p>After calling this function, you should now see a file named <span class="emphasis"><em>wizard.dot.png</em></span>, a picture of the map of the wizard’s house:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e10455"/><img src="httpatomoreillycomsourcenostarchimages783218.png" alt="image with no caption"/></div></div><p>This may not be the prettiest graph on the planet, but it’s packed with information and is very easy to understand. Also, the code is extremely flexible, and places few dependencies on our node and edge data.</p><p>With these utilities in our arsenal, we can now easily create graphs from any interconnected data in our Lisp programs. You’ll find this technique to be a valuable debugging tool when you need to deal with complicated data.</p></div></div>
<div class="sect1" title="Creating Undirected Graphs"><div class="titlepage"><div><div><h1 class="title"><a id="creating_undirected_graphs"/>Creating Undirected Graphs</h1></div></div></div><p>A graph that has arrows on its edges is called a <span class="emphasis"><em>directed graph</em></span>:<a id="IDX-CHP-7-0105" class="indexterm"/><a id="IDX-CHP-7-0106" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e10481"/><img src="httpatomoreillycomsourcenostarchimages781434.png" alt="image with no caption"/></div></div><p>But sometimes we have data that is undirected, allowing us to travel in both directions along an edge. Such a graph is less busy than a directed graph, and can be easier to understand:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e10489"/><img src="httpatomoreillycomsourcenostarchimages781500.png.jpg" alt="image with no caption"/></div></div><p>The following code expands our graph utilities with new functions that let us draw undirected graphs:</p><a id="I_programlisting5_d1e10496"/><pre class="programlisting">(defun uedges-&gt;dot (edges)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (maplist (lambda (lst)
               (mapc (lambda (edge)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>                      (unless (assoc (car edge) (cdr lst))
                         (fresh-line)
                         (princ (dot-name (caar lst)))
                         (princ "--")
                         (princ (dot-name (car edge)))
                         (princ "[label=\"")
                         (princ (dot-label (cdr edge)))
                         (princ "\"];")))
                     (cdar lst)))
             edges))

<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> (defun ugraph-&gt;dot (nodes edges)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>   (princ "graph{")
    (nodes-&gt;dot nodes)
    (uedges-&gt;dot edges)
    (princ "}"))

<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/> (defun ugraph-&gt;png (fname nodes edges)
    (dot-&gt;png fname
              (lambda ()
                (ugraph-&gt;dot nodes edges))))</pre><p>This code is very similar to the code for creating our directed graphs. Let’s look at some of the differences.</p><p>The <code class="literal">uedges-&gt;dot</code> function is very similar to the <code class="literal">edges-&gt;dot</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10538"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. However, the graph we’re drawing may have multiple directed edges between the same nodes that we want to replace with a single, undirected edge. For instance, on our wizard map, we can walk from the garden to the living room by going <span class="emphasis"><em>east</em></span> through the door. Of course, we can also walk from the living room to the garden by going <span class="emphasis"><em>west</em></span> through the exact same door. In our undirected graph, we’ll want to collapse this; in essence, we just want to say, “There’s a door between the garden and living room.”<a id="IDX-CHP-7-0107" class="indexterm"/><a id="IDX-CHP-7-0108" class="indexterm"/><a id="IDX-CHP-7-0109" class="indexterm"/><a id="IDX-CHP-7-0110" class="indexterm"/><a id="IDX-CHP-7-0111" class="indexterm"/></p><p>The <code class="literal">uedges-&gt;dot</code> function erases such duplicate edges by running through the list of edges using the <code class="literal">maplist</code> function. This is like the <code class="literal">mapcar</code> function, except that the function inside it receives the entire remainder of the list, not just the current item in the list:</p><a id="I_programlisting5_d1e10579"/><pre class="programlisting">&gt; <strong class="userinput"><code>(mapcar #'print '(a b c))</code></strong>
A
B
C
...
&gt; <strong class="userinput"><code>(maplist #'print '(a b c))</code></strong>
(A B C)
(B C)
(C)
...</pre><p>The <code class="literal">maplist</code> function sends the <code class="literal">print</code> function everything in the list from the current item until the end. <code class="literal">uedges-&gt;dot</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10599"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> then uses the information about future nodes it gets from <code class="literal">maplist</code> to check whether the destination of the node appears later in the edge list. The actual checking is done with the <code class="literal">assoc</code> function, looking for the current edge in the list of remaining edges, calculated as <code class="literal">(cdr lst)</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10615"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. In this case, it skips the edge so that only one of any pair of edges will be printed.</p><p>The <code class="literal">ugraph-&gt;dot</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10626"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> function is similar to the <code class="literal">graph-&gt;dot</code> function, except that it describes the graph as just a graph <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10635"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span> when generating the DOT data, instead of a digraph. The <code class="literal">ugraph-&gt;png</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject5_d1e10645"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span> is essentially identical to the <code class="literal">graph-&gt;png</code> function, except that it calls <code class="literal">ugraph-&gt;dot</code> instead of <code class="literal">graph-&gt;dot</code>.</p><p>We designed the <code class="literal">dot-&gt;png</code> function to accept different thunks so it could work with different DOT data generators. Now we’ve used this flexibility to generate these functions that output pictures for undirected graphs. For example, let’s try generating an undirected graph for the wizard’s house:</p><a id="I_programlisting5_d1e10665"/><pre class="programlisting">(ugraph-&gt;png "uwizard.dot" *wizard-nodes* *wizard-edges*)</pre><p>Here, <code class="literal">"uwizard.dot"</code> is the name of the DOT file we want to create. The <code class="literal">*wizard-nodes*</code> and <code class="literal">*wizard-edges*</code> variables contain the data describing the nodes and edges of the map of the wizard’s world. This code generates the <span class="emphasis"><em>uwizard.dot.png</em></span> file, which looks like this:<a id="IDX-CHP-7-0112" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e10685"/><img src="httpatomoreillycomsourcenostarchimages781832.png" alt="image with no caption"/></div></div><p>Now that you have a full suite of utilities for both directed and undirected graphs, write these functions to a file named <span class="emphasis"><em>graph-util.lisp</em></span>, so you can access them from other programs.</p></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id7"/>What You've Learned</h1></div></div></div><p>In this chapter, we discussed exotic types of lists and created a drawing library for mathematical graphs. Along the way, you learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>You can create lists in Lisp that end in a value other than nil. Such lists are displayed with an extra dot before the last item and are called <span class="emphasis"><em>dotted lists</em></span>.</p></li><li class="listitem"><p><span class="emphasis"><em>Pairs</em></span> are what you get when you cons together two items that are not lists themselves. They can also be thought of as dotted lists that contain only two items.</p></li><li class="listitem"><p><span class="emphasis"><em>Circular lists</em></span> are lists where the last cons cell points to an earlier cons cell in the same list.</p></li><li class="listitem"><p><span class="emphasis"><em>Association lists (alists)</em></span> are lists of pairs. They can be used to store data that is in the form of keys associated with values.</p></li><li class="listitem"><p>Lisp syntax expressions are great for storing and visualizing list-like and hierarchical data. Extra tools may be helpful for visualizing more complex data.</p></li><li class="listitem"><p>If your data is in the form of a mathematical graph, it’s helpful to be able to generate pictures of your data using Graphviz.</p></li><li class="listitem"><p>A common technique for generating textual data in a Lisp program is to write functions that print the text to the console for easy debugging and wrap these functions in thunks. Then you can send these thunks to other functions, which capture the console output and route the text to the appropriate destination, such as writing it to a file.</p></li></ul></div></div>
<div class="chapter" title="Chapter&#xA0;8.&#xA0;This Ain't Your Daddy's Wumpus"><div class="titlepage"><div><div><h1 class="title"><a id="this_ain_apostrophy_t_your_daddy_apostro"/>Chapter 8. This Ain't Your Daddy's Wumpus</h1></div></div></div><p>In the previous chapter, we worked with mathematical graphs in a simple game. However, as an old-school geek, the first thing I think of when I see these graphs is the old game Hunt the Wumpus. When I was nine, I could think of nothing more fun than sitting in front of my TI-99/4A and playing this excellent game.<a id="IDX-CHP-8-0001" class="indexterm"/></p><p>Here is the original title screen:</p><p>In Hunt the Wumpus, you are a hunter searching through a network of caves to find a mysterious monster—the fabled Wumpus. Along the way, you also deal with bats and tar pits. Ah, those were the days!</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e10744"/><img src="httpatomoreillycomsourcenostarchimages779776.png.jpg" alt="image with no caption"/></div></div><p>But, unfortunately, those days are long gone. We’re in a new millennium now, and no one would be impressed by these crude graphics anymore. And the story line, well, let’s just say it sounds a bit corny by modern standards. I think we can all agree that Hunt the Wumpus is in serious need of a makeover. That’s quite a challenge, but one I think we can handle.</p><p>Therefore, I present to you . . .</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e10754"/><img src="httpatomoreillycomsourcenostarchimages783024.png.jpg" alt="image with no caption"/></div></div><div class="sect1" title="The Grand Theft Wumpus Game"><div class="titlepage"><div><div><h1 class="title"><a id="the_grand_theft_wumpus_game"/>The Grand Theft Wumpus Game</h1></div></div></div><p>In this new version of Hunt the Wumpus, you are the Lisp alien. You and the Wumpus have just robbed a liquor store and made off with the loot. However, during the escape, the Wumpus decides to double-cross you and run off with the money and your car. But before he drives off, you manage to cap him a couple of times in the kidney.<a id="IDX-CHP-8-0002" class="indexterm"/><a id="IDX-CHP-8-0003" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e10773"/><img src="httpatomoreillycomsourcenostarchimages781862.png.jpg" alt="image with no caption"/></div></div><p>Now you’re in a pretty tough situation. You don’t have a car or any money, and no way to track down your former partner in crime. But you also have no choice. You have your principles, so you’re going to <span class="emphasis"><em>hunt the Wumpus</em></span>. You know he won’t be able to get very far with his injuries. He will most likely need to lie low for a few days to recover, which means he will still be somewhere in Congestion City. The problem is that the roads in this town are impossibly convoluted, and no one can find their way around, especially an out-of-towner like yourself. How are you ever going to find the Wumpus in this impossible maze?<a id="IDX-CHP-8-0004" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e10787"/><img src="httpatomoreillycomsourcenostarchimages781264.png.jpg" alt="image with no caption"/></div></div><p>Luckily, being the Lisp alien, you always carry your trusty pocket computer. Using Lisp and your graph utilities, you’re fully equipped to analyze complicated data such as the Congestion City roadways and intersections. Surely, you have the tools to conquer this impenetrable road system.<a id="IDX-CHP-8-0005" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e10798"/><img src="httpatomoreillycomsourcenostarchimages780646.png.jpg" alt="image with no caption"/></div></div><p>The Wumpus has been your partner in crime for a while now, so you know his MO quite well. He will always carefully scout out any new hiding place before he uses it. And since he is injured, any location one or two blocks away (that is, one or two graph edges away) from his hiding place should be marked with some telltale signs: his blood stains.</p><p>A problem is that he still has his trusty AK-47, while you have only a handgun with a single bullet. If you’re going to take him out, you’ll need to be absolutely sure you’ve tracked him down. You’ll need to charge into his hideout and shoot him down immediately, and you’ll have only one chance to pull this off.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e10808"/><img src="httpatomoreillycomsourcenostarchimages780468.png.jpg" alt="image with no caption"/></div></div><p>Unfortunately, you and the Wumpus aren’t the only criminals in this town. The most feared outlaw group in Congestion City is the Gruesome Glowworm Gang. These guys are a band of ruthless kidnappers. If you run into them, they will kidnap you, beat you up, rob you, blindfold you, and then kick you out of their car and leave you in some random part of town.</p><p>Luckily, they can be avoided if you know to keep an eye out for their glowing thoraxes (hence their name). If you see some blinking lights, you know that these guys are one street away from your current location. Also, you know the gang has exactly three separate teams that work the city from three separate locations.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e10819"/><img src="httpatomoreillycomsourcenostarchimages779895.png.jpg" alt="image with no caption"/></div></div><p>Finally, you still need to contend with the cops. You know they’ve probably set up some roadblocks in town to try to catch you and the Wumpus. You should still be able to visit any location in Congestion City, but you need to be careful which streets you travel. (In other words, the cops will catch you if you travel along the wrong edge.) Unfortunately, you don’t know how many of these roadblocks there may be.</p><p>As you can see, finding the Wumpus and getting back your money and car will be tough. If you think you’re Lisp alien enough to take on the Wumpus, then let’s write this game and hunt him down!<a id="IDX-CHP-8-0006" class="indexterm"/><a id="IDX-CHP-8-0007" class="indexterm"/><a id="IDX-CHP-8-0008" class="indexterm"/><a id="IDX-CHP-8-0009" class="indexterm"/><a id="IDX-CHP-8-0010" class="indexterm"/><a id="IDX-CHP-8-0011" class="indexterm"/></p></div></div>
<div class="sect1" title="Defining the Edges of Congestion City"><div class="titlepage"><div><div><h1 class="title"><a id="defining_the_edges_of_congestion_city"/>Defining the Edges of Congestion City</h1></div></div></div><p>The map of Congestion City will be an undirected graph with data associated with each node stored in the variable <code class="literal">*congestion-city-nodes*</code>. The possible data at each node will include the presence of the Wumpus, a Glowworm team, and various danger signs.<a id="IDX-CHP-8-0012" class="indexterm"/></p><p>A set of edges stored in <code class="literal">*congestion-city-edges*</code> will connect the nodes, and data linked to these edges will alert us to the presence of any police roadblocks. We declare these and other global variables at the top of our program using <code class="literal">defparameter</code>:</p><a id="I_programlisting6_d1e10871"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (load "graph-util")

  (defparameter *congestion-city-nodes* nil)
  (defparameter *congestion-city-edges* nil)
  (defparameter *visited-nodes* nil)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> (defparameter *node-num* 30)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> (defparameter *edge-num* 45)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/> (defparameter *worm-num* 3)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/> (defparameter *cop-odds* 15)</pre><p>We first load our graph utilities with the <code class="literal">load</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e10907"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, which evaluates all the code in <span class="emphasis"><em>graph-util.lisp</em></span> (which we created in the previous chapter) so the graph utility functions will be available. Notice that Congestion City will have 30 locations <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e10916"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> (nodes, defined with <code class="literal">*node-num*</code>), 45 edges <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e10926"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> (roads, defined with <code class="literal">*edge-num*</code>), and 3 worm teams <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e10935"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span> (defined with <code class="literal">*worm-num*</code>). Each street will have a 1-in-15 chance <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e10944"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span> of containing a roadblock (defined with <code class="literal">*cop-odds*</code>).</p><div class="sect2" title="Generating Random Edges"><div class="titlepage"><div><div><h2 class="title"><a id="generating_random_edges"/>Generating Random Edges</h2></div></div></div><p>Next, we create a random list of edges to connect all the nodes:</p><a id="I_programlisting6_d1e10958"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (defun random-node ()
    (1+ (random *node-num*)))

<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> (defun edge-pair (a b)
    (unless (eql a b)
      (list (cons a b) (cons b a))))

<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> (defun make-edge-list ()
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>   (apply #'append (loop repeat *edge-num*
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>                         collect (edge-pair (random-node) (random-node)))))</pre><p>First, we declare the <code class="literal">random-node</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e10994"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, which returns a random node identifier. It uses the <code class="literal">random</code> function, which returns a random natural number less than the integer you pass to it. Since we’re going to be showing the node identifiers in our user interface, we use the <code class="literal">1+</code> function to number our nodes 1 through 30 (the upper limit because the <code class="literal">*node-num*</code> variable is set to <code class="literal">30</code>), instead of 0 through 29.<a id="IDX-CHP-8-0013" class="indexterm"/><a id="IDX-CHP-8-0014" class="indexterm"/><a id="IDX-CHP-8-0015" class="indexterm"/><a id="IDX-CHP-8-0016" class="indexterm"/></p><p>The <code class="literal">make-edge-list</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11030"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> generates the actual list of random edges. It uses the <code class="literal">loop</code> command to loop <code class="literal">*edge-num*</code> times <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11042"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>, and then collects the requisite number of edges <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11049"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>. We’ll take a closer look at the <code class="literal">loop</code> command in the next section. The graph of the city is undirected, so this function uses a helper function, <code class="literal">edge-pair</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11061"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, to create <span class="emphasis"><em>two</em></span> directed edges between the randomly selected nodes. This extra step makes sense once you remember that an undirected graph is the same as a directed graph, with two opposing directed edges mirroring each undirected edge. (When we build our edges into an alist later in this chapter, this step will ensure that the list is properly formed.)</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e11071"/><img src="httpatomoreillycomsourcenostarchimages781068.png.jpg" alt="image with no caption"/></div></div><p>Let’s try the <code class="literal">make-edge-list</code> function in the CLISP REPL:</p><a id="I_programlisting6_d1e11081"/><pre class="programlisting">&gt; <strong class="userinput"><code>(make-edge-list)</code></strong>
((16 . 20) (20 . 16) (9 . 3) (3 . 9) (25 . 18) (18 . 25) (30 . 29)
 (29 . 30) (26 . 13) (13 . 26) (12 . 25) (25 . 12) (26 . 22) (22 . 26)
 (30 . 29) (29 . 30) (3 . 14) (14 . 3) (28 . 6) (6 . 28) (4 . 8) (8 . 4)
 (27 . 8) (8 . 27) (3 . 30) (30 . 3) (25 . 16) (16 . 25) (5 . 21) (21 . 5)
 (11 . 24) (24 . 11) (14 . 1) (1 . 14) (25 . 11) (11 . 25) (21 . 9) (9 . 21)
 (12 . 22) (22 . 12) (21 . 11) (11 . 21) (11 . 17) (17 . 11) (30 . 21) (21 . 30)
 (3 . 11) (11 . 3) (24 . 23) (23 . 24) (1 . 24) (24 . 1) (21 . 19) (19 . 21) (25 . 29)
 (29 . 25) (1 . 26) (26 . 1) (28 . 24) (24 . 28) (20 . 15) (15 . 20)
 (28 . 25) (25 . 28)
 (2 . 11) (11 . 2) (11 . 24) (24 . 11) (29 . 24) (24 . 29)
(18 . 28) (28 . 18) (14 . 15)
 (15 . 14) (16 . 10) (10 . 16) (3 . 26) (26 . 3) (18 . 9) (9 . 18) (5 . 12)
 (12 . 5) (11 . 18) (18 . 11) (20 . 17) (17 . 20) (25 . 3) (3 . 25))</pre><p>You see the pairs of node numbers that make up the edges. This list of edge pairs will form the skeleton of the Congestion City road system.</p></div><div class="sect2" title="Looping with the loop Command"><div class="titlepage"><div><div><h2 class="title"><a id="looping_with_the_loop_command"/>Looping with the loop Command</h2></div></div></div><p>Our <code class="literal">make-edge-list</code> function employs the powerful <code class="literal">loop</code> command, which can be used to loop over various types of data. We’ll be looking at <code class="literal">loop</code> in detail in <a class="xref" href="ch11.html" title="Chapter 10. Looping with the loop Command">Chapter 10</a>. However, our game uses <code class="literal">loop</code> a few times, so let’s consider some simple examples to clarify how it works.</p><p>One handy thing you can do with <code class="literal">loop</code> is create a list of numbers. For instance, the following command will create a list of 10 ones:<a id="IDX-CHP-8-0017" class="indexterm"/><a id="IDX-CHP-8-0018" class="indexterm"/><a id="IDX-CHP-8-0019" class="indexterm"/><a id="IDX-CHP-8-0020" class="indexterm"/></p><a id="I_programlisting6_d1e11128"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop repeat 10</code></strong>
        <strong class="userinput"><code>collect 1)</code></strong>
(1 1 1 1 1 1 1 1 1 1)</pre><p>Within the <code class="literal">loop</code> command, we specify how many times to <code class="literal">repeat</code>, and then specify an object to <code class="literal">collect</code> with every loop (in this case, the number 1).</p><p>Sometimes, we want to keep a running count as we’re looping. We can do this with the following syntax:</p><a id="I_programlisting6_d1e11149"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for n from 1 to 10</code></strong>
        <strong class="userinput"><code>collect n)</code></strong>
(1 2 3 4 5 6 7 8 9 10)</pre><p>In this example, we are saying that <code class="literal">n</code> should loop from 1 to 10. Then we <code class="literal">collect</code> each <code class="literal">n</code> and return it as a list.</p><p>Actually, we can put any Lisp code in the <code class="literal">collect</code> part of the loop. In the following example, we add 100 as we do our collecting:</p><a id="I_programlisting6_d1e11173"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for n from 1 to 10</code></strong>
        <strong class="userinput"><code>collect (+ 100 n))</code></strong>
(101 102 103 104 105 106 107 108 109 110)</pre></div><div class="sect2" title="Preventing Islands"><div class="titlepage"><div><div><h2 class="title"><a id="preventing_islands"/>Preventing Islands</h2></div></div></div><p>We now can generate random edges. Of course, if we just connect random nodes with random edges, there’s no guarantee that all of Congestion City will be connected because of all that randomness. For example, some parts of the city might form an island, with no connections to the main road system.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e11187"/><img src="httpatomoreillycomsourcenostarchimages782588.png.jpg" alt="image with no caption"/></div></div><p>To prevent this, we’ll take our list of edges, find unconnected nodes, and connect these islands to the rest of the city network using this code:<a id="IDX-CHP-8-0021" class="indexterm"/><a id="IDX-CHP-8-0022" class="indexterm"/><a id="IDX-CHP-8-0023" class="indexterm"/><a id="IDX-CHP-8-0024" class="indexterm"/><a id="IDX-CHP-8-0025" class="indexterm"/></p><a id="I_programlisting6_d1e11209"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (defun direct-edges (node edge-list)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (remove-if-not (lambda (x)
                     (eql (car x) node))
                   edge-list))

<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> (defun get-connected (node edge-list)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>   (let ((visited nil))
      (labels ((traverse (node)
                 (unless (member node visited)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>                  (push node visited)
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>                  (mapc (lambda (edge)
                           (traverse (cdr edge)))
                         (direct-edges node edge-list)))))
        (traverse node))
      visited))

  (defun find-islands (nodes edge-list)
    (let ((islands nil))
<img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/>     (labels ((find-island (nodes)
                 (let* ((connected (get-connected (car nodes) edge-list))
                        (unconnected (set-difference nodes connected)))
                   (push connected islands)
<img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/>                  (when unconnected
                     (find-island unconnected)))))
        (find-island nodes))
      islands))

  (defun connect-with-bridges (islands)
<img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/>   (when (cdr islands)
      (append (edge-pair (caar islands) (caadr islands))
              (connect-with-bridges (cdr islands)))))

<img src="httpatomoreillycomsourcenostarchimages783062.png" alt=""/> (defun connect-all-islands (nodes edge-list)
    (append (connect-with-bridges (find-islands nodes edge-list)) edge-list))</pre><p>First, we declare a utility function called <code class="literal">direct-edges</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11276"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, which finds all the edges in an edge list that start from a given node. It does this by creating a new list with all edges removed (using <code class="literal">remove-if-not</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11285"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>) that don’t have the current node in the <code class="literal">car</code> position.</p><p>To find islands, we write the <code class="literal">get-connected</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11299"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. This function takes an edge list and a source node and builds a list of all nodes connected to that node, even if it requires walking across multiple edges.</p><p>The usual way to find connected nodes is to start a <code class="literal">visited</code> list <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11310"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>, and then perform a search along connected nodes, starting with the source node. Newly found nodes are added to the visited list with the <code class="literal">push</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11319"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>. We also traverse all the children of this found node, using <code class="literal">mapc</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11329"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>.</p><p>If, on the other hand, we encounter a node that has already been visited, we know we can ignore it. Once the search is complete, the <code class="literal">visited</code> list will consist of all connected nodes.</p><p>Now that we have a function for finding nodes that are connected, we can use it to create a function that will find all the islands in our graph. The <code class="literal">find-islands</code> function first defines a local function, called <code class="literal">find-island</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11348"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>. This function checks which nodes are connected to the first node in our list of nodes using the <code class="literal">connected</code> function. It then subtracts these nodes from the full list of nodes using the <code class="literal">set-difference</code> function. (<code class="literal">set-difference</code> takes two lists, and returns all items that are in the first list but not the second.)<a id="IDX-CHP-8-0026" class="indexterm"/><a id="IDX-CHP-8-0027" class="indexterm"/><a id="IDX-CHP-8-0028" class="indexterm"/><a id="IDX-CHP-8-0029" class="indexterm"/><a id="IDX-CHP-8-0030" class="indexterm"/><a id="IDX-CHP-8-0031" class="indexterm"/><a id="IDX-CHP-8-0032" class="indexterm"/><a id="IDX-CHP-8-0033" class="indexterm"/><a id="IDX-CHP-8-0034" class="indexterm"/></p><p>Any remaining nodes are deemed unconnected. If any unconnected node exists <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11395"/><img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/></span>, we call the <code class="literal">find-islands</code> function again recursively to find additional islands.</p><p>Once we’ve found all the islands, we need a way of bridging them together. This is the job of the <code class="literal">connect-with-bridges</code> function. It returns a list of additional edges that join all the islands together. To do this, it takes the list of islands and checks if there is a <code class="literal">cdr</code> in this list <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11413"/><img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/></span>. If there is, it means there are at least two land masses, which can be connected with a bridge. It uses the <code class="literal">edge-pair</code> function to create this bridge, and then calls itself recursively on the tail of the island list, in case additional bridges are needed.</p><p>Finally, we tie all of our island prevention functions together using the function <code class="literal">connect-all-islands</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11427"/><img src="httpatomoreillycomsourcenostarchimages783062.png" alt=""/></span>. It uses <code class="literal">find-islands</code> to find all the land masses, and then calls <code class="literal">connect-with-bridges</code> to build appropriate bridges. It then appends these bridges to the initial list of edges to produce a final, fully connected land mass.</p></div><div class="sect2" title="Building the Final Edges for Congestion City"><div class="titlepage"><div><div><h2 class="title"><a id="building_the_final_edges_for_congestion"/>Building the Final Edges for Congestion City</h2></div></div></div><p>To complete our edges for Congestion City, we need to convert the edges from an edge list into an alist. We also will add the police roadblocks, which will appear randomly on some of the edges. For these tasks, we will create the <code class="literal">make-city-edges</code>, <code class="literal">edges-to-alist</code>, and <code class="literal">add-cops</code> functions:<a id="IDX-CHP-8-0035" class="indexterm"/><a id="IDX-CHP-8-0036" class="indexterm"/></p><a id="I_programlisting6_d1e11461"/><pre class="programlisting">(defun make-city-edges ()
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let* ((nodes (loop for i from 1 to *node-num*
                        collect i))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>          (edge-list (connect-all-islands nodes (make-edge-list)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>          (cops (remove-if-not (lambda (x)
                                  (zerop (random *cop-odds*)))
                                edge-list)))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>     (add-cops (edges-to-alist edge-list) cops)))

  (defun edges-to-alist (edge-list)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>   (mapcar (lambda (node1)
              (cons node1
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>                   (mapcar (lambda (edge)
                              (list (cdr edge)))
                            (remove-duplicates (direct-edges node1 edge-list)
<img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/>                                              :test #'equal))))
            (remove-duplicates (mapcar #'car edge-list))))

  (defun add-cops (edge-alist edges-with-cops)
<img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/>   (mapcar (lambda (x)
              (let ((node1 (car x))
                    (node1-edges (cdr x)))
                (cons node1
<img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/>                     (mapcar (lambda (edge)
                                (let ((node2 (car edge)))
<img src="httpatomoreillycomsourcenostarchimages783062.png" alt=""/>                                 (if (intersection (edge-pair node1 node2)
                                                    edges-with-cops
                                                    :test #'equal)
                                      (list node2 'cops)
                                    edge)))
                              node1-edges))))
            edge-alist))</pre><p>These are the most cumbersome functions in Grand Theft Wumpus. Let’s take a closer look at them.<a id="IDX-CHP-8-0037" class="indexterm"/><a id="IDX-CHP-8-0038" class="indexterm"/><a id="IDX-CHP-8-0039" class="indexterm"/><a id="IDX-CHP-8-0040" class="indexterm"/><a id="IDX-CHP-8-0041" class="indexterm"/><a id="IDX-CHP-8-0042" class="indexterm"/></p><div class="sect3" title="The make-city-edges Function"><div class="titlepage"><div><div><h3 class="title"><a id="the_make-city-edges_function"/>The make-city-edges Function</h3></div></div></div><p>First, the <code class="literal">make-city-edges</code> function creates a list of nodes, using a <code class="literal">loop</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11555"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. (This is simply a list of numbers from 1 to <code class="literal">*node-num*</code>.) Next, it creates a random (but fully connected) edge list by calling the <code class="literal">make-edge-list</code> and <code class="literal">connect-edge-list</code> functions <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11571"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. This result is stored in the <code class="literal">edge-list</code> variable. It then creates a random list of edges that contains <code class="literal">cops</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11583"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. We define these variables with the <code class="literal">let*</code> command, which allows us to reference previously defined variables.</p><p>The following example shows the difference between defining variables with <code class="literal">let</code> and <code class="literal">let*</code>:<a id="IDX-CHP-8-0043" class="indexterm"/></p><a id="I_programlisting6_d1e11605"/><pre class="programlisting">&gt; <strong class="userinput"><code>(let ((a 5)</code></strong>
        <strong class="userinput"><code>(b (+ a 2)))</code></strong>
    <strong class="userinput"><code>b)</code></strong>
*** - EVAL: variable A has no value
&gt; <strong class="userinput"><code>(let* ((a 5)</code></strong>
         <strong class="userinput"><code>(b (+ a 2)))</code></strong>
    <strong class="userinput"><code>b)</code></strong>
7</pre><p>As you can see, <code class="literal">let</code> won’t allow you to refer to other defined variables (the variable <code class="literal">b</code> can’t reference the value of <code class="literal">a</code>). When defining variables with <code class="literal">let*</code>, on the other hand, this kind of reference is allowed. For our purposes, using <code class="literal">let*</code> allows our definition of <code class="literal">cops</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11647"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> to contain a reference to <code class="literal">edge-list</code>.</p><p>Once we’ve created the edge list and determined where the cops are, we need to convert our edge list into an alist and add the cops to it <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11658"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. The edges are converted to an alist with the <code class="literal">edges-to-alist</code> function, and the cops are added with the <code class="literal">add-cops</code> function.</p></div><div class="sect3" title="The edges-to-alist Function"><div class="titlepage"><div><div><h3 class="title"><a id="the_edges-to-alist_function"/>The edges-to-alist Function</h3></div></div></div><p>The <code class="literal">edges-to-alist</code> function converts a list of edges into an alist of edges. For example, assume we have the following city, with only three locations and two edges connecting those locations:<a id="IDX-CHP-8-0044" class="indexterm"/><a id="IDX-CHP-8-0045" class="indexterm"/><a id="IDX-CHP-8-0046" class="indexterm"/><a id="IDX-CHP-8-0047" class="indexterm"/><a id="IDX-CHP-8-0048" class="indexterm"/><a id="IDX-CHP-8-0049" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e11697"/><img src="httpatomoreillycomsourcenostarchimages780974.png.jpg" alt="image with no caption"/></div></div><p>We would describe this using an edge list as <code class="literal">'((1 . 2) (2 . 1) (2 . 3) (3 . 2))</code>. Remember that each of the edges is repeated, since the edges are undirected and can be used in both directions. If we described this same city as an alist, what would that look like?</p><p>Remember that an alist is a list that lets us look up a key (in this example, one of the three nodes in our city) and find the information associated with that key (in this case, a list of the roads connected to it). For this small city, the alist would be <code class="literal">'((1 (2)) (2 (1) (3)) (3 (2)))</code>.</p><p>To build this alist, the <code class="literal">edges-to-list</code> function first <code class="literal">mapcar</code>s <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11720"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span> over the nodes found in the edge list. To build the list of nodes, we use the <code class="literal">remove-duplicates</code> function, which removes duplicate items from a list. By default, <code class="literal">remove-duplicates</code> uses the <code class="literal">eql</code> function to check for equality, though it also allows you to choose a different test function using the :test keyword parameter. Since we’re checking for equality of cons pairs in our <code class="literal">make-city-edges</code> function, we set <code class="literal">:test</code> to <code class="literal">#'equal</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11745"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>.<a id="IDX-CHP-8-0050" class="indexterm"/><a id="IDX-CHP-8-0051" class="indexterm"/></p><p>Within this outer <code class="literal">mapcar</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11763"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>, we use another <code class="literal">mapcar</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11772"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span> to map across all the <code class="literal">direct-edges</code> to this node. Together, these nested <code class="literal">mapcar</code> functions allow <code class="literal">edges-to-alist</code> to convert the edges of a city into an alist.</p></div><div class="sect3" title="The add-cops Function"><div class="titlepage"><div><div><h3 class="title"><a id="the_add-cops_function"/>The add-cops Function</h3></div></div></div><p>When we wrote the <code class="literal">make-city-edges</code> function, we randomly marked some of the edges to show that they have cops on them <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11796"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. We are now going to use this list of cop edges to mark the edges in our alist that contain cops. This is the job of the <code class="literal">add-cops</code> function.</p><p>To do this, we use nested <code class="literal">mapcar</code> commands to map across the edges within each node <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11810"/><img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11815"/><img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/></span>. We then check whether there are any cops on a given edge, using the <code class="literal">intersection</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11824"/><img src="httpatomoreillycomsourcenostarchimages783062.png" alt=""/></span>. (The <code class="literal">intersection</code> function tells us which items are shared between two lists.)</p><p>To understand exactly what the <code class="literal">add-cops</code> function is doing, it will help to once again imagine our city with only three locations and two streets. In this example, one of the streets has cops on it:<a id="IDX-CHP-8-0052" class="indexterm"/><a id="IDX-CHP-8-0053" class="indexterm"/><a id="IDX-CHP-8-0054" class="indexterm"/><a id="IDX-CHP-8-0055" class="indexterm"/><a id="IDX-CHP-8-0056" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e11860"/><img src="httpatomoreillycomsourcenostarchimages783078.png.jpg" alt="image with no caption"/></div></div><p>The generated alist for this city, created by <code class="literal">add-cops</code>, would look like this:</p><a id="I_programlisting6_d1e11870"/><pre class="programlisting">((1 (2)) (2 (1) (3 COPS)) (3 (2 COPS)))</pre><p>This is actually a <span class="emphasis"><em>nested</em></span> alist. The outer alist is organized based on the first node, and the inner alists are organized based on the second node.<a id="IDX-CHP-8-0057" class="indexterm"/></p><p>With the edges in this format, we can easily find all edges connected to a given node by calling <code class="literal">(cdr (assoc node1 edges))</code>. To see if a given edge contains cops, we can call <code class="literal">(cdr (assoc node2 (cdr (assoc node1 edges))))</code>, which goes down two levels to grab the actual data linked to a specific edge between two nodes. (One additional benefit of using this nested alist format is that it is fully compatible with our graph libraries—a feature that we’ll take advantage of shortly.)</p></div></div></div>
<div class="sect1" title="Building the Nodes for Congestion City"><div class="titlepage"><div><div><h1 class="title"><a id="building_the_nodes_for_congestion_city"/>Building the Nodes for Congestion City</h1></div></div></div><p>Now we’ll build an alist for the nodes in our city. These nodes may contain the Wumpus or the Glowworms, or they might contain various clues, such as blood, lights, or sirens.<a id="IDX-CHP-8-0058" class="indexterm"/></p><p>Most of the clues in our game are based on proximity to another node, so we need to write some functions that tell us if two nodes are one node apart in the city graph. The <code class="literal">neighbors</code> function looks up the node’s neighbors using the alist of edges. If the second node is in that list, we know we’re one away.</p><a id="I_programlisting6_d1e11905"/><pre class="programlisting">(defun neighbors (node edge-alist)
 (mapcar #'car (cdr (assoc node edge-alist))))

(defun within-one (a b edge-alist)
 (member b (neighbors a edge-alist)))</pre><p>First, this function looks up the first node (<code class="literal">a</code>) in the alist of edges with <code class="literal">neighbors</code>. Then it uses <code class="literal">member</code> to see if the other node (<code class="literal">b</code>) is among these nodes.</p><p>The blood stain clues for the Wumpus can also be seen from two nodes away. We can write a second function for checking two nodes like this:<a id="IDX-CHP-8-0059" class="indexterm"/><a id="IDX-CHP-8-0060" class="indexterm"/><a id="IDX-CHP-8-0061" class="indexterm"/></p><a id="I_programlisting6_d1e11932"/><pre class="programlisting">(defun within-two (a b edge-alist)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (or (within-one a b edge-alist)
        (some (lambda (x)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>               (within-one x b edge-alist))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>             (neighbors a edge-alist))))</pre><p>First, we check if we are within one node of our goal <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11954"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, since if we’re within one, we’re also within two. Next, we extract all the nodes that are one away <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11960"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> (similar to what we did in the <code class="literal">within-one</code> function). Finally, we check if any of <span class="emphasis"><em>these</em></span> new nodes are within one <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e11972"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, which would make them within two of the original node.</p><p>Now that we have those utility functions, let’s write the function that builds the final node alist (basically, the final map of our city.) Here’s the listing:</p><a id="I_programlisting6_d1e11980"/><pre class="programlisting">(defun make-city-nodes (edge-alist)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let ((wumpus (random-node))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>         (glow-worms (loop for i below *worm-num*
                            collect (random-node))))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>     (loop for n from 1 to *node-num*
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>         collect (append (list n)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>                         (cond ((eql n wumpus) '(wumpus))
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>                               ((within-two n wumpus edge-alist) '(blood!)))
<img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/>                         (cond ((member n glow-worms)
                                 '(glow-worm))
<img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/>                               ((some (lambda (worm)
                                         (within-one n worm edge-alist))
                                       glow-worms)
                                 '(lights!)))
<img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/>                         (when (some #'cdr (cdr (assoc n edge-alist)))
                            '(sirens!))))))</pre><p>The <code class="literal">make-city-nodes</code> function first picks random nodes for the Wumpus <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12042"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> and the Glowworms <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12048"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, and then it uses <code class="literal">loop</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12057"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> to run through the node numbers. As it runs through the nodes, it builds a list describing each node in the city, <code class="literal">appended</code> together from various sources <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12067"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. By using <code class="literal">append</code>, each part of the code that describes these nodes (and is within the body of the <code class="literal">append</code>) can choose to add zero, one, or multiple items to the description, creating its own child lists with zero, one, or multiple items.</p><p>At the front of the list, we put the node name, <code class="literal">n</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12085"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. If the Wumpus is at the current node, we add the word <span class="emphasis"><em>Wumpus</em></span> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12094"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span> (but wrapped in a list, as we just described). If we’re within two nodes of the Wumpus, we show its blood <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12100"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>. If the node has a Glowworm gang, we show it next <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12107"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>, and if the Glowworm gang is one node away, we show its lights <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12113"/><img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/></span>. Finally, if an edge from the node contains cops, we indicate that sirens can be heard <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12119"/><img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/></span>.</p><p>To check for the sirens clue, we simply grab the edges with <code class="literal">(cdr (assoc n edges))</code> and see if some of these nodes have a value in the cdr. The <code class="literal">'cops</code> symbol would be attached to the edges at the <code class="literal">cdr</code>. Since we have only one data point for edges in this game, looking for the presence of a <code class="literal">cdr</code> is an adequate check for the presence of cops. For example, if we use our earlier example of an alist with cops on it:<a id="IDX-CHP-8-0062" class="indexterm"/><a id="IDX-CHP-8-0063" class="indexterm"/><a id="IDX-CHP-8-0064" class="indexterm"/></p><a id="I_programlisting6_d1e12151"/><pre class="programlisting">((1 (2)) (2 (1)<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (3 COPS)<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>) (3 (2 COPS)))</pre><p>You can see that if an edge in the list has cops, such as here <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12167"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, the <code class="literal">cdr</code> will lead to a non-<code class="literal">nil</code> value. An edge without cops <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12179"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> will have a <code class="literal">cdr</code> that is <code class="literal">nil</code>.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e12193"/><img src="httpatomoreillycomsourcenostarchimages782874.png.jpg" alt="image with no caption"/></div></div></div>
<div class="sect1" title="Initializing a New Game of Grand Theft Wumpus"><div class="titlepage"><div><div><h1 class="title"><a id="initializing_a_new_game_of_grand_theft_w"/>Initializing a New Game of Grand Theft Wumpus</h1></div></div></div><p>With our graph construction stuff out of the way, we can write a simple function that initializes a brand-new game of Grand Theft Wumpus:</p><a id="I_programlisting6_d1e12204"/><pre class="programlisting">(defun new-game ()
    (setf *congestion-city-edges* (make-city-edges))
    (setf *congestion-city-nodes* (make-city-nodes *congestion-city-edges*))
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (setf *player-pos* (find-empty-node))
    (setf *visited-nodes* (list *player-pos*))
    (draw-city))</pre><p>There are two new functions here. One, the <code class="literal">find-empty-node</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12217"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, ensures that the player doesn’t end up on top of a bad guy right at the beginning of the game. Here’s the code for that function:</p><a id="I_programlisting6_d1e12223"/><pre class="programlisting">(defun find-empty-node ()
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let ((x (random-node)))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>     (if (cdr (assoc x *congestion-city-nodes*))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>         (find-empty-node)
          x)))</pre><p>The <code class="literal">find-empty-node</code> function is pretty simple. First, it picks a random node <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12248"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> to consider as the player’s starting position. Then it checks whether it is a completely empty node <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12254"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. If there’s stuff in that node, it simply calls itself again, trying another random spot <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12260"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.<a id="IDX-CHP-8-0065" class="indexterm"/><a id="IDX-CHP-8-0066" class="indexterm"/><a id="IDX-CHP-8-0067" class="indexterm"/><a id="IDX-CHP-8-0068" class="indexterm"/><a id="IDX-CHP-8-0069" class="indexterm"/><a id="IDX-CHP-8-0070" class="indexterm"/><a id="IDX-CHP-8-0071" class="indexterm"/></p><div class="warning" title="Warning"><h3 class="title">Warning</h3><p>If you ever decide to modify the game and make it more crowded with bad guys, you could end up in a situation where no empty nodes exist. In that case, this function will search forever and lock up your Lisp REPL, since we didn’t put in any checks to detect this situation.</p></div><p>The other new function in our <code class="literal">new-game</code> command is <code class="literal">draw-city</code>, which we’ll write next.</p></div>
<div class="sect1" title="Drawing a Map of Our City"><div class="titlepage"><div><div><h1 class="title"><a id="drawing_a_map_of_our_city"/>Drawing a Map of Our City</h1></div></div></div><p>We’re finally ready to draw a map of our new city. We’re using a standard format for our graph data, so writing this function is a breeze:</p><a id="I_programlisting6_d1e12310"/><pre class="programlisting">(defun draw-city ()
  (ugraph-&gt;png "city" *congestion-city-nodes* *congestion-city-edges*))</pre><p>We created the <code class="literal">ugraph-&gt;png</code> function in the previous chapter, as part of our graph library.</p><p>Now call <code class="literal">(new-game)</code> from the REPL, and open the <span class="emphasis"><em>city.dot.png</em></span> picture in your web browser:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e12326"/><img src="httpatomoreillycomsourcenostarchimages783532.png.jpg" alt="image with no caption"/></div></div><div class="note" title="Note"><h3 class="title">Note</h3><p>Since every city map created by our code is unique, your map will look completely different from the one in this picture.</p></div><p>Finally, we can marvel at the results of our urban planning!</p><div class="sect2" title="Drawing a City from Partial Knowledge"><div class="titlepage"><div><div><h2 class="title"><a id="drawing_a_city_from_partial_knowledge"/>Drawing a City from Partial Knowledge</h2></div></div></div><p>Of course, it’s awfully boring to hunt something if you already know where it is before the hunt starts. To solve this problem, we want a map of the city that shows only the nodes that we’ve visited so far. To that end, we use a global list called <code class="literal">*visited-nodes*</code> that is initially set to the player’s position only, but which we’ll update as we walk around the city visiting other nodes. Using this <code class="literal">*visited-nodes*</code> variable, we can calculate a smaller graph that includes only those parts of the city that are known to us.<a id="IDX-CHP-8-0072" class="indexterm"/><a id="IDX-CHP-8-0073" class="indexterm"/><a id="IDX-CHP-8-0074" class="indexterm"/><a id="IDX-CHP-8-0075" class="indexterm"/><a id="IDX-CHP-8-0076" class="indexterm"/><a id="IDX-CHP-8-0077" class="indexterm"/><a id="IDX-CHP-8-0078" class="indexterm"/></p><div class="sect3" title="Known Nodes"><div class="titlepage"><div><div><h3 class="title"><a id="known_nodes"/>Known Nodes</h3></div></div></div><p>First, we can build an alist of just the known nodes:</p><a id="I_programlisting6_d1e12386"/><pre class="programlisting">(defun known-city-nodes ()
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (mapcar (lambda (node)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>             (if (member node *visited-nodes*)
                  (let ((n (assoc node *congestion-city-nodes*)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>                   (if (eql node *player-pos*)
                        (append n '(*))
                        n))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>                 (list node '?)))
            (remove-duplicates
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>               (append *visited-nodes*
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>                       (mapcan (lambda (node)
                                  (mapcar #'car
                                         (cdr (assoc node
                                                     *congestion-city-edges*))))
                                *visited-nodes*)))))</pre><p>At the bottom of <code class="literal">known-city-nodes</code>, we need to figure out which nodes we can “see” based on where we’ve been. We’ll be able to see all visited nodes <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12430"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>, but we also want to track all nodes within one node of a visited node <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12436"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>. (We will discuss the <code class="literal">mapcan</code> function shortly.) We calculate who is “within one” using code similar to the previously discussed <code class="literal">within-one</code> function.</p><p>Next, we <code class="literal">mapcar</code> over this list of relevant nodes, processing each <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12453"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. If the current node is occupied by the player, we mark it with an asterisk <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12459"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. If the node hasn’t been visited yet <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12465"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, we mark it with a question mark <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12471"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p></div><div class="sect3" title="Known Edges"><div class="titlepage"><div><div><h3 class="title"><a id="known_edges"/>Known Edges</h3></div></div></div><p>Now, we need to create an alist stripped of any cop sirens that we haven’t reached yet:</p><a id="I_programlisting6_d1e12482"/><pre class="programlisting">(defun known-city-edges ()
    (mapcar (lambda (node)
              (cons node (mapcar (lambda (x)
                                   (if (member (car x) *visited-nodes*)
                                       x
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>                                      (list (car x))))
                                 (cdr (assoc node *congestion-city-edges*)))))
            *visited-nodes*))</pre><p>This function is similar to the <code class="literal">known-city-nodes</code> function. The noteworthy line of code is here <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12495"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> where we strip the <code class="literal">cdr</code> from the edge list for edges so that cops are indicated on the map only if we’ve visited the nodes on both ends of an edge containing cops.<a id="IDX-CHP-8-0079" class="indexterm"/><a id="IDX-CHP-8-0080" class="indexterm"/><a id="IDX-CHP-8-0081" class="indexterm"/></p></div><div class="sect3" title="The mapcan Function"><div class="titlepage"><div><div><h3 class="title"><a id="the_mapcan_function"/>The mapcan Function</h3></div></div></div><p>The <code class="literal">mapcan</code> function we used in <code class="literal">known-city-nodes</code> is a variant of <code class="literal">mapcar</code>. However, unlike <code class="literal">mapcar</code>, <code class="literal">mapcan</code> assumes that the values generated by the mapping function are all lists that should be appended together. This is useful when there isn’t a one-to-one relationship between the items in a list and the result you want to generate.</p><p>For example, suppose we run a burger shop and sell three types of burgers: the single, the double, and the double cheese. To convert a list of burgers into a list of patties and cheese slices, we could write the following function:</p><a id="I_programlisting6_d1e12537"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun ingredients (order)</code></strong>
     <strong class="userinput"><code>(mapcan (lambda (burger)</code></strong>
                <strong class="userinput"><code>(case burger</code></strong>
                   <strong class="userinput"><code>(single '(patty))</code></strong>
                   <strong class="userinput"><code>(double '(patty patty))</code></strong>
                   <strong class="userinput"><code>(double-cheese '(patty patty cheese))))</code></strong>
             <strong class="userinput"><code>order))</code></strong>
INGREDIENTS
&gt; <strong class="userinput"><code>(ingredients '(single double-cheese double))</code></strong>
'(PATTY PATTY PATTY CHEESE PATTY PATTY)</pre></div><div class="sect3" title="Drawing Only the Known Parts of the City"><div class="titlepage"><div><div><h3 class="title"><a id="drawing_only_the_known_parts_of_the_city"/>Drawing Only the Known Parts of the City</h3></div></div></div><p>Because we now have functions that can generate the known information about nodes and edges, we can write a function that turns this information into a picture, as follows:</p><a id="I_programlisting6_d1e12569"/><pre class="programlisting">(defun draw-known-city ()
  (ugraph-&gt;png "known-city" (known-city-nodes) (known-city-edges)))</pre><p>Now let’s redefine our <code class="literal">new-game</code> function to draw the known city when the game starts:</p><a id="I_programlisting6_d1e12576"/><pre class="programlisting">(defun new-game ()
    (setf *congestion-city-edges* (make-city-edges))
    (setf *congestion-city-nodes* (make-city-nodes *congestion-city-edges*))
    (setf *player-pos* (find-empty-node))
    (setf *visited-nodes* (list *player-pos*))
    (draw-city)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (draw-known-city))</pre><p>This function is almost exactly the same as the previous version of <code class="literal">new-game</code>, except that we also create a drawing composed only of the known parts of the city <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12589"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>.</p><p>Now, if we call the <code class="literal">new-game</code> function from the REPL, we’ll get a new picture named <span class="emphasis"><em>known-city.dot.png</em></span> that we can view in our browser. It will look something like this:<a id="IDX-CHP-8-0082" class="indexterm"/><a id="IDX-CHP-8-0083" class="indexterm"/><a id="IDX-CHP-8-0084" class="indexterm"/><a id="IDX-CHP-8-0085" class="indexterm"/><a id="IDX-CHP-8-0086" class="indexterm"/><a id="IDX-CHP-8-0087" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e12624"/><img src="httpatomoreillycomsourcenostarchimages782216.png.jpg" alt="image with no caption"/></div></div><p>Now we’re ready to walk around our map of Congestion City!</p></div></div><div class="sect2" title="Walking Around Town"><div class="titlepage"><div><div><h2 class="title"><a id="walking_around_town"/>Walking Around Town</h2></div></div></div><p>We’ll need two functions for traveling between the nodes in our city: a regular <code class="literal">walk</code> function and one for when we think we’ve found the Wumpus, and we want to <code class="literal">charge</code> that location with our final bullet. Since these two functions are very similar, we’ll have both of them delegate the bulk of the work to a common <code class="literal">handle-direction</code> function:</p><a id="I_programlisting6_d1e12645"/><pre class="programlisting">(defun walk (pos)
  (handle-direction pos nil))

(defun charge (pos)
  (handle-direction pos t))</pre><p>The only difference between these two functions is the flag they pass to <code class="literal">handle-direction</code>, which is set to either <code class="literal">nil</code> or <code class="literal">t</code>, depending on the kind of traveling.</p><p>The <code class="literal">handle-direction</code> function’s main job is to make sure that a move is legal, which it does by checking the edges of the city:</p><a id="I_programlisting6_d1e12663"/><pre class="programlisting">(defun handle-direction (pos charging)
    (let ((edge (assoc pos
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>                      (cdr (assoc *player-pos* *congestion-city-edges*)))))
      (if edge
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>         (handle-new-place edge pos charging)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>         (princ "That location does not exist!"))))</pre><p>First, this function looks up the legal directions players can move to from their current location <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12685"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. It then uses the <code class="literal">pos</code> the player wants to move to and looks it up in that list of possible directions. Once we’ve determined that a direction is legal (that is, a node with that number shares an edge with the player’s current position), we need to find out what surprises are waiting as the player travels to this new place, using the <code class="literal">handle-new-place</code> function, which we’ll create next <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12697"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Otherwise, we display a helpful error message <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12703"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.<a id="IDX-CHP-8-0088" class="indexterm"/><a id="IDX-CHP-8-0089" class="indexterm"/><a id="IDX-CHP-8-0090" class="indexterm"/></p><p>Now let’s create the <code class="literal">handle-new-place</code> function, which gets called when the player has traveled to a new place:</p><a id="I_programlisting6_d1e12726"/><pre class="programlisting">(defun handle-new-place (edge pos charging)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let* ((node (assoc pos *congestion-city-nodes*))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>          (has-worm (and (member 'glow-worm node)
                          (not (member pos *visited-nodes*)))))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>     (pushnew pos *visited-nodes*)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>     (setf *player-pos* pos)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>     (draw-known-city)
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>     (cond ((member 'cops edge) (princ "You ran into the cops. Game Over."))
<img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/>           ((member 'wumpus node) (if charging
                                       (princ "You found the Wumpus!")
                                       (princ "You ran into the Wumpus")))
<img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/>           (charging (princ "You wasted your last bullet. Game Over."))
<img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/>           (has-worm (let ((new-pos (random-node)))
                        (princ "You ran into a Glow Worm Gang! You're now at ")
                        (princ new-pos)
                        (handle-new-place nil new-pos nil))))))</pre><p>First, we retrieve the node the player is traveling to from the alist of nodes <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12785"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Next, we figure out if the node contains a Glowworm gang <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12791"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. We ignore the gang if they’re in a node already visited, because they’ll only attack once.</p><p>Next, the <code class="literal">handle-new-place</code> function updates <code class="literal">*visited-nodes*</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12805"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>(adding the new position to the list) and <code class="literal">*player-pos*</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12814"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. Then it calls <code class="literal">draw-known-city</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12824"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span> again, since we now have a new place we know about.</p><p>Next, it checks to see if there are any cops on the edge <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12833"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>, and then whether the Wumpus is at that location <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12839"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>. If the player encounters the Wumpus, our <code class="literal">handle-new-place</code> function needs to know whether we were charging the location. If we are charging at the Wumpus, we win the game. Otherwise, the Wumpus kills us and the game is over.</p><p>If, on the other hand, we charge at a location that does not contain the Wumpus, we waste our single bullet and we lose the game as well <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12850"/><img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/></span>. Finally, if the location has a previously unencountered Glowworm gang, jump to a random new location, calling <code class="literal">handle-new-place</code> recursively <span class="inlinemediaobject"><a id="I_inlinemediaobject6_d1e12859"/><img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/></span>.</p><p>Our game is now complete!</p></div></div>
<div class="sect1" title="Let's Hunt Some Wumpus!"><div class="titlepage"><div><div><h1 class="title"><a id="let_apostrophy_s_hunt_some_wumpus_exclam"/>Let's Hunt Some Wumpus!</h1></div></div></div><p>To play our game, simply enter the traveling commands we created (<code class="literal">walk</code> and <code class="literal">charge</code>) at the REPL, then switch to your browser and refresh <span class="emphasis"><em>known-city.dot.png</em></span> to plan your next move.</p><p>For example, here’s where we left off in our sample game:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e12884"/><img src="httpatomoreillycomsourcenostarchimages782820.png.jpg" alt="image with no caption"/></div></div><p>Since we have no clues, we know that any of these nodes will be safe to visit. Let’s try <code class="literal">(walk 20)</code>:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e12895"/><img src="httpatomoreillycomsourcenostarchimages782246.png.jpg" alt="image with no caption"/></div></div><p>Uh oh! There’s blood here. That means the Wumpus must be two nodes away! It should still be safe to (<code class="literal">walk 11</code>) though, because that’s only one node away:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e12906"/><img src="httpatomoreillycomsourcenostarchimages782044.png.jpg" alt="image with no caption"/></div></div><p>Oh no! One of these streets has a police roadblock. Let’s backtrack with <code class="literal">(walk 20) (walk 19)</code>, and then we can try <code class="literal">(walk 7)</code>:<a id="IDX-CHP-8-0091" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e12923"/><img src="httpatomoreillycomsourcenostarchimages780754.png.jpg" alt="image with no caption"/></div></div><p>Darn! Now we have the Wumpus and some Glowworms nearby. Let’s take a shot in the dark and try <code class="literal">(walk 10)</code>:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject6_d1e12935"/><img src="httpatomoreillycomsourcenostarchimages780248.png.jpg" alt="image with no caption"/></div></div><p>Well, that didn’t help, since there are cops down this path. However, because node 10 has only one other unexplored street, we can say with certainty that the street between 1 and 10 has cops on it.</p><p>You can see that it takes some serious thinking to become a master in Grand Theft Wumpus! Remember, you can always start a new game, with a new map, by using the <code class="literal">new-game</code> function. Once you’ve tracked down the Wumpus, use the <code class="literal">charge</code> function to attack him.</p><p>If you master the basic version of this game, try increasing the number of nodes, edges, cops, and Glowworms for an even greater challenge!</p></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id8"/>What You've Learned</h1></div></div></div><p>In this chapter, we’ve used graph utilities with Lisp to make a more sophisticated game. Along the way, you learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The <code class="literal">loop</code> function allows us to loop across various types of data. It will be discussed in more detail in <a class="xref" href="ch11.html" title="Chapter 10. Looping with the loop Command">Chapter 10</a>.</p></li><li class="listitem"><p>The <code class="literal">set-difference</code> function tells you which items are in one list but not in another list.</p></li><li class="listitem"><p>The <code class="literal">intersection</code> function tells you which items are shared by lists.</p></li><li class="listitem"><p>The <code class="literal">remove-duplicates</code> function removes duplicate items from a list.</p></li></ul></div></div>
<div class="chapter" title="Chapter&#xA0;9.&#xA0;Advanced Datatypes and Generic Programming"><div class="titlepage"><div><div><h1 class="title"><a id="advanced_datatypes_and_generic_programmi"/>Chapter 9. Advanced Datatypes and Generic Programming</h1></div></div></div><p>As you’ve seen so far, a lot can be accomplished in Lisp by using cons cells, symbols, strings, and numeric datatypes. As a very mature language, Common Lisp contains many more datatypes that move well beyond these basics. In this chapter, we will discuss the most useful of these advanced datatypes, including arrays, hash tables, and structures.<a id="IDX-CHP-9-0001" class="indexterm"/></p><div class="sect1" title="Arrays"><div class="titlepage"><div><div><h1 class="title"><a id="arrays"/>Arrays</h1></div></div></div><p>The <span class="emphasis"><em>Common Lisp array</em></span> is very similar to a list. The main advantage of using arrays is that they require only a constant amount of time to access a value at any specific location. We’ll be discussing what this means shortly.</p><div class="sect2" title="Working with Arrays"><div class="titlepage"><div><div><h2 class="title"><a id="working_with_arrays"/>Working with Arrays</h2></div></div></div><p>To create a new array, use the <code class="literal">make-array</code> command, specifying the array’s size:<a id="IDX-CHP-9-0002" class="indexterm"/><a id="IDX-CHP-9-0003" class="indexterm"/><a id="IDX-CHP-9-0004" class="indexterm"/><a id="IDX-CHP-9-0005" class="indexterm"/><a id="IDX-CHP-9-0006" class="indexterm"/></p><a id="I_programlisting7_d1e13025"/><pre class="programlisting">&gt; <strong class="userinput"><code>(make-array 3)</code></strong>
#(NIL NIL NIL)</pre><p>This creates an array of length 3. In order to indicate that the value created is not just a list, Common Lisp prepends a hash mark (#) in front of the array.</p><p>To get and set items in an array, use the <code class="literal">aref</code> function. For example, here’s how we get the item at index 1:</p><a id="I_programlisting7_d1e13037"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter x (make-array 3))</code></strong>
#(NIL NIL NIL)
&gt; <strong class="userinput"><code>(aref x 1)</code></strong>
NIL</pre><p>Of course, our array is just filled with <code class="literal">nil</code>s right now, so there’s not much worth getting. To set items in the array to more interesting values, use <code class="literal">aref</code> in conjunction with the <code class="literal">setf</code> command:</p><a id="I_programlisting7_d1e13056"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter x (make-array 3))</code></strong>
#(NIL NIL NIL)
&gt; <strong class="userinput"><code>(setf (aref x 1) 'foo)</code></strong>
FOO
&gt; <strong class="userinput"><code>x</code></strong>
#(NIL FOO NIL)
&gt; <strong class="userinput"><code>(aref x 1)</code></strong>
FOO</pre><p>Although <code class="literal">aref</code> is usually a command used to <span class="emphasis"><em>get</em></span> a value out of an array, when used in this special way indicated in the example, it lets us <span class="emphasis"><em>set</em></span> a value in an array, instead. This ability to use the <code class="literal">setf</code> and <code class="literal">aref</code> commands together shows off a feature in Common Lisp: its support for generic programming. Let’s take a closer look at the <code class="literal">setf</code> command to learn more about how this feature works.</p></div><div class="sect2" title="Using a Generic Setter"><div class="titlepage"><div><div><h2 class="title"><a id="using_a_generic_setter"/>Using a Generic Setter</h2></div></div></div><p>The Common Lisp language is said to support <span class="emphasis"><em>generic setters</em></span>. This means that in most cases, the code for <span class="emphasis"><em>pulling a value out of</em></span> a data structure (whether an array, list, string, or something else) is identical to the code for <span class="emphasis"><em>putting data into</em></span> that same data structure. The <code class="literal">setf</code> command can be used in conjunction with functions that perform getting operations and can use the same functions to perform setting operations, instead.<a id="IDX-CHP-9-0007" class="indexterm"/></p><p>We’ve already seen that <code class="literal">aref</code> can be used to get values out of an array, and when used with <code class="literal">setf</code>, it can be used for setting values in the same array. The <code class="literal">setf</code> command can perform this trick in a general way across most of the commands in Common Lisp that get items from a data structure. Take, for instance, the following example involving a list:<a id="IDX-CHP-9-0008" class="indexterm"/><a id="IDX-CHP-9-0009" class="indexterm"/></p><a id="I_programlisting7_d1e13128"/><pre class="programlisting">&gt; <strong class="userinput"><code>(setf foo '(a b c))</code></strong>
  (A B C)
  &gt; <strong class="userinput"><code>(second foo)</code></strong>
  B
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(setf (second foo) 'z)</code></strong>
  Z
  &gt; foo
  (A Z C)</pre><p>As you would expect, the expression <code class="literal">(second foo)</code> returns <code class="literal">B</code>. But, when we pass <code class="literal">(second foo)</code> to the <code class="literal">setf</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13159"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, it somehow knows where the <code class="literal">B</code> came from, and it is able to treat the expression <code class="literal">(second foo)</code> as if it were a regular variable. Basically, the <code class="literal">setf</code> command asks itself the question, “Where did the item in my first argument originally come from?” In this case, the value came from the second item in the list named <code class="literal">foo</code>. Therefore, if we try to <code class="literal">setf</code> this location, the source variable, <code class="literal">foo</code>, is modified in response.</p><p>In fact, the first argument in <code class="literal">setf</code> is a special sublanguage of Common Lisp, called a <span class="emphasis"><em>generalized reference</em></span>. Not every Lisp command is allowed in a generalized reference, but you can still put in some pretty complicated stuff:<a id="IDX-CHP-9-0010" class="indexterm"/></p><a id="I_programlisting7_d1e13195"/><pre class="programlisting">&gt; <strong class="userinput"><code>(setf foo (make-array 4))</code></strong>
  #(NIL NIL NIL NIL)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(setf (aref foo 2) '(x y z))</code></strong>
  (X Y Z)
  &gt; <strong class="userinput"><code>foo</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> #(NIL NIL (X Y Z) NIL)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> &gt; <strong class="userinput"><code>(setf (car (aref foo 2)) (make-hash-table))</code></strong>
  #S(HASH-TABLE)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/> &gt; <strong class="userinput"><code>(setf (gethash 'zoink (car (aref foo 2))) 5)</code></strong>
  5
  &gt; <strong class="userinput"><code>foo</code></strong>
  #(NIL NIL (#S(HASH-TABLE (ZOINK . 5)) Y Z) NIL)</pre><p>This example demonstrates the true power of <code class="literal">setf</code> in Common Lisp. In the first use, we put the list <code class="literal">(x y z)</code> into an array as the third item <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13248"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. If we now print <code class="literal">foo</code>, we can see that it worked <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13257"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. In the second use, we replace the first item in this list inside the <code class="literal">foo</code> array with a hash table <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13267"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. Hash tables are another advanced data type we’ll be learning about shortly, in <a class="xref" href="ch10s02.html" title="Hash Tables">Hash Tables</a>. It is surprisingly easy to do this with <code class="literal">setf</code>, because the generalized reference in the first argument to <code class="literal">setf</code> can be arbitrarily complicated.<a id="IDX-CHP-9-0011" class="indexterm"/></p><p>Finally, we go all out and insert the value <code class="literal">5</code> into this hash table with the key of <code class="literal">zoink</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13292"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. The <code class="literal">gethash</code> function lets you get a value out of a hash table, as we’ll see shortly. Here, with the help of <code class="literal">setf</code>, we are putting the number 5 into the hash table instead.</p><p>I hope you can appreciate from this example how useful <code class="literal">setf</code> can be when modifying complicated data structures in a program.</p><p>Another cool feature of <code class="literal">setf</code> is that you can expand the generalized reference syntax to support new ways of accessing values. <code class="literal">setf</code> is a truly generic way of modifying values, regardless of the level of nesting or the datatypes being used.<a id="IDX-CHP-9-0012" class="indexterm"/><a id="IDX-CHP-9-0013" class="indexterm"/><a id="IDX-CHP-9-0014" class="indexterm"/><a id="IDX-CHP-9-0015" class="indexterm"/><a id="IDX-CHP-9-0016" class="indexterm"/><a id="IDX-CHP-9-0017" class="indexterm"/><a id="IDX-CHP-9-0018" class="indexterm"/></p></div><div class="sect2" title="Arrays vs. Lists"><div class="titlepage"><div><div><h2 class="title"><a id="arrays_vs._lists"/>Arrays vs. Lists</h2></div></div></div><p>You’ve now seen some basic examples of working with arrays in Lisp. However, to fully understand the benefits of arrays, we need to compare them with lists.</p><p>Almost anything that can be done with a list can also be done with an array. However, arrays are usually much faster than lists when accessing specific elements, so the difference is in performance.</p><p>For example, the array-handling function <code class="literal">aref</code> is very similar to a list-handling function called <code class="literal">nth</code>, which allows you access to an item at a specific location in a regular list without using an array. Here is an example using <code class="literal">nth</code> on a list:</p><a id="I_programlisting7_d1e13365"/><pre class="programlisting">&gt; <strong class="userinput"><code>(nth 1 '(foo bar baz))</code></strong>
BAR</pre><p>However, it makes sense to use the <code class="literal">nth</code> function only with very small lists. If, for example, list X had thousands of items in it, running the command <code class="literal">(nth 1000 x)</code> would be excruciatingly slow, because Lisp lists are made out of chains of cons cells. Hence, the only way Lisp can find the thousandth item in a list is to churn through the 999 preceding objects first.</p><p>In contrast, running the command <code class="literal">(aref x 1000)</code> on a large array accesses the thousandth item directly, without counting through the previous 999 items. This means <code class="literal">aref</code> will execute much more quickly on a large array than the <code class="literal">nth</code> command would on a large list. In fact, an <code class="literal">aref</code> call will happen very quickly no matter how large the array. Even if you had an array with a billion items, retrieving the last item would still happen very quickly. The only real limiting factor is your system: the amount of RAM your computer has and how capable your Lisp environment is of taking advantage of it.<a id="IDX-CHP-9-0019" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject7_d1e13396"/><img src="httpatomoreillycomsourcenostarchimages782996.png.jpg" alt="image with no caption"/></div></div><p>Not only can we quickly access array values, but we can also change values at any specific location, usually faster than we can by performing the same operations on a list.<a id="IDX-CHP-9-0020" class="indexterm"/></p><p>Because setting and getting specific values in a large data structure is so important, keep arrays in mind as a tool to help you get the best performance possible with your code.</p></div></div></div>
<div class="sect1" title="Hash Tables"><div class="titlepage"><div><div><h1 class="title"><a id="hash_tables"/>Hash Tables</h1></div></div></div><p>In the same way that arrays are sort of like lists, <span class="emphasis"><em>hash tables</em></span> are sort of like <span class="emphasis"><em>alists</em></span>, except that they also allow you to access arbitrary elements more quickly.<a id="IDX-CHP-9-0021" class="indexterm"/></p><p>In fact, hash tables are so efficient that they can, at times, seem like magic. Think of the Babel fish in the <span class="emphasis"><em>Hitchhiker’s Guide to the Galaxy</em></span> trilogy—something so impossibly useful that it really has no business existing in the first place. That’s why almost all modern languages now offer the hash table datatype.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject7_d1e13428"/><img src="httpatomoreillycomsourcenostarchimages781664.png" alt="image with no caption"/></div></div><div class="sect2" title="Working with Hash Tables"><div class="titlepage"><div><div><h2 class="title"><a id="working_with_hash_tables"/>Working with Hash Tables</h2></div></div></div><p>Create a new hash table with the <code class="literal">make-hash-table</code> command:</p><a id="I_programlisting7_d1e13441"/><pre class="programlisting">&gt; <strong class="userinput"><code>(make-hash-table)</code></strong>
#S(HASH-TABLE ...)</pre><p>Like alists, hash tables store items using a lookup key and a value. We can retrieve an item from the hash table using the item’s key with the <code class="literal">gethash</code> function:<a id="IDX-CHP-9-0022" class="indexterm"/><a id="IDX-CHP-9-0023" class="indexterm"/></p><a id="I_programlisting7_d1e13457"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter x (make-hash-table))</code></strong>
  #S(HASH-TABLE ...)
  &gt; <strong class="userinput"><code>(gethash 'yup x)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> NIL ;
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> NIL</pre><p>So far, our hash table remains empty. This means that when we look up any key in the hash table, such as <code class="literal">'yup</code> in this example, we receive <code class="literal">NIL</code> as an answer <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13485"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Actually, we receive two NILs <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13491"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13496"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>—the <code class="literal">gethash</code> command returns multiple values, which you can do in Common Lisp (discussed in the next section). The first returned value is the actual value stored in the hash table, and the second indicates whether the key was found in the table (in this case, it wasn’t).</p><p>Just as with arrays, we can once again combine a command used for referencing data elements—in this case, <code class="literal">gethash</code>—with the <code class="literal">setf</code> command in order to fill our table with data:</p><a id="I_programlisting7_d1e13513"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter x (make-hash-table))</code></strong>
  #S(HASH-TABLE ...)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(setf (gethash 'yup x) '25)</code></strong>
  25
  &gt; <strong class="userinput"><code>(gethash 'yup x)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> 25 ;
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> T</pre><p>In this example, we’ve stored the value <code class="literal">25</code> in the hash table with a lookup key of <code class="literal">yup</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13551"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Then, when we look up <code class="literal">yup</code> in the table, we get the answer of 25 <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13560"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. We also get a second value of <code class="literal">t</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13570"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, which means, “Yes, I found the key in the table.”</p><p>Remember when we discussed alists, we set up a data structure containing an order for coffee drinks? Here is that same data, but this time it’s stored using a hash table:</p><a id="I_programlisting7_d1e13578"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter *drink-order* (make-hash-table))</code></strong>
#S(HASH-TABLE ...)
&gt; <strong class="userinput"><code>(setf (gethash 'bill *drink-order*) 'double-espresso)</code></strong>
DOUBLE-ESPRESSO
&gt; <strong class="userinput"><code>(setf (gethash 'lisa *drink-order*) 'small-drip-coffee)</code></strong>
SMALL-DRIP-COFFEE
&gt; <strong class="userinput"><code>(setf (gethash 'john *drink-order*) 'medium-latte)</code></strong>
MEDIUM-LATTE</pre><p>Accessing the drink order for any person is now simple:</p><a id="I_programlisting7_d1e13595"/><pre class="programlisting">&gt; <strong class="userinput"><code>(gethash 'lisa *drink-order*)</code></strong>
'small-drip-coffee ;
T</pre></div><div class="sect2" title="Returning Multiple Values"><div class="titlepage"><div><div><h2 class="title"><a id="returning_multiple_values"/>Returning Multiple Values</h2></div></div></div><p>Common Lisp allows you to return more than one value as a result. Some of the core Common Lisp core functions do this, including the <code class="literal">gethash</code> function, as you’ve seen. Another commonly used function that does this is the <code class="literal">round</code> function, which rounds off a number:<a id="IDX-CHP-9-0024" class="indexterm"/><a id="IDX-CHP-9-0025" class="indexterm"/><a id="IDX-CHP-9-0026" class="indexterm"/><a id="IDX-CHP-9-0027" class="indexterm"/></p><a id="I_programlisting7_d1e13625"/><pre class="programlisting">&gt; <strong class="userinput"><code>(round 2.4)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> 2 ;
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> 0.4</pre><p>Calling this function appropriately rounded our number to 2 <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13644"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, but then it also generated a second value, which is the remainder of the rounding operation <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13650"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Both values are returned from this function call.</p><p>You can also create multiple values in your own code by using the <code class="literal">values</code> function. Here, for instance, we can write a <code class="literal">foo</code> function that returns two separate numbers, 3 and 7:</p><a id="I_programlisting7_d1e13664"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun foo ()</code></strong>
      <strong class="userinput"><code>(values 3 7))</code></strong>
  FOO
  &gt; <strong class="userinput"><code>(foo)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> 3 ;
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> 7</pre><p>Both of these values are printed out at the REPL <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13689"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13694"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, just as with the <code class="literal">round</code> function. However, Lisp considers the first value to be more important, and it will always be used by default during follow-up calculations. For instance, we can perform an addition after calling <code class="literal">foo</code>, like this:</p><a id="I_programlisting7_d1e13706"/><pre class="programlisting">&gt; <strong class="userinput"><code>(+ (foo) 5)</code></strong>
8</pre><p>In this case, the addition operator just ignores the second value that <code class="literal">foo</code> returns.</p><p>However, sometimes you might need to use that additional returned value. You can do this by using the <code class="literal">multiple-value-bind</code> command:</p><a id="I_programlisting7_d1e13721"/><pre class="programlisting">&gt; <strong class="userinput"><code>(multiple-value-bind (a b) (foo)</code></strong>
                       <strong class="userinput"><code>(* a b))</code></strong>
21</pre><p>In this example, we’ve bound the variables <code class="literal">a</code> and <code class="literal">b</code> to both of the values returned by <code class="literal">foo</code> (<code class="literal">3</code> and <code class="literal">7</code>). Calling our function with <code class="literal">multiple-value-bind</code> lets us use the extra values returned from the function, which would otherwise be ignored.</p><p>You might be wondering whether you could just return a list from your function instead of using the multiple-value feature. The answer is, yes, you could. However, it’s possible that using the multiple-value feature can lead to more optimized and cleaner code.</p><p>In this book, we will not be making much use of multiple values. In fact, more recent Lisp dialects, such as Arc and Clojure, do not support multiple values at all. Instead, they just return a list in the few cases where more than one value needs to be returned.<a id="IDX-CHP-9-0028" class="indexterm"/><a id="IDX-CHP-9-0029" class="indexterm"/><a id="IDX-CHP-9-0030" class="indexterm"/><a id="IDX-CHP-9-0031" class="indexterm"/><a id="IDX-CHP-9-0032" class="indexterm"/><a id="IDX-CHP-9-0033" class="indexterm"/><a id="IDX-CHP-9-0034" class="indexterm"/><a id="IDX-CHP-9-0035" class="indexterm"/></p></div><div class="sect2" title="Hash Table Performance"><div class="titlepage"><div><div><h2 class="title"><a id="hash_table_performance"/>Hash Table Performance</h2></div></div></div><p>As with arrays, accessing and modifying a value inside a hash table requires only a constant amount of time, no matter how many items your hash table contains. For instance, suppose we have a hash table with only 10 items in it. We access a value in the table, using a key, and find it takes on average 1 millisecond to do so. Now suppose that the hash table has 1,000,000 items in it. Because of how hash tables are designed, we could still expect it to take only about 1 millisecond to retrieve a value. In other words, no matter how big the table is, we can access items at a constant time of 1 millisecond.</p><p>Think of how incredible that is! Even if your hash table contained 1,000,000 items, the <code class="literal">gethash</code> function could take the key you gave it and determine in a constant amount of time exactly where your desired item could be found!</p><p>In this era of web-based programs backed by enormous amounts of data, the ability of hash tables to store large numbers of values with fast retrieval makes them indispensable. The efficient storage of key/value pairs is essential for most online storage systems. Even the latest tools for storing vast amounts of online data, like Google’s BigTable or Amazon’s S3, are built around the quick retrieval of values using keys, which makes them similar to hash tables.<a id="IDX-CHP-9-0036" class="indexterm"/></p><p>However, you can’t always expect hash tables to provide the best performance. Here’s why:</p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>Virtual memory paging and cache misses:</strong></span></span></dt><dd><p>As with arrays, large hash tables may cause your operating system to start paging virtual memory to your hard drive, thus degrading performance. Similarly, they can increase the number of cache misses within your CPU.</p></dd><dt><span class="term"><span class="strong"><strong>Hash collisions:</strong></span></span></dt><dd><p>Internally, hash tables use a special function called a <span class="emphasis"><em>hash function</em></span>, which converts keys into numbers. Such a hash function can cause <span class="emphasis"><em>hash collisions</em></span>. Basically, a hash collision happens when, by chance, two keys are converted by the hash function into the same number. In this case, the hash table will still behave correctly, but at a slightly degraded performance. In rare cases, certain types of keys can interact with a hash function to increase the number of collisions and impede an application’s ability to perform lookups, degrading performance even more.<a id="IDX-CHP-9-0037" class="indexterm"/></p></dd><dt><span class="term"><span class="strong"><strong>Inefficiency with small tables:</strong></span></span></dt><dd><p>With very small tables, the creation and lookup time required by hash tables can make them less inefficient than simpler structures, such as alists. The performance benefits of hash tables are noticeable only when they contain larger amounts of data in them.</p></dd><dt><span class="term"><span class="strong"><strong>Varying speed for operations:</strong></span></span></dt><dd><p>In Common Lisp, if you create a small hash table, and then fill it with values, you will find that occasionally, adding a new value will be unusually slow. This is because the <code class="literal">make-hash-table</code> function is designed to minimize the cost for creating small hash tables. However, as you start adding values to make the table big, Lisp will need to take extra time to allocate more memory so that the table can hold more items. These extra allocations will lead to occasional slow insertions into the table as it grows.<a id="IDX-CHP-9-0038" class="indexterm"/><a id="IDX-CHP-9-0039" class="indexterm"/><a id="IDX-CHP-9-0040" class="indexterm"/><a id="IDX-CHP-9-0041" class="indexterm"/><a id="IDX-CHP-9-0042" class="indexterm"/></p></dd></dl></div><p>There is one final reason why hash tables are not always the best solution: They are simply not as Lispy as traditional Lisp structures built from cons cells. This means they can be harder to debug than cons cells, since they cannot be read and printed as naturally in the Lisp REPL. Therefore, a good rule of thumb is to stay away from arrays and hash tables as you conceive a new piece of code. Then, if performance ends up becoming an issue, and only then, judiciously modify the critical sections of your code to take advantage of arrays and hash tables to resolve any performance problems.</p></div><div class="sect2" title="A Faster Grand Theft Wumpus Using Hash Tables"><div class="titlepage"><div><div><h2 class="title"><a id="a_faster_grand_theft_wumpus_using_hash_t"/>A Faster Grand Theft Wumpus Using Hash Tables</h2></div></div></div><p>Let’s look at a practical example of what hash tables can do for your code. There is a glaring inefficiency in our latest game, Grand Theft Wumpus, that we can now correct with hash tables.<a id="IDX-CHP-9-0043" class="indexterm"/></p><p>Recall from the previous chapter that Grand Theft Wumpus uses lists of nodes and edges to represent the graph of the city. This means that in order to find connections to a given node, we must do a linear search through a list. This isn’t a big deal in Grand Theft Wumpus, because Congestion City doesn’t have a lot of intersections. But what if our city had a thousand nodes with a thousand edges? Let’s time the <code class="literal">get-connected</code> function and see what kind of numbers we get:</p><a id="I_programlisting7_d1e13879"/><pre class="programlisting">&gt; <strong class="userinput"><code>(setf *edge-num* 1000)</code></strong>
1000
&gt; <strong class="userinput"><code>(setf *node-num* 1000)</code></strong>
1000
&gt; <strong class="userinput"><code>(time (dotimes (i 100) (get-connected 1 (make-edge-list))))</code></strong>
Real time: 57.699303 sec.
Run time: 57.687607 sec.
Space: 39566832 Bytes
GC: 43, GC time: 0.120005 sec.</pre><p>The <code class="literal">time</code> command is a Lisp utility that outputs all kinds of useful timing information about a chunk of code, and the <code class="literal">dotimes</code> function lets us run our code 100 times, building 100 cities. Using these commands, it took about a minute to run this code on my computer. Given how many gazillion instructions a CPU can crunch in a minute, this is absolutely horrifyingly bad performance.</p><p>To fix this problem, we’ll replace our edge list for this code with a hash table so that the <code class="literal">get-connected</code> function will be able to find connections to a node in constant time. We’ll also replace our visited list with a visited table, so the function can quickly tell whether a node has already been visited.<a id="IDX-CHP-9-0044" class="indexterm"/><a id="IDX-CHP-9-0045" class="indexterm"/><a id="IDX-CHP-9-0046" class="indexterm"/><a id="IDX-CHP-9-0047" class="indexterm"/><a id="IDX-CHP-9-0048" class="indexterm"/><a id="IDX-CHP-9-0049" class="indexterm"/></p><p>Here is the code that makes this happen, consisting of hashed versions of our previous functions:</p><a id="I_programlisting7_d1e13927"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (defun hash-edges (edge-list)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (let ((tab (make-hash-table)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>     (mapc (lambda (x)
              (let ((node (car x)))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>               (push (cdr x) (gethash node tab))))
            edge-list)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>     tab))</pre><p>First, we need <code class="literal">hash-edges</code>, a function that converts our edge list into a hash table <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13963"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. At the beginning of the function, we create a new hash table and name it <code class="literal">tab</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13972"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Then, we iterate through the table with <code class="literal">mapc</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13982"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. Remember that <code class="literal">mapc</code> is just like <code class="literal">mapcar</code>, except that you use it in places where you care only about the side effects and don’t care about generating a final list as a result.</p><p>For every node, we want the table to contain a list of nodes connected to it. Therefore, as we iterate through the list, we push a new neighbor onto the current list of neighbors for the current starting node <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e13996"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. We can use the <code class="literal">push</code> command on hash table values just as for regular Lisp variable values. This, again, makes use of the general variables system built into Common Lisp, which we’ll discuss in <a class="xref" href="ch10s04.html" title="Handling Data in a Generic Way">Handling Data in a Generic Way</a> in <a class="xref" href="ch10s04.html" title="Handling Data in a Generic Way">Handling Data in a Generic Way</a>.</p><p>You may be wondering why we don’t need to deal with the case where there is no value yet for a node in the table. How can we <code class="literal">push</code> something into a value in the table if no value exists? Well, it turns out that because the <code class="literal">gethash</code> function returns <code class="literal">NIL</code> when a key is not found in the table, this code will simply push the new neighbor onto an empty list and stick a new record into the table where none was found before. In this way, the <code class="literal">push</code> command magically does the “right thing,” no matter whether the node is new or old.</p><p>Finally, once our table is populated, we return it as a result <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14026"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>. It contains the same data as the original edge list. The difference is that we can now find the neighbors of any node in Congestion City at blazing speeds.</p><a id="I_programlisting7_d1e14032"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>  (defun get-connected-hash (node edge-tab)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (let ((visited (make-hash-table)))
      (labels ((traverse (node)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>                (unless (gethash node visited)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>                  (setf (gethash node visited) t)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>                  (mapc (lambda (edge)
                           (traverse edge))
                         (gethash node edge-tab)))))
        (traverse node))
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>     visited))</pre><p>Now we’re ready to write <code class="literal">get-connected-hash</code>, which retrieves all the nodes connected to a starting node in Congestion City <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14074"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. It is identical in behavior to <code class="literal">get-connected</code>, but is optimized through hash tables.<a id="IDX-CHP-9-0050" class="indexterm"/><a id="IDX-CHP-9-0051" class="indexterm"/><a id="IDX-CHP-9-0052" class="indexterm"/><a id="IDX-CHP-9-0053" class="indexterm"/><a id="IDX-CHP-9-0054" class="indexterm"/><a id="IDX-CHP-9-0055" class="indexterm"/><a id="IDX-CHP-9-0056" class="indexterm"/></p><p>The first thing this function does is create a hash table of visited nodes <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14109"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Then we travel through the nodes of Congestion City, beginning with the starting node. Every time we visit a new node, we ask ourselves if we’ve visited it before. We can now answer this question very efficiently by looking up the current node in the <code class="literal">visited</code> table <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14118"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. If the answer is no, we’ll need to mark this node as visited <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14124"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span> and check all of its neighbors by <code class="literal">mapc</code>ing through them—checking our edge table <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14134"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>. Finally, we return our <code class="literal">visited</code> table, which in the end will hold all nodes that are connected to the starting node <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14143"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>.</p><p>Now we can rerun our test with this new logic:</p><a id="I_programlisting7_d1e14151"/><pre class="programlisting">&gt; <strong class="userinput"><code>(time (dotimes (i 100)</code></strong>
                 <strong class="userinput"><code>(get-connected-hash 1 (hash-edges (make-edge-list)))))</code></strong>
Real time: 1.221269 sec.
Run time: 1.224076 sec.
Space: 33096264 Bytes
GC: 36, GC time: 0.10801 sec. :</pre><p>As you can see, instead of taking a minute to calculate the connections in the graph, it now takes only one second to do the same thing! This is why you must know how to use hash tables.</p></div></div>
<div class="sect1" title="Common Lisp Structures"><div class="titlepage"><div><div><h1 class="title"><a id="common_lisp_structures"/>Common Lisp Structures</h1></div></div></div><p>A <span class="emphasis"><em>structure</em></span> is an advanced datatype available in Common Lisp. Structures and their properties can be a useful way to represent data in your code.</p><div class="sect2" title="Working with Structures"><div class="titlepage"><div><div><h2 class="title"><a id="working_with_structures"/>Working with Structures</h2></div></div></div><p>Structures can be used to represent objects with properties, as you might find in a typical object-oriented programming (OOP) language using the <code class="literal">defstruct</code> command, like so:</p><a id="I_programlisting7_d1e14177"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defstruct person</code></strong>
             <strong class="userinput"><code>name</code></strong>
             <strong class="userinput"><code>age</code></strong>
             <strong class="userinput"><code>waist-size</code></strong>
             <strong class="userinput"><code>favorite-color)</code></strong>
PERSON</pre><p>According to the definition in this structure, a <code class="literal">person</code> has four properties (also called <span class="emphasis"><em>slots</em></span> by Lispers): <code class="literal">name</code>, <code class="literal">age</code>, <code class="literal">waist-size</code>, and <code class="literal">favorite-color</code>.<a id="IDX-CHP-9-0057" class="indexterm"/></p><p>Having defined this structure, we can create instances of a person using the <code class="literal">make-person</code> command, a special function that <code class="literal">defstruct</code> has automatically created for us:<a id="IDX-CHP-9-0058" class="indexterm"/><a id="IDX-CHP-9-0059" class="indexterm"/><a id="IDX-CHP-9-0060" class="indexterm"/><a id="IDX-CHP-9-0061" class="indexterm"/><a id="IDX-CHP-9-0062" class="indexterm"/><a id="IDX-CHP-9-0063" class="indexterm"/><a id="IDX-CHP-9-0064" class="indexterm"/></p><a id="I_programlisting7_d1e14250"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter *bob* (make-person :name "Bob"</code></strong>
                                   <strong class="userinput"><code>:age 35</code></strong>
                                   <strong class="userinput"><code>:waist-size 32</code></strong>
                                   <strong class="userinput"><code>:favorite-color "blue"))</code></strong>
*BOB*</pre><p>Now when we enter <code class="literal">*bob*</code> into the REPL, we see our new person marked as a structure with the <code class="literal">#S</code> prefix. We also see that the structure is of type <code class="literal">person</code>, and the values of each of its properties (<code class="literal">name</code>, <code class="literal">age</code>, <code class="literal">waist size</code>, and <code class="literal">favorite-color</code>):</p><a id="I_programlisting7_d1e14288"/><pre class="programlisting">&gt; <strong class="userinput"><code>*bob*</code></strong>
#S(PERSON :NAME "Bob" :AGE 35 :WAIST-SIZE 32 :FAVORITE-COLOR "blue")</pre><p>We can determine Bob’s age by calling another automatically created function, <code class="literal">person-age</code>:</p><a id="I_programlisting7_d1e14298"/><pre class="programlisting">&gt; <strong class="userinput"><code>(person-age *bob*)</code></strong>
35</pre><p>We can also use <code class="literal">setf</code> with these commands to change Bob’s age. (Happy birthday, Bob!)</p><a id="I_programlisting7_d1e14309"/><pre class="programlisting">&gt; <strong class="userinput"><code>(setf (person-age *bob*) 36)</code></strong>
36</pre><p>The Lisp reader can also create a person directly from the printed representation of the person, another great example of the print/read symmetry in Lisp:</p><a id="I_programlisting7_d1e14316"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(defparameter *that-guy* #S(person :name</code></strong>
 <strong class="userinput"><code>"Bob" :age 35 :waist-size 32 :favorite-color "blue"))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> <strong class="userinput"><code>&gt; (person-age *that-guy*)</code></strong>
  35</pre><p>Here, we’re creating a new variable called <code class="literal">*that-guy*</code>, and we set its value using only the printed representation of the person <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14343"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. This variable now has a real <code class="literal">person</code> structure in it, just as if we had used the <code class="literal">make-person</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14355"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.</p><p>As you can see, <code class="literal">defstruct</code> is quite a powerful command that can be used to build special functions that make it easy to create instances of a new object and access its properties.</p></div><div class="sect2" title="When to Use Structures"><div class="titlepage"><div><div><h2 class="title"><a id="when_to_use_structures"/>When to Use Structures</h2></div></div></div><p>These days, many mainstream programmers believe that object orientation is a necessity when developing large and robust applications. Many Lispers, on the other hand, believe that it’s possible to build high-quality software without taking a purely OOP approach.<a id="IDX-CHP-9-0065" class="indexterm"/><a id="IDX-CHP-9-0066" class="indexterm"/><a id="IDX-CHP-9-0067" class="indexterm"/><a id="IDX-CHP-9-0068" class="indexterm"/><a id="IDX-CHP-9-0069" class="indexterm"/><a id="IDX-CHP-9-0070" class="indexterm"/><a id="IDX-CHP-9-0071" class="indexterm"/></p><p>Beginning with <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>, we’ll examine some of these alternate approaches, including higher-order functional programming and domain-specific language programming. The design of the Lisp language makes it much easier to take advantage of these alternate approaches than is possible with other, more object-oriented languages.</p><p>Regardless, even if you’re not writing purely OOP-style software, structures and their properties can still prove to be a useful way to represent data in your code. For instance, instead of creating a <code class="literal">person</code> class with <code class="literal">defstruct</code>, we could do the same thing with a standard list and our own <code class="literal">make-person</code> function. After all, why bother with structures if we can just roll our own person using lists, like so:</p><a id="I_programlisting7_d1e14417"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun make-person (name age waist-size favorite-color)</code></strong>
        <strong class="userinput"><code>(list name age waist-size favorite-color))</code></strong>
  MAKE-PERSON
  &gt; <strong class="userinput"><code>(defun person-age (person)</code></strong>
        <strong class="userinput"><code>(cadr person))</code></strong>
  PERSON-AGE
  &gt; <strong class="userinput"><code>(defparameter *bob* (make-person "bob" 35 32 "blue"))</code></strong>
  *BOB*
  &gt; <strong class="userinput"><code>*bob*</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> ("bob" 35 32 "blue")
  &gt; <strong class="userinput"><code>(person-age *bob*)</code></strong>
  35</pre><p>Although this approach will work, it has several downsides. First, in order to check a person’s age or other properties, we would need to write a lot of error-prone functions that pull properties out of the list from the correct locations. Also, the printed version of our ad hoc object <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14449"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> is very hard to understand. How do we know <code class="literal">BOB</code> is a person? Is Bob’s age 35 or 32? Regular lists just don’t lend themselves well to encoding objects with multiple properties.</p><p>Another problem with using lists to represent an object in the real world is that the properties of an object (like a <code class="literal">person</code> object) may change over time. Lists in Lisp work best when you are dealing with information that never changes once the list is created. When Bob turns 36, however, we need to change his age property.</p><p>Having part of a data structure change over time is called a <span class="emphasis"><em>mutation</em></span> by computer scientists. It’s easy to change the value of a specific property (mutate the property) in a structure created with <code class="literal">defstruct</code>, so these structures are very suitable for handling data that needs to be mutable. Therefore, it makes sense to store a <code class="literal">person</code> (or any other object that changes over time) in a structure. We will be discussing the issue of mutation in greater detail in <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>The <code class="literal">defstruct</code> facility is not the only tool that can be used to create objects in Common Lisp. For example, in the epilogue of the book, you’ll see that Common Lisp’s Common Lisp Object System (CLOS) allows you to build very sophisticated object-based systems. If you care to code with a strongly object-oriented mindset, you will probably find all the OOP language functionality you need in Common Lisp. Indeed, CLOS has many advanced object-oriented features that you won’t find in many other places. Because of this, CLOS has often been used as a research tool for studying OOP ideas.<a id="IDX-CHP-9-0072" class="indexterm"/><a id="IDX-CHP-9-0073" class="indexterm"/><a id="IDX-CHP-9-0074" class="indexterm"/><a id="IDX-CHP-9-0075" class="indexterm"/><a id="IDX-CHP-9-0076" class="indexterm"/><a id="IDX-CHP-9-0077" class="indexterm"/><a id="IDX-CHP-9-0078" class="indexterm"/><a id="IDX-CHP-9-0079" class="indexterm"/><a id="IDX-CHP-9-0080" class="indexterm"/></p></div></div></div>
<div class="sect1" title="Handling Data in a Generic Way"><div class="titlepage"><div><div><h1 class="title"><a id="handling_data_in_a_generic_way"/>Handling Data in a Generic Way</h1></div></div></div><p>Common Lisp has many different datatypes available for writing elegant and efficient programs. But without some care, having so many datatypes can lead to ugly and repetitive code.</p><p>For example, suppose we want to add several groups of numbers, which are stored as both lists and arrays. Since lists and arrays behave differently, will we need to write two different addition functions—one for lists and the other for arrays? It would be great if we could write a single chunk of code to handle both cases without caring about how the numbers are stored.</p><p>Common Lisp has all the features we need to write such generic code, including generic library functions, type predicates, <code class="literal">defmethod</code>, and generic accessors. We can use these features to write code that works with many types of data—including built-in as well as custom types that we might create with <code class="literal">defstruct</code>—without superfluous repetition in our code.</p><div class="sect2" title="Working with Sequences"><div class="titlepage"><div><div><h2 class="title"><a id="working_with_sequences"/>Working with Sequences</h2></div></div></div><p>The easiest way to write code that works with any type of argument is to hand the type-checking work to someone else. The Common Lisp libraries are packed with functions that can generically handle data of varying types in their arguments, the most commonly used of which are the <span class="emphasis"><em>sequence functions</em></span>. The sequence functions work generically across the three main ways of sequencing objects in Lisp: lists, arrays, and strings.<a id="IDX-CHP-9-0081" class="indexterm"/></p><p>You’ve already seen one of these sequence functions without even realizing it: the <code class="literal">length</code> function. You can use the <code class="literal">length</code> function to check for the length of all three sequence types:</p><a id="I_programlisting7_d1e14552"/><pre class="programlisting">&gt; <strong class="userinput"><code>(length '(a b c))</code></strong>
3
&gt; <strong class="userinput"><code>(length "blub")</code></strong>
4
&gt; <strong class="userinput"><code>(length (make-array 5))</code></strong>
5</pre><p>Without the generic <code class="literal">length</code> function, you would need to use three separate functions to determine the length of strings, arrays, and lists.<a id="IDX-CHP-9-0082" class="indexterm"/><a id="IDX-CHP-9-0083" class="indexterm"/><a id="IDX-CHP-9-0084" class="indexterm"/><a id="IDX-CHP-9-0085" class="indexterm"/><a id="IDX-CHP-9-0086" class="indexterm"/><a id="IDX-CHP-9-0087" class="indexterm"/><a id="IDX-CHP-9-0088" class="indexterm"/><a id="IDX-CHP-9-0089" class="indexterm"/><a id="IDX-CHP-9-0090" class="indexterm"/><a id="IDX-CHP-9-0091" class="indexterm"/><a id="IDX-CHP-9-0092" class="indexterm"/><a id="IDX-CHP-9-0093" class="indexterm"/><a id="IDX-CHP-9-0094" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>Common Lisp has a specific function for checking the length of lists, called list-length. Because generic functions tend to require extra type-checking to determine the correct behavior, they can be slower to execute. The <code class="literal">list-length</code> function is useful for performance-sensitive code, but most Lispers prefer using the generic <code class="literal">length</code> function in regular code.</p></div><div class="sect3" title="Sequence Functions for Searching"><div class="titlepage"><div><div><h3 class="title"><a id="sequence_functions_for_searching"/>Sequence Functions for Searching</h3></div></div></div><p>Some sequence functions let you search sequences:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">find-if</code> finds the first value that satisfies a predicate.</p></li><li class="listitem"><p><code class="literal">count</code> finds out how often a certain object appears in sequence.</p></li><li class="listitem"><p><code class="literal">position</code> tells you where an item is located.</p></li><li class="listitem"><p><code class="literal">some</code> and <code class="literal">every</code> tell you if some or every value in a sequence obeys a specific predicate.</p></li></ul></div><p>Here are some examples:</p><a id="I_programlisting7_d1e14658"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(find-if #'numberp '(a b 5 d))</code></strong>
  5
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> &gt; <strong class="userinput"><code>(count #\s "mississippi")</code></strong>
  4
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> &gt; <strong class="userinput"><code>(position #\4 "2kewl4skewl")</code></strong>
  5
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/> &gt; <strong class="userinput"><code>(some #'numberp '(a b 5 d))</code></strong>
  T
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/> &gt; <strong class="userinput"><code>(every #'numberp '(a b 5 d))</code></strong>
  NIL</pre><p>In these examples, we use <code class="literal">find-if</code> to find the first number in a sequence, which is the number 5 <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14710"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. We use <code class="literal">count</code> to find out how many times the character <code class="literal">s</code> appears in <code class="literal">"mississippi"</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14726"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. We use <code class="literal">position</code> to find at what position the character 4 appears. In this case, it is in the fifth position, starting the count from zero <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14735"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. We use <code class="literal">some</code> to see if any items in a sequence are numbers. Indeed, there is a number <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14744"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. Finally, we use <code class="literal">every</code> to see if every item in the list is a number, which is not the case <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14754"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>.</p></div><div class="sect3" title="Sequence Functions for Iterating Across a Sequence"><div class="titlepage"><div><div><h3 class="title"><a id="sequence_functions_for_iterating_across"/>Sequence Functions for Iterating Across a Sequence</h3></div></div></div><p>One particularly useful generic sequence function is <code class="literal">reduce</code>. The <code class="literal">reduce</code> function allows you to iterate through a sequence and distill it down into a single result. Here, we use <code class="literal">reduce</code> to add together items in a list:</p><a id="I_programlisting7_d1e14774"/><pre class="programlisting">&gt; <strong class="userinput"><code>(reduce #'+ '(3 4 6 5 2))</code></strong>
20</pre><p>The sum of those numbers turns out to be 20. Here is a diagram that shows exactly what is happening in this example:<a id="IDX-CHP-9-0095" class="indexterm"/><a id="IDX-CHP-9-0096" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject7_d1e14788"/><img src="httpatomoreillycomsourcenostarchimages781410.png.jpg" alt="image with no caption"/></div></div><p>On the right side, shown in gray, is our list. On the left side, you can see the pairs of numbers that are fed into the plus (<code class="literal">+</code>) function and the intermediate results that are calculated. This shows that the plus function always receives a single intermediate result as well as the next number in the list as its arguments. The only exception to this is in the very first call to the plus function. Since no intermediate result exists when we start, the first time we call the plus function, we promote the number 3, which is at the start of the list, into our intermediate result column. Therefore, the first time the plus function is called, it actually receives <span class="emphasis"><em>two items</em></span> straight off the top of the list.</p><p>Let’s look at a slightly more complicated example, this time using our own reduction function. We’re going to find the largest even number in the list:</p><a id="I_programlisting7_d1e14803"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(reduce (lambda (best item)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>             <strong class="userinput"><code>(if (and (evenp item) (&gt; item best))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>                 <strong class="userinput"><code>item</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>               <strong class="userinput"><code>best))</code></strong>
            <strong class="userinput"><code>'(7 4 6 5 2)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>           <strong class="userinput"><code>:initial-value 0)</code></strong>
  6</pre><p>Our reduction function, which we pass to <code class="literal">reduce</code> to distill down our answer from the list, has two arguments <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14858"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. The first argument is the best value we’ve found so far—in other words, the largest even number we’ve found so far. The second argument is the next number from the list.</p><p>Our <code class="literal">reduce</code> function needs to return as a result the new best number. Therefore, if the latest number is better than the previous best <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14869"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, we return it <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14875"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. Otherwise, we return the previous best <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14881"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p><p>Remember that the first number in the list we’re reducing will be used as a starting value. If this is a problem, we can instead pass an explicit initial value to the <code class="literal">reduce</code> function by passing in a keyword parameter named <code class="literal">:initial-value</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e14895"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>.</p><p>Specifying an initial value for the <code class="literal">reduce</code> function is often necessary, or a bug can sneak into your code. In our example, it could allow an odd number at the front of the list to erroneously be deemed the best large even number. Let’s see what happens if we leave out the initial value.<a id="IDX-CHP-9-0097" class="indexterm"/></p><a id="I_programlisting7_d1e14912"/><pre class="programlisting">&gt; <strong class="userinput"><code>(reduce (lambda (best item)</code></strong>
            <strong class="userinput"><code>(if (and (evenp item) (&gt; item best))</code></strong>
                <strong class="userinput"><code>item</code></strong>
              <strong class="userinput"><code>best))</code></strong>
          <strong class="userinput"><code>'(7 4 6 5 2))</code></strong>
7</pre><p>Yes, things go horribly, horribly wrong, as a result of not specifying an initial <code class="literal">reduce</code> value.</p><p>Another great benefit of the <code class="literal">reduce</code> function is that it is generic, as is true for all these sequence functions. This means that it can <code class="literal">reduce</code> lists, arrays, or strings in exactly the same way, and you can use <code class="literal">reduce</code> to write functions that are oblivious to the difference between these different sequence types.<a id="IDX-CHP-9-0098" class="indexterm"/><a id="IDX-CHP-9-0099" class="indexterm"/><a id="IDX-CHP-9-0100" class="indexterm"/><a id="IDX-CHP-9-0101" class="indexterm"/></p><p>Earlier, I mentioned that it would be convenient to be able to write a single function that could sum together numbers in lists or arrays equally well. Now we can write such a function:</p><a id="I_programlisting7_d1e14963"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun sum (lst)</code></strong>
     <strong class="userinput"><code>(reduce #'+ lst))</code></strong>
SUM
&gt; <strong class="userinput"><code>(sum '(1 2 3))</code></strong>
6
&gt; <strong class="userinput"><code>(sum (make-array 5 :initial-contents '(1 2 3 4 5)))</code></strong>
15
&gt; <strong class="userinput"><code>(sum "blablabla")</code></strong>
Error: The value #\b is not of type NUMBER.</pre><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject7_d1e14981"/><img src="httpatomoreillycomsourcenostarchimages781742.png.jpg" alt="image with no caption"/></div></div><p><code class="literal">sum</code> is blissfully unaware of the difference between arrays and lists; it works on both. However, since addition doesn’t make any sense for characters, the <code class="literal">sum</code> function returns an error when used on a string.</p><p>Another function that is useful for iterating across a sequence is the <code class="literal">map</code> function. This function is identical in behavior to <code class="literal">mapcar</code>. However, unlike <code class="literal">mapcar</code>, the <code class="literal">map</code> function works on all sequence types, not just lists. You specify the type of sequence to return from the mapping by passing an extra argument to the <code class="literal">map</code> function.</p><p>Here is an example of <code class="literal">map</code>:</p><a id="I_programlisting7_d1e15015"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(map 'list</code></strong>
         <strong class="userinput"><code>(lambda (x)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>            <strong class="userinput"><code>(if (eq x #\s)</code></strong>
                 <strong class="userinput"><code>#\S</code></strong>
                 <strong class="userinput"><code>x))</code></strong>
         <strong class="userinput"><code>"this is a string")</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> (#\t #\h #\i #\S #\  #\i #\S #\  #\a #\  #\S #\t #\r #\i #\n #\g)</pre><p>In this example, we’re turning every <code class="literal">s</code> character in a string to its uppercase version. The mapping function we pass into <code class="literal">map</code> simply checks if the current character is an <code class="literal">s</code> and returns the uppercase <code class="literal">S</code> if it is <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15068"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.<a id="IDX-CHP-9-0102" class="indexterm"/><a id="IDX-CHP-9-0103" class="indexterm"/><a id="IDX-CHP-9-0104" class="indexterm"/><a id="IDX-CHP-9-0105" class="indexterm"/><a id="IDX-CHP-9-0106" class="indexterm"/><a id="IDX-CHP-9-0107" class="indexterm"/><a id="IDX-CHP-9-0108" class="indexterm"/><a id="IDX-CHP-9-0109" class="indexterm"/><a id="IDX-CHP-9-0110" class="indexterm"/><a id="IDX-CHP-9-0111" class="indexterm"/><a id="IDX-CHP-9-0112" class="indexterm"/><a id="IDX-CHP-9-0113" class="indexterm"/><a id="IDX-CHP-9-0114" class="indexterm"/><a id="IDX-CHP-9-0115" class="indexterm"/><a id="IDX-CHP-9-0116" class="indexterm"/></p><p>The result of this calculation is a list of characters <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15125"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. This is because we told the <code class="literal">map</code> function that we wanted a list as a result <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15134"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Had we asked for a <code class="literal">string</code> instead, a string would have been our result.</p></div><div class="sect3" title="Two More Important Sequence Functions"><div class="titlepage"><div><div><h3 class="title"><a id="two_more_important_sequence_functions"/>Two More Important Sequence Functions</h3></div></div></div><p>The <code class="literal">subseq</code> function lets you pull a subsequence out of a larger sequence by specifying starting and ending points:</p><a id="I_programlisting7_d1e15151"/><pre class="programlisting">&gt; <strong class="userinput"><code>(subseq "america" 2 6)</code></strong>
"eric"</pre><p>As you can see, the word <code class="literal">america</code> contains the name <code class="literal">eric</code>, starting from the second character and ending at the sixth character.</p><p>The <code class="literal">sort</code> function lets you pass it an arbitrary function to use for the sorting. In this case, we’re just using the less-than (<code class="literal">&lt;</code>) function:</p><a id="I_programlisting7_d1e15172"/><pre class="programlisting">&gt; <strong class="userinput"><code>(sort '(5 8 2 4 9 3 6) #'&lt;)</code></strong>
(2 3 4 5 6 8 9)</pre><p>There are many more sequence functions than we’ve discussed so far, but the examples in this chapter will get you off to a good start.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>For a comprehensive list of sequence functions, and indeed all Common Lisp functions, visit the <span class="emphasis"><em>Common Lisp Hyperspec</em></span> at <a class="ulink" href="http://www.snipurl.com/rz3h0">http://www.snipurl.com/rz3h0</a>—an exhaustive, but daunting, description of all Common Lisp has to offer.<a id="IDX-CHP-9-0117" class="indexterm"/><a id="IDX-CHP-9-0118" class="indexterm"/></p></div></div></div><div class="sect2" title="Creating Your Own Generic Functions with Type Predicates"><div class="titlepage"><div><div><h2 class="title"><a id="creating_your_own_generic_functions_with"/>Creating Your Own Generic Functions with Type Predicates</h2></div></div></div><p>Common Lisp, like virtually all other Lisps, is a dynamically typed language. This means that parameters or variables in your code can hold any type of data—symbols, strings, numbers, functions, or whatever else you want to place in them. In fact, the same parameter or variable can even hold different types of data at different times in a running program.</p><p>Therefore, it makes sense to have a bunch of functions that tell you whether a variable has a certain type of data in it. For instance, you can check whether you have a number with <code class="literal">numberp</code>:</p><a id="I_programlisting7_d1e15205"/><pre class="programlisting">&gt; <strong class="userinput"><code>(numberp 5)</code></strong>
T</pre><p>The type predicates you will probably use most frequently are <code class="literal">arrayp</code>, <code class="literal">characterp</code>, <code class="literal">consp</code>, <code class="literal">functionp</code>, <code class="literal">hash-table-p</code>, <code class="literal">listp</code>, <code class="literal">stringp</code>, and <code class="literal">symbolp</code>.</p><p>You can use type predicates to write functions that handle different types of data generically. Suppose we wanted to write a function that lets us add both numbers or lists. Here’s one way we could write such a function:<a id="IDX-CHP-9-0119" class="indexterm"/><a id="IDX-CHP-9-0120" class="indexterm"/></p><a id="I_programlisting7_d1e15245"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun add (a b)</code></strong>
     <strong class="userinput"><code>(cond ((and (numberp a) (numberp b)) (+ a b))</code></strong>
           <strong class="userinput"><code>((and (listp a) (listp b)) (append a b))))</code></strong>
ADD
&gt; <strong class="userinput"><code>(add 3 4)</code></strong>
7
&gt; <strong class="userinput"><code>(add '(a b) '(c d))</code></strong>
(A B C D)</pre><p>In this <code class="literal">add</code> function, we use predicates to see if the arguments passed in are numbers or lists, and then we act appropriately. If we aren’t given two numbers or two lists, it simply returns <code class="literal">nil</code>.</p><p>Although you can write functions supporting multiple types of data using type predicates, most Lispers wouldn’t write an <code class="literal">add</code> function this way, for the following reasons:</p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>A single, monolithic function for all types:</strong></span></span></dt><dd><p>This is fine for just two types, but if we wanted to handle a dozen or more types, our function would quickly turn into a giant monstrosity.</p></dd><dt><span class="term"><span class="strong"><strong>Modifications required to accommodate new cases:</strong></span></span></dt><dd><p>We would need to change the add function whenever we want to support a new type, increasing the chance that we would break existing code. Ideally, we would like to handle each new situation by itself without touching already working code.</p></dd><dt><span class="term"><span class="strong"><strong>Hard to understand:</strong></span></span></dt><dd><p>It is hard to see exactly what the main cond statement is doing and if the types are all being routed to the right place.</p></dd><dt><span class="term"><span class="strong"><strong>Performance:</strong></span></span></dt><dd><p>The resulting function might be slow. For instance, a Lisp interpreter/compiler might be able to create faster code for appending two lists if it knew for sure that both items were lists when the appending happens. However, in our first attempt at the add function, the type of the two arguments is never really completely obvious. Our compiler would need a bit of smarts to be able to tell from the condition <code class="literal">(and (listp a) (listp b))</code> that both variables are guaranteed to be lists. Life would be easier for the compiler if we explicitly stated the types of arguments for each type situation.</p></dd></dl></div><p>Because it is so useful to be able to have a single function that does different things when given certain datatypes, the Common Lisp command <code class="literal">defmethod</code> lets us define multiple versions of a function that each supports different types. When that function is called, Lisp checks the argument types at the time of the call and chooses the correct version of the function automatically. The proper term for having a compiler/interpreter choose among different versions of a function based on argument types is <span class="emphasis"><em>type dispatching</em></span>.<a id="IDX-CHP-9-0121" class="indexterm"/><a id="IDX-CHP-9-0122" class="indexterm"/><a id="IDX-CHP-9-0123" class="indexterm"/><a id="IDX-CHP-9-0124" class="indexterm"/><a id="IDX-CHP-9-0125" class="indexterm"/></p><p>Here’s how we would write our <code class="literal">add</code> function using <code class="literal">defmethod</code>:</p><a id="I_programlisting7_d1e15343"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defmethod add ((a number) (b number))</code></strong>
     <strong class="userinput"><code>(+ a b))</code></strong>
ADD
&gt; <strong class="userinput"><code>(defmethod add ((a list) (b list))</code></strong>
     <strong class="userinput"><code>(append a b))</code></strong>
ADD
&gt; <strong class="userinput"><code>(add 3 4)</code></strong>
7
&gt; <strong class="userinput"><code>(add '(a b) '(c d))</code></strong>
(A B C D)</pre><p>As you can see, this version of the <code class="literal">add</code> function handles every type of situation with a separate function, and new cases can be added without modifying existing code. Overall, the code is much easier to understand. Also, the compiler can see the type of the parameters and may be able to write faster code using this knowledge.</p><p>The <code class="literal">defmethod</code> function is like <code class="literal">defun</code>, except that it allows us to write multiple functions with the same name. When using <code class="literal">defmethod</code>, we can explicitly state the type of each parameter in the function’s argument list so that Lisp can use these type declarations to figure out the correct version of <code class="literal">add</code> for each situation.</p><p>If you’re familiar with the world of OOP, the word <span class="emphasis"><em>method</em></span> probably has a special meaning to you. Since this new command is called <code class="literal">defmethod</code>, does it have anything to do with OOP? In short, yes. This command can be used not only with Common Lisp’s built-in types, but also with structures you’ve created with <code class="literal">defstruct</code>. The combination of <code class="literal">defstruct</code> and <code class="literal">defmethod</code> basically constitutes a simple object system.</p><p>Now we’ll use this object system to write a game!</p></div></div>
<div class="sect1" title="The Orc Battle Game"><div class="titlepage"><div><div><h1 class="title"><a id="the_orc_battle_game"/>The Orc Battle Game</h1></div></div></div><p>In the Orc Battle game, you’re a knight surrounded by 12 monsters, engaged in a fight to the death. With your superior wits and your repertoire of sword-fighting maneuvers, you must carefully strategize in your battle with orcs, hydras, and other nasty enemies. One wrong move and you may be unable to kill them all before being worn down by their superior numbers. Using <code class="literal">defmethod</code> and <code class="literal">defstruct</code>, let’s dispatch some whoop ass on these vermin!<a id="IDX-CHP-9-0126" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject7_d1e15417"/><img src="httpatomoreillycomsourcenostarchimages783116.png.jpg" alt="image with no caption"/></div></div><div class="sect2" title="Global Variables for the Player and Monsters"><div class="titlepage"><div><div><h2 class="title"><a id="global_variables_for_the_player_and_mons"/>Global Variables for the Player and Monsters</h2></div></div></div><p>We’ll want to track three player stats: health, agility, and strength. When a player’s health reaches zero, that player will die. Agility will control how many attacks a player can perform in a single round of battle, and strength will control the ferocity of the attacks. As the game progresses, each of these will change and affect gameplay and strategy in subtle ways.<a id="IDX-CHP-9-0127" class="indexterm"/><a id="IDX-CHP-9-0128" class="indexterm"/><a id="IDX-CHP-9-0129" class="indexterm"/><a id="IDX-CHP-9-0130" class="indexterm"/></p><a id="I_programlisting7_d1e15445"/><pre class="programlisting">(defparameter *player-health* nil)
(defparameter *player-agility* nil)
(defparameter *player-strength* nil)</pre><p>We’ll store our monsters in an array called <code class="literal">*monsters*</code>. This array will be <span class="emphasis"><em>heterogeneous</em></span>, meaning it can contain different types of monsters, be they orcs, hydras, or anything else. We’ll create our monster types with <code class="literal">defstruct</code>. Of course, we still need to figure out how to handle each type in the list in a meaningful way—that’s where we’ll use Lisp’s generic features.</p><p>We’ll also define a list of functions for building monsters that we’ll store in the variable <code class="literal">*monster-builders*</code>. As we write the code for each type of monster, we’ll create a function that builds a monster of each type. We’ll then push each of these monster builders onto this list. Having all the builder functions in this list will make it easy for us to create random monsters at will for our game.<a id="IDX-CHP-9-0131" class="indexterm"/><a id="IDX-CHP-9-0132" class="indexterm"/><a id="IDX-CHP-9-0133" class="indexterm"/><a id="IDX-CHP-9-0134" class="indexterm"/></p><p>Finally, we’ll create the variable <code class="literal">*monster-num*</code> to control how many opponents our knight must fight. Change this variable to increase (or decrease) the difficulty level of Orc Battle.</p><a id="I_programlisting7_d1e15486"/><pre class="programlisting">(defparameter *monsters* nil)
(defparameter *monster-builders* nil)
(defparameter *monster-num* 12)</pre></div><div class="sect2" title="Main Game Functions"><div class="titlepage"><div><div><h2 class="title"><a id="main_game_functions"/>Main Game Functions</h2></div></div></div><p>Now we’re ready to write our first real code for the game, starting with the big picture functions that drive the rest of the system.</p><p>First, we’ll define a function called <code class="literal">orc-battle</code>. This function will initialize the monsters and start the game loop and, once the battle ends, it will determine the victor and print the appropriate ending message for the game. As you can see, <code class="literal">orc-battle</code> calls plenty of helper functions to do the actual work:</p><a id="I_programlisting7_d1e15501"/><pre class="programlisting">(defun orc-battle ()
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (init-monsters)
    (init-player)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (game-loop)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>   (when (player-dead)
      (princ "You have been killed. Game Over."))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>   (when (monsters-dead)
      (princ "Congratulations! You have vanquished all of your foes.")))</pre><p>At the top, we call the initialization functions for the monsters and the player <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15529"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Then we start the main game loop <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15535"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. The game loop will keep running until either the player or the monsters are dead. We’ll print a game-ending message depending on whether the player <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15541"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> or monsters <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15547"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span> died.</p><p>Next, we’ll create the function <code class="literal">game-loop</code> to handle the game loop. This function handles a round of the battle, and then calls itself recursively for the following round:</p><a id="I_programlisting7_d1e15558"/><pre class="programlisting">(defun game-loop ()
    (unless (or (player-dead) (monsters-dead))
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>     (show-player)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>     (dotimes (k (1+ (truncate (/ (max 0 *player-agility*) 15))))
        (unless (monsters-dead)
          (show-monsters)
          (player-attack)))
      (fresh-line)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>     (map 'list
           (lambda(m)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>             (or (monster-dead m) (monster-attack m)))
           *monsters*)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>     (game-loop)))</pre><p>The <code class="literal">game-loop</code> function handles the repeated cycles of monster and player attacks. As long as both parties in the fight are still alive, the function will first show some information about the player in the REPL <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15595"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>.<a id="IDX-CHP-9-0135" class="indexterm"/><a id="IDX-CHP-9-0136" class="indexterm"/><a id="IDX-CHP-9-0137" class="indexterm"/><a id="IDX-CHP-9-0138" class="indexterm"/></p><p>Next, we allow the player to attack the monsters. The <code class="literal">game-loop</code> function uses the player’s agility to modulate how many attacks can be launched in a single round of battle, using some fudge factors to transform the agility to a small, appropriate number <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15622"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. When the game begins, the player will have three attacks per round. Later stages of battle could cause this number to drop to a single attack per round.</p><p>The calculated agility factor for our player attack loop <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15630"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> is passed into the <code class="literal">dotimes</code> command, which takes a variable name and a number <span class="emphasis"><em>n</em></span>, and runs a chunk of code <span class="emphasis"><em>n</em></span> times:</p><a id="I_programlisting7_d1e15645"/><pre class="programlisting">&gt; <strong class="userinput"><code>(dotimes (i 3)</code></strong>
      <strong class="userinput"><code>(fresh-line)</code></strong>
      <strong class="userinput"><code>(princ i)</code></strong>
      <strong class="userinput"><code>(princ ". Hatchoo!"))</code></strong>
0. Hatchoo!
1. Hatchoo!
2. Hatchoo!</pre><p>The <code class="literal">dotimes</code> function is one of Common Lisp’s looping commands (looping is covered in more detail in <a class="xref" href="ch11.html" title="Chapter 10. Looping with the loop Command">Chapter 10</a>).</p><p>After the player has attacked, we allow the monsters to attack. We do this by iterating through our list of monsters with the <code class="literal">map</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15672"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. Every type of monster has a special <code class="literal">monster-attack</code> command, which we’ll call as long as the monster is still alive <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15681"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p><p>Finally, the <code class="literal">game-loop</code> function calls itself recursively, so that the battle can continue until one side or the other has been vanquished <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15692"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>.</p></div><div class="sect2" title="Player Management Functions"><div class="titlepage"><div><div><h2 class="title"><a id="player_management_functions"/>Player Management Functions</h2></div></div></div><p>The functions we need for managing the player’s attributes (health, agility, and strength) are very simple. Following are the functions we need to initialize players, to see if they’ve died, and to output their attributes:</p><a id="I_programlisting7_d1e15703"/><pre class="programlisting">(defun init-player ()
    (setf *player-health* 30)
    (setf *player-agility* 30)
    (setf *player-strength* 30))

(defun player-dead ()
    (&lt;= *player-health* 0))

(defun show-player ()
    (fresh-line)
    (princ "You are a valiant knight with a health of ")
    (princ *player-health*)
    (princ ", an agility of ")
    (princ *player-agility*)
    (princ ", and a strength of ")
    (princ *player-strength*))</pre><p>The <code class="literal">player-attack</code> function lets us manage a player’s attack:<a id="IDX-CHP-9-0139" class="indexterm"/><a id="IDX-CHP-9-0140" class="indexterm"/><a id="IDX-CHP-9-0141" class="indexterm"/></p><a id="I_programlisting7_d1e15719"/><pre class="programlisting">(defun player-attack ()
    (fresh-line)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (princ "Attack style: [s]tab [d]ouble swing [r]oundhouse:")
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (case (read)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>    (s (monster-hit (pick-monster)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>                      (+ 2 (randval (ash *player-strength* −1)))))
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>    (d (let ((x (randval (truncate (/ *player-strength* 6)))))
             (princ "Your double swing has a strength of ")
             (princ x)
             (fresh-line)
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>            (monster-hit (pick-monster) x)
             (unless (monsters-dead)
<img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/>              (monster-hit (pick-monster) x))))
<img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/>    (otherwise (dotimes (x (1+ (randval (truncate (/ *player-strength* 3)))))
                  (unless (monsters-dead)
<img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/>                   (monster-hit (random-monster) 1))))))</pre><p>First, this function prints out some different types of attacks from which the player can choose <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15778"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. As you can see, the player is offered three possible attacks: a stab, a double swing, and a roundhouse swing. We read in the player’s selection, and then handle each type of attack in a <code class="literal">case</code> statement <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15787"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.</p><p>The stab attack is the most ferocious attack and can be delivered against a single foe. Since a stab is performed against a single enemy, we will first call the <code class="literal">pick-monster</code> function to let the player choose whom to attack <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15798"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. The attack strength is calculated from the <code class="literal">*player-strength*</code>, using a random factor and some other little tweaks to generate a nice, but never too powerful, attack strength <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15807"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. Once the player has chosen a monster to attack and the attack strength has been calculated, we call the <code class="literal">monster-hit</code> function to apply the attack <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15817"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.</p><p>Unlike the stab attack, the double swing is weaker, but allows two enemies to be attacked at once. An additional benefit of the attack is that the knight can tell, as the swing begins, how strong it will be—information that can then be used to choose the best enemies to attack midswing. This extra feature of the double swing adds strategic depth to the game. Otherwise, the double-swing code <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15825"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span> is similar to the stab code, printing a message and allowing the player to choose whom to attack. In this case, however, two monsters can be chosen <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15831"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15836"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>.</p><p>The final attack, the roundhouse swing, is a wild, chaotic attack that does not discriminate among the enemies. We run through a <code class="literal">dotimes</code> loop based on the player’s strength <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15847"/><img src="httpatomoreillycomsourcenostarchimages783566.png" alt=""/></span> and then attack random foes multiple times. However, each attack is very weak, with a strength of only 1 <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15853"/><img src="httpatomoreillycomsourcenostarchimages783498.png" alt=""/></span>.<a id="IDX-CHP-9-0142" class="indexterm"/><a id="IDX-CHP-9-0143" class="indexterm"/><a id="IDX-CHP-9-0144" class="indexterm"/><a id="IDX-CHP-9-0145" class="indexterm"/><a id="IDX-CHP-9-0146" class="indexterm"/><a id="IDX-CHP-9-0147" class="indexterm"/></p><p>These attacks must be used correctly, at the right stages of a battle, in order to achieve victory. To add some randomness to the attacks in the <code class="literal">player-attack</code> function, we used the <code class="literal">randval</code> helper function to generate random numbers. It is defined as follows:</p><a id="I_programlisting7_d1e15888"/><pre class="programlisting">(defun randval (n)
  (1+ (random (max 1 n))))</pre><p>The <code class="literal">randval</code> function returns a random number from one to <span class="emphasis"><em>n</em></span>, while making sure that no matter how small <span class="emphasis"><em>n</em></span> is, at least the number 1 will be returned. Using <code class="literal">randval</code> instead of just the <code class="literal">random</code> function for generating random numbers gives a reality check to the randomness of the game, since 0 doesn’t make sense for some of the values we use in our calculations. For instance, even the weakest player or monster should always have an attack strength of at least 1.</p><p>The <code class="literal">random</code> function used by <code class="literal">randval</code> is the canonical random value function in Lisp. It can be used in several different ways, though most frequently it is used by passing in an integer <span class="emphasis"><em>n</em></span> and receiving a random integer from 0 to <span class="emphasis"><em>n</em></span>−1:</p><a id="I_programlisting7_d1e15922"/><pre class="programlisting">&gt; <strong class="userinput"><code>(dotimes (i 10)</code></strong>
     <strong class="userinput"><code>(princ (random 5))</code></strong>
     <strong class="userinput"><code>(princ " "))</code></strong>
1 2 2 4 0 4 2 4 2 3</pre></div><div class="sect2" title="Helper Functions for Player Attacks"><div class="titlepage"><div><div><h2 class="title"><a id="helper_functions_for_player_attacks"/>Helper Functions for Player Attacks</h2></div></div></div><p>Our <code class="literal">player-attack</code> function needs two helper functions to do its job. First, it needs a <code class="literal">random-monster</code> function that picks a monster to target for the chaotic roundhouse attack, while ensuring that the chosen monster isn’t already dead:</p><a id="I_programlisting7_d1e15944"/><pre class="programlisting">(defun random-monster ()
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let ((m (aref *monsters* (random (length *monsters*)))))
      (if (monster-dead m)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>         (random-monster)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>         m)))</pre><p>The <code class="literal">random-monster</code> function first picks a random monster out of the array of monsters and stores it in the variable <code class="literal">m</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15972"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Since we want to pick a living monster to attack, we recursively try the function again if we inadvertently picked a dead monster <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15978"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Otherwise, we return the chosen monster <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e15984"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.</p><p>The <code class="literal">player-attack</code> function also needs a function that allows the player to pick a monster to target for the nonrandom attacks. This is the job of the <code class="literal">pick-monster</code> function:<a id="IDX-CHP-9-0148" class="indexterm"/><a id="IDX-CHP-9-0149" class="indexterm"/><a id="IDX-CHP-9-0150" class="indexterm"/><a id="IDX-CHP-9-0151" class="indexterm"/></p><a id="I_programlisting7_d1e16012"/><pre class="programlisting">(defun pick-monster ()
    (fresh-line)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (princ "Monster #:")
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (let ((x (read)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>     (if (not (and (integerp x) (&gt;= x 1) (&lt;= x *monster-num*)))
          (progn (princ "That is not a valid monster number.")
                 (pick-monster))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>         (let ((m (aref *monsters* (1- x))))
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>           (if (monster-dead m)
                (progn (princ "That monster is alread dead.")
                       (pick-monster))
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>               m)))))</pre><p>In order to let the player pick a monster to attack, we first need to display a prompt <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16053"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> and read in the player’s choice <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16059"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Then we need to make sure the player chose an integer that isn’t too big or too small <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16065"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. If this has happened, we print a message and call <code class="literal">pick-monster</code> again to let the player choose again. Otherwise, we can safely place the chosen monster in the variable <code class="literal">m</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16078"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p><p>Another error the player could make is to attack a monster that is already dead. We check for this possibility next and, once again, allow the player to make another selection <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16086"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>. Otherwise, the player has successfully made a choice, and we return the selected monster as a result <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16092"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>.</p><p>Now let’s work on our monsters.</p></div><div class="sect2" title="Monster Management Functions"><div class="titlepage"><div><div><h2 class="title"><a id="monster_management_functions"/>Monster Management Functions</h2></div></div></div><p>We’ll use the <code class="literal">init-monsters</code> function to initialize all the bad guys stored in the <code class="literal">*monsters*</code> array. This function will randomly pick functions out of the <code class="literal">*monster-builders*</code> list and call them with <code class="literal">funcall</code> to build the monsters:</p><a id="I_programlisting7_d1e16117"/><pre class="programlisting">(defun init-monsters ()
    (setf *monsters*
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>         (map 'vector
               (lambda (x)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>                (funcall (nth (random (length *monster-builders*))
                          *monster-builders*)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>              (make-array *monster-num*))))</pre><p>First, the <code class="literal">init-monsters</code> function builds an empty array to hold the monsters <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16142"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. Then it <code class="literal">maps</code> across this array to fill it up <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16151"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. In the <code class="literal">lambda</code> function, you can see how random monsters are created by <code class="literal">funcall</code>ing random functions in our list of monster builders <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16164"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.</p><p>Next, we need some simple functions for checking if the monsters are dead. Notice how we use the every command on the <code class="literal">*monsters*</code> array to see if the function <code class="literal">monster-dead</code> is true for every monster. This will tell us whether the entire monster population is dead.<a id="IDX-CHP-9-0152" class="indexterm"/><a id="IDX-CHP-9-0153" class="indexterm"/><a id="IDX-CHP-9-0154" class="indexterm"/><a id="IDX-CHP-9-0155" class="indexterm"/><a id="IDX-CHP-9-0156" class="indexterm"/><a id="IDX-CHP-9-0157" class="indexterm"/><a id="IDX-CHP-9-0158" class="indexterm"/></p><a id="I_programlisting7_d1e16206"/><pre class="programlisting">(defun monster-dead (m)
  (&lt;= (monster-health m) 0))

(defun monsters-dead ()
  (every #'monster-dead *monsters*))</pre><p>We’ll use the <code class="literal">show-monsters</code> function to display a listing of all the monsters. This function will, in turn, defer part of the work to another function, so it doesn’t actually need to know a lot about the different monster types:</p><a id="I_programlisting7_d1e16213"/><pre class="programlisting">(defun show-monsters ()
    (fresh-line)
    (princ "Your foes:")
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let ((x 0))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>     (map 'list
           (lambda (m)
               (fresh-line)
               (princ "   ")
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>              (princ (incf x))
               (princ ". ")
               (if (monster-dead m)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>                  (princ "**dead**")
                   (progn (princ "(Health=")
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>                         (princ (monster-health m))
                          (princ ") ")
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>                         (monster-show m))))
           *monsters*)))</pre><p>Since our player will need to choose monsters with a number, we will maintain a count as we loop through monsters in our list, in the variable <code class="literal">x</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16257"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Then we <code class="literal">map</code> through our monster list, calling a <code class="literal">lambda</code> function on each monster, which will print out some pretty text for each monster <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16269"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. We use our <code class="literal">x</code> variable to print out the number for each monster in our numbered list <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16279"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. As we do this, we use the <code class="literal">incf</code> function, which will increment <code class="literal">x</code> as we work through the list.</p><p>For dead monsters, we won’t print much about them, just a message showing that they are dead <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16293"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. For living monsters, we call generic monster functions, calculating the health <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16299"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span> and generating the monster description <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16305"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span> in a specialized way for each different type of foe.</p></div><div class="sect2" title="The Monsters"><div class="titlepage"><div><div><h2 class="title"><a id="the_monsters"/>The Monsters</h2></div></div></div><p>So far, we haven’t seen any functions that really give life to the monsters. Let’s fix that.</p><p>First, we’ll describe a generic monster.<a id="IDX-CHP-9-0159" class="indexterm"/><a id="IDX-CHP-9-0160" class="indexterm"/><a id="IDX-CHP-9-0161" class="indexterm"/><a id="IDX-CHP-9-0162" class="indexterm"/><a id="IDX-CHP-9-0163" class="indexterm"/><a id="IDX-CHP-9-0164" class="indexterm"/><a id="IDX-CHP-9-0165" class="indexterm"/></p><div class="sect3" title="The Generic Monster"><div class="titlepage"><div><div><h3 class="title"><a id="the_generic_monster"/>The Generic Monster</h3></div></div></div><p>As you would expect, orcs, hydras, and other bad guys all have one thing in common: a health meter that determines how many hits they can take before they die. We can capture this behavior in a <code class="literal">monster</code> structure:</p><a id="I_programlisting7_d1e16351"/><pre class="programlisting">(defstruct monster (health (randval 10)))</pre><p>This use of the <code class="literal">defstruct</code> function takes advantage of a special feature: When we declare each slot in the structure (in this case, <code class="literal">health</code>) we can put parentheses around the name and add a default value for that slot. But more important, we can declare a form that will be evaluated when a new <code class="literal">monster</code> is created. Since this form calls <code class="literal">randval</code>, every monster will start the battle with a different, random, health.</p><p>Let’s try creating some monsters:</p><a id="I_programlisting7_d1e16369"/><pre class="programlisting">&gt; <strong class="userinput"><code>(make-monster)</code></strong>
#S(MONSTER :HEALTH 7)
&gt; <strong class="userinput"><code>(make-monster)</code></strong>
#S(MONSTER :HEALTH 2)
&gt; <strong class="userinput"><code>(make-monster)</code></strong>
#S(MONSTER :HEALTH 5)</pre><p>We also need a function that takes away a monster’s health when it’s attacked. We’ll have this function output a message explaining what happened, including a message to be displayed when the monster dies. However, instead of creating this function with <code class="literal">defun</code>, we’ll use the generic <code class="literal">defmethod</code>, which will let us display special messages when the knight beats on particular monsters:</p><a id="I_programlisting7_d1e16388"/><pre class="programlisting">(defmethod monster-hit (m x)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (decf (monster-health m) x)
    (if (monster-dead m)
        (progn (princ "You killed the ")
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>              (princ (type-of m))
               (princ "! "))
        (progn (princ "You hit the ")
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>              (princ (type-of m))
               (princ ", knocking off ")
               (princ x)
               (princ " health points! "))))</pre><p>The <code class="literal">decf</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16413"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> is a variant of <code class="literal">setf</code> that lets us subtract an amount from a variable. The <code class="literal">type-of</code> function lets <code class="literal">monster-hit</code> pretend it knows the type of the monster that was hit <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16429"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16434"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. This function can be used to find the type of any Lisp value:</p><a id="I_programlisting7_d1e16440"/><pre class="programlisting">&gt; <strong class="userinput"><code>(type-of 'foo)</code></strong>
SYMBOL
&gt; <strong class="userinput"><code>(type-of 5)</code></strong>
INTEGER
&gt; <strong class="userinput"><code>(type-of "foo")</code></strong>
ARRAY
&gt; <strong class="userinput"><code>(type-of (make-monster))</code></strong>
MONSTER</pre><p>Currently, the type of a monster will always be <code class="literal">monster</code>, but soon we’ll have this value change for each monster type.<a id="IDX-CHP-9-0166" class="indexterm"/><a id="IDX-CHP-9-0167" class="indexterm"/><a id="IDX-CHP-9-0168" class="indexterm"/><a id="IDX-CHP-9-0169" class="indexterm"/><a id="IDX-CHP-9-0170" class="indexterm"/></p><p>We can also use two more generic methods to create monsters: <code class="literal">monster-show</code> and <code class="literal">monster-attack</code>.</p><p>The <code class="literal">monster-attack</code> function doesn’t actually do anything. This is because all our monster attacks will be so unique that there’s no point in defining a generic attack. This function is simply a placeholder.</p><a id="I_programlisting7_d1e16494"/><pre class="programlisting">(defmethod monster-show (m)
  (princ "A fierce ")
  (princ (type-of m)))

(defmethod monster-attack (m))</pre><p>Now that we have some generic monster code, we can finally create some actual bad guys!</p></div><div class="sect3" title="The Wicked Orc"><div class="titlepage"><div><div><h3 class="title"><a id="the_wicked_orc"/>The Wicked Orc</h3></div></div></div><p>The orc is a simple foe. He can deliver a strong attack with his club, but otherwise he is pretty harmless. Every orc has a club with a unique attack level. Orcs are best ignored, unless there are orcs with an unusually powerful club attack that you want to cull from the herd at the beginning of a battle.</p><p>To create the orc, we define an <code class="literal">orc</code> datatype with <code class="literal">defstruct</code>. Here, we will use another advanced feature of <code class="literal">defstruct</code> to declare that the <code class="literal">orc</code> includes all the fields of <code class="literal">monster</code>.</p><p>By including the fields from our <code class="literal">monster</code> type in our <code class="literal">orc</code> type, the <code class="literal">orc</code> will be able to inherit the fields that apply to all monsters, such as the <code class="literal">health</code> field. This is similar to what you can accomplish in popular languages such as C++ or Java by defining a generic class and then creating other, more specialized, classes that inherit from this generic class.</p><p>Once the structure is declared, we push the <code class="literal">make-orc</code> function (automatically generated by the <code class="literal">defstruct</code>) onto our list of <code class="literal">*monster-builders*</code>:</p><a id="I_programlisting7_d1e16545"/><pre class="programlisting">(defstruct (orc (:include monster)) (club-level (randval 8)))
(push #'make-orc *monster-builders*)</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>Notice how powerful this approach is. We can create as many new monster types as we want, yet we’ll never need to change our basic Orc Battle code. This is possible only in languages like Lisp, which are dynamically typed and support functions as first-class values. In statically typed programming languages, the main Orc Battle code would need some hardwired way of calling the constructor for each new type of monster. With first-class functions, we don’t need to worry about this.</p></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject7_d1e16551"/><img src="httpatomoreillycomsourcenostarchimages779881.png.jpg" alt="image with no caption"/></div></div><p>Now let’s specialize our <code class="literal">monster-show</code> and <code class="literal">monster-attack</code> functions for orcs. Notice these are defined in the same way as the earlier versions of these functions, except that we explicitly declare that these functions are orc-specific in the argument lists:<a id="IDX-CHP-9-0171" class="indexterm"/><a id="IDX-CHP-9-0172" class="indexterm"/><a id="IDX-CHP-9-0173" class="indexterm"/></p><a id="I_programlisting7_d1e16575"/><pre class="programlisting">(defmethod monster-show ((m orc))
    (princ "A wicked orc with a level ")
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (princ (orc-club-level m))
    (princ " club"))

  (defmethod monster-attack ((m orc))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (let ((x (randval (orc-club-level m))))
         (princ "An orc swings his club at you and knocks off ")
         (princ x)
         (princ " of your health points. ")
         (decf *player-health* x)))</pre><p>The one unique thing about our <code class="literal">orc</code> type is that each orc has an <code class="literal">orc-club-level</code> field. These orc-specific versions of <code class="literal">monster-show</code> and <code class="literal">monster-attack</code> take this field into account. In the <code class="literal">monster-show</code> function, we display this club level <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16607"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, so that the player can gauge the danger posed by each orc.</p><p>In the <code class="literal">monster-attack</code> function, we use the level of the club to decide how badly the player is hit by the club <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16619"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.</p></div><div class="sect3" title="The Malicious Hydra"><div class="titlepage"><div><div><h3 class="title"><a id="the_malicious_hydra"/>The Malicious Hydra</h3></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject7_d1e16629"/><img src="httpatomoreillycomsourcenostarchimages779984.png.jpg" alt="image with no caption"/></div></div><p>The hydra is a very nasty enemy. It will attack you with its many heads, which you’ll need to chop off to defeat it. The hydra’s special power is that it can grow a new head during each round of battle, which means you want to defeat it as early as possible.<a id="IDX-CHP-9-0174" class="indexterm"/><a id="IDX-CHP-9-0175" class="indexterm"/></p><a id="I_programlisting7_d1e16648"/><pre class="programlisting">(defstruct (hydra (:include monster)))
  (push #'make-hydra *monster-builders*)

  (defmethod monster-show ((m hydra))
    (princ "A malicious hydra with ")
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (princ (monster-health m))
    (princ " heads."))

  (defmethod monster-hit ((m hydra) x)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (decf (monster-health m) x)
    (if (monster-dead m)
        (princ "The corpse of the fully decapitated and decapacitated
 hydra falls to the floor!")
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>       (progn (princ "You lop off ")
               (princ x)
               (princ " of the hydra's heads! "))))

  (defmethod monster-attack ((m hydra))
    (let ((x (randval (ash (monster-health m) −1))))
      (princ "A hydra attacks you with ")
      (princ x)
      (princ " of its heads! It also grows back one more head! ")
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>     (incf (monster-health m))
      (decf *player-health* x)))</pre><p>The code for handling the hydra is similar to the code for handling the orc. The main difference is that a hydra’s health also acts as a stand-in for the number of hydra heads. In other words, a hydra with three health points will have three heads, as well. Therefore, when we write our hydra-specific <code class="literal">monster-show</code> function, we use the monster’s health to print a pretty message about the number of heads on the hydra <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16679"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>.<a id="IDX-CHP-9-0176" class="indexterm"/><a id="IDX-CHP-9-0177" class="indexterm"/></p><p>Another difference between the orc and the hydra is that an orc doesn’t do anything particularly interesting when it is hit by the player. Because of this, we didn’t need to write a custom <code class="literal">monster-hit</code> function for the orc; the orc simply used the generic <code class="literal">monster-hit</code> function we created for a generic <code class="literal">monster</code>.</p><p>A hydra, on the other hand, does something interesting when it is hit: It loses heads! We therefore create a hydra-specific <code class="literal">monster-hit</code> function, where heads are removed with every blow, which amounts to lowering the hydra’s health <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16711"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Also, we can now print a dramatic message about how the knight lopped off said heads <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16717"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.</p><p>The hydra’s <code class="literal">monster-attack</code> function is again similar to that for the orc. The one interesting difference is that we increment the health with every attack, so that the hydra grows a new head every turn <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16728"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p></div><div class="sect3" title="The Slimy Slime Mold"><div class="titlepage"><div><div><h3 class="title"><a id="the_slimy_slime_mold"/>The Slimy Slime Mold</h3></div></div></div><p>The slime mold is a unique monster. When it attacks you, it will wrap itself around your legs and immobilize you, letting the other bad guys finish you off. It can also squirt goo in your face. You must think quickly in battle to decide if it’s better to finish the slime off early in order to maintain your agility, or ignore it to focus on more vicious foes first. (Remember that by lowering your agility, the slime mold will decrease the number of attacks you can deliver in later rounds of battle.)</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject7_d1e16740"/><img src="httpatomoreillycomsourcenostarchimages780752.png.jpg" alt="image with no caption"/></div></div><a id="I_programlisting7_d1e16745"/><pre class="programlisting">(defstruct (slime-mold (:include monster)) (sliminess (randval 5)))
  (push #'make-slime-mold *monster-builders*)

  (defmethod monster-show ((m slime-mold))
    (princ "A slime mold with a sliminess of ")
    (princ (slime-mold-sliminess m)))

  (defmethod monster-attack ((m slime-mold))
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let ((x (randval (slime-mold-sliminess m))))
         (princ "A slime mold wraps around your legs and decreases your agility by ")
         (princ x)
         (princ "! ")
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>        (decf *player-agility* x)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>        (when (zerop (random 2))
           (princ "It also squirts in your face, taking away a health point! ")
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>          (decf *player-health*))))</pre><p>The <code class="literal">monster-attack</code> function for the slime mold must do some special things, which allow it to immobilize the player. First, it uses the slime mold’s sliminess (which is generated when each slime mold is built) to generate a random attack against the player, stored in the variable <code class="literal">x</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16779"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Unlike most other attacks in the game, this slime mold attack affects the agility of players, rather than their health <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16785"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.<a id="IDX-CHP-9-0178" class="indexterm"/><a id="IDX-CHP-9-0179" class="indexterm"/><a id="IDX-CHP-9-0180" class="indexterm"/><a id="IDX-CHP-9-0181" class="indexterm"/></p><p>However, it would be pointless if the slime mold couldn’t attack the player’s health at least a little, or the battle could end awkwardly, with the player and slime mold frozen in place for all time. Therefore, the slime mold also has a superwimpy squirt attack that happens during half of all attacks <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16816"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, but subtracts only a single health point from the player <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16822"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p></div><div class="sect3" title="The Cunning Brigand"><div class="titlepage"><div><div><h3 class="title"><a id="the_cunning_brigand"/>The Cunning Brigand</h3></div></div></div><p>The brigand is the smartest of all your foes. He can use his whip or slingshot and will try to neutralize your best assets. His attacks are not powerful, but they are a consistent two points for every round.</p><a id="I_programlisting7_d1e16833"/><pre class="programlisting">(defstruct (brigand (:include monster)))
  (push #'make-brigand *monster-builders*)

  (defmethod monster-attack ((m brigand))
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let ((x (max *player-health* *player-agility* *player-strength*)))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>     (cond ((= x *player-health*)
             (princ "A brigand hits you with his slingshot,
 taking off 2 health points! ")
             (decf *player-health* 2))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>           ((= x *player-agility*)
             (princ "A brigand catches your leg with his whip,
 taking off 2 agility points! ")
             (decf *player-agility* 2))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>           ((= x *player-strength*)
             (princ "A brigand cuts your arm with his whip,
 taking off 2 strength points! ")
             (decf *player-strength* 2)))))</pre><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject7_d1e16860"/><img src="httpatomoreillycomsourcenostarchimages781748.png.jpg" alt="image with no caption"/></div></div><p>The first thing the wily brigand does when performing an attack is to look at the player’s health, agility, and strength, and choose the <code class="literal">max</code> of those three as the focus of his attack <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16870"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. If several of the attributes are equally large, the brigand will choose health over agility and agility over strength as the focus of attack. If health is the largest value, the player is hit with a slingshot <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16876"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. If agility is the largest, the brigand will whip the player’s leg <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16882"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. If strength is the largest, the brigand will whip the player’s arm <span class="inlinemediaobject"><a id="I_inlinemediaobject7_d1e16888"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p><p>We have now completely defined all of our monsters for our game!</p></div></div><div class="sect2" title="To Battle!"><div class="titlepage"><div><div><h2 class="title"><a id="to_battle_exclamation"/>To Battle!</h2></div></div></div><p>To start the game, call <code class="literal">orc-battle</code> from the REPL:<a id="IDX-CHP-9-0182" class="indexterm"/><a id="IDX-CHP-9-0183" class="indexterm"/></p><a id="I_programlisting7_d1e16912"/><pre class="programlisting">&gt; <strong class="userinput"><code>(orc-battle)</code></strong>
You are a valiant knight with a health of 30, an agility of 30, and a strength of 30
Your foes:
   1. (Health=10) A wicked orc with a level 5 club
   2. (Health=3) A malicious hydra with 3 heads.
   3. (Health=9) A fierce BRIGAND
   4. (Health=3) A malicious hydra with 3 heads.
   5. (Health=3) A wicked orc with a level 2 club
   6. (Health=7) A malicious hydra with 7 heads.
   7. (Health=6) A slime mold with a sliminess of 2
   8. (Health=5) A wicked orc with a level 2 club
   9. (Health=9) A fierce BRIGAND
   10. (Health=2) A wicked orc with a level 6 club
   11. (Health=7) A wicked orc with a level 4 club
   12. (Health=8) A slime mold with a sliminess of 2</pre><p>That hydra with seven heads looks pretty gnarly—let’s finish it off first with a stab:</p><a id="I_programlisting7_d1e16919"/><pre class="programlisting">Attack style: [s]tab [d]ouble swing [r]oundhouse:<strong class="userinput"><code>s</code></strong>
Monster #:<strong class="userinput"><code>6</code></strong>
The corpse of the fully decapitated and decapacitated hydra falls to the floor!
Your foes:
   1. (Health=10) A wicked orc with a level 5 club
   2. (Health=3) A malicious hydra with 3 heads.
   3. (Health=9) A fierce BRIGAND
   4. (Health=3) A malicious hydra with 3 heads.
   5. (Health=3) A wicked orc with a level 2 club
   6. **dead**
   7. (Health=6) A slime mold with a sliminess of 2
   8. (Health=5) A wicked orc with a level 2 club
   9. (Health=9) A fierce BRIGAND
   10. (Health=2) A wicked orc with a level 6 club
   11. (Health=7) A wicked orc with a level 4 club
   12. (Health=8) A slime mold with a sliminess of 2</pre><p>No other bad guy really stands out, so we’ll try a roundhouse to bring down some of those health numbers overall:</p><a id="I_programlisting7_d1e16929"/><pre class="programlisting">Attack style: [s]tab [d]ouble swing [r]oundhouse:<strong class="userinput"><code>r</code></strong>
You hit the SLIME-MOLD,
 knocking off 1 health points! You hit the SLIME-MOLD, knocking off 1 health points!
 You hit the ORC, knocking off 1 health points! You lop off 1 of the hydra's heads!
 You lop off 1 of the hydra's heads! You lop off 1 of the hydra's heads! You hit the
 ORC, knocking off 1 health points! The corpse of the fully decapitated and decapaci
tated hydra falls to the floor! You hit the ORC, knocking off 1 health points! You hit
 the ORC, knocking off 1 health points! You hit the ORC, knocking off 1 health points!
Your foes:
   1. (Health=9) A wicked orc with a level 5 club
   2. (Health=2) A malicious hydra with 2 heads.
   3. (Health=9) A fierce BRIGAND
   4. **dead**
   5. (Health=2) A wicked orc with a level 2 club
   6. **dead**
   7. (Health=4) A slime mold with a sliminess of 2
   8. (Health=3) A wicked orc with a level 2 club
   9. (Health=9) A fierce BRIGAND
   10. (Health=2) A wicked orc with a level 6 club
   11. (Health=6) A wicked orc with a level 4 club
   12. (Health=8) A slime mold with a sliminess of 2</pre><p>Great! That even killed one of the weaker enemies. Now, with full agility, we have three attacks per round. This means we should use our last attack to strategically take out some of the more powerful bad guys. Let’s use the double swing:</p><a id="I_programlisting7_d1e16936"/><pre class="programlisting">Attack style: [s]tab [d]ouble swing [r]oundhouse:<strong class="userinput"><code>d</code></strong>
Your double swing has a strength of 3
Monster #:8
You killed the ORC!
Monster #:10
You killed the ORC!
An orc swings his club at you and knocks off 5 of your health points. A hydra
 attacks you with 1 of its heads! It also grows back one more head! A
brigand catches your leg with his whip, taking off 2 agility points! An orc
 swings his club at you and knocks off 1 of your health points. A slime mold wraps
 around your legs and decreases your agility by 2! It also squirts in your face,
 taking away a health point! A brigand cuts your arm with his whip, taking off 2
 strength points! An orc swings his club at you and knocks off 1 of your health
 points. A slime mold wraps around your legs and decreases your agility by 1!
You are a valiant knight with a health of 21, an agility of 25, and a strength of 28
Your foes:
   1. (Health=9) A wicked orc with a level 5 club
   2. (Health=3) A malicious hydra with 3 heads.
   3. (Health=9) A fierce BRIGAND
   4. **dead**
   5. (Health=2) A wicked orc with a level 2 club
   6. **dead**
   7. (Health=4) A slime mold with a sliminess of 2
   8. **dead**
   9. (Health=9) A fierce BRIGAND
   10. **dead**
   11. (Health=6) A wicked orc with a level 4 club
   12. (Health=8) A slime mold with a sliminess of 2</pre><p>They got us pretty good, but we still have plenty of fight left. This battle isn’t over yet!</p><p>As you can see, careful strategy is needed if you want to survive Orc Battle. I hope you enjoy this new game!</p></div></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id9"/>What You've Learned</h1></div></div></div><p>In this chapter, we discussed the more advanced data structures in Common Lisp. We then used this to create a monster-fighting game. Along the way, you learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Arrays are similar to lists, but allow you to access an item at a specific offset more efficiently.</p></li><li class="listitem"><p>Hash tables are similar to alists, but let you look up the value associated with a key more efficiently.</p></li><li class="listitem"><p>Using arrays and hash tables in the appropriate places will usually make your code much faster.</p></li><li class="listitem"><p>The only true way to tell if changing a data structure or algorithm makes your program faster is to time your code with the <code class="literal">time</code> command.</p></li><li class="listitem"><p>Common Lisp has generic functions that can be used against multiple datatypes. The most useful of these are sequence functions that can transparently handle lists, arrays, and strings.</p></li><li class="listitem"><p>You can create objects with properties in list using the <code class="literal">defstruct</code> command.</p></li></ul></div></div></body></html>