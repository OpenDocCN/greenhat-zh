<html><head></head><body>
  <h1><span class="chapter">Chapter 9 -</span><br/>
  Sneaking in the Back Door</h1>

  <p class="calibre1">The full range of viable attacks on the Xbox are too numerous to describe <span style="font-size: 1em;">in this book. The Xbox is based on the PC architecture, a complex, evolved</span> <span style="font-size: 1em;">architecture originally designed with no thought for security. Many of the classic hardware security holes exploited by smart card hackers, such as power supply modulation, sideband attacks, and clock glitching have not even been touched on the Xbox, to the best of my knowledge. (You can find</span> <span style="font-size: 1em;">more information on these security weaknesses in the proceedings of the</span> <span style="font-size: 1em;">Cryptographic Hardware in Embedded Systems (CHES) conference, in</span> <span style="font-size: 1em;">the Lecture Notes in Computer Science series (Springer-Verlag).</span></p>

  <p class="calibre1">Unfortunately, console and secure PC manufacturers are not concerned <span style="font-size: 1em;">about hardware security weaknesses, because hardware attacks are “too</span> <span style="font-size: 1em;">difficult for the average consumer to execute” and therefore of little threat.</span> <span style="font-size: 1em;">While it is true that researching an attack requires a skilled hacker with the correct tools, implementing an attack can be very cheap and easy. I’m</span> <span style="font-size: 1em;">reminded of the parable where a mechanic, called in to fix an important</span> <span style="font-size: 1em;">piece of broken machinery, spends an hour looking at the situation and</span> <span style="font-size: 1em;">repairs the machine by tapping on it at just the right spot. Upon receiving a bill for $1,000, the machine’s owners demand to know why a tap costs</span> <span style="font-size: 1em;">so much. The mechanic responds with, “The tap costs a dime. Knowing</span> <span style="font-size: 1em;">where to tap costs $999.90.” The corollary to this parable is that anyone</span> <span style="font-size: 1em;">could have executed the tap to repair the machine, given specific instruc</span><span style="font-size: 1em;">tions.</span></p>

  <p class="calibre1">Security attacks are often the same: difficult to figure out; easy to share and implement. Secure hardware manufacturers should also be concerned <span style="font-size: 1em;">about adopting mainly reactive policies to hacker intrusions. Many</span> <span style="font-size: 1em;">hackers work in secret, and keep their methods and results quiet so that</span> <span style="font-size: 1em;">vendors cannot develop proper countermeasures. These hackers also</span> <span style="font-size: 1em;">maintain a library of known attacks and back doors, disclosing only one</span> <span style="font-size: 1em;">at a time, so that vendors with reactive hardware security policies are</span> <span style="font-size: 1em;">always playing catchup.</span></p>

  <div class="infobox">
    <h2 class="calibre1" id="sigil_toc_id_68"><b class="calibre3" style="font-size: 1em;">A Commentary on Naming</b> <b class="calibre3" style="font-size: 1em;">Conventions</b></h2>

    <p class="calibre1">Hacking communities often invent their own terminology <span style="font-size: 1em;">for important concepts, which can vary from community to</span> <span style="font-size: 1em;">community and from industry standard terminology. The</span> <span style="font-size: 1em;">following is the list of terminologies accepted by the Xbox-</span><span style="font-size: 1em;">Linux community. Any deviations from the terminology I use</span> <span style="font-size: 1em;">in this book are noted.</span></p>

    <ul>
      <li><b>X-code:</b> Jam table opcodes; the opcodes used by the secret Southbridge (MCPX) boot ROM to initialize the Xbox hardware</li>

      <li><b>2BL:</b> Second boot loader. This is the code that is decrypted by the secret boot ROM. It is called the second boot loader because this code’s primary responsibility is to decrypt and decompress a kernel image.</li>

      <li><b>Flash Boot Loader</b>: In version 1.1 security, this is an intermediate boot loader in between the secret boot ROM and the 2BL. The FBL is verified by a lightweight hash against a hard-coded value within the secret boot ROM. As a result, the FBL cannot be changed without changing the MCPX silicon. The FBL is responsible for verifying the digital signature on all critical portions of the FLASH ROM.</li>

      <li><b>Kernel:</b> The Xbox kernel code. It is stored compressed and encrypted in the FLASH ROM.</li>

      <li>V<b>ersion 1.0 security:</b> The original Xbox security system using RC-4 encryption on the 2BL.</li>

      <li><b>Version 1.1 security:</b> The second Xbox security system using the TEA hash to verify regions of the FLASH ROM. The earliest manufacturing date seen on boxes with version 1.1 security is around August 2002.</li>
    </ul>
  </div>

  <p class="calibre1">The previous chapter described my eavesdropping attack on the Xbox <span style="font-size: 1em;">security mechanism that eventually yielded the RC-4 key hidden in a block of secret code. This chapter describes a few of the other attacks available on the Xbox that were devised by my colleagues, as well as the attack that was mounted on the revised Xbox security scheme, herein referred to as security version 1.1.</span></p>

  <h2 class="calibre1" id="sigil_toc_id_69"><b class="calibre3">Back Doors and Security Holes</b></h2>

  <p class="calibre1">A class of back door attacks on the Xbox leverage a fundamental <span style="font-size: 1em;">weakness in the way the hardware is initialized by the secret boot code.</span> <span style="font-size: 1em;">This weakness stems from the fact that hardware initialization is accom</span><span style="font-size: 1em;">plished by way of a powerful jam table opcode interpreter that stores its</span> <span style="font-size: 1em;">commands in unverified cleartext.</span></p>

  <h3 class="calibre1" id="sigil_toc_id_70"><b class="calibre3">Visor Jam Table Attacks</b></h3>

  <p class="calibre1">One class of attacks on the Xbox involves modifying the hardware initialization sequence. Recall that hardware initialization of the Xbox is accom<span style="font-size: 1em;">plished by means of an opcode interpreter that retrieves its commands from</span> <span style="font-size: 1em;">an unencrypted portion of the FLASH ROM called the “jam table.” The</span> <span style="font-size: 1em;">relationship of the jam table entries to the rest of FLASH ROM is illus</span><span style="font-size: 1em;">trated in Figure 9-1. Jam table entries are stored as &lt;opcode, arg1,</span> <span style="font-size: 1em;">arg2&gt; tuples near the lowest FLASH ROM addresses. The available</span> <span style="font-size: 1em;">opcodes include memory read and write functions to all the address spaces</span> <span style="font-size: 1em;">in the x86 architecture. Since the jam tables are stored unencrypted and never checked for modification, opcodes can be inserted into the jam table that can “seed” the Xbox memory with rogue instructions or modified hardware</span> <span style="font-size: 1em;">state</span> <i class="calibre4" style="font-size: 1em;">before</i> <span style="font-size: 1em;">the RC-4 decryption of the FLASH ROM 2BL.</span></p>

  <p class="calibre1"><span style="font-size: 1em;">One application of jam table modification is to recover the plaintext of the kernel without knowledge of the RC-4 key. A hacker, known only as Visor,</span> <span style="font-size: 1em;">first described this approach to me. Here is a summary of Visor’s approach:</span></p>

  <ol>
    <li>Boot the Xbox normally. Part of the normal boot process will place a decrypted kernel image into main memory.</li>

    <li>While maintaining power to the Xbox, switch the contents of the FLASH ROM’s jam table to an alternate table that copies regions of main memory to an easily monitored location, such as the FLASH ROM’s bus.</li>

    <li>Perform a soft-reset of the Xbox CPU. This forces a hardware re-initialization without erasing the main memory.</li>

    <li>Record the contents of main memory as the modified jam table program is executed.</li>
  </ol>

  <p><img alt="figure_9-1" src="../Images/figure_9-1.png" style="font-size: 1em; width: 622.6875px;"/></p>

  <p class="calibre1 caption"><b class="calibre3">Figure 9-1</b>: Jam table opcodes in relation to the rest of FLASH ROM.</p>

  <p class="calibre1"><span style="font-size: 1em;">Dynamic switchover of the FLASH ROM contents, required in step 2, can</span> <span style="font-size: 1em;">be accomplished by means of a ROM emulator, or by using an oversized</span> <span style="font-size: 1em;">ROM with the excess address bits wired to a bank of switches.</span></p>

  <p class="calibre1">Visor also described how the jam table can be used as part of an elaborate <span style="font-size: 1em;">hack to gain control over the Xbox’s instruction pointer (IP). To better</span> <span style="font-size: 1em;">understand this hack, we will further investigate how the secret boot code handles the case of an invalid FLASH ROM image.</span></p>

  <p class="calibre1">After decrypting the 2BL in the FLASH ROM image, the secret boot code <span style="font-size: 1em;">checks for a magic number at a location near the end of the 2BL. For an</span> <span style="font-size: 1em;">invalid FLASH ROM image, this number does not match, and causes the</span> <span style="font-size: 1em;">CPU to jump to a short sequence of instructions located at 0xFFFF.FFFA.</span> <span style="font-size: 1em;">This set of instructions continues all the way to the very last addressable location in physical memory, location 0xFFFF.FFFF. Once the CPU</span> <span style="font-size: 1em;">executes this last instruction of the invalid ROM image, it should crash and halt execution due to a code segment boundary error when the IP rolls over from 0xFFFF.FFFF to 0x0000.0000. However, this does not happen;</span> <span style="font-size: 1em;">rather, the CPU happily attempts to execute whatever instruction, valid or</span> <span style="font-size: 1em;">invalid, is located at location 0x0000.0000. Nominally, this instruction is invalid and the CPU halts anyway due to an instruction fault. However, a</span> <span style="font-size: 1em;">valid instruction can be placed there during the Xbox jam table initialization sequence using a jam table memory write opcode. Thus, by corrupting or</span> <span style="font-size: 1em;">erasing the encrypted FLASH ROM image and by modifying the jam tables</span> <span style="font-size: 1em;">to insert a jump instruction to your own unencrypted code in FLASH</span> <span style="font-size: 1em;">ROM, you can gain control of the Xbox CPU IP without ever touching a</span> <span style="font-size: 1em;">cipher or any similar technological measure that effectively controls access to a copyrighted work. Hence, this hack might be legal under the DMCA. I say</span> <i class="calibre4" style="font-size: 1em;">might</i> <span style="font-size: 1em;">because the DMCA is an oftentimes vague piece of legislation, and there is little court precedent to clarify the ambiguities. The argument for the legality of this approach lies in the fact that no significant Microsoft copyrighted code is ever decrypted or executed. The only exception is the</span> <span style="font-size: 1em;">portion of the secret boot ROM that must execute because they are hard</span><span style="font-size: 1em;">wired into the Southbridge’s silicon. See Chapter 12, “Caveat Hacker,” for a more in-depth discussion of the legal issues that are facing the hacking</span> <span style="font-size: 1em;">community today.</span></p>

  <h3 class="calibre1" id="sigil_toc_id_71"><b class="calibre3">MIST Premature Unmap Attack<sup>1</sup></b></h3>

  <p class="calibre1">In order to protect the secret boot code in the event that a hacker gains <span style="font-size: 1em;">control of the Xbox, the secret boot code in the Southbridge chip unmaps</span> <span style="font-size: 1em;">itself shortly before it exits. In other words, it hides itself permanently from the system when it is finished executing. Thus, a user program</span> <span style="font-size: 1em;">attempting to access any of the top 512 bytes in memory will see the</span> <span style="font-size: 1em;">decoy block in FLASH memory instead of the secret boot code. Michael</span> <span style="font-size: 1em;">Steil, the lead of the Xbox-Linux project, discovered a way to leverage</span> <span style="font-size: 1em;">this feature.</span></p>

  <p class="calibre1">The unmapping process is accomplished by writing to 0x8000.8008, a <span style="font-size: 1em;">hardware register in the PCI configuration space. The basic strategy is to</span> <span style="font-size: 1em;">include a jam table opcode that writes to 0x8000.8008 and unmaps the</span> <span style="font-size: 1em;">secret boot code before the initialization sequence is finished. Since the</span> <span style="font-size: 1em;">caches are off at this time, the processor will start fetching and executing instructions from the decoy block. Fortunately, since the decoy block can be freely modified since it is part of the FLASH ROM. The catch, however, is that the jam table interpreter blocks writes to location 0x8000.8008, so</span> <span style="font-size: 1em;">this shouldn’t work. However, a bug in the decoding of the PCI configura</span><span style="font-size: 1em;">tion space in the Southbridge chipset makes the unmap instruction respond</span> <span style="font-size: 1em;">to multiple aliased addresses. In particular, the “function” bitfield is ignored. Thus, a write to 0x8000.8X08 where X is not equal to 0 also does</span> <span style="font-size: 1em;">the trick, and these writes are</span> <i class="calibre4" style="font-size: 1em;">not</i> <span style="font-size: 1em;">blocked by the jam table interpreter.</span> <span style="font-size: 1em;">Therefore, to gain control of the CPU IP using the MIST hack, you must</span> <span style="font-size: 1em;">modify the decoy block in FLASH to contain your code, then add the</span> <span style="font-size: 1em;">appropriate jam table opcode to unmap the secret boot ROM during</span> <span style="font-size: 1em;">hardware initialization.</span></p>

  <h2 class="calibre1" id="sigil_toc_id_72"><b class="calibre3">Microsoft Retaliates</b></h2>

  <p class="calibre1">The discovery of security holes prompted many to speculate that Microsoft <span style="font-size: 1em;">would be swift to rotate its security scheme. In August 2002, Xboxes with a new motherboard quietly started to appear in Australia. The first official</span> <span style="font-size: 1em;">word of the new security system came from an unlikely source: nVidia,</span> <span style="font-size: 1em;">the producer of the chipsets used in the Xbox. Following an unspectacu</span><span style="font-size: 1em;">lar second quarter in 2002, an nVidia spokesperson cited this as the last</span> <span style="font-size: 1em;">of a few reasons why the quarter went poorly:</span></p>

  <blockquote>
    “What we said about Xbox was that we reached a <span style="font-size: 1em;">volume discount milestone, further reducing the</span> <span style="font-size: 1em;">margins. And that we will be taking an inventory</span> <span style="font-size: 1em;">write off in Q2 related to the amount of Xbox</span> <span style="font-size: 1em;">MCPs that were made obsolete when MSFT</span> <span style="font-size: 1em;">transitioned to a new security code (by way of the</span> <span style="font-size: 1em;">MIT hacker) and excess in nForce chipsets that we</span> <span style="font-size: 1em;">built in anticipation of higher demand of Athlon-</span><span style="font-size: 1em;">based PCs.” — Derek Perez, PR Director, nVidia <sup>2</sup></span>
  </blockquote>

  <h2 class="calibre1" id="sigil_toc_id_73"><b class="calibre3" style="font-size: 1em;">Reverse Engineering v1.1 Security<sup>3</sup></b><br/></h2>

  <p class="calibre1">The specifics of the security code changes were not revealed until <span style="font-size: 1em;">October 2002, when a hacker named Andy Green began investigating the</span> <span style="font-size: 1em;">first version 1.1 Xboxes available in the United Kingdom. The outward</span> <span style="font-size: 1em;">physical differences between Xbox version 1.1 and 1.0 on the</span> <span style="font-size: 1em;">motherboard were subtle: the GPU traded its fan for a larger heat sink,</span> <span style="font-size: 1em;">the USB daughtercard was merged into the motherboard, and a PLL</span> <span style="font-size: 1em;">clock synthesizer chip was missing. Also missing were filter capacitors</span> <span style="font-size: 1em;">here and there, but nothing significant seemed to have changed. Further</span> <span style="font-size: 1em;">probing revealed that the hole leveraged by the MIST attack was patched,</span> <span style="font-size: 1em;">but the jam table opcodes were unchanged. The LPC bus, a key vector</span> <span style="font-size: 1em;">for gaining access to the Xbox, was also present and unchanged.</span></p>

  <p class="calibre1">Andy was able to extract the MCPX ROM in one day using a procedure <span style="font-size: 1em;">thought up by a fellow hacker named Asterisk. The procedure leveraged an</span> <span style="font-size: 1em;">undisclosed combination of previously identified security holes and back</span> <span style="font-size: 1em;">doors. The initial analysis of the ROM contents revealed that the security was implemented in a radically different fashion. A cursory overview of the version 1.1 Xbox revealed that the old security through obscurity scheme was tossed out, and replaced with a scheme that nominally gets its security from the strength of public-key ciphers.</span></p>

  <p class="calibre1"><img alt="figure_9-2" src="../Images/figure_9-2.png" style="width:100%"/><br/></p>

  <p class="caption"><b class="calibre3">Figure 9-2:</b> Xbox Security Version 1.1. Regions that cannot be changed without replacing the MCPX silicon are shaded gray.</p>

  <p><span style="font-size: 1em;">Microsoft’s implementation of the new security scheme was a bit counter-</span><span style="font-size: 1em;">intuitive, though. Because the secret boot ROM within the MCPX</span> <span style="font-size: 1em;">remained the same size, 512 bytes, they could not fit the full public-key</span> <span style="font-size: 1em;">digital signature algorithm within the secret boot ROM. Instead, they</span> <span style="font-size: 1em;">chose to use a lightweight hash in the secret boot ROM to verify a region</span> <span style="font-size: 1em;">of FLASH ROM dubbed the Flash Boot Loader (FBL). The FBL</span> <span style="font-size: 1em;">contains the code (RSA cipher, SHA-1 hash, Microsoft’s public key, and</span> <span style="font-size: 1em;">the driver program) for digital signature verification of the FLASH</span> <span style="font-size: 1em;">ROM. The FBL is executed only if the FBL’s hash can be verified against</span> <span style="font-size: 1em;">a constant stored within the secret boot ROM. Thus, the FBL is in theory</span> <span style="font-size: 1em;">as immutable as the secret boot ROM, even though it is stored in the</span> <span style="font-size: 1em;">mutable FLASH ROM.</span></p>

  <p>Although this scheme sounded fairly bulletproof, the hacking community <span style="font-size: 1em;">did not give up so easily. They examined the secret boot ROM’s hash in</span> <span style="font-size: 1em;">detail and discovered that it is based on TEA, a Tiny Encryption Algorithm</span> <span style="font-size: 1em;">by David Wheeler and Roger Needham at the Computer Laboratory of</span> <span style="font-size: 1em;">Cambridge University. Franz Lehner, a collaborator in the effort, sent a query to the newsgroup sci.crypt regarding weaknesses in the TEA hash.</span></p>

  <p>On Friday afternoon, October 11th, their query was answered. A paper <span style="font-size: 1em;">written by John Kelsey, Bruce Schneier, and David Wagner, presented in</span> <span style="font-size: 1em;">CRYPTO 1996 pointed out that the TEA cipher has a weakness in its key</span> <span style="font-size: 1em;">scheduler where every key has three related keys that can be generated by</span> <span style="font-size: 1em;">inverting certain pairs of bits (this weakness, along with the TEA cipher, is discussed in more detail in Chapter 7). On Saturday, Andy Green posted</span> <span style="font-size: 1em;">this to XboxHacker.net:</span></p>
  <pre>Aw, I'm a mere mortal, my feet are definitely made of
clay.

OK, I don't think its giving too much away to say the
first 5 bytes of the region.

ffffd400: E9 83 01 00 00

This is a relative longbranch to 0xffffd588

If I flip b31 of that as a DWORD (and flip its friend at
DWORD address +1 the same way) I branch instead to
0x7fd588.... Hmmmm that's, what, 8M up, where...

where
there's
RAM

Xcodes.. visor ram push method... (looks at MCPX for RAM
Write X-Code)

X-Code opcode 3 ... unrestricted

Hold on to your hat, boys! Its testing time!

(mviz, a marvelous and well-timed revelation, I feel
mysterious and invisble forces helping me along, for which
I am grateful!)<sup>4</sup></pre>

  <p>In other words, the related-key weakness of the TEA cipher means that <span style="font-size: 1em;">every adjacent pair of double words in the FBL can be modified by one bit,</span> <span style="font-size: 1em;">the most significant bit, without any change to the resulting hash. This</span> <span style="font-size: 1em;">weakness gave Andy and his team enough breathing room to modify the</span> <span style="font-size: 1em;">target of a single jump instruction to point to a location in main memory.</span></p>

  <div class="infobox">
    <h2 class="sigil_not_in_toc"><b class="calibre3">Profile: Andy Green</b></h2>

    <p><b>Can you tell us a little bit more about yourself, and how you <span style="font-size: 1em;">got into hacking?</span></b></p>

    <p>I am 37, living in England, near Kettering in the East Mid<span style="font-size: 1em;">lands, with my wife, our four children and two cats.</span></p>

    <p>I have been interested in computers from the age of 12 or <span style="font-size: 1em;">so, when my brother bought a Commodore Pet. This 1MHz</span> <span style="font-size: 1em;">6502 kept me occupied for months and months trying to</span> <span style="font-size: 1em;">write first BASIC code typed in from magazines, then games</span> <span style="font-size: 1em;">for it; eventually I wrote a fantastic character-cell Space</span> <span style="font-size: 1em;">Invaders thing in machine code. Machine code is where</span> <span style="font-size: 1em;">you are actually programming the CPU directly in hex; I still</span> <span style="font-size: 1em;">remember the common 6502 opcodes in hex now. This was</span> <span style="font-size: 1em;">such a dificult effort that I decided my next project would</span> <span style="font-size: 1em;">be an assembler written in machine code. 1978 was before</span> <span style="font-size: 1em;">the days of the Internet: I couldn't afford the commercial</span> <span style="font-size: 1em;">assemblers because I was just a kid and there weren't any</span> <span style="font-size: 1em;">people around us that I knew to warez a copy from.</span></p>

    <p>This was fairly pathetic as assemblers go, but it worked fine. <span style="font-size: 1em;">I learned from this the value of having the right tools, I could</span> <span style="font-size: 1em;">write far faster in Assembler, and whole kinds of errors mis</span><span style="font-size: 1em;">computing relative branches by hand, for example) went</span> <span style="font-size: 1em;">completely away. Next I had a BBC Model B computer,</span> <span style="font-size: 1em;">and again I was interested to make tools and games. I was</span> <span style="font-size: 1em;">offered a scholarship at a public school, but turned it down</span> <span style="font-size: 1em;">and instead left school at 16 with no further education. I</span> <span style="font-size: 1em;">was quite content to teach myself anything that interested</span> <span style="font-size: 1em;">me.</span></p>

    <p>I sold a few games for this and another 6502 platform called <span style="font-size: 1em;">the Oric, and with that money started up a company</span> <span style="font-size: 1em;">making Assemblers and other development tools. On the</span> <span style="font-size: 1em;">way I learned C and C++, and each time I stepped up</span> <span style="font-size: 1em;">whole rafts of bugs and timewasting miseries disappeared.</span></p>

    <p><span style="font-size: 1em;">Its like that picture on the “Ascent of Man,” from Nethanderal</span> <span style="font-size: 1em;">relative branch computation through to Homo Erectus with</span> <span style="font-size: 1em;">his virtual functions.</span></p>

    <p>Alongside this I began to explore digital hardware design, <span style="font-size: 1em;">again teaching myself from experience. I discovered that</span> <span style="font-size: 1em;">hardware and software are two sides of the same coin, al</span><span style="font-size: 1em;">though they are treated completely separately in education.</span> <span style="font-size: 1em;">It’s really an implementation detail whether you choose to</span> <span style="font-size: 1em;">make your logical function in software or in hardware, or some</span> <span style="font-size: 1em;">mixture of the two. Having a foot in both camps gives greater</span> <span style="font-size: 1em;">insight into the nature of design: for example, C++ can be</span> <span style="font-size: 1em;">said to borrow many concepts from electronics in terms of the</span> <span style="font-size: 1em;">importance of interfaces.</span></p>

    <p>Recently before becoming interested in the Xbox I had been <span style="font-size: 1em;">working for a US-owned company with an office in Oxford,</span> <span style="font-size: 1em;">doing many jobs but the last one was designing smartcard</span> <span style="font-size: 1em;">silicon. Although the design was interesting and there were</span> <span style="font-size: 1em;">some great people working in the trenches there, I became i</span><span style="font-size: 1em;">ncreasingly despondent about the politics and problems with</span> <span style="font-size: 1em;">the management. Nor did it help that despite being spread</span> <span style="font-size: 1em;">across several projects, I was paid 2/3rds the salary of staff in</span> <span style="font-size: 1em;">San Jose simply because I was based in the UK. And don't get</span> <span style="font-size: 1em;">me started about the patents they had from me with no re</span><span style="font-size: 1em;">ward. In December 2001 I discovered that integrity was more</span> <span style="font-size: 1em;">important than money, resigned, and decided to go back to</span> <span style="font-size: 1em;">working for myself.</span></p>

    <p>I had been rather tenderized by some unpleasant experiences <span style="font-size: 1em;">on leaving this company, while digesting these I found myself</span> <span style="font-size: 1em;">snagged by the vast difference in outlook between the ugly,</span> <span style="font-size: 1em;">grabbing, controlling instincts of your average company in</span><span style="font-size: 1em;">volved in Intellectual Property, and the nature of GPL projects</span> <span style="font-size: 1em;">and the people involved in encouraging a reduction in the</span> <span style="font-size: 1em;">severity of patent and copyright laws. As time went on I in</span><span style="font-size: 1em;">creasingly came to see Microsoft, and the previous company</span> <span style="font-size: 1em;">I was working for in the same light.</span></p>

    <p><span style="font-size: 1em;">It was after this that I read about bunnie's hack on Slashdot. I</span> <span style="font-size: 1em;">read about bunnie's methods with some tart emotions. My</span> <span style="font-size: 1em;">main thoughts were that this was something that I could have</span> <span style="font-size: 1em;">done, since I have been using the FPGAs that bunnie used</span> <span style="font-size: 1em;">since 1989, admiration for the conciseness of the attack, and</span> <span style="font-size: 1em;">dismay with myself that I had not been doing something equally</span> <span style="font-size: 1em;">cool and interesting — and that matched with my philosophi</span><span style="font-size: 1em;">cal predilictions — with my time. Instead I was sitting there</span> <span style="font-size: 1em;">reading Slashdot, drinking coffee, contributing nothing. (An</span> <span style="font-size: 1em;">aside, I think this is a fairly common experience for many</span> <span style="font-size: 1em;">Slashdot readers, to be a little jealous and challenged when</span> <span style="font-size: 1em;">they read about someone else's cool hacks. I think it explains</span> <span style="font-size: 1em;">the constant background noise there of jeering and question</span><span style="font-size: 1em;">ing why someone would want to do such a thing.)</span></p>

    <p><span style="font-size: 1em;">Over the next few weeks I gathered as much information as I</span> <span style="font-size: 1em;">could on the internals of the Xbox; Xboxhacker.net was cru</span><span style="font-size: 1em;">cial for this. It’s also where I met Michael Steil as the Xbox</span> <span style="font-size: 1em;">Linux project was starting. Pretty soon I was able to identify</span> <span style="font-size: 1em;">interesting projects that I could contribute to, for example</span> <span style="font-size: 1em;">the Milksop project. Again from this, with Surferdude's help, it</span> <span style="font-size: 1em;">became possible for me to put together the very first clean</span> <span style="font-size: 1em;">ROM which was able to boot and keep up the Xbox with</span><span style="font-size: 1em;">out being reset. This later became the basis of the crom</span> <span style="font-size: 1em;">1MB Linux and cromwell, the Xbox Linux clean ROM. After</span> <span style="font-size: 1em;">the initial hacks and designs, I decided to work almost en</span><span style="font-size: 1em;">tirely towards the Xbox Linux goal.</span></p>

    <p><span style="font-size: 1em;"><b>Can you tell us why you hack the Xbox?</b></span><br/></p>

    <p><span style="font-size: 1em;">Why? Everyone has different reasons, but for me it was my</span> <span style="font-size: 1em;">comprehension of Microsoft's outrageous antitrust behaviour</span> <span style="font-size: 1em;">— deny everything, appeal everything, delay everything,</span> <span style="font-size: 1em;">and in the meanwhile, create and dump (for they are sold</span> <span style="font-size: 1em;">at below cost) on the market millions of Microsoft-only PCs</span> <span style="font-size: 1em;">— the Xbox. Since our representatives here in Europe and</span> <span style="font-size: 1em;">the U.S. don't seem to care (perhaps, as was the case re</span><span style="font-size: 1em;">cently in the EU, because they plan to go work for Microsoft</span> <span style="font-size: 1em;">and take their silver pieces), it would be an honour to be part</span> <span style="font-size: 1em;">of pricking this evil plan of a bloated monopoly using the</span> <span style="font-size: 1em;">weapons of the GPL and Linux. I know that people shut their</span> <span style="font-size: 1em;">eyes and think of their share options, but it must be hard for</span> <span style="font-size: 1em;">decent people — and surely most of the people working there</span> <span style="font-size: 1em;">are this — to work for such a monster.</span></p>

    <p>I was lucky enough to get a couple of contracts through 2002 <span style="font-size: 1em;">that allowed me to spend the latter part of the year working</span> <span style="font-size: 1em;">exclusively on getting the first Linux kernel up in crom and bring</span><span style="font-size: 1em;">ing Cromwell up so it was able to control the main peripher</span><span style="font-size: 1em;">als of the box and boot Linux from HDD or CD. Since then my</span> <span style="font-size: 1em;">share of the Project A prize money (thanks to donor Michael</span> <span style="font-size: 1em;">Robertson) wil allow me to continue working full time, for the</span> <span style="font-size: 1em;">next few months at least.</span></p>

    <p><span style="font-size: 1em;"><b>Do you have any advice you’d like to share?</b></span></p>

    <p>My final thought is to encourage people, especially young <span style="font-size: 1em;">people, to listen to their brain when it comes to things that</span> <span style="font-size: 1em;">interest them. Don't be afraid to dig around and try to learn</span> <span style="font-size: 1em;">about things that snag your attention. That feeling you get</span> <span style="font-size: 1em;">when you wish you understood something, a kind of yearn</span><span style="font-size: 1em;">ing, is your brain's way of telling you that it thinks the knowl</span><span style="font-size: 1em;">edge might be useful later. If you listen to it enough, you stand</span> <span style="font-size: 1em;">a good chance of knowing the right thing at the right time to</span> <span style="font-size: 1em;">make some small difference.</span></p>
  </div>

  <p><span style="font-size: 1em;">That single location can be pre-loaded with a follow-up jump instruction</span> <span style="font-size: 1em;">back into any piece of user code using the previously discussed jam table</span> <span style="font-size: 1em;">codes. The Xbox hacking community had come together in a heroic</span> <span style="font-size: 1em;">effort and cracked Xbox security version 1.1 in three days. A separate</span> <span style="font-size: 1em;">effort, no less valiant, by Xecuter had also cracked the security in the</span> <span style="font-size: 1em;">same time frame.</span></p>

  <p>The first moral of this story is that security is only as strong as its weakest link. While there is little doubt about the robustness of the RSA cipher and the SHA-1 hash for digital signature purposes, these were not the <span style="font-size: 1em;">only elements of the security system. The TEA cipher used to extend the</span> <span style="font-size: 1em;">secure boot ROM’s trust sphere into the FLASH ROM had flaws that</span> <span style="font-size: 1em;">allowed hackers to walk around the strong digital signature algorithms.</span> <span style="font-size: 1em;">This leads us to our second moral: complexity breeds weaknesses.</span> <span style="font-size: 1em;">Complex systems are difficult to design, test, and analyze. The version 1.1</span> <span style="font-size: 1em;">security for the Xbox was probably implemented on a short fuse, so</span> <span style="font-size: 1em;">there was insufficient time to analyze the system for weaknesses. Either</span> <span style="font-size: 1em;">that, or Microsoft knew about the TEA weakness and designed this back</span> <span style="font-size: 1em;">door into the system to mitigate the risk of locking their FBL into</span> <span style="font-size: 1em;">silicon. It seems rather doubtful that Microsoft intentionally included this back door, since modifying the MCPX silicon is a very expensive</span> <span style="font-size: 1em;">proposition (although the expense ended up on nVidia’s books). On the</span> <span style="font-size: 1em;">other hand, complexity is hard to avoid. My advisor at MIT, Tom</span> <span style="font-size: 1em;">Knight, once told me, “There are two kinds of designs in this world:</span> <span style="font-size: 1em;">those that are useful, and those that you can formally prove to be</span> <span style="font-size: 1em;">correct.” To some extent, the only way to ensure the security of a real-</span><span style="font-size: 1em;">world system is to make its details open (no security through obscurity!)</span> <span style="font-size: 1em;">and subject the system to analysis from all angles. In a way, a thorough</span> <span style="font-size: 1em;">analysis of Xbox security is being conducted at no expense to Microsoft,</span> <span style="font-size: 1em;">thanks to the hacker community.</span></p>

  <div>
    Even if Microsoft had used a stronger hash function in the secret boot ROM, there are still a number of viable attacks on the Xbox that have yet to be tried. One can mount a man-in-the-middle attack on the HyperTransport bus (see Chapter 8) by overdriving the signals with carefully timed pulses. This attack is fairly simple to implement, since each HyperTransport bus trace has a test point visible from the component side of the motherboard. A complete hardware solution would involve an FPGA on a board with “pogo pin” bed-of-nails style test connectors. This board can be impressed upon these test points without any solder. Another attack, suggested by Adi Shamir to me at the CHES conference, is to employ a timed glitch in the CPU clock or power supply to upset the calculation of a jump target address. This kind of attack has been applied with success to the processors in cryptographic smart cards. Again, this kind of attack can be implemented fairly easily and cheaply as a user-installable module. (Keep in mind that a much broader range of attacks is available to hackers if the goal is a onetime defeat of the security to recover, for example, a secret key or a block of critical code.)<br/>
  </div>


  <h2><b class="calibre3" style="font-size: 1em;">The Threat of Back Doors</b><br/></h2>

  <p><span style="font-size: 1em;">As this chapter has demonstrated, searching for back doors is a practical</span> <span style="font-size: 1em;">method for attacking cryptographically secured hardware. The relatively high success rate of finding back doors in the Xbox is partially because the</span> <span style="font-size: 1em;">Xbox represents the first significant attempt made by a vendor to</span> <span style="font-size: 1em;">cryptographically secure a PC. Despite the lessons learned from the</span> <span style="font-size: 1em;">Xbox experience, future secure PC implementations are still at risk of</span> <span style="font-size: 1em;">having hardware security weaknesses, since the legacy of the PC is an</span> <span style="font-size: 1em;">open and unsecured hardware architecture.</span></p>

  <div class="infobox">
    <h2 class="sigil_not_in_toc"><b class="calibre3" style="font-size: 1em;">Profile: Franz Lehner</b><br/></h2>

    <p>Franz Lehner, 29, lives in Austria with his girlfriend. He studied <span style="font-size: 1em;">Electrical Engineering for 5 years. Now, he programs “auto</span><span style="font-size: 1em;">mated solutions” while running an ISP. In his spare time, he</span> <span style="font-size: 1em;">searches for projects that are fun and educational.</span></p>

    <p><span style="font-size: 1em;">After finding bunnie’s Xbox hacking document, he met the</span> <span style="font-size: 1em;">Xbox-Linux team on sourceforge.net. He joined the Xbox-</span><span style="font-size: 1em;">Linux project to learn about team programming, Linux ker</span><span style="font-size: 1em;">nel hacking and debugging, and cryptographic systems.</span> <span style="font-size: 1em;">He also joined the Xbox-Linux project to develop a better</span> <span style="font-size: 1em;">understanding of related systems, such as Palladium.</span></p>
  </div>

  <p><span style="font-size: 1em;">PC hardware is complex yet fragile, and building a chain of trust out of</span> <span style="font-size: 1em;">it is difficult because of this brittleness. Fundamentally, each component in a PC is designed to be “trusting” of its physical environment. The</span> <span style="font-size: 1em;">specifications for any commercial integrated circuit component clearly</span> <span style="font-size: 1em;">state that the IC is guaranteed to operate over a bounded range of t</span><span style="font-size: 1em;">emperatures, voltages, frequencies, and other conditions. If these maxi</span><span style="font-size: 1em;">mum ratings are violated, then the behavior of the device is “undefined,”</span> <span style="font-size: 1em;">and al bets are off. Most chip engineers do not even consider trying to make their circuits recover gracefully from an out-of-range condition, as it is already hard enough to get a chip to work under the specified operating conditions.</span> <span style="font-size: 1em;">Furthermore, most consumer applications are very cost-sensitive, and the</span> <span style="font-size: 1em;">overhead of building in robust fault tolerance measures results in a product that is not price-competitive.</span></p>

  <p>Thus, chips are typically implemented with no internal error-checking. If, for some reason, the Arithmetic Logic Unit (ALU, the computational “brains” <span style="font-size: 1em;">of a CPU) adds two numbers incorrectly, the problem will only manifest</span> <span style="font-size: 1em;">itself symptomatically; you can observe only the effects of such an error,</span> <span style="font-size: 1em;">sometimes long after the error-causing event. One can think of attacks that take advantage of faults induced by out-of-range conditions as the analogy</span> <span style="font-size: 1em;">of buffer overruns in the software world.</span></p>

  <p>Another problem with the PC architecture is that the processor is too <span style="font-size: 1em;">trusting of its code environment. The Pentium processor architecture has</span> <span style="font-size: 1em;">no provision in hardware for discriminating between code that is insecure or secure. If the instruction pointer happens to find its way into an insecure code segment through a bug or an induced failure, the processor will happily execute this code.</span></p>

  <div class="note">
    <h3 class="sigil_not_in_toc">Note</h3>

    <p><img alt="" class="note" src="../Images/index-167_1.png"/></p>

    <p><b class="calibre3">Code compartmentalization based on hardware security</b> <b class="calibre3" style="font-size: 1em;">levels is a different technique from sand-boxing. Sand</b><b class="calibre3" style="font-size: 1em;">boxing does not provide an adequate solution for situa</b><b class="calibre3" style="font-size: 1em;">tions where a user program requires direction from or in</b><b class="calibre3" style="font-size: 1em;">teraction with secret or protected code or data. Lately,</b> <b class="calibre3" style="font-size: 1em;">new processor architectures have been proposed that can</b> <b class="calibre3" style="font-size: 1em;">solve this problem through the use of data tags that embed</b> <b class="calibre3" style="font-size: 1em;">a sort of security audit log.<sup>5</sup></b></p>
  </div>

  <p style="clear:left;">Another source of back doors are the design bugs that exist in every <span style="font-size: 1em;">complex chip. It is common practice to ship chips with plenty of known</span> <span style="font-size: 1em;">bugs, also known as errata. For example, the Intel i860 XP processor (first released in 1991, not to be confused with the recently released i860 chipset for the Pentium4 processor) shipped with a book of errata that was comparable in size to the processor’s data sheet. Another example closer to home is the bug in the nVidia MCPX’s address space decoder that made the</span> <span style="font-size: 1em;">MIST Premature Unmap attack possible. Most of these errata have simple</span> <span style="font-size: 1em;">work-arounds or have minor implications for the functionality of the chip</span> <span style="font-size: 1em;">under nominal conditions. However, some errata, such as those dealing</span> <span style="font-size: 1em;">with cache coherence, address decoding, and memory management can result</span> <span style="font-size: 1em;">in major</span> <i class="calibre4" style="font-size: 1em;">software</i> <span style="font-size: 1em;">security holes.</span></p>

  <p>In the case of the Xbox, the business impact of a hardware back door is <span style="font-size: 1em;">probably small. Perhaps Microsoft loses some small fraction of game sales</span> <span style="font-size: 1em;">revenue, but the losses due to piracy are dwarfed by the losses Microsoft</span> <span style="font-size: 1em;">takes on hardware sales. Also, the Xbox is just a game console — grandma’s</span> <span style="font-size: 1em;">bank account is not being tapped dry or credit card numbers stolen as a</span> <span style="font-size: 1em;">result of security weaknesses in the Xbox. However, more than game</span> <span style="font-size: 1em;">revenues will be at risk with the trusted PC. Unless the trusted PC architecture is a fundamental change from legacy PCs, people will be blindly trusting financial secrets and personal data security to untrustworthy hardware.</span></p>

  <p>Like most things in life, the first step is education. The more we learn about hardware security, even if it involves poking around a game console, the <span style="font-size: 1em;">better our security systems will be tomorrow. Now, on with the lesson . . .</span></p>
  <hr/>

  <p class="calibre1"><sup>1</sup> From Andy Green’s 19th Annual Chaos Communication Congress presentation on Xbox security hacking.</p>

  <p class="calibre1"><sup>2</sup> From an article by the Inquirer, http://www.theinquirer.net/?article=4735</p>

  <p><sup>3</sup> From Andy Green’s 19th Annual Chaos Communication Congress presentation on Xbox security hacking.</p>

  <p><sup>4</sup> Posting from www.xboxhacker.net under the Xbox Hacker BBS- &gt; <span style="font-size: 1em;">Xbox Hacking (TECHNICAL) -&gt; BIOS/Flash ROM/Firmware -&gt;</span> <span style="font-size: 1em;">News from the Xbox Linux Team, MS ‘made a hash of it,’ guts</span> <span style="font-size: 1em;">exposed.</span><br/></p>

  <p><sup>5</sup> http://www.ai.mit.edu/projects/aries/Documents/Memos/ARIES-15.pdf. <span style="font-size: 1em;">“A Minimal Trusted Computing Base for Dynamically Ensuring</span> <span style="font-size: 1em;">Secure Information Flow,” by Tom Knight and Jeremy Brown.</span></p>
</body></html>