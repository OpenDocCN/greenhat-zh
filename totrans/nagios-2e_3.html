<html><head></head><body>
  <div class="part" title="Part&#xA0;III.&#xA0;The Web Interface and Other Ways to Visualize Nagios Data">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_web_interface_and_other_ways_to_vi"/>Part III. The Web Interface and Other Ways to Visualize Nagios Data</h1>
    </div>

    <div class="partintro" id="id2523558" title="The Web Interface and Other Ways to Visualize Nagios Data"/>
  </div>


  <div class="chapter" title="Chapter&#xA0;16.&#xA0;The Classical Web Interface">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_classical_web_interface"/>Chapter 16. The Classical Web Interface</h1>
    </div>

    <p>On the right is the navigation area with the unmistakable black background, and the remaining area is for displaying the CGI scripts called (<a class="xref" href="../Text/ch16.html#the_subitem_unhandled_under_both_the_se" title="Figure 16-1. The subitem Unhandled under both the Service Problems and Host Problems menu items has only been on the start page of the Nagios Web interface since Nagios 3.0.">Figure 16-1</a>)-the Nagios Web interface is that simple. The start screen provides access to the program documentation—extremely useful if you just want to look up something quickly.<a class="indexterm" id="IDX-CHP-16-1162"/></p>

    <p>Provided you have the correct access rights, the Web interface allows much more than just looking up information. You can run a series of commands and control Nagios actively: from setting a single command, to switching messages on and off, to restarting the server.</p>

    <p>A separate book would be needed to describe all the features completely. This is why we will just describe the concept here on which the CGI programs are based,<sup>[<a class="footnote" href="#ftn.CHP-16-FN-1" id="CHP-16-FN-1">147</a>]</sup> in this way giving you a picture of the extensive range of options available.</p>

    <p>Many functions use the very same CGI program. If you move the mouse up and down in the navigation area shown in <a class="xref" href="../Text/ch16.html#the_subitem_unhandled_under_both_the_se" title="Figure 16-1. The subitem Unhandled under both the Service Problems and Host Problems menu items has only been on the start page of the Nagios Web interface since Nagios 3.0.">Figure 16-1</a> and observe the status display of the browser when doing this, which reveals the URLs to be called, you will see that in the <span class="strong"><strong>Monitoring</strong></span> section up to the <span class="strong"><strong>Show Hosts:</strong></span> entry field, the CGI program <strong class="userinput"><code>status.cgi</code></strong> is always called, with just four exceptions. Only the parameters are different. Things are similar for the CGI program <strong class="userinput"><code>cmd.cgi</code></strong>, with which general commands can be run. The parameters passed specify whether a comment is to be read, or a message enabled or disabled, or if Nagios is to be restarted.<a class="indexterm" id="IDX-CHP-16-1163"/><a class="indexterm" id="IDX-CHP-16-1164"/><a class="indexterm" id="IDX-CHP-16-1165"/></p>

    <div class="figure">
      <a id="the_subitem_unhandled_under_both_the_se"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e29539"/><img alt="The subitem Unhandled under both the Service Problems and Host Problems menu items has only been on the start page of the Nagios Web interface since Nagios 3.0." src="../Images/tagoreillycom20081104nostarchimages223844.png.jpg"/></div>

      <p class="title">Figure 16-1. The subitem Unhandled under both the Service Problems and Host Problems menu items has only been on the start page of the Nagios Web interface since Nagios 3.0.</p>
    </div>

    <div class="table">
      <a id="overview_of_cgi_programs"/>

      <p class="title">Table 16-1. overview of CGI programs</p>

      <div class="table-contents">
        <table class="sgc-3" summary="overview of CGI programs">
          <colgroup>
            <col/>
            <col/>
          </colgroup>

          <thead>
            <tr>
              <th class="sgc-1" valign="bottom">
                <p>CGI program</p>
              </th>

              <th class="sgc-1" valign="bottom">
                <p>Description</p>
              </th>
            </tr>
          </thead>

          <tbody>
            <tr>
              <td class="sgc-2" valign="top">
                <p><strong class="userinput"><code>status.cgi</code></strong></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Status display in various forms; by far the most important CGI program (<a class="xref" href="../Text/ch16s02.html#the_overview_output_style" title="Figure 16-10. The overview output style">Figure 16-10</a> to <a class="xref" href="../Text/ch16s02.html#the_hostdetail_output_style" title="Figure 16-15. The hostdetail output style">Figure 16-15</a>, page 334.)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p><strong class="userinput"><code>statusmap.cgi</code></strong><a class="indexterm" id="IDX-CHP-16-1166"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Topological representation of the monitored host (see <a class="xref" href="../Text/ch16s02.html#dependencies_of_monitored_hosts_shown_g" title="Figure 16-27. Dependencies of monitored hosts shown graphically">Figure 16-27</a>, page 347)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p><strong class="userinput"><code>statuswrl.cgi</code></strong><a class="indexterm" id="IDX-CHP-16-1167"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Topological representation in 3D format; requires a VRML-capable browser and allows interactive navigation in a virtual space (<a class="xref" href="../Text/ch16s02.html#this_picture_marks_the_beginning_of_the" title="Figure 16-29. This picture marks the beginning of the tour through your own network">Figure 16-29</a>, page 349)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p><strong class="userinput"><code>statuswml.cgi</code></strong><a class="indexterm" id="IDX-CHP-16-1168"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Simple status page for WAP devices (cellphone)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>extinfo.cgi<a class="indexterm" id="IDX-CHP-16-1169"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Additional information on a host or service, with the possibility of running commands (<a class="xref" href="../Text/ch16.html#extinfo.cgi_provides_additional_informa" title="Figure 16-4. extinfo.cgi provides additional information on the selected host">Figure 16-4</a>, page 331)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>cmd.cgi<a class="indexterm" id="IDX-CHP-16-1170"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Running commands (<a class="xref" href="../Text/ch16s02.html#disabling_a_service_check_with_cmd.c" title="Figure 16-23. Disabling a service check with cmd.cgi?cmd_typ=6">Figure 16-23</a>, page 343)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>tac.cgi<a class="indexterm" id="IDX-CHP-16-1171"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Overview of all services and hosts to be monitored, the <span class="strong"><strong>Tactical Overview</strong></span> (see <a class="xref" href="../Text/ch16s02.html#tactical_overview_with_tac.cgi" title="Figure 16-26. Tactical overview with tac.cgi">Figure 16-26</a> in page 346)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>outages.cgi<a class="indexterm" id="IDX-CHP-16-1172"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Network nodes that cause the failure of partial networks (<a class="xref" href="../Text/ch16s02.html#as_long_as_sis-proxy_fails_comma_nagios" title="Figure 16-30. As long as sis-proxy fails, Nagios cannot reach any hosts lying behind it">Figure 16-30</a>, page 350)<a class="indexterm" id="IDX-CHP-16-1173"/></p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>config.cgi<a class="indexterm" id="IDX-CHP-16-1174"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Display of Nagios object definitions (<a class="xref" href="../Text/ch16s02.html#config.cgi_displays_the" title="Figure 16-31. config.cgi displays the current configuration of the selected object class—here hosts—(extract)">Figure 16-31</a>, page 351)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>avail.cgi<a class="indexterm" id="IDX-CHP-16-1175"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Availability report (e.g., "98 percent of all systems OK, 2 percent WARNING", see <a class="xref" href="../Text/ch16s02.html#an_availability_report_using_the_exampl" title="Figure 16-32. An availability report using the example of the SAP-Services service group">Figure 16-32</a>, page 352)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>histogram.cgi<a class="indexterm" id="IDX-CHP-16-1176"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Histogram of the number of events occurring (<a class="xref" href="../Text/ch16s02.html#how_many_events_of_what_type_were_there" title="Figure 16-34. How many events of what type were there on which day?">Figure 16-34</a>, page 353)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>History.cgi</p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Display of all events that have ever occurred (<a class="xref" href="../Text/ch16s02.html#history.cgi_filters_the" title="Figure 16-35. history.cgi filters the information from the log file">Figure 16-35</a>, page 355)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>notifications.cgi<a class="indexterm" id="IDX-CHP-16-1177"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Overview of all sent notifications (<a class="xref" href="../Text/ch16s02.html#notifications.cgi_answer" title="Figure 16-36. notifications.cgi answers the question of who gets messages when, about what">Figure 16-36</a>, page 355)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>showlog.cgi<a class="indexterm" id="IDX-CHP-16-1178"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Display of all log file entries (<a class="xref" href="../Text/ch16s02.html#a_blue_button_marks_information_entries" title="Figure 16-37. A blue button marks information entries, the graph changing from red to green stands for Nagios restarts, and the icon marked GO with a green checked background represents restarts of the monitoring system">Figure 16-37</a>, page 356)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>summary.cgi<a class="indexterm" id="IDX-CHP-16-1179"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Report of events, which can be compiled by host, service, error category and time period (<a class="xref" href="../Text/ch16s02.html#an_individual_report_comma_as_generated" title="Figure 16-39. An individual report, as generated by summary.cgi">Figure 16-39</a>, page 358)</p>
              </td>
            </tr>

            <tr>
              <td class="sgc-2" valign="top">
                <p>trends.cgi<a class="indexterm" id="IDX-CHP-16-1180"/></p>
              </td>

              <td class="sgc-2" valign="top">
                <p>Time axis recording the states that have occurred (<a class="xref" href="../Text/ch16s02.html#trends.cgi_represents_th" title="Figure 16-40. trends.cgi represents the chronological sequence of states—here using the example of a service">Figure 16-40</a>, page 359)</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <p><a class="xref" href="../Text/ch16.html#overview_of_cgi_programs" title="Table 16-1. overview of CGI programs">Table 16-1</a> shows an overview of all the CGI programs included in the package. They all check to see whether the person running the requested action is allowed to do so. Normally a user can only access the hosts and services for which he is entered as the contact. In addition there is the possibility of assigning specific users more comprehensive rights, so that they are basically allowed to display all hosts and services, for example, or to request system information. Settings for other users are made in the <strong class="userinput"><code>cgi.cfg</code></strong> configuration file, and the authentication parameters are described in <a class="xref" href="../Text/apas02.html" title="A.2 CGI Configuration in cgi.cfg">A.2 CGI Configuration in cgi.cfg</a>, page 606.<a class="indexterm" id="IDX-CHP-16-1181"/></p>

    <div class="sect1" title="16.1 Recognizing and Acting On Problems">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="recognizing_and_acting_on_problems"/>16.1 Recognizing and Acting On Problems</h1>
      </div>

      <p>A suitable starting point for the administrator is the <span class="strong"><strong>Service Problems</strong></span> page, which can be reached through the menu item, shown in <a class="xref" href="../Text/ch16.html#the_menu_item_service_problems_brings_c" title="Figure 16-2. The menu item Service Problems brings current problems to attention">Figure 16-2</a>. You can see all problems at a glance. If there is just a service-related problem, but not a host-related one, the host name in the <span class="strong"><strong>Host</strong></span> column has a gray background, but a red background means the host itself is the source of the trouble.</p>

      <div class="figure">
        <a id="the_menu_item_service_problems_brings_c"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e29785"/><img alt="The menu item Service Problems brings current problems to attention" src="../Images/tagoreillycom20081104nostarchimages223846.png.jpg"/></div>

        <p class="title">Figure 16-2. The menu item Service Problems brings current problems to attention</p>
      </div>

      <p>The hosts <strong class="userinput"><code>sis-mail</code></strong> and <strong class="userinput"><code>sis-proxy</code></strong>, which have failed in <a class="xref" href="../Text/ch16.html#the_menu_item_service_problems_brings_c" title="Figure 16-2. The menu item Service Problems brings current problems to attention">Figure 16-2</a>, can be seen again in the <span class="strong"><strong>Host Problems</strong></span> menu item (<a class="xref" href="../Text/ch16.html#the_host_problems_menu_item_reveals_thi" title="Figure 16-3. The Host Problems menu item reveals this display">Figure 16-3</a>): <strong class="userinput"><code>sis-mail</code></strong> cannot be reached (UNREACHABLE), so the real problem therefore exists in the failure of the host <strong class="userinput"><code>sls-proxy</code></strong>. This dependency is illustrated in the <span class="strong"><strong>Outages</strong></span> menu item (<a class="xref" href="../Text/ch16s02.html#as_long_as_sis-proxy_fails_comma_nagios" title="Figure 16-30. As long as sis-proxy fails, Nagios cannot reach any hosts lying behind it">Figure 16-30</a>, page 350) or the <span class="strong"><strong>Status Map</strong></span> (<a class="xref" href="../Text/ch16s02.html#dependencies_of_monitored_hosts_shown_g" title="Figure 16-27. Dependencies of monitored hosts shown graphically">Figure 16-27</a>, page 347). In <a class="xref" href="../Text/ch16s02.html#dependencies_of_monitored_hosts_shown_g" title="Figure 16-27. Dependencies of monitored hosts shown graphically">Figure 16-27</a> the two failed hosts are shown with a red background, and you can also clearly see which host is dependent on the other (always from the point of view of the central Nagios host).</p>

      <div class="figure">
        <a id="the_host_problems_menu_item_reveals_thi"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e29828"/><img alt="The Host Problems menu item reveals this display" src="../Images/tagoreillycom20081104nostarchimages223848.png.jpg"/></div>

        <p class="title">Figure 16-3. The Host Problems menu item reveals this display</p>
      </div>

      <div class="sect2" title="16.1.1 Comments on problematic hosts">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="comments_on_problematic_hosts"/>16.1.1 Comments on problematic hosts</h2>
        </div>

        <p>The administrator clarifies the problem with the external office by telephone: the DSL connection has failed. He announces this failure to the provider responsible. To stop his colleagues from going to the same trouble again, the admin enters a corresponding comment on the failed host. To do this he clicks in the status display on the host name, which takes him to an information page for this specific host (<a class="xref" href="../Text/ch16.html#extinfo.cgi_provides_additional_informa" title="Figure 16-4. extinfo.cgi provides additional information on the selected host">Figure 16-4</a>), the options of which are described in more detail in <a class="xref" href="../Text/ch16s02.html#additional_information_and_control_cent" title="16.2.2 Additional information and control center: extinfo.cgi">16.2.2 Additional information and control center: extinfo.cgi</a>, page 339.<a class="indexterm" id="IDX-CHP-16-1182"/></p>

        <div class="figure">
          <a id="extinfo.cgi_provides_additional_informa"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e29852"/><img alt="extinfo.cgi provides additional information on the selected host" src="../Images/tagoreillycom20081104nostarchimages223850.png.jpg"/></div>

          <p class="title">Figure 16-4. <code class="userinput">extinfo.cgi</code> provides additional information on the selected host</p>
        </div>

        <p>Using the <span class="strong"><strong>Add a new comment</strong></span> link at the bottom of the page, the CGI program <strong class="userinput"><code>cmd.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#interface_for_external_commands_colon_c" title="16.2.3 Interface for external commands: cmd.cgi">16.2.3 Interface for external commands: cmd.cgi</a>, page 343), which by passing on a corresponding parameter is already prepared for this task,<sup>[<a class="footnote" href="#ftn.CHP-16-FN-2" id="CHP-16-FN-2">148</a>]</sup> allows a comment to be recorded (<a class="xref" href="../Text/ch16.html#entering_a_comment_for_a_host" title="Figure 16-5. Entering a comment for a host">Figure 16-5</a>). The host name is already shown, the check mark in the <span class="strong"><strong>Persistent</strong></span> box ensures that the comments will also "survive" a Nagios restart. The user name filled out in the <span class="strong"><strong>Author (Your Name):</strong></span> field can be edited, as can the actual comment in the <span class="strong"><strong>Comment</strong></span> field.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-3" id="CHP-16-FN-3">149</a>]</sup><a class="indexterm" id="IDX-CHP-16-1183"/></p>

        <div class="figure">
          <a id="entering_a_comment_for_a_host"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e29901"/><img alt="Entering a comment for a host" src="../Images/tagoreillycom20081104nostarchimages223852.png.jpg"/></div>

          <p class="title">Figure 16-5. Entering a comment for a host</p>
        </div>

        <p>The administrator confirms the entry with the <span class="strong"><strong>Commit</strong></span> button. Returning to the status overview, for example with the <span class="strong"><strong>Service Problems</strong></span> menu item, the administrator will see a speech bubble next to the host name, indicating that a comment exists for this host (<a class="xref" href="../Text/ch16.html#a_speech_bubble_displays_the_existence" title="Figure 16-6. A speech bubble displays the existence of comments">Figure 16-6</a>). Clicking on the icon opens the corresponding information page and takes the admin directly to the comment entries (<a class="xref" href="../Text/ch16.html#a_click_on_delete_all_comments_deletes" title="Figure 16-7. A click on Delete all comments deletes all comments at once">Figure 16-7</a>). Clicking on the icon of the trash can in the <span class="strong"><strong>Actions</strong></span> column deletes these individually, if required.</p>

        <div class="figure">
          <a id="a_speech_bubble_displays_the_existence"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e29924"/><img alt="A speech bubble displays the existence of comments" src="../Images/tagoreillycom20081104nostarchimages223854.png.jpg"/></div>

          <p class="title">Figure 16-6. A speech bubble displays the existence of comments</p>
        </div>

        <div class="figure">
          <a id="a_click_on_delete_all_comments_deletes"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e29932"/><img alt="A click on Delete all comments deletes all comments at once" src="../Images/tagoreillycom20081104nostarchimages223856.png.jpg"/></div>

          <p class="title">Figure 16-7. A click on Delete all comments deletes all comments at once</p>
        </div>
      </div>

      <div class="sect2" title="16.1.2 Taking responsibility for problems">
        <div class="titlepage">
          <h2 class="title" id="heading_id_5"><a id="taking_responsibility_for_problems"/>16.1.2 Taking responsibility for problems</h2>
        </div>

        <p><span class="emphasis"><em>Acknowledgements</em></span> (so spelled on the Web interface) are oriented more closely to the workflow than simple comments. An acknowledgement signals to other administrators that somebody is already working on a problem, so nobody else needs to get involved with it for the time being. In the status overview, a small laborer icon symbolizes this form of taking responsibility (<a class="xref" href="../Text/ch16.html#a_laborer_icon_shows_that_an_admin_has" title="Figure 16-8. A laborer icon shows that an admin has already taken on responsibility for the problem (acknowledgement)">Figure 16-8</a>), and Nagios additionally notifies the relevant contacts.<a class="indexterm" id="IDX-CHP-16-1184"/><a class="indexterm" id="IDX-CHP-16-1185"/><a class="indexterm" id="IDX-CHP-16-1186"/></p>

        <p>To issue such a statement, the link <span class="strong"><strong>Acknowledge this Host Problem</strong></span> is used on the extended info page for the host in question. As well as the fields used for entering a normal comment, there are two checkboxes in this case, <span class="strong"><strong>Sticky Acknowledgement</strong></span> (<a class="xref" href="../Text/ch16.html#entry_dialog_for_a_host_acknowlegement" title="Figure 16-9. Entry dialog for a host acknowlegement">Figure 16-9</a>)—if checked, this option prevents period notification if the error status persists—and <span class="strong"><strong>Send Notification</strong></span>. If the latter is also checked, Nagios notifies the other administrators.</p>

        <div class="figure">
          <a id="a_laborer_icon_shows_that_an_admin_has"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e29973"/><img alt="A laborer icon shows that an admin has already taken on responsibility for the problem (acknowledgement)" src="../Images/tagoreillycom20081104nostarchimages223858.png.jpg"/></div>

          <p class="title">Figure 16-8. A laborer icon shows that an admin has already taken on responsibility for the problem (acknowledgement)</p>
        </div>

        <div class="figure">
          <a id="entry_dialog_for_a_host_acknowlegement"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e29981"/><img alt="Entry dialog for a host acknowlegement" src="../Images/tagoreillycom20081104nostarchimages223860.png.jpg"/></div>

          <p class="title">Figure 16-9. Entry dialog for a host acknowlegement</p>
        </div>

        <p>The effect of <span class="strong"><strong>Persistent Comment</strong></span> is different in Nagios 2.x and Nagios 3.0: In Nagios 2.x the comment is only preserved on a reboot if the checkbox has been marked. Unfortunately, using this to save comments in case of a reboot has the disadvantage that the comment does not disappear automatically when the problem has been solved. On the other hand, Nagios 3.0 normally retains all comments after a reboot. If the check mark for <span class="strong"><strong>Persistent Comment</strong></span> is deleted, Nagios will remove the comment automatically as soon as the problem has been rectified. If the check mark is set, the comment must be removed manually if it is no longer needed, as in Nagios 2.x.</p>

        <p>What we are demonstrating here, using a faulty host state, can also be applied to faulty services. The CGI programs are the same, and through the passing of parameters they receive information on whether a host or service is involved, and react accordingly; only the host field receives company in the form of a <span class="strong"><strong>Service</strong></span> entry.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-1" id="ftn.CHP-16-FN-1">147</a>]</sup> There is a good reason that we refer here to CGI programs and not to CGI scripts: all CGI programs for Nagios 2.x and 3.0 are C programs.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-2" id="ftn.CHP-16-FN-2">148</a>]</sup> <strong class="userinput"><code>cmd_type=1&amp;host=sls-proxy</code></strong>. More on the parameters in <a class="xref" href="../Text/ch16s02.html#interface_for_external_commands_colon_c" title="16.2.3 Interface for external commands: cmd.cgi">16.2.3 Interface for external commands: cmd.cgi</a> following, page 343.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-3" id="ftn.CHP-16-FN-3">149</a>]</sup> Starting with Nagios 3.0, amending the author name can be prevented by using the parameter <strong class="userinput"><code>lock_author_name</code></strong> (see <a class="xref" href="../Text/apas02.html#other_parameters" title="A.2.2 Other Parameters">A.2.2 Other Parameters</a>).</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="16.2 An Overview of the Individual CGI Programs">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="an_overview_of_the_individual_cgi_progr"/>16.2 An Overview of the Individual CGI Programs</h1>
    </div>

    <p>At the time of going to press, this chapter was the most extensive documentation on the Nagios Web interface, especially for the individual CGI scripts. But for reasons of space, we shall not go into every detail. If you want to know more, you must take a look at the source code of the scripts or look at the <strong class="userinput"><code>nagios-users</code></strong><sup>[<a class="footnote" href="#ftn.CHP-16-FN-4" id="CHP-16-FN-4">150</a>]</sup> mailing list. Some of these are also read by the Nagios developers, and many a question is answered there for which there is currently no documentation.<a class="indexterm" id="IDX-CHP-16-1187"/><a class="indexterm" id="IDX-CHP-16-1188"/><a class="indexterm" id="IDX-CHP-16-1189"/><a class="indexterm" id="IDX-CHP-16-1190"/></p>

    <div class="sect2" title="16.2.1 Variations in status display: status.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="variations_in_status_display_colon_stat"/>16.2.1 Variations in status display: <strong class="userinput"><code>status.cgi</code></strong></h2>
      </div>

      <p>By far the most important CGI program, <strong class="userinput"><code>status.cgi</code></strong> is responsible for the status display. What it shows is determined by three parameter groups. The first one defines whether the Web page generated displays all hosts, a specific host, or a service group:<a class="indexterm" id="IDX-CHP-16-1192"/><a class="indexterm" id="IDX-CHP-16-1193"/><a class="indexterm" id="IDX-CHP-16-1194"/><a class="indexterm" id="IDX-CHP-16-1195"/><a class="indexterm" id="IDX-CHP-16-1196"/><a class="indexterm" id="IDX-CHP-16-1197"/><a class="indexterm" id="IDX-CHP-16-1198"/><a class="indexterm" id="IDX-CHP-16-1199"/><a class="indexterm" id="IDX-CHP-16-1200"/><a class="indexterm" id="IDX-CHP-16-1201"/><a class="indexterm" id="IDX-CHP-16-1202"/><a class="indexterm" id="IDX-CHP-16-1203"/><a class="indexterm" id="IDX-CHP-16-1204"/><a class="indexterm" id="IDX-CHP-16-1191"/></p><a id="I_programlisting1_d1e30109"/>
      <pre class="programlisting">http://<span class="emphasis"><em>nagiosserver</em></span>/nagios/cgi-bin/status.cgi?host=all
http://<span class="emphasis"><em>nagiosserver</em></span>/nagios/cgi-bin/status.cgi?hostgroup=all
http://<span class="emphasis"><em>nagiosserver</em></span>/nagios/cgi-bin/status.cgi?servicegroup=all</pre>

      <p>With <strong class="userinput"><code>host</code></strong> you can select individual hosts, and <strong class="userinput"><code>all</code></strong> in this case stands for <span class="emphasis"><em>all hosts</em></span>. <strong class="userinput"><code>hostgroup</code></strong> enables a specific host group to be displayed, and again you can use all to stand for <span class="emphasis"><em>all host groups</em></span>. Finally, <strong class="userinput"><code>servicegroup</code></strong> tells the CGI program to display either the individual service group given as a value, or <strong class="userinput"><code>all service groups</code></strong>, given with <strong class="userinput"><code>all</code></strong>.</p>

      <div class="figure">
        <a id="the_overview_output_style"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30153"/><img alt="The overview output style" src="../Images/tagoreillycom20081104nostarchimages223862.png.jpg"/></div>

        <p class="title">Figure 16-10. The <code class="userinput">overview</code> output style</p>
      </div>

      <p>The outputs of <strong class="userinput"><code>host=all</code></strong> and <strong class="userinput"><code>hostgroup=all</code></strong> are only different in their style, which is defined by the second parameter group. For <strong class="userinput"><code>host=all</code></strong>, <strong class="userinput"><code>style=detail</code></strong> is the default setting, and for <strong class="userinput"><code>hostgroup=all</code></strong>, it is <strong class="userinput"><code>style=overview.status.cgi?host=all&amp;style=overview</code></strong> therefore delivers the same result as <strong class="userinput"><code>status.cgi?hostgroup=all</code></strong>.<a class="indexterm" id="IDX-CHP-16-1205"/></p>

      <p>Hosts that do not belong to a host group only appear in the detail view <strong class="userinput"><code>host=all&amp;style=detail</code></strong> or <strong class="userinput"><code>hostgroup=all&amp;style=hostdetail</code></strong>. All other display styles always show entire host groups from which individual hosts may be missing. <strong class="userinput"><code>status.cgi</code></strong> provides five possible output styles: <strong class="userinput"><code>overview</code></strong> represents the hosts in a table, but summarizes the services according to states (<a class="xref" href="../Text/ch16s02.html#the_overview_output_style" title="Figure 16-10. The overview output style">Figure 16-10</a>). For the host group <strong class="userinput"><code>SAP</code></strong>, you would call the corresponding display with the URL</p><a id="I_programlisting1_d1e30207"/>
      <pre class="programlisting">http://<span class="emphasis"><em>nagiosserver</em></span>/nagios/cgi-bin/status.cgi?hostgroup=SAP&amp;style=overview</pre>

      <p>The <strong class="userinput"><code>style</code></strong> value <strong class="userinput"><code>summary</code></strong> compresses the output of <strong class="userinput"><code>overview: status.cgi</code></strong> only displays one host group for each line (<a class="xref" href="../Text/ch16s02.html#the_summary_output_style_of_nagios_2.x" title="Figure 16-11. The summary output style of Nagios 2.x">Figure 16-11</a> shows this for Nagios 2.x, <a class="xref" href="../Text/ch16s02.html#the_summary_output_style_of_nagios_3.0" title="Figure 16-12. The summary output style of Nagios 3.0">Figure 16-12</a> for Nagios 3.0). For Nagios 3.0, error states are distinguished as <span class="strong"><strong>unhandled</strong></span> (no acknowledgement set) or <span class="strong"><strong>acknowledged</strong></span>.</p>

      <div class="figure">
        <a id="the_summary_output_style_of_nagios_2.x"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30241"/><img alt="The summary output style of Nagios 2.x" src="../Images/tagoreillycom20081104nostarchimages223864.png.jpg"/></div>

        <p class="title">Figure 16-11. The <code class="userinput"><em class="replaceable"><code>summary</code></em></code> output style of Nagios 2.x</p>
      </div>

      <div class="figure">
        <a id="the_summary_output_style_of_nagios_3.0"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30253"/><img alt="The summary output style of Nagios 3.0" src="../Images/tagoreillycom20081104nostarchimages223866.png.jpg"/></div>

        <p class="title">Figure 16-12. The <code class="userinput"><em class="replaceable"><code>summary</code></em></code> output style of Nagios 3.0</p>
      </div>

      <p>The <strong class="userinput"><code>grid</code></strong> style provides an extremely attractive summary in which you can see the status of each individual service by means of the color with which it is highlighted (<a class="xref" href="../Text/ch16s02.html#the_gridoutput_style" title="Figure 16-13. The grid output style">Figure 16-13</a>). <strong class="userinput"><code>detail</code></strong> shows each service in detail on a separate line. The <strong class="userinput"><code>hostdetail</code></strong> output style is limited just to host information, providing detailed information with one line for each host (<a class="xref" href="../Text/ch16s02.html#the_hostdetail_output_style" title="Figure 16-15. The hostdetail output style">Figure 16-15</a>).</p>

      <div class="figure">
        <a id="the_gridoutput_style"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30280"/><img alt="The grid output style" src="../Images/tagoreillycom20081104nostarchimages223868.png.jpg"/></div>

        <p class="title">Figure 16-13. The <code class="userinput">grid</code> output style</p>
      </div>

      <div class="figure">
        <a id="the_detail_output_style"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30291"/><img alt="The detail output style" src="../Images/tagoreillycom20081104nostarchimages223870.png.jpg"/></div>

        <p class="title">Figure 16-14. The <code class="userinput">detail</code> output style</p>
      </div>

      <div class="figure">
        <a id="the_hostdetail_output_style"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30302"/><img alt="The hostdetail output style" src="../Images/tagoreillycom20081104nostarchimages223872.png.jpg"/></div>

        <p class="title">Figure 16-15. The <code class="userinput">hostdetail</code> output style</p>
      </div>

      <p>The third and final parameter group allows you to influence, through <span class="emphasis"><em>selectors</em></span>, what states and what properties are shown by <strong class="userinput"><code>status.cgi</code></strong>, such as all services in an error state for which no acknowledgement has yet been set by an administrator (see <a class="xref" href="../Text/ch16.html#taking_responsibility_for_problems" title="16.1.2 Taking responsibility for problems">16.1.2 Taking responsibility for problems</a>, page 332). States are passed on with the <strong class="userinput"><code>hoststatustypes</code></strong> or <strong class="userinput"><code>servicestatustypes</code></strong> parameter, properties with <strong class="userinput"><code>hostprops</code></strong> and <strong class="userinput"><code>serviceprops</code></strong>. All four parameters demand numerical values after the equals sign, and these are summarized in <a class="xref" href="../Text/ch16s02.html#possible_values_for_hoststatustypes" title="Table 16-2. Possible values for Hoststatustypes">Table 16-2</a>, <a class="xref" href="../Text/ch16s02.html#possible_values_for_servicestatus_type" title="Table 16-3. Possible values for Servicestatus types">Table 16-3</a>, and <a class="xref" href="../Text/ch16s02.html#possible_values_for_host_a" title="Table 16-4. Possible values for host and serviceprops">Table 16-4</a>.</p>

      <div class="table">
        <a id="possible_values_for_hoststatustypes"/>

        <p class="title">Table 16-2. Possible values for <code class="userinput">Hoststatustypes</code></p>

        <div class="table-contents">
          <table class="sgc-3" summary="Possible values for Hoststatustypes">
            <colgroup>
              <col/>
              <col/>
            </colgroup>

            <thead>
              <tr>
                <th class="sgc-1" valign="bottom">
                  <p>Value</p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Description</p>
                </th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td class="sgc-2" valign="top">
                  <p>1</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>PENDING (a result of the very first test planned for this host is not yet available)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>2</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>UP</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>4</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>DOWN</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>8</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>UNREACHABLE</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p>The third and final parameter group allows <span class="emphasis"><em>selectors</em></span> to be used to influence what states and properties are displayed by <strong class="userinput"><code>status.cgi</code></strong>, fofr instance all services in an error state for which no administrator has yet set an acknowledgement (see <a class="xref" href="../Text/ch16.html#taking_responsibility_for_problems" title="16.1.2 Taking responsibility for problems">16.1.2 Taking responsibility for problems</a>, page 332). Conditions are passed with the parameter <strong class="userinput"><code>hoststatustypes</code></strong> or <strong class="userinput"><code>servicestatustypes</code></strong>, and properties with the <strong class="userinput"><code>hostprops</code></strong> and <strong class="userinput"><code>serviceprops</code></strong> parameters. All four parameters require numerical values after the equals sign, and these are summarized in <a class="xref" href="../Text/ch16s02.html#possible_values_for_hoststatustypes" title="Table 16-2. Possible values for Hoststatustypes">Table 16-2</a>, <a class="xref" href="../Text/ch16s02.html#possible_values_for_servicestatus_type" title="Table 16-3. Possible values for Servicestatus types">Table 16-3</a>, and <a class="xref" href="../Text/ch16s02.html#possible_values_for_host_a" title="Table 16-4. Possible values for host and serviceprops">Table 16-4</a>.</p>

      <div class="table">
        <a id="possible_values_for_servicestatus_type"/>

        <p class="title">Table 16-3. Possible values for <code class="userinput">Servicestatus types</code></p>

        <div class="table-contents">
          <table class="sgc-3" summary="Possible values for Servicestatus types">
            <colgroup>
              <col/>
              <col/>
            </colgroup>

            <thead>
              <tr>
                <th class="sgc-1" valign="bottom">
                  <p>Value</p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Description</p>
                </th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td class="sgc-2" valign="top">
                  <p>1</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>PENDING (Service was originally planned for a check, but so far no result is available)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>2</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>OK</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>4</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>WARNING</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>8</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>UNKNOWN</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>16</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>CRITICAL</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="table">
        <a id="possible_values_for_host_a"/>

        <p class="title">Table 16-4. Possible values for <code class="userinput">host</code> and <code class="userinput">serviceprops</code></p>

        <div class="table-contents">
          <table class="sgc-3" summary="Possible values for host and serviceprops">
            <colgroup>
              <col/>
              <col/>
            </colgroup>

            <thead>
              <tr>
                <th class="sgc-1" valign="bottom">
                  <p>Value</p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Description</p>
                </th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td class="sgc-2" valign="top">
                  <p>1</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Scheduled downtime (downtime planned)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>2</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>No Scheduled downtime (no downtime planned)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>4</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Acknowledgement (status confirmed by the admin)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>8</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>No acknowledgement</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>16</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Host/Service check disabled</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>32</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Host/Service check enabled</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>64</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Event Handler disabled</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>128</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Event Handler enabled</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>256</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Flap Detection disabled</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>512</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Flap Detection enabled</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>1024</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Host/Service oscillates (flapping)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>2048</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Host/Service does not oscillate</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>4096</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Hosts or services currently excluded from a notification</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>8192</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Notification enabled</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>16384</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Passive host/service checks disabled (<a class="xref" href="../Text/ch13.html" title="Chapter 13. Passive Tests with the External Command File">Chapter 13</a>, page 291)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>32768</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Passive host/service checks enabled</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>65536</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Hosts/services for which there is at least one result determined for each passive test</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>131072</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Hosts/services for which there is at least one active check result</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>262144</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Hosts/services in the hard state (from Nagios 3.0)</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p>524288</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Hosts/services in the soft state (from Nagios 3.0)</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p>If you want to query several states or properties simultaneously, you just add the specified values together: <strong class="userinput"><code>status.cgi?host=all&amp;servicestatustypes=28</code></strong> shows all services with an error status: WARNING, UNKNOWN, and CRITICAL, that is, 4+8+16 = 28. This query is identical to the <span class="strong"><strong>Service Problems</strong></span> menu item in the navigation area.</p>

      <p><strong class="userinput"><code>status.cgi?hostgroup=all&amp;hoststatustypes=12&amp;style=hostdetail</code></strong> corresponds to the <span class="strong"><strong>Host Problems</strong></span> menu item in the navigation area. It queries all hosts which are either DOWN or UNREACHABLE (here 4+8 = 12). Since only host information should be shown, but no service information, the output style is in the form of <strong class="userinput"><code>hostdetail</code></strong>.</p>

      <p><strong class="userinput"><code>status.cgi?host=all&amp;servicestatustypes=24&amp;serviceprops=10</code></strong> is the variation of the first example: only the states UNKNOWN and CRITICAL (8 + 16 = 24) are shown, and only those that neither show a planned downtime, nor have already been confirmed (2 + 8 = 10).</p>

      <p>The CGI program specifies the filter parameter each time in a separate checkbox. <a class="xref" href="../Text/ch16s02.html#this_information_box_shows_what_states" title="Figure 16-16. This information box shows what states and properties status.cgi should display">Figure 16-16</a> shows this for the third example.</p>

      <div class="figure">
        <a id="this_information_box_shows_what_states"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30658"/><img alt="This information box shows what states and properties status.cgi should display" src="../Images/tagoreillycom20081104nostarchimages223874.png.jpg"/></div>

        <p class="title">Figure 16-16. This information box shows what states and properties <code class="userinput">status.cgi</code> should display</p>
      </div>

      <p>If you want, you can define your own navigation area to your own requirements or just use the existing one. The main page consists of one frame, and the navigation area itself is defined by a normal HTML file: <strong class="userinput"><code>/usr/local/nagios/share/side.html</code></strong>.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-5" id="CHP-16-FN-5">151</a>]</sup></p>

      <p>One example of a changed <strong class="userinput"><code>side.html</code></strong> is provided on the Nagios Demo page<sup>[<a class="footnote" href="#ftn.CHP-16-FN-6" id="CHP-16-FN-6">152</a>]</sup> at Netways;<sup>[<a class="footnote" href="#ftn.CHP-16-FN-7" id="CHP-16-FN-7">153</a>]</sup> another is the Nuvola style, shown in the figure in <a class="xref" href="../Text/ch16s06.html" title="16.6 Modern Layout with the Nuvola Style">16.6 Modern Layout with the Nuvola Style</a>.</p>
    </div>

    <div class="sect2" title="16.2.2 Additional information and control center: extinfo.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="additional_information_and_control_cent"/>16.2.2 Additional information and control center: <strong class="userinput"><code>extinfo.cgi</code></strong></h2>
      </div>

      <p>If called with the <strong class="userinput"><code>host</code></strong> or <strong class="userinput"><code>service</code></strong> parameter, <strong class="userinput"><code>extinfo.cgi</code></strong> not only provides detailed information on a specific host (<a class="xref" href="../Text/ch16.html#extinfo.cgi_provides_additional_informa" title="Figure 16-4. extinfo.cgi provides additional information on the selected host">Figure 16-4</a>, page 331) or service, it also serves as a control center for hosts and services (parameter <strong class="userinput"><code>hostgroup</code></strong>) and for service groups (<strong class="userinput"><code>servicegroup</code></strong>). Depending on the object class for which it is called, you can run various commands from here.<a class="indexterm" id="IDX-CHP-16-1207"/><a class="indexterm" id="IDX-CHP-16-1208"/><a class="indexterm" id="IDX-CHP-16-1209"/><a class="indexterm" id="IDX-CHP-16-1210"/><a class="indexterm" id="IDX-CHP-16-1211"/><a class="indexterm" id="IDX-CHP-16-1212"/><a class="indexterm" id="IDX-CHP-16-1213"/><a class="indexterm" id="IDX-CHP-16-1214"/><a class="indexterm" id="IDX-CHP-16-1215"/><a class="indexterm" id="IDX-CHP-16-1216"/><a class="indexterm" id="IDX-CHP-16-1217"/><a class="indexterm" id="IDX-CHP-16-1218"/><a class="indexterm" id="IDX-CHP-16-1219"/><a class="indexterm" id="IDX-CHP-16-1206"/></p>

      <p>In the area on the left, the status of the host is extensively documented and in the box on the right—overwritten with <span class="strong"><strong>Host Commands</strong></span>—there is a selection of commands that can be run. The latter commands call <strong class="userinput"><code>cmd.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#interface_for_external_commands_colon_c" title="16.2.3 Interface for external commands: cmd.cgi">16.2.3 Interface for external commands: cmd.cgi</a>, page 343) and only function if the interface for external commands (<a class="xref" href="../Text/ch13.html#the_interface_for_external_commands" title="13.1 The Interface for External Commands">13.1 The Interface for External Commands</a>, page 292) is active. The lower area of the page allows you to enter object-specific comments, read them, and delete them again. The Web page that <strong class="userinput"><code>extinfo.cgi</code></strong> generates for services also follows this pattern.</p>

      <p>Corresponding pages for service and host groups (<a class="xref" href="../Text/ch16s02.html#command_center_for_the_sap_host_group_c" title="Figure 16-17. Command center for the SAP host group: extinfo.cgi?type=5&amp;hostgroup=SAP">Figure 16-17</a>), on the other hand, allow only group-specific commands to be run and do not show any additional information. Each command applies to the entire group, sparing you from a lot of mouse clicking. <span class="strong"><strong>Disabling notifications for all hosts in this hostgroup</strong></span>, for example, ensures that Nagios does not send any more messages for hosts in this host group.</p>

      <div class="figure">
        <a id="command_center_for_the_sap_host_group_c"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30802"/><img alt="Command center for the SAP host group: extinfo.cgi?type=5&amp;hostgroup=SAP" src="../Images/tagoreillycom20081104nostarchimages223876.png.jpg"/></div>

        <p class="title">Figure 16-17. Command center for the <code class="userinput">SAP</code> host group: <code class="userinput">extinfo.cgi?type=5&amp;hostgroup=SAP</code></p>
      </div>

      <p>Apart from hosts, services, and corresponding groups, the CGI program has other display functions, enabled by the CGI parameter <strong class="userinput"><code>type:</code></strong></p><a id="I_programlisting1_d1e30811"/>
      <pre class="programlisting">http://nagsrv/nagios/cgi-bin/extinfo.cgi?type=<span class="emphasis"><em>value</em></span></pre>

      <p>Depending on the value specified, further parameters are required, so to display the service you also have to include the host name and service designation:</p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>extinfo.cgi?type=0</code></strong></span></dt>

          <dd>
            <p>Shows information (such as starting time and process ID) for the Nagios process itself and all global parameters (normally notifications are sent, performance data processed, etc.; see <a class="xref" href="../Text/ch16s02.html#information_on_the_nagios_process_and_g" title="Figure 16-18. Information on the Nagios process and global settings: extinfo.cgi?type=0">Figure 16-18</a>). In the <span class="strong"><strong>Process Commands</strong></span> box the global parameters can be changed, and Nagios can also be stopped and restarted.</p>

            <div class="figure">
              <a id="information_on_the_nagios_process_and_g"/>

              <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30835"/><img alt="Information on the Nagios process and global settings: extinfo.cgi?type=0" src="../Images/tagoreillycom20081104nostarchimages223878.png.jpg"/></div>

              <p class="title">Figure 16-18. Information on the Nagios process and global settings: <code class="userinput">extinfo.cgi?type=0</code></p>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>extinfo.cgi?type=l&amp;host=</code></strong><strong class="userinput"><code><em class="replaceable"><code>host</code></em></code></strong></span></dt>

          <dd>
            <p>Shows commands and information on the <strong class="userinput"><code><em class="replaceable"><code>host</code></em></code></strong> (see <a class="xref" href="../Text/ch16.html#extinfo.cgi_provides_additional_informa" title="Figure 16-4. extinfo.cgi provides additional information on the selected host">Figure 16-4</a>, page 331).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>extinfo.cgi?type=2&amp;service=</code></strong><strong class="userinput"><code><em class="replaceable"><code>service</code></em></code></strong></span></dt>

          <dd>
            <p>The same for the <strong class="userinput"><code><em class="replaceable"><code>service</code></em></code></strong>.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>extinfo.cgi?type=3</code></strong></span></dt>

          <dd>
            <p>Shows all available host and service comments on a single page (<a class="xref" href="../Text/ch16s02.html#overview_of_all_existing_comments_colon" title="Figure 16-19. Overview of all existing comments: extinfo.cgi?type=3">Figure 16-19</a>).</p>

            <div class="figure">
              <a id="overview_of_all_existing_comments_colon"/>

              <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30884"/><img alt="Overview of all existing comments: extinfo.cgi?type=3" src="../Images/tagoreillycom20081104nostarchimages223880.png.jpg"/></div>

              <p class="title">Figure 16-19. Overview of all existing comments: <code class="userinput">extinfo.cgi?type=3</code></p>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>extinfo.cgi?type=4</code></strong></span></dt>

          <dd>
            <p>Provides information on the performance of Nagios, separated according to host and service, as well as active and passive checks (<a class="xref" href="../Text/ch16s02.html#information_on_the_performance_colon_ex" title="Figure 16-20. Information on the performance: extinfo.cgi?type= 4">Figure 16-20</a>).</p>

            <div class="figure">
              <a id="information_on_the_performance_colon_ex"/>

              <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30903"/><img alt="Information on the performance: extinfo.cgi?type= 4" src="../Images/tagoreillycom20081104nostarchimages223882.png.jpg"/></div>

              <p class="title">Figure 16-20. Information on the performance: <code class="userinput">extinfo.cgi?type= 4</code></p>
            </div>

            <p>The middle column reveals how many of the planned tests Nagios has already performed in the last 1, 5, 15, and 60 minutes. As long as there are checks for which <strong class="userinput"><code>normal_check_irLterval</code></strong> is more than five minutes, the first two values can never reach 100 percent.</p>

            <p>The right-hand columns define the actual value for this page: <span class="strong"><strong>Check Execution Time</strong></span> specifies the minimum, maximum, and average time which Nagios requires to perform active host and service checks. <span class="strong"><strong>Check Latency</strong></span> measures the distance between the planned start and the actual running time of a test. If this delay is considerably larger than one or two seconds, Nagios probably has a performance problem. One possible cause is that the system is processing performance data too slowly, but low-performance hardware may also play a role here. Searching for the cause can sometimes turn out to be very difficult, and the original documentation<sup>[<a class="footnote" href="#ftn.CHP-16-FN-8" id="CHP-16-FN-8">154</a>]</sup> provides a number of tips on the subject.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>extinfo.cgi?type=5&amp;hostgroup=</code></strong><strong class="userinput"><code><em class="replaceable"><code>hostgroup</code></em></code></strong></span></dt>

          <dd>
            <p>Shows command center for a host group (<a class="xref" href="../Text/ch16s02.html#command_center_for_the_sap_host_group_c" title="Figure 16-17. Command center for the SAP host group: extinfo.cgi?type=5&amp;hostgroup=SAP">Figure 16-17</a> in page 339).</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>extinfo.cgi?type=6</code></strong></span></dt>

          <dd>
            <p>Shows all planned maintenance periods for hosts and services (<a class="xref" href="../Text/ch16s02.html#overview_of_all_planned_maintenance_per" title="Figure 16-21. Overview of all planned maintenance periods: extinfo.cgi?type=6">Figure 16-21</a>).</p>

            <div class="figure">
              <a id="overview_of_all_planned_maintenance_per"/>

              <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30952"/><img alt="Overview of all planned maintenance periods: extinfo.cgi?type=6" src="../Images/tagoreillycom20081104nostarchimages223884.png.jpg"/></div>

              <p class="title">Figure 16-21. Overview of all planned maintenance periods: <code class="userinput">extinfo.cgi?type=6</code></p>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>extinfo.cgi?type=7</code></strong></span></dt>

          <dd>
            <p>Shows an overview of all planned tests, sorted by the next implementation time (see <a class="xref" href="../Text/ch16s02.html#all_planned_tests_comma_sorted_by_their" title="Figure 16-22. All planned tests, sorted by their planned implementation time: extinfo.cgi?type=7">Figure 16-22</a>). Next to this, <strong class="userinput"><code>extinfo.cgi</code></strong> also lists the time of the last check.</p>

            <p>The <span class="strong"><strong>Active Checks</strong></span> column shows if the respective tests are active or not, and in the <strong class="userinput"><code>Actions</code></strong> column the planned check can be deleted or moved to a different time.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>extinfo.cgi?type=8&amp;servicegroup</code></strong><strong class="userinput"><code><em class="replaceable"><code>servicegroup</code></em></code></strong></span></dt>

          <dd>
            <p>Shows the command centre for a service group, identical in structure to the command center of a host group.</p>

            <div class="figure">
              <a id="all_planned_tests_comma_sorted_by_their"/>

              <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e30992"/><img alt="All planned tests, sorted by their planned implementation time: extinfo.cgi?type=7" src="../Images/tagoreillycom20081104nostarchimages223886.png.jpg"/></div>

              <p class="title">Figure 16-22. All planned tests, sorted by their planned implementation time: <code class="userinput">extinfo.cgi?type=7</code></p>
            </div>
          </dd>
        </dl>
      </div>
    </div>

    <div class="sect2" title="16.2.3 Interface for external commands: cmd.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="interface_for_external_commands_colon_c"/>16.2.3 Interface for external commands: <strong class="userinput"><code>cmd.cgi</code></strong></h2>
      </div>

      <p>As a real all-rounder, <strong class="userinput"><code>cgi.cmd</code></strong>, with some 100 functions, covers nearly all the possibilities that the interface provides for external commands. The <strong class="userinput"><code>cmd_typ</code></strong> parameter defines which of these the CGI program should run. The command<a class="indexterm" id="IDX-CHP-16-1222"/><a class="indexterm" id="IDX-CHP-16-1223"/><a class="indexterm" id="IDX-CHP-16-1224"/><a class="indexterm" id="IDX-CHP-16-1225"/><a class="indexterm" id="IDX-CHP-16-1220"/><a class="indexterm" id="IDX-CHP-16-1221"/></p><a id="I_programlisting1_d1e31036"/>
      <pre class="programlisting">http:<span class="emphasis"><em>//nagiosserver</em></span>/nagios/cgi-bin/cmd.cgi?cmd_typ=6</pre>

      <p>switches off active service checks for a specific service (<a class="xref" href="../Text/ch16s02.html#disabling_a_service_check_with_cmd.c" title="Figure 16-23. Disabling a service check with cmd.cgi?cmd_typ=6">Figure 16-23</a>). In order to describe the desired service uniquely, you must specify the host and service description. If you run the CGI program manually, the Web form shown queries these values, and if <strong class="userinput"><code>cmd.cgi</code></strong> is started by another CGI program, the required data is passed through CGI parameters. Possible parameters here are <strong class="userinput"><code>host</code></strong>, <strong class="userinput"><code>service</code></strong>, <strong class="userinput"><code>hostgroup</code></strong>, and <strong class="userinput"><code>servicegroup</code></strong>, which are followed by an equals (=) sign and then the appropriate Nagios object.</p>

      <div class="figure">
        <a id="disabling_a_service_check_with_cmd.c"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31066"/><img alt="Disabling a service check with cmd.cgi?cmd_typ=6" src="../Images/tagoreillycom20081104nostarchimages223888.png.jpg"/></div>

        <p class="title">Figure 16-23. Disabling a service check with <code class="userinput">cmd.cgi?cmd_typ=6</code></p>
      </div>

      <p><a class="xref" href="../Text/ch16s02.html#the_most_important_host_and_service_rel" title="Figure 16-24. The most important host and service related codes for cmd.cgi?cmd_typ=">Figure 16-24</a> lists the most important commands which refer to a host or service, and <a class="xref" href="../Text/ch16s02.html#cmd.cgi_command_codes_fo" title="Figure 16-25. cmd.cgi command codes for global parameters">Figure 16-25</a> shows those that refer to the control of global parameters (corresponding to the values in the main configuration file <strong class="userinput"><code>nagios.cfg</code></strong>). The source code file <strong class="userinput"><code>include/common.h</code></strong> contains a complete list of all possible values, including ones that are planned but not yet implemented.</p>

      <p>The first column in <a class="xref" href="../Text/ch16s02.html#the_most_important_host_and_service_rel" title="Figure 16-24. The most important host and service related codes for cmd.cgi?cmd_typ=">Figure 16-24</a> and <a class="xref" href="../Text/ch16s02.html#cmd.cgi_command_codes_fo" title="Figure 16-25. cmd.cgi command codes for global parameters">Figure 16-25</a> describes the function of the command: <strong class="userinput"><code>ADD_HOST_COMMENT</code></strong> adds a comment to a host, and <strong class="userinput"><code>DISABLE_ ACTIVE_SVC_CHECK</code></strong> switches off active checks for a service (in abbreviated form: <strong class="userinput"><code>SVC</code></strong>).</p>

      <p>The columns after this specify the object type to which the respective function refers. To add a comment with <strong class="userinput"><code>ADD_HOST_COMMENT</code></strong>, you must specify the host in question. For this reason the function code <strong class="userinput"><code>1</code></strong> is shown in the Host column. A specific active service check can only be switched off if the matching service is named, so the function code <strong class="userinput"><code>6</code></strong> is to be found in the <span class="strong"><strong>Service</strong></span> column. With <strong class="userinput"><code>16</code></strong> you switch off all active service checks on a host to be specified; there are also corresponding codes for all active service checks for a host or service group.</p>

      <p>With <strong class="userinput"><code>ACKNOWLEDGE_PROBLEM</code></strong>, an administrator confirms that he is taking care of a specific problem. <strong class="userinput"><code>33</code></strong> (Host column) refers to a host problem, and <strong class="userinput"><code>34</code></strong> (<span class="strong"><strong>Service</strong></span> column) to a service problem. The gray fields mean that there is no corresponding function for host and service groups. The Web form that opens with <strong class="userinput"><code>cmd_typ=33</code></strong> (<a class="xref" href="../Text/ch16.html#entry_dialog_for_a_host_acknowlegement" title="Figure 16-9. Entry dialog for a host acknowlegement">Figure 16-9</a>, page 333) then allows a comment to be entered.</p>

      <div class="figure">
        <a id="the_most_important_host_and_service_rel"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31139"/><img alt="The most important host and service related codes for cmd.cgi?cmd_typ=" src="../Images/tagoreillycom20081104nostarchimages223890.png"/></div>

        <p class="title">Figure 16-24. The most important host and service related codes for <code class="userinput">cmd.cgi?cmd_typ=</code></p>
      </div>

      <p>Functions that refer to global parameters (<a class="xref" href="../Text/ch16s02.html#cmd.cgi_command_codes_fo" title="Figure 16-25. cmd.cgi command codes for global parameters">Figure 16-25</a>) can normally only be switched on or off. So the value <strong class="userinput"><code>11</code></strong> in the <span class="strong"><strong>Start</strong></span> column for <strong class="userinput"><code>NOTIFICATIONS</code></strong> means that this command code switches on all notifications globally, while <strong class="userinput"><code>12</code></strong> switches them off globally.</p>

      <p>If you are not quite certain whether the determined function does what you really wanted, it is best to run <strong class="userinput"><code>cmd.cgi</code></strong> manually with the corresponding function code, such as shown here:</p><a id="I_programlisting1_d1e31166"/>
      <pre class="programlisting">http://<span class="emphasis"><em>nagiosserver</em></span>/nagios/cgi-bin/cmd.cgi?cmd_typ=12</pre>

      <p>The Web page generated in this way always has a small gray box available next to the required entry fields that explains the corresponding command (<a class="xref" href="../Text/ch16s02.html#disabling_a_service_check_with_cmd.c" title="Figure 16-23. Disabling a service check with cmd.cgi?cmd_typ=6">Figure 16-23</a>, on the right side of the page).</p>

      <div class="figure">
        <a id="cmd.cgi_command_codes_fo"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31180"/><img alt="cmd.cgi command codes for global parameters" src="../Images/tagoreillycom20081104nostarchimages223892.png"/></div>

        <p class="title">Figure 16-25. <code class="userinput">cmd.cgi</code> command codes for global parameters</p>
      </div>
    </div>

    <div class="sect2" title="16.2.4 The most important things at a glance: tac.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_6"><a id="the_most_important_things_at_a_glance_c"/>16.2.4 The most important things at a glance: <strong class="userinput"><code>tac.cgi</code></strong></h2>
      </div>

      <p>As a "tactical overview," <strong class="userinput"><code>tac.cgi</code></strong> provides a wealth of information on a single Web page, displayed in a summary (<a class="xref" href="../Text/ch16s02.html#tactical_overview_with_tac.cgi" title="Figure 16-26. Tactical overview with tac.cgi">Figure 16-26</a>). On the left-hand side of the page you can see, in order of priority, first the failure of entire network ranges (<span class="strong"><strong>Network Outages</strong></span>), followed by the status of hosts and services, and at the bottom <strong class="userinput"><code>tac.cgi</code></strong> lists whether individual monitoring features such as notifications and event handlers are active.<a class="indexterm" id="IDX-CHP-16-1227"/><a class="indexterm" id="IDX-CHP-16-1228"/><a class="indexterm" id="IDX-CHP-16-1226"/></p>

      <p>Up to this final section, everything is concentrated on displaying problems. Provided everything is OK, the CGI merely shows the number of unproblematic services or hosts, highlighted in light gray (and announces <strong class="userinput"><code>47 Up</code></strong>, for example, in the <strong class="userinput"><code>Hosts</code></strong> box). In problem cases it distinguishes between open problems, which nobody has looked at yet (highlighted in red, e.g., <strong class="userinput"><code>2 Unhandled Problems</code></strong> for <strong class="userinput"><code>Services | Critical</code></strong>), and those for which an adminstrator has already taken responsibility through an acknowledgement (pink background, like <strong class="userinput"><code>1 Acknowledged</code></strong> for <span class="strong"><strong>Services | Unknown</strong></span>). If host or service checks are disabled, these are also shown with a pink background, since they are problems that do not require the immediate attention of the admin (e.g., <strong class="userinput"><code>2 Disabled</code></strong> for <span class="strong"><strong>Services | Ok</strong></span>).</p>

      <p>Enabled features in the lower parts are marked by <strong class="userinput"><code>tac.cgi</code></strong> in green, and disabled ones, in red. The vertically written green <span class="strong"><strong>Enabled</strong></span> in <span class="strong"><strong>Notifications</strong></span> means that notifications are enabled globally, whereas the red background on the other hand, <strong class="userinput"><code>2 Services Disabled</code></strong>, means that they were explicitly switched off for two individual services.</p>

      <p>For all the problems displayed you are taken to a single overview specifically showing the hosts and services in question.</p>

      <div class="figure">
        <a id="tactical_overview_with_tac.cgi"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31265"/><img alt="Tactical overview with tac.cgi" src="../Images/tagoreillycom20081104nostarchimages223894.png.jpg"/></div>

        <p class="title">Figure 16-26. Tactical overview with <code class="userinput">tac.cgi</code></p>
      </div>

      <p>On the right-hand side of the page the upper box summarizes the <strong class="userinput"><code>extinfo.cgi?type=4</code></strong> (see <a class="xref" href="../Text/ch16s02.html#additional_information_and_control_cent" title="16.2.2 Additional information and control center: extinfo.cgi">16.2.2 Additional information and control center: extinfo.cgi</a>) Nagios performance data, which can be shown in detail. The bar graph beneath it shows the health of the entire network monitored as a percentage. If you move the mouse over one of the bars, you will also see the percentage as a number.</p>
    </div>

    <div class="sect2" title="16.2.5 The topological map of the network: statusmap.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_7"><a id="the_topological_map_of_the_network_colo"/>16.2.5 The topological map of the network: <strong class="userinput"><code>statusmap.cgi</code></strong></h2>
      </div>

      <p><strong class="userinput"><code>statusmap.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#dependencies_of_monitored_hosts_shown_g" title="Figure 16-27. Dependencies of monitored hosts shown graphically">Figure 16-27</a>) provides a view of the dependencies between the monitored hosts. Starting from the central Nagios server in the middle, lines connect all hosts that the server reaches directly—and whose host definitions do not need the <strong class="userinput"><code>parents</code></strong> parameter to be specified (see <a class="xref" href="../Text/ch02s03.html" title="2.3 Defining the Machines to Be Monitored, with host">2.3 Defining the Machines to Be Monitored, with host</a>, page 62.).<a class="indexterm" id="IDX-CHP-16-1230"/><a class="indexterm" id="IDX-CHP-16-1231"/><a class="indexterm" id="IDX-CHP-16-1232"/><a class="indexterm" id="IDX-CHP-16-1233"/><a class="indexterm" id="IDX-CHP-16-1234"/><a class="indexterm" id="IDX-CHP-16-1229"/></p>

      <p>The graphics also reveal the hosts to which Nagios has only indirect access through other hosts. So between <strong class="userinput"><code>sis-mail</code></strong> and the Nagios server in <a class="xref" href="../Text/ch16s02.html#dependencies_of_monitored_hosts_shown_g" title="Figure 16-27. Dependencies of monitored hosts shown graphically">Figure 16-27</a> lie the hosts <strong class="userinput"><code>sis-proxy</code></strong>, <strong class="userinput"><code>hspvip</code></strong>, and <strong class="userinput"><code>pfint. sis-proxy</code></strong>, as the comment <span class="strong"><strong>Down</strong></span> and the red (instead of green) background suggest, has failed. Since <strong class="userinput"><code>sis-mail</code></strong> depends on this, it is in an UNREACHABLE state, which <strong class="userinput"><code>statusmap.cgi</code></strong> also marks with a red background.</p>

      <div class="figure">
        <a id="dependencies_of_monitored_hosts_shown_g"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31345"/><img alt="Dependencies of monitored hosts shown graphically" src="../Images/tagoreillycom20081104nostarchimages223896.png.jpg"/></div>

        <p class="title">Figure 16-27. Dependencies of monitored hosts shown graphically</p>
      </div>

      <p>How Nagios arranges the hosts in the graphics is defined by the parameter <strong class="userinput"><code>default_statusmap_layout</code></strong> (<a class="xref" href="../Text/apas02.html#authentication_parameters" title="A.2.1 Authentication parameters">A.2.1 Authentication parameters</a>) in the configuration file <strong class="userinput"><code>cgi.cfg</code></strong>. The layout can also be changed with a selection window in the Web interface (at the top right in <a class="xref" href="../Text/ch16s02.html#statusmap_with_self-defined_coordinates" title="Figure 16-28. Statusmap with self-defined coordinates and icons">Figure 16-28</a>). The figure shows the demo system of Netways,<sup>[<a class="footnote" href="#ftn.CHP-16-FN-9" id="CHP-16-FN-9">155</a>]</sup> whose appearance depends on user-specific coordinates, which in this case you have to specify individually for each host (see <a class="xref" href="../Text/ch16s04.html#extended_host_information" title="16.4.1 Extended host information">16.4.1 Extended host information</a>). The question mark icon supplied by Nagios has been replaced with nicer pictures by the operator of the site. Coordinates and icons are defined with the <strong class="userinput"><code>hostextinfo</code></strong> object, described in more detail in <a class="xref" href="../Text/ch16s04.html#extended_host_information" title="16.4.1 Extended host information">16.4.1 Extended host information</a>).</p>

      <div class="figure">
        <a id="statusmap_with_self-defined_coordinates"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31377"/><img alt="Statusmap with self-defined coordinates and icons" src="../Images/tagoreillycom20081104nostarchimages223898.png.jpg"/></div>

        <p class="title">Figure 16-28. Statusmap with self-defined coordinates and icons</p>
      </div>

      <p>If you move the mouse onto a particular host, Nagios opens a yellow window at the top left with status information, which includes the IP address, current status information, and the time of the last check. At the bottom of this box, <strong class="userinput"><code>statusmap.cgi</code></strong> summarizes the states of the services running on this host.</p>

      <p>If you double-click on a particular host, Nagios branches off to the usual status overview, which apart from data on the host selected, also displays all the services belonging to this host (<a class="xref" href="../Text/ch16s02.html#the_detail_output_style" title="Figure 16-14. The detail output style">Figure 16-14</a> in page 336 gives an example).</p>
    </div>

    <div class="sect2" title="16.2.6 Navigation in 3D: statuswrl.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_8"><a id="navigation_in_3d_colon_statuswrl.cgi"/>16.2.6 Navigation in 3D: <strong class="userinput"><code>statuswrl.cgi</code></strong></h2>
      </div>

      <p><strong class="userinput"><code>statuswrl.cgi</code></strong> allows Nagios to move through a 3D representation of the network plan (<a class="xref" href="../Text/ch16s02.html#this_picture_marks_the_beginning_of_the" title="Figure 16-29. This picture marks the beginning of the tour through your own network">Figure 16-29</a>). In this you can zoom on to hosts, move the overall view, rotate it, etc.<a class="indexterm" id="IDX-CHP-16-1235"/></p>

      <p>A VRML-capable browser is necessary for the display.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-10" id="CHP-16-FN-10">156</a>]</sup> Although the original documentation<sup>[<a class="footnote" href="#ftn.CHP-16-FN-11" id="CHP-16-FN-11">157</a>]</sup> provides links to the corresponding plugins, two of them are out of date, and only <span class="emphasis"><em>Cortona</em></span><sup>[<a class="footnote" href="#ftn.CHP-16-FN-12" id="CHP-16-FN-12">158</a>]</sup> could be reached at the time of going to press. This plugin does not work under Linux, however; in Windows it works with Internet Explorer, and also with Netscape, Mozilla, and Firefox.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-13" id="CHP-16-FN-13">159</a>]</sup> A good overview of VRML software, organized according to operating system and browser, is provided by the National Institute of Standards and Technology (NIST) on its Web site.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-14" id="CHP-16-FN-14">160</a>]</sup><a class="indexterm" id="IDX-CHP-16-1237"/><a class="indexterm" id="IDX-CHP-16-1236"/></p>

      <p>Of the VRML plugins for Linux, <span class="emphasis"><em>OpenVRML</em></span>,<sup>[<a class="footnote" href="#ftn.CHP-16-FN-15" id="CHP-16-FN-15">161</a>]</sup> and <span class="emphasis"><em>free WRL</em></span><sup>[<a class="footnote" href="#ftn.CHP-16-FN-16" id="CHP-16-FN-16">162</a>]</sup> are the most likely to be used. The standard Linux distributions usually do not include a finished package. OpenVRML is included in Fedora in Extras; on the homepage of freeWRL there are binary packages for Fedora and Ubuntu. You should not try compiling the software yourself unless you are an experienced system administrator or software developer: there are a large number of pitfalls. If you have never worked with the Java compiler before and have not compiled complex software packages such as Mozilla or Firefox yourself, then you should leave it alone.<a class="indexterm" id="IDX-CHP-16-1238"/><a class="indexterm" id="IDX-CHP-16-1239"/></p>

      <div class="figure">
        <a id="this_picture_marks_the_beginning_of_the"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31472"/><img alt="This picture marks the beginning of the tour through your own network" src="../Images/tagoreillycom20081104nostarchimages223900.png.jpg"/></div>

        <p class="title">Figure 16-29. This picture marks the beginning of the tour through your own network</p>
      </div>

      <p>But all of this is no reason to despair, since the use of 3D navigation is questionable anyway, especially as the 2D view of the normal status map displays all the information required, and displaying simple flat graphics in the browser takes up considerably less time than CPU-intensive 3D rendering. Before you rush into the adventure of compiling software yourself, we recommend that you decide for yourself, using the Cortona plugin, whether it is worth the effort of compiling a project like OpenVRML.</p>
    </div>

    <div class="sect2" title="16.2.7 Querying the status with a cell phone: statuswml.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_9"><a id="querying_the_status_with_a_cell_phone_c"/>16.2.7 Querying the status with a cell phone: <strong class="userinput"><code>statuswml.cgi</code></strong></h2>
      </div>

      <p>In order to make the information provided by Nagios accessible for WAP<sup>[<a class="footnote" href="#ftn.CHP-16-FN-17" id="CHP-16-FN-17">163</a>]</sup>-capable devices without a fully functional browser, <strong class="userinput"><code>statuswml.cgi</code></strong> generates a Web page in the WML format,<sup>[<a class="footnote" href="#ftn.CHP-16-FN-18" id="CHP-16-FN-18">164</a>]</sup> which can be displayed with a cellphone—provided that the Nagios server is reachable in the Internet. Apart from the status query for hosts and services, it also allows the CGI program to switch off tests and notifications and to confirm existing problems with acknowledgements.<a class="indexterm" id="IDX-CHP-16-1241"/><a class="indexterm" id="IDX-CHP-16-1242"/><a class="indexterm" id="IDX-CHP-16-1243"/><a class="indexterm" id="IDX-CHP-16-1244"/><a class="indexterm" id="IDX-CHP-16-1240"/></p>

      <p>You should think carefully before you make Nagios accessible over the Internet: Nagios makes available much sensitive data that can be misused by hackers. In case of doubt, you're better off doing without it. Without direct Internet access, <strong class="userinput"><code>statuswml.cgi</code></strong> is useless, since a cellphone cannot use protected access methods such as a VPN tunnel. This is why we shall not introduce <strong class="userinput"><code>statuswml.cgi</code></strong> in great detail at this point.</p>
    </div>

    <div class="sect2" title="16.2.8 Analyzing disrupted partial networks: outages.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_10"><a id="analyzing_disrupted_partial_networks_Co"/>16.2.8 Analyzing disrupted partial networks: <strong class="userinput"><code>outages.cgi</code></strong></h2>
      </div>

      <p>The CGI program <strong class="userinput"><code>outages.cgi</code></strong> only shows those network nodes in a host overview that are responsible for the failure of a partial network: In contrast to a status overview, as in <a class="xref" href="../Text/ch16s02.html#the_hostdetail_output_style" title="Figure 16-15. The hostdetail output style">Figure 16-15</a>, page 336, <strong class="userinput"><code>outages.cgi</code></strong> specifies in the <span class="strong"><strong># Hosts Affected</strong></span> column how many services and hosts this affects in each case (<a class="xref" href="../Text/ch16s02.html#as_long_as_sis-proxy_fails_comma_nagios" title="Figure 16-30. As long as sis-proxy fails, Nagios cannot reach any hosts lying behind it">Figure 16-30</a>).<a class="indexterm" id="IDX-CHP-16-1245"/></p>

      <div class="figure">
        <a id="as_long_as_sis-proxy_fails_comma_nagios"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31564"/><img alt="As long as sis-proxy fails, Nagios cannot reach any hosts lying behind it" src="../Images/tagoreillycom20081104nostarchimages223902.png.jpg"/></div>

        <p class="title">Figure 16-30. As long as <code class="userinput">sis-proxy</code> fails, Nagios cannot reach any hosts lying behind it</p>
      </div>

      <p>With the icons in the <span class="strong"><strong>Actions</strong></span> column you call other CGI programs that selectively filter out information on the host shown here. From left to right, they show the status display in the detail view (traffic light), the topological network view (network tree), the 3D view (<span class="strong"><strong>3-D</strong></span>), the trend display (graph), the log file entries for the host (spreadsheet), and the display of notifications which have been made (megaphone).</p>
    </div>

    <div class="sect2" title="16.2.9 Querying the object definition with config.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_11"><a id="querying_the_object_definition_with_con"/>16.2.9 Querying the object definition with <strong class="userinput"><code>config.cgi</code></strong></h2>
      </div>

      <p><strong class="userinput"><code>config.cgi</code></strong> shows a tabular overview of the definition of all objects for a type that can be specified (<a class="xref" href="../Text/ch16s02.html#config.cgi_displays_the" title="Figure 16-31. config.cgi displays the current configuration of the selected object class—here hosts—(extract)">Figure 16-31</a>)—the type of object involved can be defined in the selection field in the top right corner. Where the consideration itself contains Nagios objects (in the host view <span class="strong"><strong>Host Check Command, Default Contact Group</strong></span>, and—not visible in the picture—<span class="strong"><strong>Notification Period</strong></span>), a link takes you directly to the configuration view of this object type.<a class="indexterm" id="IDX-CHP-16-1247"/><a class="indexterm" id="IDX-CHP-16-1248"/><a class="indexterm" id="IDX-CHP-16-1249"/><a class="indexterm" id="IDX-CHP-16-1250"/><a class="indexterm" id="IDX-CHP-16-1246"/></p>

      <div class="figure">
        <a id="config.cgi_displays_the"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31619"/><img alt="config.cgi displays the current configuration of the selected object class—here hosts—(extract)" src="../Images/tagoreillycom20081104nostarchimages223904.png.jpg"/></div>

        <p class="title">Figure 16-31. <code class="userinput">config.cgi</code> displays the current configuration of the selected object class—here hosts—(extract)</p>
      </div>

      <p>The CGI program does not provide any way of changing anything in the settings. In addition, only users who are entered in the parameter <strong class="userinput"><code>authorized _for_configuration_information</code></strong> (configuration file <strong class="userinput"><code>cgi.cfg</code></strong>, p. 607) have access to this view.<a class="indexterm" id="IDX-CHP-16-1251"/></p>
    </div>

    <div class="sect2" title="16.2.10 Availability statistics: avail.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_12"><a id="availability_statistics_colon_avail.cgi"/>16.2.10 Availability statistics: <strong class="userinput"><code>avail.cgi</code></strong></h2>
      </div>

      <p>If you are monitoring systems, then you also take an interest in their availability. <strong class="userinput"><code>avail.cgi</code></strong> first asks if you are interested in <span class="strong"><strong>Hosts, Services, Host-groups</strong></span>, and <span class="strong"><strong>Servicegroups</strong></span>. After you have selected a time period, you will see an overview, as in <a class="xref" href="../Text/ch16s02.html#an_availability_report_using_the_exampl" title="Figure 16-32. An availability report using the example of the SAP-Services service group">Figure 16-32</a>. For <span class="strong"><strong>Services</strong></span> and <span class="strong"><strong>Hosts</strong></span> you can also have the availability data presented through <span class="strong"><strong>All Hosts</strong></span> or <span class="strong"><strong>All Services</strong></span> as a CSV file.<a class="indexterm" id="IDX-CHP-16-1252"/></p>

      <p><strong class="userinput"><code>avail.cgi</code></strong> shows the hosts involved separately from the services. How long a service or host remained in a particular state can be seen from the corresponding colored column—green for OK, yellow for WARNING, red for CRITICAL (service), DOWN and UNREACHABLE (host)—in percent. The column that shows how much time the status of a service was UNKNOWN is shown in orange. Incomplete log files are shown in the<span class="strong"><strong>Undetermined</strong></span> column. If there is a value larger than zero, then there are periods for which Nagios cannot make a statement concerning the state.</p>

      <p>Below each table, the <span class="strong"><strong>Average</strong></span> line specifies the average of the individual values. In <a class="xref" href="../Text/ch16s02.html#an_availability_report_using_the_exampl" title="Figure 16-32. An availability report using the example of the SAP-Services service group">Figure 16-32</a> the hosts involved were available 99.965 percent of the time.</p>

      <p><strong class="userinput"><code>avail.cgi</code></strong> shows the availability twice in each case: first as an absolute value for the evaluation period, and then (in brackets) with respect to the time during which data actually was available. As long as the <span class="strong"><strong>Time Undetermined</strong></span> column displays <strong class="userinput"><code>0.000%</code></strong>, the two availability values match.</p>

      <div class="figure">
        <a id="an_availability_report_using_the_exampl"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31700"/><img alt="An availability report using the example of the SAP-Services service group" src="../Images/tagoreillycom20081104nostarchimages223906.png.jpg"/></div>

        <p class="title">Figure 16-32. An availability report using the example of the <code class="userinput">SAP-Services</code> service group</p>
      </div>

      <p>If you click on one of the hosts or services displayed, a detailed view will appear. <a class="xref" href="../Text/ch16s02.html#the_availability_of_the_host" title="Figure 16-33. The availability of the host sap-12 explained in detail">Figure 16-33</a> shows such a view for the host <strong class="userinput"><code>sap-12</code></strong>.</p>

      <div class="figure">
        <a id="the_availability_of_the_host"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31718"/><img alt="The availability of the host sap-12 explained in detail" src="../Images/tagoreillycom20081104nostarchimages223908.png.jpg"/></div>

        <p class="title">Figure 16-33. The availability of the host <code class="userinput">sap-12</code> explained in detail</p>
      </div>

      <p>On a bar diagram that shows the states over the selected period in color, there is detailed information on the host itself, followed by statistics on the availability of the service that is monitored on this host. This includes an extract from the log file, which only shows the relevant entries for the availability of the host; that is, <strong class="userinput"><code>HOST UP</code></strong>, <strong class="userinput"><code>HOST DOWN</code></strong>, or <strong class="userinput"><code>HOST UNREACHABLE</code></strong>. The log file entries are cut off by <strong class="userinput"><code>avail.cgi</code></strong> to save space.</p>
    </div>

    <div class="sect2" title="16.2.11 What events occur, how often?—histogram.Cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_13"><a id="what_events_occur_comma_how_often_quest"/>16.2.11 What events occur, how often?—<strong class="userinput"><code>histogram.Cgi</code></strong></h2>
      </div>

      <p>If the state of a host or service changes, this is called an <span class="emphasis"><em>event</em></span>. The CGI program <strong class="userinput"><code>histogram.cgi</code></strong> shows the frequency of this in different views. If you select <span class="strong"><strong>Day of the Month</strong></span> as the <span class="strong"><strong>Breakdown type</strong></span>, it illustrates what event took place on which day of the month, and how often (<a class="xref" href="../Text/ch16s02.html#how_many_events_of_what_type_were_there" title="Figure 16-34. How many events of what type were there on which day?">Figure 16-34</a>). The red graph in services stands for CRITICAL, the orange one for UNKNOWN, yellow for WARNING, and green for OK. The curve for hosts in the DOWN state is marked by <strong class="userinput"><code>histogram.cgi</code></strong> in red, that for UNREACHABLE hosts in wine-red, and the green line stands, as usual, for OK.<a class="indexterm" id="IDX-CHP-16-1253"/><a class="indexterm" id="IDX-CHP-16-1254"/></p>

      <div class="figure">
        <a id="how_many_events_of_what_type_were_there"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31775"/><img alt="How many events of what type were there on which day?" src="../Images/tagoreillycom20081104nostarchimages223910.png.jpg"/></div>

        <p class="title">Figure 16-34. How many events of what type were there <span class="strong">on which day?</span></p>
      </div>

      <p>If you choose the variation <span class="strong"><strong>Day of Week</strong></span>, the Web page shows on which day of the week most events occur, so you can find out whether Monday really is always the worst day. In addition to this you can have the frequency presented by day (<span class="strong"><strong>Hour of Day</strong></span>) or by the month of a year (<span class="strong"><strong>Month</strong></span>). With <span class="strong"><strong>Report Period</strong></span> you can adjust the report period. With <span class="strong"><strong>Assume state retention</strong></span> you can adjust whether the previously existing states are retained and included in the evaluation (<strong class="userinput"><code>yes</code></strong>) or not (<strong class="userinput"><code>no</code></strong>).</p>

      <p>If you have configured Nagios so that it explicitly logs the states of the monitored hosts and services for a restart or when the log file is changed,<sup>[<a class="footnote" href="#ftn.CHP-16-FN-19" id="CHP-16-FN-19">165</a>]</sup> and if you set <strong class="userinput"><code>Initial states logged</code></strong> to <strong class="userinput"><code>yes</code></strong>, the script includes this explicitly in the evaluation. A <strong class="userinput"><code>no</code></strong> ignores the entry; <strong class="userinput"><code>histogram.cgi</code></strong> then assumes that the state after a system start is identical to that which existed directly before the restart.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-20" id="CHP-16-FN-20">166</a>]</sup><a class="indexterm" id="IDX-CHP-16-1255"/><a class="indexterm" id="IDX-CHP-16-1256"/></p>

      <p><span class="strong"><strong>Ignore repeated states</strong></span> makes allowances if a state persists for a long time and therefore delivers the same result again and again. If you set yes here, the script evaluates it once instead of many times.</p>

      <p>If you select the item <span class="strong"><strong>Hard and soft states</strong></span> in <span class="strong"><strong>State types to graph:</strong></span>, <strong class="userinput"><code>histogram.cgi</code></strong> also counts soft states. If a service changes from OK to CRITICAL, for example, while <strong class="userinput"><code>retry_check_interval</code></strong> is set to <span class="strong"><strong>4</strong></span>,<sup>[<a class="footnote" href="#ftn.CHP-16-FN-21" id="CHP-16-FN-21">167</a>]</sup> then <strong class="userinput"><code>histogram.cgi</code></strong> counts a total of four results, three soft and one hard. If you only evaluate hard states, the statistics evaluate the value 1. If an error is rectified, there are no soft states; therefore the value for CRITICAL is usually larger that that for RECOVERY if you include soft states in the evaluation.</p>
    </div>

    <div class="sect2" title="16.2.12 Filtering log entries after specific states: history.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_14"><a id="filtering_log_entries_after_specific_st"/>16.2.12 Filtering log entries after specific states: <strong class="userinput"><code>history.cgi</code></strong></h2>
      </div>

      <p>The <strong class="userinput"><code>history.cgi</code></strong> script allows the states of a type (soft or hard) to be extracted selectively from the log file using the selection field <span class="strong"><strong>State type options</strong></span> (at the top right in <a class="xref" href="../Text/ch16s02.html#history.cgi_filters_the" title="Figure 16-35. history.cgi filters the information from the log file">Figure 16-35</a>), and specific events to be extracted (all, all related to hosts, all service events, only host-recovery, only host-down, etc.) using <span class="strong"><strong>History detail level for all hosts</strong></span>. The entries to be shown can be restricted through parameters to individual hosts, services, or host or service groups when the CGI program is called. So the command<a class="indexterm" id="IDX-CHP-16-1258"/><a class="indexterm" id="IDX-CHP-16-1259"/><a class="indexterm" id="IDX-CHP-16-1257"/></p><a id="I_programlisting1_d1e31907"/>
      <pre class="programlisting">histogram.cgi?host=sap-12</pre>

      <p>only displays log file entries for the host <strong class="userinput"><code>sap-12</code></strong>. If the output should be restricted to a specific host, then the service description needs to be specified as well:</p><a id="I_programlisting1_d1e31914"/>
      <pre class="programlisting">histogram.cgi?host=sap-12&amp;service=PING</pre>

      <p>Selecting a host and service group is done in the same way:</p><a id="I_programlisting1_d1e31918"/>
      <pre class="programlisting">histogram.cgi?hostgroup=SAP
histogram.cgi?servicegroup=SAP-Services</pre>

      <p>The period that <strong class="userinput"><code>history.cgi</code></strong> views depends on the archiving interval of the log file. The script always refers to the contents of an archive file. If you set the parameter <strong class="userinput"><code>log_rotation_method</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>) in the configuration file <strong class="userinput"><code>nagios.cfg</code></strong> to <strong class="userinput"><code>d</code></strong> for daily archiving, the Web page presents the entries for one day. Using the arrows (at the top in <a class="xref" href="../Text/ch16s02.html#history.cgi_filters_the" title="Figure 16-35. history.cgi filters the information from the log file">Figure 16-35</a>) you can then scroll up and down through the days.<a class="indexterm" id="IDX-CHP-16-1260"/></p>

      <div class="figure">
        <a id="history.cgi_filters_the"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31947"/><img alt="history.cgi filters the information from the log file" src="../Images/tagoreillycom20081104nostarchimages223912.png.jpg"/></div>

        <p class="title">Figure 16-35. <code class="userinput">history.cgi</code> filters the information from the log file</p>
      </div>
    </div>

    <div class="sect2" title="16.2.13 Who was told what, when?— notifications.Cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_15"><a id="who_was_told_what_comma_when_question_n"/>16.2.13 Who was told what, when?— <strong class="userinput"><code>notifications.Cgi</code></strong></h2>
      </div>

      <p>Another filtered view of the log file is offered by <strong class="userinput"><code>notifications.cgi:</code></strong> It shows all sent messages. Here the view can aso be restricted to a specific message group, through the selection field at the top right in <a class="xref" href="../Text/ch16s02.html#notifications.cgi_answer" title="Figure 16-36. notifications.cgi answers the question of who gets messages when, about what">Figure 16-36</a>: to all notifications involving hosts, to all which are about services in a critical state, and so on.<a class="indexterm" id="IDX-CHP-16-1261"/><a class="indexterm" id="IDX-CHP-16-1262"/></p>

      <div class="figure">
        <a id="notifications.cgi_answer"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e31977"/><img alt="notifications.cgi answers the question of who gets messages when, about what" src="../Images/tagoreillycom20081104nostarchimages223914.png.jpg"/></div>

        <p class="title">Figure 16-36. <code class="userinput">notifications.cgi</code> answers the question of who gets messages when, about what</p>
      </div>

      <p>If you just want to see messages here concerning particular hosts and services, you must again specify this with parameters when running the CGI program:</p><a id="I_programlisting1_d1e31984"/>
      <pre class="programlisting">notifications.cgi?host=<span class="emphasis"><em>host</em></span>
notifications.cgi?host=<span class="emphasis"><em>host&amp;service=service name</em></span>
notifications.cgi?contact=<span class="emphasis"><em>contact</em></span></pre>

      <p>Apart from <strong class="userinput"><code>host</code></strong> and <strong class="userinput"><code>service</code></strong>, you can also select a particular contact, but selecting host or service groups is not possible.</p>
    </div>

    <div class="sect2" title="16.2.14 Showing all log file entries: showlog.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_16"><a id="showing_all_log_file_entries_colon_show"/>16.2.14 Showing all log file entries: <strong class="userinput"><code>showlog.cgi</code></strong></h2>
      </div>

      <p>The CGI program <strong class="userinput"><code>showlog.cgi</code></strong> shows the log file as it is, with the few colored icons added to help you find your way: a red button marks critical service states or DOWN/UNREACHABLE hosts, a yellow button marks WARNINGs, and a green one, OK. Other buttons refer to information entries or Nagios restarts (<a class="xref" href="../Text/ch16s02.html#a_blue_button_marks_information_entries" title="Figure 16-37. A blue button marks information entries, the graph changing from red to green stands for Nagios restarts, and the icon marked GO with a green checked background represents restarts of the monitoring system">Figure 16-37</a>).<a class="indexterm" id="IDX-CHP-16-1263"/></p>

      <p>You only have a single option here: the chronological order. Normally <strong class="userinput"><code>showlog.cgi</code></strong> shows the newest entries first. If you enable the check mark in <span class="strong"><strong>Older Entries First:</strong></span> (top right), the oldest entries will be shown first.</p>

      <p>The period represented here also depends on the archiving method: if you archive once a day, you will obtain just one day for each Web page. To reach the entries for other days you must make your way through the individual archive files of the log file using the arrows at the top of the picture.</p>

      <div class="figure">
        <a id="a_blue_button_marks_information_entries"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e32030"/><img alt="A blue button marks information entries, the graph changing from red to green stands for Nagios restarts, and the icon marked GO with a green checked background represents restarts of the monitoring system" src="../Images/tagoreillycom20081104nostarchimages223916.png.jpg"/></div>

        <p class="title">Figure 16-37. A blue button marks information entries, the graph changing from red to green stands for Nagios restarts, and the icon marked GO with a green checked background represents restarts of the monitoring system</p>
      </div>
    </div>

    <div class="sect2" title="16.2.15 Evaluating whatever you want: summary.cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_17"><a id="evaluating_whatever_you_want_colon_summ"/>16.2.15 Evaluating whatever you want: <strong class="userinput"><code>summary.cgi</code></strong></h2>
      </div>

      <p>If the display and selection options are introduced so far are not sufficient for you, you can create your own report with <strong class="userinput"><code>summary.cgi</code></strong>, which generates the selection dialog shown in <a class="xref" href="../Text/ch16s02.html#selection_template_for_parameters_in" title="Figure 16-38. Selection template for parameters in summary.cgi">Figure 16-38</a>. The upper section, <span class="strong"><strong>Standard Reports:</strong></span>, provides a quick summary in which just one fixed report type can be selected. Clicking on the button directly below this generates the report.<a class="indexterm" id="IDX-CHP-16-1265"/><a class="indexterm" id="IDX-CHP-16-1264"/></p>

      <p>The second section is more sophisticated. The field <span class="strong"><strong>Report Type:</strong></span> with the report type <span class="strong"><strong>Most Recent Alerts</strong></span> provides an individual listing of the last <strong class="userinput"><code>n</code></strong> of individual events. The number <strong class="userinput"><code>n</code></strong> is defined further down in the selection dialog in <span class="strong"><strong>Max List Items:</strong></span>.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-22" id="CHP-16-FN-22">168</a>]</sup> <span class="strong"><strong>Report Type:</strong></span> can also be used to show all events individually on a separate line, with <span class="strong"><strong>Most Recent Alerts</strong></span>, or you can have statistics displayed, for the number of events that have occurred overall, for each host group, etc., with <span class="strong"><strong>Alert Totals, Alert Totals by Hostgroups</strong></span>, etc.</p>

      <p>One particularly interesting report type is <span class="strong"><strong>Top Alert Producer</strong></span>: such reports show in a hit list of who has caused most trouble during the report period.</p>

      <p>In <span class="strong"><strong>Report Period:</strong></span> you can either choose the desired report period from predefined intervals (this week, the past seven days, this month, last week, last month, etc.), or you can specify <strong class="userinput"><code>CUSTOM REPORT PERIOD</code></strong> and define any period you choose. If you forget to specify <strong class="userinput"><code>CUSTOM REPORT PERIOD</code></strong> explicitly, the CGI program ignores the dates you have set and selects what is currently entered in <span class="strong"><strong>Report Period</strong></span>.</p>

      <div class="figure">
        <a id="selection_template_for_parameters_in"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e32114"/><img alt="Selection template for parameters in summary.cgi" src="../Images/tagoreillycom20081104nostarchimages223918.png.jpg"/></div>

        <p class="title">Figure 16-38. Selection template for parameters in <code class="userinput">summary.cgi</code></p>
      </div>

      <p>The details that follow the report period filter according to host, services or their groups, state types, and/or individual states (e.g., only services in a CRITICAL state). It is important to specify <span class="strong"><strong>Max List Items</strong></span> at the end: <strong class="userinput"><code>summary.cgi</code></strong> always shows only as many entries as are specified here. The default is a little small; if you want all the entries in the selected period to be shown, you should enter <strong class="userinput"><code>0</code></strong> as the value. The largest value that can be given explicitly here is 999. The <span class="strong"><strong>Create Summary Report!</strong></span> button then generates the requested report (<a class="xref" href="../Text/ch16s02.html#an_individual_report_comma_as_generated" title="Figure 16-39. An individual report, as generated by summary.cgi">Figure 16-39</a>).</p>

      <p>The header of the report contains details of the report period and the selection made. The detail directly above the table is interesting: <span class="strong"><strong>Displaying most recent 25 of 3721 total matching alerts</strong></span> shows that the selection criteria matched a total of 3721 entries, but that the CGI script restricted the output to the 25 most current entries, thanks to <span class="strong"><strong>Max List Items:</strong></span>.</p>

      <div class="figure">
        <a id="an_individual_report_comma_as_generated"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e32148"/><img alt="An individual report, as generated by summary.cgi" src="../Images/tagoreillycom20081104nostarchimages223920.png.jpg"/></div>

        <p class="title">Figure 16-39. An individual report, as generated by <code class="userinput">summary.cgi</code></p>
      </div>
    </div>

    <div class="sect2" title="16.2.16 Following states graphically over time: trends.Cgi">
      <div class="titlepage">
        <h2 class="title" id="heading_id_18"><a id="following_states_graphically_over_time"/>16.2.16 Following states graphically over time: <strong class="userinput"><code>trends.Cgi</code></strong></h2>
      </div>

      <p>A rapid overview of what state occurred when for a particular host or service is provided by the graphic output of <strong class="userinput"><code>trends.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#trends.cgi_represents_th" title="Figure 16-40. trends.cgi represents the chronological sequence of states—here using the example of a service">Figure 16-40</a>). After selecting a specific host or service, you can define a period, as with <strong class="userinput"><code>summary.cgi</code></strong>. The states are color-coded by <strong class="userinput"><code>trends.cgi</code></strong>, which makes the overview easier to follow.<a class="indexterm" id="IDX-CHP-16-1266"/></p>

      <p>The zoom function of the CGI program is an interesting detail. If you click in the colored area on a particular section, the selected area is enlarged or reduced in size by the zoom factor specified at the top right. Negative entries (<strong class="userinput"><code>−1, −2, −3</code></strong>, and <span class="strong"><strong>−4</strong></span> are possible) expand the report period instead of reducing it.</p>

      <div class="figure">
        <a id="trends.cgi_represents_th"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e32187"/><img alt="trends.cgi represents the chronological sequence of states—here using the example of a service" src="../Images/tagoreillycom20081104nostarchimages223922.png.jpg"/></div>

        <p class="title">Figure 16-40. <code class="userinput">trends.cgi</code> represents the chronological sequence of states—here using the example of a service</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-4" id="ftn.CHP-16-FN-4">150</a>]</sup> <a class="ulink" href="http://lists.sourceforge.net/mailman/listinfo/nagios-users">http://lists.sourceforge.net/mailman/listinfo/nagios-users</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-5" id="ftn.CHP-16-FN-5">151</a>]</sup> If you have kept to the installation in this book.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-6" id="ftn.CHP-16-FN-6">152</a>]</sup> <a class="ulink" href="http://nagios-demo.netways.de/">http://nagios-demo.netways.de/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-7" id="ftn.CHP-16-FN-7">153</a>]</sup> <a class="ulink" href="http://www.netways.de/">http://www.netways.de/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-8" id="ftn.CHP-16-FN-8">154</a>]</sup> <strong class="userinput"><code>/usr/local/nagios/share/docs/tuning.html</code></strong></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-9" id="ftn.CHP-16-FN-9">155</a>]</sup> <a class="ulink" href="http://netways.de/Demosystem.1621.0.html">http://netways.de/Demosystem.1621.0.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-10" id="ftn.CHP-16-FN-10">156</a>]</sup> The <span class="emphasis"><em>Virtual Reality Markup Language</em></span> (VRML), version 2.0/1997, is used to describe the virtual "space."</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-11" id="ftn.CHP-16-FN-11">157</a>]</sup> <strong class="userinput"><code>/usr/local/nagios/share/docs/cgis.html#statuswrl_cgi</code></strong></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-12" id="ftn.CHP-16-FN-12">158</a>]</sup> <a class="ulink" href="http://www.parallelgrafics.com/products/cortona">http://www.parallelgrafics.com/products/cortona</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-13" id="ftn.CHP-16-FN-13">159</a>]</sup> For Firefox you have to install it manually, select <span class="strong"><strong>Custom</strong></span> instead of <span class="strong"><strong>Typical</strong></span> in the installation routine, and in <span class="strong"><strong>not supported browsers</strong></span> specify the plugin directory of the browser.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-14" id="ftn.CHP-16-FN-14">160</a>]</sup> <a class="ulink" href="http://cic.nist.gov/vrml/vbdetect.html">http://cic.nist.gov/vrml/vbdetect.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-15" id="ftn.CHP-16-FN-15">161</a>]</sup> <a class="ulink" href="http://www.openvrml.org/">http://www.openvrml.org/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-16" id="ftn.CHP-16-FN-16">162</a>]</sup> <a class="ulink" href="http://freewrl.%20sourcef%20orge.%20net/">http://freewrl. sourcef orge. net/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-17" id="ftn.CHP-16-FN-17">163</a>]</sup> <span class="emphasis"><em>Wireless Access Protocol</em></span>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-18" id="ftn.CHP-16-FN-18">164</a>]</sup> The <span class="emphasis"><em>Wireless Markup Language</em></span> contains a part of HTML, heavily reduced in its functionality.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-19" id="ftn.CHP-16-FN-19">165</a>]</sup> Parameter <strong class="userinput"><code>log_initial_state</code></strong> in <strong class="userinput"><code>nagios.cfg;</code></strong> see page 597.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-20" id="ftn.CHP-16-FN-20">166</a>]</sup> The subtle difference here lies in <strong class="userinput"><code>retain_state_information</code></strong> (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). If this parameter is set to 0, Nagios forgets the previous state. Without <strong class="userinput"><code>log_initial_state = yes</code></strong>, Nagios accepts an OK after the restart.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-21" id="ftn.CHP-16-FN-21">167</a>]</sup> Nagios thus repeats the test four times before it categorizes the state as "hard."</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-22" id="ftn.CHP-16-FN-22">168</a>]</sup> If the number of events in the report period is less than specified in <span class="strong"><strong>Max List Items:</strong></span>, the report covers all the events that have happened during this period.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="16.3 Planning Downtimes">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="planning_downtimes"/>16.3 Planning Downtimes</h1>
    </div>

    <p>In every system environment maintenance work accumulates from time to time that the administrator can normally plan, so that users can be informed accordingly beforehand. Nagios refers to such maintenance windows as <span class="emphasis"><em>Scheduled Downtime</em></span>; the administrator enters these either in the information page for the host or service generated by <strong class="userinput"><code>extinfo.cgi</code></strong> (<a class="xref" href="../Text/ch16.html#extinfo.cgi_provides_additional_informa" title="Figure 16-4. extinfo.cgi provides additional information on the selected host">Figure 16-4</a>, page 331) or for the corresponding host or service group (<a class="xref" href="../Text/ch16s02.html#command_center_for_the_sap_host_group_c" title="Figure 16-17. Command center for the SAP host group: extinfo.cgi?type=5&amp;hostgroup=SAP">Figure 16-17</a>, page 339). In doing this, <strong class="userinput"><code>extinfo.cgi</code></strong> makes use of <strong class="userinput"><code>cmd.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#interface_for_external_commands_colon_c" title="16.2.3 Interface for external commands: cmd.cgi">16.2.3 Interface for external commands: cmd.cgi</a>, page 343), which can also be called selectively:<a class="indexterm" id="IDX-CHP-16-1267"/><a class="indexterm" id="IDX-CHP-16-1268"/><a class="indexterm" id="IDX-CHP-16-1269"/><a class="indexterm" id="IDX-CHP-16-1270"/><a class="indexterm" id="IDX-CHP-16-1271"/></p><a id="I_programlisting1_d1e32237"/>
    <pre class="programlisting">http://<span class="emphasis"><em>nagiosserver</em></span>/nagios/cgi-bin/cmd.cgi?cmd_typ=55</pre>

    <p>opens the import template for maintenance times for a single host. The values for <strong class="userinput"><code>cmd_typ</code></strong> are summarized by <a class="xref" href="../Text/ch16s02.html#the_most_important_host_and_service_rel" title="Figure 16-24. The most important host and service related codes for cmd.cgi?cmd_typ=">Figure 16-24</a> in page 344.</p>

    <p>A further method of recording maintenance periods is provided by addons, which, like the CGI programs, use the external command interface, but which can be automated, in contrast to the interactive Web interface. Such addons can also be found on the Nagios Exchange.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-23" id="CHP-16-FN-23">169</a>]</sup></p>

    <p>For scheduled downtimes, Nagios prevents notifications from being sent. This ensures that the administrator is not flooded with false alarms. When checks are made to see whether messages should be sent, a downtime is the third item in the list (<a class="xref" href="../Text/ch16.html#the_menu_item_service_problems_brings_c" title="Figure 16-2. The menu item Service Problems brings current problems to attention">Figure 16-2</a>, page 268). In addition, <strong class="userinput"><code>avail.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#availability_statistics_colon_avail.cgi" title="16.2.10 Availability statistics: avail.cgi">16.2.10 Availability statistics: avail.cgi</a>, page 351.) takes account of the downtime when evaluating the availability of individual hosts and services, and assigns error states that occur during these times not as error states, but as OK.<a class="indexterm" id="IDX-CHP-16-1272"/></p>

    <p>Maintenance periods can overlap. If one maintenance window lasts from 8:00 A.M. till 12:00 P.M., and a second one involving the same host or service, from 10:00 A.M. to 2:00 P.M., then Nagios does not send any error messages between 8:00 A.M. and 2:00 P.M., and the whole period is also ignored in the availability statistics.</p>

    <div class="sect2" title="16.3.1 Maintenance periods for hosts">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="maintenance_periods_for_hosts"/>16.3.1 Maintenance periods for hosts</h2>
      </div>

      <p>What data is required to record the maintenance window can be explained quite clearly using the Web interface. <a class="xref" href="../Text/ch16s03.html#the_downtime_for_a_host_in_the_web_inte" title="Figure 16-41. The downtime for a host in the Web interface is recorded using this dialog">Figure 16-41</a> shows the input template for the downtime of a host (<strong class="userinput"><code>cmd.cgi?cmd_typ=55</code></strong>).<a class="indexterm" id="IDX-CHP-16-1274"/><a class="indexterm" id="IDX-CHP-16-1273"/></p>

      <div class="figure">
        <a id="the_downtime_for_a_host_in_the_web_inte"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e32292"/><img alt="The downtime for a host in the Web interface is recorded using this dialog" src="../Images/tagoreillycom20081104nostarchimages223924.png.jpg"/></div>

        <p class="title">Figure 16-41. The downtime for a host in the Web interface is recorded using this dialog</p>
      </div>

      <p>The first line defines the host, and in the second line Nagios automatically enters the login with which you have logged in to the Web interface. In the input field after the <span class="strong"><strong>Comment:</strong></span> keyword, you can describe the reason for the planned downtime. Specifying the trigger shows whether it was generated indirectly through another entry. When recording a new downtime, you should leave the value <span class="strong"><strong>N/A</strong></span> (<span class="emphasis"><em>not available</em></span>, that is, no trigger) as it is.</p>

      <p>In the next four lines you have the option of entering two different downtime types: fixed ones (<span class="strong"><strong>Type: Fixed</strong></span>) or variable periods (<span class="strong"><strong>Flexible</strong></span>). The first has a fixed start and a fixed end. In this case Nagios ignores the period entry in hours and minutes in the <span class="strong"><strong>Flexible Duration:</strong></span> fields completely.</p>

      <p>A flexible downtime starts when the first-ever event occurs in the period specified. From this point in time Nagios plans the downtime for the length of time that was specified here in hours and minutes. This may certainly exceed the end point specified in <span class="strong"><strong>End Time:</strong></span>.</p>

      <p>If further hosts are dependent on the computer specified in <span class="strong"><strong>Host Name:</strong></span> (perhaps because a router is involved, which other host objects have entered as <span class="strong"><strong>parents</strong></span>), you have the possibility of extending the downtime to all dependent hosts with the last item, <span class="strong"><strong>Child Hosts:. Schedule triggered downtime for all child hosts</strong></span> passes on flexible downtimes to all "child hosts," <span class="strong"><strong>Schedule non-triggered downtime for all child hosts</strong></span> does the same for fixed downtimes, and <span class="strong"><strong>Do nothing with child hosts</strong></span> ignores dependencies, so that Nagios does not plan for any downtime for any hosts other than the one specified here.<a class="indexterm" id="IDX-CHP-16-1275"/></p>

      <p>How this hereditary behavior takes effect in <a class="xref" href="../Text/ch16s03.html#the_downtime_for_a_host_in_the_web_inte" title="Figure 16-41. The downtime for a host in the Web interface is recorded using this dialog">Figure 16-41</a> is shown by the overview of all scheduled downtimes in <a class="xref" href="../Text/ch16s02.html#overview_of_all_planned_maintenance_per" title="Figure 16-21. Overview of all planned maintenance periods: extinfo.cgi?type=6">Figure 16-21</a> in page 342. The first line contains the downtime just described for the host <span class="strong"><strong>eli-saprouter</strong></span> with the <span class="strong"><strong>Downtime ID</strong></span> number <span class="strong"><strong>1</strong></span>. Entries that are caused by inheriting this timeout contain the <span class="strong"><strong>Downtime ID</strong></span> of the downtime causing them in the <span class="strong"><strong>Trigger ID</strong></span> column: for <strong class="userinput"><code>sap-12</code></strong> this is <span class="strong"><strong>1</strong></span>, since the maintenance of <strong class="userinput"><code>eli-saprouter</code></strong> also affects this host.</p>

      <p>Nagios simultaneously generates a comment entry when planning a downtime, which is automatically removed when this period has passed. This is why a speech bubble appears in the status display. During the downtime Nagios supplements this with a "snoring sign," which is meant to represent a sleep state (<a class="xref" href="../Text/ch16s03.html#the_snoring_sign_zzzzz_shows_that_the_d" title="Figure 16-42. The snoring sign zzzzz shows that the downtime for the host has begun">Figure 16-42</a>).</p>

      <div class="figure">
        <a id="the_snoring_sign_zzzzz_shows_that_the_d"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e32383"/><img alt="The snoring sign zzzzz shows that the downtime for the host has begun" src="../Images/tagoreillycom20081104nostarchimages223926.png.jpg"/></div>

        <p class="title">Figure 16-42. The snoring sign zzzzz shows that the downtime for the host has begun</p>
      </div>
    </div>

    <div class="sect2" title="16.3.2 Downtime for services">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="downtime_for_services"/>16.3.2 Downtime for services</h2>
      </div>

      <p>Downtimes for services differ from those for hosts in two small details. Apart from host name, the service description must be included, and the possibility of inheritance is excluded, since there are no corresponding dependencies for services.<a class="indexterm" id="IDX-CHP-16-1277"/><a class="indexterm" id="IDX-CHP-16-1278"/><a class="indexterm" id="IDX-CHP-16-1276"/></p>

      <p>A downtime for a host does not automatically apply to the services running on it. But since they are also not available if the host is down, it is recommended that you plan the same downtime for all dependent services. It can be quite strenuous to enter all the services individually. It is much easier to do this using a host group (<strong class="userinput"><code>cmd_typ=85</code></strong>), as shown in <a class="xref" href="../Text/ch16s03.html#one_downtime_for_all_services_of_a_host" title="Figure 16-43. One downtime for all services of a host group">Figure 16-43</a>. With this you can define the downtime for services in a specific host group with a single command, and much more as well: a check mark in <span class="strong"><strong>Schedule Downtime For Hosts Too</strong></span> at the same time defines the same downtime for all hosts belonging to this group.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-24" id="CHP-16-FN-24">170</a>]</sup></p>

      <div class="figure">
        <a id="one_downtime_for_all_services_of_a_host"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e32427"/><img alt="One downtime for all services of a host group" src="../Images/tagoreillycom20081104nostarchimages223928.png.jpg"/></div>

        <p class="title">Figure 16-43. One downtime for all services of a host group</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-23" id="ftn.CHP-16-FN-23">169</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/Downtimes.38.0.html">http://www.nagiosexchange.org/Downtimes.38.0.html</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-24" id="ftn.CHP-16-FN-24">170</a>]</sup> Up until (at least) Nagios version 3.0rc1, the check mark has no effect, however; there you have to enter the downtime of the hosts separately by running <strong class="userinput"><code>cmd.cgi?cmd_typ=84</code></strong> again.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="16.4 Additional Information on Hosts and Services">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="additional_information_on_hosts_and_ser"/>16.4 Additional Information on Hosts and Services</h1>
    </div>

    <p>With the extended information for hosts and services, you can incorporate additional information in the Web interface and also brighten up its appearance somewhat, using suitable icons. Two separate objects hold this information in Nagios 2.x: <strong class="userinput"><code>hostextinfo</code></strong> and <strong class="userinput"><code>serviceextinfo</code></strong>. Starting with Nagios 3.0, the additional information is defined directly in the host and service objects. Although Nagios 3.0 still evaluates the <strong class="userinput"><code>hostextinfo</code></strong> and <strong class="userinput"><code>serviceextinfo</code></strong> objects, it issues a warning message when checking the configuration and considers these objects to be obsolete.<a class="indexterm" id="IDX-CHP-16-1279"/><a class="indexterm" id="IDX-CHP-16-1280"/><a class="indexterm" id="IDX-CHP-16-1281"/><a class="indexterm" id="IDX-CHP-16-1282"/><a class="indexterm" id="IDX-CHP-16-1283"/></p>

    <p>It is planned to leave these out of Nagios entirely, by version 4 at the latest. Those using Nagios 3.0 for the first time should specify the information introduced below directly in the host and service definitions and leave out <strong class="userinput"><code>hostextinfo</code></strong> and <strong class="userinput"><code>serviceextinfo</code></strong> right from the start. If you are changing from Nagios 2.x to Nagios 3.0, you don't need to worry about this, and you can continue using existing instances of these objects.</p>

    <p>To make this clearer, below we will use the terms <strong class="userinput"><code>hostextinfo</code></strong> and <strong class="userinput"><code>serviceextinfo</code></strong> object <span class="emphasis"><em>information</em></span>. For Nagios 2.x, the term refers to the <span class="emphasis"><em>object</em></span> of the same name, whereas for Nagios 3.0 it refers to the corresponding <span class="emphasis"><em>details</em></span> given in the <strong class="userinput"><code>host</code></strong> and <strong class="userinput"><code>service</code></strong> objects. The parameters themselves are identical for Nagios 2.x and 3.0. The object information only influences the Web interface and has no effect on the capabilities of Nagios.</p>

    <div class="sect2" title="16.4.1 Extended host information">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="extended_host_information"/>16.4.1 Extended host information</h2>
      </div>

      <p>Object information for hosts allow you to enhance the display of hosts in the Web interface through additional functions in the form of links and enhancement features in the form of icons and coordinates:<a class="indexterm" id="IDX-CHP-16-1284"/><a class="indexterm" id="IDX-CHP-16-1285"/><a class="indexterm" id="IDX-CHP-16-1286"/><a class="indexterm" id="IDX-CHP-16-1287"/><a class="indexterm" id="IDX-CHP-16-1288"/><a class="indexterm" id="IDX-CHP-16-1289"/></p><a id="I_programlisting1_d1e32537"/>
      <pre class="programlisting"># Nagios 2.x                     # Nagios 3.0
define hostextinfo{              define host{
<span class="strong"><strong>   host_name</strong></span>    linux01
   notes               Samba Primary Domaincontroller
   notes_url           /hosts/linux01.html
   action_url          /hosts/actions/linux01.html
   icon_image          base/linux40.png
   icon_image_alt      Linux Host
   vrml_image          base/linux40.png
   statusmap_image     base/linux40.gd2
   2d_coords           120, 80
   3d_coords           70.0,30.0,40.0
}</pre>

      <p>The only obligatory parameter when these are defined is the specification of the host, with <strong class="userinput"><code>host_name</code></strong>; everything else is optional:<a class="indexterm" id="IDX-CHP-16-1290"/><a class="indexterm" id="IDX-CHP-16-1291"/></p>

      <div class="variablelist">
        <dl>
          <dt><span class="term"><strong class="userinput"><code>host_name</code></strong></span></dt>

          <dd>
            <p>This is the name of the host object whose Web pages are to be expanded by the following properties.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>notes</code></strong></span></dt>

          <dd>
            <p>Use this for additional information that <strong class="userinput"><code>extinfo.cgi</code></strong> takes into account in its information pages. (The entry specified in the above example, <span class="strong"><strong>Samba Primary Domaincontroller</strong></span>, can be found in <a class="xref" href="../Text/ch16s04.html#extinfo.cgi_also_shows_a" title="Figure 16-44. extinfo.cgi also shows an alternative text here for the Linux icon (beneath the Tux in brackets) and the additional information from the parameter notes (beneath the alternative text)">Figure 16-44</a> below the Linux icon.)</p>

            <div class="figure">
              <a id="extinfo.cgi_also_shows_a"/>

              <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e32584"/><img alt="extinfo.cgi also shows an alternative text here for the Linux icon (beneath the Tux in brackets) and the additional information from the parameter notes (beneath the alternative text)" src="../Images/tagoreillycom20081104nostarchimages223930.png.jpg"/></div>

              <p class="title">Figure 16-44. <code class="userinput">extinfo.cgi</code> also shows an alternative text here for the Linux icon (beneath the Tux in brackets) and the additional information from the parameter <code class="userinput">notes</code> (beneath the alternative text)</p>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>notes_url</code></strong></span></dt>

          <dd>
            <p>This is the URL of a (HTML) file with additional information on the host in question, to which you are linked by an icon in the form of a red, slightly opened manual, both in the status overview (<a class="xref" href="../Text/ch16s04.html#this_detail_view_shows_an_icon_each_for" title="Figure 16-45. This detail view shows an icon each for notes_url (open, read booklet) action_url (pink star), and icon_ image (here, Linux penguin)">Figure 16-45</a>) and in the info page generated by <strong class="userinput"><code>extinfo.cgi</code></strong> (<a class="xref" href="../Text/ch16s04.html#extinfo.cgi_also_shows_a" title="Figure 16-44. extinfo.cgi also shows an alternative text here for the Linux icon (beneath the Tux in brackets) and the additional information from the parameter notes (beneath the alternative text)">Figure 16-44</a>). If the documentation on the host involved is stored in the Intranet, then maintenance contracts, hotline numbers, system configuration, etc. are then just a mouse click away.</p>

            <p>The parameter may contain an absolute path (from the view of the Web server) or a complete URL (<strong class="userinput"><code>http://.</code></strong>..).</p>

            <div class="figure">
              <a id="this_detail_view_shows_an_icon_each_for"/>

              <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e32620"/><img alt="This detail view shows an icon each for notes_url (open, read booklet) action_url (pink star), and icon_ image (here, Linux penguin)" src="../Images/tagoreillycom20081104nostarchimages223932.png.jpg"/></div>

              <p class="title">Figure 16-45. This detail view shows an icon each for <code class="userinput">notes_url</code> (open, read booklet) <code class="userinput">action_url</code> (pink star), and <code class="userinput">icon_ image</code> (here, Linux penguin)</p>
            </div>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>action_url</code></strong></span></dt>

          <dd>
            <p>This is a link pointing to an action to be run for the host, which executes a CGI program such as <strong class="userinput"><code>cmd.cgi</code></strong>, for example, with just a mouse click. Since a link in the browser is always just a link, this does not have to be a command, and you can just as easily link another Web page. Both in the status overview (<a class="xref" href="../Text/ch16s04.html#this_detail_view_shows_an_icon_each_for" title="Figure 16-45. This detail view shows an icon each for notes_url (open, read booklet) action_url (pink star), and icon_ image (here, Linux penguin)">Figure 16-45</a>), and on the <strong class="userinput"><code>extinfo.cgi</code></strong> info page (<a class="xref" href="../Text/ch16s04.html#extinfo.cgi_also_shows_a" title="Figure 16-44. extinfo.cgi also shows an alternative text here for the Linux icon (beneath the Tux in brackets) and the additional information from the parameter notes (beneath the alternative text)">Figure 16-44</a>) it is hidden behind the pink star.<a class="indexterm" id="IDX-CHP-16-1292"/></p>

            <p>As a value, absolute paths from the view of the Web server or complete URLs can be used.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>icon_image</code></strong></span></dt>

          <dd>
            <p>This is an icon to enhance the Web interface, but also to provide help: if you systematically use pictures here that represent the operating system (e.g., the Tux for Linux, the Windows window for Microsoft operating systems, the Sun logo for Solaris computers, etc.), this helps you to keep an overview of the operating systems in the status view—especially if you have a large number of hosts (<a class="xref" href="../Text/ch16s04.html#this_detail_view_shows_an_icon_each_for" title="Figure 16-45. This detail view shows an icon each for notes_url (open, read booklet) action_url (pink star), and icon_ image (here, Linux penguin)">Figure 16-45</a>). <strong class="userinput"><code>extinfo.cgi</code></strong> also uses this icon (<a class="xref" href="../Text/ch16s04.html#extinfo.cgi_also_shows_a" title="Figure 16-44. extinfo.cgi also shows an alternative text here for the Linux icon (beneath the Tux in brackets) and the additional information from the parameter notes (beneath the alternative text)">Figure 16-44</a>).<a class="indexterm" id="IDX-CHP-16-1293"/></p>

            <p>Icons should be approximately 40×40 pixels large and be available as a GIF, JPEG, or PNG file. If you specify a relative path (or none at all), then this begins with the directory <strong class="userinput"><code>/usr/local/nagios/share/images/logos/</code></strong>.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-25" id="CHP-16-FN-25">171</a>]</sup></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>icon_image_alt</code></strong></span></dt>

          <dd>
            <p>This alternative text for the icon appears if the browser does not show a picture (for example for reading devices or output devices for Braille). From the icon and the icon text details, Nagios generates the following HTML code:<a class="indexterm" id="IDX-CHP-16-1294"/></p><a id="I_programlisting1_d1e32682"/>
            <pre class="programlisting">IMG SRC= <span class="emphasis"><em>icon_image</em></span> ALT=<span class="emphasis"><em>icon_image_alt</em></span>&gt;</pre>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>vrml_image</code></strong></span></dt>

          <dd>
            <p>This is an image symbolizing the host in the 3D representation of <strong class="userinput"><code>statuswrl.cgi</code></strong>. Permissible formats are again GIF, JPEG, or PNG. You should avoid slides, since the image is placed on a cube, and the transparent parts in the 3D interface may lead to unexpected results.<a class="indexterm" id="IDX-CHP-16-1295"/><a class="indexterm" id="IDX-CHP-16-1296"/></p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>statusmap_image</code></strong></span></dt>

          <dd>
            <p>This is the image with which <strong class="userinput"><code>statusmap.cgi</code></strong> (see <a class="xref" href="../Text/ch16s02.html#the_topological_map_of_the_network_colo" title="16.2.5 The topological map of the network: statusmap.cgi">16.2.5 The topological map of the network: statusmap.cgi</a>, page 346) symbolizes the host in its topological map. The Nagios demo page of Netways,<sup>[<a class="footnote" href="#ftn.CHP-16-FN-26" id="CHP-16-FN-26">172</a>]</sup> (<a class="xref" href="../Text/ch16s02.html#statusmap_with_self-defined_coordinates" title="Figure 16-28. Statusmap with self-defined coordinates and icons">Figure 16-28</a> in page 348) shows a nice example.<a class="indexterm" id="IDX-CHP-16-1297"/></p>

            <p>Although GIFs, JPEGs, and PNGs are allowed, it is better to use the GD2 format, because then Nagios requires less computer time to generate the status map. Using the program <strong class="userinput"><code>pngtogd2</code></strong>, which ought to be available as a component of the utilities for Thomas Boutells GD library in most Linux distributions, PNG files can be easily converted. Again the image size of 40×40 pixels is recommended.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>2d_coords</code></strong></span></dt>

          <dd>
            <p>This parameter specifies coordinates for a user-defined layout of the topological map. Details are given in pixels, with the origin, <strong class="userinput"><code>(0, 0), at the top left, and values must be positive:</code></strong> a positive x value counts the number of pixels from the origin to the right, a positive y value from the origin downwards.<a class="indexterm" id="IDX-CHP-16-1298"/></p>

            <p><a class="xref" href="../Text/ch16s02.html#statusmap_with_self-defined_coordinates" title="Figure 16-28. Statusmap with self-defined coordinates and icons">Figure 16-28</a> works with fixed coordinates for individual hosts. Nagios ignores <strong class="userinput"><code>2d_coords</code></strong> details if the status maps a different layout to the user-defined one.</p>
          </dd>

          <dt><span class="term"><strong class="userinput"><code>3d_coords</code></strong></span></dt>

          <dd>
            <p>These are the coordinates for the 3D representation. Positive and negative floating-point numbers are allowed. <strong class="userinput"><code>(0.0,0.0,0.0)</code></strong> is used as the origin. In the start view, <strong class="userinput"><code>statuswrl.cgi</code></strong> scales the 3D image so that all existing hosts appear on the screen. Where the starting point lies on the screen can therefore not be predicted.<a class="indexterm" id="IDX-CHP-16-1299"/></p>
          </dd>
        </dl>
      </div>

      <p>On The Nagios Exchange there is a wide range of finished icons in the category <span class="strong"><strong>Logos and Images</strong></span>.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-27" id="CHP-16-FN-27">173</a>]</sup> It is best to unpack these into separate subdirectories, and then the individual packages will not get in each other's way:</p><a id="I_programlisting1_d1e32776"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/nagios/share/images/logos</strong></span>
linux:images/logos # <span class="strong"><strong>tar xvzf imagepak-base.tar.gz</strong></span>
base/aix.gd2
base/aix.gif
base/aix.jpg
base/aix.png
base/amiga.gd2
...</pre>

      <p><strong class="userinput"><code>imagepak-base.tar.gz</code></strong> contains a basic selection of icons, which can be supplemented as you please with other packages. The <strong class="userinput"><code>base</code></strong> subdirectory created, as with the object definition at the beginning of this chapter, must also be included.</p>
    </div>

    <div class="sect2" title="16.4.2 Extended service information">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="extended_service_information"/>16.4.2 Extended service information</h2>
      </div>

      <p>Extended service object information is more or less identical to the host equivalents, so that we will only mention the differences. In addition to the host name, the service description in <strong class="userinput"><code>service_description</code></strong> is obligatory, but the details on the 2D (status map) and 3D views are omitted:<a class="indexterm" id="IDX-CHP-16-1300"/><a class="indexterm" id="IDX-CHP-16-1301"/><a class="indexterm" id="IDX-CHP-16-1302"/></p><a id="I_programlisting1_d1e32810"/>
      <pre class="programlisting"># Nagios 2.x                  # Nagios 3.0
define serviceextinfo{        define service{
   ...
<span class="strong"><strong>    host_name</strong></span>       linux01
<span class="strong"><strong>    service_description</strong></span> LPD
    notes                      Linux Print Services
    notes_url                  /hosts/linux01-lpd.html
    action_url                 /hosts/linux01-lpd-action.html
    icon_image                  base/hp-printer40.png
    icon_image_alt              Linux Print Server
}</pre>

      <p>In contrast to extended host information, the status overview for this example only shows the printer icon specified in <strong class="userinput"><code>icon_image</code></strong>, but not the two icons defined in <strong class="userinput"><code>notes_url</code></strong> and <strong class="userinput"><code>action_url</code></strong> for the two links <strong class="userinput"><code>notes_url</code></strong> and <strong class="userinput"><code>action_url</code></strong>. They only appear in the page generated by <strong class="userinput"><code>extinfo.cgi</code></strong> with the same icons as for the extended host information (<a class="xref" href="../Text/ch16s04.html#extinfo.cgi_also_shows_a" title="Figure 16-44. extinfo.cgi also shows an alternative text here for the Linux icon (beneath the Tux in brackets) and the additional information from the parameter notes (beneath the alternative text)">Figure 16-44</a>, page 363).<a class="indexterm" id="IDX-CHP-16-1303"/></p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-25" id="ftn.CHP-16-FN-25">171</a>]</sup> If you have kept to the paths suggested in this book.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-26" id="ftn.CHP-16-FN-26">172</a>]</sup> <a class="ulink" href="http://nagios-demo.netways.de/">http://nagios-demo.netways.de/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-27" id="ftn.CHP-16-FN-27">173</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/Image_Packs.75.0.html">http://www.nagiosexchange.org/Image_Packs.75.0.html</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="16.5 Configuration Changes through the Web Interfaces: the Restart Problem">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="configuration_changes_through_the_web_i"/>16.5 Configuration Changes through the Web Interfaces: the Restart Problem</h1>
    </div>

    <p>The CGI program <strong class="userinput"><code>cmd.cgi</code></strong> (<a class="xref" href="../Text/ch16s02.html#interface_for_external_commands_colon_c" title="16.2.3 Interface for external commands: cmd.cgi">16.2.3 Interface for external commands: cmd.cgi</a>, page 343) enables a series of changes to be made to the current configuration through the Web interface.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-28" id="CHP-16-FN-28">174</a>]</sup> In this way notifications or active checks can be switched on and off, for example.<a class="indexterm" id="IDX-CHP-16-1304"/><a class="indexterm" id="IDX-CHP-16-1305"/><a class="indexterm" id="IDX-CHP-16-1306"/></p>

    <p>Nagios does not save such changes in the accompanying configuration file, but notes the the current status in a separately defined file, with the parameter <strong class="userinput"><code>state_retention_file in nagios.cfg</code></strong> (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). But what happens if you restart Nagios after many changes using the Web interface?<a class="indexterm" id="IDX-CHP-16-1307"/><a class="indexterm" id="IDX-CHP-16-1308"/></p>

    <p>Whether Nagios retains the interactive changes made after a restart or forgets them is dependent on the parameter <strong class="userinput"><code>retain_state_informationin</code></strong> the configuration file <strong class="userinput"><code>nagios.cfg</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). The default <strong class="userinput"><code>0</code></strong> tells the system to forget interactive changes. For Nagios to remember this, you have to set</p><a id="I_programlisting1_d1e32895"/>
    <pre class="programlisting"># /etc/nagios/nagios.cfg
...
retain_state_information=1
...</pre>

    <p>But this causes a new problem: settings made in the Web interface do not have priority over the details in the configuration files. If you change the <strong class="userinput"><code>active_checks_enabled</code></strong> parameter there for a service, a direction of the parameter in the configuration file is ignored, since the current, temporarily stored setting in the file defined with <strong class="userinput"><code>state_retention_file</code></strong> will always "win out." This behavior affects all parameters for external commands that can be changed in the interface, and therefore also via the CGI program <strong class="userinput"><code>cmd.cgi</code></strong>. The original documentation of Nagios<sup>[<a class="footnote" href="#ftn.CHP-16-FN-29" id="CHP-16-FN-29">175</a>]</sup> labels these with a red star.<a class="indexterm" id="IDX-CHP-16-1309"/></p>

    <p>Two approaches provide a remedy in this case: on the one hand you can set the parameter <strong class="userinput"><code>retain_state_information</code></strong> to <strong class="userinput"><code>0</code></strong> shortly before a restart. Then Nagios forgets all the changes when it restarts and reads the configuration files in from scratch. This procedure is recommended only in exceptional cases, as in large environments it will hardly be possible to go through all the interactive changes in the configuration files. Alternatively you can get into the habit, whenever you make changes in the configuration file, of making them a second time in the Web interface. Although this means slightly more work, there is never a danger that current, and perhaps very important settings, will be lost.</p>

    <p>Two additional parameters in the host and service definitions provide opportunities for fine-tuning:</p><a id="I_programlisting1_d1e32930"/>
    <pre class="programlisting">define host{
   ...
   retain_status_information    1
   retain_nonstatus_information 1
   ...
}
define service{
   ...
   retain_status_information    1
   retain_nonstatus_information 1
   ...
}</pre>

    <p><strong class="userinput"><code>retain_status_information</code></strong> specifies whether the current state of ahost or service should survive the Nagios restart: <strong class="userinput"><code>1</code></strong> means that the system temporarily stores the state, and <strong class="userinput"><code>0</code></strong>, that it forgets it. <strong class="userinput"><code>1</code></strong> is certainly the more sensible value for states, and you should depart from this only in cases that can be justified.<a class="indexterm" id="IDX-CHP-16-1310"/><a class="indexterm" id="IDX-CHP-16-1311"/></p>

    <p><strong class="userinput"><code>retain_nonstatus_information</code></strong>, on the other hand, refers to all information that describes <span class="emphasis"><em>no</em></span> status. This includes, for example, whether active checks are switched on or off, whether passive checks are allowed or not, or whether admins are to be informed of status changes for this object. With a value of <strong class="userinput"><code>1</code></strong>, the system stores this information temporarily and uses it again after a restart, whereas with a value of <strong class="userinput"><code>0</code></strong>, Nagios forgets the current settings and reads the settings from the configuration file when it restarts.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-28" id="ftn.CHP-16-FN-28">174</a>]</sup> The CGI program makes use of the External Command File interface when doing this.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-29" id="ftn.CHP-16-FN-29">175</a>]</sup> Nagios 2.x: <strong class="userinput"><code>/usr/local/nagios/share/docs/xodtemplate.html</code></strong>, Nagios 3.0: <strong class="userinput"><code>/usr/local/nagios/docs/objectdefinitions.html</code></strong></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="16.6 Modern Layout with the Nuvola Style">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="modern_layout_with_the_nuvola_style"/>16.6 Modern Layout with the Nuvola Style</h1>
    </div>

    <p>The classical view of the Nagios Web interface described so far uses only a few of the CGI configuration options. However, it is hardly possible to pack any more items into the navigation bar on the left, which has become somewhat amateurish in appearance. One solution to this is the Nuvola style, shown in <a class="xref" href="../Text/ch16s06.html#nagios_in_the_nuvola_style_colon_shown" title="Figure 16-46. Nagios in the Nuvola style: shown here are the Service Problems">Figure 16-46</a>.<a class="indexterm" id="IDX-CHP-16-1313"/><a class="indexterm" id="IDX-CHP-16-1314"/><a class="indexterm" id="IDX-CHP-16-1312"/></p>

    <p>The layout for the actual CGI program—this example shows a view of the service problems with u<strong class="userinput"><code>status.cgi</code></strong> on the right of the picture—is not only in color, but there are also new icons. On the left of the picture you can see the rather elegant navigation, spiced up with corresponding icons. The real highlight, though, is the use of a Javascript-based menu tree: The individual entries (such as the sections <span class="strong"><strong>Home, Monitoring, Reporting</strong></span>, and <span class="strong"><strong>Configuration</strong></span>) can be opened and closed via mouse click.</p>

    <div class="figure">
      <a id="nagios_in_the_nuvola_style_colon_shown"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e32998"/><img alt="Nagios in the Nuvola style: shown here are the Service Problems" src="../Images/tagoreillycom20081104nostarchimages223934.png.jpg"/></div>

      <p class="title">Figure 16-46. Nagios in the Nuvola style: shown here are the Service Problems</p>
    </div>

    <p>Before installing the Nuvola style it is essential that you back up the directory <strong class="userinput"><code>/usr/local/nagios/share</code></strong> so that you can restore the old setup if you don't like the new one.</p>

    <p>The current version 1.0.3 of Nuvola from NagiosExchange<sup>[<a class="footnote" href="#ftn.CHP-16-FN-30" id="CHP-16-FN-30">176</a>]</sup> at the time of going to press is from September 2005, but it does work very well with Nagios 3.0 as well. The contents are unpacked into a suitable empty directory:</p><a id="I_programlisting1_d1e33014"/>
    <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/src; mkdir nuvola; cd nuvola</strong></span>
linux:src/nuvola # <span class="strong"><strong>tar xvz<span class="emphasis"><em>fpfad/zu</em></span>/nagios-nuvola-1.0.3.tar.gz</strong></span>
...
linux:src/nuvola # <span class="strong"><strong>cd html</strong></span></pre>

    <p>The sources contain files (<strong class="userinput"><code>index.html, main.html</code></strong>) and directories (<strong class="userinput"><code>stylesheets, images</code></strong>) that already exist in Nagios, and they overwrite the originals during installation. In addition, the Nuvola style includes a new subdirectory, <strong class="userinput"><code>side</code></strong>, which contains the actual Javascript code for the tree navigation:</p><a id="I_programlisting1_d1e33038"/>
    <pre class="programlisting">linux:nuvola/html # <span class="strong"><strong>tree</strong></span>
|-- config.js
|-- images
|   |
... ...
|-- index.html
|-- main.html
|-- side
|  |-- apytmenu.css
|  |-- apytmenu.js
|  |-- apytmenu_data.js
... ...
|  |-- dtree.css
|  |-- dtree.js
|  |-- dtree_data.js
... ...
|  |-- icons
|  |  |
... ...
|-- sidel.html
'-- stylesheets
    |
... ...
5 directories, 175 files</pre>

    <p>The contents of the directory <strong class="userinput"><code>html</code></strong> are simply copied to <strong class="userinput"><code>/usr/local/share</code></strong>, for example, with <strong class="userinput"><code>rsync:</code></strong></p><a id="I_programlisting1_d1e33053"/>
    <pre class="programlisting">linux:nuvola/html # <span class="strong"><strong>rsync -av. /usr/local/nagios/share/</strong></span>.
...</pre>

    <p>For the new navigation to appear, the file <strong class="userinput"><code>sidel.html</code></strong> must be installed. If you just rename it to <strong class="userinput"><code>side.html</code></strong>, though, the <strong class="userinput"><code>make install</code></strong> of a new Nagios version will just overwrite it again. So it is better to use a separate index file instead, such as <strong class="userinput"><code>index1.html</code></strong>, and run the Nagios Web interface from this:</p><a id="I_programlisting1_d1e33073"/>
    <pre class="programlisting">http://<span class="emphasis"><em>nagiosserver</em></span>/nagios/index1.html</pre>

    <p>To do this, you copy the <strong class="userinput"><code>index.html</code></strong> file included in Nuvola to the Nagios <strong class="userinput"><code>share</code></strong> directory with the name <strong class="userinput"><code>index1.html:</code></strong></p><a id="I_programlisting1_d1e33088"/>
    <pre class="programlisting">linux:nuvola/html # <span class="strong"><strong>cp index.html/usr/local/nagios/share/index1.html</strong></span></pre>

    <p>In the file <strong class="userinput"><code>index1.html</code></strong> you replace <strong class="userinput"><code>side.html</code></strong> with <strong class="userinput"><code>side1.html</code></strong> so that the Javascript navigation is called:</p><a id="I_programlisting1_d1e33103"/>
    <pre class="programlisting">...
document.write('&lt;FRAME SCROLLING="no" SRC="<span class="strong"><strong>side1.html</strong></span>" NAME="side"
...
...</pre>

    <p>If, like the author of this book, you consider it to be going over the top to change the styles of all the CGI programs, you can just pick out the improved navigation and supplement and redesign this as you think fit. Instead of making a complete copy of the directory <strong class="userinput"><code>html</code></strong>, you just select the files you require:</p><a id="I_programlisting1_d1e33113"/>
    <pre class="programlisting">linux:nuvola/html # <span class="strong"><strong>cp -r side /usr/local/nagios/share/</strong></span>.
                linux:nuvola/html # <span class="strong"><strong>cp side1.html config.js/usr/local/nagios/share/</strong></span>.
                linux:nuvola/html # <span class="strong"><strong>cp index.html/usr/local/nagios/share/index1.html</strong></span></pre>

    <p>You change the file <strong class="userinput"><code>index1.html</code></strong> as we have just shown and check the <strong class="userinput"><code>cgipath</code></strong> variable in <strong class="userinput"><code>config.js:</code></strong></p><a id="I_programlisting1_d1e33133"/>
    <pre class="programlisting">...
var cgipath = "/nagios/cgi-bin/";
...</pre>

    <p>Nuvola uses a ready-made menu tree library, which is available in a commercial version called <strong class="userinput"><code>apytmenu</code></strong>,<sup>[<a class="footnote" href="#ftn.CHP-16-FN-31" id="CHP-16-FN-31">177</a>]</sup> which will not be discussed here, or in a free variation, dTree.<sup>[<a class="footnote" href="#ftn.CHP-16-FN-32" id="CHP-16-FN-32">178</a>]</sup> dTree is the default setting in <strong class="userinput"><code>config.js (treeType = 'dtree'</code></strong>) and is included in full. Configuration of the menu and trees is done in the file <strong class="userinput"><code>dtree_data.js</code></strong> in the directory <strong class="userinput"><code>side</code></strong>. The basic principle can be briefly explained using the <span class="strong"><strong>Home</strong></span> menu as an example:</p><a id="I_programlisting1_d1e33162"/>
    <pre class="programlisting">general = new dTree('general');
general.header( 'Home', '<span class="emphasis"><em>icon</em></span>', ...);
general.add(0,-1);
general.add(1, 0,'Documentation','docs/index.html', ... );
document.write(general);</pre>

    <p>The <strong class="userinput"><code>dTree</code></strong> function generates a new menu tree. Its parameter is a freely selectable identifier (in this case, <strong class="userinput"><code>general</code></strong>), which is used to reference the tree. <strong class="userinput"><code>general.header</code></strong> sets the title of the menu to <strong class="userinput"><code>Home</code></strong>. The function requires other parameters as well, including an icon (as shown).</p>

    <p>The first <strong class="userinput"><code>general.add</code></strong> call anchors the tree still to be created. The first two parameters of the <strong class="userinput"><code>add</code></strong> function refer to the number of the node to be added, followed by its parent node. The topmost node is called <strong class="userinput"><code>0</code></strong>, and beneath this is the entry <strong class="userinput"><code>Documentation</code></strong>, to which the number <strong class="userinput"><code>1</code></strong> is assigned. If <strong class="userinput"><code>Documentation</code></strong> itself is to have subnodes, the invocations would be written as follows:</p><a id="I_programlisting1_d1e33202"/>
    <pre class="programlisting">general.add(2, 1, <span class="emphasis"><em>'new_entry'</em></span>, ...);
general.add(3, 1, <span class="emphasis"><em>'new_entry'</em></span>, ...);
general.add(4, 1, <span class="emphasis"><em>'new_entry'</em></span>, ...);</pre>

    <p>Finally <strong class="userinput"><code>document.write</code></strong> builds the entire menu tree. The <strong class="userinput"><code>header</code></strong> function has the following parameters:</p><a id="I_programlisting1_d1e33221"/>
    <pre class="programlisting"><span class="emphasis"><em>menu_name</em></span>. header(<span class="emphasis"><em>title, icon, height, background image, background color</em></span>, open);</pre>

    <div class="variablelist">
      <dl>
        <dt><span class="term"><strong class="userinput"><code><em class="replaceable"><code>title</code></em></code></strong></span></dt>

        <dd>
          <p>contains the heading and can also be set up as a URL. A mouse click on the heading opens the hyperlink specified.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code><em class="replaceable"><code>icon</code></em></code></strong></span></dt>

        <dd>
          <p>specifies the path to a small graphic that is displayed in front of the heading.</p>
        </dd>

        <dt><span class="term"><strong class="userinput"><code><em class="replaceable"><code>height</code></em></code></strong></span></dt>

        <dd>
          <p>specifies the height of the background beneath the heading. Following this, the property of this background can be specified either as a background image, with <strong class="userinput"><code><em class="replaceable"><code>backgroundimage</code></em></code></strong>, or as a color (<strong class="userinput"><code><em class="replaceable"><code>background colorw</code></em></code></strong>).</p>
        </dd>
      </dl>
    </div>

    <p>Finally <strong class="userinput"><code><em class="replaceable"><code>open</code></em></code></strong> specifies whether the menu tree should be open (<strong class="userinput"><code>1</code></strong>) or closed (<strong class="userinput"><code>0</code></strong>) at the start. Arguments specifying textual values are enclosed in single quotes, and numerical arguments are written directly, as shown in the examples.</p>

    <p>The <strong class="userinput"><code>add</code></strong> function is invoked in a similar way:</p><a id="I_programlisting1_d1e33278"/>
    <pre class="programlisting"><span class="emphasis"><em>menu_name</em></span>.add(<span class="emphasis"><em>id, pid, name</em></span>,
<span class="emphasis"><em>url, title, target, icon</em></span>,varlistentry58
<span class="emphasis"><em>iconOpen, open, css)</em></span></pre>

    <p><strong class="userinput"><code><em class="replaceable"><code>id</code></em></code></strong> is the node number, and <strong class="userinput"><code><em class="replaceable"><code>pid</code></em></code></strong> is the number of the node beneath which the entry should be integrated. <strong class="userinput"><code><em class="replaceable"><code>name</code></em></code></strong> defines the name of the node in the menu, and <strong class="userinput"><code><em class="replaceable"><code>url</code></em></code></strong> defines the hyperlink to be called. <strong class="userinput"><code><em class="replaceable"><code>title</code></em></code></strong> and <strong class="userinput"><code><em class="replaceable"><code>target</code></em></code></strong> optionally specify a page title and the target frame for displaying the page called via <span class="emphasis"><em>url</em></span>. Both parameters normally remain empty here; the default for the target—correctly for Nagios—is the frame <strong class="userinput"><code>main</code></strong>.</p>

    <p><strong class="userinput"><code><em class="replaceable"><code>icon</code></em></code></strong> defines the mini-graphic that is placed in front of the menu entry, and <strong class="userinput"><code><em class="replaceable"><code>iconOpen</code></em></code></strong> optionally contains another icon that is used in its place when the menu entry is open. <strong class="userinput"><code><em class="replaceable"><code>open</code></em></code></strong> again defines whether the entry should be opened (value <strong class="userinput"><code>1</code></strong>) or closed (value <strong class="userinput"><code>0</code></strong>) on starting, and <strong class="userinput"><code><em class="replaceable"><code>css</code></em></code></strong> optionally allows an alternative CSS definition. For all optional parameters, the following applies: If they are at the end, they can be omitted, but if they are followed by other details, their omission must be marked by a pair of single quotation marks (<strong class="userinput"><code><em class="replaceable"><code>''</code></em></code></strong>).</p>

    <p>The included file <strong class="userinput"><code><em class="replaceable"><code>dtree_data.js</code></em></code></strong> contains four extensive menus. If you have little experience with handling Javascript, it is best to save this template and adjust it in small steps. In case of error, information is very sparse and usually misleading, so it is particularly important that you note exactly what has been changed from one step to the next in order to be able to quickly isolate the error.</p>

    <p>At this point we would like to mention the dTree homepage<sup>[<a class="footnote" href="#ftn.CHP-16-FN-33" id="CHP-16-FN-33">179</a>]</sup> once again, which provides examples with extracts of code, along with a description of the programming interface.</p>

    <p>Those who are not satisfied with the possibilities of the Nagios Web interface described in this chapter should take a look at NagVis (<a class="xref" href="../Text/ch18.html" title="Chapter 18. NagVis">Chapter 18</a> from page 389). The addon enables a freely definable interface and supplements the standard CGIs in an impressive manner. However, a prerequisite for NagVis is the installation of the database interface NDOUtils (<a class="xref" href="../Text/ch17.html" title="Chapter 17. Flexible Web Interface with the NDOUtils">Chapter 17</a> from page 375), which sets the installation hurdle slightly higher.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-30" id="ftn.CHP-16-FN-30">176</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/75;252">http://www.nagiosexchange.org/75;252</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-31" id="ftn.CHP-16-FN-31">177</a>]</sup> <a class="ulink" href="http://dhtml-menu.com/">http://dhtml-menu.com/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-32" id="ftn.CHP-16-FN-32">178</a>]</sup> <a class="ulink" href="http://www.destroydrop.com/javascripts/tree/">http://www.destroydrop.com/javascripts/tree/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-16-FN-33" id="ftn.CHP-16-FN-33">179</a>]</sup> <a class="ulink" href="http://www.destroydrop.com/javascripts/tree/">http://www.destroydrop.com/javascripts/tree/</a></p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;17.&#xA0;Flexible Web Interface with the NDOUtils">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="flexible_web_interface_with_the_ndoutils"/>Chapter 17. Flexible Web Interface with the NDOUtils</h1>
    </div>

    <p>The Web interface of Nagios 2.x ansd 3.0, introduced in <a class="xref" href="../Text/ch16.html" title="Chapter 16. The Classical Web Interface">Chapter 16</a> from page 327, has a crucial disadvantage for large environments with hundreds of hosts: It cannot be scaled up. As long as you only observe error states and work intensively with acknowledges, you will manage fine with the CGI-based Web interface. But if you try to display several thousand services, you will have to be prepared to wait—it does not matter what their states are. Setting up the page can take a long time, and then practical work is hardly possible.<a class="indexterm" id="IDX-CHP-17-1316"/><a class="indexterm" id="IDX-CHP-17-1315"/></p>

    <p>Nagios extensions struggle with the CGI Web interface because this directly evaluates Nagios internals, such as object configuration, status data, and log files. This means that every extension that is used to supplement or replace the Web interface must follow this logic.</p>

    <p>The solution to this is called NDOUtils (<span class="emphasis"><em>Nagios Data Objects Utilities</em></span>). These consist of a handful of tools that write all data—from configuration through events and check results to historical records—to a database and make them available via a uniform database model.</p>

    <p>The mechanism that connects the NDOUtils to Nagios is called <span class="emphasis"><em>Nagios Event Broker</em></span> (NEB). This adds a modular interface to Nagios. The NEB loads the extensions as modules when Nagios starts so that the modules can be used without having to recompile Nagios. This approach is similar to that of the Apache modules, which are loaded when required and add new functions to the Web server.<a class="indexterm" id="IDX-CHP-17-1317"/></p>

    <p>The NDOUtils form the basis for the future Web interface of Nagios, implemented with PHP, which should see the light of day starting with Nagios 4.x. With NagVis (see <a class="xref" href="../Text/ch18.html" title="Chapter 18. NagVis">Chapter 18</a> from page 389), however, there is already an alternative Web interface that is based on the NDOUtils.<a class="indexterm" id="IDX-CHP-17-1318"/></p>

    <div class="sect1" title="17.1 The Event Broker">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="the_event_broker"/>17.1 The Event Broker</h1>
      </div>

      <p>The NEB provides an interface between Nagios and external modules based on shared libraries. An external, application-dependent module makes <span class="emphasis"><em>callback functions</em></span> available. The Nagios kernel itself calls the accompanying callback function from the loaded module for every event: If there is no matching function, nothing happens. What actions the callback function executes is left to the imagination of the developer: Either it does something itself or it passes on configuration, status, and event data to an external application, as outlined in <a class="xref" href="../Text/ch17.html#an_external_application_communicates_wit" title="Figure 17-1. An external application communicates with a loaded NEB module">Figure 17-1</a>.<a class="indexterm" id="IDX-CHP-17-1319"/><a class="indexterm" id="IDX-CHP-17-1320"/><a class="indexterm" id="IDX-CHP-17-1321"/></p>

      <p>For the transfer of data to external tools, Unix sockets or network sockets can be used, although it is also possible to use the file system. The application further processes information (saves it in a database, for example, or sends it as messages via SNMP traps, writes it to the syslog, etc.).</p>

      <div class="figure">
        <a id="an_external_application_communicates_wit"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject2_d1e33430"/><img alt="An external application communicates with a loaded NEB module" src="../Images/tagoreillycom20081104nostarchimages223936.png.jpg"/></div>

        <p class="title">Figure 17-1. An external application communicates with a loaded NEB module</p>
      </div>

      <p>When a callback function is called, Nagios waits for it to finish. This means that long execution times hinder the system. For this reason callback functions should always leave time-consuming processing steps to an external application and be restricted to sending on the necessary information as quickly as possible.</p>

      <p>Building event broker modules is something that should be left to experienced programmers; mere mortals must be content with using ready-made modules. An NEB module can be integrated via the instruction <strong class="userinput"><code>broker_module</code></strong> in the main configuration file <strong class="userinput"><code>nagios.cfg:</code></strong></p><a id="I_programlisting2_d1e33444"/>
      <pre class="programlisting"># /etc/nagios/nagios.cfg
...
broker_module=<span class="emphasis"><em>module-with-path arguments</em></span>
event_broker_options=-1</pre>

      <p>Whether you pass on arguments to the module or not depends on its concrete implementation. The parameter <strong class="userinput"><code>event_broker_options</code></strong> controls what information Nagios passes on to event broker modules. With the option <strong class="userinput"><code>−1</code></strong> it is all of them, while the value 0 prevents any information from being passed on. An alternate approach, of selectively passing on specific information, is provided by the file <strong class="userinput"><code>broker.h</code></strong> from the Nagios sources:<a class="indexterm" id="IDX-CHP-17-1322"/></p><a id="I_programlisting2_d1e33463"/>
      <pre class="programlisting">/* broker.h from the Nagios sources */
...
/*************** EVENT BROKER OPTIONS *****************/

#define BROKER_NOTHING                  0
#define BROKER_EVERYTHING               1048575

#define BROKER_PROGRAM_STATE            1      /* DONE */
...
#define BROKER_DOWNTIME_DATA            512    /* DONE */
...
#define BROKER_STATUS_DATA              4096   /* DONE */
...
#define BROKER_RETENTION_DATA           32768  /* DONE */
#define BROKER_ACKNOWLEDGEMENT_DATA     65536</pre>

      <div class="table">
        <a id="data_to_be_transferred_to_nagvis"/>

        <p class="title">Table 17-1. Data to be transferred to NagVis</p>

        <div class="table-contents">
          <table class="sgc-3" summary="Data to be transferred to NagVis">
            <colgroup>
              <col/>
              <col/>
              <col/>
            </colgroup>

            <thead>
              <tr>
                <th class="sgc-1" valign="bottom">
                  <p>Broker Option</p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Value</p>
                </th>

                <th class="sgc-1" valign="bottom">
                  <p>Explanation</p>
                </th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>BROKER_PROGRAM_STATE</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>1</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Is the program Nagios running</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>BROKER_DOWNTIME_DATA</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>512</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Details of planned maintenance periods</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>BROKER_STATUS_DATA</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>4096</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Current status information of all checks</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>BROKER_RETENTION_DATA</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>32768</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Data which is buffered for a restart of Nagios</p>
                </td>
              </tr>

              <tr>
                <td class="sgc-2" valign="top">
                  <p><strong class="userinput"><code>BROKER_ACKNOWLEDGEMENT_DATA</code></strong></p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>65536</p>
                </td>

                <td class="sgc-2" valign="top">
                  <p>Confirmations that have been made on error states of host and service checks</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p>NagVis 1.1, introduced in <a class="xref" href="../Text/ch18.html" title="Chapter 18. NagVis">Chapter 18</a>, requires the information listed in <a class="xref" href="../Text/ch17.html#data_to_be_transferred_to_nagvis" title="Table 17-1. Data to be transferred to NagVis">Table 17-1</a>. The corresponding numerical values add up to <strong class="userinput"><code>102913</code></strong>, so that <strong class="userinput"><code>event_broker_options</code></strong> can be modified as follows so that is tailor-made for NagVis:<a class="indexterm" id="IDX-CHP-17-1323"/></p><a id="I_programlisting2_d1e33555"/>
      <pre class="programlisting"># /etc/nagios/nagios.cfg
...
event_broker_options=102913</pre>

      <p>Information on the event broker is currently very sparse. The only descriptions of the interface are a quite old documentation from Nagios 2.0 and the <span class="emphasis"><em>Nagios Event Broker API</em></span><sup>[<a class="footnote" href="#ftn.CHP-17-FN-1" id="CHP-17-FN-1">180</a>]</sup>.<a class="indexterm" id="IDX-CHP-17-1324"/><a class="indexterm" id="IDX-CHP-17-1325"/></p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-17-FN-1" id="ftn.CHP-17-FN-1">180</a>]</sup> <a class="ulink" href="http://www.nagios.org/developerinfo">http://www.nagios.org/developerinfo</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="17.2 The Database Interface">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_database_interface"/>17.2 The Database Interface</h1>
    </div>

    <p>As a concrete and practically-oriented application of the event broker concept, the Nagios data object utilities, or NDOUtils, save all configuration and event data to a database. In order to be able to make use of the database, further applications are required. For Nagios 4.x, this will in all probability be a newly designed, PHP-based Web interface. Whether this Nagios version will immediately manage all the configuration data in the database was still a matter of speculation at press time (when Nagios 3.0 was not quite finished).<a class="indexterm" id="IDX-CHP-17-1326"/><a class="indexterm" id="IDX-CHP-17-1327"/><a class="indexterm" id="IDX-CHP-17-1328"/><a class="indexterm" id="IDX-CHP-17-1329"/></p>

    <p>For the database, the NDOUtils currently support only MySQL; the use of PostgreSQL is planned, but is not yet implemented in version 1.4, introduced here.</p>

    <p>Since the NDOUtils addons provide a database interface that is relatively simple to use, it is expected that their use with Nagios 3.x will increase. NagVis (discussed in the next chapter from page 389) already provides a powerful NDO-based front end that in many cases can replace the status map, which remains relatively simple and is discussed in <a class="xref" href="../Text/ch16s02.html#the_topological_map_of_the_network_colo" title="16.2.5 The topological map of the network: statusmap.cgi">16.2.5 The topological map of the network: statusmap.cgi</a> from page 346.</p>

    <p><a class="xref" href="../Text/ch17s02.html#how_can_you_integrate_nagios_data_into" title="Figure 17-2. How can you integrate Nagios data into the NDOUtils database?">Figure 17-2</a> shows the various paths by which Nagios data can be imported into the NDOUtils database. Export of data from Nagios is handled by the event broker module ndomod. It can either operate a TCP or Unix socket, or write the data to a file. If Nagios is installed on the same computer as the NDOUtils database, the Unix socket interface will provide the best performance and the greatest security (Unix sockets cannot be addressed from a network, in contrast to TCP sockets). The socket of the ndo2db daemon that ultimately writes the data to a database is queried.<a class="indexterm" id="IDX-CHP-17-1330"/><a class="indexterm" id="IDX-CHP-17-1331"/></p>

    <p>The method using a file involves the utility FILE2SOCK, which reads in the file and also delivers data to the nd02db daemon via a TCP or Unix socket. FILE2SOCK can also read data from the standard input.<a class="indexterm" id="IDX-CHP-17-1332"/></p>

    <div class="figure">
      <a id="how_can_you_integrate_nagios_data_into"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject2_d1e33622"/><img alt="How can you integrate Nagios data into the NDOUtils database?" src="../Images/tagoreillycom20081104nostarchimages223938.png.jpg"/></div>

      <p class="title">Figure 17-2. How can you integrate Nagios data into the NDOUtils database?</p>
    </div>

    <p>For each database you need exactly one ndo2db daemon. If several different clients have access to the socket interface, it will start several processes to handle these.</p>

    <p>The program LOG2NDO is one of the NDOUtils. It reads log files from Nagios 2.x and 3.0 and passes this data to the ndo2db daemon—either directly via the socket interface or via a file that has to be separately imported with FILE2SOCK. If you want to integrate such historical data into the database, you will have to make plenty of storage space available, because the log files are compressed when they are archived but are saved in the database in uncompressed form. Thus the log files occupy more space when they are managed using the database.<a class="indexterm" id="IDX-CHP-17-1333"/></p>

    <p>FILE2SOCK and LOG2NDO are primarily used to import historical data. The data later required by NagVis is updated by Nagios at very short intervals. Since historical data is not required here, we shall not describe these two programs in any more detail.</p>
  </div>


  <div class="sect1" title="17.3 The Installation">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_installation"/>17.3 The Installation</h1>
    </div>

    <p>Since there are problems with <strong class="userinput"><code>INSERT</code></strong> statements in some tables of the NDOUtils database when MySQL in version 4.0 is used, it is better to use MySQL 5 right from the start.<sup>[<a class="footnote" href="#ftn.CHP-17-FN-2" id="CHP-17-FN-2">181</a>]</sup> In addition to the MySQL server package (in Debian, "Etch" <strong class="userinput"><code>mysql-server-5.0</code></strong>) and the libraries that are usually selected automatically during the installation of the server package, you also require the accompanying development package (in Debian, "Etch" <strong class="userinput"><code>libmysqlclient15-dev</code></strong>) in order to be able to compile the NDOUtils.<a class="indexterm" id="IDX-CHP-17-1335"/><a class="indexterm" id="IDX-CHP-17-1336"/><a class="indexterm" id="IDX-CHP-17-1334"/><a class="indexterm" id="IDX-CHP-17-1337"/></p>

    <p>One consequence of the far-reaching integration of the NDOUtils into Nagios is that the version must exactly match that of the Nagios version used. Both Nagios and the NDOUtils define their version status in the source code with the macro <strong class="userinput"><code>CURRENT_OBJECT_STRUCTURE_VERSION</code></strong>. The macro can be found in the file <strong class="userinput"><code>./include/objects.h</code></strong> in the Nagios source code (for Nagios 3.0, in this example):</p><a id="I_programlisting2_d1e33683"/>
    <pre class="programlisting">linux:src/nagios-3.0rc1 # <span class="strong"><strong>fgrep CURRENT_OBJECT_STRUCTURE_VERSION</strong></span> \
 <span class="strong"><strong>   include/objects.h</strong></span>
#define CURRENT_OBJECT_STRUCTURE_VERSION 307</pre>

    <p>The NDOUtils package contains two include files, one for Nagios 2.x and one for Nagios 3.x:</p><a id="I_programlisting2_d1e33693"/>
    <pre class="programlisting">linux:src/ndoutils-1.4b7 # <span class="strong"><strong>fgrep CURRENT_OBJECT_STRUCTURE_VERSION</strong></span> \
 <span class="strong"><strong>   include/*/objects.h</strong></span>
include/nagios-2x/objects.h:#define CURRENT_OBJECT_STRUCTURE_VERSION 2
include/nagios-3x/objects.h:#define CURRENT_OBJECT_STRUCTURE_VERSION 307</pre>

    <p>If the <strong class="userinput"><code>CURRENT_OBJECT_STRUCTURE_VERSION</code></strong> value of Nagios does not match one of the two values in the NDOUtils source code, the NDOUtils module will unload itself and refuse to perform. The procedure is documented in the log file <strong class="userinput"><code>nagios.log</code></strong> with an entry like the following (the two different versions are marked in bold type):</p><a id="I_programlisting2_d1e33709"/>
    <pre class="programlisting">[1186152181] ndomod: NDOMOD 1.4b4 (06-19-2007) Copyright (c) 2005 -2007
Ethan Galstad (nagios@nagios.org)
[1186152181] ndomod: I've been compiled with support for <span class="strong"><strong>revision 303</strong></span> of
the internal Nagios object structures, but the Nagios daemon is currentl
y using <span class="strong"><strong>revision 304</strong></span>. I'm going to unload so I don't cause any probl...</pre>

    <div class="sect2" title="17.3.1 Compiling the source code">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="compiling_the_source_code"/>17.3.1 Compiling the source code</h2>
      </div>

      <p>The up-to-date NDOUtils code can be downloaded from the Nagios Web page<sup>[<a class="footnote" href="#ftn.CHP-17-FN-3" id="CHP-17-FN-3">182</a>]</sup> and then unpacked to a suitable directory:<a class="indexterm" id="IDX-CHP-17-1338"/></p><a id="I_programlisting2_d1e33731"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/src/nagios</strong></span>
linux:src/nagios # <span class="strong"><strong>tar xvzf</strong></span> <span class="bolditalic">/path/to/</span><span class="strong"><strong>ndoutils-1.4b7.tar.gz</strong></span>
...
linux:src/nagios # <span class="strong"><strong>cd ndoutils-1.4b7</strong></span>
linux:nagios/ndoutils-1.4.b7 # <span class="strong"><strong>./configure --sysconfdir=/etc</strong></span>
...
linux:nagios/ndoutils-1.4.b7 # <span class="strong"><strong>make</strong></span>
...</pre>

      <p>We start the <strong class="userinput"><code>configure</code></strong> run with the switch <strong class="userinput"><code>--sysconfdir=/etc</code></strong> in order to install the configuration files for the module and daemon to match the convention in this book, that is, to the directory <strong class="userinput"><code>/etc/nagios</code></strong>. The <strong class="userinput"><code>make</code></strong> call compiles the program code, and the installation is then done manually:</p><a id="I_programlisting2_d1e33768"/>
      <pre class="programlisting">linux:nagios/ndoutils-1.4.b7 # <span class="strong"><strong>cd ./src</strong></span>
linux:ndoutils-1.4.b7/src # <span class="strong"><strong>cp ndo2db-3x ndomod-3x.o log2ndo file2sock</strong></span> \
 <span class="strong"><strong>   /usr/local/nagios/bin/</strong></span></pre>

      <p>For Nagios 2.x the daemon <strong class="userinput"><code>ndo2db-2x</code></strong> and the module <strong class="userinput"><code>ndomod-2x.o</code></strong> are copied to <strong class="userinput"><code>/usr/local/nagios/bin</code></strong> instead of the 3.x versions.</p>
    </div>

    <div class="sect2" title="17.3.2 Preparing the MySQL database">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="preparing_the_mysql_database"/>17.3.2 Preparing the MySQL database</h2>
      </div>

      <p>In the MySQL database system, we require a database storing appropriate access options for the user <strong class="userinput"><code>nagios</code></strong>. In order to set this up, we first log in to MySQL as the user <strong class="userinput"><code>root:</code></strong><a class="indexterm" id="IDX-CHP-17-1339"/><a class="indexterm" id="IDX-CHP-17-1340"/><a class="indexterm" id="IDX-CHP-17-1341"/></p><a id="I_programlisting2_d1e33814"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>mysql --user=root -p</strong></span>
Enter password: <span class="emphasis"><em>root-passwort_for_the_db</em></span>
Welcome to the MySQL monitor. Commands end with ; or \g.
Your MySQL connection id is 1861
Server version: 5.0.32-Debian_7etch1 Debian etch distribution

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt;</pre>

      <p>The switch <strong class="userinput"><code>-p</code></strong> ensures that the password is requested. The following command tests whether a password is set or not:</p><a id="I_programlisting2_d1e33827"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>mysql --user=root</strong></span></pre>

      <p>If the login triggered by this works without an error message, then the <strong class="userinput"><code>root</code></strong> password is missing. This should be specified with the command</p><a id="I_programlisting2_d1e33836"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>/usr/bin/mysqladmin -u root password</strong></span> <span class="bolditalic">'secret'</span></pre>

      <p>You should replace <strong class="userinput"><code><em class="replaceable"><code>secret</code></em></code></strong> with your own secure password.<sup>[<a class="footnote" href="#ftn.CHP-17-FN-4" id="CHP-17-FN-4">183</a>]</sup></p>

      <p>The database (it is given the name <strong class="userinput"><code>nagios</code></strong>) is created with the SQL command <strong class="userinput"><code>CREATE DATABASE</code></strong>, and it is then given the required permissions with <strong class="userinput"><code>GRANT:</code></strong></p><a id="I_programlisting2_d1e33867"/>
      <pre class="programlisting">mysql&gt; <span class="strong"><strong>CREATE DATABASE nagios;</strong></span>
Query OK, 1 row affected (0.01 sec)
mysql&gt; <span class="strong"><strong>GRANT USAGE ON *.* TO 'nagios'@'localhost' IDENTIFIED BY</strong></span> <span class="bolditalic">'secret'</span>
<span class="strong"><strong>   WITH MAX_QUERIES_PER_HOUR 0</strong></span>
<span class="strong"><strong>   MAX_CONNECTIONS_PER_HOUR 0</strong></span>
<span class="strong"><strong>   MAX_UPDATES_PER_HOUR 0 ;</strong></span>
Query OK, 0 rows affected (0.00 sec)
mysql&gt; <span class="strong"><strong>GRANT SELECT, INSERT, UPDATE, DELETE ON 'nagios'.*</strong></span>
<span class="strong"><strong>   TO 'nagios'@'localhost';</strong></span>
Query OK, 0 rows affected (0.01 sec)
mysql&gt; <span class="strong"><strong>FLUSH PRIVILEGES;</strong></span>
Query OK, 0 rows affected (0.00 sec)
mysql&gt; <span class="strong"><strong>quit</strong></span></pre>

      <p>The <strong class="userinput"><code>GRANT USAGE</code></strong> command defines the user, along with his password, and specifies that for him there are no restrictions in the number of queries, database connections, or database updates per hour. For the password, something slighty more secure than <strong class="userinput"><code><em class="replaceable"><code>secret</code></em></code></strong> is chosen, but it must be written here in plain text. <strong class="userinput"><code>GRANT USAGE</code></strong> does not yet give any access permissions to the tables of the <strong class="userinput"><code>nagios</code></strong> database. This is handled by the second <strong class="userinput"><code>GRANT</code></strong> command. The changes to the permissions of the <strong class="userinput"><code>nagios</code></strong> user are activated with <strong class="userinput"><code>FLUSH PRIVILEGES</code></strong>.</p>

      <p>The NDOUtils require <strong class="userinput"><code>SELECT</code></strong>, <strong class="userinput"><code>INSERT</code></strong>, <strong class="userinput"><code>UPDATE</code></strong>, and <strong class="userinput"><code>DELETE</code></strong> permissions. For NagVis and other applications, which only read data from the database, the <strong class="userinput"><code>SELECT</code></strong> permission is sufficient.</p>

      <p>In the next step the tables are generated in which the NDOUtils will later save data. A finished SQL script in the <strong class="userinput"><code>db</code></strong> subdirectory of the NDOUtils sources is provided for this purpose, and needs only to be executed:</p><a id="I_programlisting2_d1e33947"/>
      <pre class="programlisting">user@linux:src/ndoutils-1.4b7$ <span class="strong"><strong>cd db</strong></span>
user@linux:ndoutils-1.4b7/db$ <span class="strong"><strong>mysql -u root -p nagios &lt; mysql.sql</strong></span></pre>

      <p>The script should run without error in all cases (meaning without any messages). The tables created can be shown with the SQL command <strong class="userinput"><code>show tables</code></strong>.</p>

      <p>Various distributions install MySQL by default with logging switched on. With the (usually binary) log files, the current status of the database can be replicated or restored. In combination with the NDOUtils, however, these log files grow very quickly. If you are using the database only for the NDOUtils, you will need such tools only in rare cases, and you can therefore comment out all the <strong class="userinput"><code>*log*</code></strong> parameters in the <strong class="userinput"><code>my.cnf</code></strong> configuration file and restart MySQL—this time without logging.</p>
    </div>

    <div class="sect2" title="17.3.3 Upgrading the database design">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="upgrading_the_database_design"/>17.3.3 Upgrading the database design</h2>
      </div>

      <p>Since the NDOUtils are actively undergoing development, larger changes to the database structure cannot be ruled out. For an upgrade, it is possible that the database design must also be changed. The NDOUtils provide a script for this purpose, <strong class="userinput"><code>upgradedb</code></strong> in the subdirectory <strong class="userinput"><code>db</code></strong>, which automatically adjusts the tables:<a class="indexterm" id="IDX-CHP-17-1342"/><a class="indexterm" id="IDX-CHP-17-1343"/><a class="indexterm" id="IDX-CHP-17-1344"/><a class="indexterm" id="IDX-CHP-17-1345"/></p><a id="I_programlisting2_d1e34001"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/src/nagios/ndoutils-1.4b7/db</strong></span>
linux:ndoutils-1.4b7/db # <span class="strong"><strong>./upgradedb -u root -p</strong></span> <span class="bolditalic">password</span> \
<span class="strong"><strong>-h localhost -d nagios</strong></span>
Current database version: 1.4b5
<span class="strong"><strong>**</strong></span> DB upgrade required for 1.4b7
    Using mysql-upgrade-1.4b5.sql for upgrade...
<span class="strong"><strong>**</strong></span> Upgrade to 1.4b7 complete</pre>

      <p>The script detects the existing NDOUtils version and adjusts the tables accordingly. Among other things, it uses the SQL command <strong class="userinput"><code>ALTER TABLE</code></strong>, for which the MySQL user <strong class="userinput"><code>nagios</code></strong>, created in the last section, does not have sufficient permissions. The script therefore needs to be run as the MySQL user <strong class="userinput"><code>root</code></strong>.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-17-FN-2" id="ftn.CHP-17-FN-2">181</a>]</sup> The author has tested version 5.0.23, but there are also reports of NDOUtils working successfully with MySQL 4.1.x.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-17-FN-3" id="ftn.CHP-17-FN-3">182</a>]</sup> <a class="ulink" href="http://www.nagios.org/download/">http://www.nagios.org/download/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-17-FN-4" id="ftn.CHP-17-FN-4">183</a>]</sup> Further notes on the secure adminstration of MySQL can be found in the online documentation at <a class="ulink" href="http://www.mysql.org/doc/refman/5.0/en/security-guidelines.html">http://www.mysql.org/doc/refman/5.0/en/security-guidelines.html</a> and possibly in the documentation delivered with the distribution under <strong class="userinput"><code>/usr/share/doc/</code></strong>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="17.4 Configuration">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="configuration"/>17.4 Configuration</h1>
    </div>

    <p>The NDOUtils are configured at three different locations. The file <strong class="userinput"><code>ndomod.cfg</code></strong> specifies the settings for the Event Broker module. <strong class="userinput"><code>ndo2db.cfg</code></strong> controls the daemon <strong class="userinput"><code>ndo2db</code></strong>, which accepts data from the Broker and writes to the database. An entry in <strong class="userinput"><code>/etc/nagios/nagios.cfg</code></strong> finally ensures that Nagios loads the Event Broker module <strong class="userinput"><code>ndomod</code></strong> when it starts.<a class="indexterm" id="IDX-CHP-17-1346"/><a class="indexterm" id="IDX-CHP-17-1347"/></p>

    <p>The NDOUtils source code in the subdirectory <strong class="userinput"><code>./config</code></strong> provides a template for each of the two configuration files. The command</p><a id="I_programlisting2_d1e34065"/>
    <pre class="programlisting">linux:src/ndoutils-1.4b7 # <span class="strong"><strong>cp config/ndo*.cfg /etc/nagios/</strong></span>.</pre>

    <p>copies these, in accordance with the convention used in this book, to the directory <strong class="userinput"><code>/etc/nagios</code></strong>.</p>

    <div class="sect2" title="17.4.1 Adjusting the Event Broker configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="adjusting_the_event_broker_configuration"/>17.4.1 Adjusting the Event Broker configuration</h2>
      </div>

      <p>The template for <strong class="userinput"><code>ndomod.cfg</code></strong> can almost be used unchanged; you need to adjust only the path to the <strong class="userinput"><code>var</code></strong> directory:<a class="indexterm" id="IDX-CHP-17-1348"/><a class="indexterm" id="IDX-CHP-17-1349"/><a class="indexterm" id="IDX-CHP-17-1350"/><a class="indexterm" id="IDX-CHP-17-1351"/><a class="indexterm" id="IDX-CHP-17-1352"/><a class="indexterm" id="IDX-CHP-17-1353"/><a class="indexterm" id="IDX-CHP-17-1354"/><a class="indexterm" id="IDX-CHP-17-1355"/><a class="indexterm" id="IDX-CHP-17-1356"/><a class="indexterm" id="IDX-CHP-17-1357"/></p><a id="I_programlisting2_d1e34117"/>
      <pre class="programlisting"># /etc/nagios/ndomod.cfg
instance_name=default
output_type=unixsocket
output=<span class="strong"><strong>/var/nagios/ndo.sock</strong></span>
# tcp_port=5668
output_buffer_items=5000
buffer_file=<span class="strong"><strong>/var/nagios/ndomod.tmp</strong></span>
# file_rotation_command=rotate_ndo_log
# file_rotation_interval=14400
# file_rotation_timeout=60
reconnect_interval=15
reconnect_warning_interval=15
data_processing_options=-1
config_output_options=2</pre>

      <p><strong class="userinput"><code>instance_name</code></strong> refers to the instance in the database to be used. Provided that you map only one Nagios instance in the database, it is no problem to keep to the <strong class="userinput"><code>default</code></strong> settings. Assuming that Nagios and the <strong class="userinput"><code>ndo2db</code></strong> daemon are running on the same host, a Unix socket can be used as the <strong class="userinput"><code>output_type</code></strong>, the name of which is defined by the <strong class="userinput"><code>output</code></strong> parameter. <strong class="userinput"><code>tcp_port</code></strong> is used only for <strong class="userinput"><code>output_type=tcpsocket</code></strong> and is therefore commented out.</p>

      <p>In case the <strong class="userinput"><code>ndomod</code></strong> module cannot release data via the socket interface (because the daemon has just restarted, for instance), these are saved temporarily in the file <strong class="userinput"><code>buffer_file</code></strong>. The number of entries to be saved in this in the <strong class="userinput"><code>output_buffer_items</code></strong> parameter should not be set too low. A tried-and-tested rule of thumb here is to take the number of all defined host and service objects and multiply this by five. This is an empirical value: When reloaded, or when Nagios is restarted, the NDOUtils write the start state for each host and each service to the database, along with all planned and started checks. These might be supplemented by the results of new or still running checks.</p>

      <p>The <strong class="userinput"><code>file_rotation_*</code></strong> parameters are required only for <strong class="userinput"><code>output_type=file</code></strong>, which requires the use of the additional daemon <strong class="userinput"><code>FILE2SOCK</code></strong>. For reasons of performance it is recommended, however, that you use the socket interface instead of the file-based one. The file interface also makes the configuration more complex, due to additional daemons.</p>

      <p>The parameters <strong class="userinput"><code>reconnect_interval</code></strong> and <strong class="userinput"><code>reconnect_warning_interval</code></strong> are also intended for cases where a connection using the <strong class="userinput"><code>ndo2db</code></strong> daemon could not be established. They specify in seconds how often Nagios should try to make contact with them and how often a warning should appear in the log file if a connection is not established. These two parameters should be left as they are in the default.</p>
    </div>

    <div class="sect2" title="17.4.2 Configuring database access">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="configuring_database_access"/>17.4.2 Configuring database access</h2>
      </div>

      <p>There is also little to adjust in the template for the configuration file of the <strong class="userinput"><code>ndo2db</code></strong> daemon. Apart from the path to the socket interface, the relevant password for write access to the database must be specified here:<a class="indexterm" id="IDX-CHP-17-1358"/><a class="indexterm" id="IDX-CHP-17-1359"/><a class="indexterm" id="IDX-CHP-17-1360"/><a class="indexterm" id="IDX-CHP-17-1361"/><a class="indexterm" id="IDX-CHP-17-1362"/><a class="indexterm" id="IDX-CHP-17-1363"/><a class="indexterm" id="IDX-CHP-17-1364"/><a class="indexterm" id="IDX-CHP-17-1365"/><a class="indexterm" id="IDX-CHP-17-1366"/><a class="indexterm" id="IDX-CHP-17-1367"/><a class="indexterm" id="IDX-CHP-17-1368"/><a class="indexterm" id="IDX-CHP-17-1369"/><a class="indexterm" id="IDX-CHP-17-1370"/><a class="indexterm" id="IDX-CHP-17-1371"/></p><a id="I_programlisting2_d1e34232"/>
      <pre class="programlisting"># /etc/nagios/ndo2db.cfg
ndo2db_user=nagios
ndo2db_group=nagios
socket_type=unix
socket_name=<span class="strong"><strong>/var/nagios/ndo.sock</strong></span>
# tcp_port=5668
db_servertype=mysql
db_host=localhost
db_port=3306
db_name=nagios
db_prefix=nagios_
db_user=nagios
db_pass=<span class="bolditalic">secret</span>
max_timedevents_age=1440
max_systemcommands_age=1440
max_servicechecks_age=1440
max_hostchecks_age=1440
max_eventhandlers_age=10080</pre>

      <p>The two <strong class="userinput"><code>ndo2db_*</code></strong> parameters specify the user and group with whose permissions the daemon runs after the start. <strong class="userinput"><code>socket_type</code></strong> and <strong class="userinput"><code>socket_name</code></strong> must be set to the configuration in <strong class="userinput"><code>ndomod.cfg</code></strong>.<a class="indexterm" id="IDX-CHP-17-1372"/></p>

      <p>The only database type that can currently be specified <strong class="userinput"><code>db_servertype</code></strong> is <strong class="userinput"><code>mysql</code></strong>; for <strong class="userinput"><code>db_port</code></strong> the standard port of MySQL (<strong class="userinput"><code>3306</code></strong>) is normally entered. The database name in <strong class="userinput"><code>db_name</code></strong> must match the name selected in the <strong class="userinput"><code>CREATE DATABASE</code></strong> command (in this case, <strong class="userinput"><code>nagios</code></strong>), and the database user and password must also be given in the same way as described when setting up the database. The value of the parameter <strong class="userinput"><code>db_prefix</code></strong> should not be changed under any circumstances, otherwise the name of the tables to be created in the <strong class="userinput"><code>mysql.sql</code></strong> script must also be adjusted.<a class="indexterm" id="IDX-CHP-17-1374"/><a class="indexterm" id="IDX-CHP-17-1373"/></p>

      <p>The parameters beginning with <strong class="userinput"><code>max_*</code></strong> define in minutes how long the NDOUtils data on system commands, planned events, service and host checks, and event handlers<sup>[<a class="footnote" href="#ftn.CHP-17-FN-5" id="CHP-17-FN-5">184</a>]</sup> should be kept in the database. The value 1440 corresponds to one day. If you are using the NDOUtils only with NagVis, you won't need longer times. Short intervals go easy on the database, as well as the hard disk.</p>
    </div>

    <div class="sect2" title="17.4.3 Starting the ndo2db daemon">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="starting_the_ndo2db_daemon"/>17.4.3 Starting the <strong class="userinput"><code>ndo2db</code></strong> daemon</h2>
      </div>

      <p>When everything is configured, the <strong class="userinput"><code>ndo2db</code></strong> daemon is first called manually:<a class="indexterm" id="IDX-CHP-17-1375"/><a class="indexterm" id="IDX-CHP-17-1376"/><a class="indexterm" id="IDX-CHP-17-1377"/><a class="indexterm" id="IDX-CHP-17-1378"/></p><a id="I_programlisting2_d1e34337"/>
      <pre class="programlisting">/usr/local/nagios/bin/ndo2db-3x -c /etc/nagios/ndo2db.cfg</pre>

      <p>Later on it is recommended that you create an init script by copying and modifying the script <strong class="userinput"><code>/etc/init.d/skeleton</code></strong>, provided in the distribution. The daemon must match the Nagios version: <strong class="userinput"><code>ndo2db-3x</code></strong> works together with Nagios version 3.x, <strong class="userinput"><code>ndo2db-2x</code></strong> with version 2.x. After it has started you should look to see whether the socket specified in the configuration exists:</p><a id="I_programlisting2_d1e34350"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>ls -l /var/nagios/ndo.sock</strong></span>
srwxr-xr-x 1 nagios nagios 0 Jul 18 21:16 /var/nagios/ndo.sock</pre>

      <p>If the message <strong class="userinput"><code>Socket already in use</code></strong> appears when the daemon is run, then either the daemon is already running or the socket <strong class="userinput"><code>ndo.sock</code></strong> was not removed when the daemon was stopped. In this case you should delete it manually before restarting it.</p>
    </div>

    <div class="sect2" title="17.4.4 Loading the Event Broker module in Nagios">
      <div class="titlepage">
        <h2 class="title" id="heading_id_6"><a id="loading_the_event_broker_module_in_nagio"/>17.4.4 Loading the Event Broker module in Nagios</h2>
      </div>

      <p>In order for Nagios to load the Event Broker module of the NDOUtils when it is started, the following entry is added to the configuration file <strong class="userinput"><code>/etc/nagios/nagios.cfg:</code></strong><a class="indexterm" id="IDX-CHP-17-1379"/><a class="indexterm" id="IDX-CHP-17-1380"/><a class="indexterm" id="IDX-CHP-17-1381"/><a class="indexterm" id="IDX-CHP-17-1382"/><a class="indexterm" id="IDX-CHP-17-1383"/><a class="indexterm" id="IDX-CHP-17-1384"/><a class="indexterm" id="IDX-CHP-17-1385"/><a class="indexterm" id="IDX-CHP-17-1386"/><a class="indexterm" id="IDX-CHP-17-1387"/><a class="indexterm" id="IDX-CHP-17-1388"/><a class="indexterm" id="IDX-CHP-17-1389"/><a class="indexterm" id="IDX-CHP-17-1390"/><a class="indexterm" id="IDX-CHP-17-1391"/><a class="indexterm" id="IDX-CHP-17-1392"/><a class="indexterm" id="IDX-CHP-17-1393"/><a class="indexterm" id="IDX-CHP-17-1394"/><a class="indexterm" id="IDX-CHP-17-1395"/></p><a id="I_programlisting2_d1e34444"/>
      <pre class="programlisting"># /etc/nagios/nagios.cfg:
...
# === NDO ===
broker_module=/usr/local/nagios/bin/ndomod-3x.o config_file=/etc/nagios/
ndomod.cfg</pre>

      <p>In this example the module for Nagios version 3.x is used; if you are using Nagios 2.x, you enter <strong class="userinput"><code>ndomod-2x.o</code></strong> instead. A reload activates the module:</p><a id="I_programlisting2_d1e34451"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/nagios reload</strong></span></pre>

      <p>Shortly after the reload, all host and service objects should be recorded in the database:</p><a id="I_programlisting2_d1e34457"/>
      <pre class="programlisting">user@linux:~$ <span class="strong"><strong>mysql --user=nagios -p nagios</strong></span>
mysql&gt; <span class="strong"><strong>select name1,name2 from nagios_objects WHERE objecttype</strong></span>_<span class="strong"><strong>id=2 ;</strong></span>
+---------+----------------------+
| name1   | name2                |
+---------+----------------------+
| AHDC01  | CPU_LOAD             |
| AHDC01  | DISK_C               |
| AHDC01  | DISK_D               |
...</pre>

      <p>The table <strong class="userinput"><code>nagios_objects</code></strong> contains all the objects, and <strong class="userinput"><code>objecttype_id=2</code></strong> shows all the services. Alternatively the object type <strong class="userinput"><code>1</code></strong> refers to hosts, <strong class="userinput"><code>3</code></strong> to host groups, and <strong class="userinput"><code>4</code></strong> to service groups. A complete description of the tables is provided in the file <strong class="userinput"><code>NDOUTILS DB Model.pdf</code></strong>, included in the NDOUtils in the subdirectory <strong class="userinput"><code>./docs</code></strong>.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-17-FN-5" id="ftn.CHP-17-FN-5">184</a>]</sup> For event handlers, see <a class="xref" href="../Text/apc.html" title="Appendix C. Event Handlers">Appendix C</a> in page 619</p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;18.&#xA0;NagVis">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="nagvis"/>Chapter 18. NagVis</h1>
    </div>

    <p>NagVis<sup>[<a class="footnote" href="#ftn.CHP-18-FN-1" id="CHP-18-FN-1">185</a>]</sup> is an addon for Nagios that displays host and service states against a background image selected by the user. This must be available in the PNG format; the choice is yours whether you use a map, a diagram of your own system documentation, a photo of the server room, or a schematic diagram of the system environment as a background, as shown in <a class="xref" href="../Text/ch18.html#schematic_diagram_of_a_system_environmen" title="Figure 18-1. Schematic diagram of a system environment as a template for NagVis">Figure 18-1</a>.<a class="indexterm" id="IDX-CHP-18-1396"/></p>

    <p>Via the Web interface, you can place objects wherever you want on the background. NagVis displays different icons, depending on the state of the object: red for the CRITICAL state, yellow for WARNING, green for OK, and a question mark on a gray background for UNKNOWN. If an acknowledgment was set, this is indicated by a green button with a picture of a worker on it.</p>

    <p>There are different icons for hosts and services; in the default template, host icons are rectangular, and service icons are round. A finished NagVis display—NagVis refers to this as a <span class="emphasis"><em>map</em></span>—is shown in <a class="xref" href="../Text/ch18.html#displaying_the_system_environment" title="Figure 18-2. Displaying the system environment">Figure 18-2</a>. Further examples—such as using a geographical map, or a photo of the server room, as a background—are provided on the NagVis homepage.<sup>[<a class="footnote" href="#ftn.CHP-18-FN-2" id="CHP-18-FN-2">186</a>]</sup></p>

    <div class="figure">
      <a id="schematic_diagram_of_a_system_environmen"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e34521"/><img alt="Schematic diagram of a system environment as a template for NagVis" src="../Images/tagoreillycom20081104nostarchimages223940.png.jpg"/></div>

      <p class="title">Figure 18-1. Schematic diagram of a system environment as a template for NagVis</p>
    </div>

    <p>In addition to hosts and services, host and service groups can also be integrated into a NagVis display, as well as additional maps. Thus a geographical overview map could be used for the start page, which has an icon for each location monitored that links to a detailed NagVis map specifically for that location.</p>

    <p>If an icon contains several states, as is the case for host and service groups, for instance, NagVis displays the state with the highest priority CRITICAL has a higher priority than WARNING, WARNING trumps UNKNOWN, UNKNOWN gets more attention than an acknowledgment, and OK has the lowest priority of all. If any host in a host group assumes the CRITICAL state, this is shown accordingly for the entire host group.</p>

    <p>For hosts and host groups, NagVis offers you the choice of having only host states considered in determining the state that is displayed, or having the services dependent on these hosts are included as well (see <a class="xref" href="../Text/ch18.html#initial_configuration" title="18.1.2 Initial configuration">18.1.2 Initial configuration</a>). In the latter case, a red stop light is displayed if even a single service of a host is in the critical state.</p>

    <p>Of particular interest is NagVis's ability to evaluate only hard states (<a class="xref" href="../Text/ch18.html#initial_configuration" title="18.1.2 Initial configuration">18.1.2 Initial configuration</a>). For routine work with the Web interface, it turns out to be quite useful if not every temporary soft CRITICAL state immediately generates a red light.<a class="indexterm" id="IDX-CHP-18-1397"/><a class="indexterm" id="IDX-CHP-18-1398"/></p>

    <div class="figure">
      <a id="displaying_the_system_environment"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e34551"/><img alt="Displaying the system environment" src="../Images/tagoreillycom20081104nostarchimages223942.png.jpg"/></div>

      <p class="title">Figure 18-2. Displaying the system environment</p>
    </div>

    <p>It will especially please fans of object-oriented programming that NagVis makes full use of object-oriented concepts. For example, the system inherits defaults from the global configuration for individual maps and settings on the map level and passes these on to individual objects, with the option of overwriting settings locally always available. This simplifies the configuration to a considerable extent, and NagVis also indicates in the graphical editor (also called the <span class="emphasis"><em>Web user interface</em></span> or WUI) which settings are object-specific and which have been inherited (<a class="xref" href="../Text/ch18s02.html#if_you_move_the_mouse_over_the_inserted" title="Figure 18-8. If you move the mouse over the inserted object, a hover menu opens">Figure 18-8</a> in page 399).</p>

    <p>NagVis is published under the GNU Public License Version 2 (GPLv2); the description below refers to version 1.3.</p>

    <div class="sect1" title="18.1 Installation">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="installation-id4"/>18.1 Installation</h1>
      </div>

      <p>NagVis makes use of NDOUtils and is implemented in PHP. Therefore, besides an NDO database in running order, as described in <a class="xref" href="../Text/ch17.html" title="Chapter 17. Flexible Web Interface with the NDOUtils">Chapter 17</a> from page 375, you need a Web server with PHP 4.2 or higher, as well as the packages <strong class="userinput"><code>php-mysql</code></strong> for access to the NDO database and <strong class="userinput"><code>php-gd</code></strong> to be able to draw lines.<sup>[<a class="footnote" href="#ftn.CHP-18-FN-3" id="CHP-18-FN-3">187</a>]</sup> Depending on the distribution and the PHP version used, the package names may vary slightly. For Debian "Etch" and PHP5 you need the packages <strong class="userinput"><code>libapache2-mod-php5, php5, php5-common, php5-gd</code></strong>, and <strong class="userinput"><code>php5-mysql</code></strong>.<a class="indexterm" id="IDX-CHP-18-1400"/><a class="indexterm" id="IDX-CHP-18-1401"/><a class="indexterm" id="IDX-CHP-18-1402"/><a class="indexterm" id="IDX-CHP-18-1399"/></p>

      <p>NagVis does not necessarily have to be installed on the same computer as Nagios and the NDOUtils, although in many cases they are packed onto one host. The configuration of the NDO database—NagVis documentation refers to this as the <span class="emphasis"><em>backend</em></span>—can refer (as described in <a class="xref" href="../Text/ch18.html#initial_configuration" title="18.1.2 Initial configuration">18.1.2 Initial configuration</a>) to any system you please. NagVis even allows the backend to be selected separately for each individual object so that maps can be generated that combine several Nagios installations in a single graphic.</p>

      <div class="sect2" title="18.1.1 Installing the source code">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="installing_the_source_code"/>18.1.1 Installing the source code</h2>
        </div>

        <p>The NagVis source code, from <a class="ulink" href="http://www.nagvis.org/downloads">http://www.nagvis.org/downloads</a>, is unpacked in a directory of your choice:<a class="indexterm" id="IDX-CHP-18-1403"/><a class="indexterm" id="IDX-CHP-18-1404"/><a class="indexterm" id="IDX-CHP-18-1405"/></p><a id="I_programlisting3_d1e34644"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>tar xvzf</strong></span> <span class="bolditalic">/pfad/zu/</span><span class="strong"><strong>nagvis-1.3.tar.gz</strong></span>
...</pre>

        <p>If a previous installation exists, you should back this up first. Then you copy the directory that has been created (in our case, <strong class="userinput"><code>nagvis-1.3</code></strong>) with the name <strong class="userinput"><code>nagvis</code></strong> to <strong class="userinput"><code>/usr/local/nagios/share:</code></strong></p><a id="I_programlisting3_d1e34664"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>mv nagvis-1.3 /usr/local/nagios/share/nagvis</strong></span>
linux:~ # <span class="strong"><strong>ls -F /usr/local/nagios/share/nagvis</strong></span>
INSTALL LICENCE README config.php etc/ index.php nagvis/ var/ wui/</pre>

        <p>The duplicated directory name <strong class="userinput"><code>nagvis</code></strong> can sometimes lead to confusion, but it is correct:</p><a id="I_programlisting3_d1e34677"/>
        <pre class="programlisting">/usr/local/nagios/share/nagvis
/usr/local/nagios/share/nagvis/nagvis
/usr/local/nagios/share/nagvis/wui</pre>

        <p><strong class="userinput"><code>/usr/local/nagios/share/nagvis</code></strong> represents the main directory of the NagVis installation, while the subdirectory <strong class="userinput"><code>nagvis</code></strong> contains the NagVis application, together with its configuration. Finally the subdirectory <strong class="userinput"><code>wui</code></strong> contains the graphic editor that enables NagVis maps to be edited via the browser.</p>

        <p>At present, the correct access permissions for directories and files must be set manually. To do this, you first need to determine the user with whose permissions the Web server is running (see also <a class="xref" href="../Text/ch01s02.html" title="1.2 Compiling Source Code">1.2 Compiling Source Code</a>, page 39):</p><a id="I_programlisting3_d1e34693"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>grep "^User" /etc/apache2/apache2.conf</strong></span>
User www-data
linux:~ # <span class="strong"><strong>id www-data</strong></span>
uid=33(www-data) gid=33(www-data) Groups=33 (www=data),9001 (nagcmd)</pre>

        <p>The first <strong class="userinput"><code>grep</code></strong> command looks for the corresponding user in the configuration file for the Web server—in this case, Apache2—and then the <strong class="userinput"><code>id</code></strong> command searches for the primary group of this user. This can be found after the <strong class="userinput"><code>gid=</code></strong> specification. The access permissions are now set accordingly:<a class="indexterm" id="IDX-CHP-18-1406"/></p><a id="I_programlisting3_d1e34718"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>chown www-data.www-data -R /usr/local/nagios/share/nagvis</strong></span>
linux:~ # <span class="strong"><strong>chmod 664 /usr/local/nagios/share/nagvis/etc/nagvis.ini.php</strong></span>
linux:~ # <span class="strong"><strong>chmod 775 /usr/local/nagios/share/nagvis/nagvis/images/maps</strong></span>
linux:~ # <span class="strong"><strong>chmod 664 /usr/local/nagios/share/nagvis/nagvis/images/maps/*</strong></span>
linux:~ # <span class="strong"><strong>chmod 775 /usr/local/nagios/share/nagvis/etc/maps</strong></span>
linux:~ # <span class="strong"><strong>chmod 664 /usr/local/nagios/share/nagvis/etc/maps/*</strong></span>
linux:~ # <span class="strong"><strong>chmod 775 /usr/local/nagios/share/nagvis/var</strong></span>
linux:~ # <span class="strong"><strong>chmod 664 /usr/local/nagios/share/nagvis/var/*</strong></span></pre>

        <p>Before the Web user interface can be used, you must create the central configuration file and ensure that access to NagVis is only possible after successful authentication.<a class="indexterm" id="IDX-CHP-18-1407"/></p>
      </div>

      <div class="sect2" title="18.1.2 Initial configuration">
        <div class="titlepage">
          <h2 class="title" id="heading_id_5"><a id="initial_configuration"/>18.1.2 Initial configuration</h2>
        </div>

        <p>A template for the central NagVis configuration file <strong class="userinput"><code>config.ini.php</code></strong> can be found in the directory <strong class="userinput"><code>/usr/local/nagios/share/nagvis/etc</code></strong>, which only needs to be renamed and modified:<a class="indexterm" id="IDX-CHP-18-1408"/><a class="indexterm" id="IDX-CHP-18-1409"/><a class="indexterm" id="IDX-CHP-18-1410"/><a class="indexterm" id="IDX-CHP-18-1411"/><a class="indexterm" id="IDX-CHP-18-1412"/><a class="indexterm" id="IDX-CHP-18-1413"/><a class="indexterm" id="IDX-CHP-18-1414"/><a class="indexterm" id="IDX-CHP-18-1415"/><a class="indexterm" id="IDX-CHP-18-1416"/><a class="indexterm" id="IDX-CHP-18-1417"/><a class="indexterm" id="IDX-CHP-18-1418"/><a class="indexterm" id="IDX-CHP-18-1419"/><a class="indexterm" id="IDX-CHP-18-1420"/><a class="indexterm" id="IDX-CHP-18-1421"/><a class="indexterm" id="IDX-CHP-18-1422"/><a class="indexterm" id="IDX-CHP-18-1423"/><a class="indexterm" id="IDX-CHP-18-1424"/><a class="indexterm" id="IDX-CHP-18-1425"/><a class="indexterm" id="IDX-CHP-18-1426"/><a class="indexterm" id="IDX-CHP-18-1427"/><a class="indexterm" id="IDX-CHP-18-1428"/><a class="indexterm" id="IDX-CHP-18-1429"/><a class="indexterm" id="IDX-CHP-18-1430"/><a class="indexterm" id="IDX-CHP-18-1431"/><a class="indexterm" id="IDX-CHP-18-1432"/><a class="indexterm" id="IDX-CHP-18-1433"/><a class="indexterm" id="IDX-CHP-18-1434"/><a class="indexterm" id="IDX-CHP-18-1435"/><a class="indexterm" id="IDX-CHP-18-1436"/></p><a id="I_programlisting3_d1e34860"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/nagios/share/nagvis/etc</strong></span>
linux:nagvis/etc # <span class="strong"><strong>cp config.ini.php.dist config.ini.php</strong></span>
linux:nagvis/etc # <span class="strong"><strong>chown www-data.www-data config.ini.php</strong></span>
linux:nagvis/etc # <span class="strong"><strong>chmod 664 config.ini.php</strong></span></pre>

        <p>The commands <strong class="userinput"><code>chown</code></strong> and <strong class="userinput"><code>chmod</code></strong> ensure that the correct access permissions are set for the Web user (here, <strong class="userinput"><code>www-data</code></strong>) and his group.</p>

        <p>Apart from the configuration of the backend (that is, the NDO database), the included <strong class="userinput"><code>config.ini.php</code></strong> already has usable defaults. The following description is therefore limited to introducing the most important parameters:<sup>[<a class="footnote" href="#ftn.CHP-18-FN-4" id="CHP-18-FN-4">188</a>]</sup></p><a id="I_programlisting3_d1e34894"/>
        <pre class="programlisting">[global]
language="german"
refreshtime=60</pre>

        <p>In the <strong class="userinput"><code>[global]</code></strong> section you can set the language with <strong class="userinput"><code>language</code></strong>; the default is <strong class="userinput"><code>english. refreshtime</code></strong> defines every how many seconds the display in the brower is refreshed.</p>

        <p>The section <strong class="userinput"><code>[defaults]</code></strong> specifies defaults that are inherited by the defined objects from the map configuration. The values can be overwritten via the map, if required. It is best to define settings here that are identical for the majority of objects, in order to avoid the repeated work of defining them explicitly in the object definitions:<a class="indexterm" id="IDX-CHP-18-1437"/></p><a id="I_programlisting3_d1e34917"/>
        <pre class="programlisting">[defaults]
backend="ndomy_1"
icons="std_medium"
recognizeservices=1
onlyhardstates=1</pre>

        <p><strong class="userinput"><code>backend</code></strong> specifies which NDO database is used as the default backend. The name for this can be anything you like, but the backend itself must still be defined in a separate section (see <a class="xref" href="../Text/ch18.html#initial_configuration" title="18.1.2 Initial configuration">18.1.2 Initial configuration</a>). If you are just getting started, it is best to keep the name supplied, <strong class="userinput"><code>ndomy_1</code></strong>.</p>

        <p>The parameter <strong class="userinput"><code>icons</code></strong> defines the icon set from the directory <strong class="userinput"><code>./nagvis/nagvis/images/iconsets</code></strong> that is to be used. Four sets are included: <strong class="userinput"><code>std_small, std_medium, std_big</code></strong>, and <strong class="userinput"><code>folder</code></strong>. Other icons can be downloaded from the NagVis homepage,<sup>[<a class="footnote" href="#ftn.CHP-18-FN-5" id="CHP-18-FN-5">189</a>]</sup> or you can create them yourself.<sup>[<a class="footnote" href="#ftn.CHP-18-FN-6" id="CHP-18-FN-6">190</a>]</sup><a class="indexterm" id="IDX-CHP-18-1438"/></p>

        <p>The setting <strong class="userinput"><code>recognizeserivces=1</code></strong> ensures for hosts and host groups that the current states of the accompanying services are included when the overall state is being determined. The value 0 switches off this behavior.</p>

        <p><strong class="userinput"><code>onlyhardstates=1</code></strong> on the other hand instructs NagVis to take only hard states into account. The default <strong class="userinput"><code>0</code></strong> also includes soft states.</p>

        <p>The <strong class="userinput"><code>[wui]</code></strong> section allows settings to be made for the NagVis editor:</p><a id="I_programlisting3_d1e34975"/>
        <pre class="programlisting">[wui]
autoupdatefreq=25
maplocktime=5</pre>

        <p><strong class="userinput"><code>autoupdatefreq</code></strong> determines how often (in number of seconds) the Web user interface automatically saves changes, while <strong class="userinput"><code>maplocktime</code></strong> specifies the number of minutes after which any further changes to a map that is currently being edited should be blocked, from the time of the last change. This is intended to prevent several users from simultaneously editing the same map.</p>

        <p>The paths to the NagVis installation from the perspective of the file system (<strong class="userinput"><code>base</code></strong>) and—separately for NagVis data and NagVis CGIs—from the perspective of the browser, are specified in Section <strong class="userinput"><code>[paths]</code></strong>:</p><a id="I_programlisting3_d1e34992"/>
        <pre class="programlisting">[paths]
base="/usr/local/nagios/share/nagvis/"
htmlbase="/nagios/nagvis"
htmlcgi="/nagios/cgi-bin"</pre>

        <p>The defaults listed here match the standard installation described above.</p>

        <p>The configuration for the backend, that is, for accessing the NDO database, follows at the bottom of the file:</p><a id="I_programlisting3_d1e34998"/>
        <pre class="programlisting">[backend_ndomy_1]
backendtype="ndomy"
dbhost="localhost"
dbport=3306
dbname="nagios"
dbuser="nagios"
dbpass="verysecret"
dbprefix="nagios_"
dbinstancename="default"
maxtimewithoutupdate=180</pre>

        <p>This name of this section must contain the name specified with the <strong class="userinput"><code>backend</code></strong> parameter under <strong class="userinput"><code>[defaults]</code></strong>, according to the pattern <strong class="userinput"><code>[backend_</code></strong><strong class="userinput"><code><em class="replaceable"><code>value_of_backend]</code></em></code></strong>. The default here is <strong class="userinput"><code>ndomy_1</code></strong>. If the <strong class="userinput"><code>backend</code></strong> parameter value does not match any of the defined backend sections, NagVis will refuse to work.</p>

        <p><strong class="userinput"><code>backendtype</code></strong> defines the type of backend, and for now <strong class="userinput"><code>ndomy</code></strong>—an NDO database based on MySQL—is the only possible value.</p>

        <p><strong class="userinput"><code>dbhost</code></strong> and <strong class="userinput"><code>dbport</code></strong> specify the host name or IP address and the accompanying TCP port for access to the database. <strong class="userinput"><code>dbname</code></strong> contains the name of the NDO database, and <strong class="userinput"><code>dbuser</code></strong> and <strong class="userinput"><code>dbpass</code></strong> give the user and the password for access.</p>

        <p>The values defined by default for <strong class="userinput"><code>dbprefix</code></strong> and <strong class="userinput"><code>dbinstancename</code></strong> are set for a NDOUtils standard installation. Provided that you have not changed the parameter <strong class="userinput"><code>instance_name</code></strong> in the file <strong class="userinput"><code>ndomod.cfg</code></strong> (see <a class="xref" href="../Text/ch17s04.html#adjusting_the_event_broker_configuration" title="17.4.1 Adjusting the Event Broker configuration">17.4.1 Adjusting the Event Broker configuration</a> from page 384) and <strong class="userinput"><code>db_prefix</code></strong> in the file <strong class="userinput"><code>ndo2db.cfg</code></strong> (see <a class="xref" href="../Text/ch17s04.html#configuring_database_access" title="17.4.2 Configuring database access">17.4.2 Configuring database access</a> from page 385), you can use the values given here.</p>

        <p>One parameter to which you should pay particular attention is <strong class="userinput"><code>maxtime-withoutupdate:</code></strong> This defines how much time in seconds is allowed for the status update of Nagios to appear. If the time specified here is exceeded, NagVis assumes that the data is obsolete and displays this as an error. If NagVis accesses NDO databases that are distributed across several servers, it is essential that the clock times of the servers be synchronized with one another, otherwise NagVis will refuse to work if it comes across a time difference greater than <strong class="userinput"><code>maxtimewithoutupdate</code></strong> seconds.<a class="indexterm" id="IDX-CHP-18-1439"/></p>

        <p>At this point we shall mention another problem involving data exchange between the NDO database and NagVis: NagVis evaluates the current program status. Nagios versions prior to 3.0b1, however, only write this to the NDO database <span class="emphasis"><em>after</em></span> the nightly change of the log files. Starting with version 3.0b1, Nagios updates the status every five seconds, so that NagVis always has up-to-date information.</p>
      </div>

      <div class="sect2" title="18.1.3 User authentication">
        <div class="titlepage">
          <h2 class="title" id="heading_id_6"><a id="user_authentication-id1"/>18.1.3 User authentication</h2>
        </div>

        <p>NagVis demands authentication from the user. Without user authentication, it will just issue an error message.<sup>[<a class="footnote" href="#ftn.CHP-18-FN-7" id="CHP-18-FN-7">191</a>]</sup><a class="indexterm" id="IDX-CHP-18-1440"/><a class="indexterm" id="IDX-CHP-18-1441"/><a class="indexterm" id="IDX-CHP-18-1442"/><a class="indexterm" id="IDX-CHP-18-1443"/><a class="indexterm" id="IDX-CHP-18-1444"/><a class="indexterm" id="IDX-CHP-18-1445"/><a class="indexterm" id="IDX-CHP-18-1446"/></p>

        <p>If the <strong class="userinput"><code>share</code></strong> directory of Nagios is not accessible for authentication, as in the Apache configuration in <a class="xref" href="../Text/ch01s05.html#setting_up_apache" title="1.5.1 Setting up Apache">1.5.1 Setting up Apache</a>, you should change this in the Apache configuration file <strong class="userinput"><code>/etc/apache2/conf.d/nagios</code></strong>. The authentication data are best taken from the CGI directory (see <a class="xref" href="../Text/ch01s05.html" title="1.5 Configuration of the Web Interface">1.5 Configuration of the Web Interface</a> from page 47).</p>

        <div class="figure">
          <a id="after_a_right_mouse_click"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e35145"/><img alt="After a right mouse click on the graphic displayed, the menu will appear" src="../Images/tagoreillycom20081104nostarchimages223944.png.jpg"/></div>

          <p class="title">Figure 18-3. After a right mouse click on the graphic displayed, the menu will appear</p>
        </div>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-18-FN-1" id="ftn.CHP-18-FN-1">185</a>]</sup> <a class="ulink" href="http://www.nagvis.org/">http://www.nagvis.org/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-18-FN-2" id="ftn.CHP-18-FN-2">186</a>]</sup> <a class="ulink" href="http://www.nagvis.org/screenshots">http://www.nagvis.org/screenshots</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-18-FN-3" id="ftn.CHP-18-FN-3">187</a>]</sup> You can manage without using the GD libraries if the parameter <strong class="userinput"><code>usedgdlibs</code></strong> in the NagVis configuration file <strong class="userinput"><code>config.ini.php</code></strong> (see <a class="xref" href="../Text/ch18.html#installing_the_source_code" title="18.1.1 Installing the source code">18.1.1 Installing the source code</a>) is set to <strong class="userinput"><code>0</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-18-FN-4" id="ftn.CHP-18-FN-4">188</a>]</sup> The complete documentation can be found at <a class="ulink" href="http://www.nagvis.org/docs/1.3/nagvis_config_format_description">http://www.nagvis.org/docs/1.3/nagvis_config_format_description</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-18-FN-5" id="ftn.CHP-18-FN-5">189</a>]</sup> <a class="ulink" href="http://www.nagvis.org/downloads">http://www.nagvis.org/downloads</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-18-FN-6" id="ftn.CHP-18-FN-6">190</a>]</sup> A corresponding guide can be found at <a class="ulink" href="http://www.nagvis.org/docs/extending/iconsets">http://www.nagvis.org/docs/extending/iconsets</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-18-FN-7" id="ftn.CHP-18-FN-7">191</a>]</sup> The FAQ entry <a class="ulink" href="http://www.nagvis.org/docs/general/faq#how/to/run/nagvis/without/authentication/">http://www.nagvis.org/docs/general/faq#how/to/run/nagvis/without/authentication/</a> describes away of using NagVis without authentication, but you should avoid this, for reasons of security.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="18.2 Creating NagVis Maps">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="creating_nagvis_maps"/>18.2 Creating NagVis Maps</h1>
    </div>

    <p>The NagVis configuration interface is accessed through the URL <a class="ulink" href="http://nagiosserver/nagios/wui/index.php">http://nagiosserver/nagios/wui/index.php</a>. Here you replace <strong class="userinput"><code><em class="replaceable"><code>nagiosserver</code></em></code></strong> with your own Nagios host name (<a class="xref" href="../Text/ch18.html#after_a_right_mouse_click" title="Figure 18-3. After a right mouse click on the graphic displayed, the menu will appear">Figure 18-3</a> shows the start page).<a class="indexterm" id="IDX-CHP-18-1447"/><a class="indexterm" id="IDX-CHP-18-1448"/><a class="indexterm" id="IDX-CHP-18-1449"/><a class="indexterm" id="IDX-CHP-18-1450"/><a class="indexterm" id="IDX-CHP-18-1451"/><a class="indexterm" id="IDX-CHP-18-1452"/><a class="indexterm" id="IDX-CHP-18-1453"/><a class="indexterm" id="IDX-CHP-18-1454"/></p>

    <p>It is operated through a menu that opens when you click the right mouse button. For browsers that overlay the NagVis menu with their own menu, a second click with the right mouse button will cause the browser menu to disappear.</p>

    <p>If you don't have a suitable background graphic available in PNG format, you can create a new, empty background image via the menu item <span class="strong"><strong>Manage | Backgrounds</strong></span>, as shown in <a class="xref" href="../Text/ch18s02.html#creating_a_new_comma_empty_background" title="Figure 18-4. Creating a new, empty background">Figure 18-4</a>. In this example, a gray image of size 800x600 pixels is created.</p>

    <div class="figure">
      <a id="creating_a_new_comma_empty_background"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e35208"/><img alt="Creating a new, empty background" src="../Images/tagoreillycom20081104nostarchimages223946.png.jpg"/></div>

      <p class="title">Figure 18-4. Creating a new, empty background</p>
    </div>

    <p>This image is displayed on screen in its original size, that is, not scaled. To avoid scrolling, it should not be too large, with the proper size depending on the screen resolution and taking into account possible window frames.</p>

    <p>Later on the image size can only be altered to a limited extent: although you can upload or create a background image at any time, objects that have already been placed are not affected by any changes in the size or other characteristics of the background, and so they may not fit properly into a new background image. The only option then is to reposition all the objects. The best approach is to experiment at first with just a few objects in the definitive environment before you set up an extensive map.</p>

    <div class="figure">
      <a id="if_the_entry_for_map_iconset_remains_emp"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e35220"/><img alt="If the entry for Map Iconset remains empty, NagVis uses the defaults from the central configuration." src="../Images/tagoreillycom20081104nostarchimages223948.png.jpg"/></div>

      <p class="title">Figure 18-5. If the entry for Map Iconset remains empty, NagVis uses the defaults from the central configuration.</p>
    </div>

    <p>You now create a new map for the generated or uploaded image. Via the menu entry <span class="strong"><strong>Manage | Maps</strong></span> (<a class="xref" href="../Text/ch18.html#after_a_right_mouse_click" title="Figure 18-3. After a right mouse click on the graphic displayed, the menu will appear">Figure 18-3</a>) you navigate to the dialog shown in <a class="xref" href="../Text/ch18s02.html#if_the_entry_for_map_iconset_remains_emp" title="Figure 18-5. If the entry for Map Iconset remains empty, NagVis uses the defaults from the central configuration.">Figure 18-5</a>. There you define the name of the map and select the background image. If every authenticated user should see the map, you enter <strong class="userinput"><code>EVERYONE</code></strong> as <span class="strong"><strong>User with read permissions</strong></span>. For the <strong class="userinput"><code>User with write permissions</code></strong>, on the other hand, you would probably enter a specific user, or several user names, separated by commas. Defining the icon sets is optional at this point, although the example shown specifies them.</p>

    <p>Newly created maps are automatically opened by NagVis in editing mode. You can reach this later on via the menu item <span class="strong"><strong>Open Map</strong></span> in the context menu of the opening dialog or by calling it directly with the URL <a class="ulink" href="http://nagios/nagvis/wui/index.php?map=mapname">http://nagios/nagvis/wui/index.php?map=mapname</a>.</p>

    <div class="figure">
      <a id="inserting_objects_via_the_graphical_inte"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e35254"/><img alt="Inserting objects via the graphical interface" src="../Images/tagoreillycom20081104nostarchimages223950.png.jpg"/></div>

      <p class="title">Figure 18-6. Inserting objects via the graphical interface</p>
    </div>

    <p>The <strong class="userinput"><code><em class="replaceable"><code>mapname</code></em></code></strong> for the map created in <a class="xref" href="../Text/ch18s02.html#if_the_entry_for_map_iconset_remains_emp" title="Figure 18-5. If the entry for Map Iconset remains empty, NagVis uses the defaults from the central configuration.">Figure 18-5</a> is <strong class="userinput"><code>Test</code></strong>. In the map itself you now insert objects using the right mouse button (see <a class="xref" href="../Text/ch18s02.html#inserting_objects_via_the_graphical_inte" title="Figure 18-6. Inserting objects via the graphical interface">Figure 18-6</a>). An object can be an icon, a line, or a special object. Icons and lines represent the current state of a host or service and can also stand for entire host or service groups. Icons can only reflect the overall state of a map. Special objects are graphics representing stateless objects (which might be icons as well, for example) or text boxes, which can also be provided with a hyperlink.</p>

    <p>To insert a host group you select <span class="strong"><strong>Add Object |Icon| Hostgroup</strong></span> in the menu. Then you place the mouse over the desired position and define the destination of the icon with a left mouse click (the position can be changed later on).</p>

    <p>When this is done a dialog opens, as shown in <a class="xref" href="../Text/ch18s02.html#defining_a_host_group_in_the_graphical" title="Figure 18-7. Defining a host group in the graphical interface">Figure 18-7</a>. The entry <span class="strong"><strong>backend_id</strong></span> can remain empty, and NagVis will then use the value of the <strong class="userinput"><code>backend</code></strong> parameter from the central configuration file <strong class="userinput"><code>config.php.ini</code></strong>. In the <span class="strong"><strong>hostgroup_name</strong></span> pulldown menu, NagVis allows you to select from all defined host groups.</p>

    <p>Icons can be positioned according to the <span class="strong"><strong>x</strong></span> and <span class="strong"><strong>y</strong></span> coordinates by either entering numerical values or using the mouse. For simple icons, the point (x, y) corresponds to the center, and for lines to the start or end points. The z coordinate is only used when icons overlap. The value <strong class="userinput"><code>0</code></strong> describes the underlying image at the rear and is reserved for the background, and the object with the highest <span class="strong"><strong>z</strong></span> value is right at the front. If the <span class="strong"><strong>z</strong></span> coordinate is explicitly left empty when the object is inserted, it automatically receives the value <strong class="userinput"><code>1</code></strong>.</p>

    <div class="figure">
      <a id="defining_a_host_group_in_the_graphical"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e35318"/><img alt="Defining a host group in the graphical interface" src="../Images/tagoreillycom20081104nostarchimages223952.png.jpg"/></div>

      <p class="title">Figure 18-7. Defining a host group in the graphical interface</p>
    </div>

    <p>The parameter <strong class="userinput"><code>recognize_services</code></strong> allows the <strong class="userinput"><code>recognizeservices</code></strong> setting from the <strong class="userinput"><code>config.ini.php</code></strong> (see <a class="xref" href="../Text/ch18.html#initial_configuration" title="18.1.2 Initial configuration">18.1.2 Initial configuration</a>) to be overridden, and <strong class="userinput"><code>only_hard_states</code></strong> does the same for the parameter <strong class="userinput"><code>onlyhardstates</code></strong> (<a class="xref" href="../Text/ch18.html#initial_configuration" title="18.1.2 Initial configuration">18.1.2 Initial configuration</a>).</p>

    <p>The object inserted in this way always appears in the graphical editor in the form of the OK icon from the icon set chosen; the Web interface takes no account of its actual state.</p>

    <p>If you move the mouse over the icon, a hover menu opens, as shown in <a class="xref" href="../Text/ch18s02.html#if_you_move_the_mouse_over_the_inserted" title="Figure 18-8. If you move the mouse over the inserted object, a hover menu opens">Figure 18-8</a>. It clearly distinguishes which settings are inherited and which ones have been specified directly in the object. If you follow the <span class="strong"><strong>Change</strong></span> link there, the settings can be changed again.</p>

    <div class="figure">
      <a id="if_you_move_the_mouse_over_the_inserted"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e35357"/><img alt="If you move the mouse over the inserted object, a hover menu opens" src="../Images/tagoreillycom20081104nostarchimages223954.png.jpg"/></div>

      <p class="title">Figure 18-8. If you move the mouse over the inserted object, a hover menu opens</p>
    </div>

    <p>When your work is finished, don't forget to save your changes via the context menu entry <span class="strong"><strong>Save</strong></span> (see <a class="xref" href="../Text/ch18.html#after_a_right_mouse_click" title="Figure 18-3. After a right mouse click on the graphic displayed, the menu will appear">Figure 18-3</a> in page 396). The menu item <span class="strong"><strong>Open Map in NagVis</strong></span> will then take you to the finished view, which now does display the actual states.</p>

    <p>In <a class="xref" href="../Text/ch18s02.html#object_in_the_final_view_with_text_box" title="Figure 18-9. Object in the final view with text box and hover menu">Figure 18-9</a> a text box has been added to the host group icon. The field displayed beneath this is a hover menu, which shows information on the object and its state if you move the mouse over the object. This example shows that two hosts of the host group display a Not OK state and that this has already been confirmed with an acknowledgment.</p>

    <div class="figure">
      <a id="object_in_the_final_view_with_text_box"/>

      <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e35380"/><img alt="Object in the final view with text box and hover menu" src="../Images/tagoreillycom20081104nostarchimages223956.png.jpg"/></div>

      <p class="title">Figure 18-9. Object in the final view with text box and hover menu</p>
    </div>

    <p>The finished map can be called directly via the URL <a class="ulink" href="http://nagiosserver/nagios/nagvis/nagvis/index.php?map=mapname">http://nagiosserver/nagios/nagvis/nagvis/index.php?map=mapname</a>.</p>

    <div class="sect2" title="18.2.1 Editing the configuration in text form">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="editing_the_configuration_in_text_form"/>18.2.1 Editing the configuration in text form</h2>
      </div>

      <p>NagVis stores the entire configuration of a map in text files, which can also be edited with a text editor. The files are located in the directory <strong class="userinput"><code>/usr/local/nagios/share/nagvis/etc/maps/</code></strong>. If you are using a background image with a known raster, you can insert several objects in the WUI and continue editing the map in the editor using the coordinates just determined. This is how the map shown in <a class="xref" href="../Text/ch18.html#displaying_the_system_environment" title="Figure 18-2. Displaying the system environment">Figure 18-2</a> was created. The background image (<a class="xref" href="../Text/ch18.html#schematic_diagram_of_a_system_environmen" title="Figure 18-1. Schematic diagram of a system environment as a template for NagVis">Figure 18-1</a>) was created with OpenOffice in order to obtain a reproducible raster; the OpenOffice drawing is subsequently exported as a PNG file.<a class="indexterm" id="IDX-CHP-18-1455"/></p>

      <p>The configuration options for the text files, which altogether are very extensive, are described in the online documentation.<sup>[<a class="footnote" href="#ftn.CHP-18-FN-8" id="CHP-18-FN-8">192</a>]</sup></p>
    </div>

    <div class="sect2" title="18.2.2 Adding NagVis maps to the Nagios Web interface">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="adding_nagvis_maps_to_the_nagios_web_int"/>18.2.2 Adding NagVis maps to the Nagios Web interface</h2>
      </div>

      <p>NagVis maps can also be integrated into the Nagios Web interface. <a class="xref" href="../Text/ch18s02.html#nagvis_map_as_a_footnote_in_the_nagios" title="Figure 18-10. NagVis map as a &quot;footnote&quot; in the Nagios Web interface">Figure 18-10</a> shows these after a third frame has been added to the <strong class="userinput"><code>index.html</code></strong> page, which binds a 32-pixel-high map beneath the main window. No matter what the administrator is currently working on, the most important states (here these are the host groups) are always displayed directly and can be reached with a single mouse click. There are no limits to your user interface dreams when using NagVis!<a class="indexterm" id="IDX-CHP-18-1456"/></p>

      <div class="figure">
        <a id="nagvis_map_as_a_footnote_in_the_nagios"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject3_d1e35429"/><img alt="NagVis map as a &quot;footnote&quot; in the Nagios Web interface" src="../Images/tagoreillycom20081104nostarchimages223958.png.jpg"/></div>

        <p class="title">Figure 18-10. NagVis map as a "footnote" in the Nagios Web interface</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-18-FN-8" id="ftn.CHP-18-FN-8">192</a>]</sup> <a class="ulink" href="http://www.nagvis.org/docs">http://www.nagvis.org/docs</a></p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;19.&#xA0;Graphic Display of Performance Data">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="graphic_display_of_performance_data"/>Chapter 19. Graphic Display of Performance Data</h1>
    </div>

    <p>When Nagios reports to the administrator quickly and selectively on problems that have occurred, it can basically only distinguish between OK states and error states, sparing the admin a flood of information on problematic services and hosts. The graphic display of measured values over a time period cannot be integrated into this "traffic light approach," but it is available through third-party software. Nagios supports external processing of values with an interface created specifically for this. The data processed through it is referred to in Nagios jargon as <span class="emphasis"><em>performance data</em></span>.<a class="indexterm" id="IDX-CHP-19-1457"/></p>

    <p>Nagios has two different classes of performance data. The first is Nagiosinternal performance data, statistics on the performance times of tests and on the difference between the actual test time and the planned time (the <span class="emphasis"><em>latency</em></span>). The second class includes performance data that the plugin passes on with the test result. This involves everything that the plugin can measure: response times, hard drive usage, system load, and so on. These are the very things that are of interest to an administrator, which is why the book concentrates on how they are processed.</p>

    <p>Nagios extracts this data and either writes it to a file where it can be processed by other programs, or passes it on directly to the external software that is run after every service or host check.</p>

    <div class="sect1" title="19.1 Processing Plugin Performance Data with Nagios">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="processing_plugin_performance_data_with"/>19.1 Processing Plugin Performance Data with Nagios</h1>
      </div>

      <p>Performance data provided by service and host checks can be processed only if the corresponding plugin delivers it in a predefined format. As shown here using the <strong class="userinput"><code>check_icmp</code></strong> plugin (<a class="xref" href="../Text/ch06s02.html" title="6.2 Reachability Test with Ping">6.2 Reachability Test with Ping</a>, page 108), it is preceded by a <strong class="userinput"><code>|</code></strong> sign and is not shown in the Web interface:<a class="indexterm" id="IDX-CHP-19-1458"/></p><a id="I_programlisting4_d1e35470"/>
      <pre class="programlisting">nagios@linux:libexec/nagios$ <span class="strong"><strong>./check_icmp -H vpn01</strong></span>
OK - eli02: rta 96.387ms, lost 0%| rta=96.387ms;200.000;500.000;0; pl=0%;
40;80;;</pre>

      <p>This standardized form is provided by most plugins only after version 1.4.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-1" id="CHP-19-FN-1">193</a>]</sup> The performance data itself consists of one or more variables in the following form:<a class="indexterm" id="IDX-CHP-19-1459"/><a class="indexterm" id="IDX-CHP-19-1460"/></p><a id="I_programlisting4_d1e35487"/>
      <pre class="programlisting"><span class="emphasis"><em>name= value ; warn ; crit;min; max</em></span></pre>

      <p>The variable <strong class="userinput"><code><em class="replaceable"><code>name</code></em></code></strong> may contain spaces, but then it must be surrounded by single quotation marks. After the equals sign comes first the measured value as an integer or floating-point decimal, with or without a unit. Possible units are <strong class="userinput"><code>%</code></strong> (percentage), <strong class="userinput"><code>s</code></strong> (time in seconds), <strong class="userinput"><code>B</code></strong> (data size in bytes), or <strong class="userinput"><code>c</code></strong> (counter, an incremental counter).<a class="indexterm" id="IDX-CHP-19-1461"/></p>

      <p>This is followed, separated by a semicolon, by the warning and critical limits, and then the minimum and maximum value. Percentage values can be left out by the plugin. You can also specify <strong class="userinput"><code>0</code></strong> for minimum/maximum, as well as for the warning or critical limit, if there is no such threshold value. If there are several variables, these are separated with spaces, as in the <strong class="userinput"><code>check_icmp</code></strong> example. However, in contrast to this, the final specification should <span class="emphasis"><em>not</em></span> end with a semicolon, according to the Developer Guidelines.</p>

      <div class="sect2" title="19.1.1 The template mechanism">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="the_template_mechanism"/>19.1.1 The template mechanism</h2>
        </div>

        <p>Nagios has two methods of processing performance data: either the system saves the data to a file using a <span class="emphasis"><em>template</em></span>, or it executes an external command. If you just want to write data consistently to a log file, the template procedure is somewhat easier to configure.<a class="indexterm" id="IDX-CHP-19-1462"/><a class="indexterm" id="IDX-CHP-19-1463"/><a class="indexterm" id="IDX-CHP-19-1464"/><a class="indexterm" id="IDX-CHP-19-1465"/><a class="indexterm" id="IDX-CHP-19-1466"/></p>

        <p>In order that Nagios can process performance data at all, the parameter</p><a id="I_programlisting4_d1e35558"/>
        <pre class="programlisting"># /etc/nagios/nagios.cfg
...
process_performance_data=1
...</pre>

        <p>must be set to <strong class="userinput"><code>1</code></strong>. The file to which Nagios writes the host or service performance data is specified by the parameters <strong class="userinput"><code>host_perfdata_file</code></strong> and <strong class="userinput"><code>service_perfdata_file:</code></strong><a class="indexterm" id="IDX-CHP-19-1467"/></p><a id="I_programlisting4_d1e35573"/>
        <pre class="programlisting"># /etc/nagios/nagios.cfg
...
# host_perfdata_file=/var/nagios/host-perfdata.dat
service_perfdata_file=/var/nagios/service-perfdata.dat
# host_perfdata_file_template=[HOSTPERFDATA]\t$TIMET$\t$HOSTNAME$\t$HOST
EXECUTIONTIME$\t$HOSTOUTPUT$\t$HOSTPERFDATA$
service_perfdata_file_template=[SERVICEPERFDATA]\t$TIMET$\t$HOSTNAME$\t$
SERVICEDESC$\t$SERVICEEXECUTIONTIME$\t$SERVICELATENCY$\t$SERVICEOUTPUT$\
t$SERVICEPERFDATA$
...</pre>

        <p>If <strong class="userinput"><code>host_perf data_file</code></strong> is commented out, as in this example, Nagios does not save any performance data of host checks. But since they are only used if all service checks fail, it lies in the nature of host checks that they only provide data sporadically and at irregular intervals. This is why it is not worth evaluating them in most cases.</p>

        <p>The <strong class="userinput"><code>*_perf data_file_template</code></strong> parameters define the output format. The definition shown above, <strong class="userinput"><code>service_perfdata_file_template</code></strong>, delivers (one-line) log file entries in the following pattern:</p><a id="I_programlisting4_d1e35588"/>
        <pre class="programlisting">[SERVICEPERFDATA]       1114353266     linux01 PING  0.483    0.104 OK
- 10.128.254.12: rta 100.436ms, lost 0% rta=100.436ms;3000.000;6000.000
;0; pl=0%;40;80;;</pre>

        <p>Each line begins with a <strong class="userinput"><code>[SERVICEPERFDATA]</code></strong> "stamp," followed by the test time in epoch seconds <strong class="userinput"><code>($TIMET$)</code></strong>, the host name and service description (<strong class="userinput"><code>$HOSTNAME$</code></strong> and <strong class="userinput"><code>$SERVICEDESC$</code></strong>), the time Nagios requires for the test (<strong class="userinput"><code>$SERVICEEXECUTIONTIME$</code></strong>), and the latency between the planned and actual time of performance (<strong class="userinput"><code>$SERVICELATENCY$</code></strong>), each separated by a tab.</p>

        <p>Then Nagios writes the output for the Web interface to the log file (<strong class="userinput"><code>$SER-VICEOUTPUT$</code></strong>) and finally the actual performance data (<strong class="userinput"><code>$SERVICEPERF-DATA$</code></strong>). <strong class="userinput"><code>\t</code></strong> in the parameter definition ensures that a tab separates the individual details from each other in the log. With the <strong class="userinput"><code>*_perfdata_file_mode</code></strong> parameters you can define whether Nagios appends the data to an existing file (<strong class="userinput"><code>a</code></strong>) or overwrites the existing file (<strong class="userinput"><code>w</code></strong>):</p><a id="I_programlisting4_d1e35633"/>
        <pre class="programlisting"># /etc/nagios/nagios.cfg
...
<span class="strong"><strong>host_perfdata_file_mode</strong></span>=a
<span class="strong"><strong>service_perfdata_file_mode</strong></span>=a
...</pre>

        <p>This is suitable for external programs that can read the data from a (previously set up) named pipe. This method provides better performance and does not require any space on the hard drive. If the processing software is not running, however, the data may be lost: Nagios does try for a time to continue writing to the pipe, but aborts this process after a timeout if the data cannot be read out.</p>

        <p>Programs that read from a log file generally delete it afterwards, to prevent the file system from overflowing. If the program does not retrieve any data, the file will grow quickly, but nothing will be lost as long as there is still space on the file system.</p>

        <p>It is best to run external evaluation software as a permanent service. But you can also configure Nagios so that it regularly triggers a program for further processing:</p><a id="I_programlisting4_d1e35647"/>
        <pre class="programlisting"># /etc/nagios/nagios.cfg
...
# <span class="strong"><strong>host_perfdata_file_processing_interval</strong></span>=0
# <span class="strong"><strong>service_perfdata_file_processing_interval</strong></span>=0
# <span class="strong"><strong>host_perfdata_file_processing_command</strong></span>=process-host-perfdata-file
# <span class="strong"><strong>service_perfdata_file_processing_command</strong></span>=process-service-perfdata-file</pre>

        <p>With the <strong class="userinput"><code>*_perfdata_file_processing_interval</code></strong> parameters you set an interval in seconds after which Nagios will carry on running the corresponding <strong class="userinput"><code>*_perf data_file_processirLg_command</code></strong> at specific intervals. This command is defined as a normal Nagios command object:</p><a id="I_programlisting4_d1e35669"/>
        <pre class="programlisting"># misccommands.cfg
...
define command{
    command_name   <span class="strong"><strong>process-service-perfdata-file</strong></span>
    command_line   <span class="emphasis"><em>/path/to_the/evaluation_program</em></span>
}
...</pre>

        <p>As long as the external software itself looks after the further processing of the file with the performance data, you do need to use the <strong class="userinput"><code>*_perf data_file_processing_*</code></strong> parameters.</p>
      </div>

      <div class="sect2" title="19.1.2 Using external commands to process performance data">
        <div class="titlepage">
          <h2 class="title" id="heading_id_5"><a id="using_external_commands_to_process_perf"/>19.1.2 Using external commands to process performance data</h2>
        </div>

        <p>As an alternative to the template method, Nagios can also directly call a command that takes over further processing of data. This is done directly after each test result; so after each individual check, an external program is started. If you have a large number of services to be checked, this can, depending on the software, considerably degrade performance.<a class="indexterm" id="IDX-CHP-19-1468"/><a class="indexterm" id="IDX-CHP-19-1469"/></p>

        <p>The command itself is defined with the <strong class="userinput"><code>process_perfdata_command</code></strong> parameter instead of the <strong class="userinput"><code>perfdata_file</code></strong> parameter:<a class="indexterm" id="IDX-CHP-19-1470"/></p><a id="I_programlisting4_d1e35708"/>
        <pre class="programlisting"># /etc/nagios/nagios.cfg
...
process_performance_data=1
<span class="strong"><strong>service_perfdata_command</strong></span>=process-service-perfdata
...</pre>

        <p>In the same way as with service performance data, you can also process the results of host checks, using the <strong class="userinput"><code>host_perfdata_command</code></strong> parameter. <strong class="userinput"><code>process-service-perfdata</code></strong> itself again refers to a normal Nagios command object:<a class="indexterm" id="IDX-CHP-19-1472"/><a class="indexterm" id="IDX-CHP-19-1471"/></p><a id="I_programlisting4_d1e35727"/>
        <pre class="programlisting"># misccommands.cfg
...
define command{
   command_name   <span class="strong"><strong>process-service-perfdata</strong></span>
   command_line   <span class="emphasis"><em>/pfad/zum/programm</em></span> "$LASTSERVICECHECK$||$HOSTNAME$||$
SERVICEDESC$||$SERVICEOUTPUT$||$SERVICEPERFDATA$"
}
...</pre>

        <p>This opens the external program, which is given the necessary information as arguments. This should include at least the timestamp of the last service check (<strong class="userinput"><code>$LASTSERVICECHECK$</code></strong>), the host name (<strong class="userinput"><code>$HOSTNAME$</code></strong>), and the service description (<strong class="userinput"><code>$SERVICEDESC$</code></strong>), as well as the actual service performance data (<strong class="userinput"><code>$SERVICEPERFDATA$</code></strong>). The delimiter depends on the program used: this example uses <strong class="userinput"><code>||</code></strong>, as is used by the Nagiosgraph program.<a class="indexterm" id="IDX-CHP-19-1473"/></p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-1" id="ftn.CHP-19-FN-1">193</a>]</sup> Some tools such as Nagiosgraph and NagiosGrapher make use of the fact that the remaining text normally contains performance data as well. If they are correspondingly configured, they are able to extract the performance data contained there. In this way they can further process data that does not conform to the standard format.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="19.2 Graphs for the Web with Nagiosgraph">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="graphs_for_the_web_with_nagiosgraph"/>19.2 Graphs for the Web with Nagiosgraph</h1>
    </div>

    <p>With the program Nagiosgraph from <a class="ulink" href="http://nagiosgraph.sf.net/">http://nagiosgraph.sf.net/</a>, performance data supplied by plugins can be displayed graphically in a Web interface in chronological form. The software consists of two Perl scripts. The script <strong class="userinput"><code>insert.pl</code></strong> writes the Nagios performance data to a round-robin database, a ring buffer in which the newest data overwrites the oldest.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-2" id="CHP-19-FN-2">194</a>]</sup> The advantage of this is the small amount of space required, which can be defined beforehand.<a class="indexterm" id="IDX-CHP-19-1476"/><a class="indexterm" id="IDX-CHP-19-1474"/><a class="indexterm" id="IDX-CHP-19-1475"/></p>

    <p>The trick consists of saving data in various resolutions, depending on its age: older data with a lower resolution (e.g., one measurement value per day), current data with a high resolution (e.g., one measurement every five minutes). When setting up the database, you also define how long the data is retained. This defines space requirements right from the beginning.</p>

    <p>Provided that Nagiosgraph detects the performance data, the program creates a separate round-robin database for each new service, when it appears for the first time. The <strong class="userinput"><code>map</code></strong> configuration file included describes just a few services, so that usually some manual work—and a basic knowledge of Perl—is required.<a class="indexterm" id="IDX-CHP-19-1477"/></p>

    <p>The second Nagiosgraph script <strong class="userinput"><code>show.cgi</code></strong>, a CGI script, represents the information from the database in a dynamic HTML page. To do this, it is run (after configuration is completed) in the form</p><a id="I_programlisting4_d1e35800"/>
    <pre class="programlisting">http://nagsrv/<span class="emphasis"><em>path/to</em></span>/show.cgi?host=<span class="emphasis"><em>host</em></span>&amp;service=<span class="emphasis"><em>service_description</em></span></pre>

    <p>Nagiosgraph then displays four graphs (a daily, a weekly, a monthly, and a yearly summary) for the desired service.</p>

    <div class="sect2" title="19.2.1 Basic installation">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="basic_installation"/>19.2.1 Basic installation</h2>
      </div>

      <p>An installed RRDtool package, which is contained in most Linux distributions, is a prerequisite for Nagiosgraph. Alternatively you can obtain the current source code from <a class="ulink" href="http://www.rrdtool.org/">http://www.rrdtool.org/</a>.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-3" id="CHP-19-FN-3">195</a>]</sup> For reasons of performance, it is recommended here that you also install the included Perl module <strong class="userinput"><code>RRDs</code></strong>.</p>

      <p>The Nagiosgraph tar file itself is preferably unpacked in the directory <strong class="userinput"><code>/usr/local/nagios</code></strong>:</p><a id="I_programlisting4_d1e35833"/>
      <pre class="programlisting">nagios@linux:local/nagios$ <span class="strong"><strong>tar xvzf nagiosgraph-0.5.tar.gz</strong></span>
nagiosgraph/INSTALL
nagiosgraph/README
nagiosgraph/README.map
nagiosgraph/insert.pl
nagiosgraph/insert_fast.pl
nagiosgraph/map
nagiosgraph/nagiosgraph.conf
nagiosgraph/show.cgi
nagiosgraph/testcolor.cgi
nagiosgraph/testentry.pl</pre>

      <p><strong class="userinput"><code>insert.pl</code></strong> extracts the data transferred by Nagios and inserts this into the RRD database. If this does not exist, however, the script will create it. Alternatively <strong class="userinput"><code>insert_fast.pl</code></strong> can take on this task. This script uses the Perl module <strong class="userinput"><code>RRDs</code></strong>, which is considerably more efficient than calling up <strong class="userinput"><code>rrdtool</code></strong> as an external program each time, which is what <strong class="userinput"><code>insert.pl</code></strong> does.<a class="indexterm" id="IDX-CHP-19-1478"/></p>

      <p>Another Perl script called <strong class="userinput"><code>testentry.pl</code></strong> helps if you are testing your own <strong class="userinput"><code>map</code></strong> entries. But since you have to write these directly into this file, you can also change the <strong class="userinput"><code>map</code></strong> file itself (as shown below)—provided you have made a backup copy first. The CGI script <strong class="userinput"><code>testcolor.cgi</code></strong> looks more like a developer's utility left over in the package, rather than a tool that is of any use for users.</p>

      <p>Apart from the already mentioned <strong class="userinput"><code>map</code></strong> configuration file, there is a second one, <strong class="userinput"><code>nagiosgraph.conf</code></strong>, and its path must be defined correctly in both <strong class="userinput"><code>insert.pl</code></strong> (or <strong class="userinput"><code>insert_fast.pl</code></strong>) and <strong class="userinput"><code>show.cgi</code></strong>, so it is recommended that you check this:</p><a id="I_programlisting4_d1e35888"/>
      <pre class="programlisting">my $configfile = '/usr/local/nagios/nagiosgraph/nagiosgraph.conf';</pre>
    </div>

    <div class="sect2" title="19.2.2 Configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="configuration-id1"/>19.2.2 Configuration</h2>
      </div>

      <div class="sect3" title="The configuration file nagiosgraph.conf">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="the_configuration_file_nagiosgraph.conf"/>The configuration file <strong class="userinput"><code>nagiosgraph.conf</code></strong></h3>
        </div>

        <p>All other relevant paths—such as those to the <strong class="userinput"><code>map</code></strong> file and to the <strong class="userinput"><code>rrdtool</code></strong>—are adjusted in <strong class="userinput"><code>nagiosgraph.conf</code></strong>:</p><a id="I_programlisting4_d1e35909"/>
        <pre class="programlisting">rrdtool = /usr/bin/rrdtool
rrddir  = /var/lib/rrd/nagiosgraph
logfile = /var/nagios/nagiosgraph.log
mapfile = /usr/local/nagios/nagiosgraph/map
debug   = 2
colorscheme = 4</pre>

        <p>Nagiosgraph creates the RRD databases in the <strong class="userinput"><code>rrddir</code></strong> directory. Here the user <strong class="userinput"><code>nagios</code></strong> must have write access and the user with whose rights the Web server is running must have read access:</p><a id="I_programlisting4_d1e35919"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>mkdir -p /var/lib/rrd/nagiosgraph</strong></span>
linux:~ # <span class="strong"><strong>chown nagios.nagcmd /var/lib/rrd/nagiosgraph</strong></span>
linux:~ # <span class="strong"><strong>chmod 755 /var/lib/rrd/nagiosgraph</strong></span></pre>

        <p>The log file, for which both users need write access (the Web user because the CGI script also records information to the log file), is also critical:</p><a id="I_programlisting4_d1e35931"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>touch /var/nagios/nagiosgraph.log</strong></span>
linux:~ # <span class="strong"><strong>chown nagios.nagcmd /var/nagios/nagiosgraph.log</strong></span>
linux:~ # <span class="strong"><strong>chmod 775 /var/nagios/nagiosgraph.log</strong></span></pre>

        <p>How verbose Nagiosgraph is can be adjusted with <strong class="userinput"><code>debug</code></strong>. The possible debug levels are documented in the configuration file included: <strong class="userinput"><code>2</code></strong> means "errors," <strong class="userinput"><code>4</code></strong> "information"—here Nagiosgraph is already so verbose that you must watch out that the file system does not overflow. Except for debugging purposes (such as when setting up the system), it is better to choose <strong class="userinput"><code>2</code></strong>.</p>

        <p>With <strong class="userinput"><code>colorscheme</code></strong>, which can accept values from 1 to 8, you can influence the amount of color in the graphs—it is best to try out the options to see which color scheme matches your personal taste best.</p>
      </div>

      <div class="sect3" title="Nagios configuration">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="nagios_configuration-id3"/>Nagios configuration</h3>
        </div>

        <p>Nagiosgraph grabs the performance data directly from Nagios. For this reason <strong class="userinput"><code>nagios.cfg</code></strong> does not require any <strong class="userinput"><code>*_perfdata_file_*</code></strong> parameters.<a class="indexterm" id="IDX-CHP-19-1481"/><a class="indexterm" id="IDX-CHP-19-1479"/><a class="indexterm" id="IDX-CHP-19-1480"/></p><a id="I_programlisting4_d1e35986"/>
        <pre class="programlisting"># /etc/nagios/nagios.cfg
...
process_performance_data=1
service_perfdata_command=<span class="strong"><strong>process-service-perfdata</strong></span>
...</pre>

        <p><strong class="userinput"><code>process_performance_data</code></strong> switches on processing of performance data in general; <strong class="userinput"><code>service_perfdata_command</code></strong> refers to the Nagios command object that contains the external command:<a class="indexterm" id="IDX-CHP-19-1482"/><a class="indexterm" id="IDX-CHP-19-1483"/></p><a id="I_programlisting4_d1e36004"/>
        <pre class="programlisting"># misccommands.cfg
...
define command{
  command_name<span class="strong"><strong>   process-service-perfdata</strong></span>
  command_line   /usr/local/nagios/nagiosgraph/insert_fast.pl "$LASTSERV
ICECHECK$||$HOSTNAME$||$SERVICEDESC$||$SERVICEOUTPUT$||$SERVICEPERFDATA$"
}
...</pre>

        <p>The definition of the parameter <strong class="userinput"><code>command_line</code></strong> must be written on one line (without the backslashes <strong class="userinput"><code>\</code></strong>), as usual.</p>

        <p>So that the CGI script can run directly from the Nagios Web interface, a <strong class="userinput"><code>serviceextinfo</code></strong> object is defined:</p><a id="I_programlisting4_d1e36022"/>
        <pre class="programlisting">define serviceextinfo{
    service_description PING
    host_name       *
    notes_url       /nagiosgraph/show.cgi?host=$HOSTNAME$&amp;service=PING
    icon_image      graph.gif
    icon_image_alt  show graphics
}</pre>

        <p>If the graphic defined in <strong class="userinput"><code>icon_image</code></strong> is in the directory <strong class="userinput"><code>/usr/local/nagios/share/images/logos</code></strong>, the Web interface marks the <strong class="userinput"><code>PING</code></strong> services for all hosts in the status display with this.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-4" id="CHP-19-FN-4">196</a>]</sup> Here the strength of show.cgi can be seen: only because this script is called explicitly with host and service names is a definition like the one above possible. Instead of an individual host name, you can also specify a host group, or, as in this example, a <strong class="userinput"><code>*</code></strong>. A requirement for this is that PING really is defined as a service for every host.</p>

        <p>The <strong class="userinput"><code>$HOSTNAME$</code></strong> macro then automatically inserts the appropriate host. The additional information for a specific service type (which must have the same service description in all hosts) can therefore be catered for with just one single definition.</p>
      </div>

      <div class="sect3" title="Apache configuration">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="apache_configuration"/>Apache configuration</h3>
        </div>

        <p>So that the Apache Web server can accept the CGI script as it is, a <strong class="userinput"><code>Script-Alias</code></strong> is created, for example:<a class="indexterm" id="IDX-CHP-19-1484"/><a class="indexterm" id="IDX-CHP-19-1485"/></p><a id="I_programlisting4_d1e36070"/>
        <pre class="programlisting">ScriptAlias /nagiosgraph/ /usr/local/nagios/nagiosgraph/</pre>

        <p>This entry is best placed in the configuration file discussed in <a class="xref" href="../Text/ch01s05.html" title="1.5 Configuration of the Web Interface">1.5 Configuration of the Web Interface</a> (page 47), <strong class="userinput"><code>nagios.conf</code></strong>. Only after Apache is reloaded can the CGI script be run from the URL specified in <a class="xref" href="../Text/ch19s02.html" title="19.2 Graphs for the Web with Nagiosgraph">19.2 Graphs for the Web with Nagiosgraph</a>.</p>
      </div>

      <div class="sect3" title="Adjustments to the map">
        <div class="titlepage">
          <h3 class="title" id="heading_id_8"><a id="adjustments_to_the_map"/>Adjustments to the map</h3>
        </div>

        <p>Depending on the service, the round-robin database may also save several series of measurements, which can be requested individually through the CGI script:<a class="indexterm" id="IDX-CHP-19-1486"/><a class="indexterm" id="IDX-CHP-19-1487"/><a class="indexterm" id="IDX-CHP-19-1488"/><a class="indexterm" id="IDX-CHP-19-1489"/><a class="indexterm" id="IDX-CHP-19-1490"/><a class="indexterm" id="IDX-CHP-19-1491"/><a class="indexterm" id="IDX-CHP-19-1492"/></p><a id="I_programlisting4_d1e36121"/>
        <pre class="programlisting">http://nagsrv/<span class="emphasis"><em>path/to</em></span>/show.cgi?host=<span class="emphasis"><em>host</em></span>&amp;service=<span class="emphasis"><em>service_description</em></span>&amp;db=
<span class="emphasis"><em>database,entry1,entry2</em></span>&amp;db=<span class="emphasis"><em>database,entry3</em></span></pre>

        <p>The database used here contains at least three different series of measurements, the first two of which are shown together in one graphic, while the third is shown in a separate graphic. What is shown together and what is separate depends on the standardization. It makes little sense to display the percentage load of a hard drive and the absolute value in bytes in the same graphic, since the Y axis can only have one scale. It is better here to display percentage values in one graphic and absolute byte values in a second one. On the other hand you can display the various average values of the system load (for one, five, and 15 minutes) in a single graphic. If you leave out all <strong class="userinput"><code>db</code></strong>= specifications, Nagiosgraph always displays all measured values for a service in a single graphic.</p>

        <p>What individual databases and measured values display is defined by the <strong class="userinput"><code>map</code></strong> file. To understand how the instructions contained there influence the extraction of data, you just need to switch the debugging level to <strong class="userinput"><code>4</code></strong> and take a look at the output in the log file <strong class="userinput"><code>nagiosgraph.log</code></strong>. Each time the insert function is run, Nagiosgraph rereads the configuration files, so that this does not cause any kind of reset.<a class="indexterm" id="IDX-CHP-19-1493"/></p>

        <p>In the following extract from the log file the three dots mark sections which we will not print, for the sake of clarity:</p><a id="I_programlisting4_d1e36158"/>
        <pre class="programlisting">... INSERT info:... servicedescr:PING
... INSERT info:... hostname:linux01
... INSERT info:... perfdata:rta=99.278ms;3000.000;7000.000;0; pl=0%;60;
80;;
... INSERT info:... lastcheck:1114853435
... INSERT info:... output:OK - 172.17.4.11: rta 99.278ms, lost 0%</pre>

        <p>The output is from the <strong class="userinput"><code>check_icmp</code></strong> plugin. The host name, service description, performance data, (<strong class="userinput"><code>perfdata:</code></strong>) and the standard output line (<strong class="userinput"><code>output:</code></strong>) each have their own line. In the performance data the plugin announces the <span class="emphasis"><em>round trip average</em></span> with the variable <strong class="userinput"><code>rta</code></strong>, and the number of packets that have gone missing with <strong class="userinput"><code>pl</code></strong> (<span class="emphasis"><em>packet loss</em></span>).</p>

        <p>The <strong class="userinput"><code>map</code></strong> file contains Perl instructions that filter these outputs and extracts the corresponding data if there are hits. Each of them starts with a search instruction:</p><a id="I_programlisting4_d1e36189"/>
        <pre class="programlisting">/perfdata:rta=([.\d]+)ms.+pl=(\d+)%/</pre>

        <p>The classic Perl search function consists of the two forward slashes <strong class="userinput"><code>/</code></strong> with a search pattern in the form of a regular expression in between. Round pairs of brackets enclose partial patterns with which the text found in this way can later be accessed using the variables <strong class="userinput"><code>$1</code></strong>, <strong class="userinput"><code>$2</code></strong>, etc.</p>

        <p>The pattern in the first bracket thus matches a single digit (<strong class="userinput"><code>\d</code></strong>) or a dot,<sup>[<a class="footnote" href="#ftn.CHP-19-FN-5" id="CHP-19-FN-5">197</a>]</sup> and the next + states that there can be several of them (or none at all). In the second round brackets, though, one or more digits are allowed, but no period. In concrete terms <strong class="userinput"><code>$1</code></strong> delivers the numerical value of the response time, <strong class="userinput"><code>$2</code></strong> provides the packet loss in percent.</p>

        <p>The full instruction in the <strong class="userinput"><code>map</code></strong> file links two Perl statements with the <strong class="userinput"><code>and</code></strong> operator:</p><a id="I_programlisting4_d1e36226"/>
        <pre class="programlisting"># -- check_icmp
# perfdata:rta=100.424ms;5000.000;9000 .000;0; pl=0%;40;80;;
/perfdata:rta=([.\d]+)ms.+pl=(\d+)%/
and push @s, [ 'ping',
               [ 'rta',        'GAUGE', $1 ],
               [ 'losspct',    'GAUGE', $2 ],
             ];</pre>

        <p>If the first one—the search function—is successful, then it is the turn of the <strong class="userinput"><code>push</code></strong> statement. It adds the expression in square brackets following to the array <strong class="userinput"><code>@s</code></strong>. The instruction ends with a semicolon. If the search function provides no result, the <strong class="userinput"><code>map</code></strong> instruction will not save any entry in the <strong class="userinput"><code>@s</code></strong> array. The expression to be included in the array has the following format:</p><a id="I_programlisting4_d1e36242"/>
        <pre class="programlisting">[ <span class="emphasis"><em>db-name</em></span>,
      [<span class="emphasis"><em>name_of_data_source, type, value</em></span> ],
      [<span class="emphasis"><em>name_of_data_source, type, value</em></span> ],
      ...
]</pre>

        <p>The file name for a Nagiosgraph database file consists of the host name, service description, and the database name together, for example, <strong class="userinput"><code>linux01_PING_ping.rrd</code></strong>. The desired string for the database name is entered instead of the placeholder <span class="emphasis"><em>db-name</em></span> into the <strong class="userinput"><code>map</code></strong> file (in this case, <strong class="userinput"><code>ping</code></strong>).</p>

        <p>The name of the data source can be chosen freely, but should contain an indication of the data that is stored here, such as <strong class="userinput"><code>rta</code></strong> for the response time or <strong class="userinput"><code>losspct</code></strong> for percentage of packets that have been lost.</p>

        <p>What <span class="emphasis"><em>type</em></span> you specify is determined by the RRD tools. <strong class="userinput"><code>GAUGE</code></strong> stands for simple measured values that are displayed simply as they are. <strong class="userinput"><code>DERIVE</code></strong> is recommended by Nagiosgraph author Soren Dossing for processing counters, such as in querying a packet counter on the network interface. Counters grow incrementally and, when they run over, start again at zero. What is of interest here is the difference between two points in time. The RRD database determines these automatically if the data source type <strong class="userinput"><code>DERIVE</code></strong> is specified.</p>

        <p>The database name, data source, and type should always be placed in single quotation marks in the <strong class="userinput"><code>map</code></strong> file, so that no name conflicts can occur with keywords reserved in Perl.</p>

        <p>The measured value itself is determined using Perl methods, and the placeholder <span class="emphasis"><em>value</em></span> is substituted with the corresponding instructions. In the simplest case, you take over the values found with the search pattern in the performance data with <strong class="userinput"><code>$1</code></strong>, <strong class="userinput"><code>$2</code></strong>, etc. (see example above), or calculate new values from these by multiplying<sup>[<a class="footnote" href="#ftn.CHP-19-FN-6" id="CHP-19-FN-6">198</a>]</sup> by 1024 or by calculating the percentage:</p><a id="I_programlisting4_d1e36309"/>
        <pre class="programlisting"># -- check_nt -v USEDDISKSPACE
# perfdata:C:\ Used Space=1.71Gb;6.40;7.20;0.00;8.00
/perfdata:.*Used Space=([.\d]+)Gb;([.\d]+);([.\d]+);([.\d]+);([.\d]+)/
and push @s,  [ 'disk',
                [ 'used',    'GAUGE', $1*1024 ],
                [ 'usepct',    'GAUGE', ($1/$5)*100 ],
                [ 'freepct', '  'GAUGE', (($5-$1)/$5)*100 ],
];

# -- check_disk (unix)
# perfdata:/=498MB;1090;1175;0;1212
m@perfdata:.*/([^ =]+)=([.\d]+)MB;([.\d]+);([.\d]+);([.\d]+);([.\d]+)@
and push @s, [ $1,
               [ 'used',    'GAUGE',    $2*1024**2 ],
               [ 'warn',    'GAUGE',    $3*1024**2 ],
               [ 'crit',    'GAUGE',    $4*1024**2 ],
];</pre>

        <p>The first entry evaluates the query of hard drive space on a Windows server with <strong class="userinput"><code>check_nt</code></strong> (see <a class="xref" href="../Text/ch20s02.html#nsclient" title="20.2.1 NSClient">20.2.1 NSClient</a>, page 476). The performance data also contains, apart from the occupied space in <strong class="userinput"><code>$1</code></strong>, the size of the data carrier in <strong class="userinput"><code>$5</code></strong>. This can be used to calculate the percentage that is available (<strong class="userinput"><code>freepct</code></strong>) and the percentage used (<strong class="userinput"><code>usepct</code></strong>).</p>

        <p>The second example evaluates data obtained on a Unix host, with <strong class="userinput"><code>check_ disk</code></strong>, by multiplying the free hard drive space specified in MB by 1024<sup>2</sup> to convert it to bytes. The critical and warning limits always remain constant, which leads to horizontal lines, as seen in <a class="xref" href="../Text/ch19s02.html#used_space_and_limit_values_for_the_fil" title="Figure 19-1. Used space and limit values for the file system /net/linux01/a on the host linux0l, as Nagiosgraph represents them">Figure 19-1</a>: the lower line at 12.1 GB represents the warning limit, the middle line the current load, and the top line at 18.1 GB, the critical limit. The keys for the individual graphs each list minimum, maximum, and average as a numerical value. This differentiation for the two limit values is not of any use, but it cannot be avoided, since Nagiosgraph does not know that these are constant values: it treats warning and critical limits just like any other measured values.</p>

        <p>If a plugin does not provide any performance data, but values that are used in normal output, the search function can be applied to the output (<strong class="userinput"><code>/output:.../</code></strong>) instead of to the performance data. Help is provided, for example, by the Nagiosgraph Forum at <a class="ulink" href="http://sourceforge.net/forum/forum.php?forum_id=394748">http://sourceforge.net/forum/forum.php?forum_id=394748</a>.</p>

        <div class="figure">
          <a id="used_space_and_limit_values_for_the_fil"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e36358"/><img alt="Used space and limit values for the file system /net/linux01/a on the host linux0l, as Nagiosgraph represents them" src="../Images/tagoreillycom20081104nostarchimages223960.png.jpg"/></div>

          <p class="title">Figure 19-1. Used space and limit values for the file system <code class="userinput">/net/linux01/a</code> on the host <code class="userinput">linux0l</code>, as Nagiosgraph represents them</p>
        </div>

        <p>Changes to the <strong class="userinput"><code>map</code></strong> are critical. It is therefore recommended that you copy the file first and edit the copy and then perform a syntax check, using <strong class="userinput"><code>perl -c</code></strong>:</p><a id="I_programlisting4_d1e36371"/>
        <pre class="programlisting">nagios@linux:libexec/nagios$ <span class="strong"><strong>cp map map.new</strong></span>
nagios@linux:libexec/nagios$ <span class="strong"><strong>vi map.new</strong></span>
nagios@linux:libexec/nagios$ <span class="strong"><strong>perl -c map.new</strong></span>
nagios@linux:libexec/nagios$ <span class="strong"><strong>mv map.new map</strong></span></pre>

        <p>If the syntax check is in order, you can install the new file as <strong class="userinput"><code>map</code></strong>.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-2" id="ftn.CHP-19-FN-2">194</a>]</sup> Further information on this topic can be found at <a class="ulink" href="http://www.rrdtool.org/">http://www.rrdtool.org/</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-3" id="ftn.CHP-19-FN-3">195</a>]</sup> To install, see <a class="xref" href="../Text/ch19s04.html#installation-id6" title="19.4.1 Installation">19.4.1 Installation</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-4" id="ftn.CHP-19-FN-4">196</a>]</sup> A more detailed description of the <strong class="userinput"><code>serviceextinfo</code></strong> object is contained in <a class="xref" href="../Text/ch16s04.html#extended_service_information" title="16.4.2 Extended service information">16.4.2 Extended service information</a>, page 366.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-5" id="ftn.CHP-19-FN-5">197</a>]</sup> A pair of square brackets contains alternatives.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-6" id="ftn.CHP-19-FN-6">198</a>]</sup> This turns kilobytes into bytes.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="19.3 Preparing Performance Data for Evaluation with Perf2rrd">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="preparing_performance_data_for_evaluati"/>19.3 Preparing Performance Data for Evaluation with Perf2rrd</h1>
    </div>

    <p>Another tool which transfers Nagios performance data to an RRD database is the Java application Perf2rrd. This requires an installed Java Runtime Environment (<a class="xref" href="../Text/ch01s04.html#plugin_test" title="1.4.2 Plugin test">1.4.2 Plugin test</a>, or preferably <a class="xref" href="../Text/ch01s05.html" title="1.5 Configuration of the Web Interface">1.5 Configuration of the Web Interface</a>). Since the virtual machine generates a noticeable load on less powerful computers, and also requires a large amount of memory, the requirements made of the Nagios server by Perf2rrd are significantly higher than those made by Nagiosgraph.<a class="indexterm" id="IDX-CHP-19-1495"/><a class="indexterm" id="IDX-CHP-19-1494"/></p>

    <p>On the other hand there is no more work after the installation as far as generating the RRD databases is concerned, because Perf2rrd uses the template mechanism of Nagios (see <a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a>, page 404). For each service and each variable contained in the template, the tool creates a separate RRD database using the following naming pattern:</p><a id="I_programlisting4_d1e36410"/>
    <pre class="programlisting"><span class="emphasis"><em>host+service_description+variable_name.rrd</em></span></pre>

    <p>So to evaluate the <strong class="userinput"><code>check_icmp</code></strong> variables <strong class="userinput"><code>rta</code></strong> (<span class="emphasis"><em>round trip average</em></span>) and <strong class="userinput"><code>pl</code></strong> (<span class="emphasis"><em>packet loss</em></span>), the file names are <strong class="userinput"><code>linux01+PING+pl.rrd</code></strong> and <strong class="userinput"><code>linux01+PING+rta.rrd</code></strong>.</p>

    <p>Perf2rrd only looks after the storage of data in an RRD database and does not provide any tools to graphically display the data saved there. The Perf2rrd author Marc DeTrano refers here to the <strong class="userinput"><code>drraw</code></strong> tool (see <a class="xref" href="../Text/ch19s04.html" title="19.4 The Graphics Specialist drraw">19.4 The Graphics Specialist drraw</a>, page 420). It can be advantageous to use this, because on the one hand <strong class="userinput"><code>drraw</code></strong> allows far more than just the one display provided by Nagiosgraph, and on the other hand you do not have to struggle with regular expressions in Perl.</p>

    <div class="sect2" title="19.3.1 Installation">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="installation-id5"/>19.3.1 Installation</h2>
      </div>

      <p>For the installation you should get hold of the archive in tar format from <a class="ulink" href="http://perf2rrd.sf.net/">http://perf2rrd.sf.net/</a>, and copy it, preferably to the <strong class="userinput"><code>/usr/local hierarchy</code></strong>:</p><a id="I_programlisting4_d1e36457"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local</strong></span>
linux:usr/local # <span class="strong"><strong>tar xvzf /</strong></span><span class="bolditalic">path/to</span>/<span class="strong"><strong>perf2rrd-1.0.tar.gz</strong></span>
...
perf2rrd/run
...</pre>

      <p>The executable program that is later run is a script called <strong class="userinput"><code>run</code></strong>, which in turn calls the Java bytecode interpreter, <strong class="userinput"><code>java</code></strong>. Besides this the directory contains the Java class files and other utilities, with which you can recompile the included shared library <strong class="userinput"><code>librrdj.so</code></strong>, if required. This is normally not necessary for the newer distributions.</p>

      <p>In order for <strong class="userinput"><code>run</code></strong> to be able to find the <strong class="userinput"><code>java</code></strong> program, it must be located in <strong class="userinput"><code>/usr/bin</code></strong>. If this is not the case (because you have installed the Java archive from <a class="ulink" href="http://www.sun.com/">http://www.sun.com/</a>, for example), then you should set a link:</p><a id="I_programlisting4_d1e36494"/>
      <pre class="programlisting">linux:~ # ln -s /usr/local/jre1.5.0_02/bin/java/usr/bin/java</pre>

      <p>A short test shows whether or not Perf2rrd starts correctly:</p><a id="I_programlisting4_d1e36498"/>
      <pre class="programlisting">nagios@linux:local/perf2rrd$ <span class="strong"><strong>./run</strong></span>
perf2rrd starting
Using Nagios Config: /etc/nagios/nagios.cfg
Using RRD Repository: /var/log/nagios/rrd
Unable to create RRD Repository</pre>

      <p>The error message issued in the last line is not a problem at the moment, since we have saved the RRD databases in a different directory anyway (<a class="xref" href="../Text/ch19s03.html#perf2rrd_in_permanent_operation" title="Perf2rrd in permanent operation">Perf2rrd in permanent operation</a>).</p>
    </div>

    <div class="sect2" title="19.3.2 Nagios configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="nagios_configuration-id4"/>19.3.2 Nagios configuration</h2>
      </div>

      <p>Perf2rrd searches in the Nagios configuration for all the data it requires: to what file Nagios should write the performance data, the write mode used for this,<sup>[<a class="footnote" href="#ftn.CHP-19-FN-7" id="CHP-19-FN-7">199</a>]</sup> and the format of the template:<a class="indexterm" id="IDX-CHP-19-1496"/><a class="indexterm" id="IDX-CHP-19-1497"/></p><a id="I_programlisting4_d1e36534"/>
      <pre class="programlisting"># /etc/nagios/nagios.cfg
...
process_performance_data=1
...
service_perfdata_file=/var/nagios/service-perfdata.dat

service_perfdata_file_template=$TIMET$\t$HOSTNAME$\t\
   $SERVICEDESC$\t$SERVICEEXECUTIONTIME$\t$SERVICELATENCY$\t\
   $SERVICEOUTPUT$\t$SERVICEPERFDATA$

service_perfdata_file_mode=w
...</pre>

      <p>The named pipe used here, thanks to <strong class="userinput"><code>service_perfdata_file_mode=w</code></strong>, must be created manually—Perf2rrd 1.0 in Nagios 2.0 has problems with the normal file interface (<strong class="userinput"><code>service_perfdata_file_mode=a</code></strong>):</p><a id="I_programlisting4_d1e36544"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>mknod /var/nagios/service-perfdata.dat p</strong></span>
linux:~ # <span class="strong"><strong>ls -l /var/nagios/service-perfdata.dat</strong></span>
prw-r--r-- 1 nagios nagios 0 May 1 10:49 /var/nagios/service-perfdata.dat</pre>

      <p>In the template the introductory [<strong class="userinput"><code>SERVICEPERFDATA</code></strong>] stamp is missing (see <a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a>), since Perf2rrd 1.0 does not parse this correctly. Changes to the Nagios configuration require a reload:<a class="indexterm" id="IDX-CHP-19-1498"/></p><a id="I_programlisting4_d1e36564"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/nagios reload</strong></span></pre>

      <p>Finally you create the directory for the RRD databases:</p><a id="I_programlisting4_d1e36570"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>mkdir /var/lib/rrd/perf2rrd</strong></span>
linux:~ # <span class="strong"><strong>chown nagios.nagios /var/lib/rrd/perf2rrd</strong></span></pre>
    </div>

    <div class="sect2" title="19.3.3 Perf2rrd in practice">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="perf2rrd_in_practice"/>19.3.3 Perf2rrd in practice</h2>
      </div>

      <p>Loading the Java Virtual Machine each time Perf2rrd is started requires considerable resources. For this reason you should not use the method of startingPerf2rrdwiththeparameter <strong class="userinput"><code>service_perfdata_file_processing_command</code></strong> at specific intervals of Nagios, and also should not use the <span class="emphasis"><em>one-shot mode</em></span>, with <strong class="userinput"><code>./run -o</code></strong>, in which the software processes one file at a time. In theory this would make it possible to run Perf2rrd regularly with a cron job. Instead, it is recommended that you keep the program running permanently.<a class="indexterm" id="IDX-CHP-19-1499"/></p>

      <p>When using this for the first time, we recommend that you switch on the debugging mode, which will show any problems that occur. The option <strong class="userinput"><code>-d</code></strong> specifies the directory in which the tools should create and update the RRD databases:</p><a id="I_programlisting4_d1e36599"/>
      <pre class="programlisting">nagios@linux:local/perf2rrd$ <span class="strong"><strong>./run -d /var/lib/rrd/perf2rrd -x</strong></span>
perf2rrd starting
Using Nagios Config: /etc/nagios/nagios.cfg
Using RRD Repository: /var/lib/rrd/perf2rrd
Debug Mode is on
Reading perfdata from <span class="strong"><strong>named pipe</strong></span>.
Perf Data File is : /var/nagios/service-perfdata.dat
I believe we are using Nagios ver. 2
Object Cache File is : /var/nagios/objects.cache
<span class="strong"><strong>Nagios interval_length 60</strong></span>
called update with: .../eli02+PING+rta.rrd 1114938329:0.079
called update with: .../eli02+PING+pl.rrd 1114938329:0.0
<span class="strong"><strong>/var/lib/rrd/perf2rrd/sap-14+SAP-3202+time.rrd created</strong></span>.
called update with: .../sap-14+SAP-3202+time.rrd 1114938688:0.030775
...</pre>

      <p>The output of the Nagios configuration file, the RRD repository, and the data transfer mode (<strong class="userinput"><code>named pipe</code></strong>) is followed by the time unit used by Nagios (and set with the <strong class="userinput"><code>interval_length</code></strong> parameter). Normally this is 60 seconds, that is, a check interval of <strong class="userinput"><code>5</code></strong> is five minutes long. It is extremely important that this parameter is correctly recognized, since Perf2rrd determines the <span class="emphasis"><em>step interval</em></span> of the RRD database by multiplying the <strong class="userinput"><code>normal_check_interval</code></strong> and <strong class="userinput"><code>interval_length</code></strong> parameters together.</p>

      <p>All measured values that occur during a step interval are averaged by the database. If this time period is too small, it is possible that the database will never issue any values, since it expects considerably more data than it obtains for saving.</p>

      <p>While Nagiosgraph works with a fixed five-minute interval, Perf2rrd adjusts itself to the Nagios configuration. The software only takes into account the interval when creating the RRD database, however; changing the Nagios configuration later on has no further consequences. The only thing you can do here to alter this is delete the RRD database and set it up again.</p>

      <div class="sect3" title="Perf2rrd in permanent operation">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="perf2rrd_in_permanent_operation"/>Perf2rrd in permanent operation</h3>
        </div>

        <p>Operating Perf2rrd on a named pipe has one disadvantage: if Nagios restarts, it closes the pipe before opening it again. Unfortunately when the pipe closes, Perf2rrd closes as well.</p>

        <p>This can be prevented by the use of the Daemon Tools by Daniel J. Bernstein. They monitor programs and restart them, if these programs should ever stop. They are themselves started through an <strong class="userinput"><code>/etc/inittab</code></strong> entry by the init process, and are restarted if they were to shut themselves down at some point. The Daemon Tools tar file can be obtained from <a class="ulink" href="http://cr.yp.to/daemorLtools/install.html">http://cr.yp.to/daemorLtools/install.html</a> and it is unpacked in the directory <strong class="userinput"><code>/usr/local/src</code></strong>:<a class="indexterm" id="IDX-CHP-19-1500"/></p><a id="I_programlisting4_d1e36656"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/src</strong></span>
linux:local/src # <span class="strong"><strong>tar xvzf <span class="emphasis"><em>/path/to/</em></span>daemontools-0.76.tar.gz</strong></span>
admin
admin/daemontools-0.76
admin/daemontools-0.76/package
admin/daemontools-0.76/package/README
...
admin/daemontools-0.76/src</pre>

        <p>This creates the directory <strong class="userinput"><code>admin/daemontools-0.76</code></strong>, with the subdirectories <strong class="userinput"><code>package</code></strong> and <strong class="userinput"><code>src</code></strong>. From there you should run the <strong class="userinput"><code>install</code></strong> script, which compiles and installs the program:</p><a id="I_programlisting4_d1e36681"/>
        <pre class="programlisting">linux:local/src # <span class="strong"><strong>cd admin/daemontools-0.76</strong></span>
linux:admin/daemontools-0.76 # <span class="strong"><strong>package/install</strong></span></pre>

        <p>The binaries land in the newly created directory <strong class="userinput"><code>daemontools-0.76/com-mand</code></strong> and remain there. The installation routine also sets up symbolic links pointing to them from the—also newly created—folder<strong class="userinput"><code>/command</code></strong>.</p>

        <p>The <strong class="userinput"><code>install</code></strong> script also includes the following line in the file <strong class="userinput"><code>/etc/init-tab</code></strong>, which ensures that the Daemon Tools run permanently:</p><a id="I_programlisting4_d1e36704"/>
        <pre class="programlisting">SV:123456:respawn:/command/svscanboot</pre>

        <p>The program <strong class="userinput"><code>svscanboot</code></strong> searches regularly for new or crashed daemons. For this purpose it scans the <strong class="userinput"><code>/service</code></strong> directory, which is also created during the installation. Just one symbolic link is required to have Perf2rrd monitored:</p><a id="I_programlisting4_d1e36714"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>ln -s /usr/local/perf2rrd /service/perf2rrd</strong></span></pre>

        <p>The Daemon Tools search in this directory for a script called <strong class="userinput"><code>run</code></strong> and start it. In order for <strong class="userinput"><code>run</code></strong> to be able to find the path to the RRD repository, an actual command-line option is entered in the script file instead of <strong class="userinput"><code>$*</code></strong>:</p><a id="I_programlisting4_d1e36730"/>
        <pre class="programlisting"># exec java -cp $classpath perf2rrd $*
exec java -cp $classpath perf2rrd -d /var/lib/rrd/perf2rrd</pre>

        <p>Starting and ending Perf2rrd is now taken over by the program <strong class="userinput"><code>svc</code></strong>:</p><a id="I_programlisting4_d1e36737"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>/command/svc -d /service/perf2rrd</strong></span>
linux:~ # <span class="strong"><strong>/command/svc -u /service/perf2rrd</strong></span></pre>

        <p>The <strong class="userinput"><code>-d</code></strong> option (for <span class="emphasis"><em>down</em></span>) stops the service specified, and <strong class="userinput"><code>-u</code></strong> (<span class="emphasis"><em>up</em></span>) starts it again. It is not necessary to run it at the beginning, since the Daemon Tools regularly scan the <strong class="userinput"><code>/service</code></strong> directory for new services and automatically start them. This is important insofar as the Nagios-2.0 beta versions, on which this book is based, had problems if the configured named pipe was not read. Then it might not deliver any more data at all until a reload or restart. Whether this problem has been fixed in the final version 2.0 of Nagios could not be clarified at the time of going to press.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-7" id="ftn.CHP-19-FN-7">199</a>]</sup> With <strong class="userinput"><code>a</code></strong>, Nagios appends the data to a normal log file; with <strong class="userinput"><code>w</code></strong> it makes it accessible through a named pipe. See <a class="xref" href="../Text/ch19.html#processing_plugin_performance_data_with" title="19.1 Processing Plugin Performance Data with Nagios">19.1 Processing Plugin Performance Data with Nagios</a>, page 404.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="19.4 The Graphics Specialist drraw">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_graphics_specialist_drraw"/>19.4 The Graphics Specialist <strong class="userinput"><code>drraw</code></strong></h1>
    </div>

    <p>From the RRD databases, generated for example by Perf2rrd or Nagios-graph, the CGI script <strong class="userinput"><code>drraw</code></strong> creates interactive graphics—simple ones relatively quicky, whereas for more complex ones you need to know a bit more about the RRDtools.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-8" id="CHP-19-FN-8">200</a>]</sup><a class="indexterm" id="IDX-CHP-19-1502"/><a class="indexterm" id="IDX-CHP-19-1503"/><a class="indexterm" id="IDX-CHP-19-1504"/><a class="indexterm" id="IDX-CHP-19-1501"/></p>

    <div class="sect2" title="19.4.1 Installation">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="installation-id6"/>19.4.1 Installation</h2>
      </div>

      <p>For the <strong class="userinput"><code>drraw</code></strong> installation, you need to obtain the current tar file from <a class="ulink" href="http://www.taranis.org/drraw/">http://www.taranis.org/drraw/</a> and unpack it to its own subdirectory in the CGI hierarchy<sup>[<a class="footnote" href="#ftn.CHP-19-FN-9" id="CHP-19-FN-9">201</a>]</sup> on the Web server:</p><a id="I_programlisting4_d1e36812"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/lib/cgi-bin</strong></span>
linux:lib/cgi-bin # <span class="strong"><strong>tar xvzf</strong></span> <span class="bolditalic">/path/to/</span><span class="strong"><strong>drraw-2.1.1.tar.gz</strong></span>
drraw-2.1.1/
...
drraw-2.1.1/drraw.cgi
drraw-2.1.1/drraw.conf
drraw-2.1.1/icons/
...</pre>

      <p>The directory created by this is then renamed to <strong class="userinput"><code>drraw</code></strong>:<sup>[<a class="footnote" href="#ftn.CHP-19-FN-10" id="CHP-19-FN-10">202</a>]</sup><a class="indexterm" id="IDX-CHP-19-1505"/></p><a id="I_programlisting4_d1e36836"/>
      <pre class="programlisting">linux:lib/cgi-bin # <span class="strong"><strong>mv drraw-2.1.1 drraw</strong></span></pre>

      <p><strong class="userinput"><code>drraw.cgi</code></strong> itself requires, apart from Perl, the Perl CGI module (<strong class="userinput"><code>CGI.pm</code></strong>), and the RRDtools, from at least version 1.0.47; nothing will work below version 1.0.36. If your distribution does not include a current version, you should obtain the sources from <a class="ulink" href="http://www.rrdtool.org/">http://www.rrdtool.org/</a> and compile them yourself:<a class="indexterm" id="IDX-CHP-19-1506"/></p><a id="I_programlisting4_d1e36854"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/src</strong></span>
linux:local/src # <span class="strong"><strong>tar xvzf <span class="emphasis"><em>/path/to/</em></span>rrdtool-1.0.49.tar.gz</strong></span>
...
linux:local/src # <span class="strong"><strong>cd rrdtool-1.0.49</strong></span>
linux:src/rrdtool-1.0..49 # <span class="strong"><strong>./configure</strong></span>
...
linux:src/rrdtool-1.0..49 # <span class="strong"><strong>make</strong></span>
...
linux:src/rrdtool-1.0..49 # <span class="strong"><strong>make install</strong></span>
...
linux:src/rrdtool-1.0..49 # <span class="strong"><strong>make site-perl-install</strong></span></pre>

      <p>The CGI script <strong class="userinput"><code>drraw.cgi</code></strong> uses the Perl module <strong class="userinput"><code>RRDs</code></strong>, which after the installation with <strong class="userinput"><code>make site-perl-install</code></strong>, is found automatically.<a class="indexterm" id="IDX-CHP-19-1507"/></p>
    </div>

    <div class="sect2" title="19.4.2 Configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="configuration-id2"/>19.4.2 Configuration</h2>
      </div>

      <p>The <strong class="userinput"><code>drraw</code></strong> configuration is contained in the file <strong class="userinput"><code>drraw.conf</code></strong>:</p><a id="I_programlisting4_d1e36907"/>
      <pre class="programlisting">linux:cgi-bin/drraw # <span class="strong"><strong>egrep -v '^#|^$' drraw.conf</strong></span>
...
%datadirs = ('/var/lib/rrd' ⇒ '[RRDbase]',
            );
$vrefresh = '120';
@dv_def = ( 'end - 6 hours', 'end - 28 hours', 'end - 1 week', 'end - 1
month', 'end - 1 year' );
@dv_name = ( 'Past 6 Hours', 'Past 28 Hours', 'Past Week', 'Past Month',
'Past Year' );
@dv_secs = ( 21600, 100800, 604800, 2419200, 31536000 );
$saved_dir = '/var/lib/drraw/saved';
$tmp_dir = '/var/lib/drraw/tmp';
...</pre>

      <p>The extract shown specifies the RRD repository (here: <strong class="userinput"><code>/var/lib/rrd</code></strong>) as the most important detail, but several directories can also be specified:</p><a id="I_programlisting4_d1e36917"/>
      <pre class="programlisting">%datadirs = ('/var/lib/rrd' ⇒ '[RRDbase]',
             '/data/rrd'    ⇒ '[RRDdata]',
            );</pre>

      <p>The text in square brackets (e.g., [<strong class="userinput"><code>RRDbase</code></strong>]) appears later on the Web interface, which allows a distinction to be made between various different repositories. The variables <strong class="userinput"><code>@dv_def</code></strong>, <strong class="userinput"><code>@dv_name</code></strong>, and <strong class="userinput"><code>@dv_secs</code></strong> influence the layout and number of graphics.</p>

      <p>The configuration shown above generates one graphic more than the standard configuration. This represents the past six hours: the extended statement <strong class="userinput"><code>'end--6 hours'</code></strong> in <strong class="userinput"><code>@dv_def</code></strong> describes the time period for <strong class="userinput"><code>rrdtool</code></strong> (see <strong class="userinput"><code>man rrdgraph</code></strong>), in <strong class="userinput"><code>@dv_name</code></strong> the representation is given a suitable title with <strong class="userinput"><code>'Past 6 Hours'</code></strong>, and <strong class="userinput"><code>@dv_secs</code></strong> contains the six hours, converted into (<strong class="userinput"><code>21600</code></strong>) seconds, displayed by <strong class="userinput"><code>drraw</code></strong> as a time period in a separate graphic.</p>

      <p>The repository must be readable for the user with whose rights the Web server is running, and the directories specified in <strong class="userinput"><code>$saved_dir</code></strong> and <strong class="userinput"><code>$tmp_dir</code></strong> must also be readable. If a user other than <strong class="userinput"><code>www-data</code></strong> runs this, the following command must be adapted accordingly:</p><a id="I_programlisting4_d1e36974"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>mkdir -p /var/lib/drraw/{saved,tmp}</strong></span>
linux:~ # <span class="strong"><strong>chown -R www-data.www-data /var/lib/drraw</strong></span></pre>

      <p>Data arrives in the temporary directory <strong class="userinput"><code>$temp_dir</code></strong>, whose contents can be deleted at any time, whereas in <strong class="userinput"><code>$saved_dir drraw</code></strong> stores configuration data which the program needs in order to access already created graphics later on. This data must not be lost.</p>

      <p><strong class="userinput"><code>drraw</code></strong> implements asimple access protection in three stages: read-only (<strong class="userinput"><code>0</code></strong>), restricted editing (<strong class="userinput"><code>1</code></strong>), and full access (<strong class="userinput"><code>2</code></strong>). Users logged in to the Web server automatically obtain level 2. Nonauthorized users are treated as <strong class="userinput"><code>guests</code></strong> and assigned level <strong class="userinput"><code>0</code></strong>. To avoid the hassle with authentication at the beginning, you can grant the user <strong class="userinput"><code>guest</code></strong> full access via the following directive in the configuration file:</p><a id="I_programlisting4_d1e37013"/>
      <pre class="programlisting">%users = ( 'guest' ⇒ 2 );</pre>
    </div>

    <div class="sect2" title="19.4.3 Practical application">
      <div class="titlepage">
        <h2 class="title" id="heading_id_5"><a id="practical_application"/>19.4.3 Practical application</h2>
      </div>

      <p>The CGI script in the CGI directory of the Web server can be addressed through the URL <a class="ulink" href="http://nagiosserver/cgi-bin/drraw/drraw.cgi">http://nagiosserver/cgi-bin/drraw/drraw.cgi</a>.<a class="indexterm" id="IDX-CHP-19-1508"/></p>

      <div class="figure">
        <a id="the_ddraw_start_menu"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e37033"/><img alt="The ddraw start menu" src="../Images/tagoreillycom20081104nostarchimages223962.png.jpg"/></div>

        <p class="title">Figure 19-2. The <code class="userinput">ddraw</code> start menu</p>
      </div>

      <p>New graphics are generated in the menu item <span class="strong"><strong>Create a new graph</strong></span> in the start picture, which is shown in <a class="xref" href="../Text/ch19s04.html#the_ddraw_start_menu" title="Figure 19-2. The ddraw start menu">Figure 19-2</a>. The dialog shown in <a class="xref" href="../Text/ch19s04.html#selecting_the_data_source" title="Figure 19-3. Selecting the data source">Figure 19-3</a> allows the appropriate RRD database to be selected. Using a regular expression<sup>[<a class="footnote" href="#ftn.CHP-19-FN-11" id="CHP-19-FN-11">203</a>]</sup> in the <span class="strong"><strong>Data Source filter regexp</strong></span> field, the data sources available can be further restricted; this expression can also be a simple literal text, such as <strong class="userinput"><code>sap-12</code></strong>.</p>

      <div class="figure">
        <a id="selecting_the_data_source"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e37064"/><img alt="Selecting the data source" src="../Images/tagoreillycom20081104nostarchimages223964.png.jpg"/></div>

        <p class="title">Figure 19-3. Selecting the data source</p>
      </div>

      <p>Once you have chosen an RRD database, you just need to specify the <span class="emphasis"><em>round-robin archive</em></span> (RRA) to be used. Each of these archives saves data in a particular form, processed with a consolidation function: the <strong class="userinput"><code>AVERAGE</code></strong> function averages all measurement data that accumulates in a measurement period, <strong class="userinput"><code>MIN</code></strong> saves only the minimum value of the data in an interval, and <strong class="userinput"><code>MAX</code></strong> saves only the maximum. Since the original data is lost, the archives must be specified when the round-robin database is created; maximum values can only be recalled later if this was taken into account at the time.<a class="indexterm" id="IDX-CHP-19-1509"/></p>

      <p>If you cannot remember what archives exist, you can display them using the button <strong class="userinput"><code>RRD Info for selected DB</code></strong>. Clicking on the <strong class="userinput"><code>Add DB(s) to Data Sources</code></strong> button takes you to a dialog where you first have to scroll down a bit to reach the item <strong class="userinput"><code>Data Source Configuration</code></strong> (<a class="xref" href="../Text/ch19s04.html#fine-tuning_the_graphic_configuration" title="Figure 19-4. Fine-tuning the graphic configuration">Figure 19-4</a>). There you can fine-tune the desired graph—now or later. You can define your own colors, and whether a line or a surface will be shown. You should only make use of the other possibilities if you are familiar with the concepts of the RRDtools and the way they work<sup>[<a class="footnote" href="#ftn.CHP-19-FN-12" id="CHP-19-FN-12">204</a>]</sup></p>

      <p>The <span class="strong"><strong>Update</strong></span> button provides a preview of the finished graphic, which at the same time reveals the <strong class="userinput"><code>rrdtool</code></strong> options used (<a class="xref" href="../Text/ch19s04.html#preview_and_specifying_the_rrdtool" title="Figure 19-5. Preview and specifying the rrdtool options">Figure 19-5</a>). When you save, with <span class="strong"><strong>Save Graph</strong></span>, you obtain a link in the form</p><a id="I_programlisting4_d1e37117"/>
      <pre class="programlisting">http://<span class="emphasis"><em>nagiosserver</em></span>/cgi-bin/drraw/drraw.cgi?Mode=view;Graph=11149589.4932</pre>

      <p>with which the graphic can be accessed at any time. Alternatively you can now find the graphic in the <strong class="userinput"><code>drraw</code></strong> starting menu under <span class="strong"><strong>All Graphs</strong></span>.</p>

      <div class="figure">
        <a id="fine-tuning_the_graphic_configuration"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e37133"/><img alt="Fine-tuning the graphic configuration" src="../Images/tagoreillycom20081104nostarchimages223966.png.jpg"/></div>

        <p class="title">Figure 19-4. Fine-tuning the graphic configuration</p>
      </div>

      <div class="figure">
        <a id="preview_and_specifying_the_rrdtool"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e37145"/><img alt="Preview and specifying the rrdtool options" src="../Images/tagoreillycom20081104nostarchimages223968.png.jpg"/></div>

        <p class="title">Figure 19-5. Preview and specifying the <code class="userinput">rrdtool</code> options</p>
      </div>

      <div class="figure">
        <a id="the_finished_graphic_represents_diffe"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e37153"/><img alt="The finished graphic represents different time periods" src="../Images/tagoreillycom20081104nostarchimages223970.png.jpg"/></div>

        <p class="title">Figure 19-6. The finished graphic represents different time periods</p>
      </div>

      <p>The link mentioned when you save a graphic can be recorded in a <strong class="userinput"><code>service-extinfo</code></strong> object, making it directly accessible through the Nagios interface:</p><a id="I_programlisting4_d1e37163"/>
      <pre class="programlisting">define serviceextinfo{
    service_description PING
    host            sap-12
    notes_url /nagiosgraph/drraw/drraw.cgi?Mode=view;Graph=11149589.4932
    icon_image      graph.gif
    icon_image_alt  View graphics
}</pre>

      <p>With templates and dashboards, <strong class="userinput"><code>drraw</code></strong> includes other features, which cannot be discussed in detail here, for reasons of space. Templates allow several sources of the same type to be shown in the same graphic. What these are can be specified in <span class="strong"><strong>Create a new Graph</strong></span> (see <a class="xref" href="../Text/ch19s04.html#selecting_the_data_source" title="Figure 19-3. Selecting the data source">Figure 19-3</a>). Since you can only add one source at a time there, you must click the <span class="strong"><strong>Add</strong></span> button for each separate source, before moving on to the next one.</p>

      <p>A dashboard presents a display containing several preview graphics. If you click on one of the graphics, you are shown the detailed representation. The interactive menu <span class="strong"><strong>Create a Dashboard</strong></span> contains brief instructions where you can obtain help on the two features.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-8" id="ftn.CHP-19-FN-8">200</a>]</sup> Apart from the documentation on the homepage <a class="ulink" href="http://www.rrdtool.org/">http://www.rrdtool.org/</a>, the tutorial included (<strong class="userinput"><code>man rrdtutorial</code></strong>) is a useful starting point, as well as the man page <strong class="userinput"><code>man rrdgraph</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-9" id="ftn.CHP-19-FN-9">201</a>]</sup> Which directory this is depends on the distribution or Apache configuration you are using.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-10" id="ftn.CHP-19-FN-10">202</a>]</sup> A symbolic link would also be possible, but then Apache must be configured so that it follows symbolic links, which is normally not automatically the case.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-11" id="ftn.CHP-19-FN-11">203</a>]</sup> POSIX regular expression; see <strong class="userinput"><code>man 7 regex</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-12" id="ftn.CHP-19-FN-12">204</a>]</sup> There are a number of tutorials on the homepage of the RRDtools author, Tobias Oetiker, at <a class="ulink" href="http://people.ee.ethz.ch/~oetiker/webtools/rrdtool/tut/index.en.html">http://people.ee.ethz.ch/~oetiker/webtools/rrdtool/tut/index.en.html</a>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="19.5 Automated to a Large Extent: NagiosGrapher">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="automated_to_a_large_extent_colon_nagi"/>19.5 Automated to a Large Extent: NagiosGrapher</h1>
    </div>

    <p>NagiosGrapher from Netways, the host of The Nagios Exchange Platform <a class="ulink" href="http://www.nagiosexchange.org/">http://www.nagiosexchange.org/</a>, is a powerful representation tool for performance data, but already a very powerful one. This also saves data in round-robin databases and uses the RRDtools for processing and representation. It claims to be easy to install and to work automatically to a large extent in contrast to the "competition." The latter promise has so far not been kept; as in Nagiosgraph, you have to configure search patterns in order to interpret the plugin output or performance data correspondingly. The RRD databases are generated by NagiosGrapher automatically; in addition to this, the tool <strong class="userinput"><code>serviceextinfo</code></strong> also generates entries.<a class="indexterm" id="IDX-CHP-19-1511"/><a class="indexterm" id="IDX-CHP-19-1512"/><a class="indexterm" id="IDX-CHP-19-1510"/></p>

    <p>As soon as it once recognizes the performance data, you don't have to worry any more about integrating it into Nagios. A reload is sufficient to make the <strong class="userinput"><code>serviceextinfo</code></strong> entries generated in the meantime usable in Nagios. The entries are created "intelligently," so that if you click on the corresponding icon in the service summary (see <a class="xref" href="../Text/ch19s05.html#the_nagiosgrapher_icon_open_parenthesis" title="Figure 19-7. The NagiosGrapher icon (arrow) in the Nagios Web interface indicates a time-related evaluation for this service">Figure 19-7</a> in page 434), you are taken directly to the graphic display of the performance data.</p>

    <p>As far as functionality and installation efforts are concerned, NagiosGrapher lies somewhere between Nagiosgraph and Perf2rrd: the initial configuration needed is somewhat more than for Nagiosgraph, but the possibilities of variations in the graphic output are considerably larger, and you do not have to generate each graphic individually, as is the case with Perf2rrd/<strong class="userinput"><code>drraw</code></strong>.</p>

    <div class="sect2" title="19.5.1 Installation">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="installation-id7"/>19.5.1 Installation</h2>
      </div>

      <p>In addition to the RRDtools (in version 1.2, at least) and the program <strong class="userinput"><code>auto-conf</code></strong>, NagiosGrapher requires a series of Perl modules: <strong class="userinput"><code>CGI</code></strong>, <strong class="userinput"><code>CGI::Carp</code></strong>, <strong class="userinput"><code>Calendar:: Simple</code></strong>,<strong class="userinput"><code>Carp</code></strong>,<strong class="userinput"><code>Data:: Dumper</code></strong>, <strong class="userinput"><code>File::Basename</code></strong>,<strong class="userinput"><code>File::Copy</code></strong>, <strong class="userinput"><code>GD</code></strong>, <strong class="userinput"><code>IO::Handle</code></strong>, <strong class="userinput"><code>Image::Magick</code></strong>, <strong class="userinput"><code>POSIX</code></strong>, <strong class="userinput"><code>RRDs</code></strong>, <strong class="userinput"><code>Storable</code></strong>, <strong class="userinput"><code>Time::HiRes</code></strong>, <strong class="userinput"><code>Time :: Local</code></strong>, and <strong class="userinput"><code>URI::Escape</code></strong>.<a class="indexterm" id="IDX-CHP-19-1514"/><a class="indexterm" id="IDX-CHP-19-1513"/><a class="indexterm" id="IDX-CHP-19-1515"/><a class="indexterm" id="IDX-CHP-19-1516"/></p>

      <p>There are two alternatives for installing them, namely from the packages included in the distribution or from CPAN. On Debian "Etch" and comparable Debian-based systems, you have all the modules if you select the packages <strong class="userinput"><code>autoconf</code></strong>,<strong class="userinput"><code>rrdtool</code></strong>,<strong class="userinput"><code>perl-modules</code></strong>,<strong class="userinput"><code>libcalendar-simple-perl</code></strong>,<strong class="userinput"><code>libgd-gd2-perl</code></strong>,<strong class="userinput"><code>perlmagick</code></strong>,<strong class="userinput"><code>librrds-perl</code></strong>, and <strong class="userinput"><code>liburi-perl</code></strong> for installation. In other distributions you must search for the above-mentioned modules, preferably using the graphic package installer in the distribution. You can see whether you have installed all the required modules by running <strong class="userinput"><code>make testdeps</code></strong> after the <strong class="userinput"><code>configure</code></strong> command. Installing each of the most current module versions from the CPAN is done with the command <strong class="userinput"><code>make fixdeps</code></strong>.</p>

      <p>The NagiosGrapher sources can be obtained from NagiosExchange,<sup>[<a class="footnote" href="#ftn.CHP-19-FN-13" id="CHP-19-FN-13">205</a>]</sup> and they are unpacked into the directory <strong class="userinput"><code>/usr/local/src</code></strong>:</p><a id="I_programlisting4_d1e37340"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/src</strong></span>
linux:local/src # <span class="strong"><strong>tar xvjf</strong></span><span class="bolditalic">/path/to/</span><span class="strong"><strong>NagiosGrapher-1.6.1.tar.bz2</strong></span>
...
linux:local/src # <span class="strong"><strong>cd NagiosGrapher-1.6.1</strong></span>
linux:src/NagiosGrapher-1.6.1 # <span class="strong"><strong>autoconf</strong></span></pre>

      <p>The command <strong class="userinput"><code>autoconf</code></strong> generates a <strong class="userinput"><code>configure</code></strong> script. Before you run this, edit the file <strong class="userinput"><code>config.layout</code></strong>, which provides various <span class="emphasis"><em>layouts</em></span>. In the NagiosGrapher documentation, this term means the definition of all installation paths that are required.<a class="indexterm" id="IDX-CHP-19-1517"/></p>

      <p><strong class="userinput"><code>config.layout</code></strong> contains a series of distribution-dependent suggestions that need to be changed in certain aspects in order to comply with the conventions in this book. For this purpose it is best if you copy the section that matches your distribution and rename it to <strong class="userinput"><code>&lt;Layout nagiosbook&gt;</code></strong> and modify a number of entries.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-14" id="CHP-19-FN-14">206</a>]</sup> For Debian "Etch," the following entries apply (the changed values are shown in bold print):</p><a id="I_programlisting4_d1e37391"/>
      <pre class="programlisting"># config.layout
&lt;Layout nagiosbook&gt;
   prefix:                /usr/local/nagios
   nagios_config: <span class="strong"><strong>     /etc/nagios</strong></span>
   nagios_config_cgi:<span class="strong"><strong>  /etc/nagios/cgi.cfg</strong></span>
   nagios_images:         ${prefix}/share/images
   nagios_images_logos:   ${prefix}/share/images/logos
   nagios_folder_cgi:     ${prefix}/sbin
   nagios_contribution:   ${prefix}/contrib
   perl_inc:           <span class="strong"><strong>${prefix}/perl/lib</strong></span>
   ng_config:          <span class="strong"><strong>/etc/nagios</strong></span>
   ng_config_sub:         ${ng_config}/ngraph.d
   ng_daemon:          <span class="strong"><strong>/var/nagios_grapher</strong></span>
   ng_srvext_file:     <span class="strong"><strong>/etc/nagios/serviceextinfo.cfg</strong></span>
   ng_srvext_dir:      <span class="strong"><strong>/etc/nagios/serviceext</strong></span>
   ng_interface_pipe:  <span class="strong"><strong>/var/nagios/rw/ngraph.pipe</strong></span>
   ng_perffile_path:   <span class="strong"><strong>/var/nagios/</strong></span>
   ng_logfile:         <span class="strong"><strong>/var/nagios/ngraph.log</strong></span>
   ng_rrd:             <span class="strong"><strong>/var/lib/rrd/nagios_grapher</strong></span>
   ng_rrd_font: /usr/share/fonts/truetype/ttf-dejavu/DejaVuSansCondensed.ttf
   ng_cgi:                /nagios/cgi-bin
   ng_logos:              /nagios/images/logos
   ng_pid_file:           ${ng_daemon}/nagios_grapher.pid
   init_script_dir:       /etc/init.d
   logrotate_conf_dir:    /etc/logrotate.d
&lt;/Layout&gt;</pre>

      <p>The path for the Perl modules defined in the parameter <strong class="userinput"><code>perl_inc</code></strong> corresponds in this case to the directory suggested by Ton Voon for the Perl module <strong class="userinput"><code>Nagios::Plugin</code></strong> (see <a class="xref" href="../Text/ch24s02.html#the_method_using_the_cpan" title="The method using the CPAN">The method using the CPAN</a>).</p>

      <p>The new layout is included in the <strong class="userinput"><code>configure</code></strong> script:</p><a id="I_programlisting4_d1e37442"/>
      <pre class="programlisting">linux:src/NagiosGrapher-1.6.1 # <span class="strong"><strong>./configure --with-layout=nagiosbook</strong></span>
...</pre>

      <p>You can run <strong class="userinput"><code>make</code></strong> <strong class="userinput"><code>testdeps</code></strong> to check whether all dependencies, especially the ones for the Perl modules, have been met:</p><a id="I_programlisting4_d1e37456"/>
      <pre class="programlisting">linux:src/NagiosGrapher-1.6.1 # <span class="strong"><strong>make testdeps</strong></span>
/usr/bin/perl ./tools/testdeps.pl
Checking Data::Dumper ... found
...
Checking IO::Handle ... found
Checking URI::Escape ... found
Checking Calendar::Simple ... not installed!
make: *** [testdeps] Error 1</pre>

      <p>If an error occurs, as in this example, you must install the appropriate module (here <strong class="userinput"><code>Calendar::Simple</code></strong>). This can be done from the CPAN with the command</p><a id="I_programlisting4_d1e37466"/>
      <pre class="programlisting">linux:src/NagiosGrapher-1.6.1 # <span class="strong"><strong>make fixdeps</strong></span>
...</pre>

      <p>For Debian-based distributions, the package naming scheme is quite simple: The Perl module <strong class="userinput"><code>Calendar:: Simple</code></strong> is turned into the package <strong class="userinput"><code>lib-calendar-simple-perl</code></strong>, which is installed with <strong class="userinput"><code>apt-get</code></strong> or <strong class="userinput"><code>aptitude</code></strong>:</p><a id="I_programlisting4_d1e37485"/>
      <pre class="programlisting">linux:src/NagiosGrapher-1.6.1 # <span class="strong"><strong>apt-get install libcalendar-simple-perl</strong></span>
...</pre>

      <p>Running <strong class="userinput"><code>make testdeps</code></strong> again shows whether all requirements have now been met.</p>

      <p>An already installed NagiosGrapher is updated with <strong class="userinput"><code>make update</code></strong>, since the <strong class="userinput"><code>make install</code></strong>, intended for a new installation, does not take account of already existing configuration files and simply overwrites them.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-15" id="CHP-19-FN-15">207</a>]</sup> <strong class="userinput"><code>make install</code></strong> creates all the necessary directories, ensures that the correct access permissions are set, and copies all the files to where they should go:</p><a id="I_programlisting4_d1e37513"/>
      <pre class="programlisting">linux:src/NagiosGrapher-1.6.1 # <span class="strong"><strong>make install</strong></span>
mkdir -p /etc/nagios/serviceext
chown -R nagios /etc/nagios/serviceext
mkdir -p /var/lib/rrd/nagios_grapher
chown -R nagios /var/lib/rrd/nagios_grapher
...
==================================================
Just a few steps to run the grapher ...
...</pre>

      <p>The output of <strong class="userinput"><code>make</code></strong> ends with some instructions on the configuration of NagiosGrapher and of Nagios, which we will examine in more detail in <a class="xref" href="../Text/ch19s05.html#installation-id7" title="19.5.1 Installation">19.5.1 Installation</a> and <a class="xref" href="../Text/ch19s05.html#advanced_options_of_graphic_reproces" title="Advanced options of graphic reprocessing">Advanced options of graphic reprocessing</a>.</p>

      <p>A core component of NagiosGrapher is the daemon <strong class="userinput"><code>collect2.pl</code></strong>, which is started via the startup script <strong class="userinput"><code>nagios_grapher</code></strong> in <strong class="userinput"><code>/etc/init.d</code></strong>:<a class="indexterm" id="IDX-CHP-19-1518"/></p><a id="I_programlisting4_d1e37542"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/nagios_grapher start</strong></span></pre>

      <p>So that the daemon starts automatically on system start, corresponding symlinks are set in distributions that use the system V init. On Debian/Ubuntu this is done by the system script <strong class="userinput"><code>update-rc.d</code></strong>:</p><a id="I_programlisting4_d1e37551"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>update-rc.d nagios_grapher defaults 98</strong></span></pre>

      <p>OpenSUSE includes the script <strong class="userinput"><code>insserv</code></strong> for this purpose:</p><a id="I_programlisting4_d1e37560"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>insserv nagios_grapher</strong></span></pre>

      <p>In Fedora this task is performed by <strong class="userinput"><code>chkconfig</code></strong>:</p><a id="I_programlisting4_d1e37569"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>chkconfig --add nagios_grapher</strong></span>
     linux:~ # <span class="strong"><strong>nagios on</strong></span></pre>
    </div>

    <div class="sect2" title="19.5.2 Configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="configuration-id3"/>19.5.2 Configuration</h2>
      </div>

      <div class="sect3" title="The configuration file ngraph.ncfg">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="the_configuration_file_ngraph.ncfg"/>The configuration file <strong class="userinput"><code>ngraph.ncfg</code></strong></h3>
        </div>

        <p>The configuration file <strong class="userinput"><code>ngraph.ncfg</code></strong> contains a global <strong class="userinput"><code>config</code></strong> section with paths and general settings. This is followed by an include instruction with the parameter <strong class="userinput"><code>cfg_dir</code></strong>, which, as in Nagios, integrates all the configuration files located in the directory specified. In contrast to Nagios, the configuration files for NagiosGrapher all end in <strong class="userinput"><code>.ncfg</code></strong>.<a class="indexterm" id="IDX-CHP-19-1521"/><a class="indexterm" id="IDX-CHP-19-1522"/><a class="indexterm" id="IDX-CHP-19-1523"/><a class="indexterm" id="IDX-CHP-19-1524"/><a class="indexterm" id="IDX-CHP-19-1525"/><a class="indexterm" id="IDX-CHP-19-1526"/><a class="indexterm" id="IDX-CHP-19-1527"/><a class="indexterm" id="IDX-CHP-19-1528"/><a class="indexterm" id="IDX-CHP-19-1529"/><a class="indexterm" id="IDX-CHP-19-1530"/><a class="indexterm" id="IDX-CHP-19-1531"/><a class="indexterm" id="IDX-CHP-19-1532"/><a class="indexterm" id="IDX-CHP-19-1533"/><a class="indexterm" id="IDX-CHP-19-1534"/><a class="indexterm" id="IDX-CHP-19-1535"/><a class="indexterm" id="IDX-CHP-19-1536"/><a class="indexterm" id="IDX-CHP-19-1537"/><a class="indexterm" id="IDX-CHP-19-1538"/><a class="indexterm" id="IDX-CHP-19-1539"/><a class="indexterm" id="IDX-CHP-19-1540"/><a class="indexterm" id="IDX-CHP-19-1541"/><a class="indexterm" id="IDX-CHP-19-1542"/><a class="indexterm" id="IDX-CHP-19-1543"/><a class="indexterm" id="IDX-CHP-19-1544"/><a class="indexterm" id="IDX-CHP-19-1545"/><a class="indexterm" id="IDX-CHP-19-1546"/><a class="indexterm" id="IDX-CHP-19-1547"/><a class="indexterm" id="IDX-CHP-19-1548"/><a class="indexterm" id="IDX-CHP-19-1549"/><a class="indexterm" id="IDX-CHP-19-1550"/><a class="indexterm" id="IDX-CHP-19-1551"/><a class="indexterm" id="IDX-CHP-19-1552"/><a class="indexterm" id="IDX-CHP-19-1553"/><a class="indexterm" id="IDX-CHP-19-1554"/><a class="indexterm" id="IDX-CHP-19-1555"/><a class="indexterm" id="IDX-CHP-19-1556"/><a class="indexterm" id="IDX-CHP-19-1557"/><a class="indexterm" id="IDX-CHP-19-1558"/><a class="indexterm" id="IDX-CHP-19-1559"/><a class="indexterm" id="IDX-CHP-19-1560"/><a class="indexterm" id="IDX-CHP-19-1561"/><a class="indexterm" id="IDX-CHP-19-1519"/><a class="indexterm" id="IDX-CHP-19-1520"/><a class="indexterm" id="IDX-CHP-19-1562"/></p>

        <p>It can be seen even from a quick glance that the syntax complies with the convention used by Nagios:</p><a id="I_programlisting4_d1e37750"/>
        <pre class="programlisting"># /etc/nagios/ngraph.ncfg
define config {
     interface          file
     perffile_path      /var/nagios/
     pipe               /var/nagios/rw/ngraph.pipe
     port               5667
     buffer             1024
     pidfile            /var/nagios_grapher/nagios_grapher.pid

     user               nagios
     group              nagios

     step               300
     heartbeat          AUTO

     rrdpath            /var/lib/rrd/nagios_grapher/
     tmppath            /tmp/nagiosgrapher/

     fontfile          /usr/share/fonts/truetype/ttf-dejavu/DejaVuSansCon
densed.ttf

     serviceext_type   MULTIPLE
     serviceextinfo    /etc/nagios/serviceextinfo.cfg
     serviceext_path   /etc/nagios/serviceext

     url               /nagios/cgi-bin/graphs.cgi
     #notes_url        /wiki/index.php/$HOSTNAME$#$SERVICEDESC$
     notes_url

     nagios_config     /etc/nagios
     cgi_config        /etc/nagios/cgi.cfg
   icon_image_tag        dot.png' border="0"&gt;&lt;/a&gt;&lt;A TARGET="_blank" HREF="g
raphs.cgi?###URL###"&gt;&lt;img src='###IMAGESRC###' '
   icon_image_src        /nagios/images/logos/graph.png
   icon_image_script     /nagios/cgi-bin/rrd2-system.cgi?###URL###&amp;start=-5
400&amp;title=Actual&amp;width=20&amp;height=20&amp;type=AVERAGE&amp;only-graph=true
   icon_image_static true

   log_file              /var/nagios/ngraph.log
   log_level             1023

   rrd_color_background  ffffff
   rrd_color_font        333333
   rrd_color_arrow       ff0000
   rrd_color_frame       ffffff
   rrd_color_grid
   rrd_color_canvas      ffffff
   rrd_color_shadea      c0c0c0
   rrd_color_shadeb      c0c0c0

   fe_use_browser_all    false
   fe_use_browser_for    nagiosadmin
   fe_use_browser_url    false
   fe_use_timefilter     true
   use_authentication    true
   ...
}
# Includes
cfg_dir=/etc/nagios/ngraph.d</pre>

        <p>The <strong class="userinput"><code>config</code></strong> section contains the following parameters:</p>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>interface</code></strong></span></dt>

            <dd>
              <p>This defines the type of connection to Nagios. Possible connections are <strong class="userinput"><code>pipe</code></strong>, <strong class="userinput"><code>network</code></strong>, and <strong class="userinput"><code>file</code></strong>. For the <strong class="userinput"><code>pipe</code></strong> type, Nagios and the <strong class="userinput"><code>collect2.pl</code></strong> daemon communicate via a named pipe (see the <strong class="userinput"><code>pipe</code></strong> parameter); for the <strong class="userinput"><code>network</code></strong> type, Nagios sends the performance data via the UDP transport protocol over a network socket (see parameter <strong class="userinput"><code>port</code></strong>).</p>

              <p>In contrast to the interface types just described, the <strong class="userinput"><code>file</code></strong> type (available from version 1.7) makes use of the template mechanism,<sup>[<a class="footnote" href="#ftn.CHP-19-FN-16" id="CHP-19-FN-16">208</a>]</sup> which means that Nagios writes the performance data to a file which is periodically evaluated by the daemon <strong class="userinput"><code>collect2.pl</code></strong>. This makes possible, for the first time, bulk processing of performance data, thus saving resources. The default interface type is <strong class="userinput"><code>pipe</code></strong> up to version 1.6, and <strong class="userinput"><code>file</code></strong> from version 1.7.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>perffile_path</code></strong></span></dt>

            <dd>
              <p>This defines the directory for the file to which Nagios writes all performance data via the template mechanism.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>pipe</code></strong></span></dt>

            <dd>
              <p>This defines a named pipe to which Nagios writes data with the program <strong class="userinput"><code>fifo_write</code></strong> and from which the collector script <strong class="userinput"><code>collect2.pl</code></strong> reads them out again. The named pipe is created automatically by <strong class="userinput"><code>make install</code></strong> from version 1.6.1.<a class="indexterm" id="IDX-CHP-19-1563"/></p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>port</code></strong></span></dt>

            <dd>
              <p>This specifies the UDP port for the <strong class="userinput"><code>network</code></strong> communication type. The default is <strong class="userinput"><code>5667</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>buffer</code></strong></span></dt>

            <dd>
              <p>This determines the size of the buffer for sending performance data via UDP in bytes. The default is 1024 bytes.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>pidfile</code></strong></span></dt>

            <dd>
              <p>This defines the file to which NagiosGrapher writes its own process ID on starting.<a class="indexterm" id="IDX-CHP-19-1564"/></p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>user, group</code></strong></span></dt>

            <dd>
              <p>These define the user and group with whose permissions the daemon <strong class="userinput"><code>collect2.pl</code></strong> runs. Here it makes sense to specify the user and group with whose permissions Nagios is working.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>step</code></strong></span></dt>

            <dd>
              <p>This defines the step size in seconds for the RRD database. All values recorded during this period are summarized by the RRDtools in a single value. <strong class="userinput"><code>step</code></strong> therefore also describes the smallest time resolution of data in the RRD database. The value only has an effect on newly created RRD databases, and a modification made later on has no effect on existing databases.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>heartbeat</code></strong></span></dt>

            <dd>
              <p>The heartbeat defines a time period in seconds, during which the RRD database always expects data. If no measured value at all arrives during this period, NagiosGrapher generates an invalid entry (<strong class="userinput"><code>nan</code></strong>, <span class="emphasis"><em>not a number</em></span>).</p>

              <p>In order for valid entries to materialize in the above example, at least one measured value must arrive every <strong class="userinput"><code>600</code></strong> seconds. Since the resolution is <strong class="userinput"><code>60</code></strong> seconds, the database contains ten entries for the period of the "heartbeat." If one of these values is missing, NagiosGrapher simply replaces it with the last valid one. If just one measured value arrives in ten minutes, it will be recorded ten times in the database.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>rrdpath</code></strong></span></dt>

            <dd>
              <p>This specifies the directory for the RRD databases. It must be writable for the user <strong class="userinput"><code>nagios</code></strong> and (along with the database files) readable for the Web server user. The directory is created automatically during the installation of NagiosGrapher.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>tmppath</code></strong></span></dt>

            <dd>
              <p>This defines where NagiosGrapher temporarily saves internal XML files.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>fontfile</code></strong></span></dt>

            <dd>
              <p>This specifies the font file for the font used by the RRDtools for labeling the graphics.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>serviceext_type</code></strong></span></dt>

            <dd>
              <p>This describes how the <strong class="userinput"><code>serviceextinfo</code></strong> objects are created. With the <strong class="userinput"><code>SINGLE</code></strong> type, NagiosGrapher writes everything to the file specified in <strong class="userinput"><code>serviceextinfo</code></strong>.</p>

              <p>Nagios 2.0 can also read directories recursively, and in this case it is better to use the <strong class="userinput"><code>MULTIPLE</code></strong> type. Then NagiosGrapher creates a separate file for each host with the corresponding <strong class="userinput"><code>serviceextinfo</code></strong> object. The directory is specified with the <strong class="userinput"><code>serviceext_path</code></strong> parameter. This must be made known to Nagios through the <strong class="userinput"><code>cfg_dir</code></strong> directive.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>url</code></strong></span></dt>

            <dd>
              <p>This contains the path to the CGI script <strong class="userinput"><code>graphs.cgi</code></strong> from the point of view of the Web server (a path starting from the server root) or of the browser (that is, the complete URL).</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>notes_url</code></strong></span></dt>

            <dd>
              <p>NagiosGrapher automatically generates <strong class="userinput"><code>serviceextinfo</code></strong> objects; it is useful to also be able to set the parameter <strong class="userinput"><code>notes_url</code></strong> (<a class="xref" href="../Text/ch16s04.html#extended_service_information" title="16.4.2 Extended service information">16.4.2 Extended service information</a> from page 366), for example, to generate a service-related link to a Wiki entry.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>nagios_config</code></strong></span></dt>

            <dd>
              <p>This reveals to NagiosGrapher where the standard configuration file of Nagios is located.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>cgi_config</code></strong></span></dt>

            <dd>
              <p>This specifies the Nagios CGI configuration file. NagiosGrapher uses this to find out who, apart from the contact groups, has the right to query information on all hosts.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>icon_image_tag</code></strong></span></dt>

            <dd>
              <p>This parameter corresponds to the entry that is later to be found in the <strong class="userinput"><code>serviceextinfo</code></strong> object as the <strong class="userinput"><code>icon_image</code></strong> parameter. In the <strong class="userinput"><code>serviceextinfo</code></strong> object, NagiosGrapher replaces the text <strong class="userinput"><code>###URL###</code></strong> with the host and service names. The entry <strong class="userinput"><code>###IMAGESRC###</code></strong>, on the other hand, is replaced by NagiosGrapher with the contents of the parameter <strong class="userinput"><code>icon_image_src</code></strong>.<a class="indexterm" id="IDX-CHP-19-1565"/><a class="indexterm" id="IDX-CHP-19-1566"/></p>

              <p>Here the program outwits Nagios with a trick: <strong class="userinput"><code>dot.png</code></strong> is a graphic that is one pixel in size, which is invisible on the screen. To create a second, visible icon, <strong class="userinput"><code>graph.png</code></strong>, around it, a hyperlink is set to the CGI script <strong class="userinput"><code>graphs.cgi</code></strong>.</p>

              <p>Normally if you click on an image specified in <strong class="userinput"><code>icon_image</code></strong>, Nagios will take you to the <strong class="userinput"><code>Extended info</code></strong> page, and the graphic can be reached at <strong class="userinput"><code>url</code></strong> (Nagios: <strong class="userinput"><code>notes_url</code></strong>) only with another mouse click. With the trick used here, you can do this directly.</p>

              <p>The specification following <strong class="userinput"><code>icon_image_tag</code></strong> must be written on a single line. <a class="xref" href="../Text/ch19s05.html#the_nagiosgrapher_icon_open_parenthesis" title="Figure 19-7. The NagiosGrapher icon (arrow) in the Nagios Web interface indicates a time-related evaluation for this service">Figure 19-7</a> shows the icon <strong class="userinput"><code>graph.png</code></strong>, which is visible on the Nagios interface, thanks to the automatically generated <strong class="userinput"><code>serviceextinfo</code></strong> objects.</p>

              <div class="figure">
                <a id="the_nagiosgrapher_icon_open_parenthesis"/>

                <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e38076"/><img alt="The NagiosGrapher icon (arrow) in the Nagios Web interface indicates a time-related evaluation for this service" src="../Images/tagoreillycom20081104nostarchimages223972.png.jpg"/></div>

                <p class="title">Figure 19-7. The NagiosGrapher icon (arrow) in the Nagios Web interface indicates a time-related evaluation for this service</p>
              </div>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>icon_image_static</code></strong></span></dt>

            <dd>
              <p>This specifies whether the icon integrated in <a class="xref" href="../Text/ch19s05.html#the_nagiosgrapher_icon_open_parenthesis" title="Figure 19-7. The NagiosGrapher icon (arrow) in the Nagios Web interface indicates a time-related evaluation for this service">Figure 19-7</a> is generated statically or dynamically. Possible values are <strong class="userinput"><code>true</code></strong> (static icon) or <strong class="userinput"><code>false</code></strong> (dynamically generated icon).</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>icon_image_src</code></strong></span></dt>

            <dd>
              <p>This specifies astatic icon, which NagiosGrapher integrates into <strong class="userinput"><code>icon_image_tag</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>icon_image_script</code></strong></span></dt>

            <dd>
              <p>This defines a script that generates a mini-view of a graph rather than a dynamic icon.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>log_file</code></strong></span></dt>

            <dd>
              <p>This defines the log file to which the NagiosGrapher writes information. If you want log rotation, you have to set it up yourself, as NagiosGrapher does not clean up automatically. Because Nagios requries write permissions for the file, it is better stored in the Nagios <strong class="userinput"><code>var</code></strong> directory (in this case: <strong class="userinput"><code>/var/nagios</code></strong>).</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>log_level</code></strong></span></dt>

            <dd>
              <p>This parameter specifies what information the log file should contain. Possible values are <strong class="userinput"><code>1</code></strong> (detected services and values), <strong class="userinput"><code>2</code></strong> (performance data delivered by Nagios which has not been recognized by NagiosGrapher), <strong class="userinput"><code>4</code></strong> (program states), <strong class="userinput"><code>8</code></strong> (information on the <strong class="userinput"><code>serviceextinfo</code></strong> object), <strong class="userinput"><code>16</code></strong> (RRD actions), and <strong class="userinput"><code>32</code></strong> (input which is read from the pipe). For more extensive debugging, there are the values <strong class="userinput"><code>64</code></strong> (details of how regular expressions are parsed) and <strong class="userinput"><code>128</code></strong> (advanced information on how the configuration files are parsed).</p>

              <p>If you want to log several of these information types, you just add the relevant values together, so the most extensive output is obtained with <strong class="userinput"><code>255</code></strong>; page 445 shows an example of this. It is recommended that you only use these log levels for debugging purposes, and you should normally use <strong class="userinput"><code>0</code></strong> or <strong class="userinput"><code>4</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>rrd_color_*</code></strong></span></dt>

            <dd>
              <p>The <strong class="userinput"><code>rrd_color</code></strong> options bring color to the Web interface (<a class="xref" href="../Text/ch19s05.html#the_influence_of_the_rrd_underscore" title="Figure 19-8. The influence of the rrd_color_* color options">Figure 19-8</a>): <strong class="userinput"><code>rrd_color_background</code></strong> defines the background color for the entire image, <strong class="userinput"><code>rrd_color_font</code></strong> the font color, <strong class="userinput"><code>rrd_color_arrow</code></strong> the color of the arrow tips, <strong class="userinput"><code>rrd_color_frame</code></strong> the frame color for the keys, <strong class="userinput"><code>rrd_color_grid</code></strong> the grid color, and <strong class="userinput"><code>rrd_color_canvas</code></strong> the background of the diagram itself. <strong class="userinput"><code>rrd_color_shadea</code></strong> defines the colors for the top and left of the frame, and <strong class="userinput"><code>rrd_color_shadeb</code></strong> does so for the right and bottom of the frame. Colors are specified as RGB values in hexadecimal notation, with a preceding <strong class="userinput"><code>#</code></strong>, as is the norm for Web pages. Changes to these options take effect immediately the next time the Web page is reloaded.</p>

              <div class="figure">
                <a id="the_influence_of_the_rrd_underscore"/>

                <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e38219"/><img alt="The influence of the rrd_color_* color options" src="../Images/tagoreillycom20081104nostarchimages223974.png"/></div>

                <p class="title">Figure 19-8. The influence of the <code class="userinput">rrd_color_*</code> color options</p>
              </div>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>fe_use_browser_all</code></strong></span></dt>

            <dd>
              <p>From version 1.2, NagiosGrapher provides a method of switching from the display of a specific service to that of other services for any host at all. To do this it integrates a selection window into the <strong class="userinput"><code>graphs.cgi</code></strong> display (see <a class="xref" href="../Text/ch19s05.html#whether_nagiosgrapher_shows_the_host" title="Figure 19-9. Whether NagiosGrapher shows the host and services fields is determined by the fe_use_browser parameters">Figure 19-9</a>).</p>

              <p>The value <strong class="userinput"><code>1</code></strong> activates the pulldown menus <strong class="userinput"><code>host</code></strong> and <strong class="userinput"><code>service</code></strong>, <strong class="userinput"><code>0</code></strong> hides them.</p>

              <div class="figure">
                <a id="whether_nagiosgrapher_shows_the_host"/>

                <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e38262"/><img alt="Whether NagiosGrapher shows the host and services fields is determined by the fe_use_browser parameters" src="../Images/tagoreillycom20081104nostarchimages223976.png.jpg"/></div>

                <p class="title">Figure 19-9. Whether NagiosGrapher shows the <code class="userinput">host</code> and <code class="userinput">services</code> fields is determined by the <code class="userinput">fe_use_browser</code> parameters</p>
              </div>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>fe_use_browser_for</code></strong></span></dt>

            <dd>
              <p>This option allows particular users to use the host/service selection. Several users can be specified, separated by commas. So that only the users specified here can see the selection fields for <strong class="userinput"><code>host</code></strong> and <strong class="userinput"><code>service</code></strong>, <strong class="userinput"><code>fe_use_browser_all</code></strong> must also be set to <strong class="userinput"><code>0</code></strong> at the same time.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>fe_use_browser_url</code></strong></span></dt>

            <dd>
              <p>This option allows the selection fields for <strong class="userinput"><code>host</code></strong> and <strong class="userinput"><code>service</code></strong> to be inserted through the URL <strong class="userinput"><code>graphs.cgi?browser=l</code></strong>, provided the value is <strong class="userinput"><code>1</code></strong>. This is not possible if the value is <strong class="userinput"><code>0</code></strong>.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>fe_use_timefilter</code></strong></span></dt>

            <dd>
              <p>This controls whether the time selection via <span class="strong"><strong>Start</strong></span> and <span class="strong"><strong>End</strong></span> appears in the browser menu (see <a class="xref" href="../Text/ch19s05.html#whether_nagiosgrapher_shows_the_host" title="Figure 19-9. Whether NagiosGrapher shows the host and services fields is determined by the fe_use_browser parameters">Figure 19-9</a> in page 436). The value <strong class="userinput"><code>true</code></strong> displays the selection, <strong class="userinput"><code>false</code></strong> hides it.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>use_authentication</code></strong></span></dt>

            <dd>
              <p>This defines whether NagiosGrapher should take the result of authentication by Nagios into account or not. The value <strong class="userinput"><code>true</code></strong> allows the observer only to access hosts and services for which he is responsible as the contact. The value <strong class="userinput"><code>false</code></strong> switches off authentication entirely, so that everyone has access to everything.</p>
            </dd>
          </dl>
        </div>

        <p>The <strong class="userinput"><code>cfg_dir</code></strong> configuration parameter already mentioned in <a class="xref" href="../Text/ch19s05.html#installation-id7" title="19.5.1 Installation">19.5.1 Installation</a> defines a directory containing additional configuration files, in particular the definition of the various graphs:<a class="indexterm" id="IDX-CHP-19-1567"/></p><a id="I_programlisting4_d1e38352"/>
        <pre class="programlisting">cfg_dir=/etc/nagios/ngraph.d</pre>

        <p>NagiosGrapher examines it recursively for configuration files of any name; they just need to end in <strong class="userinput"><code>.ncfg</code></strong>. The parameter must stand outside the <strong class="userinput"><code>config{}</code></strong> block; there has to be an = sign between the parameter and the value.</p>
      </div>

      <div class="sect3" title="Configuring the graphics—the basic principle">
        <div class="titlepage">
          <h3 class="title" id="heading_id_6"><a id="configuring_the_graphics_the_basic_princ"/>Configuring the graphics—the basic principle</h3>
        </div>

        <p><strong class="userinput"><code>ngraph</code></strong> objects are used to define what data is to be extracted and written to an RRD database, but the objects also contain information on the display form. Like Nagios, NagiosGrapher saves the information temporarily in a cache file, which is why the data collection script <strong class="userinput"><code>collect2.pl</code></strong> must be restarted after every change to a configuration file with <strong class="userinput"><code>/etc/init.d/ nagios_grapher restart</code></strong>. <strong class="userinput"><code>collect2.pl</code></strong> also updates the object cache when this is done.<a class="indexterm" id="IDX-CHP-19-1568"/><a class="indexterm" id="IDX-CHP-19-1569"/><a class="indexterm" id="IDX-CHP-19-1570"/><a class="indexterm" id="IDX-CHP-19-1571"/><a class="indexterm" id="IDX-CHP-19-1572"/><a class="indexterm" id="IDX-CHP-19-1573"/></p>

        <p>During its installation, NagiosGrapher provides a number of templates for <strong class="userinput"><code>ngraph</code></strong> objects; these can be found in the subdirectories <strong class="userinput"><code>standard</code></strong> and <strong class="userinput"><code>extra</code></strong> below <strong class="userinput"><code>/etc/nagios/ngraph.d/templates</code></strong>. These templates all end in <strong class="userinput"><code>.ncfg_disabled</code></strong> so that they are not considered by NagiosGrapher. In order to use them, the file extension is renamed:</p><a id="I_programlisting4_d1e38418"/>
        <pre class="programlisting">nagios@linux:nagios/ngraph.d$ <span class="strong"><strong>cp</strong></span> \
<span class="strong"><strong>templates/standard/check_ping.ncfg_disabled ./check_ping.ncfg</strong></span></pre>

        <p>The example in <strong class="userinput"><code>check_ping.ncfg_disabled</code></strong>, however, only works with <strong class="userinput"><code>check_ping</code></strong> and not with <strong class="userinput"><code>check_icmp</code></strong> (see <a class="xref" href="../Text/ch06s02.html" title="6.2 Reachability Test with Ping">6.2 Reachability Test with Ping</a>). So that NagiosGrapher can graphically display the average response time <strong class="userinput"><code>rta</code></strong> (<span class="emphasis"><em>round trip average</em></span>) and the <strong class="userinput"><code>pl</code></strong> (<span class="emphasis"><em>packet loss</em></span>) from the performance data of the <strong class="userinput"><code>check_icmp</code></strong> plugin,</p><a id="I_programlisting4_d1e38454"/>
        <pre class="programlisting">nagios@linux:libexec/nagios$ <span class="strong"><strong>./check_icmp -H linux01</strong></span>
OK - linux01: rta 96.387ms, lost 0%| rta=96.387ms;200.000;500.000;0; pl=
0%;40;80;;</pre>

        <p>the following <strong class="userinput"><code>ngraph</code></strong> objects are used:</p><a id="I_programlisting4_d1e38464"/>
        <pre class="programlisting"># check_icmp.ncfg
...
# Ping Packet loss
define ngraph{
           service_name                PING
           graph_perf_regex            pl=([0-9]*)%
           graph_value                 Loss
           graph_units                 %
           graph_legend                Packet Loss
           graph_legend_eol            none
           page                        Packet Loss
           rrd_plottype                LINE2
           rrd_color                   ff0000
}
# Ping RTA
define ngraph{
           service_name                PING
           graph_perf_regex            rta=([0-9]*\.[0-9]*)
           graph_value                 RTA
           graph_units                 ms
           graph_legend                Time to answer
           page                        RTA
           rrd_plottype                AREA
           rrd_color                   00a000
}</pre>

        <div class="variablelist">
          <dl>
            <dt><span class="term"><strong class="userinput"><code>service_name</code></strong></span></dt>

            <dd>
              <p>This consists of a regular expression,<sup>[<a class="footnote" href="#ftn.CHP-19-FN-17" id="CHP-19-FN-17">209</a>]</sup> with which the NagiosGrapher identifies the service to be displayed in the data passed on. If the service description in service objects that use the same plugin is provided with the same prefix, one <strong class="userinput"><code>ngraph</code></strong> definition is enough for all: <strong class="userinput"><code>Disk</code></strong>_ matches both <strong class="userinput"><code>Disk_usr</code></strong>, as well as <strong class="userinput"><code>Disk_var</code></strong> or <strong class="userinput"><code>Disk_tmp</code></strong>. In order for this to work, the performance data must be structured identically, which is always the case if the same plugin is used.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>graph_perf_regex</code></strong></span></dt>

            <dd>
              <p>With this regular expression, NagiosGrapher finds the value being searched for in the performance data. The pattern in the round brackets must match the value itself.</p>

              <p>If a plugin does not provide any performance data, you can use <strong class="userinput"><code>graph_log_regex</code></strong> instead. The search pattern specified there is applied by NagiosGrapher to the normal text output of the plugin.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>graph_value</code></strong></span></dt>

            <dd>
              <p>The name of the variable in the RRD database must be unique for each service and may not contain empty spaces or special characters (exception: _ is allowed).</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>graph_units</code></strong></span></dt>

            <dd>
              <p>This parameter defines the unit of the y axis.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>graph_legend</code></strong></span></dt>

            <dd>
              <p>This contains the key for the variables.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>graph_legend_eol</code></strong></span></dt>

            <dd>
              <p>This determines whether and how a line break should be inserted into the legend after the entry for these graphs. Possible values: <strong class="userinput"><code>left</code></strong> (line break, line is left-aligned), <strong class="userinput"><code>right</code></strong> (line break, line is right-aligned), <strong class="userinput"><code>center</code></strong> (line break, line is centrally aligned), <strong class="userinput"><code>justify</code></strong> (line break, fully aligned), and <strong class="userinput"><code>none</code></strong> (no line break, left-aligned). You can append to all values the number of empty spaces to be added, separated from it by a colon: <strong class="userinput"><code>none: 20</code></strong> does not create a line break, but the entry is followed by 20 empty spaces.<a class="indexterm" id="IDX-CHP-19-1574"/></p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>graph_legend_max</code></strong></span></dt>

            <dd>
              <p>This defines a column width for the legend. Instead of formatting this manually with empty spaces, using <strong class="userinput"><code>graph_legend_eol</code></strong>, this parameter specifies how wide the column for a legend entry should be. Entries that are longer are truncated.<a class="indexterm" id="IDX-CHP-19-1575"/></p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>page</code></strong></span></dt>

            <dd>
              <p>This optional parameter ensures that NagiosGrapher displays the variables in different diagrams if the standardization does not match. All values which are to be used in a single graphic are given the same <strong class="userinput"><code>page</code></strong> entry. For the selection of the "page" to be displayed, the CGI script contains its own <strong class="userinput"><code>page</code></strong> entry field (see <a class="xref" href="../Text/ch19s05.html#the_average_response_time_to_pings_comm" title="Figure 19-10. The average response time to pings, represented by NagiosGrapher">Figure 19-10</a>).</p>

              <div class="figure">
                <a id="the_average_response_time_to_pings_comm"/>

                <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e38591"/><img alt="The average response time to pings, represented by NagiosGrapher" src="../Images/tagoreillycom20081104nostarchimages223978.png.jpg"/></div>

                <p class="title">Figure 19-10. The average response time to pings, represented by NagiosGrapher</p>
              </div>

              <p>For the two <strong class="userinput"><code>check_icmp</code></strong> outputs, it is recommended that the percentage of <strong class="userinput"><code>Loss</code></strong>, which is in the value range from 0 to 100, be separated from <strong class="userinput"><code>RTA</code></strong>, which can be several thousand milliseconds.</p>

              <p>If you leave out the <strong class="userinput"><code>page</code></strong> parameter, both graphs—the one for <strong class="userinput"><code>Packet</code></strong> Loss and that for <strong class="userinput"><code>RTA</code></strong>—are displayed in one graphic.</p>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>rrd_plottype</code></strong></span></dt>

            <dd>
              <p>This parameter defines which drawing function the RRDtools should use:</p>

              <div class="itemizedlist">
                <ul class="itemizedlist">
                  <li class="listitem">
                    <p><strong class="userinput"><code>LINE1</code></strong>: simple line,</p>
                  </li>

                  <li class="listitem">
                    <p><strong class="userinput"><code>LINE2</code></strong>: double line,</p>
                  </li>

                  <li class="listitem">
                    <p><strong class="userinput"><code>LINE3</code></strong>: extra-fat line,</p>
                  </li>

                  <li class="listitem">
                    <p><strong class="userinput"><code>AREA</code></strong>: filled out surface,</p>
                  </li>

                  <li class="listitem">
                    <p><strong class="userinput"><code>STACK</code></strong>: adds the current value to the previous one. In this case the display (line or surface) depends on the previous value.</p>
                  </li>
                </ul>
              </div>
            </dd>

            <dt><span class="term"><strong class="userinput"><code>rrd_color</code></strong></span></dt>

            <dd>
              <p>This is the color of the graph in RGB hexadecimal notation (<strong class="userinput"><code><em class="replaceable"><code>rrggbb</code></em></code></strong>).</p>
            </dd>
          </dl>
        </div>

        <p><a class="xref" href="../Text/ch19s05.html#the_average_response_time_to_pings_comm" title="Figure 19-10. The average response time to pings, represented by NagiosGrapher">Figure 19-10</a> shows how NagiosGrapher displays the average response time <strong class="userinput"><code>RTA</code></strong> for the <strong class="userinput"><code>PING</code></strong> service on the host <strong class="userinput"><code>sap-13</code></strong>. The respective output <strong class="userinput"><code>page</code></strong> can be selected at the top of the Web form. In addition you can adjust the <strong class="userinput"><code>width</code></strong>: and <strong class="userinput"><code>height</code></strong>: of an individual graphic, as well as the <strong class="userinput"><code>Refresh</code></strong> rate.</p>

        <p>Starting with version 1.7, NagiosGrapher also has a zoom function: If you click on one of the graphics in <a class="xref" href="../Text/ch19s05.html#the_average_response_time_to_pings_comm" title="Figure 19-10. The average response time to pings, represented by NagiosGrapher">Figure 19-10</a>, you can see it in greater detail. You can select a time period in the diagram with the mouse, and NagiosGrapher will display the diagram for this period after the mouse button has been released.</p>
      </div>

      <div class="sect3" title="Advanced options of graphic reprocessing">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="advanced_options_of_graphic_reproces"/>Advanced options of graphic reprocessing</h3>
        </div>

        <p>You may not always want the measured values to be displayed directly. With the <span class="emphasis"><em>CDEF</em></span> feature of the RRDtools you can add new values that are calculated from the ones recorded.<a class="indexterm" id="IDX-CHP-19-1576"/><a class="indexterm" id="IDX-CHP-19-1577"/><a class="indexterm" id="IDX-CHP-19-1578"/><a class="indexterm" id="IDX-CHP-19-1579"/></p>

        <p>As an example, we will use the output of the <strong class="userinput"><code>check_disk</code></strong> plugin (<a class="xref" href="../Text/ch07.html#free_hard_drive_capacity" title="7.1 Free Hard Drive Capacity">7.1 Free Hard Drive Capacity</a>, page 158), which determines amount of a file system occupied:</p><a id="I_programlisting4_d1e38724"/>
        <pre class="programlisting">DISK OK - free space: /usr 287 MB (19%);| /usr=1225MB;1359;1465;0;1511</pre>

        <p>The used space is shown as an dark grey area, the free capacity as a light grey one. The performance data provides the current used space (<strong class="userinput"><code>1225MB</code></strong>) and uncritical warning limits, as well as the minimum and maximum (the size of the file system). The capacity that is still free is determined as the difference between the maximum and the current occupied space. In addition, the unit of MB is somewhat unfortunate: the graphic would show 10 GB as <strong class="userinput"><code>10k</code></strong> MB. For this reason you first determine the value that the plugin returns, so that you can then scale it as you wish:</p><a id="I_programlisting4_d1e38734"/>
        <pre class="programlisting"># (1) readout current occupancy of hard drive space,
#     but do not show it as a graphic
define ngraph{
        service_name               fs_
        graph_perf_regex           =([.].+)MB;[.].+;[.].+;[.].+;[.]. +
        graph_value                disk_used
        graph_units                Bytes
        graph_legend               used space
        rrd_plottype               AREA
        rrd_color                  00a000
        hide                       yes
}</pre>

        <p>The regular expression specified after <strong class="userinput"><code>service_name</code></strong> matches all service descriptions that start with <strong class="userinput"><code>fs_</code></strong> (short for <span class="emphasis"><em>file system</em></span>), that is, <strong class="userinput"><code>fs_root</code></strong>, <strong class="userinput"><code>fs_usr</code></strong>, <strong class="userinput"><code>fs_var</code></strong>, <strong class="userinput"><code>fs_tmp</code></strong>, etc. The parameter <strong class="userinput"><code>hide</code></strong> ensures that the CGI script does not show the graphs. Instead, NagiosGrapher just stores the data in a database.</p>

        <p>In the second step, the values determined are standardized with the RRD feature <strong class="userinput"><code>CDEF</code></strong>:<a class="indexterm" id="IDX-CHP-19-1580"/></p><a id="I_programlisting4_d1e38771"/>
        <pre class="programlisting"># (2) display used hard drive space in scaled form
define ngraph{
            service_name           fs_
            type                   CDEF
            graph_value            DISK_USED
            graph_legend           used space
            graph_calc             disk_used,1024,1024,*,*
            rrd_plottype           AREA
            rrd_color              666666
            hide                   no
}</pre>

        <p><strong class="userinput"><code>type</code></strong> identifies the entry as a <strong class="userinput"><code>CDEF</code></strong> definition, which calculates new values from already existing ones. <strong class="userinput"><code>graph_value</code></strong> must be unique, which is why the entry here is given its own name.</p>

        <p><strong class="userinput"><code>graph_calc</code></strong> finally processes the data. This parameter expects the instructions in reverse Polish notation (RPN).<sup>[<a class="footnote" href="#ftn.CHP-19-FN-18" id="CHP-19-FN-18">210</a>]</sup> In this, the values to be processed are pushed, in turn, onto a stack, to be removed and operated on later.<a class="indexterm" id="IDX-CHP-19-1581"/></p>

        <p>Adding 2 + 3 is noted in RPN accordingly as <strong class="userinput"><code>2</code></strong>, <strong class="userinput"><code>3</code></strong>, +. In the example we multiply the variable defined in <a class="xref" href="../Text/ch19s05.html#advanced_options_of_graphic_reproces" title="Advanced options of graphic reprocessing">Advanced options of graphic reprocessing</a>, <strong class="userinput"><code>disk_used</code></strong>, by 1024<sup>2</sup> so that the result is in bytes. <strong class="userinput"><code>hide no</code></strong> now ensures that this value is displayed.</p>

        <p>To display available space according to the same pattern, we first determine the entire space available (<strong class="userinput"><code>disk_max</code></strong>), which NagiosGrapher should not display, calculate the difference between <strong class="userinput"><code>disk_max</code></strong> and the above <strong class="userinput"><code>disk_ used</code></strong> value, and convert the result to bytes:</p><a id="I_programlisting4_d1e38828"/>
        <pre class="programlisting"># (3) defining the space available,
#     but not displaying it in the graphic
define ngraph{
       service_name              fs_
       graph_perf_regex          =[.].+MB;[.].+;[.].+;[.].+;([.].sb&gt;+)
       graph_value               disk_max
       graph_legend              max space
       rrd_plottype              LINE2
       rrd_color                 0000a0
       hide                      yes
}

# (4) calculate and display free space
define ngraph{
      service_name         fs_
      type                 CDEF
      graph_value          DISK_MAX
      graph_legend         free space
      rrd_plottype         STACK
      rrd_color            CCCCCC
      graph_calc           disk_max,disk_used,-,1024,1024,*,*
      hide                 no
}</pre>

        <p>The corresponding formula is (<strong class="userinput"><code>disk_max-disk_used</code></strong>)x1024<sup>2</sup> The plot type <strong class="userinput"><code>STACK</code></strong> ensures that the value determined from the previous <strong class="userinput"><code>disk_used</code></strong> value is placed on top of this. <a class="xref" href="../Text/ch19s05.html#displaying_the_calculated_load_data" title="Figure 19-11. Displaying the calculated load data">Figure 19-11</a> shows a corresponding output: The lower part of the screen represents the current used space on the file system for the past six hours and the past day and week, and the top part shows the remaining free hard drive space. The graph also contains a monthly and a yearly view, not shown here.</p>

        <p>At this point it should again be emphasized that with this definition, NagiosGrapher automatically records all services that begin with <strong class="userinput"><code>fs_</code></strong> and are matched by the search pattern, writes the data to an RRD database, and generates a corresponding <strong class="userinput"><code>serviceextinfo</code></strong> entry, which appears automatically in the Web interface after a Nagios reload (see <a class="xref" href="../Text/ch19s05.html#the_nagiosgrapher_icon_open_parenthesis" title="Figure 19-7. The NagiosGrapher icon (arrow) in the Nagios Web interface indicates a time-related evaluation for this service">Figure 19-7</a> in page 434).</p>

        <p>After changes have been made to the configuration file <strong class="userinput"><code>ngraph.ncfg</code></strong>, the file collector <strong class="userinput"><code>collect2.pl</code></strong> must also be restarted:</p><a id="I_programlisting4_d1e38864"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/nagios_grapher restart</strong></span></pre>

        <div class="figure">
          <a id="displaying_the_calculated_load_data"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e38871"/><img alt="Displaying the calculated load data" src="../Images/tagoreillycom20081104nostarchimages223980.png.jpg"/></div>

          <p class="title">Figure 19-11. Displaying the calculated load data</p>
        </div>
      </div>

      <div class="sect3" title="Nagios configuration">
        <div class="titlepage">
          <h3 class="title" id="heading_id_8"><a id="nagios_configuration-id5"/>Nagios configuration</h3>
        </div>

        <p>Nagios passes on data for NagiosGrapher through the command interface, that is, each individual result leads to an external command being started. Correspondingly, the Nagios main configuration file contains the following parameter:<a class="indexterm" id="IDX-CHP-19-1582"/><a class="indexterm" id="IDX-CHP-19-1583"/><a class="indexterm" id="IDX-CHP-19-1584"/><a class="indexterm" id="IDX-CHP-19-1585"/><a class="indexterm" id="IDX-CHP-19-1586"/><a class="indexterm" id="IDX-CHP-19-1587"/><a class="indexterm" id="IDX-CHP-19-1588"/></p><a id="I_programlisting4_d1e38912"/>
        <pre class="programlisting"># /etc/nagios/nagios.cfg
...
process_performance_data=1
service_perfdata_command=<span class="strong"><strong>process-service-perfdata</strong></span></pre>

        <p>The definition of the command object <strong class="userinput"><code>process-service-perfdata</code></strong>— which is best achieved by creating a separate file with the name <strong class="userinput"><code>process_service_perfdata_n.graph.cfg</code></strong>—depends on the interface type used.</p>

        <p>For <strong class="userinput"><code>interface pipe</code></strong>, the program <strong class="userinput"><code>fifo_write</code></strong> is used, whereas for <strong class="userinput"><code>interface network</code></strong>, NagiosGrapher requires the program <strong class="userinput"><code>udpecho</code></strong>.<a class="indexterm" id="IDX-CHP-19-1589"/></p>

        <p>The definition of the command with <strong class="userinput"><code>fifo_write</code></strong> is as follows:</p><a id="I_programlisting4_d1e38946"/>
        <pre class="programlisting"># process_service_perfdata_ngraph.cfg
...
define command{
      command_name <span class="strong"><strong>process-service-perfdata</strong></span>
      command_line /usr/local/nagios/contrib/<span class="strong"><strong>fifo_write</strong></span> /var/nagios/rw/ngr
aph.pipe '$HOSTNAME$\t$SERVICEDESC$\t$SERVICEOUTPUT$\t$SERVICEPERFDATA$\
n' 3
}
...</pre>

        <p><strong class="userinput"><code>process-service-perfdata</code></strong> calls the script <strong class="userinput"><code>fifo_write.pl</code></strong>, which is given three arguments as parameters: the named pipe, a string with the performance details, and a timeout in seconds. The latter ensures that the script aborts the action if the data cannot be written within three seconds. The <strong class="userinput"><code>command_line</code></strong> must, as usual, be writen on one line.<a class="indexterm" id="IDX-CHP-19-1590"/></p>

        <p>For the program <strong class="userinput"><code>udpecho</code></strong>, the definition of the command is somewhat simpler:</p><a id="I_programlisting4_d1e38972"/>
        <pre class="programlisting"># process_service_perfdata_ngraph.cfg
...
define command{
   command_name<span class="strong"><strong>     process-service-perfdata</strong></span>
   command_line     /usr/local/nagios/contrib/<span class="strong"><strong>udpecho</strong></span>
}
...</pre>

        <p><strong class="userinput"><code>udpecho</code></strong> does not need any parameters: It retrieves the required information from the environment variables <strong class="userinput"><code>NAGIOS_HOSTNAME, NAGIOS_SERVICE-DESC</code></strong>, <strong class="userinput"><code>NAGIOS_SERVICEOUTPUT</code></strong>, and <strong class="userinput"><code>NAGIOS_SERVICEPERFDATA</code></strong>. Nagios has to make these available with <strong class="userinput"><code>enable_environment_macros=1</code></strong> (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>) so that <strong class="userinput"><code>udpecho</code></strong> can provide NagiosGrapher with usable data.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-19" id="CHP-19-FN-19">211</a>]</sup><a class="indexterm" id="IDX-CHP-19-1591"/><a class="indexterm" id="IDX-CHP-19-1592"/><a class="indexterm" id="IDX-CHP-19-1593"/><a class="indexterm" id="IDX-CHP-19-1594"/></p>

        <p>For the <strong class="userinput"><code>file</code></strong> interface type, the command <strong class="userinput"><code>process-service-perfdata</code></strong> has another meaning: It is not called for every check result, but rather shifts the file into which Nagios writes all performance data via the template mechanism:</p><a id="I_programlisting4_d1e39028"/>
        <pre class="programlisting"># process_service_perfdata_ngraph.cfg
...
define command{
    command_name    process-service-perfdata
command_line mv /var/nagios/service-perfdata /var/nagios/service-per
fdata.$TIMET$
}
...</pre>

        <p>The current timestamp is simply appended to the file name <strong class="userinput"><code>service-perf-data</code></strong>. The daemon <strong class="userinput"><code>collect2.pl</code></strong> searches for all files called <strong class="userinput"><code>service-perfdata.</code></strong><strong class="userinput"><code><em class="replaceable"><code>time_stamp</code></em></code></strong> from the specified directory and processes these.<a class="indexterm" id="IDX-CHP-19-1595"/></p>

        <p>What data is written to the file by Nagios is specified by <strong class="userinput"><code>service_perf data_file_template</code></strong> in <strong class="userinput"><code>nagios.cfg</code></strong>:</p><a id="I_programlisting4_d1e39055"/>
        <pre class="programlisting"># /etc/nagios/nagios.cfg
...
service_perfdata_file_processing_command=process-service-perfdata
service_perfdata_file=/var/nagios/service-perfdata
service_perfdata_file_template=$HOSTNAME$\t$SERVICEDESC$\t$SERVICEOUTPUT
$\t$SERVICEPERFDATA$\t<span class="strong"><strong>$TIMET$</strong></span>
service_perfdata_file_mode=a
service_perfdata_file_processing_interval=60
...</pre>

        <p>Compared to the variation with <strong class="userinput"><code>fifo_write.pl</code></strong>, Nagios now also passes on a timestamp for each check. This is necessary because the data are not processed immediately, but periodically at intervals of <strong class="userinput"><code>service_perfdata_ file_processing_interval</code></strong>—this is 60 seconds in our example.</p>

        <p>If you want to squeeze a little more performance out of this, you can select a temporary file system such as <strong class="userinput"><code>/dev/shm</code></strong> for the <strong class="userinput"><code>service-perfdata*</code></strong> files. The file then is not written to the hard drive, but remains in the main memory of the Nagios server.</p>

        <p>As usual, changes to the Nagios configuration require a reload:</p><a id="I_programlisting4_d1e39078"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>/etc/init.d/nagios reload</strong></span></pre>

        <p>The success of this can be clearly observed in the log file if you set the loglevel to 255 (see <a class="xref" href="../Text/ch19s05.html#the_configuration_file_ngraph.ncfg" title="The configuration file ngraph.ncfg">The configuration file ngraph.ncfg</a>).<sup>[<a class="footnote" href="#ftn.CHP-19-FN-20" id="CHP-19-FN-20">212</a>]</sup> For the sake of clarity we will omit the timestamp at the beginning of the line:</p><a id="I_programlisting4_d1e39096"/>
        <pre class="programlisting">CFG: buffer ⇒ '1024'
     CFG: cgi_config ⇒ '/etc/nagios/cgi.cfg'
     ...
     PRG: Starting up collect2.pl (PID: 25003) ...
     PRG: using UDP socket (port: 5667)
     ...
     NET: got udp message from localhost:32783
     PIPE: swobspace PING OK - 192.168.1.9: rta 0.104ms, lost 0% rt a
     =0.104ms;200.000;500.000;0; pl=0%;20;60;;
     REGEX: 2 blocks for 'PING' found.
     REGEX: graph_value=RTA
     REGEX: output=perfdata
     REGEX: regex=m/rta=([0-9]* [0-9]*)/i
     REGEX: perfdata=rta=0.104ms;200.000;500.000;0; pl=0%;20;60;;
     REGEX: match=0.104
     REGEX: graph_value=Loss
     REGEX: output=perfdata
     REGEX: regex=m/.*pl=([0-9]*)/i
     REGEX: perfdata=rta=0.104ms;200.000;500.000;0; pl=0%;20;60;;
     REGEX: match=0
     VALUES: [swobspace][PING]: RTA=0.104 Loss=0
     RRD: rrdtool update /var/lib/rrd/nagios_grapher/swobspace/f66ffe61c885 d
     e2d8b6d0c41ff444b39.rrd --template=RTA:Loss N:0.104:0
...</pre>

        <p>The label <strong class="userinput"><code>PRG</code></strong> identifies program states, such as the restart here. <strong class="userinput"><code>PIPE</code></strong> reproduces in full all the data taken from the named pipe (host name, service description, plugin output, and performance data, each separated by a tab). <strong class="userinput"><code>REGEX</code></strong> shows how the search for matching entries takes place and how the values are extracted from them. <strong class="userinput"><code>RRD</code></strong> reveals the commands performed with <strong class="userinput"><code>rrdtool</code></strong> and <strong class="userinput"><code>VALUES</code></strong> shows the recognized values(<strong class="userinput"><code>PING</code></strong>).</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-13" id="ftn.CHP-19-FN-13">205</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/42;195">http://www.nagiosexchange.org/42;195</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-14" id="ftn.CHP-19-FN-14">206</a>]</sup> Starting from NagiosGrapher 1.7, the file <strong class="userinput"><code>config.layout</code></strong> already contains the entry <strong class="userinput"><code>&lt;Layout nagiosbook&gt;</code></strong>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-15" id="ftn.CHP-19-FN-15">207</a>]</sup> Even when running <strong class="userinput"><code>make update</code></strong>, it doesn't hurt for you to back up the configuration files beforehand.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-16" id="ftn.CHP-19-FN-16">208</a>]</sup> See <a class="xref" href="../Text/ch19.html#the_template_mechanism" title="19.1.1 The template mechanism">19.1.1 The template mechanism</a> in page 405</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-17" id="ftn.CHP-19-FN-17">209</a>]</sup> Since we have a Perl script on our hands, this is, of course, a Perl regexp.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-18" id="ftn.CHP-19-FN-18">210</a>]</sup> An introduction to RPN can be found at <a class="ulink" href="http://people.ee.ethz.ch/%CB%9Coetiker/webtools/rrdtool/tut/rpntutorial.en.html">http://people.ee.ethz.ch/˜oetiker/webtools/rrdtool/tut/rpntutorial.en.html</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-19" id="ftn.CHP-19-FN-19">211</a>]</sup> Environment macros are described in <a class="xref" href="../Text/apd.html#using_standard_macros_about_the_environm" title="D.1.8 Using standard macros about the environment">D.1.8 Using standard macros about the environment</a> from page 631.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-20" id="ftn.CHP-19-FN-20">212</a>]</sup> In general: 2<sup>n</sup> - 1 with <span class="emphasis"><em>n</em></span>≥8</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="19.6 Smooth Plotting with PNP">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="smooth_plotting_with_pnp"/>19.6 Smooth Plotting with PNP</h1>
    </div>

    <p><span class="emphasis"><em>PNP is not PerfParse</em></span>—with this recursive acronym, which is an allusion to the PerfParse tool (not described in this book)—the authors of PNP, Jörg Linge and Hendrik B$aUcker, are clearly heralding the virtues of their own tool for processing performance data: It is allegedly very easy to install (in contrast to PerfParse) and can be used (almost) without configuration, yet provides extensive configuration options for advanced usage.<a class="indexterm" id="IDX-CHP-19-1597"/><a class="indexterm" id="IDX-CHP-19-1598"/><a class="indexterm" id="IDX-CHP-19-1599"/><a class="indexterm" id="IDX-CHP-19-1600"/><a class="indexterm" id="IDX-CHP-19-1601"/><a class="indexterm" id="IDX-CHP-19-1602"/><a class="indexterm" id="IDX-CHP-19-1603"/><a class="indexterm" id="IDX-CHP-19-1604"/><a class="indexterm" id="IDX-CHP-19-1605"/><a class="indexterm" id="IDX-CHP-19-1606"/><a class="indexterm" id="IDX-CHP-19-1607"/><a class="indexterm" id="IDX-CHP-19-1596"/></p>

    <p>Besides providing the usual graphs for a specific check, PNP also creates an overview of all graphs belonging to one host. An AJAX-based input field allows host names to be typed in. The names are auto-completed during input, and a match list of alternative completions is displayed. The graphics have a sophisticated appearance and can be exported to PDF format.</p>

    <p>PNP takes the performance data directly from the area reserved for the plugin output, that is, only plugins that display performance data in the standard format can be used. In contrast to NagiosGrapher, no data can be extracted from the normal text output. To compensate for this slight limitation, PNP outputs the performance data for all plugins automatically. If PNP does not recognize the plugin, it uses a generic template.</p>

    <p>On the PNP homepage<sup>[<a class="footnote" href="#ftn.CHP-19-FN-21" id="CHP-19-FN-21">213</a>]</sup> you can find addresses of English mailing lists<sup>[<a class="footnote" href="#ftn.CHP-19-FN-22" id="CHP-19-FN-22">214</a>]</sup> and a German-language forum, where you can, however, ask questions in English.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-23" id="CHP-19-FN-23">215</a>]</sup> The English homepage is <a class="ulink" href="http://www.pnp4nagios.org/pnp/">http://www.pnp4nagios.org/pnp/</a>.<a class="indexterm" id="IDX-CHP-19-1608"/></p>

    <p>The following description refers to PNP version 0.4; older versions do not have all the features described here.</p>

    <div class="sect2" title="19.6.1 Installation">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="installation-id8"/>19.6.1 Installation</h2>
      </div>

      <p>The requirements for installation are quite minimal: Apache, Perl (without any special modules), PHP4 from version 4.3.0 or PHP5, and all the RRDtools.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-24" id="CHP-19-FN-24">216</a>]</sup> If possible you should install the Perl module RRDs from the Perl package included with your distribution (e.g., <strong class="userinput"><code>librrds-perl</code></strong> in Debian). The Perl script <strong class="userinput"><code>process_perfdata.pl</code></strong>, which forwards Nagios performance data to PNP, then accesses the RRD databases directly, without running an external program.<a class="indexterm" id="IDX-CHP-19-1610"/><a class="indexterm" id="IDX-CHP-19-1609"/></p>

      <p>The PNP source code is downloaded from the homepage<sup>[<a class="footnote" href="#ftn.CHP-19-FN-25" id="CHP-19-FN-25">217</a>]</sup> and is unpacked appropriately in the directory <strong class="userinput"><code>/usr/local/src</code></strong>:</p><a id="I_programlisting4_d1e39240"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/src/</strong></span>
linux:local/src # <span class="strong"><strong>tar xvzf</strong></span> /<span class="bolditalic">path/to</span>/<span class="strong"><strong>pnp-0.4.tar.gz</strong></span>
...
linux:local/src # <span class="strong"><strong>cd pnp-0.4</strong></span>
linux:src/pnp-0.4 # <span class="strong"><strong>./configure --sysconfdir=/etc/pnp</strong></span>
...</pre>

      <p>Finally, <strong class="userinput"><code>make all</code></strong> compiles the necessary C programs, and <strong class="userinput"><code>make install</code></strong> installs PNP in full. In the <strong class="userinput"><code>configure</code></strong> command, <strong class="userinput"><code>--sysconfdir=/etc/pnp</code></strong> allows for the later installation of the configuration examples in <strong class="userinput"><code>/etc/pnp</code></strong>, in accordance with the conventions used in this book. Other <strong class="userinput"><code>configure</code></strong> options are shown with <strong class="userinput"><code>./configure --help</code></strong>.</p>
    </div>

    <div class="sect2" title="19.6.2 The standard configuration">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="the_standard_configuration"/>19.6.2 The standard configuration</h2>
      </div>

      <p>During the installation of PNP a variety of data is placed in the configuration directory (in this case <strong class="userinput"><code>/etc/pnp</code></strong>), including <strong class="userinput"><code>config.php</code></strong>, the configuration file for the Web interface. There you must first check to see if the paths to <strong class="userinput"><code>rrdtool</code></strong> and to the performance data directory are correctly set:</p><a id="I_programlisting4_d1e39299"/>
      <pre class="programlisting"># /etc/pnp/config.php
     ...
     $conf['rrdtool'] = "/usr/bin/rrdtool"
     $conf['rrdbase'] = "/usr/local/nagios/share/perfdata"
     ...</pre>

      <p><strong class="userinput"><code>/etc/pnp</code></strong> also contains example configurations for the data collector <strong class="userinput"><code>pro-cess_perfdata.pl</code></strong>, in the files <strong class="userinput"><code>process_perfdata.cfg-sample</code></strong> and <strong class="userinput"><code>rra.cfg-sample</code></strong>. Neither of these are absolutely essential: PNP also functions correctly without any adjustments. But in order to use the data collector you need to rename the files <strong class="userinput"><code>process_perfdata.cfg</code></strong> and <strong class="userinput"><code>rra.cfg</code></strong> and modify them accordingly. If the Perl module RRDs is installed, then it is activated in the file <strong class="userinput"><code>process_perfdata.cfg</code></strong> with <strong class="userinput"><code>USE_RRDS=1</code></strong>:<a class="indexterm" id="IDX-CHP-19-1611"/><a class="indexterm" id="IDX-CHP-19-1612"/></p><a id="I_programlisting4_d1e39333"/>
      <pre class="programlisting"># /etc/pnp/process_perfdata.cfg
     TIMEOUT = 5
     USE_RRDs = <span class="strong"><strong>1</strong></span>
     RRDPATH = /usr/local/nagios/share/perfdata
     RRDTOOL = /usr/bin/rrdtool
     CFG_DIR = /etc/pnp/
     RRA_CFG = /etc/pnp/rra.cfg
     RRA_STEP =60
     LOG_FILE = <span class="strong"><strong>/var/nagios/pnp-perfdata.log</strong></span>
     LOG_LEVEL = 0</pre>

      <p>The second change (here in bold type) to the sample file refers to the Nagios directory for log files, which in this book is named <strong class="userinput"><code>/var/nagios</code></strong>.</p>

      <p><strong class="userinput"><code>rra.cfg</code></strong> is used as a template for the RRD databases to be newly created. If an existing database is to be modified, it must be deleted; but then all existing data will be lost. The template is a good compromise between length of storage and time resolution: This causes data with a time resolution of one hour to be stored for up to four years, such an RRD database that is about 400 KB in size. Information on settings for RRD databases is provided by the command <strong class="userinput"><code>man rrdcreate</code></strong>.</p>

      <p>In the directory <strong class="userinput"><code>/etc/pnp</code></strong> there is also the configuration file <strong class="userinput"><code>npcd.cfg</code></strong> for the <span class="emphasis"><em>Nagios Performance Data C Daemon</em></span> <strong class="userinput"><code>npcd</code></strong> and a subdirectory <strong class="userinput"><code>check_ commands</code></strong> for so-called <span class="emphasis"><em>custom templates</em></span>. Both will be discussed in <a class="xref" href="../Text/ch19s06.html#bulk_processing_of_performance_data" title="19.6.4 Bulk processing of performance data">19.6.4 Bulk processing of performance data</a>.<a class="indexterm" id="IDX-CHP-19-1613"/></p>

      <div class="sect3" title="Adjusting the Nagios configuration">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="adjusting_the_nagios_configuration"/>Adjusting the Nagios configuration</h3>
        </div>

        <p>There are a number of ways in which Nagios can pass on performance data to the PNP data collector <strong class="userinput"><code>process_perfdata.pl</code></strong>. The simplest way is for the system to run a separate program for each event, called <strong class="userinput"><code>service-perf-data-pnp</code></strong>. To do this, performance data processing is switched on in the file <strong class="userinput"><code>/etc/nagios/nagios.cfg</code></strong> with the parameter <strong class="userinput"><code>process_performance_data</code></strong>, and the command to be executed is defined with <strong class="userinput"><code>service_perfdata_command</code></strong>:<a class="indexterm" id="IDX-CHP-19-1614"/><a class="indexterm" id="IDX-CHP-19-1615"/><a class="indexterm" id="IDX-CHP-19-1616"/><a class="indexterm" id="IDX-CHP-19-1617"/><a class="indexterm" id="IDX-CHP-19-1618"/></p><a id="I_programlisting4_d1e39415"/>
        <pre class="programlisting"># /etc/nagios/nagios.cfg
     ...
     illegal_macro_output_chars='~$&amp;|"&lt;&gt;
     # -- perfdata
     process_performance_data=1
     service_perfdata_command=<span class="strong"><strong>service-perfdata-pnp</strong></span>
     ...</pre>

        <p>The performance data of various plugins contains names that are set in single quotes. So that these do not get lost in the plugin output, a single quote may <span class="emphasis"><em>not</em></span> be used in the parameter <strong class="userinput"><code>illegal_macro_output_chars</code></strong>.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-26" id="CHP-19-FN-26">218</a>]</sup><a class="indexterm" id="IDX-CHP-19-1619"/></p>

        <p>The command <strong class="userinput"><code>service-perfdata-pnp</code></strong> runs <strong class="userinput"><code>process_perfdata.pl</code></strong>:</p><a id="I_programlisting4_d1e39447"/>
        <pre class="programlisting"># /etc/nagios/global/commands/service-perfdata-pnp.cfg
define command{
    command_name service-perfdata-pnp
    command_line /usr/bin/perl /usr/local/nagios/libexec/process_perfdat
    a.pl
}</pre>

        <p>The embedded Perl interpreter ePN (see <a class="xref" href="../Text/apg.html" title="Appendix G. The Embedded Perl Interpreter">Appendix G</a> in page 669) cannot execute this Perl script, which is why it is called explictly with <strong class="userinput"><code>/usr/bin/perl</code></strong>. If ePN is not compiled into Nagios, you can leave out the <strong class="userinput"><code>/usr/bin/perl</code></strong> path.</p>

        <p>The performance data is taken here by <strong class="userinput"><code>process_perfdata.pl</code></strong> via the environment variable <strong class="userinput"><code>NAGIOS_SERVICEPERFDATA</code></strong>, so that environment variables in general must not be switched off.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-27" id="CHP-19-FN-27">219</a>]</sup><a class="indexterm" id="IDX-CHP-19-1620"/><a class="indexterm" id="IDX-CHP-19-1621"/></p>
      </div>
    </div>

    <div class="sect2" title="19.6.3 The PNP Web interface">
      <div class="titlepage">
        <h2 class="title" id="heading_id_6"><a id="the_pnp_web_interface"/>19.6.3 The PNP Web interface</h2>
      </div>

      <p>If you run <a class="ulink" href="http://nagios_server/nagios/pnp/index.php">http://nagios_server/nagios/pnp/index.php</a> you will be taken to the PNP overview page (see <a class="xref" href="../Text/ch19s06.html#all_services_of_elix01_on_one_page" title="Figure 19-12. All services of elix01 on one page">Figure 19-12</a>). This displays the data of the first host, in alphabetical order, that is found by PNP. The input field at the top right is implemented with AJAX and shows a hit list, matching the text entered so far, from which the desired host is selected. The accompanying overview page presents all services in a 24-hour view.<a class="indexterm" id="IDX-CHP-19-1622"/><a class="indexterm" id="IDX-CHP-19-1623"/><a class="indexterm" id="IDX-CHP-19-1624"/><a class="indexterm" id="IDX-CHP-19-1625"/></p>

      <p>This can also be accessed directly via <a class="ulink" href="http://nagiosserver/nagios/%20pnp/index.php?host=hostname">http://nagiosserver/nagios/ pnp/index.php?host=hostname</a>. If you replace <strong class="userinput"><code><em class="replaceable"><code>hostname</code></em></code></strong> with <strong class="userinput"><code>elix01</code></strong>, you will arrive at the overview page for the host of that name (<a class="xref" href="../Text/ch19s06.html#all_services_of_elix01_on_one_page" title="Figure 19-12. All services of elix01 on one page">Figure 19-12</a>).</p>

      <div class="figure">
        <a id="all_services_of_elix01_on_one_page"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e39531"/><img alt="All services of elix01 on one page" src="../Images/tagoreillycom20081104nostarchimages223982.png.jpg"/></div>

        <p class="title">Figure 19-12. All services of <code class="userinput">elix01</code> on one page</p>
      </div>

      <p>A mouse click on a service graph or on the accompanying link on the right in the overview causes the selected display to be shown in a different time resolution (<a class="xref" href="../Text/ch19s06.html#system_load_in_pnp_colon_host" title="Figure 19-13. System load in PNP: host elix01, service lx-load">Figure 19-13</a>): four hours, one day and (not shown) one week, one month, and one year. The periods presented here by PNP are defined in the configuration file <strong class="userinput"><code>config.php</code></strong>:<a class="indexterm" id="IDX-CHP-19-1626"/></p><a id="I_programlisting4_d1e39546"/>
      <pre class="programlisting">$views[0]["title"]   =   "4 Hours";
         $views[0]["start"]   =   ( 60*60*4 );

         $views[1]["title"]   =   "24 Hours";
         $views[1]["start"]   =   ( 60*60*24 );

         $views[2]["title"]   =   "One Week";
         $views[2]["start"]   =   ( 60*60*24*7 );

         $views[3]["title"]   =   "One Month";
         $views[3]["start"]   =   ( 60*60*24*30 );

         $views[4]["title"]   =   "One Year";
         $views[4]["start"]   =   ( 60*60*24*365 );</pre>

      <p>The specific <strong class="userinput"><code>title</code></strong> labels can be chosen freely, so you could also use text in other languages. The images themselves cannot be localized, however.</p>

      <div class="figure">
        <a id="system_load_in_pnp_colon_host"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e39561"/><img alt="System load in PNP: host elix01, service lx-load" src="../Images/tagoreillycom20081104nostarchimages223984.png.jpg"/></div>

        <p class="title">Figure 19-13. System load in PNP: host <code class="userinput">elix01</code>, service <code class="userinput">lx-load</code></p>
      </div>

      <p>The <strong class="userinput"><code>start</code></strong> details specify for how many seconds <span class="emphasis"><em>before</em></span> a defined reference point the graphic will begin. Normally the current time is used as a reference point, but this can also be selected using the calendar included. To do this, you click the calendar icon (see <a class="xref" href="../Text/ch19s06.html#pnp_apostrophy_s_calendar_function" title="Figure 19-14. PNP's calendar function">Figure 19-14</a>), select the end time after <span class="strong"><strong>Time</strong></span> with a mouse click, and then select the day. Selecting the time takes some getting used to: One click increases the value displayed by one, and holding down the <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e39579"/><img alt="System load in PNP: host elix01, service lx-load" src="../Images/tagoreillycom20081104nostarchimages223986.png"/></span> key at the same time reduces the time value displayed. You can also hold down the left mouse button and drag the mouse to the left to increase the value, or drag to the right to decrease it.</p>

      <div class="figure">
        <a id="pnp_apostrophy_s_calendar_function"/>

        <div class="figure-contents mediaobject"><a id="I_mediaobject4_d1e39588"/><img alt="PNP's calendar function" src="../Images/tagoreillycom20081104nostarchimages223988.png.jpg"/></div>

        <p class="title">Figure 19-14. PNP's calendar function</p>
      </div>

      <p>In order to display a specific service directly, just add the detail <strong class="userinput"><code>svc=</code></strong><strong class="userinput"><code><em class="replaceable"><code>servicename</code></em></code></strong> to the URL, so that you have <a class="ulink" href="http://nagiosserver/nagios/pnp/index.php?host=hostname&amp;svc=servicename">http://nagiosserver/nagios/pnp/index.php?host=hostname&amp;svc=servicename</a>.</p>

      <p>A particular feature of PNP is that each graphic can be addressed directly, without using HTML or PHP pages. You require the two optional parameters <strong class="userinput"><code>display</code></strong> and <strong class="userinput"><code>view</code></strong>: <a class="ulink" href="http://nagiosserver/nagios/pnp/index.php?host=host&amp;svc=servicename&amp;display=image&amp;view=0">http://nagiosserver/nagios/pnp/index.php?host=host&amp;svc=servicename&amp;display=image&amp;view=0</a>. <strong class="userinput"><code>display</code></strong> can currently handle only the value <strong class="userinput"><code>image</code></strong>, and for <strong class="userinput"><code>view</code></strong> you enter the index defined in <strong class="userinput"><code>config.php</code></strong>: <strong class="userinput"><code>view=0</code></strong> refers to the time period that was defined there with <strong class="userinput"><code>$views [0] ["start"]</code></strong> (so this is the default, with a four-hour overview).</p>

      <div class="sect3" title="Integrating PNP into the Nagios Web interface">
        <div class="titlepage">
          <h3 class="title" id="heading_id_7"><a id="integrating_pnp_into_the_nagios_web_int"/>Integrating PNP into the Nagios Web interface</h3>
        </div>

        <p>To display a single service directly from the Nagios Web interface, in Nagios 3 you need to integrate the following URL as <strong class="userinput"><code>action_url</code></strong> in the service definition:<a class="indexterm" id="IDX-CHP-19-1627"/><a class="indexterm" id="IDX-CHP-19-1628"/><a class="indexterm" id="IDX-CHP-19-1629"/><a class="indexterm" id="IDX-CHP-19-1630"/><a class="indexterm" id="IDX-CHP-19-1631"/><a class="indexterm" id="IDX-CHP-19-1632"/><a class="indexterm" id="IDX-CHP-19-1633"/><a class="indexterm" id="IDX-CHP-19-1634"/></p><a id="I_programlisting4_d1e39675"/>
        <pre class="programlisting"># Nagios 3
define service {
    hostname              <span class="emphasis"><em>hostname</em></span>
    service_description   <span class="emphasis"><em>servicename</em></span>
    ...
    action_url            /pnp/index.php?host=$HOSTNAME$&amp;srv=$SERVICEDESC$
}</pre>

        <p>In Nagios 2.x you require the object <strong class="userinput"><code>serviceextinfo</code></strong> to achieve the same purpose:</p><a id="I_programlisting4_d1e39688"/>
        <pre class="programlisting"># Nagios 2.x
define serviceextinfo {
     hostname             <span class="emphasis"><em>hostname</em></span>
     service_description  <span class="emphasis"><em>servicedesc</em></span>
     ...
     action_url           /pnp/index.php?host=$HOSTNAME$&amp;srv=$SERVICEDESC$
}</pre>
      </div>
    </div>

    <div class="sect2" title="19.6.4 Bulk processing of performance data">
      <div class="titlepage">
        <h2 class="title" id="heading_id_8"><a id="bulk_processing_of_performance_data"/>19.6.4 Bulk processing of performance data</h2>
      </div>

      <p>The standard configuration discussed calls the command defined in <strong class="userinput"><code>service_perfdata_command</code></strong> for each check. Since the embedded Perl interpreter ePN (see <a class="xref" href="../Text/apg.html" title="Appendix G. The Embedded Perl Interpreter">Appendix G</a> in page 669) cannot execute <strong class="userinput"><code>process_perf-data.pl</code></strong>, Nagios has to restart the Perl interpreter for every service whose performance data is to be processed. This takes a toll on resources and, depending on the capabilities of the host and the number of services to be processed, has a negative influence on the performance of Nagios (to measure Nagios performance, see <a class="xref" href="../Text/apf.html" title="Appendix F. Tips on Optimizing Performance">Appendix F</a> from page 653). Nagios then really is brought to its knees, which means that the latency time that passes between the planned starting point and the actual start of a check increases considerably, and Nagios's timetable (the <span class="emphasis"><em>scheduling</em></span>) gets out of control.<a class="indexterm" id="IDX-CHP-19-1636"/><a class="indexterm" id="IDX-CHP-19-1635"/></p>

      <p>One solution to this is offered by PNP's bulk mode in combination with the <span class="emphasis"><em>Nagios Performance Data C Daemon</em></span> (NPCD).<sup>[<a class="footnote" href="#ftn.CHP-19-FN-28" id="CHP-19-FN-28">220</a>]</sup> When this is used, Nagios writes the performance data—formatted by templates (defined in <strong class="userinput"><code>service_perfdata_file_template</code></strong>)—to a file that is regularly renamed by a command in <strong class="userinput"><code>service_perfdata_file_processing_command</code></strong>. NPCD now runs the Perl script <strong class="userinput"><code>process_perfdata.pl</code></strong> only once for each file.<a class="indexterm" id="IDX-CHP-19-1638"/><a class="indexterm" id="IDX-CHP-19-1639"/><a class="indexterm" id="IDX-CHP-19-1640"/><a class="indexterm" id="IDX-CHP-19-1637"/></p>

      <p><strong class="userinput"><code>service_perfdata_file_template</code></strong> defines the format in which the data is written to the file specified in <strong class="userinput"><code>service_perfdata_file</code></strong>:<sup>[<a class="footnote" href="#ftn.CHP-19-FN-29" id="CHP-19-FN-29">221</a>]</sup></p><a id="I_programlisting4_d1e39764"/>
      <pre class="programlisting"># /etc/nagios/nagios.cfg
...
service_perfdata_file_template=DATATYPE::SERVICEPERFDATA\tTIMET::$TIMET$
\tHOSTNAME::$HOSTNAME$\tSERVICEDESC::$SERVICEDESC$\tSERVICEPERFDATA::$SE
RVICEPERFDATA$\tSERVICECHECKCOMMAND::$SERVICECHECKCOMMAND$\tHOSTSTATE::
$HOSTSTATE$\tHOSTSTATETYPE::$HOSTSTATETYPE$\tSERVICESTATE::$SERVICEST
ATE$\tSERVICESTATETYPE::$SERVICESTATETYPE$

service_perfdata_file=/var/nagios/service-perfdata
service_perfdata_file_mode=a
service_perfdata_file_processing_interval=30
service_perfdata_file_processing_command=service-perfdata-npcd
...</pre>

      <p><strong class="userinput"><code>service_perfdata_file_mode</code></strong> specifies how Nagios handles the file: The value <strong class="userinput"><code>a</code></strong> stands for <span class="emphasis"><em>append</em></span>. Thus Nagios appends new results to an already existing file. Every 30 seconds (as specified in <strong class="userinput"><code>service_perfdata_file_processing_interval</code></strong>) the <span class="emphasis"><em>File Processing Command</em></span> <strong class="userinput"><code>service-perfdata-npcd</code></strong> starts. It shifts the file, renames it, and adds the current times-tamp, using the Nagios macro <strong class="userinput"><code>$TIMET$</code></strong>:<a class="indexterm" id="IDX-CHP-19-1641"/><a class="indexterm" id="IDX-CHP-19-1642"/></p><a id="I_programlisting4_d1e39795"/>
      <pre class="programlisting">define command{
      command_name service-perfdata-npcd
      command_line /bin/mv /var/nagios/service-perfdata /var/nagios/perfsp
ool/service-perfdata-$TIMET$
}</pre>

      <p>Renaming and shifting doesn't use up any time. So Nagios can immediately resume its normal tasks and leave further processing of performance data to the external NPCD daemon. NPCD has its own configuration file, in <strong class="userinput"><code>npcd.cfg</code></strong>, which is copied during installation to the directory <strong class="userinput"><code>/etc/pnp</code></strong>:<a class="indexterm" id="IDX-CHP-19-1643"/></p><a id="I_programlisting4_d1e39808"/>
      <pre class="programlisting">user=nagios
group=nagios
log_type=syslog
log_level=0
perfdata_spool_dir=/var/nagios/perfspool/
perfdata_file_run_cmd=/usr/local/nagios/libexec/process_perfdata.pl
perfdata_file_run_cmd_args=-b
npcd_max_threads=1</pre>

      <p>The first two entries specify with which user and which group membership NPCD is to be started. The daemon can currently only log its work in the syslog. Future versions should also allow this to be written to a separate file. <strong class="userinput"><code>log_level=0</code></strong> ensures that NPCD itself behaves quietly and passes on all errors only to the syslog daemon.</p>

      <p>The parameter <strong class="userinput"><code>perfdata_spool_dir</code></strong> renames the directory to be monitored. It must already exist; the NPCD does not create it automatically. Thanks to the argument <strong class="userinput"><code>-b</code></strong> given in <strong class="userinput"><code>perfdata_file_run_cmd_args, process_perfdata.pl</code></strong> starts in bulk mode.</p>

      <p>The NPCD installs itself during the <strong class="userinput"><code>"make install"</code></strong> command for PNP to the directory <strong class="userinput"><code>/usr/local/nagios/bin</code></strong>. Running <strong class="userinput"><code>make install-init</code></strong> causes an additional startup script to be placed in <strong class="userinput"><code>/etc/init.d</code></strong>, in which you have to check the path to the configuration file:<a class="indexterm" id="IDX-CHP-19-1644"/></p><a id="I_programlisting4_d1e39846"/>
      <pre class="programlisting">...
CONF=/etc/pnp/npcd.cfg
...</pre>

      <p>With the help of this, the daemon is started with the following command:</p><a id="I_programlisting4_d1e39850"/>
      <pre class="programlisting">linux:~ # /etc/init.d/npcd start</pre>

      <p>Depending on your distribution, the init script in the <strong class="userinput"><code>rc</code></strong> directories is linked to the relevant runlevel:</p><a id="I_programlisting4_d1e39857"/>
      <pre class="programlisting">linux:~ # ln -s /etc/init.d/npcd.sh /etc/init.d/rc2.d/S99npcd
linux:~ # ln -s /etc/init.d/npcd.sh /etc/init.d/rc3.d/S99npcd
linux:~ # ln -s /etc/init.d/npcd.sh /etc/init.d/rc5.d/S99npcd</pre>
    </div>

    <div class="sect2" title="19.6.5 How should the graphic appear?">
      <div class="titlepage">
        <h2 class="title" id="heading_id_9"><a id="how_should_the_graphic_appear_question"/>19.6.5 How should the graphic appear?</h2>
      </div>

      <p>The appearance of PNP graphics is determined by templates. The examples included are located in the directory <strong class="userinput"><code>/usr/local/nagios/share/pnp/templates.dist</code></strong>. You should not touch these, as they will be overwritten at the next update. The directory <strong class="userinput"><code>templates</code></strong> is intended for some templates. PNP takes the name of the check that was defined in the <strong class="userinput"><code>command_name</code></strong> and searches here for a matching template called <strong class="userinput"><code><em class="replaceable"><code>command_name.php</code></em></code></strong>.<a class="indexterm" id="IDX-CHP-19-1645"/></p>

      <p>If PNP cannot find this either in <strong class="userinput"><code>./templates</code></strong> or in <strong class="userinput"><code>./templates.dist</code></strong>, it uses the default template <strong class="userinput"><code>default.php</code></strong>.</p>

      <p>Sometimes there is already a suitable template in <strong class="userinput"><code>templates.dist</code></strong> (for example, <strong class="userinput"><code>check_ping.php</code></strong> for the plugin <strong class="userinput"><code>check_icmp</code></strong>), the name of which does not match the command name (in the case of <strong class="userinput"><code>check_icmp</code></strong>, we have defined this as <strong class="userinput"><code>command_name check_icmp</code></strong>). Then you must create a symlink in <strong class="userinput"><code>./templates</code></strong> to the desired file:<a class="indexterm" id="IDX-CHP-19-1646"/></p><a id="I_programlisting4_d1e39915"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/nagios/share/pnp/templates</strong></span>
linux:pnp/templates # <span class="strong"><strong>ln -s../templates.dist/check_ping.php \
check_icmp.php</strong></span></pre>

      <p>A simple template which can be used for all plugins that transmit a simple response time is <strong class="userinput"><code>response.php</code></strong>:</p><a id="I_programlisting4_d1e39927"/>
      <pre class="programlisting">&lt;?php
#
# For all plugins that provide response times
# $Id: response.php 53 2006-06-07 07:16:50Z linge $
#

$opt[1] = "--vertical-label \"Response Time\" \
           --title \"Response Time For $hostname / $serviced
esc\" ";

$def[1]  =  "DEF:var1=$rrdfile:$DS[1]:AVERAGE " ;
$def[1]  .=  "AREA:var1#00FF00:\"Response Times \" " ;
$def[1]  .=  "LINE1:var1#000000:\"\" " ;
$def[1]  .=  "GPRINT:var1:LAST:\"%3.41g %s$UNIT[1] LAST \" ";
$def[1]  .=  "GPRINT:var1:MAX:\"%3.41g %s$UNIT[1] MAX \" ";
$def[1]  .=  "GPRINT:var1:AVERAGE:\"%3.4lg %s$UNIT[1] AVERAGE \" ";
?&gt;</pre>

      <p>The variable <strong class="userinput"><code>$opt[1]</code></strong> defines the options for <strong class="userinput"><code>rrdtool</code></strong>, and the variable <strong class="userinput"><code>$def[1]</code></strong> defines the RRD graph. If you want to create your own templates, you will need to get involved with <strong class="userinput"><code>rrdtool</code></strong> in more detail. The definition of a graphic is explained in detail by <strong class="userinput"><code>man rrdgraph</code></strong>, and further information can be found on the homepage.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-30" id="CHP-19-FN-30">222</a>]</sup></p>

      <div class="sect3" title="Custom Templates">
        <div class="titlepage">
          <h3 class="title" id="heading_id_10"><a id="custom_templates"/>Custom Templates</h3>
        </div>

        <p>PNP is based on the name of the defined command object. If this is not informative enough, as in the case of <strong class="userinput"><code>command_name check_nrpe</code></strong>, then so-called <span class="emphasis"><em>custom templates</em></span> in the directory <strong class="userinput"><code>/etc/pnp/check_commands</code></strong> are used. These must contain the name of the original command, however, which in our example is <strong class="userinput"><code>check_nt.cfg</code></strong>:<a class="indexterm" id="IDX-CHP-19-1647"/><a class="indexterm" id="IDX-CHP-19-1648"/><a class="indexterm" id="IDX-CHP-19-1649"/><a class="indexterm" id="IDX-CHP-19-1650"/><a class="indexterm" id="IDX-CHP-19-1651"/></p><a id="I_programlisting4_d1e39987"/>
        <pre class="programlisting">#
# Adapt the Template if check_command should not be the PNP Template
#
# check_command check_nt!MEMUSE!80%!90%
# ________0__________|     |    |  |
# ________1________________|    |  |
# ________2_____________________|  |
# ________3________________________|
#
CUSTOM_TEMPLATE = 0,1
#</pre>

        <p>If <strong class="userinput"><code>check_nt</code></strong> is not given <strong class="userinput"><code>MEMUSE</code></strong> as the first parameter, the actual command for the plugin <strong class="userinput"><code>check_nt</code></strong>, only this parameter will differentiate whether memory usage or CPU load, for instance, is measured. The parameter <strong class="userinput"><code>CUSTOM_TEMPLATE</code></strong> puts together the command that PNP uses when searching for templates: The example below puts together <strong class="userinput"><code>check_nt</code></strong> (entry number 0) and <strong class="userinput"><code>MEMUSE</code></strong> (entry number 1). This means that PNP will search for a template with the name <strong class="userinput"><code>check_nt_MEMUSE.php</code></strong>. With <strong class="userinput"><code>CUSTOM_TEMPLATE = 1</code></strong>, PNP would search for <strong class="userinput"><code>MEMUSE.php</code></strong>. A suitable symlink is now set in the directory <strong class="userinput"><code>./templates</code></strong>:</p><a id="I_programlisting4_d1e40022"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>cd /usr/local/nagios/share/pnp/templates</strong></span>
linux:pnp/templates # <span class="strong"><strong>ln -s ../templates.dist/check_nt_mem.php</strong></span>\
<span class="strong"><strong>check_nt_MEMUSE.php</strong></span></pre>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-21" id="ftn.CHP-19-FN-21">213</a>]</sup> <a class="ulink" href="http://www.pnp4nagios.org/pnp/">http://www.pnp4nagios.org/pnp/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-22" id="ftn.CHP-19-FN-22">214</a>]</sup> <a class="ulink" href="https://lists.sourceforge.net/mailman/listinfo/pnp4nagios-users">https://lists.sourceforge.net/mailman/listinfo/pnp4nagios-users</a> (generally on PNP usage) and <a class="ulink" href="https://lists.sourceiorge.net/mailman/listinio/%20pnp4nagios-devel">https://lists.sourceiorge.net/mailman/listinio/ pnp4nagios-devel</a> (feature requests, bugs, patches, and the like)</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-23" id="ftn.CHP-19-FN-23">215</a>]</sup> <a class="ulink" href="http://nagios-portal.de/forum/board.php?boardid=58">http://nagios-portal.de/forum/board.php?boardid=58</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-24" id="ftn.CHP-19-FN-24">216</a>]</sup> <a class="ulink" href="http://www.rrdtool.org/">http://www.rrdtool.org/</a>, see also <a class="xref" href="../Text/ch19s04.html#installation-id6" title="19.4.1 Installation">19.4.1 Installation</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-25" id="ftn.CHP-19-FN-25">217</a>]</sup> <a class="ulink" href="http://www.pnp4nagios.org/pnp/">http://www.pnp4nagios.org/pnp/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-26" id="ftn.CHP-19-FN-26">218</a>]</sup> Performance data is provided by the macro <strong class="userinput"><code>$SERVICEPERFDATA$</code></strong>; see <a class="xref" href="../Text/apd.html#host_macros" title="D.1.1 Host macros">D.1.1 Host macros</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-27" id="ftn.CHP-19-FN-27">219</a>]</sup> This has only been possible since Nagios 3.0, with the <strong class="userinput"><code>enable_environment_macros</code></strong> parameter (see <a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>). More on environment variables in <a class="xref" href="../Text/apd.html#using_standard_macros_about_the_environm" title="D.1.8 Using standard macros about the environment">D.1.8 Using standard macros about the environment</a> from page 631.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-28" id="ftn.CHP-19-FN-28">220</a>]</sup> The C in the name alludes to the considerably faster performance speed of a C program compared to a Perl script, for which Nagios has to restart the Perl interpreter each time.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-29" id="ftn.CHP-19-FN-29">221</a>]</sup> This is just a single line, which has been line-wrapped here for display purposes.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-30" id="ftn.CHP-19-FN-30">222</a>]</sup> <a class="ulink" href="http://www.rrdtool.org/">http://www.rrdtool.org/</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="19.7 Other Tools and the Limits of Graphic Evaluation">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="other_tools_and_the_limits_of_graphic"/>19.7 Other Tools and the Limits of Graphic Evaluation</h1>
    </div>

    <p>Apart from the tools introduced here, <a class="ulink" href="http://www.nagiosexchange.org/">http://www.nagiosexchange.org/</a> provides further tools for the graphic evaluation of performance data. Many of these are also based on the RRDtools and round-robin databases, the consequence of which is that they are not much use for exact evaluations over several years, just like the ones described here.<a class="indexterm" id="IDX-CHP-19-1652"/><a class="indexterm" id="IDX-CHP-19-1653"/><a class="indexterm" id="IDX-CHP-19-1654"/></p>

    <p>Several tools, such as the current APAN<sup>[<a class="footnote" href="#ftn.CHP-19-FN-31" id="CHP-19-FN-31">223</a>]</sup> version, save their data in an SQL database, thus enabling long-term statistics without data loss.<a class="indexterm" id="IDX-CHP-19-1655"/></p>

    <p>PerfParse<sup>[<a class="footnote" href="#ftn.CHP-19-FN-32" id="CHP-19-FN-32">224</a>]</sup> is very extensive, and it stores data in a MySQL or PostgreSQL database and also includes its own wide range of evaluation tools. Because it uses various current libraries which are not included in every distribution, the installation hurdles are quite high. Nevertheless, those for whom the RRD-based tools do not offer enough should look to see if the PerfParse tools can provide the missing functionality that is required.</p>

    <p>For all the options it offers, the graphical display of Nagios performance data also has its limits. If you check WAN connections with a ping to a remote host and measure the average response time, all the pretty graphics don't mean much if the check interval is only every five minutes. You will receive only a momentary snapshot every five minutes, which does not provide any serious clues to the traffic load of the connection over a period of time.</p>

    <p>To be able to sensibly assess the load of a Unix computer reported by a plugin every one, five, and 15 minutes, the check interval should be one minute. Less critical data are such things as used hard drive space or temperature. Equally noncritical is the display of network traffic, for which the plugin displays the values as a counter. RRD-based tools can automatically detect the difference between two measurements and display them; it makes no difference here whether the check interval is one, two, or five minutes; no data is lost.</p>

    <p>If the measuring precision of Nagios leaves something to be desired, you can deploy other tools in parallel, such as Cricket<sup>[<a class="footnote" href="#ftn.CHP-19-FN-33" id="CHP-19-FN-33">225</a>]</sup> or Cacti.<sup>[<a class="footnote" href="#ftn.CHP-19-FN-34" id="CHP-19-FN-34">226</a>]</sup> If the external tool—like Munin<sup>[<a class="footnote" href="#ftn.CHP-19-FN-35" id="CHP-19-FN-35">227</a>]</sup> —works with RRD databases, you can check these for critical values, so that they are included in the sophisticated Nagios notification system. Alternatively the external tool can provide an interface with which recorded data can be further processed. These can be passed on as a passive test result to Nagios, for example using NSCA (see <a class="xref" href="../Text/ch14.html" title="Chapter 14. The Nagios Service Check Acceptor (NSCA)">Chapter 14</a>).<a class="indexterm" id="IDX-CHP-19-1656"/></p>

    <p>But an additional tool always has the disadvantage of adding to the configuration effort. Whether this is justified, or whether Nagios performance monitoring is sufficient, depends on the information required in a particular situation.</p>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-31" id="ftn.CHP-19-FN-31">223</a>]</sup> <a class="ulink" href="http://apan.sf.net/">http://apan.sf.net/</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-32" id="ftn.CHP-19-FN-32">224</a>]</sup> <a class="ulink" href="http://perfparse.sf.net/">http://perfparse.sf.net/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-33" id="ftn.CHP-19-FN-33">225</a>]</sup> <a class="ulink" href="http://cricket.sourceforge.net/">http://cricket.sourceforge.net/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-34" id="ftn.CHP-19-FN-34">226</a>]</sup> <a class="ulink" href="http://www.cacti.net/">http://www.cacti.net/</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-19-FN-35" id="ftn.CHP-19-FN-35">227</a>]</sup> <a class="ulink" href="http://munin.projects.linpro.no/">http://munin.projects.linpro.no/</a></p>
      </div>
    </div>
  </div>
</body></html>