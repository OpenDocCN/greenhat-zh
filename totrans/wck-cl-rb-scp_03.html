<html><head></head><body>
  <div class="sgc-1" id="filepos272253"/>&#13;
&#13;
  <h1 class="calibre1" id="calibre_pb_149"><span class="calibre2"><a class="calibre7" shape="rect"/>Chapter 3. LI(U)NIX SYSTEM ADMINISTRATION</span></h1>&#13;
&#13;
  <div class="calibre3"><a class="calibre17" shape="rect"/><img alt="LI(U)NIX SYSTEM ADMINISTRATION" class="calibre23" src="../Images/00001.jpg"/></div>&#13;
&#13;
  <p class="calibre4">No computing system runs optimally straight out of the box. Whether you need to adjust security settings, add users, define permissions, or install applications—there is always something left to do. Once the system is configured exactly how you want it, the next task is maintaining the system until an upgrade is needed. Then the cycle starts all over again. This cycle is known as system administration. Administrators well versed in Linux or Unix system administration understand the power and flexibility that simple scripts can add to the geek's toolbox. Forget about the mundane tasks: Let the scripts deal with them.<a class="calibre17" shape="rect"/></p>&#13;


  <div class="calibre3 calibre3 calibre3 calibre3">
    <h1 class="calibre1" id="calibre_pb_150"><span class="calibre2"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos273659"/>Fixing Bad Filenames</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_151"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos273953"/>Fixing Bad Filenames</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>fixFilename.rb</h3>
      </div>

      <p class="calibre4">When it comes to naming files, endless possibilities exist. There can be short abbreviated filenames, long descriptive filenames, or even random filenames that don't make sense. Filenames can be too long for some systems or contain special, reserved characters for other systems.<a class="calibre17" shape="rect"/></p>

      <p class="calibre4">Working in <span><em class="italic">a graphical user interface</em></span>, or <span><em class="italic">GUI</em></span>, environment can lead to <a class="calibre17" shape="rect"/>bad habits, as far as naming conventions go. The GUI environment can deal with almost any character used in a filename, but when these <a class="calibre17" shape="rect"/>filenames are accessed at the <a class="calibre17" shape="rect"/>command line, they create a lot of headaches. The idea behind this script is to remember the poor souls who still use the command line … myself included. For all of the uncertainty of naming files, a simple script can help clean up and organize them. This script will rename files according to a specific set of rules.</p>

      <p class="calibre4">When I think of weird filenames, picture and music files always come to mind. If you're sharing photographs from that special vacation or showing off your band's latest jam session, the naming scheme will be different from person to person, and it may clash with the recipient's operating system. The script I'm about to show you will take each filename and format it based on your specifications. This script is highly customizable and super efficient, so find some files with questionable filenames and send them through. You'll be pleasantly surprised when the script is done.</p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_152"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos276412"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> #!/usr/bin/ruby<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       unless ARGV[0]<br class="calibre20"/>&#13;
           puts "Usage: ruby fixFilename.rb &lt;filename.ext&gt;"<br class="calibre20"/>&#13;
           puts "Example: ruby fixFilename.rb \'How to (make) 20% more on $500.pdf\'"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> old_filename = ARGV[0]<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       unless File.exist?(old_filename)'<br class="calibre20"/>&#13;
           puts "#{old_filename} does not exist.  Please try again."<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/>      exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> name = File.basename(old_filename, ".*")<br class="calibre20"/>&#13;
       ext = File.extname(old_filename)<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/> replacements = {  /;/ =&gt; "-",<br class="calibre20"/>&#13;
                       /\s/ =&gt; "_",<br class="calibre20"/>&#13;
                       /\'\`/ =&gt; "=",<br class="calibre20"/>&#13;
                       /\&amp;/ =&gt; "_and_",<br class="calibre20"/>&#13;
                       /\$/ =&gt; "dollar_",<br class="calibre20"/>&#13;
                       /%/ =&gt; "_percent",<br class="calibre20"/>&#13;
                       /[\(\)\[\]&lt;&gt;]/ =&gt; ""<br class="calibre20"/>&#13;
                     }<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
        replacements.each do |orig, fix|<br class="calibre20"/>&#13;
            name.gsub!(orig,fix)<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/> File.rename(old_filename, name + ext)<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00007.jpg"/> puts "#{old_filename} ---&gt; #{name + ext}"</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_153"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos278589"/>Running the Code</span></h2>
    </div>

    <p class="calibre4">The script runs with one command-line argument, the filename <a class="calibre17" shape="rect"/>to scan and potentially fix:<a class="calibre17" shape="rect"/></p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">./fixFilename.rb <em class="italic"><code class="calibre19">"How to (make) 20% more on $500.pdf"</code></em></code></strong></tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_154"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos279418"/>The Results</span></h2>
    </div>

    <p class="calibre4">The resulting output will show the old filename and what it was converted to. For this example, I made a bogus file with some nasty characters in it.</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19"><em class="italic"><code class="calibre19">How to (make) 20% more on $500.pdf ---&gt;<br class="calibre20"/>
      How_to_make_20_percent_more_on_dollar_500.pdf</code></em></tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_155"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos280194"/>How It Works</span></h2>
    </div>

    <p class="calibre4">As mentioned in "Running the Code," this script relies on the user passing a filename as an argument to the script <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. The script, in turn, attaches to the file and ensures that it actually exists. If a user mistyped some of the filename, instead of crashing, the script will inform the user that something is amiss with the input and exit cleanly <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>.</p>

    <p class="calibre4">Next, a new variable called <code class="calibre19">name</code> is created so that you can tweak the original filename without disrupting it. The filename is stripped from its <a class="calibre17" shape="rect"/>extension <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. I isolated the extension so the file will still function properly in the off chance that one of the filters was set up in a way that could accidentally alter an extension. In the script's current configuration, it will only alter the filename.</p>

    <p class="calibre4">The script uses a hash data structure named <code class="calibre19">replacements</code> to hold all of the invalid characters and their corresponding acceptable values. A code block containing the <code class="calibre19">gsub</code> method will be used to make all of the substitutions. The end result is that <code class="calibre19">name</code> will be returned with all occurrences of the specified pattern substituted by a replacement. Each line of the hash focuses on a specific "<a class="calibre17" shape="rect"/>bad character" <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. First is the <a class="calibre17" shape="rect"/>semicolon, which is a reserved character in Linux and must be escaped. Instead of dealing with the semi-colon, the script substitutes it with a dash. All <a class="calibre17" shape="rect"/>whitespace in the filename is turned into underscores, which look similar to whitespace. Backticks (on American keyboards this key is on the upper-left side, immediately to the left of the number 1, shared with the tilde) and apostrophes are turned into equal signs. Symbols such as &amp;, %, and $ are converted to words. Finally, the name is checked for any parentheses, curly brackets, and angle brackets. Any found are removed.</p>

    <p class="calibre4">The last step in the script renames the file. Using the <code class="calibre19">rename</code> method, the script gives the file our brand new operating-system friendly name <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. As a courtesy to the user, the old filename is shown, as well as what it is being transformed into <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00007.jpg"/></span>.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_156"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos283804"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">Further expansion on this script is really easy because of the way each rule is created. If you have a better way of representing the percentage sign, then you can easily edit the corresponding line of code. Additionally, there is always the possibility of <a class="calibre17" shape="rect"/>adding prefixes or suffixes to each file. The script is flexible, so try some variations to see how you like them.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_157"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos284407">
    <h1 class="calibre1" id="calibre_pb_158"><span class="calibre2"><a class="calibre7" shape="rect"/>Adding a User</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_159"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos284895"/>Adding a User</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>addUser.rb</h3>
      </div>

      <p class="calibre4">Since the advent of GUIs, <a class="calibre17" shape="rect"/>adding users to Unix and Linux systems has become much easier. You fill out the boxes, click Add, and you're done. Before GUIs, and still too often today, system administrators had to manually create each user account on a system.</p>

      <p class="calibre4">While the task of manually creating user accounts for small organizations can be trivial, big businesses with thousands of users are a different story. Manually inputting account information into a computer system for 1,000 users is time consuming, tedious, and, most importantly, a waste of human productivity. This script automates the addition of user accounts to a system.</p>

      <div class="calibre3">
        <hr class="calibre21"/>
      </div>

      <div class="calibre3">
        <h3 class="calibre24" id="heading_id_3"><span class="calibre18"><a class="calibre7" shape="rect"/>Warning</span></h3>

        <p class="calibre4"><span class="calibre18"><span><em class="italic">This script is platform dependent, so ensure that your systems are compatible with the commands to avoid corrupting your user files</em></span>.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></span></p>
      </div>

      <div class="calibre3">
        <hr class="calibre21"/>
      </div>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_160"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos286804"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> #!/usr/bin/env ruby<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Using the command 'useradd' with various arguments<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       print "Enter new username: "<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/>    user_name = gets.chomp<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Add the groups to the user<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/>    print "\nEnter primary group: "<br class="calibre20"/>&#13;
       gname = gets.chomp<br class="calibre20"/>&#13;
       add_user = "-g #{gname} "<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       while gname<br class="calibre20"/>&#13;
           print "\nEnter next group (return blank line when finished): "<br class="calibre20"/>&#13;
           gname = gets.chomp<br class="calibre20"/>&#13;
           break if gname.empty?<br class="calibre20"/>&#13;
           add_user &lt;&lt; "-G #{gname} "<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> #Define which program will start when the user logs in<br class="calibre20"/>&#13;
       puts "\n\n\n[1] Bourne Again Shell (bash)"<br class="calibre20"/>&#13;
       puts "[2] Korn Shell (ksh)"<br class="calibre20"/>&#13;
       puts "[3] Z Shell (zsh)"<br class="calibre20"/>&#13;
       puts "[4] C Shell (csh)"<br class="calibre20"/>&#13;
       print "Which shell do you prefer (default bash)? "<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       sh_num = gets.chomp.to_i<br class="calibre20"/>&#13;
       shell = case sh_num<br class="calibre20"/>&#13;
           when 1 then '/bin/bash'<br class="calibre20"/>&#13;
           when 2 then '/bin/ksh'<br class="calibre20"/>&#13;
           when 3 then '/bin/zsh'<br class="calibre20"/>&#13;
           when 4 then '/bin/csh'<br class="calibre20"/>&#13;
           else '/bin/bash'<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       add_<a class="calibre17" shape="rect"/>user &lt;&lt; "-s #{shell} "<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Define home directory<br class="calibre20"/>&#13;
       add_user &lt;&lt; "-d /home/#{user_name} "<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Define starting folder<br class="calibre20"/>&#13;
       add_user &lt;&lt; "-m #{user_name}"<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Add user to the system and look at return value<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/> if(system("useradd #{add_user}"))<br class="calibre20"/>&#13;
           puts "\n\nSuccessfully added: #{user_name}"<br class="calibre20"/>&#13;
       else<br class="calibre20"/>&#13;
           puts "\n\nUnable to add: #{user_name}"<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_161"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos289166"/>Running the Code</span></h2>
    </div>

    <p class="calibre4">You can add users to your Unix-type system by following the prompts given by the script. Run it by typing:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">./addUser.rb</code></strong><br class="calibre20"/>
      Enter new username: <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">steve</code></em></code></strong><br class="calibre20"/>
      How many groups will you add? <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">2</code></em></code></strong><br class="calibre20"/>
      Enter primary group: <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">admin</code></em></code></strong><br class="calibre20"/>
      Enter next group: <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">printer</code></em></code></strong><br class="calibre20"/>
      <br class="calibre20"/>
      [1] Bourne Again Shell (bash)<br class="calibre20"/>
      [2] Korn Shell (ksh)<br class="calibre20"/>
      [3] Z Shell (zsh)<br class="calibre20"/>
      [4] C Shell (csh)<br class="calibre20"/>
      Which shell do you prefer (default bash)? <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">1</code></em></code></strong><br class="calibre20"/>
      <br class="calibre20"/>
      Successfully added: <em class="italic"><code class="calibre19">steve</code></em></tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_162"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos290893"/>The Results</span></h2>
    </div>

    <p class="calibre4">This script will result in a user being added to your system with the configuration specified by you. You will see the following lines if the script was successful:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Successfully added: <em class="italic"><code class="calibre19">steve</code></em></tt></span>
    </div>

    <p class="calibre4">If you are able to change the password of the new account, you'll know the script actually worked. I ran this script on a Gentoo Linux computer and all of my accounts were disabled upon creation if no password was specified. Simply type:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">passwd <em class="italic"><code class="calibre19">steve</code></em></code></strong></tt></span>
    </div>

    <p class="calibre4">and enter your chosen password twice. Next, you can switch users, log in with your new credentials, and take a break. If the script was unsuccessful in creating the account, you will receive an error message.</p>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_163"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos292454"/>How It Works</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">You will no longer need to remember each flag or read through the <code class="calibre19">man</code> pages to simply add a user. The <code class="calibre19">useradd</code> command is a clean way to add users to a system, but the flags and options can be a bit cryptic. Also, <a class="calibre17" shape="rect"/>adding more than a handful of accounts can become tedious. This script is fully interactive and will allow anyone with basic system knowledge to easily add users.<a class="calibre17" shape="rect"/></p>&#13;
&#13;
    <p class="calibre4">In the example above, the script essentially creates the following string and uses the <code class="calibre19">system()</code> command to execute it:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19">useradd -g <em class="italic"><code class="calibre19">admin</code></em> -G <em class="italic"><code class="calibre19">printer</code></em> -s /bin/<em class="italic"><code class="calibre19">bash</code></em> -d /home/<em class="italic"><code class="calibre19">steve</code></em> -m <em class="italic"><code class="calibre19">steve</code></em></tt></span>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">The script begins building the string by requesting the <a class="calibre17" shape="rect"/>username <a class="calibre17" shape="rect"/>for the new account <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. The username is important for two reasons: It specifies the first piece of the logon credential, and it completes the <a class="calibre17" shape="rect"/>home directory. Next are the <a class="calibre17" shape="rect"/>groups <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. Groups matter in Unix-style systems because they associate <a class="calibre17" shape="rect"/>permissions to a specific username. In this example, I used the administrator and printer groups—these are entirely dependent upon the groups in your system.</p>&#13;
&#13;
    <p class="calibre4">After the permissions are given to the user, the <a class="calibre17" shape="rect"/>shell preference is requested <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. The list of shells I provided (bash, ksh, zsh, and csh) may not all be installed on your system, so you'll need to edit accordingly. Bash is the most common shell to use, so I have defined that as the default entry and also used it in my example.</p>&#13;
&#13;
    <p class="calibre4">The last addition to our command string is the home directory and username. The script asked for the username in the beginning, so that value is used. The home directory ends up being <span><em class="italic">/home/steve</em></span>, and the username is, obviously, <span><em class="italic">steve</em></span>.</p>&#13;
&#13;
    <p class="calibre4">Finally, the string is executed using the <code class="calibre19">system()</code> command <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>, which spawns a subprocess and waits for the subprocess to terminate. The value <code class="calibre19">true</code> is returned if the subprocess exits successfully; otherwise, <code class="calibre19">false</code> is returned.<a class="calibre17" shape="rect"/></p>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_164"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos296557"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">Hopefully, you realize that not all of the flags are required to create a user, but they do make life simpler during the initial account creation process. With some additional code, this script could be integrated with a CSV file for automated user creation.<a class="calibre17" shape="rect"/></p>

    <p class="calibre4">Try not to be overwhelmed by the amount of data I'm describing by hacking these scripts. If you are serious about writing your own scripts, a good starting point is to tweak other scripts and build up to writing scripts from scratch … especially when they involve many complex sections.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_165"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos297390">
    <h1 class="calibre1" id="calibre_pb_166"><span class="calibre2"><a class="calibre7" shape="rect"/>Modifying a User</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_167"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos297881"/>Modifying a User</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>modUser.rb</h3>
      </div>

      <p class="calibre4">If you have ever administered a computer system that had multiple users, chances are you have had to modify existing accounts. In my experience, <a class="calibre17" shape="rect"/>user accounts can be modified to update an expiration date, change a home directory, tweak a username, or, more commonly, to add a new group to the mix. Below you will find a generic script for guiding the user through the modification process. Keep in mind that this script needs to be run with elevated permissions.<a class="calibre17" shape="rect"/></p>

      <div class="calibre3">
        <hr class="calibre21"/>
      </div>

      <div class="calibre3">
        <h3 class="calibre24" id="heading_id_3"><span class="calibre18"><a class="calibre7" shape="rect"/>Warning</span></h3>

        <p class="calibre4"><span class="calibre18"><span><em class="italic">This script is platform dependent, so ensure that your systems are compatible with the commands to avoid corrupting your user files</em></span>.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></span></p>
      </div>

      <div class="calibre3">
        <hr class="calibre21"/>
      </div>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_168"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos299595"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> #!/usr/bin/env ruby<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Using the command 'useradd' with various arguments<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       print "Enter the username to modify: "<br class="calibre20"/>&#13;
       user_name = gets.chomp<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Determine how many groups the account will belong to<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> print "Would you like to add this account to any groups [y/n]? "<br class="calibre20"/>&#13;
       gresult = gets.chomp<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/>     if (gresults == 'y' || gresults == 'Y')<br class="calibre20"/>&#13;
           #Add the groups to the user<br class="calibre20"/>&#13;
           print "\nEnter primary group: "<br class="calibre20"/>&#13;
           gname = gets.chomp<br class="calibre20"/>&#13;
           mod_user = "-g #{gname} "<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
           while gname<br class="calibre20"/>&#13;
               print "\nEnter next group: "<br class="calibre20"/>&#13;
               gname = gets.chomp<br class="calibre20"/>&#13;
               break if gname.empty?<br class="calibre20"/>&#13;
               add_user &lt;&lt; "-G #{gname} "<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Define which program will start when the user logs in<br class="calibre20"/>&#13;
       print "Would you like to change the starting shell [y/n]?<br class="calibre20"/>&#13;
       sresult = gets.chomp<br class="calibre20"/>&#13;
       if (sresults == 'y' || sresults == 'Y')<br class="calibre20"/>&#13;
           puts "\n\n\n[1] Bourne Again Shell (bash)"<br class="calibre20"/>&#13;
           puts "[2] Korn Shell (ksh)"<br class="calibre20"/>&#13;
           puts "[3] Z Shell (zsh)"<br class="calibre20"/>&#13;
           puts "[4] C Shell (csh)"<br class="calibre20"/>&#13;
           print "Which shell would you like? "<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
           sh_num = gets.chomp.to_i<br class="calibre20"/>&#13;
           shell = case sh_num<br class="calibre20"/>&#13;
               when 1 then '/bin/bash'<br class="calibre20"/>&#13;
               when 2 then '/bin/ksh'<br class="calibre20"/>&#13;
               when 3 then '/bin/zsh'<br class="calibre20"/>&#13;
               when 4 then '/bin/csh'<br class="calibre20"/>&#13;
               else '/bin/bash'<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
           mod_user &lt;&lt; "-s ${shell} "<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Define home directory<br class="calibre20"/>&#13;
       print "Would you like to change the home directory [y/n]?<br class="calibre20"/>&#13;
       dresult = gets.chomp<br class="calibre20"/>&#13;
       if (dresults == 'y' || dresults == 'Y')<br class="calibre20"/>&#13;
           print "Enter new directory: "<br class="calibre20"/>&#13;
           dir = gets.chomp<br class="calibre20"/>&#13;
           mod_user &lt;&lt; "-d #{dir} "<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Define new Login<br class="calibre20"/>&#13;
       print "Would you like to change the login name [y/n]?<br class="calibre20"/>&#13;
       lresult = gets.chomp<br class="calibre20"/>&#13;
       if (lresults == 'y' || lresults == 'Y')<br class="calibre20"/>&#13;
           print "Enter new login: "<br class="calibre20"/>&#13;
           name = gets.chomp<br class="calibre20"/>&#13;
           mod_user &lt;&lt; "-l #{name}"<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #Modify user and look at return value<br class="calibre20"/>&#13;
       if('usermod #{mod_user}')<br class="calibre20"/>&#13;
           puts "\n\nSuccessfully modified: #{user_name}\n"<br class="calibre20"/>&#13;
       else<br class="calibre20"/>&#13;
           puts "\n\nUnable to modify: #{user_name}\n"</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_169"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos302991"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">You will be prompted for information a minimum of five times. The first prompt will ask for the username of the account you want to modify. The remaining four prompts will ask questions about which part of the account needs modification.</p>&#13;
&#13;
    <p class="calibre4">In the example above, I only changed the starting shell. The script interaction is shown below:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">./modUser.rb</code></strong><br class="calibre20"/>&#13;
      Enter the username to modify: <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">steve</code></em></code></strong><br class="calibre20"/>&#13;
      Would you like to add this account to any groups [y/n]? <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">n</code></em></code></strong><br class="calibre20"/>&#13;
      Would you like to change the starting shell [y/n]? <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">y</code></em></code></strong><br class="calibre20"/>&#13;
          [1] Bourne Again Shell (bash)<br class="calibre20"/>&#13;
          [2] Korn Shell (ksh)<br class="calibre20"/>&#13;
          [3] Z Shell (zsh)<br class="calibre20"/>&#13;
          [4] C Shell (csh)<br class="calibre20"/>&#13;
      Which shell would you like? <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">3</code></em></code></strong><br class="calibre20"/>&#13;
      Would you like to change the home directory [y/n]? <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">n</code></em></code></strong><br class="calibre20"/>&#13;
      Would you like to change the login name [y/n]? <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">n</code></em></code></strong><br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      Successfully modified: <em class="italic"><code class="calibre19">steve</code></em></tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_170"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos305347"/>The Results</span></h2>
    </div>

    <p class="calibre4">The results will be one of two messages. Either</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Successfully modified: <em class="italic"><code class="calibre19">steve</code></em></tt></span>
    </div>

    <p class="calibre4">or</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Unable to modify: <em class="italic"><code class="calibre19">steve</code></em></tt></span>
    </div>

    <p class="calibre4">If you are unable to modify the user, you will need to break out your troubleshooting hat to find the reason.</p>

    <p class="calibre4">In the example, whenever I log back into the account steve, I will now start off with the Z Shell instead of Bash. See how easy it is? This script could be given to a Unix novice and run from a terminal without any worries.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_171"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos306684"/>How It Works</span></h2>
    </div>

    <p class="calibre4">The script's main components are similar to the script in "#18 Adding a User" on <a class="calibre6" href="../Text/dummy_split_128.html#filepos283804" shape="rect">Hacking the Script</a>, because the <a class="calibre17" shape="rect"/>attributes for a user account are the same whether you are creating, <a class="calibre17" shape="rect"/>modifying, or deleting it. While I chose four attributes that I felt would be modified most frequently, they can always be removed to shorten runtime, or you can add others to suit your needs. The attributes to modify are <code class="calibre19">groups</code>, <code class="calibre19">starting shell</code>, <code class="calibre19">home directory</code>, and <code class="calibre19">login name</code>.</p>

    <p class="calibre4">Starting with the username, the script begins to prompt the system administrator for each attribute to determine whether any modifications are needed <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. A simple conditional statement is used each time and looks for the letter <span><em class="italic">y</em></span>. In case the user left her CAPS LOCK enabled, the script will also accept an uppercase letter <span><em class="italic">Y</em></span>. Any other input, whether it's <span><em class="italic">n</em></span>, <span><em class="italic">N</em></span>, or some other character, will be interpreted as a dismissal of the modification <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. Instead of adding this option to the conditional statement, I could have easily applied <code class="calibre19">.downcase</code> to the <code class="calibre19">gets</code> statement to <a class="calibre17" shape="rect"/>ensure the input is always lowercase.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>

    <p class="calibre4">Because most of the script is self-explanatory and thoroughly covered in "#18 Adding a User" on <a class="calibre6" href="../Text/dummy_split_128.html#filepos283804" shape="rect">Hacking the Script</a>, I won't belabor the details. An interesting point to note: If you wish to modify the username of an account, that account cannot be logged into. If you try to <code class="calibre19">su</code> to an admin account, then modify the account you just came from, or you will surely see a friendly message declaring that you cannot modify the specific user.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_172"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos309721"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">Adding a user and <a class="calibre17" shape="rect"/>modifying a user are very similar operations, lending themselves to the creation of a turnkey script for all user manipulations. You could easily combine the script in "#18 Adding a User" on <a class="calibre6" href="../Text/dummy_split_128.html#filepos283804" shape="rect">Hacking the Script</a> with this script and extract some of the methods for another clean script.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_173"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos310309">
    <h1 class="calibre1" id="calibre_pb_174"><span class="calibre2"><a class="calibre7" shape="rect"/>Killing a Stuck Process</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_175"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos310807"/>Killing a Stuck Process</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>killProcess.rb</h3>
      </div>

      <p class="calibre4"><a class="calibre17" shape="rect"/>Applications are wonderful additions to operating systems. But occasionally they get stuck and begin to cause a self-inflicted Denial of Service attack on your system. Some <a class="calibre17" shape="rect"/>processes are very stubborn and take extra effort to completely kill. This wicked little script will intuitively identify the stuck processes and automatically terminate them. How's that for avoiding additional manual work?<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_176"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos311995"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> #!/usr/bin/ruby<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> max_time = 300<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> ps_list = `ps h -eo cputime, pcpu, pid, user, cmd`<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> list = ps_list.split(/\n/)<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/> list.each do |p|<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>     process = p.split<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00007.jpg"/>     process[0] =~ /(\d+):(\d+):(\d+)/<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00008.jpg"/>     cpu_time = $1*3600 + $2*60 + $3<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00009.jpg"/>     next if cpu_time &lt; $max_time<br class="calibre20"/>&#13;
           next if process[3] == "root" or process[3] == "postfix"<br class="calibre20"/>&#13;
           next if process[4] == "kdeinit"<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
           begin<br class="calibre20"/>&#13;
               print "Would you like to kill: #{process[4]} (y/n)? "<br class="calibre20"/>&#13;
               if gets.downcase == "y"<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00011.jpg"/>               Process.kill :TERM,process[2]<br class="calibre20"/>&#13;
               end<br class="calibre20"/>&#13;
           rescue<br class="calibre20"/>&#13;
               puts "Couldn't kill the process...check permission."<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00012.jpg"/>            retry<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_177"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos313978"/>Running the Code</span></h2>
    </div>

    <p class="calibre4">The script is almost completely autonomous and only requires confirmation before <a class="calibre17" shape="rect"/>killing a process. To run it, type:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">./killProcess.rb</code></strong></tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_178"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos314696"/>The Results</span></h2>
    </div>

    <p class="calibre4">You will get a series of questions asking about the process identified as being an offender. The questions will look like these:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Would you like to kill: /usr/games/blackjack (y/n)? <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">y</code></em></code></strong><br class="calibre20"/>
      Killing /usr/bin/blackjack (7274)<br class="calibre20"/>
      .<br class="calibre20"/>
      .<br class="calibre20"/>
      .<br class="calibre20"/>
      Would you like to kill: /usr/bin/ruby (y/n)? <strong class="calibre22"><code class="calibre19"><em class="italic"><code class="calibre19">n</code></em></code></strong></tt></span>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_179"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos315727"/>How It Works</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">The beauty of this code lies in the way the script extracts <a class="calibre17" shape="rect"/>CPU time. If a process has been expending CPU cycles for more than a reasonable amount of time, then it's time to kill the process. Chances are the process is hung, blocking other <a class="calibre17" shape="rect"/>applications, and wasting precious system resources. You can change the time constraint to match the needs of your situation, but any time period will gain efficiency out of the processor by allowing the CPU to focus on meaningful data.</p>&#13;
&#13;
    <p class="calibre4">The maximum time allowed in this script is set in seconds. In the script, I arbitrarily choose 5 minutes, or 300 seconds <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. The data used in this script is retrieved from the system using Ruby's awesome <a class="calibre17" shape="rect"/>backticks <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. The <code class="calibre19">ps</code> command is executed with several arguments that will enable the script to target abusive <a class="calibre17" shape="rect"/>processes. The <code class="calibre19">h</code> flag removes the header from the <code class="calibre19">ps</code> output. Since we are dictating the fields used, we don't need to label the fields. Next, <code class="calibre19">-e</code> is used to show all processes on the system; <code class="calibre19">-A</code> could have also been used instead of <code class="calibre19">-e</code>. The second part of that flag is <code class="calibre19">o</code>, and that flag allows us to specify the output. The rest of the command shows which fields we are interested in retrieving: <code class="calibre19">cputime</code>, <code class="calibre19">pcpu</code>, <code class="calibre19">pid</code>, <code class="calibre19">user</code>, and <code class="calibre19">command</code>.<a class="calibre17" shape="rect"/></p>&#13;
&#13;
    <p class="calibre4">Now that the data is captured into the variable <code class="calibre19">ps_list</code> as a string, it must be broken down into manageable pieces of information. The highly effective <code class="calibre19">.split</code> command comes into play here, directed to split up the string by every new line <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. If you recall the <code class="calibre19">ps</code> output, <a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/>each process has its own line. After the <a class="calibre17" shape="rect"/>processes are broken down into their elements, we can begin examining these.<a class="calibre17" shape="rect"/></p>&#13;
&#13;
    <p class="calibre4">If you don't yet realize the power of <code class="calibre19">.each</code>, you will soon. The variable <code class="calibre19">list</code> contains an array of each process and its details. The <code class="calibre19">.each</code> instruction will go through each process no matter how many or how few there are <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>.</p>&#13;
&#13;
    <p class="calibre4">Even though we have split each process from the others, we need to drill down the specific process information further to isolate the fields <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. The default delimiter for <code class="calibre19">.split</code> is whitespace. A process string before the <code class="calibre19">.split</code> might look like:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><em class="italic"><code class="calibre19">"00:03:04    0.0    1    steve    /usr/bin/ruby"</code></em></tt></span>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">After the split it will be an array with five items:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><em class="italic"><code class="calibre19">["00:06:04", "0.0", "1", "steve", "/usr/bin/ruby"]</code></em></tt></span>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">How cool is that?</p>&#13;
&#13;
    <p class="calibre4">Hopefully, you see that the first field of each process will be what decides the process's fate. In this example, the process has been running for six minutes and four seconds. To get the data into a usable form, we need to convert the <a class="calibre17" shape="rect"/>time into seconds. I've used a regular expression and groupings based on the time format. The <code class="calibre19">=~</code> operator is another slick feature; it allows you to take a shortcut around the regular expression <code class="calibre19">match</code> method. I use regular expressions a lot for input validation—if you don't know them, they are well worth the time it takes to learn!<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>&#13;
&#13;
    <p class="calibre4">After the regular expression has evaluated the data, the evaluation will return each grouping, signified by parentheses, into <code class="calibre19">$1-$</code><em class="italic"><code class="calibre19">n</code></em> with <em class="italic"><code class="calibre19">n</code></em> being the number of groups <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00007.jpg"/></span>. The next step is to break each value down into seconds. We know there are 3,600 seconds in every hour and 60 seconds in every minute. So we multiply each grouping by its corresponding seconds and add them together <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00008.jpg"/></span>.</p>&#13;
&#13;
    <p class="calibre4">The evaluation is done using three <code class="calibre19">if</code> statements. An alternative would be to use a really long <code class="calibre19">if</code> statement, but I decided against it for the sake of keeping the code readable. For a process to be a target, it must meet three conditions. If any of those conditions are not satisfied, then we disregard the process. The three conditions are: the time being more than <code class="calibre19">$max_time</code> in seconds, the owner not being a protected user, and the process not being a system-critical one <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00009.jpg"/></span>. In the script, I threw in some examples like <code class="calibre19">root</code> and <code class="calibre19">kdeinit</code>. Play around in this area to customize for your purposes.</p>&#13;
&#13;
    <p class="calibre4">If you trust the script to do everything it said and no more, you can remove the confirmation statement. I'm not entirely trusting, so I prefer to know when I'm about to kill a process. If the user answers anything but a capitalized or lowercase y, the process will not be killed—again, I am using a regular expression. If the script is directed to kill the process, it will attempt to use <code class="calibre19">TERM</code> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00011.jpg"/></span>. Feel free to change to <code class="calibre19">SIGTERM</code> if you're feeling especially grumpy since it is a more <a class="calibre17" shape="rect"/>forceful kill. Every once in a while a process won't die, and the script will let you know. You can continue retrying <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00012.jpg"/></span>, or skip it by answering no to the confirmation line. Once the script has gone through each process, it exits.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>&#13;
  </div>&#13;
&#13;
  <div class="mbppagebreak" id="calibre_pb_180"/>&#13;


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos324388">
    <h1 class="calibre1" id="calibre_pb_181"><span class="calibre2"><a class="calibre7" shape="rect"/>Validating Symlinks</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_182"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos324882"/>Validating Symlinks</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>symlinkCheck.rb</h3>
      </div>

      <p class="calibre4"><span><em class="italic">Symlinks, or symbolic links</em></span>, are awesome for a lot of reasons: They simplify obnoxiously long path names; you can put them anywhere you like; you can call them whatever you want; and they are generally transparent to the user. While symlinks can do magical things, they really suck when they become <a class="calibre17" shape="rect"/>orphans (that is, no longer point to a valid target). So, in an effort to uphold the symlink reputation, I wrote this script to clean up after myself … and others. It's a housekeeping script.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_183"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos326187"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> #!/usr/bin/ruby<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> unless File.directory?(ARGV[0])<br class="calibre20"/>&#13;
           puts "Not a valid directory...\nCheck path and try again.\n\n"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> Dir.open(ARGV[0]) do |adir|<br class="calibre20"/>&#13;
           adir.each do |afile|<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/>            next unless FileTest.symlink?(afile)<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>            next if File.file?(afile)<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>            puts "Bad Link: #{File.expand_path(afile)}"<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_184"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos327433"/>Running the Code</span></h2>
    </div>

    <p class="calibre4">The script runs off a single directory input. If you have a directory where you keep symlinks, this script will scrub the list in a matter of seconds. Just type the following:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">./symlinkCheck.rb <em class="italic"><code class="calibre19">/directory/of/symlinks</code></em></code></strong></tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_185"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos328260"/>The Results</span></h2>
    </div>

    <p class="calibre4">The script will immediately output the path of each symlink identified as being orphaned—all other symlinks are skipped. The output will be similar to this:<a class="calibre17" shape="rect"/></p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Bad Link: <em class="italic"><code class="calibre19">/home/steve/Desktop/symlink.txt</code></em></tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_186"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos329029"/>How It Works</span></h2>
    </div>

    <p class="calibre4">User input drives the script's direction, so the first step is to collect the user input (the directory in which we are symlink hunting). If an invalid argument is supplied, the user is notified and the script exits <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. The directory is opened using the <code class="calibre19">Dir.open()</code> command <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. After the directory has been successfully opened, the process is iterated and each file analyzed.</p>

    <p class="calibre4">Two conditions must be met for a file to be considered an orphaned symlink. The first condition is checked by the <code class="calibre19">next unless</code> statement <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. This statement checks to see if the file is a symlink. If the file is not a symbolic link, then the script doesn't need to waste any more time analyzing it; <code class="calibre19">next</code> is called and the rest of the files are analyzed. If you're lucky and the file is a symlink, then the script will verify that the symlink actually links to something. This second check is based on the symlink pointing to a target: the method <code class="calibre19">File.file?</code> will be asking if the target is a file <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. If the target does not exist, the link is orphaned and must be reported to the user for further action <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. The output shows the entire path of the bad symlink for easy identification once the script has finished. All that is left is for the user to find the target for each bad link or delete the symlink.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_187"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos331470"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">While this script only looks at symbolic links of files, directories can also have symbolic links. You can change this script to look for invalid directories along with invalid file links. Give it a try and see how many unexpectedly invalid links exist on your machine!</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_188"/>
</body></html>