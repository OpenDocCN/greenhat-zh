<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;CITRIX XENSERVER: XEN FOR THE ENTERPRISE"><div class="titlepage"><div><div><h1 class="title"><a id="citrix_xenserver_xen_for_the_enterprise"/>Chapter 11. CITRIX XENSERVER: XEN FOR THE ENTERPRISE</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject11_d1e11924"/><img src="httpatomoreillycomsourcenostarchimages333191.png.jpg" alt="image with no caption"/></div></div><p>Until now, we've focused exclusively on the open source version of Xen. However, that's not the only choice available. The Xen guys have also released a packaged version of Xen that's aimed at turning Xen into a product that is suitable for the enterprise.<sup>[<a id="CHP-11-FNOTE-1" href="#ftn.CHP-11-FNOTE-1" class="footnote">60</a>]</sup></p><p>One implication that you may have gotten reading between the lines of this book is that Xen is still in a state of development. It is, in a word, hackerware. It's good 'ware—obviously we think it's stable enough for real people to use every day—but it's still a lot of work to set up and get going.</p><p>There are a couple of reasonable explanations for this state of affairs. Partly this is because hackers are not, as a group, very good at finishing things. The work to take a product from 90 percent finished to 100 percent finished isn't usually difficult, just tedious. Open source is wonderful, but it's not great at producing full-on commercial <span class="emphasis"><em>products</em></span>.<sup>[<a id="CHP-11-FNOTE-2" href="#ftn.CHP-11-FNOTE-2" class="footnote">61</a>]</sup> Another issue is that Xen, by nature, is invasive and fundamental. One hesitates to use words like <span class="emphasis"><em>paradigm</em></span>, but there you have it—virtualization is a different way of computing, a different way of thinking about computers, and it requires a lot of very polished software support.</p><p>Citrix (who acquired XenSource, the company founded by the original Xen team) works to ease the transition by providing this software—creating a software stack, developing a certification process, and establishing best practices so that administrators can roll out Xen with a minimum of fuss and uncertainty. They work on the open source version of Xen and contribute changes to it, but they also do an additional level of QA aimed at turning Xen into a product that you can feel comfortable trusting with your business.</p><p>You may ask how this is possible, considering that Xen is still under the GPL. Citrix can do this while obeying the terms of Xen's license because Xen's client/server architecture and modular design allow them to extend the basic <a id="idx-CHP-11-0810" class="indexterm"/>hypervisor, adding new features as modules and userspace processes that work in conjunction with the GPL software. Citrix uses the open source hypervisor with open source Linux, plus added modules and proprietary control software to provide an integrated distribution of Xen, much like a traditional Linux distro but with a strong emphasis on virtualization.</p><div class="sect1" title="Citrix's Xen Products"><div class="titlepage"><div><div><h1 class="title"><a id="citrixs_xen_products"/>Citrix's Xen Products</h1></div></div></div><p>The <a id="idx-CHP-11-0811" class="indexterm"/>Citrix product consists of two components, <a id="idx-CHP-11-0812" class="indexterm"/>XenServer and XenEssentials. XenServer is the hypervisor and basic management tools, and it is available for free.<sup>[<a id="CHP-11-FNOTE-3" href="#ftn.CHP-11-FNOTE-3" class="footnote">62</a>]</sup> XenEssentials is a suite of utilities that cost money.</p><p>The basic free product is simply called XenServer. XenServer supports most of the features of the paid Citrix products, with the same management interface. It's aimed at development, test, and noncritical production deployments, as well as people who want to test or play with Xen.</p><p>Citrix's pay product is called Citrix Essentials for XenServer, with various levels of licensing. It doesn't have all the features of open source Xen, but it has all the features Citrix feels comfortable supporting and some commercial product exclusives. Citrix, as far as we can tell, charges as much as the market will bear for this version.<sup>[<a id="CHP-11-FNOTE-4" href="#ftn.CHP-11-FNOTE-4" class="footnote">63</a>]</sup> This is, of course, subject to change at any time. Negotiate with your Citrix representative, preferably in some form of gladiatorial combat.<sup>[<a id="CHP-11-FNOTE-5" href="#ftn.CHP-11-FNOTE-5" class="footnote">64</a>]</sup></p><p>By and large, we're going to focus exclusively on the base product and components that are available for free.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-1" href="#CHP-11-FNOTE-1" class="para">60</a>] </sup>Sorry, we know, marketing speak. But it is the easiest way for us to convey the aim of the product.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-2" href="#CHP-11-FNOTE-2" class="para">61</a>] </sup>This is not to disparage the fine work <a id="idx-CHP-11-0809" class="indexterm"/>of the people behind polished products we use daily, such as Linux, Mozilla, and Vim. We're just saying that the last 10 percent is the most difficult, not that it never gets done.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-3" href="#CHP-11-FNOTE-3" class="para">62</a>] </sup>That's free as in beer, as the greybeards say.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-4" href="#CHP-11-FNOTE-4" class="para">63</a>] </sup>We were unable to find coherent pricing information.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-5" href="#CHP-11-FNOTE-5" class="para">64</a>] </sup>After spending weeks trying to get prices for colocation out of salespeople, Luke suspects gladiatorial combat would be more pleasant than the traditional methods for negotiating price. prgmr.com favors the "the price on the website is the price you pay" model.</p></div></div></div>
<div class="sect1" title="The Benefits of Using Citrix XenServer"><div class="titlepage"><div><div><h1 class="title"><a id="the_benefits_of_using_citrix_xenserver"/>The Benefits of Using Citrix XenServer</h1></div></div></div><p>The XenServer product improves on open source Xen primarily in the area <a id="idx-CHP-11-0813" class="indexterm"/>of manageability. They've streamlined and automated common tasks while retaining most of the transparency of open source Xen.</p><div class="sect2" title="Ten Minutes to Xen"><div class="titlepage"><div><div><h2 class="title"><a id="ten_minutes_to_xen"/>Ten Minutes to Xen</h2></div></div></div><div class="epigraph"><p>Our model is one where the CD enters the drive and the computer is a better machine as a result (in ten minutes or less). That is what XenExpress<sup>[<a id="CHP-11-FNOTE-6" href="#ftn.CHP-11-FNOTE-6" class="footnote">65</a>]</sup> is all about.</p><div class="attribution"><span>—<span class="attribution">
<span class="author"><span class="firstname">Frank</span> <span class="surname">Artale,</span></span>
<em class="citation">XenSource</em>
</span></span></div></div><p>One of the best demonstrations of this is in what Citrix calls <span class="emphasis"><em>Xen in ten minutes</em></span> or <span class="emphasis"><em>Ten to Xen</em></span>. They've dramatically simplified the bootstrap aspect of Xen, where you have to install a dom0 OS and modify it to work nicely with Xen's control software and the hypervisor.<a id="idx-CHP-11-0815" class="indexterm"/><a id="idx-CHP-11-0816" class="indexterm"/></p><p>Citrix reasons that you shouldn't actually be <span class="emphasis"><em>doing</em></span> anything with the dom0, other than controlling domUs. Therefore, the product installs a basic Linux OS that includes only the components needed to run Xen: a kernel, a shell, some libraries, a text editor, Python, syslog, SSH (and so forth), and the Xen software. In this approach, software that's not needed to control Xen, such as the daemons that provide a server's <span class="emphasis"><em>raison d'etre</em></span>, should be installed in a domU. Of course, it's still Linux—based on CentOS, in fact—and there's nothing to stop you from installing other software. However, we recommend sticking with Citrix's approach and keeping your core virtualization server uncluttered.</p><p>The basic package does, in fact, take about 10 minutes to install, as advertised. Be sure to get the supplementary Linux pack, which includes Debian templates and supporting tools for Linux VMs. When that's done, it's a simple matter to create domUs from the included Debian template or from install media.</p><p>Citrix XenServer has other <a id="idx-CHP-11-0817" class="indexterm"/>advantages. Perhaps most important, it feels much more centralized than the open source Xen. All of the decisions that we've been writing about—<a id="idx-CHP-11-0818" class="indexterm"/>storage, networking, and so forth—are handled in a centralized way, using a consistent interface. Where possible, they've made sensible default decisions for you. They're not necessarily going to be the best for all situations, but at least they'll be reasonable for Xen's purposes.</p><p>Take storage, for example. Citrix uses the same architecture as open source Xen, using unmodified Linux drivers in the dom0 to access physical devices. They layer LVM on top of this to abstract physical storage and increase flexibility, as we've outlined elsewhere. Citrix builds on these open source tools by offering a way of administering storage through the same GUI as the more Xen-specific aspects of the system, allowing you to focus on virtual machines rather than obscure disk-administration commands. If you like, you can still use the familiar commands. Citrix's Xen product isn't out to reinvent the wheel or obfuscate the basic workings <a id="idx-CHP-11-0819" class="indexterm"/>of the system; they've just provided an alternative to make common tasks a little easier.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-6" href="#CHP-11-FNOTE-6" class="para">65</a>] </sup>XenExpress was the name of the free product when XenSource was XenSource, before <a id="idx-CHP-11-0814" class="indexterm"/>Citrix bought them.</p></div></div></div>
<div class="sect1" title="The Disadvantages of Using Citrix XenServer"><div class="titlepage"><div><div><h1 class="title"><a id="the_disadvantages_of_using_citrix_xenser"/>The Disadvantages of Using Citrix XenServer</h1></div></div></div><p>Even with the high-end Essentials product, there's a trade-off between stability and features. Citrix exposes only those hypervisor features that they feel are mature enough to use in a production environment. For example, migration was added a couple of years after it had been introduced in the open source version.<a id="idx-CHP-11-0820" class="indexterm"/><a id="idx-CHP-11-0821" class="indexterm"/></p><p>There's also no easy way of moving VMs between open source and commercial Xen at the moment. (You can, of course, move VMs manually by using the lower-level methods outlined in <a class="xref" href="ch09.html" title="Chapter 9. XEN MIGRATION">Chapter 9</a>.) If you standardize on open source or commercial Xen, it may be difficult to reverse that decision later, although the <a id="idx-CHP-11-0822" class="indexterm"/>Open Virtualization Format (OVF), which has some support from open source tools,<sup>[<a id="CHP-11-FNOTE-7" href="#ftn.CHP-11-FNOTE-7" class="footnote">66</a>]</sup> promises to improve the situation.</p><p>Beyond that, open source is still an ideological issue. Some people use it whenever possible; some avoid it as a pestilence. We use the open source product because it's good enough for us and because apparently our time is worthless. Citrix offers a straightforward transaction: Give them money and they'll give you Xen as a product, rather than Xen as heavily customizable hackerware. Step on board and take your chances.</p><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-7" href="#CHP-11-FNOTE-7" class="para">66</a>] </sup><a id="idx-CHP-11-0823" class="indexterm"/><a class="ulink" href="http://open-ovf.wiki.sourceforge.net/">http://open-ovf.wiki.sourceforge.net/</a> is a good place to start.</p></div></div></div>
<div class="sect1" title="Getting Started"><div class="titlepage"><div><div><h1 class="title"><a id="getting_started-id001"/>Getting Started</h1></div></div></div><p>Having said all that, the best way to get started with Citrix's XenServer is probably just to try the product and see if you like it. The entry-level version is available for free. You can download it at <a class="ulink" href="http://www.citrix.com/xenserver/getitfree/">http://www.citrix.com/xenserver/getitfree/</a> and upgrade it at any time simply by entering a license key. Besides, they're telling the truth when they say it takes about 10 minutes to install, so why not?</p><div class="sect2" title="Prerequisites"><div class="titlepage"><div><div><h2 class="title"><a id="prerequisites"/>Prerequisites</h2></div></div></div><p>First, check to make sure that you meet the minimum system requirements:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>64-bit CPU, that is, AMD Opteron, Athlon 64, Phenom, or whatever else AMD's marketing department has come up with, or most Intel Xeons of the last few years, as well as the Core 2 (but not Core).</p></li><li class="listitem"><p>A certain amount of memory, depending on how many virtual machines you want. Citrix's minimum is 1GB, which sounds reasonable to us.</p></li><li class="listitem"><p>Sufficient disk space. The XenServer backend will take 8GB, leaving the rest available for domUs. Of course, you can also use network storage for VMs.</p></li><li class="listitem"><p>HVM support is required if you want to run Windows domUs, but otherwise it's optional.</p></li></ul></div></div><div class="sect2" title="Installing Citrix XenServer"><div class="titlepage"><div><div><h2 class="title"><a id="installing_citrix_xenserver"/>Installing Citrix XenServer</h2></div></div></div><p>As we've mentioned, Citrix's product is a complete system; install it like any other OS. For us, that meant downloading the ISO, burning it to a CD, and booting our target machine from the CD. We also grabbed the <span class="emphasis"><em>Linux Guest Support disc</em></span>, which includes support for Linux guests.<a id="idx-CHP-11-0824" class="indexterm"/><a id="idx-CHP-11-0825" class="indexterm"/></p><p>The machine goes through a nongraphical install and asks some standard questions about keyboard, time, and network setup—the usual. Compared to a normal Linux install, it's incredibly spare and streamlined because the product itself has the single focus of virtualization. For example, there's no opportunity to set up partitioning. At the end, it prompted us to insert supplementary CDs, so we put in the Linux support disc.</p><p>Ten minutes and one reboot later, we're staring at a screen that advises us to log in via the administration frontend, XenCenter.</p><div class="sidebar"><a id="using_a_serial_console_with_xenserver"/><p class="title">USING A SERIAL CONSOLE WITH XENSERVER</p><p>We would never consider <a id="idx-CHP-11-0826" class="indexterm"/>using a server without serial console access. Citrix's Xen product, although it doesn't support a serial console out of the box, can support a serial console with a little configuration.<a id="idx-CHP-11-0827" class="indexterm"/></p><p>It's a little more difficult than you'd expect because Citrix uses Extlinux to boot rather than GRUB. However, Extlinux's configuration is similar. The only file we need to adjust is <span class="emphasis"><em>/boot/extlinux.cfg</em></span>. Note that we specify the options to Xen and the Linux kernel on the same long line:</p><a id="I_programlisting11_d1e12179"/><pre class="programlisting">SERIAL 0 115200

default xe

prompt 1

timeout 50


label xe

  # XenServer

  kernel mboot.c32

  append /boot/xen.gz dom0_mem=752M lowmem_emergency_pool=16M \
    crashkernel=64M@32M com1=115200,8n1 console=com1 --- \
    /boot/vmlinuz-2.6-xen root=LABEL=root-jhawazvh ro \
    console=ttyS0,115200n8 --- /boot/initrd-2.6-xen.img</pre><p>Because this is basically CentOS, it already has ttyS0 listed in <span class="emphasis"><em>/etc/inittab</em></span> with a getty. Reboot and enjoy the serial console.</p></div></div></div>
<div class="sect1" title="Citrix's Xen GUI: XenCenter"><div class="titlepage"><div><div><h1 class="title"><a id="citrixs_xen_gui_xencenter"/>Citrix's Xen GUI: XenCenter</h1></div></div></div><p>We are, of course, fond of following advice.</p><p>Citrix's system, like the open source version of Xen, uses a client/server architecture to control the virtual machines. Unlike the open source version, they include a <a id="idx-CHP-11-0828" class="indexterm"/>graphical Xen console that can automate many of the boring details of running Xen.<sup>[<a id="CHP-11-FNOTE-8" href="#ftn.CHP-11-FNOTE-8" class="footnote">67</a>]</sup></p><p>In fact, the package includes both a GUI and a command-line utility. As of version 5, the GUI is a Windows application called XenCenter, and the command-line tool is called <code class="literal">xe</code>. They offer roughly the same functionality, but the XenCenter GUI has more features, and <code class="literal">xe</code> supports certain more arcane operations. Citrix suggests using <code class="literal">xe</code> for scripted (or otherwise automated) operation and the XenCenter for interactive administration. There's also a character-based menu system called <code class="literal">xsconsole</code> that normally runs on the Xen server's physical console, but which can be run in any shell session in dom0. It provides access to many common operations.</p><p>You'll need a Windows machine for the GUI client. Although version 3.2 and previous versions were written in Java, and are therefore cross-platform, versions 4.0 and above require the .NET-based XenCenter. Previous versions of the client will not be able to connect to the XenServer host. The requirement that the client runs under Windows, of course, also means that you can't run the client directly on the machine that's running Citrix's product.<sup>[<a id="CHP-11-FNOTE-9" href="#ftn.CHP-11-FNOTE-9" class="footnote">68</a>]</sup></p><p>Unlike the open source version of Xen, communication between the tools and hypervisor doesn't go through <code class="literal">xend</code>. Instead, both the command-line and graphical tools connect to the <code class="literal">xapi</code> service on the Xen server via TCP/IP, using SSL to encrypt traffic.</p><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-8" href="#CHP-11-FNOTE-8" class="para">67</a>] </sup>The <a id="idx-CHP-11-0829" class="indexterm"/>XenCenter cannot connect to open source Xen. We tried.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-9" href="#CHP-11-FNOTE-9" class="para">68</a>] </sup>Although you could run the client inside of a Windows install under the XenSource product, it does raise an interesting chicken-and-egg problem.</p></div></div></div>
<div class="sect1" title="Administering VMs with the XenCenter"><div class="titlepage"><div><div><h1 class="title"><a id="administering_vms_with_the_xencenter"/>Administering VMs with the XenCenter</h1></div></div></div><p>Having successfully installed both the Citrix server and the XenCenter client, we started our nice, shiny GUI frontend, told it about our XenServer, and logged in. The login process is straightforward and immediately drops you into a comprehensive two-panel interface, as shown in <a class="xref" href="ch11s06.html#xencenter_console" title="Figure 11-1. XenCenter console">Figure 11-1</a>.<a id="idx-CHP-11-0830" class="indexterm"/></p><p>The left panel displays hosts, both physical and virtual, in a tree view. On the right side, we can interact with the selected VM or change its parameters via the tabs at the top. Most tasks are broken out into a wizard-based interface.</p><p>These tasks are based on a concept of <span class="emphasis"><em>lifecycle management</em></span>; you can create VMs, edit them, and destroy them, all by clicking through a series of dialog boxes. The user interface aims to make these steps, especially creation, as easy as possible; after all, part of the attraction of virtual computing appliances is that it's easy to add more machines or scale back as necessary.</p><div class="figure"><a id="xencenter_console"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject11_d1e12256"/><img src="httpatomoreillycomsourcenostarchimages333233.png.jpg" alt="XenCenter console"/></div></div><p class="title">Figure 11-1. XenCenter console</p></div></div>
<div class="sect1" title="Installing DomU Images"><div class="titlepage"><div><div><h1 class="title"><a id="installing_domu_images"/>Installing DomU Images</h1></div></div></div><p>XenServer offers several install methods: First, you can install <a id="idx-CHP-11-0831" class="indexterm"/>from the included <a id="idx-CHP-11-0832" class="indexterm"/>Debian Etch template. Second, you can install a supported distro using a template and distro-specific installer. Third, there is the HVM install using emulated devices. Finally, we have physical-to-virtual conversion using the P2V tool.</p><p>The Debian install is the fastest and easiest, but it's the least flexible. Templated installation is a good option, allowing PV installs of a good variety of Linux distros, though not all of them. The HVM install works well for everything but requires a machine that supports HVM and results in a domain running in HVM mode (which may be suboptimal, depending on your application). P2V allows you to clone an existing hardware-based Linux installation and to create templates based on that existing system, but it is inconvenient and works with only a few older distros.</p><div class="sect2" title="Installing from the Debian Templates"><div class="titlepage"><div><div><h2 class="title"><a id="installing_from_the_debian_templates"/>Installing from the Debian Templates</h2></div></div></div><p>The easiest way to install a VM is to use the prepopulated Debian Etch template. This template is a preconfigured basic install, designed to make starting a Xen instance almost a one-click affair. (There is also a Debian Lenny template, but it is an installer, not a fully populated instance.)<a id="idx-CHP-11-0833" class="indexterm"/><a id="idx-CHP-11-0834" class="indexterm"/></p><p>To install from a template, log in to the Xen host using the graphical interface, select the XenServer from the list in the left panel of the screen (it should be the first entry), right-click it, and select <span class="strong"><strong>New VM</strong></span>. It will pop up a wizard interface that allows you to configure the machine. Select the <a id="idx-CHP-11-0835" class="indexterm"/>Debian Etch template. Answer the questions about RAM and disk space (the defaults should be fine), click <span class="strong"><strong>Finish</strong></span>, and it'll create a guest.</p><p>After the guest boots, it performs some first-boot configuration, then starts as a normal paravirtualized Xen instance, with the text console and <a id="idx-CHP-11-0836" class="indexterm"/>graphical console already set up and ready to work with, as shown in <a class="xref" href="ch11s07.html#the_graphical_console_of_a_freshly_insta" title="Figure 11-2. The graphical console of a freshly installed domU">Figure 11-2</a>.</p><div class="figure"><a id="the_graphical_console_of_a_freshly_insta"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject11_d1e12318"/><img src="httpatomoreillycomsourcenostarchimages333235.png.jpg" alt="The graphical console of a freshly installed domU"/></div></div><p class="title">Figure 11-2. The graphical console of a freshly installed domU</p></div></div><div class="sect2" title="Templated Linux VM"><div class="titlepage"><div><div><h2 class="title"><a id="templated_linux_vm"/>Templated Linux VM</h2></div></div></div><p>To ensure that the VM kernels are compatible with both Xen and the domU operating environment, the XenServer product <a id="idx-CHP-11-0837" class="indexterm"/>supports installation of only a few RPM-based distros and, of course, the already-mentioned Debian VM templates. This support is implemented through templates, which are essentially canned VM configurations.<a id="idx-CHP-11-0838" class="indexterm"/><a id="idx-CHP-11-0839" class="indexterm"/></p><p><a id="idx-CHP-11-0840" class="indexterm"/>Installing a supported distro is almost as easy as installing the <a id="idx-CHP-11-0841" class="indexterm"/>Debian templates. Go to the <span class="strong"><strong>Install</strong></span> dialog, select your distro and an install source (physical media, ISO, or network), enter a name, tweak the parameters if desired, and click <span class="strong"><strong>Install</strong></span>.</p><p>It's a bit harder to install an unsupported distro. However, the hardware emulation mode allows you to install any Linux distro by selecting the <span class="strong"><strong>Other Install Media</strong></span> template and booting <a id="idx-CHP-11-0842" class="indexterm"/>from the OS CD. From that point, proceed as with a normal install on hardware.</p><p>When you have the domain installed, you can configure it for paravirtualization and then convert it to a template.</p></div><div class="sect2" title="Windows Install"><div class="titlepage"><div><div><h2 class="title"><a id="windows_install"/>Windows Install</h2></div></div></div><p><a id="idx-CHP-11-0843" class="indexterm"/>Install <a id="idx-CHP-11-0844" class="indexterm"/>Windows by selecting the <span class="strong"><strong>XenServer</strong></span> server, selecting <span class="strong"><strong>Install VM</strong></span> from the context menu, and then filling in the resulting dialog. Select the template that corresponds to the version of Windows that you want to install, and change the CD-ROM/DVD setting so that it points to the install media.</p><p>Click <span class="strong"><strong>Install</strong></span>. Xen will create a new VM. When the machine comes up, it'll be in HVM mode, with the HVM BIOS configured to boot from the emulated CD-ROM. From that point, you can install Windows in the ordinary way. It's really quite a turnkey process; <a id="idx-CHP-11-0845" class="indexterm"/>Citrix has put a lot of work into making <a id="idx-CHP-11-0846" class="indexterm"/>Windows installation easy.</p></div><div class="sect2" title="Creating DomU Images with P2V"><div class="titlepage"><div><div><h2 class="title"><a id="creating_domu_images_with_p2v"/>Creating DomU Images with P2V</h2></div></div></div><p>The final way of installing is with the <a id="idx-CHP-11-0847" class="indexterm"/>P2V install tool, short for <span class="emphasis"><em>physical to virtual</em></span>. The tool creates domU images from physical Linux boxes, allowing you to install domUs on hardware that doesn't support HVM. Unfortunately, the P2V tool only supports a small number of Red Hat–like systems. Any other systems will cause it to quit with an error.<a id="idx-CHP-11-0848" class="indexterm"/><a id="idx-CHP-11-0849" class="indexterm"/></p><p>The tool comes as part of the XenServer install CD. To use it, boot the source machine from the XenServer CD. Interrupt the boot and enter <strong class="userinput"><code>p2v-legacy</code></strong> at the prompt if you're virtualizing a 32-bit system, or boot to the installer and select the <span class="strong"><strong>P2V</strong></span> option if you're virtualizing a 64-bit system. A series of prompts will guide you through network setup and selecting a destination.</p><p>Existing filesystems on the machine will be copied and sent to the remote Citrix Xen server, which automatically creates configuration files and uses an appropriate kernel. Note that the P2V tool will conflate partitions in the copy process. In this way it's similar to the tar(1) process that we describe in <a class="xref" href="ch03.html" title="Chapter 3. PROVISIONING DOMUS">Chapter 3</a>, with added autoconfiguration magic.</p></div><div class="sect2" title="Converting Pre-existing Virtual or Physical Machines with XenConvert"><div class="titlepage"><div><div><h2 class="title"><a id="converting_pre-existing_virtual_or_physi"/>Converting Pre-existing Virtual or Physical Machines with XenConvert</h2></div></div></div><p>If you have virtual machines in the VMware VMDK, Microsoft VHD, or cross-platform OVF formats, you can convert them to Xen virtual machines using Citrix's Windows-based <a id="idx-CHP-11-0850" class="indexterm"/>XenConvert utility. <a id="idx-CHP-11-0851" class="indexterm"/>XenConvert will also work on physical Windows machines, similarly to the P2V utility.<a id="idx-CHP-11-0852" class="indexterm"/><a id="idx-CHP-11-0853" class="indexterm"/></p><p>XenConvert is quite simple to use. First, download the <a id="idx-CHP-11-0854" class="indexterm"/>Windows installer from Citrix's site, at <a class="ulink" href="http://www.citrix.com/xenserver_xenconvert_free">http://www.citrix.com/xenserver_xenconvert_free</a>. Install the package, run the program, and follow the prompts.</p></div><div class="sect2" title="XenServer Tools in the DomU"><div class="titlepage"><div><div><h2 class="title"><a id="xenserver_tools_in_the_domu"/>XenServer Tools in the DomU</h2></div></div></div><p>When you have a domain installed, you will almost certainly want to install the XenServer tools, which improve integration between the domain and the management interface. In particular, the tools allow the XenCenter to collect performance data from the domU. Under Windows, the Citrix tools also include paravirtualized drivers, which bypass the (slow) emulated drivers in favor of Xen-style ring buffers and so forth.<a id="idx-CHP-11-0855" class="indexterm"/></p><p>To <a id="idx-CHP-11-0856" class="indexterm"/>install the tools, select the virtual machine in <a id="idx-CHP-11-0857" class="indexterm"/>XenCenter, right-click it, and choose the <span class="strong"><strong>Install XenServer Tools</strong></span><a id="idx-CHP-11-0858" class="indexterm"/> option from the context menu to switch the emulated CD. An alert box will pop up, advising you of the proper steps to perform.</p><p>Under Windows, the installer will autorun. Answer the prompts and let it go ahead with the install.<sup>[<a id="CHP-11-FNOTE-10" href="#ftn.CHP-11-FNOTE-10" class="footnote">69</a>]</sup> Reboot, selecting the <span class="strong"><strong>PV</strong></span> option at the bootloader. Windows will detect and configure your new PV devices.</p><p>With Linux VMs, as the prompt says, perform these commands:</p><a id="I_programlisting11_d1e12521"/><pre class="programlisting"># mount /dev/xvdd /mnt
# /mnt/Linux/install.sh</pre><p>The <span class="emphasis"><em>install.sh</em></span> script will select an appropriate package and install it. Reboot and enjoy the utilization graphs.</p></div><div class="sect2" title="xe: Citrix XenServer's Command-Line Tool"><div class="titlepage"><div><div><h2 class="title"><a id="xe_citrix_xenservers_command-line_tool"/>xe: Citrix XenServer's Command-Line Tool</h2></div></div></div><p>Citrix also ships a command-line interface alongside the graphical console. This command-line tool is called <code class="literal">xe</code>, and it's recommended for backups and similar automated tasks. In our opinion, it's definitely less pleasant than the XenCenter for everyday use. It's probably just our bias, but it also seems more cumbersome than the open source equivalent, <code class="literal">xm</code>.</p><p>You can use <code class="literal">xe</code> either from a separate management host (which can run either Windows or Linux) or in local mode directly on the XenServer host.<sup>[<a id="CHP-11-FNOTE-11" href="#ftn.CHP-11-FNOTE-11" class="footnote">70</a>]</sup></p><p>Citrix includes <code class="literal">xe</code> as an RPM on the Linux supplement CD in the <span class="emphasis"><em>client_install</em></span> directory. Make sure you have the required stunnel package. In our case, to install it on Slackware, we did:</p><a id="I_programlisting11_d1e12558"/><pre class="programlisting"># cd /media/XenServer-5.0.0 Linux Pack/client_install
# rpm -ivh --nodeps xe-cli-5.0.0-13192p.i386.rpm</pre><p>When the client is installed on a remote machine, you can run it. Make sure to specify <code class="literal">-s</code>, otherwise it'll assume that you want to connect to the local host and fail.</p><a id="I_programlisting11_d1e12565"/><pre class="programlisting"># xe help -s corioles.prgmr.com</pre><p>Whether you're using <code class="literal">xe</code> locally or remotely, the commands and parameters are the same. <code class="literal">xe</code> is actually a very thin wrapper around the Xen API. It exposes almost all the functionality offered by the API, with a corresponding difficulty of use. If you run it with the <code class="literal">help --all</code> command, it outputs a daunting usage message, detailing a huge variety of possible actions.</p><p>Fortunately, we can break these commands into groups. In general, there are commands to interact with the host and with virtual machines. There are commands to get logging information. There are pool commands. We have commands to administer virtual devices such as vifs and vbds.</p><p>Although some of the <code class="literal">xe</code> commands are similar to <code class="literal">xm</code> commands, the <code class="literal">xe</code> syntax is a bit more elaborate. The first argument must be a command name, followed by any switches, followed by any command parameters, in <code class="literal">name=value</code> syntax. It looks cumbersome, but Citrix has shipped a very nice bash completion setup to make autocomplete work well for the <code class="literal">xe</code>-specific parameters. It even fills in UUIDs. Thus:<a id="idx-CHP-11-0859" class="indexterm"/></p><a id="I_programlisting11_d1e12601"/><pre class="programlisting"># xm network-list 1
Idx BE     MAC Addr.     handle state evt-ch tx-/rx-ring-ref BE-path
0   0  00:16:3E:B9:B0:53    0     4      8     522  /523     /local/domain/0/backend/vif/1/0</pre><p>becomes, with <code class="literal">xe</code>:</p><a id="I_programlisting11_d1e12609"/><pre class="programlisting"># xe vm-vif-list vm-name=aufidius

name: eth0
         mac: 00:16:3E:B9:B0:53
          ip: 192.168.1.64
     vbridge: xenbr0
        rate: 0</pre><p>The documentation and the various recipes that are offered on Citrix's website have more advice on using <code class="literal">xe</code>.</p></div><div class="sect2" title="XenServer's Disk Management"><div class="titlepage"><div><div><h2 class="title"><a id="xenservers_disk_management"/>XenServer's Disk Management</h2></div></div></div><p>The XenServer software reserves a pair of 4GB partitions for itself, leaving the rest of the disk available for domUs. The first partition has the active XenServer install. The second partition is ordinarily left blank; however, if the server is upgraded, that partition is formatted and used as a complete backup of the previous install.<a id="idx-CHP-11-0860" class="indexterm"/></p><div class="warning" title="Warning"><h3 class="title"><a id="warning-3"/>Warning</h3><p><span class="emphasis"><em>Note that this backup only applies to the dom0 data; the installer will wipe domU storage repositories on the disk. The moral? Back up domUs manually before upgrading XenSource</em></span>.<a id="idx-CHP-11-0861" class="indexterm"/></p></div><p>The rest of the space is put into a volume group, or, as Citrix calls it, a <span class="emphasis"><em>storage repository</em></span>. As domUs are created, the server divides the space using LVM. The storage setup, for a single disk, can be seen in <a class="xref" href="ch11s07.html#xensource_disk_layout" title="Figure 11-3. XenSource disk layout">Figure 11-3</a>. Each additional disk becomes a single PV, which is added to the storage pool.</p><div class="figure"><a id="xensource_disk_layout"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject11_d1e12646"/><img src="httpatomoreillycomsourcenostarchimages333237.png.jpg" alt="XenSource disk layout"/></div></div><p class="title">Figure 11-3. XenSource disk layout</p></div><p>Each LV gets a very long name that uses a UUID (universally unique identifier) to associate it with a VM.<a id="idx-CHP-11-0862" class="indexterm"/></p></div><div class="sect2" title="Xen Storage Repositories"><div class="titlepage"><div><div><h2 class="title"><a id="xen_storage_repositories"/>Xen Storage Repositories</h2></div></div></div><p>If you log in to the XenServer on the console or via SSH using the root password that you entered during the install, you can use standard Linux commands to examine the installed environment. To continue our example, you can use the <a id="idx-CHP-11-0863" class="indexterm"/>LVM tools:<a id="idx-CHP-11-0864" class="indexterm"/></p><a id="I_programlisting11_d1e12671"/><pre class="programlisting"># vgs
  VG                                                 #PV #LV #SN Attr   VSize   VFree
  VG_XenStorage-03461f18-1189-e775-16f9-88d5b0db543f   1   0   0 wz--n- 458.10G 458.10G</pre><p>However, you'll usually want to use the Citrix-provided higher-level commands because those also update the storage metadata. Equivalently, to list <a id="idx-CHP-11-0865" class="indexterm"/>storage repositories using <code class="literal">xe</code>:</p><a id="I_programlisting11_d1e12684"/><pre class="programlisting"># xe sr-list
uuid ( RO)                : 03461f18-1189-e775-16f9-88d5b0db543f
          name-label ( RW): Local storage
    name-description ( RW):
                host ( RO): localhost.localdomain
                type ( RO): lvm
        content-type ( RO): user</pre><p>Note that the SR UUID matches the name of the volume group.</p><p>A complete description of <code class="literal">xe</code>'s capabilities with regard to storage is best left to Citrix's documentation. However, we'll describe a brief session to illustrate the relationship between LVM, Xen's storage pools, and the hypervisor.</p><p>Let's say that you've added a new SATA <a id="idx-CHP-11-0866" class="indexterm"/>disk to your XenServer, <span class="emphasis"><em>/dev/sdb</em></span>. To extend the default <a id="idx-CHP-11-0867" class="indexterm"/>XenServer storage pool to the new disk, you can treat the storage pool as a normal LVM volume group:</p><a id="I_programlisting11_d1e12708"/><pre class="programlisting"># pvcreate /dev/sdb1
  Physical volume "/dev/sdb1" successfully created
# vgextend VG_XenStorage-9c186713-1457-6edb-a6aa-cbabb48c1e88 /dev/sdb1
  Volume group "VG_XenStorage-9c186713-1457-6edb-a6aa-cbabb48c1e88" successfully extended
# vgs
  VG                                                 #PV #LV #SN Attr   VSize   VFree
  VG_XenStorage-9c186713-1457-6edb-a6aa-cbabb48c1e88   2   2   0 wz--n- 923.86G 919.36G
# service <a id="idx-CHP-11-0868" class="indexterm"/>xapi restart</pre><p>The only unusual thing that we've done here is to restart the <code class="literal">xapi</code> service so that the various administration tools can use the new storage.</p><p>However, Citrix recommends that you perform these operations through their management stack. If you want to do anything more complex, like create a new storage repository, it's better to use the appropriate <code class="literal">xe</code> commands rather than work with LVM directly. Here's an example of the same operation, using <code class="literal">xe</code>:</p><a id="I_programlisting11_d1e12728"/><pre class="programlisting"># xe sr-create name-label="Supplementary Xen Storage" type=lvm device-config-device=/dev/sdb1
a154498a-897c-3f85-a82f-325e612d551d</pre><p>That's all there is to it. Now the GUI should immediately show a new storage repository under the XenServer machine. We can confirm its status using <code class="literal">xe sr-list</code>:<a id="idx-CHP-11-0869" class="indexterm"/></p><a id="I_programlisting11_d1e12738"/><pre class="programlisting"># xe sr-list
uuid ( RO)                : 9c186713-1457-6edb-a6aa-cbabb48c1e88
          name-label ( RW): Local storage on corioles
    name-description ( RW):
                type ( RO): lvm
        content-type ( RO): user
uuid ( RO)                : a154498a-897c-3f85-a82f-325e612d551d
          name-label ( RW): Supplementary Xen Storage
    name-description ( RW):
                type ( RO): lvm
        content-type ( RO): disk</pre><p>Citrix's website has more information on adding storage with <code class="literal">xe</code>, including the options of using file-backed storage, iSCSI, or NFS. They also cover such topics as removing <a id="idx-CHP-11-0870" class="indexterm"/>storage repositories and setting QoS controls on VM storage. We defer to them for further details.</p></div><div class="sect2" title="Emulated CD-ROM Access"><div class="titlepage"><div><div><h2 class="title"><a id="emulated_cd-rom_access"/>Emulated CD-ROM Access</h2></div></div></div><p>One of the slickest things about Citrix's product is their <a id="idx-CHP-11-0871" class="indexterm"/>CD-ROM emulation.<sup>[<a id="CHP-11-FNOTE-12" href="#ftn.CHP-11-FNOTE-12" class="footnote">71</a>]</sup> In addition to giving VMs the option of mounting the physical drives attached to the machine, it presents ISO images as possible CDs. When you change the CD, the domU immediately registers that a new disc has been inserted.<a id="idx-CHP-11-0872" class="indexterm"/><a id="idx-CHP-11-0873" class="indexterm"/></p><p>XenServer looks for local ISO images in <span class="emphasis"><em>/opt/xensource/packages/iso</em></span>, and it looks for shared ISO images in <span class="emphasis"><em>/var/opt/xen/iso_import</em></span>. Both of these paths are on the server, not the admin host. Note that the XenServer host has a very limited root filesystem and devotes most of its disk space to virtual machines; thus, we recommend using shared NFS or CIFS storage for ISOs. However, local ISO storage is still possible. For example, to make a Windows 2003 ISO conveniently accessible to the XenServer VM installer, we can:</p><a id="I_programlisting11_d1e12780"/><pre class="programlisting"># dd if=/dev/cdrom of=/opt/xensource/packages/iso/win2003.iso</pre><p>Then restart the <code class="literal">xapi</code> service as before, and select the new ISO from the drop-down menu in XenCenter's graphical console tab. You can also use this ISO as an install source when creating virtual machines.</p></div><div class="sect2" title="XenServer VM Templates"><div class="titlepage"><div><div><h2 class="title"><a id="xenserver_vm_templates"/>XenServer VM Templates</h2></div></div></div><p>The <a id="idx-CHP-11-0874" class="indexterm"/>templates are one of the nicest features of XenCenter. They allow you to create a virtual machine with predefined specifications with a couple of clicks. Although Citrix includes some templates, you'll probably want to add your own.<a id="idx-CHP-11-0875" class="indexterm"/><a id="idx-CHP-11-0876" class="indexterm"/></p><p>The easiest way to create <a id="idx-CHP-11-0877" class="indexterm"/>VM templates is to create a VM with the desired setup and then convert it to a template using the XenSource management software. Right-click the machine in the GUI and select <span class="strong"><strong>Convert to Template</strong></span>. Conceptually, this is like the <span class="emphasis"><em>golden client</em></span> concept used by, say, SystemImager; you first tailor a client to meet your needs and then export it as the model for future installs.</p><a id="I_programlisting11_d1e12818"/><pre class="programlisting"># xe vm-param-set uuid=&lt;UUID OF VM BEING CONVERTED TO TEMPLATE&gt; is-a-template=true</pre><p>Another option is to use the P2V tool. To create a template from a physical machine, boot the machine from the XenServer CD as you would to create a VM, but direct the output of the P2V tool at an NFS share rather than a XenServer host. The template will show up in the XenCenter client's list of available templates.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-10" href="#CHP-11-FNOTE-10" class="para">69</a>] </sup>By the way, Citrix is, in fact, serious about the drivers not supporting pre-SP2 Windows XP. We tried.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-11" href="#CHP-11-FNOTE-11" class="para">70</a>] </sup>We are told that you can even use <code class="literal">xe</code> on Windows. Not that we would dirty our hands using an OS like Windows to administer a Linux/Xen server.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-12" href="#CHP-11-FNOTE-12" class="para">71</a>] </sup>After years of being too lazy to set up an automounter, we are easily impressed.</p></div></div></div>
<div class="sect1" title="XenServer Resource Pools"><div class="titlepage"><div><div><h1 class="title"><a id="xenserver_resource_pools"/>XenServer Resource Pools</h1></div></div></div><p>One of the most compelling features of Citrix's product is their integration of <a id="idx-CHP-11-0878" class="indexterm"/>resource pools. These pools are the manifestation of the utility computing model for Xen, in which a program is decoupled from a physical machine and run in a virtual machine on any member of a cluster of physical machines.<a id="idx-CHP-11-0879" class="indexterm"/></p><p>To create a resource pool, just select a XenServer virtualization host in the XenCenter client and create a pool from it.<sup>[<a id="CHP-11-FNOTE-13" href="#ftn.CHP-11-FNOTE-13" class="footnote">72</a>]</sup> When that's done, you can add more machines to the pool through the interface. (Up to 16 hosts are supported in a pool, although we've heard of people using more.) Furthermore, you can add storage to the pool, rather than to an individual machine, and create VMs that use shared storage. When you have domains based on shared storage, you can easily migrate them to other machines in the pool through the XenCenter GUI, as shown in <a class="xref" href="ch11s08.html#adding_nfs_storage_to_a_pool_through_xen" title="Figure 11-4. Adding NFS storage to a pool through XenCenter">Figure 11-4</a>.</p><p>As you can see, Citrix has made migration basically a point-and-click operation.</p><p>We're not going to discuss pool administration at length; we mention it here mostly to emphasize that the feature exists.</p><div class="figure"><a id="adding_nfs_storage_to_a_pool_through_xen"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject11_d1e12851"/><img src="httpatomoreillycomsourcenostarchimages333239.png.jpg" alt="Adding NFS storage to a pool through XenCenter"/></div></div><p class="title">Figure 11-4. Adding NFS storage to a pool through XenCenter</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-11-FNOTE-13" href="#CHP-11-FNOTE-13" class="para">72</a>] </sup>Some of the documentation claims that this feature is only available to paying customers, but we were able to manage fine. Consult Citrix for further clarification.</p></div></div></div>
<div class="sect1" title="Citrix XenServer: A Brief Review"><div class="titlepage"><div><div><h1 class="title"><a id="citrix_xenserver_a_brief_review"/>Citrix XenServer: A Brief Review</h1></div></div></div><p>Overall, we're quite pleased with Citrix's product. They have a polished tool that takes the drudgery out <a id="idx-CHP-11-0880" class="indexterm"/>of Xen administration, and they've made a stable product. In our opinion, it's considerably better than using any of the frontends that are available from the open source version, and it's at least as reliable.</p><p>Along with the XenCenter frontend (the most obvious difference), XenServer does well in ease of installation and manageability. The combination of templates and streamlined domU creation is particularly nice.</p><p>Another advantage of the XenServer product is its inclusion of paravirtualized drivers for Windows. Although GPL PV drivers are in development and available (see <a class="xref" href="ch13.html" title="Chapter 13. XEN AND WINDOWS">Chapter 13</a> for more information), they aren't as mature as the Citrix implementation. The drivers make a huge difference and aren't available with the open source product. They may be the single most compelling reason to run XenServer.</p><p>Finally, virtually all of the interesting features of open source Xen are supported. Storage and network options are pared down somewhat, but the available options should be enough for most purposes.</p><p>It isn't all roses, however. The biggest problem that we ran into while testing it was its narrow support for obscure platforms, or even less-popular Linux distros like Gentoo or Slackware. Although it's possible to get other distros running, it's inconvenient, and convenience is one of XenServer's key selling points. Another annoyance is the need for a Windows machine to administer the Xen server—previous versions used a cross-platform Java client. However, because the frontend is apparently written in C#, perhaps we'll see a Mono port at some point.</p><p>Can Citrix's product replace the open source Xen? As always, the answer is maybe. It offers significant improvements in management and some interesting new capabilities, but that's balanced against the substantial cost and annoying limitations. We're sticking with the free version, but, then, our time is worthless.</p></div></body></html>