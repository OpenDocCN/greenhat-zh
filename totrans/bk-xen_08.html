<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;BEYOND LINUX: USING XEN WITH OTHER UNIX-LIKE OSS"><div class="titlepage"><div><div><h1 class="title"><a id="beyond_linux_using_xen_with_other_unix_l"/>Chapter 8. BEYOND LINUX: USING XEN WITH OTHER UNIX-LIKE OSS</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject8_d1e8789"/><img src="httpatomoreillycomsourcenostarchimages333191.png.jpg" alt="image with no caption"/></div></div><p>One major <a id="idx-CHP-8-0605" class="indexterm"/>benefit of paravirtualization which we've thus far ignored is the ability to run multiple operating systems on a single paravirtualized physical machine. Although Linux is the most popular OS to run under Xen, it's not the only option available. Several other Unix-like OSs can run as a dom0, and rather more have been modified to run as paravirtualized domUs.</p><p>Apart from Linux, only Solaris and NetBSD are capable of functioning as a dom0 with current versions of Xen. Some work has been done with the other BSDs and with Plan9, but these OSs either can only work as a domU or can only work with older Xen versions. Support is evolving rapidly, however. (FreeBSD seems especially close to having functional Xen bits.)</p><p>In this chapter, we'll focus on Solaris and NetBSD. Partially this is because they have mature Xen support, with active community involvement and ongoing development. Most importantly, though, it's because we have run them in production. In a later chapter, we'll discuss Windows.</p><div class="sect1" title="Solaris"><div class="titlepage"><div><div><h1 class="title"><a id="solaris"/>Solaris</h1></div></div></div><p>Sun has been pushing Xen virtualization heavily in recent community releases of OpenSolaris, and their effort shows. Solaris works well as both a dom0 and a domU, with closely integrated Xen support. The only caveat is that, as of this writing, OpenSolaris does not support Xen 3.3 and paravirt_ops domUs.</p><div class="note" title="Note"><h3 class="title"><a id="note-32"/>Note</h3><p><span class="emphasis"><em>Sun doesn't actually call their shipping version of Xen</em></span> Xen. <span class="emphasis"><em>They use the term</em></span> xVM <span class="emphasis"><em>for marketing purposes, and include the unrelated VirtualBox under the xVM label. We're going to continue to call it Xen, however, because it's the name we're used to</em></span>.</p></div><p>Only the x86 version of Solaris supports Xen—Solaris/SPARC uses alternate virtualization technologies.</p><div class="sidebar"><a id="virtualization_with_solaris"/><p class="title">VIRTUALIZATION WITH SOLARIS</p><p>Sun, being traditionally a "medium iron" company, has emphasized virtualization for a long time, with a few different, complementary technologies to implement virtualization at different levels. Here's an <a id="idx-CHP-8-0606" class="indexterm"/>overview of their non-Xen virtualization offerings.<a id="idx-CHP-8-0607" class="indexterm"/></p><p>On new <a id="idx-CHP-8-0608" class="indexterm"/>UltraSparc Niagara-based systems, pure hardware virtualization is provided by means of Logical Domains, or <a id="idx-CHP-8-0609" class="indexterm"/>LDoms. These are a successor to the <span class="emphasis"><em>Dynamic System Domains</em></span> found on earlier Sun Enterprise platforms, which allowed you to devote CPU and memory boards to independent OS instances. Similarly, on a reasonably new SPARC box, you can partition the CPU and memory to run multiple, independent operating systems, using the processor's hardware virtualization support.</p><p>On x86, Sun addresses full virtualization by way of their VirtualBox product. VirtualBox executes guest code directly where possible and emulates when necessary, much like VMware.</p><p>Finally, Sun addresses OS-level virtualization through Solaris <a id="idx-CHP-8-0610" class="indexterm"/>Zones,<sup>[<a id="CHP-8-FNOTE-1" href="#ftn.CHP-8-FNOTE-1" class="footnote">45</a>]</sup> which are themselves an interesting, lightweight virtualization option. Like other OS-level virtualization platforms, Zones provide a fair amount of separation between operating environments with very little overhead.</p><p>Sun even offers the option to run <a id="idx-CHP-8-0611" class="indexterm"/>Linux binaries under Solaris on x86_64, via <span class="emphasis"><em>lx</em></span> branded Zones. (These <span class="emphasis"><em>lx</em></span> branded Zones provide a thin compatibility layer between the Solaris kernel and Linux userspace. Pretty cool.) However, the Linux emulation isn't perfect. For example, since <span class="emphasis"><em>lx</em></span> branded Zones use the same Solaris kernel that's <a id="idx-CHP-8-0612" class="indexterm"/>running on the actual hardware, you can't load Linux device drivers.</p></div><div class="sect2" title="Getting Started with Solaris"><div class="titlepage"><div><div><h2 class="title"><a id="getting_started_with_solaris"/>Getting Started with Solaris</h2></div></div></div><p>To run Solaris under Xen, you'll need to get a copy of Solaris. There are several versions, so make sure that you pick the right one.<a id="idx-CHP-8-0613" class="indexterm"/></p><p>You do not want Solaris 10, which is the current Sun version of Solaris. Although it's a fine OS, it doesn't have Xen support because its development lags substantially behind the bleeding edge. (In this it caters to its market segment. We are personally acquainted with people who are <a id="idx-CHP-8-0614" class="indexterm"/>running Solaris 8—a welcome contrast to the prevailing Linux view that software more than six months old is some sort of historical curiosity.)</p><p>Fortunately, Solaris 10 isn't the only option. <a id="idx-CHP-8-0615" class="indexterm"/>Solaris Express acts as a preview of the next official Solaris version, and it's a perfectly capable OS for Xen in its own right. It incorporates Xen, but is still a bit behind the latest development. It's also not as popular as <a id="idx-CHP-8-0616" class="indexterm"/>OpenSolaris.</p><p>Finally, there's OpenSolaris. Sun released huge tracts of Solaris source code a while ago under the Common Development and Distribution License<sup>[<a id="CHP-8-FNOTE-2" href="#ftn.CHP-8-FNOTE-2" class="footnote">46</a>]</sup> (CDDL), and the community's been pounding on it ever since. OpenSolaris is the result—it's much like Sun's release of Solaris but with new technology and a much faster release cycle. Think of the relationship between the two as like Red Hat Enterprise Linux and Fedora, only more so.</p><p>Both Solaris Express and OpenSolaris incorporate Xen support. Solaris Express has the Xen packages included on the DVD, while OpenSolaris requires you to download Xen as an add-on. Both of them provide a fairly polished experience. Although there are other distros based on the released Solaris code, none of them are particularly Xen-oriented, so the officially blessed distros are probably the best place to start.</p><div class="sidebar"><a id="running_solaris_express"/><p class="title">RUNNING SOLARIS EXPRESS</p><p>We had some trouble deciding whether to focus on OpenSolaris or Solaris Express while we were writing this chapter. We decided to go with OpenSolaris because it seemed more popular, based on a completely unscientific poll of our friends.</p><p>However, Solaris Express is still a perfectly fine OS with excellent Xen support, so we've also included some notes on setting it up.</p><p>Believe it or not, Xen support should exist pretty much out of the box.<sup>[<a id="CHP-8-FNOTE-3" href="#ftn.CHP-8-FNOTE-3" class="footnote">47</a>]</sup> When you install Solaris Express on a system that supports Xen, it installs a Xen kernel and gives you the option to boot it from GRUB—just select <span class="strong"><strong>Solaris xVM</strong></span> and off you go. (The included Xen version is 3.1.4 as of snv_107.)</p><p>From there, you can install domUs normally. It's even got <code class="literal">virt-manager</code>. Take a look at the next section for more details on setting up domUs. Most of these steps will apply to Solaris Express and OpenSolaris equally well.</p></div><p>In general, there are three possible <a id="idx-CHP-8-0617" class="indexterm"/>configurations of (Open)Solaris that are of interest in our discussion of Xen.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>First, we have the Solaris dom0.</p></li><li class="listitem"><p>Second, there's the Solaris domU on a Solaris dom0. This is a fairly straightforward setup.</p></li><li class="listitem"><p>Finally, you can run a Solaris domU under Linux with a minimum<sup>[<a id="CHP-8-FNOTE-4" href="#ftn.CHP-8-FNOTE-4" class="footnote">48</a>]</sup> of fuss.</p></li></ul></div></div><div class="sect2" title="Solaris Dom0"><div class="titlepage"><div><div><h2 class="title"><a id="solaris_dom0"/>Solaris Dom0</h2></div></div></div><p>Let's start by <a id="idx-CHP-8-0618" class="indexterm"/>setting up an OpenSolaris dom0, since you'll need one for the next section. (Although we suppose this applies only if you're doing something crazy like <a id="idx-CHP-8-0619" class="indexterm"/>running through all our examples in order.)<a id="idx-CHP-8-0620" class="indexterm"/></p><p>Note that we're going to be using <code class="literal">pfexec</code>, the Solaris equivalent of <code class="literal">sudo</code>,<sup>[<a id="CHP-8-FNOTE-5" href="#ftn.CHP-8-FNOTE-5" class="footnote">49</a>]</sup> for these examples, so it's not necessary to be root for these steps.</p><p>First, download the distribution from <a class="ulink" href="http://opensolaris.org/os/downloads/">http://opensolaris.org/os/downloads/</a>. Follow the directions to unpack and burn it, and boot from the CD, just like virtually any other OS install.</p><p>The OpenSolaris LiveCD will probably be a familiar experience to anyone who's installed Ubuntu. It 's really quite similar, with a standard GNOME desktop, some productivity software, and a cute <span class="emphasis"><em>Install OpenSolaris</em></span> icon on the desktop. Double-click the <span class="strong"><strong>Install OpenSolaris</strong></span> icon to launch the installer, then follow its directions.</p><p>When the installer finishes, it'll prompt you to reboot.</p></div><div class="sect2" title="Setting Up Xen"><div class="titlepage"><div><div><h2 class="title"><a id="setting_up_xen"/>Setting Up Xen</h2></div></div></div><p>If, once you reboot, you notice that you don't have Xen available, don't panic. OpenSolaris, unlike Solaris Express, doesn't include the Xen packages in the initial install. (Everything had to fit on a CD, after all.) You will have to install and set them up manually.<a id="idx-CHP-8-0621" class="indexterm"/></p><p>First, we create a <a id="idx-CHP-8-0622" class="indexterm"/>ZFS boot environment. (If you're not familiar with boot environments, substitute the word <span class="emphasis"><em>snapshot</em></span>. The idea is, if you break your system trying to install Xen, you can reboot into the original environment and try again.)</p><a id="I_programlisting8_d1e9046"/><pre class="programlisting">$ pfexec beadm create -a -d xvm xvm
$ pfexec beadm mount xvm /tmp/xvm</pre><p>Next, we use the OpenSolaris <code class="literal">pkg</code> command to install the Xen packages in the new boot environment.<a id="idx-CHP-8-0623" class="indexterm"/><a id="I_indexterm8_d1e9056" class="indexterm"/></p><a id="I_programlisting8_d1e9061"/><pre class="programlisting">$ pfexec pkg -R /tmp/xvm install xvm-gui</pre><p>As of OpenSolaris 2008.11, the xvm-gui package cluster provides all the necessary Xen packages. Previous versions may require you to install the packages individually. If you need to do that, you should be able to get away with running:</p><a id="I_programlisting8_d1e9065"/><pre class="programlisting"># <a id="idx-CHP-8-0624" class="indexterm"/>pkg install SUNWxvmhvm
# pkg install SUNWvirtinst
# pkg install SUNWlibvirt
# pkg install SUNWurlgrabber</pre><p>These packages provide Xen (with HVM), <code class="literal">virt-install</code>, and <code class="literal">virt-install</code> 's dependencies.</p><p>Next, we need to update GRUB to boot the Xen kernel properly.</p><p>Under OpenSolaris, <a id="idx-CHP-8-0625" class="indexterm"/><em class="filename">menu.lst</em> is at <span class="emphasis"><em>/rpool/boot/grub/menu.lst</em></span>. Edit the xvm menu item to look something like the following:</p><a id="I_programlisting8_d1e9095"/><pre class="programlisting">title xvm
findroot (pool_rpool,0,a)
bootfs rpool/ROOT/xvm
kernel$ /boot/$ISADIR/xen.gz<a id="idx-CHP-8-0626" class="indexterm"/>
module$ /platform/i86xpv/kernel/$ISADIR/unix /platform/i86xpv/kernel/$ISADIR/
unix -B $ZFS-BOOTFS,console=text
module$ /platform/i86pc/$ISADIR/boot_archive</pre><p>Note that we're using extensions to GRUB that enable variables in <em class="filename">menu.lst</em>, such as <code class="literal">$ISADIR</code> (for Instruction Set Architecture). Apart from that, it's a fairly normal Xen GRUB config, with the hypervisor, kernel, and ramdisk.</p><p>Reboot.</p></div><div class="sect2" title="Solaris SMF"><div class="titlepage"><div><div><h2 class="title"><a id="solaris_smf"/>Solaris SMF</h2></div></div></div><p>When you begin to configure a Solaris dom0, you'll probably notice immediately that some files aren't quite where you expect. For one thing, Solaris doesn't have an <span class="emphasis"><em>/etc/xen</em></span> directory, nor does it have the customary scripts in <span class="emphasis"><em>/etc/init.d</em></span>. The various <a id="idx-CHP-8-0627" class="indexterm"/>support scripts in <span class="emphasis"><em>/etc/xen/scripts</em></span> instead live in <span class="emphasis"><em>/usr/lib/xen/scripts</em></span>. You can keep <a id="idx-CHP-8-0628" class="indexterm"/>domain configurations wherever you like. (We actually make an <span class="emphasis"><em>/etc/xen</em></span> directory and put domain configurations in it.)<a id="idx-CHP-8-0629" class="indexterm"/></p><p>Instead of relying on the standard Xen config files, Solaris handles configuration and service startup via its own management framework, SMF (<a id="idx-CHP-8-0630" class="indexterm"/>Service Management Facility). You can examine and change <code class="literal">xend</code> 's <a id="idx-CHP-8-0631" class="indexterm"/>settings using the <code class="literal">svccfg</code> command:</p><a id="I_programlisting8_d1e9167"/><pre class="programlisting"># svccfg -s xend listprop</pre><p>This will output a list of properties for the <code class="literal">xend</code> service. For example, to enable migration:</p><a id="I_programlisting8_d1e9174"/><pre class="programlisting"># svccfg -s xend setprop config/xend-relocation-address = \"\"
# svcadm refresh xend
# svcadm restart xend</pre><p>You may have to enable the Xen-related <a id="idx-CHP-8-0632" class="indexterm"/>services manually using <code class="literal">svcadm</code>, particularly if you initially booted the non-Xen kernel. To look at which services are stopped, use <code class="literal">svcs</code>:</p><a id="I_programlisting8_d1e9188"/><pre class="programlisting"># svcs -xv</pre><p>If the Xen services are stopped for maintenance or disabled, you can enable them using <code class="literal">svcadm</code>:</p><a id="I_programlisting8_d1e9195"/><pre class="programlisting"># svcadm enable store
# svcadm enable xend
# svcadm enable virtd
# svcadm enable domains
# svcadm enable console</pre><p>From that point, you should be able to use Solaris as a perfectly normal dom0 OS. It's even got libvirt. Have fun.</p></div><div class="sect2" title="Creating a Solaris DomU"><div class="titlepage"><div><div><h2 class="title"><a id="creating_a_solaris_domu"/>Creating a Solaris DomU</h2></div></div></div><p>You didn't really think it would be that easy, did you? There are a couple of small caveats to note—things that make Xen under Solaris a slightly different animal than from under Linux. We'll start by <a id="idx-CHP-8-0633" class="indexterm"/>creating a Solaris domU on a Solaris dom0, then extend our discussion to a Solaris domU on a Linux dom0.<a id="idx-CHP-8-0634" class="indexterm"/><a id="idx-CHP-8-0635" class="indexterm"/></p><div class="sect3" title="ZFS Backing Devices"><div class="titlepage"><div><div><h3 class="title"><a id="zfs_backing_devices"/>ZFS Backing Devices</h3></div></div></div><p>First, we suggest handling virtual block devices a bit differently under Solaris. Although you can create domU filesystems as plain loopback-mounted files, ZFS is probably a better option. It's been praised far and wide, even winning some grudging accolades from Linus Torvalds. It is, in fact, ideal for this sort of thing, and the generally accepted way to manage disks under Solaris—even more so now that OpenSolaris uses a ZFS root filesystem.<a id="idx-CHP-8-0636" class="indexterm"/></p><p>ZFS is pretty simple, at least to get started with. Users of LVM should find that creating a pool and filesystem are familiar tasks, even though the commands are slightly different. Here we'll make a pool, create a ZFS filesystem within the pool, and set the size of the filesystem:</p><a id="I_programlisting8_d1e9232"/><pre class="programlisting"># zpool create guests c0d0
# zfs create guests/escalus
# zfs set quota=4g guests/escalus</pre><p>Now we can define a domain that uses the <code class="literal">phy:</code> device <span class="emphasis"><em>/dev/zvol/dsk/guests/escalus</em></span> for its backing store, as shown in the config file.</p><p>We'll leave further subtleties of ZFS administration to Sun's documentation.</p></div><div class="sect3" title="Installing a DomU via PyGRUB"><div class="titlepage"><div><div><h3 class="title"><a id="installing_a_domu_via_pygrub"/>Installing a DomU via PyGRUB</h3></div></div></div><p>The last thing to do before <a id="idx-CHP-8-0637" class="indexterm"/>creating the <a id="idx-CHP-8-0638" class="indexterm"/>domU is to write an appropriate config file. Here's ours:</p><a id="I_programlisting8_d1e9261"/><pre class="programlisting"># cat /etc/xen/escalus
name = "escalus"
memory = 512
disk = [
     'file:/opt/xen/install-iso/os200805.iso,6:cdrom,r',
     'phy:/dev/zvol/dsk/guests/escalus,0,w'
]
vif = ['']
bootloader = 'pygrub'
kernel = '/platform/i86xpv/kernel/unix'
ramdisk = 'boot/x86.microroot'
extra = /platform/i86xpv/kernel/unix -B console=ttya,livemode=text
on_shutdown = 'destroy'
on_reboot = 'destroy'
on_crash = 'destroy'</pre><p>Note that the disk specifier works differently than with Linux domUs. Rather than using symbolic device names, as under Linux:</p><a id="I_programlisting8_d1e9265"/><pre class="programlisting">disk = ['file:/export/home/xen/solaris.img,sda1,w']
root = "/dev/sda1"</pre><p>we instead specify the disk number:</p><a id="I_programlisting8_d1e9269"/><pre class="programlisting">disk = ['phy:/dev/zvol/dsk/guests/ecalus,0,w']
root = "/dev/dsk/c0d0s0"</pre><p>Here we're <a id="idx-CHP-8-0639" class="indexterm"/>installing Solaris from an ISO image (<em class="filename">os200805.iso</em>) using PyGRUB to pull the correct kernel and initrd off the CD image, boot that, and proceed with a normal install.</p><div class="note" title="Note"><h3 class="title"><a id="note-33"/>Note</h3><p><span class="emphasis"><em>One thing to watch out for is that domU networking will only work if you're using a GLD3-based network driver. The drivers that ship with Solaris are all fine in this regard—however, you may have trouble with third-party drivers</em></span>.</p></div><p>Once the install's done, we shut the machine down and remove the disk entry for the CD.</p><p>At this point your Solaris domU should be ready to go. Setting up a Linux domU is equally straightforward, since standard Linux domU images and kernels should work unmodified under Solaris.</p><p>Next, we'll look at setting up a Solaris domU under Linux.</p></div></div><div class="sect2" title="Creating a Solaris DomU Under Linux"><div class="titlepage"><div><div><h2 class="title"><a id="creating_a_solaris_domu_under_linux"/>Creating a Solaris DomU Under Linux</h2></div></div></div><p><a id="idx-CHP-8-0640" class="indexterm"/>For the most part, a domU is independent of the dom0 OS, and thus the install under Linux uses much the same installation procedure as under <a id="idx-CHP-8-0641" class="indexterm"/>Solaris. There are only a few pitfalls for the unwary.</p><p>First, you might have a bit more work to do to ensure that the domain can find an appropriate kernel. The Solaris image will complain bitterly, and in fact will not boot, with a Linux kernel.</p><p>If you're using PyGRUB on a Xen 3.1 or later system, you shouldn't need to do anything special. PyGRUB itself will load the appropriate files from OpenSolaris installation media without further intervention, just as in the previous example.</p><p>If you're not using PyGRUB, or if you're using the stock RHEL5.1 hypervisor, you'll need to extract the kernel and miniroot (initrd, for Linux people) from the OpenSolaris install package and place them somewhere that Xen can load them.</p><a id="I_programlisting8_d1e9316"/><pre class="programlisting"># mount -o loop,ro osol200811.iso
# cp /mnt/cdrom/boot/platform/i86pv/kernel/unix /xen/kernels/solaris/
# cp /mnt/cdrom/x86.miniroot /xen/kernels/solaris/
# umount /mnt/cdrom</pre><p>Just as under Solaris, begin by writing a config file. We'll set up this config file to load the installer from the CD, and later alter it to boot our newly installed domU. Note that we're grabbing the kernel from the ISO, using the kernel and ramdisk options to specify the files we need.</p><a id="I_programlisting8_d1e9320"/><pre class="programlisting">bootloader = '/usr/bin/pygrub'
kernel = "/platform/i86xpv/kernel/amd64/unix"
ramdisk = "/boot/x86.microroot"
extra = "/platform/i86xpv/kernel/amd64/unix -- nowin -B install_media=cdrom"

cpu_weight=1024
memory = 1024
name = "rosaline"
vif = ['vifname=rosaline,ip=192.0.2.136,bridge=xenbr0,mac=00:16:3e:59:A7:88' ]
disk = [
        'file:/opt/distros/osol-0811.iso,xvdf:cdrom,r',
        'phy:/dev/verona/rosaline,xvda,w'
]</pre><p>Make sure to create your backing store (<span class="emphasis"><em>/dev/verona/rosaline</em></span> in this case).</p><p>Now create the domain. Next step, installation.</p><p>Although OpenSolaris has a perfectly functional console when running as a domU, it unfortunately does not include a text mode installer. It does, however, include a VNC server and SSH server, either of which can be used to get a remote graphical display. Here's how to set up VNC.</p><p>Log in at the domU console with username <span class="emphasis"><em>jack</em></span> and password <span class="emphasis"><em>jack</em></span>.</p><p>Once you're in locally, set up your network. (If you're using DHCP, it'll probably already be set up <a id="idx-CHP-8-0642" class="indexterm"/>for you, but it doesn't hurt to make sure.)</p><a id="I_programlisting8_d1e9348"/><pre class="programlisting"># pfexec ifconfig xnf0
xnf0: flags=201000843&lt;UP,BROADCAST,RUNNING,MULTICAST,IPv4,CoS&gt; mtu 1500 index 2
        inet 192.0.2.128 netmask ffffff00 broadcast 192.0.2.255
        ether aa:0:0:59:a7:88</pre><p>You can see that our network is in fine shape, with the address 192.168.2.128. If it's not set up already, assign an address manually:</p><a id="I_programlisting8_d1e9352"/><pre class="programlisting">pfexec ifconfig xnf0 192.0.2.128/24</pre><p>The VNC server should already be running. To enable remote access to it, run the <code class="literal">vncpasswd</code> <a id="idx-CHP-8-0643" class="indexterm"/>command:</p><a id="I_programlisting8_d1e9365"/><pre class="programlisting">pfexec vncpasswd /etc/X11/.vncpasswd</pre><p><code class="literal">vncpasswd</code> will ask you to make up a password and enter it twice. Use this password to connect to the VNC server using your favorite VNC client. You should be greeted with an <a id="idx-CHP-8-0644" class="indexterm"/>OpenSolaris desktop.</p><p>Finally, click the <span class="strong"><strong>Install OpenSolaris</strong></span> icon on the desktop and proceed with the graphical install.</p></div><div class="sect2" title="OpenSolaris DomU Postinstall Configuration"><div class="titlepage"><div><div><h2 class="title"><a id="opensolaris_domu_postinstall_configurati"/>OpenSolaris DomU Postinstall Configuration</h2></div></div></div><p>Once the installer has done its work, you'll be ready to shut down the domain and move to the next step: setting up the dom0 to load a kernel <a id="idx-CHP-8-0645" class="indexterm"/>from a ZFS filesystem.<a id="idx-CHP-8-0646" class="indexterm"/></p><p>The problem is that in Xen 3.3, PyGRUB's version of <code class="literal">libfsimage</code> isn't able to handle recent versions of ZFS directly. Our solution was to download the <a id="idx-CHP-8-0647" class="indexterm"/>Xen-unstable source tree (as of this writing, Xen 3.4-rc) from <a class="ulink" href="http://xenbits.xen.org/">http://xenbits.xen.org/</a> and build PyGRUB from that. (Alternatively, you can mount the install media, extract the kernel and microroot, specify these manually in the config file, and pass the correct "extra" line to the kernel—that works just as well.)<a id="idx-CHP-8-0648" class="indexterm"/></p><a id="I_programlisting8_d1e9415"/><pre class="programlisting"># hg clone http://xenbits.xen.org/xen-unstable.hg
# cd xen-unstable
# make tools
# cd xen-unstable.hg/tools/pygrub; make install
# cd xen-unstable.hg/tools/libfsimage; make install</pre><p>Now we update the domain config file. Since we went to all the trouble of updating PyGRUB, we'll use it directly here:</p><a id="I_programlisting8_d1e9419"/><pre class="programlisting">bootloader='pygrub'
cpu_weight=1024
memory = 1024
name = "rosaline"
vif = ['vifname=rosaline,ip=192.0.2.136,bridge=xenbr0,mac=00:16:3e:59:A7:88' ]
disk = [
        #'file:/opt/distros/osol-0811.iso,xvdf:cdrom,r',
        'phy:/dev/verona/rosaline,xvda,w'
]</pre><div class="note" title="Note"><h3 class="title"><a id="note-34"/>Note</h3><p><span class="emphasis"><em>PV-GRUB, at this time, isn't able to load an OpenSolaris kernel properly. Use PyGRUB instead</em></span>.<a id="idx-CHP-8-0649" class="indexterm"/></p></div><p>Start your new domain as usual with <code class="literal">xm</code>:</p><a id="I_programlisting8_d1e9436"/><pre class="programlisting"># xm create rosaline</pre></div></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FNOTE-1" href="#CHP-8-FNOTE-1" class="para">45</a>] </sup>We tend to use the terms <span class="emphasis"><em>Zone</em></span> and <span class="emphasis"><em>Container</em></span> interchangeably. Technically, a Solaris Container implements system resource controls on top of Zones.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FNOTE-2" href="#CHP-8-FNOTE-2" class="para">46</a>] </sup>The CDDL is a free software license that's GPL-incompatible but generally inoffensive.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FNOTE-3" href="#CHP-8-FNOTE-3" class="para">47</a>] </sup>That's another reason we gloss over Solaris Express: Focusing on it would not, in the words of Douglas Adams, "make for nice fat books such as the American market thrives on."</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FNOTE-4" href="#CHP-8-FNOTE-4" class="para">48</a>] </sup>The temptation exists to write "elegant minimum," but it's simply not so.</p></div><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FNOTE-5" href="#CHP-8-FNOTE-5" class="para">49</a>] </sup>Anyone planning to take offense to the comparison of <code class="literal">pfexec</code> and <code class="literal">sudo</code>: Please assume that we have been utterly convinced by your rhetoric and carry on with your day-to-day life.</p></div></div></div>
<div class="sect1" title="NetBSD"><div class="titlepage"><div><div><h1 class="title"><a id="netbsd"/>NetBSD</h1></div></div></div><p>NetBSD is a popular choice for a <a id="idx-CHP-8-0650" class="indexterm"/>dom0 OS because <a id="idx-CHP-8-0651" class="indexterm"/>of its small <a id="idx-CHP-8-0652" class="indexterm"/>and versatile design, which is a good match for the <span class="emphasis"><em>dedicated virtualization server</em></span> model that Xen encourages. In our experience, a dom0 running NetBSD will use less memory and be at least as stable as one running Linux.</p><p>However, Linux people <a id="idx-CHP-8-0653" class="indexterm"/>often make the mistake of assuming that NetBSD is exactly like Linux. It's not—it's kind of close, but NetBSD is the product of an evolution as long as Linux's, and it requires some practice to work with. In this section, we're going to assume that you're familiar with NetBSD's idiosyncrasies; we're only going to cover the Xen-related differences.</p><div class="sect2" title="NetBSD's Historical Xen Support"><div class="titlepage"><div><div><h2 class="title"><a id="netbsds_historical_xen_support"/>NetBSD's Historical Xen Support</h2></div></div></div><p>NetBSD has supported Xen for a very long time—since NetBSD version 3.0, which incorporated support for Xen2 as dom0 and as a domU. This Xen2 support is quite stable. However, it has the obvious drawback of being Xen2, which lacks the Xen3 features like live migration and HVM. It's also 32 bit only, and doesn't support PAE (Physical Address Extension). (We've used this version quite a bit. The first Xen setup we used for hosting at prgmr.com was a dual Xeon running NetBSD 3.1 and Xen2, supporting Linux and NetBSD domUs.) NetBSD 3.1 introduced support for Xen 3.0.<span class="emphasis"><em>x</em></span>—but only as a domU.</p><p>NetBSD 4.0 added Xen 3.1 support as both a domU and a dom0, and it also introduced support for HVM. The only remaining problem with NetBSD 4.0 was that it, like its predecessors, it did not support PAE or x86_64, which means that it was unable to use more than 4GB of memory. It also could not run as a domU on a 64-bit or PAE system, such as is used by Amazon's EC2. That last bit was the real killer—it meant NetBSD 4 required a non-PAE 32-bit hypervisor, which in turn limited you to 4GB of address space, which translates about 3.5GB of physical memory. (This limitation is so significant that Xen.org doesn't even distribute a non-PAE binary package anymore.)</p><p>Finally, the new and shiny <a id="idx-CHP-8-0654" class="indexterm"/>NetBSD 5 adds PAE support for NetBSD domUs, x86-64 support for both dom0 and domUs, and support for 32-bit domUs on 64-bit dom0s (<span class="emphasis"><em>32-on-64</em></span> in Xen parlance). Work is still being done to add features to bring NetBSD Xen support into feature parity with Linux's Xen support, but NetBSD is already a perfectly viable platform.</p></div><div class="sect2" title="Installing NetBSD as a Dom0"><div class="titlepage"><div><div><h2 class="title"><a id="installing_netbsd_as_a_dom0"/>Installing NetBSD as a Dom0</h2></div></div></div><p>The basic steps to get started using NetBSD with Xen are pretty much the same as for any other OS: Download it, install it, and make it work. Again, we're assuming that you're familiar with the basic NetBSD install procedure, so we're just going to outline these directions briefly.<a id="idx-CHP-8-0655" class="indexterm"/></p><p>Begin by <a id="idx-CHP-8-0656" class="indexterm"/>downloading NetBSD and <a id="idx-CHP-8-0657" class="indexterm"/>installing it as usual. (We opted to download and burn the ISO at <a class="ulink" href="http://mirror.planetunix.net/pub/NetBSD/iso/5.0/amd64cd-5.0.iso">http://mirror.planetunix.net/pub/NetBSD/iso/5.0/amd64cd-5.0.iso</a>.)<a id="idx-CHP-8-0658" class="indexterm"/> Configure the system according to your preference.</p><div class="note" title="Note"><h3 class="title"><a id="note-35"/>Note</h3><p><a id="idx-CHP-8-0659" class="indexterm"/>ftp:// <span class="emphasis"><em>and</em></span> http:// <span class="emphasis"><em>are interchangeable on all of the</em></span> <a class="ulink" href="http://ftp.netbsd.org">ftp.netbsd.org</a> <span class="emphasis"><em>URLs</em></span>. http:// <span class="emphasis"><em>gets through firewalls better, and</em></span> ftp:// <span class="emphasis"><em>is slightly faster. Pick one. Also, you often get significantly better speeds using a mirror rather than the netbsd.org site. If your FTP install fails partway through, the first thing to do is to try another mirror</em></span>.<a id="idx-CHP-8-0660" class="indexterm"/></p></div><p>However you install NetBSD, go through the installer and reboot into your new system. Next, install the Xen kernel and supporting tools using the NetBSD ports system, <code class="literal">pkgsrc</code>. Get <code class="literal">pkgsrc</code> at <a class="ulink" href="http://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc.tar.gz">http://ftp.netbsd.org/pub/NetBSD/packages/pkgsrc.tar.gz</a>. Untar <span class="emphasis"><em>pkgsrc.tar.gz</em></span>, then install Xen:</p><a id="I_programlisting8_d1e9564"/><pre class="programlisting"># cd pkgsrc/sysutils/xenkernel3 ; make install
# cd pkgsrc/sysutils/xentools3 ; make install</pre><p>After installing the Xen tools, NetBSD will remind you to create the Xen device nodes:</p><a id="I_programlisting8_d1e9568"/><pre class="programlisting"># cd /dev ; sh MAKEDEV xen</pre><p>Now that Xen is installed, our next task is to install GRUB in place of the standard NetBSD bootloader so that we can perform the multistage boot that Xen requires:</p><a id="I_programlisting8_d1e9572"/><pre class="programlisting"># cd pkgsrc/sysutils/grub ; make install</pre><p>Our next step is to download and install <a id="idx-CHP-8-0661" class="indexterm"/>NetBSD Xen kernels—we're already running off standard NetBSD kernels, and we've got the hypervisor installed, but we still need kernels for the dom0 and domUs. Download <em class="filename">netbsd-XEN3_DOM0.gz</em>, <em class="filename">netbsd-XEN3_DOMU.gz</em>, and <em class="filename">netbsd-INSTALL_XEN3_DOMU.gz</em> from your favorite NetBSD mirror. (We used <a class="ulink" href="http://mirror.planetunix.net/pub/NetBSD/NetBSD-5.0/">http://mirror.planetunix.net/pub/NetBSD/NetBSD-5.0/</a>.)</p><p>Now that we have suitable Xen kernels to go with the hypervisor and <a id="idx-CHP-8-0662" class="indexterm"/>supporting tools that we installed in the previous step, we can set up GRUB in the usual way:</p><a id="I_programlisting8_d1e9600"/><pre class="programlisting"># grub-install --no-floppy sd0a</pre><p>Edit <span class="emphasis"><em>/grub/menu.lst</em></span> so that it boots the Xen kernel and loads <a id="idx-CHP-8-0663" class="indexterm"/>NetBSD as a module. Here's a complete file, with comments (adapted from a <a id="idx-CHP-8-0664" class="indexterm"/>NetBSD example at <a class="ulink" href="http://www.netbsd.org/ports/xen/howto.html">http://www.netbsd.org/ports/xen/howto.html</a>):</p><a id="I_programlisting8_d1e9619"/><pre class="programlisting"># Boot the first entry by default
default=1

# after 10s, boot the default entry if the user didn't hit keyboard
timeout=10

# Configure serial port to use as console. Ignore this bit if you're
# not <a id="idx-CHP-8-0665" class="indexterm"/>using the serial port.
serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1

# Let the user select which console to use (serial or VGA). Default
# to serial after 10s
terminal --timeout=10 console serial
# An entry for NetBSD/xen, using /xen/kernels/xen.gz as the domain0
# kernel, with serial console. Domain0 will have 64MB RAM allocated.
# Assume NetBSD is installed in the first MBR partition.
title Xen 3.3 / NetBSD (sd0a, serial) root(hd0,0) kernel
(hd0,a)/xen/kernels/xen.gz dom0_mem=65536 com1=115200,8n1 module
(hd0,a)/xen/kernels/XEN3_DOM0 root=sd0a ro console=ttyS0

# Same as above, but using VGA console
# We can use console=tty0 (Linux syntax) or console=pc (NetBSD syntax)
title Xen 3.3 / NetBSD (sd0a, vga)
root(hd0,0)
kernel (hd0,a)/xen/kernels/xenkernel3-3.1.0nb2 dom0_mem=65536 noreboot
module (hd0,a)/xen/kernels/XEN3_DOM0 root=sd0a ro console=pc

# Load a regular NetBSD/i386 kernel. Can be useful if you end up with a
# nonworking /xen.gz
title NetBSD 5
root (hd0,a)
kernel (hd0,a)/netbsd-GENERIC</pre><p>The important bits are the kernel name, <code class="literal">XEN3_DOM0</code>, and the root device, which we specify using NetBSD syntax.</p><div class="note" title="Note"><h3 class="title"><a id="note-36"/>Note</h3><p><span class="emphasis"><em>We've also set up this config file to use the serial console. No matter which operating system you use, we strongly recommend using a serial console with Xen, even if you prefer to use a KVM or other method of remote management normally. See <a class="xref" href="ch14.html" title="Chapter 14. TIPS">Chapter 14</a> for more discussion of the many and varied uses of the serial console</em></span>.</p></div><p>Copy over the <a id="idx-CHP-8-0666" class="indexterm"/>basic Xen config files to the directory where the Xen tools will expect to find them:</p><a id="I_programlisting8_d1e9647"/><pre class="programlisting"># cp /usr/pkg/share/examples/xen/* /usr/pkg/etc/xen/</pre><p>Now that we have all the parts of a <a id="idx-CHP-8-0667" class="indexterm"/>NetBSD dom0, we need to start <code class="literal">xenbackendd</code> and <code class="literal">xend</code> (in that order, or it won't work).</p><a id="I_programlisting8_d1e9661"/><pre class="programlisting"># cp /usr/pkg/share/examples/rc.d/xen* /etc/rc.d/

# echo "xenbackendd=YES"&gt;&gt;/etc/rc.conf
# echo "xend=YES"&gt;&gt;/etc/rc.conf</pre><p>Finally, to get networking to work, create <span class="emphasis"><em>/etc/ifconfig.bridge0</em></span> with these contents:</p><a id="I_programlisting8_d1e9669"/><pre class="programlisting">create
!brconfig $int add fxp0 up</pre><p>At this point you're most likely done. Reboot to test, or start the Xen services manually:</p><a id="I_programlisting8_d1e9673"/><pre class="programlisting"># /etc/rc.d/xenbackendd start
Starting xenbackendd.
# /etc/rc.d/xend start
Starting xend</pre><p>You should now be able to run <code class="literal">xm list</code>:</p><a id="I_programlisting8_d1e9680"/><pre class="programlisting"># xm list
Name ID Mem VCPUs State Time(s)
Domain-0 0 64 1 r----- 282.1</pre></div><div class="sect2" title="Installing NetBSD as a DomU"><div class="titlepage"><div><div><h2 class="title"><a id="installing_netbsd_as_a_domu"/>Installing NetBSD as a DomU</h2></div></div></div><p><a id="idx-CHP-8-0668" class="indexterm"/>Installing <a id="idx-CHP-8-0669" class="indexterm"/>NetBSD as a domU is easy, even with a Linux dom0. In fact, because NetBSD's <a id="idx-CHP-8-0670" class="indexterm"/>INSTALL kernels include a ramdisk with everything necessary to complete the installation, we can even do it without modifying the configuration from the dom0, given a sufficiently versatile PyGRUB or PV-GRUB setup.<a id="idx-CHP-8-0671" class="indexterm"/></p><p>For this discussion, we assume that you've got a domU of some sort already set up—perhaps one of the generic prgmr.com Linux domains. In this domU, you'll need to have a small boot partition that GRUB<sup>[<a id="CHP-8-FNOTE-6" href="#ftn.CHP-8-FNOTE-6" class="footnote">50</a>]</sup> can read. This is where we'll store the kernel and GRUB configuration.<a id="I_indexterm8_d1e9718" class="indexterm"/><a id="I_indexterm8_d1e9723" class="indexterm"/></p><p>First, from within your domain, download the <a id="idx-CHP-8-0672" class="indexterm"/>NetBSD kernels:</p><a id="I_programlisting8_d1e9734"/><pre class="programlisting"># wget http://mirror.planetunix.net/pub/<a id="idx-CHP-8-0673" class="indexterm"/>NetBSD/<a id="idx-CHP-8-0674" class="indexterm"/>NetBSD-5.0/amd64/binary/kernel/
netbsd-<a id="idx-CHP-8-0675" class="indexterm"/>INSTALL_XEN3_DOMU.gz
# wget http://mirror.planetunix.net/pub/NetBSD/NetBSD-5.0/amd64/binary/kernel/
netbsd-XEN3_DOMU.gz</pre><p>Then, edit the domain's <a id="idx-CHP-8-0676" class="indexterm"/>GRUB menu (most likely at <a id="idx-CHP-8-0677" class="indexterm"/><span class="emphasis"><em>/boot/grub/menu.lst</em></span>) to load the INSTALL kernel on next reboot. (On the reboot after that, when the installation's done, you'll select the NetBSD run option.)</p><a id="I_programlisting8_d1e9768"/><pre class="programlisting">title NetBSD install
        root (hd0,0)
        kernel /boot/netbsd-INSTALL_XEN3_DOMU

title NetBSD run
        root (hd0,0)
        kernel /boot/netbsd-XEN3_DOMU root=xbd1a</pre><p>Reboot, selecting the <span class="strong"><strong>NetBSD install</strong></span> option.</p><p>As if by magic, your domain will begin running the <a id="idx-CHP-8-0678" class="indexterm"/>NetBSD installer, until you end <a id="idx-CHP-8-0679" class="indexterm"/>up in a totally ordinary NetBSD install session. Go through the steps of the NetBSD <a id="idx-CHP-8-0680" class="indexterm"/>FTP install. There's some very nice documentation at <a class="ulink" href="http://netbsd.org/docs/guide/en/chap-exinst.html">http://netbsd.org/docs/guide/en/chap-exinst.html</a>.</p><div class="note" title="Note"><h3 class="title"><a id="note-37"/>Note</h3><p><span class="emphasis"><em>At this point you have to be careful not to overwrite your boot device. For example, prgmr.com gives you only a single physical block device, from which you'll need to carve a</em></span> /boot <span class="emphasis"><em>partition in addition to the normal filesystem layout</em></span>.<a id="idx-CHP-8-0681" class="indexterm"/></p></div><p>The only sticky point is that you have to be careful to set up a boot device that PyGRUB can read, in the place where PyGRUB expects it. (If you have multiple physical devices, PyGRUB will try to boot from the first one.) Since we're installing within the standard prgmr.com domU setup, we only have a single physical block device to work with, which we'll carve into separate <span class="emphasis"><em>/boot</em></span> and <span class="emphasis"><em>/</em></span> partitions. Our disklabel, with a <span class="emphasis"><em>32 MB FFS /boot</em></span> partition, looks like this:</p><a id="I_programlisting8_d1e9818"/><pre class="programlisting">We now have your BSD-disklabel partitions as:
 This is your last chance to change them.
   
    Start  MB   End  MB  Size  MB FS type    Newfs Mount Mount point
    --------- --------- --------- ---------- ----- ----- -----------
 a:        31      2912      2882 FFSv1      Yes   Yes   /
 b:      2913      3040       128 swap
 c:         0      3071      3072 NetBSD partition
 d:         0      3071      3072 Whole disk
 e:         0        30        31 Linux Ext2
 f:         0         0         0 unused
 g: Show all unused partitions
 h: Change input units (sectors/cylinders/MB)
&gt;x: Partition sizes ok</pre><p>Once the install's done, reboot. Select the regular kernel in PyGRUB, and your domU should be ready to go.</p><p>After NetBSD's booted, if you want to change the bootloader configuration, you can mount the <span class="emphasis"><em>ext2</em></span> partition thus:</p><a id="I_programlisting8_d1e9827"/><pre class="programlisting"># mount_ext2fs /dev/xbd0d /mnt</pre><p>This will allow you upgrade the domU kernel. Just remember that, whenever you want to upgrade the kernel, you need to mount the partition that PyGRUB loads the kernel from and make sure to update that kernel and <em class="filename">menu.lst</em>. It would also be a good idea to install the NetBSD kernel in the usual place, in the root of the domU filesystem, but it isn't strictly necessary.</p><p>And there you have it—a complete, fully functional NetBSD domU, without any intervention from the dom0 at all. (If you have dom0 access, you can specify the install kernel on the <code class="literal">kernel=</code> line of the domain config file in the usual way—but what would be the fun of that?)</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.CHP-8-FNOTE-6" href="#CHP-8-FNOTE-6" class="para">50</a>] </sup>More accurately, of course, your GRUB simulator. If this is PyGRUB, it relies on <code class="literal">libfsimage</code>.</p></div></div></div>
<div class="sect1" title="Beyond Paravirtualization: HVM"><div class="titlepage"><div><div><h1 class="title"><a id="beyond_paravirtualization_hvm"/>Beyond Paravirtualization: HVM</h1></div></div></div><p>In this chapter, we have outlined the general steps necessary to use Solaris and NetBSD as both dom0 and domU operating systems. This isn't meant to exhaustively list the operating systems that work with Xen—in particular, we haven't mentioned Plan9 or FreeBSD at all—but it does give you a good idea of the sort of differences that you might encounter and easy recipes for using at least two systems other than Linux.</p><p>Furthermore, they each have their own advantages: NetBSD is a very lightweight operating system, much better than Linux at handling low-memory conditions. This comes in handy with Xen. Solaris isn't as light, but it is extremely robust and has interesting technologies, such as ZFS. Both of these OSs can support any OS as domU, as long as it's been modified to work with Xen. That's virtualization in action, if you like.</p><div class="note" title="Note"><h3 class="title"><a id="note-38"/>Note</h3><p><span class="emphasis"><em>The new Linux paravirt_ops functionality that is included in the kernel.org kernels requires Xen hypervisor version 3.3 or later, so it works with NetBSD but not OpenSolaris</em></span>.</p></div><p>Finally, the addition of hardware virtualization extensions to recent processors means that virtually any OS can be used as a domU, even if it hasn't been modified specifically to work with Xen. We discuss Xen's support for these extensions in <a class="xref" href="ch12.html" title="Chapter 12. HVM: BEYOND PARAVIRTUALIZATION">Chapter 12</a> and then describe using HVM to run Windows under Xen in <a class="xref" href="ch13.html" title="Chapter 13. XEN AND WINDOWS">Chapter 13</a>. Stay tuned.<a id="I_indexterm8_d1e9857" class="indexterm"/><a id="I_indexterm8_d1e9862" class="indexterm"/></p></div></body></html>