<html><head></head><body><section epub:type="chapter" id="intelligence_gathering-id1"><div class="titlepage"><div class="book"><div class="book"><h2 class="title1">Chapter 3. Intelligence Gathering</h2></div></div></div><p class="calibre2">Intelligence gathering follows the pre-engagement activities as the second step in a penetration test. Your goals during intelligence gathering should be to gain accurate information about your targets without revealing your presence or your intentions, to learn how the organization operates, and to determine the best route of entry. If you don’t do a thorough job of intelligence gathering, you may miss vulnerable systems or viable attack vectors. It takes time and patience to sort through web pages, perform Google hacking, and map systems thoroughly in an attempt to understand the infrastructure of a particular target. Intelligence gathering requires careful planning, research, and, most importantly, the ability to think like an attacker. At this step, you will attempt to collect as much information about the target environment as possible. This can be an expansive amount of information, and even the most trivial data gathered during this stage can prove useful later on, so pay attention.<a id="IDX-CHP-3-0001" class="strong"/></p><p class="calibre2">Before you begin intelligence gathering, consider how you will record everything you do and the results you achieve. You must remember and record as many details of your penetration test as possible. Most security professionals quickly learn that detailed notes can mean the difference between a successful and a failed penetration test. Just as a scientist needs to achieve reproducible results, other experienced penetration testers should be able to reproduce your work using your documentation alone.<a id="IDX-CHP-3-0002" class="strong"/><a id="IDX-CHP-3-0003" class="strong"/><a id="IDX-CHP-3-0004" class="strong"/><a id="IDX-CHP-3-0005" class="strong"/><a id="IDX-CHP-3-0006" class="strong"/><a id="IDX-CHP-3-0007" class="strong"/></p><p class="calibre2">Intelligence gathering is arguably the most important aspect of a penetration test, because it provides the foundation for all work that follows. When recording your work, be methodical, accurate, and precise. And, as stated earlier, be sure that before you fire off your exploits, you have learned all that you can about your target.</p><p class="calibre2">The excitement for most people comes in exploiting systems and getting to root, but you need to learn to walk before you can run.</p><div class="book"><hr class="calibre5"/></div><div class="warning" epub:type="warning"><h3 class="title6">Warning</h3><p class="calibre2">If you follow the procedures in this chapter, you can actually damage your system and your target’s system, so be sure to set up your test environment now. (For help, see <a class="xref" href="part0022.html#configuring_your_target_machines">Appendix A</a>.) Many of the examples in these chapters can be destructive and make a target system unusable. The activities discussed in this chapter could be considered illegal if they are undertaken by someone with bad intentions, so follow the rules and don’t be stupid.</p></div><div class="book"><hr class="calibre5"/></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="passive_information_gathering">Passive Information Gathering</h2></div></div></div><p class="calibre2">By using <span class="strong"><em class="calibre4">passive</em></span> and <span class="strong"><em class="calibre4">indirect</em></span> information gathering, you can discover information about targets without touching their systems. For example, you can use these techniques to identify network boundaries, identify the network maintainers, and even learn what operating system and web server software is in use on the target network.</p><p class="calibre2"><span class="strong"><em class="calibre4">Open source intelligence (OSINT)</em></span> is a form of intelligence collection that uses open or readily available information to find, select, and acquire information about a target. Several tools make passive information gathering almost painless, including complex tools such as Yeti and the humble <span class="strong"><em class="calibre4">whois</em></span>. In this section, we’ll explore the process of passive information gathering and the tools that you might use for this step.<a id="IDX-CHP-3-0008" class="strong"/><a id="IDX-CHP-3-0009" class="strong"/></p><p class="calibre2">Imagine, for example, an attack against <a class="xref" href="http://www.secmaniac.net/" target="_top">http://www.secmaniac.net/</a>. Our goal is to determine, as a part of a penetration test, what systems the company owns and what systems we can attack. Some systems may not be owned by the company and could be considered out of scope and unavailable for attack.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="whois_lookups">whois Lookups</h3></div></div></div><p class="calibre2">Let’s begin by using Back|Track’s <span class="strong"><em class="calibre4">whois</em></span> lookup to find the names of <a class="xref" href="http://secmaniac.net" target="_top">secmaniac.net</a>’s domain servers.</p><a id="I_programlisting3_d1e1327" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">whois secmaniac.net</code></strong>
[*] exec: whois secmaniac.net

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>
Registered through: GoDaddy.com, Inc. (http://www.godaddy.com)
   Domain Name: SECMANIAC.NET
      Created on: 03-Feb-10
      Expires on: 03-Feb-12
      Last Updated on: 03-Feb-10

  <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>Domain servers in listed order:
      NS57.DOMAINCONTROL.COM
      NS58.DOMAINCONTROL.COM</pre><p class="calibre2">We learn at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e1343" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> that the Domain Name System (DNS) servers are hosted by <span class="strong"><em class="calibre4">DOMAINCONTROL.COM</em></span>, so this is a good example of systems that would not be included in a penetration test because we would have no authority to attack them. In most large organizations, the DNS servers are housed within the company and are viable attack vectors. Zone transfers and similar DNS attacks can often be used to learn more about a network from both the inside and outside. In this scenario, because <span class="strong"><em class="calibre4">DOMAINCONTROL.COM</em></span> is not owned by <a class="xref" href="http://secmaniac.net" target="_top">secmaniac.net</a>, we should not attack these systems and will instead move on to a different attack vector.<a id="IDX-CHP-3-0010" class="strong"/><a id="IDX-CHP-3-0011" class="strong"/><a id="IDX-CHP-3-0012" class="strong"/><a id="IDX-CHP-3-0013" class="strong"/><a id="IDX-CHP-3-0014" class="strong"/><a id="IDX-CHP-3-0015" class="strong"/><a id="IDX-CHP-3-0016" class="strong"/><a id="IDX-CHP-3-0017" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="netcraft">Netcraft</h3></div></div></div><p class="calibre2">Netcraft (<a class="xref" href="http://searchdns.netcraft.com/" target="_top">http://searchdns.netcraft.com/</a>) is a web-based tool that we can use to find the IP address of a server hosting a particular website, as shown in <a class="xref" href="part0007.html#use_netcraft_to_find_the_ip_address_of_t">Figure 3-1</a>.</p><div class="figure"><a id="use_netcraft_to_find_the_ip_address_of_t" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject3_d1e1401" class="strong"/><img src="../images/00003.jpeg" alt="Use Netcraft to find the IP address of the server hosting a particular website." hisrc="httpatomoreillycomsourcenostarchimages867460.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 3-1. Use Netcraft to find the IP address of the server hosting a particular website.</div></div><p class="calibre2">Having identified <a class="xref" href="http://secmaniac.net" target="_top">secmaniac.net</a>’s IP address as 75.118.185.142, we do another <span class="strong"><em class="calibre4">whois</em></span> lookup on that IP address:</p><a id="I_programlisting3_d1e1414" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">whois 75.118.185.142</code></strong>
[*] exec: whois 75.118.185.142
WideOpenWest Finance LLC WIDEOPENWEST (NET-75-118-0-0-1)
                                  75.118.0.0 - 75.118.255.255
WIDEOPENWEST OHIO WOW-CL11-1-184-118-75 (NET-75-118-184-0-1)
                                  75.118.184.0 - 75.118.191.255</pre><p class="calibre2">We see from the <span class="strong"><em class="calibre4">whois</em></span> lookup and a quick search that this IP (<span class="strong"><em class="calibre4">WIDEOPENWEST</em></span>) appears to be a legitimate service provider. While the actual subnet range isn’t specifically registered to <a class="xref" href="http://secmaniac.net" target="_top">secmaniac.net</a> or <a class="xref" href="http://secmaniac.com" target="_top">secmaniac.com</a>, we can tell that this site appears to be hosted inside the author’s home, because the IP block appears to be part of a residential range.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="nslookup">NSLookup</h3></div></div></div><p class="calibre2">To get additional server information, we’ll use Back|Track to leverage <code class="literal">nslookup</code>, a tool built into most operating systems, to find information about <a class="xref" href="http://secmaniac.net" target="_top">secmaniac.net</a>.<a id="IDX-CHP-3-0018" class="strong"/><a id="IDX-CHP-3-0019" class="strong"/><a id="IDX-CHP-3-0020" class="strong"/><a id="IDX-CHP-3-0021" class="strong"/><a id="IDX-CHP-3-0022" class="strong"/><a id="IDX-CHP-3-0023" class="strong"/><a id="IDX-CHP-3-0024" class="strong"/><a id="IDX-CHP-3-0025" class="strong"/><a id="IDX-CHP-3-0026" class="strong"/></p><a id="I_programlisting3_d1e1482" class="strong"/><pre class="programlisting">root@bt:˜# <strong class="calibre3"><code class="calibre6">nslookup</code></strong>
<strong class="calibre3"><code class="calibre6">set type=mx</code></strong>
&gt; <strong class="calibre3"><code class="calibre6">secmaniac.net</code></strong>
Server:         172.16.32.2
Address:        172.16.32.2#53

Non-authoritative answer:
secmaniac.net   mail exchanger = 10 mailstore1.secureserver.net.
secmaniac.net   mail exchanger = 0 smtp.secureserver.net.</pre><p class="calibre2">We see in this listing that the mail servers are pointing to <span class="strong"><em class="calibre4">mailstore1.secureserver.net</em></span> and <span class="strong"><em class="calibre4">smtp.secureserver.net</em></span>. Some quick research on these mail servers tells us that this website is hosted by a third party, which would not be within the scope of our penetration test.</p><p class="calibre2">At this point, we have gathered some valuable information that we might be able to use against the target later on. Ultimately, however, we have to resort to active information gathering techniques to determine the actual target IP, which is 75.118.185.142.<a id="IDX-CHP-3-0027" class="strong"/></p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">Passive information gathering is an art that is not easily mastered in just a few pages of discussion. See the <span class="strong"><em class="calibre4">Penetration Testing Execution Standard (PTES;</em></span> <a class="xref" href="http://www.pentest-standard.org/" target="_top">http://www.pentest-standard.org/</a>) for a list of potential ways to perform additional passive intelligence gathering.</p></div><div class="book"><hr class="calibre5"/></div></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="active_information_gathering">Active Information Gathering</h2></div></div></div><p class="calibre2">In active information gathering, we interact directly with a system to learn more about it. We might, for example, conduct port scans for open ports on the target or conduct scans to determine what services are running. Each system or running service that we discover gives us another opportunity for exploitation. But beware: If you get careless while active information gathering, you might be nabbed by an IDS or intrusion prevention system (IPS) — not a good outcome for the covert penetration tester.<a id="IDX-CHP-3-0028" class="strong"/></p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="port_scanning_with_nmap">Port Scanning with Nmap</h3></div></div></div><p class="calibre2">Having identified the target IP range with passive information gathering as well as the <a class="xref" href="http://secmaniac.net" target="_top">secmaniac.net</a> target IP address, we can begin to scan for open ports on the target by <span class="strong"><em class="calibre4">port scanning</em></span>, a process whereby we meticulously connect to ports on the remote host to identify those that are active. (Obviously, in a larger enterprise, we would have multiple IP ranges and things to attack instead of only one IP.)</p><p class="calibre2"><span class="strong"><em class="calibre4">Nmap</em></span> is, by far, the most popular port scanning tool. It integrates with Metasploit quite elegantly, storing scan output in a database backend for later use. <span class="strong"><em class="calibre4">Nmap</em></span> lets you scan hosts to identify the services running on each, any of which might offer a way in.<a id="IDX-CHP-3-0029" class="strong"/><a id="IDX-CHP-3-0030" class="strong"/><a id="IDX-CHP-3-0031" class="strong"/><a id="IDX-CHP-3-0032" class="strong"/><a id="IDX-CHP-3-0033" class="strong"/><a id="IDX-CHP-3-0034" class="strong"/><a id="IDX-CHP-3-0035" class="strong"/></p><p class="calibre2">For this example, let’s leave <a class="xref" href="http://secmaniac.net" target="_top">secmaniac.net</a> behind and turn to the virtual machine described in <a class="xref" href="part0022.html#configuring_your_target_machines">Appendix A</a>, with IP address 172.16.32.131. Before we get started, take a quick look at the basic <span class="strong"><em class="calibre4">nmap</em></span> syntax by entering <strong class="calibre3"><code class="calibre6">nmap</code></strong> from the command line on your Back|Track machine.</p><p class="calibre2">You’ll see immediately that <span class="strong"><em class="calibre4">nmap</em></span> has a quite a few options, but you’ll use just a few of them for the most part.</p><p class="calibre2">One of our preferred <span class="strong"><em class="calibre4">nmap</em></span> options is <code class="literal">-sS</code>. This runs a stealth TCP scan that determines whether a specific TCP-based port is open. Another preferred option is <code class="literal">-Pn</code>, which tells <span class="strong"><em class="calibre4">nmap</em></span> not to use <code class="literal">ping</code> to determine whether a system is running; instead, it considers all hosts “alive.” If you’re performing Internet-based penetration tests, you should use this flag, because most networks don’t allow Internet Control Message Protocol (ICMP), which is the protocol that <code class="literal">ping</code> uses. If you’re performing this scan internally, you can probably ignore this flag.<a id="IDX-CHP-3-0036" class="strong"/><a id="IDX-CHP-3-0037" class="strong"/></p><p class="calibre2">Now let’s run a quick <span class="strong"><em class="calibre4">nmap</em></span> scan against our Windows XP machine using both the <code class="literal">-sS</code> and <code class="literal">-Pn</code> flags.</p><a id="I_programlisting3_d1e1623" class="strong"/><pre class="programlisting">root@bt:˜# <strong class="calibre3"><code class="calibre6">nmap -sS -Pn 172.16.32.131</code></strong>
Nmap scan report for 172.16.32.131
Host is up (0.00057s latency).
Not shown: 990 closed ports
PORT     STATE SERVICE
21/tcp   open  ftp
25/tcp   open  smtp
80/tcp   open  http
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
443/tcp  open  https
445/tcp  open  microsoft-ds
1025/tcp open  NFS-or-IIS
1433/tcp open  ms-sql-s
3389/tcp open  ms-term-serv
Nmap done: 1 IP address (1 host up) scanned in 14.34 seconds</pre><p class="calibre2">As you can see, <span class="strong"><em class="calibre4">nmap</em></span> reports a list of open ports, along with a description of the associated service for each.</p><p class="calibre2">For more detail, try using the <code class="literal">-A</code> flag. This option will attempt advanced service enumeration and banner grabbing, which may give you even more details about the target system. For example, here’s what we’d see if we were to call <span class="strong"><em class="calibre4">nmap</em></span> with the <code class="literal">-sS</code> and <code class="literal">-A</code> flags, using our same target system:<a id="IDX-CHP-3-0038" class="strong"/><a id="IDX-CHP-3-0039" class="strong"/></p><a id="I_programlisting3_d1e1653" class="strong"/><pre class="programlisting">root@bt:˜# <strong class="calibre3"><code class="calibre6">nmap -Pn -sS -A 172.16.32.131</code></strong>
Nmap scan report for 172.16.32.131
Host is up (0.0035s latency).
Not shown: 993 closed ports
PORT     STATE SERVICE      VERSION
135/tcp  open  msrpc        Microsoft Windows RPC
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds Microsoft Windows XP microsoft-ds
777/tcp  open  unknown
1039/tcp open  unknown
1138/tcp open  msrpc        Microsoft Windows RPC
1433/tcp open  ms-sql-s     Microsoft SQL Server 2005 9.00.1399; RTM

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

Device type: general purpose
Running: Microsoft Windows XP|2003
OS details: Microsoft Windows XP Professional SP2 or Windows Server 2003
Network Distance: 1 hop
Service Info: OS: Windows

Host script results:
|_nbstat: NetBIOS name: V-MAC-XP, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC:
    00:0c:29:c9:38:4c (VMware)
|_smbv2-enabled: Server doesn't support SMBv2 protocol
| smb-os-discovery:

|   OS: Windows XP (Windows 2000 LAN Manager)
|   Name: WORKGROUP\V-MAC-XP</pre></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="working_with_databases_in_metasploit">Working with Databases in Metasploit</h3></div></div></div><p class="calibre2">When you’re running a complex penetration test with a lot of targets, keeping track of everything can be a challenge. Luckily, Metasploit has you covered with expansive support for multiple database systems.<a id="IDX-CHP-3-0040" class="strong"/><a id="IDX-CHP-3-0041" class="strong"/><a id="IDX-CHP-3-0042" class="strong"/><a id="IDX-CHP-3-0043" class="strong"/><a id="IDX-CHP-3-0044" class="strong"/><a id="IDX-CHP-3-0045" class="strong"/><a id="IDX-CHP-3-0046" class="strong"/><a id="IDX-CHP-3-0047" class="strong"/></p><p class="calibre2">To ensure that database support is available for your system, you should first decide which database system you want to run. Metasploit supports MySQL and PostgreSQL; because PostgreSQL is the default, we’ll stick with it in this discussion.</p><p class="calibre2">First, we start the database subsystem using the built-in Back|Track <span class="strong"><em class="calibre4">init.d</em></span> scripts.</p><a id="I_programlisting3_d1e1699" class="strong"/><pre class="programlisting">root@bt˜# <strong class="calibre3"><code class="calibre6">/etc/init.d/postgresql-8.3 start</code></strong></pre><p class="calibre2">After PostgreSQL has started, we tell the Framework to connect to the database instance. This connection requires a username, password, name of the host on which the database is running, and the database name we want to use. Back|Track’s default PostgreSQL username is <span class="strong"><em class="calibre4">postgres</em></span> with the password <span class="strong"><em class="calibre4">toor</em></span>, but we’ll use <span class="strong"><em class="calibre4">msfbook</em></span> as the database name. Let’s make the connection.</p><a id="I_programlisting3_d1e1714" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_connect postgres:toor@127.0.0.1/msfbook</code></strong></pre><p class="calibre2">If this were the first time we connected to the database name, we would see a lot of text output as Metasploit sets up all the necessary tables. Otherwise, the command will return to the <code class="literal">msfconsole</code> prompt.<a id="IDX-CHP-3-0048" class="strong"/></p><p class="calibre2">Metasploit provides a number of commands that we can use to interact with the database, as you’ll see throughout this book. (For a complete list, enter <strong class="calibre3"><code class="calibre6">help</code></strong>.) For now, we’ll use <code class="literal">db_status</code> to make sure that we’re connected correctly.</p><a id="I_programlisting3_d1e1734" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_status</code></strong>
[*] postgresql connected to msfbook</pre><p class="calibre2">Everything seems to be set up just fine.<a id="IDX-CHP-3-0049" class="strong"/><a id="IDX-CHP-3-0050" class="strong"/><a id="IDX-CHP-3-0051" class="strong"/><a id="IDX-CHP-3-0052" class="strong"/><a id="IDX-CHP-3-0053" class="strong"/><a id="IDX-CHP-3-0054" class="strong"/></p><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="importing_nmap_results_into_metasploit">Importing Nmap Results into Metasploit</h4></div></div></div><p class="calibre2">When you are working with other team members, with various individuals scanning at different times and from different locations, it helps to know how to run <span class="strong"><em class="calibre4">nmap</em></span> on its own and then import its results into the Framework. Next, we’ll examine how to import a basic <span class="strong"><em class="calibre4">nmap</em></span>-generated XML export file (generated with <span class="strong"><em class="calibre4">nmap</em></span>’s <code class="literal">-oX</code> option) into the Framework.</p><p class="calibre2">First, we scan the Windows virtual machine using the <code class="literal">-oX</code> option to generate a <span class="strong"><em class="calibre4">Subnet1.xml</em></span> file:</p><a id="I_programlisting3_d1e1787" class="strong"/><pre class="programlisting"><strong class="calibre3"><code class="calibre6">nmap -Pn -sS -A -oX Subnet1 192.168.1.0/24</code></strong></pre><p class="calibre2">After generating the XML file, we use the <code class="literal">db_import</code> command to import it into our database. We can then verify that the import worked by using the <code class="literal">db_hosts</code> command, which lists the systems entries that have been created, as shown here:</p><a id="I_programlisting3_d1e1798" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_connect postgres:toor@127.0.0.1/msf3</code></strong>
msf &gt; <strong class="calibre3"><code class="calibre6">db_import Subnet1.xml</code></strong>
msf &gt; <strong class="calibre3"><code class="calibre6">db_hosts -c address</code></strong>

Hosts
=====

address

-------

192.168.1.1
192.168.1.10
192.168.1.101
192.168.1.102
192.168.1.109
192.168.1.116
192.168.1.142
192.168.1.152
192.168.1.154
192.168.1.171
192.168.1.155
192.168.1.174
192.168.1.180
192.168.1.181
192.168.1.2
192.168.1.99

msf &gt;</pre><p class="calibre2">This tells us that we’ve successfully imported the output of our <span class="strong"><em class="calibre4">nmap</em></span> scans into Metasploit, as evidenced by the IP addresses populated when we run the <code class="literal">db_hosts</code> commands.<a id="IDX-CHP-3-0055" class="strong"/><a id="IDX-CHP-3-0056" class="strong"/><a id="IDX-CHP-3-0057" class="strong"/><a id="IDX-CHP-3-0058" class="strong"/><a id="IDX-CHP-3-0059" class="strong"/></p></div><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="advanced_nmap_scanning_colon_tcp_idle_sc">Advanced Nmap Scanning: TCP Idle Scan</h4></div></div></div><p class="calibre2">A more advanced <span class="strong"><em class="calibre4">nmap</em></span> scan method, <span class="strong"><em class="calibre4">TCP idle scan</em></span>, allows us to scan a target stealthily by spoofing the IP address of another host on the network. For this type of scan to work, we first need to locate an idle host on the network that uses incremental IP IDs (which are used to track packet order). When we discover an idle system that uses incremental IP IDs, the IP IDs become predictable, and we can then predict the next ID. However, when spoofing the address of an idle host while scanning a target’s responses from open ports, we can see a break in the predictability of the IP ID sequence, which indicates that we have discovered an open port. (To learn more about this module and IP ID sequences, visit <a class="xref" href="http://www.metasploit.com/modules/auxiliary/scanner/ip/ipidseq/" target="_top">http://www.metasploit.com/modules/auxiliary/scanner/ip/ipidseq/</a>.)<a id="IDX-CHP-3-0060" class="strong"/><a id="IDX-CHP-3-0061" class="strong"/><a id="IDX-CHP-3-0062" class="strong"/><a id="IDX-CHP-3-0063" class="strong"/></p><p class="calibre2">Use the Framework’s <span class="strong"><em class="calibre4">scanner/ip/ipidseq</em></span> module to scan for a host that fits the TCP idle scan requirements, as shown next:</p><a id="I_programlisting3_d1e1868" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use auxiliary/scanner/ip/ipidseq</code></strong>
 msf auxiliary(ipidseq) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

 Module options:

    Name       Current Setting  Required  Description
    ----       ---------------  --------  -----------
    GWHOST                      no        The gateway IP address
    INTERFACE                   no        The name of the interface
    LHOST                       no        The local IP address
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>   RHOSTS
                      yes       The target address range or CIDR identifier
    RPORT      80               yes       The target port
    SNAPLEN    65535            yes       The number of bytes to capture
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>   THREADS    1                yes       The number of concurrent threads
    TIMEOUT    500              yes       The reply read timeout in milliseconds</pre><p class="calibre2">This listing displays the required options for the <span class="strong"><em class="calibre4">ipidseq</em></span> scan. One notable one, <code class="literal">RHOSTS</code> at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e1896" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, can take IP ranges (such as 192.168.1.20–192.168.1.30); Classless Inter-Domain Routing (CIDR) ranges (such as 192.168.1.0/24); multiple ranges separated by commas (such as 192.168.1.0/24, 192.168.3.0/24); and a text file with one host per line (such as <span class="strong"><em class="calibre4">file:/tmp/hostlist.txt</em></span>). All these options give us quite a bit of flexibility in specifying our targets.</p><p class="calibre2">The <code class="literal">THREADS</code> value at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e1910" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> sets the number of concurrent threads to use while scanning. By default, all scanner modules have their <code class="literal">THREADS</code> value initially set to 1. We can raise this value to speed up our scans or lower it to reduce network traffic. In general, you should not set the <code class="literal">THREADS</code> value greater 16 when running Metasploit on Windows, and not greater than 128 on UNIX-like operating systems.</p><p class="calibre2">Now let’s set our values and run the module. We’ll set the value for <code class="literal">RHOSTS</code> to 192.168.1.0/24, set <code class="literal">THREADS</code> to 50, and then run the scan.<a id="IDX-CHP-3-0064" class="strong"/></p><a id="I_programlisting3_d1e1933" class="strong"/><pre class="programlisting">msf auxiliary(ipidseq) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.0/24</code></strong>
  RHOSTS =&gt; 192.168.1.0/24
  msf auxiliary(ipidseq) &gt; <strong class="calibre3"><code class="calibre6">set THREADS 50</code></strong>
  THREADS =&gt; 50
  msf auxiliary(ipidseq) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

  [*] 192.168.1.1's IPID sequence class: All zeros
  [*] 192.168.1.10's IPID sequence class: Incremental!
  [*] Scanned 030 of 256 hosts (011% complete)
  [*] 192.168.1.116's IPID sequence class: All zeros
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [*] 192.168.1.109's IPID sequence class: Incremental!
  [*] Scanned 128 of 256 hosts (050% complete)
  [*] 192.168.1.154's IPID sequence class: Incremental!
  [*] 192.168.1.155's IPID sequence class: Incremental!
  [*] Scanned 155 of 256 hosts (060% complete)
  [*] 192.168.1.180's IPID sequence class: All zeros
  [*] 192.168.1.181's IPID sequence class: Incremental!
  [*] 192.168.1.185's IPID sequence class: All zeros
  [*] 192.168.1.184's IPID sequence class: Randomized
  [*] Scanned 232 of 256 hosts (090% complete)
  [*] Scanned 256 of 256 hosts (100% complete)
  [*] Auxiliary module execution completed
  msf auxiliary(ipidseq) &gt;</pre><p class="calibre2">Judging by the results of our scan, we see a number of potential idle hosts that we can use to perform idle scanning. We’ll try scanning a host using the system at 192.168.1.109 shown at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e1952" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> by using the <code class="literal">-sI</code> command line flag to specify the idle host:<a id="IDX-CHP-3-0065" class="strong"/></p><a id="I_programlisting3_d1e1966" class="strong"/><pre class="programlisting">msf auxiliary(ipidseq) &gt; <strong class="calibre3"><code class="calibre6">nmap -PN -sI 192.168.1.109 192.168.1.155</code></strong>
[*] exec: nmap -PN -sI 192.168.1.109 192.168.1.155

Idle scan using zombie 192.168.1.109 (192.168.1.109:80); Class: Incremental
Interesting ports on 192.168.1.155:
Not shown: 996 closed|filtered ports
PORT    STATE SERVICE
135/tcp open  msrpc
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 00:0C:29:E4:59:7C (VMware)
Nmap done: 1 IP address (1 host up) scanned in 7.12 seconds
msf auxiliary(ipidseq) &gt;</pre><p class="calibre2">By using the idle host, we were able to discover a number of open ports on our target system without sending a single packet to the system.</p></div><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="running_nmap_from_msfconsole">Running Nmap from MSFconsole</h4></div></div></div><p class="calibre2">Now that we’ve performed advanced enumeration on our target, let’s connect <span class="strong"><em class="calibre4">nmap</em></span> with Metasploit. To do this, we first connect to the <span class="strong"><em class="calibre4">msfbook</em></span> database:<a id="IDX-CHP-3-0066" class="strong"/><a id="IDX-CHP-3-0067" class="strong"/><a id="IDX-CHP-3-0068" class="strong"/><a id="IDX-CHP-3-0069" class="strong"/></p><a id="I_programlisting3_d1e2000" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_connect postgres:toor@127.0.0.1/msf3</code></strong></pre><p class="calibre2">Now we should be able to enter the <code class="literal">db_nmap</code> command from within <span class="strong"><em class="calibre4">msfconsole</em></span> to run <span class="strong"><em class="calibre4">nmap</em></span> and have its results automatically stored in our new database.</p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">We’ll be attacking only one system in this instance, but you can specify IPs by CIDR notation and even ranges (for example, 192.168.1.1/24 or 192.168.1.1–254).</p></div><div class="book"><hr class="calibre5"/></div><a id="I_programlisting3_d1e2018" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_nmap -sS -A 172.16.32.131</code></strong>

Warning: Traceroute does not support idle or connect scan, disabling...
Nmap scan report for 172.16.32.131
Host is up (0.00056s latency).
Not shown: 990 closed ports
PORT     STATE SERVICE       VERSION
21/tcp <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>open  ftp           Microsoft ftpd
25/tcp   open  smtp          Microsoft ESMTP 6.0.2600.2180 <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>
80/tcp   open  http          Microsoft IIS webserver 5.1
|_html-title:
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn
443/tcp  open  https?
445/tcp  open  microsoft-ds  Microsoft Windows XP microsoft-ds
1025/tcp open  msrpc         Microsoft Windows RPC
1433/tcp open  ms-sql-s      Microsoft SQL Server 2005 9.00.1399; RTM
3389/tcp open  microsoft-rdp Microsoft Terminal Service
MAC Address: 00:0C:29:EA:26:7C (VMware)
Device type: general purpose
Running: Microsoft Windows XP|2003 <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>
OS details: Microsoft Windows XP Professional SP2 or Windows Server 2003
Network Distance: 1 hop
Service Info: Host: ihazsecurity; OS: Windows

Host script results:
|_nbstat: NetBIOS name: IHAZSECURITY, NetBIOS user:
 &lt;unknown&gt;, NetBIOS MAC: 00:0c:29:ea:26:7c
| smb-os-discovery:
|   OS: Windows XP (Windows 2000 LAN Manager)
|   Name: WORKGROUP\IHAZSECURITY
|_smbv2-enabled: Server doesn't support SMBv2 protocol

OS and Service detection performed. Please report any
 incorrect results at http://nmap.org/submit/.
Nmap done: 1 IP address (1 host up) scanned in 33.51 seconds</pre><p class="calibre2">Notice a series of open ports <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2043" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, software versions <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2049" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, and even a prediction about the target’s operating system <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2055" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>.</p><p class="calibre2">To check that the results from the scan are stored in the database, we run <code class="literal">db_services</code>:<a id="IDX-CHP-3-0070" class="strong"/><a id="IDX-CHP-3-0071" class="strong"/><a id="IDX-CHP-3-0072" class="strong"/><a id="IDX-CHP-3-0073" class="strong"/><a id="IDX-CHP-3-0074" class="strong"/><a id="IDX-CHP-3-0075" class="strong"/></p><a id="I_programlisting3_d1e2086" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_services</code></strong>
Services
========

host            port   proto  name          state  info
----            ----   -----  ----          -----  ----
172.16.32.131   135    tcp   msrpc         open   Microsoft Windows RPC
172.16.32.131   139    tcp   netbios-ssn   open
172.16.32.131   445    tcp   microsoft-ds  open   Microsoft Windows XP microsoft-ds
172.16.32.131   777    tcp   unknown       open
172.16.32.131   1433   tcp   ms-sql-s      open   Microsoft
 SQL Server 2005 9.00.1399; RTM</pre><p class="calibre2">We’re beginning to develop a picture of our target and exposed ports for use as potential attack vectors.</p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="port_scanning_with_metasploit">Port Scanning with Metasploit</h3></div></div></div><p class="calibre2">In addition to its ability to use third-party scanners, Metasploit has several port scanners built into its auxiliary modules that directly integrate with most aspects of the Framework. In later chapters, we’ll use these port scanners to leverage compromised systems to access and attack; his process, often called <span class="strong"><em class="calibre4">pivoting</em></span>, allows us to use internally connected systems to route traffic to a network that would otherwise be inaccessible.</p><p class="calibre2">For example, suppose you compromise a system behind a firewall that is using Network Address Translation (NAT). The system behind the NAT-based firewall uses private IP addresses, which you cannot contact directly from the Internet. If you use Metasploit to compromise a system behind a NAT, you might be able to use that compromised internal system to pass traffic (pivot) to internally hosted and private IP-based systems to penetrate the network farther behind the firewall.<a id="IDX-CHP-3-0076" class="strong"/></p><p class="calibre2">To see the list of port scanning tools that the Framework offers, enter the following:</p><a id="I_programlisting3_d1e2108" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">search portscan</code></strong></pre><p class="calibre2">Let’s conduct a simple scan of a single host using Metasploit’s SYN Port Scanner. In the following listing, we start the scan with <code class="literal">use scanner/portscan/syn</code>, set <code class="literal">RHOSTS</code> to 192.168.1.155, set <code class="literal">THREADS</code> to 50, and then run the scan.<a id="IDX-CHP-3-0077" class="strong"/></p><a id="I_programlisting3_d1e2126" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use scanner/portscan/syn</code></strong>
  msf auxiliary(syn) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.155</code></strong>
  RHOSTS =&gt; 192.168.1.155
  msf auxiliary(syn) &gt; <strong class="calibre3"><code class="calibre6">set THREADS 50</code></strong>
  THREADS =&gt; 50
  msf auxiliary(syn) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [*]  TCP OPEN 192.168.1.155:135
  [*]  TCP OPEN 192.168.1.155:139
  [*]  TCP OPEN 192.168.1.155:445
  [*] Scanned 1 of 1 hosts (100% complete)
  [*] Auxiliary module execution completed
  msf auxiliary(syn) &gt;</pre><p class="calibre2">From the results, you can see at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2148" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> that ports 135, 139, and 445 are open on IP address 192.168.1.155, leveraging the <span class="strong"><em class="calibre4">portscan syn</em></span> module within Metasploit.<a id="IDX-CHP-3-0078" class="strong"/><a id="IDX-CHP-3-0079" class="strong"/><a id="IDX-CHP-3-0080" class="strong"/><a id="IDX-CHP-3-0081" class="strong"/><a id="IDX-CHP-3-0082" class="strong"/><a id="IDX-CHP-3-0083" class="strong"/><a id="IDX-CHP-3-0084" class="strong"/><a id="IDX-CHP-3-0085" class="strong"/></p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="targeted_scanning">Targeted Scanning</h2></div></div></div><p class="calibre2">When you are conducting a penetration test, there is no shame in looking for an easy win. A <span class="strong"><em class="calibre4">targeted scan</em></span> looks for specific operating systems, services, program versions, or configurations that are known to be exploitable and that provide an easy door into a target network. For example, it is common to scan a target network quickly for the vulnerability MS08-067, as this is (still) an extremely common hole that will give you SYSTEM access much more quickly than scanning an entire target network for vulnerabilities.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="server_message_block_scanning">Server Message Block Scanning</h3></div></div></div><p class="calibre2">Metasploit can scour a network and attempt to identify versions of Microsoft Windows using its <span class="strong"><em class="calibre4">smb_version</em></span> module.</p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">If you are not familiar with Server Message Block (SMB, a common file-sharing protocol), study up a bit on the different protocols and their purposes before you continue. You will need to understand basic port information to learn how to attack a system successfully.</p></div><div class="book"><hr class="calibre5"/></div><p class="calibre2">We run the module, list our options, set <code class="literal">RHOSTS</code>, and begin scanning:</p><a id="I_programlisting3_d1e2216" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use scanner/smb/smb_version</code></strong>
  msf auxiliary(smb_version) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

  Module options:

     Name     Current Setting  Required  Description
     ----     ---------------  --------  -----------
     RHOSTS                    yes       The target address range or CIDR identifier
     THREADS  1                yes       The number of concurrent threads

  msf auxiliary(smb_version) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.155</code></strong>
  RHOSTS =&gt; 192.168.1.155
  msf auxiliary(smb_version) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [*] 192.168.1.155 is running Windows XP Service Pack 2 (language: English)
      (name:DOOKIE-FA154354) (domain:WORKGROUP)
  [*] Scanned 1 of 1 hosts (100% complete)
  [*] Auxiliary module execution completed</pre><p class="calibre2">As you can see at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2238" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> the <code class="literal">smb_version</code> scanner has pinpointed the operating system as Windows XP with Service Pack 2. Because we are scanning only one system, we leave <code class="literal">THREADS</code> set to 1. If we had been scanning a number of systems, such as a class C subnet range, we might consider upping the <code class="literal">THREADS</code> using the <code class="literal">set THREADS</code> <em class="calibre4"><code class="calibre9">number</code></em> option. The results of this scan are stored in the Metasploit database for use at a later time and to be accessed with the <code class="literal">db_hosts</code> command.<a id="IDX-CHP-3-0086" class="strong"/><a id="IDX-CHP-3-0087" class="strong"/><a id="IDX-CHP-3-0088" class="strong"/><a id="IDX-CHP-3-0089" class="strong"/><a id="IDX-CHP-3-0090" class="strong"/><a id="IDX-CHP-3-0091" class="strong"/><a id="IDX-CHP-3-0092" class="strong"/><a id="IDX-CHP-3-0093" class="strong"/><a id="IDX-CHP-3-0094" class="strong"/><a id="IDX-CHP-3-0095" class="strong"/><a id="IDX-CHP-3-0096" class="strong"/><a id="IDX-CHP-3-0097" class="strong"/></p><a id="I_programlisting3_d1e2316" class="strong"/><pre class="programlisting">msf auxiliary(smb_version) &gt; <strong class="calibre3"><code class="calibre6">db_hosts -c address,os_flavor</code></strong>

Hosts
=====

address        os_flavor   Svcs  Vulns  Workspace
-------        ---------   ----  -----  ---------
192.168.1.155  Windows XP  3     0      default
msf auxiliary(smb_version) &gt;</pre><p class="calibre2">We have discovered a system running Windows XP without having to do a full scan of the network. This is a great way to target hosts quickly and quietly that are likely to be more vulnerable when our goal is avoid being noticed.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="hunting_for_poorly_configured_microsoft">Hunting for Poorly Configured Microsoft SQL Servers</h3></div></div></div><p class="calibre2">Poorly configured Microsoft SQL Server (MS SQL) installations often provide an initial way into a target network. In fact, many system administrators don’t even realize that they have MS SQL servers installed on their workstations at all, because the service is installed as a prerequisite for some common software, such as Microsoft Visual Studio. These installations are often unused, unpatched, or never even configured.</p><p class="calibre2">When MS SQL is installed, it listens by default either on TCP port 1433 or on a random dynamic TCP port. If MS SQL is listening on a dynamic port, simply query UDP port 1434 to discover on what dynamic TCP port MS SQL is listening. Of course, Metasploit has a module that can make use of this “feature”: <span class="strong"><em class="calibre4">mssql_ping</em></span>.<a id="IDX-CHP-3-0098" class="strong"/><a id="IDX-CHP-3-0099" class="strong"/></p><p class="calibre2">Because <span class="strong"><em class="calibre4">mssql_ping</em></span> uses UDP, it can be quite slow to run across entire subnets because of issues with timeouts. But on a local LAN, setting <code class="literal">THREADS</code> to 255 will greatly speed up the scan. As Metasploit finds MS SQL servers, it displays all the details it can extract from them including, perhaps most importantly, the TCP port on which the server is listening.</p><p class="calibre2">Here’s how you might run an <span class="strong"><em class="calibre4">mssql_ping</em></span> scan, which includes starting the scan, listing and setting options, and the results.</p><a id="I_programlisting3_d1e2356" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use scanner/mssql/mssql_ping</code></strong>
  msf auxiliary(mssql_ping) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

  Module options:

     Name       Current Setting  Required  Description
     ----       ---------------  --------  -----------
     PASSWORD                    no        The password for the specified username
     RHOSTS                      yes       The target address range or CIDR identifier
     THREADS    1                yes       The number of concurrent threads
     USERNAME   sa               no        The username to authenticate as
     WORKSPACE                   no        The name of the
 workspace to report data into

  msf auxiliary(mssql_ping) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.0/24</code></strong>
  RHOSTS =&gt; 192.168.1.0/24
  msf auxiliary(mssql_ping) &gt; <strong class="calibre3"><code class="calibre6">set THREADS 255</code></strong>
  THREADS =&gt; 255
  msf auxiliary(mssql_ping) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [*] SQL Server information for 192.168.1.155:
  [*]    ServerName      = V-XPSP2-BARE
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> [*]    InstanceName    = SQLEXPRESS
  [*]    IsClustered     = No
<img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/> [*]    Version         = 10.0.1600.22
<img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/> [*]    tcp             = 1433</pre><p class="calibre2">As you can see, not only does the scanner locate a MS SQL server at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2400" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, but it also identifies the instance name at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2406" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>, the SQL server version at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2412" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, and the TCP port number at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2418" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> on which it is listening. Just think of how much time this targeted scan for SQL servers would save over running <span class="strong"><em class="calibre4">nmap</em></span> against all ports on all machines in a target subnet in search of the elusive TCP port.<a id="IDX-CHP-3-0100" class="strong"/><a id="IDX-CHP-3-0101" class="strong"/><a id="IDX-CHP-3-0102" class="strong"/><a id="IDX-CHP-3-0103" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="ssh_server_scanning">SSH Server Scanning</h3></div></div></div><p class="calibre2">If during your scanning you encounter machines running Secure Shell (SSH), you should determine which version is running on the target. SSH is a secure protocol, but vulnerabilities in various implementations have been identified. You never know when you might get lucky and come across an old machine that hasn’t been updated. You can use the Framework’s <span class="strong"><em class="calibre4">ssh_version</em></span> module to determine the SSH version running on the target server.<a id="IDX-CHP-3-0104" class="strong"/></p><a id="I_programlisting3_d1e2457" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use scanner/ssh/ssh_version</code></strong>
msf auxiliary(ssh_version) &gt; <strong class="calibre3"><code class="calibre6">set THREADS 50</code></strong>
THREADS =&gt; 50
msf auxiliary(ssh_version) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

[*] 192.168.1.1:22, SSH server version: SSH-2.0-dropbear_0.52
[*] Scanned 044 of 256 hosts (017% complete)
[*] 192.168.1.101:22, SSH server version: SSH-2.0-OpenSSH_5.1p1 Debian-3ubuntu1
[*] Scanned 100 of 256 hosts (039% complete)
[*] 192.168.1.153:22, SSH server version: SSH-2.0-OpenSSH_4.3p2 Debian-8ubuntu1
[*] 192.168.1.185:22, SSH server version: SSH-2.0-OpenSSH_4.3</pre><p class="calibre2">This output tells us that a few different servers are running with various patch levels. This information could prove useful if, for example, we wanted to attack a specific version of OpenSSH as found with the <span class="strong"><em class="calibre4">ssh_version</em></span> scan.<a id="IDX-CHP-3-0105" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="ftp_scanning">FTP Scanning</h3></div></div></div><p class="calibre2">FTP is a complicated and insecure protocol. FTP servers are often the easiest way into a target network, and you should always scan for, identify, and fingerprint any FTP servers running on your target.<a id="IDX-CHP-3-0106" class="strong"/><a id="IDX-CHP-3-0107" class="strong"/><a id="IDX-CHP-3-0108" class="strong"/><a id="IDX-CHP-3-0109" class="strong"/><a id="IDX-CHP-3-0110" class="strong"/><a id="IDX-CHP-3-0111" class="strong"/><a id="IDX-CHP-3-0112" class="strong"/><a id="IDX-CHP-3-0113" class="strong"/><a id="IDX-CHP-3-0114" class="strong"/></p><p class="calibre2">Next, we scan our XP box for FTP services using the Framework’s <span class="strong"><em class="calibre4">ftp_version</em></span> module:</p><a id="I_programlisting3_d1e2523" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use scanner/ftp/ftp_version</code></strong>
  msf auxiliary(ftp_version) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

  Module options:

     Name       Current Setting      Required  Description
     ----       ---------------      --------  -----------
     FTPPASS    mozilla@example.com  no        The password for the specified username
     FTPUSER    anonymous            no        The username to authenticate as
     RHOSTS                          yes       The target
 address range or CIDR identifier
     RPORT      21                   yes       The target port
     THREADS    1                    yes       The number of concurrent threads
     WORKSPACE                       no        The name of
 the workspace to report data into

  msf auxiliary(ftp_version) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.0/24</code></strong>
  RHOSTS =&gt; 192.168.1.0/24
  msf auxiliary(ftp_version) &gt; <strong class="calibre3"><code class="calibre6">set THREADS 255</code></strong>
  THREADS =&gt; 255
  msf auxiliary(ftp_version) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [*] 192.168.1.155:21 FTP Banner: Minftpd ready</pre><p class="calibre2">The scanner successfully identifies an FTP server at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2549" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>. Now let’s see if this FTP server allows anonymous logins using the Framework’s <span class="strong"><em class="calibre4">scanner/ftp/anonymous</em></span>.</p><a id="I_programlisting3_d1e2558" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use auxiliary/scanner/ftp/anonymous</code></strong>
  msf auxiliary(anonymous) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.0/24</code></strong>
  RHOSTS =&gt; 192.168.1.0/24
  msf auxiliary(anonymous) &gt; <strong class="calibre3"><code class="calibre6">set THREADS 50</code></strong>
  THREADS =&gt; 50
  msf auxiliary(anonymous) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

  [*] Scanned 045 of 256 hosts (017% complete)
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [*] 192.168.1.155:21 Anonymous READ/WRITE (220 Minftpd ready)</pre><p class="calibre2">The scanner reports at <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2580" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> that anonymous access is allowed and that anonymous users have both read and write access to the server; in other words, we have full access to the remote system and the ability to upload or download any file that can be accessed by the FTP server software.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="simple_network_management_protocol_sweep">Simple Network Management Protocol Sweeping</h3></div></div></div><p class="calibre2">The Simple Network Management Protocol (SNMP) is typically used in network devices to report information such as bandwidth utilization, collision rates, and other information. However, some operating systems also have SNMP servers that can provide information such as CPU utilization, free memory, and other system-specific details.<a id="IDX-CHP-3-0115" class="strong"/><a id="IDX-CHP-3-0116" class="strong"/><a id="IDX-CHP-3-0117" class="strong"/><a id="IDX-CHP-3-0118" class="strong"/><a id="IDX-CHP-3-0119" class="strong"/><a id="IDX-CHP-3-0120" class="strong"/><a id="IDX-CHP-3-0121" class="strong"/><a id="IDX-CHP-3-0122" class="strong"/><a id="IDX-CHP-3-0123" class="strong"/></p><p class="calibre2">Convenience for the system administrator can be a gold mine for the penetration tester, and accessible SNMP servers can offer considerable information about a specific system or even make it possible to compromise a remote device. If, for instance, you can get the read/write SNMP community string for a Cisco router, you can download the router’s entire configuration, modify it, and upload it back to the router.</p><p class="calibre2">The Metasploit Framework includes a built-in auxiliary module called <span class="strong"><em class="calibre4">scanner/snmp/snmp_enum</em></span> that is designed specifically for SNMP sweeps. Before you start the scan, keep in mind that the read-only (RO) and read/write (RW) community strings will play an important role in the type of information you will be able to extract from a given device. On Windows-based devices configured with SNMP, you can often use the RO or RW community strings to extract patch levels, running services, usernames, uptime, routes, and other information that can make things much easier for you during a pen test. (<span class="strong"><em class="calibre4">Community strings</em></span> are essentially passwords used to query a device for information or to write configuration information to the device.)<a id="IDX-CHP-3-0124" class="strong"/><a id="IDX-CHP-3-0125" class="strong"/></p><p class="calibre2">After you guess the community strings, SNMP itself (depending on the version) can allow anything from excessive information disclosure to full system compromise. SNMPv1 and v2 are inherently flawed protocols. SNMPv3, which incorporates encryption and better check mechanisms, is significantly more secure. To gain access to a switch, you’ll first need to attempt to find its community strings. The Framework’s <span class="strong"><em class="calibre4">use scanner/snmp/snmp_login</em></span> module will try a word list against one or a range of IP addresses.</p><a id="I_programlisting3_d1e2645" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use use scanner/snmp/snmp_login</code></strong>
  msf auxiliary(snmp_login) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.0/24</code></strong>
  RHOSTS =&gt; 192.168.1.0/24
  msf auxiliary(snmp_login) &gt; <strong class="calibre3"><code class="calibre6">set THREADS 50</code></strong>
  THREADS =&gt; 50
  msf auxiliary(snmp_login) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

  [*] &gt;&gt; progress (192.168.1.0-192.168.1.255) 0/30208...
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [*] 192.168.1.2 'public' '<strong class="calibre3"><code class="calibre6">GSM7224</code></strong> L2 Managed Gigabit Switch'
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> [*] 192.168.1.2 'private' 'GSM7224 L2 Managed Gigabit Switch'
  [*] Auxiliary module execution completed
  msf auxiliary(snmp_login) &gt;</pre><p class="calibre2">A quick Google search for <span class="strong"><em class="calibre4">GSM7224</em></span> from the output tells us that the scanner has found both the public <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2680" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and private <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2686" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> community strings for a Netgear switch. This result, believe it or not, has not been staged for this book. These are the default factory settings for this switch.<a id="IDX-CHP-3-0126" class="strong"/></p><p class="calibre2">You will encounter many jaw-dropping situations like these throughout your pen testing career, because many administrators simply attach devices to a network with all their defaults still in place. The situation is even scarier when you find these devices accessible from the Internet within a large corporation.<a id="IDX-CHP-3-0127" class="strong"/><a id="IDX-CHP-3-0128" class="strong"/><a id="IDX-CHP-3-0129" class="strong"/><a id="IDX-CHP-3-0130" class="strong"/><a id="IDX-CHP-3-0131" class="strong"/><a id="IDX-CHP-3-0132" class="strong"/><a id="IDX-CHP-3-0133" class="strong"/><a id="IDX-CHP-3-0134" class="strong"/><a id="IDX-CHP-3-0135" class="strong"/></p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="writing_a_custom_scanner">Writing a Custom Scanner</h2></div></div></div><p class="calibre2">Many applications and services lack custom modules in Metasploit. Thankfully, the Framework has many features that can be useful when you’re building a custom scanner, including offering access to all of its exploit classes and methods, and support for proxies, Secure Sockets Layer (SSL), reporting, and threading. It can be very useful to write your own scanner during security assessments, because doing so will allow you to locate every instance of a bad password or unpatched service quickly on a target system.<a id="IDX-CHP-3-0136" class="strong"/></p><p class="calibre2">The Metasploit Framework scanner modules include various mixins, such as exploit mixins for TCP, SMB, and so on, and the auxiliary <code class="literal">scanner</code> mixin that is built into the Framework. <span class="strong"><em class="calibre4">Mixins</em></span> are portions of code with predefined functions and calls that are preconfigured for you. The <code class="literal">Auxiliary::Scanner</code> mixin overloads the Auxiliary <code class="literal">run</code> method; calls the module method at runtime with <code class="literal">run_host(ip)</code>, <code class="literal">run_range(range)</code>, or <code class="literal">run_batch(batch)</code>; and then processes the IP addresses. We can leverage <code class="literal">Auxiliary::Scanner</code> to call additional, built-in Metasploit functionality.<a id="IDX-CHP-3-0137" class="strong"/><a id="IDX-CHP-3-0138" class="strong"/></p><p class="calibre2">Following is a Ruby script for a simple TCP scanner that will connect to a remote host on a default port of 12345 and upon connecting, send “HELLO SERVER,” receive the server response, and print it out along with the server’s IP address.</p><a id="I_programlisting3_d1e2771" class="strong"/><pre class="programlisting">#<strong class="calibre3"><code class="calibre6">Metasploit</code></strong>
require 'msf/core'
class Metasploit3 &lt; Msf::Auxiliary
      <img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>include Msf::Exploit::Remote::Tcp
      <img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/>include Msf::Auxiliary::Scanner
        def initialize
                super(
                        'Name'           =&gt; 'My custom TCP scan',
                        'Version'        =&gt; '$Revision: 1 $',
                        'Description'    =&gt; 'My quick scanner',
                        'Author'         =&gt; 'Your name here',
                        'License'        =&gt; MSF_LICENSE
                )
                register_options(
                        [
                                <img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre7"/>Opt::RPORT(12345)
                        ], self.class)
        end

        def run_host(ip)
                connect()
              <img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre7"/>sock.puts('HELLO SERVER')
                data = sock.recv(1024)
              <img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre7"/>print_status("Received: #{data} from #{ip}")
                disconnect()
        end
end</pre><p class="calibre2">This simple scanner uses the <code class="literal">Msf::Exploit::Remote::Tcp</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2812" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> mixin to handle the TCP networking, and the <code class="literal">Msf::Auxiliary::Scanner</code> mixin exposes the various settings that are required for scanners within the Framework <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2821" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. This scanner is configured to use the default port of 12345 <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2827" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span>, and upon connecting to the server, it sends a message <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2834" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span>, receives the reply from the server, and then prints it out to the screen along with the server IP address <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e2840" class="strong"/><img src="../images/00007.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867468.png" class="calibre8"/></span>.<a id="IDX-CHP-3-0139" class="strong"/><a id="IDX-CHP-3-0140" class="strong"/><a id="IDX-CHP-3-0141" class="strong"/><a id="IDX-CHP-3-0142" class="strong"/><a id="IDX-CHP-3-0143" class="strong"/></p><p class="calibre2">We have saved this custom script under <span class="strong"><em class="calibre4">modules/auxiliary/scanner/</em></span> as <span class="strong"><em class="calibre4">simple_tcp.rb</em></span>. The saved location is important in Metasploit. For example, if the module is saved under <span class="strong"><em class="calibre4">modules/auxiliary/scanner/http/</em></span>, it would show up in the modules list as <span class="strong"><em class="calibre4">scanner/http/simple_tcp</em></span>.</p><p class="calibre2">To test this rudimentary scanner, we set up a <span class="strong"><em class="calibre4">netcat</em></span> listener on port 12345 and pipe in a text file to act as the server response.</p><a id="I_programlisting3_d1e2880" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">echo "Hello Metasploit" &gt; banner.txt</code></strong>
root@bt:/# <strong class="calibre3"><code class="calibre6">nc -lvnp 12345 &lt; banner.txt</code></strong>
listening on [any] 12345...</pre><p class="calibre2">Next, we load up <span class="strong"><em class="calibre4">msfconsole</em></span>, select our scanner module, set its parameters, and run it to see if it works.<a id="IDX-CHP-3-0144" class="strong"/></p><a id="I_programlisting3_d1e2896" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use auxiliary/scanner/simple_tcp</code></strong>
msf auxiliary(simple_tcp) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

Module options:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       The target address range or CIDR identifier
   RPORT    12345            yes       The target port
   THREADS  1                yes       The number of concurrent threads

msf auxiliary(simple_tcp) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.101</code></strong>
RHOSTS =&gt; 192.168.1.101
msf auxiliary(simple_tcp) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

[*] Received: Hello Metasploit from 192.168.1.101
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf auxiliary(simple_tcp) &gt;</pre><p class="calibre2">Although this is only a simple example, the level of versatility afforded by the Metasploit Framework can be of great assistance when you need to get some custom code up and running quickly in the middle of a pen test. Hopefully, this simple example demonstrates the power of the Framework and modular code. But, of course, you don’t have to do everything by hand.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="looking_ahead">Looking Ahead</h2></div></div></div><p class="calibre2">In this chapter, you learned how to leverage the Metasploit Framework for intelligence gathering, as outlined in the PTES. Intelligence gathering takes practice and requires a deep understanding of how an organization operates and how to identify the best potential attack vectors. As with anything, you should adapt and improve your own methodologies throughout your penetration-testing career. Just remember that your main focus for this phase is to learn about the organization you’re attacking and its overall footprint. Regardless of whether your work occurs over the Internet, on an internal network, wirelessly, or via social engineering, the goals of intelligence gathering will always be the same.</p><p class="calibre2">In the next chapter, we’ll move on to another important step during the vulnerability analysis phase: automated vulnerability scanning. In later chapters, we will explore more in-depth examples of how to create your own modules, exploits, and Meterpreter scripts.</p></div></section></body></html>