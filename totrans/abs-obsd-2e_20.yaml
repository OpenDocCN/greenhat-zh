- en: Chapter 20. Upgrading
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '*The latest source code?*'
  prefs: []
  type: TYPE_NORMAL
- en: '*Fugu extraordinary!*'
  prefs: []
  type: TYPE_NORMAL
- en: '*Be brave and swallow.*'
  prefs: []
  type: TYPE_NORMAL
- en: '![](httpatomoreillycomsourcenostarchimages1616079.png) Here’s an ugly truth:
    If upgrades are hard, sysadmins try their best to avoid them. And that can cause
    security problems. Operating system upgrades can cause software that has worked
    well for years to develop nervous tics or stop working altogether. Fixing add-on
    packages that don’t work on the new operating system version can require days
    of troubleshooting. Server upgrades can make even seasoned sysadmins wish that
    they had a simpler job, such as performing as a carnival sideshow, stuffing weasels
    into their trousers.'
  prefs: []
  type: TYPE_NORMAL
- en: While you can probably deal with a bit of odd behavior in a desktop after an
    upgrade, your servers and firewalls must behave exactly as expected. It’s common
    to delay upgrades until the system is so old that it can be replaced with a new
    machine running the new release, but that’s both terrible system administration
    practice and completely unacceptable security practice. Computers connected to
    the Internet must be patched, maintained, and upgraded, or an intruder will almost
    certainly compromise them.
  prefs: []
  type: TYPE_NORMAL
- en: Fortunately, the OpenBSD upgrade process is simpler than those used by many
    other Unix-like operating systems. With proper preparation, you can upgrade OpenBSD
    with a minimum of difficulty.
  prefs: []
  type: TYPE_NORMAL
- en: Why Upgrade?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Because you don’t have a choice.
  prefs: []
  type: TYPE_NORMAL
- en: Security researchers, programmers, and skilled intruders continuously discover
    new ways to penetrate previously secure systems. Although OpenBSD has suffered
    only two vulnerabilities in a default installation that permitted an intruder
    to compromise the system, that doesn’t mean that a two-year-old OpenBSD version
    is secure.
  prefs: []
  type: TYPE_NORMAL
- en: The OpenBSD Project provides security updates for only the two most recent releases.
    For example, when OpenBSD 5.3 comes out, OpenBSD 5.1 will be “end-of-lifed” and
    lose support from developers. If someone figures out how to break into a default
    OpenBSD 5.1 installation after 5.3 comes out, the developers might not provide
    fixes. You might adjust new security patches to work on older versions of the
    code, but you will find that backporting fixes becomes increasingly difficult.
  prefs: []
  type: TYPE_NORMAL
- en: Software not enabled in the default installation can also have problems. For
    example, in November 2011, the OpenBSD Project released a patch for a problem
    in the included BIND `named(8)` name server. OpenBSD does not ship with `named`
    enabled, so this wasn’t a problem in the default installation, but it was certainly
    a security problem in a function that you might have chosen to enable.
  prefs: []
  type: TYPE_NORMAL
- en: In order to protect your system, you must understand how to apply security patches,
    either by applying the patch or by upgrading the entire system. But before we
    get to the upgrade process itself, let’s look at your choices for OpenBSD versions.
  prefs: []
  type: TYPE_NORMAL
- en: OpenBSD Versions
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Developers all over the world continually make minor changes to OpenBSD’s source
    code. If you download the source code in the morning and again in the afternoon,
    you’ll get two slightly different versions. In fact, at any given time, you can
    get a few different versions of OpenBSD: *-current*, *snapshots*, *releases*,
    and *-stable*.'
  prefs: []
  type: TYPE_NORMAL
- en: OpenBSD-current
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: OpenBSD-current is the most recent development version of OpenBSD, containing
    code that is making its public debut. Developers test each other’s work and then
    get approval to commit code to the tree. Eventually, they must put their work
    out for the public to test, review, and debug.
  prefs: []
  type: TYPE_NORMAL
- en: OpenBSD-current is where the public can access the newest code. If a change
    would temporarily break web servers, games, database servers, or whatever is running
    on -current, but the change is for the long-term good, the change will go into
    -current. Those programs will probably work again before the next OpenBSD release,
    but there’s no requirement that every third-party program work perfectly at all
    times on -current.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The developers expect -current itself to work at all times, and they consider
    breaks serious problems. You might need to recompile Firefox, or the port maintainer
    might need to rewrite a makefile, but the core operating system is expected to
    run at all times.
  prefs: []
  type: TYPE_NORMAL
- en: With these caveats, why would you possibly want to run -current? One excellent
    reason is to test the new OpenBSD in your environment. If today’s -current panics
    under certain conditions, but last week’s didn’t, the OpenBSD folks want to know
    that.
  prefs: []
  type: TYPE_NORMAL
- en: (All the OpenBSD folks run -current on their laptops, and they run firewalls
    on -current.) If you can exercise -current in the real world, with a real workload,
    they want you to do so. Having real users run -current is the only way that OpenBSD
    can be tested before the official releases come out.
  prefs: []
  type: TYPE_NORMAL
- en: OpenBSD Snapshots
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Every few days, the OpenBSD team uploads a release from the latest -current
    code to the mirror servers. This is an interim release called a *snapshot*, which
    is identified only by the date of its release. A snapshot is simply the state
    of -current at a particular time. While the developers try not to build a snapshot
    on a day that -current is notably fouled up, guess who’s in charge of the snapshot
    quality-assurance process. That’s you.
  prefs: []
  type: TYPE_NORMAL
- en: Snapshots are provided for installation and testing convenience. Installing
    and testing a snapshot is easier than building -current on your own. Also, if
    you can reproduce a bug on a specific snapshot, the developers know exactly which
    version of the code you are running. It’s much easier to identify a problem as
    appeared “in the July 15 2013 snapshot” than in a -current you built yourself
    from “code downloaded from server X at about 3:17 PM EST on July 15, 2013.”
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Snapshots can contain uncommitted code not in -current. The patches for the
    changes are not usually available.
  prefs: []
  type: TYPE_NORMAL
- en: You can get snapshots installation media from any mirror site, in the */pub/OpenBSD/snapshots*
    directory. If you want to run -current, the recommended way to start is by installing
    the most recent snapshot you can get your hands on and upgrading from there.
  prefs: []
  type: TYPE_NORMAL
- en: OpenBSD Releases
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Every six months, the pace of OpenBSD development is deliberately slowed. Developers
    spend time polishing new features, and Theo makes increasingly forceful requests
    for beta testers of the newest snapshots. When the OpenBSD team is satisfied that
    the software is of adequate quality, the source code tree is tagged, and a high-quality
    snapshot is built. This snapshot is called a *release* and is issued a number
    like 5.2, 5.3, and so on. This is almost certainly what you installed on your
    first OpenBSD machine. A new release appears every May and November.
  prefs: []
  type: TYPE_NORMAL
- en: OpenBSD numbers releases sequentially, starting with 2.0 and incrementing .1
    with every release. Unlike most software products, a .0 release has no special
    meaning. It’s just another spot along a long path—a milestone hit every five years.
  prefs: []
  type: TYPE_NORMAL
- en: The release is the best-supported version of OpenBSD. Everything is expected
    to work, and the development team stands behind its releases. If a serious security
    problem is discovered in a release, OpenBSD will release a patch, or *errata*,
    for it.
  prefs: []
  type: TYPE_NORMAL
- en: OpenBSD-stable
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: OpenBSD-stable is an OpenBSD release with all errata and very minor patches
    included. The developers deliberately hold the number of changes to each -stable
    version to the absolute bare minimum. A stable version is referred to as its base
    release plus -stable, such as 5.4-stable, 5.5-stable, and so on.
  prefs: []
  type: TYPE_NORMAL
- en: What sort of changes are merged back into -stable? Security fixes and errata
    go in automatically. Other than security issues, any patches added to -stable
    must be simple, short, and obviously correct. Patches that dramatically affect
    a small number of users might go in. For example, if all systems with a specific
    network card panic at random intervals, a patch might go into -stable (accompanied
    by various developers asking why no one with that network card ran snapshots before
    the release).
  prefs: []
  type: TYPE_NORMAL
- en: You won’t get new functions in -stable. It won’t come with any new device drivers
    or packet-filtering features. The API will not change. In general, -stable is
    expected to never get worse.
  prefs: []
  type: TYPE_NORMAL
- en: The only way to get OpenBSD-stable is to update the system from source.
  prefs: []
  type: TYPE_NORMAL
- en: Which Version Should You Use?
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: OpenBSD’s release system combines the best features of open source development
    and commercial releases. Users have access to both the bleeding-edge experimental
    code and the stable, polished releases. Look at your requirements and choose your
    poison.
  prefs: []
  type: TYPE_NORMAL
- en: If you’re running OpenBSD in a production environment, either use a release
    with the applicable security errata or track -stable. The developers encourage
    more experienced users to use snapshots or -current, but that choice is up to
    you.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If you are evaluating OpenBSD for use in a production environment, install the
    version you intend to use.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If you’re just learning about Unix-like systems, or if you want a quiet OpenBSD
    experience, use a release and apply applicable errata.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If you’re an operating system developer or experienced sysadmin, feel free to
    jump right in to -current or snapshots. You can either handle any problems you
    encounter or use those problems as an excuse to expand your knowledge. Many people
    find that they can use -current in production, if they do not need packages. These
    are usually more experienced users who want firewalls.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Hobbyists can run anything they want!
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Remember the limitations of your chosen branch. A release is a good place to
    start, but you can gradually upgrade your system to -stable, and then to -current,
    as your understanding expands. Many developers started out as interested hobbyists.
  prefs: []
  type: TYPE_NORMAL
- en: The OpenBSD Upgrade Process
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'An OpenBSD upgrade has three distinct phases: installing the newer versions
    of the operating system files, updating the local configuration, and updating
    obsolete add-on software packages. Each is a separate part that requires independent
    handling.'
  prefs: []
  type: TYPE_NORMAL
- en: An upgrade requires installation media. The best upgrade media is the new release
    CD or an Internet mirror. You can also upgrade OpenBSD by building and installing
    the source code directly on the machine to be upgraded, but doing so is more difficult
    and risky than upgrading from the official release. Much of the information for
    upgrading from a network or CD applies to upgrading via source code.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: OpenBSD supports upgrading only one major release at a time. You cannot upgrade
    directly from, say, 5.3 to 5.5; you must upgrade from 5.3 to 5.4, and then to
    5.5\. The more releases you need to upgrade through, the more reason to reinstall.
    You would spend more time serially upgrading three or four releases than you would
    reinstalling.
  prefs: []
  type: TYPE_NORMAL
- en: Before upgrading, back up any data you actually care about. The upgrade process
    extracts new files over the existing operating system, and could overwrite something
    important. The installer generally works, but human beings are fallible. Back
    up!
  prefs: []
  type: TYPE_NORMAL
- en: Following the Upgrade Guide
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: As OpenBSD evolves, basic system features change. This wouldn’t be a big issue,
    except when interdependent changes create a chicken-and-egg or bootstrap problem.
    If you just blindly run the upgrade process and don’t handle any other required
    changes, you’ll find that your new system fails in unpredictable ways.^([[42](#ftn.id310014)])
    If you’re building the system from source, these problems might prevent the build
    from completing.
  prefs: []
  type: TYPE_NORMAL
- en: All of these potential problems should be solvable by anyone building the system
    from source, but it’s nice to have them documented. Conveniently, OpenBSD provides
    an *Upgrade Guide* for each release, documenting the steps needed to take a system
    from one release to the next.
  prefs: []
  type: TYPE_NORMAL
- en: The *Upgrade Guide* is divided into chunks by the type of upgrade you are performing.
    The simplest upgrade is for people using official OpenBSD files, such as a network
    or CD upgrade. If you’re building from source, the instructions quickly grow in
    complexity. Follow the instructions in the order in which they appear. Most upgrade
    prerequisites are typical system administration tasks. The following are the most
    common requirements.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Instructions in the *Upgrade Guide* supersede anything I say in this chapter.
    I could just sprinkle the words “unless specified otherwise in the *Upgrade Guide*”
    in every paragraph for the rest of this section, but then my editor would slap
    me. The OpenBSD documentation is the final word in OpenBSD system administration,
    including the upgrade process.
  prefs: []
  type: TYPE_NORMAL
- en: Install Programs
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Especially when you are building from source, bootstrap tools such as `gcc(1)`
    and `perl(1)` might need to be built with the upgraded tool. When upgrading from
    source, you might need to install these bootstrap tools before beginning to compile
    the new version of OpenBSD. The *Upgrade Guide* notes these requirements.
  prefs: []
  type: TYPE_NORMAL
- en: If your attempt to build OpenBSD from source fails, reread the *Upgrade Guide*
    before troubleshooting. Starting from the closest available binary release or
    snapshot will probably solve your problem.
  prefs: []
  type: TYPE_NORMAL
- en: Remove Programs and Files
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: OpenBSD removes programs from the base system when they become obsolete or dangerous,
    or when their functions are integrated into other programs. When you upgrade,
    you must manually remove these programs. This is necessary because old software
    left on an upgraded system can pose a security risk. Also, some files and directories
    might become superfluous in a new OpenBSD version. You can remove these programs,
    files, or directories once the upgrade is complete.
  prefs: []
  type: TYPE_NORMAL
- en: Prepare Package Upgrades
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: When you upgrade OpenBSD, you must upgrade the installed packages as well, because
    you can’t reliably run packages built for old versions of OpenBSD on newer versions.
    (Doing so *might* work, but there’s no guarantee.) The *Upgrade Guide* includes
    notes on upgrading specific installed packages, and you should take some of those
    actions before beginning the upgrade.
  prefs: []
  type: TYPE_NORMAL
- en: For example, the *Upgrade Guide* for the newest OpenBSD version says that the
    PostgreSQL port had a major version upgrade. You must do a database dump and restore
    as part of the upgrade. The old version of PostgreSQL might not run well on the
    new OpenBSD, so perform the database dump before starting the system upgrade.
  prefs: []
  type: TYPE_NORMAL
- en: Your packages might not require any pre-upgrade work, but it’s much easier to
    check beforehand than to finish the operating system upgrade, and then need to
    fall back because you didn’t prepare some third-party package.
  prefs: []
  type: TYPE_NORMAL
- en: System Configuration
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: The preceding tasks are the most common requirements for upgrading, but you
    might need to change other system files before or after the upgrade process itself.
    Read the *Upgrade Guide*, or your programs might not run as expected.
  prefs: []
  type: TYPE_NORMAL
- en: Customizing Upgrades
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The upgrade script supports the *siteXX.tgz* file discussed in [Chapter 23](ch23.html
    "Chapter 23. Customizing OpenBSD"). If the file exists in the installation media,
    you can choose to install it during the upgrade.
  prefs: []
  type: TYPE_NORMAL
- en: You can also run a custom post-upgrade script as part of the upgrade. When the
    upgrade completes, the script checks for the file */upgrade.site*. If the upgrader
    finds this file, it executes this script as the last step of the upgrade. Copy
    */upgrade.site* to the system before starting the upgrade. [Chapter 23](ch23.html
    "Chapter 23. Customizing OpenBSD") discusses *upgrade.site* in more detail.
  prefs: []
  type: TYPE_NORMAL
- en: Upgrading from Official Media
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'After reading the *Upgrade Guide*, get your installation media for the new
    version of OpenBSD and boot from it. If you plan to upgrade over a network, you
    should need only the new installation kernel *bsd.rd*. You can just grab this
    via FTP (or you could grab the entire directory along with it and run the upgrade
    from your local disk). Here, I grab the newest snapshot kernel from my root directory:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: After you get the snapshot kernel, go to your console and boot into the new
    kernel.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: Enter **`U`** to upgrade. The upgrade process looks much like the installation
    process covered in [Chapter 3](ch03.html "Chapter 3. Installation Walk-Through").
    Defaults appear inside square brackets. Accept the defaults by pressing ENTER.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: Always use the default terminal, unless you know exactly when you shouldn’t.
    Commodity hardware usually uses vt220, as shown here at **1**, but the default
    terminal is platform-specific.
  prefs: []
  type: TYPE_NORMAL
- en: The upgrade needs to read your root partition to learn where to install files.
    It can’t conclusively identify your actual root disk **2** and partition **3**
    unless you tell it to do that.
  prefs: []
  type: TYPE_NORMAL
- en: The upgrade script will configure your network according to the existing settings
    that you should hope are correct. If you need to adjust the network at every boot,
    the upgrade script gives you a chance to reconfigure the network at **4**.
  prefs: []
  type: TYPE_NORMAL
- en: If you shut down the machine via `reboot` or `shutdown`, your filesystems should
    be clean. If you unceremoniously pulled the power plug because you were going
    to upgrade the machine and no longer cared about your filesystems, OpenBSD will
    notice and clean your filesystems. To deep-check clean filesystems, you can force
    running `fsck(8)` at **5**. The upgrade script preens clean filesystems to check
    for obvious errors before proceeding.
  prefs: []
  type: TYPE_NORMAL
- en: Upgrading Over the Network
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The default upgrade method is CD. I want to do this upgrade over the network,
    so here’s how I continue:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: I choose `ftp` as the location of the sets at **1**. I don’t need to go through
    a proxy server to access the FTP server, so I leave that space blank at **2**.
  prefs: []
  type: TYPE_NORMAL
- en: The default OpenBSD FTP server is perfectly fine, but if you’ve identified a
    really fast mirror, you might use that. I use my preferred mirror site at **3**.
  prefs: []
  type: TYPE_NORMAL
- en: Every *bsd.rd* installer knows the server directory to install from at **4**.
    I change the server directory only if I have set up a local mirror. Similarly,
    every OpenBSD mirror permits anonymous FTP. I change the username and enter a
    password only if I’m using a local mirror at **5**.
  prefs: []
  type: TYPE_NORMAL
- en: Choosing File Sets
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Next comes a chance to choose which sets to upgrade.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: You must upgrade every file set installed on your machine, or the machine will
    behave unpredictably. If you didn’t install some sets during your original installation,
    you don’t need to install them now. For most machines, I recommend installing
    all sets.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Notice that two sets are missing: *etcXX.tgz* and *xetcXX.tgz*. These files
    belong in */etc* and are legitimately edited by system administrators. The upgrade
    script cannot know if a file should be replaced, edited, or ignored. You must
    update */etc* yourself.'
  prefs: []
  type: TYPE_NORMAL
- en: The upgrade script downloads and extracts the selected file sets, and then asks
    you to verify that you’re finished selecting file sets. If so, it remakes all
    your device nodes to fit with the new kernel.
  prefs: []
  type: TYPE_NORMAL
- en: At this point, you can reboot into your new OpenBSD userland except that userland
    might not work quite right because you haven’t updated */etc* yet.
  prefs: []
  type: TYPE_NORMAL
- en: Updating /etc
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The */etc* directory contains system and program configuration information.
    When a program changes, its configuration file might also change. If you try to
    run a new program with an obsolete configuration file, the program will not run
    correctly.
  prefs: []
  type: TYPE_NORMAL
- en: You absolutely must update */etc* before running your system—arguably the most
    annoying part of an upgrade. No automated process can possible know how your system
    should behave. Only you can know that, which means that you must compare the contents
    of your existing */etc* to the same files in a new, stock */etc*. OpenBSD provides
    tools to make the process less annoying.
  prefs: []
  type: TYPE_NORMAL
- en: Before you begin, if your system performs complicated functions, such as a database
    or packet filtering, boot into single-user mode. (Although single-user mode is
    not strictly necessary, I’ve had software behave badly during a half-completed
    upgrade, so I now routinely update */etc* in single-user mode.)
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: While I’m a long-time `tcsh` user,^([[43](#ftn.id427066)]) I always use the
    default shell in single-user mode. If you want to use an alternate shell, it must
    be statically linked and available on the root partition.
  prefs: []
  type: TYPE_NORMAL
- en: Mounting Filesystems
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Now mount all your filesystems. If you upgraded via the network, start the network
    now.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: I’ve hardly begun, and here’s a warning already. How fantastic! Perhaps this
    IPv6 error is from the upgrade, or maybe it’s a lingering misconfiguration I never
    noticed before. Either way, this is a good time to identify and fix the problem.
  prefs: []
  type: TYPE_NORMAL
- en: Verify that you’re on the network by pinging a couple of hosts.
  prefs: []
  type: TYPE_NORMAL
- en: You need the files *etcXX.tgz* and *xetcXX.tgz* for your new release. If you
    have the CD, the files are in the release directory. If not, fetch them over the
    network. (I always get these file sets from the same server I upgraded from, just
    to eliminate any chance of a difference in the files.)
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: You are now ready to update */etc*.
  prefs: []
  type: TYPE_NORMAL
- en: Using sysmerge(8) to Compare /etc Files
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The `sysmerge(8)` program compares your existing */etc* to the */etc* in the
    installation set, points out differences, and lets you replace your installed
    file with the new one, keep your file, or merge the two.
  prefs: []
  type: TYPE_NORMAL
- en: Use `-s` to tell `sysmerge` where the new *etcXX.tgz* file is, and `-x` to point
    to the new *xetcXX.tgz*. I put both of these files in */tmp*.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: '`sysmerge` will handle the easy changes itself, but leave you to take care
    of files that need your intervention.'
  prefs: []
  type: TYPE_NORMAL
- en: Easy sysmerge Updates
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'If your system is only lightly modified, you should see something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: I haven’t changed these files, so `sysmerge` automatically updates them for
    me.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: I didn’t have these files on my system, so `sysmerge` installs them for me.
  prefs: []
  type: TYPE_NORMAL
- en: These examples are easy cases. In cases where you’ve edited an */etc* file,
    `sysmerge` will need your help.
  prefs: []
  type: TYPE_NORMAL
- en: sysmerge and Edited Files
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Say you’ve edited a file, and the file version has changed. Does your local
    change reflect the update, does it conflict, or can the two coexist? `sysmerge`
    can’t tell if it should overwrite the installed file with a new version, leave
    it unchanged, or merge the two, so it displays the differences between the old
    and new files.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: If you’ve changed the file, `sysmerge` presents the differences between the
    old and new files with a few surrounding lines of context. In this example, the
    */etc/mail/aliases* file on my system is dated June 9 at **1**, and the new version
    is from October 23 at **2**. Lines that exist in the new version of the file but
    not in the installed one are prefaced with a plus sign (`+`). Lines that exist
    in the installed file but not in the new one are prefaced with a minus sign (`-`).
  prefs: []
  type: TYPE_NORMAL
- en: This example shows that the OpenBSD version of this file changed from 1.36 at
    **3** to 1.37 at **4**. That’s not terribly surprising, and for system administration
    purposes, not a terribly vital piece of information. But the new version has a
    new alias, directing email addressed to the user `_iscsid` to */dev/null* at **5**.
    This could be important, so I want the new alias on my system.
  prefs: []
  type: TYPE_NORMAL
- en: Next, we see a difference between the files, where I’ve forwarded email addressed
    to root to my personal email at **6**, but the new version of the file has no
    such redirection at **7**. I want the old version of this line but the new version
    of another line, and while I don’t particularly care about the OpenBSD version
    numbers, I would prefer the newer one. I could hand assemble an aliases file,
    but after `sysmerge` prints out the differences, it offers to help.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: '`sysmerge` offers the following choices:'
  prefs: []
  type: TYPE_NORMAL
- en: If I delete the temporary aliases file, `sysmerge` throws away the new file
    **1**. This is fine if my existing aliases file is adequate, but in this case,
    I want part of the new file.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If I install the temporary aliases file, I overwrite my changes **2**. Unless
    I go back in and change the aliases file again, my custom mail forwarding will
    stop working. I don’t want this to happen.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: I can merge the old and new files **3**, choosing the best fit from each file,
    which is the option I’ll pick.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: I could look at the differences again **4**. This has the advantage of putting
    off an actual decision.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: To merge the old and new files, I enter **`m`**. Note that the merge function
    requires close attention to detail. A mistake here can make your system hang as
    it tries to go into multiuser mode.
  prefs: []
  type: TYPE_NORMAL
- en: When you merge, `sysmerge` takes your input and builds a combined file. Lines
    that are identical in both versions are automatically added to the new file. When
    lines differ, `sysmerge` walks you through the differences and lets you choose
    a version.
  prefs: []
  type: TYPE_NORMAL
- en: The new version of the line appears on the right, and the installed version
    is on the left. Enter **`l`** or **`1`** to choose the version on the left side,
    or **`r`** or **`2`** to choose the version on the right.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: The version number has updated, though it’s in a comment, which won’t affect
    how the alias file updates. Still, as I’m merging the files anyway, I might as
    well get the new version number. I enter **`r`** to choose the version on the
    right.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: There is no equivalent to this line in the installed file, as this alias exists
    only in the new file. Again, I choose **`r`** to include this line in my file.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: Here, I want the entry from the installed file, on the left-hand side. I choose
    **`l`**.
  prefs: []
  type: TYPE_NORMAL
- en: Once I’ve gone through all of the entries, `sysmerge` offers me more choices.
    These include comparing the merged and installed files, comparing the merged and
    new files, starting over, viewing the merged file, redoing the merge, and installing
    the merged file.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: I did everything correctly, so I install the merged file (although I should
    probably view the merged file first, and then install it).
  prefs: []
  type: TYPE_NORMAL
- en: My biggest difficulty with `sysmerge` comes in differentiating my left and my
    right. Worse, the L key is on the right side, and the R key is on the left. (Go
    ahead now, laugh, but just wait until you mix that up.)
  prefs: []
  type: TYPE_NORMAL
- en: Finishing sysmerge
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: When `sysmerge` finishes installing the files, it checks the permissions on
    the */etc* files, and tells you where to find the log and that the system might
    need a reboot. A purist might tell you that you don’t need to reboot, but usually
    you should go ahead and do it. Rebooting after changing core system files prevents
    a variety of problems, and rebooting as part of an upgrade isn’t unreasonable.
    You can wait to reboot until after you upgrade your packages, as long as everything
    works.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: You now have an updated OpenBSD base system. Be aware that new or changed files
    can change system behavior, but usually you won’t notice. The *Upgrade Guide*
    usually notes any changes average users are likely to notice. Still, only you
    know what your system does and how you want it to behave.
  prefs: []
  type: TYPE_NORMAL
- en: Upgrading your installed packages is a separate task.
  prefs: []
  type: TYPE_NORMAL
- en: Updating Installed Packages
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Packages run reliably only on the version of OpenBSD for which they’re compiled.
    If you’re using packages, then updating your third-party software is very easy.
    (If you build your own software from the ports collection, you can still update
    but it won’t be as easy.)
  prefs: []
  type: TYPE_NORMAL
- en: First, check the *Upgrade Guide* again. It describes any intrusive changes to
    major software. Take any actions it recommends before continuing.
  prefs: []
  type: TYPE_NORMAL
- en: Updating the Package Repository
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Before upgrading your packages, check your `$PKG_PATH` environment variable.
    It almost certainly references the package directory for your previous version
    of OpenBSD.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: Find the package repository for your new version of OpenBSD. You can probably
    just update the release number in your shell’s dotfile, but go to the mirror site
    and make sure that the packages for that release are present.
  prefs: []
  type: TYPE_NORMAL
- en: If you upgrade from release to release, you can use the `uname(1)` command to
    set your `PKG_PATH` in your dotfile. For example, if *ftp11.usa.openbsd.org* is
    your favorite mirror site, use a line like this for `sh`-based dotfiles.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: Using the Upgrade Command
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: To upgrade your installed packages, use `pkg_add` with the `-i` and `-u` flags.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: The `-i` flag tells `pkg_add` to work in interactive mode and ask you about
    any ambiguities. The `-u` flag means “update.”
  prefs: []
  type: TYPE_NORMAL
- en: This upgrader recurses through each of your add-on software packages and its
    dependencies, uninstalling the old version and installing the new. If you want
    to see more verbose and detailed messages about the package-updating process,
    add the `-v` flag.
  prefs: []
  type: TYPE_NORMAL
- en: Package Options
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: If the dependencies for a package have changed and you now have multiple options,
    `pkg_add` presents your choices.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: The package `foomatic-db-engine` can use either `curl` or `wget`. Of the two,
    I prefer `wget`, so I enter `1`. Pressing ENTER tells `pkg_add` to use the default.
  prefs: []
  type: TYPE_NORMAL
- en: Package Messages
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Once all of the packages have been updated, `pkg_add` displays any messages
    from the upgraded packages.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: Some of the installation instructions will tell you to clear out cached files
    from the older version of the software, as in this CUPS example.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: Other times, software might jump versions. For example, OpenBSD lets you install
    multiple versions of PHP, Python, and other scripting languages, but after upgrading,
    you must decide which is your preferred default.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: You may also need to change some system configuration after an upgrade.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: The package maintainers put these messages into the package for your benefit.
    Read them, and if you’re in doubt, follow their instructions.
  prefs: []
  type: TYPE_NORMAL
- en: If all of your software is installed via packages, the upgrade process should
    be painless and transparent. I would like to tell you about all the problems and
    edge cases, except I’ve never been able to trigger any. Upgrading packages from
    the official release media just works. Packages built from the ports tree, however,
    are more complicated to upgrade, as I discuss in [Upgrading Ports](ch20.html#upgrading_ports
    "Upgrading Ports").
  prefs: []
  type: TYPE_NORMAL
- en: Why Build Your Own OpenBSD?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Building your own upgrade from OpenBSD’s source is intended only for advanced
    users and those interested in developing OpenBSD and advanced users. You must
    be comfortable reading and compiling source code, debugging problems, and restoring
    from backup before even trying to build OpenBSD from source. In OpenBSD’s earlier
    days, I found upgrading from source to be the easiest way to move forward, but
    now upgrading via snapshot is much easier and much less error-prone. If there’s
    any way you can use an official binary release to install what you’re looking
    for, do so.
  prefs: []
  type: TYPE_NORMAL
- en: When you build OpenBSD from source, you are building the distribution sets that
    you installed via FTP or CD. The files might not be bundled up in distributions,
    but their contents will be the same. You still must merge your configuration files
    with `sysmerge`, and you will still need to update your installed software. The
    only thing building OpenBSD gets you is the latest version of the branch you’re
    following.
  prefs: []
  type: TYPE_NORMAL
- en: 'I know of three reasons to build your own OpenBSD from source: to get OpenBSD-stable,
    to get the latest OpenBSD-current, or to highly customize OpenBSD. OpenBSD-stable
    is available only as source code. No official installation media is available
    for -stable, so if you want to go from 5.4-release to 5.4-stable, you must build
    it from source. If you want the absolutely latest OpenBSD code—newer than the
    latest snapshot—you must build it. And if you want to highly customize OpenBSD,
    you must build it from source.'
  prefs: []
  type: TYPE_NORMAL
- en: Preparations for Building Your Own OpenBSD
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Building OpenBSD takes up about 4GB of disk, 2GB in */usr/src* and 2GB in */usr/obj*.
    OpenBSD creates these directories as separate partitions by default, but if you
    designed your own disk-partition scheme, make sure you have enough space.
  prefs: []
  type: TYPE_NORMAL
- en: You must build on your target platform. Don’t try to cross-compile by, for example,
    building VAX binaries on an amd64 box. OpenBSD developers use cross-compiling
    to bring up a new hardware platform, but once the platform is up and running,
    all development happens on the native hardware. Code produced by cross-compiling
    might not be identical to code produced by the compiler running on the native
    platform.
  prefs: []
  type: TYPE_NORMAL
- en: Preparing the Base Operating System
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Your first step is to prepare the base operating system. You can build OpenBSD
    on only an OpenBSD installation similar to what you’re trying to build, which
    means you need to install the closest binary set to your target platform on your
    build machine. If you’re trying to build OpenBSD 5.4-stable, start by installing
    5.4-release on your build machine. If you’re trying to build the latest OpenBSD-current,
    upgrade your build machine to the newest snapshot first.
  prefs: []
  type: TYPE_NORMAL
- en: Why start from the closest available binary release? For one, that’s how the
    OpenBSD developers do it; the code is meant to be built from a very recent OpenBSD.
    Although the system changes only slowly, those changes can add up. OpenBSD-stable
    is built only on the OpenBSD release it’s based on, or on a -stable release following
    that base release.
  prefs: []
  type: TYPE_NORMAL
- en: Also, OpenBSD-current occasionally has “flag days,” where a critical system
    change makes building the source code difficult. These might be compiler or linker
    upgrades, library or kernel changes, or just about anything else. While the OpenBSD
    team documents what you need to do to get over these humps, those documents are
    more like notes for people who know what they’re doing than user-friendly instructions.
  prefs: []
  type: TYPE_NORMAL
- en: These flag days are announced on the OpenBSD mailing lists. You can try to follow
    those notes and build OpenBSD over these barriers, but when you get sick of beating
    your head against a flag-day change, upgrade to a snapshot to get over the hump.
    (Many OpenBSD developers also use snapshots to get over flag-day changes; inability
    to compile OpenBSD through a flag day is not a threat to your manhood or womanhood.)
  prefs: []
  type: TYPE_NORMAL
- en: Getting Source Code
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Now get the OpenBSD source code. If you have already installed these files,
    and you need to upgrade to a more recent version, see [Updating Source Code](ch20.html#updating_source_code
    "Updating Source Code").
  prefs: []
  type: TYPE_NORMAL
- en: 'For those installing the source code for the first time, the OpenBSD project
    provides recent code snapshots in four compressed tar files: the userland (*src.tar.gz*),
    kernel (*sys.tar.gz*), X Windows (*xenocara.tar.gz*), and ports (*ports.tar.gz*).
    All must be kept synchronized, which means that you cannot use a -current ports
    tree atop a -stable userland and kernel. Get the file that’s closest to what you
    want to build.'
  prefs: []
  type: TYPE_NORMAL
- en: If you’re building -stable, you can grab all four files from the release directory
    of the binary you installed. For example, if you’re building OpenBSD 5.4-stable,
    you’ll find *src.tar.gz*, *sys.tar.gz*, *xenocara.tar.gz*, and *ports.tar.gz*
    on your CD or on an OpenBSD mirror under */pub/OpenBSD/5.4/*.
  prefs: []
  type: TYPE_NORMAL
- en: If you’re building -current, you’re better off starting with a newer snapshot
    of the source code. On the OpenBSD mirror sites, under */pub/OpenBSD*, you’ll
    find recent copies of *src.tar.gz* and *sys.tar.gz*. Grab the most recent ones
    of those. You still need the *xenocara.tar.gz* and *ports.tar.gz* files from the
    most recent OpenBSD release, as those files are not updated as frequently.
  prefs: []
  type: TYPE_NORMAL
- en: 'Verify that the directories */usr/src*, */usr/obj*, */usr/xenocara*, */usr/xobj*,
    and */usr/ports* are empty. Then extract *src.tar.gz* and *sys.tar.gz* under */usr/src*,
    and Xenocara and *ports* directly under */usr*. Here, I’ve copied all the tarballs
    to my home directory:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: This gives you a known good base to start from. If you’re looking to build your
    own OpenBSD, you probably don’t want to build a version that’s available for installation
    now; you want to build a version that’s not available for installation. This means
    you want to update the source code to either -current or -stable.
  prefs: []
  type: TYPE_NORMAL
- en: Updating Source Code
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: OpenBSD uses Concurrent Versions System (CVS) for source code management. CVS
    is an older, somewhat traditional version control system. While many projects
    have moved from CVS to newer, shinier, and perhaps more glamorous systems, CVS
    meets the OpenBSD Project’s needs.
  prefs: []
  type: TYPE_NORMAL
- en: 'OpenBSD has a single central source-code repository: the master CVS server.
    Only developers and mirror sites have access to this server. When a developer
    wants to make new OpenBSD code available, he *commits* the changes to this central
    repository, and other developers can see his changes at this point.'
  prefs: []
  type: TYPE_NORMAL
- en: The master CVS server tracks all changes ever made to the OpenBSD source, as
    well as who made those changes. Mirror sites capture these changes and make them
    available to the users in a matter of hours. As a user, you can use CVS to update
    your local source code to the latest version from a mirror site.
  prefs: []
  type: TYPE_NORMAL
- en: Source Code Repositories and Tags
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: OpenBSD’s source code is divided into *repositories*, or collections of code
    for particular subsystems. You need to download and synchronize only the collections
    that you want to use.
  prefs: []
  type: TYPE_NORMAL
- en: 'The OpenBSD CVS repository includes four collections: `src` (userland and kernel
    source), `ports` (the ports collection), `xenocara` (X Windows), `www` (the website),
    and the obsolete `X11` and `XF4` X Windows collections. While X11 and XF4 are
    still kept for historical purposes, you should never need to use that code. The
    `www` repository is of interest to the website editors and contributors. In order
    to build a recent OpenBSD, you must update your `src`, `ports`, and `xenocara`
    collections to the latest versions of your chosen branch.'
  prefs: []
  type: TYPE_NORMAL
- en: A *tag* is a label for a particular version of a repository. OpenBSD uses tags
    to differentiate between -stable, -release, and -current. For example, the source
    code of every single OpenBSD release ever made includes the file */usr/src/etc/master.passwd*.
    But the version of *master.passwd* shipped with OpenBSD 2.0 differs wildly from
    that shipped with OpenBSD 5.3! CVS uses tags to differentiate the various versions
    of this and every other file. By using tags, you can ask CVS for the version of
    any file that shipped with any OpenBSD release.
  prefs: []
  type: TYPE_NORMAL
- en: 'The tag for any -stable version of OpenBSD is the string `OPENBSD` and the
    version number, separated by underscores. For example, the tag for OpenBSD 5.4
    is `OpenBSD_5_4`. Note the two underscores: there is no `OPENBSD_54` or `OPENBSD5_4`.
    If you use a tag that does not exist, rather than updating your local source code
    files, you’ll delete them. (While you should download the source code for a release,
    rather than updating to it via CVS, an OpenBSD release appends the string `_BASE`
    to the tag, as in `OPENBSD-5_4_BASE`.) That said, OpenBSD-current is special in
    that it has no tag and it includes the latest version of all source code in all
    repositories.'
  prefs: []
  type: TYPE_NORMAL
- en: All of the repositories are designed to be updated synchronously. If, for example,
    you update the source code repository to -current and leave your ports and Xenocara
    at their -release or -stable versions, your system will behave unpredictably.
    As with learning to juggle chainsaws, you’re welcome to try it, but don’t whine.
  prefs: []
  type: TYPE_NORMAL
- en: CVS Mirrors
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: You can use anonymous CVS to update your source code to the latest version.
    Start by choosing a convenient anonymous CVS server from the list at *[http://www.OpenBSD.org/anoncvs.html](http://www.OpenBSD.org/anoncvs.html)*.
    There are mirrors all over the world, but choose one on your continent for better
    performance. (I use *anoncvs13.usa.openbsd.org*^([[44](#ftn.id444809)]) in my
    examples.)
  prefs: []
  type: TYPE_NORMAL
- en: Tracking OpenBSD-current is slightly different than tracking OpenBSD-stable.
    We’ll start with -stable, and then see how -current differs.
  prefs: []
  type: TYPE_NORMAL
- en: Updating to -stable
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: The first time you update your source code, you must specify the anonymous CVS
    server on the command line.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: CVS is very picky about the order of its command-line arguments, and many flags
    are position-dependent. Don’t change the order of arguments unless you know what
    you’re doing.
  prefs: []
  type: TYPE_NORMAL
- en: 'Substitute your preferred server and the release tag you want to get into this
    command. For example, to update my OpenBSD 5.1 source tree to the latest stable
    version from *anoncvs13.openbsd.org*, I would run the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: Because OpenBSD runs CVS over SSH the first time you run `cvs`, it asks you
    to verify the CVS mirror’s host key. Compare the **1** key fingerprint given by
    your client to the fingerprint listed on the CVS mirror list. If they match, you’re
    talking to the actual CVS server. If the fingerprints don’t match, something is
    wrong, which could be a problem at the server, a skipped website update, or an
    actual security problem at the mirror. If the key fingerprints don’t match, choose
    a different CVS mirror. (SSH will cache this key, and future updates won’t ask
    you to verify the key unless it changes.)
  prefs: []
  type: TYPE_NORMAL
- en: 'There’s a pause when CVS starts comparing the source code on your disk to the
    source code on the server, and just about when you think that something has gone
    wrong, you’ll probably see actual source code updates, like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: This is complete CVS update output for updating OpenBSD 5.1 release to -stable.
    In all, there were seven changes. When the OpenBSD guys say “minimal changes in
    -stable,” they mean it.
  prefs: []
  type: TYPE_NORMAL
- en: Repeat this for */usr/ports* and */usr/xenocara*.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: A source tree records the last server updated from, and on subsequent updates,
    you can drop the server from the command line. The source tree also knows which
    repository within the server it’s supposed to update from, so you don’t need to
    specify it.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: Run this same command any time you want the latest -stable source code.
  prefs: []
  type: TYPE_NORMAL
- en: Updating to -current
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: The process for updating your source code to -current is much the same as updating
    to -stable, but the command line differs slightly. The first time you update your
    source tree, you must specify the server name.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  prefs: []
  type: TYPE_PRE
- en: 'This `cvs` command gives you the latest -current source code. For example,
    if I want to update my source code from *anoncvs13.openbsd.org*, I run this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  prefs: []
  type: TYPE_PRE
- en: You should get the SSH key fingerprint verification message, and see the same
    type of messages that you would get updating to -stable.
  prefs: []
  type: TYPE_NORMAL
- en: 'The first time you run CVS to update a specific set of source code, `cvs` records
    which server the source code came from. For subsequent updates to the latest -current
    source code, you can skip the server name and shorten the command, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  prefs: []
  type: TYPE_PRE
- en: Now you need to build the new source code into program code.
  prefs: []
  type: TYPE_NORMAL
- en: You build -stable and -current in the same way, but -current has more potential
    issues, so we’ll start by building -stable.
  prefs: []
  type: TYPE_NORMAL
- en: Building OpenBSD-stable
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Building OpenBSD-stable requires building and installing a new kernel, building
    and installing a new userland, and building and installing the new Xenocara.
  prefs: []
  type: TYPE_NORMAL
- en: Upgrading the Kernel
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Building an upgraded kernel is like building a custom kernel, as discussed
    in [Chapter 19](ch19.html "Chapter 19. Building Custom Kernels"). Basically, the
    process boils down to this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  prefs: []
  type: TYPE_PRE
- en: (If I planned to build OpenBSD regularly on this machine, I would script this.)
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '[Chapter 19](ch19.html "Chapter 19. Building Custom Kernels") is full of warnings
    about difficulties compiling a custom kernel. These don’t apply to building the
    *GENERIC* kernel on -stable. Remember that -stable includes only security fixes
    and obviously correct small changes. ABI, API, configuration, and syntax changes
    are absolutely forbidden. If this kernel build fails, you probably corrupted your
    source tree somehow. Remove everything in */usr/src* and start over.'
  prefs: []
  type: TYPE_NORMAL
- en: After building and installing the new kernel, reboot. You must run the new kernel
    to build the new userland.
  prefs: []
  type: TYPE_NORMAL
- en: Building the Userland
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: To build and install everything outside the kernel, remove any old builds and
    re-create the object directories. Also, make sure that the installed OpenBSD system
    has all of the necessary directories. Skipping this step will make the build fail
    and corrupt your source tree.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  prefs: []
  type: TYPE_PRE
- en: Now you can build and install the userland.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  prefs: []
  type: TYPE_PRE
- en: Building userland can take several days on an antique system, but should take
    only an hour or two on more modern hardware. When the process finishes, you should
    have the new userland installed on the local system.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Installing -stable simplifies the userland part of the upgrade. There’s no need
    to merge any new */etc/* files with `sysmerge` (but there’s no harm in running
    `sysmerge` either, just to check that your configuration is indeed valid), or
    to re-create your device nodes, as they won’t change. OpenBSD-stable contains
    very minor changes from the release on which it’s based.
  prefs: []
  type: TYPE_NORMAL
- en: Building Xenocara
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The X Window System might or might not change during -stable. If your CVS update
    shows no changes in -stable, you don’t need to rebuild it, but if any of the files
    in */usr/xenocara* have changed, you’re better off rebuilding X. The build process
    is completely routine for Xenocara-stable.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  prefs: []
  type: TYPE_PRE
- en: This builds and installs the new X on your system.
  prefs: []
  type: TYPE_NORMAL
- en: Building a Release
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: This is all very nice if you want to upgrade only one machine. But what if you
    have several machines to upgrade to your custom OpenBSD build? You don’t want
    to go building -stable on your firewalls or your web server.
  prefs: []
  type: TYPE_NORMAL
- en: If you need to upgrade multiple machines, build your OpenBSD on one machine,
    and install that build on multiple machines by building your own *release*. This
    will take less time than you needed to build your upgrade and use under a gigabyte
    of disk space.
  prefs: []
  type: TYPE_NORMAL
- en: A release is what the OpenBSD Project puts on the mirror sites for you to install.
    It’s a few kernels, tarballs containing the userland files, the index file, and
    so on. Using these files, you can upgrade your other hosts just as you would perform
    the official media upgrade discussed earlier this chapter. Building a release
    is the easiest way to upgrade several OpenBSD hosts to identical versions.
  prefs: []
  type: TYPE_NORMAL
- en: Before you can build a release, you must build both the base OpenBSD system
    and Xenocara. You could skip Xenocara if you don’t want any X on any of your hosts,
    but a surprising number of third-party programs need the X libraries. It’s easier
    to build X and not install it on selected hosts than to go back and rebuild the
    whole release because you didn’t build Xenocara the first time.
  prefs: []
  type: TYPE_NORMAL
- en: The release process installs OpenBSD in a temporary root directory and then
    bundles that installation into the release tarballs and related files. Next, it
    repeats the process with the X software. It assumes that you have the OpenBSD
    source code in */usr/src* and a completed build in */usr/obj*, as well as the
    Xenocara source in */usr/xenocara* and a completed build in */usr/xobj*. You can
    change the build process to get around these requirements, as documented in `release(8)`,
    but you should accept the defaults.
  prefs: []
  type: TYPE_NORMAL
- en: 'You’ll need to define three directories: one to store your release, one for
    your temporary OpenBSD root directory, and one for your temporary Xenocara root
    directory. You can reuse the temporary root directories, but I keep them for reference.
    I use */home/releasedir* as my release directory, */home/destdir* as my temporary
    OpenBSD root, and */home/xdestdir* as the Xenocara temporary root.'
  prefs: []
  type: TYPE_NORMAL
- en: Warning
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: You can use any partition with sufficient free space, except for */mnt* because
    the release process uses this partition. Similarly, building a release builds
    ISO and floppy images using the first `vnode` device, */dev/vnd0*. If you have
    any disk images mounted using that device (see [Chapter 9](ch09.html "Chapter 9. More
    Filesystems")), the release process will fail. If you must mount a disk image
    while building a release, use a `vnode` device other than */dev/vnd0*.
  prefs: []
  type: TYPE_NORMAL
- en: 'The release process has three steps: bundling the base system, bundling Xenocara,
    and indexing the results.'
  prefs: []
  type: TYPE_NORMAL
- en: Bundling the Base System
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: OpenBSD’s build system includes all of the glue that you need to build a release.
    First, do a `make build` of your new OpenBSD so that you’re running the same version
    you want to build a release for. Next, define the temporary OpenBSD root and the
    release directory in your environment as `$DESTDIR` and `$RELEASEDIR`, respectively.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Verify that the temporary OpenBSD root and the release directories are empty
    before you start. While the release process can overwrite files from an old build,
    the directories might have obsolete files that you don’t want included in the
    new release.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  prefs: []
  type: TYPE_PRE
- en: Once you have this ready, building the release involves only a few commands.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  prefs: []
  type: TYPE_PRE
- en: 'Take a look in your release directory. You should see the following items:'
  prefs: []
  type: TYPE_NORMAL
- en: Three kernels (*bsd*, *bsd.mp*, and *bsd.rd*)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Three floppy boot images if you’re building for i386, or one if it’s for amd64
    (other architectures vary)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Two ISO images
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Five file sets for the OpenBSD base system
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: These files are functionally identical to those distributed by the OpenBSD project,
    except they’re based on your custom build.
  prefs: []
  type: TYPE_NORMAL
- en: Once you’ve finished building releases, be sure to remove the `$RELEASEDIR`
    and `$DESTDIR` variables from your environment because they can mess up other
    software builds. You can’t successfully build Xenocara with them still set.
  prefs: []
  type: TYPE_NORMAL
- en: Bundling Xenocara
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: As with bundling the base system, you must first complete a Xenocara build.
    Confirm that your system has the same version of Xenocara installed that you want
    included in your release, and then set the `RELEASEDIR` and `DESTDIR` environment
    variables. `RELEASEDIR` should be identical to that used to bundle the base system,
    but `DESTDIR` should differ.
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: You could reuse `DESTDIR`, but that will erase everything from your temporary
    base system installation. Leave those files around until you’re sure you have
    a solid release.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  prefs: []
  type: TYPE_PRE
- en: Now go into the Xenocara source and bundle the release.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  prefs: []
  type: TYPE_PRE
- en: Xenocara isn’t much smaller than the base system. It takes a while to bundle
    up, so this is a good time to go to lunch. When you get back, you should find
    five new files in your release directory, all tarballs beginning with *x*.
  prefs: []
  type: TYPE_NORMAL
- en: Before you quit for the day, remove `RELEASEDIR` and `DESTDIR` from your environment.
  prefs: []
  type: TYPE_NORMAL
- en: Indexing the Release
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Copy your release to your local FTP or web server, and create an index of the
    contents. (Only HTTP installs and upgrades need an index file.) The OpenBSD installer
    and upgrade software will use this index during the installation.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  prefs: []
  type: TYPE_PRE
- en: Make the web or FTP site accessible from the machines you want to upgrade.
  prefs: []
  type: TYPE_NORMAL
- en: Using the Release
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Upgrade or install using this release just as you would use an official release.
    Copy *bsd.rd* to a machine to be upgraded, and then boot into that kernel. When
    the installer asks where to get the file sets, give the location of your release.
    Extract and reboot!
  prefs: []
  type: TYPE_NORMAL
- en: Building OpenBSD-current
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Building OpenBSD-current is exactly like building -stable, except when it isn’t.
    OpenBSD-current can change wildly, and building it from source is considered an
    advanced activity. The only time I actually build -current is if I need to test
    some new functionality or a patch offered by an OpenBSD developer.
  prefs: []
  type: TYPE_NORMAL
- en: The two big problems are the radical changes in -current and merging */etc*.
  prefs: []
  type: TYPE_NORMAL
- en: Following -current
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: When you follow -current, keep a close eye on OpenBSD’s changes by tracking
    the Following -current web page at *http://www.OpenBSD.org/faq/current.html*.
    This is where the OpenBSD developers list all of the changes likely to impact
    people trying to build -current. Not all changes apply to all systems, but any
    change listed that applies to your system requires special handling.
  prefs: []
  type: TYPE_NORMAL
- en: The entries are chronological, and include everything since the last release.
    Just concern yourself with entries dated on or after the date of the source code
    used to build your snapshot. For example, if you built a snapshot dated January
    30, and you want to build -current on the following February 5, check the web
    page for any entries between those two dates, inclusive. Earlier changes are already
    incorporated in the installed snapshot.
  prefs: []
  type: TYPE_NORMAL
- en: Some changes will require your intervention before you even try to build the
    system. For example, if you have new unprivileged usernames, they will need to
    be in place before a `make build` can succeed—after all, a program owned by user
    `_fdisk` can’t be installed unless that user is in place.
  prefs: []
  type: TYPE_NORMAL
- en: If you don’t understand an entry on this page, do not upgrade!
  prefs: []
  type: TYPE_NORMAL
- en: Merging /etc
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: When you upgrade to a new -stable, you can be sure that the files in */etc/*
    haven’t changed. When you track -current, those critical system files might well
    change. Any critical changes are usually noted in the Following -current website,
    but it’s best to use `sysmerge(8)` to merge in all */etc* changes. You can give
    `sysmerge` the path to the system source instead of the *etc.tgz* file set.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  prefs: []
  type: TYPE_PRE
- en: See the section about `sysmerge` earlier in this chapter for detailed information.
  prefs: []
  type: TYPE_NORMAL
- en: Upgrading Ports
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you use OpenBSD-provided packages, upgrading your system is as easy as running
    `pkg_add -ui`. If you built your third-party packages from source using the ports
    collection, however, there’s no easy way to upgrade. You must rebuild those packages.
    There is no automated way to do this, but the `make update` command in a port
    can rebuild a specific port.
  prefs: []
  type: TYPE_NORMAL
- en: Presumably, you built your own packages because the OpenBSD-provided packages
    lacked some option or flavor you needed. In that case, you probably only needed
    to build one or two packages from source. All of the software required by that
    package could be installed from official OpenBSD sources. You should upgrade everything
    possible via packages and rebuild only what is strictly necessary.
  prefs: []
  type: TYPE_NORMAL
- en: Now that you can upgrade OpenBSD any way you want, let’s look at OpenBSD’s packet
    filter.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[42](#id310014)]) Henning Brauer tells me that many upgrade failures aren’t
    really unpredictable; they’re merely “unsupported and untested” code paths. To
    most of us, that’s “unpredictable,” but you’re welcome to predict them yourself.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[43](#id427066)]) I know, I know, your shell is superior to mine. I was given
    tcsh as my first shell almost 30 years ago, and my fingers are too habituated
    to it to change. I’ll concede your superiority if you’ll stop telling me about
    it.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[44](#id444809)]) Again, there is no *anoncvs13.usa.openbsd.org*. Find a
    server close to you. Stop blindly copying my examples. It’s like you think I know
    what I’m doing or something!
  prefs: []
  type: TYPE_NORMAL
