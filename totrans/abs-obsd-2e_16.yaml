- en: Chapter 16. Network Servers
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 第16章 网络服务器
- en: '*Working behind scenes,*'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: '*幕后工作，*'
- en: '*taking care of vital things,*'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: '*处理重要事务，*'
- en: '*the daemon is here.*'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '*守护进程在这里。*'
- en: '![](httpatomoreillycomsourcenostarchimages1616079.png) The OpenBSD base system
    includes several servers to support a network. This chapter covers the following
    network servers:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: '![](httpatomoreillycomsourcenostarchimages1616079.png) OpenBSD基础系统包括几个服务器来支持网络。本章涵盖了以下网络服务器：'
- en: Small-server handler `inetd`
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 小服务器处理器 `inetd`
- en: Printer daemon `lpd`
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 打印机守护进程 `lpd`
- en: DHCP daemon `dhcpd`
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: DHCP守护进程 `dhcpd`
- en: TFTP daemon `tftpd`
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: TFTP守护进程 `tftpd`
- en: SNMP agent `snmpd`
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: SNMP代理 `snmpd`
- en: SSH server `sshd`
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: SSH服务器 `sshd`
- en: This miscellany of small daemons supports the features covered in upcoming chapters.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 这本杂乱无章的小精灵支持了即将到来的章节中涵盖的功能。
- en: The inetd Small-Server Handler
  id: totrans-12
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: inetd 小服务器处理器
- en: The `inetd(8)` “super-server” handles incoming network requests for network
    services that aren’t used very often. After all, many systems don’t have a steady
    stream of incoming FTP requests, so why have an FTP daemon running constantly?
    Instead, `inetd` listens for incoming network requests, and when an FTP request
    arrives, it starts the FTP server and feeds it the request. Other common services
    that frequently (but not always) run through `inetd` include ident, finger, and
    TFTP. Many of these services can also run standalone, if the application usage
    warrants it.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: '`inetd(8)` “超级服务器”处理不常使用的网络服务的传入网络请求。毕竟，许多系统没有稳定的FTP请求流，为什么还要一直运行FTP守护进程呢？相反，`inetd`
    监听传入的网络请求，当FTP请求到达时，它启动FTP服务器并将请求传递给它。其他经常（但不总是）通过 `inetd` 运行的常见服务包括 ident、finger
    和 TFTP。许多这些服务也可以独立运行，如果应用程序的使用需要的话。'
- en: '`inetd` also handles functions so small and rarely used that they’re easier
    to implement within `inetd` itself, rather than by calling a separate program.
    These functions include `discard` (which dumps any data received into the bottomless
    pit of */dev/null*), `chargen` (which pours out a stream of characters), and `echo`
    (which repeats whatever you send to it). Most of these services are not needed
    on the modern Internet and are disabled by default, but you have access to them
    if necessary.'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: '`inetd` 还处理一些非常小且很少使用的功能，这些功能在 `inetd` 本身内实现比通过调用单独的程序实现更容易。这些功能包括 `discard`（将接收到的任何数据丢弃到
    */dev/null* 的无底洞中），`chargen`（输出一串字符），和 `echo`（重复你发送给它的任何内容）。大多数这些服务在现代互联网上不是必需的，并且默认情况下被禁用，但如果你需要，你可以访问它们。'
- en: Configuring inetd
  id: totrans-15
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 配置inetd
- en: 'You configure `inetd` in */etc/inetd.conf*. Here’s the default `inetd` configuration
    for OpenBSD’s FTP server:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 你在 */etc/inetd.conf* 中配置 `inetd`。以下是OpenBSD FTP服务器的默认 `inetd` 配置：
- en: '[PRE0]'
  id: totrans-17
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: The first thing you’ll notice is that these entries are commented out. OpenBSD’s
    default `inetd` offers only the identity server `identd(8)` and two time services
    by default.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 你首先会注意到这些条目已被注释掉。OpenBSD的默认 `inetd` 默认只提供身份服务器 `identd(8)` 和两个时间服务。
- en: The first field is the service name (`ftp` in this case) **1**. The name in
    this field must match a name in */etc/services*. The `inetd` program uses the
    *services* file to perform a service lookup to identify which ports it must listen
    on. To change the TCP/IP port that your FTP server runs on, change the port for
    FTP in */etc/services*. (You could also change the first field to use the name
    of the service that usually runs on the desired port, but I find starting my FTP
    server entry with the wrong name just gives me a headache.)
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 第一个字段是服务名称（在这种情况下为 `ftp`）**1**。此字段中的名称必须与 */etc/services* 中的名称匹配。`inetd` 程序使用
    *services* 文件来执行服务查找，以确定它必须监听哪些端口。要更改FTP服务器运行的TCP/IP端口，请更改 */etc/services* 中FTP的端口。（你也可以更改第一个字段以使用通常在所需端口上运行的服务名称，但我发现用错误的名字开始我的FTP服务器条目只会让我头疼。）
- en: The second field is the socket type (`stream` in this case) **2**. This field
    dictates what sort of connection this is. All TCP connections are of type `stream`,
    and UDP connections are of type `dgram`. The `inetd` program does support other
    types of connections, but they’re rarely used. If you’re considering using them,
    either you’re reading the documentation for a piece of software that needs that
    type of connection or you’re wrong (probably the latter).
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个字段是套接字类型（在这种情况下为 `stream`）**2**。此字段决定了这种连接的类型。所有TCP连接都是 `stream` 类型，而UDP连接是
    `dgram` 类型。`inetd` 程序也支持其他类型的连接，但它们很少使用。如果你正在考虑使用它们，要么你正在阅读需要此类连接的软件的文档，要么你错了（可能后者的可能性更大）。
- en: The third field is the layer 4 network protocol, usually `tcp` **3**, `udp`,
    `tcp6`, or `udp6`. If you want to offer a service over both IPv4 and IPv6, you
    need a separate entry for each. That’s why there are two otherwise identical configurations
    for the FTP server. The `inetd` program also supports RPC services, which have
    type `rpc/udp` or `rpc/tcp`.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 第三字段是第4层网络协议，通常是`tcp` **3**，`udp`，`tcp6`或`udp6`。如果您想在IPv4和IPv6上提供服务，您需要为每个协议分别创建条目。这就是为什么FTP服务器有两个其他方面相同的配置。`inetd`程序还支持RPC服务，其类型为`rpc/udp`或`rpc/tcp`。
- en: The fourth field (`nowait` in this case) **4** indicates whether `inetd` should
    wait for the server program to close the connection or just start the program
    and go away. As a general rule, TCP-based daemons use `nowait`, and UDP-based
    daemons use `wait`. (There are rare exceptions.)
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 第四字段（在本例中为`nowait`）**4**表示`inetd`是否应该等待服务器程序关闭连接，或者只是启动程序然后离开。一般来说，基于TCP的守护进程使用`nowait`，而基于UDP的守护进程使用`wait`。（有少数例外。）
- en: The fifth field (`root` in this case) **5** names the user that the server daemon
    runs as. Many `inetd`-using programs must run as root, as they can affect multiple
    users or accept more specific logins, but some smaller programs have dedicated
    unprivileged users.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 第五字段（在本例中为`root`）**5**指定了服务器守护进程运行的用户。许多使用`inetd`的程序必须以root身份运行，因为它们可以影响多个用户或接受更具体的登录，但一些较小的程序有专门的未授权用户。
- en: The sixth field is the full path to the server program `inetd` runs when a connection
    request arrives **6**. Services implemented within `inetd` have a path of `internal`.
    The FTP server is at */usr/libexec/ftpd*.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 第六字段是当连接请求到达时`inetd`运行的程序的全路径 **6**。在`inetd`中实现的服务路径为`internal`。FTP服务器位于`/usr/libexec/ftpd`。
- en: Finally, the last field gives the command to start the server program, including
    any command-line arguments you want. This configuration runs the FTP server with
    the arguments `-US` **7**.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，最后一个字段给出了启动服务器程序的命令，包括您想要的任何命令行参数。此配置使用`-US`参数运行FTP服务器 **7**。
- en: Restricting Incoming Connections
  id: totrans-26
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 限制传入连接
- en: Script kiddies occasionally try to knock a server off the Internet by sending
    it more connection requests than it can handle. The `inetd` program accepts up
    to 256 connections per minute per service. If a service receives too many connection
    requests, `inetd` logs the issue and stops answering requests for that service
    for 10 minutes.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 小白用户偶尔会尝试通过发送比服务器能处理的更多的连接请求来将服务器从互联网上移除。`inetd`程序每个服务每分钟最多接受256个连接。如果一个服务接收过多的连接请求，`inetd`将记录问题并停止回答该服务的请求10分钟。
- en: Note
  id: totrans-28
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: The IPv4 and IPv6 versions are limited separately, so you could accept 512 FTP
    connections per second if the requests are evenly divided between protocol families.
    You can override this globally with a command-line flag when starting `inetd`,
    or you can configure this on a per-service basis.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: IPv4和IPv6版本分别限制，因此如果请求在协议族之间均匀分配，您每秒可以接受512个FTP连接。您可以在启动`inetd`时使用命令行标志全局覆盖此限制，或者您可以在每个服务的基础上进行配置。
- en: 'The `-R` flag controls how many connections per minute and per service that
    `inetd` accepts. For example, to accept 1000 requests per minute, you would set
    the following in */etc/rc.conf.local*:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: '`-R`标志控制`inetd`每分钟和每个服务接受的连接数。例如，要每分钟接受1000个请求，您需要在`/etc/rc.conf.local`中设置以下内容：'
- en: '[PRE1]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'You can set per-service limits by editing the `wait/nowait` field in the service’s
    *inetd.conf* entry. Add a dot to the `wait` or `nowait` entry, followed by the
    number of times per minute you want to allow the service to be called. For example,
    if you have an FTP server that should be used by only a few of your friends, you
    could limit the server to 10 requests per minute, as follows:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过编辑服务的`inetd.conf`条目中的`wait/nowait`字段来设置每个服务的限制。在`wait`或`nowait`条目后添加一个点，然后跟您希望服务每分钟被调用的次数。例如，如果您有一个只有几个朋友使用的FTP服务器，您可以将服务器限制为每分钟10个请求，如下所示：
- en: '[PRE2]'
  id: totrans-33
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Now, if more than 10 connection requests arrive in one minute, `inetd` stops
    servicing FTP requests for ten minutes. An attacker could still use this to knock
    your FTP service offline, but not to knock the entire server offline. At least
    this way you get to choose your failure mode and when you reach it.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，如果一分钟内超过10个连接请求到达，`inetd`将停止服务FTP请求十分钟。攻击者仍然可以使用此方法使您的FTP服务离线，但不会使整个服务器离线。至少这样您可以选择您的故障模式以及何时达到它。
- en: The lpd Printing Daemon
  id: totrans-35
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: lpd 打印守护进程
- en: OpenBSD includes the `lpd(8)` printing daemon common on Unix-like operating
    systems. The `lpd` daemon has options to support thousands of different printers,
    but getting the right mix of options to support any one specific printer can be
    a challenge.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD 包含了在 Unix-like 操作系统中常见的 `lpd(8)` 打印守护进程。`lpd` 守护进程有支持成千上万种不同打印机的选项，但找到支持任何特定打印机的正确选项组合可能是一个挑战。
- en: The simplest way to use a printer on OpenBSD is through a PostScript server,
    and that’s the method I’ll cover here. Many modern printers, particularly the
    popular multifunction fax/scanner/printer combinations, support PostScript, and
    you’ll find that every office print server does, too.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在 OpenBSD 上使用打印机的最简单方法是通过 PostScript 服务器，这正是我将在这里介绍的方法。许多现代打印机，尤其是流行的多功能传真/扫描/打印机组合，都支持
    PostScript，你会发现每个办公室的打印服务器也是如此。
- en: 'Every printer your system knows about needs an entry in */etc/printcap*, the
    printer capability database. This is another `termcap(5)`-style configuration
    file. You don’t need to know everything about the printer to change settings here.
    This entry just needs the hostname or IP address of the print server and the print
    server’s name for the printer you want to access. Then use the following template:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 系统中知道的每个打印机都需要在 */etc/printcap* 中有一个条目，即打印机功能数据库。这是一个另一种 `termcap(5)` 风格的配置文件。你不需要了解打印机的所有信息就可以在这里更改设置。此条目只需要打印服务器的主机名或
    IP 地址以及你想要访问的打印机的打印服务器名称。然后使用以下模板：
- en: '[PRE3]'
  id: totrans-39
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The first line gives the printer’s names. Every printer can have any number
    of names, separated by the pipe (`|`) symbol. The default printer on a Unix-like
    system is named `lp`, so be sure that one of the printers has that name attached
    to it. Another name should be the one used by the print server for this printer
    (such as `Billing`). (Microsoft print servers frequently share one printer under
    several different names, and each name prints differently, so be sure to use the
    name that represents the PostScript facility.)
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 第一行给出打印机的名称。每个打印机可以有任意数量的名称，名称之间由管道（`|`）符号分隔。Unix-like 系统上的默认打印机名为 `lp`，因此请确保至少有一台打印机附有该名称。另一个名称应该是打印服务器用于该打印机的名称（例如
    `Billing`）。（Microsoft 打印服务器通常在几个不同的名称下共享一台打印机，并且每个名称打印的内容不同，因此请确保使用代表 PostScript
    功能的名称。）
- en: 'The other lines list attributes:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 其他行列出属性：
- en: By default, `lpd` precedes each print job with a page giving the job name, number,
    host, and other identifying information. This used to be important when people
    paid for printing by the page, but unless you’re in an environment with a single,
    massive printer, this probably wastes paper. The `:sh:=\` entry suppresses this
    page.
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 默认情况下，`lpd` 在每个打印作业前都会加上一个包含作业名称、编号、主机和其他识别信息的页面。当人们按页付费打印时，这曾经很重要，但除非你在一个只有一台大型打印机的环境中，否则这可能会浪费纸张。`:sh:=\`
    条目会抑制此页面。
- en: The `:rm=` attribute gives the hostname or IP address of the print server. You
    must be able to ping the print server by this name.
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`:rm=` 属性给出了打印服务器的主机名或 IP 地址。你必须能够通过此名称ping通打印服务器。'
- en: Printing works best if each printer has a unique spool directory, given by the
    `:sd=` attribute. The printer daemon stores documents en route to the print server
    here. This directory must be owned by the user root and the group daemon.
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果每个打印机都有一个唯一的打印队列目录，给定 `:sd=` 属性，则打印效果最佳。打印机守护进程将正在前往打印服务器的文档存储在此目录中。此目录必须由用户
    root 和组 daemon 拥有。
- en: Several printers can share a common log file, shown by the `:lf=` attribute.
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 几台打印机可以共享一个公共日志文件，由 `:lf=` 属性表示。
- en: Finally, specify the remote printer name with the `:rp=` attribute. This last
    attribute is the only one that doesn’t end with a backslash.
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最后，使用 `:rp=` 属性指定远程打印机名称。这是唯一一个不以反斜杠结尾的属性。
- en: Always end */etc/printcap* with a newline. I usually use an entire blank line,
    just to be certain.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 总是以换行符结束 */etc/printcap*。我通常使用一个完整的空白行，以确保无误。
- en: 'Now that you have a printer configuration, you start `lpd` at boot with this
    *rc.conf.local* entry:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经配置了打印机，你可以通过在 *rc.conf.local* 中添加以下条目在启动时启动 `lpd`：
- en: '[PRE4]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Restart `lpd` with `/etc/rc.d/lpd restart` any time you edit */etc/printcap*.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 任何时间编辑 */etc/printcap* 后，都使用 `/etc/rc.d/lpd restart` 重新启动 `lpd`。
- en: Finally, view the print queue with `lpq(1)`, and watch */var/log/lpd-errs* for
    problems.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，使用 `lpq(1)` 查看打印队列，并观察 */var/log/lpd-errs* 文件以查找问题。
- en: The DHCP Server dhcpd
  id: totrans-52
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: DHCP 服务器 dhcpd
- en: DHCP is the standard method for dynamically configuring clients on an IP network.
    You might know DHCP as a way to give computers basic IP information, but it can
    also hand out configuration files for embedded devices such as routers and phones,
    point diskless machines to their kernel and userland, and much more.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: DHCP 是在 IP 网络上动态配置客户端的标准方法。你可能知道 DHCP 是一种为计算机提供基本 IP 信息的方法，但它也可以分发路由器和电话等嵌入式设备的配置文件，将无盘机器指向它们的内核和用户空间，等等。
- en: OpenBSD includes a heavily modified ISC DHCP server, `dhcpd(8)`. Here, we’ll
    cover the basics of using `dhcpd` for configuring dynamic clients in a shared
    Ethernet system. In [Chapter 23](ch23.html "Chapter 23. Customizing OpenBSD"),
    we’ll discuss the details of using DHCP to configure diskless workstations.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD 包含了一个经过大量修改的 ISC DHCP 服务器，`dhcpd(8)`。在这里，我们将介绍如何使用 `dhcpd` 在共享以太网系统中配置动态客户端的基础知识。在
    [第 23 章](ch23.html "第 23 章。定制 OpenBSD") 中，我们将讨论使用 DHCP 配置无盘工作站细节。
- en: How DHCP Works
  id: totrans-55
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: DHCP 的工作原理
- en: A client seeking DHCP information broadcasts a request across the local network
    asking for someone—*anyone*—to give it a network configuration. If your DHCP server
    is on that Ethernet segment, it answers directly. If it’s on another network segment,
    the router for that network segment can forward the DHCP request to your server,
    which will then offer a configuration to the client, maintaining a list of which
    clients have been assigned which unique configuration values (such as IP addresses).
    A configuration issued to a client is called a *lease*. Like all leases, DHCP
    leases expire and must be renewed in order to be valid.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 寻求 DHCP 信息的客户端会在本地网络中广播一个请求，请求某人——任何人——给它一个网络配置。如果你的 DHCP 服务器位于该以太网段上，它会直接响应。如果它位于另一个网络段上，该网络段的路由器可以将
    DHCP 请求转发到你的服务器，然后服务器将为客户端提供一个配置，并维护一个已分配哪些唯一配置值（如 IP 地址）给哪些客户端的列表。分配给客户端的配置称为
    *租约*。像所有租约一样，DHCP 租约会过期，必须续订才能有效。
- en: Clients can request certain DHCP features to support their operations. For example,
    Microsoft clients request the IP addresses of the network Windows Internet Name
    Service (WINS) servers, Voice over IP (VoIP) desktop phones request their configuration
    file, and diskless systems (discussed in [Chapter 23](ch23.html "Chapter 23. Customizing
    OpenBSD")) ask where to find their kernel and userland. The DHCP server can offer
    this information, or not.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 客户端可以请求某些 DHCP 功能以支持其操作。例如，Microsoft 客户端请求网络 Windows Internet Name Service (WINS)
    服务器的 IP 地址，VoIP 桌面电话请求它们的配置文件，而无盘系统（在第 23 章[定制 OpenBSD](ch23.html "第 23 章。定制 OpenBSD")中讨论）询问它们在哪里可以找到它们的内核和用户空间。DHCP
    服务器可以提供这些信息，也可以不提供。
- en: The DHCP server uniquely identifies each client by the MAC address of the network
    card it uses to connect to the network. To find out what information a client
    received from the DHCP server, get the client’s MAC address and search for it
    in the */var/db/dhcpd.lease* file.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: DHCP 服务器通过客户端连接到网络的网卡 MAC 地址唯一标识每个客户端。要找出客户端从 DHCP 服务器接收了什么信息，获取客户端的 MAC 地址并在
    */var/db/dhcpd.lease* 文件中搜索它。
- en: Configuring dhcpd(8)
  id: totrans-59
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 配置 dhcpd(8)
- en: Configure `dhcpd` in */etc/dhcpd.conf*. The default *dhcpd.conf* file includes
    a sample configuration suitable for a small office environment, as well as a diskless
    client sample configuration.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 在 */etc/dhcpd.conf* 中配置 `dhcpd`。默认的 *dhcpd.conf* 文件包含一个适合小型办公环境的示例配置，以及一个无盘客户端的示例配置。
- en: I’m going to assume that you’re running a single DHCP server on your network,
    and that this server is authoritative for DHCP services. (OpenBSD’s DHCP server
    also supports clustering for fault tolerance.)
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: '我将假设你在你的网络上运行一个 DHCP 服务器，并且这个服务器是 DHCP 服务的权威服务器。（OpenBSD 的 DHCP 服务器也支持集群以实现容错。） '
- en: 'Before configuring `dhcpd` to configure clients dynamically, you’ll need a
    few facts about your network:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 在配置 `dhcpd` 以动态配置客户端之前，你需要了解一些关于你网络的事实：
- en: Domain name
  id: totrans-63
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 域名
- en: DNS servers
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: DNS 服务器
- en: IP network and netmask
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: IP 网络和子网掩码
- en: Range of IP addresses in the network used for DHCP clients
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 网络中用于 DHCP 客户端的 IP 地址范围
- en: Default router
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 默认路由器
- en: 'Once you have this information, you can assemble a brief *dhcpd.conf*. Here’s
    an example:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你有了这些信息，你就可以组装一个简短的 *dhcpd.conf* 文件。以下是一个示例：
- en: '[PRE5]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: All hosts that get their configuration from this host are told that their domain
    name is *blackhelicopters.org* **1**, and that they should use the name servers
    192.0.2.5 and 192.0.2.10 **2**. The client can be configured to ignore or override
    this DHCP configuration, but you can’t prevent local sysadmins from hanging themselves.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 所有从这个主机获取配置的主机都被告知它们的域名是*blackhelicopters.org**1*，并且它们应该使用名称服务器192.0.2.5和192.0.2.10**2**。客户端可以被配置为忽略或覆盖此DHCP配置，但你无法阻止本地系统管理员自挂东南枝。
- en: Each subnet needs its own configuration. Even if you have only one subnet, you
    must still have a `subnet` statement defining the IP network for that subnet so
    that `dhcpd` can determine which clients get which configuration. This example
    defines the configuration for clients on the network at 198.51.100.0/24 **3**.
    Everything inside the brackets that follow applies only to hosts on this subnet.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 每个子网都需要自己的配置。即使你只有一个子网，你也必须有一个定义该子网IP网络的`subnet`语句，以便`dhcpd`可以确定哪些客户端获得哪些配置。以下示例定义了网络在198.51.100.0/24**3**上的客户端配置。以下方括号内的所有内容仅适用于此子网上的主机。
- en: The `routers` option at **4** identifies the default gateway for this network.
    Because the `dhcpd` server won’t let you define additional static routes to feed
    to clients, your local network router must have proper routes to reach the destination.
    If you have multiple gateways on your local network, your default router should
    send an ICMP redirect to the DHCP client to correct its routing. (You don’t unilaterally
    block ICMP from your firewalls, do you?)
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: '**4**处的`routers`选项标识了此网络的默认网关。因为`dhcpd`服务器不会让你为客户端定义额外的静态路由，所以你的本地网络路由器必须具有到达目的地的正确路由。如果你在本地网络上有多个网关，你的默认路由器应向DHCP客户端发送ICMP重定向以纠正其路由。（你不会单方面从防火墙中阻止ICMP，对吧？）'
- en: The `range` keyword gives the IP addresses that the DHCP server can assign to
    clients. In this example, the DHCP server controls the addresses 198.51.100.51
    to 198.51.100.100, inclusive **5**. If 52 dynamic clients connect simultaneously,
    the last client won’t get an address.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: '`range`关键字给出了DHCP服务器可以分配给客户端的IP地址。在这个例子中，DHCP服务器控制了从198.51.100.51到198.51.100.100的地址，包括**5**。如果有52个动态客户端同时连接，最后一个客户端将无法获得地址。'
- en: This configuration should get your clients on the network.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 此配置应使你的客户端能够连接到网络。
- en: Static IP Address Assignments
  id: totrans-75
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 静态IP地址分配
- en: 'You can tell your DHCP server to assign a specific address to specific hosts
    by specifying the Ethernet address of the client in the configuration and using
    a stanza within the `subnet` statement. Here’s the earlier DHCP configuration
    with a static entry added:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过在配置中指定客户端的以太网地址并使用`subnet`语句中的段落来告诉你的DHCP服务器为特定的主机分配特定的地址。以下是一个添加了静态条目的早期DHCP配置示例：
- en: '[PRE6]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: I’ve found the MAC address of my workstation, and used it to assign a static
    IP address to that machine. This client machine inherits the default router from
    the subnet definition, as well as any default DHCP information.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 我已经找到了我的工作站的MAC地址，并使用它为该机器分配了一个静态IP地址。此客户端机器从子网定义继承了默认路由器以及任何默认DHCP信息。
- en: Enabling dhcpd
  id: totrans-79
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 启用dhcpd
- en: Enable `dhcpd` in *rc.conf.local*.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 在`rc.conf.local`中启用`dhcpd`。
- en: '[PRE7]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'If you have only one network-facing interface, `dhcpd` will automatically listen
    for DHCP requests on that interface. If you have multiple interfaces, give the
    interface name as an argument. For example, here’s how to tell `dhcpd` to listen
    for requests only on the interface `fxp1`:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你只有一个面向网络的接口，`dhcpd`将自动在该接口上监听DHCP请求。如果你有多个接口，请将接口名称作为参数。例如，以下是如何告诉`dhcpd`只在该接口`fxp1`上监听请求：
- en: '[PRE8]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: The interface name must be the last `dhcpd` argument in *rc.conf.local*. If
    `dhcpd` needs to handle several interfaces, the list of interfaces must come after
    any other arguments in `dhcpd_flags`.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 接口名称必须是`rc.conf.local`中`dhcpd`参数的最后一个。如果`dhcpd`需要处理多个接口，接口列表必须跟在其他任何参数之后在`dhcpd_flags`中。
- en: dhcpd and Firewalls
  id: totrans-85
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: dhcpd和防火墙
- en: The OpenBSD packet filtering system includes *tables*, which are lists of IP
    addresses that the packet filter applies rules to. Traffic from IP addresses in
    tables can be blocked, have its bandwidth throttled or prioritized, or be allowed
    to pass. Each table has a unique name.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD数据包过滤系统包括*表格*，这些是数据包过滤器应用规则到的一组IP地址。来自表格中IP地址的流量可以被阻止，带宽被限制或优先处理，或者被允许通过。每个表格都有一个唯一名称。
- en: The `dhcpd` server can add addresses to packet filter tables, thereby dynamically
    changing the firewall rules depending on whether an IP address is leased. Here,
    we’ll look at configuring `dhcpd` to give addresses to the packet filter tables.
    [Chapter 21](ch21.html "Chapter 21. Packet Filtering") discusses how to configure
    the packet filter to handle addresses from `dhcpd`.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: '`dhcpd` 服务器可以将地址添加到包过滤表中，从而根据 IP 地址是否已租用动态更改防火墙规则。在这里，我们将探讨如何配置 `dhcpd` 以向包过滤表提供地址。[第
    21 章](ch21.html "第 21 章。包过滤") 讨论了如何配置包过滤规则以处理来自 `dhcpd` 的地址。'
- en: 'DHCP considers IP addresses in its address pool to be in one of three states:
    leased, abandoned, or changed. *Leased* addresses are addresses assigned to a
    host attached to the network. Use `-L` to give `dhcpd` the name of the packet
    filter table for leased addresses, and then configure the packet filter to allow
    or deny those addresses access to the rest of the network.'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: DHCP 将其地址池中的 IP 地址视为三种状态之一：已租用、已放弃或已更改。*已租用*的地址是指分配给连接到网络的宿主机的地址。使用 `-L` 选项向
    `dhcpd` 提供已租用地址的包过滤表名称，然后配置包过滤规则以允许或拒绝这些地址访问网络的其他部分。
- en: '*Abandoned* addresses are ones that have been assigned to a host, but that
    are not currently in use. In practice, that means that if you shut down your laptop,
    the DHCP server will consider the IP address assigned to it abandoned. The problem
    with that is that unauthorized users might try to get on the network by taking
    an unused address from the address pool, without going through the DHCP server.
    To address this problem, give the packet filter the list of addresses not in use,
    and give illicit network hosts their own special packet filter rules. Use the
    `-A` argument to tell `dhcpd` the name of the packet filter table for abandoned
    addresses.'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: '*已放弃*的地址是指已分配给宿主机但当前未使用的地址。在实践中，这意味着如果你关闭你的笔记本电脑，DHCP 服务器将认为分配给它的 IP 地址已放弃。问题是未经授权的用户可能会尝试从地址池中获取未使用的地址来接入网络，而不通过
    DHCP 服务器。为了解决这个问题，向包过滤规则提供未使用地址的列表，并为非法网络主机提供他们自己的特殊包过滤规则。使用 `-A` 选项告诉 `dhcpd`
    已放弃地址的包过滤表名称。'
- en: If a host changes its address despite the DHCP server’s configuration instructions,
    the DHCP server considers the address *changed*, and `dhcpd` can add its new address
    to the changed address table. Use the `-C` argument to tell `dhcpd` the name of
    the changed address table. (In [Chapter 21](ch21.html "Chapter 21. Packet Filtering"),
    we’ll do something interesting with these tables.)
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 如果宿主机更改了地址，尽管 DHCP 服务器的配置说明，DHCP 服务器仍认为该地址已更改，`dhcpd` 可以将其新地址添加到更改地址表中。使用 `-C`
    选项告诉 `dhcpd` 更改地址表的名称。（在[第 21 章](ch21.html "第 21 章。包过滤")中，我们将对这些表进行一些有趣的配置。）
- en: '[PRE9]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Note
  id: totrans-92
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Static IP address assignments do not go into tables. If you assign a static
    address to a host, you must manually configure firewall rules for that address.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 静态 IP 地址分配不会进入表。如果你为宿主机分配了静态地址，你必须手动为该地址配置防火墙规则。
- en: The TFTP Daemon tftpd
  id: totrans-94
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: TFTP 守护进程 tftpd
- en: The Trivial File Transfer Protocol (TFTP) is used to transfer files across a
    network. Unlike FTP, TFTP doesn’t include authentication. Anyone who can access
    the TFTP server can upload or download files from it.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 简单文件传输协议（TFTP）用于在网络上传输文件。与 FTP 不同，TFTP 不包含身份验证。任何可以访问 TFTP 服务器的人都可以从它上传或下载文件。
- en: TFTP is an inflexible protocol. It doesn’t work through network address translation
    without a proxy or some kind of intelligence within the translation device, and
    there’s no interactive session as there is with FTP and SFTP. TFTP is most commonly
    used to copy configuration files and operating system images for embedded devices
    such as routers.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: TFTP 是一种不灵活的协议。如果没有代理或翻译设备内的某种智能，它无法通过网络地址转换工作，并且没有像 FTP 和 SFTP 那样的交互会话。TFTP
    最常用于复制嵌入式设备（如路由器）的配置文件和操作系统映像。
- en: OpenBSD uses TFTP to bootstrap diskless systems, as discussed in [Chapter 23](ch23.html
    "Chapter 23. Customizing OpenBSD").
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD 使用 TFTP 来引导无盘系统，如[第 23 章](ch23.html "第 23 章。定制 OpenBSD")所述。
- en: Specifying a tftpd Directory
  id: totrans-98
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 指定 tftpd 目录
- en: OpenBSD’s `tftpd(8)` serves files from a directory, much like a web server.
    Traditionally, this directory is */tftpboot*, but don’t follow tradition in this
    case (you don’t want a TFTP user filling your server’s root partition!). If you
    use */tftpboot* on your root partition, make sure that your TFTP clients can’t
    write to the directory. (You could create a */tftpboot* partition.) Normally,
    I create */var/tftpboot* and tell `tftpd` to use that as its root directory. If
    your fingers are used to typing `/tftpboot`, create a symlink.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD 的 `tftpd(8)` 从目录中提供服务，就像一个 Web 服务器。传统上，这个目录是 */tftpboot*，但在此情况下不要遵循传统（您不希望
    TFTP 用户填满您的服务器根分区！）。如果您在根分区上使用 */tftpboot*，请确保您的 TFTP 客户端无法写入该目录。（您可以创建一个 */tftpboot*
    分区。）通常，我会创建 */var/tftpboot* 并告诉 `tftpd` 使用该目录作为其根目录。如果您的手指习惯于输入 `/tftpboot`，请创建一个符号链接。
- en: To enable `tftpd`, set `tftpd_flags` in *rc.conf.local* to the TFTP root directory.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 要启用 `tftpd`，请在 `rc.conf.local` 中设置 `tftpd_flags` 为 TFTP 根目录。
- en: '[PRE10]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: '`tftpd` `chroot`s to the directory you specify, so `tftpd` cannot access files
    outside this directory.'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: '`tftpd` 将 `chroot` 到您指定的目录，因此 `tftpd` 无法访问此目录之外的文件。'
- en: tftpd and Files
  id: totrans-103
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: tftpd 和文件
- en: 'TFTP uses file permissions as an access control method. Because all files on
    the TFTP server can be read by anyone who can access the server port, TFTP will
    let clients read files in its root directory only if they are world-readable.
    To make them world-readable, do this:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: TFTP 使用文件权限作为访问控制方法。因为 TFTP 服务器上的所有文件都可以被任何可以访问服务器端口的用户读取，所以 TFTP 只允许客户端在其根目录中读取文件，前提是这些文件是全局可读的。要使它们全局可读，请执行以下操作：
- en: '[PRE11]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Similarly, `tftpd` will not allow anyone to upload a file unless a file of that
    name already exists and is world-writable. This means that anyone who knows a
    file’s name can overwrite it, so make vital files read-only. If an attacker can’t
    write files, he can’t fill your hard drive.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 类似地，`tftpd` 不会允许任何人上传文件，除非该名称的文件已经存在并且是全局可写的。这意味着任何知道文件名的人都可以覆盖它，因此请将重要文件设置为只读。如果攻击者无法写入文件，他就无法填满您的硬盘。
- en: To create files via TFTP, so that you can upload files that don’t already exist,
    run `tftpd` with the `-c` option.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 要通过 TFTP 创建文件，以便您可以上传不存在的文件，请使用 `-c` 选项运行 `tftpd`。
- en: '`tftpd` starts as root in order to bind UDP port 69, but it then drops privileges
    and runs as the unprivileged user `_tftpd`. Any files `tftpd` created will be
    owned by its user. As a general rule, the files in the TFTP root directory should
    not be owned by `_tftpd`, in order to make sure that the server cannot affect
    the files it serves.'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: '`tftpd` 以 root 身份启动，以便绑定 UDP 端口 69，但它随后会降低权限并以无特权的用户 `_tftpd` 运行。`tftpd` 创建的任何文件都将属于其用户。作为一般规则，TFTP
    根目录中的文件不应由 `_tftpd` 拥有，以确保服务器无法影响其提供的服务器文件。'
- en: tftpd Logging
  id: totrans-109
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: tftpd 日志记录
- en: You should log your TFTP transfers. Use the `-v` flag to send the transaction
    log to `syslogd`.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该记录您的 TFTP 传输。使用 `-v` 标志将事务日志发送到 `syslogd`。
- en: '[PRE12]'
  id: totrans-111
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: '`tftpd` logs uses the FTP facility to log messages to */var/log/daemon*.'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: '`tftpd` 日志使用 FTP 功能将消息记录到 */var/log/daemon*。'
- en: Testing the TFTP Server
  id: totrans-113
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 测试 TFTP 服务器
- en: Use `tftp(1)` to test your TFTP server.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `tftp(1)` 测试您的 TFTP 服务器。
- en: '[PRE13]'
  id: totrans-115
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: You won’t see any friendly hash marks as you download the file, and you can’t
    change to another directory or list the contents of the TFTP server. Once the
    test is complete, use `quit` to end your TFTP session.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 在下载文件时，您不会看到任何友好的散列标记，并且您无法切换到另一个目录或列出 TFTP 服务器的内容。一旦测试完成，使用 `quit` 结束您的 TFTP
    会话。
- en: After you have a TFTP client and server set up, you’ll be ready to serve diskless
    OpenBSD machines, router operating system images, or anything else you need.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 在您设置好 TFTP 客户端和服务器之后，您将准备好为无盘 OpenBSD 机器、路由器操作系统镜像或其他任何您需要的设备提供服务。
- en: The SNMP Agent snmpd
  id: totrans-118
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: SNMP 代理 snmpd
- en: SNMP is the de facto standard for gathering information from network devices.
    Many different devices from many different vendors support SNMP as a management
    protocol.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP 是从网络设备收集信息的既定标准。许多不同厂商的不同设备都支持 SNMP 作为管理协议。
- en: OpenBSD includes an SNMP agent, `snmpd(8)`, which supports all of the usual
    SNMP functions, and also offers visibility into OpenBSD-specific features such
    as packet filtering.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD 包含一个 SNMP 代理 `snmpd(8)`，它支持所有常规的 SNMP 功能，并提供对 OpenBSD 特定功能（如数据包过滤）的可见性。
- en: SNMP works according to the standard client/server model. The SNMP client (usually
    a server performing network management or monitoring) queries the SNMP server
    (or *agent*) running on a network device. The SNMP agent, `snmpd`, gathers information
    from the local system and returns it to the client.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP 根据标准的客户端/服务器模型工作。SNMP 客户端（通常是执行网络管理或监控的服务器）查询运行在网络设备上的 SNMP 服务器（或 *代理*）。SNMP
    代理 `snmpd` 从本地系统收集信息并将其返回给客户端。
- en: In traditional SNMP, an SNMP client with the correct privileges can also request
    that the SNMP agent modify its device. Most Unix-like operating systems are designed
    to be configured at the command line and generally don’t accept write requests
    from SNMP. OpenBSD follows this trend, and we will focus specifically on read-only
    SNMP.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 在传统的 SNMP 中，具有正确权限的 SNMP 客户端还可以请求 SNMP 代理修改其设备。大多数类 Unix 操作系统都设计为在命令行中进行配置，并且通常不接受
    SNMP 的写请求。OpenBSD 跟随这一趋势，我们将特别关注只读 SNMP。
- en: In addition to having an SNMP agent answer requests from an SNMP client, the
    agent can transmit SNMP traps to a *trap receiver* somewhere on the network. SNMP
    traps are much like `syslogd(8)` messages, except that they follow a specific
    format required by SNMP.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 除了让 SNMP 代理响应 SNMP 客户端的请求外，代理还可以将 SNMP 陷阱发送到网络上的某个 *陷阱接收器*。SNMP 陷阱与 `syslogd(8)`
    消息非常相似，但它们遵循 SNMP 所需的特定格式。
- en: Note
  id: totrans-124
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: OpenBSD does not include an SNMP trap receiver. If you need one, check out `snmptrapd`
    in the `net-snmp` package.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD 不包括 SNMP 陷阱接收器。如果您需要，请查看 `net-snmp` 包中的 `snmptrapd`。
- en: SNMP MIBs
  id: totrans-126
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: SNMP MIBs
- en: SNMP manages information via a Management Information Base (MIB), which is a
    tree-like structure that contains hierarchical information in ASN.1 format. Each
    SNMP agent has a list of information it can extract from the local system, arranged
    in a hierarchical SNMP MIB with very general main categories, such as network,
    physical, programs, and so on.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP 通过管理信息库（MIB）管理信息，MIB 是一个树状结构，包含以 ASN.1 格式的分层信息。每个 SNMP 代理都有一个从本地系统提取信息列表，这些信息按分层
    SNMP MIB 安排，具有非常一般的主要类别，如网络、物理、程序等。
- en: Think of the MIB tree as a well-organized filing cabinet, where individual drawers
    hold specific information, and files within drawers hold particular facts. Similarly,
    the uppermost MIB contains a list of MIBs beneath it.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 将 MIB 树想象成一个组织良好的文件柜，其中每个抽屉都保存着特定的信息，抽屉内的文件则保存着特定的事实。同样，最顶层的 MIB 包含了其下 MIB 的列表。
- en: MIB References
  id: totrans-129
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: MIB 参考信息
- en: 'MIBs can be referred to by name or number. For example, here’s a MIB pulled
    from an OpenBSD test machine:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: MIBs 可以通过名称或编号进行引用。例如，这里是一个从 OpenBSD 测试机器中提取的 MIB：
- en: '[PRE14]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: The first term in this MIB, `interfaces`, tells us that we’re looking at this
    machine’s network interfaces. If this machine had no interfaces, this category
    would not even exist (although an OpenBSD machine will always have at least a
    loopback interface). The `ifTable` is the *interface table*, which is a list of
    all network interfaces on the system. The field `ifEntry` shows one particular
    entry, and `ifDescr` means that we’re looking at a description of this interface.
    This MIB could be expressed as “Interface number 1 on this machine is called `em0`.”
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 这个 MIB 的第一个术语 `interfaces` 告诉我们，我们正在查看这台机器的网络接口。如果这台机器没有接口，这个类别甚至不会存在（尽管 OpenBSD
    机器将始终至少有一个回环接口）。`ifTable` 是 *接口表*，它列出了系统上的所有网络接口。`ifEntry` 字段显示一个特定的条目，而 `ifDescr`
    则意味着我们正在查看这个接口的描述。这个 MIB 可以表示为“这台机器上的接口编号 1 被称为 `em0`。”
- en: 'MIBs can also be expressed as numbers, and most SNMP clients do their work
    natively in numerical MIBs. Your management tool should be able to translate between
    numbers and names, but just so you’re not terribly surprised, here’s the earlier
    example in numerical form:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: MIBs 也可以用数字表示，大多数 SNMP 客户端在数字 MIB 中以原生方式工作。您的管理工具应该能够将数字和名称之间进行转换，但为了以防您感到非常惊讶，这里提供了之前示例的数字形式：
- en: '[PRE15]'
  id: totrans-134
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Expressed in words, this MIB has five parts separated by dots. Expressed in
    numbers, the MIB has 11 parts. Aren’t they supposed to be the same thing? Well,
    the numerical MIB is longer because it includes the default address .1.3.6.1.2.1,
    which translates to *.iso.org.dod.internet.mgmt.mib-2*, the standard subset of
    MIBs used on the Internet. Most SNMP MIBs start with this string, so the management
    tools no longer bother printing out this name.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 用文字表达，这个 MIB 由五个部分组成，部分之间用点分隔。用数字表达，MIB 有 11 个部分。它们不应该是一样的吗？嗯，数字 MIB 更长，因为它包括了默认地址
    .1.3.6.1.2.1，这对应于 *.iso.org.dod.internet.mgmt.mib-2*，这是在互联网上使用的 MIB 的标准子集。大多数
    SNMP MIB 都以这个字符串开头，所以管理工具就不再打印出这个名称了。
- en: MIB Definitions
  id: totrans-136
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: MIB定义
- en: 'OpenBSD supports two groups of MIBs:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD支持两组MIB：
- en: The standard host MIBs, which every network management system understands. This
    information includes network and disk space utilization, software running on the
    system, and so on.
  id: totrans-138
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 标准的主机MIB，这是每个网络管理系统都理解的。这些信息包括网络和磁盘空间利用率、系统上运行的软件等。
- en: MIBs for OpenBSD-specific functions, such as the packet filter, network failover,
    bridging, and so on. Most network management systems will not understand the OpenBSD-specific
    MIBs out of the box, so you’ll want to teach your management system about OpenBSD’s
    MIBs.
  id: totrans-139
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用于OpenBSD特定功能（如数据包过滤器、网络故障转移、桥接等）的MIB。大多数网络管理系统不会默认理解OpenBSD特定的MIB，所以你将想要让你的管理系统了解OpenBSD的MIB。
- en: MIBs are defined according to a very strict syntax documented in MIB files.
    For example, `snmpd` includes MIB files for the OpenBSD-specific functions in
    */usr/share/snmp/mibs*. These files are written in plaintext, in the very stilted
    and formal ASN.1 syntax. While you can read and interpret them with nothing more
    than your brain, I highly recommend copying them to your network management workstation
    and using an SNMP client to examine them.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: MIB是根据MIB文件中记录的非常严格的语法定义的。例如，`snmpd`在`/usr/share/snmp/mibs`中包含了OpenBSD特定功能的MIB文件。这些文件以纯文本形式编写，使用非常正式的ASN.1语法。虽然你可以仅用大脑阅读和解释它们，但我强烈建议将它们复制到你的网络管理工作站上，并使用SNMP客户端来检查它们。
- en: MIB browsers interpret MIB files and present them in their full tree-like splendor,
    complete with definitions of each part of the tree and descriptions of each MIB,
    taken from the MIB files. Generally speaking, you enter a MIB in the MIB browser,
    which displays its numerical and word descriptions, and offers the ability to
    query an SNMP agent for that MIB.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: MIB浏览器解释MIB文件，并以完整的树状结构展示它们，包括树中每一部分的定义和每个MIB的描述，这些描述来自MIB文件。一般来说，你将MIB输入到MIB浏览器中，它会显示其数字和文字描述，并提供查询该MIB的SNMP代理的能力。
- en: If you don’t already have a MIB browser on your OpenBSD workstation, use the
    `mbrowse` package. If you don’t want a graphical interface, use the `net-snmp`
    package for a full assortment of command-line SNMP client tools, but be prepared
    to type some long command lines.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你已经在你的OpenBSD工作站上安装了MIB浏览器，请使用`mbrowse`包。如果你不想使用图形界面，请使用`net-snmp`包来获得一系列完整的命令行SNMP客户端工具，但要做好准备输入一些长的命令行。
- en: SNMP Security
  id: totrans-143
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: SNMP安全
- en: The most common alternate acronym for SNMP is “Security? Not My Problem!” This
    is unkind, but true. You should use SNMP only behind firewalls or on trusted networks.
    If you must use SNMP on the naked Internet, employ packet filtering to keep the
    public from querying your SNMP service. SNMP agents run on UDP port 161, so allow
    your management hosts access to that port on only your SNMP hosts.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP最常见的替代缩写是“安全？不是我的问题！”这听起来不友好，但却是真的。你应该只在防火墙后面或信任的网络中使用SNMP。如果你必须在裸露的互联网上使用SNMP，请使用数据包过滤来阻止公众查询你的SNMP服务。SNMP代理在UDP端口161上运行，因此只允许你的管理主机访问你的SNMP主机上的该端口。
- en: SNMP provides basic security through *communities*. If you read the SNMP documentation,
    you’ll see all kinds of explanations of why a community is not the same as a password,
    but as far as a sysadmin is concerned, a community is a password.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP通过*团体*提供基本的安全保障。如果你阅读了SNMP文档，你会看到各种解释为什么团体不等于密码，但就系统管理员而言，团体就是密码。
- en: 'Most SNMP agents have two communities by default: `public` (read-only access)
    and `private` (read-write access). OpenBSD’s `snmpd` daemon supports both of these
    communities by default. One of your first tasks will be to change these community
    names to something that the whole world doesn’t know. Just like passwords, community
    names should be hard for intruders to guess and easy for you to remember.'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数SNMP代理默认有两个团体：`public`（只读访问）和`private`（读写访问）。OpenBSD的`snmpd`守护进程默认支持这两个团体。你的第一个任务之一将是将这些团体名称更改为全世界都不知道的名称。就像密码一样，团体名称应该难以被入侵者猜测，但对你来说容易记住。
- en: As you might expect, there have been various versions of SNMP. Version 1 was
    the first attempt. Version 2c (SNMPv2c) is the more commonly deployed update.
    Version 3 (SNMPv3) uses encryption to protect data on the wire, and it includes
    strong authentication. In practice, few vendors actually use it because it’s very
    complicated. The `snmpd` daemon has partial support for SNMPv3\. Here, we’ll focus
    on the completely supported SNMPv2c.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所料，SNMP已经有过各种版本。版本1是第一次尝试。版本2c（SNMPv2c）是更常见的更新。版本3（SNMPv3）使用加密来保护线上的数据，并且它包括强大的身份验证。在实践中，很少有供应商真正使用它，因为它非常复杂。`snmpd`守护进程对SNMPv3有部分支持。在这里，我们将专注于完全支持的SNMPv2c。
- en: Configuring snmpd
  id: totrans-148
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 配置`snmpd`
- en: Configure `snmpd` in */etc/snmpd.conf*. The configuration format is a series
    of text statements. Defining new community strings overrides the defaults of `public`
    and `private`.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 在`*/etc/snmpd.conf*`中配置`snmpd`。配置格式是一系列文本语句。定义新的共同体字符串会覆盖`public`和`private`的默认值。
- en: 'We start by defining new read-only and read-write community strings, as follows:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 我们首先定义新的只读和读写共同体字符串，如下所示：
- en: '[PRE16]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: In general, most `snmpd` configuration statements look like these two. The `snmpd.conf(5)`
    man page lists all valid *snmpd.conf* configuration statements.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，大多数`snmpd`配置语句看起来像这两样。`snmpd.conf(5)`手册页列出了所有有效的`*snmpd.conf*`配置语句。
- en: 'Every SNMP system is expected to list a contact, a description, and a location,
    as in this example:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 每个SNMP系统都应列出联系人、描述和位置，如下例所示：
- en: '[PRE17]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Many network management systems will automatically pull in this information
    to populate the database. Here, I’ve defined these values for my system. Make
    similar entries for your system.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 许多网络管理系统会自动拉取这些信息以填充数据库。在这里，我为我的系统定义了这些值。为你的系统创建类似的条目。
- en: The default *snmpd.conf* listens to only the localhost IP address, 127.0.0.1,
    so outside hosts cannot contact the SNMP daemon. If you want to listen on all
    available addresses, comment out the lines, like the following, that specify an
    address.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 默认的`*snmpd.conf*`只监听本地主机IP地址，127.0.0.1，因此外部主机无法联系SNMP守护进程。如果你想监听所有可用的地址，取消注释指定地址的行，如下所示。
- en: '[PRE18]'
  id: totrans-157
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Alternatively, you can give an interface IP address to have `snmpd` listen to
    a specific external IP address for those machines with many addresses.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，你可以提供一个接口IP地址，使`snmpd`监听特定外部IP地址，对于具有多个地址的机器。
- en: '[PRE19]'
  id: totrans-159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: With this configuration, `snmpd` can provide information about your system.
    Enable it in */etc/rc.conf.local*.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此配置，`snmpd`可以提供有关你的系统的信息。在`*/etc/rc.conf.local*`中启用它。
- en: '[PRE20]'
  id: totrans-161
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: This will start `snmpd` at boot, or you can run */etc/rc.d/snmpd*.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 这将使`snmpd`在启动时启动，或者你可以运行`*/etc/rc.d/snmpd*`。
- en: Debugging snmpd
  id: totrans-163
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 调试`snmpd`
- en: SNMP can be an annoying protocol to debug. For one, because it’s UDP, there’s
    no easy way to test connectivity to the agent. Also, it runs fairly silently,
    in that it doesn’t log queries.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP调试可能是一个令人烦恼的协议。一方面，因为它使用UDP，所以没有简单的方法来测试到代理的连接性。此外，它运行得相当安静，因为它不记录查询。
- en: To verify that queries from your network management system are reaching your
    server, try running `snmpd` in verbose mode and with debugging.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 为了验证你的网络管理系统中的查询是否到达你的服务器，尝试以详细模式和调试模式运行`snmpd`。
- en: '[PRE21]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: When an SNMP query reaches your server, you should see the server parse the
    requests. By the same token, `snmpd` is very good about telling you why it can’t
    provide an answer.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 当一个SNMP查询到达你的服务器时，你应该看到服务器解析请求。同样地，`snmpd`在告诉你为什么它不能提供答案方面做得很好。
- en: '[PRE22]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: Errors, like the following, that arise from requests for a nonexistent MIB are
    a little more difficult to understand.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 来自对不存在MIB请求的错误，如以下所示，理解起来有点困难。
- en: '[PRE23]'
  id: totrans-170
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: Here, the MIB request is trying to find the object identifier (OID) `iso.org.dod.internet.private.enterprises.2041`,
    but OpenBSD’s `snmpd` does not support that. (It does support `20`*`2`*`1`, part
    of the Net-SNMP MIB.) The SNMP client is requesting an invalid MIB.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，MIB请求试图找到对象标识符（OID）`iso.org.dod.internet.private.enterprises.2041`，但OpenBSD的`snmpd`不支持它。（它支持`20`*`2`*`1`，这是Net-SNMP
    MIB的一部分。）SNMP客户端请求了一个无效的MIB。
- en: 'This example shows a successful request and the MIB that `snmpd` sends in response:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 这个例子展示了成功请求以及`snmpd`响应时发送的MIB：
- en: '[PRE24]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: By reading the output carefully, you should be able to see why `snmpd` is not
    answering requests as expected.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 通过仔细阅读输出，你应该能够看到为什么`snmpd`没有按照预期回答请求。
- en: Getting snmpd Information
  id: totrans-175
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 获取`snmpd`信息
- en: The most important feature of SNMP is that it lets you read statistics from
    the operating system and/or software. In addition to the usual features supported
    by SNMP, such as resource utilization and processes, `snmpd` lets you grab OpenBSD-specific
    system information. You can get information about the packet filter, sensor data,
    interface memory, and Command Address Redundancy Protocol (CARP). All of this
    appears under the .1.3.6.1.4.1.30155 MIB, OpenBSD’s private (enterprise) MIB tree.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP最重要的特性是它允许您从操作系统和/或软件中读取统计数据。除了SNMP支持的常规功能，如资源利用率和进程外，`snmpd`还允许您获取OpenBSD特定的系统信息。您可以获得有关数据包过滤器、传感器数据、接口内存和命令地址冗余协议（CARP）的信息。所有这些信息都出现在.1.3.6.1.4.1.30155
    MIB下，这是OpenBSD的私有（企业）MIB树。
- en: The PF SNMP MIB
  id: totrans-177
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: PF SNMP MIB
- en: 'The OpenBSD packet filtering feature keeps a lot of statistics, and everything
    I’ve ever wanted is available through the PF MIB. You’ll find information such
    as the following:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD的数据包过滤功能保留了很多统计数据，而我所需要的一切都可以通过PF MIB获得。您将找到如下信息：
- en: Whether PF is on, and how long has it been running (in hundredths of a second)
  id: totrans-179
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: PF是否开启，以及运行了多长时间（以百分之一秒为单位）
- en: The number of packets that have matched filter rules
  id: totrans-180
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 匹配过滤规则的数据包数量
- en: The number of fragments and reassembled packets
  id: totrans-181
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 分片和重组的数据包数量
- en: The number of packets dropped because of memory problems, internal packet-filtering
    problems, overfilling the state tables, and so on
  id: totrans-182
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 由于内存问题、内部数据包过滤问题、状态表溢出等原因丢弃的数据包数量
- en: The number of states added and removed from the state table
  id: totrans-183
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从状态表中添加和删除的状态数量
- en: The number of timeouts of various protocols
  id: totrans-184
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 各种协议的超时数量
- en: The amount of traffic blocked on each interface
  id: totrans-185
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 每个接口上阻止的流量量
- en: Packet filtering table usage, number of addresses in each table
  id: totrans-186
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 数据包过滤表的使用情况，每个表中的地址数量
- en: And there’s more. The PF SNMP MIB gives you more useful visibility into packet
    filtering. Point your MIB browser at the .1.3.6.1.4.1.30155.1 MIB to see everything.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 还有更多。PF SNMP MIB为您提供了更多关于数据包过滤的有用可见性。将您的MIB浏览器指向.1.3.6.1.4.1.30155.1 MIB，以查看所有内容。
- en: Sensors
  id: totrans-188
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 传感器
- en: You can view the same kernel values processed by `sensorsd(8)` (see [Chapter 15](ch15.html
    "Chapter 15. System Maintenance")) via `snmpd`, including a list of sensors on
    this device, the value reported by the sensor, and whether each sensor is in an
    alarm state. This means you can use `snmpd` instead of `sensorsd` to monitor your
    hardware.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过`snmpd`查看与`sensorsd(8)`相同的内核值（见[第15章](ch15.html "第15章。系统维护"）），包括此设备上的传感器列表、传感器报告的值以及每个传感器是否处于警报状态。这意味着您可以使用`snmpd`而不是`sensorsd`来监控您的硬件。
- en: To view sensor data via SNMP, examine the MIB tree .1.3.6.1.4.1.30155.2.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 要通过SNMP查看传感器数据，请检查MIB树.1.3.6.1.4.1.30155.2。
- en: Interface Memory
  id: totrans-191
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 接口内存
- en: You can view the amount of memory used by an interface, and how often (if ever)
    an interface was starved for memory as a result of system load. View the MIB tree
    .1.3.6.1.4.1.30155.5 to see these values.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以查看接口使用的内存量，以及由于系统负载而导致的接口内存不足的频率（如果有的话）。查看MIB树.1.3.6.1.4.1.30155.5以查看这些值。
- en: CARP
  id: totrans-193
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: CARP
- en: 'CARP is an OpenBSD invention for sharing one address between two or more machines.
    It was designed to provide highly available IP services. The `snmpd` daemon exposes
    CARP’s innards, including these items:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: CARP是OpenBSD发明的一种在两台或多台机器之间共享一个地址的方法。它旨在提供高度可用的IP服务。`snmpd`守护进程公开了CARP的内部结构，包括以下项目：
- en: The name of each CARP interface
  id: totrans-195
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 每个CARP接口的名称
- en: CARP configuration values (preemption, `advskew`, and so on)
  id: totrans-196
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: CARP配置值（抢占、`advskew`等）
- en: The number of IPv4 and IPv6 packets received
  id: totrans-197
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 接收的IPv4和IPv6数据包数量
- en: The number of packets discarded for various reasons
  id: totrans-198
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 由于各种原因丢弃的数据包数量
- en: The number of times the host has become master
  id: totrans-199
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 主机成为主机的次数
- en: To see the CARP MIB tree, view .1.3.6.1.4.1.30155.6.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 要查看CARP MIB树，请查看.1.3.6.1.4.1.30155.6。
- en: Other MIBs
  id: totrans-201
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 其他MIB
- en: The `snmpd` daemon is constantly being expanded. According to the MIB files,
    they’ve reserved space for IPsec and `relayd(8)`. Check */usr/share/snmp/mibs*
    for additional MIB files, and use your MIB browser to see what your specific version
    of OpenBSD supports. The OpenBSD team adds MIBs as they’re needed and as code
    is contributed. If you need IPsec MIBs, feel free to write and submit the code.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: '`snmpd`守护进程正在不断扩展。根据MIB文件，他们已经为IPsec和`relayd(8)`预留了空间。检查*/usr/share/snmp/mibs*以获取额外的MIB文件，并使用您的MIB浏览器查看您的OpenBSD特定版本支持的内容。OpenBSD团队根据需要和代码贡献添加MIB。如果您需要IPsec
    MIB，请随时编写并提交代码。'
- en: The SSH Server sshd
  id: totrans-203
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: SSH服务器sshd
- en: Secure Shell (SSH) is a protocol for building encrypted tunnels between hosts.
    SSH is most commonly used for remote command-line access to a system, but you
    can use it as a generic wrapper around other protocols or even to build virtual
    private networks. One common use for SSH is to support secure file transfer protocol
    service, or SFTP, which doesn’t give you a shell prompt but does encrypt files
    and authentication information as they cross the network.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 安全外壳协议（SSH）是在主机之间建立加密隧道的一种协议。SSH最常用于远程命令行访问系统，但你也可以将其用作其他协议的通用包装器，甚至用于构建虚拟专用网络。SSH的一个常见用途是支持安全文件传输协议服务（SFTP），它不会提供shell提示符，但在文件通过网络传输时会加密文件和认证信息。
- en: The OpenBSD project supports OpenSSH, a freely licensed client and server. OpenSSH
    is the most widely deployed SSH server in the world, with roughly 97 percent market
    share, and is generally considered the standard SSH server. Entire books have
    been written about OpenSSH, including mine (*SSH Mastery,* Tilted Windmill Press,
    2012).
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD项目支持OpenSSH，这是一个免费许可的客户端和服务器。OpenSSH是世界上部署最广泛的SSH服务器，市场份额约为97%，通常被认为是标准的SSH服务器。关于OpenSSH已经写了很多本书，包括我的（《SSH
    Mastery》，Tilted Windmill Press，2012年）。
- en: OpenBSD includes the OpenSSH server `sshd(8)`, the OpenSSH command-line client
    `ssh(1)`, and the SFTP client `sftp(1)`. We’ll focus on `sshd` here, since you
    can use any number of SSH clients. The ones I use most commonly are `ssh` (for
    Unix-like systems) and PuTTY (for Windows). For SFTP, I commonly use `sftp` (for
    Unix-like systems) and WinSCP (for Windows).
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD包括OpenSSH服务器`sshd(8)`，OpenSSH命令行客户端`ssh(1)`，以及SFTP客户端`sftp(1)`。在这里我们将重点关注`sshd`，因为你可以使用任意数量的SSH客户端。我使用最频繁的是`ssh`（用于类Unix系统）和PuTTY（用于Windows）。对于SFTP，我通常使用`sftp`（用于类Unix系统）和WinSCP（用于Windows）。
- en: Disabling sshd
  id: totrans-207
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 禁用sshd
- en: Unless you specified otherwise during installation, OpenBSD starts `sshd` by
    default. If you don’t want `sshd` to run, disable it in */etc/rc.conf.local*.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 除非你在安装过程中指定了其他设置，否则OpenBSD默认会启动`sshd`。如果你不想`sshd`运行，请在*/etc/rc.conf.local*中禁用它。
- en: '[PRE25]'
  id: totrans-209
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: SSH Host Keys
  id: totrans-210
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: SSH主机密钥
- en: The first time you start `sshd`, OpenBSD creates *host keys* in */etc/ssh*.
    These are sets of public and private keys that uniquely identify an SSH server.
    Each key file includes the word *key* in its name. When your client first connects
    to the SSH server, it presents a fingerprint summary of the server’s host key.
    If you tell the client to accept the key, the client will cache the server’s host
    key. If this key ever changes, the client warns the user that the server’s unique
    identity has changed, and that the user might be offering his login credentials
    to a different server. (Anyone who gets copies of the host keys can have another
    server masquerade as yours.) Be sure to back up your host keys, and protect them
    from theft.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 第一次启动`sshd`时，OpenBSD会在*/etc/ssh*目录中创建*主机密钥*。这些是一组公钥和私钥，唯一地标识了一个SSH服务器。每个密钥文件的名字中都包含单词*key*。当你的客户端第一次连接到SSH服务器时，它会展示服务器主机密钥的指纹摘要。如果你告诉客户端接受这个密钥，客户端会缓存服务器的密钥。如果这个密钥发生了变化，客户端会警告用户服务器的唯一身份已改变，用户可能正在向不同的服务器提供他的登录凭证。（任何获得主机密钥副本的人都可以让另一个服务器伪装成你的服务器。）请确保备份你的主机密钥，并保护它们免遭盗窃。
- en: sshd Network Options
  id: totrans-212
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: sshd网络选项
- en: You could change `sshd`’s behavior by adding command-line flags, but the most
    common way to reconfigure `sshd` is to edit the files in */etc/ssh*.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过添加命令行标志来更改`sshd`的行为，但重新配置`sshd`最常见的方式是编辑*/etc/ssh*目录下的文件。
- en: 'OpenSSH has many configuration options. The ones that are most commonly changed
    involve the network settings. You can control the port, IP address, and version
    of IP `sshd` listens to by editing the configuration file */etc/ssh/sshd_config*.
    Here’s an example:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: OpenSSH有许多配置选项。其中最常更改的是网络设置。你可以通过编辑配置文件*/etc/ssh/sshd_config*来控制`sshd`监听的端口、IP地址和IP版本。以下是一个示例：
- en: '[PRE26]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: The `Port` keyword specifies the TCP/IP port that `sshd` attaches to. The default
    is TCP port 22.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: '`Port`关键字指定了`sshd`附加到的TCP/IP端口。默认是TCP端口22。'
- en: Note
  id: totrans-217
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Some people recommend using a port other than 22 to avoid password-guessing
    worms. Far better ways to protect your SSH server are to allow only public-key
    authentication or use a packet filter to allow logins from only selected hosts
    or networks.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 有些人建议使用除22号端口以外的端口来避免密码猜测蠕虫。保护你的SSH服务器更好的方法仅允许公钥认证或使用数据包过滤器只允许来自选定主机或网络的登录。
- en: The `AddressFamily` keyword specifies the version of IP that `sshd` uses. The
    default is to use both IPv4 and IPv6, but you can restrict it to a specific protocol
    with the `inet` (IPv4) or `inet6` (IPv6) keyword.
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: '`AddressFamily` 关键字指定 `sshd` 使用的 IP 版本。默认情况下，使用 IPv4 和 IPv6，但你可以使用 `inet`（IPv4）或
    `inet6`（IPv6）关键字来限制特定协议。'
- en: Lastly, you can attach `sshd` to a specific IP address with the `ListenAddress`
    option.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，你可以使用 `ListenAddress` 选项将 `sshd` 绑定到特定的 IP 地址。
- en: chrooting Users
  id: totrans-221
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: chroot 用户
- en: Organizations commonly need to confine users to a particular directory or subset
    of directories. For example, many websites allow users command-line access over
    SSH so that they can edit their files and debug problems more easily, or even
    just SFTP access to their files. Those users should have access to their own directories,
    but not to other users’ files, or any other part of the system. One solution is
    to `chroot` the user in his home directory. If you have several users who need
    to access a shared directory, you can `chroot` all of them in that directory.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 组织通常需要将用户限制在特定的目录或目录子集。例如，许多网站允许用户通过 SSH 命令行访问，以便他们可以更容易地编辑文件和调试问题，或者甚至只提供文件
    SFTP 访问。这些用户应该有权访问自己的目录，但不能访问其他用户的文件或系统的任何其他部分。一种解决方案是在用户的家目录中 `chroot` 用户。如果你有多个需要访问共享目录的用户，你可以将他们全部
    `chroot` 在该目录中。
- en: 'Locking users in a directory involves three steps: choosing the directory to
    lock users into, populating that directory, and configuring `sshd` to `chroot`
    those users. To demonstrate, we’ll walk through an example of `chroot`ing the
    user `lasnyder` in his home directory, and give him command-line access, so he
    will be able to access only the programs in his `chroot`.'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 将用户锁定在目录中涉及三个步骤：选择要锁定用户的目录、填充该目录以及配置 `sshd` 以 `chroot` 这些用户。为了演示，我们将通过一个示例来展示如何将用户
    `lasnyder` 在他的家目录中 `chroot`，并给他命令行访问权限，这样他只能访问他的 `chroot` 中的程序。
- en: Choosing the Directory
  id: totrans-224
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 选择目录
- en: First, specify the `chroot` directory with the `ChrootDirectory` option.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，使用 `ChrootDirectory` 选项指定 `chroot` 目录。
- en: '[PRE27]'
  id: totrans-226
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: This works well if all of your users need to be locked into the same directory,
    but if you want users to have their own private directory, or if you want to specify
    a directory elsewhere on the filesystem, things get more complex.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 如果所有用户都需要锁定在同一个目录中，这效果很好，但如果你想让用户有自己的私有目录，或者你想要在文件系统中的其他位置指定一个目录，事情就会变得复杂。
- en: OpenSSH supports the `%%`, `%h`, and `%u` macros to represent home directories.
    If your `chroot` directory includes a literal `%`, use the `%%` macro to represent
    it. The server in this example has home directories on */disk%3/home*, so the
    `%%` macro is needed to escape the percent sign.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: OpenSSH 支持使用 `%%`、`%h` 和 `%u` 宏来表示家目录。如果你的 `chroot` 目录包含一个字面 `%`，请使用 `%%` 宏来表示它。本例中的服务器在家目录
    */disk%3/home* 上，因此需要使用 `%%` 宏来转义百分号。
- en: '[PRE28]'
  id: totrans-229
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'The `%u` macro expands to the user’s username. You could use this to give users
    a `chroot` some place other than their home directory (though I don’t know why
    you wouldn’t just give them a home directory in the desired location). Here, each
    user has a directory under */var/www*:'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: '`%u` 宏展开为用户的用户名。你可以使用这个宏来给用户一个除了家目录之外的 `chroot` 目录（尽管我不知道为什么你不想直接在期望的位置给他们一个家目录）。在这里，每个用户在
    */var/www* 下都有一个目录：'
- en: '[PRE29]'
  id: totrans-231
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: Finally, you could lock each user in his home directory with the `%h` macro.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，你可以使用 `%h` 宏将每个用户锁定在他的家目录中。
- en: '[PRE30]'
  id: totrans-233
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: Wherever you lock a user, you must give that directory everything the user needs
    to function, since the user won’t be able to leave that directory to get a tool
    that he might need.
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 无论你在哪里锁定用户，都必须给该目录提供用户执行所需的一切，因为用户将无法离开该目录去获取他可能需要的工具。
- en: Populating the chroot
  id: totrans-235
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 填充 chroot
- en: Most programs, such as a shell, require at least a few device nodes, and the
    user must have a shell program to be able to run one. If a user has only SFTP
    access, you don’t need to do any special preparation of the `chroot`. OpenSSH’s
    SFTP server includes everything it needs. But if users have shell access, they
    need basic device nodes and a shell program.
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数程序，如 shell，至少需要几个设备节点，并且用户必须有一个 shell 程序才能运行。如果一个用户只有 SFTP 访问，你不需要对 `chroot`
    进行任何特殊准备。OpenSSH 的 SFTP 服务器包含它所需的一切。但如果用户有 shell 访问，他们需要基本的设备节点和一个 shell 程序。
- en: For our example, to give `lasnyder` what he needs, go to the `chroot` directory,
    create a *dev* directory, and then make the standard device nodes using `/dev/MAKEDEV`.
    You can remove the `console`, `klog`, `kmem`, `ksyms`, `mem`, and `xf86` devices.
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 对于我们的示例，为了给`lasnyder`提供他所需要的，请进入`chroot`目录，创建一个*dev*目录，然后使用`/dev/MAKEDEV`创建标准的设备节点。你可以移除`console`、`klog`、`kmem`、`ksyms`、`mem`和`xf86`设备。
- en: '[PRE31]'
  id: totrans-238
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: Now we need to get the user a shell. Since programs running inside the shell
    cannot access any files outside the `chroot`, including shared libraries, any
    shell copied into a `chroot` must be statically linked. The included system shells
    are statically linked, and most shells in the ports tree can be built in static
    flavors.
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们需要为用户提供一个shell。由于在shell内运行的程序无法访问`chroot`之外的任何文件，包括共享库，因此复制到`chroot`中的任何shell都必须是静态链接的。包含的系统shell是静态链接的，并且大多数ports树中的shell都可以构建为静态版本。
- en: Verify that a shell is statically linked with `file(1)`, and then create a *bin*
    directory inside the `chroot` and copy the shell there.
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`file(1)`验证shell是否为静态链接，然后在`chroot`内创建一个*bin*目录并将shell复制到那里。
- en: '[PRE32]'
  id: totrans-241
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: Lastly, although a `chroot`ed user should not have write access to his own root
    directory, he needs a real home directory. The user’s home directory in */etc/passwd*
    is relative to the `chroot`; in other words, if a user’s home directory in */etc/passwd*
    is */home/lasnyder*, and the user is `chroot`ed to */home/lasnyder*, his personal
    files and dotfiles actually go in */home/lasnyder/home/lasnyder*.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，尽管被`chroot`的用户不应该有对其自己的根目录的写访问权限，但他需要一个真正的家目录。用户在*/etc/passwd*中的家目录相对于`chroot`；换句话说，如果用户在*/etc/passwd*中的家目录是*/home/lasnyder*，并且用户被`chroot`到*/home/lasnyder*，那么他的个人文件和点文件实际上位于*/home/lasnyder/home/lasnyder*。
- en: '[PRE33]'
  id: totrans-243
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: The user now has a command-line friendly jail cell on the system. Now we need
    to tell `sshd` to lock the user in it.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 用户现在在系统上拥有一个友好的命令行监狱单元格。现在我们需要告诉`sshd`将用户锁在其中。
- en: chrooting Specific Users
  id: totrans-245
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: chroot特定用户
- en: Applying this `chroot` strategy to all of your users probably isn’t advisable—if
    nothing else, your sysadmins need unfettered system access to perform maintenance.
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 将这种`chroot`策略应用于所有用户可能并不明智——至少，你的系统管理员需要无限制的系统访问来执行维护。
- en: To tell `sshd` to `chroot` specific users, either by name or by group, use the
    `Match` keyword at the end of *sshd_config*. Match lets you change `sshd`’s default
    behavior based on factors such as user and client IP address. (`Match` has many
    more functions; see `sshd_config(5)` for examples.)
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 要告诉`sshd`对特定用户进行`chroot`，无论是按名称还是按组，请在*sshd_config*的末尾使用`Match`关键字。`Match`允许你根据用户和客户端IP地址等因素更改`sshd`的默认行为。（`Match`有许多其他功能；请参阅`sshd_config(5)`以获取示例。）
- en: For example, if you wanted to `chroot` only the user `lasnyder`, you could use
    `Match` to specify his username. Early in the configuration, you would have a
    `ChrootDirectory` statement that turns off `chroot` for most users. Then, at the
    end of the configuration, you would change the setting based on matching that
    username.
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果你想仅对用户`lasnyder`进行`chroot`，你可以使用`Match`来指定他的用户名。在配置的早期，你会有一个`ChrootDirectory`语句，该语句关闭大多数用户的`chroot`。然后，在配置的末尾，你会根据匹配该用户名来更改设置。
- en: '[PRE34]'
  id: totrans-249
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: You could also `chroot` all users in a group.
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: 你也可以对组中的所有用户进行`chroot`。
- en: '[PRE35]'
  id: totrans-251
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: If you have multiple `Match` terms, separate them with commas.
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你有多条`Match`条款，请用逗号分隔它们。
- en: '[PRE36]'
  id: totrans-253
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: Or, if most of your users are `chroot`ed, reverse the default and specifically
    de`chroot` your sysadmins.
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，如果你的大多数用户都已被`chroot`，则反转默认设置，并特别为你的系统管理员去`chroot`。
- en: '[PRE37]'
  id: totrans-255
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: With careful configuration, you can restrict access to only the desired users.
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: 通过仔细配置，你可以仅限制对所需用户的访问。
- en: SSH can do a whole lot more, such as securely eliminate passwords from your
    network. It’s worth your time to fully master this protocol.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: SSH可以做很多事情，例如安全地从你的网络中消除密码。完全掌握这个协议是值得你花时间的。
- en: OpenBSD’s built-in services can help you hold your network together, and they
    provide all kinds of useful support infrastructure. Now that you know how to configure
    some of these built-in programs, let’s see how to use OpenBSD as a desktop.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: OpenBSD的内置服务可以帮助你维护你的网络，并提供各种有用的支持基础设施。现在你了解了如何配置一些这些内置程序，让我们看看如何将OpenBSD用作桌面。
