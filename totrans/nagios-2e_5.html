<html><head></head><body>
  <div class="part" title="Part&#xA0;V.&#xA0;Part V Development">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="development"/>Part V. Part V Development</h1>
    </div>

    <div class="partintro" id="id2567080" title="Part V Development"/>
  </div>


  <div class="chapter" title="Chapter&#xA0;24.&#xA0;Writing Your Own Plugins">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="writing_your_own_plugins"/>Chapter 24. Writing Your Own Plugins</h1>
    </div>

    <p><span class="emphasis"><em>Plugins</em></span> are independent programs—called by Nagios—that perform a check and return the result in standardized form. If there is neither a standard plugin for the task you want to perform, nor something appropriate in <span class="strong"><strong>Categories | Check Plugins</strong></span> on NagiosExchange,<sup>[<a class="footnote" href="#ftn.CHP-24-FN-1" id="CHP-24-FN-1">290</a>]</sup> then the best solution is for you to write a plugin yourself.</p>

    <p>The plugin needs only to be executable on the command line, and to return a short text output for the admin and a standardized return value. If you want to make it available on the Internet as well, you need to comply with various guidelines so that it will be widely used and accepted without the need for extensive support.</p>

    <p>There is no restriction <span class="emphasis"><em>in theory</em></span> on the programming language used. Exotic programming languages do restrict portability to other systems and platforms, however, and script languages need to be interpreted, so scripted plugins require more time to execute than compiled ones. But this should not stop anyone from using the language of his or her choice where rapid implementation is more important than portability and speed of execution. But if you are planning to run 2,000 or more checks at five-minute intervals using a script language, you will be forced to tackle the issue of performance.</p>

    <p>Below we will be using the Perl programming language. This exists on almost every Unix system, and the many small tasks that a plugin has to perform, requiring simple text output, are within the classical domain of this script language. There are also numerous ready-made modules available via the CPAN,<sup>[<a class="footnote" href="#ftn.CHP-24-FN-2" id="CHP-24-FN-2">291</a>]</sup> which you can use to deal with emerging tasks in a modular fashion. There remains the problem of the drag on performance caused by the script language. However, with ePN, Nagios has its own integrated Perl interpreter, which considerably improves performance. A separate chapter is devoted to this, from page 669.</p>

    <p>The central hub used when developing a Nagios plugin with Perl is the Perl module <strong class="userinput"><code>Nagios::Plugin</code></strong> by Tom Voon, which really simplifies concrete programming in many aspects. The module <strong class="userinput"><code>Pod::Usage</code></strong> is also used, which enables man pages embedded in the source code of the plugin to be formatted as online help.</p>

    <div class="sect1" title="24.1 Programming Guidelines for Plugins">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="programming_guidelines_for_plugins"/>24.1 Programming Guidelines for Plugins</h1>
      </div>

      <p>Even if you just want to quickly throw something together, you will ultimately make life easier for yourself if you keep to the official <span class="emphasis"><em>Developer Guidelines</em></span><sup>[<a class="footnote" href="#ftn.CHP-24-FN-3" id="CHP-24-FN-3">292</a>]</sup> right from the beginning, as you will seldom be the only person involved with the resulting plugin.<a class="indexterm" id="IDX-CHP-24-1961"/></p>

      <p>The Developer Guidelines currently do not provide an option for processing multiple-line output with Nagios 3.0. The new Application Programming Interface (API) for Nagios 3 plugins is described on the Nagios homepage.<sup>[<a class="footnote" href="#ftn.CHP-24-FN-4" id="CHP-24-FN-4">293</a>]</sup></p>

      <div class="sect2" title="24.1.1 Return values">
        <div class="titlepage">
          <h2 class="title" id="heading_id_4"><a id="return_values"/>24.1.1 Return values</h2>
        </div>

        <p>Nagios expects from a plugin a standardized return value from <strong class="userinput"><code>0</code></strong> to <strong class="userinput"><code>3</code></strong>, which describes the current state of the check performed. The differentiation between the values <strong class="userinput"><code>0</code></strong> (OK) and <strong class="userinput"><code>2</code></strong> (CRITICAL) is almost always defined by the adminstrator when defining the individual check via warning and critical thresholds—only for a few plugins does the plugin itself specify the thresholds.<a class="indexterm" id="IDX-CHP-24-1962"/><a class="indexterm" id="IDX-CHP-24-1963"/><a class="indexterm" id="IDX-CHP-24-1964"/></p>

        <p>The return value <strong class="userinput"><code>3</code></strong> (UNKNOWN) is reserved for errors in operating the plugin (the wrong setting for options, nonexistent options) or internal plugin errors that may prevent the plugin from carrying out its work. The Development Guidelines cite the example here of a network socket which the plugin would like to open, but the call fails. Normal timeouts, on the other hand, should not be answered with UNKNOWN. There are certainly plugins which return WARNING when there is a timeout and only return CRITICAL if a specific threshold has been exceeded. In many cases CRITICAL makes more sense for a general timeout, since this can normally be interpreted as <span class="emphasis"><em>service xyz won't work</em></span>.<a class="indexterm" id="IDX-CHP-24-1965"/><a class="indexterm" id="IDX-CHP-24-1966"/><a class="indexterm" id="IDX-CHP-24-1967"/><a class="indexterm" id="IDX-CHP-24-1968"/><a class="indexterm" id="IDX-CHP-24-1969"/></p>

        <p><a class="xref" href="../Text/ch24.html#return_values_for_nagios_plugins-id1" title="Table 24-1. Return values for Nagios plugins">Table 24-1</a> summarizes the return values and their meanings, arranged by service and host checks. For host checks, Nagios has the states OK, DOWN, and UNREACHABLE, where the difference between DOWN and UNREACHABLE reflects only the spatial arrangement: Is the failed host <span class="emphasis"><em>itself</em></span> involved, or a host that lies <span class="emphasis"><em>behind</em></span> a failed host? This is why it makes sense to distinguish only between return values for <span class="emphasis"><em>state ok</em></span> (<strong class="userinput"><code>0</code></strong>) and <span class="emphasis"><em>error state</em></span> (<strong class="userinput"><code>2</code></strong>).</p>

        <div class="table">
          <a id="return_values_for_nagios_plugins-id1"/>

          <p class="title">Table 24-1. Return values for Nagios plugins</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Return values for Nagios plugins">
              <colgroup>
                <col/>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Status</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Service Check</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Host Check</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p>0</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>OK</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>UP</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>1</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>WARNING</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>UP or DOWN/UNREACHABLE<sup>[<a class="footnote" href="#ftn.CHP-24-FN-5" id="CHP-24-FN-5">a</a>]</sup></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>2</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>CRITICAL</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>DOWN/UNREACHABLE</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p>3</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>UNKNOWN</p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>DOWN/UNREACHABLE</p>
                  </td>
                </tr>
              </tbody>

              <tbody class="footnotes">
                <tr>
                  <td colspan="3">
                    <div class="footnote">
                      <p><sup>[<a class="para" href="#CHP-24-FN-5" id="ftn.CHP-24-FN-5">a</a>]</sup> see text</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <p>How the return value 1 is handled in Nagios 3.0 depends on the parameter <strong class="userinput"><code>use_aggressive_host_checking</code></strong> (<a class="xref" href="../Text/apa.html#an_overview_of_the_nagios_configuration" title="A.1 The Main Configuration File nagios.cfg">A.1 The Main Configuration File nagios.cfg</a>): if this is set to <strong class="userinput"><code>1</code></strong>, the return value <strong class="userinput"><code>1</code></strong> means DOWN/UNREACHABLE, otherwise Nagios will evaluate the host as UP.<a class="indexterm" id="IDX-CHP-24-1970"/></p>
      </div>

      <div class="sect2" title="24.1.2 Information for the administrator on the standard output">
        <div class="titlepage">
          <h2 class="title" id="heading_id_5"><a id="information_for_the_administrator_on_th"/>24.1.2 Information for the administrator on the standard output</h2>
        </div>

        <p>Nagios expects a text on the standard output that informs the administrator—in the Web interface, for instance—about the current state. This output should keep to specific form, however:<a class="indexterm" id="IDX-CHP-24-1971"/><a class="indexterm" id="IDX-CHP-24-1972"/><a class="indexterm" id="IDX-CHP-24-1973"/><a class="indexterm" id="IDX-CHP-24-1974"/></p><a id="I_programlisting1_d1e48899"/>
        <pre class="programlisting"><span class="emphasis"><em>TYPE_OF_CHECK STATUS-text information</em></span></pre>

        <p>In practice this looks something like what is shown in the following three examples:</p><a id="I_programlisting1_d1e48904"/>
        <pre class="programlisting">SMTP OK - 0 second response time
CHECKSAP OK - system p10db012_P10_00 available
PROCS WARNING: 4 processes with command name 'pppoe'</pre>

        <p>The Web interface shows the return value itself only indirectly via the color, and the text contains the current state in a legible form. The contents of the text output should otherwise be based on what will provide the administrator with the most information for the check specifically carried out.</p>

        <p>There are considerable differences between Nagios 2.x and Nagios 3.0 with respect to the requirements of the text output. For Nagios 2.x the text must be in one line, as shown in the examples. It will only process the first line of a multiple-line output. The entire text, including the performance data (we will discuss this in <a class="xref" href="../Text/ch24.html#timeout" title="24.1.6 Timeout">24.1.6 Timeout</a>) may not exceed a length of 300 bytes.</p>

        <p>Nagios 3.0 processes output of up to a maximum length of 8192 bytes, and the output may contain several lines. The multiple-line format is described in <a class="xref" href="../Text/ch08s05.html#multiple-line_plugin_output" title="8.5.1 Multiple-line plugin output">8.5.1 Multiple-line plugin output</a> in page 193.</p>

        <p>If you are programming a plugin that makes use of the advantages of Nagios 3.0 (multiple lines, text longer than 300 bytes), you need to realize that this plugin can only be used with limitations in Nagios 2.x. You should therefore carefully consider whether the multiple-line output format is the right approach for the specific problem. Remember that you can summarize the results of several individual checks with the <strong class="userinput"><code>check_multi</code></strong> plugin (see <a class="xref" href="../Text/ch08s05.html" title="8.5 Summarizing Checks with check_multi">8.5 Summarizing Checks with check_multi</a>, page 191) and in this way reduce the number of individual checks performed—to optimize performance, say—without missing out on detailed text information. However, an individual check always provides just one return value, which in this case is a collective result. Another approach would be to start the test via a script and cron, and pass on individual results to Nagios as passive checks.</p>

        <p>For this reason, it is recommended that you do without multiple-line output for general plugins and comply with the limitations of Nagios 2.x.</p>
      </div>

      <div class="sect2" title="24.1.3 Onboard online help?">
        <div class="titlepage">
          <h2 class="title" id="heading_id_6"><a id="onboard_online_help_question"/>24.1.3 Onboard online help?</h2>
        </div>

        <p>Classic Nagios plugins, including the core plugins, do not include separate man pages but are <span class="emphasis"><em>self-documenting:</em></span> Help is obtained by calling with the switches <strong class="userinput"><code>-h</code></strong> or <strong class="userinput"><code>--help</code></strong>. This does not mean that there cannot be any other documentation, but the integrated help shold be be complete and all existing options described in detail, so that the plugin can be used without any further documentation.<a class="indexterm" id="IDX-CHP-24-1976"/><a class="indexterm" id="IDX-CHP-24-1975"/></p>

        <p>Some plugins provide just a short help text with <strong class="userinput"><code>-h</code></strong> and the complete help text with <strong class="userinput"><code>--help</code></strong>. In this case, the output of <strong class="userinput"><code>-h</code></strong> should indicate that more information can be retrieved with the long form.</p>

        <p>The help text should also be adjusted to the width of a normal terminal and not exceed 80 characters in length. It is quite often the case that an administrator is in the server room trying to solve a problem, faced with a simple console.</p>

        <p>The help should always be written in English. For localization purposes, that is, output in different languages, <strong class="userinput"><code>gettext</code></strong> can be used. This tool translates text to be displayed using a simple file-based database. If no text exists for the target language, <strong class="userinput"><code>gettext</code></strong> displays the untranslated text, so it behaves in an error-tolerant manner. Further information can be found in the man page or info page for <strong class="userinput"><code>gettext</code></strong>.<a class="indexterm" id="IDX-CHP-24-1977"/></p>

        <p>For Perl scripts, <strong class="userinput"><code>man perllocale</code></strong><sup>[<a class="footnote" href="#ftn.CHP-24-FN-6" id="CHP-24-FN-6">294</a>]</sup> is a good starting point. For a concrete application, we recommend the Perl module <strong class="userinput"><code>Text::Domain</code></strong>, which considerably simplifies localization.</p>
      </div>

      <div class="sect2" title="24.1.4 Reserved options">
        <div class="titlepage">
          <h2 class="title" id="heading_id_7"><a id="reserved_options"/>24.1.4 Reserved options</h2>
        </div>

        <p>The programming guidelines provide options that have the same meaning for all plugins. The most important of these are listed in <a class="xref" href="../Text/ch06.html#standard_options_of_plugins" title="Table 6-2. Standard options of plugins">Table 6-2</a> in page 108.<a class="indexterm" id="IDX-CHP-24-1978"/><a class="indexterm" id="IDX-CHP-24-1979"/><a class="indexterm" id="IDX-CHP-24-1980"/><a class="indexterm" id="IDX-CHP-24-1981"/><a class="indexterm" id="IDX-CHP-24-1982"/><a class="indexterm" id="IDX-CHP-24-1983"/></p>

        <p>In addition there are several reserved options which are sometimes assigned twice in the short form. Thus, <strong class="userinput"><code>-u</code></strong> can stand for a user name (<strong class="userinput"><code>--user</code></strong>), but also for a URL (<strong class="userinput"><code>--url</code></strong>). The option <strong class="userinput"><code>-p</code></strong> in turn allows a TCP or UDP port (<strong class="userinput"><code>--port</code></strong>) to be specified, but also a password (<strong class="userinput"><code>--password</code></strong>). The user name can also be passed on with <strong class="userinput"><code>−l</code></strong> or <strong class="userinput"><code>--logname</code></strong>, and the password (in more general terms, the authentication string, which can also be a Kerberos realm) with <strong class="userinput"><code>-a</code></strong> or <strong class="userinput"><code>--authentication</code></strong>.</p>

        <p>The fact that these options may have two different meanings is rather unfortunate, and is presumably for historical reasons. In case of doubt you should steer clear of such double assignments and use only the long form of the option whose meaning is clear. Many GNU and other Open Source programs behave in a similar fashion (e.g., <strong class="userinput"><code>tar</code></strong>, <strong class="userinput"><code>rsync</code></strong>,...). The main thing here is that a reserved option is not used for another purpose. The reserved option <strong class="userinput"><code>-C</code></strong>/<strong class="userinput"><code>--community</code></strong>, for instance, only makes sense in combination with SNMP queries. If the plugin has nothing to do with SNMP, you should not misuse it for other purposes.</p>
      </div>

      <div class="sect2" title="24.1.5 Specifying thresholds">
        <div class="titlepage">
          <h2 class="title" id="heading_id_8"><a id="specifying_thresholds"/>24.1.5 Specifying thresholds</h2>
        </div>

        <p><span class="emphasis"><em>Thresholds</em></span> determine whether a plugin returns OK or an error value (WARNING, CRITICAL). Thresholds always specify a range according to the pattern <span class="emphasis"><em>from:to</em></span>.</p>

        <p>The exclusion principle here takes some getting used to. A warning threshold in the form <strong class="userinput"><code>-w 10:20</code></strong> means that a value within the specified range does <span class="emphasis"><em>not</em></span> lead to a WARNING. The warning state includes all values from -∞ to and including 9 and from 21 to ∞.</p>

        <p>The interaction between warning and critical thresholds can best be explained by means of an example. Suppose Nagios is monitoring the temperature in the server room. Normally the temperature should lie between 18°C and 22°C. In each case, two degrees Centigrade above and below this range is set as the tolerance range, for which a WARNING should be shown. Below 16°C and above 24°C, Nagios should report a CRITICAL state.</p>

        <p>Converted into thresholds, the scenario sketched in <a class="xref" href="../Text/ch24.html#what_happens_with_the_thresholds_-w_18" title="Figure 24-1. What happens with the thresholds -w 18:22 -c 16:24?">Figure 24-1</a> should look like this: <strong class="userinput"><code>-w 18:22 -c 16:24</code></strong>. The temperatures between 22°C and 24°C are not critical, but are only covered by the warning range. The temperature range above 24°C covers both threshold intervals, and there the stronger error value (CRITICAL) predominates.</p>

        <div class="figure">
          <a id="what_happens_with_the_thresholds_-w_18"/>

          <div class="figure-contents mediaobject"><a id="I_mediaobject1_d1e49098"/><img alt="What happens with the thresholds -w 18:22 -c 16:24?" src="../Images/tagoreillycom20081104nostarchimages224012.png.jpg"/></div>

          <p class="title">Figure 24-1. What happens with the thresholds <code class="userinput">-w 18:22 -c 16:24</code>?</p>
        </div>

        <p>To negate a value range, you just place a <strong class="userinput"><code>@</code></strong> in front of it: <strong class="userinput"><code>-w @10:20</code></strong> now ensures that a WARNING will be shown if the value determined is larger or equal to 10 and smaller or equal to 20. If the start value equals 0, this can be left out: <strong class="userinput"><code>-w 20</code></strong> has the same effect as <strong class="userinput"><code>-w 0:20</code></strong>. An infinite final value does not need to be specified, but the colon after the start value must remain in place: <strong class="userinput"><code>-w 10:</code></strong>. The tilde (<strong class="userinput"><code>˜</code></strong>) stands for negative infinity, and no provision is made for a separate sign for infinity (see <a class="xref" href="../Text/ch24.html#special_syntax_for_specifying_thresholds" title="Table 24-2. Special syntax for specifying thresholds">Table 24-2</a>).</p>

        <div class="table">
          <a id="special_syntax_for_specifying_thresholds"/>

          <p class="title">Table 24-2. Special syntax for specifying thresholds</p>

          <div class="table-contents">
            <table class="sgc-3" summary="Special syntax for specifying thresholds">
              <colgroup>
                <col/>
                <col/>
              </colgroup>

              <thead>
                <tr>
                  <th class="sgc-1" valign="bottom">
                    <p>Threshold</p>
                  </th>

                  <th class="sgc-1" valign="bottom">
                    <p>Area covered</p>
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code><em class="replaceable"><code>end</code></em></code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>0:</code></strong> <strong class="userinput"><code><em class="replaceable"><code>end</code></em></code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code><em class="replaceable"><code>start:</code></em></code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code><em class="replaceable"><code>start:</code></em></code></strong>∞</p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code>˜:</code></strong> <strong class="userinput"><code><em class="replaceable"><code>end</code></em></code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>-∞<strong class="userinput"><code>:</code></strong><strong class="userinput"><code><em class="replaceable"><code>end</code></em></code></strong></p>
                  </td>
                </tr>

                <tr>
                  <td class="sgc-2" valign="top">
                    <p><strong class="userinput"><code><em class="replaceable"><code>@start:end</code></em></code></strong></p>
                  </td>

                  <td class="sgc-2" valign="top">
                    <p>not <strong class="userinput"><code><em class="replaceable"><code>start:end</code></em></code></strong></p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="sect2" title="24.1.6 Timeout">
        <div class="titlepage">
          <h2 class="title" id="heading_id_9"><a id="timeout"/>24.1.6 Timeout</h2>
        </div>

        <p>A plugin may not always perform its task in a reasonable amount of time. For instance, it may use <strong class="userinput"><code>df</code></strong> to access a volume mounted via NFS, the host of which is not currently available. Or, a firewall may reject the network packets from a network plugin, and the plugin was not designed to notice this. However, Nagios would like to receive a sensible reply from its plugins at some point in time; if any type of checks are hanging around in limbo somewhere, this consumes unnecessary resources and can really cause chaos for the Nagios scheduler.<a class="indexterm" id="IDX-CHP-24-1985"/><a class="indexterm" id="IDX-CHP-24-1986"/><a class="indexterm" id="IDX-CHP-24-1984"/><a class="indexterm" id="IDX-CHP-24-1987"/></p>

        <p>Each plugin should therefore cancel its actions after a preset time—normally ten seconds—and return a corresponding error result to Nagios. The option <strong class="userinput"><code>-t</code></strong> (<strong class="userinput"><code>--timeout</code></strong>) enables a different timeout value to be specified when a plugin is called.</p>

        <p>A modified timeout makes sense, for instance, if a plugin is run indirectly via NRPE (see <a class="xref" href="../Text/ch10.html" title="Chapter 10. The Nagios Remote Plugin Executor (NRPE)">Chapter 10</a> from page 213). The timeout of <strong class="userinput"><code>check_nrpe</code></strong>, which Nagios is running directly, should sensibly be somewhat longer than the timeout for the plugin itself, so that <strong class="userinput"><code>check_nrpe</code></strong> does not cancel the execution without learning something about the real cause.</p>
      </div>

      <div class="sect2" title="24.1.7 Performance data">
        <div class="titlepage">
          <h2 class="title" id="heading_id_10"><a id="performance_data"/>24.1.7 Performance data</h2>
        </div>

        <p>Performance data present result values in a standardized form, described from page 404, which enables these values to be processed automatically by external programs. They come after the normal text output, separated by the | sign.<a class="indexterm" id="IDX-CHP-24-1988"/><a class="indexterm" id="IDX-CHP-24-1989"/><a class="indexterm" id="IDX-CHP-24-1990"/><a class="indexterm" id="IDX-CHP-24-1991"/></p>

        <p>As long as the plugin finds numerical values, it should always display these values as performance data. If an external program can process such data automatically, there is little configuration work for the administrator. There are some external programs that can, if necessary, fish out information from the normal text output, but because of the lack of standardization, this is always associated with extra work—and not every Nagios admin can handle Perl-compatible regular expressions perfectly. For this reason, every plugin programmer should always include performance data provided that the specific application allows this.<a class="indexterm" id="IDX-CHP-24-1992"/></p>
      </div>

      <div class="sect2" title="24.1.8 Copyright">
        <div class="titlepage">
          <h2 class="title" id="heading_id_11"><a id="copyright"/>24.1.8 Copyright</h2>
        </div>

        <p>A plugin should be furnished with a clear copyright notice that names the license and the author. For plugins written in languages that are compiled (such as C), the two items are stored in separate text files so that this information is not lost when the plugin is later distributed in binary form. The standard approach is to have one <strong class="userinput"><code>COPYING</code></strong> file containing the complete license in question (for example, the GNU Public License) and an <strong class="userinput"><code>AUTHORS</code></strong> file with the names of the authors.</p>

        <p>For plugins written in script languages, it is sufficient to have the copyright notice in the source code itself, since the plugin is normally distributed in a readable form.</p>

        <p>It is also useful to provide a brief output of the copyright when displaying the version number with the option <strong class="userinput"><code>--version</code></strong>.</p>

        <p>If the plugin is based on already existing code, or if individuals have been involved in the form of patches or suggestions, the Developer Guidelines require the files <strong class="userinput"><code>ACKNOWLEDGEMENTS</code></strong> and <strong class="userinput"><code>THANKS</code></strong>. The first one is used if the code originally had a different author (or if parts of code are recycled), and the latter includes the names of those who have made contributions in the form of patches and sometimes in the form of important ideas.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-24-FN-1" id="ftn.CHP-24-FN-1">290</a>]</sup> <a class="ulink" href="http://www.nagiosexchange.org/Check_Plugins.21.0.html">http://www.nagiosexchange.org/Check_Plugins.21.0.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-24-FN-2" id="ftn.CHP-24-FN-2">291</a>]</sup> <a class="ulink" href="http://www.cpan.org">http://www.cpan.org</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-24-FN-3" id="ftn.CHP-24-FN-3">292</a>]</sup> <a class="ulink" href="http://nagiosplug.sourceforge.net/developer-guidelines.html">http://nagiosplug.sourceforge.net/developer-guidelines.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-24-FN-4" id="ftn.CHP-24-FN-4">293</a>]</sup> <a class="ulink" href="http://nagiosplug.sourceforge.net/developer-guidelines.html">http://nagiosplug.sourceforge.net/developer-guidelines.html</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-24-FN-6" id="ftn.CHP-24-FN-6">294</a>]</sup> <a class="ulink" href="http://perldoc.perl.org/perllocale.html">http://perldoc.perl.org/perllocale.html</a></p>
      </div>
    </div>
  </div>


  <div class="sect1" title="24.2 The Perl Module Nagios::Plugin">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_perl_module_nagios_colon_colon_plugi"/>24.2 The Perl Module <strong class="userinput"><code>Nagios::Plugin</code></strong></h1>
    </div>

    <p>If you want to create plugins in Perl with as little effort as possible, while at the same time conforming to the programming guidelines, the Perl module <strong class="userinput"><code>Nagios::Plugin</code></strong> is at hand to provide support to developers. We will introduce it here in version 0.21 from October 2007. In this version the main functions are well developed and should not undergo any major changes, apart from the message functions, which are still marked as being experimental.</p>

    <p>This object-oriented module contains constants and variables to represent states; exit functions that use not only a Nagios-compatible exit code, but also the same formatting; and functions for testing thresholds and for the correct output of performance data. In addition, it provides functions for parsing the command line, as well as an integrated help function. On this last point, the module deviates from the standard Perl convention: There is already an extensive module for the command line with <strong class="userinput"><code>Getopt::Long</code></strong>, and for online help, Perl provides the Perl Online Documentation (POD).</p>

    <div class="sect2" title="24.2.1 Installation">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="installation-id12"/>24.2.1 Installation</h2>
      </div>

      <p><strong class="userinput"><code>Nagios::Plugin</code></strong> is one of the core plugins, but it can alternatively be installed via the CPAN. This anchors the module in the system in such a way that Perl finds it automatically. But the module does cause other modules to be installed as well, which is not always desirable on a certified system.</p>

      <p>After the installation of the core plugins, <strong class="userinput"><code>Nagios::Plugin</code></strong> can be found in its own directory, together with all dependent modules. The existing Perl installation is not affected by this, but Perl does not find the module automatically in this way. Any plugins based on this must explicitly set the path to the base directory of the module themselves.</p>

      <div class="sect3" title="The method using the CPAN">
        <div class="titlepage">
          <h3 class="title" id="heading_id_4"><a id="the_method_using_the_cpan"/>The method using the CPAN</h3>
        </div>

        <p>The CPAN installation command for <strong class="userinput"><code>Nagios::Plugin</code></strong> checks existing dependencies and at the same time installs any modules required:</p><a id="I_programlisting1_d1e49325"/>
        <pre class="programlisting">linux:~ # <span class="strong"><strong>perl -MCPAN -e 'install Nagios::Plugin'</strong></span>
...</pre>

        <p>In some circumstances, modules that you have previously installed will be updated. If you are running <strong class="userinput"><code>perl -MCPAN</code></strong> for the first time, Perl will ask a number of questions that are answered interactively—apart from the selection of the download server, the suggested defaults can be used.</p>
      </div>

      <div class="sect3" title="Together with the core plugins">
        <div class="titlepage">
          <h3 class="title" id="heading_id_5"><a id="together_with_the_core_plugins"/>Together with the core plugins</h3>
        </div>

        <p>Starting with version 1.4.10, the <strong class="userinput"><code>nagios-plugins*</code></strong> tar archive also contains the Perl module. It is included in the installation if you use the <strong class="userinput"><code>--enable-perl-modules</code></strong> switch (see <a class="xref" href="../Text/ch01s04.html" title="1.4 Installing and Testing Plugins">1.4 Installing and Testing Plugins</a>, page 43) when running the <strong class="userinput"><code>configure</code></strong> command. The module is installed to the directory <strong class="userinput"><code>/usr/local/nagios/perl</code></strong>, complying with the conventions used in this book.</p>

        <p>In order for a plugin to be able to find the module, you must explicitly set the path, via <strong class="userinput"><code>use lib</code></strong>. In his FAQ,<sup>[<a class="footnote" href="#ftn.CHP-24-FN-7" id="CHP-24-FN-7">295</a>]</sup> Ton Voon recommends using the Perl module <strong class="userinput"><code>FindBin</code></strong>:</p><a id="I_programlisting1_d1e49366"/>
        <pre class="programlisting">use FindBin;
use lib "$FindBin::Bin/../perl/lib";
use Nagios::Plugin;</pre>

        <p><strong class="userinput"><code>FindBin</code></strong> is a component of the Perl distribution and finds the path to the directory from which the plugin was called. In accordance with our conventions, this is the directory <strong class="userinput"><code>/usr/local/nagios/libexec</code></strong>. This path is queried with the variable <strong class="userinput"><code>$FindBin::Bin</code></strong>, and <strong class="userinput"><code>use lib</code></strong> then integrates the Nagios-specific Perl directory relative to this directory. Whether the Linux distributions will set up a Perl directory with an identical relative path remains to be seen. As long as you install the core plugins yourself, the three-line command will work as intended.</p>

        <p>If <strong class="userinput"><code>Nagios::Plugin</code></strong> cannot be found in the path specified, Perl will search through all other standard paths. In this way the module will be found if it originates from the CPAN or (in the future) from distribution packages.</p>
      </div>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-24-FN-7" id="ftn.CHP-24-FN-7">295</a>]</sup> <a class="ulink" href="http://www.nagiosplugins.org/faq/development/nagios-plugin-perl">http://www.nagiosplugins.org/faq/development/nagios-plugin-perl</a></p>
      </div>
    </div>
  </div>


  <div class="chapter" title="Chapter&#xA0;25.&#xA0;Determining File and Directory Sizes">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="determining_file_and_directory_sizes"/>Chapter 25. Determining File and Directory Sizes</h1>
    </div>

    <p>For a specific example of a Perl plugin, we will look at <strong class="userinput"><code>check_du.pl</code></strong>.<sup>[<a class="footnote" href="#ftn.CHP-25-FN-1" id="CHP-25-FN-1">296</a>]</sup> It is used to determine the size of specified files or directories and to check whether the total size lies within preset thresholds. To do this, it calls the system program <strong class="userinput"><code>du</code></strong>:<a class="indexterm" id="IDX-CHP-25-1993"/></p><a id="I_programlisting2_d1e49406"/>
    <pre class="programlisting">user@linux:~$ <span class="strong"><strong>du -cs /var/spool/var/log</strong></span>
26524   /var/spool
745640  /var/log
772164  total</pre>

    <p>When used with the <strong class="userinput"><code>-s</code></strong> option, <strong class="userinput"><code>du</code></strong> does not list all the individual subdirectories but just shows the total size. <strong class="userinput"><code>-c</code></strong> adds up individual values to reach a total size.</p>

    <p>At the beginning, the plugin generates a new <strong class="userinput"><code>new Nagios::Plugin</code></strong> object with the <strong class="userinput"><code>new</code></strong> constructor so that it can make use of the functions of the module:</p><a id="I_programlisting2_d1e49430"/>
    <pre class="programlisting">#!/usr/bin/perl -w
use strict;
use warnings;
use FindBin;
use lib "$FindBin::Bin/../perl/lib";
use Nagios::Plugin;

my $np = Nagios::Plugin-&gt;new(shortname ⇒ "CHECK_DU");</pre>

    <p>Various parameters can be used here. <strong class="userinput"><code>shortname</code></strong> contains the short name of the check to be performed, which will be later prefixed to all outputs:<sup>[<a class="footnote" href="#ftn.CHP-25-FN-2" id="CHP-25-FN-2">297</a>]</sup></p><a id="I_programlisting2_d1e49443"/>
    <pre class="programlisting">CHECK_DU OK - check size: 1128 kByte | size=1128kB;;</pre>

    <p>The contents of the first line after <strong class="userinput"><code>#!</code></strong> define the interpreter to be run, which is Perl. The option <strong class="userinput"><code>-w</code></strong> and the following <strong class="userinput"><code>use warnings</code></strong>—which both ensure extensive output, provided that Perl objects to something in the script—are duplicated here intentionally. In Perl versions prior to 5.6, there is no <strong class="userinput"><code>use warnings</code></strong> parameter, so you must comment out the statement and use <strong class="userinput"><code>-w</code></strong>. To make sure that no one forgets this, <strong class="userinput"><code>-w</code></strong> is included from the beginning. The instruction <strong class="userinput"><code>use strict</code></strong> enforces a strict syntactical check and forces the programmer to pre-declare all variables. Many simple errors are avoided when this is used.</p>

    <p>The core function of the plugin is constructed in a relatively simple manner:</p><a id="I_programlisting2_d1e49471"/>
    <pre class="programlisting">open ( OUT, "LANG=C /usr/bin/du -cs $what 2&gt;&amp;1 |" )
   or $np-&gt;nagios_die( "can't start /usr/bin/du" );
while (&lt;OUT&gt;) {
   print "$_" if ($verbose);
   chomp $_;
   $denied++ if ( /Permission denied/i );
   if ( /^(\d+)\s+total$/i ) {
      $size = $1;
      last;
   }
}
close (OUT);</pre>

    <p><strong class="userinput"><code>open</code></strong> calls the program <strong class="userinput"><code>du</code></strong> and handles the output as if this came from an opened file. If the call fails, <strong class="userinput"><code>nagios_die</code></strong> from the module <strong class="userinput"><code>Nagios::Plugin</code></strong> terminates execution of the plugin and issues an error message. Before the <strong class="userinput"><code>du</code></strong> program is called, <strong class="userinput"><code>LANG=C</code></strong> explicitly sets the language to the English default, so that the texts displayed by <strong class="userinput"><code>du</code></strong> do not depend on the specific environment.</p>

    <p>The <strong class="userinput"><code>while</code></strong> loop reads the output line for line and checks whether all directories can be evaluated. If <strong class="userinput"><code>Permission denied</code></strong> appears in the text of the output, the plugin makes a note of this in the variable <strong class="userinput"><code>$denied</code></strong>, which at the end contains the number of nonreadable directories. If <strong class="userinput"><code>$verbose</code></strong> does not equal zero, the plugin sends all lines received by <strong class="userinput"><code>du</code></strong> to STDOUT for debugging purposes. <strong class="userinput"><code>chomp</code></strong> removes the end of line from the just-processed line called in <strong class="userinput"><code>$_</code></strong>.</p>

    <p>From the line reporting the total size—identified by the text <strong class="userinput"><code>total</code></strong> at the end of the line of output—the plugin extracts the displayed number using the regular expression in the parentheses. This amount is what <strong class="userinput"><code>$1</code></strong> now contains. If there is a match, <strong class="userinput"><code>last</code></strong> terminates the <strong class="userinput"><code>while</code></strong> loop, and then the <strong class="userinput"><code>close</code></strong> function closes the file handle correctly.</p>

    <div class="sect1" title="25.1 Splitting up the Command Line With Getopt::Long">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="splitting_up_the_command_line_with_getop"/>25.1 Splitting up the Command Line With <strong class="userinput"><code>Getopt::Long</code></strong></h1>
      </div>

      <p>The module <strong class="userinput"><code>Getopt::Long</code></strong> provides a function, <strong class="userinput"><code>GetOptions</code></strong>, that simplifies the fragmentation of the command line in the style of many GNU programs:</p><a id="I_programlisting2_d1e49551"/>
      <pre class="programlisting">use Getopt::Long qw(:config no_ignore_case bundling);

GetOptions(
    "P|path=s"         ⇒ \$what,
    "w|warning=s"      ⇒ \$warn threshold,
    "c|critical=s"     ⇒ \$crit threshold,
    "t|timeout=s"      ⇒ \$timeout,
    "h|help"           ⇒ \$help,
    "V|version"        ⇒ \$printversion,
    "v|verbose+"       ⇒ \$verbose,
    "d|debug:+"        ⇒ \$debug,
) or <span class="emphasis"><em>die_with_help;</em></span></pre>

      <p>The instruction <strong class="userinput"><code>qw(:conf ig no_ignore_case)</code></strong> configures the behavior of <strong class="userinput"><code>GetOptions</code></strong> so that a distinction is made between upper and lower case.<strong class="userinput"><code>qw(:config bundling)</code></strong> allows short options to be combined, as is normal for older Unix and GNU programs; instead of <strong class="userinput"><code>-a -b -c</code></strong>, the user can write <strong class="userinput"><code>-abc</code></strong>.</p>

      <p>In the <strong class="userinput"><code>GetOptions</code></strong> option, you enumerate all the options of the plugin and pass a reference to a variable for each option. The variables used in the call of <strong class="userinput"><code>GetOptions</code></strong> had to be pre-declared because of the <strong class="userinput"><code>use strict</code></strong> parameter (e. g., with <strong class="userinput"><code>my $what = ";</code></strong>). This stores the arguments that have been passed on the command line with the corresponding option. The string on the left side defines under what name the option can be called. An option listed as</p><a id="I_programlisting2_d1e49586"/>
      <pre class="programlisting">"P|path|directory=s"</pre>

      <p>can be called as <strong class="userinput"><code>-P</code></strong> <strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong>, <strong class="userinput"><code>--path</code></strong> <strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong>, <strong class="userinput"><code>--path=</code></strong><strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong>, and also as <strong class="userinput"><code>--directory=</code></strong><strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong>. All long forms can also be abbreviated, as long as the abbreviation is unambiguous. Examples of this are <strong class="userinput"><code>--pf</code></strong> <strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong>, <strong class="userinput"><code>--pa</code></strong> <strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong>, or <strong class="userinput"><code>--dir=</code></strong><strong class="userinput"><code><em class="replaceable"><code>path</code></em></code></strong>.</p>

      <p>The instruction <strong class="userinput"><code>=s</code></strong> at the end states that the argument, which in this case is of the type string (<strong class="userinput"><code>s</code></strong>), must follow the option. Alternatives are <strong class="userinput"><code>i</code></strong>(integer), <strong class="userinput"><code>o</code></strong> (Perl integer, i.e., including octal and hexadecimal numbers), and <strong class="userinput"><code>f</code></strong> (floating-point decimal). If a colon is used instead of the equals sign, the argument is optional.</p>

      <p>A plus sign following the option name, as in <span class="strong"><strong>v |</strong></span><strong class="userinput"><code>verbose+</code></strong>, allows the option to be specified multiple times on the command line. Each time it is used, the variable is incremented. If the user selects the option <strong class="userinput"><code>--verbose</code></strong>, <strong class="userinput"><code>$verbose</code></strong> will contain the value <strong class="userinput"><code>1</code></strong>, but if he selects <strong class="userinput"><code>--verbose --verbose</code></strong> (or <strong class="userinput"><code>--verbose</code></strong> <span class="strong"><strong>-v</strong></span>), it will contain <strong class="userinput"><code>2</code></strong>, and so on. If you include the plus sign in combination with the colon (e. g., <strong class="userinput"><code>d|debug:+</code></strong>), the user can assign an integer to the variable when running the command: <strong class="userinput"><code>--debug=5</code></strong> sets the variable <strong class="userinput"><code>$debug</code></strong> to <strong class="userinput"><code>5</code></strong>. If he calls just <strong class="userinput"><code>--debug</code></strong>, <strong class="userinput"><code>$debug</code></strong> will only have the value <strong class="userinput"><code>1</code></strong>.</p>

      <p>When calling <strong class="userinput"><code>GetOptions</code></strong> you should always check to see whether an error occurs, for instance through an error condition. In Perl this is written as follows:</p><a id="I_programlisting2_d1e49711"/>
      <pre class="programlisting">GetOptions(...) or <span class="emphasis"><em>die_with_help;</em></span></pre>

      <p>In case of error, the Developer Guidelines demand that the reason for termination must be specified, along with a short online help. For this, we need to use the Perl Online Documentation and the module <strong class="userinput"><code>Pod::Usage</code></strong>.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-25-FN-1" id="ftn.CHP-25-FN-1">296</a>]</sup> The plugin is available on the author's homepage at <a class="ulink" href="http://linux.swobspace.net/projects/nagios/perl-nagios-plugins.html">http://linux.swobspace.net/projects/nagios/perl-nagios-plugins.html</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-25-FN-2" id="ftn.CHP-25-FN-2">297</a>]</sup> Other parameters are required for the online help functions of the module, which we will not use here. We will use the module <strong class="userinput"><code>Pod::Usage</code></strong> instead.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="25.2 The Perl Online Documentation">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="the_perl_online_documentation"/>25.2 The Perl Online Documentation</h1>
    </div>

    <p>The Perl Online Documentation (POD) is a simple markup language, which is based on conventional man pages. It enables you to include the documentation for a Perl script in the script itself. The command <strong class="userinput"><code>perldoc</code></strong> <strong class="userinput"><code><em class="replaceable"><code>script</code></em></code></strong> provides this ready-formatted:<sup>[<a class="footnote" href="#ftn.CHP-25-FN-3" id="CHP-25-FN-3">298</a>]</sup><a class="indexterm" id="IDX-CHP-25-1994"/><a class="indexterm" id="IDX-CHP-25-1995"/></p><a id="I_programlisting2_d1e49747"/>
    <pre class="programlisting">#!/usr/bin/perl -w
<span class="strong"><strong>=head1</strong></span> NAME

check_du.pl - Nagios plugin for checking size of directories and files

<span class="strong"><strong>=head1</strong></span> SYNOPSIS

check_du.pl -P path/pattern [-v] [-w warning_threshold] [-c critical_threshold]
check_du.pl [-h|-V]

<span class="strong"><strong>=head1</strong></span> OPTIONS

<span class="strong"><strong>=over 4</strong></span>

<span class="strong"><strong>=item</strong></span> -P|--path=expression

Path expression for calculating size. May be a shell expression like /var/log/<span class="strong"><strong>*</strong></span>.log

<span class="strong"><strong>=item</strong></span> -w|--warning=threshold

threshold can be max (warn if &lt; 0 or &gt; max), min:max (warn if &lt; min or &gt; max), min:
 (warn if &lt; min), or @min:max (warn if &gt;= min and &lt;= max). All values must be integer.

<span class="strong"><strong>=item</strong></span> -c|--critical=threshold

see --warning for explanation of threshold format

...
<span class="strong"><strong>=cut</strong></span>


... <span class="emphasis"><em>perlcode</em></span> ...

<strong class="userinput"><code>=head1</code></strong> AUTHOR

...

<strong class="userinput"><code>=cut</code></strong></pre>

    <p>Each instruction begins with an equals sign as the first character in the line, as can be seen in the headings <strong class="userinput"><code>=head1</code></strong> to <strong class="userinput"><code>=head4</code></strong>. The lines before and after an instruction are kept empty.</p>

    <p>The instruction <strong class="userinput"><code>=over 4</code></strong> starts a listing with an indentation of four characters, in which only <strong class="userinput"><code>=item</code></strong> may be used as a POD instruction. <strong class="userinput"><code>=cut</code></strong> ends the inserted documentation, after which you can continue with normal Perlcode.</p>

    <p>A Perl script may contain as many POD sections as you wish. Usually the important ones are set at the beginning of the script, and less important ones, such as the details for <strong class="userinput"><code>SEE ALSO-</code></strong>, <strong class="userinput"><code>AUTHOR-</code></strong> or <strong class="userinput"><code>BUGS</code></strong> for the man pages, are placed at the end.</p>

    <p>Apart from <strong class="userinput"><code>perldoc</code></strong> there are programs such as <strong class="userinput"><code>pod2html</code></strong>, <strong class="userinput"><code>pod2latex</code></strong>, <strong class="userinput"><code>pod2man</code></strong>, <strong class="userinput"><code>pod2text</code></strong>, and <strong class="userinput"><code>pod2usage</code></strong>, which display the inline documentation in other formats. It should be pointed out, however, that POD basically displays an inline man page, and a man page converted to HTML will still have the appearance of a man page.</p>

    <p>The individual sections of a man page are described by <strong class="userinput"><code>man man;</code></strong> important ones are <strong class="userinput"><code>NAME</code></strong>, <strong class="userinput"><code>SYNOPSIS</code></strong>, <strong class="userinput"><code>DESCRIPTION</code></strong>, <strong class="userinput"><code>OPTIONS</code></strong>, <strong class="userinput"><code>FILES</code></strong>, <strong class="userinput"><code>SEE ALSO</code></strong>, <strong class="userinput"><code>BUGS</code></strong>, and <strong class="userinput"><code>AUTHOR</code></strong>. If the plugin requires more extensive documentation, you can add your own sections. Syntax and construction of the POD format are described in detail by <strong class="userinput"><code>man perlpod</code></strong>, while <strong class="userinput"><code>man perldoc</code></strong> explains how the embedded help can be extracted.</p>

    <div class="sect2" title="25.2.1 The module Pod::Usage">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="the_module_pod_colon_colon_usage"/>25.2.1 The module Pod::Usage</h2>
      </div>

      <p><strong class="userinput"><code>Pod::Usage</code></strong> as a component of the Perl core distribution displays the inline documentation either in full or in extracts, and ends the script with a predefined exit code:</p><a id="I_programlisting2_d1e49880"/>
      <pre class="programlisting">pod2usage(
   -msg     ⇒ <span class="emphasis"><em>$message_text</em></span>,
   -exitval ⇒ <span class="emphasis"><em>$exit_status</em></span>,
   -verbose ⇒ <span class="emphasis"><em>$verbose</em></span>,
   -output  ⇒ <span class="emphasis"><em>$filehandle</em></span>,
);</pre>

      <p>You can specify an additional text, such as a note on the incorrect use of the plugin, with the switch <strong class="userinput"><code>-msg</code></strong>, which is displayed before the inline documentation.</p>

      <p><strong class="userinput"><code>-exitval</code></strong> determines the return code with which the script ends. For a Nagios plugin, the constant UNKNOWN, which is imported with <strong class="userinput"><code>Nagios:: Plugin</code></strong>, should always be used here.</p>

      <p><strong class="userinput"><code>-verbose</code></strong> defines the amount of documentation displayed. With the value <strong class="userinput"><code>0, pod2usage</code></strong> generates a short usage message. For <strong class="userinput"><code>-verbose ⇒ 1</code></strong> the output includes the sections <strong class="userinput"><code>SYNOPSIS</code></strong>, <strong class="userinput"><code>OPTIONS</code></strong>, and <strong class="userinput"><code>ARGUMENTS</code></strong>, and for <strong class="userinput"><code>-verbose ⇒ 2</code></strong> it includes the entire documentation. A special role is played by the value <strong class="userinput"><code>99</code></strong>. This is used, together with the <strong class="userinput"><code>-sections</code></strong> switch, to specify which sections will be shown:</p><a id="I_programlisting2_d1e49935"/>
      <pre class="programlisting">-verbose ⇒ 99,
-sections ⇒ "NAME|SYNOPSIS|OPTIONS|AUTHOR",</pre>

      <p>Individual sections are separated with a <strong class="userinput"><code>|</code></strong> sign. The switch <strong class="userinput"><code>-output</code></strong> finally defines where the information should end up—to STDOUT for verbose values of <strong class="userinput"><code>0</code></strong> or <strong class="userinput"><code>1</code></strong> and to STDERR for for <strong class="userinput"><code>2</code></strong> and higher. For the output of the complete online help you should therefore set this explicitly (otherwise the user would first have to redirect STDERR to STDOUT in order to be able to see the help):</p><a id="I_programlisting2_d1e49954"/>
      <pre class="programlisting">-output ⇒ \*STDOUT,</pre>

      <p>In the plugin you first check whether the <strong class="userinput"><code>GetOptions</code></strong> fails, for example because an invalid option has been specified. In case of an error, the instruction following <strong class="userinput"><code>or</code></strong>—in this case <strong class="userinput"><code>pod2usage</code></strong>—is executed:</p><a id="I_programlisting2_d1e49967"/>
      <pre class="programlisting">GetOptions( ...
) or pod2usage(
   -exitval ⇒ UNKNOWN,
   -verbose ⇒ 0,
   -msg     ⇒ "<span class="strong"><strong>***</strong></span> unknown option or argument found <span class="strong"><strong>***</strong></span>",
);</pre>

      <p>The return value is then UNKNOWN, since the plugin is used incorrectly. <strong class="userinput"><code>-verbose</code></strong> is set to <strong class="userinput"><code>0</code></strong>, since a brief usage message is sufficient in this case. <strong class="userinput"><code>-msg</code></strong> explains more precisely to the user what he has done wrong; this message is placed before the usage message.</p>

      <p>If the user requests the online help, the entire help text contained in the plugin is displayed:</p><a id="I_programlisting2_d1e49989"/>
      <pre class="programlisting">pod2usage(
   -verbose ⇒ 2,
   -exitval ⇒ UNKNOWN,
   -output ⇒ \*STDOUT,
) if ( $help );</pre>

      <p>Because <strong class="userinput"><code>pod2usage</code></strong> normally uses STDERR here, <strong class="userinput"><code>-output</code></strong> explicitly ensures that the output goes to STDOUT.</p>

      <p>To display the version number, <strong class="userinput"><code>pod2usage</code></strong> can also be used. Many GNU programs include copyright information along with the version number. To do this, you create a POD section <strong class="userinput"><code>=head1 LICENSE</code></strong> and output this with <strong class="userinput"><code>verbose ⇒ 99:</code></strong></p><a id="I_programlisting2_d1e50009"/>
      <pre class="programlisting">=head1 LICENSE
This program is free software; you can redistribute it and/or modify it under the
 terms of the GNU General Public License as published by the Free Software Foundation;
 either version 2 of the License, or (at your option) any later version.

...

You should have received a copy of the GNU General Public License along with this
 program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street,
 Fifth Floor, Boston, MA 02110-1301, USA.

=cut
...
pod2usage(
   -msg      ⇒ "\n$0 -- version: $version\n",
   -verbose  ⇒ 99,
   -sections ⇒ "NAME|LICENSE",
   -output   ⇒ STDOUT,
   -exitval  ⇒ UNKNOWN,
) if ( $printversion );</pre>

      <p>Since the output for this verbose level goes to STDERR, you also use <strong class="userinput"><code>-output</code></strong> here to ensure that the output goes to STDOUT. The <strong class="userinput"><code>NAME</code></strong> and <strong class="userinput"><code>LICENSE</code></strong> sections may be located in the plugin file either before or after the <strong class="userinput"><code>pod.2-usage</code></strong> call.</p>

      <p>If the plugin expects mandatory details—in our case, the path to the directory subtree whose total size should be determined—the parameter is checked for existing values:</p><a id="I_programlisting2_d1e50027"/>
      <pre class="programlisting">pod2usage(
   -msg       ⇒ "<span class="strong"><strong>***</strong></span> no path/pattern specified <span class="strong"><strong>***</strong></span>",
   -verbose   ⇒ 0,
   -exitval   ⇒ UNKNOWN,
) unless $what;</pre>

      <p>If the user calls the plugin without the <strong class="userinput"><code>--path</code></strong> option, the variable <strong class="userinput"><code>$what</code></strong> will remain empty and <strong class="userinput"><code>pod2usage</code></strong> will issue a corresponding message.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-25-FN-3" id="ftn.CHP-25-FN-3">298</a>]</sup> The complete text is contained in the plugin <strong class="userinput"><code>check_du.pl</code></strong> at <a class="ulink" href="http://linux.swobspace.net/projects/nagios/perl-nagios-plugins.html">http://linux.swobspace.net/projects/nagios/perl-nagios-plugins.html</a>.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="25.3 Determining Thresholds">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="determining_thresholds"/>25.3 Determining Thresholds</h1>
    </div>

    <p>The format of the thresholds, which was discussed in <a class="xref" href="../Text/ch24.html#specifying_thresholds" title="24.1.5 Specifying thresholds">24.1.5 Specifying thresholds</a>, page 557, is not easy to parse, which is why the functions from the module <strong class="userinput"><code>Nagios::Plugin</code></strong> are a welcome help:<a class="indexterm" id="IDX-CHP-25-1996"/></p><a id="I_programlisting2_d1e50061"/>
    <pre class="programlisting">$np-&gt;set_thresholds(
   warning  ⇒ $warn_threshold,
   critical ⇒ $crit_threshold,
);

$result = $np-&gt;check_threshold($size);

$np-&gt;nagios_exit($result, "check size: $size kByte");</pre>

    <p>The method <strong class="userinput"><code>set_thresholds</code></strong> has the task of setting the thresholds for the <strong class="userinput"><code>Nagios::Plugin</code></strong> instance <strong class="userinput"><code>$np.$warn_threshold</code></strong> and <strong class="userinput"><code>$crit_threshold</code></strong> contain the details that the user passed on to the options <strong class="userinput"><code>--warning</code></strong> and <strong class="userinput"><code>--critical</code></strong> on the command line.</p>

    <p><strong class="userinput"><code>check_threshold</code></strong> compares the thresholds with the total size of the directory in <strong class="userinput"><code>$size</code></strong> and stores the return code in the variable <strong class="userinput"><code>$result</code></strong> (either OK, WARNING, or CRITICAL). This can be used right away in the function <strong class="userinput"><code>nagios_exit.Nagios::Plugin</code></strong> does all the work of parsing and checking.</p>
  </div>


  <div class="sect1" title="25.4 Implementing Timeouts">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="implementing_timeouts"/>25.4 Implementing Timeouts</h1>
    </div>

    <p>To implement a hard timeout, the function <strong class="userinput"><code>alarm()</code></strong> is available in C, Perl, and other programming languages, which normally calls the system functon of the same name (see <strong class="userinput"><code>man 2 alarm</code></strong>). For the Perl <strong class="userinput"><code>alarm()</code></strong> function, the timeout is specified in seconds:<a class="indexterm" id="IDX-CHP-25-1997"/><a class="indexterm" id="IDX-CHP-25-1998"/><a class="indexterm" id="IDX-CHP-25-1999"/><a class="indexterm" id="IDX-CHP-25-2000"/><a class="indexterm" id="IDX-CHP-25-2001"/></p><a id="I_programlisting2_d1e50135"/>
    <pre class="programlisting"># ... GetOptions ...
alarm($timeout);
# ... core code ...
alarm(0);
# ... end</pre>

    <p>The <strong class="userinput"><code>alarm($timeout)</code></strong> call starts the alarm function, the argument <strong class="userinput"><code>0</code></strong> for the second call stops it again. The first call should be used before time-intensive processing steps, in network-based plugins before opening sockets, and similar situations where a long delay may occur. A good place is after the command line has been processed via <strong class="userinput"><code>GetOptions</code></strong>.</p>

    <p>At the end of the plugin it is recommended that you reset the alarm. This may not be necessary for standalone programs, but if the Perl plugin is running in the Embedded Perl interpreter, some undesired side effects could result if this step is not taken. By explicitly stopping the alarm, you are certainly on the safe side.</p>

    <p>What happens if the alarm is set off, which means that the timeout has expired? Perl checks whether an accompanying signal handler is installed, and executes it if this is the case. It is recommended that you make use of this possibility and install your own signal handler, so that the plugin behaves in compliance with the Developer Guidelines:</p><a id="I_programlisting2_d1e50152"/>
    <pre class="programlisting">$SIG{ALRM} = sub {
   $np-&gt;nagios_die("Timeout reached");
}</pre>

    <p>The signal handler—an anonymous subroutine—is assigned the variable <strong class="userinput"><code>$SIG{ALRM}</code></strong>. The subroutine calls the function <strong class="userinput"><code>nagios_die</code></strong> from the <strong class="userinput"><code>Na-gios::Plugin</code></strong> module. In case of a timeout, the plugin will terminate and send back the return code UNKNOWN with a suitable error message.</p>
  </div>


  <div class="sect1" title="25.5 Displaying Performance Data">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="displaying_performance_data"/>25.5 Displaying Performance Data</h1>
    </div>

    <p>Displaying performance data with <strong class="userinput"><code>Nagios::Plugin</code></strong> is just as simple as processing thresholds. All you need to do is run the function <strong class="userinput"><code>add_perfdata</code></strong> with a few parameters, and the rest is handled by <strong class="userinput"><code>nagios_exit</code></strong> automatically:<a class="indexterm" id="IDX-CHP-25-2002"/><a class="indexterm" id="IDX-CHP-25-2003"/><a class="indexterm" id="IDX-CHP-25-2004"/></p><a id="I_programlisting2_d1e50194"/>
    <pre class="programlisting">$np-&gt;add_perfdata(
   label ⇒ "size",
   value ⇒ $size,
   uom ⇒ "kB",
   threshold ⇒ $np-&gt;threshold(),
);</pre>

    <p>The parameter <strong class="userinput"><code>label</code></strong> defines the name of the variable. <strong class="userinput"><code>value</code></strong> contains the measured value, <strong class="userinput"><code>uom</code></strong> defines the unit of measurements, in this case KB. <strong class="userinput"><code>threshold</code></strong> expects a threshold object, which is generated with the function <strong class="userinput"><code>threshold()</code></strong>. The thresholds must already have been set, with <strong class="userinput"><code>set_thresholds</code></strong>.<a class="indexterm" id="IDX-CHP-25-2005"/></p>

    <p>The output is shown automatically when <strong class="userinput"><code>nagios_exit</code></strong> is run, provided that the performance data were defined before the first <strong class="userinput"><code>nagios_exit</code></strong> call.</p>

    <p>The <strong class="userinput"><code>Nagios::Plugin</code></strong> package also contains the module <strong class="userinput"><code>Nagios::Plugin::Performance</code></strong>, which provides a parser for performance data in <strong class="userinput"><code>parse_perf string()</code></strong>, which splits up a performance data string. If you are programming addons in Perl that process performance data, you can save yourself a lot of work with this function.</p>
  </div>


  <div class="sect1" title="25.6 Configuration Files for Plugins">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="configuration_files_for_plugins"/>25.6 Configuration Files for Plugins</h1>
    </div>

    <p>A simple plugin can always be configured entirely on the command line. But if you need to incorporate more complex defaults, or if parameters should not appear as arguments in the process list, a configuration file may be of use. The module <strong class="userinput"><code>Nagios::Plugin</code></strong> enables you to access configuration files in a simple manner—one reason certainly being to encourage plugin programmers to use a uniform format, since this would considerably simplify configuration work for the Nagios admin, who no longer has to get used to different formats for every plugin.<a class="indexterm" id="IDX-CHP-25-2006"/><a class="indexterm" id="IDX-CHP-25-2007"/><a class="indexterm" id="IDX-CHP-25-2008"/><a class="indexterm" id="IDX-CHP-25-2009"/><a class="indexterm" id="IDX-CHP-25-2010"/><a class="indexterm" id="IDX-CHP-25-2011"/></p>

    <p><strong class="userinput"><code>Nagios::Plugin</code></strong> provides an interface for the module <strong class="userinput"><code>Config::Tiny</code></strong>. The file format corresponds to that of the INI files:</p><a id="I_programlisting2_d1e50282"/>
    <pre class="programlisting">rootproperty=10.0

[math]
pi=3.1415
euler=2.78</pre>

    <p>A section begins with an entry in square brackets, in this example <strong class="userinput"><code>[math]</code></strong>. Everything written before this (in the example here, the variable <strong class="userinput"><code>root-property)</code></strong> is referred to as <span class="emphasis"><em>root property</em></span>. Instructions are given according to the pattern <strong class="userinput"><code><em class="replaceable"><code>parameter=value</code></em></code></strong>. Lines beginning with # and ; are comments; spaces before and after the equals sign are allowed and are simply ignored. More information is provided by the man page <strong class="userinput"><code>man Config::Tiny</code></strong>.<a class="indexterm" id="IDX-CHP-25-2012"/></p>

    <p>Access to the configuration file is made through a <strong class="userinput"><code>Config</code></strong> object from the module <strong class="userinput"><code>Nagios::Plugin::Config</code></strong>, which is generated using the <strong class="userinput"><code>read()</code></strong> method:</p><a id="I_programlisting2_d1e50317"/>
    <pre class="programlisting">$Config = Nagios::Plugin::Config-&gt;read('/etc/nagios/myplugin.ini');

my $rootproperty = $Config-&gt;{_}-&gt;{rootproperty};
my $pi    = $Config-&gt;{math}-&gt;{pi};
my $euler = $Config-&gt;{math}-&gt;{euler};</pre>

    <p>At the same time, <strong class="userinput"><code>read()</code></strong> reads in the configuration file specified. If you omit the path details and call <strong class="userinput"><code>read()</code></strong> without parameters, the module will search for various configuration files. The exact listing of the search paths is contained in the man page <strong class="userinput"><code>man Nagios::Plugin::Config</code></strong>.</p>

    <p>Although it is conceivable that a single configuration file might be used for all plugins, for reasons of maintenance it is recommended that you set up a separate configuration file for each plugin, each containing an example.</p>

    <p>Configuration parameters in the <strong class="userinput"><code>[math]</code></strong> section are now addressed via the construct</p><a id="I_programlisting2_d1e50337"/>
    <pre class="programlisting">$Config-&gt;{math}-&gt;{pi};</pre>

    <p>and for the root properties, _ is used as a section delimiter:</p><a id="I_programlisting2_d1e50342"/>
    <pre class="programlisting">$Config-&gt;{_}-&gt;{rootproperty};</pre>
  </div>


  <div class="chapter" title="Chapter&#xA0;26.&#xA0;Monitoring Oracle with the Instant Client">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="monitoring_oracle_with_the_instant_clien"/>Chapter 26. Monitoring Oracle with the Instant Client</h1>
    </div>

    <p>If a specific task requires you to manipulate the STDIN and read the STD-OUT of the external program at the same time, another tool is needed, in the form of the module <strong class="userinput"><code>IPC::0pen2</code></strong>.</p>

    <p>The following chapter will not introduce any finished plugins, but illustrate how you can build your own Oracle plugin, using an example that monitors Oracle. Some plugins do already exist for this DBMS, such as <strong class="userinput"><code>check_oracle</code></strong>, one of the standard Nagios plugins, or <strong class="userinput"><code>check_oracle_writeaccess</code></strong><sup>[<a class="footnote" href="#ftn.CHP-26-FN-1" id="CHP-26-FN-1">299</a>]</sup> by Mathias Kettner. But both of them require the normal Oracle client, and most non-Oracle administrators will be out of their depth attempting to install it.<a class="indexterm" id="IDX-CHP-26-2013"/><a class="indexterm" id="IDX-CHP-26-2014"/></p>

    <p>Luckily there is an easier solution: For some time now, Oracle has been offering an <span class="emphasis"><em>instant client</em></span>, which drastically reduces the installation work: unpack the zip files, set the variables, and the installation is finished—the command-line tool <strong class="userinput"><code>sqlplus</code></strong> can be used immediately. The latter can be used in a plugin—just like the Perl script introduced in this chapter does, which sends a request to the Oracle database using <strong class="userinput"><code>sqlplus</code></strong> and evaluates the response.<a class="indexterm" id="IDX-CHP-26-2015"/></p>

    <div class="sect1" title="26.1 Installing the Oracle Instant Client">
      <div class="titlepage">
        <h1 class="title" id="heading_id_3"><a id="installing_the_oracle_instant_client"/>26.1 Installing the Oracle Instant Client</h1>
      </div>

      <p>Even though the instant client has been available only since Oracle version 10g, it can be used just as well with older Oracle databases such as 8i or 9i. The software is available in the form of zip files at the Oracle homepage,<sup>[<a class="footnote" href="#ftn.CHP-26-FN-2" id="CHP-26-FN-2">300</a>]</sup> provided you have previously registered on the Web site of the company. When downloading, you are asked some additional questions on export conditions.<a class="indexterm" id="IDX-CHP-26-2016"/></p>

      <p>Although the software costs nothing, you must observe Oracle's license terms. If your Oracle database is licensed on a CPU basis, you do not need to worry about additional access by another user (Nagios).</p>

      <p>For <strong class="userinput"><code>sqlplus</code></strong> you require two zip files,<sup>[<a class="footnote" href="#ftn.CHP-26-FN-3" id="CHP-26-FN-3">301</a>]</sup> <strong class="userinput"><code>instantclient-basic-linux32-10.1.0.3.zip</code></strong> and <strong class="userinput"><code>instantclient-sqlplus-linux32-10.1.0.3.zip</code></strong>.</p>

      <p>The <strong class="userinput"><code>instantclient-basic</code></strong> package, some 31 MB in size, contains all the necessary libraries, and the <strong class="userinput"><code>instantclient-sqlplus</code></strong> included, only 320 KB in size, contains a short documentation (<strong class="userinput"><code>READFR0M_IC.htm</code></strong>) as well as the client itself with a further library. It does not matter for the installation where the files are unpacked; in this case we will use <strong class="userinput"><code>/usr/local/oracle:</code></strong></p><a id="I_programlisting3_d1e50428"/>
      <pre class="programlisting">linux:~ # <span class="strong"><strong>mkdir /usr/local/oracle</strong></span>
linux:~ # <span class="strong"><strong>cd /usr/local/oracle</strong></span>
linux:local/oracle # <span class="strong"><strong>unzip instantclient-basic-linux32-10.1.0.3.zip</strong></span>
Archive: instantclient-basic-linux32-10.1.0.3.zip
  inflating: instantclient10_1/classes12.jar

...
linux:local/oracle # <span class="strong"><strong>unzip instantclient-sqlplus-linux32-10.1.0.3.zip</strong></span>
Archive:  instantclient-sqlplus-linux32-10.1.0.3.zip
  inflating: instantclient10_1/READFROM_IC.htm
  inflating: instantclient10_1/glogin.sql
  inflating: instantclient10_1/libsqlplus.so
  inflating: instantclient10_1/sqlplus</pre>

      <p>This creates a subdirectory <strong class="userinput"><code>instantclient 10_1</code></strong>, containing all the required files. After setting two environment variables, the instant client is ready for use:</p><a id="I_programlisting3_d1e50447"/>
      <pre class="programlisting">LD_LIBRARY_PATH=/usr/local/oracle/instantclient10_1
SQLPATH=/usr/local/oracle/instantclient10_1</pre>

      <p><strong class="userinput"><code>LD_LIBRARY_PATH</code></strong> ensures first that all shared libraries from the instant client directory are taken into account when programs are run, before the libraries installed system-wide are loaded. <strong class="userinput"><code>SQLPATH</code></strong> reveals to <strong class="userinput"><code>sqlplus</code></strong> where it needs to look for the file <strong class="userinput"><code>glogin.sql</code></strong>. This file makes a number of default settings for accessing the Oracle database, and no adjustments are necessary for our purposes.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-26-FN-1" id="ftn.CHP-26-FN-1">299</a>]</sup> <a class="ulink" href="http://mathias-kettner.de/nagios_plugins.html">http://mathias-kettner.de/nagios_plugins.html</a>.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-26-FN-2" id="ftn.CHP-26-FN-2">300</a>]</sup> <a class="ulink" href="http://www.oracle.com/technology/software/tech/oci/instantclient">http://www.oracle.com/technology/software/tech/oci/instantclient</a></p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-26-FN-3" id="ftn.CHP-26-FN-3">301</a>]</sup> Apart from the Linux version introduced here on Intel x86-32 systems, the client is also available for Linux x86-64, Linux Itanium, MAC OS-X, HP-UX (32- and 64-bit, for both PA-RISC and Itanium), Solaris SPARC (32- and 64-bit), Solaris x86-32, AIX 5L (32- and 64-bit), and HP Tru64 UNIX.</p>
      </div>
    </div>
  </div>


  <div class="sect1" title="26.2 Establishing a Connection to the Oracle Database">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="establishing_a_connection_to_the_oracle"/>26.2 Establishing a Connection to the Oracle Database</h1>
    </div>

    <p><strong class="userinput"><code>sqlplus</code></strong> requires the following details to make contact with the database:</p><a id="I_programlisting3_d1e50469"/>
    <pre class="programlisting">sqlplus <span class="emphasis"><em>user/password@//host/database</em></span></pre>

    <p>The placeholder <strong class="userinput"><code>user</code></strong> is replaced by a user who exists in the database, and the password is followed by a forward slash. After the <strong class="userinput"><code>@//</code></strong> sign comes the host name or IP address, followed by the name of the database to which <strong class="userinput"><code>sqlplus</code></strong> should make a connection. In the following example we will use the database <strong class="userinput"><code>DEMO:</code></strong></p><a id="I_programlisting3_d1e50486"/>
    <pre class="programlisting">user@linux:~$ <span class="strong"><strong>sqlplus wob/</strong></span><span class="bolditalic">password</span><span class="strong"><strong>@//192.168.1.9/DEMO</strong></span>

SQL*Plus: Release 10.1.0.3.0 - Production on Sat Aug 13 14:12:52 2005
...
SQL&gt; <span class="strong"><strong>quit</strong></span>
Disconnected from Oracle8i Release 8.1.7.0.0 - Production
JServer Release 8.1.7.0.0 - Production</pre>

    <p>On the connect you are shown the version of the instant client used (here: <strong class="userinput"><code>10.1.0.3.0</code></strong>) as well as a note on the version of the Oracle database used, in this case <strong class="userinput"><code>8.1.7.0.0</code></strong>. The <strong class="userinput"><code>quit</code></strong> command terminates the connection. If the password is wrong, or if the user does not exist, Oracle explicitly requests the user to enter both again.</p>
  </div>


  <div class="sect1" title="26.3 A Wrapper Plugin for sqlplus">
    <div class="titlepage">
      <h1 class="title" id="heading_id_2"><a id="a_wrapper_plugin_for_sqlplus"/>26.3 A Wrapper Plugin for <strong class="userinput"><code>sqlplus</code></strong></h1>
    </div>

    <p>To query an Oracle database, <strong class="userinput"><code>sqlplus</code></strong> is given the appropriate SQL statement via standard input and receives a reply via the standard output:<a class="indexterm" id="IDX-CHP-26-2017"/><a class="indexterm" id="IDX-CHP-26-2018"/></p><a id="I_programlisting3_d1e50529"/>
    <pre class="programlisting">user@linux:~$ <span class="strong"><strong>echo "select trash from nothing"</strong></span> |\
 <span class="strong"><strong>sqlplus -i wob/</strong></span><span class="bolditalic">password</span><span class="strong"><strong>@//192.168.1.9/DEMO</strong></span>
select trash from nothing
               <span class="strong"><strong>*</strong></span>

ERROR at line 1:
ORA-00942: table or view does not exist</pre>

    <p>The switch <strong class="userinput"><code>-s</code></strong> (<span class="emphasis"><em>silent</em></span>) prevents the output of things like version and copyright, and restricts the reply to the really interesting part. If the query fails, as above, the text merely points out the error that has occurred. <strong class="userinput"><code>sqlplus</code></strong> itself only returns an error status as a return value if the error occurred when using the client itself, otherwise it just returns OK (command executed). This is why <strong class="userinput"><code>sqlplus</code></strong> cannot be used directly by Nagios. Instead, a <span class="emphasis"><em>wrapper</em></span> must be written around the actual query which evaluates the reply of the database, which in the above example generates a CRITICAL return value appropriate for Nagios from the <strong class="userinput"><code>ERROR</code></strong> reply, and adds a short one-line reply.<a class="indexterm" id="IDX-CHP-26-2019"/></p>

    <p><strong class="userinput"><code>sqlplus</code></strong> can in principle be run with any scripting language that enables the text response to be interpreted. Since this is one of the strengths of Perl, we shall use this language for the wrapper plugin—but it could also be written in a shell like Bash; the basic principle is always the same.</p>

    <div class="sect2" title="26.3.1 How the wrapper works">
      <div class="titlepage">
        <h2 class="title" id="heading_id_3"><a id="how_the_wrapper_works"/>26.3.1 How the wrapper works</h2>
      </div>

      <p>The wrapper plugin is constructed on the following lines:</p><a id="I_programlisting3_d1e50579"/>
      <pre class="programlisting"><span class="emphasis"><em>sql-statement</em></span> | sqplus <span class="emphasis"><em>arguments</em></span> | <span class="emphasis"><em>output_processing</em></span></pre>

      <p><strong class="userinput"><code>sqlplus</code></strong> receives an SQL statement on the standard input, and the plugin retrieves the result from the standard output. Wrappers can be built around (almost) any program which does not provide sensible return values, but "hides" the result in text.</p>

      <p>Perl itself does not provide a direct way of checking standard input and output at the same time. But Perl would not be Perl if there were not a module created specifically for this purpose. <strong class="userinput"><code>ICP:: Open2</code></strong><sup>[<a class="footnote" href="#ftn.CHP-26-FN-4" id="CHP-26-FN-4">302</a>]</sup> fullfils exactly this purpose:</p><a id="I_programlisting3_d1e50600"/>
      <pre class="programlisting">use IPC::Open2;

open2(*READFROM, *WRITETO, <span class="emphasis"><em>program, list_of_arguments</em></span>);
print WRITETO "<span class="emphasis"><em>instruction_via_standard_input</em></span>\n";

while (&lt;READFROM&gt;) {
<span class="emphasis"><em>processed_standard_output</em></span>;
}

close(READFROM);
close(WRITETO);</pre>

      <p>The routine <strong class="userinput"><code>open2</code></strong> requires two file handles. Their names, <strong class="userinput"><code>WRITETO</code></strong> and <strong class="userinput"><code>READFROM</code></strong>, describe the interaction from the point of view of the wrapper, and seen from <strong class="userinput"><code>open2</code></strong> its behavior is exactly the opposite: <strong class="userinput"><code>open2</code></strong> reads from its standard input (<strong class="userinput"><code>WRITETO</code></strong>) and writes to its output (<strong class="userinput"><code>READFROM</code></strong>), where no distinction is made between standard output and error output. The third argument is a program with its complete path, followed by any number of arguments for the program, each separated from the next by a comma.</p>

      <p>With the <strong class="userinput"><code>WRITETO</code></strong> file handle, the desired commands are sent with <strong class="userinput"><code>print</code></strong>. Each line for <strong class="userinput"><code>sqlplus</code></strong> should end here with a correct end-of-line (Perl: <strong class="userinput"><code>'\n</code></strong>'). With the <strong class="userinput"><code>while (&lt;READFR0M&gt;)</code></strong> construction, Perl reads line by line from the standard (or error) output until there are no more lines. Then <strong class="userinput"><code>close ()</code></strong> closes the two file handles.</p>

      <p>Using <strong class="userinput"><code>IPC::Open2</code></strong> can cause problems, however: it is conceivable that the program used (in our case, <strong class="userinput"><code>sqlplus</code></strong>) gets blocked, because it continues processing a part of the input only after it has written something. If the plugin only processes the output once all the input is completed, you have the classic situation of a deadlock. For this reason you must make sure there are no blocks when reading and writing. Luckily the danger of this happening in our simple application is minimal.</p>
    </div>

    <div class="sect2" title="26.3.2 The Perl plugin in detail">
      <div class="titlepage">
        <h2 class="title" id="heading_id_4"><a id="the_perl_plugin_in_detail"/>26.3.2 The Perl plugin in detail</h2>
      </div>

      <p>A good Perl script starts with the instructions <strong class="userinput"><code>use strict</code></strong> and <strong class="userinput"><code>use warnings</code></strong>. Then all variables must be declared, and in other ways Perl is very particular with syntax.<sup>[<a class="footnote" href="#ftn.CHP-26-FN-5" id="CHP-26-FN-5">303</a>]</sup></p><a id="I_programlisting3_d1e50684"/>
      <pre class="programlisting">#!/usr/bin/perl -w
use strict;
use warnings;
use IPC::Open2;

my $ipath = "/usr/local/oracle/instantclient10_1";
my $sqlplus = "$ipath/sqlplus";
my $connectstring = "wob/<span class="emphasis"><em>password</em></span>@//192.168.1.9/DEMO";

# -- Set environment variables
$ENV{'LD_LIBRARY_PATH'} = $ipath;
$ENV{'SQLPATH'} = $ipath;</pre>

      <p><strong class="userinput"><code>$ipath</code></strong> contains the path to the directory in which the instant client is located, and <strong class="userinput"><code>$sqlplus</code></strong> has the absolute path to the program <strong class="userinput"><code>sqlplus</code></strong>. The connect string was already explained above. With the hash <strong class="userinput"><code>%ENV</code></strong>, the script sets the two required environment variables. Hash entries are referenced by Perl with <strong class="userinput"><code>$ENV{'</code></strong><em class="replaceable"><code>variable name'</code></em><strong class="userinput"><code>}</code></strong>.</p>

      <p>The database query statement is defined for this example in a variable:</p><a id="I_programlisting3_d1e50711"/>
      <pre class="programlisting"># -- SQL-Statement
my $select = "SELECT table_name FROM all_tables ";
   $select .= " where table_name = 'VERSION';";</pre>

      <p>The instruction <strong class="userinput"><code>.=</code></strong> appends the following text to that already existing in <strong class="userinput"><code>$select</code></strong>. The SQL statement therefore selects, from the Oracle system table <strong class="userinput"><code>all_tables</code></strong>, which contains all the names of existing tables, the column <strong class="userinput"><code>table_name</code></strong>, in this case with an additional restriction to the table name <strong class="userinput"><code>VERSION</code></strong>.</p>

      <p>In the next step the plugin opens the standard input and output with the routine <strong class="userinput"><code>open2:</code></strong></p><a id="I_programlisting3_d1e50734"/>
      <pre class="programlisting"># -- open2 with error processing
eval {
   open2(*READFROM, *WRITETO, $sqlplus, "-s", $connectstring);
};
if ($@) {
   die "Error in open2: $!\n$@\n";
}</pre>

      <p>The <strong class="userinput"><code>sqlplus</code></strong> switch <strong class="userinput"><code>-s</code></strong> prevents unnecessary connect output. For adequate error processing, we embed the <strong class="userinput"><code>open2</code></strong> command in an <strong class="userinput"><code>eval</code></strong> environment: since <strong class="userinput"><code>open2</code></strong> aborts directly if there is an error, the programmer would otherwise have no chance to display a sensible error message. If it is needed, the error output is obtained in the <strong class="userinput"><code>eval</code></strong> environment through <strong class="userinput"><code>$@</code></strong>. The <strong class="userinput"><code>die</code></strong> function outputs this and aborts the execution of the Perl script.</p>

      <p>The only thing remaining now is to send the SQL statement, with <strong class="userinput"><code>print WRITETO</code></strong>, to <strong class="userinput"><code>sqlplus</code></strong> (afterwards we close down the standard input <strong class="userinput"><code>WRITETO</code></strong>, to be on the safe side) and evaluate the output:</p><a id="I_programlisting3_d1e50775"/>
      <pre class="programlisting"># -- Write instruction
print WRITETO $select;
close(WRITETO);

# -- Process reply
while (&lt;READFR0M&gt;) {
   print $_;
}</pre>

      <p><strong class="userinput"><code>while &lt;READFR0M&gt;</code></strong> reads the output line by line. The contents of the current line are contained in <strong class="userinput"><code>$_</code></strong>. With your first attempts, we recommend that you have the output of all lines displayed with <strong class="userinput"><code>print $_;</code></strong> so that you can determine whether everything is working.</p>

      <p>If this is the case, the actual logic can be expanded: if the table name sought exists in the database, Oracle first displays the column header, then (separated by <strong class="userinput"><code>hyphens</code></strong>) the actual contents, that is, the name of the table being sought:</p><a id="I_programlisting3_d1e50792"/>
      <pre class="programlisting">TABLE NAME
--------------------
VERSION</pre>

      <p>If such a table does not exist in the database, the response is:</p><a id="I_programlisting3_d1e50796"/>
      <pre class="programlisting">no rows selected</pre>

      <p>If an error occurs in the query, perhaps because the column sought, <strong class="userinput"><code>table_name</code></strong>, is missing or the table <strong class="userinput"><code>all_tables</code></strong> does not exist, <strong class="userinput"><code>sqlplus</code></strong> returns a message containing the keyword <strong class="userinput"><code>ERROR</code></strong>, as in the initial example in <a class="xref" href="../Text/ch26s03.html" title="26.3 A Wrapper Plugin for sqlplus">26.3 A Wrapper Plugin for sqlplus</a>.</p>

      <p>The <strong class="userinput"><code>while</code></strong> loop now looks like this:</p><a id="I_programlisting3_d1e50819"/>
      <pre class="programlisting"># -- Process response
while (&lt;READFR0M&gt;) {
   if ( /^VERSION/i ) {
      print "OK - Table VERSION found\n";
      exit 0;
   } elsif (/no rows selected/i) {
      print "WARNING - Table VERSION not found\n";
      exit 1;
   } elsif (/ERROR/i) {
      print "CRITICAL - SQL-Statement failed\n";
      exit 2;
   }
}
close(READFROM);
print "UNKNOWN - unknown response\n";
exit 3;</pre>

      <p>The search instruction <strong class="userinput"><code>/^VERSION/i</code></strong> contains two special features: the <strong class="userinput"><code>i</code></strong> at the end ensures that the comparison ignores upper or lower case. The <strong class="userinput"><code>^</code></strong> at the beginning ensures that the text <strong class="userinput"><code>VERSION</code></strong> must stand at the beginning of the line. If the SQL statement sent by Oracle was incorrect, the error message repeats this first—but then the text <strong class="userinput"><code>VERSION</code></strong> is <span class="emphasis"><em>not</em></span> at the beginning of the line.</p>

      <p>If the plugin finds the sought table name <strong class="userinput"><code>VERSION</code></strong> in the response sent, an OK text message is displayed and it terminates with the return value <strong class="userinput"><code>0</code></strong>.</p>

      <p>If the database issues <strong class="userinput"><code>no rows selected</code></strong> or even an <strong class="userinput"><code>ERROR</code></strong>, however, the script feeds Nagios a corresponding reply and terminates with <strong class="userinput"><code>exit</code></strong> and the corresponding return value. If none of the three search patterns match, a return value must also be accounted for; otherwise the script will end with the status <strong class="userinput"><code>0</code></strong>, and Nagios will announce: "Everything in order." Here we take advantage of the <strong class="userinput"><code>UNKNOWN</code></strong> status, which is actually reserved for error processing for the plugin.</p>

      <p>Armed with this background knowledge, it should not be too difficult to write your own Oracle plugin. Its use here is not restricted to read access: provided you have write permissions for the user in question, you can just as well formulate SQL statements with UPDATE, INSERT, or DELETE, and evaluate the answer.</p>
    </div>

    <div class="footnotes">
      <br/>
      <hr/>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-26-FN-4" id="ftn.CHP-26-FN-4">302</a>]</sup> The module is included in the standard package of Perl 5.8.</p>
      </div>

      <div class="footnote">
        <p><sup>[<a class="para" href="#CHP-26-FN-5" id="ftn.CHP-26-FN-5">303</a>]</sup> Some programmers get very irritated, especially at the start, because Perl reacts very pettily with <strong class="userinput"><code>use strict</code></strong>. Without this instruction, variables do not need to be declared. One single typing error in a variable name is sometimes sufficient to keep you searching for hours to find out why the value at a certain position is always <strong class="userinput"><code>0</code></strong>.</p>
      </div>
    </div>
  </div>
</body></html>