<html><head></head><body><div class="part" title="Part&#xA0;III.&#xA0;Lisp is Hacking"><div class="titlepage"><div><div><h1 class="title"><a id="lisp_is_hacking"/>Part III. Lisp is Hacking</h1></div></div></div><div class="partintro" title="Lisp is Hacking" id="id2855127"><div/><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject_d1e16980"/><img src="httpatomoreillycomsourcenostarchimages779893.png" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject_d1e16986"/><img src="httpatomoreillycomsourcenostarchimages779921.png.jpg" alt="image with no caption"/></div></div><div class="sect1" title="loop and format: The Seedy Underbelly of Lisp"><div class="titlepage"><div><div><h1 class="title"><a id="loop_and_format_colon_the_seedy_underbel"/>loop and format: The Seedy Underbelly of Lisp</h1></div></div></div><p>Previously, we looked at the core of the Common Lisp language and admired its succinctness and elegance. However, there are also some darker, seedier parts of Lisp built around this core that have a certain charm of their own. They may lack the beauty of the Lisp core, but they easily make up for it with their power. These parts of the language are a real delight for any budding Lisp hacker.<a id="IDX-CHP-9-0184" class="indexterm"/><a id="IDX-CHP-9-0185" class="indexterm"/><a id="IDX-CHP-9-0186" class="indexterm"/></p><p>The extensions we’ll cover in this section, <code class="literal">loop</code> and <code class="literal">format</code>, place a strong emphasis on power over mathematical elegance. This has led to occasional controversy among Lisp programmers, some of whom question whether the power provided by these commands is worth the trade-off in elegance. These programmers believe that <code class="literal">loop</code> and <code class="literal">format</code> should be avoided when writing any serious code.</p><p>But there is one great reason to learn and use these commands: They embody the flexibility and extensibility of Lisp. Since Lisp is (arguably) the most flexible programming language available, hackers have been extending it with thousands of their own hacks for decades. <code class="literal">loop</code> and <code class="literal">format</code>, which are among the most successful of these extensions, had to be really spectacular to survive in the Darwinian battlefield.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject_d1e17028"/><img src="httpatomoreillycomsourcenostarchimages780016.png.jpg" alt="image with no caption"/></div></div></div></div></div>
<div class="chapter" title="Chapter&#xA0;10.&#xA0;Looping with the loop Command"><div class="titlepage"><div><div><h1 class="title"><a id="looping_with_the_loop_command-id1"/>Chapter 10. Looping with the loop Command</h1></div></div></div><p>The <code class="literal">loop</code> and <code class="literal">format</code> commands are powerful and hacker-friendly. Though most of the functionality they offer is available elsewhere in the Lisp language, these highly specialized commands are worth learning if you like terse code. We’ll look at <code class="literal">loop</code> in this chapter. The next chapter covers <code class="literal">format</code>.<a id="IDX-CHP-10-0001" class="indexterm"/></p><div class="sect1" title="The loop Macro"><div class="titlepage"><div><div><h1 class="title"><a id="the_loop_macro"/>The loop Macro</h1></div></div></div><p>Any type of looping you would ever want to do inside a computer program can be accomplished with the <code class="literal">loop</code> macro. Here’s a simple example:</p><a id="I_programlisting1_d1e17061"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for i</code></strong>
<strong class="userinput"><code>        below 5</code></strong>
<strong class="userinput"><code>        sum i)</code></strong>
10</pre><p>This code adds together the natural numbers below 5, like this:<a id="IDX-CHP-10-0002" class="indexterm"/><a id="IDX-CHP-10-0003" class="indexterm"/><a id="IDX-CHP-10-0004" class="indexterm"/></p><table border="0" summary="Simple list" class="simplelist"><tr><td>0 + 1 + 2 + 3 + 4 = 10</td></tr></table><p>You can see that this <code class="literal">loop</code> command doesn’t work in the way a proper Lisp command should. First of all, it’s parenthetically challenged. Never before have we had seven tokens in a row without parentheses!</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17092"/><img src="httpatomoreillycomsourcenostarchimages779821.png.jpg" alt="image with no caption"/></div></div><p>What makes it even less Lispy is that some of these extra tokens (<code class="literal">for</code>, <code class="literal">below</code>, and <code class="literal">sum</code>) appear to have special meanings. Recall from <a class="xref" href="ch03.html" title="Chapter 3. Exploring the Syntax of Lisp Code">Chapter 3</a> that the first token in a form (the one immediately after the opening parenthesis) is typically what decides the basic behavior of the code, while the rest of the form contains parameters. Within the <code class="literal">loop</code> macro, several of these “magic tokens” fundamentally affect the <code class="literal">loop</code>’s behavior. Here’s what they mean:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">for</code> allows you to declare a variable (in this case, named <code class="literal">i</code>) that iterates through a range of values. By default, it will count through the integers starting at zero.</p></li><li class="listitem"><p><code class="literal">below</code> tells the <code class="literal">for</code> construct to halt when it reaches the specified value (in this case, <code class="literal">5</code>), excluding the value itself.</p></li><li class="listitem"><p><code class="literal">sum</code> adds together all values of a given expression (in this case, the expression is just <code class="literal">i</code>) and makes the <code class="literal">loop</code> return that number.</p></li></ul></div><div class="sect2" title="Some loop Tricks"><div class="titlepage"><div><div><h2 class="title"><a id="some_loop_tricks"/>Some loop Tricks</h2></div></div></div><p>The <code class="literal">loop</code> macro has a veritable cornucopia of special tokens that make just about any kind of behavior possible. Let’s look at some of the possibilities.</p><div class="sect3" title="Counting from a Starting Point to an Ending Point"><div class="titlepage"><div><div><h3 class="title"><a id="counting_from_a_starting_point_to_an_end"/>Counting from a Starting Point to an Ending Point</h3></div></div></div><p>By using <code class="literal">from</code> and <code class="literal">to</code> clauses, you can make the <code class="literal">for</code> construct count through any specific range of integers:<a id="IDX-CHP-10-0005" class="indexterm"/><a id="IDX-CHP-10-0006" class="indexterm"/><a id="IDX-CHP-10-0007" class="indexterm"/><a id="IDX-CHP-10-0008" class="indexterm"/><a id="IDX-CHP-10-0009" class="indexterm"/><a id="IDX-CHP-10-0010" class="indexterm"/><a id="IDX-CHP-10-0011" class="indexterm"/><a id="IDX-CHP-10-0012" class="indexterm"/><a id="IDX-CHP-10-0013" class="indexterm"/></p><a id="I_programlisting1_d1e17210"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for i</code></strong>
<strong class="userinput"><code>        from 5</code></strong>
<strong class="userinput"><code>        to 10</code></strong>
<strong class="userinput"><code>      sum i)</code></strong>
45</pre></div><div class="sect3" title="Iterating Through Values in a List"><div class="titlepage"><div><div><h3 class="title"><a id="iterating_through_values_in_a_list"/>Iterating Through Values in a List</h3></div></div></div><p>In the following example, we iterate through values in a list using the <code class="literal">in</code> token:</p><a id="I_programlisting1_d1e17232"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for i</code></strong>
<strong class="userinput"><code>        in '(100 20 3)</code></strong>
<strong class="userinput"><code>      sum i)</code></strong>
123</pre></div><div class="sect3" title="doing Stuff in a Loop"><div class="titlepage"><div><div><h3 class="title"><a id="doing_stuff_in_a_loop"/>doing Stuff in a Loop</h3></div></div></div><p>The <code class="literal">do</code> token takes an arbitrary expression and executes it inside the <code class="literal">loop</code>:</p><a id="I_programlisting1_d1e17254"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for i</code></strong>
<strong class="userinput"><code>        below 5</code></strong>
<strong class="userinput"><code>      do (print i))</code></strong>
0
1
2
3
4</pre></div><div class="sect3" title="Doing Stuff Under Certain Conditions"><div class="titlepage"><div><div><h3 class="title"><a id="doing_stuff_under_certain_conditions"/>Doing Stuff Under Certain Conditions</h3></div></div></div><p>The <code class="literal">when</code> token lets you run the following part of the <code class="literal">loop</code> only as needed:</p><a id="I_programlisting1_d1e17276"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for i</code></strong>
<strong class="userinput"><code>        below 10</code></strong>
<strong class="userinput"><code>      when (oddp i)</code></strong>
<strong class="userinput"><code>      sum i)</code></strong>
25</pre><p>Notice that only the sum of the odd numbers is returned.</p></div><div class="sect3" title="Breaking out of a Loop Early"><div class="titlepage"><div><div><h3 class="title"><a id="breaking_out_of_a_loop_early"/>Breaking out of a Loop Early</h3></div></div></div><p>The following <code class="literal">loop</code> uses several new tricks:<a id="IDX-CHP-10-0014" class="indexterm"/><a id="IDX-CHP-10-0015" class="indexterm"/><a id="IDX-CHP-10-0016" class="indexterm"/><a id="IDX-CHP-10-0017" class="indexterm"/><a id="IDX-CHP-10-0018" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17322"/><img src="httpatomoreillycomsourcenostarchimages782608.png.jpg" alt="image with no caption"/></div></div><a id="I_programlisting1_d1e17327"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for i</code></strong>
<strong class="userinput"><code>        from 0</code></strong>
<strong class="userinput"><code>      do (print i)</code></strong>
<strong class="userinput"><code>      when (= i 5)</code></strong>
<strong class="userinput"><code>      return 'falafel)</code></strong>
0
1
2
3
4
5

FALAFEL</pre><p>Notice that there’s nothing in the <code class="literal">for</code> part of the <code class="literal">loop</code> that tells it to stop counting numbers—it goes from zero off to infinity. However, once we reach <code class="literal">5</code>, the <code class="literal">when</code> clause triggers the loop to immediately return the value <code class="literal">'falafel</code>.</p></div><div class="sect3" title="Collecting a List of Values"><div class="titlepage"><div><div><h3 class="title"><a id="collecting_a_list_of_values"/>Collecting a List of Values</h3></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17365"/><img src="httpatomoreillycomsourcenostarchimages780290.png.jpg" alt="image with no caption"/></div></div><p>The <code class="literal">collect</code> clause lets you return more than one item from the <code class="literal">loop</code>, in the form of a list. This command is useful when you need to modify each item in a list, as in the following example:</p><a id="I_programlisting1_d1e17378"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for i</code></strong>
<strong class="userinput"><code>     in '(2 3 4 5 6)</code></strong>
<strong class="userinput"><code>     collect (* i i))</code></strong>
(4 9 16 25 36)</pre></div><div class="sect3" title="Using Multiple for Clauses"><div class="titlepage"><div><div><h3 class="title"><a id="using_multiple_for_clauses"/>Using Multiple for Clauses</h3></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17393"/><img src="httpatomoreillycomsourcenostarchimages782304.png" alt="image with no caption"/></div></div><p>It’s possible for a <code class="literal">loop</code> macro to have more than one <code class="literal">for</code> clause. Consider the following example:</p><a id="I_programlisting1_d1e17406"/><pre class="programlisting">(loop for x below 10
      for y below 10
      collect (+ x y))</pre><p>How many numbers do you think will be returned as a result? There are two possibilities: Either it increments <code class="literal">x</code> and <code class="literal">y</code> at the same time and returns a list of 10 items, or it iterates <code class="literal">x</code> and <code class="literal">y</code> in a nested fashion and returns 100 numbers. The answer is the former:<a id="IDX-CHP-10-0019" class="indexterm"/><a id="IDX-CHP-10-0020" class="indexterm"/></p><a id="I_programlisting1_d1e17430"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for x below 10</code></strong>
<strong class="userinput"><code>        for y below 10</code></strong>
<strong class="userinput"><code>        collect (+ x y))</code></strong>
(0 2 4 6 8 10 12 14 16 18)</pre><p>As you can see, both numbers incremented at the same time between 0 and 9.</p><p>If there are multiple <code class="literal">for</code> clauses in a Common Lisp <code class="literal">loop</code>, each one will be checked, and the <code class="literal">loop</code> will stop when any one of the clauses runs out of values. This means that <code class="literal">for</code> clauses <span class="emphasis"><em>do not</em></span> <code class="literal">loop</code> independently across multiple looping variables, so if you <code class="literal">loop</code> on two ranges of 10 values each, it will still just <code class="literal">loop</code> 10 times.</p><p>However, sometimes you want to generate the <span class="emphasis"><em>Cartesian product</em></span> between multiple ranges. In other words, you want a <code class="literal">loop</code> to run once for every possible combination of two or more ranges. To accomplish this, you need to use nested loops for <code class="literal">x</code> and <code class="literal">y</code>:</p><a id="I_programlisting1_d1e17484"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for x below 10</code></strong>
<strong class="userinput"><code>        collect (loop for y below 10</code></strong>
<strong class="userinput"><code>                      collect (+ x y)))</code></strong>
((0 1 2 3 4 5 6 7 8 9) (1 2 3 4 5 6 7 8 9 10) (2 3 4 5 6 7 8 9 10 11)
 (3 4 5 6 7 8 9 10 11 12) (4 5 6 7 8 9 10 11 12 13) (5 6 7 8 9 10 11 12 13 14)
 (6 7 8 9 10 11 12 13 14 15) (7 8 9 10 11 12 13 14 15 16)
 (8 9 10 11 12 13 14 15 16 17) (9 10 11 12 13 14 15 16 17 18))</pre><p>In this case, we’ve created 10 lists of 10 items each, <code class="literal">loop</code>ing for a total of 100 items.</p><p>Also, notice that using a <code class="literal">for</code> variable starting at zero, such as the <code class="literal">i</code> variable in the following example, provides a clean way to track the index number of items in a list:</p><a id="I_programlisting1_d1e17509"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop for i</code></strong>
<strong class="userinput"><code>        from 0</code></strong>
<strong class="userinput"><code>        for day</code></strong>
<strong class="userinput"><code>        in '(monday tuesday wednesday thursday friday saturday sunday)</code></strong>
<strong class="userinput"><code>        collect (cons i day))</code></strong>
((0 . MONDAY) (1 . TUESDAY) (2 . WEDNESDAY)
 (3 . THURSDAY) (4 . FRIDAY) (5 . SATURDAY) (6 . SUNDAY))</pre><p>You might think we’ve covered every conceivable variation of looping at this point. If so, you are gravely mistaken. Behold! The Periodic Table of the Loop Macro!<a id="IDX-CHP-10-0021" class="indexterm"/><a id="IDX-CHP-10-0022" class="indexterm"/><a id="IDX-CHP-10-0023" class="indexterm"/><a id="IDX-CHP-10-0024" class="indexterm"/><a id="IDX-CHP-10-0025" class="indexterm"/><a id="IDX-CHP-10-0026" class="indexterm"/><a id="IDX-CHP-10-0027" class="indexterm"/><a id="IDX-CHP-10-0028" class="indexterm"/><a id="IDX-CHP-10-0029" class="indexterm"/><a id="IDX-CHP-10-0030" class="indexterm"/><a id="IDX-CHP-10-0031" class="indexterm"/><a id="IDX-CHP-10-0032" class="indexterm"/><a id="IDX-CHP-10-0033" class="indexterm"/><a id="IDX-CHP-10-0034" class="indexterm"/><a id="IDX-CHP-10-0035" class="indexterm"/><a id="IDX-CHP-10-0036" class="indexterm"/><a id="IDX-CHP-10-0037" class="indexterm"/><a id="IDX-CHP-10-0038" class="indexterm"/><a id="IDX-CHP-10-0039" class="indexterm"/><a id="IDX-CHP-10-0040" class="indexterm"/><a id="IDX-CHP-10-0041" class="indexterm"/><a id="IDX-CHP-10-0042" class="indexterm"/><a id="IDX-CHP-10-0043" class="indexterm"/><a id="IDX-CHP-10-0044" class="indexterm"/><a id="IDX-CHP-10-0045" class="indexterm"/><a id="IDX-CHP-10-0046" class="indexterm"/><a id="IDX-CHP-10-0047" class="indexterm"/><a id="IDX-CHP-10-0048" class="indexterm"/><a id="IDX-CHP-10-0049" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17620"/><img src="httpatomoreillycomsourcenostarchimages781219.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17626"/><img src="httpatomoreillycomsourcenostarchimages781278.png.jpg" alt="image with no caption"/></div></div></div></div><div class="sect2" title="Everything You Ever Wanted to Know About loop"><div class="titlepage"><div><div><h2 class="title"><a id="everything_you_ever_wanted_to_know_about"/>Everything You Ever Wanted to Know About loop</h2></div></div></div><p>The individual examples we’ve discussed so far give only the briefest hint of the full capabilities of <code class="literal">loop</code>. But fear not! You now have the world’s first and only Periodic Table of the Loop Macro. Just tape it to your monitor, glue it to your wallet, or laser-etch it directly into your retina, and you’ll be guaranteed to reach <code class="literal">loop</code> proficiency in no time!<a id="IDX-CHP-10-0050" class="indexterm"/><a id="IDX-CHP-10-0051" class="indexterm"/><a id="IDX-CHP-10-0052" class="indexterm"/></p><p>Almost every legal command that can be used in a <code class="literal">loop</code> macro is covered by the periodic table. It shows how to manipulate hash tables and arrays, and perform special looping operations. Each square in the periodic table contains an example. If you run the example, you should be able to figure out the behavior of the given command.</p></div></div></div>
<div class="sect1" title="Using loop to Evolve!"><div class="titlepage"><div><div><h1 class="title"><a id="using_loop_to_evolve_exclamation"/>Using loop to Evolve!</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17662"/><img src="httpatomoreillycomsourcenostarchimages782680.png.jpg" alt="image with no caption"/></div></div><p>Let’s create another game, making full use of <code class="literal">loop</code>. But this won’t be a game that we play. Instead, it will be a game world that evolves as we watch it! We’re going to create an environment of steppes and jungles, filled with animals running around, foraging, eating, and reproducing. And after a few million units of time, we’ll see that they’ve evolved into different species!</p><div class="note" title="Note"><h3 class="title">Note</h3><p>This example is adapted from A.K. Dewdney’s article “Simulated evolution: wherein bugs learn to hunt bacteria,” in the “Computer Recreations” column of <span class="emphasis"><em>Scientific American</em></span> (May 1989: 138-141).</p></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17679"/><img src="httpatomoreillycomsourcenostarchimages782162.png.jpg" alt="image with no caption"/></div></div><p>Our game world is extremely simple. It consists of a simple rectangular plane, with edges that wrap around to the opposite side. (Mathematically speaking, it has a toroidal topology.) Most of this world is covered in steppes, meaning that very few plants grow for the animals to eat. In the center of the world is a small jungle, where plants grow much faster. Our animals, who are herbivores, will forage this world in search for food.<a id="IDX-CHP-10-0053" class="indexterm"/><a id="IDX-CHP-10-0054" class="indexterm"/><a id="IDX-CHP-10-0055" class="indexterm"/></p><p>Let’s create some variables describing the extent of our world:</p><a id="I_programlisting1_d1e17703"/><pre class="programlisting">(defparameter *width* 100)
(defparameter *height* 30)
(defparameter *jungle* '(45 10 10 10))
(defparameter *plant-energy* 80)</pre><p>We’re giving the world a width of 100 units and a height of 30 units. Using these dimensions should make it easy to display the world in our Lisp REPL. The <code class="literal">*jungle*</code> list defines the rectangle in the world map that contains the jungle. The first two numbers in the list are the x- and y-coordinates of the jungle’s top-left corner, and the last two numbers are its width and height. Finally, we give the amount of energy contained in each plant, which is set to 80. This means that if an animal finds a plant, it will gain 80 days’ worth of food by eating it.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>If your terminal window isn’t large enough to display the entire world, change the values of the <code class="literal">*width*</code> and <code class="literal">*height*</code> variables. Set the <code class="literal">*width*</code> variable to the width of your terminal window minus two, and the <code class="literal">*height*</code> variable to the height of your terminal window minus one.</p></div><div class="sect2" title="Growing Plants in Our World"><div class="titlepage"><div><div><h2 class="title"><a id="growing_plants_in_our_world"/>Growing Plants in Our World</h2></div></div></div><p>As you might imagine, simulating evolution on a computer is a slow process. In order to see the creatures evolve, we need to simulate large stretches of time, which means we’ll want our code for this project to be very efficient. As animals wander around our world, they will need to be able to check if there is a plant at a given x,y location. The most efficient way to enable this is to store all of our plants in a hash table, indexed based on each plant’s x- and y-coordinates.<a id="IDX-CHP-10-0056" class="indexterm"/><a id="IDX-CHP-10-0057" class="indexterm"/><a id="IDX-CHP-10-0058" class="indexterm"/><a id="IDX-CHP-10-0059" class="indexterm"/><a id="IDX-CHP-10-0060" class="indexterm"/><a id="IDX-CHP-10-0061" class="indexterm"/><a id="IDX-CHP-10-0062" class="indexterm"/></p><a id="I_programlisting1_d1e17761"/><pre class="programlisting">(defparameter *plants* (make-hash-table :test #'equal))</pre><p>By default, a Common Lisp hash table uses <code class="literal">eq</code> when testing for the equality of keys. For this hash table, however, we’re defining <code class="literal">:test</code> to use <code class="literal">equal</code> instead of <code class="literal">eq</code>, which will let us use cons pairs of x- and y-coordinates as keys. If you remember our rule of thumb for checking equality, cons pairs should be compared using <code class="literal">equal</code>. If we didn’t make this change, every check for a key would fail, since two different cons cells, even with the same contents, test as being different when using <code class="literal">eq</code>.</p><p>Plants will grow randomly across the world, though a higher concentration of plants will grow in the jungle area than in the steppes. Let’s write some functions to grow new plants:</p><a id="I_programlisting1_d1e17786"/><pre class="programlisting">(defun random-plant (left top width height)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>    (let ((pos (cons (+ left (random width)) (+ top (random height)))))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>         (setf (gethash pos *plants*) t)))

  (defun add-plants ()
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>    (apply #'random-plant *jungle*)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>    (random-plant 0 0 *width* *height*))</pre><p>The <code class="literal">random-plant</code> function creates a new plant within a specified region of the world. It uses the <code class="literal">random</code> function to construct a random location and stores it in the local variable <code class="literal">pos</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e17823"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Then it uses <code class="literal">setf</code> to indicate the existence of the plant within the hash table <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e17833"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. The only item actually stored in the hash table is <code class="literal">t</code>. For this <code class="literal">*plants*</code> table, the keys of the table (the x,y position of each plant) are actually more than the values stored in the table.</p><p>It may seem a bit weird to go through the trouble of creating a hash table to do nothing more than store <code class="literal">t</code> in every slot. However, Common Lisp does not, by default, have a data structure designed for holding mathematical sets. In our game, we want to keep track of the set of all world positions that have a plant in them. It turns out that hash tables are a perfectly acceptable way of expressing this. You simply use each set item as a key and store <code class="literal">t</code> as the value. Indeed, doing this is a bit of a hack, but it is a reasonably simple and efficient hack. (Other Lisp dialects, such as Clojure, have a set data structure built right into them, making this hack unnecessary.)</p><p>Every day our simulation runs, the <code class="literal">add-plants</code> function will create two new plants: one in the jungle <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e17858"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span> and one in the rest of the map <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e17864"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. Because the jungle is so small, it will have dense vegetation compared to the rest of the world.</p></div><div class="sect2" title="Creating Animals"><div class="titlepage"><div><div><h2 class="title"><a id="creating_animals"/>Creating Animals</h2></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17875"/><img src="httpatomoreillycomsourcenostarchimages782474.png" alt="image with no caption"/></div></div><p>The plants in our world are very simple, but the animals are a bit more complicated. Because of this, we’ll need to define a structure that stores the properties of each animal in our game:<a id="IDX-CHP-10-0063" class="indexterm"/><a id="IDX-CHP-10-0064" class="indexterm"/></p><a id="I_programlisting1_d1e17894"/><pre class="programlisting">(defstruct animal x y energy dir genes)</pre><p>Let’s take a look at each of these fields in detail.</p><div class="sect3" title="Anatomy of an Animal"><div class="titlepage"><div><div><h3 class="title"><a id="anatomy_of_an_animal"/>Anatomy of an Animal</h3></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17902"/><img src="httpatomoreillycomsourcenostarchimages781054.png.jpg" alt="image with no caption"/></div></div><p>We need to track several properties for each animal. First, we need to know its x- and y-coordinates. This indicates where the animal is located on the world map.<a id="IDX-CHP-10-0065" class="indexterm"/><a id="IDX-CHP-10-0066" class="indexterm"/></p><p>Next, we need to know how much <code class="literal">energy</code> an animal has. This is a Darwinian game of survival, so if an animal can’t forage enough food, it will starve and die. The energy field tracks how many days of energy an animal has remaining. It is crucial that an animal find more food before its energy supply is exhausted.<a id="IDX-CHP-10-0067" class="indexterm"/></p><p>We also need to track which direction the animal is facing. This is important because an animal will walk to a neighboring square in the world map each day. The <code class="literal">dir</code> field will specify the direction of the animal’s next x,y position as a number from 0 to 7:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17941"/><img src="httpatomoreillycomsourcenostarchimages782494.png" alt="image with no caption"/></div></div><p>For example, an orientation of 0 would cause the animal to move up and to the left by the next day.</p><p>Finally, we need to track the animal’s <code class="literal">genes</code>. Each animal has exactly eight genes, consisting of positive integers. These integers represent eight “slots,” which encircle the animal as follows:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17954"/><img src="httpatomoreillycomsourcenostarchimages781962.png" alt="image with no caption"/></div></div><p>Every day, an animal will decide whether to continue facing the same direction as the day before or to turn and face a new direction. It will do this by consulting these eight slots and randomly choosing a new direction. The chance of a gene being chosen will be proportional to the number stored in the gene slot.</p><p>For example, an animal might have the following genes:</p><a id="I_programlisting1_d1e17964"/><pre class="programlisting">(1 1 10 1 1 1 1 1)</pre><p>Let’s represent these genes as a table, showing each slot number and how large of a value is stored in it:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e17969"/><img src="httpatomoreillycomsourcenostarchimages781380.png.jpg" alt="image with no caption"/></div></div><p>In this example, an animal has a large number (10) stored in slot 2. Looking at our picture of the eight slots around the animal, you can see that slot 2 points to the right. Therefore, this animal will make a lot of right-hand turns and run in a circle. Of course, since the other slots still contain values larger than zero, the animal will occasionally move in another direction.<a id="IDX-CHP-10-0068" class="indexterm"/><a id="IDX-CHP-10-0069" class="indexterm"/></p><p>Let’s create an <code class="literal">*animals*</code> variable, populated with a single starting animal. You can think of this animal as “Adam” (or “Eve”, depending on what gender you prefer for our asexual animals).</p><a id="I_programlisting1_d1e17991"/><pre class="programlisting">(defparameter *animals*
    (list (make-animal :x      (ash *width*  −1)
                       :y      (ash *height* −1)
                       :energy 1000
                       :dir    0
                       :genes  (loop repeat 8
                                     collecting (1+ (random 10))))))</pre><p>We make the animal’s starting point the center of the world by setting the <code class="literal">x</code> and <code class="literal">y</code> positions to half of the map’s width and height, respectively. We set its initial energy to <code class="literal">1000</code>, since it hasn’t evolved much yet and we want it to have a fighting chance at survival. It starts off facing the upper left, with its <code class="literal">dir</code> field set to <code class="literal">0</code>. For its genes, we just use random numbers.<a id="IDX-CHP-10-0070" class="indexterm"/></p><p>Note that unlike the <code class="literal">*plants*</code> structure, which was a hash table, the <code class="literal">*animals*</code> structure is just a plain list (currently containing only a single member). This is because, for the core of our simulation, we never need to search our list of animals. Instead, we’ll just be traversing <code class="literal">*animals*</code> once every simulated day, to let our critters do their daily activities. Lists already support efficient linear traversals, so using another, more complex data structure (such as a table) would have no significant effect on the performance of our simulation.</p></div><div class="sect3" title="Handling Animal Motion"><div class="titlepage"><div><div><h3 class="title"><a id="handling_animal_motion"/>Handling Animal Motion</h3></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e18033"/><img src="httpatomoreillycomsourcenostarchimages780460.png.jpg" alt="image with no caption"/></div></div><p>The <code class="literal">move</code> function accepts an animal as an argument and moves it, orthogonally or diagonally, based on the direction grid we have described:</p><a id="I_programlisting1_d1e18043"/><pre class="programlisting">(defun move (animal)
    (let ((dir (animal-dir animal))
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>         (x (animal-x animal))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>         (y (animal-y animal)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>     (setf (animal-x animal) (mod (+ x
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>                                     (cond ((and (&gt;= dir 2) (&lt; dir 5)) 1)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>                                           ((or (= dir 1) (= dir 5)) 0)
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>                                           (t −1))
                                      *width*)
                                   *width*))
<img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/>     (setf (animal-y animal) (mod (+ y
                                      (cond ((and (&gt;= dir 0) (&lt; dir 3)) −1)
                                            ((and (&gt;= dir 4) (&lt; dir 7)) 1)
                                            (t 0))
                                      *height*)
                                   *height*))
      (decf (animal-energy animal))))</pre><p>The <code class="literal">move</code> function modifies the <code class="literal">x</code> and <code class="literal">y</code> fields, using the <code class="literal">animal-x</code> and <code class="literal">animal-y</code> accessors. As we’ve discussed, these are automatically generated through the <code class="literal">defstruct</code> macro, based on the field names. At the top of this function, we use the accessors to retrieve the x- and y-coordinates for the animal <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18109"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18114"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Then we use the same accessors to set the same values, with the aid of <code class="literal">setf</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18123"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18128"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>.<a id="IDX-CHP-10-0071" class="indexterm"/><a id="IDX-CHP-10-0072" class="indexterm"/><a id="IDX-CHP-10-0073" class="indexterm"/><a id="IDX-CHP-10-0074" class="indexterm"/><a id="IDX-CHP-10-0075" class="indexterm"/></p><p>To calculate the new x-coordinate, we use a <code class="literal">cond</code> command to first check if the direction is 2, 3, or 4 <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18159"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. These are the directions the animal may face that point east in the world, so we want to add one to the x-coordinate. If the direction instead is 1 or 5, it means the animal is facing directly north or south <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18165"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>. In those cases, the x-coordinate shouldn’t be changed. In all other cases, the animal is facing west and we need to subtract one <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18171"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>. The y-coordinate is adjusted in an analogous way <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18177"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>.</p><p>Since the world needs to wrap around at the edges, we do some extra math using the <code class="literal">mod</code> (remainder) function to calculate the modulus of the coordinates and enable wrapping across the map <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18188"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span><span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18193"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>. If an animal would have ended up with an x-coordinate of <code class="literal">*width*</code>, the <code class="literal">mod</code> function puts it back to zero, and it does the same for the y-coordinate and <code class="literal">*height*</code>. So, for example, if our function makes the animal move east until <code class="literal">x</code> equals 100, this will mean that (<code class="literal">mod 100 *width*</code>) equals zero, and the animal will have wrapped around back to the far west side of the game world.</p><p>The final thing the <code class="literal">move</code> function needs to do is decrease the amount of energy the animal possesses by one. Motion, after all, requires energy.</p></div><div class="sect3" title="Handling Animal Turning"><div class="titlepage"><div><div><h3 class="title"><a id="handling_animal_turning"/>Handling Animal Turning</h3></div></div></div><p>Next, we’ll write the <code class="literal">turn</code> function. This function will use the animal’s genes to decide if and how much it will turn on a given day.</p><a id="I_programlisting1_d1e18228"/><pre class="programlisting">(defun turn (animal)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let ((x (random (apply #'+ (animal-genes animal)))))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>     (labels ((angle (genes x)
                 (let ((xnu (- x (car genes))))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>                  (if (&lt; xnu 0)
                       0
                       (1+ (angle (cdr genes) xnu))))))
          (setf (animal-dir animal)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>               (mod (+ (animal-dir animal) (angle (animal-genes animal) x))
  8)))))</pre><p>This function needs to make sure that the amount the animal turns is proportional to the gene number in the given slot. It does this by first summing the amount of all genes, and then picking a random number within that sum <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18256"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. After that, it uses a recursive function named <code class="literal">angle</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18265"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, which traverses the genes and finds the gene that corresponds to the chosen number, based on the respective contributions of each gene to the sum. It subtracts the running count in the argument <code class="literal">x</code> from the number stored at the current gene <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18274"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. If the running count has hit or exceeded zero, the function has reached the chosen number and stops recursing <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18281"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. Finally, it adds the amount of turning to the current direction and, if needed, wraps the number around back to zero, once again by using <code class="literal">mod</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18290"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.<a id="IDX-CHP-10-0076" class="indexterm"/><a id="IDX-CHP-10-0077" class="indexterm"/><a id="IDX-CHP-10-0078" class="indexterm"/></p></div><div class="sect3" title="Handling Animal Eating"><div class="titlepage"><div><div><h3 class="title"><a id="handling_animal_eating"/>Handling Animal Eating</h3></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e18313"/><img src="httpatomoreillycomsourcenostarchimages780304.png" alt="image with no caption"/></div></div><p>Eating is a simple process. We just need to check if there’s a plant at the animal’s current location, and if there is, consume it:</p><a id="I_programlisting1_d1e18320"/><pre class="programlisting">(defun eat (animal)
  (let ((pos (cons (animal-x animal) (animal-y animal))))
    (when (gethash pos *plants*)
      (incf (animal-energy animal) *plant-energy*)
      (remhash pos *plants*))))</pre><p>The animal’s energy is increased by the amount of energy that was being stored by the plant. We then remove the plant from the world using the <code class="literal">remhash</code> function.</p></div><div class="sect3" title="Handling Animal Reproduction"><div class="titlepage"><div><div><h3 class="title"><a id="handling_animal_reproduction"/>Handling Animal Reproduction</h3></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e18331"/><img src="httpatomoreillycomsourcenostarchimages782918.png.jpg" alt="image with no caption"/></div></div><p>Reproduction is usually the most interesting part in any animal simulation. We’ll keep things simple by having our animals reproduce asexually, but it should still be interesting, because errors will creep into their genes as they get copied, causing mutations.<a id="IDX-CHP-10-0079" class="indexterm"/><a id="IDX-CHP-10-0080" class="indexterm"/><a id="IDX-CHP-10-0081" class="indexterm"/><a id="IDX-CHP-10-0082" class="indexterm"/></p><a id="I_programlisting1_d1e18354"/><pre class="programlisting">(defparameter *reproduction-energy* 200)

  (defun reproduce (animal)
    (let ((e (animal-energy animal)))
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>     (when (&gt;= e *reproduction-energy*)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>       (setf (animal-energy animal) (ash e −1))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>       (let ((animal-nu (copy-structure animal))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>             (genes     (copy-list (animal-genes animal)))
              (mutation  (random 8)))
          (setf (nth mutation genes) (max 1 (+ (nth mutation genes) (random 3) −1)))
          (setf (animal-genes animal-nu) genes)
          (push animal-nu *animals*)))))</pre><p>It takes a healthy parent to produce healthy offspring, so our animals will reproduce only if they have at least 200 days’ worth of energy <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18382"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. We use the global constant <code class="literal">*reproduction-energy*</code> to decide what this cutoff number should be. If the animal decides to reproduce, it will lose half its energy to its child <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18391"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.</p><p>To create the new animal, we simply copy the structure of the parent with the <code class="literal">copy-structure</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18402"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. We need to be careful though, since <code class="literal">copy-structure</code> performs only a <span class="emphasis"><em>shallow copy</em></span> of a structure. This means that if there are any fields in the structure that contain values that are more complicated than just numbers or symbols, the values in those fields will be shared with the parent. An animal’s genes, which are stored in a list, represent the only such complex value in our animal structures. If we aren’t careful, mutations in the genes of an animal would simultaneously affect all its parents and children. In order to avoid this, we need to create an explicit copy of our gene list using the <code class="literal">copy-list</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18418"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.<a id="IDX-CHP-10-0083" class="indexterm"/><a id="IDX-CHP-10-0084" class="indexterm"/><a id="IDX-CHP-10-0085" class="indexterm"/><a id="IDX-CHP-10-0086" class="indexterm"/><a id="IDX-CHP-10-0087" class="indexterm"/></p><p>Here is an example that shows what horrible things could happen if we just relied on the shallow copy from the <code class="literal">copy-structure</code> function:</p><a id="I_programlisting1_d1e18448"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter *parent* (make-animal :x 0</code></strong>
  <strong class="userinput"><code>                                      :y 0</code></strong>
  <strong class="userinput"><code>                                      :energy 0</code></strong>
  <strong class="userinput"><code>                                      :dir 0</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/><strong class="userinput"><code>                                       :genes '(1 1 1 1 1 1 1 1)))</code></strong>
  *PARENT*
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> &gt; <strong class="userinput"><code>(defparameter *child* (copy-structure *parent*))</code></strong>
  *CHILD*
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> &gt; <strong class="userinput"><code>(setf (nth 2 (animal-genes *parent*)) 10)</code></strong>
  10
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/> &gt; <strong class="userinput"><code>*parent*</code></strong>
  #S(ANIMAL :X 0 :Y 0 :ENERGY 0 :DIR 0 :GENES (1 1 10 1 1 1 1 1))
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/> &gt; <strong class="userinput"><code>*child*</code></strong>
  #S(ANIMAL :X 0 :Y 0 :ENERGY 0 :DIR 0 :GENES (1 1 10 1 1 1 1 1))</pre><p>Here, we’ve created a parent animal with all its genes set to <code class="literal">1</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18513"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Next, we use <code class="literal">copy-structure</code> to create a child <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18522"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Then we set the third (second counting from zero) gene equal to <code class="literal">10</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18532"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. Our parent now looks correct <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18538"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. Unfortunately, since we neglected to use <code class="literal">copy-list</code> to create a separate list of genes for the child, the child genes were also changed <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18547"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span> when the parent mutated. Any time you have data structures that go beyond simple atomic symbols or numbers, you need to be very careful when using <code class="literal">setf</code> so that these kinds of bugs don’t creep into your code. In future chapters (especially <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>), you’ll learn how to avoid these issues by not using functions that mutate data directly, in the manner that <code class="literal">setf</code> does.</p><p>To mutate an animal in our <code class="literal">reproduce</code> function, we randomly pick one of its eight genes and place it in the <code class="literal">mutation</code> variable. Then we use <code class="literal">setf</code> to twiddle that value a bit, again using a random number. We did this twiddling on the following line:</p><a id="I_programlisting1_d1e18573"/><pre class="programlisting">(setf (nth mutation genes) (max 1 (+ (nth mutation genes) (random 3) −1)))</pre><p>In this line, we’re slightly changing a random slot in the gene list. The number of the slot is stored in the local variable <code class="literal">mutation</code>. We add a random number less than three to the value in this slot, and then subtract one from the total. This means the gene value will change plus or minus one, or stay the same. Since we don’t want a gene value to be smaller than one, we use the <code class="literal">max</code> function to make sure it is at least one.<a id="IDX-CHP-10-0088" class="indexterm"/><a id="IDX-CHP-10-0089" class="indexterm"/><a id="IDX-CHP-10-0090" class="indexterm"/><a id="IDX-CHP-10-0091" class="indexterm"/><a id="IDX-CHP-10-0092" class="indexterm"/><a id="IDX-CHP-10-0093" class="indexterm"/><a id="IDX-CHP-10-0094" class="indexterm"/></p><p>We then use <code class="literal">push</code> to insert this new critter into our global <code class="literal">*animal*</code> list, which adds it to the simulation.</p></div></div><div class="sect2" title="Simulating a Day in Our World"><div class="titlepage"><div><div><h2 class="title"><a id="simulating_a_day_in_our_world"/>Simulating a Day in Our World</h2></div></div></div><p>Now that we have functions that handle every detail of an animal’s routine, let’s write one that simulates a day in our world.</p><a id="I_programlisting1_d1e18623"/><pre class="programlisting">(defun update-world ()
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (setf *animals* (remove-if (lambda (animal)
                                   (&lt;= (animal-energy animal) 0))
                               *animals*))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (mapc (lambda (animal)
            (turn animal)
            (move animal)
            (eat animal)
            (reproduce animal))
          *animals*)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>   (add-plants))</pre><p>First, this function removes all dead animals from the world <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18645"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. (An animal is dead if its energy is less than or equal to zero.) Next, it maps across the list, handling each of the animal’s possible daily activities: turning, moving, eating, and reproducing <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18651"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Since all these functions have side effects (they modify the individual animal structures directly, using <code class="literal">setf</code>), we use the <code class="literal">mapc</code> function, which does not waste time generating a result list from the mapping process.</p><p>Finally, we call the <code class="literal">add-plants</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18668"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, which adds two new plants to the world every day (one in the jungle and one in the steppe). Since there are always new plants growing on the landscape, our simulated world should eventually reach an equilibrium, allowing a reasonably large population of animals to survive throughout the spans of time we simulate.</p></div><div class="sect2" title="Drawing Our World"><div class="titlepage"><div><div><h2 class="title"><a id="drawing_our_world"/>Drawing Our World</h2></div></div></div><p>A simulated world isn’t any fun unless we can actually see our critters running around, searching for food, reproducing, and dying. The <code class="literal">draw-world</code> function handles this by using the <code class="literal">*animals*</code> and <code class="literal">*plants*</code> data structures to draw a snapshot of the current world to the REPL.</p><a id="I_programlisting1_d1e18688"/><pre class="programlisting">(defun draw-world ()
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (loop for y
          below *height*
          do (progn (fresh-line)
                    (princ "|")
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>                   (loop for x
                          below *width*
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>                         do (princ (cond ((some (lambda (animal)
                                                   (and (= (animal-x animal) x)
                                                        (= (animal-y animal) y)))
                                                 *animals*)
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>                                         #\M)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>                                        ((gethash (cons x y) *plants*) #\*)
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>                                         (t #\space))))
<img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/>                    (princ "|"))))</pre><p>First, the function uses a <code class="literal">loop</code> to iterate through each of the world’s rows <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18738"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Every row starts with a new line (created with <code class="literal">fresh-line</code>) followed by a vertical bar, which shows us where the left edge of the world is. Next, we iterate across the columns of the current row <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18747"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, checking for an animal at every location. We perform this check using the <code class="literal">some</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18757"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, which lets us determine if at least one item in a list obeys a certain condition. In this case, the condition we’re checking is whether there’s an animal at the current x- and y-coordinates. If so, we draw the letter <code class="literal">M</code> at that spot <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18766"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. (The capital letter <code class="literal">M</code> looks a little like an animal, if you use your imagination.)<a id="IDX-CHP-10-0095" class="indexterm"/><a id="IDX-CHP-10-0096" class="indexterm"/></p><p>Otherwise, we check for a plant, which we’ll indicate with an asterisk (<code class="literal">*</code>) character <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18788"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>. And if there isn’t a plant or an animal, we draw a space character <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18794"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>. Lastly, we draw another vertical bar to cap off the end of each line <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18800"/><img src="httpatomoreillycomsourcenostarchimages783556.png" alt=""/></span>.</p><p>Notice that in this function, we need to search through our entire <code class="literal">*animals*</code> list, which will cause a performance penalty. However, <code class="literal">draw-world</code> is not a core routine in our simulation. As you’ll see shortly, the user interface for our game will allow us to run thousands of days of the simulation at a time, without drawing the world to the screen until the end. Since there’s no need to draw the screen on every single day when we do this, the performance of <code class="literal">draw-world</code> has no impact on the overall performance of the simulation.<a id="IDX-CHP-10-0097" class="indexterm"/></p></div><div class="sect2" title="Creating a User Interface"><div class="titlepage"><div><div><h2 class="title"><a id="creating_a_user_interface"/>Creating a User Interface</h2></div></div></div><p>Finally, we’ll create a user interface function for our simulation, called <code class="literal">evolution</code>.</p><a id="I_programlisting1_d1e18830"/><pre class="programlisting">(defun evolution ()
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (draw-world)
    (fresh-line)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (let ((str (read-line)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>     (cond ((equal str "quit") ())
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>           (t (let ((x (parse-integer str :junk-allowed t)))
                 (if x
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>                    (loop for i
                        below x
                        do (update-world)
                        if (zerop (mod i 1000))
                        do (princ #\.))
                     (update-world))
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>                (evolution))))))</pre><p>First, this function draws the world in the REPL <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18871"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. Then it waits for the user to enter a command at the REPL using <code class="literal">read-line</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18880"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. If the user enters <code class="literal">quit</code>, the simulation ends <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18889"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. Otherwise, it will attempt to parse the user’s command using <code class="literal">parse-integer</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18899"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. We set <code class="literal">:junk-allowed</code> to <code class="literal">true</code> for <code class="literal">parse-integer</code>, which lets the interface accept a string even if it isn’t a valid integer.<a id="IDX-CHP-10-0098" class="indexterm"/></p><p>If the user enters a valid integer <span class="emphasis"><em>n</em></span>, the program will run the simulation for <span class="emphasis"><em>n</em></span> simulated days, using a loop <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18927"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>. It will also print a dot to the screen for every 1000 days, so the user can see that the computer hasn’t frozen while running the simulation.</p><p>If the input isn’t a valid integer, we run <code class="literal">update-world</code> to simulate one more day. Since <code class="literal">read-line</code> allows for an empty value, the user can just tap the <span class="keycap">enter</span> key and watch the animals move around their world.</p><p>Finally, the <code class="literal">evolution</code> function recursively calls itself to redraw the world and await more user input <span class="inlinemediaobject"><a id="I_inlinemediaobject1_d1e18949"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>. Our simulation is now complete.</p></div><div class="sect2" title="Let's Watch Some Evolution!"><div class="titlepage"><div><div><h2 class="title"><a id="let_apostrophy_s_watch_some_evolution_ex"/>Let's Watch Some Evolution!</h2></div></div></div><p>To start the simulation, execute <code class="literal">evolution</code> as follows:</p><a id="I_programlisting1_d1e18963"/><pre class="programlisting">&gt; <strong class="userinput"><code>(evolution)</code></strong>
|
                                             |
|
                                                     |
|
                                                |
|
                                                     |
|
                                             |
|
                                             |
|
                                            |
|
                                     |
|
                                        |
|
                                             |
|
                                        |
|
                                           |
|
                                      |
|
                                      |
|
                                      |
|                                                  M
                                            |
|
                                        |
|
                                             |
|
                                          |
|
                                             |
|
                                      |
|
                                                  |
|
                                         |
|
                                           |
|
                                           |
|
                                              |
|
                                              |
|
                                          |
|
                                           |
|
                                   |</pre><p>Our world is currently empty, except for the Adam/Eve animal in the center. Hit <span class="keycap">enter</span> a few times to cycle through a few days:</p><a id="I_programlisting1_d1e18973"/><pre class="programlisting">|
                                                    |
|
                                             |
|
                                                  |
|
                                          |
|
                                             |
|
                                         |
|
                                       |
|
                                        |
|
                                          |
|
                                            |
|
                                               |
|
                                                |
|
                                               |
|
                                           |
|                                                *
                                               |
|
                                                     |
|                                               *   M
                                                |
|
                                                     |
|
                                     |
|
                                     |
|
                                         |
|
                                             |
|
                                               |
|
                                                 |
|
                                                 |
|
                                                |
|
                                           |
|
                                             |
|
                                   |
|
                                                |
<strong class="userinput"><code><em class="replaceable"><code>[enter]</code></em></code></strong>
|
                                                |
|
                                                   |
|
                                                 |
|                *
                                                  |
|
                                                 |
|
                                                   |
|
                                                |
|
                                                  |
|
                                                |
|
                                             |
|
                                          |
|
                                               |
|
                                          |
|
                                       |
|                                                *
                                              |
|                                                      *
                                          |
|                                               *  M
                                            |
|
                                           |
|
                                     |
|
                                      |
|
                                  |
|
                                        |
|
                                      |
|
                                             |
|
                                      |
|
                                     |
|
                                         |
|
                                           |
|
                                        |
|
                                      |</pre><p>Our under-evolved animal is stumbling around randomly, and a few plants are starting to grow.</p><p>Next, enter <strong class="userinput"><code>100</code></strong> to see what the world looks like after 100 days:</p><a id="I_programlisting1_d1e18986"/><pre class="programlisting"><strong class="userinput"><code>100</code></strong>
|                                                    *
               *                       |
|
           *                       *          |
|  *                 **                            *
                                           |
|           *    *    *
          * *                        |
|                                          M        *
      M*                           *        |
|          *                        M    *
                                       |
|             *           *                                        *
                                 |
|                                        *     M             M *
                                    |
|                                           M M  M
              *                  |
|                       *                        M M             *    *
                              |
|                        *                       M M  MM                *
    *                      |
|                                            M* *
                              *              |
|                                                 M  M    M
          *                         |
|                          *                  M       MM
                                           |
|          *                  *     *      M  M   *      M
   M  *                     *   *          |
|     *                           *    *       M MM   *  M
       *                *               |
|                                            M M   M*  *
         *              *           |
|                        *      *        M    M  M
                                           |
|                   *                                 *    M
                  *              *  *   |
|
   M                               *       |
|         *                           * M               M
                                            |
|   *                 *               *             M     M
                                         |
| *    *                                  *     M M    M
   M                                        |
|               *                         *      M    M
           * *          *                  |
|                                            *
                                   *       |
|                        *             *
          *                            |
|                            *
                       *              |
|        *      *                                 M
                                        *     |
|                        *
                                     *       |
| *                   *                          M              *
           * * *                   |</pre><p>Our animal has already multiplied quite a bit, although this has less to do with the amount of food it has eaten than with the large amount of “starter energy” we gave it.</p><p>Now let’s go all out and run the simulation for five million days! Since we’re using CLISP, this will be kind of slow, and you may want to start it up in the evening and let it run overnight. With a higher-performance Lisp, such as SBCL, it could take only a couple of minutes.</p><a id="I_programlisting1_d1e18994"/><pre class="programlisting"><strong class="userinput"><code>5000000</code></strong>
|                                                                *
      M              M        |
|         *            *          *
                          M               |
|      M
                       *              |
|           M                                       *
       *       M        M                |
|                *                            M            *
        *                             |
|                                                           **
                                  *   |
|                                                M
                                          |
|           M        *                                M              M
       *                       |
|              *                       *     M   M M     M
              M                     M      |
|                                                M
                        M                  |
| M*                                    *     M  M  MMM    M
                                   M     |
|    *              *                     MMM  *           M             M
                       M  |
|  *            M    *               M      M *MM*     MMM M
                           *            |
|                                              M  MMMMMM M M
      M                        *         |
|               M                          MMMM MMM  M *          M
                              M   |
|         M                              *          M MMM
     *                               *   |
|                                             M M M  M M M
     M                           *    |
|      M                                M M  MMM               M
      M       M                 |
|                      M                  M  M    MM
   M             *          *      |
|                                     *     MMM M
 MM M                                        M   |
|                        M                            MM     *
            M                          |
|                                             MMM  M  M   M
                                         |
|           *               M                           M
                                         |
|               M            M          M        *M                *
       M   M                     |
|      M        M
      MM            M                |
|  M                             *                 M   *    M
    M                                 |
|               MM      M      M      M
     M                        |
|                   M       M         M
                                         |
|        M           *    M                    *            *
                *                  |
|        M     M                                     M
                                          |</pre><p>Our world doesn’t look much different after five million days than it did after a hundred days. Of course, there are more animals, both traveling across the steppes and enjoying the lush vegetation of the jungle.</p><p>But appearances are deceptive. These animals are distinctly different from their early ancestors. If you observe them closely (by tapping <span class="keycap">enter</span>), you’ll see that some of the creatures move in straight lines and others just jitter around in a small area, never taking more than a single step in any direction. (As an exercise, you could tweak the code to use different letters for each animal, in order to make their motion even easier to observe.) You can see this contrast even more clearly by typing <code class="literal">quit</code> to exit the simulation, then checking the contents of the <code class="literal">*animals*</code> variable at the REPL:<a id="IDX-CHP-10-0099" class="indexterm"/></p><a id="I_programlisting1_d1e19017"/><pre class="programlisting">&gt;<strong class="userinput"><code>*animals*</code></strong>
#S(ANIMAL :X 6 :Y 24 :ENERGY 65 :DIR 3 :GENES (67 35 13 14 1 3 11 74))
 #S(ANIMAL :X 72 :Y 11 :ENERGY 78 :DIR 6 :GENES (68 36 13 12 2 4 11 72))
 #S(ANIMAL :X 16 :Y 26 :ENERGY 78 :DIR 0 :GENES (71 36 9 16 1 6 5 77))
 #S(ANIMAL :X 50 :Y 25 :ENERGY 76 :DIR 4 :GENES (2 2 7 5 21 208 33 9))
 #S(ANIMAL :X 53 :Y 13 :ENERGY 34 :DIR 4 :GENES (1 2 8 5 21 208 33 8))
 #S(ANIMAL :X 58 :Y 10 :ENERGY 66 :DIR 6 :GENES (5 2 7 2 22 206 29 3))
 #S(ANIMAL :X 74 :Y 3 :ENERGY 77 :DIR 0 :GENES (68 35 11 12 1 3 11 74))
 #S(ANIMAL :X 47 :Y 19 :ENERGY 47 :DIR 2 :GENES (5 1 8 4 21 207 30 3))
 #S(ANIMAL :X 27 :Y 22 :ENERGY 121 :DIR 1 :GENES (69 36 11 12 1 2 11 74))
 #S(ANIMAL :X 96 :Y 14 :ENERGY 78 :DIR 5 :GENES (71 37 9 17 2 5 5 77))
 #S(ANIMAL :X 44 :Y 19 :ENERGY 28 :DIR 1 :GENES (1 3 7 5 22 208 34 8))
 #S(ANIMAL :X 55 :Y 22 :ENERGY 18 :DIR 7 :GENES (1 3 8 5 22 208 34 7))
 #S(ANIMAL :X 52 :Y 10 :ENERGY 63 :DIR 0 :GENES (1 2 7 5 23 208 34 7))
 #S(ANIMAL :X 49 :Y 14 :ENERGY 104 :DIR 4 :GENES (4 1 9 2 22 203 28 1))
 #S(ANIMAL :X 39 :Y 23 :ENERGY 62 :DIR 7 :GENES (70 37 9 15 2 6 5 77))
 #S(ANIMAL :X 97 :Y 11 :ENERGY 48 :DIR 0 :GENES (69 36 13 12 2 5 12 72))
 ...</pre><p>If you look closely at all the animals in the list, you’ll notice that they have two distinct types of genomes. One group of animals has a high number toward the front of the list, which causes them to move mostly in a straight line. The other group has a large number toward the back of the list, which causes them to jitter about within a small area. There are no animals with a genome between those two extremes. Have we evolved two different species?</p><p>If you were to create a function that measured how far these evolved animals travel in a fixed amount of time, the histogram of the distance would appear as follows:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e19027"/><img src="httpatomoreillycomsourcenostarchimages783464.png.jpg" alt="image with no caption"/></div></div><p>This is a clear bimodal distribution, showing that the behavior of these animals appears to fall into two populations. Think about the environment these animals live in, and try to reason why this bimodal distribution would evolve. We will discuss the solution to this conundrum next.</p></div><div class="sect2" title="Explaining the Evolution"><div class="titlepage"><div><div><h2 class="title"><a id="explaining_the_evolution"/>Explaining the Evolution</h2></div></div></div><p>The solution to the evolution puzzle is pretty straightforward. There are two possible survival strategies an animal can adopt in this imaginary world:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Focus on the rich food supply in the jungle. Any animal adopting this strategy needs to be conservative in its motion. It can’t stray too far over time, or it might fall out of the jungle. Of course, these types of animals <span class="emphasis"><em>do</em></span> need to evolve at least a bit of jittery motion, or they will never find any food at all. Let’s call these conservative, jittery, jungle-dwelling animals the <span class="emphasis"><em>elephant species</em></span>.</p></li><li class="listitem"><p>Forage the sparse vegetation of the steppes. Here, the most critical trait for survival is to cover large distances. Such an animal needs to be open-minded, and must constantly migrate to new areas of the map to find food. (It can’t travel in <span class="emphasis"><em>too</em></span> straight a line however, or it may end up competing for resources with its own offspring.) This strategy requires a bit of naïve optimism, and can at times lead to doom. Let’s call these liberally minded, risk-taking animals the <span class="emphasis"><em>donkey species</em></span>.</p></li></ul></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject1_d1e19059"/><img src="httpatomoreillycomsourcenostarchimages781764.png.jpg" alt="image with no caption"/></div></div><p>Expanding the simulation to evolve the three branches of government is left as an exercise to the reader.</p></div></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id10"/>What You've Learned</h1></div></div></div><p>In this chapter, we discussed the <code class="literal">loop</code> command in detail. Along the way, you learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The <code class="literal">loop</code> command is a one-stop looping shop—it can do anything you need a <code class="literal">loop</code> to do.</p></li><li class="listitem"><p>To count through numbers in a loop, use the <code class="literal">for</code> phrase.</p></li><li class="listitem"><p>To count through items in a list within a loop, use the <code class="literal">for in</code> phrase.</p></li><li class="listitem"><p>You can collect items inside a list and return them as a list with the <code class="literal">collect</code> phrase.</p></li><li class="listitem"><p>Use the Periodic Table of the Loop Macro to find other useful phrases supported by <code class="literal">loop</code>.</p></li></ul></div></div>
<div class="chapter" title="Chapter&#xA0;11.&#xA0;Printing Text with the format Function"><div class="titlepage"><div><div><h1 class="title"><a id="printing_text_with_the_format_function"/>Chapter 11. Printing Text with the format Function</h1></div></div></div><p>Even in this modern era of programming, it’s extremely important to be able to manipulate text, and Common Lisp has some of the fanciest text-printing functions available. Whether you need to manipulate XML, HTML, Linux configuration files, or any other data in a textual format, Lisp will make your work easy.<a id="IDX-CHP-11-0001" class="indexterm"/></p><p>The most important advanced text printing function in Common Lisp is the <code class="literal">format</code> function, which is the subject of this chapter.</p><div class="sect1" title="Anatomy of the format Function"><div class="titlepage"><div><div><h1 class="title"><a id="anatomy_of_the_format_function"/>Anatomy of the format Function</h1></div></div></div><p>Here is an example of the <code class="literal">format</code> function in use:</p><a id="I_programlisting2_d1e19131"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "Add onion rings for only ˜$ dollars more!" 1.5)</code></strong>
Add onion rings for only 1.50 dollars more!
NIL</pre><p>Let’s take a look at what each part of this function means.<a id="IDX-CHP-11-0002" class="indexterm"/><a id="IDX-CHP-11-0003" class="indexterm"/><a id="IDX-CHP-11-0004" class="indexterm"/><a id="IDX-CHP-11-0005" class="indexterm"/><a id="IDX-CHP-11-0006" class="indexterm"/><a id="IDX-CHP-11-0007" class="indexterm"/><a id="IDX-CHP-11-0008" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e19164"/><img src="httpatomoreillycomsourcenostarchimages780524.png.jpg" alt="image with no caption"/></div></div><div class="sect2" title="The Destination Parameter"><div class="titlepage"><div><div><h2 class="title"><a id="the_destination_parameter"/>The Destination Parameter</h2></div></div></div><p>The first parameter to the <code class="literal">format</code> function is the <span class="emphasis"><em>destination</em></span> parameter, which tells <code class="literal">format</code> where to send the text it generates. Here are its possible values:</p><div class="variablelist"><dl><dt><span class="term"><strong class="userinput"><code>nil</code></strong></span></dt><dd><p>Don’t print anything; just return the value as a string.</p></dd><dt><span class="term"><strong class="userinput"><code>t</code></strong></span></dt><dd><p>Print the value to the console. In this case, the function just returns nil as a value (as in our example).</p></dd><dt><span class="term"><strong class="userinput"><code>stream</code></strong></span></dt><dd><p>Write the data to an output stream (covered in <a class="xref" href="ch13.html" title="Chapter 12. Working with Streams">Chapter 12</a>).</p></dd></dl></div><p>In the following example, we set the first parameter to <code class="literal">nil</code> so it simply returns the value as a string:</p><a id="I_programlisting2_d1e19212"/><pre class="programlisting">&gt; <strong class="userinput"><code>(princ (reverse</code></strong>
        <strong class="userinput"><code>(format nil "Add onion rings for only ˜$ dollars more!" 1.5)))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> !erom srallod 05.1 ylno rof sgnir noino ddA
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/> "!erom srallod 05.1 ylno rof sgnir noino ddA"</pre><p>The resulting string value (<code class="literal">"Add onion rings for only 1.50 dollars more!"</code>) is passed to the <code class="literal">reverse</code> function, and then that reversed string is printed to the screen with the <code class="literal">princ</code> command <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e19243"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>.</p><p>In this example, the REPL will also print the value of the entered expression, along with the information output by the <code class="literal">princ</code> command. This is why you see the value displayed a second time <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e19254"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. For the remainder of this chapter, the examples will omit these values printed by the REPL, and show only the information explicitly printed by our code.</p></div><div class="sect2" title="The Control String Parameter"><div class="titlepage"><div><div><h2 class="title"><a id="the_control_string_parameter"/>The Control String Parameter</h2></div></div></div><p>The second parameter to the <code class="literal">format</code> function is a <code class="literal">control string</code>, which controls the text formatting. The <code class="literal">format</code> function’s power lies in the control string. In our current example, the control string is <code class="literal">"Add onion rings for only ˜$ dollars more!"</code>.</p><p>By default, the text in this string is simply printed as output. However, you can place <span class="emphasis"><em>control sequences</em></span> into this string to affect the format of the output, as described in the remainder of this chapter. Our current example contains the control sequence <code class="literal">˜$</code>, which indicates a <span class="emphasis"><em>monetary floating-point</em></span> value. Every control sequence recognized by the <code class="literal">format</code> function begins with the tilde (<code class="literal">˜</code>) character.<a id="IDX-CHP-11-0009" class="indexterm"/><a id="IDX-CHP-11-0010" class="indexterm"/><a id="IDX-CHP-11-0011" class="indexterm"/><a id="IDX-CHP-11-0012" class="indexterm"/><a id="IDX-CHP-11-0013" class="indexterm"/><a id="IDX-CHP-11-0014" class="indexterm"/><a id="IDX-CHP-11-0015" class="indexterm"/><a id="IDX-CHP-11-0016" class="indexterm"/><a id="IDX-CHP-11-0017" class="indexterm"/><a id="IDX-CHP-11-0018" class="indexterm"/></p></div><div class="sect2" title="Value Parameters"><div class="titlepage"><div><div><h2 class="title"><a id="value_parameters"/>Value Parameters</h2></div></div></div><p>The <code class="literal">format</code> parameters following the control string contain values, or the actual data to be displayed and formatted. As you’ll see, the control string interacts with these parameters and controls their formatting.</p></div></div></div>
<div class="sect1" title="Control Sequences for Printing Lisp Values"><div class="titlepage"><div><div><h1 class="title"><a id="control_sequences_for_printing_lisp_valu"/>Control Sequences for Printing Lisp Values</h1></div></div></div><p>Any Lisp value can be printed with the <code class="literal">print</code> or <code class="literal">prin1</code> command. To print a value for humans, without any delimiters, we can use the <code class="literal">princ</code> command:</p><a id="I_programlisting2_d1e19347"/><pre class="programlisting">&gt; <strong class="userinput"><code>(prin1 "foo")</code></strong>
"foo"
&gt; <strong class="userinput"><code>(princ "foo")</code></strong>
foo</pre><p>We can use the <code class="literal">˜s</code> and <code class="literal">˜a</code> control sequences with <code class="literal">format</code> to produce the same behavior as <code class="literal">prin1</code> and <code class="literal">princ</code>. When used with <code class="literal">format</code>, the <code class="literal">˜s</code> control sequence includes appropriate delimiters. The <code class="literal">˜a</code> shows the value, without delimiters, for humans to read:</p><a id="I_programlisting2_d1e19382"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "I am printing ˜s in the middle of this sentence." "foo")</code></strong>
I am printing "foo" in the middle of this sentence.
&gt; <strong class="userinput"><code>(format t "I am printing ˜a in the middle of this sentence." "foo")</code></strong>
I am printing foo in the middle of this sentence.</pre><p>We can adjust the behavior of these control sequences even further by entering parameters within the control sequence. For instance, we can place a number <span class="emphasis"><em>n</em></span> in front of the <code class="literal">a</code> or <code class="literal">s</code> to indicate that the value should be <span class="emphasis"><em>padded</em></span> with blank spaces on the right. The <code class="literal">format</code> command will then add spaces until the total width of the value is <span class="emphasis"><em>n</em></span>.</p><p>For example, by writing <code class="literal">˜10a</code> in the following example, we add seven spaces to the right of <code class="literal">foo</code>, making the total width of the formatted value 10 characters:</p><a id="I_programlisting2_d1e19419"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "I am printing ˜10a within ten spaces of room." "foo")</code></strong>
I am printing foo        within ten spaces of room.</pre><p>We can also add spaces on the left side of the value by adding the @ symbol, as follows:</p><a id="I_programlisting2_d1e19426"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "I am printing ˜10@a within ten spaces of room." "foo")</code></strong>
I am printing        foo within ten spaces of room.</pre><p>In this case, the total width of the added spaces along with the value <code class="literal">foo</code> equals 10 characters.</p><p>Control sequences can accept more than just one parameter. In the preceding examples, we set only the first parameter, which controls the final width of the final formatted string. Let’s look at an example that sets the second parameter of the <code class="literal">˜a</code> control sequence as well:</p><a id="I_programlisting2_d1e19442"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "I am printing ˜10,3a within ten (or more) spaces of room." "foo")</code></strong>
I am printing foo          within ten (or more) spaces of room.</pre><p>As you can see, additional parameters to a control sequence are separated with a comma. In this case, the second parameter is set to <code class="literal">3</code>, which tells the <code class="literal">format</code> command to add spaces in groups of three (instead of just one at a time) until the goal width of 10 is reached. In this example, a total of nine spaces are added to the formatted value. This means it overshot our goal width of 10 (by design), leading instead to a total width of 12 (nine spaces plus the letters <code class="literal">foo</code>). Padding strings in multiples like this is not a commonly needed feature, so the second parameter to the <code class="literal">˜a</code> control sequence is rarely used.</p><p>Sometimes we need to control the exact number of spaces to add to our string, regardless of the length of the final value. We can do this by setting the third parameter in the <code class="literal">˜a</code> control sequence. For example, suppose we want to print exactly four spaces after the final formatted value. To set the third control sequence parameter equal to four, we place two commas in front of the parameter to indicate that the first two parameters are blank, then follow this with a <code class="literal">4</code>:</p><a id="I_programlisting2_d1e19469"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "I am printing ˜,,4a in the middle of this sentence." "foo")</code></strong>
I am printing foo     in the middle of this sentence.</pre><p>Notice that there are exactly four extra spaces inserted in the results. Since the first and second parameters were not specified before the commas, their default values will be used.</p><p>The fourth control sequence parameter specifies which character will be used for padding. For example, in the following listing, we pad the printed value with four exclamation points:</p><a id="I_programlisting2_d1e19478"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "The word ˜,,4,'!a feels very important." "foo")</code></strong>
The word foo!!!! feels very important.</pre><p>These control sequence parameters can also be combined. For example, we can add the <code class="literal">@</code> symbol to our code to indicate that the exclamation marks should appear in front of the value, like this:</p><a id="I_programlisting2_d1e19488"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "The word ˜,,4,'!@a feels very important." "foo")</code></strong>
The word !!!!foo feels very important.</pre><p>Now that you have an overview of <code class="literal">format</code> command control sequences, let’s look at how to use them for formatting, beginning with numbers.</p></div>
<div class="sect1" title="Control Sequences for Formatting Numbers"><div class="titlepage"><div><div><h1 class="title"><a id="control_sequences_for_formatting_numbers"/>Control Sequences for Formatting Numbers</h1></div></div></div><p>The <code class="literal">format</code> command has many options designed specifically for controlling the appearance of numbers. Let’s look at some of the more useful ones.<a id="IDX-CHP-11-0019" class="indexterm"/><a id="IDX-CHP-11-0020" class="indexterm"/><a id="IDX-CHP-11-0021" class="indexterm"/><a id="IDX-CHP-11-0022" class="indexterm"/><a id="IDX-CHP-11-0023" class="indexterm"/><a id="IDX-CHP-11-0024" class="indexterm"/><a id="IDX-CHP-11-0025" class="indexterm"/><a id="IDX-CHP-11-0026" class="indexterm"/><a id="IDX-CHP-11-0027" class="indexterm"/><a id="IDX-CHP-11-0028" class="indexterm"/><a id="IDX-CHP-11-0029" class="indexterm"/><a id="IDX-CHP-11-0030" class="indexterm"/><a id="IDX-CHP-11-0031" class="indexterm"/><a id="IDX-CHP-11-0032" class="indexterm"/><a id="IDX-CHP-11-0033" class="indexterm"/></p><div class="sect2" title="Control Sequences for Formatting Integers"><div class="titlepage"><div><div><h2 class="title"><a id="control_sequences_for_formatting_integer"/>Control Sequences for Formatting Integers</h2></div></div></div><p>First, we can use <code class="literal">format</code> to display a number using a different base. For instance, we can display a number in hexadecimal (base-16) with the <code class="literal">˜x</code> control sequence:</p><a id="I_programlisting2_d1e19571"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "The number 1000 in hexadecimal is ˜x" 1000)</code></strong>
The number 1000 in hexadecimal is 3E8</pre><p>Similarly, we can display a number in binary (base-2) using the <code class="literal">˜b</code> control sequence:</p><a id="I_programlisting2_d1e19581"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "The number 1000 in binary is ˜b" 1000)</code></strong>
The number 1000 in binary is 1111101000</pre><p>We can even explicitly declare that a value will be displayed as a decimal (base-10) number, using the <code class="literal">˜d</code> control sequence:</p><a id="I_programlisting2_d1e19591"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "The number 1000 in decimal is ˜d" 1000)</code></strong>
The number 1000 in decimal is 1000</pre><p>In this case, we would have gotten the same result if we had just used the more generic <code class="literal">˜a</code> control sequence. The difference is that <code class="literal">˜d</code> supports special parameters and flags that are specific to printing decimal numbers. For example, we can place a colon inside the control sequence to enable commas as digit group separators:</p><a id="I_programlisting2_d1e19604"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "Numbers with commas in them are ˜:d times better." 1000000)</code></strong>
Numbers with commas in them are 1,000,000 times better.</pre><p>To control the width of the number, we can set the padding parameter, just as we did with the <code class="literal">˜a</code> and <code class="literal">˜s</code> control sequences:</p><a id="I_programlisting2_d1e19617"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "I am printing ˜10d within ten spaces of room" 1000000)</code></strong>
I am printing    1000000 within ten spaces of room</pre><p>To change the character used for padding, pass in the desired character (in this case, the <span class="emphasis"><em>x</em></span> character) as the second parameter:</p><a id="I_programlisting2_d1e19628"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "I am printing ˜10,'xd within ten spaces of room" 1000000)</code></strong>
I am printing xxx1000000 within ten spaces of room</pre></div><div class="sect2" title="Control Sequences for Formatting Floating-Point Numbers"><div class="titlepage"><div><div><h2 class="title"><a id="control_sequences_for_formatting_floatin"/>Control Sequences for Formatting Floating-Point Numbers</h2></div></div></div><p>Floating-point values are handled with the <code class="literal">˜f</code> control sequence. As with all of the previously discussed control sequences, we can change the value’s display width by changing the first parameter. When used with floating-point numbers, the <code class="literal">format</code> command will automatically round the value to fit within the requested number of characters (including the decimal point):<a id="IDX-CHP-11-0034" class="indexterm"/><a id="IDX-CHP-11-0035" class="indexterm"/><a id="IDX-CHP-11-0036" class="indexterm"/><a id="IDX-CHP-11-0037" class="indexterm"/><a id="IDX-CHP-11-0038" class="indexterm"/><a id="IDX-CHP-11-0039" class="indexterm"/><a id="IDX-CHP-11-0040" class="indexterm"/><a id="IDX-CHP-11-0041" class="indexterm"/><a id="IDX-CHP-11-0042" class="indexterm"/></p><a id="I_programlisting2_d1e19678"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "PI can be estimated as ˜4f" 3.141593)</code></strong>
PI can be estimated as 3.14</pre><p>As you can see, the final width of <code class="literal">3.14</code> is four characters wide, as specified by the control sequence.</p><p>The second parameter of the <code class="literal">˜f</code> control sequence controls the number of digits displayed after the decimal point. For example, if we pass <code class="literal">4</code> as the second parameter in the preceding example, we get the following output:</p><a id="I_programlisting2_d1e19696"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "PI can be estimated as ˜,4f" 3.141593)</code></strong>
PI can be estimated as 3.1416</pre><p>Note that Common Lisp actually includes the constant <code class="literal">pi</code> as part of the standard, so you could also rewrite the command like this:</p><a id="I_programlisting2_d1e19706"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "PI can be estimated as ˜,4f" pi)</code></strong>
PI can be estimated as 3.1416</pre><p>The third parameter of the <code class="literal">˜f</code> control sequence causes the number to be scaled by factors of ten. For example, we can pass <code class="literal">2</code> as the third parameter, which we can use to multiply a fraction by 10<sup>2</sup> to turn it into a percentage:</p><a id="I_programlisting2_d1e19722"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "Percentages are ˜,,2f percent better than fractions" 0.77)</code></strong>
Percentages are 77.0 percent better than fractions</pre><p>In addition to <code class="literal">˜f</code>, we can use the control sequence <code class="literal">˜$</code>, which is used for formatting currencies:</p><a id="I_programlisting2_d1e19736"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "I wish I had ˜$ dollars in my bank account." 1000000.2)</code></strong>
I wish I had 1000000.20 dollars in my bank account.</pre><p>You saw an example that used <code class="literal">˜$</code> at the beginning of this chapter.</p></div></div>
<div class="sect1" title="Printing Multiple Lines of Output"><div class="titlepage"><div><div><h1 class="title"><a id="printing_multiple_lines_of_output"/>Printing Multiple Lines of Output</h1></div></div></div><p>Common Lisp has two different commands for starting a new line during printing. The first, <code class="literal">terpri</code>, simply tells Lisp to terminate the current line and start a new one for printing subsequent output. For example, we can print two numbers on different lines like so:</p><a id="I_programlisting2_d1e19754"/><pre class="programlisting">&gt; <strong class="userinput"><code>(progn (princ 22)</code></strong>
         <strong class="userinput"><code>(terpri)</code></strong>
         <strong class="userinput"><code>(princ 33))</code></strong>
22
33</pre><p>We can also start a new line with <code class="literal">fresh-line</code>. This command will start a new line, but only if the cursor position in the REPL isn’t already at the very front of a line. Let’s look at some examples:<a id="IDX-CHP-11-0043" class="indexterm"/><a id="IDX-CHP-11-0044" class="indexterm"/><a id="IDX-CHP-11-0045" class="indexterm"/><a id="IDX-CHP-11-0046" class="indexterm"/><a id="IDX-CHP-11-0047" class="indexterm"/><a id="IDX-CHP-11-0048" class="indexterm"/></p><a id="I_programlisting2_d1e19792"/><pre class="programlisting">&gt; <strong class="userinput"><code>(progn (princ 22)</code></strong>
         <strong class="userinput"><code>(fresh-line)</code></strong>
         <strong class="userinput"><code>(princ 33))</code></strong>
22
33
&gt; <strong class="userinput"><code>(progn (princ 22)</code></strong>
         <strong class="userinput"><code>(fresh-line)</code></strong>
         <strong class="userinput"><code>(fresh-line)</code></strong>
         <strong class="userinput"><code>(princ 33))</code></strong>
22
33</pre><p>As you can see, placing two <code class="literal">fresh-line</code> statements between the two <code class="literal">princ</code> calls resulted in Lisp printing only one line between the outputted numbers. The first <code class="literal">fresh-line</code> starts a new line; the second <code class="literal">fresh-line</code> is simply ignored.</p><p>Essentially, the <code class="literal">terpri</code> command says “start a new line,” whereas the <code class="literal">fresh-line</code> command says “start a new line, <span class="emphasis"><em>if needed</em></span>.” Any code using the <code class="literal">terpri</code> command needs to “know” what was printed before. Otherwise, unsightly empty lines may result. Since it’s always better if different parts of a program know as little about each other as possible, most Lispers prefer using <code class="literal">fresh-line</code> over <code class="literal">terpri</code>, because it allows them to decouple the printing of one piece of data from the next.</p><p>The <code class="literal">format</code> command has two control sequences that are analogous to <code class="literal">terpri</code> and <code class="literal">fresh-line</code>:</p><div class="variablelist"><dl><dt><span class="term"><strong class="userinput"><code>˜%</code></strong></span></dt><dd><p>causes a new line to be created in all cases (like <code class="literal">terpri</code>)</p></dd><dt><span class="term"><strong class="userinput"><code>˜&amp;</code></strong></span></dt><dd><p>creates new lines only as needed (like <code class="literal">fresh-line</code>).</p></dd></dl></div><p>These examples illustrate this difference:</p><a id="I_programlisting2_d1e19885"/><pre class="programlisting">&gt; <strong class="userinput"><code>(progn (format t "this is on one line ˜%")</code></strong>
           <strong class="userinput"><code>(format t "˜%this is on another line"))</code></strong>
  this is on one line
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>
  this is on another line
  &gt; <strong class="userinput"><code>(progn (format t "this is on one line ˜&amp;")</code></strong>
           <strong class="userinput"><code>(format t "˜&amp;this is on another line"))</code></strong>
  this is on one line
  this is on another line</pre><p>As you can see, using an extra <code class="literal">˜%</code> prints an unsightly empty line <span class="inlinemediaobject"><a id="I_inlinemediaobject2_d1e19911"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, and using <code class="literal">˜&amp;</code> in the same places does not.</p><p>These two line-termination sequences can also have an additional parameter in front of them to indicate the number of new lines to be created. This is useful in cases where we want to use empty lines to space out our output. For example, the addition of <code class="literal">5</code> in the following example adds five empty lines to our output:<a id="IDX-CHP-11-0049" class="indexterm"/><a id="IDX-CHP-11-0050" class="indexterm"/><a id="IDX-CHP-11-0051" class="indexterm"/><a id="IDX-CHP-11-0052" class="indexterm"/><a id="IDX-CHP-11-0053" class="indexterm"/><a id="IDX-CHP-11-0054" class="indexterm"/><a id="IDX-CHP-11-0055" class="indexterm"/></p><a id="I_programlisting2_d1e19954"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "this will print ˜5%on two lines spread far apart")</code></strong>
this will print




on two lines spread far apart</pre></div>
<div class="sect1" title="Justifying Output"><div class="titlepage"><div><div><h1 class="title"><a id="justifying_output"/>Justifying Output</h1></div></div></div><p>The <code class="literal">format</code> command also gives us a lot of control over text justification. Control sequences allow us to format tables, center text, and perform other useful justification feats.<a id="IDX-CHP-11-0056" class="indexterm"/></p><p>To help you understand the various justification rules, we’ll create a simple function that returns different animal names with varying character lengths:</p><a id="I_programlisting2_d1e19972"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun random-animal ()</code></strong>
      <strong class="userinput"><code>(nth (random 5) '("dog" "tick" "tiger" "walrus" "kangaroo")))</code></strong>
RANDOM-ANIMAL
&gt; <strong class="userinput"><code>(random-animal)</code></strong>
"walrus"</pre><p>Now suppose we want to display a bunch of random animals in a table. We can do this by using the <code class="literal">˜t</code> control sequence. <code class="literal">˜t</code> can take a parameter that specifies the column position at which the formatted value should appear. For example, to have our table of animals appear in three columns at the fifth, fifteenth, and twenty-fifth character positions, we could create this table:</p><a id="I_programlisting2_d1e19991"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop repeat 10</code></strong>
        <strong class="userinput"><code>do (format t "˜5t˜a ˜15t˜a ˜25t˜a˜%"</code></strong>
                   <strong class="userinput"><code>(random-animal)</code></strong>
                   <strong class="userinput"><code>(random-animal)</code></strong>
                   <strong class="userinput"><code>(random-animal)))</code></strong>
     kangaroo  tick      dog
     dog       walrus    walrus
     walrus    tiger     tiger
     walrus    kangaroo  dog
     kangaroo  tiger     dog
     tiger     walrus    kangaroo
     tick      dog       tiger
     kangaroo  tick      kangaroo
     tiger     dog       walrus
     kangaroo  kangaroo  tick</pre><p>Remember that a <code class="literal">loop</code> command with a <code class="literal">repeat 10</code> clause executes the body of the loop 10 times. As you can see, use of the <code class="literal">˜t</code> control sequence caused the animals to be laid out in a neatly formatted table.<a id="IDX-CHP-11-0057" class="indexterm"/><a id="IDX-CHP-11-0058" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e20026"/><img src="httpatomoreillycomsourcenostarchimages782580.png.jpg" alt="image with no caption"/></div></div><p>Now suppose we want all the animals be spaced equally apart on a single line. To do so, we can use the <code class="literal">˜&lt;</code> and <code class="literal">˜&gt;</code> control sequences, as follows:</p><a id="I_programlisting2_d1e20039"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop repeat 10</code></strong>
        <strong class="userinput"><code>do (format t "˜30&lt;˜a˜;˜a˜;˜a˜&gt;˜%"</code></strong>
                   <strong class="userinput"><code>(random-animal)</code></strong>
                   <strong class="userinput"><code>(random-animal)</code></strong>
                   <strong class="userinput"><code>(random-animal)))</code></strong>
tick         tiger        tick
tick         tiger         dog
tick          dog          dog
kangaroo     kangaroo    tiger
tiger      tiger      kangaroo
walrus       kangaroo      dog
dog         dog         walrus
kangaroo       dog      walrus
walrus        dog       walrus
kangaroo       tiger      tick</pre><p>Let’s deconstruct this control string to understand how it works:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e20060"/><img src="httpatomoreillycomsourcenostarchimages780168.png" alt="image with no caption"/></div></div><p>First, the <code class="literal">˜30&lt;</code> tells the function that we’re initiating a block of justified text. The parameter <code class="literal">30</code> indicates that the block should be 30 characters wide. Next, we have three <code class="literal">˜a</code> control sequences in a row, one for each animal. Each <code class="literal">˜a</code> is separated by <code class="literal">;</code>, which tells <code class="literal">format</code> that we’re starting a new value to be justified by <code class="literal">˜&lt;</code>. (The <code class="literal">˜;</code> sequences indicate where extra spaces should be inserted to justify the values.) We then end the justified section with the <code class="literal">˜&gt;</code> command sequence.<a id="IDX-CHP-11-0059" class="indexterm"/><a id="IDX-CHP-11-0060" class="indexterm"/></p><p>Because the equal spacing of the animals in each line doesn’t guarantee that the columns created by printing multiple lines will be properly aligned, we add the <code class="literal">:@</code> flag to our justification <code class="literal">˜&lt;</code> command sequence. For example, we can create a single, neatly centered column as follows:</p><a id="I_programlisting2_d1e20109"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop repeat 10 do (format t "˜30:@&lt;˜a˜&gt;˜%" (random-animal)))</code></strong>
              dog
            walrus
           kangaroo
             tick
             tick
             tiger
              dog
           kangaroo
           kangaroo
              dog</pre><p>In the same way, we can use <code class="literal">:@</code> with multiple justified values, centering them on the line with additional space at their left and right ends:</p><a id="I_programlisting2_d1e20119"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop repeat 10</code></strong>
        <strong class="userinput"><code>do (format t "˜30:@&lt;˜a˜;˜a˜;˜a˜&gt;˜%"</code></strong>
                     <strong class="userinput"><code>(random-animal)</code></strong>
                     <strong class="userinput"><code>(random-animal)</code></strong>
                     <strong class="userinput"><code>(random-animal)))</code></strong>
    walrus    tick    tick
    walrus    tiger    tick
     tick     dog     tick
    walrus    tiger   tiger
   kangaroo   dog   kangaroo
   tiger   kangaroo   walrus
   tiger  kangaroo  kangaroo
    kangaroo   tiger   tick
    tick    tiger    walrus
    walrus    tiger    tick</pre><p>This step brings us closer to having three neatly centered columns, but our columns are still a bit wavy because we’re aligning the values within a single line, without telling <code class="literal">format</code> to arrange the values using three centered columns.<a id="IDX-CHP-11-0061" class="indexterm"/></p><p>To produce neat columns, we’ll still use the <code class="literal">:@</code> flag, but we’ll describe our rows using three separate 10-character justification sections:</p><a id="I_programlisting2_d1e20149"/><pre class="programlisting">&gt; <strong class="userinput"><code>(loop repeat 10</code></strong>
        <strong class="userinput"><code>do (format t "˜10:@&lt;˜a˜&gt;˜10:@&lt;˜a˜&gt;˜10:@&lt;˜a˜&gt;˜%"</code></strong>
                     <strong class="userinput"><code>(random-animal)</code></strong>
                     <strong class="userinput"><code>(random-animal)</code></strong>
                     <strong class="userinput"><code>(random-animal)))</code></strong>
   tiger   kangaroo  kangaroo
 kangaroo  kangaroo   walrus
   tick      tick      tick
    dog       dog       dog
   tiger      dog     walrus
    dog      tiger   kangaroo
  walrus      dog      tick
   tick     walrus   kangaroo
    dog      tick     walrus
   tiger     tiger     tiger</pre><p>At last, we have the nicely centered random animal columns of our dreams!<a id="IDX-CHP-11-0062" class="indexterm"/><a id="IDX-CHP-11-0063" class="indexterm"/><a id="IDX-CHP-11-0064" class="indexterm"/><a id="IDX-CHP-11-0065" class="indexterm"/><a id="IDX-CHP-11-0066" class="indexterm"/><a id="IDX-CHP-11-0067" class="indexterm"/><a id="IDX-CHP-11-0068" class="indexterm"/></p><p>As you can see, the layout options for <code class="literal">format</code> are quite flexible. Since we often need to create complex lists and tables of data when debugging applications, these tricks are very helpful when you need to get a handle on your data, even with more complex programs.</p></div>
<div class="sect1" title="Iterating Through Lists Using Control Sequences"><div class="titlepage"><div><div><h1 class="title"><a id="iterating_through_lists_using_control_se"/>Iterating Through Lists Using Control Sequences</h1></div></div></div><p>The <code class="literal">format</code> function with its many control sequences is practically a programming language in its own right. (In fact, many Lispers would call it a <span class="emphasis"><em>domain-specific language</em></span>, a concept we will revisit in <a class="xref" href="ch19.html" title="Chapter 17. Domain-Specific Languages">Chapter 17</a>.) And, like most programming languages, <code class="literal">format</code> can loop through data. It does this using the <code class="literal">˜{</code> and <code class="literal">˜}</code> control sequences.</p><p>To achieve this looping, pass the <code class="literal">format</code> function a control string containing <code class="literal">˜{</code> and <code class="literal">˜}</code>, and a list to iterate through. The part of the control string between the <code class="literal">˜{</code> and <code class="literal">˜}</code> sequences is treated almost like the body of a loop. It will be executed a number of times, depending on the length of the list that follows it. The <code class="literal">format</code> function will iterate through this list, applying each of its items to the specified section of the control string.</p><p>For example, let’s create a list of animals that we can use for testing:</p><a id="I_programlisting2_d1e20246"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter *animals* (loop repeat 10 collect (random-animal)))</code></strong>
*ANIMALS*
&gt; <strong class="userinput"><code>*animals*</code></strong>
("dog" "kangaroo" "walrus" "kangaroo" "kangaroo" "walrus" "kangaroo"
 "dog" "tick" "tick")</pre><p>Now we use the <code class="literal">˜{ ˜}</code> control sequences to to loop through this list:</p><a id="I_programlisting2_d1e20259"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "˜{I see a ˜a! ˜}" *animals*)</code></strong>
I see a dog! I see a kangaroo! I see a walrus! I see a kangaroo! I see
 a kangaroo! I see a walrus! I see a kangaroo!
 I see a dog! I see a tick! I see a tick!</pre><p>To produce this loop, we simply pass the single variable <code class="literal">*animals*</code>, a list of items, to the <code class="literal">format</code> function. The control string iterates through the list, constructing the sentence <code class="literal">"I see a ˜a"</code> for each member of <code class="literal">*animals*</code>.<a id="IDX-CHP-11-0069" class="indexterm"/><a id="IDX-CHP-11-0070" class="indexterm"/><a id="IDX-CHP-11-0071" class="indexterm"/><a id="IDX-CHP-11-0072" class="indexterm"/></p><p>A single iteration construct can also grab more than one item from the list, as in this example:</p><a id="I_programlisting2_d1e20297"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "˜{I see a ˜a... or was it a ˜a?˜%˜}" *animals*)</code></strong>
I see a dog... or was it a kangaroo?
I see a walrus... or was it a kangaroo?
I see a kangaroo... or was it a walrus?
I see a kangaroo... or was it a dog?
I see a tick... or was it a tick?</pre><p>Here, we have two <code class="literal">˜a</code> control sequences within a single looping construct. Each <code class="literal">˜a</code> pulls a single animal from the list, so two animals print for every iteration of the loop.</p></div>
<div class="sect1" title="A Crazy Formatting Trick for Creating Pretty Tables of Data"><div class="titlepage"><div><div><h1 class="title"><a id="a_crazy_formatting_trick_for_creating_pr"/>A Crazy Formatting Trick for Creating Pretty Tables of Data</h1></div></div></div><p>Let’s look at one last <code class="literal">format</code> example that uses some of the control sequences you’ve already seen, as well as some new ones. This example will illustrate how the varied control sequences can be combined for complex behavior.</p><a id="I_programlisting2_d1e20318"/><pre class="programlisting">&gt; <strong class="userinput"><code>(format t "|˜{˜&lt;|˜%|˜,33:;˜2d ˜&gt;˜}|" (loop for x below 100 collect x))</code></strong>
| 0  1  2  3  4  5  6  7  8  9 |
|10 11 12 13 14 15 16 17 18 19 |
|20 21 22 23 24 25 26 27 28 29 |
|30 31 32 33 34 35 36 37 38 39 |
|40 41 42 43 44 45 46 47 48 49 |
|50 51 52 53 54 55 56 57 58 59 |
|60 61 62 63 64 65 66 67 68 69 |
|70 71 72 73 74 75 76 77 78 79 |
|80 81 82 83 84 85 86 87 88 89 |
|90 91 92 93 94 95 96 97 98 99 |</pre><p>To create this nicely formatted table of numbers, we first use the looping control sequences <code class="literal">˜{ ˜}</code> to iterate through a list of numbers created by the <code class="literal">loop</code> command. Within the iteration, we place justification control sequences <code class="literal">˜&lt; ˜&gt;</code>, which we’ve used earlier. In this case, we don’t use them to justify our text, but instead use them to divide the resulting text into pieces. This is how we break our 100 numbers into nice clean rows of 10. We place the <code class="literal">˜:;</code> control sequence inside our justification control sequences <code class="literal">˜&lt; ˜&gt;</code>, which causes text to be broken into pieces of equal length.</p><p>When used inside a justification, the control string preceding this sequence <code class="literal">˜:;</code> (which in this case happens to be <code class="literal">|˜%|</code>) will be triggered only if the current cursor position is beyond a certain point, as specified by the second parameter, <code class="literal">33</code>. In other words, we’re telling the format function “Hey, once you have 33 characters’ worth of text, start a fresh line.”<a id="IDX-CHP-11-0073" class="indexterm"/><a id="IDX-CHP-11-0074" class="indexterm"/><a id="IDX-CHP-11-0075" class="indexterm"/><a id="IDX-CHP-11-0076" class="indexterm"/><a id="IDX-CHP-11-0077" class="indexterm"/></p><p>The <code class="literal">|˜%|</code> control string causes the line break and vertical bars to be printed. The number to be displayed is formatted using <code class="literal">˜2d</code>, which prints a left-justified number, two characters wide.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>For full details on every single control sequence, see the <span class="emphasis"><em>Common Lisp HyperSpec</em></span> at <a class="ulink" href="http://www.lispworks.com/documentation/HyperSpec/Front/index.htm">http://www.lispworks.com/documentation/HyperSpec/Front/index.htm</a>.</p></div></div>
<div class="sect1" title="Attack of the Robots!"><div class="titlepage"><div><div><h1 class="title"><a id="attack_of_the_robots_exclamation"/>Attack of the Robots!</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e20393"/><img src="httpatomoreillycomsourcenostarchimages780825.png.jpg" alt="image with no caption"/></div></div><p>Here, we look at a game so horrifying that it’s sure to give you nightmares: Attack of the Robots! In this game, robots have taken over the world, and it’s your job to destroy them. Though the plot may sound scary, the part of this game that will <span class="emphasis"><em>really</em></span> give a Lisp programmer nightmares is the way it abuses the <code class="literal">loop</code> and <code class="literal">format</code> commands in order to squeeze a fully functional robot-fighting game into a <span class="emphasis"><em>single page of code!</em></span> (This program uses the “crazy formatting trick” discussed in the previous section.)</p><p>I have annotated the code with some basic explanations. If you want to understand how the game works in detail, you’ll need to review most of the information from the previous couple of chapters. Also, you can visit <a class="ulink" href="http://landoflisp.com/">http://landoflisp.com/</a> to download the source code for the game and read a more thorough explanation of the code.</p><p>To win the game, you need to strategically walk around the field to cause all robots to collide with each other. The movement keys are QWE/ASD/ZXC. These characters form a grid on the left side of your keyboard, letting you move up, down, left, right, as well as diagonally. You can also teleport with the T key.</p><p>Enjoy!</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject2_d1e20421"/><img src="httpatomoreillycomsourcenostarchimages783256.png.jpg" alt="image with no caption"/></div></div></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id11"/>What You've Learned</h1></div></div></div><p>This chapter didn’t really even come close to covering all of the features of the <code class="literal">format</code> function. However, it did provide an introduction, in which you learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The first parameter of the <code class="literal">format</code> command determines whether the output is sent to the REPL, a stream, or returned as a string.</p></li><li class="listitem"><p>The second parameter of the <code class="literal">format</code> command is a <span class="emphasis"><em>control string</em></span> that lets you change the way your data is printed. The control string has a sophisticated syntax, acting almost like a programming language in its own right.</p></li><li class="listitem"><p>The remaining <code class="literal">format</code> parameters are values that can be referenced from the control string to embed values into the formatted output.</p></li><li class="listitem"><p>To embed a Lisp value into a formatted string, use the <code class="literal">˜s</code> or <code class="literal">˜a</code> control sequences.</p></li><li class="listitem"><p>Many control sequences are available for printing and customizing the appearance of numbers.</p></li><li class="listitem"><p>The <code class="literal">format</code> command also has complex looping abilities that can be used, for example, to format tables laid out in many different styles.</p></li></ul></div></div>
<div class="chapter" title="Chapter&#xA0;12.&#xA0;Working with Streams"><div class="titlepage"><div><div><h1 class="title"><a id="working_with_streams"/>Chapter 12. Working with Streams</h1></div></div></div><p>Nearly every computer program you write will need to interact with the outside world at some point. Perhaps your program just needs to communicate with the user through the REPL, printing out information and capturing the user’s input from the keyboard. Other programs you write may need to read or write files on a hard drive. Additionally, you may want to write programs that interact with other computers, either over a local network or the Internet. In Common Lisp, these kinds of interactions happen through streams.<a id="IDX-CHP-12-0001" class="indexterm"/></p><p><span class="emphasis"><em>Streams</em></span> are data types in Common Lisp that allow you to take some external resource and make it look like just another simple piece of data you can manipulate with your code. The external resource could be a variety of things: a file on a disk, another computer on a network, or text in a console window on the screen. As you’ll learn in this chapter, through the use of a stream, a Lisp program can interact with this outside resource just as easily as it might interact with a list or a hash table.<a id="IDX-CHP-12-0002" class="indexterm"/><a id="IDX-CHP-12-0003" class="indexterm"/><a id="IDX-CHP-12-0004" class="indexterm"/></p><div class="sect1" title="Types of Streams"><div class="titlepage"><div><div><h1 class="title"><a id="types_of_streams"/>Types of Streams</h1></div></div></div><p>When we communicate with an external resource from a Common Lisp program, we do so by using a stream. Different types of streams are available for different types of resources. Another factor is the direction of the stream—sometimes you will want to write data to a resource, and sometimes you will want to read data from a resource.<a id="IDX-CHP-12-0005" class="indexterm"/></p><div class="sect2" title="Streams by Type of Resource"><div class="titlepage"><div><div><h2 class="title"><a id="streams_by_type_of_resource"/>Streams by Type of Resource</h2></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e20510"/><img src="httpatomoreillycomsourcenostarchimages780982.png.jpg" alt="image with no caption"/></div></div><p>When organized by the type of resource on which they operate, the following are the most commonly used stream types:</p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>Console streams</strong></span></span></dt><dd><p>What we’ve been using so far when communicating with the REPL.</p></dd><dt><span class="term"><span class="strong"><strong>File streams</strong></span></span></dt><dd><p>Let us read and write to files on our hard drive.</p></dd><dt><span class="term"><span class="strong"><strong>Socket streams</strong></span></span></dt><dd><p>Let us communicate with other computers on a network.</p></dd><dt><span class="term"><span class="strong"><strong>String streams</strong></span></span></dt><dd><p>Let us send and receive text from a Lisp string.</p></dd></dl></div><p>Of these stream types, string streams are the black sheep of the family. Rather than letting you communicate with the outside world, string streams allow you to manipulate strings in new and interesting ways.<a id="IDX-CHP-12-0006" class="indexterm"/></p></div><div class="sect2" title="Streams by Direction"><div class="titlepage"><div><div><h2 class="title"><a id="streams_by_direction"/>Streams by Direction</h2></div></div></div><p>When you write data to a resource, you use <span class="emphasis"><em>output streams</em></span>. For reading data from a resource, you use <span class="emphasis"><em>input streams</em></span>.<a id="IDX-CHP-12-0007" class="indexterm"/><a id="IDX-CHP-12-0008" class="indexterm"/></p><div class="sect3" title="Output Streams"><div class="titlepage"><div><div><h3 class="title"><a id="output_streams"/>Output Streams</h3></div></div></div><p>Output streams are used for tasks such as writing to the REPL, writing to a file, or sending information over a socket. At the most primitive level, you can do two things with an output stream:<a id="IDX-CHP-12-0009" class="indexterm"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Check whether the stream is valid.</p></li><li class="listitem"><p>Push a new item onto the stream.</p></li></ul></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e20584"/><img src="httpatomoreillycomsourcenostarchimages780652.png" alt="image with no caption"/></div></div><p>As you can see, a stream is more restrictive than a true data structure in Lisp. For instance, a list supports all of the same features as a stream (we can push a new item onto a list with <code class="literal">push</code> and check if a list is valid with <code class="literal">listp</code>), and we also can do certain tasks with a list that we can’t do with an output stream (such as changing items in the list with <code class="literal">setf</code>). But this limited functionality of streams actually makes them useful in many cases.<a id="IDX-CHP-12-0010" class="indexterm"/><a id="IDX-CHP-12-0011" class="indexterm"/><a id="IDX-CHP-12-0012" class="indexterm"/><a id="IDX-CHP-12-0013" class="indexterm"/><a id="IDX-CHP-12-0014" class="indexterm"/><a id="IDX-CHP-12-0015" class="indexterm"/></p><p>To see if we have a valid output stream, we can use the <code class="literal">output-stream-p</code> function. For example, the REPL has an output stream associated with it called <code class="literal">*standard-output*</code>. We can see if this is a valid output stream with the following code:</p><a id="I_programlisting3_d1e20627"/><pre class="programlisting">&gt; <strong class="userinput"><code>(output-stream-p *standard-output*)</code></strong>
T</pre><p>A Lisp character is one item that can be pushed onto an output stream using the basic command <code class="literal">write-char</code>. For example, to write the character <code class="literal">#\x</code> to the <code class="literal">*standard-output*</code> stream, we can run the following command:</p><a id="I_programlisting3_d1e20643"/><pre class="programlisting">&gt; <strong class="userinput"><code>(write-char #\x *standard-output*)</code></strong>
xNIL</pre><p>This code prints an <span class="emphasis"><em>x</em></span> to the standard output (which, in this case, is the same as the REPL). Note that this function also returns <code class="literal">nil</code>, causing the <span class="emphasis"><em>x</em></span> and the return value to be printed on the same line. As you saw in <a class="xref" href="ch06.html" title="Chapter 6. Interacting with the World: Reading and Printing in Lisp">Chapter 6</a>, this extra <code class="literal">nil</code> is just a side effect of running the code in the REPL. If we ran this command as part of a larger program, only the <span class="emphasis"><em>x</em></span> would have printed out.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>In this chapter, we’ll discuss only streams based on text characters. In Common Lisp, you can also create streams based on other data types. For instance, if you’re working with binary data, you may want to send or receive raw bytes instead of characters. But for our purposes, manipulating textual data (and hence using streams that work with text characters) is the most convenient.</p></div></div><div class="sect3" title="Input Streams"><div class="titlepage"><div><div><h3 class="title"><a id="input_streams"/>Input Streams</h3></div></div></div><p>Input streams are used for reading data. As with output streams, the actions that you can perform with an input stream are limited. At the most primitive level, you can do two things with an input stream:<a id="IDX-CHP-12-0016" class="indexterm"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Check whether the stream is valid.</p></li><li class="listitem"><p>Pop an item off of the stream.</p></li></ul></div><p>We can see if we have a valid stream with the <code class="literal">input-stream-p</code> command. For instance, as with standard output, the REPL has an associated input stream called <code class="literal">*standard-input*</code>, which we can validate as follows:</p><a id="I_programlisting3_d1e20694"/><pre class="programlisting">&gt; <strong class="userinput"><code>(input-stream-p *standard-input*)</code></strong>
T</pre><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e20700"/><img src="httpatomoreillycomsourcenostarchimages781986.png" alt="image with no caption"/></div></div><p>We can pop an item off the stream with the <code class="literal">read-char</code> command. Since we’re reading from the REPL, we need to type some characters and press <span class="keycap">enter</span> to send the data into the standard input stream:<a id="IDX-CHP-12-0017" class="indexterm"/></p><a id="I_programlisting3_d1e20716"/><pre class="programlisting">&gt; <strong class="userinput"><code>(read-char *standard-input*)</code></strong>
<strong class="userinput"><code>123</code></strong>
#\1</pre><p>As you can see, the 1 at the front of the stream was popped off and returned by <code class="literal">read-char</code>.</p><div class="sidebar"><a id="using_other_commands_to_interact_with_st"/><p class="title">USING OTHER COMMANDS TO INTERACT WITH STREAMS</p><p>In addition to <code class="literal">write-char</code> and <code class="literal">read-char</code>, Common Lisp has many other commands for interacting with streams. In fact, all the commands for printing and reading introduced in <a class="xref" href="ch06.html" title="Chapter 6. Interacting with the World: Reading and Printing in Lisp">Chapter 6</a> can accept a stream as an extra parameter, which lets us use Lisp's powerful input/output abilities with any stream. For instance, we can explicitly tell the <code class="literal">print</code> command to print to <code class="literal">*standard-output*</code>, as follows:<a id="IDX-CHP-12-0018" class="indexterm"/><a id="IDX-CHP-12-0019" class="indexterm"/><a id="IDX-CHP-12-0020" class="indexterm"/><a id="IDX-CHP-12-0021" class="indexterm"/><a id="IDX-CHP-12-0022" class="indexterm"/></p><a id="I_programlisting3_d1e20772"/><pre class="programlisting">&gt; <strong class="userinput"><code>(print 'foo *standard-output*)</code></strong>
FOO</pre><p>This can be useful when working with streams other than <code class="literal">*standard-output*</code>, as you'll see shortly.</p></div></div></div></div></div>
<div class="sect1" title="Working with Files"><div class="titlepage"><div><div><h1 class="title"><a id="working_with_files"/>Working with Files</h1></div></div></div><p>In addition to using streams to write to and read from the REPL, we can also use streams to write to and read from files.<a id="IDX-CHP-12-0023" class="indexterm"/></p><p>You can create a file stream in Common Lisp in several ways. The best way is to use the <code class="literal">with-open-file</code> command. As you’ll see shortly, this command contains special bug-prevention features that make it safer to use than other available file commands. The following example uses <code class="literal">with-open-file</code> to write the string <code class="literal">"my data"</code> to a file named <code class="literal">data.txt</code>:</p><a id="I_programlisting3_d1e20804"/><pre class="programlisting">&gt; <strong class="userinput"><code>(with-open-file (</code></strong><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/><strong class="userinput"><code>my-stream "data.txt" :direction :output)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/><strong class="userinput"><code>      (print "my data" my-stream))</code></strong></pre><p>In this example, the <code class="literal">with-open-file</code> command binds the output stream to the name <code class="literal">my-stream</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e20831"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. This causes a file output stream to be created with the name <code class="literal">my-stream</code>. This stream will be available within the body of the <code class="literal">with-open-file</code> command (until the final closing bracket <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e20844"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>), and any data we send to this stream will end up in the file named <code class="literal">data.txt</code> on the disk. The <code class="literal">print</code> command references <code class="literal">my-stream</code> as the destination for its output <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e20859"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Therefore, after running this example, you should find a new file named <code class="literal">data.txt</code> in the folder from which you launched CLISP. This file has the text "<code class="literal">my data</code>" as its content.</p><p>Specifying <code class="literal">:output</code> as the direction for <code class="literal">with-open-file</code> creates an output stream. To make this an input stream instead, we could change the direction to <code class="literal">:input</code>, as follows:</p><a id="I_programlisting3_d1e20883"/><pre class="programlisting">&gt; <strong class="userinput"><code>(with-open-file (my-stream "data.txt" :direction :input)</code></strong>
<strong class="userinput"><code>     (read my-stream))</code></strong>
"my data"</pre><p>As you can see, this causes the data—the same data written to the file in the previous example—to be read in from the file.<a id="IDX-CHP-12-0024" class="indexterm"/><a id="IDX-CHP-12-0025" class="indexterm"/><a id="IDX-CHP-12-0026" class="indexterm"/></p><p>As you learned in <a class="xref" href="ch06.html" title="Chapter 6. Interacting with the World: Reading and Printing in Lisp">Chapter 6</a>, the <code class="literal">print</code> and <code class="literal">read</code> commands can print and read any of the basic Common Lisp data types. This functionality makes it easy to use streams to store data from your programs to the hard drive. Here is a more complicated example that writes an association list (alist) to a file:</p><a id="I_programlisting3_d1e20914"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(let ((animal-noises '((dog . woof)</code></strong>
  <strong class="userinput"><code>                         (cat . meow))))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/><strong class="userinput"><code>     (with-open-file (my-stream "animal-noises.txt" :direction :output)</code></strong>
         <strong class="userinput"><code>(print animal-noises my-stream)))</code></strong>
  ((DOG . WOOF) (CAT . MEOW))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> &gt; <strong class="userinput"><code>(with-open-file (my-stream "animal-noises.txt" :direction :input)</code></strong>
       <strong class="userinput"><code>(read my-stream))</code></strong>
  ((DOG . WOOF) (CAT . MEOW))</pre><p>In this example, we’re creating an association table of animals and the sounds they make. We create a new alist named <code class="literal">animal-noises</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e20956"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. We put keys for <code class="literal">dog</code> and <code class="literal">cat</code> into this list. Now we can write this alist to a new file called <code class="literal">animal-noises.txt</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e20972"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Later, we can easily reconstitute this alist from the file <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e20978"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.</p><p>The <code class="literal">with-open-file</code> command can take keyword parameters that modify its behavior. For instance, you can tell the command what to do if a file with the given name already exists. In the following example, we’ll display an error message using the <code class="literal">:if-exists</code> keyword parameter:</p><a id="I_programlisting3_d1e20993"/><pre class="programlisting">&gt; <strong class="userinput"><code>(with-open-file (my-stream "data.txt" :direction :output :if-exists :error)</code></strong>
      <strong class="userinput"><code>(print "my data" my-stream))</code></strong>
*** - OPEN: file #P"/home/user/data.txt" already exists</pre><p>Alternatively, you may simply want the existing file to be overwritten. In that case, set the <code class="literal">:if-exists</code> keyword parameter to <code class="literal">:supersede</code>, as follows:</p><a id="I_programlisting3_d1e21009"/><pre class="programlisting">&gt; <strong class="userinput"><code>(with-open-file (my-stream "data.txt" :direction :output</code></strong>
                                         <strong class="userinput"><code>:if-exists :supersede)</code></strong>
      <strong class="userinput"><code>(print "my data" my-stream))</code></strong>
"my data"</pre><p>The <code class="literal">with-open-file</code> command gives you a very succinct way to work with files. Unlike most programming languages, when using this command, you don’t need to open and close files manually, and you don’t need to worry about potentially messing up your files by failing to properly close them. (Actually, Common Lisp has lower-level commands for opening and closing files as well, but <code class="literal">with-open-file</code> packages them in a clean way that hides all the ugly details.)</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e21029"/><img src="httpatomoreillycomsourcenostarchimages782374.png.jpg" alt="image with no caption"/></div></div><p>The main purpose of <code class="literal">with-open-file</code> is to acquire a file resource. It takes command of the file and assumes the responsibility of closing it. In fact, even if the code inside the <code class="literal">with-open-file</code> throws an ugly error that stops the program dead, <code class="literal">with-open-file</code> will still close the file properly to make sure this resource stays intact.<a id="IDX-CHP-12-0027" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>Common Lisp has many commands that begin with <code class="literal">with-</code> that will safely allocate resources in this way. These <code class="literal">with-</code> commands, available in the core Lisp libraries, are built with Lisp’s awesome macro system. You’ll learn more about Lisp macros, and how to create your own <code class="literal">with-</code> commands, in <a class="xref" href="ch18.html" title="Chapter 16. The Magic of Lisp Macros">Chapter 16</a>.</p></div></div>
<div class="sect1" title="Working with Sockets"><div class="titlepage"><div><div><h1 class="title"><a id="working_with_sockets"/>Working with Sockets</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e21066"/><img src="httpatomoreillycomsourcenostarchimages779968.png" alt="image with no caption"/></div></div><p>Now that we’ve used streams to communicate with the REPL and with files, let’s see how we can use them to communicate with another computer.<a id="IDX-CHP-12-0028" class="indexterm"/><a id="IDX-CHP-12-0029" class="indexterm"/><a id="IDX-CHP-12-0030" class="indexterm"/><a id="IDX-CHP-12-0031" class="indexterm"/><a id="IDX-CHP-12-0032" class="indexterm"/></p><p>If you want to write a program that can communicate with another computer elsewhere on a standard network (almost all networks nowadays use the TCP/IP protocol), you’ll first need to create a socket. A <span class="emphasis"><em>socket</em></span> is a mechanism for routing data over a computer network between programs running on different computers on that network.</p><p>Unfortunately, sockets didn’t make it into the ANSI Common Lisp standard, which means there’s no standard way of interacting with sockets at this time. However, every version of Common Lisp supports sockets, even if it doesn’t follow any standard. Since we’ve been using CLISP as our Lisp of choice in this book, we’ll consider only CLISP’s socket commands.<a id="IDX-CHP-12-0033" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>cl-sockets <span class="emphasis"><em>(</em></span><a class="ulink" href="http://common-lisp.net/project/cl-sockets/">http://common-lisp.net/project/cl-sockets/</a><span class="emphasis"><em>)</em></span> and usocket <span class="emphasis"><em>(</em></span><a class="ulink" href="http://common-lisp.net/project/usocket/">http://common-lisp.net/project/usocket/</a><span class="emphasis"><em>)</em></span> are two attempts at adding a standard socket library to Common Lisp.<a id="IDX-CHP-12-0034" class="indexterm"/><a id="IDX-CHP-12-0035" class="indexterm"/></p></div><div class="sect2" title="Socket Addresses"><div class="titlepage"><div><div><h2 class="title"><a id="socket_addresses"/>Socket Addresses</h2></div></div></div><p>Every socket within a network must have a <span class="emphasis"><em>socket address</em></span>. This socket address has two components:</p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>IP address</strong></span></span></dt><dd><p>A number that uniquely identifies a computer on the network (typically shown as 4 bytes delimited by periods, such as 192.168.33.22).</p></dd><dt><span class="term"><span class="strong"><strong>Port number</strong></span></span></dt><dd><p>Any programs that want to use the network must choose a unique port number that no other program on the same computer is already using.</p></dd></dl></div><p>The IP address and the port number combine to make up the socket address. Since the IP address is unique on a network and the port number is unique for a given computer, every socket address on a network is unique to a specific program running on a specific computer. Any messages running over the network (through chunks of data called <span class="emphasis"><em>TCP packets</em></span>) will be labeled with a socket address to indicate their destination.<a id="IDX-CHP-12-0036" class="indexterm"/></p><p>Once a computer receives a packet labeled with its IP address, the operating system will look at the port number in the socket address of the message to figure out which program should receive the message.</p><p>And how does the operating system know which program receives messages for a given port? It knows this because a program first must create a socket for that port in order to use it. In other words, a socket is simply a way for a computer program to tell the operating system, “Hey, if you get any messages on port 251, send them my way!”</p></div><div class="sect2" title="Socket Connections"><div class="titlepage"><div><div><h2 class="title"><a id="socket_connections"/>Socket Connections</h2></div></div></div><p>In order to actually send a message over a socket between two programs, we first need to follow some steps to initialize a <span class="emphasis"><em>socket connection</em></span>. The first step in creating such a connection is to have one of the programs create a socket that starts in a listening state, waiting to see if other programs on the network want to start a communication. The computer with the socket in a listening state is called the <span class="emphasis"><em>server</em></span>. Then the other program, called a <span class="emphasis"><em>client</em></span>, creates a socket on its end and uses it to establish a connection with the server. If all goes well, these two programs can now transmit messages across the socket connection running between them.<a id="IDX-CHP-12-0037" class="indexterm"/><a id="IDX-CHP-12-0038" class="indexterm"/><a id="IDX-CHP-12-0039" class="indexterm"/><a id="IDX-CHP-12-0040" class="indexterm"/><a id="IDX-CHP-12-0041" class="indexterm"/><a id="IDX-CHP-12-0042" class="indexterm"/><a id="IDX-CHP-12-0043" class="indexterm"/></p><p>But enough talk. Let’s try connecting two programs right now to see the magic happen for ourselves!</p></div><div class="sect2" title="Sending a Message over a Socket"><div class="titlepage"><div><div><h2 class="title"><a id="sending_a_message_over_a_socket"/>Sending a Message over a Socket</h2></div></div></div><p>First, open two copies of CLISP in two different console windows on your computer. We’ll call one the client and one the server. (Or, if you have two computers on a network and know their IP addresses, you can create the two consoles on two separate machines, for the full network experience.)</p><div class="note" title="Note"><h3 class="title">Note</h3><p>You <span class="emphasis"><em>must</em></span> use CLISP to get the socket code shown in this chapter to run.</p></div><p>On the server, take control of a port by calling <code class="literal">socket-server</code>:</p><a id="I_programlisting3_d1e21218"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter my-socket (socket-server 4321))</code></strong> ;ON THE SERVER
MY-SOCKET</pre><p>This command acquires port 4321 and binds a socket to it using the operating system. The socket is bound to the <code class="literal">my-socket</code> variable so that we can interact with it.</p><p>This command is somewhat dangerous, because the operating system is expecting us to give up the socket once we’re finished with it. If we don’t, no one will be able to use this socket anymore. In fact, if you make any mistakes during this socket exercise, you could mess up the socket at port 4321, and then you would need to switch to another port number until you restart your computer. (In the next chapter, you’ll learn how to use the exception handling system in Common Lisp to work around these ugly problems.)</p><p>Next, let’s make a stream from this socket (still on the server) that handles a connection from a single client:</p><a id="I_programlisting3_d1e21232"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter my-stream (socket-accept my-socket))</code></strong> ;ON THE SERVER</pre><p>After running this command, the server will seem to lock up, and you won’t be returned to the REPL prompt. Don’t be alarmed—the <code class="literal">socket-accept</code> command is a <span class="emphasis"><em>blocking operation</em></span>, which means the function won’t exit until a client has connected.<a id="IDX-CHP-12-0044" class="indexterm"/><a id="IDX-CHP-12-0045" class="indexterm"/><a id="IDX-CHP-12-0046" class="indexterm"/><a id="IDX-CHP-12-0047" class="indexterm"/><a id="IDX-CHP-12-0048" class="indexterm"/></p><p>Now switch over to your client CLISP and use the <code class="literal">socket-connect</code> command to connect to that socket on the server:</p><a id="I_programlisting3_d1e21268"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter my-stream (socket-connect 4321 "127.0.0.1"))</code></strong> ;ON THE CLIENT
MY-STREAM</pre><p>The IP address 127.0.0.1 is a special address that always points to the computer from which it’s called. If you are using two different computers for this exercise, you should enter the actual IP address of your server.</p><p>After running this command, the server will unlock, and the value of the <code class="literal">my-stream</code> variable will be set. We now have a stream open in both copies of CLISP, and we can use it to communicate between them!</p><p>The stream CLISP has created here is called a <span class="emphasis"><em>bidirectional</em></span> stream. This means it can act both as an input stream and an output stream, and we can use either set of commands on it to communicate in both directions. Let’s send a cordial greeting between the client and the server.</p><p>Enter the following on the client:</p><a id="I_programlisting3_d1e21287"/><pre class="programlisting">&gt; <strong class="userinput"><code>(print "Yo Server!" my-stream)</code></strong>
"Yo Server!"</pre><p>And enter the following on the server:</p><a id="I_programlisting3_d1e21294"/><pre class="programlisting">&gt; <strong class="userinput"><code>(read my-stream)</code></strong>
"Yo Server!"</pre><p>Then, still on the server, enter this:</p><a id="I_programlisting3_d1e21301"/><pre class="programlisting">&gt; <strong class="userinput"><code>(print "What up, Client!" my-stream)</code></strong>
"What up, Client!"</pre><p>Back on the client, run this command:</p><a id="I_programlisting3_d1e21309"/><pre class="programlisting">&gt; <strong class="userinput"><code>(read my-stream)</code></strong>
"What up, Client!"</pre><p>Here’s what your two CLISP windows should look like when you’re finished:<a id="IDX-CHP-12-0049" class="indexterm"/><a id="IDX-CHP-12-0050" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e21325"/><img src="httpatomoreillycomsourcenostarchimages780950.png.jpg" alt="image with no caption"/></div></div><p>The message we sent across the socket was a Lisp string, but because of Lisp’s elegant stream-handling capabilities, we could send almost any standard Lisp data structure in the same way, without any extra effort!</p></div><div class="sect2" title="Tidying Up After Ourselves"><div class="titlepage"><div><div><h2 class="title"><a id="tidying_up_after_ourselves"/>Tidying Up After Ourselves</h2></div></div></div><p>It’s crucial that we free up the resources we’ve created during this exercise. First, run the following command on <span class="emphasis"><em>both</em></span> the client and the server to close the stream on both ends:</p><a id="I_programlisting3_d1e21340"/><pre class="programlisting">&gt; <strong class="userinput"><code>(close my-stream)</code></strong>
T</pre><p>Next, run <code class="literal">socket-server-close</code> on the server to free up the port and disconnect the socket from it. If you don’t, port 4321 will be unusable until you reboot.<a id="IDX-CHP-12-0051" class="indexterm"/><a id="IDX-CHP-12-0052" class="indexterm"/><a id="IDX-CHP-12-0053" class="indexterm"/><a id="IDX-CHP-12-0054" class="indexterm"/><a id="IDX-CHP-12-0055" class="indexterm"/><a id="IDX-CHP-12-0056" class="indexterm"/></p><a id="I_programlisting3_d1e21370"/><pre class="programlisting">&gt; <strong class="userinput"><code>(socket-server-close my-socket)</code></strong>
NIL</pre></div></div>
<div class="sect1" title="String Streams: The Oddball Type"><div class="titlepage"><div><div><h1 class="title"><a id="string_streams_colon_the_oddball_type"/>String Streams: The Oddball Type</h1></div></div></div><p>Streams are usually used for communicating with the outside world from within a Lisp program. One exception to this is the string stream, which simply makes a string look like a stream. In the same way you can read or write to external resources with other types of streams, a string stream will let you read or write to a string.</p><p>You can create string streams with the <code class="literal">make-string-output-stream</code> and <code class="literal">make-string-input-stream</code> commands. Following is an example that uses <code class="literal">make-string-output-stream</code>:</p><a id="I_programlisting3_d1e21391"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defparameter foo (make-string-output-stream))</code></strong>
&gt; <strong class="userinput"><code>(princ "This will go into foo. " foo)</code></strong>
&gt; <strong class="userinput"><code>(princ "This will also go into foo. " foo)</code></strong>
&gt; <strong class="userinput"><code>(get-output-stream-string foo)</code></strong>
"This will go into foo. This will also go into foo. "</pre><p>You may be wondering why anyone would want to do this, since we can already directly manipulate strings in Lisp, without using streams. Actually, there are several good reasons for using string streams in this way. They are useful for debugging, as well as for creating complex strings efficiently.</p><div class="sect2" title="Sending Streams to Functions"><div class="titlepage"><div><div><h2 class="title"><a id="sending_streams_to_functions"/>Sending Streams to Functions</h2></div></div></div><p>Using string streams allows us to use functions that require streams as parameters. This is great for debugging code that works with files or sockets, using only strings for the input and output of data.</p><p>For example, suppose we have a function <code class="literal">write-to-log</code> that writes log information to a stream. Usually, we would want to send the log information to a file stream, so it can be written to a file for safekeeping. However, if we want to debug the function, we may want to send it a string stream instead, so we can take a look at the data it writes and make sure it’s correct. If we had hard-coded the <code class="literal">write-to-log</code> function to only write to a file, we wouldn’t have this flexibility. This is why it makes sense to write functions to use the abstract concept of a stream whenever possible, instead of using other methods to access external resources.</p></div><div class="sect2" title="Working with Long Strings"><div class="titlepage"><div><div><h2 class="title"><a id="working_with_long_strings"/>Working with Long Strings</h2></div></div></div><p>String streams can lead to better-performing code when dealing with very long strings. For instance, concatenating two strings together can be a costly operation—first, it requires a new block of memory to be allocated to hold both strings, and then the strings need to be copied into this new location. Because of this bottleneck, many programming languages use devices called <span class="emphasis"><em>string builders</em></span> to avoid this overhead. In Lisp, we can get similar performance benefits by using string streams.<a id="IDX-CHP-12-0057" class="indexterm"/><a id="IDX-CHP-12-0058" class="indexterm"/><a id="IDX-CHP-12-0059" class="indexterm"/><a id="IDX-CHP-12-0060" class="indexterm"/><a id="IDX-CHP-12-0061" class="indexterm"/></p></div><div class="sect2" title="Reading and Debugging"><div class="titlepage"><div><div><h2 class="title"><a id="reading_and_debugging"/>Reading and Debugging</h2></div></div></div><p>Another reason for using string streams is that they can make our code easier to read and debug, especially when we use the <code class="literal">with-output-to-string</code> macro.</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject3_d1e21456"/><img src="httpatomoreillycomsourcenostarchimages781306.png.jpg" alt="image with no caption"/></div></div><p>Here’s an example of this command being used:</p><a id="I_programlisting3_d1e21463"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt;  <strong class="userinput"><code>(with-output-to-string (*standard-output*)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>      <strong class="userinput"><code>(princ "the sum of ")</code></strong>
       <strong class="userinput"><code>(princ 5)</code></strong>
       <strong class="userinput"><code>(princ " and ")</code></strong>
       <strong class="userinput"><code>(princ 2)</code></strong>
       <strong class="userinput"><code>(princ " is ")</code></strong>
       <strong class="userinput"><code>(princ (+ 2 5)))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> "the sum of 5 and 2 is 7"</pre><p>The <code class="literal">with-output-to-string</code> macro <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e21509"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> will intercept any text that would otherwise be output to the console, REPL, or other output stream, and capture it as a string. In the preceding example, the output created by the <code class="literal">princ</code> functions <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e21518"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span> within the body of the <code class="literal">with-output-to-string</code> call is redirected automatically into a string stream. Once the body of the <code class="literal">with-output-to-string</code> command has completed, the entire printed output that was put into the stream is returned as a result <span class="inlinemediaobject"><a id="I_inlinemediaobject3_d1e21531"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.</p><p>You can also use the <code class="literal">with-output-to-string</code> macro to easily construct complex strings by “printing” each part, and then capturing the result as a string. This tends to be much more elegant and efficient than using the <code class="literal">concatenate</code> command.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Using <code class="literal">with-output-to-string</code> runs counter to the tenets of functional programming (discussed in <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>). Some Lispers consider this function (and similar functions that intercept input or output intended for other destinations) to be an ugly hack. You’ll see some disagreement in the Lisp community about whether the use of <code class="literal">with-output-to-string</code> is elegant or ugly.</p></div></div></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id12"/>What You've Learned</h1></div></div></div><p>This chapter described how to use streams to let your Lisp programs interact with outside resources. You learned the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Different types of streams interact with different types of resources. These include <span class="emphasis"><em>console streams</em></span>, <span class="emphasis"><em>file streams</em></span>, <span class="emphasis"><em>socket streams</em></span>, and <span class="emphasis"><em>string streams</em></span>.</p></li><li class="listitem"><p>Streams can be categorized based on their direction. <span class="emphasis"><em>Output streams</em></span> let us write to a resource. <span class="emphasis"><em>Input streams</em></span> let us read from a resource.</p></li><li class="listitem"><p>Socket streams allow computer programs to communicate over a network. To establish a socket stream, we must first open sockets on both ends and open a socket connection between the programs.</p></li><li class="listitem"><p>String streams allow us to use functions that require streams without linking to an outside resource, for debugging purposes. They also are useful for constructing complex strings efficiently and elegantly through the use of <code class="literal">with-output-to-string</code>.</p></li></ul></div></div>
<div class="chapter" title="Chapter&#xA0;13.&#xA0;Let's Create a Web Server!"><div class="titlepage"><div><div><h1 class="title"><a id="let_apostrophy_s_create_a_web_server_exc"/>Chapter 13. Let's Create a Web Server!</h1></div></div></div><p>In <a class="xref" href="ch06.html" title="Chapter 6. Interacting with the World: Reading and Printing in Lisp">Chapter 6</a>, you learned how to interact with a user by sending text to and from the REPL. However, when people talk about “interacting with a user” these days, they’re usually referring to a user on the Web. In this chapter, you’re going to learn how to interact with users on the Web by building a web server from scratch. Since communications over a network are error prone by their nature, you’ll first learn how errors are handled in Lisp.<a id="IDX-CHP-13-0001" class="indexterm"/></p><div class="sect1" title="Error Handling in Common Lisp"><div class="titlepage"><div><div><h1 class="title"><a id="error_handling_in_common_lisp"/>Error Handling in Common Lisp</h1></div></div></div><p>Any time you’re interacting with the outside world, as our web server will, unexpected things can happen. No matter how smart a modern computer network may be, it can never anticipate every possible exceptional situation. After all, even the smartest network can’t recover from some fool tripping over the wrong cable.</p><p>Common Lisp has a very extensive set of features for dealing with unexpected exceptional situations in your code. This exception handling system is very flexible, and it can be used to do things that are impossible with exception systems in most other languages.<a id="IDX-CHP-13-0002" class="indexterm"/><a id="IDX-CHP-13-0003" class="indexterm"/><a id="IDX-CHP-13-0004" class="indexterm"/><a id="IDX-CHP-13-0005" class="indexterm"/><a id="IDX-CHP-13-0006" class="indexterm"/><a id="IDX-CHP-13-0007" class="indexterm"/></p><div class="sect2" title="Signaling a Condition"><div class="titlepage"><div><div><h2 class="title"><a id="signaling_a_condition"/>Signaling a Condition</h2></div></div></div><p>If you’re writing a function and something goes horribly wrong, a Lisp function can notify the Lisp environment that a problem has been encountered. This is done by <span class="emphasis"><em>signaling a condition</em></span>. What sort of things could go wrong? Maybe a function tried to divide by zero. Or maybe a library function received a parameter of the wrong type. Or maybe a socket communication was interrupted because you tripped over your network cable.</p><p>If you want to signal a condition directly, you can do so with the <code class="literal">error</code> command. You would do this if a function you wrote detected a problem on its own—a problem so serious the program just could not continue normally. Using the <code class="literal">error</code> command will interrupt your running Lisp program, unless you intercept the error elsewhere to prevent an interruption. Let’s signal a condition and print the message “foo” to describe the error:</p><a id="I_programlisting4_d1e21650"/><pre class="programlisting">&gt; <strong class="userinput"><code>(error "foo")</code></strong>

*** - foo
The following restarts are available:
ABORT          :R1      Abort main loop
&gt;</pre><p>As you can see, signaling this condition causes Lisp to interrupt our program, print the message “foo,” and show an error prompt at the REPL. (In CLISP, you can type <strong class="userinput"><code>:a</code></strong> at this point to abort the program and return to the normal REPL.)</p><p>Most of the time your program signals a condition, it will probably not be because you called <code class="literal">error</code> yourself. Instead, it will be because your program has a bug, or because you called a library function, and that function signals a condition. However, any time something prevents normal execution in your program, leading to a condition, your program will stop and show an error prompt such as in the preceding example.</p></div><div class="sect2" title="Creating Custom Conditions"><div class="titlepage"><div><div><h2 class="title"><a id="creating_custom_conditions"/>Creating Custom Conditions</h2></div></div></div><p>In our first example, we passed a string describing the condition to the <code class="literal">error</code> command. However, this text string just customizes the error message and doesn’t lead to a different “type” of condition. Common Lisp also allows you to have various types of conditions that can be handled in different ways.</p><p>A more sophisticated way to signal conditions is to first define a custom condition using <code class="literal">define-condition</code>, as in the following example:</p><a id="I_programlisting4_d1e21678"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (define-condition foo () ()
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>    (:report (lambda (condition stream)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>                (princ "Stop FOOing around, numbskull!" stream))))</pre><p>This is a typical example of creating a new type of condition, which we’ve named <code class="literal">foo</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e21702"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. When this condition is signaled, we can supply a custom function that will be called to report the error. Here, we declare a lambda function for this purpose <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e21708"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Within the lambda function, we print a custom message to report the error <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e21714"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.<a id="IDX-CHP-13-0008" class="indexterm"/><a id="IDX-CHP-13-0009" class="indexterm"/><a id="IDX-CHP-13-0010" class="indexterm"/></p><p>Let’s see what happens when we trigger this new condition:</p><a id="I_programlisting4_d1e21736"/><pre class="programlisting">&gt; <strong class="userinput"><code>(error 'foo)</code></strong>

*** - Stop FOOing around, numbskull!
The following restarts are available:
ABORT          :R1      Abort main loop
&gt;</pre><p>As you can see, our custom message was printed. This technique allows the programmer to get a more meaningful error report, customized for the specific condition that was triggered.</p></div><div class="sect2" title="Intercepting Conditions"><div class="titlepage"><div><div><h2 class="title"><a id="intercepting_conditions"/>Intercepting Conditions</h2></div></div></div><p>When we create a condition with <code class="literal">define-condition</code>, it’s given a name (such as <code class="literal">foo</code>). This name can be used by the higher-level parts of our program to intercept and handle that condition, so it won’t stop the program’s execution. We can do this with the <code class="literal">handler-case</code> command, as follows:</p><a id="I_programlisting4_d1e21757"/><pre class="programlisting">&gt; <strong class="userinput"><code>(defun bad-function ()</code></strong>
       <strong class="userinput"><code>(error 'foo))</code></strong>
  BAD-FUNCTION
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(handler-case (bad-function)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>      <strong class="userinput"><code>(foo () "somebody signaled foo!")</code></strong>
       <strong class="userinput"><code>(bar () "somebody signaled bar!"))</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> "somebody signaled foo!"</pre><p>The first thing we put inside a <code class="literal">handler-case</code> command is the piece of code that may signal conditions that we want to handle <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e21798"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>.</p><p>In this example, the code we’re watching is a call to <code class="literal">bad-function</code>. The rest of <code class="literal">handler-case</code> lets us specify actions to perform if a particular condition occurs <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e21812"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. When this code is run, <code class="literal">bad-function</code> signals the <code class="literal">foo</code> condition by calling <code class="literal">(error 'foo)</code>. Usually, this would cause our program to be interrupted and lead to a error prompt at the REPL. However, our <code class="literal">handler-case</code> command intercepts the <code class="literal">foo</code> condition <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e21834"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. This means that the program can keep running without interruption, with the <code class="literal">handler-case</code> evaluating as “somebody signaled foo!” <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e21843"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.</p></div><div class="sect2" title="Protecting Resources Against Unexpected Conditions"><div class="titlepage"><div><div><h2 class="title"><a id="protecting_resources_against_unexpected"/>Protecting Resources Against Unexpected Conditions</h2></div></div></div><p>When an unexpected exception happens in a program, there is always a risk that it could bring down your program, or even cause damage to resources outside your program. Exceptions interrupt the regular flow of your code, and they may stop your code dead in its tracks, even while it’s in the middle of a sensitive operation.<a id="IDX-CHP-13-0011" class="indexterm"/><a id="IDX-CHP-13-0012" class="indexterm"/><a id="IDX-CHP-13-0013" class="indexterm"/><a id="IDX-CHP-13-0014" class="indexterm"/></p><p>For instance, your program may be writing to a file or to a socket stream when an unexpected exception happens. In this case, it is critically important that your program has an opportunity to close the file/socket stream and free the file handle or socket; otherwise, that resource may become locked indefinitely. If such resources aren’t cleaned up properly, the users may need to reboot their computer first before the resource becomes available again.</p><p>The <code class="literal">unwind-protect</code> command can help us to avoid these problems. With this command, we can tell the Lisp compiler, “This piece of code must run no matter what happens.” Consider the following example:</p><a id="I_programlisting4_d1e21875"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(unwind-protect (/ 1 0)</code></strong>
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>                   <strong class="userinput"><code>(princ "I need to say 'flubyduby' matter what"))</code></strong>

  *** - /: division by zero
  The following restarts are available:
  ABORT          :R1      Abort main loop
  &gt; <strong class="userinput"><code>:r1</code></strong>
  I need to say 'flubyduby' matter what
  &gt;</pre><p>Within the <code class="literal">unwind-protect</code>, we divide by 0, which signals a condition <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e21902"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. But even after we tell CLISP to abort, the program still prints its crucial message <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e21908"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>.</p><p>We can usually avoid calling <code class="literal">unwind-protect</code> directly by relying on Common Lisp’s “<code class="literal">with-</code>” macros; many of these call <code class="literal">unwind-protect</code> themselves, under the hood. In <a class="xref" href="ch18.html" title="Chapter 16. The Magic of Lisp Macros">Chapter 16</a>, we’ll create our own macros to see how this is possible.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>In the comic book epilogue at the end of the book, you’ll learn about an additional feature of the Common Lisp signaling system called <span class="emphasis"><em>restarts</em></span>.</p></div></div></div></div>
<div class="sect1" title="Writing a Web Server from Scratch"><div class="titlepage"><div><div><h1 class="title"><a id="writing_a_web_server_from_scratch"/>Writing a Web Server from Scratch</h1></div></div></div><p>Now that you have a basic understanding of sockets (covered in <a class="xref" href="ch13.html" title="Chapter 12. Working with Streams">Chapter 12</a>) and error handling, you know enough to make a web server that can serve dynamic web pages written in Lisp. After all, why should Apache (the world’s most popular web server) have all the fun?<a id="IDX-CHP-13-0015" class="indexterm"/></p><div class="sect2" title="How a Web Server Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_a_web_server_works"/>How a Web Server Works</h2></div></div></div><p>Hypertext Transfer Protocol, or HTTP, is the Internet protocol used for transferring web pages. It adds a layer on top of TCP/IP for requesting pages once a socket connection has been established. When a program running on a client computer (usually a web browser) sends a properly encoded request, the server will retrieve the requested page and send it over the socket stream in response.<a id="IDX-CHP-13-0016" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject4_d1e21952"/><img src="httpatomoreillycomsourcenostarchimages781432.png.jpg" alt="image with no caption"/></div></div><div class="note" title="Note"><h3 class="title">Note</h3><p>This web server is adapted from <span class="emphasis"><em>http.lisp</em></span>, created by Ron Garret.<a id="IDX-CHP-13-0017" class="indexterm"/><a id="IDX-CHP-13-0018" class="indexterm"/><a id="IDX-CHP-13-0019" class="indexterm"/></p></div><p>For example, suppose the client is the Firefox web browser, and it asks for the page <span class="emphasis"><em>lolcats.html</em></span>. The client’s request might look like this:</p><a id="I_programlisting4_d1e21977"/><pre class="programlisting">GET /lolcats.html HTTP/1.1
Host: localhost:8080
User-Agent: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.5)
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Keep-Alive: 300
Connection: keep-alive</pre><p>For our web server, the most important part of this request is the first line. There we can see the type of request made (a <code class="literal">GET</code> request, which means we just want to look at a page without modifying it), and the name of the page requested (<span class="emphasis"><em>lolcats.html</em></span>). This data sent to the server is called the <span class="emphasis"><em>request header</em></span>. You’ll see later that additional information can be sent to the server below the request header, in a <span class="emphasis"><em>request body</em></span>.<a id="IDX-CHP-13-0020" class="indexterm"/><a id="IDX-CHP-13-0021" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>To readers from the distant future, <span class="emphasis"><em>lolcats</em></span> was a viral Internet phenomenon from early in the third millennium. It involved pictures of cats with funny captions. If people of your time are no longer familiar with lolcats, it is of no great loss.</p></div><p>In response, the server will send an HTML document that represents the web page over the socket stream. This is called the <span class="emphasis"><em>response body</em></span>. Here is what a response body might look like:<a id="IDX-CHP-13-0022" class="indexterm"/><a id="IDX-CHP-13-0023" class="indexterm"/><a id="IDX-CHP-13-0024" class="indexterm"/><a id="IDX-CHP-13-0025" class="indexterm"/><a id="IDX-CHP-13-0026" class="indexterm"/></p><a id="I_programlisting4_d1e22029"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &lt;html&gt;
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>    &lt;body&gt;
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>       Sorry dudez, I don't have any L0LZ for you today :-(
     &lt;/body&gt;
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/> &lt;/html&gt;</pre><p>An HTML document is wrapped in <code class="literal">html</code> opening <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22059"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> and closing tags <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22065"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. Within these tags, you can declare a body section <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22071"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. In the body section, you can write a text message that will be displayed in the web browser as the body of the web page<span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22077"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>.</p><p>For a fully HTML-compliant web page, other items must exist in the document, such as a DOCTYPE declaration. However, our example will work just fine, and we can ignore these technical details for our simple demonstration.<a id="IDX-CHP-13-0027" class="indexterm"/></p><p>A web server will typically also generate a <span class="emphasis"><em>response header</em></span>. This header can give a web browser additional information about the document it has just received, such as whether it is in HTML or another format. However, the simplified web server we’re going to create does not generate such a header and instead simply returns a body.<a id="IDX-CHP-13-0028" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>Since we’re using CLISP-specific socket commands, you must be running CLISP for the sample web server presented in this chapter to work.</p></div></div><div class="sect2" title="Request Parameters"><div class="titlepage"><div><div><h2 class="title"><a id="request_parameters"/>Request Parameters</h2></div></div></div><p>Web forms are an essential element in powering websites. For instance, suppose we create a simple login form for a website.<a id="IDX-CHP-13-0029" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject4_d1e22109"/><img src="httpatomoreillycomsourcenostarchimages781624.png" alt="image with no caption"/></div></div><p>After the visitor to our website hits the Submit button on this page, it will send a <code class="literal">POST</code> request back to the website. A <code class="literal">POST</code> request looks very similar to the <code class="literal">GET</code> request in the preceding example. However, a <code class="literal">POST</code> request usually carries the expectation that it may alter data on the server.</p><p>In our sample login form, we need to tell the server the user ID and password that the visitor to our site had entered into the text fields on this form. The values of these fields that are sent to the server as part of the <code class="literal">POST</code> request are called <span class="emphasis"><em>request parameters</em></span>. They are sent within the <code class="literal">POST</code> request by appending them below the request header, in the area that makes up the request body.</p><p>This is what the <code class="literal">POST</code> request might look like for our login example:</p><a id="I_programlisting4_d1e22144"/><pre class="programlisting">POST /login.html HTTP/1.1
  Host: www.mywebsite.com
  User-Agent: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.5)
  Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
  Accept-Language: en-us,en;q=0.5
  Accept-Encoding: gzip,deflate
  Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
  Keep-Alive: 300
  Connection: keep-alive
  <strong class="userinput"><code>Content-Length: 39</code></strong>

<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/><strong class="userinput"><code> userid=foo&amp;password=supersecretpassword</code></strong></pre><p>The extra parameter in the header of this <code class="literal">POST</code> request, <code class="literal">Content-Length</code>, indicates the length of the parameter data at the bottom of the request. Specifically, <code class="literal">Content-Length: 39</code> tells the server that the text containing the request parameters <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22167"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> is 39 characters long.<a id="IDX-CHP-13-0030" class="indexterm"/><a id="IDX-CHP-13-0031" class="indexterm"/><a id="IDX-CHP-13-0032" class="indexterm"/></p><div class="sect3" title="Request Parameters for GET Requests"><div class="titlepage"><div><div><h3 class="title"><a id="request_parameters_for_get_requests"/>Request Parameters for GET Requests</h3></div></div></div><p>As we’ve discussed, the typical purpose of request parameters is to send web form data back to the server during a <code class="literal">POST</code> request. However, <code class="literal">GET</code> requests may also contain request parameters. Usually, with a <code class="literal">GET</code> request, we want to see what the parameters are in the URL of the request, whereas with a <code class="literal">POST</code> request, the parameters are hidden in the body of the request.</p><p>For instance, suppose you go to Google and search for “dogs.” In this case, the follow-up page will have a URL that reads something like <a class="ulink" href="http://www.google.com/search?q=dogs&amp;hl=en&amp;safe=off&amp;">http://www.google.com/search?q=dogs&amp;hl=en&amp;safe=off&amp;</a>.... These values in the URL (such as the one stating that the [q]uery=“dogs”) are also request parameters.</p><p>The web server we’re creating will need to give the server code access to both types of request parameters: the ones in the body of the request (as is common with <code class="literal">POST</code> requests) as well as the ones that appear in the URL (as is common with <code class="literal">GET</code> requests.)</p></div><div class="sect3" title="Decoding the Values of Request Parameters"><div class="titlepage"><div><div><h3 class="title"><a id="decoding_the_values_of_request_parameter"/>Decoding the Values of Request Parameters</h3></div></div></div><p>HTTP has a special way to represent the nonalphanumeric characters that a user might enter into a form, using <span class="emphasis"><em>HTTP escape codes</em></span>. These escape codes let you have characters in the values of a request parameter that would not otherwise be available in the HTTP format. For instance, if a user enters <strong class="userinput"><code>"foo?"</code></strong>, it will appear in the request as <code class="literal">"foo%3F"</code>, since the question mark is represented with an escape code. Our web server will need to decode these escape characters, so the first function we’ll write is <code class="literal">decode-param</code>:<a id="IDX-CHP-13-0033" class="indexterm"/></p><a id="I_programlisting4_d1e22236"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (defun http-char (c1 c2 &amp;optional (default #\Space))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (let ((code (parse-integer
                 (coerce (list c1 c2) 'string)
                 :radix 16
                 :junk-allowed t)))
      (if code
          (code-char code)
        default)))

  (defun decode-param (s)
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>    (labels ((f (lst)
                 (when lst
                   (case (car lst)
                       (#\% (cons (http-char (cadr lst) (caddr lst))
                                  (f (cdddr lst))))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>                      (#\+ (cons #\space (f (cdr lst))))
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>                      (otherwise (cons (car lst) (f (cdr lst))))))))
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>        (coerce (f (coerce s 'list)) 'string)))</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>The HTTP escape codes we are discussing here are unrelated to the escape characters in Lisp strings we’ve discussed in other parts of this book.<a id="IDX-CHP-13-0034" class="indexterm"/><a id="IDX-CHP-13-0035" class="indexterm"/><a id="IDX-CHP-13-0036" class="indexterm"/><a id="IDX-CHP-13-0037" class="indexterm"/><a id="IDX-CHP-13-0038" class="indexterm"/><a id="IDX-CHP-13-0039" class="indexterm"/><a id="IDX-CHP-13-0040" class="indexterm"/><a id="IDX-CHP-13-0041" class="indexterm"/><a id="IDX-CHP-13-0042" class="indexterm"/><a id="IDX-CHP-13-0043" class="indexterm"/><a id="IDX-CHP-13-0044" class="indexterm"/></p></div><p>First, this function defines a local function named <code class="literal">f</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22317"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, which we’ll use to recursively process the characters. To make this recursion work, we need to use <code class="literal">coerce</code> to turn the string into a list of characters <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22326"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>, and then pass this list to <code class="literal">f</code>.</p><p>The <code class="literal">f</code> function checks the first character in the list to see if it’s a percent sign (<code class="literal">%</code>) or a plus sign (<code class="literal">+</code>). If it’s a percent sign, we know that the next value in the list is an ASCII code, represented as a hexadecimal number. (ASCII codes are a standard set of numbers that correspond to text characters, shared among many computer systems and applications.)<a id="IDX-CHP-13-0045" class="indexterm"/></p><p>To decode this ASCII code, we’ve created a function named <code class="literal">http-char</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22354"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. In this function, we use the <code class="literal">parse-integer</code> function to convert this string to an integer <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22363"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. In this case, we’re using some keyword parameters on <code class="literal">parse-integer:</code> the <code class="literal">:radix</code> parameter, which tells the function to parse a hexadecimal number, and the <code class="literal">:junk-allowed</code> parameter, which tells it to just return nil when an invalid number is given, rather than signaling an error.</p><p>We then use the <code class="literal">code-char</code> function to convert this integer (which holds an ASCII code) into the actual character that the user entered.</p><p>As per the rules of HTTP encoding, if a value in a request parameter contains a plus sign, it should be translated into a space character. We make this conversion here <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22386"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p><p>Any other character passes through the <code class="literal">f</code> function unchanged. However, we still need to call <code class="literal">f</code> on the remainder of the list until all the characters have been processed <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22400"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>.</p><p>Here are some examples of <code class="literal">decode-param</code> in action:</p><a id="I_programlisting4_d1e22412"/><pre class="programlisting">&gt; <strong class="userinput"><code>(decode-param "foo")</code></strong>
"foo"
&gt; <strong class="userinput"><code>(decode-param "foo%3F")</code></strong>
"foo?"
&gt; <strong class="userinput"><code>(decode-param "foo+bar")</code></strong>
"foo bar"</pre></div><div class="sect3" title="Decoding Lists of Request Parameters"><div class="titlepage"><div><div><h3 class="title"><a id="decoding_lists_of_request_parameters"/>Decoding Lists of Request Parameters</h3></div></div></div><p>The next thing our server needs to do is to decode a list of parameters, which will be given as name/value pairs in a string such as <code class="literal">"name=bob&amp;age=25&amp;gender=male"</code>. As we’ve discussed, URLs for web pages often contain such name/value pairs at the end. As you can see, this string says that the person we’re looking for on the web page has a name of bob, an age of 25, and a gender of male. These name/value pairs are separated by an ampersand (<code class="literal">&amp;</code>). The structure of these strings is equivalent to that of an association list (alist), so we’ll store these parameters as an alist using the following function:<a id="IDX-CHP-13-0046" class="indexterm"/><a id="IDX-CHP-13-0047" class="indexterm"/><a id="IDX-CHP-13-0048" class="indexterm"/><a id="IDX-CHP-13-0049" class="indexterm"/><a id="IDX-CHP-13-0050" class="indexterm"/><a id="IDX-CHP-13-0051" class="indexterm"/></p><a id="I_programlisting4_d1e22458"/><pre class="programlisting">(defun parse-params (s)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let* ((i1 (position #\= s))
            (i2 (position #\&amp; s)))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>       (cond (i1 (cons (cons (intern (string-upcase (subseq s 0 i1)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>                             (decode-param (subseq s (1+ i1) i2)))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>                       (and i2 (parse-params (subseq s (1+ i2))))))
              ((equal s "") nil)
              (t s))))</pre><p>The <code class="literal">parse-params</code> function finds the first occurrence of an ampersand (<code class="literal">&amp;</code>) and equal sign (=) in the string, using the <code class="literal">position</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22495"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. If a name/value pair is found (we know this is true if an equal sign was found in the string and is stored in <code class="literal">i1</code>), we use the <code class="literal">intern</code> function to convert the name into a Lisp symbol <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22508"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. We <code class="literal">cons</code> this name to the value of the parameter, which we decode with our <code class="literal">decode-param</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22520"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. Finally, we recursively call <code class="literal">parse-params</code> on the remainder of the string <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22530"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p><p>Let’s give our new <code class="literal">parse-params</code> function a try:</p><a id="I_programlisting4_d1e22541"/><pre class="programlisting">&gt; <strong class="userinput"><code>(parse-params "name=bob&amp;age=25&amp;gender=male")</code></strong>
((NAME . "bob") (AGE . "25") (GENDER . "male"))</pre><p>Putting this data into an alist will allow our code to easily reference a specific variable whenever that’s necessary.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Both <code class="literal">decode-param</code> and <code class="literal">parse-params</code> could achieve higher performance if they were written using a tail call, as we’ll discuss in <a class="xref" href="ch16.html" title="Chapter 14. Ramping Lisp Up a Notch with Functional Programming">Chapter 14</a>.</p></div></div></div><div class="sect2" title="Parsing the Request Header"><div class="titlepage"><div><div><h2 class="title"><a id="parsing_the_request_header"/>Parsing the Request Header</h2></div></div></div><p>Next, we’ll write a function to process the first line of the request header. (This is the line that will look something like <code class="literal">GET /lolcats.html HTTP/1.1</code>).</p><p>The following <code class="literal">parse-url</code> function will process these strings:</p><a id="I_programlisting4_d1e22572"/><pre class="programlisting">(defun parse-url (s)
    (let* ((url (subseq s
                      (+ 2 (position #\space s))
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>                       (position #\space s :from-end t)))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>          (x (position #\? url)))
       (if x
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>          (cons (subseq url 0 x) (parse-params (subseq url (1+ x))))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>          (cons url '()))))</pre><p>This function first uses the string’s delimiting spaces to find and extract the URL <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22600"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. It then checks this URL for a question mark, which may indicate that there are request parameters that need to be handled <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22606"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. For instance, if the URL is <span class="emphasis"><em>lolcats.html?extra-funny=yes</em></span>, then the question mark lets us know that there is a parameter named <span class="emphasis"><em>extra-funny</em></span> in the URL. If such parameters exist, we’ll need to extract them, and then parse them using our <code class="literal">parse-params</code> function <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22622"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. If there aren’t any request parameters, we just return the URL <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22628"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. Note that this function skips over the request method (most often <code class="literal">GET</code> or <code class="literal">POST</code>). A fancier web server would extract this data point as well.<a id="IDX-CHP-13-0052" class="indexterm"/><a id="IDX-CHP-13-0053" class="indexterm"/><a id="IDX-CHP-13-0054" class="indexterm"/><a id="IDX-CHP-13-0055" class="indexterm"/><a id="IDX-CHP-13-0056" class="indexterm"/><a id="IDX-CHP-13-0057" class="indexterm"/><a id="IDX-CHP-13-0058" class="indexterm"/></p><p>Let’s try out our new URL extractor:</p><a id="I_programlisting4_d1e22672"/><pre class="programlisting">&gt; <strong class="userinput"><code>(parse-url "GET /lolcats.html HTTP/1.1")</code></strong>
("lolcats.html")
&gt; <strong class="userinput"><code>(parse-url "GET /lolcats.html?extra-funny=yes HTTP/1.1")</code></strong>
("lolcats.html" (EXTRA-FUNNY . "yes"))</pre><p>Now that we can read the first line, we’ll process the rest of the request. The following <code class="literal">get-header</code> function will convert the remaining lines of the request into a nice alist:</p><a id="I_programlisting4_d1e22685"/><pre class="programlisting">(defun get-header (stream)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (let* ((s (read-line stream))
           (h (let ((i (position #\: s)))
                 (when i
                       (cons (intern (string-upcase (subseq s 0 i)))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>                            (subseq s (+ i 2)))))))
       (when h
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>         (cons h (get-header stream)))))</pre><p>This function reads in a line from the stream <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22707"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, converts it to a key/value pair based on the location of a colon <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22713"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>, and then recurses to convert additional lines in the header <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22719"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. If it encounters a line that doesn’t conform to a header line, it means we’ve reached the blank line at the end of the header and are finished. In this case, both <code class="literal">i</code> and <code class="literal">h</code> will be <code class="literal">nil</code>, and the function terminates.</p><p>The <code class="literal">intern</code> command used when generating the key above is a simple function that converts a string into a symbol. We could, instead, have used the <code class="literal">read</code> command for this purpose, as we have previously in this book. But remember that the flexibility of the <code class="literal">read</code> command also makes it a great target for hackers, who might try creating malformed headers to crack your web server. That’s why it’s wise to use the more limited, specific <code class="literal">intern</code> function to process this data sent over the Internet to our web server.</p></div><div class="sect2" title="Testing get-header with a String Stream"><div class="titlepage"><div><div><h2 class="title"><a id="testing_get-header_with_a_string_stream"/>Testing get-header with a String Stream</h2></div></div></div><p>Since the <code class="literal">get-header</code> function pulls its data directly from a socket stream, you might think we can’t test it directly through the REPL. However, as you saw in the previous chapter, there are actually several different types of resources besides sockets that can be accessed through the stream interface in Common Lisp. Because of the common interface among streams, we can test our <code class="literal">get-header</code> function by passing it a string stream instead of a socket stream:</p><a id="I_programlisting4_d1e22760"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> &gt; <strong class="userinput"><code>(get-header (make-string-input-stream "foo: 1</code></strong>
  <strong class="userinput"><code>bar: abc, 123</code></strong>

<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/><strong class="userinput"><code> "))</code></strong>
  ((FOO . "1") (BAR . "abc, 123"))</pre><p>Using the <code class="literal">make-string-input-stream</code> function, we can create an input stream from a literal string. In this example, we’re taking a string defining two keys (<code class="literal">foo</code> and <code class="literal">bar</code>) and ending it with an empty line, just like a typical HTTP header. Note that we have a single literal string from <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22792"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span> to <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22798"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. Such strings are permitted in Common Lisp. As you can see, the <code class="literal">get-header</code> function appropriately pulled the two keys and their values out of this stream, in the same way it would pull these values out of a socket stream.<a id="IDX-CHP-13-0059" class="indexterm"/><a id="IDX-CHP-13-0060" class="indexterm"/><a id="IDX-CHP-13-0061" class="indexterm"/><a id="IDX-CHP-13-0062" class="indexterm"/><a id="IDX-CHP-13-0063" class="indexterm"/><a id="IDX-CHP-13-0064" class="indexterm"/></p><p>Using this trick, you can test functions that manipulate streams directly from the REPL. To do this, simply substitute string streams for other, more complicated stream types.</p></div><div class="sect2" title="Parsing the Request Body"><div class="titlepage"><div><div><h2 class="title"><a id="parsing_the_request_body"/>Parsing the Request Body</h2></div></div></div><p>In a POST request, there will usually be parameters stored beneath the header, in an area known as the <span class="emphasis"><em>request body</em></span> or <span class="emphasis"><em>request content</em></span>. The following <code class="literal">get-content-params</code> function extracts these parameters:</p><a id="I_programlisting4_d1e22848"/><pre class="programlisting">(defun get-content-params (stream header)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>        (let ((length (cdr (assoc 'content-length header))))
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>          (when length
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>            (let ((content (make-string (parse-integer length))))
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>               (read-sequence content stream)
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>               (parse-params content)))))</pre><p>First, this function searches the header for a value called <code class="literal">content-length</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22885"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, which tells us the length of the string that contains these content parameters. If <code class="literal">content-length</code> exists, then we know there are parameters to parse <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22894"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. The function will then create a string with the given length using <code class="literal">make-string</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22904"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, and use <code class="literal">read-sequence</code> to fill that string with characters from the stream <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22913"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. It then runs the result through our <code class="literal">parse-params</code> function to translate the parameters into our cleaned-up alist format <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22922"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>.</p></div><div class="sect2" title="Our Grand Finale: The serve Function!"><div class="titlepage"><div><div><h2 class="title"><a id="our_grand_finale_colon_the_serve_functio"/>Our Grand Finale: The serve Function!</h2></div></div></div><p>Now all the pieces are in place to write the heart of our web server: the <code class="literal">serve</code> function. Here it is in all its glory:</p><a id="I_programlisting4_d1e22936"/><pre class="programlisting"><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/> (defun serve (request-handler)
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>   (let ((socket (socket-server 8080)))
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/>     (unwind-protect
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>        (loop (with-open-stream (stream (socket-accept socket))
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>                  (let* ((url    (parse-url (read-line stream)))
                          (path   (car url))
                          (header (get-header stream))
                          (params (append (cdr url)
                                          (get-content-params stream header)))
                          (*standard-output* stream))
<img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/>                            (funcall request-handler path header params))))
         (socket-server-close socket))))</pre><p>The <code class="literal">serve</code> function takes a single parameter: <code class="literal">request-handler</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e22981"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>, which is supplied by the creator of a website that wants to use this web server. When the server receives a request over the network, it parses the request into clean Lisp data structures (using the functions we’ve discussed throughout this chapter), and then passes this request information to <code class="literal">request-handler</code>. The <code class="literal">request-handler</code> then displays the correct HTML.<a id="IDX-CHP-13-0065" class="indexterm"/><a id="IDX-CHP-13-0066" class="indexterm"/><a id="IDX-CHP-13-0067" class="indexterm"/><a id="IDX-CHP-13-0068" class="indexterm"/><a id="IDX-CHP-13-0069" class="indexterm"/></p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject4_d1e23010"/><img src="httpatomoreillycomsourcenostarchimages783506.png" alt="image with no caption"/></div></div><p>Let’s look at our <code class="literal">serve</code> function in detail to see how it accomplishes this.</p><p>First, <code class="literal">serve</code> creates a socket bound to port 8080 <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e23025"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. This is one of several ports that is commonly used for serving web pages, especially when a site is still under development. (Port 80 is usually used for a production website/web server.) We then call <code class="literal">unwind-protect</code> <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e23034"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>, which ensures that no matter what happens as the server runs, <code class="literal">socket-server-close</code> will be called at some point to free the socket.<a id="IDX-CHP-13-0070" class="indexterm"/><a id="IDX-CHP-13-0071" class="indexterm"/></p><p>Next, we start the main web-serving loop. Within this loop, we open a stream for any client that accesses our server <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e23052"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>. We then use the <code class="literal">with-open-stream</code> macro to guarantee that, no matter what, that stream will be properly closed. Now we’re ready to read and parse the website request that the client has made to our server, using all of the reading and parsing functions we created <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e23061"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>.</p><p>Finally, we call the <code class="literal">request-handler</code> function, passing in the request details <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e23072"/><img src="httpatomoreillycomsourcenostarchimages783544.png" alt=""/></span>. Note how we redefine the <code class="literal">*standard-output*</code> dynamic variable beforehand. This means that the request handler can just write to standard output, and all the printed data will be redirected to the client stream automatically. As you learned in <a class="xref" href="ch13.html" title="Chapter 12. Working with Streams">Chapter 12</a>, capturing data from standard output allows us to minimize string concatenation. Also, it will make our <code class="literal">request-handler</code> function easier to debug, as you’ll see shortly.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>One thing we did not do with our web server is prevent the web server from crashing if the <code class="literal">request-handler</code> triggers an exception. Instead, we simply guarantee that no resources are mangled in the case of an exception. We could easily add extra exception handling to keep the server ticking even if horrible exceptions occur. However, since our goal is to learn Lisp and develop games in a browser, it’s better for us to know right away about any exceptions, even if that brings down our server.<a id="IDX-CHP-13-0072" class="indexterm"/><a id="IDX-CHP-13-0073" class="indexterm"/><a id="IDX-CHP-13-0074" class="indexterm"/><a id="IDX-CHP-13-0075" class="indexterm"/><a id="IDX-CHP-13-0076" class="indexterm"/><a id="IDX-CHP-13-0077" class="indexterm"/><a id="IDX-CHP-13-0078" class="indexterm"/><a id="IDX-CHP-13-0079" class="indexterm"/></p></div></div></div>
<div class="sect1" title="Building a Dynamic Website"><div class="titlepage"><div><div><h1 class="title"><a id="building_a_dynamic_website"/>Building a Dynamic Website</h1></div></div></div><p>To try out our shiny new web server, let’s build a simple site that greets a visitor, using the dirt-simple function <code class="literal">hello-request-handler</code>:</p><a id="I_programlisting4_d1e23132"/><pre class="programlisting">(defun hello-request-handler (path header params)
<img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/>   (if (equal path "greeting")
<img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/>       (let ((name (assoc 'name params)))
          (if (not name)
              (princ "&lt;html&gt;&lt;form&gt;What is your name?&lt;input name='name' /&gt;
<img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/> &lt;/form&gt;&lt;/html&gt;")
<img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/>             (format t "&lt;html&gt;Nice to meet you, ˜a!&lt;/html&gt;" (cdr name))))
<img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/>       (princ "Sorry... I don't know that page.")))</pre><p>This <code class="literal">hello-request-handler</code> function supports only a single web page, called <code class="literal">greeting</code>. The first step in serving up this <code class="literal">greeting</code> page is to see if this page is indeed what the client requested <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e23175"/><img src="httpatomoreillycomsourcenostarchimages783564.png" alt=""/></span>. If not, we print an apology to the user for not finding the specified page <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e23181"/><img src="httpatomoreillycomsourcenostarchimages783510.png" alt=""/></span>. Otherwise, we check the request parameters to see if we know the user’s name<span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e23188"/><img src="httpatomoreillycomsourcenostarchimages783562.png" alt=""/></span>. If not, we ask the user to enter a username using a web form <span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e23194"/><img src="httpatomoreillycomsourcenostarchimages783560.png" alt=""/></span>. If we <span class="emphasis"><em>do</em></span> know the user’s name, we greet the visitor enthusiastically<span class="inlinemediaobject"><a id="I_inlinemediaobject4_d1e23203"/><img src="httpatomoreillycomsourcenostarchimages783554.png" alt=""/></span>.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>We’re taking a ton of shortcuts with our web server and this primitive website. For instance, any HTML sent to a client should be wrapped in a proper HTML skeleton, such as <code class="literal">&lt;html&gt;&lt;body&gt;...&lt;/body&gt;&lt;/html&gt;</code>. However, even then our page wouldn’t be fully compliant with modern HTML standards. In addition, when a client requests a nonexistent page, the appropriate response is to display a 404 error page, not just print a polite apology. Luckily, web browsers are very forgiving about such shortcuts, and they will display our simplified responses anyway.<a id="IDX-CHP-13-0080" class="indexterm"/></p></div><div class="sect2" title="Testing the Request Handler"><div class="titlepage"><div><div><h2 class="title"><a id="testing_the_request_handler"/>Testing the Request Handler</h2></div></div></div><p>Before we launch our new website, let’s test our <code class="literal">hello-request-handler</code> in the REPL by first viewing a page about lolcats:</p><a id="I_programlisting4_d1e23226"/><pre class="programlisting">&gt; <strong class="userinput"><code>(hello-request-handler "lolcats" '() '())</code></strong>
Sorry... I don't know that page.</pre><p>Perfect. As you can see, when we ask our request handler for a page other than the <code class="literal">greeting</code> page, it just prints an apology. Now let’s try viewing the correct <code class="literal">greeting</code> page:<a id="IDX-CHP-13-0081" class="indexterm"/><a id="IDX-CHP-13-0082" class="indexterm"/></p><a id="I_programlisting4_d1e23247"/><pre class="programlisting">&gt; <strong class="userinput"><code>(hello-request-handler "greeting" '() '())</code></strong>
&lt;html&gt;&lt;form&gt;What is your name?&lt;input name='name' /&gt;&lt;/form&gt;&lt;/html&gt;</pre><p>Excellent! Our request handler has generated an HTML form asking the user for a username. Now let’s pass in a parameter for the user’s name, as if the form had been processed and sent to the server:</p><a id="I_programlisting4_d1e23254"/><pre class="programlisting">&gt; <strong class="userinput"><code>(hello-request-handler "greeting" '() '((name . "Bob")))</code></strong>
&lt;html&gt;Nice to meet you, Bob!&lt;/html&gt;</pre><p>Because of the way we designed our web server, it’s very simple to debug a request handler independently in the REPL. We were able to see that <code class="literal">hello-request-handler</code> generates the correct responses without actually firing up a web browser.</p></div><div class="sect2" title="Launching the Website"><div class="titlepage"><div><div><h2 class="title"><a id="launching_the_website"/>Launching the Website</h2></div></div></div><p>Now that we know that our new website is functioning, let’s launch it! But first, we need to make sure that all of the functions discussed in this chapter have been defined in an instance of CLISP. If you haven’t been entering these functions into the REPL as you’ve been reading, you can just save them all into a file called <span class="emphasis"><em>webserver.lisp</em></span>, and then load them with <code class="literal">(load "webserve'")</code>.</p><p>Once you’ve defined your functions in the CLISP, start the server by entering the following into the REPL:</p><a id="I_programlisting4_d1e23277"/><pre class="programlisting">&gt; <strong class="userinput"><code>(serve #'hello-request-handler)</code></strong></pre><p>That’s it! Now you should be able to visit the site in a web browser:</p><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject4_d1e23284"/><img src="httpatomoreillycomsourcenostarchimages783558.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject4_d1e23290"/><img src="httpatomoreillycomsourcenostarchimages782976.png.jpg" alt="image with no caption"/></div></div><p>As you can see, when you visit our <code class="literal">greeting</code> page from a browser (using 127.0.0.1:8080, which will point to port 8080 on the same machine the web browser is running on), you are asked for your name. The server then shows a follow-up page, which greets you by name. This shows that our web server was able to parse out the name from the request parameters, and was able to pass the name to our <code class="literal">hello-request-handler</code> function.</p><p>We now have a fully functioning web server and request handling infrastructure. In future chapters, we’ll use these tools to create an awesome, graphical, web-based game.</p></div></div>
<div class="sect1" title="What You've Learned"><div class="titlepage"><div><div><h1 class="title"><a id="what_you_apostrophy_ve_learned-id13"/>What You've Learned</h1></div></div></div><p>In this chapter, you created a web server using Common Lisp, and learned the following along the way:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>You can signal conditions in Common Lisp with the <code class="literal">error</code> function. You can catch such errors with the <code class="literal">handle-case</code> command. If some code absolutely, positively needs to be called no matter what errors occur, you can place this code inside the <code class="literal">unwind-protect</code> command.</p></li><li class="listitem"><p>A web server processes HTTP requests. The most common type of request is the <code class="literal">GET</code> request, used for viewing information. Another common type is a <code class="literal">POST</code> request, which is used when submitting web forms, for instance. You can tell the type of request, which page was requested, as well as other information, by looking at the <span class="emphasis"><em>request header</em></span>. Both <code class="literal">GET</code> and <code class="literal">POST</code> requests may have request parameters, which can appear either at the end of the requested URL or at the bottom of the request in the <span class="emphasis"><em>request body</em></span>.</p></li></ul></div></div>
<div class="chapter" title="Chapter&#xA0;13.5.&#xA0;Functional Programming Is Beautiful"><div class="titlepage"><div><div><h1 class="title"><a id="functional_programming_is_beautiful"/>Chapter 13.5. Functional Programming Is Beautiful</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23349"/><img src="httpatomoreillycomsourcenostarchimages783152.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23355"/><img src="httpatomoreillycomsourcenostarchimages782536.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23361"/><img src="httpatomoreillycomsourcenostarchimages781954.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23367"/><img src="httpatomoreillycomsourcenostarchimages781992.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23373"/><img src="httpatomoreillycomsourcenostarchimages781350.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23379"/><img src="httpatomoreillycomsourcenostarchimages781394.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23385"/><img src="httpatomoreillycomsourcenostarchimages780708.png" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23391"/><img src="httpatomoreillycomsourcenostarchimages780140.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23397"/><img src="httpatomoreillycomsourcenostarchimages780194.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23403"/><img src="httpatomoreillycomsourcenostarchimages779934.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23410"/><img src="httpatomoreillycomsourcenostarchimages783136.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23416"/><img src="httpatomoreillycomsourcenostarchimages783170.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23422"/><img src="httpatomoreillycomsourcenostarchimages782562.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23428"/><img src="httpatomoreillycomsourcenostarchimages782606.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23434"/><img src="httpatomoreillycomsourcenostarchimages782016.png" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23440"/><img src="httpatomoreillycomsourcenostarchimages781376.png.jpg" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23446"/><img src="httpatomoreillycomsourcenostarchimages781416.png" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23452"/><img src="httpatomoreillycomsourcenostarchimages780728.png" alt="image with no caption"/></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e23458"/><img src="httpatomoreillycomsourcenostarchimages780772.png.jpg" alt="image with no caption"/></div></div></div></body></html>