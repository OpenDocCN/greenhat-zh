<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;REPORTING AND FOLLOW-UP ANALYSIS"><div class="titlepage"><div><div><h1 class="title"><a id="reporting_and_follow-up_analysis"/>Chapter 5. REPORTING AND FOLLOW-UP ANALYSIS</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject5_d1e6378"/><img alt="image with no caption" src="httpatomoreillycomsourcenostarchimages651574.png.jpg"/></div></div><p>The ability to view exactly what traffic passed over your network is a powerful tool, but what can anyone do with this data in its entirety? After all, very few people can eyeball a list of 15,000 flows and identify the 10 most active hosts, identify the most commonly used ports, or even rank them by IP. Carefully choosing flow files to examine and then filtering their contents can reduce the number of flows you have to read, but this still leaves you with a huge data set to integrate, aggregate, and analyze even on a small network. You need a tool to aggregate flow data, sort it, and display the cumulative results.<a class="indexterm" id="IDX-CHP-5-0001"/></p><p>The <code class="literal">flow-report</code> program reads flows and produces totals, rankings, per-second and per-interface counts, and other reports. You can create carefully customized reports to run over and over again, or you can use the built-in ones to perform ad hoc analysis. <code class="literal">flow-report</code> lets you quickly answer basic questions such as "Which web server sends the most traffic?" and "Which host is spewing viruses?" In this chapter, you'll see how to use <code class="literal">flow-report</code>'s many options and how to quickly answer your most important questions about your network.</p><div class="sect1" title="Default Report"><div class="titlepage"><div><div><h1 class="title"><a id="default_report"/>Default Report</h1></div></div></div><p>Everything <code class="literal">flow-report</code> produces is configured in the file <span class="emphasis"><em>stat.cfg</em></span>. The default configuration includes one generic report, with options to override many settings on the command line, much as <code class="literal">flow-nfilter</code> lets you configure filtering on the command line. You'll start with the default report and see how far you can stretch it.<a class="indexterm" id="IDX-CHP-5-0002"/><a class="indexterm" id="IDX-CHP-5-0003"/><a class="indexterm" id="IDX-CHP-5-0004"/><a class="indexterm" id="IDX-CHP-5-0005"/><a class="indexterm" id="IDX-CHP-5-0006"/></p><p>First you'll use the default report without any configuration. This produces the <span class="emphasis"><em>summary-detail report</em></span>, a generic statistical analysis of the flow data. The summary-detail report is rather lengthy, so I'll break it up into several chunks.<a class="indexterm" id="IDX-CHP-5-0007"/><a class="indexterm" id="IDX-CHP-5-0008"/></p><a id="I_programlisting5_d1e6446"/><pre class="programlisting">#    <strong class="userinput"><code>flow-cat * | flow-report</code></strong>
  #     --- ---- ---- Report Information --- --- ---
  #    build-version:        flow-tools 0.68.4
❶ #    name:                 default
❷ #    type:                 summary-detail
❸ #    options:              +header,+xheader,+totals
❹ #    fields:               +other
❺ #    records:              0
  #    first-flow:           1322715601 Thu Dec  1 00:00:01 2011
  #    last-flow:            1322719199 Thu Dec  1 00:59:59 2011
  #    now:                  1325460205 Sun Jan  1 18:23:25 2012
  #
  #    mode:                 streaming
  #    compress:             off
  #    byte order:           little
  #    stream version:       3
❻ #    export version:       5
  #
❼ #    ['/usr/local/bin/flow-rptfmt', '-f', 'ascii']</pre><p>Every line that starts with a hash mark is information about how the report was prepared or a comment about the actual flow files. This information includes the version of flow-tools used, the date and times of the first and last flows in the flow files, the current date and time, and so on.</p><p>At ❶ you see the report's name as defined in the report configuration file. I haven't created any custom reports yet, so I generated the default report.</p><p>Report types (❷) dictate how the flow data is arranged, searched, sorted, and presented. Report types include things such as "most common ports" and "most common addresses." I'll cover most of them in this chapter. This particular report is the summary-detail report.<a class="indexterm" id="IDX-CHP-5-0009"/></p><p>Report options (❸) tell <code class="literal">flow-report</code> what to include in the report. For example, the <code class="literal">+header</code> and <code class="literal">+xheader</code> options tell <code class="literal">flow-report</code> to include the report meta-information you're looking at right now. You can override the default options on the command line or set them in a custom report.</p><p>The fields setting (❹) tells <code class="literal">flow-report</code> what information to include in the report. Fields are columns in the report, as you'll see later with other report types. Again, you can override the default fields on the command line or set them in a custom report.<a class="indexterm" id="IDX-CHP-5-0010"/><a class="indexterm" id="IDX-CHP-5-0011"/><a class="indexterm" id="IDX-CHP-5-0012"/><a class="indexterm" id="IDX-CHP-5-0013"/><a class="indexterm" id="IDX-CHP-5-0014"/><a class="indexterm" id="IDX-CHP-5-0015"/><a class="indexterm" id="IDX-CHP-5-0016"/><a class="indexterm" id="IDX-CHP-5-0017"/></p><p>The records field (❺) shows whether <code class="literal">flow-report</code> has limited its output to a certain number of lines. You can set a maximum number of lines on the command line or in a report definition. This feature is useful if you want to know, for example, the top 10 hosts generating a certain type of traffic.</p><p>Knowing the flow version (❻) in the flow files tells you what information the report includes. You won't get BGP information from NetFlow version 1, for example.</p><p>Finally, at ❼ you see the command used to format the report. The <code class="literal">flow-report</code> program produces comma-separated value (CSV) reports only and relies on an outside program (<code class="literal">flow-rptfmt</code>) to create formatted text or HTML.<a class="indexterm" id="IDX-CHP-5-0018"/></p><div class="sect2" title="Timing and Totals"><div class="titlepage"><div><div><h2 class="title"><a id="timing_and_totals"/>Timing and Totals</h2></div></div></div><p>The next section includes details about the data inside the flow records. The first six lines are presented only when the report definition includes the <code class="literal">+totals</code> option.</p><a id="I_programlisting5_d1e6536"/><pre class="programlisting">❶    Ignores:                 0
     Total Flows:             54286
     Total Octets:            633669712
     Total Packets:           996238
❷    Total Duration (ms):     884588200
❸    Real Time:               1322719199
❹    Average Flow Time:       16294.000000
❺    Average Packets/Second:  636.000000
     Average Flows/Second:    11672.000000
     Average Packets/Flow:    18.000000
❻    Flows/Second:            0.042795
     Flows/Second (real):     0.000044</pre><p><code class="literal">flow-report</code> (❶) ignores flows with zero packets. Zero-packet flows are normally errors, but including them in other calculations will throw off your averages.<a class="indexterm" id="IDX-CHP-5-0019"/></p><p>You then see the total number of flows, octets, and packets in these flows. I captured 54,286 flows, or 633Mb, in 996,238 packets.</p><p>The total duration (❷) is the sum of the total time that the flows lasted, in milliseconds. For example, 10 one-second flows would give a total duration of 10 seconds, or 10,000 milliseconds, even if the flows ran simultaneously.</p><p>The remaining information is all part of the default summary-detail report.</p><p>The <code class="literal">Real Time</code> header (❸) tells when the flow data ends in Unix epochal time. 1322719199 is Thursday, December 1, 2011, at 00:59:59 EST, or just short of 1 <span class="keycap"><strong>am</strong></span>.</p><p>The average flow time (❹) is the average flow duration in milliseconds.<a class="indexterm" id="IDX-CHP-5-0020"/><a class="indexterm" id="IDX-CHP-5-0021"/><a class="indexterm" id="IDX-CHP-5-0022"/><a class="indexterm" id="IDX-CHP-5-0023"/><a class="indexterm" id="IDX-CHP-5-0024"/><a class="indexterm" id="IDX-CHP-5-0025"/><a class="indexterm" id="IDX-CHP-5-0026"/></p><p>You then have averages at ❺ for packets per second, flows per second, and packets per flow.<a class="indexterm" id="IDX-CHP-5-0027"/><a class="indexterm" id="IDX-CHP-5-0028"/></p><p>The two <code class="literal">Flows/Second</code> values at ❻ can be confusing. The first, <code class="literal">Flows/Second</code>, gives the number of flows per second you would expect by dividing the number of flows by the number of seconds in the sample. The <code class="literal">Flows/Second (real)</code> value calculation is based on epochal time and is not useful for most network management purposes.</p></div><div class="sect2" title="Packet Size Distribution"><div class="titlepage"><div><div><h2 class="title"><a id="packet_size_distribution"/>Packet Size Distribution</h2></div></div></div><p>The next section of the summary-detail report, packet size distribution, shows the size of the packets in these flows as a fraction of all the packets.<a class="indexterm" id="IDX-CHP-5-0029"/><a class="indexterm" id="IDX-CHP-5-0030"/></p><a id="I_programlisting5_d1e6634"/><pre class="programlisting">❶ 1-32   ❸64  96  128  160  192  224  256  288  320  352  384  416  448  480
❷ .000 ❹.232 .443 .067 .157 .045 .008 .005 .004 .003 .011 .003 .002 .001 .002

      512  544  576 1024 1536 2048 2560 3072 3584 4096 4608
     .001 .001 .001 .006 .008 .000 .000 .000 .000 .000 .000</pre><p>The first entry at ❶ shows what fraction of the packets in these flows has a size between 1 and 32 bytes; in this case, there are zero, as you can see at ❷.</p><p>A little less than a quarter of the packets in these flows (.232 as shown at ❹) are 64 bytes long (as shown at ❸). (I took these samples from a network segment with a heavily used DNS server, so I would expect many small flows.) Almost half of the packets are 96 bytes.</p></div><div class="sect2" title="Packets per Flow"><div class="titlepage"><div><div><h2 class="title"><a id="packets_per_flow"/>Packets per Flow</h2></div></div></div><p>The next section of the summary-detail report is the packets per flow, formatted much like the packet size distribution table.</p><a id="I_programlisting5_d1e6645"/><pre class="programlisting">❶  1    2    4 ❸ 8   12   16   20   24   28   32   36   40   44   48   52
❷ .307 .051 .135 .235 .072 .041 .032 .023 .019 .013 .012 .006 .004 .004 .003

       60  100  200  300  400  500  600  700  800  900 &gt;900
      .005 .013 .013 .003 .002 .001 .001 .000 .000 .000 .003</pre><p>Here you see at ❷ that 0.307, or roughly 31 percent, of the flows include only one packet (as shown at ❶). As you saw earlier, one-packet flows are generally ICMP requests or UDP such as simple DNS queries. Almost a quarter of the flows contain five to eight packets per flow (as shown at ❸). The remaining flows are scattered widely among the packets per flow.</p></div><div class="sect2" title="Octets in Each Flow"><div class="titlepage"><div><div><h2 class="title"><a id="octets_in_each_flow"/>Octets in Each Flow</h2></div></div></div><p>The next section of the summary-detail report tells you how many octets are in each flow.</p><a id="I_programlisting5_d1e6654"/><pre class="programlisting">❶ 32   64  128  256  512 1280 2048 2816 3584 4352 5120 5888 6656 7424 8192
❷ .000 .070 .173 .129 .097 .208 .115 .029 .028 .016 .017 .023 .011 .009 .005

     8960 9728 10496 11264 12032 12800 13568 14336 15104 15872 ❹ &gt;15872
     .004 .004  .003  .003  .003  .002  .002  .002  .002  .001 ❸ .043</pre><p>As you can see at ❷, none of the flows in this file contains only 32 octets (shown at ❶). (Remember, even a ping packet is usually 64 bytes.) The most common size for a flow is 513 to 1280 octets, with 0.208 representing roughly 20 percent of the flows. Although large flows are rare, you can see at ❸ that 0.043, or about 4 percent of the flows, are larger than 15,872 octets (as shown at ❹).<a class="indexterm" id="IDX-CHP-5-0031"/><a class="indexterm" id="IDX-CHP-5-0032"/><a class="indexterm" id="IDX-CHP-5-0033"/><a class="indexterm" id="IDX-CHP-5-0034"/></p></div><div class="sect2" title="Flow Time Distribution"><div class="titlepage"><div><div><h2 class="title"><a id="flow_time_distribution"/>Flow Time Distribution</h2></div></div></div><p>The last part of the summary-detail report, flow time distribution, tells you how long flows last in milliseconds.<a class="indexterm" id="IDX-CHP-5-0035"/><a class="indexterm" id="IDX-CHP-5-0036"/><a class="indexterm" id="IDX-CHP-5-0037"/></p><a id="I_programlisting5_d1e6696"/><pre class="programlisting">❷ 10    50  100  200  500 1000 2000 3000 4000 5000 6000 7000 8000 9000 10000
❶ .158 .100 .088 .084 .157 .085 .036 .019 .017 .010 .009 .007 .007 .010 .009

    12000 14000 16000 18000 20000 22000 24000 26000 28000 30000  &gt;30000
     .014  .008  .006  .008  .007  .005  .003  .003  .004  .004 ❸ .141</pre><p>As you can see at ❶, 0.158, or roughly 16 percent of the flows, lasted 10 milliseconds or less (as shown at ❷). A look at the data shows that this is the most common flow duration. As a general rule on this network, short flows are more common than longer ones: The long-running flows at the end (shown at ❸) stand out.</p><div class="sidebar"><a id="how_do_you_use_the_summary-detail_report"/><p class="title">HOW DO YOU USE THE SUMMARY-DETAIL REPORT?</p><p>If you get complaints that your network is behaving oddly, compare today's packets with last week's or last year's to quickly see anomalies. If you see that your traffic has changed in size, duration, or quantity during a network problem, you know something has changed. Filter on these characteristics to identify the host or connection that's changed.</p></div></div></div></div>
<div class="sect1" title="Modifying the Default Report"><div class="titlepage"><div><div><h1 class="title"><a id="modifying_the_default_report"/>Modifying the Default Report</h1></div></div></div><p>Much like with <code class="literal">flow-nfilter</code>, you can modify <code class="literal">flow-report</code>'s behavior from the command line. The program supports five variables: <code class="literal">TYPE</code>, <code class="literal">SORT</code>, <code class="literal">FIELDS</code>, <code class="literal">OPTIONS</code>, and <code class="literal">RPTOPT</code>. I'll cover each with an example later in this chapter. For now, here's a brief look at each variable:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">TYPE</code> tells <code class="literal">flow-report</code> which report to run. <code class="literal">flow-report</code> supports more than 70 report types. Much of this chapter is a discussion of the reports I find most useful. The <code class="literal">flow-report</code> manual page contains a complete list.</p></li><li class="listitem"><p><code class="literal">SORT</code> controls the data display order. You can sort most reports by any field in the report.<a class="indexterm" id="IDX-CHP-5-0038"/><a class="indexterm" id="IDX-CHP-5-0039"/><a class="indexterm" id="IDX-CHP-5-0040"/><a class="indexterm" id="IDX-CHP-5-0041"/><a class="indexterm" id="IDX-CHP-5-0042"/></p></li><li class="listitem"><p><code class="literal">FIELDS</code> lets you adjust the fields that appear in a report.</p></li><li class="listitem"><p><code class="literal">OPTIONS</code> activates or deactivates various report-wide features.</p></li><li class="listitem"><p><code class="literal">RPTOPT</code> gives options to pass to the report formatting program, <code class="literal">flow-rptfmt</code>.</p></li></ul></div><p>To set a variables, use <code class="literal">-v</code> and the variable name. For example, to set the <code class="literal">TYPE</code> variable, use the following:<a class="indexterm" id="IDX-CHP-5-0043"/></p><a id="I_programlisting5_d1e6800"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=</code></strong><strong class="userinput"><code><em class="replaceable"><code>yourtype</code></em></code></strong></pre><p>I'll use variables throughout the rest of this section to modify reports and then explore the different report types.</p><div class="sect2" title="Using Variables: Report Type"><div class="titlepage"><div><div><h2 class="title"><a id="using_variables_colon_report_type"/>Using Variables: Report Type</h2></div></div></div><p>One question you might hear from an interested manager<sup>[<a class="footnote" href="#ftn.CHP-5-FN-1" id="CHP-5-FN-1">8</a>]</sup> is "What computer talks the most?" The report type <code class="literal">ip-source-address</code> displays how much traffic each host puts on the network.</p><a id="I_programlisting5_d1e6821"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-source-address</code></strong>
...
#  ['/usr/local/bin/flow-rptfmt', '-f', 'ascii']
ip-source-address flows octets    packets duration
192.0.2.37        12163 107898108 204514  159749392
158.43.128.72     16389 1962766   16711   49357139
192.0.2.4         54280 127877204 785592  831419980
198.6.1.1         7627  970898    7992    26371278
...</pre><p>With this report you get a list of IP addresses and the number of flows, octets, and packets sent by that host, as well as the total duration of all flows to this host in milliseconds. The data in this report is presented, in no particular order, as a list of IP addresses and traffic measurements, which demonstrates that you must know exactly what you mean by "busiest host." Is it the host that sends the greatest amount of traffic (octets)? Is it the host involved in the greatest number of connections (flows)? Or is it the host that sends the greatest number of individual packets?</p></div><div class="sect2" title="Using Variables: SORT"><div class="titlepage"><div><div><h2 class="title"><a id="using_variables_colon_sort"/>Using Variables: SORT</h2></div></div></div><p>Scrolling through a long report in search of the host that sends the most traffic isn't terribly effective. Instead, use the <code class="literal">SORT</code> variable to tell <code class="literal">flow-report</code> how to order the data.</p><p>You can assign <code class="literal">SORT</code> the value of the name of any field in a report. However, the fields are not necessarily the same as the names of the columns. The report header contains the fields entry, which lists the valid fields in the report type in the order they appear in the report. Here's the header information on fields from the <code class="literal">ip-source-address</code> report:<a class="indexterm" id="IDX-CHP-5-0044"/><a class="indexterm" id="IDX-CHP-5-0045"/><a class="indexterm" id="IDX-CHP-5-0046"/></p><a id="I_programlisting5_d1e6860"/><pre class="programlisting"># fields:               +key,+flows,+octets,+packets,+duration,+other</pre><p>The actual report includes the columns <code class="literal">ip-source-address</code>, <code class="literal">flows</code>, <code class="literal">octets</code>, <code class="literal">packets</code>, and <code class="literal">duration</code>, as shown here:</p><a id="I_programlisting5_d1e6879"/><pre class="programlisting">ip-source-address flows octets    packets duration
192.0.2.4         54280 127877204 785592  831419980
...</pre><p>Note that the list of fields starts with an entry named <code class="literal">key</code> and follows that with entries called <code class="literal">flows</code>, <code class="literal">octets</code>, <code class="literal">packets</code>, <code class="literal">duration</code>, and <code class="literal">other</code>. The actual report starts with a column called <code class="literal">ip-source-address</code> and follows that with the fields <code class="literal">flows</code>, <code class="literal">octets</code>, <code class="literal">packets</code>, and <code class="literal">duration</code>. <code class="literal">flow-report</code> calls the field it's reporting on the <span class="emphasis"><em>key</em></span>. I ran the <code class="literal">ip-source-address</code> report, so the key is the <code class="literal">ip-source-address</code> field. (This report has no <code class="literal">other</code> column, despite its presence in the list of fields.)</p><p>To sort by a column in descending order, assign the <code class="literal">SORT</code> variable the field name with a leading plus sign. To sort by a column in ascending order, assign the <code class="literal">SORT</code> variable the field name with a leading minus sign.</p><p>I'm interested in the host that creates the greatest number of connections, or flows, so I'll assign <code class="literal">SORT</code> the value <code class="literal">+flows</code> to sort the data by flows in descending order, like so:</p><a id="I_programlisting5_d1e6949"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-source-address -v SORT=+flows</code></strong>
  ...
  #  ['/usr/local/bin/flow-rptfmt', '-f', 'ascii']
  ip-source-address flows octets    packets duration
❶ 192.0.2.4         54280 127877204 785592  831419980
  158.43.128.72     16389 1962766   16711   49357139
  192.0.2.37        12163 107898108 204514  159749392
  198.6.1.5         8826  1425518   11339   24124445
  192.0.2.36        8786  21773315  38616   44443605
  198.6.1.1         7627  970898    7992    26371278
  ...</pre><p>The host 192.0.2.4 (❶) has sent 54,280 flows, almost four times as many as the next highest host.</p><p>At first glance, it might appear that sorting by flows also sorts by bytes (octets) to a certain degree, but that's illusionary. Here I report on the same data sorted by octets:</p><a id="I_programlisting5_d1e6959"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-source-address -v SORT=+octets</code></strong>
...
#  ['/usr/local/bin/flow-rptfmt', '-f', 'ascii']
ip-source-address flows octets    packets duration
207.46.209.247    25    131391013 90275   2967322
192.0.2.4         54280 127877204 785592  831419980
192.0.2.37        12163 107898108 204514  159749392
192.0.2.7         116   72083511  55415   15057488
192.0.2.130       145   49604492  74852   36232749
192.0.2.8         88    48766466  36166   7181558
...</pre><p>When you compare the list of hosts that send the greatest number of octets to the list of hosts that send the greatest number of flows, notice that four of the top six hosts on each list don't even appear in the other list!<a class="indexterm" id="IDX-CHP-5-0047"/><a class="indexterm" id="IDX-CHP-5-0048"/><a class="indexterm" id="IDX-CHP-5-0049"/><a class="indexterm" id="IDX-CHP-5-0050"/><a class="indexterm" id="IDX-CHP-5-0051"/></p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-5-FN-1" id="ftn.CHP-5-FN-1">8</a>] </sup>The quickest way to make your manager lose interest is to answer this question in appalling detail. This might seem cruel, but it's best for everyone involved.</p></div></div></div>
<div class="sect1" title="Analyzing Individual Flows from Reports"><div class="titlepage"><div><div><h1 class="title"><a id="analyzing_individual_flows_from_reports"/>Analyzing Individual Flows from Reports</h1></div></div></div><p>Look back at the <code class="literal">ip-source-address</code> report from in <a class="xref" href="ch05s02.html#using_variables_colon_sort" title="Using Variables: SORT">Using Variables: SORT</a> in <a class="xref" href="ch05s02.html#using_variables_colon_report_type" title="Using Variables: Report Type">Using Variables: Report Type</a>. Notice how the host 207.46.209.247 used the most bandwidth, 131,391,013 octets. That's 131,391,013 divided by 1,024, which is about 128,312KB, or 125MB. The obvious question is "What did that host send in all those octets with but so few flows?"</p><p>To find out, use <code class="literal">flow-nfilter</code> to answer that question. Because this is a one-off query that probably won't be repeated, just configure the filter on the command line.</p><a id="I_programlisting5_d1e7004"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-nfilter -F ip-src-addr -v ADDR=207.46.209.247 | flow-print</code></strong>
srcIP            dstIP            prot  srcPort  dstPort  octets      packets
207.46.209.247   192.0.2.4     ❶ 6  ❷ 80       51538    16499752    11018
207.46.209.247   192.0.2.4        6     80       51540    16104523    10756
207.46.209.247   192.0.2.4        6     80       53410    20798       17
...</pre><p>Thanks to this report, you can see that this connection ran over TCP (❶) and that it came from port 80 to a high-numbered port (❷). This is obviously a response from a web server. In this case, the destination IP happens to be my main proxy server. I can search my proxy logs and probably identify this traffic more exactly.<a class="indexterm" id="IDX-CHP-5-0052"/></p><p>Unfortunately, web traffic isn't quite that simple. People frequently browse and click through many pages on a website, perhaps downloading data from many different places on the site or maybe downloading a single large file. How can you know whether this data represents a single large download or a bunch of smaller requests? There's no way to be certain, but one way to check is to compare the connections coming from that address to the connections going to that address.</p><p>To do so, you can change the filter to check for flows going to 207.46.209.247. You'll need the start and stop times for each flow to see whether new connections are starting or whether each flow is an independent request. <code class="literal">flow-print</code> format 5 displays timing information with each flow, so I use that to display my filtered data. (I've removed several irrelevant fields, such as the protocol, interface, packets, and octets, from this example to make the output fit on the page.)<a class="indexterm" id="IDX-CHP-5-0053"/></p><a id="I_programlisting5_d1e7028"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-nfilter -F ip-dst-addr -v ADDR=207.46.209.247 | flow-print -f 5</code></strong>
  Start             End               SrcIPaddress  SrcP  DstIPaddress    DstP
❶   1201.11:58:00.409 1201.12:01:55.917 192.0.2.4   51538 207.46.209.247  80
❷   1201.11:58:00.451 1201.12:02:05.769 192.0.2.4   51540 207.46.209.247  80
❸   1201.12:03:00.506 1201.12:04:10.916 192.0.2.4   53410 207.46.209.247  80
    1201.12:03:00.505 1201.12:04:16.805 192.0.2.4   53409 207.46.209.247  80
❹   1201.12:08:00.457 1201.12:09:25.912 192.0.2.4   55190 207.46.209.247  80
    1201.12:08:00.457 1201.12:09:26.775 192.0.2.4   55191 207.46.209.247  80
❺   1201.12:13:00.519 1201.12:14:11.891 192.0.2.4   57581 207.46.209.247  80
    1201.12:13:00.520 1201.12:16:30.907 192.0.2.4   57580 207.46.209.247  80
  ...</pre><p>The first flow (❶) starts at 1201.11:58:00.409, or 11:58 <span class="keycap"><strong>am</strong></span> and .409 seconds, on December 1, and ends at 12:05:55.917. A second request at ❷ begins milliseconds later and ends at about the same time. These are clearly two separate HTTP requests.<a class="indexterm" id="IDX-CHP-5-0054"/><a class="indexterm" id="IDX-CHP-5-0055"/><a class="indexterm" id="IDX-CHP-5-0056"/></p><p>What makes this output interesting is the timing of the other requests. Two more requests begin at ❸ exactly five minutes after the first two, and two more begin at ❹ five minutes after that. By viewing the requests rather than the responses to the requests, it becomes very obvious that something on your network is accessing this site (❺) every five minutes. People do not behave in such a mechanistic manner. The sensible assumption is that a piece of software is responsible for this traffic.</p><p>This report gives exact timestamps for when these repeating, high-bandwidth HTTP requests begin and end, which is all you need in order to find the site in your proxy logs. (In this particular case, this turned out to be clients downloading patches from Microsoft instead of using the corporate update server.)</p><div class="note" title="Note"><h3 class="title">Note</h3><p>If you have no proxy server, you aren't logging Internet usage. You can do flow analysis on your internal network to identify the specific workstations that were making these requests and see what those workstations have in common, but that's all. If the activity is ongoing, use your packet sniffer to identify what site the workstations are trying to reach.</p></div></div>
<div class="sect1" title="Other Report Customizations"><div class="titlepage"><div><div><h1 class="title"><a id="other_report_customizations"/>Other Report Customizations</h1></div></div></div><p>Just as the <code class="literal">SORT</code> variable adjusts data display, other variables further change a report's format, allowing you to create a report that contains exactly the information you need, presented in the most usable manner. I'll modify the <code class="literal">ip-source-address</code> report I ran earlier this chapter to demonstrate exactly how each of these variables changes a report.</p><div class="sect2" title="Choosing Fields"><div class="titlepage"><div><div><h2 class="title"><a id="choosing_fields"/>Choosing Fields</h2></div></div></div><p>Perhaps you specifically want to know the number of bytes (or packets) sent by a host, and you don't care about the other information provided by a report. The <code class="literal">FIELDS</code> variable lets you select the columns to include in a report.</p><p>For example, the <code class="literal">ip-source-address</code> report includes five fields: <code class="literal">address</code>, <code class="literal">flows</code>, <code class="literal">octets</code>, <code class="literal">packets</code>, and <code class="literal">duration</code>. Say you want to remove the duration column from your report. To do so, give the <code class="literal">FIELDS</code> variable the value of the field you want to remove, with a leading minus sign, as shown here with <code class="literal">-duration</code>:<a class="indexterm" id="IDX-CHP-5-0057"/><a class="indexterm" id="IDX-CHP-5-0058"/><a class="indexterm" id="IDX-CHP-5-0059"/><a class="indexterm" id="IDX-CHP-5-0060"/><a class="indexterm" id="IDX-CHP-5-0061"/><a class="indexterm" id="IDX-CHP-5-0062"/><a class="indexterm" id="IDX-CHP-5-0063"/><a class="indexterm" id="IDX-CHP-5-0064"/><a class="indexterm" id="IDX-CHP-5-0065"/></p><a id="I_programlisting5_d1e7137"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-source-address</code></strong>
 <strong class="userinput"><code>-v SORT=+octets -v FIELDS=-duration</code></strong>
...
ip-source-address flows octets    packets
207.46.209.247    25    131391013 90275
192.0.2.4        54280 127877204 785592
192.0.2.37       12163 107898108 204514
...</pre><p>To remove multiple <code class="literal">FIELDS</code> values, separate each with commas. Here I've removed everything except the IP address and the number of octets:</p><a id="I_programlisting5_d1e7150"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=</code></strong>
<strong class="userinput"><code>ip-source-address -v SORT=+octets -v FIELDS=-duration,-packets,-flows</code></strong>
...
ip-source-address octets
207.46.209.247    131391013
192.0.2.4         127877204
192.0.2.37        107898108
...</pre><p>If extraneous data confuses your audience, consider trimming unneeded fields.</p></div><div class="sect2" title="Displaying Headers, Hostnames, and Percentages"><div class="titlepage"><div><div><h2 class="title"><a id="displaying_headers_comma_hostnames_comma"/>Displaying Headers, Hostnames, and Percentages</h2></div></div></div><p>The <code class="literal">OPTIONS</code> variable controls miscellaneous report settings. <code class="literal">flow-report</code> supports five options, but not all report types support all options, and not all options make sense for every report type. The effect of different options varies with the type of report being run. The report header shows the options used in a report.<a class="indexterm" id="IDX-CHP-5-0066"/></p><a id="I_programlisting5_d1e7176"/><pre class="programlisting"># options:              +percent-total,+header</pre><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The <code class="literal">header</code> option tells <code class="literal">flow-report</code> to include the generic informational header consisting of the name of the report type, the time of the last flow in the data, and so on. You saw an example of a flow report header in <a class="xref" href="ch05.html#default_report" title="Default Report">Default Report</a> in <a class="xref" href="ch05.html#default_report" title="Default Report">Default Report</a>.</p></li><li class="listitem"><p>The <code class="literal">xheader</code> option tells <code class="literal">flow-report</code> to provide extra header information. Not all report types have extra header information. In some reports, the extra header information is identical to the regular header information. Try this option to see what it does with a given report type.<a class="indexterm" id="IDX-CHP-5-0067"/></p></li><li class="listitem"><p>With the <code class="literal">totals</code> option, <code class="literal">flow-report</code> includes the total values of the information being reported on. Not all reports include this, because not all information can be totaled. (You cannot sensibly add IP addresses together, for example!)<a class="indexterm" id="IDX-CHP-5-0068"/><a class="indexterm" id="IDX-CHP-5-0069"/><a class="indexterm" id="IDX-CHP-5-0070"/><a class="indexterm" id="IDX-CHP-5-0071"/><a class="indexterm" id="IDX-CHP-5-0072"/><a class="indexterm" id="IDX-CHP-5-0073"/><a class="indexterm" id="IDX-CHP-5-0074"/><a class="indexterm" id="IDX-CHP-5-0075"/></p></li><li class="listitem"><p>The <code class="literal">percent-total</code> option provides the information as a percentage of the total rather than an absolute amount. For example, in the <code class="literal">source-ip-address</code> report, the flows from a particular host would appear as a percentage of the total number of flows rather than the actual number of flows.</p></li><li class="listitem"><p>Finally, the <code class="literal">names</code> option tells <code class="literal">flow-report</code> to use names rather than numbers. This option makes <code class="literal">flow-report</code> perform a DNS query for each IP address in the report, which makes reports with IP addresses run extremely slowly. Reports with a limited number of hosts can run reasonably quickly, however, and pulling information from static files such as <span class="emphasis"><em>/etc/protocols</em></span> and <span class="emphasis"><em>/etc/services</em></span> is very quick.</p></li></ul></div><p>To remove options from an existing report, put a minus sign (<code class="literal">-</code>) before the option name in the <code class="literal">OPTIONS</code> variable. In the following example, I've removed all header information from the <code class="literal">ip-source-address</code> report and am presenting only the report data:</p><a id="I_programlisting5_d1e7280"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-source-address -v SORT=+octets -v</code></strong>
 ❶ <strong class="userinput"><code>OPTIONS=-header</code></strong></pre><p>The minus sign before <code class="literal">header</code> at ❶ tells <code class="literal">flow-report</code> to remove this value from the list of options.</p><p>Adding options is a little more complicated. Once you start adding options, <code class="literal">flow-report</code> assumes that you will list all desired options. The default report includes the options <code class="literal">header</code>, <code class="literal">xheader</code>, and <code class="literal">totals</code>. To retain all of these and add the <code class="literal">percent-total</code> option, list them all on the command line, separated by commas, as shown here:</p><a id="I_programlisting5_d1e7312"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-source</code></strong>
<strong class="userinput"><code>-address -v SORT=+octets -v OPTIONS=+percent-total,+header,+xheader,+totals</code></strong></pre><div class="note" title="Note"><h3 class="title">Note</h3><p>If I were to include only the <code class="literal">+percent-total</code> option, <code class="literal">flow-report</code> would not use any other options even though they are the default.</p></div></div><div class="sect2" title="Presenting Reports in HTML"><div class="titlepage"><div><div><h2 class="title"><a id="presenting_reports_in_html"/>Presenting Reports in HTML</h2></div></div></div><p><code class="literal">flow-report</code> formats its output through an external program, <code class="literal">flow-rptfmt</code>. Most of <code class="literal">flow-rptfmt</code>'s features overlap <code class="literal">flow-report</code> functions, such as setting sorting order or choosing fields to display, but you can have <code class="literal">flow-rptfmt</code> create HTML with the <code class="literal">-f html</code> flag. Use the <code class="literal">RPTOPT</code> variable to pass commands to <code class="literal">flow-rptfmt</code>.</p><a id="I_programlisting5_d1e7357"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-source-address -v RPTOPT=-fhtml</code></strong></pre><p>You'll consider <code class="literal">flow-rptfmt</code> further when I show how to create customized reports.</p></div></div>
<div class="sect1" title="Useful Report Types"><div class="titlepage"><div><div><h1 class="title"><a id="useful_report_types"/>Useful Report Types</h1></div></div></div><p><code class="literal">flow-report</code> supports more than 70 types of reports and lets you analyze your traffic in more ways than you may have thought possible. In this section, I'll demonstrate the most commonly useful report types. Read the <code class="literal">flow-report</code> man page for the complete list.<a class="indexterm" id="IDX-CHP-5-0076"/><a class="indexterm" id="IDX-CHP-5-0077"/><a class="indexterm" id="IDX-CHP-5-0078"/><a class="indexterm" id="IDX-CHP-5-0079"/><a class="indexterm" id="IDX-CHP-5-0080"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>Many of these reports are most useful when presented in graphical format or when prepared on a filtered subset of data. You'll look at how to do both of these later in this chapter.</p></div><div class="sect2" title="IP Address Reports"><div class="titlepage"><div><div><h2 class="title"><a id="ip_address_reports"/>IP Address Reports</h2></div></div></div><p>Many traffic analysis problems focus on individual IP addresses. You've already spent some quality time with the <code class="literal">ip-source-address</code> report. These reports work similarly, but they have their own unique characteristics.<a class="indexterm" id="IDX-CHP-5-0081"/></p><div class="sect3" title="Highest Data Exchange: ip-address"><div class="titlepage"><div><div><h3 class="title"><a id="highest_data_exchange_colon_ip-address"/>Highest Data Exchange: ip-address</h3></div></div></div><p>To report on all flows by host, use the <code class="literal">ip-address</code> report. This totals both the flows sent and the flows received by the host. Here, you look for the host that processed the largest number of octets on the network. You lose the data's bidirectional nature, but this report quickly identifies your most network-intensive host.<a class="indexterm" id="IDX-CHP-5-0082"/></p><a id="I_programlisting5_d1e7424"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-address -v SORT=+octets</code></strong>
ip-address      flows  octets    packets duration
192.0.2.4       107785 995021734 1656178 1659809423
192.0.2.37      24294  347444011 456952  322712670
207.46.209.247  50     134705214 151227  5934644
...</pre></div><div class="sect3" title="Flows by Recipient: ip-destination-address"><div class="titlepage"><div><div><h3 class="title"><a id="flows_by_recipient_colon_ip-destination"/>Flows by Recipient: ip-destination-address</h3></div></div></div><p>This is the opposite of the <code class="literal">ip-source-address</code> report I used as an example report throughout the beginning of this chapter. It reports on traffic by destination address.</p><a id="I_programlisting5_d1e7437"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-destination-address</code></strong>
ip-destination-address flows octets    packets duration
158.43.128.72          16478 1090268   16816   49357139
192.0.2.37             12131 239545903 252438  162963278
198.6.1.1              7630  588990    7997    26371278
...</pre><p>In this example, the host 158.43.128.72 has received 16,478 flows in 1,090,268 octets. Lots of people transmitted data to this host. You don't know whether this data is the result of connections initiated by this host or whether many hosts are connecting to this host. To answer that, you have to look at the actual connections. Use <code class="literal">flow-nfilter</code> to trim your data down to show only the flows involving this host, and use <code class="literal">flow-print</code> to see the data.<a class="indexterm" id="IDX-CHP-5-0083"/></p></div><div class="sect3" title="Most Connected Source: ip-source-address-destination-count"><div class="titlepage"><div><div><h3 class="title"><a id="most_connected_source_colon_ip-source-ad"/>Most Connected Source: ip-source-address-destination-count</h3></div></div></div><p>Many worms scan networks trying to find vulnerable hosts. If you have a worm infection, you'll want to know which host sends traffic to the greatest number of other hosts on the network. The <code class="literal">ip-source-address-destination-count</code> report shows exactly this.<a class="indexterm" id="IDX-CHP-5-0084"/><a class="indexterm" id="IDX-CHP-5-0085"/><a class="indexterm" id="IDX-CHP-5-0086"/><a class="indexterm" id="IDX-CHP-5-0087"/><a class="indexterm" id="IDX-CHP-5-0088"/></p><a id="I_programlisting5_d1e7482"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-source-address-destination-count</code></strong>
  ip-source-address ip-destination-address-count flows octets    packets duration
❶ 192.0.2.37      ❷ 1298                         12163 107898108 204514  159749392
  158.43.128.72     5                            16389 1962766   16711   49357139
  192.0.2.4         2016                         54280 127877204 785592  831419980
  ...</pre><p>This report shows you that the host 192.0.2.37 (❶) sent flows to 1,298 (❷) other hosts, as well as the number of flows, octets, and packets of these connections.</p></div><div class="sect3" title="Most Connected Destination: ip-destination-address-source-count"><div class="titlepage"><div><div><h3 class="title"><a id="most_connected_destination_colon_ip-dest"/>Most Connected Destination: ip-destination-address-source-count</h3></div></div></div><p>You can also count the number of sources that connect to each destination. This is similar to the previous report but will contain slightly different data. Some flows (such as broadcasts and some ICMP) go in only one direction, so you must consider destinations separately from sources.</p><a id="I_programlisting5_d1e7494"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-destination-address-source-count</code></strong>
ip-destination-address ip-source-address-count flows octets    packets duration
158.43.128.72          5                       16478 1090268   16816   49357139
192.0.2.37            1303                     12131 239545903 252438  162963278
198.6.1.1              2                       7630  588990    7997    26371278
...</pre><p>The <code class="literal">ip-source-address-destination-count</code> and <code class="literal">ip-destination-address-source-count</code> reports give additional insight into the key servers, resources, and users on your network, even when you don't have problems.</p><div class="sidebar"><a id="reports_that_don_apostrophy_t_sort_by"/><p class="title">REPORTS THAT DON'T SORT BY EVERYTHING</p><p>Some reports don't offer the opportunity to sort by every field. For example, the two interconnectedness reports cannot sort by the number of hosts an address connects to. This is annoying, especially because this is precisely what you're interested in if you're running this report! On most flavors of Unix you can sort by a column by piping the output through <code class="literal">sort -rnk columnnumber</code>, as shown here:<a class="indexterm" id="IDX-CHP-5-0089"/></p><a id="I_programlisting5_d1e7518"/><pre class="programlisting">flow-cat | flow-report | sort -rnk 2</pre></div></div></div><div class="sect2" title="Network Protocol and Port Reports"><div class="titlepage"><div><div><h2 class="title"><a id="network_protocol_and_port_reports"/>Network Protocol and Port Reports</h2></div></div></div><p>These reports identify the network ports used by TCP and UDP flows or, on a larger scale, just how much traffic is TCP, UDP, and other protocols.<a class="indexterm" id="IDX-CHP-5-0090"/><a class="indexterm" id="IDX-CHP-5-0091"/><a class="indexterm" id="IDX-CHP-5-0092"/><a class="indexterm" id="IDX-CHP-5-0093"/><a class="indexterm" id="IDX-CHP-5-0094"/><a class="indexterm" id="IDX-CHP-5-0095"/><a class="indexterm" id="IDX-CHP-5-0096"/></p><div class="sect3" title="Ports Used: ip-port"><div class="titlepage"><div><div><h3 class="title"><a id="ports_used_colon_ip-port"/>Ports Used: ip-port</h3></div></div></div><p>Forget about source and destination addresses. What TCP and UDP protocols are the most heavily used on your network? The <code class="literal">ip-port</code> report tells you.</p><a id="I_programlisting5_d1e7562"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-port -v SORT=+octets</code></strong>
  ip-port flows octets    packets duration
❶   80 ❹ 63344 877141857 1298560 1444603541
❷   25    8903  361725472 475912  139074162
❸   443   10379 136012764 346935  324609472
  ...</pre><p>This looks suspiciously like assorted Internet services. Port 80 (❶) is regular web traffic; port 25 (❷) is email; and port 443 (❸) is encrypted web traffic. You can see how much traffic involves each of these ports, but it's a combination of inbound and outbound traffic. For example, you know that 63,344 (❹) flows either started or finished on port 80. These could be to a web server on the network or web client requests to servers off the network. To narrow this down, you really must filter the flows you examine, run a more specific report, or both. Still, this offers a fairly realistic answer to the question "How much of the traffic is web browsing or email?" especially if you use the <code class="literal">+percent-total</code> option.</p></div><div class="sect3" title="Flow Origination: ip-source-port"><div class="titlepage"><div><div><h3 class="title"><a id="flow_origination_colon_ip-source-port"/>Flow Origination: ip-source-port</h3></div></div></div><p>To see the originating port of a flow, use the <code class="literal">ip-source-port</code> report. Here I'm sorting the ports in ascending order:</p><a id="I_programlisting5_d1e7580"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-source-port -v SORT=-key</code></strong>
  ip-source-port flows octets    packets duration
❶ 0            215   4053775   23056   21289759
  22             111   1281556   15044   4816416
  25             4437  10489387  181655  69456345
  49             19    3922      79      5135
  ...</pre><p>Flows with a source port of zero (❶) are probably ICMP and certainly not TCP or UDP. It's best to filter your data to only TCP and UDP before running this report. Although ICMP flows use a destination port to represent the ICMP type and code, ICMP flows have no source port.</p><p>Source ports with low numbers, such as those in the previously shown report snippet, are almost certainly responses to services running on those ports. In a normal network, port 22 is SSH, port 25 is SMTP, and port 49 is TACACS.</p></div><div class="sect3" title="Flow Termination: ip-destination-port"><div class="titlepage"><div><div><h3 class="title"><a id="flow_termination_colon_ip-destination-po"/>Flow Termination: ip-destination-port</h3></div></div></div><p>The report <code class="literal">ip-destination-port</code> identifies flow termination ports.<a class="indexterm" id="IDX-CHP-5-0097"/><a class="indexterm" id="IDX-CHP-5-0098"/><a class="indexterm" id="IDX-CHP-5-0099"/><a class="indexterm" id="IDX-CHP-5-0100"/><a class="indexterm" id="IDX-CHP-5-0101"/><a class="indexterm" id="IDX-CHP-5-0102"/></p><a id="I_programlisting5_d1e7617"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-destination-port -v SORT=-key</code></strong>
ip-destination-port flows octets    packets duration
0                   91    3993212   22259   14707048
22                  231   26563846  22155   5421745
25                  4466  351236085 294257  69617817
49                  19    6785      101     5135
...</pre><p>These look an awful lot like the source ports. What gives? Because a flow is half of a TCP/IP connection, the destination port might be the destination for the data flowing from the server to the client. A report on the same data should show just roughly as many flows starting on a port as you terminate on that port. Sorting the report by port makes this very obvious.<a class="indexterm" id="IDX-CHP-5-0103"/><a class="indexterm" id="IDX-CHP-5-0104"/></p></div><div class="sect3" title="Individual Connections: ip-source/destination-port"><div class="titlepage"><div><div><h3 class="title"><a id="individual_connections_colon_ip-source_s"/>Individual Connections: ip-source/destination-port</h3></div></div></div><p>Part of the identifying information for a single TCP/IP connection is the source port and a destination port. The <code class="literal">ip-source/destination-port</code> report groups flows by common source and destination ports. Here, I'm reporting on port pairs and sorting them by the number of octets:</p><a id="I_programlisting5_d1e7642"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-source/destination-port -v SORT=+octets</code></strong>
  ip-source-port ip-destination-port flows octets   packets duration
❶ 80             15193               3     62721604 43920   620243
❷ 4500           4500                115   57272960 101806  30176444
❸ 14592          25                  2     28556024 19054   480319
  ...</pre><p>The first connection at ❶ appears to be responses to a web request, coming from port 80 to a high-numbered port. Three separate flows used this combination of ports. Then at ❷ there is IPSec NAT-T traffic on port 4500 and then transmissions to the email server at ❸.</p><p>I find this report most useful after I prefilter the data to include only a pair of hosts, which gives me an idea of the traffic being exchanged between the two. You might also use this report to identify high-bandwidth connections and filter on those ports to identify the hosts involved, but if you're interested in the hosts exchanging the most traffic, the <code class="literal">ip-address</code> report is more suitable.<a class="indexterm" id="IDX-CHP-5-0105"/></p></div><div class="sect3" title="Network Protocols: ip-protocol"><div class="titlepage"><div><div><h3 class="title"><a id="network_protocols_colon_ip-protocol"/>Network Protocols: ip-protocol</h3></div></div></div><p>How much of your traffic is TCP, and how much is UDP? Do you have other protocols running on your network? The <code class="literal">ip-protocol</code> report breaks down the protocols that appear on your network. In this example, I'm using the <code class="literal">+names</code> option to have <code class="literal">flow-report</code> print the protocol name from <span class="emphasis"><em>/etc/protocols</em></span> rather than using the protocol number. Looking up names in a static file is much faster than DNS resolution.</p><a id="I_programlisting5_d1e7674"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-protocol -v OPTIONS=+names</code></strong>
ip-protocol flows octets     packets duration
icmp        158   75123      965     6719987
tcp         83639 1516003823 2298691 1989109659
udp         76554 69321656   217741  296940177
esp         34    3820688    18720   8880078
vrrp        12    151708     3298    3491379</pre><p>As you can see, clearly TCP and UDP are our most common protocols, but there is also an interesting amount of ESP traffic. ESP is one of the protocols used for IPSec VPNs.<a class="indexterm" id="IDX-CHP-5-0106"/><a class="indexterm" id="IDX-CHP-5-0107"/><a class="indexterm" id="IDX-CHP-5-0108"/><a class="indexterm" id="IDX-CHP-5-0109"/><a class="indexterm" id="IDX-CHP-5-0110"/></p><div class="sidebar"><a id="reports_combining_addresses_and_ports"/><p class="title">REPORTS COMBINING ADDRESSES AND PORTS</p><p><code class="literal">flow-report</code> also supports reports that provide source and destination addresses and ports together, in almost any combination. Read the <code class="literal">flow-report</code> manual page for the specific names of these reports. I find <code class="literal">flow-print</code> more useful for that type of analysis.</p></div></div></div><div class="sect2" title="Traffic Size Reports"><div class="titlepage"><div><div><h2 class="title"><a id="traffic_size_reports"/>Traffic Size Reports</h2></div></div></div><p>Has the number of large data transfers increased on your network over the past few days? If so, <code class="literal">flow-report</code> lets you dissect your traffic records and identify trends. These reports are most useful when graphed and compared to historical traffic patterns.</p><div class="sect3" title="Packet Size: packet-size"><div class="titlepage"><div><div><h3 class="title"><a id="packet_size_colon_packet-size"/>Packet Size: packet-size</h3></div></div></div><p>How large are the packets crossing your network? You're probably familiar with the 1,500-byte limit on packet size, but how many packets actually reach that size? The <code class="literal">packet-size</code> report counts the packets of each size. Here I'm running this report and sorting the results by packet size:</p><a id="I_programlisting5_d1e7733"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=packet-size -v SORT=+key</code></strong>
packet size/flow flows octets   packets duration
1500           ❶ 5   ❷ 2776500 ❸1851   1406780
1499             2     14717980 9816    390603
1498             5     60253559 40207   999167
...</pre><p>As you can see at ❶, 1,500-byte packets have been seen in five flows, containing a total of 2.7 million bytes (❷). You've seen 1851, (❸) of these 1,500-byte packets. Sorting by packets would identify the most and least common packet size.</p></div><div class="sect3" title="Bytes per Flow: octets"><div class="titlepage"><div><div><h3 class="title"><a id="bytes_per_flow_colon_octets"/>Bytes per Flow: octets</h3></div></div></div><p>How large are your individual flows? Do you have more large network transactions or small ones? To answer this, report on the bytes per flow with the <code class="literal">octets</code> report.<a class="indexterm" id="IDX-CHP-5-0111"/><a class="indexterm" id="IDX-CHP-5-0112"/><a class="indexterm" id="IDX-CHP-5-0113"/><a class="indexterm" id="IDX-CHP-5-0114"/><a class="indexterm" id="IDX-CHP-5-0115"/><a class="indexterm" id="IDX-CHP-5-0116"/></p><a id="I_programlisting5_d1e7772"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=octets -v SORT=-key</code></strong>
octets/flow flows octets   packets duration
46        ❶ 367  ❷16882    367     1214778
48        ❸ 59    2832   ❹ 59      272782
...
168       ❺ 496   83328  ❻ 1311    5819361
...</pre><p>This network had 367 46-octet flows (❶), for a total of 16,882 (❷) octets.</p><p>In a small flow, the number of flows (❸) probably equals the number of packets (❹), and each of these tiny flows has only one packet. When flows contain more data, each flow (❺) contains multiple packets (❻).</p></div><div class="sect3" title="Packets per Flow: packets"><div class="titlepage"><div><div><h3 class="title"><a id="packets_per_flow_colon_packets"/>Packets per Flow: packets</h3></div></div></div><p>The number of packets in a flow offers an idea of what kind of transactions is most common on your network. The sample DNS queries you looked at in <a class="xref" href="ch01.html" title="Chapter 1. FLOW FUNDAMENTALS">Chapter 1</a> had only one packet in each flow, while long-running FTP sessions might have thousands or millions of packets. The packets per flow report <code class="literal">packets</code> tells you how many flows have each number of packets, as shown here:</p><a id="I_programlisting5_d1e7791"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=packets -v SORT=-key</code></strong>
packets/flow flows octets   packets duration
1          ❶ 74213 6978064  74213   19224735
2            3411  551388   6822    190544194
3            4764  2033952  14292   37130046
...</pre><p>As you can see at ❶, this data contains 74,213 one-packet flows, carrying almost 7 million octets. (That sounds so much more impressive than 6.5MB, doesn't it?)</p></div></div><div class="sect2" title="Traffic Speed Reports"><div class="titlepage"><div><div><h2 class="title"><a id="traffic_speed_reports"/>Traffic Speed Reports</h2></div></div></div><p>I've had managers ask "How fast is the network?" so often that I've given up telling them that the question is meaningless. Saying that you have a gigabit Ethernet backbone sounds good, but it's like saying that your car's speedometer goes up to 120 miles per hour without mentioning that the engine starts making a sickly ratcheting cough at 40 miles per hour. Here are some ways to take a stab at answering that question in something approaching a meaningful way.</p><div class="sidebar"><a id="network_speed_caveats"/><p class="title">NETWORK SPEED CAVEATS</p><p>Remember, a long-running connection can pass traffic at different speeds through its lifetime. You've probably seen this yourself when downloading a CD or DVD image from the Internet. The connection might start off very quick, become slower partway through for any number of reasons, and accelerate again later. Flow records include only average speed information. For example, to determine how many packets a flow passed in a second, <code class="literal">flow-report</code> divides the number of seconds the flow lasted by the number of packets in the flow. This is good enough for most purposes, however, and it's certainly better than you'll get with anything short of packet capture.<a class="indexterm" id="IDX-CHP-5-0117"/><a class="indexterm" id="IDX-CHP-5-0118"/><a class="indexterm" id="IDX-CHP-5-0119"/><a class="indexterm" id="IDX-CHP-5-0120"/><a class="indexterm" id="IDX-CHP-5-0121"/></p><p>Many of these reports are not terribly informative to the naked eye. When you're looking at a list of TCP ports that accepted connections, you can quickly say that, for example, ports 80 and 25 received 75 percent of your traffic. These reports are not so readily interpreted, though they do make good fodder for graphs. I've written these descriptions assuming you'll be feeding the results into a graphing program such as <code class="literal">gnuplot</code> or OpenOffice.org Calc. Those of you who can interpret these results without further processing can congratulate yourself on being either much smarter or much dumber than myself.</p></div><div class="sect3" title="Counting Packets: pps"><div class="titlepage"><div><div><h3 class="title"><a id="counting_packets_colon_pps"/>Counting Packets: pps</h3></div></div></div><p>Another critical measure of network throughput is packets per second (pps). Many network vendors describe the limits of their equipment in packets per second. The <code class="literal">pps</code> report, much like the <code class="literal">bps</code> report, shows how many flows travel at the given number of packets per second.<a class="indexterm" id="IDX-CHP-5-0122"/></p><a id="I_programlisting5_d1e7851"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=pps -v SORT=+key</code></strong>
  pps/flow flows octets    packets duration
❶ 3000   1     231      ❷ 3    ❸ 1
  1000     70    4192      70      70
  833      1     403       5       6
  ...</pre><p>Wow! One flow went at 3,000 packets per second (❶)? Yes, technically, but note that it contained only three packets (❷) and lasted for one millisecond (❸). Multiplying anything by a thousand exaggerates its impact.</p><p>Again, this report isn't terribly useful to the naked eye but can be interesting when graphed.</p></div><div class="sect3" title="Traffic at a Given Time: linear-interpolated-flows-octets-packets"><div class="titlepage"><div><div><h3 class="title"><a id="traffic_at_a_given_time_colon_linear-int"/>Traffic at a Given Time: linear-interpolated-flows-octets-packets</h3></div></div></div><p>The <code class="literal">linear-interpolated-flows-octets-packets</code> report averages all the flows fed into it and lists how many flows, octets, and packets passed each second. I find this the most useful "speed" report.</p><a id="I_programlisting5_d1e7868"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=linear-interpolated-flows-octets-packets</code></strong>
unix-secs  flows      octets        packets
1334981479 35.605553  35334.016293  96.820015
1334981480 63.780553  62865.828793  184.570015
1334981481 38.702116  69297.703533  192.235604
...</pre><p>The first column gives the time, in Unix epochal seconds: <code class="literal">1334981479</code> is equivalent to Saturday, April 21, 2012, at 11 minutes and 19 seconds after midnight, EDT. Each row that follows is one second later. In this second, I passed 35.6 flows, 35334 octets, and 96.8 packets.<a class="indexterm" id="IDX-CHP-5-0123"/><a class="indexterm" id="IDX-CHP-5-0124"/><a class="indexterm" id="IDX-CHP-5-0125"/><a class="indexterm" id="IDX-CHP-5-0126"/></p><p>This report is ideal for answering many frequently asked questions, such as "How much traffic goes between our desktops and the domain controllers at remote sites?" Take the flow data from your internal connection, run it through <code class="literal">flow-nfilter</code> once to reduce it to traffic from your desktop address ranges, and then run it through again to trim that down to traffic with your remote domain controllers. Finally, feed the results into <code class="literal">flow-report</code>, and use the resulting report to generate graphable data.</p><p>A little creativity will give you data on things you never expected you could see. For example, TCP resets are a sign of something being not quite right; either a client is misconfigured, a server daemon has stopped working, or a TCP connection has become so scrambled that one side or the other says "Hang up, I'm done."</p><p>You can use <code class="literal">flow-nfilter</code> to strip your flows down to TCP resets. (One TCP reset is one packet.) Run this report with <code class="literal">-v FIELDS=-octets,-flows</code> to display only the number of TCP resets in a given second, and you'll then have graphable data on TCP resets on your network.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Although the quality of a network administrator's work is difficult to measure, I suggest offering "before" and "after" pictures of TCP reset activity during your performance reviews.<sup>[<a class="footnote" href="#ftn.CHP-5-FN-2" id="CHP-5-FN-2">9</a>]</sup></p></div></div></div><div class="sect2" title="Routing, Interfaces, and Next Hops"><div class="titlepage"><div><div><h2 class="title"><a id="routing_comma_interfaces_comma_and_next"/>Routing, Interfaces, and Next Hops</h2></div></div></div><p>Flow records include information on which interfaces a packet uses. In simple cases, this information isn't terribly useful: If you have a router with one Internet connection and one Ethernet interface, you have a really good idea how packets flowed without any fancy network analysis. A router using BGP, with multiple Internet providers, will distribute outgoing traffic to all Internet providers based on its routing information. Most people use <code class="literal">traceroute</code> to identify which path the router takes to a particular destination. BGP routing is dynamic, however; the path a packet takes now might not be the path it took five minutes ago or during an outage. Routers that support NetFlow version 5 or newer include interface information with each flow, however, so you can retroactively identify the route a flow used. (Remember, software flow sensors, such as <code class="literal">softflowd</code>, do not have access to interface information.)<a class="indexterm" id="IDX-CHP-5-0127"/><a class="indexterm" id="IDX-CHP-5-0128"/></p><div class="sect3" title="Interfaces and Flow Data"><div class="titlepage"><div><div><h3 class="title"><a id="interfaces_and_flow_data"/>Interfaces and Flow Data</h3></div></div></div><p>In <a class="xref" href="ch04.html" title="Chapter 4. FILTERING FLOWS">Chapter 4</a>, you filtered on router interfaces. Reporting on interfaces is the natural extension.</p><p>Remember, each router represents its interfaces with numbers. You might think of a router interface as Serial 0, but the router might call it Interface 8. A Cisco router might renumber its interfaces after a reboot, unless you use the <code class="literal">snmp ifIndex persist</code> option.<a class="indexterm" id="IDX-CHP-5-0129"/><a class="indexterm" id="IDX-CHP-5-0130"/><a class="indexterm" id="IDX-CHP-5-0131"/><a class="indexterm" id="IDX-CHP-5-0132"/><a class="indexterm" id="IDX-CHP-5-0133"/><a class="indexterm" id="IDX-CHP-5-0134"/><a class="indexterm" id="IDX-CHP-5-0135"/></p><p>I'm using the router from <a class="xref" href="ch04.html" title="Chapter 4. FILTERING FLOWS">Chapter 4</a> as a source of flow information. On this router, interfaces 1 and 2 are local Ethernet ports, and interfaces 7 and 8 are T1 circuits to two different Internet service providers.</p></div><div class="sect3" title="The First Interface: input-interface"><div class="titlepage"><div><div><h3 class="title"><a id="the_first_interface_colon_input-interfac"/>The First Interface: input-interface</h3></div></div></div><p>To see which interface a flow entered a router on, use the <code class="literal">input-interface</code> report. Here, I'm adding a filter to report on data only for a single router:</p><a id="I_programlisting5_d1e7991"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-nfilter -F router1-exports | flow-report -v TYPE=input-interface</code></strong>
input-interface flows octets    packets duration
1               22976 136933632 306843  58766984
2               320   182048    1307    3214392
7               4934  59690118  165408  46161632
8               1316  7386629   11142   7592624</pre><p>Most of these flows start on interface 1, with the fewest on interface 2.</p></div><div class="sect3" title="The Last Interface: output-interface"><div class="titlepage"><div><div><h3 class="title"><a id="the_last_interface_colon_output-interfac"/>The Last Interface: output-interface</h3></div></div></div><p>To show the interfaces that are being used to leave a router, use the <code class="literal">output-interface</code> report.</p><a id="I_programlisting5_d1e8006"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-nfilter -F router1-exports | flow-report -v TYPE=output-interface</code></strong>
  output-interface flows octets   packets duration
❶ 0                1765  447958   5043    3599588
  1                5057  66979701 175073  52900988
  2                17545 20507633 56531   9440036
  7                111   43079633 34710   8266712
  8                5068  73177502 213343  41528308</pre><p>The first thing I notice in this output is the sudden appearance of interface 0 at ❶. This is a list of valid router interfaces, and 0 isn't one of them. What gives?</p><p>These are flows that arrived at the router and never left. The appearance of interface 0 prompted me to more closely scrutinize my flow data, and I found flows that appeared to come from IP addresses reserved for internal, private use. Closer inspection of the firewall revealed several rules that allowed internal traffic to reach the Internet-facing network segment without address translation, but the router dropped all traffic from these internal-only RFC1918 addresses. I also found quite a few traffic streams from the public Internet that were sourced from these private IP addresses, but the router dropped them too, as I would expect.</p><p>The lesson to learn is, of course, that proper reporting will do nothing but make more work for you. But at least you'll be able to identify and fix problems before an outsider can use those problems against you.<a class="indexterm" id="IDX-CHP-5-0136"/><a class="indexterm" id="IDX-CHP-5-0137"/><a class="indexterm" id="IDX-CHP-5-0138"/><a class="indexterm" id="IDX-CHP-5-0139"/></p></div><div class="sect3" title="The Throughput Matrix: input/output-interface"><div class="titlepage"><div><div><h3 class="title"><a id="the_throughput_matrix_colon_input_solidu"/>The Throughput Matrix: input/output-interface</h3></div></div></div><p>Putting the <code class="literal">input/output-interface</code> reports together into a matrix showing which traffic arrived on which interface can be illuminating. Use the <code class="literal">input/output-interface</code> report for this. Here, I'm sorting the output by the number of flows so you can easily tell which pairs of interfaces see the greatest number of connections.</p><a id="I_programlisting5_d1e8042"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-nfilter -F router1-exports</code></strong>
 <strong class="userinput"><code>| flow-report -v TYPE=input/output-interface -v SORT=+flows</code></strong>
  input-interface output-interface flows octets   packets duration
❶ 1            ❷  2                17539 20507195 56522   9438220
❸ 1               8                4801  73147574 212806  41001424
  7               1                3888  59604956 164102  45390152
  8               1                1169  7374745  10971   7510836
  7               0                1040  84724    1297    769664
  1               0                525   199230   2805    60628
  2               8                267   29928    537     526884
  8               0                147   11884    171     81788
  1               7                111  ❹43079633 34710   8266712
  2               0                53    152120   770     2687508
  7               2                6     438      9       1816</pre><p>The busiest connection is between interface 1 (FastEthernet0/0) and interface 2 (FastEthernet0/1), shown at ❶ and ❷. This might or might not make sense, depending on your network topology. In mine, it's expected. You then route traffic out one of the Internet circuits at ❸.</p><p>This report clearly indicates the difference between flows and bytes. As you can see at ❹, one of the connections with a relatively few flows is actually pushing a comparatively large amount of traffic.</p><p>Note the absence of flows between interfaces 7 and 8. This indicates traffic entering on one of the Internet circuits and leaving by the other. You would have become a transit provider, carrying Internet traffic from one network to another. This would happen if, say, you sold a T1 to a third party and they sent their traffic through you to the Internet. If you're not an Internet backbone, this would be a serious problem.</p></div><div class="sect3" title="The Next Address: ip-next-hop-address"><div class="titlepage"><div><div><h3 class="title"><a id="the_next_address_colon_ip-next-hop-addre"/>The Next Address: ip-next-hop-address</h3></div></div></div><p>Reporting by interface gives you a good general idea of where traffic is going, and reporting by IP address offers a detailed view. For an intermediate view, use the <code class="literal">ip-next-hop-address</code> report. You do not need to filter this report by the router offering the flows, because the report doesn't confuse the results with interface numbers. This report effectively tells you where the network traffic is going, both for your local hosts and for your upstream providers. I've sorted this report by octets so that the highest-bandwidth next hops appear first.<a class="indexterm" id="IDX-CHP-5-0140"/><a class="indexterm" id="IDX-CHP-5-0141"/></p><a id="I_programlisting5_d1e8072"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-next-hop-address | -v SORT=+octets</code></strong>
  ip-next-hop-address flows octets    packets duration
❶ 192.0.2.4           2490  154742050 174836  31131852
❷ 95.116.11.45        5068  73177502  213343  41528308
  192.0.2.37          5944  65552868  73357   13692932
❸ 12.119.119.161      111   43079633  34710   8266712
  192.0.2.13          2370  21382159  21595   4996548
  192.0.2.194         17545 20507633  56531   9440036
❹ 66.125.104.149      17534 20506982  56521   9447180
  ...</pre><p>As you can see in this report at ❶, the most heavily used next hop is the proxy server. This isn't a great surprise.</p><p>The second most heavily used next hop isn't even an address on my network. It's the ISP's side of one of my T1 circuits, as shown at ❷. This hop represents traffic leaving my network. I also have IP addresses for the second (❸) and third ISPs (❹).</p></div><div class="sect3" title="Where Traffic Comes from and How It Gets There: ip-source-address/output-interface"><div class="titlepage"><div><div><h3 class="title"><a id="where_traffic_comes_from_and_how_it_gets"/>Where Traffic Comes from and How It Gets There: ip-source-address/output-interface</h3></div></div></div><p><code class="literal">flow-report</code> includes reports based on IP addresses and interfaces. Because these reports are so similar, I'll cover two in detail, and I'll let you figure out the rest.</p><p>The <code class="literal">ip-source-address/output-interface</code> report shows the source address of a flow and the interface the flow left the router on. If you filter your underlying flow data by an individual host of interest and run that data through this report, you'll get information on how much traffic this one host sent to each of your Internet circuits as well as information on how much data that host received from each remote host. In the following report, I'm filtering by the router exporting the flows to avoid interface number confusion and by the IP address of my main external NAT address:</p><a id="I_programlisting5_d1e8093"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-nfilter -F router1-exports</code></strong>
 <strong class="userinput"><code>| flow-nfilter -F ip-addr -v ADDR=192.0.2.4 | flow-report -v</code></strong>
 <strong class="userinput"><code>TYPE=ip-source-address/output-interface</code></strong>
  ip-source-address output-interface flows octets  packets duration
❶ 192.0.2.4       2                3553  422428  5849    1881348
❷ 192.0.2.4       8                324   3826147 69225   2851980
❸ 198.22.63.8     1                137   56475   762     915472
  ...
❹ 192.0.2.4       7                2     124     2       0
  ...</pre><p>The first entry at ❶ gives the proxy server itself as a source address and shows that I sent many flows out interface 2. That's an Ethernet to another local network segment. You also see at ❷ that the proxy sent large amounts of traffic out interface 8, one of the Internet connections.<a class="indexterm" id="IDX-CHP-5-0142"/><a class="indexterm" id="IDX-CHP-5-0143"/><a class="indexterm" id="IDX-CHP-5-0144"/><a class="indexterm" id="IDX-CHP-5-0145"/></p><p>You'll see entries at ❸ for remote IP addresses that send a comparatively small number of flows.</p><p>The surprising entry here is at ❹ where the proxy server sends a really small amount of traffic out interface 7, the other Internet circuit. Measurements show that this other circuit is consistently heavily used. Whatever is using this circuit isn't the main proxy server, however. I could identify the traffic going out over this circuit by removing the filter on the main proxy server and adding a filter for interface 7. I'll do that with a different report.</p></div><div class="sect3" title="Where Traffic Goes, and How It Gets There: ip-destination-address/input-interface"><div class="titlepage"><div><div><h3 class="title"><a id="where_traffic_goes_comma_and_how_it_gets"/>Where Traffic Goes, and How It Gets There: ip-destination-address/input-interface</h3></div></div></div><p>After viewing the results of the previous report, I'm curious about what hosts exchange traffic over interface 7. In <a class="xref" href="ch04.html" title="Chapter 4. FILTERING FLOWS">Chapter 4</a>, I created a filter that passed all traffic crossing interface 7. You'll use that filter on traffic from this router together with a flow report to see what's happening. Rather than reporting on the source address and the output interface, you'll use <code class="literal">ip-destination-address/input-interface</code> to see where traffic arriving on a particular interface is going. The resulting command line might be long enough to scare small children, but it will answer the question.</p><a id="I_programlisting5_d1e8134"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-nfilter -F router1-exports</code></strong>
 <strong class="userinput"><code>| flow-nfilter -F interface7 | flow-report -v TYPE=ip-dest</code></strong>
<strong class="userinput"><code>ination-address/input-interface -v SORT=+octets</code></strong>
ip-source-address input-interface flows octets   packets duration
192.0.2.7         7                2     27347244 22122   3601016
69.147.97.45      1                2     19246168 12853   232400
192.0.2.8         7                2     15442834 11779   3600988
76.122.146.90     1                2     14113638 56214   3601884
...</pre><p>Remember, I designed the filter <code class="literal">interface7</code> so that it matched traffic either entering or leaving over interface 7. That's why this report includes both output interfaces 1 and 7.</p><p>Two local hosts, both web servers, receive most of the traffic sent to you over this router interface. More investigation shows that the Internet provider for this line has good connectivity to home Internet providers, such as Comcast and AT&amp;T. The other provider has better connectivity to business customers. (How do you know what kind of connectivity your providers have? You can extract this information from the BGP information in flow records.)</p></div><div class="sect3" title="Other Address and Interface Reports"><div class="titlepage"><div><div><h3 class="title"><a id="other_address_and_interface_reports"/>Other Address and Interface Reports</h3></div></div></div><p>Flow-report includes two more reports for interfaces and addresses, <code class="literal">ip-source-address/input-interface</code> and <code class="literal">ip-destination-address/output-interface</code>. After the previous two examples, you should have no trouble using or interpreting these reports.</p></div></div><div class="sect2" title="Reporting Sensor Output"><div class="titlepage"><div><div><h2 class="title"><a id="reporting_sensor_output"/>Reporting Sensor Output</h2></div></div></div><p>If you have multiple sensors feeding a single collector, you might want to know how much data each sensor transmits. Use the <code class="literal">ip-exporter-address</code> report to find that out.<a class="indexterm" id="IDX-CHP-5-0146"/><a class="indexterm" id="IDX-CHP-5-0147"/><a class="indexterm" id="IDX-CHP-5-0148"/><a class="indexterm" id="IDX-CHP-5-0149"/><a class="indexterm" id="IDX-CHP-5-0150"/><a class="indexterm" id="IDX-CHP-5-0151"/><a class="indexterm" id="IDX-CHP-5-0152"/><a class="indexterm" id="IDX-CHP-5-0153"/><a class="indexterm" id="IDX-CHP-5-0154"/><a class="indexterm" id="IDX-CHP-5-0155"/></p><a id="I_programlisting5_d1e8216"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -v TYPE=ip-exporter-address</code></strong>
ip-exporter-address flows octets    packets duration
192.0.2.3          29546 204192427 484700  115735632
192.0.2.12         36750 202920788 231118  39230288</pre><p>As you can see in this report, records from the first router included fewer flows but more octets than those from the second router. Your results will vary depending on the throughput of each of your routers, the kind of traffic they carry, and their sampling rate.</p></div><div class="sect2" title="BGP Reports"><div class="titlepage"><div><div><h2 class="title"><a id="bgp_reports"/>BGP Reports</h2></div></div></div><p>Flow records exported from BGP-speaking hardware include Autonomous System (AS) information. Reporting on this information tells you which remote networks you are communicating with and even how you reached those networks. If your network does not use BGP, these report types are of no use to you, and you can skip the rest of this chapter.</p><p>Flow-tools includes many reports and tools of interest to transit providers, but few if any readers of this book are transit providers. BGP-using readnsers are probably clients of multiple ISPs and use multiple providers for redundancy. I'll cover flow BGP information from the BGP user's perspective. Transit providers reading this book<sup>[<a class="footnote" href="#ftn.CHP-5-FN-3" id="CHP-5-FN-3">10</a>]</sup> are encouraged to read the <code class="literal">flow-report</code> manual page for a complete list of reports involving AS numbers.</p><div class="sect3" title="Using AS Information"><div class="titlepage"><div><div><h3 class="title"><a id="using_as_information"/>Using AS Information</h3></div></div></div><p>What possible use can this type of AS information be for a network engineer? Knowing who you exchange traffic with might have little impact on day-to-day troubleshooting, but it has a great impact on who you purchase bandwidth from.</p><p>When the time comes to choose Internet providers, run reports to see who you consistently exchange the most traffic with. If you know that you consistently need good connectivity to three particular remote networks, use them as bullet points in your negotiations with providers. If you don't make bandwidth purchasing decisions, provide the decision maker with this information. The statement "40 percent of our Internet traffic goes to these three companies" is much more authoritative than "I worked with company X before, and they were pretty good."</p></div><div class="sect3" title="Traffic's Network of Origin: source-as"><div class="titlepage"><div><div><h3 class="title"><a id="traffic_apostrophy_s_network_of_origin_c"/>Traffic's Network of Origin: source-as</h3></div></div></div><p>The <code class="literal">source-as</code> report identifies the AS where flows originated. I'll sort this report by octets, because that's how I pay for bandwidth.</p><a id="I_programlisting5_d1e8252"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-nfilter -F router1-exports</code></strong>
 <strong class="userinput"><code>| flow-report -v TYPE=source-as -v SORT=+octets</code></strong>
  source-as flows octets    packets duration
❶ 0         23024 137077373 307572  61361020
❷ 14779     2     19246168  12853   232400
  33668     136   15664027  64345   14486504
  21502     2     5087464   3450    47692
  ...</pre><p>The invalid AS <code class="literal">0</code> appears first at ❶. When traffic originates or terminates locally, flow sensors do not record an AS number for the local end of that traffic, which means that your local AS number will never appear in a flow report. The source AS of traffic you transmit shows up as <code class="literal">0</code>, and the destination address of traffic you receive is also shown as <code class="literal">0</code>. The only time you will see both a source and a destination AS number in a flow record is if the exporter is a transit provider, such as an Internet backbone. Traffic coming from AS <code class="literal">0</code> is the total of all traffic sourced by your network and transmitted to other networks. You might want to filter out all flows with a source AS of <code class="literal">0</code> from your data before running the report to remove the information about the data that your network transmits.<a class="indexterm" id="IDX-CHP-5-0156"/><a class="indexterm" id="IDX-CHP-5-0157"/></p><p>In the hour shown in the earlier report, the largest amount of traffic originated from AS <code class="literal">14779</code> (Inktomi/Yahoo!, shown at ❷), but it included only two flows. I suspect that if you were to filter this same data on AS <code class="literal">14779</code> and run <code class="literal">flow-print</code> against it, you'd see that someone had downloaded a file, and I would further guess that the proxy logs would show that someone needed printer software. You can repeat this exercise for each of the AS numbers in the list.</p></div><div class="sect3" title="Destination Network: destination-as"><div class="titlepage"><div><div><h3 class="title"><a id="destination_network_colon_destination-as"/>Destination Network: destination-as</h3></div></div></div><p>To see where you're sending traffic to, use the <code class="literal">destination-as</code> report. For a slightly different view of traffic, sort by the number of flows.</p><a id="I_programlisting5_d1e8303"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-nfilter -F router1-exports</code></strong>
 <strong class="userinput"><code>| flow-report -v TYPE=destination-as -v SORT=+flows</code></strong>
  destination-as flows octets   packets duration
❶ 702            11834 767610   11869   23248
❷ 0              6828  67428097 180125  56502392
❸ 701            4154  459973   6372    1893152
  3209           397   553003   9751    1220164
  ...</pre><p>As you can see at ❶, you sent more flows to AS <code class="literal">702</code> than you received from everybody else combined (shown at ❷). Also note at ❸ that AS <code class="literal">701</code> belongs to the same organization as AS <code class="literal">702</code>, but <code class="literal">flow-report</code> does not aggregate them. Different autonomous systems within one organization almost certainly have slightly different routing policies, despite the best efforts of their owner to coordinate their technical teams.</p></div><div class="sect3" title="BGP Reports and Friendly Names"><div class="titlepage"><div><div><h3 class="title"><a id="bgp_reports_and_friendly_names"/>BGP Reports and Friendly Names</h3></div></div></div><p>The BGP reports can use friendly names, which will save you the trouble of looking up the owner of interesting AS numbers. Although <code class="literal">whois</code> is a fast command-line tool for checking the ownership of AS numbers and you can look up AS information on any number of registry websites, none of these interfaces is suitable for automation. <code class="literal">flow-tools</code> gets around this by keeping a static list of AS assignments in the file <span class="emphasis"><em>asn.sym</em></span>. Registries are continuously assigning and revoking AS numbers, however, so the list included with <code class="literal">flow-tools</code> will quickly become obsolete. To get the best information on AS names, you must update <code class="literal">flow-tools</code>' list of AS numbers.<a class="indexterm" id="IDX-CHP-5-0158"/><a class="indexterm" id="IDX-CHP-5-0159"/><a class="indexterm" id="IDX-CHP-5-0160"/><a class="indexterm" id="IDX-CHP-5-0161"/><a class="indexterm" id="IDX-CHP-5-0162"/><a class="indexterm" id="IDX-CHP-5-0163"/><a class="indexterm" id="IDX-CHP-5-0164"/><a class="indexterm" id="IDX-CHP-5-0165"/><a class="indexterm" id="IDX-CHP-5-0166"/><a class="indexterm" id="IDX-CHP-5-0167"/></p><p>To update the list of AS numbers, first download the latest list of ARIN assignments from <a class="ulink" href="ftp://ftp.arin.net/info/asn.txt">ftp://ftp.arin.net/info/asn.txt</a>, and save it on your analysis server.</p><p>Flow-tools includes <span class="emphasis"><em>gasn</em></span>, a small script to strip out all of ARIN's comments and instructions and convert ARIN's list to a format it understands. The standard <code class="literal">flow-tools</code> installation process doesn't install this rarely used program in one of the regular system program directories, but you can probably find it under <span class="emphasis"><em>/usr/local/flow-tools/share/flow-tools</em></span> if you installed from source. Use <code class="literal">locate gasn</code> to find the program if you installed from an operating system package.</p><p>Here, you feed ARIN's <span class="emphasis"><em>asn.txt</em></span> in the current directory to the <span class="emphasis"><em>gasn</em></span> script located in <span class="emphasis"><em>/usr/local/flow-tools/share/gasn</em></span> and produce a new file, <span class="emphasis"><em>newasn.sym</em></span>:</p><a id="I_programlisting5_d1e8416"/><pre class="programlisting"># <strong class="userinput"><code>cat asn.txt | perl /usr/local/share/flow-tools/gasn &gt; newasn.sym</code></strong></pre><p>Take a look at your <span class="emphasis"><em>newasn.sym</em></span> file. The contents should resemble these:</p><a id="I_programlisting5_d1e8425"/><pre class="programlisting">0 IANA-RSVD-0
1 LVLT-1
2 DCN-AS
3 MIT-GATEWAYS
...</pre><p>As of this writing, this file contains more than 64,000 AS numbers, each on its own line.</p><p>Your system should already have an existing <span class="emphasis"><em>asn.sym</em></span> file, possibly in <span class="emphasis"><em>/usr/local/etc/flow-tools/</em></span> or <span class="emphasis"><em>/usr/local/flow-tools/etc/sym/</em></span>. Replace that file with your new file. When you add the <code class="literal">+names</code> option to <code class="literal">flow-report</code>, you should see the current AS names.</p><a id="I_programlisting5_d1e8446"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-nfilter -F router1-exports</code></strong>
 <strong class="userinput"><code>| flow-report -v TYPE=source-as -v SORT=+octets -v OPTIONS=+names</code></strong>
source-as                     flows octets    packets duration
IANA-RSVD-0                   23024 137077373 307572  61361020
INKTOMI-LAWSON                2     19246168  12853   232400
MICROSOFT-CORP---MSN-AS-BLOCK 64    4669359   3259    106792
GOOGLE                        130   4052114   3184    616152
...</pre><p>Not all AS numbers have sensible names, especially those that are acronyms or words in foreign languages, but you can easily pick out some of the obvious ones and identify the others with <code class="literal">whois</code>.<a class="indexterm" id="IDX-CHP-5-0168"/><a class="indexterm" id="IDX-CHP-5-0169"/><a class="indexterm" id="IDX-CHP-5-0170"/><a class="indexterm" id="IDX-CHP-5-0171"/><a class="indexterm" id="IDX-CHP-5-0172"/><a class="indexterm" id="IDX-CHP-5-0173"/><a class="indexterm" id="IDX-CHP-5-0174"/><a class="indexterm" id="IDX-CHP-5-0175"/></p></div></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-5-FN-2" id="ftn.CHP-5-FN-2">9</a>] </sup>Remember that a certain level of TCP reset activity is normal, and much of it is caused by buggy or graceless software. Do <span class="emphasis"><em>not</em></span> let your boss give you a goal of "zero TCP resets" during your performance review.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-5-FN-3" id="ftn.CHP-5-FN-3">10</a>] </sup>Both of you.</p></div></div></div>
<div class="sect1" title="Customizing Reports"><div class="titlepage"><div><div><h1 class="title"><a id="customizing_reports"/>Customizing Reports</h1></div></div></div><p>I use command-line reports for occasional analysis on an ad hoc basis, such as when I'm trying to find patterns in problematic traffic. If you're going to regularly use a report with a long command line, I recommend creating a customized report. Writing truly custom detailed reports of the type I've been demonstrating requires programming, but <code class="literal">flow-report</code> lets you highly customize existing reports.</p><p>The <span class="emphasis"><em>stat.cfg</em></span> file contains flow report definitions. You'll probably find this file in <span class="emphasis"><em>/usr/local/flow-tools/etc/cfg</em></span> or <span class="emphasis"><em>/usr/local/etc/flow-tools</em></span>, depending on how you installed <code class="literal">flow-tools</code>. The only report that comes in <span class="emphasis"><em>stat.cfg</em></span> is the default report. Don't touch it; it's what makes the various command-line reports function. Add your custom changes below it.<a class="indexterm" id="IDX-CHP-5-0176"/></p><p>Setting variables on the command line does not work in customized reports because the reason to customize a report is to avoid typing all those command-line variables. You can create a report that will accept command-line modifications, but to do so, you'll need to understand how to write basic reports first. To create such a report, study the default report in <span class="emphasis"><em>stat.cfg</em></span>.<a class="indexterm" id="IDX-CHP-5-0177"/></p><div class="sect2" title="Custom Report: Reset-Only Flows"><div class="titlepage"><div><div><h2 class="title"><a id="custom_report_colon_reset-only_flows"/>Custom Report: Reset-Only Flows</h2></div></div></div><p>I frequently use <code class="literal">flow-report</code> to create graphable data on flows that contain only TCP resets. These flows can indicate misconfigured software, network equipment, or general system cussedness. Some of the best graphable data comes from the <code class="literal">liner-interpolated-flow-octets-packets</code> report. Let's create such a report. My goal is to be able to run the report very simply, like this:</p><a id="I_programlisting5_d1e8546"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -S resets-only</code></strong></pre><p>Use <code class="literal">-S</code> to tell <code class="literal">flow-report</code> that you're running a customized report. The new report will be named <code class="literal">resets-only</code>.</p><p>A minimal report in <span class="emphasis"><em>stat.cfg</em></span> looks like this:</p><a id="I_programlisting5_d1e8566"/><pre class="programlisting">❶ stat-report packets
❷     type linear-interpolated-flows-octets-packets
❸     output

❹ stat-definition resets-only
      report packets</pre><p>Much like a <code class="literal">flow-nfilter</code> filter, a customized flow report has two main components: the <code class="literal">stat-report</code> and the <code class="literal">stat-definition</code>. The <code class="literal">stat-report</code> at ❶ is somewhat like a filtering primitive. This customized <code class="literal">stat-report</code> is called <code class="literal">packets</code>, for reasons that will become clear later.</p><p>The <code class="literal">stat-report</code> needs to know what type of <code class="literal">flow-report</code> it is based on, as shown at ❷. The <code class="literal">resets-only</code> report starts life as the <code class="literal">linear-interpolated-flows-octets-packets</code> report. At ❸ we tell the <code class="literal">resets-only</code> report to produce output.<a class="indexterm" id="IDX-CHP-5-0178"/><a class="indexterm" id="IDX-CHP-5-0179"/><a class="indexterm" id="IDX-CHP-5-0180"/><a class="indexterm" id="IDX-CHP-5-0181"/><a class="indexterm" id="IDX-CHP-5-0182"/><a class="indexterm" id="IDX-CHP-5-0183"/><a class="indexterm" id="IDX-CHP-5-0184"/></p><p>The <code class="literal">stat-definition</code> at ❹ lets you aggregate multiple <code class="literal">stat-reports</code> into a single report. This definition includes only a single report, named <code class="literal">resets</code>. Even with this minimal definition, you can already run the <code class="literal">resets-only</code> report. The resulting numbers will be identical to setting <code class="literal">TYPE=linear-interpolated-flows-octets-packets</code> on the command line even though it appears slightly different.</p><a id="I_programlisting5_d1e8649"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -S resets-only</code></strong>
# recn: unix-secs*,flows,octets,packets
1228150499,35.605553,35334.016293,96.820015
1228150500,63.780553,62865.828793,184.570015
1228150501,38.702116,69297.703533,192.235604
...</pre><p>The first thing you'll notice in the previous report is that <code class="literal">flow-report</code> creates comma-separated value (CSV) reports by default. This is perfectly fine if you're going to feed the results to a graphing program, but CSV data gives me a headache when I have to read it. A graphing program can read tab-delimited data just as easily as CSV, so let's make the report produce human-friendly output.<a class="indexterm" id="IDX-CHP-5-0185"/></p><div class="sect3" title="Report Format and Output"><div class="titlepage"><div><div><h3 class="title"><a id="report_format_and_output"/>Report Format and Output</h3></div></div></div><p><code class="literal">flow-report</code> uses the external program <code class="literal">flow-rptfmt</code> to improve the output's appearance. Let's direct the output into <code class="literal">flow-rptfmt</code>.</p><a id="I_programlisting5_d1e8676"/><pre class="programlisting">stat-report packets
   type linear-interpolated-flows-octets-packets
   output
❶  path |/usr/local/bin/flow-rptfmt</pre><p>The <code class="literal">path</code> variable at ❶ tells <code class="literal">flow-report</code> where to send the output. By using a path that starts with a pipe symbol (<code class="literal">|</code>), you tell <code class="literal">flow-report</code> to feed its output to a program, just like a pipe on the command line. Everything after the pipe is run as a command. Here I'm using the standard report formatting software, <code class="literal">flow-rptfmt</code>. Adding a formatting program to the report produces this output:</p><a id="I_programlisting5_d1e8695"/><pre class="programlisting">#  ['/usr/local/bin/flow-rptfmt']
unix-secs  flows      octets        packets
1228150499 35.605553  35334.016293  96.820015
1228150500 63.780553  62865.828793  184.570015
1228150501 38.702116  69297.703533  192.235604
...</pre><p>You'll learn more about using <code class="literal">flow-rptfmt</code> and other output options in <a class="xref" href="ch05s06.html#customizing_report_appearance" title="Customizing Report Appearance">Customizing Report Appearance</a> in <a class="xref" href="ch05s06.html#customizing_report_appearance" title="Customizing Report Appearance">Customizing Report Appearance</a>.<a class="indexterm" id="IDX-CHP-5-0186"/><a class="indexterm" id="IDX-CHP-5-0187"/><a class="indexterm" id="IDX-CHP-5-0188"/><a class="indexterm" id="IDX-CHP-5-0189"/><a class="indexterm" id="IDX-CHP-5-0190"/><a class="indexterm" id="IDX-CHP-5-0191"/><a class="indexterm" id="IDX-CHP-5-0192"/></p></div><div class="sect3" title="Removing Columns"><div class="titlepage"><div><div><h3 class="title"><a id="removing_columns"/>Removing Columns</h3></div></div></div><p>You're interested in counting the number of TCP resets that occur over time. (One TCP reset is one packet.) The octets and packets columns are irrelevant, so remove them.</p><a id="I_programlisting5_d1e8739"/><pre class="programlisting">stat-report packets
   type linear-interpolated-flows-octets-packets
   output
❶  fields -octets,-flows
     path |/usr/local/bin/flow-rptfmt</pre><p>This works exactly like removing fields on the command line. The <code class="literal">fields</code> header at ❶ tells <code class="literal">flow-report</code> which columns to remove. Removing the octets and flows fields from this report gives you output much like the output shown next, and you now see only the data of interest:</p><a id="I_programlisting5_d1e8749"/><pre class="programlisting">#  ['/usr/local/bin/flow-rptfmt']
unix-secs  packets
1228150499 96.820015
1228150500 184.570015
1228150501 192.235604
...</pre></div><div class="sect3" title="Applying Filters to Reports"><div class="titlepage"><div><div><h3 class="title"><a id="applying_filters_to_reports"/>Applying Filters to Reports</h3></div></div></div><p>The report lists times and the number of packets, so you're headed in the right direction. But it's listing the total number of packets in the flow file, not just the TCP resets. You need to add a filter to strip away everything except the data you're interested in. You could use a filter on the command line, of course, but the purpose of a customized report is to reduce the amount of typing you do.</p><p><code class="literal">flow-report</code> lets you add a filter in either the <code class="literal">stat-report</code> or the <code class="literal">stat-definition</code>. I define my filter in the <code class="literal">stat-definition</code>. Recall from <a class="xref" href="ch04.html" title="Chapter 4. FILTERING FLOWS">Chapter 4</a> that you configured the <code class="literal">rst-only</code> filter to pass only TCP resets.</p><a id="I_programlisting5_d1e8774"/><pre class="programlisting">stat-definition reset-only
  filter rst-only
  report packets</pre><p>The report output now looks like this:</p><a id="I_programlisting5_d1e8778"/><pre class="programlisting">unix-secs  packets
1228150595 0.068702
1228150596 0.068702
1228150597 0.068702
...</pre><p>This network has a low number of TCP resets, but if you page through the results, you'll see peaks and valleys of reset-only flows. You'll use this data, among others, to create graphs in <a class="xref" href="ch08.html" title="Chapter 8. AD HOC FLOW VISUALIZATION">Chapter 8</a>.<a class="indexterm" id="IDX-CHP-5-0193"/><a class="indexterm" id="IDX-CHP-5-0194"/><a class="indexterm" id="IDX-CHP-5-0195"/><a class="indexterm" id="IDX-CHP-5-0196"/><a class="indexterm" id="IDX-CHP-5-0197"/><a class="indexterm" id="IDX-CHP-5-0198"/></p></div><div class="sect3" title="Combining stat-reports and stat-definitions"><div class="titlepage"><div><div><h3 class="title"><a id="combining_stat-reports_and_stat-definiti"/>Combining stat-reports and stat-definitions</h3></div></div></div><p>If you can use filters in either a <code class="literal">stat-report</code> or a <code class="literal">stat-definition</code>, why did I put the filter in my <code class="literal">stat-definition</code>?<a class="indexterm" id="IDX-CHP-5-0199"/></p><p>Look at the <code class="literal">packets stat-report</code>. I wrote it to display reset-only TCP flows, but it is really just a linearly interpolated packet count. You can use this same <code class="literal">stat-report</code> elsewhere to create customized reports on data filtered differently. For example, if you had a filter to show all your SYN-only flows, you could use the <code class="literal">packets stat-report</code> to create data for both.</p><a id="I_programlisting5_d1e8836"/><pre class="programlisting">stat-definition reset-only
  filter rst-only
  report packets

stat-definition syn-only
  filter syn-only
  report packets</pre><p>Both the <code class="literal">reset-only</code> and <code class="literal">syn-only</code> reports format and present their results identically. The only difference is the filter applied to create each report.</p></div></div><div class="sect2" title="More Report Customizations"><div class="titlepage"><div><div><h2 class="title"><a id="more_report_customizations"/>More Report Customizations</h2></div></div></div><p>Any customization you can perform on the command line will also work in a customized report, but the configuration file supports additional features as well.</p><div class="sect3" title="Reversing Sampling"><div class="titlepage"><div><div><h3 class="title"><a id="reversing_sampling"/>Reversing Sampling</h3></div></div></div><p>Some flow sensors sample flows only, sending just a fraction of their data to the flow collector (see <a class="xref" href="ch02.html" title="Chapter 2. COLLECTORS AND SENSORS">Chapter 2</a>). This is better than having no flow data but can confuse reporting. To improve this situation, you can tell <code class="literal">flow-report</code> to scale up its output to compensate for sampling. For example, if your router samples at a rate of 1:10, you can scale up the output by a factor of 10 to get traffic volumes roughly comparable to the original. The report here scales the source and destination IP addresses:</p><a id="I_programlisting5_d1e8861"/><pre class="programlisting">stat-report subnets
   type ip-source/destination-address
❶  scale 10
   output
     path |/usr/local/bin/flow-rptfmt

 stat-definition subnets
   report subnets</pre><p>The <code class="literal">scale</code> keyword at ❶ defines a scaling multiplier. Take a look at the output from this report:<a class="indexterm" id="IDX-CHP-5-0200"/><a class="indexterm" id="IDX-CHP-5-0201"/><a class="indexterm" id="IDX-CHP-5-0202"/></p><a id="I_programlisting5_d1e8881"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -S subnets</code></strong>
#  ['/usr/local/bin/flow-rptfmt']
ip-source-address ip-destination-address flows octets     packets duration
192.0.2.37        158.43.128.72          8702  5760730    88840   30096122
158.43.128.72     192.0.2.37             8649  10405130   88280   30096122
192.0.2.4         198.6.1.1              7625  5886410    79920   26370707
...</pre><p>I've copied this report to <code class="literal">subnets-unscaled</code> and removed the <code class="literal">scale</code> command. Let's compare the output.</p><a id="I_programlisting5_d1e8894"/><pre class="programlisting"># <strong class="userinput"><code>flow-cat * | flow-report -S subnets-unscaled</code></strong>
#  ['/usr/local/bin/flow-rptfmt']
ip-source-address ip-destination-address flows octets    packets duration
192.0.2.37        158.43.128.72          8702  576073    8884    30096122
158.43.128.72     192.0.2.37             8649  1040513   8828    30096122
192.0.2.4         198.6.1.1              7625  588641    7992    26370707
...</pre><p>The source and destination addresses are unchanged, as is the number of flows, but the octet and packet counts have increased tenfold in the scaled report. This gives you a mostly accurate view of the amount of traffic passing through your network. Although you're still entirely missing data on some flows, this is about as close to reality as you can get from sampled data.</p></div><div class="sect3" title="Filters in stat-report Statements"><div class="titlepage"><div><div><h3 class="title"><a id="filters_in_stat-report_statements"/>Filters in stat-report Statements</h3></div></div></div><p>To use a filter in a <code class="literal">stat-report</code> statement, you must place it before the output definition. For example, the following <code class="literal">filter</code> statement applies the specified filter to your data before reporting:</p><a id="I_programlisting5_d1e8912"/><pre class="programlisting">stat-report subnets
  type ip-source/destination-address
  <strong class="userinput"><code>filter</code></strong> web-traffic
  output
    path |/usr/local/bin/flow-rptfmt</pre></div><div class="sect3" title="Reporting by BGP Routing"><div class="titlepage"><div><div><h3 class="title"><a id="reporting_by_bgp_routing"/>Reporting by BGP Routing</h3></div></div></div><p>Perhaps you're interested in internetwork connectivity rather than connectivity between individual IP addresses. If your flow records include BGP information, you can have <code class="literal">flow-report</code> generate reports using network block data. To do so, set the <code class="literal">ip-source-address-format</code> and <code class="literal">ip-destination-address-format</code> options to <code class="literal">prefix-len</code>, and <code class="literal">flow-report</code> will print the netmask with each entry.<a class="indexterm" id="IDX-CHP-5-0203"/></p><a id="I_programlisting5_d1e8943"/><pre class="programlisting">stat-report subnets
   type ip-source/destination-address
❶  ip-source-address-format prefix-len
❷  ip-destination-address-format prefix-len
   output
     path |/usr/local/bin/flow-rptfmt</pre><p>Here you've told <code class="literal">flow-report</code> to include the netmask in the source (❶) and destination (❷) addresses. The report now looks like this:<a class="indexterm" id="IDX-CHP-5-0204"/><a class="indexterm" id="IDX-CHP-5-0205"/><a class="indexterm" id="IDX-CHP-5-0206"/></p><a id="I_programlisting5_d1e8961"/><pre class="programlisting">ip-source-address  ip-destination-address flows octets    packets duration
  63.125.104.150/12  87.169.213.77/10       9     1008      18      23760
❶ 192.0.2.37/25      158.43.128.72/16       8233  537169    8233    4
  192.0.2.4/25    ❷ 198.6.1.1/16           6634  485854    6658    168412
  ...</pre><p>You can see at ❶ that 192.0.2.37 is routed as a /25 network. Although a /25 is too small to be announced on the public Internet, these addresses are local. The router had better know the netmask of directly attached networks! You also see that, for example, the address 198.6.1.1 at ❷ is announced as a /16.</p><p>To have <code class="literal">flow-report</code> aggregate data by network, set the address format to <code class="literal">prefix-mask</code>. Here's the same report on the same data, using the <code class="literal">prefix-mask</code> format:</p><a id="I_programlisting5_d1e8976"/><pre class="programlisting">ip-source-address ip-destination-address flows octets    packets duration
❶ 63.112/12         87.128/10              15    1792      32      58384
❷ 192.0.2/25        158.43/16              23663 1532256   23707   17372
  192.0.2/25        198.6/16               8299  915307    12698   3711276
  ...</pre><p>Now you no longer see individual IP addresses. Instead, you see source address blocks as they are routed. You're sending traffic from some addresses inside the 63.112/12 range (❶) to addresses inside 87.128/10. <code class="literal">flow-report</code> has aggregated all the individual connections from one block to another.</p><p>Look at the second line of each of these reports. The first report shows that you sent 8,233 flows from the address 192.0.2.37 to the address 158.43.128.72. The report with the address mask set says that you sent 23,663 flows (❷) from addresses inside the block 192.0.2/25 to addresses inside 158.43/16. This line on the second report includes all the flows from the entry you checked in the first report, plus other flows that fit within those address blocks. They've been aggregated.</p></div></div><div class="sect2" title="Customizing Report Appearance"><div class="titlepage"><div><div><h2 class="title"><a id="customizing_report_appearance"/>Customizing Report Appearance</h2></div></div></div><p><code class="literal">flow-report</code> supports many options for customizing presentation. Use these options in the <code class="literal">stat-report</code> definition only beneath the word <code class="literal">output</code>. Using them earlier will generate an error.</p><div class="sect3" title="flow-rptfmt Options"><div class="titlepage"><div><div><h3 class="title"><a id="flow-rptfmt_options"/>flow-rptfmt Options</h3></div></div></div><p>Remember, setting <code class="literal">path</code> to a pipe followed by a program name tells <code class="literal">flow-report</code> to feed its output into that program. Everything after the pipe is executed as a regular shell command. This means you can do things such as redirect the output to a file.<a class="indexterm" id="IDX-CHP-5-0207"/><a class="indexterm" id="IDX-CHP-5-0208"/><a class="indexterm" id="IDX-CHP-5-0209"/><a class="indexterm" id="IDX-CHP-5-0210"/><a class="indexterm" id="IDX-CHP-5-0211"/><a class="indexterm" id="IDX-CHP-5-0212"/><a class="indexterm" id="IDX-CHP-5-0213"/><a class="indexterm" id="IDX-CHP-5-0214"/><a class="indexterm" id="IDX-CHP-5-0215"/><a class="indexterm" id="IDX-CHP-5-0216"/><a class="indexterm" id="IDX-CHP-5-0217"/><a class="indexterm" id="IDX-CHP-5-0218"/><a class="indexterm" id="IDX-CHP-5-0219"/><a class="indexterm" id="IDX-CHP-5-0220"/><a class="indexterm" id="IDX-CHP-5-0221"/><a class="indexterm" id="IDX-CHP-5-0222"/><a class="indexterm" id="IDX-CHP-5-0223"/></p><a id="I_programlisting5_d1e9089"/><pre class="programlisting">path |/usr/local/bin/flow-rptfmt &gt; /tmp/resets.txt</pre><p>The previous line would have the report appear in the file <span class="emphasis"><em>/tmp/resets.txt</em></span> rather than on the screen.</p><p>If you prefer, <code class="literal">flow-rptfmt</code> can produce a very simple HTML table of its output by adding the <code class="literal">-f html</code> arguments to activate this function, as shown next. ( You'll probably want to redirect the output to a file under your web server's root directory.)<a class="indexterm" id="IDX-CHP-5-0224"/></p><a id="I_programlisting5_d1e9107"/><pre class="programlisting">path |/usr/local/bin/flow-rptfmt -f html &gt; /var/www/resets/today.html</pre><p>Of course, dumping regularly produced reports to a single file probably isn't useful. What you really need is a way to send the output to a file based on timing information.</p></div><div class="sect3" title="Dump CSV to a File"><div class="titlepage"><div><div><h3 class="title"><a id="dump_csv_to_a_file"/>Dump CSV to a File</h3></div></div></div><p>Although <code class="literal">flow-rptfmt</code> is the standard tool for formatting reports, you might decide that the plain-text CSV works better for some purposes, such as for automated graph creation. If you set <code class="literal">path</code> to a filename, <code class="literal">flow-report</code> will dump raw CSV text straight to that file, which is most useful if you automatically process the data.</p><a id="I_programlisting5_d1e9125"/><pre class="programlisting">path /tmp/reset.csv</pre></div><div class="sect3" title="Using Time to Direct Output"><div class="titlepage"><div><div><h3 class="title"><a id="using_time_to_direct_output"/>Using Time to Direct Output</h3></div></div></div><p>A <code class="literal">stat-report</code> definition can create and use timing information when saving CSV files using the <code class="literal">time</code> option and special characters in the <code class="literal">path</code> setting.</p><p>Before using this definition, decide which time you want <code class="literal">flow-report</code> to use. Do you want to use the current time or the time in the flow files? If the time in the flow files, do you want the time when the flows begin or end? Control this with the <code class="literal">time</code> option using one of four different time values: <code class="literal">now</code> (the time when the report is run), <code class="literal">start</code> (the time the first flow begins), <code class="literal">end</code> (the time the last flow ends), or <code class="literal">mid</code> (the average of the start and end times, the default). For most uses, the default is fine.</p><p>The path value can accept variables from the <code class="literal">strftime</code> library. <a class="xref" href="ch05s06.html#some_strftime_variables_for_flow-report" title="Table 5-1. Some strftime Variables for flow-report">Table 5-1</a> lists the most common ones. If you need a time representation that isn't listed in this table, such as the day of the year, the day of the week as a numerical value, or the current time zone as expressed as minutes offset from universal time, read the manual page.</p><div class="table"><a id="some_strftime_variables_for_flow-report"/><p class="title">Table 5-1. Some <code class="literal">strftime</code> Variables for <code class="literal">flow-report</code></p><div class="table-contents"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; " summary="Some strftime Variables for flow-report"><colgroup><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Variable<a class="indexterm" id="IDX-CHP-5-0225"/><a class="indexterm" id="IDX-CHP-5-0226"/></p></th><th style="text-align: left" valign="bottom"><p>Replaced with</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p><code class="literal">%a</code></p></td><td style="text-align: left" valign="top"><p>Abbreviated day name (Mon, Tue, and so on)</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">%b</code></p></td><td style="text-align: left" valign="top"><p>Abbreviated month name (Jan, Feb, and so on)</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">%d</code></p></td><td style="text-align: left" valign="top"><p>Day of the month as a number (131)</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">%H</code></p></td><td style="text-align: left" valign="top"><p>Hour as per 24-hour clock (00–23)</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">%M</code></p></td><td style="text-align: left" valign="top"><p>Minutes (0–59)</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">%m</code></p></td><td style="text-align: left" valign="top"><p>Month (1–12)</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">%Y</code></p></td><td style="text-align: left" valign="top"><p>Four-digit year (0–9999)</p></td></tr><tr><td style="text-align: left" valign="top"><p><code class="literal">%y</code></p></td><td style="text-align: left" valign="top"><p>Two-digit year (00–99)</p></td></tr></tbody></table></div></div><p><code class="literal">flow-report</code> can use the <code class="literal">strftime</code> variable values to direct output. For example, suppose you want to have the report output directed into a file with a name based on the time, in a directory hierarchy based on the year, month, and day. Use the <code class="literal">strftime</code> variables to name the file and to choose a directory to place the file, as shown here:</p><a id="I_programlisting5_d1e9275"/><pre class="programlisting">stat-report subnets
   type ip-source/destination-address
   output
❶  time end
❷  path /tmp/%Y/%m/%d/%H/%M-report.csv</pre><p>This report uses the <code class="literal">time</code> the last flow ends (❶). As shown at ❷, the results will appear in a file under a directory named for the year, month, day, and hour, and they use the last time in the file for the filename. For example, if I'm reporting on flow data from December 1, 2011, between 8 <span class="keycap"><strong>am</strong></span> and 8:59 <span class="keycap"><strong>am</strong></span>, the results would appear in the directory <span class="emphasis"><em>/tmp/2011/12/01/08</em></span>.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Although <code class="literal">flow-report</code> will expand <code class="literal">strftime</code> variables and hand the correct numbers to <code class="literal">flow-rptfmt</code>, <code class="literal">flow-rptfmt</code> cannot create missing directories.<a class="indexterm" id="IDX-CHP-5-0227"/></p></div><p>The following report places HTML reports in a directory under the web root, using filenames based on the year, month, day, and hour of the data you're reporting on:<a class="indexterm" id="IDX-CHP-5-0228"/></p><a id="I_programlisting5_d1e9316"/><pre class="programlisting">stat-report subnets
  type ip-source/destination-address
  output
    time mid
    path |flow-rptfmt -f html &gt; /var/www/reports/report-%Y-%m-%d-%H-report.html</pre></div><div class="sect3" title="Set Sorting Order"><div class="titlepage"><div><div><h3 class="title"><a id="set_sorting_order"/>Set Sorting Order</h3></div></div></div><p>Use the <code class="literal">sort</code> output option to control which column the report sorts on. This works the same as if you changed sorting on the command line. Use any column name in the report as the value for <code class="literal">sort</code>. A leading plus sign says start with the largest value and go down; a leading minus sign means start with the smallest and go up. The following example <code class="literal">stat-report</code> tells you what remote address ranges your network communicates with most because you list the highest traffic networks first by sorting on octets.<a class="indexterm" id="IDX-CHP-5-0229"/><a class="indexterm" id="IDX-CHP-5-0230"/><a class="indexterm" id="IDX-CHP-5-0231"/><a class="indexterm" id="IDX-CHP-5-0232"/><a class="indexterm" id="IDX-CHP-5-0233"/><a class="indexterm" id="IDX-CHP-5-0234"/></p><a id="I_programlisting5_d1e9361"/><pre class="programlisting">stat-report subnets
  type ip-source/destination-address
  ip-source-address-format prefix-len
  ip-destination-address-format prefix-len
  output
  <strong class="userinput"><code>sort +octets</code></strong>
    path |flow-rptfmt</pre></div><div class="sect3" title="Cropping Output"><div class="titlepage"><div><div><h3 class="title"><a id="cropping_output"/>Cropping Output</h3></div></div></div><p>Flow reports can run to hundreds or thousands of lines. Often you don't want the entire report and instead want merely the first entries, whether that's the first five or the first 500, but there's no sense in creating the 50,000-line report just to get those few entries. The <code class="literal">records</code> option gives the maximum number of results to show. Here, I'm adding a <code class="literal">records</code> entry to the previous report:</p><a id="I_programlisting5_d1e9377"/><pre class="programlisting">output
  <strong class="userinput"><code>records 5</code></strong>
    sort +octets
    path |flow-rptfmt</pre><p>The report is no longer a list of all the networks you communicate with. Instead, it's the top five networks you communicate with.</p></div><div class="sect3" title="Other Output Options"><div class="titlepage"><div><div><h3 class="title"><a id="other_output_options"/>Other Output Options</h3></div></div></div><p>You might or might not want header information, percentages, and so on, in your customized report. Control these with the <code class="literal">options</code> keyword. (I discussed these options in <a class="xref" href="ch05s04.html#displaying_headers_comma_hostnames_comma" title="Displaying Headers, Hostnames, and Percentages">Displaying Headers, Hostnames, and Percentages</a> in <a class="xref" href="ch05s04.html#displaying_headers_comma_hostnames_comma" title="Displaying Headers, Hostnames, and Percentages">Displaying Headers, Hostnames, and Percentages</a>.) Here I'm turning off the informational headers:</p><a id="I_programlisting5_d1e9396"/><pre class="programlisting">output
    <strong class="userinput"><code>options +header</code></strong>
    path |flow-rptfmt</pre></div><div class="sect3" title="Alternate Configuration Files"><div class="titlepage"><div><div><h3 class="title"><a id="alternate_configuration_files"/>Alternate Configuration Files</h3></div></div></div><p>As you proceed, you might find yourself with an increasing number of customized reports used by more and more people. Reports, like filters, will not work if the configuration file is not parseable. As more people and processes run reports, you might find it difficult to develop new reports without annoying other system users or interrupting scheduled jobs. If so, tell <code class="literal">flow-report</code> to use a different configuration file than the default with the <code class="literal">-s</code> flag.</p><a id="I_programlisting5_d1e9412"/><pre class="programlisting"># <strong class="userinput"><code>flow-report -s</code></strong> <strong class="userinput"><code><em class="replaceable"><code>test-stat.cfg</code></em></code></strong> <strong class="userinput"><code>-S</code></strong> <strong class="userinput"><code><em class="replaceable"><code>newreport</code></em></code></strong></pre><p>Create, edit, and remove reports on a copy of the configuration file. When your changes are working the way you want, just copy your new configuration over the old one. Users won't notice unless you change a report that they're using.</p><p>Now that you can report on your traffic any way you like, you'll create graphical reports and even write your own flow analysis software in <a class="xref" href="ch06.html" title="Chapter 6. PERL, FLOWSCAN, AND CFLOW.PM">Chapter 6</a>.</p></div></div></div></body></html>