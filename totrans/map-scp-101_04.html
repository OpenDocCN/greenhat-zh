<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;LAYER IT ON"><div class="titlepage"><div><div><h1 class="title"><a id="layer_it_on"/>Chapter 4. LAYER IT ON</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject4_d1e3551"/><img src="httpatomoreillycomsourcenostarchimages671943.png.jpg" alt="image with no caption"/></div></div><p>Mapping is like painting on a geo-referenced canvas. The most common brushes are markers and message boxes, which is the bulk of what we've used so far. To achieve a different texture, you'll need to switch it up. In this chapter, we'll branch out with some specialized layers that will improve the look of your maps.<a id="IDX-CHP-4-0001" class="indexterm"/></p><p>To start, we'll simply draw lines. A lot can be represented simply by connecting geographic coordinates together: routes, political boundaries, and even individual buildings. This chapter even has a project to color states or countries on a map, which could be used to make an election map like the ones that have become popular in recent US presidential races.</p><p>We'll also add images to the map. Didn't we do that with custom markers? Yes, but the images we'll be adding will be larger and act like your own map's imagery. In fact, we'll also create custom tiles, still utilizing a mapping API but bypassing (or augmenting) its own maps.<a id="IDX-CHP-4-0002" class="indexterm"/><a id="IDX-CHP-4-0003" class="indexterm"/></p><p>Creating layers on your map is a huge step toward making your maps stand out as a masterpiece. Get out those new brushes and let's start mapping.</p><div class="sect1" title="#16: Draw Lines on a Map"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_16_colon_draw_lines_on"/>#16: Draw Lines on a Map</h1></div></div></div><p>What's the shortest distance from point A to point B? Here's a hint: After reading this section, you'll be able to represent it on a map.</p><p>Drawing lines, which Mapstraction calls <span class="emphasis"><em>polylines</em></span>, is very useful. With them, you can outline a route, such as driving directions or a hiking trail. Like a marker, a line uses latitude and longitude points. Of course, you can't have a line with a single point, so you'll need at least two pairs of coordinates to draw a line.<a id="IDX-CHP-4-0004" class="indexterm"/></p><p>Mapstraction lets you have an unlimited number of points, but let's start simply. This example will draw a line between the capitals of Georgia (the US state) and Georgia (the country). Add the following code to your <code class="literal">create_map</code> function after your map has been initialized:</p><a id="I_programlisting4_d1e3595"/><pre class="programlisting">var georgias = ❶[new LatLonPoint(33.754487, −84.389663),
                 new LatLonPoint(41.709981, 44.792998)];
  var poly = ❷new Polyline(georgias);
❸ mapstraction.addPolyline(poly);
  mapstraction.autoCenterAndZoom();</pre><p>The first thing I've done is declare the two points ❶, storing them in an array variable. Note the square brackets—<code class="literal">[</code> and <code class="literal">]</code>—that create the array and that the two <code class="literal">LatLonPoints</code> inside the array are separated by a comma. Mapstraction requires an array with at least two <code class="literal">LatLonPoints</code> to create a polyline.</p><p>Next, I actually create the <code class="literal">Polyline</code> object ❷ using the array. Like a marker object, this object is Mapstraction's way of representing the data so it can be reproduced with multiple mapping providers, if necessary. Creating a polyline is not enough to draw the line, however. I also need to add it to the map ❸.</p><p>Finally, I automatically center the map using the same function described in <a class="xref" href="ch02s08.html" title="#8: Determine the Correct Zoom Level to Use Based on Markers">#8: Determine the Correct Zoom Level to Use Based on Markers</a> in <a class="xref" href="ch02s07.html" title="#7: Loop Through All Markers">#7: Loop Through All Markers</a>. In this case, Mapstraction uses polylines instead of markers to determine the zoom level.</p><p>The resulting map is shown in <a class="xref" href="ch04.html#a_line_drawn_between_two_georgian_capita" title="Figure 4-1. A line drawn between two Georgian capitals">Figure 4-1</a> with a line drawn across the Atlantic Ocean, connecting the two Georgias. Let's see if we can make something a little more useful by adding more points to our line.</p><div class="figure"><a id="a_line_drawn_between_two_georgian_capita"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e3629"/><img src="httpatomoreillycomsourcenostarchimages671987.png.jpg" alt="A line drawn between two Georgian capitals"/></div></div><p class="title">Figure 4-1. A line drawn between two Georgian capitals</p></div><div class="sect2" title="Draw Multiple Line Segments"><div class="titlepage"><div><div><h2 class="title"><a id="draw_multiple_line_segments"/>Draw Multiple Line Segments</h2></div></div></div><p>When you think of a line, you probably picture something like what we created in the previous section: the connection between two points. Polylines, however, can have unlimited segments, which means you can use them to create paths and routes.<a id="IDX-CHP-4-0005" class="indexterm"/><a id="IDX-CHP-4-0006" class="indexterm"/><a id="IDX-CHP-4-0007" class="indexterm"/></p><p>In fact, Google uses a polyline to display its driving directions. Using polylines makes sense because very few streets are perfectly straight. Most have at least slight meanderings from side to side. In San Francisco, a couple of streets are even known for their crookedness, most notably a short section of Lombard.</p><p>Here's some code to create a polyline that very roughly follows the curves of Lombard Street, from the top to the bottom:</p><a id="I_programlisting4_d1e3658"/><pre class="programlisting">var lombard = [new LatLonPoint(37.802010, −122.419635),
               new LatLonPoint(37.802036, −122.419463),
               new LatLonPoint(37.802120, −122.419356),
               new LatLonPoint(37.802010, −122.419184),
               new LatLonPoint(37.802137, −122.419034),
               new LatLonPoint(37.802053, −122.418841),
               new LatLonPoint(37.802197, −122.418701),
               new LatLonPoint(37.802087, −122.418519),
               new LatLonPoint(37.802231, −122.418401),
               new LatLonPoint(37.802120, −122.418186),
               new LatLonPoint(37.802214, −122.417993)];
var poly = new Polyline(lombard);
mapstraction.addPolyline(poly);
mapstraction.autoCenterAndZoom();</pre><p>As you can see from <a class="xref" href="ch04.html#a_polyline_with_several_points_to_trace" title="Figure 4-2. A polyline with several points to trace San Francisco's famous Lombard Street">Figure 4-2</a>, those 11 latitude and longitude points create a polyline that traces along Lombard's eight turns. As with the Georgia example, the points are stored within brackets to create the JavaScript array that Mapstraction needs to make a polyline.</p><div class="figure"><a id="a_polyline_with_several_points_to_trace"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e3667"/><img src="httpatomoreillycomsourcenostarchimages671989.png.jpg" alt="A polyline with several points to trace San Francisco's famous Lombard Street"/></div></div><p class="title">Figure 4-2. A polyline with several points to trace San Francisco's famous Lombard Street</p></div><p>Lombard Street is still a fairly simple example. We've covered less than a quarter mile—and that includes the twists and turns. You could use polylines to trace entire highways, rivers that flow for hundreds of miles, or even the Great Wall of China.</p></div><div class="sect2" title="Set the Color and Thickness"><div class="titlepage"><div><div><h2 class="title"><a id="set_the_color_and_thickness"/>Set the Color and Thickness</h2></div></div></div><p>Like markers and other aspects of a map, polylines come with a standard look you may want to change. For example, you can alter the color and thickness of the lines you draw.<a id="IDX-CHP-4-0008" class="indexterm"/><a id="IDX-CHP-4-0009" class="indexterm"/><a id="IDX-CHP-4-0010" class="indexterm"/><a id="IDX-CHP-4-0011" class="indexterm"/><a id="IDX-CHP-4-0012" class="indexterm"/><a id="IDX-CHP-4-0013" class="indexterm"/><a id="IDX-CHP-4-0014" class="indexterm"/><a id="IDX-CHP-4-0015" class="indexterm"/><a id="IDX-CHP-4-0016" class="indexterm"/><a id="IDX-CHP-4-0017" class="indexterm"/><a id="IDX-CHP-4-0018" class="indexterm"/><a id="IDX-CHP-4-0019" class="indexterm"/></p><p>Mapstraction has individual functions to set the criteria you want. Each can be applied after you have created a polyline, but before you have added it to the map. This process is similar to the order in which Marker options have to be added.</p><p>Here is an example that makes a purple polyline that is five pixels thick (it assumes your polyline is stored in the <code class="literal">poly</code> variable):</p><a id="I_programlisting4_d1e3738"/><pre class="programlisting">poly.setColor(❶'#FF00FF');
poly.setWidth(5);</pre><p>Note that the color is set as a hexadecimal value ❶, similar to how colors are declared in HTML. Either a six- or three-character value works, and you can even precede it with a hash mark, <code class="literal">#</code>, if you prefer.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>Some browsers, especially older ones, have trouble with colored polylines. Be sure to check thoroughly across all browsers your user base commonly employs, especially if the color of the polyline is integral to your application.</p></div><p>Because you'll often want to set several attributes at once, Mapstraction has a function that accepts many options, storing their values in a JavaScript object:</p><a id="I_programlisting4_d1e3750"/><pre class="programlisting">poly.addData({color: '#FF00FF', width: 5});</pre><p>The curly brackets <code class="literal">{</code> and <code class="literal">}</code> are important, as they declare the JavaScript object. Then an attribute is set with the name of the option, a colon, and the value. You'll see more examples of adding styling options to polylines in the next project.</p></div></div></div>
<div class="sect1" title="#17: Draw Shapes on a Map"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_17_colon_draw_shapes_on_a"/>#17: Draw Shapes on a Map</h1></div></div></div><p>Are you ready for a little philosophy? I hope so, because I have a philosophical question for you: What is a shape?</p><p>Before you answer that, let's list some names of shapes. Shapes include circles and triangles. Squares are popular, as are their relative the rectangles. If we continue to increase the number of sides, the names may sound familiar—pentagon, hexagon, heptagon, octagon—and then the names get a little strange.</p><p>Your philosophical answer may be different, but for our purposes, we'll create a shape with some number of sides. This shape is called a <span class="emphasis"><em>polygon</em></span>. A polygon is made up of line segments that start and end at the same point. If you have mastered the previous project, you probably have a pretty good idea of how you could create a polygon using Mapstraction.</p><p>Surprisingly, creating shapes on a map is essentially the same process as drawing polylines. Take a look at this code, which draws an outline around the US Department of Defense headquarters ("The Pentagon"—get it?):<a id="IDX-CHP-4-0020" class="indexterm"/><a id="IDX-CHP-4-0021" class="indexterm"/><a id="IDX-CHP-4-0022" class="indexterm"/></p><a id="I_programlisting4_d1e3785"/><pre class="programlisting">var pentagon = <strong class="userinput"><code>[new LatLonPoint(38.870253, −77.058491)</code></strong>,
                new LatLonPoint(38.872725, −77.057955),
                new LatLonPoint(38.873059, −77.054715),
                new LatLonPoint(38.870804, −77.053320),
                new LatLonPoint(38.869000, −77.055616),
                <strong class="userinput"><code>new LatLonPoint(38.870253, −77.058491)</code></strong>];
var poly = new Polyline(pentagon);
mapstraction.addPolyline(poly);
mapstraction.autoCenterAndZoom();</pre><p>As with standard polylines, we need to declare an array of <code class="literal">LatLonPoint</code>s using square brackets <code class="literal">[</code> and <code class="literal">]</code> to show a JavaScript array. The big difference is that the first and last points (both shown in bold) are identical, signaling to Mapstraction that you are creating a polygon.</p><p>The outcome, as shown in <a class="xref" href="ch04s02.html#the_pentagon_building_outlined_with_a_po" title="Figure 4-3. The Pentagon building outlined with a polygon">Figure 4-3</a>, is that the polyline is filled in to show that it's more than just a line—it's a shape. Shapes bring up a few more styling issues than normal lines, so Mapstraction provides some additional options.</p><div class="figure"><a id="the_pentagon_building_outlined_with_a_po"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e3811"/><img src="httpatomoreillycomsourcenostarchimages671991.png.jpg" alt="The Pentagon building outlined with a polygon"/></div></div><p class="title">Figure 4-3. The Pentagon building outlined with a polygon</p></div><div class="sect2" title="Set the Fill Color and Opacity"><div class="titlepage"><div><div><h2 class="title"><a id="set_the_fill_color_and_opacity"/>Set the Fill Color and Opacity</h2></div></div></div><p>Now that your polyline has turned into a polygon, let's declare the color that fills its center. Also, with the fill covering such a large area, you may want to leave bits of the map under the polygon visible. That's where opacity comes in—it determines the opaqueness of the fill color.<a id="IDX-CHP-4-0023" class="indexterm"/><a id="IDX-CHP-4-0024" class="indexterm"/><a id="IDX-CHP-4-0025" class="indexterm"/><a id="IDX-CHP-4-0026" class="indexterm"/><a id="IDX-CHP-4-0027" class="indexterm"/><a id="IDX-CHP-4-0028" class="indexterm"/></p><p>If you are familiar with graphics programs, you'll likely be comfortable with opacity. You declare it with a percentage from 0 to 100, where 0 is invisible and 100 is not transparent at all.</p><p>Let's use a single function in Mapstraction to set all the options for the pentagon we made earlier:</p><a id="I_programlisting4_d1e3849"/><pre class="programlisting">poly.addData({❶opacity: 0.9, ❷fillColor: '#00FF00', color: '#009900', width: 5});</pre><p>Here, we have declared an opacity of 90 percent ❶, so we can barely see through it. Notice that we use a decimal between 0 and 1 to show the percentage. Though mathematically correct, you may find this a little confusing.</p><p>The fill color is declared with a CSS-like hexadecimal value ❷. This value is separate from the color of the polyline, which can be the same or different. In this example, the fill color is a bright green, whereas the border is a slightly darker green.</p></div></div>
<div class="sect1" title="#18: Add Circles to Show Search Radius"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_18_colon_add_circles_to_sh"/>#18: Add Circles to Show Search Radius</h1></div></div></div><p>Drawing lines and polygons is fairly easy. They are made up of a series of connected points. A circle is a little more difficult to express. A circle has no points that make up its border. Instead, it's declared by a center point and a radius.</p><p>Circles are useful in mapping, because you can use them to show an area you are searching. For example, if you are looking for places within five miles of a point, your circle would be ten miles wide (and tall—a circle is perfectly round), with the search point right at the center.</p><p>Mapstraction offers two ways to create a circle. First, we can approximate with a many-sided polygon. Second, we could use a graphic and layer it on top of the map. In this section, I'll show you how to do both.</p><div class="sect2" title="Approximate with a Polygon"><div class="titlepage"><div><div><h2 class="title"><a id="approximate_with_a_polygon"/>Approximate with a Polygon</h2></div></div></div><p>Creating a fake circle by connecting points along the circle looks better than you might imagine it would. Of course, the more points you use, the better the circle looks. Mapstraction has a built-in function to perform the computations, and you can set the quality.</p><p>Remember, a circle requires two pieces of information: a center and a radius. In this example, we'll show just how big the state of Texas is by drawing a circle 500 miles in diameter starting from its capital near the center of the state.</p><p>Add these lines to your map initialization function, which I've called <code class="literal">create_map</code> throughout this book:<a id="IDX-CHP-4-0029" class="indexterm"/><a id="IDX-CHP-4-0030" class="indexterm"/></p><a id="I_programlisting4_d1e3884"/><pre class="programlisting">var radius_object = ❶new Radius(new LatLonPoint(30.268259, −97.744674), ❷10);
var poly = radius_object.getPolyline(❸mxn.fn.milesToKM(250), ❹'#990066');
mapstraction.addPolyline(poly);
mapstraction.setCenterAndZoom(center, 5);</pre><p>This code is all that's necessary to add a circle-ish polygon to your map. First, you need to create a <code class="literal">Radius</code> object ❶, which is part of the Mapstraction library. This object does some important calculations to determine the circle's edges. Then you pass the object two values: the center point (downtown Austin, Texas) and a quality number ❷.</p><p>The lower the quality number, the more your polygon will look like a circle. The number represents the degrees between each point in the polygon. You can use this to determine the number of sides your "circle" will have. A circle is 360 degrees total, so if you divide by 10, that's 36 points, which means you're creating a 36-sided polygon in this instance. Using this method, you've done a pretty good job of approximating a circle, as you can see in <a class="xref" href="ch04s03.html#circle_approximated_by_36-sided_polygon" title="Figure 4-4. Circle approximated by 36-sided polygon">Figure 4-4</a>. The more sides you have, the longer it takes to create the circle, so you have to make a trade-off.</p><div class="figure"><a id="circle_approximated_by_36-sided_polygon"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e3898"/><img src="httpatomoreillycomsourcenostarchimages671993.png.jpg" alt="Circle approximated by 36-sided polygon"/></div></div><p class="title">Figure 4-4. Circle approximated by 36-sided polygon</p></div><p>Now that you have a <code class="literal">Radius</code> object, you can create the polygon, which is a <code class="literal">Polyline</code> object. You use a Mapstraction function to convert miles to kilometers ❸. Here, I've passed it the number of miles of the radius, which is half of the diameter of the eventual circle. Also, I've passed a hexadecimal value for the color ❹ of the circle, in this case, a shade of purple.<a id="IDX-CHP-4-0031" class="indexterm"/><a id="IDX-CHP-4-0032" class="indexterm"/><a id="IDX-CHP-4-0033" class="indexterm"/></p><p>You can create as many circles as you want from the radius object, so you could show several levels of distance from Austin. If you want to move the center (or change the quality of the circle), however, you'll need to re-create the radius object.</p></div><div class="sect2" title="Overlay a Circle Image"><div class="titlepage"><div><div><h2 class="title"><a id="overlay_a_circle_image"/>Overlay a Circle Image</h2></div></div></div><p>The polygonized circle may still be too jagged for you, or perhaps you want more control over how the circle looks. In that case, overlaying an image on your map is your best choice.</p><p>First, you'll need a circle image, likely saved as a transparent PNG file. Transparency is important because graphics are stored as rectangles, so you definitely don't want the area outside of the circle to be visible. Also, since you'll be referencing this on the map as a rectangle, your circle should be up against the four edges of the graphic. I've included several sample circle graphics for download on the book's website at <a class="ulink" href="http://mapscripting.com/circle-overlays">http://mapscripting.com/circle-overlays</a>.<a id="IDX-CHP-4-0034" class="indexterm"/><a id="IDX-CHP-4-0035" class="indexterm"/><a id="IDX-CHP-4-0036" class="indexterm"/></p><p>Once you have your circle graphic, you can figure out where to place it on the map. A graphic is referenced by the four sides of its rectangle, so you need to determine the north, south, east, and west points. Usually, a circle is determined by its center and radius. You can calculate the side values by measuring in four directions from the center.</p><p>Add these lines to your map code:</p><a id="I_programlisting4_d1e3952"/><pre class="programlisting">var center = new LatLonPoint(30.268259, −97.744674);
❶ var dist_lat = 250 / 69.2;
  var dist_lon = ❷mxn.fn.metresToLon(❸mxn.fn.milesToKM(250)*1000, center.lat);
❹ var n = center.lat + dist_lat;
  var s = center.lat − dist_lat;
  var e = center.lon + dist_lon;
  var w = center.lon − dist_lon;
  mapstraction.addImageOverlay(❺'searchradius', 'circle.png', ❻75, w, s, e, n);
  mapstraction.setCenterAndZoom(center, 5);</pre><p>To be able to determine the geographic borders of your circle image, you need to calculate how many degrees of latitude and longitude make up the radius, which is 250 miles. The latitude distance ❶ is easier, because latitude is nearly constant throughout the world at 69.2 miles per degree.</p><p>Longitude depends on where you are on earth because the degrees are closer to each other as you near a pole. Mapstraction has a handy function ❷ for converting meters to longitude based on a latitude. In order to pass the function 250 miles in meters, you must first convert to kilometers ❸ and then multiply by 1000.</p><p>At this point, you have your distances, so now you just need to calculate the four sides. For example, the northern border ❹ of the graphic will be at the center point latitude plus the number of degrees latitude we determined are in 250 miles. South will also use that latitude distance (only this distance is subtracted from the center's latitude. East and west borders will use the longitude distance.</p><p>Armed with your four geographic borders, you can apply your image overlay. Mapstraction needs a lot of information, including an identifier for the image ❺ and an opacity level ❻ (for this example, I've chosen 75 percent). The results are shown in <a class="xref" href="ch04s03.html#transparent_circle_image_overlay" title="Figure 4-5. Transparent circle image overlay">Figure 4-5</a>, where you can see a perfect circle atop Texas. The area it covers, you'll notice, is identical to the area covered by the polygon circle in <a class="xref" href="ch04s03.html#circle_approximated_by_36-sided_polygon" title="Figure 4-4. Circle approximated by 36-sided polygon">Figure 4-4</a>.</p><div class="figure"><a id="transparent_circle_image_overlay"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e3969"/><img src="httpatomoreillycomsourcenostarchimages671995.png.jpg" alt="Transparent circle image overlay"/></div></div><p class="title">Figure 4-5. Transparent circle image overlay</p></div><p>No matter which type of circle you choose to use, Texas is a big state.</p></div></div>
<div class="sect1" title="#19: Draw a Rectangle to Declare an Area"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_19_colon_draw_a_rectangle"/>#19: Draw a Rectangle to Declare an Area</h1></div></div></div><p>In <a class="xref" href="ch02.html" title="Chapter 2. PLOTTING MARKERS AND MESSAGE BOXES">Chapter 2</a>, I discussed the bounding box, a set of coordinates that roughly describes a geographic area. I write <span class="emphasis"><em>roughly</em></span> because bounds are visually rectangular, so they can only be used to declare the simplest of areas. Of course, with every map we have been indirectly creating bounds. The visible portion of the map is a rectangular portion of the greater map.<a id="IDX-CHP-4-0037" class="indexterm"/><a id="IDX-CHP-4-0038" class="indexterm"/><a id="IDX-CHP-4-0039" class="indexterm"/></p><p>Mapstraction uses the <code class="literal">BoundingBox</code> class to describe an area. As a data structure, this class is made up of two <code class="literal">LatLonPoint</code>s. One declares the southwest corner (the lower left) and the other the northeast corner (the upper left). From those two values, we can figure out the remaining two corners. And we'll do just that in this project.</p><p>You may find yourself wanting to declare an area of the map visually. Because a <code class="literal">BoundingBox</code> is simply a data representation of an area, we need to convert to a <code class="literal">Polyline</code>. Add this function to your JavaScript (outside the <code class="literal">create_map</code> function) to perform the conversion:</p><a id="I_programlisting4_d1e4015"/><pre class="programlisting">function BoundingBox_to_Polyline(box) {
  var points = [❶box.sw, ❷new mxn.LatLonPoint(box.ne.lat, box.sw.lon), box.ne,
                new mxn.LatLonPoint(box.sw.lat, box.ne.lon),
                new mxn.LatLonPoint(box.sw.lat, ❸box.sw.lon-.0001)];
  var poly = new mxn.Polyline(points);
  return poly;
}</pre><p>Drawing a rectangle on a map requires five points. At first, this requirement may seem a bit strange—doesn't a rectangle have four corners? Of course. We aren't violating basic rules of geometry. We need to declare the start and the finish points separately, however. And because these are the same point (or, as you'll see, nearly the same), we include it twice.</p><p>The array of points begins, simply enough, with the southwest point ❶. Then we want to draw a line directly north, which means we need to keep the same longitude while increasing the latitude. We only have two points to work with, so we create a new point ❷ using the southwest's longitude and the northeast's latitude.</p><p>The third point is the northeast point itself. Then we can use a similar process to determine the fourth point. Finally, we need to draw the final side of the rectangle back to the southwest point. But this is where things get strange. If we use exactly the southwest point, Mapstraction will fill in the area. To get an unfilled box, we create a final point with a longitude almost imperceptibly off ❸ from the starting point.</p><p>Now that we've written our new function, we need to call it. From within your <code class="literal">create_map</code> function, add the following lines:</p><a id="I_programlisting4_d1e4028"/><pre class="programlisting">❹ var bounds = mapstraction.getBounds();
❺ var poly = BoundingBox_to_Polyline(bounds);
  mapstraction.addPolyline(poly);
  mapstraction.setZoom(mapstraction.getZoom()-1);</pre><p>We could create new bounds if we wanted, but instead we are taking them from the map itself ❹. Then we use those bounds to call our function to convert to a <code class="literal">Polyline</code> ❺. As you saw earlier, creating the object is just the first step. We also need to add it to the map. The final line zooms out so we can see the rectangle, as shown in <a class="xref" href="ch04s04.html#bounding_box_converted_to_a_polyline" title="Figure 4-6. Bounding box converted to a polyline">Figure 4-6</a>. Without zooming, the rectangle would be right at the edges of our map.<a id="IDX-CHP-4-0040" class="indexterm"/><a id="IDX-CHP-4-0041" class="indexterm"/><a id="IDX-CHP-4-0042" class="indexterm"/></p><div class="figure"><a id="bounding_box_converted_to_a_polyline"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4054"/><img src="httpatomoreillycomsourcenostarchimages671997.png.jpg" alt="Bounding box converted to a polyline"/></div></div><p class="title">Figure 4-6. Bounding box converted to a polyline</p></div><p>Use this snippet of code to clearly show bounds. For an example of this project in action, see <a class="xref" href="ch02s07.html" title="#7: Loop Through All Markers">#7: Loop Through All Markers</a> in <a class="xref" href="ch06s07.html#other_useful_parameters" title="Other Useful Parameters">Other Useful Parameters</a>.</p></div>
<div class="sect1" title="#20: Draw Lines Along Clicks"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_20_colon_draw_lines_along"/>#20: Draw Lines Along Clicks</h1></div></div></div><p>The biggest stumbling block to creating your own lines on a map is finding the latitude and longitude points. With this project, you (or your users) will be able to draw lines simply by clicking the map. Gmap Pedometer (<a class="ulink" href="http://gmap-pedometer.com/">http://gmap-pedometer.com/</a>) popularized this technique in the earliest days of mapping APIs, and now you can use it, too.</p><p>Reacting to a click event is at the center of this method. You will find events covered in detail in <a class="xref" href="ch05.html" title="Chapter 5. HANDLE MAP EVENTS">Chapter 5</a>. We want to store all the click points in an array. Because we'll be accessing this from an event, the variable we create needs to be public, meaning it is declared outside of any function. Include this line at the beginning of your JavaScript:<a id="IDX-CHP-4-0043" class="indexterm"/><a id="IDX-CHP-4-0044" class="indexterm"/></p><a id="I_programlisting4_d1e4082"/><pre class="programlisting">var cpts = [];</pre><p>This variable will hold every point that is clicked. Right now it is an empty array (there's nothing between those square brackets). With every click, however, we'll add a new <code class="literal">LatLonPoint</code> to the array.</p><p>From within your map initialization code, add these lines to react to clicks:</p><a id="I_programlisting4_d1e4091"/><pre class="programlisting">mapstraction.click.addHandler(function(event_name, event_source, event_args) {
    var clickpoint = event_args.location;
❶   cpts.push(clickpoint);
    if (cpts.length == 1) {
❷   var mk = new Marker(clickpoint);
      mapstraction.addMarker(mk);
    }
    else {
      ❸var poly = new Polyline(❹cpts.slice(cpts.length-2));
      mapstraction.addPolyline(poly);
    }
  });</pre><p>Here, I have included the code that runs when the user clicks the map in an anonymous, inline function. This is about as long as I would make a function without explicitly naming it.</p><p>The very first thing that happens is we "push" the new point into the array ❶. The <code class="literal">push</code> function is built into JavaScript for every array variable and always adds it on to the end of the array.</p><p>The minimum number of points before we can draw a line is two. This requirement causes a bit of an issue because we need the user to know we have recorded the first click. To deal with this, we added a marker ❷ to the map only if the length of the array is one. In other words, a marker is added only on the first click.</p><p>On subsequent clicks, we create a new polyline ❸ with the two most recent points. To do this, we connect the last point in the array ❹ to the next-to-last point in the array (because arrays in JavaScript begin counting at zero, the last element is always one less than the length). Also, remember that a polyline is created with an array itself, so we need to surround those two numbers with brackets. The code starts to look a little messy.</p><p>After several clicks, the map will look something like <a class="xref" href="ch04s05.html#connecting_clicks_with_polyline_segments" title="Figure 4-7. Connecting clicks with polyline segments">Figure 4-7</a>. Internally, we'll have all the points stored in our array. Mapstraction, however, is treating each line segment as its own polyline. From a visual perspective, it still looks like one big line.</p><div class="figure"><a id="connecting_clicks_with_polyline_segments"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4112"/><img src="httpatomoreillycomsourcenostarchimages671999.png.jpg" alt="Connecting clicks with polyline segments"/></div></div><p class="title">Figure 4-7. Connecting clicks with polyline segments</p></div></div>
<div class="sect1" title="#21: Color States/Countries on a Map"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_21_colon_color_states_soli"/>#21: Color States/Countries on a Map</h1></div></div></div><p>If you've paid attention to recent US politics, you've likely seen red and blue state maps. During the 2004 and 2008 presidential campaigns, these became common across the Web. And believe it or not, if you've read this far in the chapter, you already know how to make a colored map of your own.<a id="IDX-CHP-4-0045" class="indexterm"/><a id="IDX-CHP-4-0046" class="indexterm"/><a id="IDX-CHP-4-0047" class="indexterm"/><a id="IDX-CHP-4-0048" class="indexterm"/></p><p>All you need are the points that make up the outline of each state. Then, you create a polygon for each state, giving it the proper fill color. Before you can start coloring states, you'll need the points that make up the outline of each state. You can get this data in a number of ways. For example, you could create it on your own using code similar to that in the previous project.</p><p>You could also take it directly from the government, but you'd likely need to convert it to a format that's easy for Mapstraction to use. I have data sources available at the book's website at <a class="ulink" href="http://mapscripting.com/state-boundaries">http://mapscripting.com/state-boundaries</a>.</p><p>If you want to try it out, start with just a few states. In this example, I'll use the four-corner states of Utah, Colorado, Arizona, and New Mexico. They have relatively few points, and they all come together neatly. The first step is declaring the points that make up each state boundary as a JavaScript array:<a id="IDX-CHP-4-0049" class="indexterm"/><a id="IDX-CHP-4-0050" class="indexterm"/></p><a id="I_programlisting4_d1e4155"/><pre class="programlisting">var utah = [new LatLonPoint(36.99, −114.05), new LatLonPoint(36.99, −109.04),
            new LatLonPoint(40.99, −109.05), new LatLonPoint(40.99, −111.05),
            new LatLonPoint(41.99, −111.05), new LatLonPoint(41.99, −114.04),
            new LatLonPoint(36.99, −114.05)];
var colorado = [new LatLonPoint(41.00, −102.05), new LatLonPoint(40.99, −109.04),
                new LatLonPoint(37.00, −109.04), new LatLonPoint(36.99, −102.04),
                new LatLonPoint(41.00, −102.05)];
var arizona = [new LatLonPoint(33.95, −114.52), new LatLonPoint(34.00, −114.47),
               new LatLonPoint(34.02, −114.43), new LatLonPoint(34.08, −114.43),
               ...
               new LatLonPoint(33.92, −114.53), new LatLonPoint(33.95, −114.52)];
var newmexico = [new LatLonPoint(32.00, −106.62), new LatLonPoint(31.99, −103.06),
                 new LatLonPoint(36.99, −103.00), new LatLonPoint(36.99, −109.04),
                 new LatLonPoint(36.99, −109.04), new LatLonPoint(31.33, −109.04),
                 new LatLonPoint(31.33, −108.21), new LatLonPoint(31.77, −108.20),
                 new LatLonPoint(31.78, −106.53), new LatLonPoint(32.00, −106.62)];</pre><p>Arizona is just a little too complex to show all of its points in the book, but the others are complete. Like declaring other shapes using points, we include a list of <code class="literal">LatLonPoint</code>s within square brackets to designate an array. To create a complete shape (and, therefore, include a fill color), the first and last points in the array must be identical. The identical points tell Mapstraction that the polyline begins and ends at the same place.</p><p>Because we are going to be performing the same actions multiple times, this is an appropriate occasion to create our own function. Here is the code to color in a state:</p><a id="I_programlisting4_d1e4164"/><pre class="programlisting">function color_state(❶pts, ❷color) {
  var poly = new Polyline(pts);
  poly.addData({❸opacity: 0.9, ❹fillColor: color, ❺width: 0});
  mapstraction.addPolyline(poly);
}</pre><p>We'll call this function four times—once for each state. Or, if you're doing the whole United States, you'd call the function fifty times. This function's three lines mean our code will only take up one-third of the space. If you're going to run the same code many times, you'll want to avoid duplication and create your own function.</p><p>We'll need to pass the function two arguments. First, we pass it a list of points ❶—a state boundary array. Then, because we're filling in the map with different colored states, we'll need to let the function know what color ❷ to make the current state.</p><p>The function then goes to work creating a <code class="literal">Polyline</code> and adding data to it. We've set the opacity to 90 percent ❸, which means the filled state shape will be slightly transparent, just enough to see the state name underneath. The color is set ❹ to the argument that we received. We made the width zero ❺, meaning the state will not have a border. You may prefer to have a border, so try out a few different values. This argument takes integers, which refer to thickness in number of pixels.<a id="IDX-CHP-4-0051" class="indexterm"/></p><p>Nothing we've done so far will actually do anything yet. For that, we need to call this function, passing a state boundary array and color. Add this code to your map initialization section:</p><a id="I_programlisting4_d1e4181"/><pre class="programlisting">color_state(utah, '#00ff00');
color_state(colorado, '#006600');
color_state(arizona, '#009900');
color_state(newmexico, '#00cc00');
mapstraction.autoCenterAndZoom();</pre><p>As you see, this calls the <code class="literal">color_state</code> function four times, using a different point array variable and color each time. To keep this example apolitical, I've used shades of green. Feel free to insert your own red (<code class="literal">'ff0000'</code>) or blue (<code class="literal">'0000ff'</code>) values.</p><p>To be sure every state is within view, I autocentered the map after adding the four states. As you can see from <a class="xref" href="ch04s07.html#polygons_of_four_us_states" title="Figure 4-8. Polygons of four US states">Figure 4-8</a>, our map looks pretty snazzy. But if you zoom in, the borders of each state might not completely touch. That's a precision issue, which you may not care about. Its importance depends on how closely you expect users to view your borders. For the case of a colored election map, which is viewed at country-level, we don't need perfection.</p><p>Another issue you may notice with creating a state map is that not all states are one perfect shape. Hawaii is a series of islands, and Michigan's two pieces are separated by a Great Lake. Again, how you handle this depends on how big of a deal it is to you. You may be fine connecting the portions so they can be one state. Or, you may use multiple polygons to represent these complex states.</p></div>
<div class="sect1" title="#22: Add Custom Controls"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_22_colon_add_custom_contro"/>#22: Add Custom Controls</h1></div></div></div><p>Everything we have layered on the map so far has been geo-referenced. In other words, when the user drags the map to the side, the thing we've layered also moves. In this section, we'll create some interface elements that don't move, but instead are anchored to a specific spot in the map window.</p><p>The controls we'll be creating are similar to map type controls, which are in the upper-right corner of the map. In <a class="xref" href="ch01s06.html" title="Add Zoom and Other Controls">Add Zoom and Other Controls</a> in <a class="xref" href="ch01s06.html" title="Add Zoom and Other Controls">Add Zoom and Other Controls</a>, I showed how to include these (and other) controls. Now, we'll be making our own buttons that live in the same spot.</p><p>For this example, we'll make a button that gives users the option to center the map automatically so all the markers and lines are visible. Better yet, we'll write the code so you can create any number of these custom controls with a simple function call.<a id="IDX-CHP-4-0052" class="indexterm"/><a id="IDX-CHP-4-0053" class="indexterm"/></p><div class="figure"><a id="polygons_of_four_us_states"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4224"/><img src="httpatomoreillycomsourcenostarchimages672001.png.jpg" alt="Polygons of four US states"/></div></div><p class="title">Figure 4-8. Polygons of four US states</p></div><p>Here's the code for creating a control:<a id="IDX-CHP-4-0054" class="indexterm"/></p><a id="I_programlisting4_d1e4234"/><pre class="programlisting">function create_control(❶txt, ❷func) {
❸ var newcontrol = document.createElement("a");
❹ newcontrol.className = 'googlecontrol';
❺ newcontrol.appendChild(document.createTextNode(txt));
❻ newcontrol.onclick = func;
❼ mapstraction.currentElement.appendChild(newcontrol);
  }</pre><p>This function needs two pieces of data in order to create the control and add it to the map: It needs the text ❶ that will be written inside the button, and it needs the function ❷ that it will call when the button is clicked.</p><p>With those pieces of information, we can go about creating this control. In terms of how the browser interprets it, we are creating a simple <code class="literal">&lt;a&gt;</code> tag programmatically ❸. We give it a class name ❹ so we can style it with CSS. Then we add the label to it ❺.</p><p>At this point, the control has been created, but it isn't on the map, nor does it do anything. To fix these two issues, we set the function ❻ that will be called when the user clicks and then append the object as a child of the map object ❼.</p><p>Now we can style the control. Add these CSS lines to your style sheet:</p><a id="I_programlisting4_d1e4248"/><pre class="programlisting">a.googlecontrol {
  <strong class="userinput"><code>position: relative;</code></strong>
  <strong class="userinput"><code>float: right;</code></strong>
  width: 63px;
  height: 15px;
  margin: 5px 3px 0 0;
  border: 1px solid #b0b0b0;
  background-color: white;
  color: black;
  font-size: 12px;
  text-align: center;
}
a.googlecontrol:hover {
  cursor: pointer;
}</pre><p>This CSS is designed to make our controls look similar to Google's map type controls. Only the first two lines (in bold) are necessary to position it in the upper-right corner. Everything else is styling.</p><p>All of the hard work is now done, and we're ready to use our custom control. From within the initialization code for our map, add these lines to create an autocentering control:</p><a id="I_programlisting4_d1e4260"/><pre class="programlisting">create_control("auto-center", function() {
  mapstraction.autoCenterAndZoom();
});</pre><p>This code passes the label for our new control (autocenter) and an anonymous, inline function reference, which decides what to do when the user clicks the new control button. In this case, it fires off the Mapstraction code to show all the markers and lines on the map automatically. See <a class="xref" href="ch04s07.html#a_custom_control_looks_like_a_google_con" title="Figure 4-9. A custom control looks like a Google control">Figure 4-9</a> for a before and after example of clicking the button.</p><p>You could do anything you want when the user clicks your custom control button. One common choice might be showing only markers of a particular type. I demonstrate how to do this in <a class="xref" href="ch02s09.html" title="#9: Filter Out Certain Markers">#9: Filter Out Certain Markers</a> in <a class="xref" href="ch02s09.html" title="#9: Filter Out Certain Markers">#9: Filter Out Certain Markers</a>. With a marker-filled map, you might also create specific areas to zoom into, as I do in <a class="xref" href="ch10s03.html" title="#70: Display Recent Earthquakes Worldwide">#70: Display Recent Earthquakes Worldwide</a> in <a class="xref" href="ch10s03.html" title="#70: Display Recent Earthquakes Worldwide">#70: Display Recent Earthquakes Worldwide</a>.</p><div class="figure"><a id="a_custom_control_looks_like_a_google_con"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4279"/><img src="httpatomoreillycomsourcenostarchimages672003.png.jpg" alt="A custom control looks like a Google control"/></div></div><p class="title">Figure 4-9. A custom control looks like a Google control</p></div></div>
<div class="sect1" title="#23: Create Your Own Zoom Interface"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_23_colon_create_your_own"/>#23: Create Your Own Zoom Interface</h1></div></div></div><p>When you choose a mapping provider, certain elements of how the map looks cannot be easily changed. The zoom interface may be one of these things you've accepted as being unchangeable. In this project, I'll show how you can include your own zoom in/out buttons to give you even more control over the look of your map.<a id="IDX-CHP-4-0055" class="indexterm"/><a id="IDX-CHP-4-0056" class="indexterm"/><a id="IDX-CHP-4-0057" class="indexterm"/></p><p>The approach is similar to the previous project. We'll make a function that adds a new object to the page, and we'll position and style it using CSS. Instead of a text button, we'll make an image button. And, as before, each new object will react to a click.</p><p>First, you need two images: one will be your zooming-in button and the other the zooming-out button. You can see the two unassuming graphics I chose in <a class="xref" href="ch04s08.html#two_zoom_graphics_to_be_used_as_custom_c" title="Figure 4-10. Two zoom graphics to be used as custom controls">Figure 4-10</a>.</p><div class="figure"><a id="two_zoom_graphics_to_be_used_as_custom_c"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4311"/><img src="httpatomoreillycomsourcenostarchimages672005.png" alt="Two zoom graphics to be used as custom controls"/></div></div><p class="title">Figure 4-10. Two zoom graphics to be used as custom controls</p></div><p>Here is the generic code for creating an image control:</p><a id="I_programlisting4_d1e4318"/><pre class="programlisting">function create_image_control(❶src, ❷func) {
❸ var newcontrol = document.createElement("img");
❹ newcontrol.className = 'imgcontrol';
❺ newcontrol.src = src;
❻ newcontrol.onclick = func;
❼ mapstraction.currentElement.appendChild(newcontrol);
  }</pre><p>This function needs two pieces of data in order to create the control and add it to the map. It needs the image source ❶, which is a path to the image file we'll be using for this control. It also needs the function ❷ that it will call when the image is clicked.</p><p>Now we're ready to create this control. We create an image element programmatically ❸, just as we did with the <code class="literal">&lt;a&gt;</code> tag when making a custom control. Then we give the image a class name ❹ so we can style it with CSS. Finally we add the image URL ❺. This URL can be full or relative to the current page.</p><p>At this point, the image is created, but it's neither on the map, nor does it do anything. To fix those two issues, we set the function ❻ to be called when the user clicks and then append the image object as a child of the map object ❼.</p><p>Let's make sure our new image controls are positioned correctly. Add these CSS lines to your style sheet:</p><a id="I_programlisting4_d1e4332"/><pre class="programlisting">img.imgcontrol {
  position: relative;
  float: right;
  margin: 2px;
}</pre><p>Now we can add our custom zoom controls to the map. From within the initialization code for your map, add these lines:</p><a id="I_programlisting4_d1e4336"/><pre class="programlisting">create_image_control(❶"zoom-plus.png", function() {
❷ mapstraction.setZoom(mapstraction.getZoom()+1);
  });
  create_image_control("zoom-minus.png", function() {
    mapstraction.setZoom(mapstraction.getZoom()-1);
  });</pre><p>Here, I've created two image controls, as shown in <a class="xref" href="ch04s08.html#custom_zoom_images_on_a_map" title="Figure 4-11. Custom zoom images on a map">Figure 4-11</a>. The first is for zooming in. The CSS will place the control furthest to the right. I send it the name of my image ❶, which assumes it is stored in the same directory as the HTML page. Then I pass it an anonymous, inline function. Here, I set the zoom level ❷ using Mapstraction, passing a number one greater than the current zoom level.</p><div class="figure"><a id="custom_zoom_images_on_a_map"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4345"/><img src="httpatomoreillycomsourcenostarchimages672007.png.jpg" alt="Custom zoom images on a map"/></div></div><p class="title">Figure 4-11. Custom zoom images on a map</p></div><p>The second image control is similar. It is given a different image, and when clicked, it sets the zoom to one <span class="emphasis"><em>less</em></span> than the current zoom level.<a id="IDX-CHP-4-0058" class="indexterm"/><a id="IDX-CHP-4-0059" class="indexterm"/><a id="IDX-CHP-4-0060" class="indexterm"/><a id="IDX-CHP-4-0061" class="indexterm"/></p></div>
<div class="sect1" title="#24: Plot Image Thumbnails on a Map"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_24_colon_plot_image_thumbn"/>#24: Plot Image Thumbnails on a Map</h1></div></div></div><p>A picture may not be quite worth a thousand geographic points, but it's close. A map is a great way to show photos that have been <span class="emphasis"><em>geo-tagged</em></span>. Geo-tagging is associating latitude and longitude coordinates with images. Full-size photos may not be ideal, however, as they would take up too much space. Instead, a popular method is to display much smaller versions—thumbnails—that the viewer can expand.<a id="IDX-CHP-4-0062" class="indexterm"/></p><p>Of course, you'll need photos. You can use some that you have as a test or search the photo sharing site Flickr. I was able to find some good shots, already geo-tagged, by searching for Orlando, Florida. I looked specifically for photos that are licensed as Creative Commons, meaning they have less rigid copyright restrictions.<a id="IDX-CHP-4-0063" class="indexterm"/><a id="IDX-CHP-4-0064" class="indexterm"/></p><p>Though we will link to larger versions of each picture, we'll need separate files to store the smaller versions. Another plus to using Flickr is that it creates these thumbnails and a midsize image, too, automatically.</p><p>For each Orlando photo we plot, we're going to need the following:<a id="IDX-CHP-4-0065" class="indexterm"/><a id="IDX-CHP-4-0066" class="indexterm"/><a id="IDX-CHP-4-0067" class="indexterm"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Photo thumbnail</p></li><li class="listitem"><p>Latitude and longitude</p></li><li class="listitem"><p>Medium-sized photo</p></li><li class="listitem"><p>Dimensions of medium photo</p></li><li class="listitem"><p>Link to full photo</p></li></ul></div><p>At the very least you need the first two items, though you'll create a better user experience the more items from this list you can include. If, like me, you're using Flickr, then you'll need that link to avoid violating Creative Commons.</p><p>My three plotted thumbnails are shown on a map in <a class="xref" href="ch04s09.html#thumbnails_overlaid_as_custom_markers_op" title="Figure 4-12. Thumbnails overlaid as custom markers (Photos by Ron Miguel, Kok Leng Yeo, and LancerE)">Figure 4-12</a>. As in other situations where we may be doing one action many times, creating a function is best. Add this to your JavaScript code:</p><a id="I_programlisting4_d1e4429"/><pre class="programlisting">function plot_thumbnail(pt, thumbimg, medimg, medw, medh, link) {
    var mk = new Marker(pt);
❶ mk.setIcon(thumbimg, [50, 50]);
❷ mk.setShadowIcon('outline.png', [52, 52]);
    mk.setInfoBubble('&lt;a href=\"' + ❸link + '\"&gt;' +
                     '&lt;img src=\"' + ❹medimg + '\" width=\"' + ❺medw + '\"' +
                     ' height=\"' + ❻medh + '\" /&gt;&lt;/a&gt;');
    mapstraction.addMarker(mk);
  }</pre><p>As arguments to the function, we need to pass all the items I mentioned in the list. Then we create a custom marker using the thumbnail image ❶. Notice that I set the dimensions of the marker to be 50×50. You can use whatever size you want, but make sure the image itself is close to that size. Flickr's are 75 pixels square, so a little downsizing is okay.</p><p>Next, we want to set a shadow ❷ or else the default will be used (in Google Maps the default is a reverse teardrop, which would look funny underneath a square photo). I've created an outline graphic that gives a slight border to the image. I set the size to be slightly bigger than the thumbnail itself.</p><p>Finally, we add a message box. Remember, you can include any HTML inside, so we'll link to the full image ❸, as well as display the medium image ❹. To help the mapping provider determine how big to make the message box, we include the width ❺ and height ❻ of the midsized image.</p><p>Now we're ready to call the function:</p><a id="I_programlisting4_d1e4440"/><pre class="programlisting">plot_thumbnail(new LatLonPoint(28.4736, −81.4651),
               'http://farm3.static.flickr.com/2578/3769139951_954a782886_s.jpg',
               'http://farm3.static.flickr.com/2578/3769139951_954a782886_m.jpg',
               240, 180,
               'http://www.flickr.com/photos/lancerrevolution/3769139951/');</pre><div class="figure"><a id="thumbnails_overlaid_as_custom_markers_op"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4445"/><img src="httpatomoreillycomsourcenostarchimages672009.png.jpg" alt="Thumbnails overlaid as custom markers (Photos by Ron Miguel, Kok Leng Yeo, and LancerE)"/></div></div><p class="title">Figure 4-12. Thumbnails overlaid as custom markers (Photos by Ron Miguel, Kok Leng Yeo, and LancerE)</p></div><p>This function plots a single photo thumbnail on the map. Click the tiny version and it opens a message box showing the midsized version. Then, when you click the image, the Flickr link opens.<a id="IDX-CHP-4-0068" class="indexterm"/><a id="IDX-CHP-4-0069" class="indexterm"/></p><p>Now simply call that function two more times—or twenty. You can use the Flickr shots from my map as examples:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><a class="ulink" href="http://www.flickr.com/photos/kamoteus/2421383748/">http://www.flickr.com/photos/kamoteus/2421383748/</a></p></li><li class="listitem"><p><a class="ulink" href="http://www.flickr.com/photos/yeowatzup/461692550/">http://www.flickr.com/photos/yeowatzup/461692550/</a></p></li></ul></div><p>For a more advanced project, you could automate the process of finding images by tapping into the Flickr API to search near a geographic point. The API then responds back with XML or JSON, both of which you can parse using the techniques shown in <a class="xref" href="ch08.html" title="Chapter 8. DATA FORMATS">Chapter 8</a>.</p></div>
<div class="sect1" title="#25: Overlay an Image on a Map"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_25_colon_overlay_an_image"/>#25: Overlay an Image on a Map</h1></div></div></div><p>You can add an image to a map in a number of ways. In <a class="xref" href="ch02s05.html" title="#5: Create a Custom Icon Marker">#5: Create a Custom Icon Marker</a> in <a class="xref" href="ch02s04.html" title="#4: Show and Hide Message Boxes Without Clicking the Marker">#4: Show and Hide Message Boxes Without Clicking the Marker</a>, you used an image as the icon for a Placemark. In this section, we'll do something a bit different—overlaying an image over a larger area of the map, where it will replace or augment the existing map.</p><p>You're actually familiar with this process, as we used it earlier in this chapter, in <a class="xref" href="ch04s03.html" title="#18: Add Circles to Show Search Radius">#18: Add Circles to Show Search Radius</a> in <a class="xref" href="ch04s02.html#set_the_fill_color_and_opacity" title="Set the Fill Color and Opacity">Set the Fill Color and Opacity</a>. There, we used a circle image and geo-referenced it so the image was centered on a point and covered a specific area. That example was easier than what we want to do now because a circle is the same distance in every direction and it doesn't matter where it's pointing.</p><p>Consider, for example, the map of New York's Central Park in <a class="xref" href="ch04s10.html#central_park_source_graphic" title="Figure 4-13. Central Park source graphic">Figure 4-13</a>. It contains some buildings and landmarks that may not be on your standard web map. This map has the park perfectly oriented to be running north and south. In reality, the streets that border the long side of the park are slightly east of north (and west of south).</p><div class="figure"><a id="central_park_source_graphic"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4497"/><img src="httpatomoreillycomsourcenostarchimages672011.png.jpg" alt="Central Park source graphic"/></div></div><p class="title">Figure 4-13. Central Park source graphic</p></div><p>Mapstraction is only able to overlay a graphic if the top of its rectangle is at north exactly. To get the Central Park map to match the rest of New York, we need to geo-reference it.</p><div class="sect2" title="Geo-Reference Your Map"><div class="titlepage"><div><div><h2 class="title"><a id="geo-reference_your_map"/>Geo-Reference Your Map</h2></div></div></div><p>At the heart of the geo-referencing technique is the ability to determine the latitude and longitude of points on the graphic. Then, using those points, you can bend and warp the map so the top and bottom borders of the graphic are static latitudes (and the other two static longitudes).<a id="IDX-CHP-4-0070" class="indexterm"/><a id="IDX-CHP-4-0071" class="indexterm"/><a id="IDX-CHP-4-0072" class="indexterm"/><a id="IDX-CHP-4-0073" class="indexterm"/><a id="IDX-CHP-4-0074" class="indexterm"/><a id="IDX-CHP-4-0075" class="indexterm"/></p><p>This process is often called <span class="emphasis"><em>rubbersheeting</em></span>, because you are taking a two-dimensional reference, stretching it across a spherical earth, and then unfolding it so it's flat again. The result is a warped image, as if it were made of rubber.<a id="IDX-CHP-4-0076" class="indexterm"/></p><p>You can geo-reference a graphic to a map in a number of ways. Microsoft has a program called MapCruncher that works well. In this case, you'll need a Windows machine and the resulting graphic can only be used for noncommercial purposes. MetaCarta also has a web tool called Map Rectifier.</p><p>For this project, I'll be using a web application called Map Warper, which can be found at <a class="ulink" href="http://warper.geothings.net/">http://warper.geothings.net/</a>. Map Warper was built by Tim Waters and is open source and meant to free you from worries over how you can use the end result. You will need to create a free account to store your map images. Once you do, click the <span class="strong"><strong>Add Map</strong></span> link to start a new map.<a id="IDX-CHP-4-0077" class="indexterm"/></p><p>After you provide the name and other metadata to the map, you include a graphic. Browse your hard drive for the image you want to use. You can find the Central Park graphic that I'm using in this example at <a class="ulink" href="http://mapscripting.com/image-overlay/">http://mapscripting.com/image-overlay/</a>.</p><p>Click the <span class="strong"><strong>Rectify</strong></span> tab and you'll see your image on the left and a map on the right (see <a class="xref" href="ch04s10.html#map_warper_interface" title="Figure 4-14. Map Warper interface">Figure 4-14</a>). Move and zoom the map provided until you can see Central Park or the area you are geo-referencing. Now you want to add <span class="emphasis"><em>control points</em></span> wherever you can identify a spot in the left graphic whose coordinates you can determine in the map on the right.</p><div class="figure"><a id="map_warper_interface"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4564"/><img src="httpatomoreillycomsourcenostarchimages672013.png.jpg" alt="Map Warper interface"/></div></div><p class="title">Figure 4-14. Map Warper interface</p></div><p>For example, I chose my first point at Columbus Circle in the lower left of the Central Park graphic. Once I can see Columbus Circle on both screens, I click the marker button (see the circle in <a class="xref" href="ch04s10.html#map_warper_interface" title="Figure 4-14. Map Warper interface">Figure 4-14</a>) and the spot on the left. Then I click the same spot on the right side. Finally, I click the <span class="strong"><strong>Add Control Point</strong></span> button and the marker changes so the number 1 appears inside it, as shown in <a class="xref" href="ch04s10.html#first_control_point_for_geo-referencing" title="Figure 4-15. First control point for geo-referencing">Figure 4-15</a>.</p><div class="figure"><a id="first_control_point_for_geo-referencing"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4581"/><img src="httpatomoreillycomsourcenostarchimages672015.png.jpg" alt="First control point for geo-referencing"/></div></div><p class="title">Figure 4-15. First control point for geo-referencing</p></div><p>To find additional points that are off the screen, remember to switch from the marker to the hand, which will allow you to move the image again. You'll need to do the same thing with the map on the right. Continue this process until you have a handful of points. Map Warper suggests at least three points, but I've found it often takes more.</p><p>The Central Park example is easier than some, as New York City has a nice set of grid streets to use as references. <a class="xref" href="ch04s10.html#more_control_points_produces_a_better_re" title="Figure 4-16. More control points produces a better rectified map">Figure 4-16</a> shows the seven points I chose for this example. When you are finished adding control points, scroll to the bottom and click <span class="strong"><strong>Warp Image</strong></span>.</p><div class="figure"><a id="more_control_points_produces_a_better_re"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4599"/><img src="httpatomoreillycomsourcenostarchimages672017.png.jpg" alt="More control points produces a better rectified map"/></div></div><p class="title">Figure 4-16. More control points produces a better rectified map</p></div><p>The system will whirl and whiz for a bit. When it responds that the map has been rectified, you can scroll back to the top and click the <span class="strong"><strong>Preview Rectified</strong></span> tab. A map with your image warped and overlaid on top will appear, as shown in <a class="xref" href="ch04s10.html#preview_of_geo-referenced_central_park_m" title="Figure 4-17. Preview of geo-referenced Central Park map">Figure 4-17</a>. You can move the slider at the bottom to change your image's opacity. Moving the marker all the way to the right makes the image completely opaque, meaning it completely covers the original map.<a id="IDX-CHP-4-0078" class="indexterm"/></p><div class="figure"><a id="preview_of_geo-referenced_central_park_m"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4617"/><img src="httpatomoreillycomsourcenostarchimages672019.png.jpg" alt="Preview of geo-referenced Central Park map"/></div></div><p class="title">Figure 4-17. Preview of geo-referenced Central Park map</p></div><p>Move the slider back and forth to determine how well your image matches the source map. If you aren't satisfied with the results, click the <span class="strong"><strong>Rectify</strong></span> tab and add a few more points.</p></div><div class="sect2" title="Apply Warped Map"><div class="titlepage"><div><div><h2 class="title"><a id="apply_warped_map"/>Apply Warped Map</h2></div></div></div><p>When you're happy with the result of your warped image, click the <span class="strong"><strong>Export</strong></span> link to download the image to use it in your own project. You'll want to get the PNG-formatted version. <a class="xref" href="ch04s10.html#central_park_image_comma_warped_from_geo" title="Figure 4-18. Central Park image, warped from geo-referencing">Figure 4-18</a> shows how different my Central Park graphic is now that it has been geo-referenced.</p><div class="figure"><a id="central_park_image_comma_warped_from_geo"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4640"/><img src="httpatomoreillycomsourcenostarchimages672021.png.jpg" alt="Central Park image, warped from geo-referencing"/></div></div><p class="title">Figure 4-18. Central Park image, warped from geo-referencing</p></div><p>In order to overlay the warped image on your map using Mapstraction, you need to know the boundaries of the image rectangle. To find this information within Map Warper, click the <span class="strong"><strong>Activity</strong></span> tab, where you'll see a table showing the timeline of your geo-referencing session. The topmost item is likely Map Successfully Rectified. Click the <span class="strong"><strong>Further Details</strong></span> link for that row and you'll see more details, including a box with a list of four decimal numbers. Highlight and copy these, which should already be in order: west, north, east, and south.<a id="IDX-CHP-4-0079" class="indexterm"/></p><p>Now you can add the overlay code to your Mapstraction map:</p><a id="I_programlisting4_d1e4658"/><pre class="programlisting">mapstraction.addImageOverlay(❶'centralpark', ❷'centralpark-warped.png', ❸100,
                             ❹-73.9867415, 40.7622753, −73.9460798, 40.8032834);</pre><p>In order to add our warped image to the map, we need to give it an identifier ❶. We let Mapstraction know the path to the warped image ❷ (here, I've assumed the image is in the same directory as the HTML file). Then, we give an opacity percentage ❸ between 0 (invisible) and 100 (hidden—no map can be seen under the image). Finally, we add the four numbers from Map Warper ❹ that describe the geographic box where the image will reside.</p><p><a class="xref" href="ch04s10.html#central_park_geo-referenced_image_overla" title="Figure 4-19. Central Park geo-referenced image overlay on a Google Map">Figure 4-19</a> shows the finished map, with the Central Park graphic completely obscuring the Google Map under it.</p><div class="figure"><a id="central_park_geo-referenced_image_overla"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e4668"/><img src="httpatomoreillycomsourcenostarchimages672023.png.jpg" alt="Central Park geo-referenced image overlay on a Google Map"/></div></div><p class="title">Figure 4-19. Central Park geo-referenced image overlay on a Google Map</p></div><p>You can use your own map imagery over larger areas as well. Storing an entire city or more of data in a single image won't work very well, however. Instead, see the next project, which shows how to create your own imagery to display a little bit at a time.</p></div></div>
<div class="sect1" title="#26: Use Custom Tiles"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_26_colon_use_custom_tiles"/>#26: Use Custom Tiles</h1></div></div></div><p>Most providers allow you to choose from a handful of imagery types for your maps. You can show satellite view, road maps, or a hybrid version. You're not the cookie-cutter type though, are you? You like the glitz and glamour of choosing your own shade of green for parks or your own thickness for roads. To do this, you'll need custom tiles. And what better place for your glitz and glamour than the Las Vegas strip?<a id="IDX-CHP-4-0080" class="indexterm"/><a id="IDX-CHP-4-0081" class="indexterm"/><a id="IDX-CHP-4-0082" class="indexterm"/><a id="IDX-CHP-4-0083" class="indexterm"/><a id="IDX-CHP-4-0084" class="indexterm"/><a id="IDX-CHP-4-0085" class="indexterm"/><a id="IDX-CHP-4-0086" class="indexterm"/><a id="IDX-CHP-4-0087" class="indexterm"/></p><p>To create Vegas tiles, we'll need the data about streets and other features. Although mapping providers are liberal in what they allow you to do with their APIs, most hold the underlying data like a poker player does his or her cards. One that makes its data widely available is OpenStreetMap, the free editable map of the world. Of course, distributing the details of every street on earth means the file is pretty big, so region-specific downloads are also available. In this project, for example, we'll just use the data for Nevada, the state where Las Vegas is located.<a id="IDX-CHP-4-0088" class="indexterm"/></p><p>To create the tiles, we'll plug the data into an open source program called Mapnik. Because Mapnik can be a bit complicated to install and configure, we'll take advantage of another project called Tile Drawer, which provides an Amazon EC2 machine image to do much of the technical work. First, let's get a feel for how tiles are used by mapping providers.<a id="IDX-CHP-4-0089" class="indexterm"/><a id="IDX-CHP-4-0090" class="indexterm"/><a id="IDX-CHP-4-0091" class="indexterm"/></p><div class="sect2" title="How Many Pixels Wide Is the Earth?"><div class="titlepage"><div><div><h2 class="title"><a id="how_many_pixels_wide_is_the_earth_questi"/>How Many Pixels Wide Is the Earth?</h2></div></div></div><p>As described in <a class="xref" href="ch01.html" title="Chapter 1. MAPPING BASICS">Chapter 1</a>, a map is made up of tiles arranged to appear as one large image. Each tile is 256 pixels square and organized as a grid. Most providers reference the grid left to right and north to south, beginning in the Arctic Ocean above Alaska. Tiles are referenced by their number in the grid, such as <code class="literal">(14, 34)</code>.</p><p>The number of tiles required to display the entire earth depends on the zoom level. For example, at its most zoomed out, which is zoom level 0 in Mapstraction, the earth can be shown on a single tile. Each time you zoom in, it takes four tiles to show the detail that was previously displayed on one tile. You can find the number of tiles used in each direction by determining 2 to the <span class="emphasis"><em>zoom level</em></span> power (2<span class="emphasis"><em>zoom level</em></span>). <a class="xref" href="ch04s11.html#tiles_and_pixels_at_each_zoom_level" title="Table 4-1. Tiles and Pixels at Each Zoom Level">Table 4-1</a> shows tile and pixel information at each zoom level.</p><p>When a mapping provider loads map tiles, it uses three numbers: the zoom level, the number of tiles from the left, and the number of tiles from the top. All of these numbers begin at zero, so the upper left of the map at every zoom level is <code class="literal">(0, 0)</code>. The upper right at level 6, for example, is <code class="literal">(16383, 0)</code>.</p><div class="table"><a id="tiles_and_pixels_at_each_zoom_level"/><p class="title">Table 4-1. Tiles and Pixels at Each Zoom Level</p><div class="table-contents"><table summary="Tiles and Pixels at Each Zoom Level" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Zoom level<a id="IDX-CHP-4-0092" class="indexterm"/></p></th><th style="text-align: left" valign="bottom"><p>Tiles wide/tall</p></th><th style="text-align: left" valign="bottom"><p>Pixels wide/tall</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p>0</p></td><td style="text-align: left" valign="top"><p>1</p></td><td style="text-align: left" valign="top"><p>256</p></td></tr><tr><td style="text-align: left" valign="top"><p>1</p></td><td style="text-align: left" valign="top"><p>2</p></td><td style="text-align: left" valign="top"><p>512</p></td></tr><tr><td style="text-align: left" valign="top"><p>2</p></td><td style="text-align: left" valign="top"><p>4</p></td><td style="text-align: left" valign="top"><p>1,024</p></td></tr><tr><td style="text-align: left" valign="top"><p>3</p></td><td style="text-align: left" valign="top"><p>8</p></td><td style="text-align: left" valign="top"><p>2,048</p></td></tr><tr><td style="text-align: left" valign="top"><p>4</p></td><td style="text-align: left" valign="top"><p>16</p></td><td style="text-align: left" valign="top"><p>4,096</p></td></tr><tr><td style="text-align: left" valign="top"><p>5</p></td><td style="text-align: left" valign="top"><p>32</p></td><td style="text-align: left" valign="top"><p>8,192</p></td></tr><tr><td style="text-align: left" valign="top"><p>6</p></td><td style="text-align: left" valign="top"><p>64</p></td><td style="text-align: left" valign="top"><p>16,384</p></td></tr><tr><td style="text-align: left" valign="top"><p>7</p></td><td style="text-align: left" valign="top"><p>128</p></td><td style="text-align: left" valign="top"><p>32,768</p></td></tr><tr><td style="text-align: left" valign="top"><p>8</p></td><td style="text-align: left" valign="top"><p>256</p></td><td style="text-align: left" valign="top"><p>65,536</p></td></tr><tr><td style="text-align: left" valign="top"><p>9</p></td><td style="text-align: left" valign="top"><p>512</p></td><td style="text-align: left" valign="top"><p>131,072</p></td></tr><tr><td style="text-align: left" valign="top"><p>10</p></td><td style="text-align: left" valign="top"><p>1,024</p></td><td style="text-align: left" valign="top"><p>262,144</p></td></tr><tr><td style="text-align: left" valign="top"><p>11</p></td><td style="text-align: left" valign="top"><p>2,048</p></td><td style="text-align: left" valign="top"><p>524,288</p></td></tr><tr><td style="text-align: left" valign="top"><p>12</p></td><td style="text-align: left" valign="top"><p>4,096</p></td><td style="text-align: left" valign="top"><p>1,048,576</p></td></tr><tr><td style="text-align: left" valign="top"><p>13</p></td><td style="text-align: left" valign="top"><p>8,192</p></td><td style="text-align: left" valign="top"><p>2,097,152</p></td></tr><tr><td style="text-align: left" valign="top"><p>14</p></td><td style="text-align: left" valign="top"><p>16,384</p></td><td style="text-align: left" valign="top"><p>4,194,304</p></td></tr><tr><td style="text-align: left" valign="top"><p>15</p></td><td style="text-align: left" valign="top"><p>32,768</p></td><td style="text-align: left" valign="top"><p>8,388,608</p></td></tr><tr><td style="text-align: left" valign="top"><p>16</p></td><td style="text-align: left" valign="top"><p>65,536</p></td><td style="text-align: left" valign="top"><p>16,777,216</p></td></tr><tr><td style="text-align: left" valign="top"><p>17</p></td><td style="text-align: left" valign="top"><p>131,072</p></td><td style="text-align: left" valign="top"><p>33,554,432</p></td></tr><tr><td style="text-align: left" valign="top"><p>18</p></td><td style="text-align: left" valign="top"><p>262,144</p></td><td style="text-align: left" valign="top"><p>67,108,864</p></td></tr></tbody></table></div></div><p>Thankfully, you don't need to reference the tiles by their grid location. The mapping provider does all this for you. Understanding how it works is important because you'll need to use this knowledge to create custom tile URLs later in this project.</p><p>As for the question at the top of this section—how many pixels wide is the earth? It depends on the zoom level, but for most providers, the earth is between 256 and 67,108,864 pixels wide.</p></div><div class="sect2" title="Start a Tile Drawer EC2 Instance"><div class="titlepage"><div><div><h2 class="title"><a id="start_a_tile_drawer_ec2_instance"/>Start a Tile Drawer EC2 Instance</h2></div></div></div><p>Tile Drawer helps you create your own custom map tiles and runs a tile server in the cloud. It runs on top of Amazon EC2, which is an <span class="emphasis"><em>elastic compute cloud</em></span>, that is, an expandable web server. Another feature of EC2 is the ability to save preconfigured servers, Amazon Machine Images (AMIs), and make them available to others. That's what the creators of Tile Drawer have done. Handy!<a id="IDX-CHP-4-0093" class="indexterm"/><a id="IDX-CHP-4-0094" class="indexterm"/></p><p>You will need an Amazon account (be prepared to provide your email address and a few other bits of information) and then sign up for EC2. Amazon charges for this service, but does so for cents per hour, so you'll be able to try this project for less than a dollar. This page will walk you through the signup process: <a class="ulink" href="http://aws.amazon.com/ec2/">http://aws.amazon.com/ec2/</a>.<a id="IDX-CHP-4-0095" class="indexterm"/><a id="IDX-CHP-4-0096" class="indexterm"/></p><p>Log in to the AWS Management Console from this page. Click the <span class="strong"><strong>Launch Instance</strong></span> button. Then search the Community AMIs for the Tile Drawer machine image. Look for <span class="emphasis"><em>tiledrawer</em></span>, or find the ID, such as <code class="literal">ami-e1ea0a88</code>, listed on <a class="ulink" href="http://tiledrawer.com/">http://tiledrawer.com/</a>. When you find the Tile Drawer AMI, click the <span class="strong"><strong>Select</strong></span> button.<a id="IDX-CHP-4-0097" class="indexterm"/><a id="IDX-CHP-4-0098" class="indexterm"/></p><p>On the Instance Details screen, only create one instance, as shown in <a class="xref" href="ch04s11.html#create_a_single_amazon_ec2_tile_drawer_i" title="Figure 4-20. Create a single Amazon EC2 Tile Drawer instance">Figure 4-20</a>. Because you'll be using a very small area to start, you can get away with a small instance type. Click the <span class="strong"><strong>Continue</strong></span> button, and then on the next screen, you mostly leave the default settings in place. You'll need to add some user data, however.</p><div class="figure"><a id="create_a_single_amazon_ec2_tile_drawer_i"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e5030"/><img src="httpatomoreillycomsourcenostarchimages672025.png.jpg" alt="Create a single Amazon EC2 Tile Drawer instance"/></div></div><p class="title">Figure 4-20. Create a single Amazon EC2 Tile Drawer instance</p></div></div><div class="sect2" title="Declare User Data for Your Instance"><div class="titlepage"><div><div><h2 class="title"><a id="declare_user_data_for_your_instance"/>Declare User Data for Your Instance</h2></div></div></div><p>The Tile Drawer server is fairly plug and play. Just a few settings are necessary to make it run. As you'll see later, these settings also allow you to fully customize your map tiles.</p><p>You can use the wizard on <a class="ulink" href="http://tiledrawer.com/">http://tiledrawer.com/</a> to help you create the user data automatically. Or to continue following along with this example, paste the following data in the User Data box on the EC2 setup page (see <a class="xref" href="ch04s11.html#adding_user_data_to_the_ec2_instance" title="Figure 4-21. Adding user data to the EC2 instance">Figure 4-21</a>):</p><a id="I_programlisting4_d1e5046"/><pre class="programlisting">{
  "style": "http://tiledrawer.com/mapscratch.mml",
  "bbox": [−115.2, 36.10, −115.1, 36.15],
  "source": "http://downloads.cloudmade.com/north_america/
united_states/nevada/nevada.osm.bz2",
  "coast": "http://hypercube.telascience.org/~kleptog/processed_p.zip"
}</pre><p>This data has four preferences. First, the style of the map, which uses a CSS-like style sheet. We'll stick with the basic look from Tile Drawer for this first example and make changes later. Next, we declare a <code class="literal">BoundingBox</code>, similar to those we've used with Mapstraction. The difference here is that longitudes are listed before latitudes. The two points we use are still southwest followed by northeast.</p><p>The last two items are URLs to files that Tile Drawer will download and use. The first is the data itself. We're using the data for Nevada, which is hosted by CloudMade. You can find the data you need at <a class="ulink" href="http://downloads.cloudmade.com/">http://downloads.cloudmade.com/</a>. Look for files of type <span class="emphasis"><em>.osm.bz2</em></span>. The final URL is the coastline data, which is hosted separately.<a id="IDX-CHP-4-0099" class="indexterm"/></p><div class="figure"><a id="adding_user_data_to_the_ec2_instance"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e5066"/><img src="httpatomoreillycomsourcenostarchimages672027.png.jpg" alt="Adding user data to the EC2 instance"/></div></div><p class="title">Figure 4-21. Adding user data to the EC2 instance</p></div><p>With the user data set, click <span class="strong"><strong>Continue</strong></span> again. The next screen will prompt you to create a key pair. The key pair enables you to connect to the server's backend. This advanced feature may be useful at some point in the future. For now, select <span class="strong"><strong>Proceed without a Key Pair</strong></span>, and click <span class="strong"><strong>Continue</strong></span>.</p><p>On the firewall screen, make sure you select the webserver security group. This group opens up the appropriate ports for running a web server, which is necessary for accessing your tiles from any computer, including your own. Click <span class="strong"><strong>Continue</strong></span> and you'll be on the final screen. Take a deep breath and then click <span class="strong"><strong>Launch</strong></span>.</p></div><div class="sect2" title="Tile Drawer Does Its Job"><div class="titlepage"><div><div><h2 class="title"><a id="tile_drawer_does_its_job"/>Tile Drawer Does Its Job</h2></div></div></div><p>Your EC2 instance will not instantly start up. Although it's a virtual computer, it still takes a few minutes to boot. Once it is available, creating all the tiles will take some additional time. This is a great time for a break!</p><p>But you shouldn't need <span class="emphasis"><em>too</em></span> long of a break. With only one state of data to download and a small area to prepare, Tile Drawer should be ready in less than 15 minutes. From your EC2 dashboard, you should be able to click the <span class="strong"><strong>Running Instances</strong></span> link under My Resources. From there, you can see the status of your new instance. When the server has booted up, it should switch from yellow and pending to green and running.<a id="IDX-CHP-4-0100" class="indexterm"/></p><p>When the server is running, click your instance and a description will appear in the pane below. Scroll down and locate the Public DNS address, as shown in <a class="xref" href="ch04s11.html#instance_details_shows_your_public_dns_a" title="Figure 4-22. Instance details shows your Public DNS address.">Figure 4-22</a>. This address is the equivalent of a domain name for your new virtual server. Enter that address in your web browser and you should see a page that says, "It works!"</p><div class="figure"><a id="instance_details_shows_your_public_dns_a"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e5113"/><img src="httpatomoreillycomsourcenostarchimages672029.png.jpg" alt="Instance details shows your Public DNS address."/></div></div><p class="title">Figure 4-22. Instance details shows your Public DNS address.</p></div><p>Next, add <span class="emphasis"><em>/status.php</em></span> to the end of your address to get Tile Drawer's status. Tile Drawer goes through to create tiles: Getting Started, Downloading Source, Extracting Data, Creating Tables, Importing Coastline, Downloading Stylesheet, and Creating TileCache. As it completes each step, it will become grayed out, as shown in <a class="xref" href="ch04s11.html#tile_drawer_apostrophy_s_status_updates" title="Figure 4-23. Tile Drawer's status updates as each section finishes.">Figure 4-23</a>. When Tile Dawer is done, you can click the link or go to your address followed by <span class="emphasis"><em>/preview.php</em></span>.<a id="IDX-CHP-4-0101" class="indexterm"/><a id="IDX-CHP-4-0102" class="indexterm"/><a id="IDX-CHP-4-0103" class="indexterm"/></p><div class="figure"><a id="tile_drawer_apostrophy_s_status_updates"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e5144"/><img src="httpatomoreillycomsourcenostarchimages672031.png.jpg" alt="Tile Drawer's status updates as each section finishes."/></div></div><p class="title">Figure 4-23. Tile Drawer's status updates as each section finishes.</p></div><p>You'll see a quick preview of your new tiles on the Tile Drawer server. You can double-click to zoom in. If everything looks good, the time has come to put those tiles on a Mapstraction map.</p></div><div class="sect2" title="Add Tile Overlays to Your Map"><div class="titlepage"><div><div><h2 class="title"><a id="add_tile_overlays_to_your_map"/>Add Tile Overlays to Your Map</h2></div></div></div><p>The process of including your tiles in Mapstraction is as easy as a single line of code. The hard work is behind you with setting up the tile server—and also ahead of you in creating the styles, which can be a tedious.</p><p>Create a new basic map using the following code:</p><a id="I_programlisting4_d1e5158"/><pre class="programlisting">function create_map() {
  mapstraction = new mxn.Mapstraction('mymap', 'googlev3');
  mapstraction.setCenterAndZoom(
    new mxn.LatLonPoint(36.123, −115.167), 13);
  mapstraction.addSmallControls();
 <strong class="userinput"><code> mapstraction.addTileLayer(</code></strong>
   <strong class="userinput"><code> "http://</code></strong><strong class="userinput"><code><em class="replaceable"><code>yourserver</code></em></code></strong><strong class="userinput"><code>.amazonaws.com/
tilecache/1.0.0/osm/</code></strong>❶<strong class="userinput"><code>{Z}/{X}/{Y}.png",</code></strong> ❷1.0);
}</pre><p>Here we have created a map centered on the Las Vegas strip. Then, in the line in bold, we tell Mapstraction where to find our tiles. Our URL contains placeholders for zoom level ❶ and the tile grid coordinates. These values, <code class="literal">{Z}</code>, <code class="literal">{X}</code>, and <code class="literal">{Y}</code>, are filled in with actual numbers. You can see an example tile by going to <span class="emphasis"><em>yourserver.amazonaws.com/tilecache/1.0.0/osm/13/1475/3213.png</em></span>. Be sure to replace <span class="emphasis"><em>yourserver</em></span> with the Public DNS address of your EC2 instance.<a id="IDX-CHP-4-0104" class="indexterm"/></p><p>The second argument that we pass to Mapstraction's tile layer function is an opacity. Like in <a class="xref" href="ch04s10.html" title="#25: Overlay an Image on a Map">#25: Overlay an Image on a Map</a> in <a class="xref" href="ch04s10.html" title="#25: Overlay an Image on a Map">#25: Overlay an Image on a Map</a>, we can make our tiles semitransparent so we can still see some of the provider imagery underneath. Here I made our tiles completely opaque ❷ by choosing a value of one. A number between zero and one sets the percentage. For example, 0.6 would be 60 percent opaque.<a id="IDX-CHP-4-0105" class="indexterm"/></p><p>Save your map and load it in a browser. You should now see your custom Las Vegas tiles instead of the Google imagery, like in <a class="xref" href="ch04s11.html#custom_tiles_using_tile_drawer_apostroph" title="Figure 4-24. Custom tiles using Tile Drawer's &quot;scratch&quot; style sheet">Figure 4-24</a>. You may catch a glimpse of the default look before your tiles load. That's because the custom tiles are being placed on top of Google, so both sets still need to load.</p><div class="figure"><a id="custom_tiles_using_tile_drawer_apostroph"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e5213"/><img src="httpatomoreillycomsourcenostarchimages672033.png.jpg" alt="Custom tiles using Tile Drawer's &quot;scratch&quot; style sheet"/></div></div><p class="title">Figure 4-24. Custom tiles using Tile Drawer's "scratch" style sheet</p></div></div><div class="sect2" title="Create Your Own Tile Styles"><div class="titlepage"><div><div><h2 class="title"><a id="create_your_own_tile_styles"/>Create Your Own Tile Styles</h2></div></div></div><p>If you are familiar with CSS for styling web pages, you will likely feel comfortable with the way Tile Drawer applies colors and other styles to maps. It uses Cascadenik to convert into the file format necessary to work with the Mapnik tile generator. Earlier in this project, we used a basic example provided by Tile Drawer. Now we'll try changing a few of the colors and road widths.<a id="IDX-CHP-4-0106" class="indexterm"/><a id="IDX-CHP-4-0107" class="indexterm"/><a id="IDX-CHP-4-0108" class="indexterm"/><a id="IDX-CHP-4-0109" class="indexterm"/></p><p>The first thing you'll need is to copy <a class="ulink" href="http://tiledrawer.com/mapscratch.mml">http://tiledrawer.com/mapscratch.mml</a> to your own server. Or you can use the version I have edited for this section at <a class="ulink" href="http://mapscripting.com/examples/tiledrawer/mapscratch-edits.mml">http://mapscripting.com/examples/tiledrawer/mapscratch-edits.mml</a>.</p><p>Because Vegas is famous for its neon lights, let's aim to make the roads pop out from the map. To do this, we'll use bright colors and a dark background. Find the line that begins with <code class="literal">#land</code> and change it, using this styling data:</p><a id="I_programlisting4_d1e5248"/><pre class="programlisting">#land { polygon-fill: #333; }</pre><p>This data changes the land, which is essentially the background color, from a very light color to nearly black. Black is very Vegas, especially when we include the bright colors. For these next changes, you'll need to use the styles that begin with the <code class="literal">#lines</code>. Be sure your code matches these settings:</p><a id="I_programlisting4_d1e5255"/><pre class="programlisting">#lines[❶highway=motorway],
  #lines[highway=motorway_link]
  {
❷  line-width: 6;
❸  line-color: #f00;
  }
  #lines[highway=primary],
  #lines[highway=secondary],
  #lines[highway=tertiary]
  {
    line-width: 4;
    line-color: ❹#ff0;
  }
  #lines[highway=residential],
  #lines[highway=unclassified],
  #lines[highway=service]
  {
    line-width: 2;
    line-color: ❺#00f;
  }</pre><p>Cascadenik style sheets use OpenStreetMap tags inside the square brackets to determine which elements you want to style. In all these examples, we're styling highways, a generic term for any road. In the first set, we apply the styles only to motorways ❶ and motorway "links" (such as off-ramps). Since everything is bigger and brighter in Vegas, we make the motorways wider ❷ and then color them a bright red ❸.<a id="IDX-CHP-4-0110" class="indexterm"/><a id="IDX-CHP-4-0111" class="indexterm"/></p><p>In the next two sections, we set the larger streets to be yellow ❹. Residential and other small streets are set to blue ❺. As the streets get smaller, so do their widths on the map. Seeing as we're doing this Vegas-style, however, they're still larger than the styles we're editing.</p><p>You can do some powerful things with these styles to make your maps look unlike any imagery available. As one example of how specific you can get with styles, try adding these lines to your style sheet:</p><a id="I_programlisting4_d1e5273"/><pre class="programlisting">#lines<strong class="userinput"><code>[zoom=13]</code></strong>[highway=motorway]
{
  line-color: #ff8000;
}</pre><p>At first glance, this code is similar to some we've already done. Pay attention to the bolded section; it tells the tile server to only apply this style when the zoom level is 13. At all other zoom levels, our other styles will take precedence. But when our map is at level 13, the motorways will be orange instead of red.</p><p>I didn't reset the line width, as I did in other sections, which means the line width already set for motorways will remain the same for zoom level 13. Only the color will change. In addition to <code class="literal">=</code>, you can use <code class="literal">&gt;</code>, <code class="literal">&gt;=</code>, <code class="literal">&lt;</code>, and <code class="literal">&lt;=</code> to style at certain zoom levels.</p><p>With a few styles changed, let's see Tile Drawer in action. Create a new EC2 instance (remember to terminate those not in use to avoid the hourly charges) with the following data:</p><a id="I_programlisting4_d1e5300"/><pre class="programlisting">{
  "style": "<strong class="userinput"><code>http://mapscripting.com/examples/tiledrawer/mapscratch-edits.mml</code></strong>",
  "bbox": [−115.2, 36.10, −115.1, 36.15],
  "source": "http://downloads.cloudmade.com/north_america/
united_states/nevada/nevada.osm.bz2",
  "coast": "http://hypercube.telascience.org/~kleptog/processed_p.zip"
}</pre><p>If you've made changes that I didn't include here, good for you! In that case, replace the URL in bold with the address of the map style sheet on your own server. To get a feel for how these few changes alters the look of our tiles, see <a class="xref" href="ch04s11.html#big_roads_and_bright_colors_style_the_la" title="Figure 4-25. Big roads and bright colors style the Las Vegas map">Figure 4-25</a>.</p><div class="figure"><a id="big_roads_and_bright_colors_style_the_la"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject4_d1e5312"/><img src="httpatomoreillycomsourcenostarchimages672035.png.jpg" alt="Big roads and bright colors style the Las Vegas map"/></div></div><p class="title">Figure 4-25. Big roads and bright colors style the Las Vegas map</p></div><p>After a short wait as your virtual server boots and Tile Drawer does its work, your newly styled Las Vegas tiles should be ready. Update the address of your server in the Mapstraction file you used to create a tile layer. Load it up and you should see the bright roads of Vegas popping out from your new map.</p></div></div></body></html>