<html><head></head><body><div class="appendix" title="Appendix&#xA0;C.&#xA0;Mitigation"><div class="titlepage"><div><div><h1 class="title"><a id="mitigation"/>Appendix C. Mitigation</h1></div></div></div><p>This appendix contains information about mitigation techniques.<a id="IDX-APP-C-0092" class="indexterm"/><a id="IDX-APP-C-0093" class="indexterm"/></p><div class="sect1" title="C.1 Exploit Mitigation Techniques"><div class="titlepage"><div><div><h1 class="title"><a id="c.1_exploit_mitigation_techniques"/>C.1 Exploit Mitigation Techniques</h1></div></div></div><p>Various exploit mitigation techniques and mechanisms available today are designed to make exploiting memory corruption vulnerabilities as difficult as possible. The most prevalent ones are these:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Address Space Layout Randomization (ASLR)<a id="IDX-APP-C-0094" class="indexterm"/></p></li><li class="listitem"><p>Security Cookies (/GS), Stack-Smashing Protection (SSP), or Stack Canaries<a id="IDX-APP-C-0095" class="indexterm"/><a id="IDX-APP-C-0096" class="indexterm"/></p></li><li class="listitem"><p>Data Execution Prevention (DEP) or No eXecute (NX)<a id="IDX-APP-C-0097" class="indexterm"/></p></li></ul></div><p>There are other mitigation techniques that are bound to an operating system platform, a special heap implementation, or a file format like SafeSEH, SEHOP, or RELRO (see Section C.2). There are also various heap mitigation techniques (heap cookies, randomization, safe unlinking, etc.).<a id="IDX-APP-C-0098" class="indexterm"/></p><p>The many mitigation techniques could easily fill another book, so I will focus on the most prevalent ones, as well as on some tools used to detect them.<a id="IDX-APP-C-0099" class="indexterm"/><a id="IDX-APP-C-0100" class="indexterm"/><a id="IDX-APP-C-0101" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>There is a continuous race between exploit mitigation techniques and ways of bypassing them. Even systems using all of these mechanisms may be successfully exploited under certain circumstances.</p></div><div class="sect2" title="Address Space Layout Randomization (ASLR)"><div class="titlepage"><div><div><h2 class="title"><a id="address_space_layout_randomization_open"/>Address Space Layout Randomization (ASLR)</h2></div></div></div><p>ASLR randomizes the location of key areas of a process space (usually the base address of the executable, the position of the stack, the heap, the libraries, and others) to prevent an exploit writer from predicting target addresses. Say you find a <span class="emphasis"><em>write4 primitive</em></span> vulnerability that presents you with the opportunity to write 4 bytes of your choosing to any memory location you like. That gives you a powerful exploit if you choose a stable memory location to overwrite. If ASLR is in place, it’s much harder to find a reliable memory location to overwrite. Of course, ASLR is effective only if it’s implemented correctly.<sup>[<a href="apcs03.html#ftn.APP-C-FN-1" class="footnoteref">100</a>]</sup></p></div><div class="sect2" title="Security Cookies (/GS), Stack-Smashing Protection (SSP), or Stack Canaries"><div class="titlepage"><div><div><h2 class="title"><a id="security_cookies_open_parenthesis_solidu"/>Security Cookies (/GS), Stack-Smashing Protection (SSP), or Stack Canaries</h2></div></div></div><p>These methods normally inject a canary or cookie into a stack frame to protect the function’s metadata associated with procedure invocation (e.g., the return address). Before the return address is processed, the validity of the cookie or canary is checked, and the data in the stack frame is reorganized to protect the pointers and arguments of the function. If you find a stack buffer overflow in a function that is protected by this mitigation technique, exploitation can be tough.<sup>[<a href="apcs03.html#ftn.APP-C-FN-2" class="footnoteref">101</a>]</sup></p></div><div class="sect2" title="NX and DEP"><div class="titlepage"><div><div><h2 class="title"><a id="nx_and_dep"/>NX and DEP</h2></div></div></div><p>The <span class="emphasis"><em>No eXecute (NX)</em></span> bit is a CPU feature that helps prevent code execution from data pages of a process. Many modern operating systems take advantage of the NX bit. Under Microsoft Windows, hardware-enforced <span class="emphasis"><em>Data Execution Prevention (DEP)</em></span> enables the NX bit on compatible CPUs and marks all memory locations in a process as nonexecutable unless the location explicitly contains executable code. DEP was introduced in Windows XP SP2 and Windows Server 2003 SP1. Under Linux, NX is enforced by the kernel on 64-bit CPUs of AMD and Intel. ExecShield<sup>[<a href="apcs03.html#ftn.APP-C-FN-3" class="footnoteref">102</a>]</sup> and PaX<sup>[<a href="apcs03.html#ftn.APP-C-FN-4" class="footnoteref">103</a>]</sup> emulate the NX functionality on older 32-bit x86 CPUs under Linux.<a id="IDX-APP-C-0102" class="indexterm"/></p></div><div class="sect2" title="Detecting Exploit Mitigation Techniques"><div class="titlepage"><div><div><h2 class="title"><a id="detecting_exploit_mitigation_techniques"/>Detecting Exploit Mitigation Techniques</h2></div></div></div><p>Before you can try to circumvent these mitigation techniques, you have to determine which ones an application or a running process actually uses.<a id="IDX-APP-C-0103" class="indexterm"/><a id="IDX-APP-C-0104" class="indexterm"/></p><p>Mitigations can be controlled by system policy, by special APIs, and by compile-time options. For example, the default system-wide DEP policy for Windows client–operating systems is called OptIn. In this mode of operation, DEP is enabled only for processes that explicitly opt in to DEP. There are different ways to opt a process in to DEP. For example, you could use the appropriate linker switch (/NXCOMPAT) at compile time, or you could use the <code class="literal">SetProcessDEPPolicy</code> API to allow an application to opt in to DEP programmatically. Windows supports four system-wide configurations for hardware-enforced DEP.<sup>[<a href="apcs03.html#ftn.APP-C-FN-5" class="footnoteref">104</a>]</sup> On Windows Vista and later, you can use the <span class="emphasis"><em>bcdedit.exe</em></span> console application to verify the system-wide DEP policy, but this must be done from an elevated Windows command prompt. To verify the DEP and ASLR settings of an application, you can use Sysinternals’s Process Explorer.<sup>[<a href="apcs03.html#ftn.APP-C-FN-6" class="footnoteref">105</a>]</sup><a id="IDX-APP-C-0105" class="indexterm"/></p><div class="note" title="Note"><h3 class="title">Note</h3><p>To configure Process Explorer so that it shows the processes’ DEP and ASLR status, add the following columns to the view: <span class="strong"><strong>View</strong></span> ▸ <span class="strong"><strong>Select Columns</strong></span> ▸ <span class="strong"><strong>DEP Status</strong></span> and <span class="strong"><strong>View</strong></span> ▸ <span class="strong"><strong>Select Columns</strong></span> ▸ <span class="strong"><strong>ASLR Enabled</strong></span>. Additionally, set the lower pane to view DLLs for a process and add the “ASLR Enabled” column to the view (see <a class="xref" href="apc.html#dep_and_aslr_status_shown_in_process_exp" title="Figure C-1. DEP and ASLR status shown in Process Explorer">Figure C-1</a>).</p></div><p>The newer versions of Windows (Vista or later) also support ASLR by default, but the DLLs and EXEs must opt in to support ASLR using the /DYNAMICBASE linker option. It is important to note that protection is significantly weaker if not all modules of a process opt in to ASLR. In practice, the effectiveness of mitigations like DEP and ASLR is heavily dependent on how completely each mitigation technology has been enabled by an application.<sup>[<a href="apcs03.html#ftn.APP-C-FN-7" class="footnoteref">106</a>]</sup></p><p><a class="xref" href="apc.html#dep_and_aslr_status_shown_in_process_exp" title="Figure C-1. DEP and ASLR status shown in Process Explorer">Figure C-1</a> shows an example of Process Explorer being used to observe the DEP and ASLR settings of Internet Explorer. Note that the Java DLLs that have been loaded into the context of Internet Explorer do not make use of ASLR (denoted by an empty value for the ASLR column in the lower pane). Microsoft has also released a tool called <span class="emphasis"><em>BinScope Binary Analyzer</em></span>,<sup>[<a href="apcs03.html#ftn.APP-C-FN-8" class="footnoteref">107</a>]</sup> which analyzes binaries for a wide variety of security protections with a straightforward, easy-to-use interface.</p><p>If both DEP and ASLR are correctly deployed, exploit development is a lot harder.</p><p>To see if a Windows binary supports the security cookie (/GS) mitigation technique, you can disassemble the binary with IDA Pro and look for references to the security cookie in the function epilogue and prologue, as shown in <a class="xref" href="apc.html#security_cookie_open_parenthesis_solidus" title="Figure C-2. Security cookie (/GS) reference in the function prologue and epilogue (IDA Pro)">Figure C-2</a>.</p><div class="figure"><a id="dep_and_aslr_status_shown_in_process_exp"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject_d1e12330"/><img src="httpatomoreillycomsourcenostarchimages939357.png.jpg" alt="DEP and ASLR status shown in Process Explorer"/></div></div><p class="title">Figure C-1. DEP and ASLR status shown in Process Explorer</p></div><div class="figure"><a id="security_cookie_open_parenthesis_solidus"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject_d1e12338"/><img src="httpatomoreillycomsourcenostarchimages939359.png.jpg" alt="Security cookie (/GS) reference in the function prologue and epilogue (IDA Pro)"/></div></div><p class="title">Figure C-2. Security cookie (/GS) reference in the function prologue and epilogue (IDA Pro)</p></div><p>To check the system-wide configurations of Linux systems as well as ELF binaries and processes for different exploit mitigation techniques, you can use my <code class="literal">checksec.sh</code><sup>[<a href="apcs03.html#ftn.APP-C-FN-9" class="footnoteref">108</a>]</sup> script.<a id="IDX-APP-C-0106" class="indexterm"/><a id="IDX-APP-C-0107" class="indexterm"/><a id="IDX-APP-C-0108" class="indexterm"/><a id="IDX-APP-C-0109" class="indexterm"/><a id="IDX-APP-C-0110" class="indexterm"/></p></div></div></div>
<div class="sect1" title="C.2 RELRO"><div class="titlepage"><div><div><h1 class="title"><a id="c.2_relro"/>C.2 RELRO</h1></div></div></div><p>RELRO is a generic exploit mitigation technique to harden the data sections of an ELF<sup>[<a href="apcs03.html#ftn.APP-C-FN-10" class="footnoteref">109</a>]</sup> binary or process. ELF is a common file format for executables and libraries that is used by a variety of UNIX-like systems, including Linux, Solaris, and BSD. RELRO has two different modes:<a id="IDX-APP-C-0111" class="indexterm"/></p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>Partial RELRO</strong></span></span></dt><dd><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Compiler command line: <code class="literal">gcc -Wl,-z,relro</code>.</p></li><li class="listitem"><p>The ELF sections are reordered so that the ELF internal data sections (<code class="literal">.got</code>, <code class="literal">.dtors</code>, etc.) precede the program’s data sections (<code class="literal">.data</code> and <code class="literal">.bss</code>).</p></li><li class="listitem"><p>Non-PLT GOT is read-only.</p></li><li class="listitem"><p>PLT-dependent GOT is still writeable.</p></li></ul></div></dd><dt><span class="term"><span class="strong"><strong>Full RELRO</strong></span></span></dt><dd><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Compiler command line: <code class="literal">gcc -Wl,-z,relro,-z,now</code>.</p></li><li class="listitem"><p>Supports all the features of Partial RELRO.</p></li><li class="listitem"><p>Bonus: The entire GOT is (re)mapped as read-only.</p></li></ul></div></dd></dl></div><p>Both Partial and Full RELRO reorder the ELF internal data sections to protect them from being overwritten in the event of a buffer overflow in the program’s data sections (<code class="literal">.data</code> and <code class="literal">.bss</code>), but only Full RELRO mitigates the popular technique of modifying a GOT entry to get control over the program execution flow (see Section A.4).</p><p>To demonstrate the RELRO mitigation technique, I made up two simple test cases. I used Debian Linux 6.0 as a platform.<a id="IDX-APP-C-0112" class="indexterm"/></p><div class="sect2" title="Test Case 1: Partial RELRO"><div class="titlepage"><div><div><h2 class="title"><a id="test_case_1_colon_partial_relro"/>Test Case 1: Partial RELRO</h2></div></div></div><p>The test program in <a class="xref" href="apcs02.html#example_code_used_to_demonstrate" title="Example C-1. Example code used to demonstrate RELRO (testcase.c)">Example C-1</a> takes a memory address (see line 6) and tries to write the value <code class="literal">0x41414141</code> at that address (see line 8).</p><div class="example"><a id="example_code_used_to_demonstrate"/><p class="title">Example C-1. Example code used to demonstrate RELRO (<span class="emphasis"><em>testcase.c</em></span>)</p><div class="example-contents"><pre class="programlisting">01    #include &lt;stdio.h&gt;
02
03    int
04    main (int argc, char *argv[])
05    {
06      size_t *p = (size_t *)strtol (argv[1], NULL, 16);
07
08      p[0] = 0x41414141;
09      printf ("RELRO: %p\n", p);
10
11      return 0;
12    }</pre></div></div><p>I compiled the program with Partial RELRO support:</p><a id="I_programlisting_d1e12463"/><pre class="programlisting">linux$ <strong class="userinput"><code>gcc -g -Wl,-z,relro -o testcase testcase.c</code></strong></pre><p>I then checked the resulting binary with my <code class="literal">checksec.sh</code> script:<sup>[<a href="apcs03.html#ftn.APP-C-FN-11" class="footnoteref">110</a>]</sup></p><a id="I_programlisting_d1e12473"/><pre class="programlisting">linux$ <strong class="userinput"><code>./checksec.sh --file testcase</code></strong>
RELRO           STACK CANARY      NX            PIE                     FILE
Partial RELRO   No canary found   NX enabled    No PIE                  testcase</pre><p>Next I used <code class="literal">objdump</code> to gather the GOT address of the <code class="literal">printf()</code> library function used in line 9 of <a class="xref" href="apcs02.html#example_code_used_to_demonstrate" title="Example C-1. Example code used to demonstrate RELRO (testcase.c)">Example C-1</a> and then tried to overwrite that GOT entry:<a id="IDX-APP-C-0113" class="indexterm"/></p><a id="I_programlisting_d1e12491"/><pre class="programlisting">linux$ <strong class="userinput"><code>objdump -R ./testcase | grep printf</code></strong>
0804a00c R_386_JUMP_SLOT   printf</pre><p>I started the test program in gdb in order to see exactly what was happening:</p><a id="I_programlisting_d1e12498"/><pre class="programlisting">linux$ <strong class="userinput"><code>gdb -q ./testcase</code></strong>

(gdb) <strong class="userinput"><code>run 0804a00c</code></strong>
Starting program: /home/tk/BHD/testcase 0804a00c

Program received signal SIGSEGV, Segmentation fault.
0x41414141 in ?? ()

(gdb) <strong class="userinput"><code>info registers eip</code></strong>
eip            0x41414141     0x41414141</pre><p>Result: If only Partial RELRO is used to protect an ELF binary, it is still possible to modify arbitrary GOT entries to gain control of the execution flow of a process.</p></div><div class="sect2" title="Test Case 2: Full RELRO"><div class="titlepage"><div><div><h2 class="title"><a id="test_case_2_colon_full_relro"/>Test Case 2: Full RELRO</h2></div></div></div><p>This time, I compiled the test program with Full RELRO support:</p><a id="I_programlisting_d1e12517"/><pre class="programlisting">linux$ <strong class="userinput"><code>gcc -g -Wl,-z,relro,-z,now -o testcase testcase.c</code></strong>

linux$ <strong class="userinput"><code>./checksec.sh --file testcase</code></strong>
RELRO           STACK CANARY      NX            PIE                     FILE
Full RELRO      No canary found   NX enabled    No PIE                  testcase</pre><p>I then tried to overwrite the GOT address of <code class="literal">printf()</code> again:</p><a id="I_programlisting_d1e12530"/><pre class="programlisting">linux$ <strong class="userinput"><code>objdump -R ./testcase | grep printf</code></strong>
08049ff8 R_386_JUMP_SLOT   printf

linux$ <strong class="userinput"><code>gdb -q ./testcase</code></strong>

(gdb) <strong class="userinput"><code>run 08049ff8</code></strong>
Starting program: /home/tk/BHD/testcase 08049ff8

Program received signal SIGSEGV, Segmentation fault.
0x08048445 in main (argc=2, argv=0xbffff814) at testcase.c:8
8          p[0] = 0x41414141;</pre><p>This time, the execution flow was interrupted by a <code class="literal">SIGSEGV</code> signal at source code line 8. Let’s see why:</p><a id="I_programlisting_d1e12546"/><pre class="programlisting">(gdb) <strong class="userinput"><code>set disassembly-flavor intel</code></strong>

(gdb) <strong class="userinput"><code>x/1i $eip</code></strong>
0x8048445 &lt;main+49&gt;:    mov    DWORD PTR [eax],0x41414141

(gdb) <strong class="userinput"><code>info registers eax</code></strong>
eax            0x8049ff8        134520824</pre><p>As expected, the program tried to write the value <code class="literal">0x41414141</code> at the given memory address <code class="literal">0x8049ff8</code>.</p><a id="I_programlisting_d1e12565"/><pre class="programlisting">(gdb) <strong class="userinput"><code>shell cat /proc/$(pidof testcase)/maps</code></strong>
08048000-08049000 r-xp 00000000 08:01 497907     /home/tk/testcase
<strong class="userinput"><code>08049000-0804a000 r--p 00000000 08:01 497907     /home/tk/testcase</code></strong>
0804a000-0804b000 rw-p 00001000 08:01 497907     /home/tk/testcase
b7e8a000-b7e8b000 rw-p 00000000 00:00 0
b7e8b000-b7fcb000 r-xp 00000000 08:01 181222     /lib/i686/cmov/libc-2.11.2.so
b7fcb000-b7fcd000 r--p 0013f000 08:01 181222     /lib/i686/cmov/libc-2.11.2.so
b7fcd000-b7fce000 rw-p 00141000 08:01 181222     /lib/i686/cmov/libc-2.11.2.so
b7fce000-b7fd1000 rw-p 00000000 00:00 0
b7fe0000-b7fe2000 rw-p 00000000 00:00 0
b7fe2000-b7fe3000 r-xp 00000000 00:00 0          [vdso]
b7fe3000-b7ffe000 r-xp 00000000 08:01 171385     /lib/ld-2.11.2.so
b7ffe000-b7fff000 r--p 0001a000 08:01 171385     /lib/ld-2.11.2.so
b7fff000-b8000000 rw-p 0001b000 08:01 171385     /lib/ld-2.11.2.so
bffeb000-c0000000 rw-p 00000000 00:00 0          [stack]</pre><p>The memory map of the process shows that the memory range <code class="literal">08049000-0804a000</code>, which includes the GOT, was successfully set to read-only (<code class="literal">r--p</code>).</p><p>Result: If Full RELRO is enabled, the attempt to overwrite a GOT address leads to an error because the GOT section is mapped read-only.</p></div><div class="sect2" title="Conclusion"><div class="titlepage"><div><div><h2 class="title"><a id="conclusion"/>Conclusion</h2></div></div></div><p>In case of a buffer overflow in the program’s data sections (<code class="literal">.data</code> and <code class="literal">.bss</code>), both Partial and Full RELRO protect the ELF internal data sections from being overwritten.</p><p>With Full RELRO, it’s possible to successfully prevent the modification of GOT entries.</p><p>There is also a generic way to implement a similar mitigation technique for ELF objects, which works on platforms that don’t support RELRO.<sup>[<a href="apcs03.html#ftn.APP-C-FN-12" class="footnoteref">111</a>]</sup></p></div></div>
<div class="sect1" title="C.3 Solaris Zones"><div class="titlepage"><div><div><h1 class="title"><a id="c.3_solaris_zones"/>C.3 Solaris Zones</h1></div></div></div><p>Solaris Zones is a technology used to virtualize operating system services and provide an isolated environment for running applications. A <span class="emphasis"><em>zone</em></span> is a virtualized operating system environment created within a single instance of the Solaris Operating System. When you create a zone, you produce an application execution environment in which processes are isolated from the rest of the system. This isolation should prevent processes that are running in one zone from monitoring or affecting processes that are running in other zones. Even a process running with superuser credentials shouldn’t be able to view or affect activity in other zones.<a id="IDX-APP-C-0114" class="indexterm"/></p><div class="sect2" title="Terminology"><div class="titlepage"><div><div><h2 class="title"><a id="terminology"/>Terminology</h2></div></div></div><p>There are two different kinds of zones: <span class="emphasis"><em>global</em></span> and <span class="emphasis"><em>non-global</em></span>. The global zone represents the conventional Solaris execution environment and is the only zone from which non-global zones can be configured and installed. By default, non-global zones cannot access the global zone or other non-global zones. All zones have a security boundary around them and are confined to their own subtree of the filesystem hierarchy. Every zone has its own root directory, has separate processes and devices, and operates with fewer privileges than the global zone.</p><p>Sun and Oracle were very confident about the security of their Zones technology when they rolled it out:</p><div class="note" title="Note"><h3 class="title">Note</h3><p><span class="emphasis"><em>The platform that I used throughout this section was the default installation of Solaris 10 10/08 x86/x64 DVD Full Image (sol-10-u6-ga1-x86-dvd.iso), which is called Solaris 10 Generic_137138-09</em></span>.</p></div><div class="blockquote"><blockquote class="blockquote"><p>Once a process has been placed in a zone other than the global zone, neither the process nor any of its subsequent children can change zones.</p><p>Network services can be run in a zone. By running network services in a zone, you limit the damage possible in the event of a security violation. An intruder who successfully exploits a security flaw in software running within a zone is confined to the restricted set of actions possible within that zone. The privileges available within a zone are a subset of those available in the system as a whole. . .<sup>[<a href="apcs03.html#ftn.APP-C-FN-13" class="footnoteref">112</a>]</sup></p><p>Processes are restricted to a subset of privileges. Privilege restriction prevents a zone from performing operations that might affect other zones. The set of privileges limits the capabilities of privileged users within the zone. To display the list of privileges available within a zone, use the <code class="literal">ppriv</code> utility.<sup>[<a href="apcs03.html#ftn.APP-C-FN-14" class="footnoteref">113</a>]</sup></p></blockquote></div><p>Solaris Zones is great, but there is one weak point: All zones (global and non-global) share the same kernel. If there is a bug in the kernel that allows arbitrary code execution, it’s possible to cross all security boundaries, escape from a non-global zone, and compromise other non-global zones or even the global zone. To demonstrate this, I recorded a video that shows the exploit for the vulnerability described in <a class="xref" href="ch03.html" title="Chapter 3. Escape from the WWW Zone">Chapter 3</a> in action. The exploit allows an unprivileged user to escape from a non-global zone and then compromise all other zones, including the global zone. You can find the video on this book’s website.<sup>[<a href="apcs03.html#ftn.APP-C-FN-15" class="footnoteref">114</a>]</sup></p></div><div class="sect2" title="Set Up a Non-Global Solaris Zone"><div class="titlepage"><div><div><h2 class="title"><a id="set_up_a_non-global_solaris_zone"/>Set Up a Non-Global Solaris Zone</h2></div></div></div><p>To set up the Solaris Zone for <a class="xref" href="ch03.html" title="Chapter 3. Escape from the WWW Zone">Chapter 3</a>, I did the following steps (all steps have to be performed as a privileged user in the global zone):</p><a id="I_programlisting_d1e12652"/><pre class="programlisting">solaris# <strong class="userinput"><code>id</code></strong>
uid=0(root) gid=0(root)

solaris# <strong class="userinput"><code>zonename</code></strong>
global</pre><p>The first thing I did was to create a filesystem area for the new zone to reside in:</p><a id="I_programlisting_d1e12662"/><pre class="programlisting">solaris# <strong class="userinput"><code>mkdir /wwwzone</code></strong>
solaris# <strong class="userinput"><code>chmod 700 /wwwzone</code></strong>
solaris# <strong class="userinput"><code>ls -l / | grep wwwzone</code></strong>
drwx------   2 root     root         512 Aug 23 12:45 wwwzone</pre><p>I then used <code class="literal">zonecfg</code> to create the new non-global zone:</p><a id="I_programlisting_d1e12678"/><pre class="programlisting">solaris# <strong class="userinput"><code>zonecfg -z wwwzone</code></strong>
wwwzone: No such zone configured
Use 'create' to begin configuring a new zone.
zonecfg:wwwzone&gt; <strong class="userinput"><code>create</code></strong>
zonecfg:wwwzone&gt; <strong class="userinput"><code>set zonepath=/wwwzone</code></strong>
zonecfg:wwwzone&gt; <strong class="userinput"><code>set autoboot=true</code></strong>
zonecfg:wwwzone&gt; <strong class="userinput"><code>add net</code></strong>
zonecfg:wwwzone:net&gt; <strong class="userinput"><code>set address=192.168.10.250</code></strong>
zonecfg:wwwzone:net&gt; <strong class="userinput"><code>set defrouter=192.168.10.1</code></strong>
zonecfg:wwwzone:net&gt; <strong class="userinput"><code>set physical=e1000g0</code></strong>
zonecfg:wwwzone:net&gt; <strong class="userinput"><code>end</code></strong>
zonecfg:wwwzone&gt; <strong class="userinput"><code>verify</code></strong>
zonecfg:wwwzone&gt; <strong class="userinput"><code>commit</code></strong>
zonecfg:wwwzone&gt; <strong class="userinput"><code>exit</code></strong></pre><p>After that, I checked the results of my actions with <code class="literal">zoneadm</code>:</p><a id="I_programlisting_d1e12722"/><pre class="programlisting">solaris# <strong class="userinput"><code>zoneadm list -vc</code></strong>
  ID NAME             STATUS     PATH                           BRAND    IP
   0 global           running    /                              native   shared
   - wwwzone          configured /wwwzone                       native   shared</pre><p>Next, I installed and booted the new non-global zone:</p><a id="I_programlisting_d1e12729"/><pre class="programlisting">solaris# <strong class="userinput"><code>zoneadm -z wwwzone install</code></strong>
Preparing to install zone &lt;wwwzone&gt;.
Creating list of files to copy from the global zone.
Copying &lt;8135&gt; files to the zone.
Initializing zone product registry.
Determining zone package initialization order.
Preparing to initialize &lt;1173&gt; packages on the zone.
Initialized &lt;1173&gt; packages on zone.
Zone &lt;wwwzone&gt; is initialized.

solaris# <strong class="userinput"><code>zoneadm -z wwwzone boot</code></strong></pre><p>To ensure that everything had gone okay, I pinged the IP address of the new non-global zone:</p><a id="I_programlisting_d1e12739"/><pre class="programlisting">solaris# <strong class="userinput"><code>ping 192.168.10.250</code></strong>
192.168.10.250 is alive</pre><p>To log into the new non-global zone, I used the following command:</p><a id="I_programlisting_d1e12746"/><pre class="programlisting">solaris# <strong class="userinput"><code>zlogin -C wwwzone</code></strong></pre><p>After answering the questions regarding language and terminal settings, I logged in as <code class="literal">root</code> and created a new unprivileged user:</p><a id="I_programlisting_d1e12755"/><pre class="programlisting">solaris# <strong class="userinput"><code>id</code></strong>
uid=0(root) gid=0(root)

solaris# <strong class="userinput"><code>zonename</code></strong>
wwwzone

solaris# <strong class="userinput"><code>mkdir /export/home</code></strong>

solaris# <strong class="userinput"><code>mkdir /export/home/wwwuser</code></strong>

solaris# <strong class="userinput"><code>useradd -d /export/home/wwwuser wwwuser</code></strong>

solaris# <strong class="userinput"><code>chown wwwuser /export/home/wwwuser</code></strong>

solaris# <strong class="userinput"><code>passwd wwwuser</code></strong></pre><p>I then used this unprivileged user to exploit the Solaris kernel vulnerability described in <a class="xref" href="ch03.html" title="Chapter 3. Escape from the WWW Zone">Chapter 3</a>.</p></div><div class="sect2" title="Notes"><div class="titlepage"><div><div><h2 class="title"><a id="notes-id10"/>Notes</h2></div></div></div><p><sup>[<a id="APP-C-FN-1" href="#ftn.APP-C-FN-1" class="footnote">100</a>]</sup></p><p><sup>[<a id="APP-C-FN-2" href="#ftn.APP-C-FN-2" class="footnote">101</a>]</sup></p><p><sup>[<a id="APP-C-FN-3" href="#ftn.APP-C-FN-3" class="footnote">102</a>]</sup></p><p><sup>[<a id="APP-C-FN-4" href="#ftn.APP-C-FN-4" class="footnote">103</a>]</sup></p><p><sup>[<a id="APP-C-FN-5" href="#ftn.APP-C-FN-5" class="footnote">104</a>]</sup></p><p><sup>[<a id="APP-C-FN-6" href="#ftn.APP-C-FN-6" class="footnote">105</a>]</sup></p><p><sup>[<a id="APP-C-FN-7" href="#ftn.APP-C-FN-7" class="footnote">106</a>]</sup></p><p><sup>[<a id="APP-C-FN-8" href="#ftn.APP-C-FN-8" class="footnote">107</a>]</sup></p><p><sup>[<a id="APP-C-FN-9" href="#ftn.APP-C-FN-9" class="footnote">108</a>]</sup></p><p><sup>[<a id="APP-C-FN-10" href="#ftn.APP-C-FN-10" class="footnote">109</a>]</sup></p><p><sup>[<a id="APP-C-FN-11" href="#ftn.APP-C-FN-11" class="footnote">110</a>]</sup></p><p><sup>[<a id="APP-C-FN-12" href="#ftn.APP-C-FN-12" class="footnote">111</a>]</sup></p><p><sup>[<a id="APP-C-FN-13" href="#ftn.APP-C-FN-13" class="footnote">112</a>]</sup></p><p><sup>[<a id="APP-C-FN-14" href="#ftn.APP-C-FN-14" class="footnote">113</a>]</sup></p><p><sup>[<a id="APP-C-FN-15" href="#ftn.APP-C-FN-15" class="footnote">114</a>]</sup></p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-1" href="#APP-C-FN-1" class="para">100</a>] </sup>See Rob King, “New Leopard Security Features—Part I: ASLR,” <span class="emphasis"><em>DVLabs Tipping Point</em></span> (blog), November 7, 2007, <a class="ulink" href="http://dvlabs.tippingpoint.com/blog/2007/11/07/leopard-aslr">http://dvlabs.tippingpoint.com/blog/2007/11/07/leopard-aslr</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-2" href="#APP-C-FN-2" class="para">101</a>] </sup>See Tim Burrell, “GS Cookie Protection—Effectiveness and Limitations,” Microsoft TechNet Blogs: Security Research &amp; Defense (blog), March 16, 2009, <a class="ulink" href="http://blogs.technet.com/srd/archive/2009/03/16/gs-cookie-protection-effectiveness-and-limitations.aspx">http://blogs.technet.com/srd/archive/2009/03/16/gs-cookie-protection-effectiveness-and-limitations.aspx</a>; “Enhanced GS in Visual Studio 2010,” Microsoft TechNet Blogs: Security Research &amp; Defense (blog), March 20, 2009, <a class="ulink" href="http://blogs.technet.com/srd/archive/2009/03/20/enhanced-gs-in-visual-studio-2010.aspx">http://blogs.technet.com/srd/archive/2009/03/20/enhanced-gs-in-visual-studio-2010.aspx</a>; IBM Research “GCC Extension for Protecting Applications from Stack-Smashing Attacks,” last updated August 22, 2005, <a class="ulink" href="http://researchweb.watson.ibm.com/trl/projects/security/ssp/">http://researchweb.watson.ibm.com/trl/projects/security/ssp/</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-3" href="#APP-C-FN-3" class="para">102</a>] </sup>See <a class="ulink" href="http://people.redhat.com/mingo/exec-shield/">http://people.redhat.com/mingo/exec-shield/</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-4" href="#APP-C-FN-4" class="para">103</a>] </sup>See the home page of the PaX team at <a class="ulink" href="http://pax.grsecurity.net/">http://pax.grsecurity.net/</a> as well as the grsecurity website at <a class="ulink" href="http://www.grsecurity.net/">http://www.grsecurity.net/</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-5" href="#APP-C-FN-5" class="para">104</a>] </sup>See Robert Hensing, “Understanding DEP as a Mitigation Technology Part 1,” Microsoft TechNet Blogs: Security Research &amp; Defense (blog), June 12, 2009, <a class="ulink" href="http://blogs.technet.com/srd/archive/2009/06/12/understanding-dep-as-a-mitigation-technology-part-1.aspx">http://blogs.technet.com/srd/archive/2009/06/12/understanding-dep-as-a-mitigation-technology-part-1.aspx</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-6" href="#APP-C-FN-6" class="para">105</a>] </sup>See <a class="ulink" href="http://technet.microsoft.com/en-en/sysinternals/bb896653/">http://technet.microsoft.com/en-en/sysinternals/bb896653/</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-7" href="#APP-C-FN-7" class="para">106</a>] </sup>For more information, see the Secunia study by Alin Rad Pop, “DEP/ASLR Implementation Progress in Popular Third-party Windows Applications,” 2010, <a class="ulink" href="http://secunia.com/gfx/pdf/DEP_ASLR_2010_paper.pdf">http://secunia.com/gfx/pdf/DEP_ASLR_2010_paper.pdf</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-8" href="#APP-C-FN-8" class="para">107</a>] </sup>To download BinScope Binary Analyzer, visit <a class="ulink" href="http://go.microsoft.com/?linkid=9678113">http://go.microsoft.com/?linkid=9678113</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-9" href="#APP-C-FN-9" class="para">108</a>] </sup>See <a class="ulink" href="http://www.trapkit.de/tools/checksec.html">http://www.trapkit.de/tools/checksec.html</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-10" href="#APP-C-FN-10" class="para">109</a>] </sup>See TIS Committee, <span class="emphasis"><em>Tool Interface Standard (TIS) Executable and Linking Format (ELF) Specification</em></span>, version 1.2, 1995, <a class="ulink" href="http://refspecs.freestandards.org/elf/elf.pdf">http://refspecs.freestandards.org/elf/elf.pdf</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-11" href="#APP-C-FN-11" class="para">110</a>] </sup>See note 9 above.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-12" href="#APP-C-FN-12" class="para">111</a>] </sup>See Chris Rohlf, “Self Protecting Global Offset Table (GOT),” draft version 1.4, August 2008, <a class="ulink" href="http://code.google.com/p/em386/downloads/detail?name=Self-Protecting-GOT.html">http://code.google.com/p/em386/downloads/detail?name=Self-Protecting-GOT.html</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-13" href="#APP-C-FN-13" class="para">112</a>] </sup>See “Introduction to Solaris Zones: Features Provided by Non-Global Zones,” <span class="emphasis"><em>System Administration Guide: Oracle Solaris Containers—Resource Management and Oracle Solaris Zones</em></span>, 2010, <a class="ulink" href="http://download.oracle.com/docs/cd/E19455-01/817-1592/zones.intro-9/index.html">http://download.oracle.com/docs/cd/E19455-01/817-1592/zones.intro-9/index.html</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-14" href="#APP-C-FN-14" class="para">113</a>] </sup>See “Solaris Zones Administration (Overview): Privileges in a Non-Global Zone,” <span class="emphasis"><em>System Administration Guide:Virtualization Using the Solaris Operating System</em></span>, 2010, <a class="ulink" href="http://download.oracle.com/docs/cd/E19082-01/819-2450/z.admin.ov-18/index.html">http://download.oracle.com/docs/cd/E19082-01/819-2450/z.admin.ov-18/index.html</a>.</p></div><div class="footnote"><p><sup>[<a id="ftn.APP-C-FN-15" href="#APP-C-FN-15" class="para">114</a>] </sup>See <a class="ulink" href="http://www.trapkit.de/books/bhd/">http://www.trapkit.de/books/bhd/</a>.</p></div></div></div></body></html>