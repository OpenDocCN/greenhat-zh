<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;CGI and the Web"><div class="titlepage"><div><div><h1 class="title"><a id="cgi_and_the_web"/>Chapter 11. CGI and the Web</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject11_d1e18860"/><img alt="image with no caption" src="httpatomoreillycomsourcenostarchimages686190.png.jpg"/></div></div><p><a class="indexterm" id="idx-CHP-11-1062"/>Ruby has gotten a lot of attention as a language particularly well suited <a class="indexterm" id="idx-CHP-11-1063"/>for web programming, especially in the context of the Rails <a class="indexterm" id="idx-CHP-11-1064"/>development framework. Some people even go so far as to categorize Ruby as a web language, suggesting that it is not a full-fledged general-purpose programming language. I hope that the previous chapters have played at least a modest role in convincing readers that this assertion is false.</p><p>That said, Ruby is very useful for web work, and it does have some characteristics that make it better suited for web programming than (for example) video game programming. Ruby operates at a very high level of abstraction, giving programmers a large toolset to work with, and it executes code at a slower speed than some other languages. These characteristics make Ruby well suited for web work, since development speed is often critical, but program execution speed is often less critical than in other types of programs, such as real-time action video games.</p><p>The Rails development framework has been instrumental in bringing Ruby to the attention of an ever-larger audience. Some say it’s Ruby’s “killer app,” analogous to Perl’s CPAN or the GNU project’s gcc. This is a general Ruby book, not a Rails book, but Rails is important enough that it gets its own chapter. (Since we’ll be using RubyGems, Ruby’s package-management system, to install Rails, this book also has a chapter devoted to RubyGems.)</p><p>You’ll have to wait two chapters for Rails. Aside from knowing how to install it with RubyGems, by then you should also know something about <a class="indexterm" id="idx-CHP-11-1065"/>web programs in general—that’s what this chapter is for. If you’re a web app veteran, feel free to skip this chapter, although you may find some of the specific scripts novel and interesting, even if you already know how they work.</p><div class="sect1" title="Common Gateway Interface"><div class="titlepage"><div><div><h1 class="title"><a id="common_gateway_interface"/>Common Gateway Interface</h1></div></div></div><p>The most common approach to web programming is the Common Gateway Interface (<a class="indexterm" id="idx-CHP-11-1066"/>CGI). <span class="emphasis"><em>CGI</em></span> is not a programming language; it’s a set of rules for programs to follow when they run on the Web, regardless of the particular language in which each program might be written. CGI enables friendly cooperation among multiple files that could even be written in distinct programming languages but all exist together within a larger web application.<a class="indexterm" id="idx-CHP-11-1067"/></p><p>Using more than one language for a single web application is fairly common. I mentioned that Ruby’s high level of abstraction makes it suitable for web programming. However, sometimes you might really want to use a library someone has already written in another language—like Python, for instance—in a web program. If you use CGI, you could write part of your web application in Python in order to use that library. You might also have a section of your web application that is highly speed critical, so you could write that part in C for execution speed, and the rest in Ruby for development speed. This is exactly the reason that Paul <a class="indexterm" id="idx-CHP-11-1068"/>Graham and his colleagues chose to use a combination of Lisp and C for their company Viaweb, which eventually became Yahoo! Stores. They were able to do so because the CGI specification holds across multiple languages.</p></div></div>
<div class="sect1" title="Preparation and Installation"><div class="titlepage"><div><div><h1 class="title"><a id="preparation_and_installation"/>Preparation and Installation</h1></div></div></div><p>Before we get going with Ruby and CGI, we’ve got to do a little work to get our <a class="indexterm" id="idx-CHP-11-1069"/>webserver ready. For the purposes of this chapter, I’ll be focusing on getting CGI working for the <a class="indexterm" id="idx-CHP-11-1070"/>Apache webserver running on a Unix-like environment. Apache is the most popular webserver, and Unix-like operating systems are the most common (and most stable) server operating systems.<a class="indexterm" id="idx-CHP-11-1071"/></p><p>You can get a copy of the <a class="indexterm" id="idx-CHP-11-1072"/>Apache webserver at <a class="ulink" href="http://httpd.apache.org">http://httpd.apache.org</a>, or you can use a package manager to install it. (Mac OS X comes with Apache pre-installed.) I used <code class="literal">apt-get</code> on my Ubuntu system, as follows:</p><a id="I_programlisting11_d1e18948"/><pre class="programlisting">apt-get install apache2 apache2-doc
Reading package lists... Done
Building dependency tree... Done
The following extra packages will be installed:
 apache2-common apache2-mpm-worker apache2-utils libapr0 libpcre3 ssl-cert
Suggested packages:
 lynx www-browser
The following NEW packages will be installed:
 apache2 apache2-common apache2-doc apache2-mpm-worker apache2-utils libapr0
 libpcre3 ssl-cert
0 upgraded, 8 newly installed, 0 to remove and 5 not upgraded.
Need to get 3555kB of archives.
After unpacking 16.4MB of additional disk space will be used.
Do you want to continue [Y/n]? Y</pre><p>I answered <code class="literal">Y</code>. You can see that I chose the <code class="literal">apache2</code> version of the Apache webserver. After installing Apache, you’ll also want to install packages for <code class="literal">mod_ruby</code>, which allows Ruby programs to be run within the webserver. I’ll explain the benefits of this when we get to the script that shows <code class="literal">mod_ruby</code> being used. You can install <code class="literal">mod_ruby</code> by typing <code class="literal">apt-get install libapache2-mod-ruby liberuby</code> on a Debian-based system. Now that the <a class="indexterm" id="idx-CHP-11-1073"/>installation is done, let’s start with our first simple <a class="indexterm" id="idx-CHP-11-1074"/>CGI script.</p></div>
<div class="sect1" title="#41 A Simple CGI Script (simple_cgi.rb)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp41_a_simple_cgi_script_simple_cgirb"/>#41 A Simple CGI Script (simple_cgi.rb)</h1></div></div></div><p>This script is fairly quick and dirty, but it shows the basics of how to use Ruby for CGI and introduces Ruby’s aptly named <code class="literal">cgi</code> library. You’ll need to put this script in your system’s cgi-bin directory. It’s <code class="literal">/usr/lib/cgi-bin/</code> on my system, although your system’s location may be different. You can then browse to http://localhost/cgi-bin/simple_cgi.rb, because your webserver will provide access to the contents of your cgi-bin directory via http://localhost/cgi-bin/.<a class="indexterm" id="idx-CHP-11-1075"/></p><div class="note" title="Note"><h3 class="title"><a id="note-60"/>Note</h3><p><span class="emphasis"><em>You’ll also need to give <code class="literal">simple_cgi.rb 755</code> permissions, meaning that its owner can do anything with it and everyone else can read and execute it, but not write (change) it. For more information, see <em class="replaceable"><code>man chmod</code></em></em></span>.<a class="indexterm" id="idx-CHP-11-1076"/></p></div><p>Before we even get started with the script, you should also browse to http://localhost/. If you see either a page telling you that Apache is installed correctly or a listing of files in a directory, your webserver is probably working. If you don’t see either of these things, consult the Apache documentation (available at http://httpd.apache.org/docs) to diagnose the problem. If your webserver is working, you can proceed to the script.<a class="indexterm" id="I_indexterm11_d1e19012"/></p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id040"/>The Code</h2></div></div></div><a id="I_programlisting11_d1e19020"/><pre class="programlisting">  #!/usr/bin/env ruby
  # simple_cgi.rb

❶ require 'cgi'    <em class="lineannotation"><span class="lineannotation">Requiring CGI.rb</span></em>

❷ class Simple_CGI

❸   EMPTY_STRING = ''
    TITLE = 'A simple CGI script'

    def display()
❹     cgi = CGI.new('html4')
❺     output = cgi.html do
        cgi.head do
          cgi.title { TITLE }
        end +
        cgi.body do
          cgi.h1 { TITLE } +
❻          show_def_list(cgi)
        end
      end
❼     cgi.out { output.gsub('&gt;&lt;', "&gt;\n&lt;") }
    end

    private

❽   def get_items_hash()
      {
        'script'   =&gt; ENV['SCRIPT_NAME'],
❾       'server'   =&gt; ENV['SERVER_NAME'] || %x{hostname} || EMPTY_STRING,
        'software' =&gt; ENV['SERVER_SOFTWARE'],
        'time'     =&gt; Time.now,
      }
    end

❿   def show_def_list(cgi)
      cgi.dl do
        items = get_items_hash.merge(cgi.params)
        items.keys.sort.map do |term|
          definition = items[term]
          "&lt;dt&gt;#{term}&lt;/dt&gt;&lt;dd&gt;#{definition}&lt;/dd&gt;\n"
        end.join( EMPTY_STRING )
      end
    end

  end

  Simple_CGI.new.display()</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id039"/>How It Works</h2></div></div></div><p>The first thing we do in the script is <code class="literal">require</code> the <code class="literal">cgi</code> library at ❶. Then we define a class called <code class="literal">Simple_CGI</code> at ❷ and the Constants <code class="literal">EMPTY_STRING</code> and <code class="literal">TITLE</code> at ❸. Next, within the <code class="literal">display</code> method (at ❹), we create an instance of <code class="literal">CGI</code> called <code class="literal">cgi</code>, defining it in terms of <code class="literal">html4</code>, which is one of the versions of HTML that <code class="literal">CGI</code> is aware of. We’ll use <code class="literal">cgi</code> to create an HTML document that <code class="literal">simple_cgi.rb</code> will output.<a class="indexterm" id="idx-CHP-11-1077"/></p><p>Instances of <code class="literal">CGI</code> have several methods that take blocks, whose names are the same as the tags they will create. Every HTML document needs an <code class="literal">&lt;html&gt;</code> tag, so we include that at ❺. For reasons I’ll explain shortly, I want to store the contents of the <code class="literal">&lt;html&gt;</code> tag in a temporary local variable called <code class="literal">output</code>. We can go through the <a class="indexterm" id="idx-CHP-11-1078"/>HTML document we want to create, opening new tags with the appropriate method of <code class="literal">cgi</code> (like <code class="literal">head, title, h1</code>, etc.). Hierarchical <a class="indexterm" id="idx-CHP-11-1079"/>nesting is accomplished using blocks, as you can see, and tags that are at the same level (<span class="emphasis"><em>siblings</em></span>) are concatenated with the <code class="literal">+</code> method.<a class="indexterm" id="idx-CHP-11-1080"/></p><p>You’ll notice that within <code class="literal">cgi.body</code>, which creates the <code class="literal">&lt;body&gt;</code> tag within our resulting output, I have used a method at ❻ called <code class="literal">show_def_list</code> (defined at ❿). This is mainly to avoid multiple levels of block nesting for the methods of <code class="literal">cgi</code>, but it also performs other tasks. Let’s examine it at ❿. It outputs a <a class="indexterm" id="idx-CHP-11-1081"/>definition list as you’d expect using <code class="literal">cgi.dl</code> with a block. To do so, it pulls both <code class="literal">terms</code> and their <code class="literal">definitions</code> from a Hash called <code class="literal">items</code>, wrapping them in <code class="literal">&lt;dt&gt;</code> and <code class="literal">&lt;dd&gt;</code> tags, respectively.<a class="indexterm" id="idx-CHP-11-1082"/></p><p>The <code class="literal">items</code> Hash is defined by the output of <code class="literal">get_items_hash</code> (❽) merged with <code class="literal">cgi.params</code>. The <code class="literal">cgi.params</code> Hash represents the query string, so if you browse to http://localhost/cgi-bin/<a class="indexterm" id="idx-CHP-11-1083"/>simple_cgi.rb?key1=value1&amp;key2=value2, <code class="literal">cgi.params</code> would be <code class="literal">{ ‘key1’ =&gt; ‘value1’, ‘key2’, ‘value2’ }</code>. The <code class="literal">get_items_hash</code> method returns a Hash representing some values that I thought might be worth demonstrating, such as the script name, the server, and so on. In general, the script simply reads from the machine’s environment, using values of the <code class="literal">ENV</code> Hash. At ❾, the value for <code class="literal">‘server’</code> in the Hash is slightly more complex than the others. It tries to read from <code class="literal">ENV</code> like the others, falling back to a system execution of the <code class="literal">hostname</code> command, and finally falling back to the <code class="literal">EMPTY_STRING</code>, if necessary. This resulting Hash is then returned implicitly, because it’s the last evaluated expression in the method.<a class="indexterm" id="idx-CHP-11-1084"/><a class="indexterm" id="idx-CHP-11-1085"/></p><p>Back at ❼, we call <code class="literal">cgi.out</code>, giving it a block with a slight massaging of the <code class="literal">output</code> variable using <code class="literal">gsub</code>. I’ll be the first to admit that this is a little unusual. Normally, you call <code class="literal">cgi.out</code> with a block that includes <code class="literal">cgi.html</code> and all the other methods I used to fill the <code class="literal">output</code> variable. Why did I do it this way? There are two related reasons.<a class="indexterm" id="idx-CHP-11-1086"/></p><p>The first reason is that <code class="literal">cgi.out</code> is not purely functional: It doesn’t return a value to be printed using <code class="literal">puts</code>. Instead, it does the outputting by itself. The second reason is that <code class="literal">cgi</code>’s methods don’t introduce line breaks between tags. This is good for speed optimization, in that each new character, even just a line break, is slightly more content to transfer. However, it doesn’t make the resulting <a class="indexterm" id="idx-CHP-11-1087"/>HTML source very readable. I like readable HTML source, so I use <code class="literal">gsub</code> at ❼ to introduce line breaks between adjacent tags. If you don’t mind your HTML all strung together in a single line, by all means, put your <code class="literal">cgi.html</code> and similar calls within the block for <code class="literal">cgi.out</code>.</p><p>Everything we have discussed so far has been within the <code class="literal">display</code> method. We call it on the last line of the script, directly on an anonymous new instance of <code class="literal">Simple_CGI</code>. There’s no real need to instantiate it into a variable, like so:<a class="indexterm" id="idx-CHP-11-1088"/></p><a id="I_programlisting11_d1e19264"/><pre class="programlisting">scgi = Simple_CGI.new
scgi.display()</pre><p>However, if you’re more comfortable doing that, there’s also no reason not to. Let’s see how it works.</p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id037"/>The Results</h2></div></div></div><p>On your system, browse to http://localhost/cgi-bin/<a class="indexterm" id="idx-CHP-11-1089"/>simple_cgi.rb and see what you get. It should be something more or less like <a class="xref" href="ch11s03.html#the_output_of_ltliteralgtsimple_cgirbltl" title="Figure 11-1. The output of simple_cgi.rb">Figure 11-1</a>.</p><p>Note that the software value will probably differ, unless you’re also using a fairly stock Ubuntu system, and the time will obviously differ a great deal. You can see that the tab shows the page title, which is <span class="emphasis"><em>A simple CGI script</em></span> (the same as the large bold header). Values that should not differ are the script and server, unless you’ve intentionally changed the filename from <code class="literal">simple_cgi.rb</code> to something else or browsed to a hostname other than <code class="literal">localhost</code>. Astute readers will also see that I had another tab open to the Apache website.<a class="indexterm" id="idx-CHP-11-1090"/></p><div class="figure"><a id="the_output_of_ltliteralgtsimple_cgirbltl"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject11_d1e19300"/><img alt="The output of simple_cgi.rb" src="httpatomoreillycomsourcenostarchimages686188.png.jpg"/></div></div><p class="title">Figure 11-1. The output of <code class="literal">simple_cgi.rb</code></p></div><p>Now let’s try changing the query string a bit, with http://localhost/cgi-bin/simple_cgi.rb?lang=Ruby. I won’t bother showing a new screenshot, but you should now see five entries in the definition list instead of four. The new one is the key <code class="literal">lang</code>, which has a value of <code class="literal">Ruby</code>. This appears because <code class="literal">cgi.params</code> is a part of the items Hash within <code class="literal">show_def_list</code> at ❿, and when we use the query string <code class="literal">lang=Ruby, cgi.params</code> is <code class="literal">{ ‘lang’ =&gt; ‘Ruby’ }</code>, which is then one of the pairs in <code class="literal">items</code>.</p><p>Now let’s try giving an explicit value within the query string to one of the keys that already appears in items, with the URL http://localhost/cgi-bin/simple_cgi.rb?lang=Ruby&amp;server=some_other_server_name. You should still see the key <code class="literal">lang</code> with a value <code class="literal">Ruby</code>, but in addition, the value for <code class="literal">server</code> is no longer <code class="literal">localhost</code>, but is instead <code class="literal">some_other_server_name</code>. The reason this happens is that <code class="literal">cgi.params</code> is the argument to <code class="literal">merge</code>, and it overrides any conflicting pair already in the Hash on which <code class="literal">merge</code> is called. Therefore, anything in <code class="literal">cgi.params</code> takes precedence.<a class="indexterm" id="I_indexterm11_d1e19359"/></p></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id029"/>Hacking the Script</h2></div></div></div><p>This is just a simple script showing the basics of CGI. You could modify and extend it in countless ways. One suggestion would be to incorporate part of <code class="literal">currency_converter2.rb</code>. For example, you could display the time, just as this script already does, and take arguments for the currencies to convert from and to as well as the amount of money to convert. Many people also use CGI to execute system calls on a machine and display the results, showing the processes running on the machine, how much disk space is used, and other information of interest to system administrators.</p></div></div>
<div class="sect1" title="#42 Mod Ruby (mod_ruby_demo.rhtml and mod_ruby_demo.conf)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp42_mod_ruby_mod_ruby_demorhtml_and_"/>#42 Mod Ruby (mod_ruby_demo.rhtml and mod_ruby_demo.conf)</h1></div></div></div><p>CGI is great for many applications. However, sometimes you may want to have files that are mainly HTML, with only subsections that need to be executed by your programming language, Ruby or otherwise. Wouldn’t it be great if you had an HTML tag that meant <span class="emphasis"><em>Start Ruby code now</em></span>, after which you could add some Ruby code, and then use another tag that meant <span class="emphasis"><em>Done with Ruby code, go back to plain old HTML</em></span>?<a class="indexterm" id="idx-CHP-11-1091"/><a class="indexterm" id="idx-CHP-11-1092"/></p><p>There is such a system, for many languages. It’s the default behavior for the <a class="indexterm" id="idx-CHP-11-1093"/>PHP language, and similar systems are available for <a class="indexterm" id="idx-CHP-11-1094"/>Perl and <a class="indexterm" id="idx-CHP-11-1095"/>Python, among others. One of the systems that does this for Ruby is <code class="literal">eRuby</code>, which will be embedded directly within the webserver via the <code class="literal">mod_ruby</code> software.<a class="indexterm" id="idx-CHP-11-1096"/></p><p>One of the problems with CGI is speed. When someone makes a web request that needs dynamic CGI execution, that request spawns a new Ruby interpreter;<sup>[<a class="footnote" href="#ftn.CHP-11-FNOTE-1" id="CHP-11-FNOTE-1">32</a>]</sup> that interpreter then evaluates the CGI program, returns its value to the webserver process, and closes down. For the next CGI request, the whole process start all over again. All of this takes time. What <code class="literal">mod_ruby</code> and similar systems do is have a Ruby interpreter always <a class="indexterm" id="idx-CHP-11-1097"/>running in the background, ready to evaluate scripts and return their results to the webserver, but without the overhead of spawning and shutting down a distinct <code class="literal">ruby</code> process for each script. This makes the webserver start up a bit slower, because it needs to do more, but it saves a lot of machine overhead after just a few requests.</p><p>In the code, you’ll see <code class="literal">&lt;%</code> and <code class="literal">%&gt;</code>, the opening and closing <a class="indexterm" id="idx-CHP-11-1098"/>tags that mean <span class="emphasis"><em>Interpret my contents in Ruby, not as HTML</em></span>. But first we need to <a class="indexterm" id="idx-CHP-11-1099"/>set up Apache so that it knows how to handle <code class="literal">mod_ruby</code>. We’ve already installed the <code class="literal">mod_ruby</code> packages, but we need a configuration file. That’s <code class="literal">mod_ruby_demo.conf</code> below.</p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id041"/>The Code</h2></div></div></div><div class="sect3" title="mod_ruby_demo.conf"><div class="titlepage"><div><div><h3 class="title"><a id="mod_ruby_democonf"/>mod_ruby_demo.conf</h3></div></div></div><a id="I_programlisting11_d1e19468"/><pre class="programlisting">  &lt;IfModule mod_ruby.c&gt;    <em class="lineannotation"><span class="lineannotation">An Apache Config File</span></em>
    # for Apache::RubyRun
    RubyRequire apache/ruby-run

    # for Apache::ERubyRun
    RubyRequire apache/eruby-run

    # handle *.rcss as eruby files.
❷   &lt;Files *.rcss&gt;
      AddType text/css .rcss
      AddType application/x-httpd-ruby *.rb
      SetHandler ruby-object
      RubyHandler Apache::ERubyRun.instance
    &lt;/Files&gt;

    # handle *.rhtml as eruby files.
❷   &lt;Files *.rhtml&gt;
      AddType text/html .rhtml
      AddType application/x-httpd-ruby *.rb
      SetHandler ruby-object
      RubyHandler Apache::ERubyRun.instance
    &lt;/Files&gt;

    RubyRequire auto-reload

  &lt;/IfModule&gt;</pre><p>This file isn’t Ruby code—it uses Apache’s configuration file format. Put this file in <code class="literal">/etc/apache2/mods-available/</code>, with a symlink in <code class="literal">/etc/apache2/mod-enabled/</code>.<sup>[<a class="footnote" href="#ftn.CHP-11-FNOTE-2" id="CHP-11-FNOTE-2">33</a>]</sup> If you’re using Apache version 1.X (such as 1.3, which is still popular), you’ll add the contents of this file within your <code class="literal">/etc/apache/httpd.conf</code> file. As I noted for the <code class="literal">cgi-bin</code> directory, these specific file and directory locations are accurate for my system, but yours might be different.</p></div><div class="sect3" title="mod_ruby_demo.rhtml"><div class="titlepage"><div><div><h3 class="title"><a id="mod_ruby_demorhtml"/>mod_ruby_demo.rhtml</h3></div></div></div><p>This file should be more recognizable as a weird hybrid of HTML and Ruby code.<a class="indexterm" id="idx-CHP-11-1100"/><a class="indexterm" id="I_indexterm11_d1e19502"/></p><a id="I_programlisting11_d1e19507"/><pre class="programlisting">  &lt;!DOCTYPE html
       PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
  &lt;html  xml:lang="en" lang="en"&gt;

  &lt;head&gt;
  &lt;title&gt;Mod Ruby&lt;/title&gt;
  &lt;style&gt;
  code {
   background-color: #ddf;
   color: #f00;
   padding: 0.3em;
  }
  &lt;/style&gt;
  &lt;/head&gt;

  &lt;body&gt;
  &lt;h1&gt;Mod Ruby&lt;/h1&gt;

  &lt;p&gt;
  The eRuby command below should print &lt;q&gt;Hello, world!&lt;/q&gt;
  &lt;/p&gt;

  &lt;p&gt;
❸ &lt;q&gt;&lt;% print "Hello, world!" %&gt;&lt;/q&gt;    <em class="lineannotation"><span class="lineannotation"><strong class="userinput"><code>%</code></strong> tags</span></em>
  &lt;/p&gt;

  &lt;p&gt;
❹ Welcome to &lt;em&gt;&lt;%= ENV['SERVER_NAME'] %&gt;&lt;/em&gt;. If you see a server name,
❺ &lt;%= 'e' + 'Ruby' %&gt; is probably working.
  &lt;/p&gt;

  &lt;p&gt;
❻ The current time is &lt;%= Time.now %&gt;.
  &lt;/p&gt;

  &lt;p&gt;
  &lt;%
❼ def function_within_mod_ruby(input)
    "#{input} was passed through a function.\n"
  end

  print function_within_mod_ruby("Some sample input")
  print '&lt;br /&gt;'
  print function_within_mod_ruby("Some other sample input")
  %&gt;
  &lt;/p&gt;

  &lt;/body&gt;
  &lt;/html&gt;</pre><p>Put this file somewhere browsable via the <a class="indexterm" id="idx-CHP-11-1101"/>Web. I’ll assume it’s in http://localhost/mod_ruby/, making it accessible as http://localhost/mod_ruby/<a class="indexterm" id="idx-CHP-11-1102"/>mod_ruby_demo.rhtml.</p></div></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id040"/>How It Works</h2></div></div></div><p>Hopefully, <code class="literal">mod_ruby_demo.conf</code> will be completely opaque. I’m kidding, of course, but it’s not critical at this point if you don’t understand everything about this file. It’s great to know about <a class="indexterm" id="idx-CHP-11-1103"/>Apache configuration files, and you can certainly learn a great deal from the Apache website (<a class="ulink" href="http://www.apache.org">http://www.apache.org</a>) or the various Apache-related books out there, but what’s important for our purposes are points ❶ and ❷. At ❶, we declare that files having the <a class="indexterm" id="idx-CHP-11-1104"/>.rcss extension are to be interpreted as Ruby files. At ❷, we make the same declaration about files having the <a class="indexterm" id="idx-CHP-11-1105"/>.rhtml extension.<a class="indexterm" id="idx-CHP-11-1106"/></p><div class="note" title="Note"><h3 class="title"><a id="note-61"/>Note</h3><p><span class="emphasis"><em>Why these extensions? It’s a fairly common practice to define filename extensions for dynamically interpreted files with the normal extension and an additional preceding letter representing the programming language used. For example</em></span>, .rhtml <span class="emphasis"><em>is used for Ruby files that generate HTML output</em></span>, .rcss <span class="emphasis"><em>is used for Ruby files that generate CSS stylesheets, and so on. You may also sometimes see .phtml files that integrate Perl or PHP, or even .mhtml files that use the software Mason, written in Perl</em></span>.<a class="indexterm" id="idx-CHP-11-1107"/></p></div><p>That’s it for <code class="literal">mod_ruby_demo.conf</code>. In <code class="literal">mod_ruby_demo.rhtml</code>, we have some additional points of interest. It should look like standard HTML until ❸. At that point, we see this line: <code class="literal">&lt;q&gt;&lt;% print “Hello, world!” %&gt;&lt;/q&gt;</code>. The <code class="literal">&lt;%</code> and <code class="literal">%&gt;</code> are the <span class="emphasis"><em>Interpret my contents as</em></span> Ruby tags I mentioned earlier, so anything within those tags will be interpreted as Ruby code. In this case, we’re asking Ruby to print <code class="literal">‘Hello, world!’</code>, which it does, incorporating the printed <a class="indexterm" id="idx-CHP-11-1108"/>output within the eventual HTML.</p><p>You’ll probably expect that we often want to print <a class="indexterm" id="idx-CHP-11-1109"/>output that will be incorporated into the HTML. It would be tedious to keep using <code class="literal">print</code> statements, so there’s a shortcut, which you can see at ❹. If you use an initial code tag of <code class="literal">&lt;%=</code>, Ruby assumes that you want the evaluated expression to be printed. At ❹, we incorporate the value of <code class="literal">ENV[‘SERVER_NAME’]</code> within an <code class="literal">&lt;em&gt;</code> tag. Just to show that what falls between <code class="literal">&lt;%=</code> and <code class="literal">%&gt;</code> can be any expression, at ❺, we concatenate two Strings, only caring about the result.<a class="indexterm" id="idx-CHP-11-1110"/></p><p>The printed output doesn’t have to be a simple literal expression, either. At ❻, I show the value of a method call, which in this case results in the current local time. Finally, at ❼, we define a completely new method within our .rhtml file called <code class="literal">function_within_mod_ruby</code>, which is then available anytime afterward for use, as you can see in the code.<a class="indexterm" id="idx-CHP-11-1111"/></p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id038"/>The Results</h2></div></div></div><p>When I call this script via my own webserver, I get the results shown in <a class="xref" href="ch11s04.html#the_output_from_ltliteralgtmod_rubyltlit" title="Figure 11-2. The output from mod_ruby">Figure 11-2</a>.</p><div class="figure"><a id="the_output_from_ltliteralgtmod_rubyltlit"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject11_d1e19648"/><img alt="The output from mod_ruby" src="httpatomoreillycomsourcenostarchimages686172.png.jpg"/></div></div><p class="title">Figure 11-2. The output from <code class="literal">mod_ruby</code></p></div><p>The time will obviously be different in your result, but that should be the only difference, unless you specifically browse to your machine by a name other than <code class="literal">localhost</code>, or you placed <code class="literal">mod_ruby_demo.rhtml</code> under a different directory or gave it a different name.<a class="indexterm" id="idx-CHP-11-1112"/><a class="indexterm" id="I_indexterm11_d1e19664"/></p></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id030"/>Hacking the Script</h2></div></div></div><p>This script is a modification playground. You can put any Ruby expressions you want within those <code class="literal">&lt;%</code> or <code class="literal">&lt;%=</code> tags. Try using <code class="literal">require</code>, either with files that you know are part of the standard library (like <code class="literal">cgi</code>) or your own files. This technique lets you define all your real “things” as classes in .rb library files, reserving your .rhtml files for display.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-11-FNOTE-1" id="ftn.CHP-11-FNOTE-1">32</a>] </sup>Or an interpreter for whichever language the CGI program uses.</p></div><div class="footnote"><p><sup>[<a class="para" href="#CHP-11-FNOTE-2" id="ftn.CHP-11-FNOTE-2">33</a>] </sup>You can create a symlink with the command <code class="literal">ln -s</code> in a Unix shell.</p></div></div></div>
<div class="sect1" title="#43 CSS Stylesheets, Part I (stylesheet.rcss)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp43_css_stylesheets_part_i_styleshee"/>#43 CSS Stylesheets, Part I (stylesheet.rcss)</h1></div></div></div><p>Having .rhtml files is great—they allow you to dynamically generate whatever visible HTML you want. But you can use <code class="literal">mod_ruby</code> for more than that. A major portion of any well-designed modern website will be its stylesheets. One of the frustrations that web designers have to deal with is incomplete or incompatible CSS support among the various <a class="indexterm" id="idx-CHP-11-1113"/>browsers. There are lots of potential solutions for those frustrations, which you can find at sites like <a class="ulink" href="http://www.richinstyle.com">http://www.richinstyle.com</a> or <a class="ulink" href="http://alistapart.com">http://alistapart.com</a>. One obvious solution for programmers is to determine exactly which browser someone is using (via <code class="literal">ENV[‘USER_AGENT’]</code>) and serve that user a stylesheet customized for his or her specific browser.<a class="indexterm" id="idx-CHP-11-1114"/><a class="indexterm" id="idx-CHP-11-1115"/><a class="indexterm" id="idx-CHP-11-1116"/></p><p>That’s a great solution, put into practice countless times all over the Web. There is another solution, however. Why not make the stylesheet itself a dynamic .rcss file? With this approach, the stylesheet becomes polymorphic, to use a term from object-oriented programming. Every browser would refer to the same stylesheet by name and would then receive specific content that works just right for that browser. Here’s an example.</p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id042"/>The Code</h2></div></div></div><a id="I_programlisting11_d1e19718"/><pre class="programlisting">  /*
  This file outputs CSS data customized by user_agent via eruby.
  There is a blog entry about some similar ideas at
  http://blog.airbladesoftware.com/2006/12/11/cssdryer-dry-up-your-css
  */
  &lt;%
  # define functions
❶ def alpha_width(user_agent)
    width =
      if (user_agent =~ /Windows/)
        11.8 if (user_agent =~ /Opera/)
        11.8 if (user_agent =~ /MSIE 6/)
        14   if (user_agent =~ /MSIE/)
        11.8
      elsif (user_agent =~ /Palm/)
        5
      else
        11.8
      end
❷ return <a class="indexterm" id="idx-CHP-11-1117"/>%Q[\twidth:#{width}em;]
  end

❸ def beta_width(user_agent)
    width =
      if (user_agent =~ /Windows/)
        15.8 if (user_agent =~ /Opera/)
        15.8 if (user_agent =~ /MSIE 6/)
        18   if (user_agent =~ /MSIE/)
        15.8
      elsif (user_agent =~ /Palm/)
        7
      else
        15.8
      end
❹   return <a class="indexterm" id="idx-CHP-11-1118"/>%Q[\twidth:#{width}em;]
  end

❺ def margin_left(user_agent)
    margin =
      if (user_agent =~ /Mac/)
        3   if (user_agent =~ /Opera/)
        1   if (user_agent =~ /MSIE/)
        2.5 if (user_agent =~ /Safari/)
        2   if (user_agent =~ /Gecko/)
        2.7
      elsif (user_agent =~ /Windows/)
        1.5
      else
        2   if (user_agent =~ /Opera/)
        2   if (user_agent =~ /onqueror/)
        1.8 if (user_agent =~ /Galeon/)
        2.5
      end
❻   return %Q[margin-left:-#{margin}em;]
  end
  %&gt;

❼ li { &lt;%= margin_left(ENV['HTTP_USER_AGENT']) %&gt; }

  #navAlpha {
    position:absolute;
❽   &lt;%= alpha_width(ENV['HTTP_USER_AGENT']) %&gt;
    top:2em;
    left:2em;
    border:0.5em double #333;
    background-color:#ada;
    padding:1em;
    z-index:2;
  }

  #navBeta {
    position:absolute;
❾   &lt;%= beta_width(ENV['HTTP_USER_AGENT']) %&gt;
    top:2em;
    right:2em;
    border:0.5em double #333;
    background-color:#ada;
    padding:1em;
    z-index:1;
  }</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id041"/>How It Works</h2></div></div></div><p>Much like <code class="literal">mod_ruby_demo.rhtml</code>, this is mainly a file with some other format (in this case a <a class="indexterm" id="idx-CHP-11-1119"/>CSS stylesheet) that happens to have a little Ruby interspersed within it. We define a new function called <code class="literal">alpha_width</code> at ❶ that determines the value of a local variable called <code class="literal">width</code>, finally returning it within a bit of text that follows <a class="indexterm" id="idx-CHP-11-1120"/>CSS formatting at ❷. Note that this function takes advantage of the fact that even <code class="literal">if</code> statements in Ruby return a value, in this case, assigning that value into <code class="literal">width</code>. We do something similar with <code class="literal">beta_width</code> at ❸, which returns its own CSS-formatted output at ❹. Finally, we define <code class="literal">margin_left</code> at ❺, which returns CSS at ❻.<a class="indexterm" id="idx-CHP-11-1121"/></p><div class="note" title="Note"><h3 class="title"><a id="note-62"/>Note</h3><p><span class="emphasis"><em>Why those particular functions? I found that the CSS support variations that frustrated me the most were the differences involving margins and padding and left margins for list items, so those are the functions I made. People who know more about CSS than I do have probably found more elegant solutions, but sometimes a pretty good solution now is better than a perfect solution when it’s too late. The point of this script is also to demonstrate that the polymorphic stylesheet technique</em></span> can <span class="emphasis"><em>be done, but this isn’t precisely</em></span> how <span class="emphasis"><em>it should be done. If you care a great deal about CSS, you can use this technique to accomplish much bigger things</em></span>.</p></div><p>Then we use the output of <code class="literal">margin_left</code> within a CSS declaration for a list element at ❼. The stylesheet also defines two IDs called <code class="literal">#navAlpha</code> and <code class="literal">#navBeta</code>, which are just identifiers for column divs. Within <code class="literal">#navAlpha</code> at ❽, we use the output of <code class="literal">alpha_width</code> for the width of <code class="literal">#navAlpha</code>, and at ❾, we do something analogous for <code class="literal">#navBeta</code>.</p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id039"/>The Results</h2></div></div></div><p>Here’s the output of <code class="literal">stylesheet.rcss</code> when I browse to it using Mozilla Firefox on an Ubuntu system:<a class="indexterm" id="idx-CHP-11-1122"/></p><a id="I_programlisting11_d1e19812"/><pre class="programlisting">/*
This file outputs CSS data customized by user_agent via eruby.
There is a blog entry about some similar ideas at
http://blog.airbladesoftware.com/2006/12/11/cssdryer-dry-up-your-css
*/


li { margin-left:-2.5em; }

#navAlpha {
  position:absolute;
        width:11.8em;
  top:2em;
  left:2em;
  border:0.5em double #333;
  background-color:#ada;
  padding:1em;
  z-index:2;
}

#navBeta {
  position:absolute;
        width:15.8em;
  top:2em;
  right:2em;
  border:0.5em double #333;
  background-color:#ada;
  padding:1em;
  z-index:1;
}</pre><p>You’ll notice that the appropriate values are interpolated within the <code class="literal">li</code> and <code class="literal">width</code> <a class="indexterm" id="idx-CHP-11-1123"/>CSS declarations. Your results may differ, since the whole point of this file is to provide different output for different <a class="indexterm" id="idx-CHP-11-1124"/>browsers.</p></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id031"/>Hacking the Script</h2></div></div></div><p>There are many hacking options for this script. One is our next script, <code class="literal">stylesheet2.rcss</code>.<a class="indexterm" id="idx-CHP-11-1125"/></p></div></div>
<div class="sect1" title="#44 CSS Stylesheets, Part II (stylesheet2.rcss)"><div class="titlepage"><div><div><h1 class="title"><a id="sharp44_css_stylesheets_part_ii_styleshe"/>#44 CSS Stylesheets, Part II (stylesheet2.rcss)</h1></div></div></div><p>In many ways, this script is just a glorified hack of <code class="literal">stylesheet.rcss</code>. I separated it mainly to allow for comparison. The major difference between the two files is that <code class="literal">stylesheet2.rcss</code> generalizes the <code class="literal">width</code> values into a single function.<a class="indexterm" id="idx-CHP-11-1126"/><a class="indexterm" id="I_indexterm11_d1e19859"/></p><div class="sect2" title="The Code"><div class="titlepage"><div><div><h2 class="title"><a id="the_code-id043"/>The Code</h2></div></div></div><a id="I_programlisting11_d1e19865"/><pre class="programlisting">  /*
  This file outputs CSS data customized by user_agent using eruby.
  */
  &lt;%
  # define functions
❶ def width(type, user_agent)
❷   small = {
      'alpha' =&gt; 11.8,
      'beta'  =&gt; 15.8,
    }
❸   large = {
      'alpha' =&gt; 14,
      'beta'  =&gt; 18,
    }
❹   palm = {
      'alpha' =&gt; 5,
      'beta'  =&gt; 7,
    }
❺   width =
      if (user_agent =~ /Windows/)
        small[type] if (user_agent =~ /Opera/)
        small[type] if (user_agent =~ /MSIE 6/)
        large[type] if (user_agent =~ /MSIE/)
        small[type]
      elsif (user_agent =~ /Palm/)
        palm[type]
      else
        small[type]
      end
    return <a class="indexterm" id="idx-CHP-11-1127"/>%Q[\twidth:#{width}em;]
  end

  def margin_left(user_agent)
    margin =
      if (user_agent =~ /Mac/)
        3   if (user_agent =~ /Opera/)
        1   if (user_agent =~ /MSIE/)
        2.5 if (user_agent =~ /Safari/)
        2   if (user_agent =~ /Gecko/)
        2.7
      elsif (user_agent =~ /Windows/)
        1.5
      else
        2   if (user_agent =~ /Opera/)
        2   if (user_agent =~ /onqueror/)
        1.8 if (user_agent =~ /Galeon/)
        2.5
      end
    return %Q[margin-left:-#{margin}em;]
  end
  %&gt;

  li { &lt;%= margin_left(ENV['HTTP_USER_AGENT']) %&gt; }

  #navAlpha {
    position:absolute;
    &lt;%= width('alpha', ENV['HTTP_USER_AGENT']) %&gt;
    top:2em;
    left:2em;
    border:0.5em double #333;
    background-color:#ada;
    padding:1em;
    z-index:2;
  }

  #navBeta {
    position:absolute;
    &lt;%= width('beta', ENV['HTTP_USER_AGENT']) %&gt;
    top:2em;
    right:2em;
    border:0.5em double #333;
    background-color:#ada;
    padding:1em;
    z-index:1;
  }</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h2 class="title"><a id="how_it_works-id042"/>How It Works</h2></div></div></div><p>At ❶, we define the general <code class="literal">width</code> function, which you’ll see now takes two arguments: the user agent as before, but also the <code class="literal">type</code> of column we’re generating <code class="literal">width</code> for. We then have separate Hashes for <code class="literal">small</code> (❷), <code class="literal">large</code> (❸), and <code class="literal">palm</code> (❹). <a class="indexterm" id="idx-CHP-11-1128"/>Palm devices always use their own Hash, while other browsers use either the <code class="literal">small</code> or <code class="literal">large</code> Hash, depending on the specific user agent. Then at ❺, we determine the <code class="literal">width</code>.<sup>[<a class="footnote" href="#ftn.CHP-11-FNOTE-3" id="CHP-11-FNOTE-3">34</a>]</sup> The <code class="literal">type</code> is simply the key for whichever Hash has already been decided on. Everything else is identical to <code class="literal">stylesheet.rcss</code>, except that calls to either <code class="literal">alpha_width</code> or <code class="literal">beta_width</code> are now calls to <code class="literal">width</code>, as described already.</p></div><div class="sect2" title="The Results"><div class="titlepage"><div><div><h2 class="title"><a id="the_results-id040"/>The Results</h2></div></div></div><p>As before, here’s the output with my setup.</p><a id="I_programlisting11_d1e19939"/><pre class="programlisting">/*
This file outputs <a class="indexterm" id="idx-CHP-11-1129"/>CSS data customized by user_agent using eruby.
*/


li { margin-left:-2.5em; }

#navAlpha {
  position:absolute;
        width:11.8em;
  top:2em;
  left:2em;
  border:0.5em double #333;
  background-color:#ada;
  padding:1em;
  z-index:2;
}

#navBeta {
  position:absolute;
        width:15.8em;
  top:2em;
  right:2em;
  border:0.5em double #333;
  background-color:#ada;
  padding:1em;
  z-index:1;
}</pre><p>This output is basically the same as that for <code class="literal">stylesheet.rcss</code>, except for the preliminary comments.</p></div><div class="sect2" title="Hacking the Script"><div class="titlepage"><div><div><h2 class="title"><a id="hacking_the_script-id032"/>Hacking the Script</h2></div></div></div><p>As I already noted, someone with a better grasp of <a class="indexterm" id="idx-CHP-11-1130"/>CSS could really customize this script to do some marvelous things. There are undoubtedly better ways to accomplish what this script does, but its point was to show the technique in broad strokes. I hope you found it useful.</p></div><div class="footnotes"><br/><hr/><div class="footnote"><p><sup>[<a class="para" href="#CHP-11-FNOTE-3" id="ftn.CHP-11-FNOTE-3">34</a>] </sup>Don’t be confused by the fact that there is both a function called <code class="literal">width</code> and a local variable inside it also called <code class="literal">width</code>. Anything outside the function can’t get at the variable, and the function knows to check whether or not there’s a variable by that name before automatically making a recursive call to itself.</p></div></div></div>
<div class="sect1" title="Chapter Recap"><div class="titlepage"><div><div><h1 class="title"><a id="chapter_recap-id009"/>Chapter Recap</h1></div></div></div><p>What was new in this chapter?</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Using Ruby for CGI scripts</p></li><li class="listitem"><p>The <code class="literal">cgi</code> library</p></li><li class="listitem"><p><code class="literal">cgi.params</code></p></li><li class="listitem"><p><code class="literal">mod_ruby</code></p></li><li class="listitem"><p>.rhtml and .rcss files</p></li><li class="listitem"><p>Apache configuration files<a class="indexterm" id="I_indexterm11_d1e19988"/></p></li></ul></div><p>This chapter scratches the surface of CGI programming, with Ruby or other languages. Its purpose was to get you comfortable with using Ruby to interact with a webserver and browser. Most web-based coding in Ruby makes use of the Rails framework, which we’ll get to soon. But first, we’ll be installing Rails with the RubyGems system, so that is the subject of our next chapter.</p></div></body></html>