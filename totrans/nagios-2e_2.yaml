- en: Part II. In More Detail...
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第二部分：更详细地...
- en: Chapter 4. Nagios Basics
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第 4 章：Nagios 基础
- en: The fact that a host can be reached, in itself, has little meaning if no service
    is running on it on which somebody or something relies. Accordingly, everything
    in Nagios revolves around service checks. After all, no service can run without
    a host. If the host computer fails, it cannot provide the desired service. Things
    get slightly more complicated if, for example, a router that lies between users
    and the system providing services is brought into play. If this fails, the desired
    service may still be running on the target host, but it is nevertheless no longer
    reachable for the user.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一个主机可以访问，但上面没有运行任何依赖的服务，那么这个事实本身几乎没有意义。因此，Nagios 中的所有内容都围绕着服务检查展开。毕竟，没有主机就无法运行服务。如果主机计算机失败，它就无法提供所需的服务。如果，例如，一个位于用户和提供服务的系统之间的路由器被引入，事情会变得稍微复杂一些。如果这个路由器失败了，目标主机上可能仍然运行着所需的服务，但对于用户来说，它仍然无法访问。
- en: Nagios is in a position to reproduce such dependencies and to precisely inform
    the administrator of the failure of an important network component, instead of
    flooding the administrator with irrelevant error messages concerning services
    that cannot be reached. An understanding of such dependencies is essential for
    the smooth operation of Nagios, which is why [4.1 Taking into Account the Network
    Topology](../Text/ch04.html#taking_into_account_the_network_topology "4.1 Taking
    into Account the Network Topology") will examine these dependencies and the way
    Nagios works in more detail.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios 能够重现这样的依赖关系，并精确地通知管理员一个重要网络组件的故障，而不是让管理员被无法访问的服务的不相关错误信息淹没。理解这些依赖关系对于
    Nagios 的平稳运行至关重要，这就是为什么 [4.1 考虑网络拓扑](../Text/ch04.html#taking_into_account_the_network_topology
    "4.1 考虑网络拓扑") 将会详细检查这些依赖关系以及 Nagios 的工作方式。
- en: Another important item is the *state* of a host or service. On the one hand
    Nagios allows a much finer distinction than just OK or "not OK;" on the other
    hand the distinction between *soft state* and *hard state* means that the administrator
    does not have to deal with short-term disruptions that have long since disappeared
    by the time the administrator has received the information. These states also
    influence the intensity of the service checks. How this functions is described
    in detail in [4.3 States of Hosts and Services](../Text/ch04s03.html "4.3 States
    of Hosts and Services").
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个重要的事项是主机或服务的 *状态*。一方面，Nagios 允许比仅仅 OK 或 "not OK" 更精细的区分；另一方面，*软状态* 和 *硬状态*
    之间的区分意味着管理员不必处理那些在管理员收到信息时早已消失的短期中断。这些状态也会影响服务检查的强度。这种功能是如何工作的将在 [4.3 主机和服务的状态](../Text/ch04s03.html
    "4.3 主机和服务的状态") 中详细描述。
- en: 4.1 Taking into Account the Network Topology
  id: totrans-5
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 4.1 考虑网络拓扑
- en: How Nagios handles dependencies of hosts and services can be best illustrated
    with an example. [Figure 4-1](../Text/ch04.html#topology_of_an_example_network
    "Figure 4-1. Topology of an example network") represents a small network in which
    the Domain Name Service on **`proxy`** is to be monitored.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios 如何处理主机和服务的依赖关系，可以通过一个例子来最好地说明。[图 4-1](../Text/ch04.html#topology_of_an_example_network
    "图 4-1. 示例网络的拓扑") 表示一个包含要监控的 **`proxy`** 上的域名服务的小型网络。
- en: '![Topology of an example network](../Images/tagoreillycom20081104nostarchimages223798.png)'
  id: totrans-7
  prefs: []
  type: TYPE_IMG
  zh: '![示例网络的拓扑](../Images/tagoreillycom20081104nostarchimages223798.png)'
- en: Figure 4-1. Topology of an example network
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4-1. 示例网络的拓扑
- en: The service check always serves as the starting point for monitoring that is
    regularly performed by the system. As long as the service can be reached, Nagios
    takes no further steps; that is, it does not perform any host checks.^([[41](#ftn.CHP-4-FN-1)])
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 服务检查始终是系统定期执行的监控的起点。只要服务可以访问，Nagios 就不会采取进一步措施；也就是说，它不会执行任何主机检查.^([[41](#ftn.CHP-4-FN-1)])
- en: For **`switch1`**, **`switch2`**, and **`proxy`**, such a check would be pointless
    anyway, because if the DNS service responds to **`proxy`**, then the hosts mentioned
    are automatically accessible.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 **`switch1`**、**`switch2`** 和 **`proxy`**，这样的检查无论如何都是没有意义的，因为如果 DNS 服务对 **`proxy`**
    响应，那么提到的主机将自动可访问。
- en: If the name service fails, however, Nagios tests the computer involved with
    a host check, to see whether the service or the host is causing the problem.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，如果域名服务失败，Nagios 将通过主机检查测试相关的计算机，以查看是服务还是主机导致了问题。
- en: If **`proxy`** cannot be reached, Nagios might test the *parent* hosts entered
    in the configuration ([Figure 4-2](../Text/ch04.html#the_order_of_tests_performed_after_a
    "Figure 4-2. The order of tests performed after a service failure")). With the
    **`parents`** host parameter, the administrator has a means available to provide
    Nagios with information on the network topology.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 如果**`proxy`**无法访问，Nagios可能会测试配置中输入的**`parent`**主机（[图4-2](../Text/ch04.html#the_order_of_tests_performed_after_a
    "图4-2. 服务失败后执行的测试顺序")）。通过**`parents`**主机参数，管理员可以提供有关网络拓扑结构的信息给Nagios。
- en: '![The order of tests performed after a service failure](../Images/tagoreillycom20081104nostarchimages223800.png)'
  id: totrans-13
  prefs: []
  type: TYPE_IMG
  zh: '![服务失败后执行的测试顺序](../Images/tagoreillycom20081104nostarchimages223800.png)'
- en: Figure 4-2. The order of tests performed after a service failure
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 图4-2. 服务失败后执行的测试顺序
- en: 'When doing this, the administrator only enters the direct neighbor computer
    for each host on the same path to the Nagios server as the parent.^([[42](#ftn.CHP-4-FN-2)])
    Hosts that are allocated in the same network segment as the Nagios server itself
    are defined without a parent. For the network topology from [Figure 4-1](../Text/ch04.html#topology_of_an_example_network
    "Figure 4-1. Topology of an example network"), the corresponding configuration
    (reduced to the host name and parent) appears as follows:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在进行此操作时，管理员只需为每个主机输入与Nagios服务器同一路径上的直接相邻计算机作为父节点。[42](#ftn.CHP-4-FN-2)] 同一网络段内分配的主机定义为没有父节点。对于[图4-1](../Text/ch04.html#topology_of_an_example_network
    "图4-1. 示例网络的拓扑结构")中的网络拓扑，相应的配置（简化为主机名和父节点）如下所示：
- en: '[PRE0]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '**`switch1`** is located in the same network segment as the Nagios server,
    so it is therefore not allocated a parent computer. What belongs to a network
    segment is a matter of opinion. If you interpret the switches as the segment limit,
    as is the case here, this has the advantage of being able to more closely isolate
    a disruption. But you can also take a different view and interpret an IP subnetwork
    as a segment. Then a router would form the segment limit; in our example, **`proxy`**
    would then count in the same network as the Nagios server. However, it would no
    longer be possible to distinguish between a failure of **`proxy`** and a failure
    of **`switch1`** or **`switch2`**.'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: '**`switch1`**位于与Nagios服务器相同的网络段中，因此没有分配父计算机。属于网络段的是一种观点。如果您将交换机解释为段限制，就像这里的情况一样，这有一个优点，即可以更紧密地隔离中断。但您也可以有不同的看法，将IP子网解释为段。那么，路由器就会形成段限制；在我们的例子中，**`proxy`**就会计入与Nagios服务器相同的网络。然而，将无法区分**`proxy`**的故障与**`switch1`**或**`switch2`**的故障。'
- en: '![Classification of individual network nodes by Nagios](../Images/tagoreillycom20081104nostarchimages223802.png)'
  id: totrans-18
  prefs: []
  type: TYPE_IMG
  zh: '![Nagios对单个网络节点的分类](../Images/tagoreillycom20081104nostarchimages223802.png)'
- en: Figure 4-3. Classification of individual network nodes by Nagios
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 图4-3. Nagios对单个网络节点的分类
- en: If **`switch1`** in the example fails, [Figure 4-3](../Text/ch04.html#classification_of_individual_network_no
    "Figure 4-3. Classification of individual network nodes by Nagios") shows the
    sequence in which Nagios proceeds. First the system checks the DNS service on
    **`proxy`** and determines that this service is no longer reachable (1). To differentiate,
    it now performs a host check to determine the state of the **`proxy`** computer
    (2). Since **`proxy`** cannot be reached, but it has **`switch2`** as a parent,
    Nagios performs a host check on **`switch2`** (3). If this switch also cannot
    be reached, the system checks its parent, **`switch1`** (4).
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 如果示例中的**`switch1`**失败，[图4-3](../Text/ch04.html#classification_of_individual_network_no
    "图4-3. Nagios对单个网络节点的分类")显示了Nagios执行的顺序。首先，系统检查**`proxy`**上的DNS服务并确定该服务已无法访问（1）。为了区分，它现在执行主机检查以确定**`proxy`**计算机的状态（2）。由于**`proxy`**无法访问，但它有**`switch2`**作为父节点，Nagios在**`switch2`**上执行主机检查（3）。如果这个交换机也无法访问，系统会检查其父节点，即**`switch1`**（4）。
- en: 'If Nagios can establish contact with **`switch1`**, the cause for the failure
    of the DNS service on **`proxy`** can be isolated to **`switch2`**. The system
    accordingly specifies the states of the host: **`switch1`** is UP, **`switch2`**
    DOWN; **`proxy`**, on the other hand, is UNREACHABLE. Through a suitable configuration
    of the Nagios messaging system (see [12.3 The Message Filter](../Text/ch12s03.html
    "12.3 The Message Filter") in page 267) you can use this distinction to determine,
    for example, that the administrator is informed only about the host that is in
    the DOWN state and represents the actual problem, but not about the hosts that
    are dependent on the down host.'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 如果Nagios能够与**`switch1`**建立联系，那么**`proxy`**上DNS服务失败的故障原因就可以隔离到**`switch2`**。系统相应地指定了主机的状态：**`switch1`**是UP状态，**`switch2`**是DOWN状态；另一方面，**`proxy`**是不可达的。通过适当配置Nagios消息系统（参见第267页的[12.3
    消息过滤器](../Text/ch12s03.html "12.3 消息过滤器")），你可以使用这种区别来确定，例如，只有当主机处于DOWN状态并代表实际问题时，管理员才会被通知，而不是通知那些依赖于DOWN主机的其他主机。
- en: In a further step, Nagios can determine other topology-specific failures in
    the network (so-called *network outages*). **`proxy`** is the parent of **`gate`**,
    so **`gate`** is also represented as UNREACHABLE (5). **`gate`** in turn functions
    as a parent; the Internet server dependent on this is also classified as "UNREACHABLE."
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 在进一步的操作中，Nagios可以确定网络中的其他拓扑特定故障（所谓的*网络中断*）。**`proxy`**是**`gate`**的父节点，因此**`gate`**也被表示为UNREACHABLE（5）。**`gate`**反过来又作为父节点；依赖于这个节点的互联网服务器也被分类为“UNREACHABLE”。
- en: This "intelligence," which distinguishes Nagios, helps the administrator all
    the more when more hosts and services are dependent on a failed component. For
    a router in the backbone, on which hundreds of hosts and services are dependent,
    the system informs administrators of the specific disruption, instead of sending
    them hundreds of error messages that are not wrong in principle, but are not really
    of any help in trying to eliminate the disruption.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 这种“智能”，即Nagios所特有的，当更多主机和服务依赖于一个失败的组件时，对管理员帮助就更大了。对于一个骨干网中的路由器，它依赖于数百个主机和服务，系统会通知管理员具体的故障，而不是发送数百条本质上没有错误但实际对消除故障没有帮助的错误消息。
- en: '* * *'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[41](#CHP-4-FN-1)]) [4.2 On-Demand Host Checks vs. Periodic Reachability
    Tests](../Text/ch04s02.html "4.2 On-Demand Host Checks vs. Periodic Reachability
    Tests") from page 95 deals with these *on-demand checks*
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[41](#CHP-4-FN-1)]) 第95页的[4.2 按需主机检查与定期可达性测试](../Text/ch04s02.html "4.2 按需主机检查与定期可达性测试")讨论了这些*按需检查*。
- en: ^([[42](#CHP-4-FN-2)]) The parameter name **`parents`** can be explained by
    the fact that there are scenarios— such as in high availability environments—in
    which a host has two upstream routers that guarantee the Internet connection,
    for example.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[42](#CHP-4-FN-2)]) 参数名称**`parents`**可以通过以下事实来解释：存在一些场景——例如在高可用性环境中——其中主机有两个上游路由器来保证互联网连接，例如。
- en: 4.2 On-Demand Host Checks vs. Periodic Reachability Tests
  id: totrans-27
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 4.2 按需主机检查与定期可达性测试的比较
- en: 'As a matter of principle, Nagios performs service checks at regular intervals,
    with the exception of passive service checks. (See [13.2 Passive Service Checks](../Text/ch13s02.html
    "13.2 Passive Service Checks") in page 293.) Some slightly different rules apply
    for host checks, which play the main role. Nagios executes host checks when it
    needs them—that is, *on demand*—and uses them to monitor hosts where a service
    installed on them changes to an error state or hosts that lie in topological dependency
    to a failed host. A third way is via host dependencies, as described in [12.6.2
    Only in exceptional cases: host dependencies](../Text/ch12s06.html#only_in_exceptional_cases_colon_host_de
    "12.6.2 Only in exceptional cases: host dependencies") in page 289\. On-demand
    host checks are a core function of Nagios, as this is the only way the system
    can precisely inform the administrator about a failed central switch, instead
    of bombarding him with thousands of error messages about unreachable services.'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 原则上，Nagios定期执行服务检查，除了被动服务检查。 （参见第293页的[13.2 被动服务检查](../Text/ch13s02.html "13.2
    被动服务检查")。）对于主机检查，有一些稍微不同的规则适用，因为它们扮演着主要角色。Nagios在需要时执行主机检查——也就是说，*按需*——并使用它们来监控那些安装了服务的状态变为错误状态的主机，或者那些与失败主机存在拓扑依赖关系的主机。第三种方式是通过主机依赖性，如第289页的[12.6.2
    仅在异常情况下：主机依赖性](../Text/ch12s06.html#only_in_exceptional_cases_colon_host_de "12.6.2
    仅在异常情况下：主机依赖性")所述。按需主机检查是Nagios的核心功能，因为这是系统唯一能够精确通知管理员一个失败的中央交换机，而不是用成千上万关于不可达服务的错误消息轰炸他的方式。
- en: Planned host checks at regular intervals—*active host checks* in Nagios terminology
    —play only a minor role. Although Nagios 2.0 does provide a way to do this, Nagios
    2.x only performs active host checks serially, which is considered to be a real
    performance killer.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 定期间隔计划的主机检查——在Nagios术语中称为*主动主机检查*——只扮演了较小的角色。尽管Nagios 2.0确实提供了一种实现这种方式的方法，但Nagios
    2.x只以串行方式执行主动主机检查，这被认为是一个真正的性能杀手。
- en: In Nagios 3.0, checks are executed simultaneously, eliminating the drop in performance
    of earlier versions. If a Nagios version prior to 3.0 is used, you would be well
    advised not to use active host checks. However, in Nagios 3.0 regular host checks
    like these can help to improve performance, because this version caches the check
    results, if required, for a time that can be specified. Instead of running an
    on-demand check, Nagios then reverts to the cached result, saving considerable
    time—provided that this is still sufficiently up-to-date. The new logic for host
    checks in Nagios 3.0 is dealt with in [H.7 A New Logic for Host Checks](../Text/aphs07.html
    "H.7 A New Logic for Host Checks") in page 689.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 在Nagios 3.0中，检查是同时执行的，消除了早期版本性能下降的问题。如果使用3.0之前的Nagios版本，建议不要使用主动主机检查。然而，在Nagios
    3.0中，像这样的常规主机检查可以帮助提高性能，因为该版本可以缓存检查结果，如果需要，可以指定缓存时间。Nagios在需要时将回退到缓存的结果，从而节省大量时间——前提是这些结果仍然足够最新。Nagios
    3.0中主机检查的新逻辑在[第689页的H.7 主机检查的新逻辑](../Text/aphs07.html "H.7 主机检查的新逻辑")中进行了处理。
- en: The reachability of a host can also be regularly be checked in Nagios 2.x by
    using a trick in the shape of a ping-based service check (see [6.2 Reachability
    Test with Ping](../Text/ch06s02.html "6.2 Reachability Test with Ping") in page
    108). Nagios performs service checks in parallel, so the serial brake in performance
    under Nagios 2.x is released. At the same time you will obtain further information
    such as the response times or possible packet losses, which provides indirect
    clues about the network load or possible network problems. A host check, on the
    other hand, also issues an OK even if many packets go missing and the network
    performance is catastrophic. What is involved here, as the name "host check" implies,
    is only reachability in principle and not the quality of the connection.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 在Nagios 2.x中，可以通过使用基于ping的服务检查技巧来定期检查主机的可达性（参见第108页的[6.2 使用Ping进行可达性测试](../Text/ch06s02.html
    "6.2 使用Ping进行可达性测试")）。Nagios并行执行服务检查，因此在Nagios 2.x下的性能下降问题得到了缓解。同时，你还可以获得更多额外信息，如响应时间或可能的丢包，这为网络负载或可能的网络问题提供了间接线索。另一方面，主机检查即使在许多数据包丢失且网络性能极差的情况下也会发出OK状态。正如“主机检查”这个名字所暗示的，这里涉及到的仅仅是原则上可达性，而不是连接质量。
- en: 4.3 States of Hosts and Services
  id: totrans-32
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 4.3 主机和服务的状态
- en: 'Nagios uses plugins for the host and service checks. They provide four different
    return values (see [Table 6-1](../Text/ch06.html#return_values_for_nagios_plugins
    "Table 6-1. Return values for Nagios plugins") in page 105): **`0`** (OK), **`1`**
    (WARNING), **`2`** (CRITICAL), and **`3`** (UNKNOWN).'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios使用插件进行主机和服务检查。它们提供四种不同的返回值（参见第105页的[表6-1](../Text/ch06.html#return_values_for_nagios_plugins
    "表6-1. Nagios插件的返回值")）：**`0`**（OK），**`1`**（WARNING），**`2`**（CRITICAL），和**`3`**（UNKNOWN）。
- en: The return value UNKNOWN means that the running of the plugin generally went
    wrong, perhaps because of wrong parameters. You can normally specify the situations
    in which the plugin issues a warning or a critical state when it is started.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 返回值UNKNOWN表示插件运行通常出错，可能是由于参数错误。通常可以指定插件启动时发出警告或临界状态的情况。
- en: 'Nagios determines the states of services and hosts from the return values of
    the plugin. The states for services are the same as the return values OK, WARNING,
    CRITICAL, and UNKNOWN. For the hosts the picture is slightly different: the UP
    state describes a reachable host, DOWN means that the computer is down, and UNREACHABLE
    refers to the state of nonreachability, where Nagios cannot test whether the host
    is available or not, because a parent is down (see [4.1 Taking into Account the
    Network Topology](../Text/ch04.html#taking_into_account_the_network_topology "4.1
    Taking into Account the Network Topology"), page 92).'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios通过插件的返回值来确定服务和主机的状态。服务状态与返回值OK、WARNING、CRITICAL和UNKNOWN相同。对于主机来说，情况略有不同：UP状态描述了一个可达的主机，DOWN表示计算机已关闭，而UNREACHABLE指的是不可达状态，此时Nagios无法测试主机是否可用，因为父节点已关闭（参见[4.1
    考虑网络拓扑](../Text/ch04.html#taking_into_account_the_network_topology "4.1 考虑网络拓扑")，第92页）。
- en: 'In addition to this, Nagios makes a distinction between two types of state:
    soft state and hard state. If a problem occurs for the first time (that is, if
    there was nothing wrong with the state of a service until now), then the program
    categorizes the new state initially as a soft state and repeats the test several
    times. It may be the case that the error state was just a one-off event that was
    eliminated a short while later. Only if the error continues to exist after multiple
    tests is it then categorized by Nagios as a hard state. Administrators are informed
    only of hard states, because messages involving short-term disruptions that disappear
    again immediately afterwards only add to an unnecessary flood of information.'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，Nagios 在两种状态之间做出区分：软状态和硬状态。如果问题首次发生（即，直到现在服务的状态都没有问题），则程序最初将该新状态分类为软状态，并重复测试几次。可能的情况是，错误状态只是短暂的事件，稍后就被消除了。只有当错误在多次测试后仍然存在时，Nagios
    才将其分类为硬状态。管理员只会被告知硬状态，因为涉及短期中断的消息，而这些中断随后又立即消失，只会导致信息的不必要泛滥。
- en: 'In our example the chronological sequence of states of a service can be illustrated
    quite simply. A service with the following parameters is used for this purpose:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的示例中，可以非常简单地说明服务状态的时间序列。使用以下参数的服务用于此目的：
- en: '[PRE1]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '**`normal_check_interval`** specifies at what interval Nagios should check
    the corresponding service as long as the state is OK or if a hard state exists—in
    this case, every five minutes. **`retry_check_interval`** defines the interval
    between two service checks during a soft state—one minute in the example. If a
    new error occurs, then Nagios will take a closer look at the service at shorter
    intervals.'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: '**`normal_check_interval`** 指定了 Nagios 在服务状态正常或存在硬状态时应检查相应服务的间隔——在这种情况下，每五分钟检查一次。**`retry_check_interval`**
    定义了软状态期间两次服务检查之间的间隔——在示例中为 一分钟。如果发生新的错误，Nagios 将在更短的间隔内更仔细地检查服务。'
- en: '**`max_check_attempts`** determines how often the service check is to be repeated
    after an error has first occurred. If **`max_check_attempts`** has been reached
    and if the error state continues, Nagios inspects the service again at the intervals
    specified in **`normal_check_interval`**.'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: '**`max_check_attempts`** 确定了在首次发生错误后服务检查应重复的次数。如果达到 **`max_check_attempts`**
    并错误状态持续，Nagios 将在 **`normal_check_interval`** 中指定的间隔内再次检查服务。'
- en: '[Figure 4-4](../Text/ch04s03.html#example_of_the_chronological_progressio "Figure 4-4. Example
    of the chronological progression of states in a monitored service") represents
    the chronological progression in graphic form. The illustration begins with an
    OK state (which is always a hard state). Normally Nagios will repeat the service
    check at five-minute intervals. After ten minutes an error occurs; the state changes
    to CRITICAL, but this is initially a soft state. At this point in time, Nagios
    has not yet issued any message.'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 4-4](../Text/ch04s03.html#example_of_the_chronological_progressio "图 4-4.
    监控服务状态时间序列的示例") 以图形形式表示了时间序列的进展。插图从 OK 状态（这始终是硬状态）开始。通常 Nagios 将在五分钟间隔内重复服务检查。十分钟时发生错误；状态变为
    CRITICAL，但最初是软状态。此时，Nagios 尚未发出任何消息。'
- en: Now the system checks the service at intervals specified in **`retry_check_interval`**.
    Here this is every minute. After a total of five checks (as specified in **`max_check_attempts`**)
    with the same result, the state changes from soft to hard. Only now does Nagios
    inform the relevant people. The tests are now repeated at the intervals specified
    in **`normal_check_interval`**.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，系统以 **`retry_check_interval`** 中指定的间隔检查服务。这里是一分钟。在总共五次（如 **`max_check_attempts`**
    中指定）检查并得到相同结果后，状态从软状态变为硬状态。只有现在 Nagios 才会通知相关人员。现在测试将以 **`normal_check_interval`**
    中指定的间隔重复进行。
- en: '![Example of the chronological progression of states in a monitored service](../Images/tagoreillycom20081104nostarchimages223804.png)'
  id: totrans-43
  prefs: []
  type: TYPE_IMG
  zh: '![监控服务状态时间序列的示例](../Images/tagoreillycom20081104nostarchimages223804.png)'
- en: Figure 4-4. Example of the chronological progression of states in a monitored
    service
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 图 4-4. 监控服务状态时间序列的示例
- en: In the next test the service is again available; thus its state changes from
    CRITICAL to OK. Since an OK state is always a hard state, this change is not subject
    to any tests by Nagios at shorter intervals.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一次测试中，服务再次可用；因此其状态从 CRITICAL 变为 OK。由于 OK 状态始终是硬状态，因此这种变化不会受到 Nagios 在更短间隔内进行的任何测试的影响。
- en: The transition of the service to the OK state after an error in the hard state
    is referred to as a *hard recovery*. The system informs the administrators of
    this (if it is configured to do so) as well as of the change between various error-connected
    hard states (such as from WARNING to UNKNOWN). If the service recovers from an
    error soft state to the normal state (OK)—also called a *soft recovery*—the administrators
    will not be notified.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 服务在硬状态错误后过渡到OK状态被称为*硬恢复*。系统会通知管理员这一点（如果配置了这样做），以及各种错误相关联的硬状态之间的变化（例如从WARNING到UNKNOWN）。如果服务从错误软状态恢复到正常状态（OK），也称为*软恢复*，管理员将不会收到通知。
- en: Even if the messaging system leaves out soft states and switches back to soft
    states, it will still record such states in the Web interface and in the log files.
    In the Web front end, soft states can be identified by the fact that the value
    **`2/5`** is listed in the column **Attempts**, for example. This means that **`max_check_attempts`**
    expects **`five`** attempts, but only two have been carried out until now. With
    a hard state, **`max_check_attempts`** is listed twice at the corresponding position,
    which in the example is **`5/5`**.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 即使消息系统省略了软状态并切换回软状态，它仍然会在Web界面和日志文件中记录这些状态。在Web前端，可以通过**`2/5`**的值出现在**尝试**列中来识别软状态。这意味着**`max_check_attempts`**期望**`五个`**尝试，但到目前为止只进行了两个。在硬状态下，**`max_check_attempts`**在相应的位置列出两次，在示例中是**`5/5`**。
- en: More important for the administrator in the Web interface than the distinction
    of whether the state is still "soft" or already "hard," is the duration of the
    error state in the column **Duration**. From this a better judgment can be made
    of how large the overall problem may be.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 对于Web界面中的管理员来说，比状态是否仍然是“软”还是已经“硬”的区别更重要的是**持续时间**列中的错误状态持续时间。从这个数据可以更好地判断整体问题可能有多大。
- en: 'For services that are not available because the host is down, the entry 1/5
    in the column **Attempts** would appear, since Nagios does not repeat service
    checks until the entire host is reachable again. The failure of a computer can
    be more easily recognized by its color in the Web interface: the service overview
    figure in [3.3 Overview of the Web Interface](../Text/ch03s03.html "3.3 Overview
    of the Web Interface") marks the failed host in red; if the computer is reachable,
    the background remains gray.'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 对于由于主机故障而不可用的服务，**尝试**列中会出现1/5的条目，因为Nagios不会重复进行服务检查，直到整个主机再次可访问。计算机的故障可以通过Web界面中的颜色更容易地识别：[3.3
    Web界面概述](../Text/ch03s03.html "3.3 Web界面概述")中的服务概览图用红色标记失败的宿主；如果计算机可访问，背景保持灰色。
- en: '* * *'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[43](#CHP-4-FN-3)]) As an alternative, Nagios 3.0 allows the notation known
    from the host definition, **`check_interval`**.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[43](#CHP-4-FN-3)]) 作为一种替代，Nagios 3.0允许使用从主机定义中已知的表示法，**`check_interval`**。
- en: ^([[44](#CHP-4-FN-4)]) For Nagios 3.0 you can alternatively use **`retry_interval`**.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[44](#CHP-4-FN-4)]) 对于Nagios 3.0，你可以使用**`retry_interval`**作为替代。
- en: Chapter 5. Service Checks and How They Are Performed
  id: totrans-53
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第5章。服务检查及其执行方式
- en: To test services, Nagios makes use of external programs called *plugins*. In
    the simplest case this involves testing an Internet service, for example, SMTP.
    Here the service can be addressed directly over the network, so it is sufficient
    to call a program locally on the Nagios server that tests the mail server on the
    remote host.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 为了测试服务，Nagios使用称为*插件*的外部程序。在最简单的情况下，这涉及到测试一个互联网服务，例如SMTP。在这里，服务可以通过网络直接访问，因此只需要在Nagios服务器上调用一个测试远程主机上邮件服务器的本地程序就足够了。
- en: Not everything you might want to test can be reached so easily over the network,
    however; there is no network protocol for checking free capacity on a hard drive,
    for example. Then you must either start a plugin on the remote host via a remote
    shell (but first this has to be installed on the remote computer), or you use
    other methods, such as the *Simple Network Management Protocol (SNMP)*, to test
    the hard drive capacity.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 并非所有你可能想要测试的内容都可以通过网络轻松访问；例如，没有网络协议可以用来检查硬盘的空闲容量。在这种情况下，你必须通过远程shell在远程主机上启动一个插件（但首先这个插件必须安装在远程计算机上），或者使用其他方法，例如*简单网络管理协议（SNMP）*，来测试硬盘容量。
- en: The fact that different methods are available here does not make it any easier
    to get started with Nagios. For this reason, this chapter provides an overview
    of the common methods and attempts to develop an understanding of the underlying
    concepts involved. Later chapters then provide detailed configuration examples.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 这里提供了不同的方法，但这并不使开始使用Nagios变得更容易。因此，本章提供了常见方法的概述，并试图理解涉及的基本概念。随后章节将提供详细的配置示例。
- en: '![Nagios allows different testing methods.](../Images/tagoreillycom20081104nostarchimages223806.png.jpg)'
  id: totrans-57
  prefs: []
  type: TYPE_IMG
  zh: '![Nagios允许不同的测试方法。](../Images/tagoreillycom20081104nostarchimages223806.png.jpg)'
- en: Figure 5-1. Nagios allows different testing methods.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 图5-1. Nagios允许不同的测试方法。
- en: '[Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods "Figure 5-1. Nagios
    allows different testing methods.") shows an overview of the various test methods
    supported by Nagios. The upper box with a gray background marks all the components
    that run directly on the Nagios server machine: this includes the server itself,
    as well as plugins and other auxiliary tools. This unit is in contact with five
    clients, which are tested in various ways. The following sections will go into
    somewhat more detail regarding the individual methods.'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: '[图5-1](../Text/ch05.html#nagios_allows_different_testing_methods "图5-1. Nagios允许不同的测试方法.")展示了Nagios支持的多种测试方法的概述。带有灰色背景的上方框标记了所有直接在Nagios服务器机器上运行的组件：这包括服务器本身，以及插件和其他辅助工具。这个单元与五个客户端接触，以各种方式对这些客户端进行测试。接下来的几节将更详细地介绍个别方法。'
- en: In order to monitor the network service on the first client (starting from the
    left) marked as **`service`**, the Nagios server runs its "own" plugin, **`check_xyz`**
    ([5.1 Testing Network Services Directly](../Text/ch05.html#testing_network_services_directly
    "5.1 Testing Network Services Directly"), page 101). For the second client it
    starts the "middle plugin" **`check_by_ssh`**, in order to execute the plugin
    it really wants remotely on the client ([5.2 Running Plugins via Secure Shell
    on the Remote Computer](../Text/ch05s02.html "5.2 Running Plugins via Secure Shell
    on the Remote Computer"), page 102).
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 为了监控第一个客户端（从左起标记为**`service`**）上的网络服务，Nagios服务器运行其“自己的”插件**`check_xyz`**（[5.1
    Testing Network Services Directly](../Text/ch05.html#testing_network_services_directly
    "5.1 Testing Network Services Directly")，第101页）。对于第二个客户端，它启动“中间插件”**`check_by_ssh`**，以便在远程客户端上远程执行它真正想要的插件（[5.2
    Running Plugins via Secure Shell on the Remote Computer](../Text/ch05s02.html
    "5.2 通过安全外壳在远程计算机上运行插件")，第102页）。
- en: In the third case the plugin is also executed directly on the client machine,
    but now Nagios uses the NRPE service, created specifically for this purpose. The
    query is made on the Nagios side with **`check_nrpe`** ([5.3 The Nagios Remote
    Plugin Executor](../Text/ch05s03.html "5.3 The Nagios Remote Plugin Executor"),
    page 102).
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 在第三种情况下，插件也直接在客户端机器上执行，但现在Nagios使用专门为此目的创建的NRPE服务。查询在Nagios端通过**`check_nrpe`**进行（[5.3
    The Nagios Remote Plugin Executor](../Text/ch05s03.html "5.3 The Nagios Remote
    Plugin Executor")，第102页）。
- en: The fourth method performs a query via SNMP. For this, the client must have
    an SNMP agent available ([11.1 Introduction to SNMP](../Text/ch11.html#introduction_to_snmp
    "11.1 Introduction to SNMP"), page 228). Various plugins are available for querying
    data via SNMP ([5.4 Monitoring via SNMP](../Text/ch05s04.html "5.4 Monitoring
    via SNMP"), page 103).
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 第四种方法通过SNMP进行查询。为此，客户端必须有一个可用的SNMP代理（[11.1 Introduction to SNMP](../Text/ch11.html#introduction_to_snmp
    "11.1 SNMP简介")，第228页）。有各种插件可用于通过SNMP查询数据（[5.4 Monitoring via SNMP](../Text/ch05s04.html
    "5.4 通过SNMP监控")，第103页）。
- en: These four methods represent "active" checks, because Nagios takes the initiative
    and triggers the test itself. The fifth method, in contrast, is passive. Here
    Nagios does nothing actively, but waits for incoming information that the client
    sends to the Nagios server with the program **`send_nsca`**. On the Nagios server
    itself the *Nagios Service Check Acceptor*, NSCA, is running as a daemon that
    accepts the transmitted results and forwards them to the interface for external
    commands (see [5.5 The Nagios Service Check Acceptor](../Text/ch05s05.html "5.5
    The Nagios Service Check Acceptor"), page 104).
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 这四种方法代表“主动”检查，因为Nagios主动采取行动并触发测试。相比之下，第五种方法是“被动”的。在这种情况下，Nagios不会主动采取任何行动，而是等待客户端通过程序**`send_nsca`**发送给Nagios服务器的传入信息。在Nagios服务器本身，*Nagios服务检查接受器*，NSCA，作为一个守护进程运行，接受传输的结果并将它们转发到外部命令的接口（参见[5.5
    The Nagios Service Check Acceptor](../Text/ch05s05.html "5.5 The Nagios Service
    Check Acceptor")，第104页）。
- en: There are other ways of performing checks in addition to these. Usually a separate
    service is installed on the client, which is then queried by the Nagios server
    via a specialized plugin. A typical example here is NSClient/NC_Net, which can
    be used to monitor Windows servers ([20.2.1 NSClient](../Text/ch20s02.html#nsclient
    "20.2.1 NSClient"), page 464).
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 除了这些方法之外，还有其他执行检查的方式。通常，客户端会安装一个独立的服务，然后Nagios服务器通过专门的插件查询该服务。这里的一个典型例子是NSClient/NC_Net，它可以用来监控Windows服务器（[20.2.1
    NSClient](../Text/ch20s02.html#nsclient "20.2.1 NSClient")，第464页）。
- en: 5.1 Testing Network Services Directly
  id: totrans-65
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5.1 直接测试网络服务
- en: Mail or Web servers can be tested very simply over the network, since the underlying
    protocols, SMTP and HTTP, are by definition network-capable ([Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "Figure 5-1. Nagios allows different testing methods."), page 100, Client 1).
    Nagios can call here on a wide range of plugins, each specialized for a particular
    service.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 邮件或Web服务器可以通过网络非常简单地测试，因为底层协议SMTP和HTTP按定义是网络兼容的（[图5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "图5-1. Nagios允许不同的测试方法.")，第100页，客户端1）。Nagios可以调用广泛的插件，每个插件都针对特定的服务进行了专门化。
- en: Such a specific program has advantages over a generic one. A generic plugin
    tests only whether the corresponding TCP or UDP port is open and whether the service
    is waiting there, but it does not determine whether the correct service is on
    the port, or whether it is active.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 这样的特定程序比通用的程序有优势。通用插件只测试相应的TCP或UDP端口是否打开，以及服务是否在那里等待，但它并不确定正确的服务是否在端口上，或者它是否处于活动状态。
- en: 'Specific plugins adopt the network protocol and test whether the service on
    the port in question behaves as it is expected to. A mail server, for example,
    normally responds with a so-called *Greeting* after a connection has been established:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 特定插件采用网络协议，并测试相关端口上的服务是否按预期行为。例如，邮件服务器在建立连接后通常会以所谓的*问候*进行响应：
- en: '[PRE2]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: The important thing here is the number **`220`**. A number in the 200 range
    means OK, 220 stands for the greeting. The **`check_smtp`** plugin evaluates this
    reply. It can also simulate the initial dialog when sending mail (in addition
    to the greeting), as shown in [6.3 Monitoring Mail Servers](../Text/ch06s03.html
    "6.3 Monitoring Mail Servers") in page 113.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 这里重要的是数字 **`220`**。200系列数字表示正常，220代表问候。**`check_smtp`** 插件评估这个回复。它还可以模拟发送邮件时的初始对话（除了问候之外），如[6.3
    监控邮件服务器](../Text/ch06s03.html "6.3 监控邮件服务器")第113页中所示。
- en: It behaves in a similar way with other specific plugins, such as **`check_http`**,
    which not only can handle a simple HTTP dialog, but also manipulates HTTP headers
    where required, checks SSL capabilities and certificates of the Web server, and
    even sends data to the server with the **`POST`** command (more on this in [6.4
    Monitoring FTP and Web Servers](../Text/ch06s04.html "6.4 Monitoring FTP and Web
    Servers") from page 118).
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 它与其他特定插件的行为类似，例如**`check_http`**，它不仅能够处理简单的HTTP对话，而且在需要时还会操作HTTP头，检查Web服务器的SSL功能和证书，甚至可以使用**`POST`**命令向服务器发送数据（更多内容请参阅[6.4
    监控FTP和Web服务器](../Text/ch06s04.html "6.4 监控FTP和Web服务器")，第118页）。
- en: The package with the Nagios plugins, which is installed separately (see [1.4
    Installing and Testing Plugins](../Text/ch01s04.html "1.4 Installing and Testing
    Plugins") from page 43), includes specific plugins for the most important network
    services. If one is missing for a specific service, it is worth taking a look
    at the Nagios homepage^([[45](#ftn.CHP-5-FN-1)]) or the Exchange for Nagios Add-ons.^([[46](#ftn.CHP-5-FN-2)])
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 安装Nagios插件的软件包是单独安装的（请参阅[1.4 安装和测试插件](../Text/ch01s04.html "1.4 安装和测试插件")，第43页），它包括最重要的网络服务的特定插件。如果缺少特定服务的插件，值得查看Nagios主页^([[45](#ftn.CHP-5-FN-1)])或Nagios附加组件交换.^([[46](#ftn.CHP-5-FN-2)])
- en: If no suitable plugin can be found in these locations, you can use the generic
    plugins **`check_tcp`** or **`check_udp`**, which apart from performing a pure
    port test, also send data to the target port and evaluate the response. (In most
    cases, this only makes sense if an ASCII-based protocol is involved.) More on
    generic plugins in [6.7.1 Testing TCP ports](../Text/ch06s09.html#testing_tcp_ports
    "6.7.1 Testing TCP ports") in page 132.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在这些位置找不到合适的插件，可以使用通用插件**`check_tcp`**或**`check_udp`**，除了执行纯端口测试外，它们还会向目标端口发送数据并评估响应。（在大多数情况下，这只有在涉及基于ASCII的协议时才有意义。）更多关于通用插件的内容请参阅[6.7.1
    测试TCP端口](../Text/ch06s09.html#testing_tcp_ports "6.7.1 测试TCP端口")，第132页。
- en: '* * *'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[45](#CHP-5-FN-1)]) [http://www.nagios.org/](http://www.nagios.org/)
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[45](#CHP-5-FN-1)]) [http://www.nagios.org/](http://www.nagios.org/)
- en: ^([[46](#CHP-5-FN-2)]) [http://www.nagiosexchange.org/](http://www.nagiosexchange.org/)
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[46](#CHP-5-FN-2)]) [http://www.nagiosexchange.org/](http://www.nagiosexchange.org/)
- en: 5.2 Running Plugins via Secure Shell on the Remote Computer
  id: totrans-77
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5.2 在远程计算机上通过安全壳运行插件
- en: To test local resources such as hard drive capacity, the load on the swap area,
    the current CPU load, or whether a specific process is running, various *local
    plugins* are available. They are called "local" because they have to be installed
    on the computer that is to be checked.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 要测试本地资源，如硬盘容量、交换区的负载、当前CPU负载或特定进程是否正在运行，有各种**本地插件**可供使用。它们被称为“本地”插件，因为它们必须安装在被检查的计算机上。
- en: The Nagios server has no way to directly access such information over the network,
    without taking further measures. However, it can start local plugins on the remote
    host via a remote shell ([Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "Figure 5-1. Nagios allows different testing methods."), page 100, Client 2).
    Only the *Secure Shell*, SSH, should be considered for use here; the *Remote Shell*,
    RSH, simply has too many security holes.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios服务器无法直接通过网络访问此类信息，除非采取进一步措施。然而，它可以通过远程shell在远程主机上启动本地插件（[图5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "图5-1. Nagios允许不同的测试方法.")，第100页，客户端2）。在这里应仅考虑使用**安全壳**，SSH；**远程壳**，RSH，存在太多的安全漏洞。
- en: To do this, the Nagios server runs the program **`check_by_ssh`**, which is
    given the command, as an argument, to run the local plugin on the target host.
    For this, **`check_by_ssh`** needs a way of logging into the target host without
    a password, which can be set up with *Public Key Authentication*.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 要做到这一点，Nagios服务器运行程序**`check_by_ssh`**，该程序将命令作为参数传递，以在目标主机上运行本地插件。为此，**`check_by_ssh`**需要一种无需密码登录目标主机的方法，这可以通过**公钥认证**来设置。
- en: From the viewpoint of the Nagios server, **`check_by_ssh`** is the plugin whose
    results are processed. It does not notice anything concerning the start of the
    secure shell connection and of the remote plugin—the main thing is that the reply
    corresponds to the Nagios standard and contains the status plus a line of comment
    text for the administrator. (See the introduction to [Chapter 6](../Text/ch06.html
    "Chapter 6. Plugins for Network Services") in page 105.)
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 从Nagios服务器的角度来看，**`check_by_ssh`**是处理其结果的插件。它不会注意到有关安全壳连接和远程插件启动的任何内容——主要的是回复必须符合Nagios标准，并包含状态以及一行供管理员查看的注释文本。（参见第105页[第6章](../Text/ch06.html
    "第6章. 网络服务插件")的介绍。）
- en: Further information on the *Remote Execution* of plugins via Secure Shell is
    provided in [Chapter 9](../Text/ch09.html "Chapter 9. Executing Plugins via SSH")
    in page 205.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 关于通过安全壳执行插件**远程执行**的更多信息，请参阅第205页的[第9章](../Text/ch09.html "第9章. 通过SSH执行插件")。
- en: 5.3 The Nagios Remote Plugin Executor
  id: totrans-83
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5.3 Nagios远程插件执行器
- en: An alternative method of running plugins installed on the target computer via
    the secure shell is represented by the *Nagios Remote Plugin Executor* (NRPE).
    [Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods "Figure 5-1. Nagios
    allows different testing methods.") (page 100) illustrates this with the middle
    client.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 通过安全壳运行目标计算机上安装的插件的另一种方法是**Nagios远程插件执行器**（NRPE）。[图5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "图5-1. Nagios允许不同的测试方法.")（第100页）以中间客户端为例说明了这一点。
- en: The NRPE is installed on the target host and started via the inet daemon, which
    must be configured accordingly. If NRPE receives a query from the Nagios server
    via the (selectable) TCP port 5666, it will run the matching query for this. As
    with the method using the Secure Shell, the plugin that is to perform the test
    must be installed on the target host.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: NRPE安装在目标主机上，并通过inet守护进程启动，必须相应地配置。如果NRPE通过（可选的）TCP端口5666从Nagios服务器接收查询，它将运行相应的查询。与使用安全壳的方法一样，要执行测试的插件必须安装在目标主机上。
- en: So all of this is somewhat more work than using the Secure Shell, especially
    as SSH should be installed on almost every Unix machine, and when it is used,
    enables monitoring to be configured centrally on the Nagios server. The Secure
    Shell method requires an account with a local shell, however, thus enabling any
    command to be run on the target host.^([[47](#ftn.CHP-5-FN-3)]) The Remote Plugin
    Executor, on the other hand, is restricted to the commands configured.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，所有这些与使用安全壳相比都要做更多的工作，尤其是 SSH 应该安装在几乎每一台 Unix 机器上，并且当它被使用时，可以在 Nagios 服务器上集中配置监控。然而，安全壳方法需要一个具有本地壳的账户，从而允许在目标主机上运行任何命令。^([[47](#ftn.CHP-5-FN-3)])
    相反，远程插件执行器仅限于配置的命令。
- en: If you don't want the user **`nagios`** to be able to do anything more than
    run plugins on the target host without a password, than you are better off sticking
    with NRPE. The installation configuration for this is described in [Chapter 10](../Text/ch10.html
    "Chapter 10. The Nagios Remote Plugin Executor (NRPE)") in page 213.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你不想让用户 **`nagios`** 在目标主机上执行任何需要密码的操作，那么坚持使用 NRPE 会更好。该安装配置在[第 10 章](../Text/ch10.html
    "第 10 章. Nagios 远程插件执行器 (NRPE)")中描述，第 213 页。
- en: '* * *'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[47](#CHP-5-FN-3)]) The Secure Shell does allow a single command to be executed
    without opening a separate shell. Usually, however, you will want to test several
    resources, so you'll need to run more than one command.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[47](#CHP-5-FN-3)]) 安全壳允许在不打开单独的壳的情况下执行单个命令。然而，通常你将想要测试多个资源，因此你需要运行多个命令。
- en: 5.4 Monitoring via SNMP
  id: totrans-90
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5.4 通过 SNMP 监控
- en: With the *Simple Network Management Protocol*, SNMP, local resources can be
    queried over the network (see also Client 4 in [Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "Figure 5-1. Nagios allows different testing methods."), page 100). If an SNMP
    daemon is installed (NET-SNMPD is used extensively and is described in [11.2.2
    The NET-SNMP daemon](../Text/ch11s02.html#the_net-snmp_daemon "11.2.2 The NET-SNMP
    daemon") in page 238), Nagios can use it to query local resources such as processes,
    hard drive, and interface load.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 *简单网络管理协议*，即 SNMP，可以通过网络查询本地资源（参见[图 5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "图 5-1. Nagios 允许不同的测试方法"), 第 100 页)中的客户端 4。如果安装了 SNMP 守护进程（广泛使用 NET-SNMPD，并在第
    238 页的[11.2.2 NET-SNMP 守护进程](../Text/ch11s02.html#the_net-snmp_daemon "11.2.2
    NET-SNMP 守护进程")中描述），Nagios 可以使用它来查询本地资源，如进程、硬盘和接口负载。
- en: The advantage of SNMP lies in the fact that it is widely used. There are corresponding
    services for both UNIX and Windows systems, and almost all modern network components
    such as routers and switches can be queried via SNMP. Even uninterruptable power
    supplies (UPSs) and other equipment sometimes have a network connection and can
    provide current status information via SNMP.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP 的优势在于其广泛的应用。UNIX 和 Windows 系统都有相应的服务，几乎所有现代网络组件，如路由器和交换机，都可以通过 SNMP 进行查询。甚至不间断电源（UPS）和其他设备有时也具有网络连接，可以通过
    SNMP 提供当前状态信息。
- en: Apart from the standard plugin **`check_snmp`**, a generic SNMP plugin, there
    are various specialized plugins that concentrate on specific SNMP queries but
    are sometimes more simple to use. **`check_ifstatus`** and **`check_if-operstatus`**,
    for example, focus on the status of network interfaces.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 除了标准的插件 **`check_snmp`**，一个通用的 SNMP 插件，还有各种专门的插件，它们专注于特定的 SNMP 查询，但有时使用起来更简单。例如，**`check_ifstatus`**
    和 **`check_if-operstatus`** 专注于网络接口的状态。
- en: If you are grappling with SNMP for the first time, you will soon come to realize
    that the phrase "human-readable" did not seem to be high on the list of priorities
    when the protocol was defined. SNMP queries are optimized for machine processing,
    such as for a network monitoring tool.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你第一次处理 SNMP，你很快就会意识到，当定义该协议时，“可读性”似乎并不是优先考虑的事项之一。SNMP 查询针对机器处理进行了优化，例如用于网络监控工具。
- en: If you use the tool available from the vendor for its network components, SNMP
    will basically remain hidden to the user. But to use it with Nagios, you have
    to get your hands dirty and get involved with the protocol and its underlying
    syntax. It takes some getting used to, but it's not really as difficult as it
    seems at first sight.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用供应商提供的网络组件工具，SNMP 将基本上对用户隐藏。但为了与 Nagios 一起使用，你必须动手操作，并涉及协议及其底层语法。这需要一些习惯，但事实上并没有看起来那么困难。
- en: The use of SNMP is the subject of [Chapter 11](../Text/ch11.html "Chapter 11. Collecting
    Information Relevant for Monitoring with SNMP") (page 227); there you can learn
    how to configure and use an SNMP daemon for Linux and other UNIX systems.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP的使用是[第11章](../Text/ch11.html "第11章. 使用SNMP收集监控相关信息")（第227页）的主题；在那里你可以学习如何配置和使用Linux和其他UNIX系统的SNMP守护进程。
- en: 5.5 The Nagios Service Check Acceptor
  id: totrans-97
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5.5 Nagios服务检查接受者
- en: The fifth method of processing the results of service checks leads to the use
    of the *Nagios Service Check Acceptor*, NSCA. This runs as a daemon on the Nagios
    server and waits for incoming test results (see [Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "Figure 5-1. Nagios allows different testing methods.") in the right in [Chapter 5](../Text/ch05.html
    "Chapter 5. Service Checks and How They Are Performed")). This method is referred
    to as *passive*, because Nagios itself does not take the initiative.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 处理服务检查结果的方法之一导致了*Nagios服务检查接受者*，NSCA的使用。它作为Nagios服务器上的守护进程运行，等待接收测试结果（参见[图5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "图5-1. Nagios允许不同的测试方法.")，位于[第5章](../Text/ch05.html "第5章. 服务检查及其执行")的右侧）。这种方法被称为*被动*，因为Nagios本身并不主动。
- en: NSCA uses the interface for external commands used by CGI scripts, among others,
    to send commands to Nagios. It consists of a *named pipe*^([[48](#ftn.CHP-5-FN-4)])
    from which Nagios reads the external commands. With the command **`PROCESS_SERVICE_CHECK_RESULT`**
    Nagios processes test results that were determined elsewhere. The interface itself
    is described in more detail in [13.1 The Interface for External Commands](../Text/ch13.html#the_interface_for_external_commands
    "13.1 The Interface for External Commands") in page 292.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: NSCA使用CGI脚本使用的外部命令接口，以及其他接口，向Nagios发送命令。它由一个*命名管道*组成，Nagios从中读取外部命令。使用命令**`PROCESS_SERVICE_CHECK_RESULT`**，Nagios处理在其他地方确定的测试结果。该接口的详细信息在[13.1
    外部命令接口](../Text/ch13.html#the_interface_for_external_commands "13.1 外部命令接口")的第292页有更详细的描述。
- en: The main use for NSCA is *Distributed Monitoring*. By this we mean having several
    different Nagios installations that send their results to a central Nagios server.
    The distributed Nagios servers, perhaps in different branches of a company, work
    as autonomous and independent Nagios instances, except that they also send the
    results to a head office. This does not check the decentralized networks actively,
    but processes the information sent from the branches in a purely passive manner.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: NSCA的主要用途是*分布式监控*。这意味着有多个不同的Nagios安装将它们的结果发送到一个中央Nagios服务器。分布式的Nagios服务器，可能在公司的不同分支，作为自主和独立的Nagios实例运行，除了它们还将结果发送到总部。这并不是积极检查分散的网络，而是以纯粹被动的方式处理来自分支的信息。
- en: NSCA is not just restricted to distributed monitoring, however. With the program
    **`send_nsca`**, test results can be sent which were not obtained from a Nagios
    instance, but rather from a cron job, for example, which executes the desired
    service check.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: NSCA不仅限于分布式监控。使用程序**`send_nsca`**，可以将测试结果发送出去，这些结果并非来自Nagios实例，而是来自例如执行所需服务检查的cron作业。
- en: Before you use NSCA, you should consider the security aspects. Because it can
    be used by external programs to send information and commands to Nagios, there
    is a danger that it could be misused. This should not stop you from using NSCA,
    but rather should motivate you into paying attention to security aspects during
    the NSCA configuration.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用NSCA之前，你应该考虑安全性方面的问题。因为外部程序可以使用它来向Nagios发送信息和命令，所以存在被滥用的风险。这不应该阻止你使用NSCA，而应该激励你在配置NSCA时关注安全性方面。
- en: Further information on using NSCA, distributed monitoring and on security in
    general is provided in [Chapter 14](../Text/ch14.html "Chapter 14. The Nagios
    Service Check Acceptor (NSCA)") in page 299.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 关于使用NSCA、分布式监控以及一般安全性的更多信息，请参阅[第14章](../Text/ch14.html "第14章. Nagios服务检查接受者（NSCA）")的第299页。
- en: '* * *'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[48](#CHP-5-FN-4)]) A named pipe is a buffer to which a process writes something
    and from which another process reads out the data. This buffer is given a name
    in the file system so that it can be specifically addressed, which is why it is
    called *named* pipe.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[48](#CHP-5-FN-4)]) 命名管道是一个缓冲区，一个进程向其中写入数据，另一个进程从中读取数据。这个缓冲区在文件系统中被赋予一个名称，以便可以具体地指向它，这就是为什么它被称为*命名管道*。
- en: Chapter 6. Plugins for Network Services
  id: totrans-106
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第6章 网络服务插件
- en: 'Every plugin that is used for host and service checks is a separate and independent
    program that can also be used independently of Nagios. The other way round, it
    is not so easy: in order for Nagios to use an external program, it must obey certain
    rules. The most important of these concerns the return status that is returned
    by the program. Using this, Nagios precisely evaluates the status. [Table 6-1](../Text/ch06.html#return_values_for_nagios_plugins
    "Table 6-1. Return values for Nagios plugins") displays the possible values.'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 用于主机和服务检查的每个插件都是一个独立且独立的程序，也可以独立于Nagios使用。反过来，就不那么容易了：为了使Nagios使用外部程序，它必须遵守某些规则。其中最重要的是程序返回的返回状态。通过使用它，Nagios可以精确评估状态。[表
    6-1](../Text/ch06.html#return_values_for_nagios_plugins "表 6-1. Nagios 插件的返回值")
    显示了可能值。
- en: Table 6-1. Return values for Nagios plugins
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 表 6-1. Nagios 插件的返回值
- en: '| Status | Name | Description |'
  id: totrans-109
  prefs: []
  type: TYPE_TB
  zh: '| 状态 | 名称 | 描述 |'
- en: '| --- | --- | --- |'
  id: totrans-110
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| 0 | OK | Everything in order |'
  id: totrans-111
  prefs: []
  type: TYPE_TB
  zh: '| 0 | OK | 一切正常 |'
- en: '| 1 | WARNING | Warning limit has been exceeded, but critical limit not yet
    reached |'
  id: totrans-112
  prefs: []
  type: TYPE_TB
  zh: '| 1 | WARNING | 警告限制已超过，但尚未达到临界限制 |'
- en: '| 2 | CRITICAL | Critical limit exceeded or the plugin has broken off the test
    after a timeout |'
  id: totrans-113
  prefs: []
  type: TYPE_TB
  zh: '| 2 | CRITICAL | 超过临界限制或插件在超时后中断了测试 |'
- en: '| 3 | UNKNOWN | Error has occurred inside the plugin (the wrong parameter has
    been used, for example) |'
  id: totrans-114
  prefs: []
  type: TYPE_TB
  zh: '| 3 | UNKNOWN | 插件内部发生错误（例如使用了错误的参数） |'
- en: A plugin therefore does not distinguish by using the pattern "OK—Not OK," but
    instead is more highly differentiated. In order for it to be able to categorize
    a status as WARNING, it requires details of up to what measured value a certain
    event is regarded as OK, when it is seen as a WARNING, and when it is CRITICAL.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，插件不是通过使用“OK—Not OK”的模式来区分的，而是更加细致。为了能够将状态分类为WARNING，它需要知道某个事件在什么测量值以下被视为OK，何时被视为WARNING，以及何时被视为CRITICAL。
- en: For example, apart from the response time, a ping also returns the rate of packet
    loss. For a slow network connection (ISDN, DSL), a response time of 1000 milliseconds
    could be seen as a warning limit and 5000 milliseconds as critical, because that
    would mean that interactive working is no longer possible. If there is a high
    load on the network connection, occasional packet loss could also occur,^([[49](#ftn.CHP-6-FN-1)])
    so that 20 percent packet loss can be specified as a warning limit and 60 percent
    as the critical limit.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，除了响应时间外，ping 还会返回数据包丢失率。对于慢速网络连接（ISDN、DSL），1000毫秒的响应时间可以被视为警告限制，5000毫秒为临界，因为这意味着交互式工作将不再可能。如果网络连接负载高，偶尔也会发生数据包丢失，^([[49](#ftn.CHP-6-FN-1)])
    因此可以将20%的数据包丢失指定为警告限制，60%为临界限制。
- en: In all cases, the administrator decides what values shall serve as warning signs
    or be regarded as critical. Since all services can be individually configured,
    the values for each host may vary, even in the same plugin.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 在所有情况下，管理员决定哪些值应作为警告信号或被视为临界。由于所有服务都可以单独配置，因此每个主机的值可能不同，即使在同一插件中也是如此。
- en: Plugins always have a *timeout*, which is usually ten seconds. This prevents
    the program from waiting endlessly, thus stopping a large number of plugin processes
    from accumulating at the Nagios host. In other ways too, a response time above
    10 seconds makes little sense for many applications, since these interrupt connection
    attempts themselves after a certain time span, which has the same effect as the
    total failure of the corresponding service. Here the administrator can step in
    and explicitly specify a different timeout.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 插件总是有一个 *超时时间*，通常是十秒。这防止程序无限期地等待，从而阻止大量插件进程在Nagios主机上积累。在其他方面，对于许多应用来说，超过10秒的响应时间也几乎没有意义，因为这些应用会在一定时间后中断连接尝试，这具有与相应服务完全失败相同的效果。在这种情况下，管理员可以介入并明确指定不同的超时时间。
- en: 'A further characteristic of all plugins is a text output, which Nagios shows
    in its overview. It is principally intended for the administrator, so it needs
    to be "human-readable." Nagios 2.x processes only the first line, and here the
    output may not exceed 300 characters. Nagios since version 3.0 no longer has this
    restriction. The output may have multiple lines and can be up to 8KB in length
    (see [8.5.1 Multiple-line plugin output](../Text/ch08s05.html#multiple-line_plugin_output
    "8.5.1 Multiple-line plugin output"), page 193). In the Web interface, however,
    Nagios 3.0 also displays only the first line. Simple plugins should therefore
    restrict their output to a single line, the multiple-line output is recommended
    only for special applications such as the **`plugin check_multi`** ([8.5 Summarizing
    Checks with check_multi](../Text/ch08s05.html "8.5 Summarizing Checks with check_multi")
    from page 191). The following form has become established for the text output:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 所有插件的一个进一步特点是文本输出，Nagios 在其概览中显示它。它主要面向管理员，因此需要是“可读的”。Nagios 2.x 只处理第一行，这里的输出可能不超过300个字符。自3.0版本以来，Nagios
    已不再有此限制。输出可以有多个行，长度可达8KB（参见[8.5.1 多行插件输出](../Text/ch08s05.html#multiple-line_plugin_output
    "8.5.1 多行插件输出"，见第193页)）。然而，在Web界面中，Nagios 3.0 也只显示第一行。因此，简单插件应将其输出限制为单行，多行输出仅推荐用于特殊应用，例如**`plugin
    check_multi`** ([8.5 使用check_multi汇总检查](../Text/ch08s05.html "8.5 使用check_multi汇总检查"，见第191页)）。文本输出的以下形式已经确立：
- en: '[PRE3]'
  id: totrans-120
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'In practice, the text output looks like this:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 实际的文本输出看起来像这样：
- en: '[PRE4]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: The above examples are from the plugin **`check_smtp`** and **`check_disk`**,
    respectively. In both cases, the type of check (here **`SMTP`** or **`DISK`**)
    is followed by the status in text form and then the actual information. Not all
    plugins adhere to this recommendation in their output. Sometimes the detail of
    the test type is missing, and sometimes even the status is missing.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 上述示例分别来自**`check_smtp`**和**`check_disk`**插件。在这两种情况下，检查类型（此处为**`SMTP`**或**`DISK`**）后面跟着文本形式的状况，然后是实际信息。并非所有插件都遵循此建议进行输出。有时测试类型的细节缺失，有时甚至状况也缺失。
- en: 'Various plugins also provide performance information, which can be evaluated
    and graphically represented with external programs (see [Chapter 19](../Text/ch19.html
    "Chapter 19. Graphic Display of Performance Data"), page 403):'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 不同的插件也提供性能信息，这些信息可以用外部程序进行评估和图形表示（参见[第19章](../Text/ch19.html "第19章。性能数据的图形显示"，见第403页)）：
- en: '[PRE5]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: As can be seen here from the example of the **`check_icmp`** plugin, the performance
    data follows the text output, separated by the pipe character **`|`**. These data
    do not appear in the Web interface.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 如此可见，从**`check_icmp`**插件的示例中，性能数据遵循文本输出，由管道字符**`|`**分隔。这些数据在Web界面中不会显示。
- en: '**`check_icmp`** here provides two values: the medium reply time, **``*`r`*``****`ta`**
    (*Real Time Answer*), in milliseconds and the packet loss rate, **`pl`**.^([[50](#ftn.CHP-6-FN-2)])
    For each variable, the plugin first displays the measured value (**`97.751`**
    ms and **`0%`**), followed by the warning limit (200 milliseconds or 40 percent)
    and the critical limit (500 milliseconds or 80 percent). The fact that only the
    first value in the **``*`r`*``****`ta`** or **`pl`** list is provided with a scale
    unit is specified by the Developer Guidelines—since the unit of a variable does
    not change, it only needs to be given once.'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_icmp`**在这里提供两个值：中等的回复时间，**``*`r`*``****`ta`** (*Real Time Answer*，实际时间回答)，以毫秒为单位，以及数据包丢失率，**`pl`**.^([[50](#ftn.CHP-6-FN-2)])
    对于每个变量，插件首先显示测量值（**`97.751`**毫秒和**`0%`**），然后是警告限制（200毫秒或40%）和临界限制（500毫秒或80%）。Developer
    Guidelines指定了只有**``*`r`*``****`ta`**或**`pl`**列表中的第一个值提供单位，因为变量的单位不会改变，所以只需要给出一次。'
- en: To keep the installation ([1.4 Installing and Testing Plugins](../Text/ch01s04.html
    "1.4 Installing and Testing Plugins") from page 43) as simple as possible, there
    are no manual pages for the plugins. Each of these programs must maintain an online
    help, which is displayed with the option **`-h`** or **`--help`**. Some plugins
    distinguish here between a short help (**`-h`**) and a long one (**`--help`**);
    it is therefore recommended that you always try **`--help`** as well.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 为了尽可能简化安装过程（[1.4 安装和测试插件](../Text/ch01s04.html "1.4 安装和测试插件"，见第43页）），插件没有提供手册页面。每个程序都必须维护一个在线帮助，可以通过选项**`-h`**或**`--help`**显示。一些插件在这里区分了简短的帮助（**`-h`**）和长帮助（**`--help`**）；因此，建议您始终尝试使用**`--help`**。
- en: This chapter introduces the most important plugins from the basic distribution
    of the **`nagios-plugins`** package, version 1.4.11,^([[51](#ftn.CHP-6-FN-3)])
    which test network services. With their help, the Nagios server queries services
    on other servers. The description is restricted to the functionality that is important
    for normal operation. If you are interested in all the options, we refer you to
    the integrated online help.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 本章介绍了**`nagios-plugins`**包的基本分布中最重要的插件，版本1.4.11，^([[51](#CHP-6-FN-3)]) 用于测试网络服务。借助它们，Nagios服务器查询其他服务器上的服务。描述仅限于对正常操作重要的功能。如果您对所有选项感兴趣，我们建议您参考集成在线帮助。
- en: 6.1 Standard Options
  id: totrans-130
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.1 标准选项
- en: '[Table 6-2](../Text/ch06.html#standard_options_of_plugins "Table 6-2. Standard
    options of plugins") lists the options that are common to all plugins. The options
    in bold type must be known to all plugins. The key words not in bold type can
    be omitted by the programs, but if they are supported at all, they must be used
    in the sense specified.'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: '[表6-2](../Text/ch06.html#standard_options_of_plugins "表6-2. 插件的标准选项")列出了所有插件共有的选项。粗体字体的选项必须为所有插件所知。非粗体字体的关键词可以被程序省略，但如果它们被支持，则必须按照指定的意义使用。'
- en: If an option demands an argument, it is usually separated by spaces in the short
    form, but by equals signs in the long form. But for Perl or shell scripts in particular,
    not all authors adhere to these, so you have no option here but to take a look
    at the corresponding description.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一个选项需要参数，通常在简短形式中通过空格分隔，但在长形式中通过等号分隔。但对于Perl或shell脚本特别地，并非所有作者都遵循这些规则，因此在这里您没有选择，只能查看相应的描述。
- en: Table 6-2. Standard options of plugins
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 表6-2. 插件的标准选项
- en: '| Short form | Long form | Description |'
  id: totrans-134
  prefs: []
  type: TYPE_TB
  zh: '| 简短形式 | 长形式 | 描述 |'
- en: '| --- | --- | --- |'
  id: totrans-135
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| ^([[a](#ftn.CHP-6-TFN-4)]) |'
  id: totrans-136
  prefs: []
  type: TYPE_TB
  zh: '| ^([[a](#ftn.CHP-6-TFN-4)]) |'
- en: '| **`-h`** | **`--help`** | Output of the online help |'
  id: totrans-137
  prefs: []
  type: TYPE_TB
  zh: '| **`-h`** | **`--help`** | 输出在线帮助 |'
- en: '| **`-V`** | **`--version`** | Output of the plugin version |'
  id: totrans-138
  prefs: []
  type: TYPE_TB
  zh: '| **`-V`** | **`--version`** | 输出插件版本 |'
- en: '| **`-v`** | **`--verbose`** | Output of additional information-this option
    may be given multiple times^([[a](../Text/ch06.html#ftn.CHP-6-TFN-4)]) |'
  id: totrans-139
  prefs: []
  type: TYPE_TB
  zh: '| **`-v`** | **`--verbose`** | 输出额外信息——此选项可以多次给出^([[a](../Text/ch06.html#ftn.CHP-6-TFN-4)])
    |'
- en: '| **`-H`** | **`--hostname`** | Host name or IP address of the target |'
  id: totrans-140
  prefs: []
  type: TYPE_TB
  zh: '| **`-H`** | **`--hostname`** | 目标的主机名或IP地址 |'
- en: '| **`-t`** | **`--timeout`** | Timeout in seconds after which the plugin will
    interrupt the operation and return the CRITICAL status |'
  id: totrans-141
  prefs: []
  type: TYPE_TB
  zh: '| **`-t`** | **`--timeout`** | 超时时间（秒），在此时间后插件将中断操作并返回CRITICAL状态 |'
- en: '| **`-w`** | **`--warning`** | Specificies the warning limit value |'
  id: totrans-142
  prefs: []
  type: TYPE_TB
  zh: '| **`-w`** | **`--warning`** | 指定警告限制值 |'
- en: '| **`-c`** | **`--critical`** | Specifies the critical limit value |'
  id: totrans-143
  prefs: []
  type: TYPE_TB
  zh: '| **`-c`** | **`--critical`** | 指定临界限制值 |'
- en: '| **`−4`** | **`--use-ipv4`** | Force IPv4 to be used |'
  id: totrans-144
  prefs: []
  type: TYPE_TB
  zh: '| **`−4`** | **`--use-ipv4`** | 强制使用IPv4 |'
- en: '| **`−6`** | **`--use-ipv6`** | Force IPv6 to be used |'
  id: totrans-145
  prefs: []
  type: TYPE_TB
  zh: '| **`−6`** | **`--use-ipv6`** | 强制使用IPv6 |'
- en: '|'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: ^([[a](#CHP-6-TFN-4)]) Whether this leads to more information depends on the
    individual plugin ...
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[a](#CHP-6-TFN-4)]) 这是否会导致更多信息取决于特定的插件...
- en: '|'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: Thus it is not allowed to use **`-c`**, for example, for anything other than
    specifying a critical limit. How exactly **`-c`** and **-w** are used may, on
    the other hand, vary from plugin to plugin, because sometimes an individual value
    may be required, at other times, multiple values (see also the explanations on
    the plugin **`check_icmp`**), described below.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，不允许使用**`-c`**，例如，用于指定除临界限制以外的任何内容。另一方面，**`-c`**和**-w**的确切使用方法可能因插件而异，因为有时可能需要一个单独的值，而在其他时候，可能需要多个值（也请参阅下面对插件**`check_icmp`**的解释）。
- en: Most plugins also have the options **`−4`** and **`−6`**, which was not necessarily
    the case prior to version 1.4.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数插件也具有**`−4`**和**`−6`**选项，但在版本1.4之前并不一定如此。
- en: '* * *'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[49](#CHP-6-FN-1)]) ICMP packets are not re-sent; a lost packet remains lost.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[49](#CHP-6-FN-1)]) ICMP数据包不会被重发；丢失的数据包将保持丢失。
- en: ^([[50](#CHP-6-FN-2)]) Short for *packet loss*.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[50](#CHP-6-FN-2)]) 短称*数据包丢失*。
- en: ^([[51](#CHP-6-FN-3)]) Versions prior to 1.4 should no longer be used. Some
    parameters have changed, and often performance data output is missing. In addition,
    plugin developers make great efforts to clean up existing errors and to continually
    improve the plugins.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[51](#CHP-6-FN-3)]) 1.4版本之前的版本不应再使用。一些参数已更改，并且通常性能数据输出会缺失。此外，插件开发者付出了巨大的努力来清理现有错误并不断改进插件。
- en: 6.2 Reachability Test with Ping
  id: totrans-155
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.2 使用Ping进行可达性测试
- en: 'The classic reachability test in UNIX systems has always been a ping, which
    sends an ICMP echo request packet and waits for an ICMP echo response packet.
    The Nagios plugin package includes two programs that carry out this ping check:
    **`check_icmp`** and **`check_ping`**. Even though **`check_ping`** is used in
    the standard configuration, you should replace it with the more efficient **`check_icmp`**,
    which has been included since plugin version 1.4.'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: UNIX系统中的经典可达性测试一直是ping，它发送ICMP回显请求数据包并等待ICMP回显响应数据包。Nagios插件包包括两个执行此ping检查的程序：**`check_icmp`**和**`check_ping`**。尽管**`check_ping`**在标准配置中使用，但你应该用更有效的**`check_icmp`**来替换它，该功能自插件版本1.4以来已包含在内。
- en: Whereas **`check_ping`** calls the UNIX program **`/bin/ping`**, which is why
    there are always compatibility problems with the existing **`ping`** version,
    **`check_icmp`** sends ICMP without any external help programs. **`check_icmp`**
    basically works more efficiently, since it does not wait for one second between
    individual packets, as **`ping`** does. In addition it evaluates ICMP error messages
    such as **`ICMP host unreachable`**, while **`check_ping`** discards these. **`check_icmp`**
    is backward-compatible to **`check_ping`**; this makes it easy to do without **`check_ping`**
    entirely and to replace it with **`check_icmp`**.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 而**`check_ping`**调用UNIX程序**`/bin/ping`**，这就是为什么总是与现有的**`ping`**版本存在兼容性问题，**`check_icmp`**则无需任何外部帮助程序发送ICMP。**`check_icmp`**基本上更有效率，因为它不像**`ping`**那样在各个数据包之间等待一秒钟。此外，它还会评估ICMP错误消息，如**`ICMP主机不可达`**，而**`check_ping`**会丢弃这些消息。**`check_icmp`**与**`check_ping`**向后兼容；这使得可以完全不用**`check_ping`**，并用**`check_icmp`**来替换它。
- en: '**`check_icmp`** measures the reply time of the ICMP packets and determines
    the proportion of packets that have been lost. If an error message arrives instead
    of the expected **`ICMP echo reply`**, this is evaluated immediately. Thus Nagios
    breaks off the test if an **`ICMP host unreachable`** message arrives.'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_icmp`**测量ICMP数据包的回复时间并确定丢失的数据包比例。如果收到的是预期的**`ICMP回显应答`**之外的错误消息，则会立即进行评估。因此，如果收到**`ICMP主机不可达`**消息，Nagios会中断测试。'
- en: '**`check_icmp`** has the following options:^([[52](#ftn.CHP-6-FN-5)])'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_icmp`**有以下选项^([[52](#ftn.CHP-6-FN-5)])。'
- en: '**`-H`** **``*`address`*``**'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`地址`*``**'
- en: Without the host name or the IP address of the computer to be tested, **`check_icmp`**
    cannot work. With **`-H`**, multiple **``*`host`*``** entries can be separated,
    using spaces.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 没有要测试的计算机的主机名或IP地址，**`check_icmp`**无法工作。使用**`-H`**，可以使用空格分隔多个**``*`主机`*``**条目。
- en: '**`-w`** **``*`response_time,packet_loss_percent%`*``**'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`response_time,packet_loss_percent%`*``**'
- en: This switch sets the warning limit for a warning. **``*`response time`*``**
    stands here for the desired response time in milliseconds, **``*`packet loss percent`*``**
    stands for the corresponding packet loss as a percentage. If you specify **`-w
    500.0,20%`** the plugin will give a warning either if the response time is at
    least 500.0 milliseconds or if 20 percent or more of ICMP packets are lost.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关设置警告的警告限制。**``*`响应时间`*``**代表所需的响应时间（以毫秒为单位），**``*`丢包百分比`*``**代表相应的丢包百分比。如果你指定**`-w
    500.0,20%`**，则插件会在响应时间至少为500.0毫秒或20%或更多ICMP数据包丢失时发出警告。
- en: '**`-c`** **``*`response_time,packet_loss_percent%`*``**'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`response_time,packet_loss_percent%`*``**'
- en: This switch specifies the critical limit in the same way as **`-w`** defines
    the warning value. The critical limit should always be larger than the warning
    limit.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关以与**`-w`**定义警告值相同的方式指定临界限制。临界限制应始终大于警告限制。
- en: '**`-n`** **``*`packets`*``**'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-n`** **``*`数据包`*``**'
- en: With **``*`packets`*``** you can set the number of packets that **`check_icmp`**
    should use for each test. The default is **`5`** packets.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**``*`数据包`*``**，你可以设置**`check_icmp`**在每次测试中应使用的数据包数量。默认为**`5`**个数据包。
- en: '**`-i`** **``*`packet_interval`*``**'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-i`** **``*`数据包间隔`*``**'
- en: This switch sets the time interval between two single packets that are going
    to the same host. The default is 80 milliseconds. It is specified as a floating
    point (e.g., **`-i 80.000`**).
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关设置发送到同一主机的两个单独数据包之间的时间间隔。默认为80毫秒。它指定为浮点数（例如，**`-i 80.000`**）。
- en: '**`-I`** **``*`target_interval`*``**'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-I`** **``*`目标间隔`*``**'
- en: This switch sets the time interval in which packets are sent to different hosts
    (provided that **`-H`** contains more than one host). The default is **`0`** milliseconds,
    meaning that packets to multiple hosts are sent simultaneously.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关设置向不同主机发送数据包的时间间隔（前提是 **`-H`** 包含多个主机）。默认值为 **`0`** 毫秒，意味着向多个主机发送数据包是同时进行的。
- en: '**`-m`** **``*`number_of_reachable_hosts`*``**'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-m`** **``*`number_of_reachable_hosts`*``**'
- en: 'This switch specifies the number of hosts that must be reachable for the plugin
    to return OK. This option allows a simple cluster check:'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关指定必须可访问的主机数量，插件才能返回 OK。此选项允许简单的集群检查：
- en: '[PRE6]'
  id: totrans-174
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: Of the three hosts specified, **`192.168.1.11`** (printed in bold) is not reachable.
    **`-m 2`** requests only two reachable hosts; therefore, the result is OK. Without
    this detail, the result would be CRITICAL, because one host is not reachable.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 在指定的三个主机中，**`192.168.1.11`**（加粗显示）无法访问。**`-m 2`** 仅请求两个可访问的主机；因此，结果是 OK。如果没有这个细节，结果将是
    CRITICAL，因为有一个主机无法访问。
- en: '**`-l`** **``*`ttl`*``**'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-l`** **``*`ttl`*``**'
- en: A value larger than **`0`** sets the TTL (*Time to Live*) of the IP packet.
    The default is the value **`0`**, which means that the plugin leaves the choice
    of the TTL to the operating system.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 大于 **`0`** 的值设置 IP 数据包的 TTL（生存时间）。默认值是 **`0`**，这意味着插件将 TTL 的选择留给操作系统。
- en: '**`-t`** **``*`timeout`*``**'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``**'
- en: After **``*`timeout`*``** seconds have passed, the plugin interrupts the test
    and returns the CRITICAL status. The default is **`10`** seconds.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 经过 **``*`timeout`*``** 秒后，插件中断测试并返回 CRITICAL 状态。默认值为 **`10`** 秒。
- en: 'Like the program **`/bin/ping`**, **`check_icmp`** must also run with **``*`r`*``****`oot`**
    permissions, which is why the SUID bit is set:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 与程序 **`/bin/ping`** 一样，**`check_icmp`** 也必须以 **``*`r`*``****`oot`** 权限运行，这就是为什么设置了
    SUID 位：
- en: '[PRE7]'
  id: totrans-181
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'As a test, you should execute the plugin on the command line as the user **`nagios`**,
    since Nagios will later execute it under this account:'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 作为测试，您应该在命令行上以用户 **`nagios`** 的身份执行插件，因为 Nagios 将后来以这个账户执行它：
- en: '[PRE8]'
  id: totrans-183
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: '**`check_icmp`** then sends the standard number of five ICMP packets on their
    way. Instead of an OK, it issues a WARNING as soon as the response time, averaged
    over all the packets, is at least 100.0 milliseconds or if 20 percent or more
    are lost—that is, at least one packet in five. For a CRITICAL status, the average
    response time must be at least 200.0 milliseconds, or at least two packets (40
    percent of five) must remain unanswered.'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_icmp`** 然后发送标准数量的五个 ICMP 数据包。如果所有数据包的平均响应时间至少为 100.0 毫秒，或者丢失 20% 或更多——即至少有一个数据包在五个中，它就会立即发出警告。对于
    CRITICAL 状态，平均响应时间必须至少为 200.0 毫秒，或者至少有两个数据包（五个中的 40%）未得到响应。'
- en: 6.2.1 **`check_icmp`** as a Service Check
  id: totrans-185
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.2.1 **`check_icmp`** 作为服务检查
- en: 'In order for **`check_icmp`** to be used as a service check, you need to have
    a suitable command object. The file **`checkcommands.cfg`**, with **`check_ping`**,
    already has one for the ping service. We will just replace the **`check_ping`**
    plugin in it with **`check_icmp`**:'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 为了将 **`check_icmp`** 用作服务检查，您需要一个合适的命令对象。包含 **`check_ping`** 的文件 **`checkcommands.cfg`**
    已经有一个用于 ping 服务。我们只需将其中的 **`check_ping`** 插件替换为 **`check_icmp`**：
- en: '[PRE9]'
  id: totrans-187
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: The macro **`$HOSTADDRESS$`** provides the IP address of the **`address`** parameter
    from the host definition, and with the two freely defined macros **`$ARG1$`**
    and **`$ARG2$`**, parameters can be taken over from the service definition, so
    that warning and critical limits can be set with these.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 宏 **`$HOSTADDRESS$`** 提供了主机定义中 **`address`** 参数的 IP 地址，以及两个自由定义的宏 **`$ARG1$`**
    和 **`$ARG2$**，可以从服务定义中获取参数，因此可以使用这些宏设置警告和临界限制。
- en: 'In the service definition (an extract of it is shown here)^([[53](#ftn.CHP-6-FN-6)])
    for the **`PING`** service, the **`check_command`** entry, in addition to the
    name of the command object to be executed, now needs two arguments, which are
    entered after the command and separated by an exclamation mark:'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **`PING`** 服务的服务定义（此处显示的是其中的一部分）中，除了要执行的命令对象的名称外，现在还需要两个参数，这些参数在命令之后输入，并用感叹号分隔：
- en: '[PRE10]'
  id: totrans-190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: From the definition of the command object, you can see that the first parameter
    (**`100.0,20%`**) defines the warning limit, and the second one (**`500.0,60%`**)
    defines the critical value.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 从命令对象的定义中，您可以看到第一个参数（**`100.0,20%`**）定义了警告限制，第二个参数（**`500.0,60%`**）定义了临界值。
- en: 6.2.2 **`check_icmp`** as a Host Check
  id: totrans-192
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.2.2 **`check_icmp`** 作为主机检查
- en: 'To be able to use the plugin under the name **`check_host`** for host checks,
    a corresponding symbolic link to **`check_icmp`** is set:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 要能够在主机检查中使用名为 **`check_host`** 的插件，需要设置一个指向 **`check_icmp`** 的相应符号链接：
- en: '[PRE11]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'If it is called under its new name, **`check_host`**, the plugin modifies its
    behavior somewhat: it interrupts the test after receiving the first ICMP echo
    reply, because a single reply packet is enough to prove that the host "is alive."
    The same applies if the first response to be returned is an error message such
    as **`ICMP network unreachable`** or **`host unreachable`**—the host is then considered
    to be unreachable.'
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 如果以新名称 **`check_host`** 调用，该插件会稍微修改其行为：在收到第一个 ICMP 回显响应后中断测试，因为单个响应包就足以证明主机“活着”。如果第一个返回的响应是错误消息，例如
    **`ICMP 网络不可达`** 或 **`主机不可达`**，则主机被认为是不可达的。
- en: 'Host checks are defined like every other check. The only difference is that
    this test is specified during the definition of the host object (and not of a
    service object):'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 主机检查的定义与其他检查类似。唯一的区别是，这个测试是在定义主机对象时指定的（而不是服务对象）：
- en: '[PRE12]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'The name used here, **`check-host-alive`**, can be freely defined and can be
    specified separately for each host. The definition of the command itself is made
    in **`checkcommands.cfg`**:'
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 这里使用的名称 **`check-host-alive`** 可以自由定义，并且可以为每个主机单独指定。命令本身的定义是在 **`checkcommands.cfg`**
    中进行的：
- en: '[PRE13]'
  id: totrans-199
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Host checks do not always need to be executed with **`check_icmp`**. You could
    just as well measure the refrigerator temperature or test, with the generic plugins
    for TCP or UDP (**`check_tcp`** and **`check_udp`**; see [6.7.1 Testing TCP ports](../Text/ch06s09.html#testing_tcp_ports
    "6.7.1 Testing TCP ports") from page 132), whether a specific port is open or
    not. The port scanner **`nmap`**, for example, uses TCP port 80 (HTTP).
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 主机检查不总是需要使用 **`check_icmp`** 来执行。你也可以测量冰箱温度或使用 TCP 或 UDP 的通用插件（**`check_tcp`**
    和 **`check_udp`**；参见第 132 页的[6.7.1 测试 TCP 端口](../Text/ch06s09.html#testing_tcp_ports
    "6.7.1 测试 TCP 端口")）来测试特定的端口是否打开。例如，端口扫描器 **`nmap`** 使用 TCP 端口 80（HTTP）。
- en: The disadvantage of such a method lies in the fact that, apart from the host
    itself, another application also needs to run—that is, the Web server. In addition,
    the test of a specific application by no means proves that the computer is no
    longer reachable. A ping has the great advantage that the kernel replies to ICMP
    echo request messages itself, so that no application needs to be running for this.
    You should therefore change from ping to other host check methods only if there
    is a good reason to do so. One example might be a firewall that filters ICMP messages,
    and over which the administrator has no influence, but that does let through HTTP
    queries on TCP port 80.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 这种方法的缺点在于，除了主机本身之外，还需要运行另一个应用程序——即 Web 服务器。此外，对特定应用程序的测试并不能证明计算机不再可访问。ping 的一大优点是内核会自己回复
    ICMP 回显请求消息，因此不需要运行任何应用程序。因此，只有当有充分的理由时，才应该从 ping 转换到其他主机检查方法。一个例子可能是一个防火墙，它会过滤
    ICMP 消息，管理员无法对其产生影响，但允许通过 TCP 端口 80 的 HTTP 查询。
- en: '* * *'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[52](#CHP-6-FN-5)]) The online help **`check_icmp`** -h says that it knows
    some of the options in the long form as well, but these have not been implemented
    as of today.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[52](#CHP-6-FN-5)]) 在线帮助 **`check_icmp`** -h 表示它还知道一些长格式选项，但这些选项至今尚未实现。
- en: ^([[53](#CHP-6-FN-6)]) Like any other object, service definitions can also be
    defined in a file of your choice, from which Nagios loads object definitions.
    For the sake of clarity it is best to choose a descriptive name for the file,
    such as **`services.cfg`**, as in our example in [Simple structure](../Text/ch02.html#simple_structure
    "Simple structure").
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[53](#CHP-6-FN-6)]) 与任何其他对象一样，服务定义也可以定义在你选择的文件中，Nagios 会从这个文件中加载对象定义。为了清晰起见，最好为文件选择一个描述性的名称，例如
    **`services.cfg`**，就像我们在[简单结构](../Text/ch02.html#simple_structure "简单结构")示例中所做的那样。
- en: 6.3 Monitoring Mail Servers
  id: totrans-205
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.3 监控邮件服务器
- en: A number of plugins are also available to monitor mail servers. The mail server
    itself (*Mail Transport Agent* (MTA)) is monitored by **`check_smtp`**, and the
    mail queue on the mail server can be checked with **`check_mailq`**. Since the
    latter test takes place locally, the plugin is described in the next chapter in
    [7.8 Regularly Checking the Status of the Mail Queue](../Text/ch07s08.html "7.8
    Regularly Checking the Status of the Mail Queue") (page 180).
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 许多插件也可用于监控邮件服务器。邮件服务器本身（*邮件传输代理*（MTA））由**`check_smtp`**监控，而邮件服务器上的邮件队列可以通过**`check_mailq`**进行检查。由于后者的测试是在本地进行的，因此该插件将在下一章[7.8
    定期检查邮件队列状态](../Text/ch07s08.html "7.8 定期检查邮件队列状态")（第180页）中描述。
- en: To monitor the *Mail User Agent* (MUA) protocols POP3 and IMAP —including the
    SSL variants, POP3S and IMAPS—the plugin **`check_tcp`** is used. **`check_pop`**
    and so forth are symbolic links to **`check_tcp`**, which determines which protocol
    it should test by means of the name by which it is called, and makes the relevant
    presettings.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 要监控*邮件用户代理*（MUA）协议POP3和IMAP——包括SSL变体POP3S和IMAPS——使用插件**`check_tcp`**。**`check_pop`**等是**`check_tcp`**的符号链接，它通过被调用的名称确定应测试哪种协议，并做出相关预设。
- en: 6.3.1 Monitoring SMTP with **`check_smtp`**
  id: totrans-208
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.3.1 使用**`check_smtp`**监控SMTP
- en: 'The SMTP monitoring plugin **`check_smtp`** has the following options:'
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: SMTP监控插件**`check_smtp`**有以下选项：
- en: '**`-H`** **``*`address`*``** **`/--host=`****``*`address`*``**'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/--host=`****``*`address`*``**'
- en: Details the computer on which the SMTP service should be checked.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 详细说明应检查SMTP服务的计算机。
- en: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
- en: '**``*`port`*``** determines the ports, in case the mail service is not listening
    on the standard port 25\. In this way the mail virus scanner Amavis (usually port
    10024) can be monitored, for example. But this can normally be reached only from
    **`localhost`**.'
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`port`*``**确定端口，如果邮件服务不在标准端口25上监听。例如，可以使用这种方式监控邮件病毒扫描器Amavis（通常端口10024）。但通常只能从**`localhost`**访问。'
- en: '**`-e`** **``*`string`*``** **`/--expect=`****``*`string`*``**'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-e`** **``*`string`*``** **`/--expect=`****``*`string`*``**'
- en: '**``*`string`*``** defines the text which the mail server must provide in the
    very first reply line. The default setting for **``*`string`*``** is **`220`**,
    with which the normal SMTP greeting begins, but there may be servers that have
    different settings. A wrong reply from the service monitored will generate a WARNING.'
  id: totrans-215
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`string`*``**定义了邮件服务器必须在第一行回复中提供的文本。**``*`string`*``**的默认设置是**`220`**，这是正常SMTP问候语开始的地方，但可能有服务器有不同的设置。监控服务的错误回复将生成一个警告。'
- en: '**`-f`** **``*`address`*``** **`/--from=`****``*`address`*``**'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-f`** **``*`address`*``** **`/--from=`****``*`address`*``**'
- en: With **``*`address`*``** you specify a mail address that **`check_smtp`** then
    sends to the server with the "**`MAIL FROM:`**" command. This option is required
    to test a Microsoft Exchange 2000 Server.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**``*`address`*``**指定一个邮件地址，**`check_smtp`**随后将使用“**`MAIL FROM:`**”命令将该地址发送到服务器。此选项是测试Microsoft
    Exchange 2000服务器所必需的。
- en: '**`-C`** **``*`"mail command"`*``** **`/--command=`****``*`"mail command"`*``**'
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`"mail command"`*``** **`/--command=`****``*`"mail command"`*``**'
- en: With **`-C`** you can send individual mail commands to the server, to extend
    the test slightly (see example below).
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**`-C`**可以向服务器发送单个邮件命令，以稍微扩展测试（见以下示例）。
- en: '**`-R`** **``*`"string"`*``** **`/--response=`** **``*`"string"`*``**'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-R`** **``*`"string"`*``** **`/--response=`** **``*`"string"`*``**'
- en: If you send an SMTP command to the server with **`-C`**, you can specify the
    expected reply here instead of **``*`string`*``** (for example, **`250`**). A
    "wrong" reply triggers a WARNING.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您使用**`-C`**向服务器发送SMTP命令，您可以在这里指定预期的回复，而不是**``*`string`*``**（例如，**`250`**）。一个“错误”的回复将触发一个警告。
- en: '**`-S / --starttls`**'
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-S / --starttls`**'
- en: The connection setup during the test uses STARTTLS.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 测试期间建立的连接使用STARTTLS。
- en: '**`-D`** **``*`duration`*``****`/--certificate=`****``*`duration`*``**'
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-D`** **``*`duration`*``****`/--certificate=`****``*`duration`*``**'
- en: The minimum duration in days for which the certificate used for STARTTLS must
    still be valid.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 用于STARTTLS的证书必须仍然有效的最小持续时间（以天为单位）。
- en: '**`-A / --authtype=`****``*`autheutication type`*``**'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-A / --authtype=`****``*`autheutication type`*``**'
- en: The authentication type for the SMTP-Auth procedure. The default is **`none`**
    (no authentication). The only procedure supported until now is **`LOGIN`**, which
    is based on user-password pairs.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: SMTP-Auth过程的认证类型。默认是**`none`**（无认证）。目前唯一支持的过程是**`LOGIN`**，它基于用户密码对。
- en: '**`-U / --authuser=`****``*`user`*``**'
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-U / --authuser=`****``*`user`*``**'
- en: The user name for the SMTP authentication, if **`-A LOGIN`** is used.
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 如果使用 **`-A LOGIN`**，则为SMTP身份验证的用户名。
- en: '**`-P / --authpass=`****``*`password`*``**'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-P / --authpass=`****``*`密码`*``**'
- en: The accompanying password if **`-A LOGIN`** is specified.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 如果指定了 **`-A LOGIN`**，则附带密码。
- en: '**`-w`** **``*`floating_point_dec`*``** **`/--warning=`****``*`floatii2g_point_dec`*``**'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`浮点数秒`*``** **`/--warning=`****``*`浮点数秒`*``**'
- en: If the server takes longer than **``*`floating_point_dec`*``** seconds for the
    answer, **`check_smtp`** issues a WARNING.
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 如果服务器回答所需时间超过 **``*`浮点数秒`*``**，则 **`check_smtp`** 会发出警告。
- en: '**`-c`** **``*`floating_point_dec`*``** **`/--critical=`****``*`floating_point_dec`*``**'
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`浮点数秒`*``** **`/--critical=`****``*`浮点数秒`*``**'
- en: Like **`-w`**, except that **`check_smtp`** issues a CRITICAL after **``*`floating_point_dec`*``**
    seconds.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 与 **`-w`** 类似，但 **`check_smtp`** 在 **``*`浮点数秒`*``** 秒后发出CRITICAL。
- en: 'In the simplest case, you just enter the name or the IP address of the mail
    server:'
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 在最简单的情况下，你只需输入邮件服务器的名称或IP地址：
- en: '[PRE14]'
  id: totrans-237
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: The plugin **`check_smtp`** sends back a **`HELO`** **``*`hostname`*``** after
    receiving the SMTP greeting, which should contain the reply **`250`**.
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
  zh: 在收到SMTP问候后，插件 **`check_smtp`** 会发送一个 **`HELO`** **``*`主机名`*``**，其中应包含回复 **`250`**。
- en: 'The definition of the corresponding command object in this case appears as
    follows:'
  id: totrans-239
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，相应的命令对象定义如下：
- en: '[PRE15]'
  id: totrans-240
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'To check the host object **`linux01`** with this, it requires the following
    service definition:'
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用此选项检查主机对象 **`linux01`**，需要以下服务定义：
- en: '[PRE16]'
  id: totrans-242
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'Using the **`-C`** option, the SMTP dialog can be extended even further, roughly
    until **`RCPT TO`**:'
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 **`-C`** 选项，可以将SMTP对话扩展得更远，大致直到 **`RCPT TO`**：
- en: '[PRE17]'
  id: totrans-244
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Such a test could be used, for example, to check the configuration of the restrictions
    built into the mail server (invalid domains, spam defenses, and more). The example
    checks whether the mail server refuses to accept a mail containing the invalid
    domain **`gna.dot`** (that is, in the **`RCPT TO`**:). The test runs successfully,
    therefore, if the server rejects the mail with **`554`**. What **`check_smtp`**
    does here corresponds to the following mail dialog reproduced by **`telnet`**:'
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，此类测试可以用来检查内置在邮件服务器中的限制配置（无效域名、垃圾邮件防御等）。示例检查邮件服务器是否拒绝接受包含无效域名 **`gna.dot`**（即在
    **`RCPT TO`** 中）的邮件。如果服务器以 **`554`** 的状态拒绝邮件，则测试运行成功。在此处，**`check_smtp`** 所执行的操作对应于以下由
    **`telnet`** 复制的邮件对话：
- en: '[PRE18]'
  id: totrans-246
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: If the mail server did not reject the recipient domain because of the configuration
    error, the reply would no longer contain **`554`** and the plugin would issue
    a WARNING.
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 如果邮件服务器没有因为配置错误而拒绝接收者域名，则回复将不再包含 **`554`**，插件将发出警告。
- en: In general you should remember, when checking restrictions, that the server
    rejects mails only after a **`RCPT TO:`**, depending on the configuration, even
    if the reason for this (a certain client IP address, the server name in **`HELO`**
    or the sender address in **`MAIL FROM:`**) has already occurred before this.
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，在检查限制时，你应该记住，服务器只有在收到 **`RCPT TO:`** 后才会拒绝邮件，即使在此之前（一个特定的客户端IP地址、**`HELO`**
    中的服务器名称或 **`MAIL FROM:`** 中的发送者地址）已经发生了这种情况。
- en: 6.3.2 POP and IMAP
  id: totrans-249
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.3.2 POP和IMAP
- en: 'Four pseudo plugins are available for testing the POP and IMAP protocols: **`check_pop`**,
    **`check_spop`**, **`check_imap`**, and **`check_simap`**. They are called pseudo
    plugins because they are just symbolic links to the plugin **`check_tcp`**. By
    means of the name with which the plugin is called, this determines its intended
    use and correspondingly sets the required parameters, such as the standard port,
    whether something should be sent to the server, the expected response, and how
    the connection should be terminated. The options are the same for all plugins,
    which is why we shall introduce them all together:'
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
  zh: 有四个伪插件可用于测试POP和IMAP协议：**`check_pop`**、**`check_spop`**、**`check_imap`** 和 **`check_simap`**。它们被称为伪插件，因为它们只是对插件
    **`check_tcp`** 的符号链接。通过插件调用的名称，这确定了其预期用途，并相应地设置了所需的参数，例如标准端口、是否应向服务器发送某些内容、预期的响应以及如何终止连接。所有插件都使用相同的选项，因此我们将一起介绍它们：
- en: '**`-H`** **``*`address`*``** **`/--host=`****``*`address`*``**'
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`地址`*``** **`/--host=`****``*`地址`*``**'
- en: This specifies the computer on which POP or IMAP is to be checked.
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了要检查POP或IMAP的计算机。
- en: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`端口`*``** **`/--port=`****``*`端口`*``**'
- en: '**``*`port`*``** specifies an alternative port if the plugin is intended to
    monitor a different port from the standard one: 110 for **`check_pop`**, 995 for
    **`check_spop`**, 143 for **`check_imap`**, and 993 for **`check_simap`** (see
    also **`/etc/services`**).'
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`port`*``**指定一个替代端口，如果插件旨在监视标准端口以外的端口：**`check_pop`**为110，**`check_spop`**为995，**`check_imap`**为143，**`check_simap`**为993（另见**`/etc/services`**）。'
- en: '**`-w`** **``*`floating_point_dec`*``** **`/--warning=`****``*`floating_point_dec`*``**'
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`floating_point_dec`*``** **`/--warning=`****``*`floating_point_dec`*``**'
- en: The placeholder **``*`floating_point_dec`*``** is replaced by the warning limit
    for the response time in seconds, specified as a floating point decimal.
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: 占位符**``*`floating_point_dec`*``**被替换为响应时间的警告限制，以秒为单位，指定为浮点小数。
- en: '**`-c`** **``*`floating_point_dec`*``** **`/--critical=`****``*`floating_point_dec`*``**'
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`floating_point_dec`*``** **`/--critical=`****``*`floating_point_dec`*``**'
- en: This sets the critical limit for the response time in seconds (see **`-w`**).
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 这设置了响应时间的临界限制（秒），（见**`-w`**）。
- en: '**`-s`** **``*`"string"`*``** **`/--send=`****``*`"string"`*``**'
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-s`** **``*`"string"`*``** **`/--send=`****``*`"string"`*``**'
- en: This string is to be sent to the server. In the default setting, none of the
    four plugins uses this option.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 此字符串要发送到服务器。在默认设置下，四个插件都不使用此选项。
- en: '**`-e`** **``*`"string"`*``** **`/--expect=`****``*`"string"`*``**'
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-e`** **``*`"string"`*``** **`/--expect=`****``*`"string"`*``**'
- en: '**``*`string`*``** specifies a text string, which must be contained in the
    response of the server. The default is +**`0K`** for (S) POP and **`* OK`** for
    (S)IMAP. This option may be given multiple times to search for different partial
    strings in the answer.'
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`string`*``**指定一个文本字符串，该字符串必须包含在服务器的响应中。默认情况下，(S) POP为+**`0K`**，(S)IMAP为**`*
    OK`**。此选项可以多次给出，以在答案中搜索不同的部分字符串。'
- en: '**`-E / --escape`**'
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-E / --escape`**'
- en: This switch allows the use of the escape sequences **`\n`**, **`\r`**, **`\t`**,
    or simply **`\`** in the details for **`-s`** and **`-e`**. In all cases **`-E`**
    must be placed in front of the options **`-s`** and **`-e`** on which it is to
    have an influence.
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项允许在**`-s`**和**`-e`**的详细信息中使用转义序列**`\n`**、**`\r`**、**`\t`**或简单地使用**`\`**。在所有情况下，**`-E`**必须放在它要影响的选择**`-s`**和**`-e`**之前。
- en: '**`-A / --all`**'
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-A / --all`**'
- en: If you specify several reply strings with **`-e`**, the plugin with **`-A`**
    will only return OK if all required reply strings were found. Without this option,
    one string out of several sought is enough to trigger a positive acknowledgment.
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你指定了多个回复字符串与**`-e`**，带有**`-A`**的插件只有在找到所有必需的回复字符串时才会返回OK。没有这个选项，多个搜索字符串中只要有一个找到就足以触发积极的确认。
- en: '**`-M`** **``*`return value`*``** **`/ -mismatch=`****``*`return value`*``**'
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-M`** **``*`return value`*``** **`/ -mismatch=`****``*`return value`*``**'
- en: How should the plugin react if a returned string does not match the statement
    in **`-e`**? The default is **`warn`**, which means there is a WARNING. With **`crit`**
    a false return can be assigned as CRITICAL, with **`ok`** as OK.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 如果返回的字符串与**`-e`**中的声明不匹配，插件应该如何反应？默认值为**`warn`**，表示有WARNING。使用**`crit`**可以将错误返回值指定为CRITICAL，使用**`ok`**则为OK。
- en: '**`-q`** **``*`"string"`*``** **`/--quit=`****``*`"string"`*``**'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-q`** **``*`"string"`*``** **`/--quit=`****``*`"string"`*``**'
- en: This is the string with which the service is requested to end the connection.
    For (S)POP this is **`QUIT\r\n`**, for (S)IMAP, **`al L0G0UT\r\n`**.
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 这是请求服务结束连接的字符串。对于(S)POP，这是**`QUIT\r\n`**，对于(S)IMAP，**`al L0G0UT\r\n`**。
- en: '**`-S / --ssl`**'
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-S / --ssl`**'
- en: The connection set up during the test uses SSL/TLS for the connection. If you
    call the plugins **`check_simap`** and **`check_spop`**, this option is set automatically.
    In order for a connection to be established, the server must support SSL/TLS directly
    on the addressed port.
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 测试期间建立的连接使用SSL/TLS进行连接。如果你调用插件**`check_simap`**和**`check_spop`**，此选项会自动设置。为了建立连接，服务器必须在指定的端口上直接支持SSL/TLS。
- en: STARTTLS^([[54](#ftn.CHP-6-FN-7)]) on its own does not support the plugin. With
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 仅凭STARTTLS本身不支持插件。使用
- en: '[PRE19]'
  id: totrans-274
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'you can at least check whether the server provides this method: the plugin
    returns OK if the reply string contains STARTTLS, or WARNING if it doesn''t. But
    this is not really a genuine test of whether STARTTLS really does work properly.'
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 你至少可以检查服务器是否提供此方法：如果回复字符串包含STARTTLS，插件返回OK，如果不包含，则返回WARNING。但这并不是真正测试STARTTLS是否真正正常工作的测试。
- en: '**`-D`** **``*`duration`*``** **`/--certificate=`****``*`duration`*``**'
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-D`** **``*`duration`*``** **`/--certificate=`****``*`duration`*``**'
- en: This switch specifies the number of days the certificate used for STARTTLS will
    remain valid.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关指定用于 STARTTLS 的证书将保持有效的天数。
- en: '**`-r`** **``*`return_value`*``** **`/ -refuse=`****``*`return_value`*``**'
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** **``*`return_value`*``** **`/ -refuse=`****``*`return_value`*``**'
- en: This switch specifies which value the plugin returns if the server rejects the
    TCP connection. The default is **`crit`** (CRITICAL). The value **`ok`** can be
    set in case no POP or IMAP service is available. The third possible value, **`warn`**,
    triggers a WARNING.
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关指定如果服务器拒绝 TCP 连接，插件返回哪个值。默认值为 **`crit`**（严重）。如果没有任何 POP 或 IMAP 服务可用，可以设置
    **`ok`** 值。第三个可能的值，**`warn`**，会触发警告。
- en: '**`-m`** **``*`bytes`*``** **`/--maxbytes=`****``*`bytes`*``**'
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-m`** **``*`bytes`*``** **`/--maxbytes=`****``*`bytes`*``**'
- en: This switch advices the plugin to close the TCP connection when the specified
    data amount (in bytes) has been received.
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关建议插件在接收到指定数据量（以字节为单位）后关闭 TCP 连接。
- en: '**`-d`** **``*`seconds`*``** **`/--delay=`****``*`seconds`*``**'
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-d`** **``*`seconds`*``** **`/--delay=`****``*`seconds`*``**'
- en: This switch waits for the specified time after a string has been sent to the
    server before the answer is searched for the string specified with **`-e`**.
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关在发送字符串到服务器后等待指定时间，然后搜索使用 **`-e`** 指定的字符串。
- en: Of course, all the other options of the generic plugin **`check_tcp`** (described
    in [6.7.1 Testing TCP ports](../Text/ch06s09.html#testing_tcp_ports "6.7.1 Testing
    TCP ports") in page 132) can be used with **`check_pop`**, **`check_spop`**, **`check_imap`**,
    and **`check_simap`**.
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，所有通用插件 **`check_tcp`**（在第 132 页的 [6.7.1 测试 TCP 端口](../Text/ch06s09.html#testing_tcp_ports
    "6.7.1 测试 TCP 端口") 中描述）的其他选项都可以与 **`check_pop`**、**`check_spop`**、**`check_imap`**
    和 **`check_simap`** 一起使用。
- en: 'In the simplest case you just need to give the name of the computer to be tested
    (here: **`mailsrv`**) or the IP address:'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 在最简单的情况下，您只需提供要测试的计算机名称（此处：**`mailsrv`**）或 IP 地址：
- en: '[PRE20]'
  id: totrans-286
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: In each case the plugin provides just one line of output, which has been line-wrapped
    here for layout reasons. The details after the pipe character **`|`** in turn
    involve performance data not shown by the Web interface. The structure of performance
    data and how they are processed are described in more detail in [19.1 Processing
    Plugin Performance Data with Nagios](../Text/ch19.html#processing_plugin_performance_data_with
    "19.1 Processing Plugin Performance Data with Nagios") in page 404.
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 在每种情况下，插件仅提供一行输出，这里为了布局原因进行了换行。管道字符 **`|`** 后面的详细信息涉及 Web 界面未显示的性能数据。性能数据的结构和处理方式在
    [19.1 使用 Nagios 处理插件性能数据](../Text/ch19.html#processing_plugin_performance_data_with
    "19.1 使用 Nagios 处理插件性能数据") 中有更详细的描述，第 404 页。
- en: 'Implemented as a command object, the above **`check_pop`** command looks like
    this:'
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: 作为命令对象实现，上述 **`check_pop`** 命令看起来是这样的：
- en: '[PRE21]'
  id: totrans-289
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'As a service for the machine **`linuxO1`**, it is integrated like this:'
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: 作为对 **`linuxO1`** 机器的服务，它被集成如下：
- en: '[PRE22]'
  id: totrans-291
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: '* * *'
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[54](#CHP-6-FN-7)]) STARTTLS refers to the capacity of a service to set up
    an SSL/TLS-secured connection after a normal connection has been established—for
    example, for POP3, via TCP port 110\. Every service that implements STARTTLS must
    have a suitable command available to do this. With POP3 this is called **`STLS`**
    (see RFC 2595). STARTTLS is used with SMTP, LDAP, IMAP, and POP3, among others,
    but not every server supports this method automatically.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[54](#CHP-6-FN-7)]) STARTTLS 指的是在建立正常连接之后，服务设置 SSL/TLS 加密连接的能力——例如，对于 POP3，通过
    TCP 端口 110。实现 STARTTLS 的每个服务都必须有一个合适的命令来完成此操作。对于 POP3，这被称为 **`STLS`**（见 RFC 2595）。STARTTLS
    与 SMTP、LDAP、IMAP 和 POP3 等一起使用，但并非所有服务器都自动支持此方法。
- en: 6.4 Monitoring FTP and Web Servers
  id: totrans-294
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.4 监控 FTP 和 Web 服务器
- en: 'The Nagios plugin package provides two plugins to monitor the classic Internet
    services FTP and HTTP (including HTTPS): **`check_ftp`** and **`check_ http`**.
    When many users from a network are using Web services, a proxy is usually used
    in addition. To monitor this, you could also use **`check_http`**, but with the
    **`check_squid.pl`** plugin, The Nagios Exchange has a better tool available.'
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios 插件包提供了两个插件来监控经典的互联网服务 FTP 和 HTTP（包括 HTTPS）：**`check_ftp`** 和 **`check_http`**。当网络中的许多用户使用
    Web 服务时，通常会使用代理。为了监控这一点，您也可以使用 **`check_http`**，但与 **`check_squid.pl`** 插件相比，Nagios
    Exchange 有一个更好的工具可用。
- en: 6.4.1 FTP services
  id: totrans-296
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.4.1 FTP 服务
- en: The plugin **`check_ftp`** is, like the plugins for POP and IMAP, a symbolic
    link to the generic plugin **`check_tcp`**, so that it also has the same options.
    They are described in detail in [6.7.1 Testing TCP ports](../Text/ch06s09.html#testing_tcp_ports
    "6.7.1 Testing TCP ports") in page 132.
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 插件 **`check_ftp`** 与 POP 和 IMAP 插件一样，是通用插件 **`check_tcp`** 的符号链接，因此它也有相同的选项。它们在
    132 页的 [6.7.1 测试 TCP 端口](../Text/ch06s09.html#testing_tcp_ports "6.7.1 测试 TCP
    端口") 中详细描述。
- en: 'The generic plugin sets the following parameters if it is called with the name
    **`check_ftp`**:'
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
  zh: 如果使用名称 **`check_ftp`** 调用通用插件，则设置以下参数：
- en: '[PRE23]'
  id: totrans-299
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: It does not send a string to the server, but it expects a reply containing the
    text **`220`**, and it ends the connection to the standard port 21 cleanly with
    **`QUIT\r\n`**.
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 它不会向服务器发送字符串，而是期望包含文本 **`220`** 的回复，并且使用 **`QUIT\r\n`** 清洁地结束到标准端口 21 的连接。
- en: 'On the command line there is, as usual, a one-line reply (with line breaks
    for the printed version) with performance data after the **`|`** character that
    is not shown by the Web interface, (see [19.1 Processing Plugin Performance Data
    with Nagios](../Text/ch19.html#processing_plugin_performance_data_with "19.1 Processing
    Plugin Performance Data with Nagios") from page 404) for an explanation of this:'
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
  zh: 在命令行中，通常有一行回复（对于打印版本，带有换行符），其中包含在 **`|`** 字符后面的性能数据，该数据在 Web 界面中未显示（参见 404 页的
    [19.1 使用 Nagios 处理插件性能数据](../Text/ch19.html#processing_plugin_performance_data_with
    "19.1 使用 Nagios 处理插件性能数据") 以了解此信息）：
- en: '[PRE24]'
  id: totrans-302
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'As a command object, this call appears as follows:'
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
  zh: 作为命令对象，此调用如下所示：
- en: '[PRE25]'
  id: totrans-304
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'A corresponding service definition looks like this:'
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 相应的服务定义看起来如下：
- en: '[PRE26]'
  id: totrans-306
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 6.4.2 Web server control via HTTP
  id: totrans-307
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.4.2 通过 HTTP 控制 Web 服务器
- en: 'The **`check_http`** plugin for HTTP and HTTPS checks contains a large number
    of very useful options, depending on the intended use:'
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: 根据 intended use，HTTP 和 HTTPS 的 **`check_http`** 插件包含大量非常有用的选项：
- en: '**`-H`** **``*`virtual_host`*``** **`/--hostn.ame=`****``*`virtual_host`*``**'
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`virtual_host`*``** **`/--hostn.ame=`****``*`virtual_host`*``**'
- en: 'This switch specifies the virtual host name that the plugin transmits in the
    HTTP header in the **`host:`** field:'
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关指定插件在 HTTP 头部的 **`host:`** 字段中传输的虚拟主机名：
- en: '[PRE27]'
  id: totrans-311
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: If you don't want **`check_http`** to send this, you can use **`-I`** instead.
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您不想 **`check_http`** 发送此信息，可以使用 **`-I`** 代替。
- en: '**`-I`** **``*`ip-address`*``** **`/--IP-address=`****``*`ip-address`*``**'
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-I`** **``*`ip-address`*``** **`/--IP-address=`****``*`ip-address`*``**'
- en: 'Instead of **``*`ip`*``**, the host name or IP address of the target computer
    is given. For systems with several virtual environments, you will land in the
    default environment, and for most Web hosting providers you will then receive
    an error message:'
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
  zh: 而不是 **``*`ip`*``**，给出目标计算机的计算机名或 IP 地址。对于具有多个虚拟环境的系统，您将进入默认环境，对于大多数 Web 托管提供商，您将收到错误消息：
- en: '[PRE28]'
  id: totrans-315
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: '**`-u`** **``*`url_or_path`*``** **`/--url=`****``*`url_or_path`*``**'
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u`** **``*`url_or_path`*``** **`/--url=`****``*`url_or_path`*``**'
- en: 'The argument is the URL to be sent to the Web server. If the design document
    lies on the server to be tested, it is sufficient to enter the directory path,
    starting from the *document root* of the server:'
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: 参数是要发送到 Web 服务器的 URL。如果设计文档位于要测试的服务器上，则只需输入从服务器的 *文档根* 开始的目录路径：
- en: '[PRE29]'
  id: totrans-318
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: If this option is not specified, the plugin asks for the document root**`/`**.
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: 如果未指定此选项，插件将请求文档根**`/`**。
- en: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
  id: totrans-320
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
- en: This is an alternative port specification for HTTP.
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 HTTP 的替代端口指定。
- en: '**`-w`** **``*`floating_point_dec`*``** **`/--warning=`****``*`floati.ng_point_dec`*``**'
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`floating_point_dec`*``** **`/--warning=`****``*`floati.ng_point_dec`*``**'
- en: This is the warning limit for the response time of the Web server in seconds.
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 Web 服务器响应时间的警告限制（以秒为单位）。
- en: '**`-c`** **``*`floating_point_dec`*``** **`/--critical=`****``*`floating_point_dec`*``**'
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`floating_point_dec`*``** **`/--critical=`****``*`floating_point_dec`*``**'
- en: This is the critical limit for the response time of the Web server in seconds.
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 Web 服务器响应时间的临界限制（以秒为单位）。
- en: '**`-t`** **``*`timeout`*``** **`/--timeout=`****``*`timeout`*``**'
  id: totrans-326
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** **`/--timeout=`****``*`timeout`*``**'
- en: After **``*`timeout`*``** seconds have expired, the plugin interrupts the test
    and returns the CRITICAL status. The default is **`10`** seconds.
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **``*`timeout`*``** 秒后过期，插件中断测试并返回 CRITICAL 状态。默认值为 **`10`** 秒。
- en: '**`-L`** **`/--link-url`**'
  id: totrans-328
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-L`** **`/--link-url`**'
- en: This option ensures that the virtual host in the text output appears on the
    Web interface as a link.
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项确保在文本输出中，虚拟主机在 Web 界面中作为链接显示。
- en: '[PRE30]'
  id: totrans-330
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: '**`-a`** **``*`username : password`*``** **`/--authorization=`****``*`username
    : password`*``**'
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-a`** **``*`username : password`*``** **`/--authorization=`****``*`username
    : password`*``**'
- en: If the Web server requires authentication, this option can be used to specify
    a user-password pair. The plugin can only handle *basic authentication*, however;
    *digest authentication* is currently not yet possible.
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
  zh: 如果Web服务器需要身份验证，可以使用此选项指定用户密码对。然而，插件只能处理**基本身份验证**；**摘要身份验证**目前尚不可行。
- en: '**`-f`** **``*`behavior`*``** **`/--onredirect=`****``*`behavior`*``**'
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-f`** **``*`behavior`*``** **`/--onredirect=`****``*`behavior`*``**'
- en: If the Web server sends a redirect as a reply to the requested Web page, the
    **``*`behavior`*``** parameter influences the behavior of the plugin. The values
    **`ok`**, **`warning`**, **`critical`** and **`follow`** are allowed. The default
    is **`ok`**, so the plugin will simply return an OK, without following the redirect.
    The plugin can be made to follow the redirect with **`follow`**. **`warning`**
    and **`critical`** with a redirect return the **`WARNING`** or **`CRITICAL`**
    status.
  id: totrans-334
  prefs: []
  type: TYPE_NORMAL
  zh: 如果Web服务器将重定向作为对请求的Web页面的回复发送，**``*`behavior`*``**参数会影响插件的行为。允许的值有**`ok`**、**`warning`**、**`critical`**和**`follow`**。默认值为**`ok`**，因此插件将简单地返回OK，而不会跟随重定向。可以通过**`follow`**使插件跟随重定向。带有重定向的**`warning`**和**`critical`**返回**`WARNING`**或**`CRITICAL`**状态。
- en: '**`-e`** **``*`"string"`*``** **`/--expect=`****``*`"string"`*``**'
  id: totrans-335
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-e`** **``*`"string"`*``** **`/--expect=`****``*`"string"`*``**'
- en: This is the text that the server response should contain in its first status
    line. If this option is not specified, the plugin expects **`HTTP/1`**. as a **``*`string`*``**.
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
  zh: 这是服务器响应应在其第一行状态中包含的文本。如果未指定此选项，插件期望**`HTTP/1`**作为**``*`*string`*``**。
- en: '**`-s`** **``*`"string"`*``** **`/--string=`****``*`"string"`*``**'
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-s`** **``*`"string"`*``** **`/--string=`****``*`"string"`*``**'
- en: This is the search text that the plugin looks for in the contents of the page
    returned, not in the header.
  id: totrans-338
  prefs: []
  type: TYPE_NORMAL
  zh: 这是在页面返回的内容中插件搜索的搜索文本，而不是在标题中。
- en: '**`-r`** **``*`"regexp"`*``** **`/--regex=`****``*`"regexp"`*``**'
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** **``*`"regexp"`*``** **`/--regex=`****``*`"regexp"`*``**'
- en: This is a regular expression^([[55](#ftn.CHP-6-FN-8)]) for which the plugin
    should search in the page returned.
  id: totrans-340
  prefs: []
  type: TYPE_NORMAL
  zh: 这是插件应在返回的页面中搜索的正则表达式。
- en: '**`-R`** **``*`"regexp"`*``** **`/--eregi=`****``*`"regexp"`*``**'
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-R`** **``*`"regexp"`*``** **`/--eregi=`****``*`"regexp"`*``**'
- en: This switch works like **``*`-r`*``**, except that the plugin now makes no distinction
    between upper and lower case.
  id: totrans-342
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关与**``*`-r`*``**类似，但插件现在不区分大小写。
- en: '**`--invert-regex`**'
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--invert-regex`**'
- en: This inverts the search with **``*`-r`*``** or **`-R`**. The plugin now returns
    CRITICAL instead of OK if there is a match.
  id: totrans-344
  prefs: []
  type: TYPE_NORMAL
  zh: 这将**``*`-r`*``**或**`-R`**的搜索反转。如果匹配，插件现在返回CRITICAL而不是OK。
- en: '**`-l`** **`/--linespan`**'
  id: totrans-345
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-l`** **`/--linespan`**'
- en: Normally the search for regular expressions is restricted to one line with **``*`-r`*``**
    and **`-R`**. If **`−l`** precedes these options, the search pattern can refer
    to text covering multiple lines.
  id: totrans-346
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，正则表达式的搜索限制在一行内，使用**``*`-r`*``**和**`-R`**。如果**`−l`**在这些选项之前，搜索模式可以引用多行文本。
- en: '**`-P`** **``*`string`*``** **`/--post=`****``*`string`*``**'
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-P`** **``*`string`*``** **`/--post=`****``*`string`*``**'
- en: Use this switch for data that you would like to send via a POST command to the
    Web server. The characters in **``*`string`*``** must be encoded in accordance
    with RFC 1738:^([[56](#ftn.CHP-6-FN-9)]) only the letters A to Z (upper and lower
    case), the special characters **`$-_. + !*' ()`**, and the numbers 0 to 9 are
    allowed.
  id: totrans-348
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此开关发送您希望通过POST命令发送到Web服务器的数据。**``*`*string`*``**中的字符必须按照RFC 1738进行编码：仅允许字母A到Z（大小写）、特殊字符**`$-_.
    + !*' ()`**和数字0到9。
- en: To send the text **Übung für Anfänger** ("Exercise For Beginners" in German)
    as a **``*`string`*``**, umlauts and spaces must be encoded before they are sent:**%DCbung%20f%FCr%20Anf%E4nger**.
  id: totrans-349
  prefs: []
  type: TYPE_NORMAL
  zh: 要发送文本**Übung für Anfänger**（德语中的“Exercise For Beginners”），在发送之前必须对重音符号和空格进行编码：**%DCbung%20f%FCr%20Anf%E4nger**。
- en: '**`-T`** **``*`string`*``** **`/ -content-type=`****``*`string`*``**'
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-T`** **``*`string`*``** **`/ -content-type=`****``*`string`*``**'
- en: This specifies the **`content type`** of the header, if you are sending something
    with **`--post`**, for example, to the server. The default is **`application/x-www-form-urlencoded`**.
    A list of all content types is given in the file **`/etc/mime.types`**, and a
    description of the format can be found in RFC2045.^([[57](#ftn.CHP-6-FN-10)])
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了头部的**`内容类型`**，如果您正在使用**`--post`**向服务器发送某些内容。默认为**`application/x-www-form-urlencoded`**。所有内容类型的列表在文件**`/etc/mime.types`**中给出，格式描述可以在RFC2045中找到.^([[57](#ftn.CHP-6-FN-10)])
- en: '**`-m`** **``*`min_bytes:max_bytes`*``** **`/--pagesize=`****``*`min_bytes:max_bytes`*``**'
  id: totrans-352
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-m`** **``*`min_bytes:max_bytes`*``** **`/--pagesize=`****``*`min_bytes:max_bytes`*``**'
- en: 'This parameter defines that the page returned must be at least **``*`min_bytes`*``**
    in size, otherwise the plugin will issue a WARNING. You can optionally use an
    upper limit as well—separated by a colon—to specify the size of the Web page.
    Now **`check_http`** will also give a warning if the page returned is larger than
    **``*`max_bytes`*``**. In the following example, everything is in order if the
    page returned is at least 500 bytes and at most 2000 bytes in size:'
  id: totrans-353
  prefs: []
  type: TYPE_NORMAL
  zh: 此参数定义返回的页面必须至少为**``*`min_bytes`*``**大小，否则插件将发出警告。您还可以使用一个上限（由冒号分隔）来指定网页的大小。现在**`check_http`**如果返回的页面大于**``*`max_bytes`*``**，也会发出警告。在以下示例中，如果返回的页面大小至少为500字节且最多为2000字节，则一切正常：
- en: '[PRE31]'
  id: totrans-354
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: '**`-N`** **`/--no-body`**'
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-N`** **`/--no-body`**'
- en: With this option the plugin does not wait for the server to return the complete
    page contents, but just reads in the header data. To do this it uses the HTTP
    commands **`GET`** or **`POST`**, and not **`HEAD`**.
  id: totrans-356
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此选项，插件不会等待服务器返回完整的页面内容，而是只读取头部数据。为此，它使用HTTP命令**`GET`**或**`POST`**，而不是**`HEAD`**。
- en: '**`-M`** **``*`seconds`*``** **`/--max-age=`****``*`seconds`*``**'
  id: totrans-357
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-M`** **``*`seconds`*``** **`/--max-age=`****``*`seconds`*``**'
- en: If the returned document is older than the date specified in the header (HTTP
    header field **`Date:`**), the plugin will generate a WARNING. Instead of seconds
    (without additional details) you can also use explicit units such as **`5m`**
    (five minutes), **`12h`** (twelve hours), or **`3d`** (three days); combinations
    are not allowed.
  id: totrans-358
  prefs: []
  type: TYPE_NORMAL
  zh: 如果返回的文档早于头部中指定的日期（HTTP头部字段**`Date:`**），则插件将生成警告。除了秒（不包含其他详细信息）之外，您还可以使用显式单位，例如**`5m`**（五分钟）、**`12h`**（十二小时）或**`3d`**（三天）；不允许组合。
- en: '**`-A`** **``*`"string"`*``** **`/--useragent=`****``*`"string"`*``**'
  id: totrans-359
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-A`** **``*`"string"`*``** **`/--useragent=`****``*`"string"`*``**'
- en: This parameter explicitly specifies a user agent in the HTTP header, such as
    **`-A "Lynx/1.12"`** for Lynx version 1.12\. Normally the plugin does not send
    this field.
  id: totrans-360
  prefs: []
  type: TYPE_NORMAL
  zh: 此参数明确指定HTTP头中的用户代理，例如**`-A "Lynx/1.12"`**用于Lynx版本1.12。通常插件不会发送此字段。
- en: '**`-k`** **``*`"string"`*``** **`/--header=`****``*`"string"`*``**'
  id: totrans-361
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-k`** **``*`"string"`*``** **`/--header=`****``*`"string"`*``**'
- en: 'This specifies any HTTP header tags. If several tags are to be specified, they
    must be separated by a semicolon, as in the following example:'
  id: totrans-362
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了任何HTTP头标签。如果需要指定多个标签，它们必须由分号分隔，如下例所示：
- en: '[PRE32]'
  id: totrans-363
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: '**`-S`** **`/--ssl`**'
  id: totrans-364
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-S`** **`/--ssl`**'
- en: 'This forces an SSL connection to be used:'
  id: totrans-365
  prefs: []
  type: TYPE_NORMAL
  zh: 这强制使用SSL连接：
- en: '[PRE33]'
  id: totrans-366
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: The host [www.verisign.com](http://www.verisign.com) allows an SSL connection.
    If this is not the case, the server returns an error and the plugin returns the
    value CRITICAL:^([[58](#ftn.CHP-6-FN-11)])
  id: totrans-367
  prefs: []
  type: TYPE_NORMAL
  zh: 主机[www.verisign.com](http://www.verisign.com)允许SSL连接。如果不是这种情况，服务器将返回错误，插件将返回值CRITICAL:^([[58](#ftn.CHP-6-FN-11)])
- en: '[PRE34]'
  id: totrans-368
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: '**`-C`** **``*`days`*``** **`/--certificate=`****``*`days`*``**'
  id: totrans-369
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`days`*``** **`/--certificate=`****``*`days`*``**'
- en: Tests whether the certificate is at least valid for the given number of days.
    Otherwise a WARNING is issued.
  id: totrans-370
  prefs: []
  type: TYPE_NORMAL
  zh: 测试证书是否至少有效给定天数。否则将发出警告。
- en: '**`−4`** **`/--use-ipv4`**'
  id: totrans-371
  prefs: []
  type: TYPE_NORMAL
  zh: '**`−4`** **`/--use-ipv4`**'
- en: The test is made explicitly over an IPv4 connection.
  id: totrans-372
  prefs: []
  type: TYPE_NORMAL
  zh: 测试是在IPv4连接上明确进行的。
- en: '**`−6`** **`/--use-ipv6`**'
  id: totrans-373
  prefs: []
  type: TYPE_NORMAL
  zh: '**`−6`** **`/--use-ipv6`**'
- en: The test is made explicitly over an IPv6 connection.
  id: totrans-374
  prefs: []
  type: TYPE_NORMAL
  zh: 测试是在IPv6连接上明确进行的。
- en: The definition of a corresponding command object and its use as a service is
    no different from that based on other plugins; [6.4.3 Monitoring Web proxies](../Text/ch06s04.html#monitoring_web_proxies
    "6.4.3 Monitoring Web proxies") shows an example.
  id: totrans-375
  prefs: []
  type: TYPE_NORMAL
  zh: 相应命令对象及其作为服务的定义与基于其他插件的不同；[6.4.3 监控Web代理](../Text/ch06s04.html#monitoring_web_proxies
    "6.4.3 监控Web代理")展示了示例。
- en: 6.4.3 Monitoring Web proxies
  id: totrans-376
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.4.3 监控Web代理
- en: Proxy test with **`check_http`**
  id: totrans-377
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用**`check_http`**进行代理测试
- en: 'A proxy such as Squid can also be tested with **`check_http`**, but this assumes
    that you have some knowledge of how a browser makes contact with the proxy. It
    does this in the form of an HTTP header:'
  id: totrans-378
  prefs: []
  type: TYPE_NORMAL
  zh: 类似于Squid这样的代理也可以用**`check_http`**进行测试，但这假设您对浏览器如何与代理建立联系有一些了解。它是通过以下形式的HTTP头部来做的：
- en: '[PRE35]'
  id: totrans-379
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'The decisive entries are printed in bold type. In contrast to normal Web server
    queries, the browser requests the document from the server via a GET command,
    not by specifying the directory path, but by using the complete URL, including
    the protocol type. In the **`Host:`** field it specifies the host name of the
    Web server that it actually wants to reach. With normal HTTP queries that go directly
    to a Web server (and not via a proxy), the host name of the Web server would be
    written there. This behavior can be reproduced with **`check_http`**:'
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
  zh: 决定性的条目以粗体形式打印。与正常的Web服务器查询相比，浏览器通过GET命令从服务器请求文档，而不是指定目录路径，而是使用包括协议类型在内的完整URL。在**`Host:`**字段中，它指定了它实际上想要到达的Web服务器的名称。对于直接发送到Web服务器（而不是通过代理）的正常HTTP查询，Web服务器的名称将写入那里。此行为可以用**`check_http`**来重现：
- en: '[PRE36]'
  id: totrans-381
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'In order to set the **`Host:`** field in the header, you specify the name of
    a Web server with **-H**. The nonlocal URL is forced by a **`-u`**, and specifying
    **-I** at the same time ensures that the proxy is addressed, and not the Web server
    itself. Finally you need to select the proxy port, and the proxy test is then
    complete. Then **`check_http`** will send the following HTTP header to the proxy:'
  id: totrans-382
  prefs: []
  type: TYPE_NORMAL
  zh: 为了在头部设置**`Host:`**字段，您需要使用**-H**指定Web服务器的名称。非本地URL由**`-u`**强制，同时指定**-I**确保代理被寻址，而不是Web服务器本身。最后，您需要选择代理端口，然后代理测试就完成了。然后**`check_http`**将以下HTTP头部发送到代理：
- en: '[PRE37]'
  id: totrans-383
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: This test does not use any implementation-specific information of the proxy,
    so it should work with every Web proxy.
  id: totrans-384
  prefs: []
  type: TYPE_NORMAL
  zh: 此测试不使用代理的任何特定实现信息，因此它应该与每个Web代理一起工作。
- en: 'The command object is defined as follows:'
  id: totrans-385
  prefs: []
  type: TYPE_NORMAL
  zh: 命令对象定义为如下：
- en: '[PRE38]'
  id: totrans-386
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'The proxy computer **`linuxO1`** is then tested with the following service:'
  id: totrans-387
  prefs: []
  type: TYPE_NORMAL
  zh: 然后使用以下服务测试代理计算机**`linuxO1`**：
- en: '[PRE39]'
  id: totrans-388
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: The parameter **`3128`** ensures that the command object **`check_proxy`** can
    read out the port from **`$ARG1$`**.
  id: totrans-389
  prefs: []
  type: TYPE_NORMAL
  zh: 参数**`3128`**确保命令对象**`check_proxy`**可以从**`$ARG1$`**中读取端口。
- en: Proxy test with **`check_squid`**
  id: totrans-390
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用**`check_squid`**进行代理测试
- en: The proxy check with **`check_http`**, introduced in the last section, works
    only if the desired Web page is available or is already in the cache. If neither
    is the case, this test will produce an error, even if the proxy is working in
    principle.
  id: totrans-391
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一节中介绍的**`check_http`**代理检查仅在所需Web页面可用或已存在于缓存中时才有效。如果这两种情况都不成立，此测试将产生错误，即使代理在原则上正在工作。
- en: The plugin **`check_squid.pl`** uses a different method, but it is not part
    of the standard installation, and is to be found in the **Check Plugins** category,
    under **Software | HTTP & FTP | Squid Proxy**.^([[59](#ftn.CHP-6-FN-12)])
  id: totrans-392
  prefs: []
  type: TYPE_NORMAL
  zh: 插件**`check_squid.pl`**使用不同的方法，但它不是标准安装的一部分，可以在**检查插件**类别下找到，在**软件 | HTTP & FTP
    | Squid代理**下.^([[59](#ftn.CHP-6-FN-12)])
- en: It makes use of the *cache manager* of the Squid proxy, which is queried by
    a pseudo protocol. A command is sent in the form
  id: totrans-393
  prefs: []
  type: TYPE_NORMAL
  zh: 它利用Squid代理的**缓存管理器**，该管理器通过伪协议进行查询。命令以以下形式发送
- en: '[PRE40]'
  id: totrans-394
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: 'to Squid and obtains the desired information. The plugin **`check_squid.pl`**
    uses the **`info`** command, which queries a range of statistical usage information:'
  id: totrans-395
  prefs: []
  type: TYPE_NORMAL
  zh: 向Squid发送并获取所需信息。插件**`check_squid.pl`**使用**`info`**命令，该命令查询一系列统计使用信息：
- en: '[PRE41]'
  id: totrans-396
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: It is targeted at the number of still-free file descriptors (the third line
    from the end); you can set a warning or critical limit for this value. The number
    of file descriptors plays a role when access is made to objects in the Squid cache
    at the same time. In environments with a high number of parallel accesses to the
    proxy, it is quite possible that 1024 file descriptors are insufficient. In smaller
    networks with just a few hundred users, not all of whom are surfing at the same
    time, the compiled-in value of 1024 will be sufficient.
  id: totrans-397
  prefs: []
  type: TYPE_NORMAL
  zh: 它针对的是仍然空闲的文件描述符数量（从末尾起的第三行）；您可以为此值设置警告或临界限制。文件描述符的数量在同时访问Squid缓存中的对象时发挥作用。在具有大量并行访问代理的环境下，1024个文件描述符可能不足。在只有几百个用户的小型网络中，并非所有用户都在同一时间上网，编译的1024值将足够。
- en: '`Squid configuration` Normally Squid allows access to the cache manager only
    from **`localhost`**. So that Nagios can query it over the network, the proxy
    must be reconfigured accordingly:'
  id: totrans-398
  prefs: []
  type: TYPE_NORMAL
  zh: '`Squid配置` 通常Squid只允许从**`localhost`**访问缓存管理器。为了使Nagios可以通过网络查询它，代理必须相应地重新配置：'
- en: '[PRE42]'
  id: totrans-399
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: The necessary changes to the configuration file **`squid.conf`** are printed
    in bold type, and the other relevant lines are already contained in the default
    file. The first line to be printed defines an access control list (*Access Control
    List*, **`acl`**) called **`manager`** by means of the internal protocol **`cache_object`**,
    so it refers to everything that accesses the proxy using the **`cache_object`**
    protocol. This is followed by an access control list for the Nagios server, based
    on its IP address, here **`192.168.1.9`**. The list name **`nagiosserver`** may
    be freely chosen here (as can **`manager`** in the first line). With **`http_access
    allow`**, **`nagiosserver`** obtains access to the cache manager (**`manager`**),
    before the line
  id: totrans-400
  prefs: []
  type: TYPE_NORMAL
  zh: 配置文件**`squid.conf`**中必要的更改以粗体形式打印，其他相关行已包含在默认文件中。要打印的第一行定义了一个通过内部协议**`cache_object`**的访问控制列表（*访问控制列表*，**`acl`**）名为**`manager`**，因此它指的是使用**`cache_object`**协议访问代理的所有内容。接下来是一个基于Nagios服务器IP地址的访问控制列表，这里为**`192.168.1.9`**。列表名称**`nagiosserver`**可以在这里自由选择（第一行中的**`manager`**也可以自由选择）。通过**`http_access
    allow`**，**`nagiosserver`**在行之前获得对缓存管理器（**`manager`**）的访问权限。
- en: '[PRE43]'
  id: totrans-401
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'prohibits access to all others through the **`cache_object`** protocol. Finally,
    **`cachemgr_passwd`** provides a password for the cache manager access. If you
    omit this, with none, then only selected commands should be allowed that have
    no potential to change things, such as **`info`** and **`menu`**, which shows
    all the things that the cache manager can do. After the configuration file has
    been modified, Squid needs to read it in again:'
  id: totrans-402
  prefs: []
  type: TYPE_NORMAL
  zh: 通过**`cache_object`**协议禁止所有其他访问。最后，**`cachemgr_passwd`**为缓存管理器访问提供密码。如果您省略此选项，则没有密码，则应仅允许执行没有潜在更改事物的选定命令，例如**`info`**和**`menu`**，后者显示缓存管理器可以执行的所有操作。修改配置文件后，Squid需要重新读取它：
- en: '[PRE44]'
  id: totrans-403
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: '`Applying the plugin` The test plugin **`check_squid.pl`** itself has the following
    options:'
  id: totrans-404
  prefs: []
  type: TYPE_NORMAL
  zh: '`应用插件` 测试插件**`check_squid.pl`**本身有以下选项：'
- en: '**`-H`** **``*`address`*``** **`/--hostname=`****``*`address`*``**'
  id: totrans-405
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/--hostname=`****``*`address`*``**'
- en: This is the server on which Squid is to be tested, specified by IP address or
    FQDN.
  id: totrans-406
  prefs: []
  type: TYPE_NORMAL
  zh: 这是Squid要测试的服务器，通过IP地址或FQDN指定。
- en: '**`-P`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-407
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-P`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: This specifies the port on which Squid is listening. The default is the standard
    port 3128.
  id: totrans-408
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了Squid监听的端口号。默认值为标准端口3128。
- en: '**`-p`** **``*`password`*``** **`/ --password=`****``*`password`*``**'
  id: totrans-409
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`password`*``** **`/ --password=`****``*`password`*``**'
- en: This is the password for access to the cache manager.
  id: totrans-410
  prefs: []
  type: TYPE_NORMAL
  zh: 这是访问缓存管理器的密码。
- en: '**`-w`** **``*`free_descriptors`*``** **`/ --warning=`****``*`free_descriptors`*``**'
  id: totrans-411
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`free_descriptors`*``** **`/ --warning=`****``*`free_descriptors`*``**'
- en: This is the number of free file descriptors, where the plugin will issue a warning
    if the number drops below this. The default is 200.
  id: totrans-412
  prefs: []
  type: TYPE_NORMAL
  zh: 这是插件将发出警告的空闲文件描述符数量。默认值为200。
- en: '**`-c`** **``*`free_descriptors`*``** **`/ --critical=`****``*`free_descriptors`*``**'
  id: totrans-413
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`free_descriptors`*``** **`/ --critical=`****``*`free_descriptors`*``**'
- en: This is the critical limit for free file descriptors. If the number falls below
    this, **`check_squid`** returns CRITICAL. The default is 50.
  id: totrans-414
  prefs: []
  type: TYPE_NORMAL
  zh: 这是空闲文件描述符的临界限制。如果数量低于此值，**`check_squid`**返回CRITICAL。默认值为50。
- en: 'When **`check_squid`** is run, it is usually very unspectacular:'
  id: totrans-415
  prefs: []
  type: TYPE_NORMAL
  zh: 当运行**`check_squid`**时，通常非常不起眼：
- en: '[PRE45]'
  id: totrans-416
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: The matching command also presents no problems ...
  id: totrans-417
  prefs: []
  type: TYPE_NORMAL
  zh: 相应的命令也没有问题 ...
- en: '[PRE46]'
  id: totrans-418
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: '... and the same goes for service definitions:'
  id: totrans-419
  prefs: []
  type: TYPE_NORMAL
  zh: '... 对于服务定义也是如此：'
- en: '[PRE47]'
  id: totrans-420
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: '* * *'
  id: totrans-421
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[55](#CHP-6-FN-8)]) Posix regular expressions, see **`man 7 regex`**.
  id: totrans-422
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[55](#CHP-6-FN-8)]) Posix正则表达式，请参阅**`man 7 regex`**。
- en: ^([[56](#CHP-6-FN-9)]) [http://www.faqs.org/rfcs/rfcl738.html](http://www.faqs.org/rfcs/rfcl738.html),
    paragraph 2.2
  id: totrans-423
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[56](#CHP-6-FN-9)]) [http://www.faqs.org/rfcs/rfcl738.html](http://www.faqs.org/rfcs/rfcl738.html)，第2.2段
- en: ^([[57](#CHP-6-FN-10)]) [http://tools.ietf.org/html/rfc2045#section-5](http://tools.ietf.org/html/rfc2045#section-5)
  id: totrans-424
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[57](#CHP-6-FN-10)]) [http://tools.ietf.org/html/rfc2045#section-5](http://tools.ietf.org/html/rfc2045#section-5)
- en: ^([[58](#CHP-6-FN-11)]) This can be checked in the shell with **`echo $?`**.
  id: totrans-425
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[58](#CHP-6-FN-11)]) 这可以在shell中通过**`echo $?`**进行检查。
- en: ^([[59](#CHP-6-FN-12)]) [http://www.nagiosexchange.org/cgi-bin/pages/Detailed/1764.html](http://www.nagiosexchange.org/cgi-bin/pages/Detailed/1764.html)
  id: totrans-426
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[59](#CHP-6-FN-12)]) [http://www.nagiosexchange.org/cgi-bin/pages/Detailed/1764.html](http://www.nagiosexchange.org/cgi-bin/pages/Detailed/1764.html)
- en: 6.5 Domain Name Server Under Control
  id: totrans-427
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.5 控制域名服务器
- en: Two plugins are also available for testing the *Domain Name Service (DNS):*
    **`check_dns`** and **`check_dig`**. While **`check_dns`** tests whether a host
    name can be resolved, using the external **`nslookup`** program, **`check_dig`**
    allows any records at all to be queried. Both plugins are part of the standard
    distribution.
  id: totrans-428
  prefs: []
  type: TYPE_NORMAL
  zh: 还提供了两个插件用于测试 *域名服务 (DNS)*：**`check_dns`** 和 **`check_dig`**。虽然 **`check_dns`**
    通过使用外部 **`nslookup`** 程序测试主机名是否可以解析，但 **`check_dig`** 允许查询所有记录。这两个插件都是标准分发的一部分。
- en: The situations in which they are used overlap somewhat. With **`check_dns`**,
    you can also explicitly query a specific DNS server, although this plugin is really
    for checking whether the name service is available generally.
  id: totrans-429
  prefs: []
  type: TYPE_NORMAL
  zh: 它们被使用的场景有所重叠。使用 **`check_dns`**，你也可以显式查询特定的 DNS 服务器，尽管这个插件实际上是用于检查名称服务是否通常可用。
- en: 6.5.1 DNS check with **`nslookup`**
  id: totrans-430
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.5.1 使用 **`nslookup`** 进行 DNS 检查
- en: The **`check_dns`** plugin checks whether a specified host name can be resolved
    to an IP address. Used locally, the plugin tests the DNS configuration of the
    computer on which it is run. For the name resolution, it uses the name server
    configured in **`/etc/resolv.conf`**.
  id: totrans-431
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_dns`** 插件检查指定的主机名是否可以解析为 IP 地址。在本地使用时，该插件测试运行它的计算机上的 DNS 配置。对于名称解析，它使用
    **`/etc/resolv.conf`** 中配置的名称服务器。'
- en: The possible options are just as unspectacular.
  id: totrans-432
  prefs: []
  type: TYPE_NORMAL
  zh: 可能的选项同样不起眼。
- en: '**`-H`** **``*`host`*``** **`/ --hostname=`****``*`host`*``**'
  id: totrans-433
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`主机`*``** **`/ --hostname=`****``*`主机`*``**'
- en: This is the host name to be resolved to an IP address.
  id: totrans-434
  prefs: []
  type: TYPE_NORMAL
  zh: 这是需要解析为 IP 地址的主机名。
- en: '**`-s`** **``*`dns-server`*``** **`/ --server=`****``*`dns-server`*``**'
  id: totrans-435
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-s`** **``*`DNS 服务器`*``** **`/ --server=`****``*`DNS 服务器`*``**'
- en: This switch explicitly specifies the name server to be used. If this option
    is missing, **`check_dns`** uses the name server from **`/etc/resolv.conf`**.
  id: totrans-436
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项明确指定要使用的名称服务器。如果此选项缺失，**`check_dns`** 将使用 **`/etc/resolv.conf`** 中的名称服务器。
- en: '**`-a`** **``*`ip_address`*``** **`/ --expected-address=`****``*`ip_address`*``**'
  id: totrans-437
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-a`** **``*`IP 地址`*``** **`/ --expected-address=`****``*`IP 地址`*``**'
- en: The **``*`ip_address`*``** is the IP address that **``*`host`*``** should have.
    If the name service returns a different address, the plugin will raise the alarm
    with CRITICAL. This option makes sense only if it is necessary for the name server
    to provide a fixed IP address. Without this option, the plugin will accept every
    IP address as a reply.
  id: totrans-438
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`IP 地址`*``** 是 **``*`主机`*``** 应该有的 IP 地址。如果名称服务返回不同的地址，插件将使用 CRITICAL
    状态发出警报。此选项仅在需要名称服务器提供固定 IP 地址时才有意义。没有此选项，插件将接受所有 IP 地址作为回复。'
- en: '**`-A / --expect-authority`**'
  id: totrans-439
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-A / --expect-authority`**'
- en: The name server specified with **`-s`** should answer the given query authoritatively,
    so the corresponding domain must act as a primary or secondary name server. If
    this is not the case, the plugin returns CRITICAL.
  id: totrans-440
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 **`-s`** 指定的名称服务器应该能够权威地回答给定的查询，因此相应的域名必须充当主域名服务器或辅助域名服务器。如果不是这种情况，插件将返回
    CRITICAL 状态。
- en: '**`-w`** **``*`floating point`*``** **`/ - warning=`****``*`floating point`*``**'
  id: totrans-441
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`浮点数`*``** **`/ - 警告=`****``*`浮点数`*``**'
- en: This switch specifies the warning limit for the response time of the name server
    in seconds (specified as a floating point).
  id: totrans-442
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项指定名称服务器响应时间的警告限制（以秒为单位，指定为浮点数）。
- en: '**`-c`** **``*`floating point`*``** **`/ - critical=`****``*`floating point`*``**'
  id: totrans-443
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`浮点数`*``** **`/ - 临界=`****``*`浮点数`*``**'
- en: This switch gives the critical response time of name server in seconds, specified
    as a floating point.
  id: totrans-444
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项以秒为单位指定名称服务器的临界响应时间，指定为浮点数。
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  id: totrans-445
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`超时`*``** **`/ --timeout=`****``*`超时`*``**'
- en: After **``*`timeout`*``** seconds have expired, the plugin interrupts the test
    and returns the CRITICAL state. The default is **`10`** seconds.
  id: totrans-446
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **``*`超时`*``** 秒后，插件中断测试并返回 CRITICAL 状态。默认值为 **`10`** 秒。
- en: 'For the local test of the DNS configuration (not that for a name server) you
    just require a host name that is highly unlikely to disappear from the DNS, such
    as [www.google.com](http://www.google.com):'
  id: totrans-447
  prefs: []
  type: TYPE_NORMAL
  zh: 对于本地 DNS 配置测试（不是名称服务器），你只需要一个不太可能从 DNS 中消失的主机名，例如 [www.google.com](http://www.google.com)：
- en: '[PRE48]'
  id: totrans-448
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'The corresponding command definition appears as follows in this case:'
  id: totrans-449
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，相应的命令定义如下：
- en: '[PRE49]'
  id: totrans-450
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'The following service tests whether the name server configuration for the computer
    **`linux01`** is functioning:'
  id: totrans-451
  prefs: []
  type: TYPE_NORMAL
  zh: 以下服务测试计算机 **`linux01`** 的域名服务器配置是否正常工作：
- en: '[PRE50]'
  id: totrans-452
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: 6.5.2 Monitoring the name server with **`dig`**
  id: totrans-453
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.5.2 使用 **`dig`** 监控域名服务器
- en: The plugin **`check_dig`** provides more options for monitoring a name server
    than **`check_dns`**. As the name implies, it is based on the external utility
    **`dig`**, intended for precisely this purpose.
  id: totrans-454
  prefs: []
  type: TYPE_NORMAL
  zh: 插件 **`check_dig`** 为监控域名服务器提供了比 **`check_dns`** 更多的选项。正如其名所示，它基于外部实用程序 **`dig`**，旨在实现这一目的。
- en: '**`-H`** **``*`address`*``** / **`--hostname=`****``*`address`*``**'
  id: totrans-455
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** / **`--hostname=`****``*`address`*``**'
- en: The **``*`address`*``** is the IP address for the DNS server to be tested. It
    is also possible to specify a host name (instead of an IP address), but in most
    cases this makes little sense, because this would first have to be resolved before
    it can reach the name server.
  id: totrans-456
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`address`*``** 是要测试的 DNS 服务器的 IP 地址。也可以指定一个主机名（而不是 IP 地址），但在大多数情况下这几乎没有意义，因为这首先必须解析，然后才能到达域名服务器。'
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-457
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: This switch specifies the UDP port to be used. The default is **`53`**.
  id: totrans-458
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关指定要使用的 UDP 端口。默认值为 **`53`**。
- en: '**`−1`** **``*`hostname`*``** **`/ --lookup=`** **``*`hostuame`*``**'
  id: totrans-459
  prefs: []
  type: TYPE_NORMAL
  zh: '**`−1`** **``*`hostname`*``** **`/ --lookup=`** **``*`hostuame`*``**'
- en: The **``*`hostname`*``** is the host name to be tested. If no particular computer
    is looked up, but only the functionality of the DNS server is to be tested, you
    should specify an address here easily reachable from the Internet, such as [www.google.com](http://www.google.com).
  id: totrans-460
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`hostname`*``** 是要测试的主机名。如果未查找特定计算机，而是仅测试 DNS 服务器的功能，则应在此处指定一个易于从互联网访问的地址，例如
    [www.google.com](http://www.google.com)。'
- en: '**`-T`** **``*`record_type`*``** **`/ --record_type=`****``*`record_type`*``**'
  id: totrans-461
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-T`** **``*`record_type`*``** **`/ --record_type=`****``*`record_type`*``**'
- en: This switch specifies the record type to be queried. The default is **`A`**
    (IPv4 address), but often **`NS`** (relevant name server), **`MX`** (relevant
    *Mail Exchange*), **`PTR`**(*Pointer*; IP address for reverse lookup), or **`S0A`**(*Source
    of Authority*, the administration details of the domain) are also used.
  id: totrans-462
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关指定要查询的记录类型。默认为 **`A`**（IPv4 地址），但通常也使用 **`NS`**（相关域名服务器）、**`MX`**（相关 *邮件交换*）、**`PTR`**（*指针*；反向查找的
    IP 地址）或 **`S0A`**（*授权源*，域的管理细节）。
- en: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
  id: totrans-463
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
- en: This switch sets the warning limit for the response time of the name server
    in seconds (floating point decimal).
  id: totrans-464
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关设置域名服务器响应时间的警告限制（以秒为单位，浮点十进制）。
- en: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
  id: totrans-465
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
- en: This switch sets the critical response time of the name server in seconds (floating
    point decimal).
  id: totrans-466
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关设置域名服务器在秒（浮点十进制）内的关键响应时间。
- en: '**`-a`** **``*`address`*``** **`/ --expected_address=`****``*`address`*``**'
  id: totrans-467
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-a`** **``*`address`*``** **`/ --expected_address=`****``*`address`*``**'
- en: This is the address that **`dig`** should return in the *ANSWER SECTION*. In
    contrast to **`check_dns, check_dig`** delivers a WARNING only if the IP address
    does not match, but the reply itself has arrived within the given time limit.
  id: totrans-468
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 **`dig`** 应在 *ANSWER SECTION* 中返回的地址。与 **`check_dns, check_dig`** 不同，只有当
    IP 地址不匹配时，**`check_dig`** 才会发出警告，但回复本身已在该给定时间限制内到达。
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  id: totrans-469
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
- en: After **``*`timeout`*``** seconds have expired, the plugin breaks off the test
    and returns the CRITICAL state. The default is **`10`** seconds.
  id: totrans-470
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **``*`timeout`*``** 秒后过期，插件中断测试并返回 CRITICAL 状态。默认值为 **`10`** 秒。
- en: 'The following two examples check the name server **`194.25.2.129`**, by requesting
    it for the IP address of the computer [www.swobspace.de](http://www.swobspace.de.)
    The second example ends with a WARNING, since the reply of the name server for
    [www.swobspace.de](http://www.swobspace.de) returns a different IP address from
    **`1.2.3.4`** in the **`ANSWER SECTION`**:'
  id: totrans-471
  prefs: []
  type: TYPE_NORMAL
  zh: 以下两个示例检查域名服务器 **`194.25.2.129`**，通过请求其计算机 [www.swobspace.de](http://www.swobspace.de)
    的 IP 地址。第二个示例以警告结束，因为域名服务器对 [www.swobspace.de](http://www.swobspace.de) 的回复返回了与
    **`ANSWER SECTION`** 中的 **`1.2.3.4`** 不同的 IP 地址：
- en: '[PRE51]'
  id: totrans-472
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: 'Example 1 is implemented as a command object as follows:'
  id: totrans-473
  prefs: []
  type: TYPE_NORMAL
  zh: 示例 1 实现为一个命令对象，如下所示：
- en: '[PRE52]'
  id: totrans-474
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: In order to test the specific name server **`linux0l`**, you look for an address
    that Nagios should always be able to resolve, such as [www.google.com](http://www.google.com/)
  id: totrans-475
  prefs: []
  type: TYPE_NORMAL
  zh: 为了测试特定的名称服务器 **`linux0l`**，您寻找 Nagios 应该始终能够解析的地址，例如 [www.google.com](http://www.google.com/)
- en: '[PRE53]'
  id: totrans-476
  prefs: []
  type: TYPE_PRE
  zh: '[PRE53]'
- en: 6.6 Querying the Secure Shell Server
  id: totrans-477
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.6 查询 Secure Shell 服务器
- en: Monitoring of Secure Shell servers (irrespective of whether they use protocol
    version 1 or 2) is taken over by the plugin **`check_ssh`** (included in the standard
    distribution). It is quite a simple construction and just evaluates the SSH handshake.
    User name and password are not required for the test.
  id: totrans-478
  prefs: []
  type: TYPE_NORMAL
  zh: 无论 Secure Shell 服务器使用的是协议版本 1 还是 2，对 Secure Shell 服务器的监控都由插件 **`check_ssh`**（包含在标准发行版中）负责。它相当简单，只是评估
    SSH 握手。测试不需要用户名和密码。
- en: Not to be confused with **`check_sshis`** the plugin **`check_by_ssh`** (see
    [Chapter 9](../Text/ch09.html "Chapter 9. Executing Plugins via SSH") from page
    205), which starts plugins remotely on a different computer.
  id: totrans-479
  prefs: []
  type: TYPE_NORMAL
  zh: 不要与 **`check_sshis`** 混淆的插件 **`check_by_ssh`**（见第 9 章[通过 SSH 执行插件](../Text/ch09.html
    "第 9 章。通过 SSH 执行插件"，第 205 页)），该插件在另一台计算机上远程启动插件。
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  id: totrans-480
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
- en: Host name or IP address of the computer to which the plugin should set up an
    SSH connection.
  id: totrans-481
  prefs: []
  type: TYPE_NORMAL
  zh: 插件应建立 SSH 连接的计算机的主机名或 IP 地址。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-482
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: This specifies an alternative port. The default is 22.
  id: totrans-483
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了一个备用端口。默认为 22。
- en: '**`-r`** **``*`version`*``** **`/ --remote-version=`****``*`version`*``**'
  id: totrans-484
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** **``*`version`*``** **`/ --remote-version=`****``*`version`*``**'
- en: The version details for the tested Secure Shell must match the specified text
    instead of **``*`version`*``**, otherwise a WARNING will be sent (see example
    below). If the version details contain spaces, the string must be enclosed by
    double quotes.
  id: totrans-485
  prefs: []
  type: TYPE_NORMAL
  zh: 测试的 Secure Shell 的版本详细信息必须与指定的文本匹配，而不是 **``*`version`*``**，否则将发送警告（见下例）。如果版本详细信息包含空格，则字符串必须用双引号括起来。
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  id: totrans-486
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
- en: After **``*`timeout`*``** (by default, **`10`**) seconds the plugin breaks off
    the test and returns the CRITICAL state.
  id: totrans-487
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **``*`timeout`*``**（默认为 **`10`**）秒后，插件中断测试并返回 CRITICAL 状态。
- en: 'The following example in turn tests the Secure Shell daemons on the local computer
    and on **`wobgate`**, to see whether the current SSH version from Debian Etch
    is being used:'
  id: totrans-488
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例依次测试本地计算机和 **`wobgate`** 上的 Secure Shell 守护程序，以查看是否正在使用 Debian Etch 的当前
    SSH 版本：
- en: '[PRE54]'
  id: totrans-489
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: The latest version of SSH is not in use on **`wobgate`**.
  id: totrans-490
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **`wobgate`** 上未使用 SSH 的最新版本。
- en: 'In heterogeneous environments with various Linux distributions, you will usually
    use version checking "manually" only for plugin calls, and only rarely integrate
    them into the Nagios configuration. Instead, it is normally sufficient to use
    command and service definitions using the following simple pattern:'
  id: totrans-491
  prefs: []
  type: TYPE_NORMAL
  zh: 在具有各种 Linux 发行版的异构环境中，您通常只需“手动”进行插件调用时才使用版本检查，并且很少将它们集成到 Nagios 配置中。相反，通常使用以下简单模式使用命令和服务定义就足够了：
- en: '[PRE55]'
  id: totrans-492
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: Otherwise you run the risk of having to adjust the version number in the command
    object after every security update.
  id: totrans-493
  prefs: []
  type: TYPE_NORMAL
  zh: 否则，您将面临在每次安全更新后都必须调整命令对象中版本号的风险。
- en: 6.7 Generic Network Plugins
  id: totrans-494
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.7 通用网络插件
- en: 'Sometimes no plugin can be found that is precisely geared to the service to
    be monitored. For such cases, two generic plugins are available: **`check_tcp`**
    and **`check_udp`**. Both of them test whether a service is active on the target
    port for the protocol in question. Although this does not yet guarantee that the
    service running on the port really is the one in question, in an environment that
    one adminstrator looks after and configures, this can be sufficiently guaranteed
    in other ways.'
  id: totrans-495
  prefs: []
  type: TYPE_NORMAL
  zh: 有时找不到与要监控的服务完全匹配的插件。对于此类情况，有两个通用插件可用：**`check_tcp`** 和 **`check_udp`**。它们都测试目标端口上是否针对相关协议有活动服务。尽管这还不能保证在端口上运行的服务确实是所需的服务，但在一个管理员负责和配置的环境中，可以通过其他方式充分保证这一点。
- en: 'Both plugins send a string to the server and evaluate the reply. This is at
    its most simple for text-based protocols such as POP or IMAP: these two "specific"
    plugins, which are tailor-made for these two mail services (see [6.3.2 POP and
    IMAP](../Text/ch06s03.html#pop_and_imap "6.3.2 POP and IMAP") from page 115),
    use nothing more than symbolic links to **`check_tcp`**, which has already completed
    the corresponding question-and-answer game with relevant default settings.'
  id: totrans-496
  prefs: []
  type: TYPE_NORMAL
  zh: 这两个插件都会向服务器发送一个字符串并评估回复。对于基于文本的协议，如POP或IMAP，这最为简单：这两个“特定”插件，专为这两种邮件服务量身定制（参见第115页的[6.3.2
    POP和IMAP](../Text/ch06s03.html#pop_and_imap "6.3.2 POP和IMAP")），除了到**`check_tcp`**的符号链接外，没有使用任何其他东西，而**`check_tcp`**已经完成了相应的问答游戏，并设置了相关默认设置。
- en: If you know the protocol to be tested and you configure a "quiz" that will fit
    this (no easy task for binary protocols), a check becomes considerably more than
    just a port scan. In this way the generic plugins can also be substituted for
    specific missing plugins.
  id: totrans-497
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您知道要测试的协议，并配置了一个适合此协议的“测验”（对于二进制协议来说这不是一件容易的事），那么检查就不仅仅是端口扫描了。这样，通用插件也可以替代缺失的特定插件。
- en: 6.7.1 Testing TCP ports
  id: totrans-498
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.7.1 测试TCP端口
- en: '**`check_tcp`** is concentrated on TCP-based services. In line with its generic
    nature, it has a large number of options:'
  id: totrans-499
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_tcp`**专注于基于TCP的服务。与其通用性质一致，它有许多选项：'
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  id: totrans-500
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
- en: This is the IP address or host name of the computer whose port should be tested.
  id: totrans-501
  prefs: []
  type: TYPE_NORMAL
  zh: 这是应测试端口的计算机的IP地址或主机名。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-502
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: This specifies the target port. In contrast to the plugins that are formed as
    a symbolic link to **`check_tcp`**, this detail is always required.
  id: totrans-503
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了目标端口。与作为**`check_tcp`**符号链接的插件不同，此详细信息始终是必需的。
- en: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
  id: totrans-504
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
- en: This sets the warning limit for the response time in seconds.
  id: totrans-505
  prefs: []
  type: TYPE_NORMAL
  zh: 这将设置响应时间的警告限制（以秒为单位）。
- en: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
  id: totrans-506
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
- en: This sets a time limit like **`-w`** but specifies the critical limit value.
  id: totrans-507
  prefs: []
  type: TYPE_NORMAL
  zh: 这设置了一个类似于**`-w`**的时间限制，但指定了临界限制值。
- en: '**`-s`** **``*`"string"`*``** **`/ --send=`****``*`"string"`*``**'
  id: totrans-508
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-s`** **``*`"string"`*``** **`/ --send=`****``*`"string"`*``**'
- en: This is the string that the plugin should send to the server.
  id: totrans-509
  prefs: []
  type: TYPE_NORMAL
  zh: 这是插件应发送到服务器的字符串。
- en: '**`-e`** **``*`"string"`*``****`/ --expect=`****``*`"string"`*``**'
  id: totrans-510
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-e`** **``*`"string"`*``****`/ --expect=`****``*`"string"`*``**'
- en: This is the string that the reply of the server should contain. The plugin does
    not restrict its search here to the first line.
  id: totrans-511
  prefs: []
  type: TYPE_NORMAL
  zh: 这是服务器回复中应包含的字符串。插件不会将其搜索限制在第一行。
- en: '**`-E`** **`/ --escape`**'
  id: totrans-512
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-E`** **`/ --escape`**'
- en: This allows the use of the escape sequences **`\n`**, **`\r`**, **`\t`** or
    simply **`\`** for **`-s`** and **`-e`**. In all cases **`-E`** must be placed
    in front of the options **`-s`** and **`-e`** on which it should have an influence.
  id: totrans-513
  prefs: []
  type: TYPE_NORMAL
  zh: 这允许使用转义序列**`\n`**、**`\r`**、**`\t`**或简单地**`\`**来表示**`-s`**和**`-e`**。在所有情况下，**`-E`**必须放在影响**`-s`**和**`-e`**选项之前。
- en: '**`-A`** **`/ --all`**'
  id: totrans-514
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-A`** **`/ --all`**'
- en: If you specify multiple reply strings with **`-e`**, the plugin with **`-A`**
    will only return OK if all required reply strings were found. Without this option
    it is enough for a positive return if just one of several strings is found.
  id: totrans-515
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您指定了多个回复字符串**`-e`**，则带有**`-A`**的插件只有在所有必需的回复字符串都被找到时才会返回OK。如果没有此选项，只要找到几个字符串中的任何一个就足够了。
- en: '**`-M`** **``*`return_value`*``** **`/ --mismatch=`****``*`return_value`*``**'
  id: totrans-516
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-M`** **``*`return_value`*``** **`/ --mismatch=`****``*`return_value`*``**'
- en: How should the plugin react if a returned string does not match what is specified
    with **`-e?`** The default is **`warn`**, which means that a WARNING is given.
    With **`crit`**, a false return value could be categorized as CRITICAL, and with
    **`ok`**, as OK.
  id: totrans-517
  prefs: []
  type: TYPE_NORMAL
  zh: 如果返回的字符串与**`-e`**指定的内容不匹配，插件应该如何反应？默认值为**`warn`**，这意味着会发出警告。使用**`crit`**，错误的返回值可能被分类为CRITICAL，而使用**`ok`**，则被视为OK。
- en: '**`-q`** **``*`"string"`*``** **`/ --quit=`****``*`"string"`*``**'
  id: totrans-518
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-q`** **``*`"string"`*``** **`/ --quit=`****``*`"string"`*``**'
- en: This is the string that requests the service to end the connection.
  id: totrans-519
  prefs: []
  type: TYPE_NORMAL
  zh: 这是请求服务结束连接的字符串。
- en: '**`-m`** **``*`bytes`*``** **`/ --maxbytes=`****``*`bytes`*``**'
  id: totrans-520
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-m`** **``*`bytes`*``** **`/ --maxbytes=`****``*`bytes`*``**'
- en: The plugin closes the connection if it has received more than **``*`bytes`*``**.
  id: totrans-521
  prefs: []
  type: TYPE_NORMAL
  zh: 插件在接收到超过**``*`bytes`*``**后关闭连接。
- en: '**`-d`** **``*`floating_point_decimal`*``** **`/ --delay=`****``*`floating_point_decimal`*``**'
  id: totrans-522
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-d`** **``*`floating_point_decimal`*``** **`/ --delay=`****``*`floating_point_decimal`*``**'
- en: This is the time period in seconds between sending a string and checking the
    response.
  id: totrans-523
  prefs: []
  type: TYPE_NORMAL
  zh: 这是发送字符串和检查响应之间的秒数间隔。
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  id: totrans-524
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
- en: After **``*`timeout`*``** (the default is **`10`**) seconds the plugin stops
    the test and returns the CRITICAL status.
  id: totrans-525
  prefs: []
  type: TYPE_NORMAL
  zh: 在**``*`timeout`*``**（默认为**`10`**）秒后，插件停止测试并返回 CRITICAL 状态。
- en: '**`-j`** **`/ --jail`**'
  id: totrans-526
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-j`** **`/ --jail`**'
- en: Setting this displays the TCP output. For text-based protocols such as POP or
    IMAP, this is usually "human-readable", but for binary protocols you generally
    cannot decipher the output, so that **`-j`** is appropriate.
  id: totrans-527
  prefs: []
  type: TYPE_NORMAL
  zh: 设置此选项将显示 TCP 输出。对于基于文本的协议，如 POP 或 IMAP，这通常是“可读的”，但对于二进制协议，你通常无法解析输出，因此**`-j`**是合适的。
- en: '**`-r`** **``*`return_value`*``** **`/ --refuse=`****``*`return_value`*``**'
  id: totrans-528
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** **``*`return_value`*``** **`/ --refuse=`****``*`return_value`*``**'
- en: This switch specifies what value the plugin returns if the server rejects the
    TCP connection. The default is **`crit`** (CRITICAL). With **`ok`** as the **``*`return_value`*``**,
    you can test whether a service is available that should not be accessible from
    outside. The third possible value, **`warn`**, ensures that a WARNING is given.
  id: totrans-529
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项指定插件在服务器拒绝 TCP 连接时返回的值。默认为**`crit`**（CRITICAL）。如果**``*`return_value`*``**为**`ok`**，则可以测试是否有一个不应从外部访问的服务可用。第三种可能的值，**`warn`**，确保给出
    WARNING。
- en: '**`-D`** **``*`days`*``** **`/ --certificate=`****``*`days`*``**'
  id: totrans-530
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-D`** **``*`days`*``** **`/ --certificate=`****``*`days`*``**'
- en: 'This is the time span in days for which a server certificate must at least
    be valid for the test to run successfully. It is relevant only for SSL connections.
    Note that there is a danger of confusion: in the **`check_http`** plugin this
    same option is **`-C`** (see [6.4.2 Web server control via HTTP](../Text/ch06s04.html#web_server_control_via_http
    "6.4.2 Web server control via HTTP")). If the time span drops below the time period
    specified for the server certificate, the plugin returns a WARNING.'
  id: totrans-531
  prefs: []
  type: TYPE_NORMAL
  zh: 这是服务器证书至少需要有效的天数范围，以便测试成功运行。这仅适用于 SSL 连接。请注意，存在混淆的危险：在**`check_http`**插件中，此相同选项是**`-C`**（见[6.4.2
    通过 HTTP 控制Web服务器](../Text/ch06s04.html#web_server_control_via_http "6.4.2 通过 HTTP
    控制Web服务器")）。如果时间范围低于为服务器证书指定的时间段，插件将返回 WARNING。
- en: '**`-S`** **`/ --ssl`**'
  id: totrans-532
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-S`** **`/ --ssl`**'
- en: SSL/TLS should be used for the connection. The plugin cannot handle STARTTLS^([[60](#ftn.CHP-6-FN-13)]).
  id: totrans-533
  prefs: []
  type: TYPE_NORMAL
  zh: 应使用 SSL/TLS 进行连接。插件无法处理 STARTTLS^([[60](#ftn.CHP-6-FN-13)]）。
- en: 'The following example checks on the command line whether a service on the target
    host **`192.168.1.89`** is active on port 5631, the TCP port for the Windows remote-control
    software, PCAnywhere:'
  id: totrans-534
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例检查命令行是否在目标主机**`192.168.1.89`**的 5631 端口上激活了服务，这是 Windows 远程控制软件 PCAnywhere
    的 TCP 端口：
- en: '[PRE56]'
  id: totrans-535
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: 'For all services for which the computer name and port detail are sufficient
    as parameters for the test, the command object is as follows:'
  id: totrans-536
  prefs: []
  type: TYPE_NORMAL
  zh: 对于所有计算机名和端口细节足以作为测试参数的服务，命令对象如下：
- en: '[PRE57]'
  id: totrans-537
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: 'To monitor the said PCAnywhere on the machine **`Win0l`**, the following service
    definition would be used:'
  id: totrans-538
  prefs: []
  type: TYPE_NORMAL
  zh: 要监控机器**`Win0l`**上的 PCAnywhere，将使用以下服务定义：
- en: '[PRE58]'
  id: totrans-539
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: '* * *'
  id: totrans-540
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[60](#CHP-6-FN-13)]) See footnote in [6.3.2 POP and IMAP](../Text/ch06s03.html#pop_and_imap
    "6.3.2 POP and IMAP").
  id: totrans-541
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[60](#CHP-6-FN-13)]) 见[6.3.2 POP 和 IMAP](../Text/ch06s03.html#pop_and_imap
    "6.3.2 POP 和 IMAP")中的脚注。
- en: 6.7.2 Monitoring UDP ports
  id: totrans-542
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.7.2 监控 UDP 端口
- en: It is not so simple to monitor UDP ports, since there is no standard connection
    setup, such as the *three-way-handshake* for TCP, in the course of which a connection
    is opened, but data is not yet transferred. For a stateless protocol such as UDP
    there is no regulated sequence for sent and received packets. The server can reply
    to a UDP packet sent by the client with a UDP packet, but it is not obliged to
    do this.
  id: totrans-543
  prefs: []
  type: TYPE_NORMAL
  zh: 监控 UDP 端口并不简单，因为没有标准连接设置，例如 TCP 的 *三次握手*，在这个过程中连接被打开，但数据尚未传输。对于无状态协议如 UDP，没有发送和接收数据包的规范序列。服务器可以用
    UDP 数据包回复客户端发送的 UDP 数据包，但它没有义务这样做。
- en: 'If you find an unoccupied port, the requested host normally sends back an ICMP
    port unreachable message, which evaluates the plugin. If there is no reply, there
    are two possibilities: either the service on the target port is not reacting to
    the request, or a firewall is filtering out network traffic (either the UDP traffic
    itself or the ICMP message). This is why you can never be sure with UDP whether
    the server behind a particular port really is offering a service or not.'
  id: totrans-544
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你找到一个未使用的端口，请求的主机通常会发送一个ICMP端口不可达消息，这会评估插件。如果没有回复，有两种可能性：要么目标端口上的服务没有对请求做出反应，要么防火墙正在过滤网络流量（无论是UDP流量本身还是ICMP消息）。这就是为什么你永远不能确定特定端口背后的服务器是否真的提供了服务。
- en: In order to force a positive response where possible, you normally have to send
    data to the server, with the option **`-s`**, containing some kind of meaningful
    message for the underlying protocol. Most services will not respond to empty or
    meaningless packets. This is why you cannot avoid getting to grips with the corresponding
    protocol, since you will otherwise not be in a position to send meaningful data
    to the server, to prompt it into giving a reply at all.
  id: totrans-545
  prefs: []
  type: TYPE_NORMAL
  zh: 为了在可能的情况下强制得到积极的响应，你通常必须向服务器发送包含某种有意义消息的数据，使用**`-s`**选项。大多数服务不会对空或无意义的包做出响应。这就是为什么你不能避免了解相应的协议，因为否则你将无法向服务器发送有意义的数据，从而促使它给出回复。
- en: Ever since Nagios plugin version 1.4.4, **`check_udp`** has been a symlink to
    **`check_tcp`**, so that **`check_udp`** has the same options as **`check_tcp`**
    (see [6.6 Querying the Secure Shell Server](../Text/ch06s08.html "6.6 Querying
    the Secure Shell Server")). **`-p`** **``*`port`*``**, **`-s`** **``*`string`*``**,
    and **`-e`** **``*`string`*``** are obligatory entries, even though the integrated
    online help declares these to be optional.
  id: totrans-546
  prefs: []
  type: TYPE_NORMAL
  zh: 自从Nagios插件版本1.4.4以来，**`check_udp`**一直是**`check_tcp`**的符号链接，因此**`check_udp`**具有与**`check_tcp`**相同的选项（参见[6.6
    查询安全外壳服务器](../Text/ch06s08.html "6.6 查询安全外壳服务器")）。**`-p`** **``*`port`*``**、**`-s`**
    **``*`string`*``**和**`-e`** **``*`string`*``**是必填项，尽管集成在线帮助声明这些是可选的。
- en: 'The following example tests whether a service on the target host **`192.168.1.13`**
    is active on the time server (NTP) Port 123\. The NTP daemon only replies to packets
    containing a meaningful request (e.g., to ones whose contents begin with **`w`**):'
  id: totrans-547
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例测试目标主机**`192.168.1.13`**上的服务是否在时间服务器（NTP）端口123上活跃。NTP守护进程只对包含有意义请求的包做出响应（例如，内容以**`w`**开头的包）：
- en: '[PRE59]'
  id: totrans-548
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: 'The reply remains empty, so the reply string is specified as **`-e ""`**. The
    NTP server does not respond to packets with data not in the protocol form. Normally
    NTP expects a relatively complex packet^([[61](#ftn.CHP-6-FN-14)]) containing
    various information. The **`w`** used here was found out by trial and error: It
    does not contain really meaningful data, but it does provoke the server into giving
    a response.'
  id: totrans-549
  prefs: []
  type: TYPE_NORMAL
  zh: 回复保持为空，因此回复字符串被指定为**`-e ""`**。NTP服务器不会对非协议形式的包做出响应。通常，NTP期望一个相对复杂的包^([[61](#ftn.CHP-6-FN-14)))，其中包含各种信息。这里使用的**`w`**是通过试错法找到的：它不包含真正有意义的资料，但它确实能促使服务器做出响应。
- en: 'The command line command shown above is implemented as follows as a command
    object:'
  id: totrans-550
  prefs: []
  type: TYPE_NORMAL
  zh: 上面的命令行命令被实现为一个命令对象：
- en: '[PRE60]'
  id: totrans-551
  prefs: []
  type: TYPE_PRE
  zh: '[PRE60]'
- en: Here we pass on the port as the first argument; all the other switches of the
    plugin are accessed through **`$ARG2$`**.
  id: totrans-552
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们将端口作为第一个参数传递；所有其他插件的选项都通过**`$ARG2$`**访问。
- en: 'Checking an NTP time server is then taken over by the following service definition:'
  id: totrans-553
  prefs: []
  type: TYPE_NORMAL
  zh: 然后以下服务定义接管了检查NTP时间服务器：
- en: '[PRE61]'
  id: totrans-554
  prefs: []
  type: TYPE_PRE
  zh: '[PRE61]'
- en: As in the command line example, Nagios sends the string **`w`** to the service
    to provoke a positive response.
  id: totrans-555
  prefs: []
  type: TYPE_NORMAL
  zh: 如命令行示例所示，Nagios将字符串**`w`**发送到服务以引发一个积极的响应。
- en: '* * *'
  id: totrans-556
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: '^([[61](#CHP-6-FN-14)]) The protocol version NTPv3 is described in RFC 1305:
    [http://rfc.sunsite.dk/rfc/rfcl305.html](http://rfc.sunsite.dk/rfc/rfcl305.html).'
  id: totrans-557
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[61](#CHP-6-FN-14)]) NTPv3协议版本在RFC 1305中描述：[http://rfc.sunsite.dk/rfc/rfcl305.html](http://rfc.sunsite.dk/rfc/rfcl305.html)。
- en: 6.8 Monitoring Databases
  id: totrans-558
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.8 监控数据库
- en: 'Nagios provides three plugins for monitoring databases: **`check_pgsql`** for
    PostgreSQL, **`check_mysql`** for MySQL, and **`check_oracle`** for Oracle. The
    last will not be covered in this book.^([[62](#ftn.CHP-6-FN-15)]) They all have
    in common the fact that they can be used both locally and over the network. The
    latter has the advantage that the plugin in question does not have to be installed
    on the database server. The disadvantage is that you have to get more deeply involved
    with the subject of authentication, because configuring a secure *local* access
    to the database is somewhat more simple.'
  id: totrans-559
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios提供了三个用于监控数据库的插件：**`check_pgsql`**用于PostgreSQL，**`check_mysql`**用于MySQL，以及**`check_oracle`**用于Oracle。最后一项在本书中不会涉及^([[62](#ftn.CHP-6-FN-15)])。它们共同的特点是它们既可以在本地使用，也可以通过网络使用。后者的优点是相关的插件不需要安装到数据库服务器上。缺点是您必须更深入地了解认证主题，因为配置数据库的**安全本地**访问要简单一些。
- en: For less critical systems, network access by the plugin can be done without
    a password. To do this, the user **`nagios`** is set up with its own database
    in the database management system to be tested, which does not contain any (important)
    data. Areas accessed by this user can be isolated from other data, stored in the
    DBMS, through the database's own permissions system.
  id: totrans-560
  prefs: []
  type: TYPE_NORMAL
  zh: 对于不太关键的系统，插件的网络访问可以不使用密码进行。为此，用户**`nagios`**在要测试的数据库管理系统（DBMS）中设置了自己的数据库，其中不包含任何（重要）数据。通过此用户访问的区域可以通过数据库自身的权限系统与其他数据隔离，存储在DBMS中。
- en: Of course, there is nothing stopping you from setting up a password for the
    user **`nagios`**. But if you cannot make use of SSL-encrypted connections, this
    will be transmitted in plain text for most database connections. In addition,
    it is stored unencrypted in the Nagios configuration files. In this respect the
    password does offer some protection, but it is not really that secure.
  id: totrans-561
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，您可以为用户**`nagios`**设置密码。但如果您无法使用SSL加密连接，大多数数据库连接将以明文形式传输。此外，它还在Nagios配置文件中未加密存储。在这方面，密码确实提供了一些保护，但并不真正安全。
- en: As an additional measure, you should certainly restrict the IP address from
    which a user **`nagios`** user can access the database on the Nagios server.
  id: totrans-562
  prefs: []
  type: TYPE_NORMAL
  zh: 作为一项额外措施，您当然应该限制用户**`nagios`**可以从Nagios服务器访问数据库的IP地址。
- en: The plugins introduced here have only read access to the database. **`check_mysql`**
    additionally allows a pure connection check, without read access. A write access
    to the database is not available in any of the plugins mentioned. For Oracle there
    is a plugin on Nagios Exchange^([[63](#ftn.CHP-6-FN-16)]) called **`check_oracle_writeaccess.sh`**,
    which also tests the writeability of the database.
  id: totrans-563
  prefs: []
  type: TYPE_NORMAL
  zh: 这里介绍的插件对数据库只有读取访问权限。**`check_mysql`**插件还允许进行纯连接检查，而不需要读取访问。在提到的任何插件中，数据库的写入访问均不可用。对于Oracle，Nagios
    Exchange^([[63](#ftn.CHP-6-FN-16)])上有一个名为**`check_oracle_writeaccess.sh`**的插件，它也测试数据库的可写性。
- en: 6.8.1 PostgreSQL
  id: totrans-564
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.8.1 PostgreSQL
- en: With the **`check_pgsql`** plugin you can establish both local and network connections
    to the database. Local connections are handled by PostgreSQL via a Unix socket,
    which is a purely local mechanism. An IP connection is set up by **`check_pgsql`**
    if a target host is explicitly passed to it. The plugin performs a pure connection
    test to a test database but does not read any data from it.
  id: totrans-565
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**`check_pgsql`**插件，您可以建立到数据库的本地和网络连接。本地连接由PostgreSQL通过Unix套接字处理，这是一个纯粹的本地区域机制。如果显式传递目标主机给**`check_pgsql`**，则会通过它建立IP连接。插件对测试数据库执行纯连接测试，但不从中读取任何数据。
- en: In order that PostgreSQL can be reached over the network, you must start the
    **`postmaster`** program, either with **`-i`**, or by setting the parameter **`tcpip_socket`**
    in the configuration file **`postgresql.conf`** to the value **`true`**.
  id: totrans-566
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使PostgreSQL可以通过网络访问，您必须启动**`postmaster`**程序，使用**`-i`**选项，或者在配置文件**`postgresql.conf`**中将参数**`tcpip_socket`**设置为**`true`**。
- en: Configuring a monitor-friendly DBMS
  id: totrans-567
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 配置便于监控的DBMS
- en: 'In order to separate the data that the user **`nagios`** (executing the plugin)
    gets to see more clearly from other data, you first set up a database user with
    the same name, and a database to which this user is given access:'
  id: totrans-568
  prefs: []
  type: TYPE_NORMAL
  zh: 为了更清晰地分离用户**`nagios`**（执行插件）可以看到的数据与其他数据，您首先设置一个具有相同名称的数据库用户，并授予此用户访问权限的数据库：
- en: '[PRE62]'
  id: totrans-569
  prefs: []
  type: TYPE_PRE
  zh: '[PRE62]'
- en: Of particular importance when creating a database user with the command **`createuser`**
    is the option **`--no-adduser`**. To PostgreSQL, the ability to be allowed to
    create users automatically means that you are the superuser, who can easily get
    round the various permissions set.^([[64](#ftn.CHP-6-FN-17)]) But **`nagios`**
    should not be given superuser permissions under any circumstances.
  id: totrans-570
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用命令 **`createuser`** 创建数据库用户时，**`--no-adduser`** 选项尤为重要。对于 PostgreSQL 来说，允许自动创建用户的能力意味着你是超级用户，可以轻松绕过各种权限设置.^([[64](#ftn.CHP-6-FN-17)])
    但在任何情况下都不应授予 **`nagios`** 超级用户权限。
- en: '**`createdb`** finally creates a new, empty database called **`nagdb`**, which
    belongs to **`nagios`**.'
  id: totrans-571
  prefs: []
  type: TYPE_NORMAL
  zh: '**`createdb`** 最终创建了一个名为 **`nagdb`** 的新空数据库，属于 **`nagios`**。'
- en: 'Access to the database can be restricted in the file **`pg_hba.conf`**. Depending
    on the distribution, this can be found either in **`/etc/postgresql`** or in the
    subdirectory **`./data`** of the database itself (for example, **`/var/lib/pgsql/data`**
    for SUSE). The following extract restricts access by the database user **`nagios`**
    to a specific database and to the IP address of the Nagios server (instead of
    the IP address to be completed by **``*`ip-nagios`*``**):'
  id: totrans-572
  prefs: []
  type: TYPE_NORMAL
  zh: 数据库访问可以通过文件 **`pg_hba.conf`** 进行限制。根据发行版的不同，它可能位于 **`/etc/postgresql`** 或数据库本身的子目录
    **`./data`** 中（例如，对于 SUSE，为 **`/var/lib/pgsql/data`**）。以下摘录限制了数据库用户 **`nagios`**
    对特定数据库和 Nagios 服务器 IP 地址的访问（而不是由 **``*`ip-nagios`*``** 完成的 IP 地址）：
- en: '[PRE63]'
  id: totrans-573
  prefs: []
  type: TYPE_PRE
  zh: '[PRE63]'
- en: The first line is a comment describing the function of the columns. The second
    line allows the database user **`nagios`** access to the database **`nagdb`**
    over a local connection. Even though the authentication method here is called
    **`ident`**, you do not need a local ident daemon for Linux and BSD variants (NetBSD,
    FreeBSD, etc.).
  id: totrans-574
  prefs: []
  type: TYPE_NORMAL
  zh: 第一行是注释，描述了列的功能。第二行允许数据库用户 **`nagios`** 通过本地连接访问数据库 **`nagdb`**。尽管这里的身份验证方法被称为
    **`ident`**，但你不需要为 Linux 和 BSD 变体（NetBSD、FreeBSD 等）安装本地身份验证守护进程。
- en: The last line describes the same restriction, but this time it is for a TCP/IP
    connection to the Nagios server. But now PostgreSQL asks the ident daemon of the
    Nagios server which user has set off the connection request. This means that an
    ident daemon must be installed on **``*`ip-nagios`*``**. In this way the DBMS
    tests whether the user initiating the connection from the Nagios server really
    is called **`nagios`**. It will not permit another user (or a connection from
    a different host).
  id: totrans-575
  prefs: []
  type: TYPE_NORMAL
  zh: 最后一行描述了相同的限制，但这次是针对与 Nagios 服务器建立的 TCP/IP 连接。但现在 PostgreSQL 会询问 Nagios 服务器上的身份验证守护进程，哪个用户触发了连接请求。这意味着必须在
    **``*`ip-nagios`*``** 上安装一个身份验证守护进程。这样，数据库管理系统就会检查从 Nagios 服务器发起连接的用户是否真的叫做 **`nagios`**。它不会允许其他用户（或来自不同主机的连接）。
- en: Normally the ident protocol is only partially suited for user authentication.
    But in the case of the Nagios server you can assume that a host is involved that
    is under the control of the administrator who can ensure that an ident daemon
    really is running on port 113.
  id: totrans-576
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，身份验证协议只部分适用于用户身份验证。但在 Nagios 服务器的情况下，你可以假设涉及的主机是在管理员控制之下，管理员可以确保身份验证守护进程确实运行在端口
    113 上。
- en: There is a huge range of different ident daemons. **`pidentd`**^([[65](#ftn.CHP-6-FN-18)])
    is widely used and is included in most Linux distributions. Normally it is already
    precon-figured and just needs to be started. But how it is started depends on
    the distribution; usually **`inetd`** or **`xinetd`** takes over this task. A
    glance at the documentation (should) put you straight.
  id: totrans-577
  prefs: []
  type: TYPE_NORMAL
  zh: 存在着大量不同的身份验证守护进程。**`pidentd`**^([[65](#ftn.CHP-6-FN-18)]) 被广泛使用，并且包含在大多数 Linux
    发行版中。通常它已经预先配置好，只需启动即可。但是启动方式取决于发行版；通常由 **`inetd`** 或 **`xinetd`** 承担这项任务。浏览文档（应该）能让你直接找到答案。
- en: After modifying the configuration in **`pg_hba.conf`** you must stop the DBMS
    so that it can reload the configuration files. This is best done with the command
  id: totrans-578
  prefs: []
  type: TYPE_NORMAL
  zh: 修改 **`pg_hba.conf`** 中的配置后，必须停止数据库管理系统，以便它可以重新加载配置文件。这最好通过以下命令完成：
- en: '[PRE64]'
  id: totrans-579
  prefs: []
  type: TYPE_PRE
  zh: '[PRE64]'
- en: (a restart is not necessary). If the configuration of the **`inetd/xinetd`**
    was modified, this daemon is reinitialized in the same way.
  id: totrans-580
  prefs: []
  type: TYPE_NORMAL
  zh: （不需要重启）。如果修改了 **`inetd/xinetd`** 的配置，此守护进程将以相同的方式重新初始化。
- en: The test plugin **`check_pgsql`**
  id: totrans-581
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 测试插件 **`check_pgsql`**
- en: '**`check_pgsql`** has the following options:'
  id: totrans-582
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_pgsql`** 有以下选项：'
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  id: totrans-583
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
- en: If given this option, the plugin establishes a TCP/IP connection instead of
    making contact with a local DBMS through a Unix socket.
  id: totrans-584
  prefs: []
  type: TYPE_NORMAL
  zh: 如果提供了此选项，插件将建立 TCP/IP 连接，而不是通过 Unix 套接字与本地 DBMS 建立联系。
- en: '**`-P`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-585
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-P`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: In contrast to the plugins discussed until now, **`check_pgsql`** uses a capital
    P to specify the port on which PostgreSQL is running. In its default value it
    is connected to port 5432\. This option is only useful if PostgreSQL allows TCP/IP
    connections.
  id: totrans-586
  prefs: []
  type: TYPE_NORMAL
  zh: 与之前讨论的插件不同，**`check_pgsql`** 使用大写 P 来指定 PostgreSQL 运行的端口。默认情况下，它连接到端口 5432。此选项仅在
    PostgreSQL 允许 TCP/IP 连接时有用。
- en: '**`-d`** **``*`database`*``** **`/ --database=`****``*`database`*``**'
  id: totrans-587
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-d`** **``*`database`*``** **`/ --database=`****``*`database`*``**'
- en: Specifies the name of the database to which the plugin should connect. If this
    detail is missing, it uses the standard database **`template1`**.
  id: totrans-588
  prefs: []
  type: TYPE_NORMAL
  zh: 指定插件应连接到的数据库名称。如果缺少此详细信息，它将使用标准数据库 **`template1`**。
- en: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
  id: totrans-589
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
- en: This is the warning time in seconds for the performance time for the test.
  id: totrans-590
  prefs: []
  type: TYPE_NORMAL
  zh: 这是测试性能时间的警告时间（以秒为单位）。
- en: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
  id: totrans-591
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
- en: This is the critical limit for the performance time of the test in seconds.
  id: totrans-592
  prefs: []
  type: TYPE_NORMAL
  zh: 这是测试性能时间的临界限制（以秒为单位）。
- en: '**`−1`** **``*`user`*``** **`/ --logname=`****``*`user`*``**'
  id: totrans-593
  prefs: []
  type: TYPE_NORMAL
  zh: '**`−1`** **``*`user`*``** **`/ --logname=`****``*`user`*``**'
- en: This is the name of the user who should establish contact to the database.
  id: totrans-594
  prefs: []
  type: TYPE_NORMAL
  zh: 这是应该与数据库建立联系的用户名称。
- en: '**`-p`** **``*`passwd`*``** **`/ --password=`****``*`passwd`*``**'
  id: totrans-595
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`passwd`*``** **`/ --password=`****``*`passwd`*``**'
- en: This switch sets the password for access to the database. Since this must be
    stored in plain text in the service definition, a potential security problem is
    involved. It is preferable to explicitly define a restricted, password-free access
    to the database in the PostgreSQL configuration for the user **`nagios`**.
  id: totrans-596
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关设置数据库访问密码。由于必须在服务定义中以纯文本形式存储，因此可能存在潜在的安全问题。最好在 PostgreSQL 的用户 **`nagios`**
    配置中显式定义一个受限的、无密码的数据库访问。
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  id: totrans-597
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
- en: After 10 seconds have expired, the plugin stops the test and returns the CRITICAL
    status. This option allows the default value to be changed.
  id: totrans-598
  prefs: []
  type: TYPE_NORMAL
  zh: 10 秒后过期，插件停止测试并返回 CRITICAL 状态。此选项允许更改默认值。
- en: 'To test the reachability across the network of the database **`nagdb`** set
    up specially for this purpose, this is passed on as a parameter together with
    the target host (here: **`linux01`**):'
  id: totrans-599
  prefs: []
  type: TYPE_NORMAL
  zh: 要测试专门为此目的设置的数据库 **`nagdb`** 在网络上的可达性，此参数与目标主机（此处：**`linux01`**）一起传递：
- en: '[PRE65]'
  id: totrans-600
  prefs: []
  type: TYPE_PRE
  zh: '[PRE65]'
- en: 'The fact that the check went wrong in the example is clearly due to the ident
    authentication. This happens, for example, if you forget to reload the ident daemon
    after the configuration has been modified. Once the error has been rectified,
    the plugin—hopefully—will work better:'
  id: totrans-601
  prefs: []
  type: TYPE_NORMAL
  zh: 检查在示例中出错明显是由于 ident 认证。例如，如果你忘记在修改配置后重新加载 ident 守护进程，就会发生这种情况。一旦错误得到纠正，插件——希望——将工作得更好：
- en: '[PRE66]'
  id: totrans-602
  prefs: []
  type: TYPE_PRE
  zh: '[PRE66]'
- en: 'If the database parameter is omitted, **`check_pgsql`** will address the database
    **`template1`**:'
  id: totrans-603
  prefs: []
  type: TYPE_NORMAL
  zh: 如果省略数据库参数，**`check_pgsql`** 将连接到数据库 **`template1`**：
- en: '[PRE67]'
  id: totrans-604
  prefs: []
  type: TYPE_PRE
  zh: '[PRE67]'
- en: 'A similar result is obtained if you run the test with the correct database,
    but with the wrong user:'
  id: totrans-605
  prefs: []
  type: TYPE_NORMAL
  zh: 如果使用正确的数据库但错误的用户运行测试，也会得到类似的结果：
- en: '[PRE68]'
  id: totrans-606
  prefs: []
  type: TYPE_PRE
  zh: '[PRE68]'
- en: You should certainly run the last two tests, just to check that the PostgreSQL
    database really does reject corresponding requests. Otherwise you will have a
    security leak, and we recommend that you remove settings in the configuration
    that are too generous.
  id: totrans-607
  prefs: []
  type: TYPE_NORMAL
  zh: 你当然应该运行最后两个测试，只是为了检查 PostgreSQL 数据库是否真的拒绝相应的请求。否则，你将有一个安全漏洞，我们建议你删除配置中过于宽泛的设置。
- en: 'If you have created a separate database for the check, there is no reason why
    you shouldn''t write this explicitly in the command definition, instead of using
    parameters, with **`$ARG1$`**:'
  id: totrans-608
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你为检查创建了单独的数据库，就没有理由不在命令定义中明确写出，而不是使用参数，使用 **`$ARG1$`**：
- en: '[PRE69]'
  id: totrans-609
  prefs: []
  type: TYPE_PRE
  zh: '[PRE69]'
- en: 'Then the service definition for **`linux01`** is as simple as this:'
  id: totrans-610
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，**`linux01`** 的服务定义就像这样简单：
- en: '[PRE70]'
  id: totrans-611
  prefs: []
  type: TYPE_PRE
  zh: '[PRE70]'
- en: 6.8.2 MySQL
  id: totrans-612
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.8.2 MySQL
- en: With the **`check_mysql`** plugin, MySQL databases can be tested both locally
    and across the network. For local connections, it makes contact via a Unix socket,
    and not via a real network connection.
  id: totrans-613
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 **`check_mysql`** 插件，MySQL 数据库可以在本地和网络上进行测试。对于本地连接，它通过 Unix 套接字进行联系，而不是通过真正的网络连接。
- en: MySQL configuration
  id: totrans-614
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: MySQL 配置
- en: 'In order that the database can be reached across the network, the **`skip-networking`**
    option in the configuration file **`my.cnf`** must be commented out. The database
    should then be running on TCP port 3306, which can be tested with **`netstat -ant`**,
    for example:'
  id: totrans-615
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使数据库可以通过网络访问，必须在配置文件 **`my.cnf`** 中取消注释 **`skip-networking`** 选项。然后数据库应在 TCP
    端口 3306 上运行，可以使用 **`netstat -ant`** 等命令进行测试：
- en: '[PRE71]'
  id: totrans-616
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: To set up the password-free access to the database relatively securely, a separate
    **`nagdb`** database is created here that does not contain any critical data,
    and for which the user **`nagios`** is given restricted access from the Nagios
    server. To do this, you connect yourself, as the database user **`root`**, to
    the database **`mysql`**, and there you create the database **`nagdb:`**
  id: totrans-617
  prefs: []
  type: TYPE_NORMAL
  zh: 为了相对安全地设置无密码访问数据库，这里创建了一个单独的 **`nagdb`** 数据库，其中不包含任何关键数据，并且用户 **`nagios`** 从
    Nagios 服务器获得了受限访问。为此，您作为数据库用户 **`root`** 连接到数据库 **`mysql`**，然后在其中创建数据库 **`nagdb:`**
- en: '[PRE72]'
  id: totrans-618
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: If the command **`mysql --user=root mysql`** functions without the need to enter
    a **`root`** password, then you have a serious security problem. In that case,
    anyone—at least from the database server—is able to obtain full access to the
    database. If this is the case, it is essential that you read the security notes
    in the MySQL documentation.^([[66](#ftn.CHP-6-FN-19)])
  id: totrans-619
  prefs: []
  type: TYPE_NORMAL
  zh: 如果命令 **`mysql --user=root mysql`** 无需输入 **`root`** 密码即可执行，那么您面临一个严重的安全问题。在这种情况下，任何人——至少是从数据库服务器开始——都可以获得对数据库的完全访问权限。如果出现这种情况，您必须阅读
    MySQL 文档中的安全注意事项。[^([66](#ftn.CHP-6-FN-19))]
- en: 'Recreating a user and the access restrictions can be done in one and the same
    step:'
  id: totrans-620
  prefs: []
  type: TYPE_NORMAL
  zh: 重新创建用户和访问限制可以一步完成：
- en: '[PRE73]'
  id: totrans-621
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: The command sets up the user **`nagios`**, if it does not exist. It may only
    accept connections from the Nagios server with the IP address **``*`ip-nagios`*``**
    and obtains access to all tables in the database **`nagdb`**, but may execute
    only the **`SELECT`** command there (no **`INSERT`**, no **`UPDATE`** or **`DELETE`**);
    that is, user **`nagios`** only has read access.
  id: totrans-622
  prefs: []
  type: TYPE_NORMAL
  zh: 命令设置用户 **`nagios`**，如果不存在。它可能只接受来自 IP 地址 **``*`ip-nagios`*``** 的 Nagios 服务器的连接，并能够访问数据库
    **`nagdb`** 中的所有表，但只能执行 **`SELECT`** 命令（不允许 **`INSERT`**、**`UPDATE`** 或 **`DELETE`**）；也就是说，用户
    **`nagios`** 只具有读取权限。
- en: The test plugin **`check_mysql`**
  id: totrans-623
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 测试插件 **`check_mysql`**
- en: '**`check_mysql`** has fewer options than its PostgreSQL equivalent—apart from
    **`-H`**, it does not implement any standard flags and has neither a warning not
    a critical limit for the performance time of the test. For the database-specific
    options, it uses the same syntax as **`check_pgsql`**, except for the user entry:'
  id: totrans-624
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_mysql`** 的选项比其 PostgreSQL 等效选项少——除了 **`-H`** 之外，它不实现任何标准标志，并且没有警告或临界性能时间限制。对于特定数据库的选项，它使用与
    **`check_pgsql`** 相同的语法，除了用户输入：'
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  id: totrans-625
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
- en: This sets the host name or IP address of the database server. If the option
    **`-H`** is omitted, or if it is used in connection with the argument **`localhost`**,
    **`check_mysql`** does not set up a network connection but uses a Unix socket.
    If you want to establish an IP connection to **`localhost`**, you must explicitly
    specify the IP address **`127.0.0.1`**.
  id: totrans-626
  prefs: []
  type: TYPE_NORMAL
  zh: 这设置了数据库服务器的计算机名或 IP 地址。如果省略了选项 **`-H`**，或者它与参数 **`localhost`** 一起使用，**`check_mysql`**
    不会建立网络连接，而是使用 Unix 套接字。如果您想建立到 **`localhost`** 的 IP 连接，您必须明确指定 IP 地址 **`127.0.0.1`**。
- en: '**`-P`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-627
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-P`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: This is the TCP port on which MySQL is installed. In the default, port 3306
    is used.
  id: totrans-628
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 MySQL 安装的 TCP 端口。默认情况下，使用端口号 3306。
- en: '**`-d`** **``*`database`*``** **`/ --database=`****``*`database`*``**'
  id: totrans-629
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-d`** **``*`database`*``** **`/ --database=`****``*`database`*``**'
- en: This is the name of the database to which the plugin should set up a connection.
    If this option is omitted, it only makes a connection to the database process,
    without addressing a specific database.
  id: totrans-630
  prefs: []
  type: TYPE_NORMAL
  zh: 这是插件应建立连接的数据库的名称。如果省略此选项，它仅连接到数据库进程，而不指定特定的数据库。
- en: '**`-u`** **``*`user`*``** **`/ --username=`****``*`user`*``**'
  id: totrans-631
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u`** **``*`user`*``** **`/ --username=`****``*`user`*``**'
- en: This is the user in whose name the plugin should log in to the DBMS.
  id: totrans-632
  prefs: []
  type: TYPE_NORMAL
  zh: 这是插件应以其名义登录到 DBMS 的用户。
- en: '**`-p`** **``*`passwd`*``** **`/ --password=`****``*`passwd`*``**'
  id: totrans-633
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`passwd`*``** **`/ --password=`****``*`passwd`*``**'
- en: This switch is used to provide the password for logging in to the database.
  id: totrans-634
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关用于提供登录数据库的密码。
- en: 'To set up a connection to the database **`nagdb`** as the user **`nagios`**,
    both parameters are passed on to the plugin:'
  id: totrans-635
  prefs: []
  type: TYPE_NORMAL
  zh: 要设置与数据库 **`nagdb`** 的连接，以用户 **`nagios`** 身份，这两个参数都传递给插件：
- en: '[PRE74]'
  id: totrans-636
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: 'In contrast to PostgreSQL, with MySQL you can also make contact without establishing
    a connection to a specific database:'
  id: totrans-637
  prefs: []
  type: TYPE_NORMAL
  zh: 与 PostgreSQL 相比，使用 MySQL，您也可以在不连接到特定数据库的情况下建立联系：
- en: '[PRE75]'
  id: totrans-638
  prefs: []
  type: TYPE_PRE
  zh: '[PRE75]'
- en: 'With a manual connection to the database, with **`mysql`**, you can then subsequently
    change to the desired database, using the MySQL command **`use`**:'
  id: totrans-639
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 **`mysql`** 手动连接到数据库后，您可以使用 MySQL 命令 **`use`** 切换到所需的数据库：
- en: '[PRE76]'
  id: totrans-640
  prefs: []
  type: TYPE_PRE
  zh: '[PRE76]'
- en: With this plugin, a subsequent database change is not possible. Here you must
    decide from the beginning whether you want to contact a database or whether you
    just want to establish a connection to the MySQL database system.
  id: totrans-641
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此插件，后续无法更改数据库。在这里，您必须从一开始就决定您是想联系数据库还是只想建立与 MySQL 数据库系统的连接。
- en: 'To test a **`nagdb`** database set up explicitly for this purpose, you can
    do without parameters when creating the corresponding command object, and explicitly
    specify both user and database:'
  id: totrans-642
  prefs: []
  type: TYPE_NORMAL
  zh: 要测试为该目的明确设置的 **`nagdb`** 数据库，在创建相应的命令对象时可以不使用参数，并明确指定用户和数据库：
- en: '[PRE77]'
  id: totrans-643
  prefs: []
  type: TYPE_PRE
  zh: '[PRE77]'
- en: 'This simplifies the service definition:'
  id: totrans-644
  prefs: []
  type: TYPE_NORMAL
  zh: 这简化了服务定义：
- en: '[PRE78]'
  id: totrans-645
  prefs: []
  type: TYPE_PRE
  zh: '[PRE78]'
- en: '* * *'
  id: totrans-646
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[62](#CHP-6-FN-15)]) The plugin **`check_oracle`** assumes the installation
    of an Oracle Full Client on the Nagios server; it does not work together with
    the Instant Client and expects its users to have an extensive knowledge of Oracle.
    To explain all this here is far beyond the scope of this book.
  id: totrans-647
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[62](#CHP-6-FN-15)]) 插件 **`check_oracle`** 假设 Nagios 服务器上安装了 Oracle 完整客户端；它与
    Instant Client 不兼容，并期望其用户对 Oracle 有广泛的知识。在这里解释所有这些内容远远超出了本书的范围。
- en: ^([[63](#CHP-6-FN-16)]) [http://www.nagiosexchange.org/153;3](http://www.nagiosexchange.org/153;3)
  id: totrans-648
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[63](#CHP-6-FN-16)]) [http://www.nagiosexchange.org/153;3](http://www.nagiosexchange.org/153;3)
- en: ^([[64](#CHP-6-FN-17)]) Permissions in PostgreSQL are given by the database
    command **`GRANT`**.
  id: totrans-649
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[64](#CHP-6-FN-17)]) PostgreSQL 中的权限由数据库命令 **`GRANT`** 提供。
- en: ^([[65](#CHP-6-FN-18)]) [http://www.lysator.liu.se/~pen/pidentd/](http://www.lysator.liu.se/~pen/pidentd/).
  id: totrans-650
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[65](#CHP-6-FN-18)]) [http://www.lysator.liu.se/~pen/pidentd/](http://www.lysator.liu.se/~pen/pidentd/).
- en: ^([[66](#CHP-6-FN-19)]) To be found at [http://dev.mysql.com/doc/mysql/de/Security.html](http://dev.mysql.com/doc/mysql/de/Security.html).
  id: totrans-651
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[66](#CHP-6-FN-19)]) 可在 [http://dev.mysql.com/doc/mysql/de/Security.html](http://dev.mysql.com/doc/mysql/de/Security.html)
    找到。
- en: 6.9 Monitoring LDAP Directory Services
  id: totrans-652
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.9 监控 LDAP 目录服务
- en: 'For monitoring LDAP directory services, the **`check_ldap`** plugin is available.
    It runs a search query that can be specified anonymously or with authentication.
    It has the following parameters to do this:'
  id: totrans-653
  prefs: []
  type: TYPE_NORMAL
  zh: 对于监控 LDAP 目录服务，有 **`check_ldap`** 插件可用。它运行一个可以指定为匿名或带认证的搜索查询。为此，它有以下参数：
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  id: totrans-654
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
- en: This is the host name or IP address of the LDAP server.
  id: totrans-655
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 LDAP 服务器的主机名或 IP 地址。
- en: '**`-b`** **``*`base_dn`*``** **`/ --base=`****``*`base_dn`*``**'
  id: totrans-656
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-b`** **``*`base_dn`*``** **`/ --base=`****``*`base_dn`*``**'
- en: 'This is the top element (*Base Domain Name*) of the LDAP directory, formed
    for example from the components of the domain name: **`dc=swobspace,dc=de`**.'
  id: totrans-657
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 LDAP 目录的顶级元素 (*基础域名*)，例如由域名组件组成：**`dc=swobspace,dc=de`**。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-658
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: This is the port on which the LDAP server is running. The default is the standard
    port 389.
  id: totrans-659
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 LDAP 服务器运行的服务器端口。默认端口是标准端口 389。
- en: '**`-a`** **``*`"ldap-attribute"`*``** **`/ --attr=`****``*`"ldap-attribute"`*``**'
  id: totrans-660
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-a`** **``*`"ldap-attribute"`*``** **`/ --attr=`****``*`"ldap-attribute"`*``**'
- en: This switch enables a search according to specific attributes. Thus **`-a "(objectclass=inetOrgPerson)"`**
    searches for all nodes in the directory tree containing the object class **`inetOrgPerson`**
    (normally used for telephone and e-mail directories, for example).
  id: totrans-661
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关启用根据特定属性进行搜索。因此 **`-a "(objectclass=inetOrgPerson)"`** 搜索目录树中包含对象类 **`inetOrgPerson`**
    的所有节点（通常用于电话和电子邮件目录，例如）。
- en: Specifying attributes in the check is less useful than it may seem. If you search
    through an LDAP directory for nonexistent attributes, you will normally receive
    an answer with zero results, but no errors.
  id: totrans-662
  prefs: []
  type: TYPE_NORMAL
  zh: 在检查中指定属性不如表面上看起来那么有用。如果您在 LDAP 目录中搜索不存在的属性，您通常会收到一个包含零结果但无错误的答案。
- en: '**`-D`** **``*`ldap_bind_dn`*``** **`/ --bin.d=`****``*`ldap_bind_dn`*``**'
  id: totrans-663
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-D`** **``*`ldap_bind_dn`*``** **`/ --bin.d=`****``*`ldap_bind_dn`*``**'
- en: 'This specifies a bind DN^([[67](#ftn.CHP-6-FN-20)]) for an authenticated connection,
    such as:'
  id: totrans-664
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了一个用于认证连接的 bind DN^([[67](#ftn.CHP-6-FN-20)])，例如：
- en: '[PRE79]'
  id: totrans-665
  prefs: []
  type: TYPE_PRE
  zh: '[PRE79]'
- en: Without this entry, the plugin establishes an anonymous connection.
  id: totrans-666
  prefs: []
  type: TYPE_NORMAL
  zh: 如果没有此条目，插件将建立匿名连接。
- en: '**`-P`** **``*`ldap_passwd`*``** **`/ --pass=`****``*`ldap_passwd`*``**'
  id: totrans-667
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-P`** **``*`ldap_passwd`*``** **`/ --pass=`****``*`ldap_passwd`*``**'
- en: This is the password for an authenticated connection. It only makes sense in
    conjunction with the option **`-D`**.
  id: totrans-668
  prefs: []
  type: TYPE_NORMAL
  zh: 这是认证连接的密码。它仅在 **`-D`** 选项结合使用时才有意义。
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  id: totrans-669
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
- en: After **``*`timeout`*``** seconds have expired (**`10`** seconds if this option
    is not given), the plugin stops the test and returns the CRITICAL status.
  id: totrans-670
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **``*`timeout`*``** 秒（如果没有给出此选项，则为 10 秒）后过期后，插件停止测试并返回 CRITICAL 状态。
- en: '**`−2`** **`/ --ver2`**'
  id: totrans-671
  prefs: []
  type: TYPE_NORMAL
  zh: '**`−2`** **`/ --ver2`**'
- en: 'Use LDAP version v2 (the default). If the server does not support this protocol
    version, the connection will fail. In OpenLDAP from version 2.1, v3 is used by
    default; to activate protocol version v2, the following line is entered in the
    configuration file **`slapd.conf`**:'
  id: totrans-672
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 LDAP 版本 v2（默认）。如果服务器不支持此协议版本，连接将失败。从 OpenLDAP 2.1 版本开始，默认使用 v3；要激活协议版本 v2，请在配置文件
    **`slapd.conf`** 中输入以下行：
- en: '[PRE80]'
  id: totrans-673
  prefs: []
  type: TYPE_PRE
  zh: '[PRE80]'
- en: Many clients, such as Mozilla and the Thunderbird address book, are still using
    LDAP version v2.
  id: totrans-674
  prefs: []
  type: TYPE_NORMAL
  zh: 许多客户端，如 Mozilla 和 Thunderbird 地址簿，仍在使用 LDAP 版本 v2。
- en: '**`−3 / --ver3`**'
  id: totrans-675
  prefs: []
  type: TYPE_NORMAL
  zh: '**`−3 / --ver3`**'
- en: Use LDAP version v3\. For many modern LDAP servers such as Open-LDAP, this is
    now the standard, but they usually also have parallel support for the older version
    v2, since various clients cannot yet implement v3.
  id: totrans-676
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 LDAP 版本 v3。对于许多现代 LDAP 服务器，如 Open-LDAP，这现在是标准，但它们通常也支持旧版本 v2 的并行支持，因为各种客户端还不能实现
    v3。
- en: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
  id: totrans-677
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
- en: If the performance time of the plugin exceeds **``*`floating_point_dec`*``**
    seconds, it issues a warning.
  id: totrans-678
  prefs: []
  type: TYPE_NORMAL
  zh: 如果插件的执行时间超过 **``*`floating_point_dec`*``** 秒，它将发出警告。
- en: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
  id: totrans-679
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
- en: If the performance time of the plugin exceeds **``*`floating_point_dec`*``**
    seconds, it returns CRITICAL.
  id: totrans-680
  prefs: []
  type: TYPE_NORMAL
  zh: 如果插件的执行时间超过 **``*`floating_point_dec`*``** 秒，它将返回 CRITICAL。
- en: '**`-T`** **`/ --starttls`**'
  id: totrans-681
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-T`** **`/ --starttls`**'
- en: Uses the STARTTLS intended in LDAPv3.^([[68](#ftn.CHP-6-FN-21)])
  id: totrans-682
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 LDAPv3 中预期的 STARTTLS。^([[68](#ftn.CHP-6-FN-21)])
- en: '**`-S`** **`/ --ssl`**'
  id: totrans-683
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-S`** **`/ --ssl`**'
- en: Uses SSL encrypted LDAP (LDAPS) from LDAPv2 and at the same time sets the port
    used for this, port 636\. Whenever possible you should choose STARTTLS. LDAP with
    STARTTLS uses the same port as LDAP without SSL encryption; in many cases this
    allows the unencrypted LDAP access to be configured as a fallback for LDAP with
    STARTTLS. Such a fallback is not possible for LDAPS due to the different ports.
  id: totrans-684
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 SSL 加密的 LDAP（LDAPS）从 LDAPv2 开始，同时设置用于此的端口，端口 636。在可能的情况下，您应选择 STARTTLS。使用
    STARTTLS 的 LDAP 使用与未使用 SSL 加密的 LDAP 相同的端口；在许多情况下，这允许将未加密的 LDAP 访问配置为 STARTTLS
    的后备。由于端口不同，这种后备对于 LDAPS 是不可能的。
- en: 'In the simplest case it is sufficient to query whether the LDAP server really
    does own the base DN specified with **`-b`**:'
  id: totrans-685
  prefs: []
  type: TYPE_NORMAL
  zh: 在最简单的情况下，只需查询 LDAP 服务器是否真的拥有用 **`-b`** 指定的基准 DN 即可：
- en: '[PRE81]'
  id: totrans-686
  prefs: []
  type: TYPE_PRE
  zh: '[PRE81]'
- en: 'This query corresponds to the following command object:'
  id: totrans-687
  prefs: []
  type: TYPE_NORMAL
  zh: 此查询对应以下命令对象：
- en: '[PRE82]'
  id: totrans-688
  prefs: []
  type: TYPE_PRE
  zh: '[PRE82]'
- en: 'Since an LDAP server can handle many LDAP directories with different base DNs,
    it is recommended that you configure this with parameters:'
  id: totrans-689
  prefs: []
  type: TYPE_NORMAL
  zh: 由于 LDAP 服务器可以处理具有不同基准 DNs 的多个 LDAP 目录，建议您使用以下参数进行配置：
- en: '[PRE83]'
  id: totrans-690
  prefs: []
  type: TYPE_PRE
  zh: '[PRE83]'
- en: 'If authentication is involved, things get slightly more complicated. On the
    one hand the plugin is given the bind-DN of the **`nagios`** user, with **`-D`**.
    On the other hand, the following example protects the necessary password from
    curious onlookers by storing this as the macro **`$USER3$`** in the file **`resource.cfg`**,
    which may be readable only for the user **`nagios`** (see [2.14 The Resources
    File resource.cfg](../Text/ch02s14.html "2.14 The Resources File resource.cfg"),
    page 79):'
  id: totrans-691
  prefs: []
  type: TYPE_NORMAL
  zh: 如果涉及身份验证，事情会稍微复杂一些。一方面，插件被赋予**`nagios`**用户的绑定DN，使用**`-D`**。另一方面，以下示例通过将此密码存储为文件**`resource.cfg`**中的宏**`$USER3$**来保护必要的密码，该文件可能只有用户**`nagios`**可以读取（参见[2.14
    资源文件resource.cfg](../Text/ch02s14.html "2.14 资源文件resource.cfg")，第79页）。
- en: '[PRE84]'
  id: totrans-692
  prefs: []
  type: TYPE_PRE
  zh: '[PRE84]'
- en: 'Accordingly, the matching service definition contains the base DN and bind
    DN as arguments, but not the password:'
  id: totrans-693
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，匹配的服务定义包含基础DN和绑定DN作为参数，但不包含密码：
- en: '[PRE85]'
  id: totrans-694
  prefs: []
  type: TYPE_PRE
  zh: '[PRE85]'
- en: '* * *'
  id: totrans-695
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[67](#CHP-6-FN-20)]) A bind DN serves to identify the user and refers to
    the user's nodes in the directory tree, specifying all the overlying nodes. The
    bind DN in LDAP corresponds in its function more or less to the user name when
    logging in under Unix.
  id: totrans-696
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[67](#CHP-6-FN-20)]) 绑定DN用于识别用户，并指向目录树中用户的节点，指定所有上层节点。LDAP中的绑定DN在功能上与在Unix下登录时的用户名相对应。
- en: ^([[68](#CHP-6-FN-21)]) See footnote in [6.3.2 POP and IMAP](../Text/ch06s03.html#pop_and_imap
    "6.3.2 POP and IMAP").
  id: totrans-697
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[68](#CHP-6-FN-21)]) 请参阅[6.3.2 POP和IMAP](../Text/ch06s03.html#pop_and_imap
    "6.3.2 POP和IMAP")脚注。
- en: 6.10 Checking a DHCP Server
  id: totrans-698
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.10 检查DHCP服务器
- en: To monitor DHCP services, the plugin **`check_dhcp`** is available. It sends
    a **`DHCPDISCOVER`** via UDP broadcast to the target port 67 and waits for an
    offer from a DHCP server in the form of a **`DHCPOFFER`**, which offers an IP
    address and further configuration information.
  id: totrans-699
  prefs: []
  type: TYPE_NORMAL
  zh: 要监控DHCP服务，可用的插件是**`check_dhcp`**。它通过UDP广播发送**`DHCPDISCOVER`**到目标端口67，并等待DHCP服务器以**`DHCPOFFER`**的形式提供IP地址和进一步配置信息。
- en: Because **`check_dhcp`** does not send a **`DHCPREQUEST`** after this, the server
    does not need to reserve the sources and to confirm this reservation with **`DHCPACK`**,
    nor does it need to reject the request with **`DHCPNACK`**.
  id: totrans-700
  prefs: []
  type: TYPE_NORMAL
  zh: 因为**`check_dhcp`**在此之后不会发送**`DHCPREQUEST`**，所以服务器不需要保留源并使用**`DHCPACK`**确认此保留，也不需要使用**`DHCPNACK`**拒绝请求。
- en: Granting the plugin **`root`** permissions
  id: totrans-701
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 授予插件**`root`**权限
- en: Granting the plugin **`root`** permissions
  id: totrans-702
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 授予插件**`root`**权限
- en: 'There is a further restriction to the **`check_dhcp`**: it requires full access
    to the network interface and must therefore run with **`root`** privileges.'
  id: totrans-703
  prefs: []
  type: TYPE_NORMAL
  zh: 对**`check_dhcp`**有进一步的限制：它需要完全访问网络接口，因此必须以**`root`**权限运行。
- en: 'In order for the user **`nagios`** to be able to run the plugin with **`root`**
    permissions, the plugin must belong to the user **`root`** and the SUID bit must
    be set. If you install the plugins from a current tarball, the permissions will
    be set correctly. Several distributions disable the SUID bit, as it represents
    a potential danger—it is possible that general **`root`** permissions may slip
    in via buffer overflows in uncleanly programmed code. Here the program owner must
    be changed manually to the user **`root`** so that the SUID bit can be set with
    **`chmod`**. When this is done, only the group **`nagios`**, apart from **`root`**,
    is allowed to run the plugin:'
  id: totrans-704
  prefs: []
  type: TYPE_NORMAL
  zh: 为了让用户**`nagios`**能够以**`root`**权限运行插件，插件必须属于用户**`root`**，并且必须设置SUID位。如果您从当前的tarball安装插件，权限将被正确设置。一些发行版禁用了SUID位，因为它代表潜在的危险——可能通过不干净编程代码中的缓冲区溢出而使一般**`root`**权限泄露。在此，程序所有者必须手动更改为用户**`root`**，以便可以使用**`chmod`**设置SUID位。完成此操作后，只有组**`nagios`**（除了**`root`**之外）被允许运行插件：
- en: '[PRE86]'
  id: totrans-705
  prefs: []
  type: TYPE_PRE
  zh: '[PRE86]'
- en: The **`chown`** command assigns the plugin to the user **`root`** and to the
    group **`nagios`**, to whom nobody else should belong apart from the user **`nagios`**
    itself. (The user in whose name the Web server is running should be a member of
    a different group, such as **`nagcmd`**, as is described in [Chapter 1](../Text/ch01.html
    "Chapter 1. Installation") from page 37.)
  id: totrans-706
  prefs: []
  type: TYPE_NORMAL
  zh: '**`chown`**命令将插件分配给用户**`root`**和组**`nagios`**，除了用户**`nagios`**本身之外，不应属于其他任何人。（运行Web服务器的用户应该是不同组的成员，例如**`nagcmd`**，如[第1章](../Text/ch01.html
    "第1章。安装")第37页所述。）'
- en: In addition the **`chmod`** ensures that nobody apart from **`root`** may even
    read the plugin file, let alone edit it.
  id: totrans-707
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，**`chmod`**确保除了**`root`**之外没有人可以读取插件文件，更不用说编辑它。
- en: Applying the plugin
  id: totrans-708
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 应用插件
- en: '**`check_dhcp`** only the following options:'
  id: totrans-709
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_dhcp`** 仅以下选项：'
- en: '**`-s`** **``*`server_ip`*``** **`/ --serverip=`****``*`server_ip`*``**'
  id: totrans-710
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-s`** **``*`server_ip`*``** **`/ --serverip=`****``*`server_ip`*``**'
- en: This is the IP address of a DHCP server that the plugin should explicitly query.
    Without this entry, it is sufficient to have a functioning DHCP server in the
    network to pass the test satisfactorily. So you have to decide whether you want
    to test the general availability of the DHCP service or the functionality of a
    specific DHCP server.
  id: totrans-711
  prefs: []
  type: TYPE_NORMAL
  zh: 这是插件应明确查询的 DHCP 服务器的 IP 地址。如果没有此条目，只要网络中有一个功能正常的 DHCP 服务器，就可以通过测试。因此，您必须决定您是想测试
    DHCP 服务的总体可用性还是特定 DHCP 服务器的功能。
- en: '**`-r`** **``*`requested_ip`*``** **`/ --requestedip=`****``*`requested_ip`*``**'
  id: totrans-712
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** **``*`requested_ip`*``** **`/ --requestedip=`****``*`requested_ip`*``**'
- en: With this option the plugin attempts to obtain the IP address **``*`requested_ip`*``**
    from the server. If this is not successful because it is already reserved or lies
    outside the configured area, **`check_dhcp`** reacts with a warning.
  id: totrans-713
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此选项，插件尝试从服务器获取 **``*`请求的 IP 地址`*``**。如果由于它已被保留或位于配置区域之外而无法成功，**`check_dhcp`**
    将以警告响应。
- en: '**`-i`** **``*`interface`*``** **`/ --interface=`****``*`interface`*``**'
  id: totrans-714
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-i`** **``*`interface`*``** **`/ --interface=`****``*`interface`*``**'
- en: This selects a specific network interface through which the DHCP request should
    pass. Without this parameter, the plugin always uses the first network card to
    be configured (in Linux, usually **`ethO`**).
  id: totrans-715
  prefs: []
  type: TYPE_NORMAL
  zh: 这选择了一个特定的网络接口，通过该接口应通过 DHCP 请求。如果没有此参数，插件始终使用配置的第一个网络卡（在 Linux 中通常是 **`ethO`**）。
- en: '**`-m`** **``*`mac_address`*``** **`/ -mac=`****``*`mac_address`*``** (from
    version 1.4.10)'
  id: totrans-716
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-m`** **``*`mac_address`*``** **`/ -mac=`****``*`mac_address`*``** (从版本
    1.4.10 开始)'
- en: Uses the specified MAC address in DHCP queries instead of that of the Nagios
    server. This explicit detail is required if the DHCP server only assigns IP addresses
    to specific MAC addresses, and the MAC address of the Nagios server is not one
    of these.
  id: totrans-717
  prefs: []
  type: TYPE_NORMAL
  zh: 使用指定的 MAC 地址进行 DHCP 查询，而不是 Nagios 服务器的 MAC 地址。如果 DHCP 服务器只将 IP 地址分配给特定的 MAC
    地址，而 Nagios 服务器的 MAC 地址不在此列表中，则需要此明确细节。
- en: '**`-u`** **`/ --unicast`** (from version 1.4.10)'
  id: totrans-718
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u`** **`/ --unicast`** (从版本 1.4.10 开始)'
- en: Sends a unicast message instead of a broadcast.^([[69](#ftn.CHP-6-FN-22)]) The
    IP address to which the DHCP request is addressed is specified with **`-s`** **``*`server_ip`*``**.
  id: totrans-719
  prefs: []
  type: TYPE_NORMAL
  zh: 发送单播消息而不是广播.^([[69](#ftn.CHP-6-FN-22)]) DHCP 请求地址的 IP 地址由 **`-s`** **``*`server_ip`*``**
    指定。
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  id: totrans-720
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
- en: After **`10`** seconds have expired (the default), otherwise **``*`timeout`*``**
    seconds, the plugin stops the test and returns the CRITICAL state.
  id: totrans-721
  prefs: []
  type: TYPE_NORMAL
  zh: 经过 **`10`** 秒后（默认值），否则 **``*`超时`*``** 秒，插件停止测试并返回 CRITICAL 状态。
- en: With a configurable warning or critical limit for the performance time, the
    plugin is of no use. Here you must, where necessary, explicitly set a timeout,
    which causes the CRITICAL return value to be issued.
  id: totrans-722
  prefs: []
  type: TYPE_NORMAL
  zh: 如果性能时间有一个可配置的警告或临界限制，则插件没有用。在这种情况下，您必须根据需要显式设置超时，这将导致发出 CRITICAL 返回值。
- en: 'The following example shows that the DHCP service in the network is working:'
  id: totrans-723
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个示例显示网络中的 DHCP 服务正在运行：
- en: '[PRE87]'
  id: totrans-724
  prefs: []
  type: TYPE_PRE
  zh: '[PRE87]'
- en: The plugin includes only the **``*`lease time`*``** as additional information,
    that is, the time for which the client would be assigned an IP address. If you
    want to see all the information contained in **`DHCPOFFER`**, you should use the
    option **`-v`** ("verbose").
  id: totrans-725
  prefs: []
  type: TYPE_NORMAL
  zh: 插件仅包含额外的 **``*`租期`*``** 信息，即客户端将被分配 IP 地址的时间。如果您想查看 **`DHCPOFFER`** 中包含的所有信息，应使用选项
    **`-v`** ("详细")。
- en: 'In the next example the plugin explicitly requests a specific IP address (**`192.168.1.40`**),
    but this is not available:'
  id: totrans-726
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一个示例中，插件明确请求一个特定的 IP 地址（**`192.168.1.40`**），但这个地址不可用：
- en: '[PRE88]'
  id: totrans-727
  prefs: []
  type: TYPE_PRE
  zh: '[PRE88]'
- en: The result is a WARNING, as is shown by the output of the status, with **`$?`**.
  id: totrans-728
  prefs: []
  type: TYPE_NORMAL
  zh: 结果是一个警告，如状态输出所示，带有 **`$?`**。
- en: 'If you want to test both the availability of the DHCP service overall and the
    servers in question individually, you need two different commands:'
  id: totrans-729
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想测试 DHCP 服务的总体可用性和相关服务器，则需要两个不同的命令：
- en: '[PRE89]'
  id: totrans-730
  prefs: []
  type: TYPE_PRE
  zh: '[PRE89]'
- en: '**`check_dhcp_service`** grills the DHCP service as a whole by sending a broadcast,
    to which any DHCP server at all may respond.'
  id: totrans-731
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_dhcp_service`** 通过发送任何 DHCP 服务器都可能响应的广播来整体审查 DHCP 服务。'
- en: '[PRE90]'
  id: totrans-732
  prefs: []
  type: TYPE_PRE
  zh: '[PRE90]'
- en: '**`check_dhcp_server`** on the other hand explicitly tests the DHCP service
    on a specific server.'
  id: totrans-733
  prefs: []
  type: TYPE_NORMAL
  zh: 另一方面，**`check_dhcp_server`** 明确测试特定服务器上的 DHCP 服务。
- en: 'To match this, you can then define one service that monitors DHCP as a whole
    and another one that tests DHCP for a specific host. Even if the first variation
    is in principle not host-specific, it still needs to be assigned explicitly to
    a computer for it to run in Nagios:'
  id: totrans-734
  prefs: []
  type: TYPE_NORMAL
  zh: 为了匹配这些，你可以定义一个监控整个DHCP的服务，以及另一个测试特定主机的DHCP的服务。即使第一种变化在原则上不是针对特定主机的，它仍然需要明确分配给一台计算机，以便在Nagios中运行：
- en: '[PRE91]'
  id: totrans-735
  prefs: []
  type: TYPE_PRE
  zh: '[PRE91]'
- en: '* * *'
  id: totrans-736
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[69](#CHP-6-FN-22)]) A unicast message is addressed to exactly one IP address,
    whereas a broadcast message is meant for all stations in the local network.
  id: totrans-737
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[69](#CHP-6-FN-22)]) 单播消息针对的是确切的IP地址，而广播消息是针对本地网络中所有站点的。
- en: 6.11 Monitoring UPS with the Network UPS Tools
  id: totrans-738
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.11 使用网络不间断电源工具监控UPS
- en: 'There are two possibilities for monitoring uninterruptible power supplies (UPS):
    the *Network UPS Tools* support nearly all standard devices. The **`apcupsd`**
    daemon is specifically tailored to UPS''s from the company APC, described in [7.10
    Monitoring UPSs with apcupsd](../Text/ch07s10.html "7.10 Monitoring UPSs with
    apcupsd") from page 182\. The plugin **`check_ups`** included in Nagios only supports
    the first implementation.'
  id: totrans-739
  prefs: []
  type: TYPE_NORMAL
  zh: 监控不间断电源（UPS）有两种可能性：*网络不间断电源工具* 支持几乎所有标准设备。专门针对APC公司不间断电源的 **`apcupsd`** 守护进程，在[7.10
    使用apcupsd监控UPS](../Text/ch07s10.html "7.10 使用apcupsd监控UPS") 一节中描述，见第182页。Nagios中包含的插件
    **`check_ups`** 只支持第一种实现。
- en: 'The following rule generally applies: no plugin directly accesses the UPS interface.
    Rather they rely on a corresponding daemon that monitors the UPS and provides
    status information. This daemon primarily serves the purpose of shutting down
    the connected servers in time in case of a power failure. But it also always provides
    status information, which plugins can query and which can be processed by Nagios.'
  id: totrans-740
  prefs: []
  type: TYPE_NORMAL
  zh: 以下规则通常适用：没有插件直接访问UPS接口。相反，它们依赖于相应的守护进程，该守护进程监控UPS并提供状态信息。此守护进程的主要目的是在电力故障发生时及时关闭连接的服务器。但它也始终提供状态信息，插件可以查询这些信息，并且Nagios可以处理这些信息。
- en: Both the solution with the Network UPS Tools and that with **`apcupsd`** are
    fundamentally network-capable, that is, the daemon is always queried via TCP/IP
    (through a proprietary protocol, or alternatively SNMP). But you should be aware
    here that a power failure may affect the transmission path, so that the corresponding
    information might no longer even reach Nagios. Monitoring via the network therefore
    makes sense only if the entire network path is safeguarded properly against power
    failure. In the ideal scenario, the UPS is connected directly to the Nagios server.
    Calling the **`check_ups`** plugin is no different in this case from that for
    the network configuration, since even for local use it communicates via TCP/IP—but
    in this case, with the host **`localhost`**.
  id: totrans-741
  prefs: []
  type: TYPE_NORMAL
  zh: 网络不间断电源工具包的解决方案和 **`apcupsd`** 的解决方案在本质上都是网络兼容的，也就是说，守护进程总是通过TCP/IP（通过专有协议，或者通过SNMP）进行查询。但你应该意识到，电力故障可能会影响传输路径，因此相应的信息可能甚至无法到达Nagios。因此，只有当整个网络路径得到适当的电力故障保护时，通过网络进行监控才有意义。在理想场景中，UPS直接连接到Nagios服务器。在这种情况下调用
    **`check_ups`** 插件与网络配置没有区别，因为即使对于本地使用，它也是通过TCP/IP进行通信的——但在这个情况下，使用主机 **`localhost`**。
- en: The Network UPS Tools
  id: totrans-742
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 网络不间断电源工具
- en: The Network UPS Tools
  id: totrans-743
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 网络不间断电源工具
- en: The Network UPS Tools is a manufacturer-independent package containing tools
    for monitoring uninterruptible power supplies. Different specific drivers take
    care of hardware access, so that new power supplies can be easily supported, provided
    their protocols are known.
  id: totrans-744
  prefs: []
  type: TYPE_NORMAL
  zh: 网络不间断电源工具包是一个制造商独立的软件包，包含用于监控不间断电源的工具。不同的特定驱动程序负责硬件访问，因此可以轻松支持新的电源供应，前提是它们的协议是已知的。
- en: 'The remaining functionality is also spread across various programs: while the
    daemon **`upsd`** provides information, the program **`upsmon`** shuts down the
    computers supplied by the UPS in a controlled manner. It takes care both of machines
    connected via serial interface to the UPS and, in client/ server mode, of computers
    supplied via the network.'
  id: totrans-745
  prefs: []
  type: TYPE_NORMAL
  zh: 剩余的功能也分布在各种程序中：而守护进程 **`upsd`** 提供信息，程序 **`upsmon`** 以受控方式关闭由不间断电源（UPS）供电的计算机。它既负责通过串行接口连接到UPS的机器，也在客户端/服务器模式下负责通过网络供电的计算机。
- en: '[http://www.networkupstools.org/](http://www.networkupstools.org/) lists the
    currently supported models and provides further information on the topic of UPS.
    Standard distributions already contain the software, but not always with package
    names that are very obvious: in SuSE and Debian they are known by the name of
    **`nut`**.'
  id: totrans-746
  prefs: []
  type: TYPE_NORMAL
  zh: '[http://www.networkupstools.org/](http://www.networkupstools.org/)列出了目前支持的型号，并提供了有关UPS主题的更多信息。标准发行版已经包含了软件，但并不总是包含非常明显的包名：在SuSE和Debian中，它们以**`nut`**命名。'
- en: To query the information provided by the daemon **`upsd`**, there is the **`check_ups`**
    plugin from the Nagios Plugin package. It queries the status of the UPS through
    the network UPS Tools' own network protocol. A subproject also allows it to query
    the power supplies via SNMP.^([[70](#ftn.CHP-6-FN-23)]) However, further development
    on it is not taking place at the present time.
  id: totrans-747
  prefs: []
  type: TYPE_NORMAL
  zh: 要查询由守护进程**`upsd`**提供的信息，有来自Nagios插件包的**`check_ups`**插件。它通过网络UPS工具自己的网络协议查询UPS的状态。一个子项目还允许它通过SNMP查询电源供应。然而，目前没有对其进行进一步开发。
- en: For purely monitoring purposes via Nagios (without shutting down the computer
    automatically, depending on the test result), it is sufficient to configure and
    start the **`upsd`** on the host to which the UPS is connected via serial cable.
    The relevant configuration file in the directory **`/etc/nut`** is called **`ups.conf`**.
    If you perform the query via the network, you must normally add an entry for the
    Nagios server in the (IP-based) access permissions. Detailed information can be
    found directly in the files themselves or in the documentation included, which
    in Debian is in the directory **`/usr/share/doc/nut`**, and in SuSE, in **`/usr/share/doc/packages/nut`**.
  id: totrans-748
  prefs: []
  type: TYPE_NORMAL
  zh: 仅通过Nagios进行纯粹监控（不根据测试结果自动关闭计算机），在通过串行线连接UPS的主机上配置并启动**`upsd`**就足够了。目录**`/etc/nut`**中的相关配置文件名为**`ups.conf`**。如果您通过网络进行查询，通常需要在（基于IP的）访问权限中添加Nagios服务器的条目。详细信息可以直接在文件本身或包含的文档中找到，在Debian中位于目录**`/usr/share/doc/nut`**，在SuSE中位于**`/usr/share/doc/packages/nut`**。
- en: 'Provided that the Network UPS Tools include a suitable driver for the uninterruptable
    power supply used, the driver and communication interface are entered in the file
    **`ups.conf`**:'
  id: totrans-749
  prefs: []
  type: TYPE_NORMAL
  zh: 假设网络UPS工具包括用于不间断电源的合适驱动程序，驱动程序和通信接口将输入到**`ups.conf`**文件中：
- en: '[PRE92]'
  id: totrans-750
  prefs: []
  type: TYPE_PRE
  zh: '[PRE92]'
- en: 'In the example, a UPS of the company APC is used. Communication takes place
    on the serial interface **`/dev/ttySO`**. A name for the UPS is given in square
    brackets, with which it is addressed later on: **`desc`** can be used to describe
    the intended purpose of the UPS in more detail, but Nagios ignores this.'
  id: totrans-751
  prefs: []
  type: TYPE_NORMAL
  zh: 在示例中，使用了公司APC的UPS。通信通过串行接口**`/dev/ttySO`**进行。在方括号中给出了UPS的名称，稍后通过该名称进行寻址：**`desc`**可以用来更详细地描述UPS的预期用途，但Nagios会忽略这一点。
- en: 'Next you must ensure that the user with whose permissions the Network UPS Tools
    are running (such as the user **`nut`** from the group **`nut`**) has full access
    to the interface **`/dev/ttySO`**:'
  id: totrans-752
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，您必须确保运行网络UPS工具的用户（例如来自**`nut`**组的用户**`nut`**）具有对接口**`/dev/ttySO`**的完全访问权限：
- en: '[PRE93]'
  id: totrans-753
  prefs: []
  type: TYPE_PRE
  zh: '[PRE93]'
- en: 'In order for Nagios to access information from the UPS via the **`upsd`** daemon,
    corresponding data is entered in an Access Control List in the **`upsd`** configuration
    file **`upsd.conf`**:'
  id: totrans-754
  prefs: []
  type: TYPE_NORMAL
  zh: 为了让Nagios通过**`upsd`**守护进程访问UPS的信息，需要在**`upsd`**配置文件**`upsd.conf`**中输入相应的数据：
- en: '[PRE94]'
  id: totrans-755
  prefs: []
  type: TYPE_PRE
  zh: '[PRE94]'
- en: 'With the keyword **`ACL`** you first define hosts and network ranges with their
    IP address. You must always specify a network block here: **`/32`** means that
    all 32 bits of the netmask are set to 1 (this corresponds to 255.255.255.255),
    which is therefore a single host address. It is not sufficient just to specify
    the IP address here.'
  id: totrans-756
  prefs: []
  type: TYPE_NORMAL
  zh: 使用关键字**`ACL`**，您首先定义主机和网络范围及其IP地址。您必须始终在此指定一个网络块：**`/32`**表示网络掩码的所有32位都设置为1（这对应于255.255.255.255），因此是一个单独的主机地址。仅指定IP地址是不够的。
- en: An **`ACCEPT`** entry allows access for the computer specified in the ACL **``*`acl-name`*``**.
    **`ACCEPT`** rules may be used more than once. The final **`REJECT`** entry then
    refuses access to all other hosts.
  id: totrans-757
  prefs: []
  type: TYPE_NORMAL
  zh: '**`ACCEPT`**条目允许在ACL **``*`acl-name`*``**中指定的计算机访问。**`ACCEPT`**规则可以多次使用。最后的**`REJECT`**条目拒绝所有其他主机的访问。'
- en: To conclude the configuration, you should make sure that the UPS daemon is started
    with every system start. In SuSE this is done via YaST2; in Debian this is taken
    care of during the installation.
  id: totrans-758
  prefs: []
  type: TYPE_NORMAL
  zh: 要完成配置，你应该确保UPS守护进程在每次系统启动时启动。在SuSE中，这是通过YaST2完成的；在Debian中，这是在安装过程中处理的。
- en: The check_ups plugin
  id: totrans-759
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 这是检查UPS插件。
- en: 'The monitoring plugin itself has the following options:'
  id: totrans-760
  prefs: []
  type: TYPE_NORMAL
  zh: 监控插件本身有以下选项：
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  id: totrans-761
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
- en: This is the computer on which **`upsd`** is installed.
  id: totrans-762
  prefs: []
  type: TYPE_NORMAL
  zh: 这是安装**`upsd`**的计算机。
- en: '**`-u`** **``*`identifier`*``** **`/ --ups=`****``*`identifier`*``**'
  id: totrans-763
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u`** **``*`identifier`*``** **`/ --ups=`****``*`identifier`*``**'
- en: This is the name for the UPS in **`ups.conf`**, specified in square brackets.
  id: totrans-764
  prefs: []
  type: TYPE_NORMAL
  zh: 这是**`ups.conf`**中UPS的名称，用方括号指定。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-765
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: This is the number of the port on which the **`upsd`** is running. The default
    is TCP port 3493.
  id: totrans-766
  prefs: []
  type: TYPE_NORMAL
  zh: 这是**`upsd`**运行的端口号。默认是TCP端口3493。
- en: '**`-w`** **``*`whole_number`*``** **`/ --warning=`****``*`whole_number`*``**'
  id: totrans-767
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`whole_number`*``** **`/ --warning=`****``*`whole_number`*``**'
- en: 'This switch defines a warning limit as a whole number. If no variable is given
    (see **`-v`**), **``*`whole_number`*``** means a response time in seconds; otherwise
    the value range of the variable (e.g., **`80`** for 80% in **`BATTPCT`**). Specifying
    multiple warning limits is currently not possible: the plugin then only uses the
    last variable and the last warning limit.'
  id: totrans-768
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关定义一个警告极限为整数。如果没有给出变量（参见**`-v`**），**``*`whole_number`*``**表示秒数响应时间；否则，变量的值范围（例如，**`80`**表示**`BATTPCT`**中的80%）。目前无法指定多个警告极限：插件将仅使用最后一个变量和最后一个警告极限。
- en: '**`-c`** **``*`whole_number`*``** **`/ --critical=`****``*`whole_number`*``**'
  id: totrans-769
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`whole_number`*``** **`/ --critical=`****``*`whole_number`*``**'
- en: This option specifies a critical limit in connection with a variable (see **`-v`**).
  id: totrans-770
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项指定与变量相关的临界极限（参见**`-v`**）。
- en: '**`-v`** **``*`variable`*``** **`/ --variable=`****``*`variable`*``**'
  id: totrans-771
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-v`** **``*`variable`*``** **`/ --variable=`****``*`variable`*``**'
- en: 'With this option, specific values of the UPS can be queried. The limit values
    then referred to this parameter. **`check_ups`** currently supports only the following
    variables:'
  id: totrans-772
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此选项，可以查询UPS的特定值。然后引用此参数的极限值。**`check_ups`**当前仅支持以下变量：
- en: '**`LINE:`**'
  id: totrans-773
  prefs: []
  type: TYPE_NORMAL
  zh: '**`LINE:`**'
- en: input voltage of the UPS.
  id: totrans-774
  prefs: []
  type: TYPE_NORMAL
  zh: UPS的输入电压。
- en: '**`TEMP:`**'
  id: totrans-775
  prefs: []
  type: TYPE_NORMAL
  zh: '**`TEMP:`**'
- en: Temperature of the USV.
  id: totrans-776
  prefs: []
  type: TYPE_NORMAL
  zh: USV的温度。
- en: '**`BATTPCT:`**'
  id: totrans-777
  prefs: []
  type: TYPE_NORMAL
  zh: '**`BATTPCT:`**'
- en: Remaining battery capacity in percent.
  id: totrans-778
  prefs: []
  type: TYPE_NORMAL
  zh: 剩余电池容量百分比。
- en: '**`LOADPCT:`**'
  id: totrans-779
  prefs: []
  type: TYPE_NORMAL
  zh: '**`LOADPCT:`**'
- en: Load on the UPS in percent.
  id: totrans-780
  prefs: []
  type: TYPE_NORMAL
  zh: UPS上的负载百分比。
- en: If this option is missing, the plugin only checks the status of the UPS (online
    or offline).
  id: totrans-781
  prefs: []
  type: TYPE_NORMAL
  zh: 如果缺少此选项，插件将只检查UPS的状态（在线或离线）。
- en: Since **`-v`** thus has another value, **`check_ups`** does not know the obligatory
    option **`--verbose`** (see [Table 6-2](../Text/ch06.html#standard_options_of_plugins
    "Table 6-2. Standard options of plugins") in page 108), even in its long form.
  id: totrans-782
  prefs: []
  type: TYPE_NORMAL
  zh: 由于**`-v`**具有另一个值，**`check_ups`**不知道强制选项**`--verbose`**（参见第108页的[表6-2](../Text/ch06.html#standard_options_of_plugins
    "表6-2. 插件的标准选项")），即使在其长形式中也是如此。
- en: '**`-T /--temperature`**'
  id: totrans-783
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-T /--temperature`**'
- en: This command issues temperature values in degrees Celsius instead of Fahrenheit.
  id: totrans-784
  prefs: []
  type: TYPE_NORMAL
  zh: 此命令以摄氏度而不是华氏度发布温度值。
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  id: totrans-785
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
- en: After **``*`timeout`*``** seconds have expired, the plugin stops the test and
    returns the CRITICAL state. The default is **`10`** seconds.
  id: totrans-786
  prefs: []
  type: TYPE_NORMAL
  zh: 经过**``*`timeout`*``**秒后，插件停止测试并返回CRITICAL状态。默认是**`10`**秒。
- en: 'The following example tests the above defined local UPS with the name **`upsfw`**.
    The **`-T`** switch ensures that the output of the temperature is given in degrees
    Celsius:'
  id: totrans-787
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例测试了上面定义的名为**`upsfw`**的本地不间断电源（UPS）。**`-T`**开关确保温度输出以摄氏度为单位：
- en: '[PRE95]'
  id: totrans-788
  prefs: []
  type: TYPE_PRE
  zh: '[PRE95]'
- en: If a variable is not used, the plugin returns a CRITICAL if the UPS is switched
    off (**`Status=Off`**) or has reached low battery capacity (**`Status=0n Battery,
    Low Battery`**). **`check_ups`** issues a warning if at least one of the three
    states **`On Battery`**, **`Low Battery`**, or **`Replace Battery`** applies,
    but this is not sufficient for a CRITICAL status (for example, because of correspondingly
    set variables). With **`On Battery`** the power supply is provided by the battery,
    with **`Low Battery`** the UPS is online with a low battery state, and with **`Replace
    Battery`**, the battery must be replaced.
  id: totrans-789
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一个变量未被使用，当UPS关闭（**`状态=关闭`**）或已达到低电池容量（**`状态=0n电池，低电池`**）时，插件返回CRITICAL。**`check_ups`**如果至少有一个三个状态**`电池供电`**、**`低电池`**或**`更换电池`**适用，则发出警告，但这不足以达到CRITICAL状态（例如，因为相应设置的变量）。在**`电池供电`**状态下，电源由电池提供，在**`低电池`**状态下，UPS在线但电池电量低，在**`更换电池`**状态下，必须更换电池。
- en: 'If none of these points apply, the plugin issues an OK for the following states:'
  id: totrans-790
  prefs: []
  type: TYPE_NORMAL
  zh: 如果这些点都不适用，插件将为以下状态发出OK：
- en: In the normal **`online`** state
  id: totrans-791
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在正常的**`在线`**状态下
- en: If the UPS is being calibrated (**`Calibrating`**)
  id: totrans-792
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果UPS正在校准（**`校准`**）
- en: If it is currently being bypassed and the power supply is provided directly
    from the power supply grid (**`On Bypass`**)
  id: totrans-793
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果它目前正在旁路，并且电源直接从电源电网提供（**`旁路`**）
- en: If the UPS is overloaded (**`Overload`**)
  id: totrans-794
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果UPS过载（**`过载`**）
- en: If the voltage in the power grid is too high and the UPS restricts the voltage
    to the normal value (**`Trimming`**)
  id: totrans-795
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果电网电压过高，UPS将电压限制在正常值（**`调整`**）
- en: If the voltage in the power grid is too low and is supplemented by the UPS (**`Boosting`**)
  id: totrans-796
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果电网电压过低，并由UPS补充（**`提升`**）
- en: If the UPS is currently being charged (**`Charging`**)
  id: totrans-797
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果UPS目前正在充电（**`充电`**）
- en: If the UPS is currently being discharged (e.g., during a programmed maintenance
    procedure) (**`Discharging`**)
  id: totrans-798
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果不间断电源（UPS）目前正在放电（例如，在计划中的维护程序期间）(**`放电`**)
- en: 'Transformed into a command object, the above test for any host looks like this:'
  id: totrans-799
  prefs: []
  type: TYPE_NORMAL
  zh: 将上述测试转换为命令对象，对于任何主机看起来是这样的：
- en: '[PRE96]'
  id: totrans-800
  prefs: []
  type: TYPE_PRE
  zh: '[PRE96]'
- en: 'The corresponding service definition for the computer **`linux01`**, to which
    the UPS is connected, and for the above defined UPS **`upsfw`**, would then look
    like this:'
  id: totrans-801
  prefs: []
  type: TYPE_NORMAL
  zh: 对于连接到计算机**`linux01`**（UPS连接的计算机）和上述定义的UPS**`upsfw`**的相应服务定义将如下所示：
- en: '[PRE97]'
  id: totrans-802
  prefs: []
  type: TYPE_PRE
  zh: '[PRE97]'
- en: 'If **`check_ups`** is to determine the UPS status by means of the current load,
    the relevant information is taken from the variable **`LOADPCT`**:'
  id: totrans-803
  prefs: []
  type: TYPE_NORMAL
  zh: 如果**`check_ups`**要通过当前负载确定UPS状态，则相关信息从变量**`LOADPCT`**中获取：
- en: '[PRE98]'
  id: totrans-804
  prefs: []
  type: TYPE_PRE
  zh: '[PRE98]'
- en: With 61 percent, the UPS has a heavier load than specified in the limit value
    **`-w`**, but it does not yet reach the critical area above 80 percent, so there
    is just a warning. If two error criteria occur, such as a warning limit for a
    queried variable being exceeded and a critical state simultaneously, because the
    UPS is losing power (**`On Battery`** and **`Low Battery`** simultaneously), the
    most critical state has priority for the return value of the plugin, so here,
    **`check_ups`** would return CRITICAL, and not the WARNING which results from
    the query of **`LOADPCT`**.
  id: totrans-805
  prefs: []
  type: TYPE_NORMAL
  zh: UPS的负载比限制值**`-w`**指定的负载重61%，但尚未达到80%以上的临界区域，因此只是警告。如果出现两个错误标准，例如查询变量的警告限制被超过和同时处于临界状态，因为UPS正在失去电力（**`电池供电`**和**`低电池`**同时），则最关键的返回值状态具有优先级，因此在这里，**`check_ups`**将返回CRITICAL，而不是由**`LOADPCT`**查询产生的WARNING。
- en: '* * *'
  id: totrans-806
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[70](#CHP-6-FN-23)]) [http://eul.networkupstools.org/server-projects/](http://eul.networkupstools.org/server-projects/)
  id: totrans-807
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[70](#CHP-6-FN-23)]) [http://eul.networkupstools.org/server-projects/](http://eul.networkupstools.org/server-projects/)
- en: 6.12 Health Check of an NTP Server with **`check_ntp_peer`**
  id: totrans-808
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 6.12 使用**`check_ntp_peer`**检查NTP服务器健康
- en: The plugin **`check_ntp_peer`**, which is included from plugin version 1.4.11,
    tests the quality of an NTP server. If you want to check the time deviation of
    a local server against an NTP server, you need to use the plugin **`check_ntp_time`**,
    described in [7.7.1 Checking the system time via NTP](../Text/ch07s07.html#checking_the_system_time_via_ntp
    "7.7.1 Checking the system time via NTP") in page 177.
  id: totrans-809
  prefs: []
  type: TYPE_NORMAL
  zh: 从插件版本1.4.11开始包含的插件**`check_ntp_peer`**测试NTP服务器的质量。如果您想检查本地服务器与NTP服务器的时间偏差，您需要使用在[7.7.1
    通过NTP检查系统时间](../Text/ch07s07.html#checking_the_system_time_via_ntp "7.7.1 通过NTP检查系统时间")页面177中描述的插件**`check_ntp_time`**。
- en: 'Several parameters characterize the quality: the *offset* describes the time
    difference from other NTP servers (the reference servers). *Jitter* is a measurement
    of the fluctuations in the packet delay to a remote reference server, and *stratum*
    specifies the topological distance from the next atomic clock. Stratum 0 is the
    atomic clock itself, stratum 1 refers to an NTP server directly connected to an
    atomic clock. Stratum 2 is an NTP server that obtains its time from an NTP server
    with stratum 1\. The further an NTP server is away from the atomic clock, the
    higher the stratum value. The imprecision of the server also increases the higher
    this value is.'
  id: totrans-810
  prefs: []
  type: TYPE_NORMAL
  zh: 几个参数表征了质量：*偏移*描述了与其他 NTP 服务器（参考服务器）的时间差。*抖动*是测量到远程参考服务器的数据包延迟波动的度量，而*分层*指定了到下一个原子钟的拓扑距离。分层
    0 是原子钟本身，分层 1 指的是直接连接到原子钟的 NTP 服务器。分层 2 是从分层 1 的 NTP 服务器获取时间的 NTP 服务器。NTP 服务器离原子钟越远，分层值就越高。服务器的精度越高，这个值也越高。
- en: 'These parameters can also be queried with the program **`ntpq`**, by giving
    the IP address of the NTP server. The option **`-p`** reveals the reference server
    from which the queried NTP server obtains its time details. The option **`-n`**
    prevents name resolution on the reference servers, thus accelerating the execution
    of **`ntpq`**:'
  id: totrans-811
  prefs: []
  type: TYPE_NORMAL
  zh: 这些参数也可以通过程序 **`ntpq`** 进行查询，通过提供 NTP 服务器的 IP 地址。选项 **`-p`** 显示了查询的 NTP 服务器获取时间详情的参考服务器。选项
    **`-n`** 防止在参考服务器上进行名称解析，从而加速 **`ntpq`** 的执行：
- en: '[PRE99]'
  id: totrans-812
  prefs: []
  type: TYPE_PRE
  zh: '[PRE99]'
- en: The **`remote`** column specifies the reference server that uses the queried
    NTP server. **`127.127.1.1`** here is a special case, and stands for the local
    system clock. The stratum value (column **`st`**), with **`10`**, is relatively
    high, but the local system clock only plays a role if no other NTP source can
    is reachable. The other two quality parameters, offset and jitter, are located
    in the last two columns.
  id: totrans-813
  prefs: []
  type: TYPE_NORMAL
  zh: '**`remote`** 列指定了使用查询的 NTP 服务器的参考服务器。**`127.127.1.1`** 是一个特殊情况，代表本地系统时钟。分层值（列
    **`st`**），**`10`**，相对较高，但只有当没有其他 NTP 源可达时，本地系统时钟才起作用。其他两个质量参数，偏移和抖动，位于最后两列。'
- en: 'In the simplest case you can run **`check_ntp_peer`**, specifying only the
    NTP server to be checked (option **`-H`**):'
  id: totrans-814
  prefs: []
  type: TYPE_NORMAL
  zh: 在最简单的情况下，您可以运行 **`check_ntp_peer`**，仅指定要检查的 NTP 服务器（选项 **`-H`**）：
- en: '[PRE100]'
  id: totrans-815
  prefs: []
  type: TYPE_PRE
  zh: '[PRE100]'
- en: 'Without further details the plugin checks the time deviation from the reference
    servers, and the stratum and jitter are not taken into account. All threshold
    details from **`check_ntp_peer`** are specified in the format described in [24.1.5
    Specifying thresholds](../Text/ch24.html#specifying_thresholds "24.1.5 Specifying
    thresholds") from page 557\. The plugin has the following options:'
  id: totrans-816
  prefs: []
  type: TYPE_NORMAL
  zh: 没有进一步详情的情况下，插件会检查与参考服务器的时间偏差，并且不考虑分层和抖动。所有来自 **`check_ntp_peer`** 的阈值详情都按照 [24.1.5
    指定阈值](../Text/ch24.html#specifying_thresholds "24.1.5 指定阈值") 中描述的格式指定，该格式位于第 557
    页。插件有以下选项：
- en: '**`-H`** **``*`address`*``** **`/ -host=`****``*`address`*``**'
  id: totrans-817
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`地址`*``** **`/ -host=`****``*`地址`*``**'
- en: This is the name or IP address of the NTP server to be checked.
  id: totrans-818
  prefs: []
  type: TYPE_NORMAL
  zh: 这是待检查的 NTP 服务器的名称或 IP 地址。
- en: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
  id: totrans-819
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`端口`*``** **`/--端口=`****``*`端口`*``**'
- en: This is the UDP port on which the NTP server is listening. The default is port
    **`123`**.
  id: totrans-820
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 NTP 服务器监听的 UDP 端口。默认端口是 **`123`**。
- en: '**`-q`** **`/--quiet`**'
  id: totrans-821
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-q`** **`/--静默`**'
- en: This returns UNKNOWN instead of WARNING or CRITICAL if the NTP server is not
    synchronized.
  id: totrans-822
  prefs: []
  type: TYPE_NORMAL
  zh: 如果 NTP 服务器未同步，则返回 UNKNOWN 而不是 WARNING 或 CRITICAL。
- en: '**`-w`** **``*`threshold`*``** **`/ -warning=`****``*`threshold`*``**'
  id: totrans-823
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`阈值`*``** **`/ -warning=`****``*`阈值`*``**'
- en: This is the warning threshold for the time deviation. A warning is issued if
    the time deviation between the NTP server and at least one of the reference servers
    is greater than the specified number of seconds. The default is **`60`** seconds.
  id: totrans-824
  prefs: []
  type: TYPE_NORMAL
  zh: 这是时间偏差的警告阈值。如果 NTP 服务器与至少一个参考服务器的时间偏差大于指定的秒数，则发出警告。默认是 **`60`** 秒。
- en: '**`-c`** **``*`seconds`*``** **`/ -critical=`****``*`seconds`*``**'
  id: totrans-825
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`秒`*``** **`/ -critical=`****``*`秒`*``**'
- en: 'This is the critical threshold for the time deviation. If the time of one of
    the reference servers used deviates by more than **``*`seconds`*``** seconds (in
    the default: **`120`**) from that of the NTP server, the state becomes CRITICAL.'
  id: totrans-826
  prefs: []
  type: TYPE_NORMAL
  zh: 这是时间偏差的临界阈值。如果使用的某个参考服务器的时间与 NTP 服务器的时间偏差超过 **``*`秒`*``** 秒（默认为 **`120`**），则状态变为
    CRITICAL。
- en: '**`-W`** **``*`threshold`*``** **`/ -swarn=`****``*`threshold`*``**'
  id: totrans-827
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-W`** **``*`阈值`*``** **`/ -swarn=`****``*`阈值`*``**'
- en: This is the warning threshold based on the stratum value. A warning is issued
    if no reference server is available whose stratum value matches the specified
    threshold. This means that **`-W 1:2`** causes a WARNING if no reference server
    is available with stratum 1 or stratum 2\. Without the detail of this parameter
    the stratum value is not included in the check.
  id: totrans-828
  prefs: []
  type: TYPE_NORMAL
  zh: 这是基于stratum值的警告阈值。如果没有可用的参考服务器其stratum值与指定的阈值匹配，则发出警告。这意味着**`-W 1:2`**如果没有可用的参考服务器具有stratum
    1或stratum 2，则引起警告。如果没有此参数的详细信息，则stratum值不包括在检查中。
- en: '**`-C`** **``*`threshold`*``** **`/ -scrit=`****``*`threshold`*``**'
  id: totrans-829
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`阈值`*``** **`/ -scrit=`****``*`阈值`*``**'
- en: This is the critical threshold based on the stratum value. See **`-W`**.
  id: totrans-830
  prefs: []
  type: TYPE_NORMAL
  zh: 这是基于stratum值的临界阈值。见**`-W`**。
- en: '**`-j`** **``*`threshold`*``** **`/ -jwarn=`****``*`threshold`*``**'
  id: totrans-831
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-j`** **``*`阈值`*``** **`/ -jwarn=`****``*`阈值`*``**'
- en: This is the warning threshold for the jitter in milliseconds, given in the threshold
    format. The plugin returns OK if at least one reference server displays a jitter
    within the specified range. If this option is not given, the jitter is not included
    in the evaluation; there is no default.
  id: totrans-832
  prefs: []
  type: TYPE_NORMAL
  zh: 这是毫秒级的抖动警告阈值，以阈值格式给出。如果至少有一个参考服务器在指定的范围内显示抖动，则插件返回OK。如果没有给出此选项，则抖动不包括在评估中；没有默认值。
- en: '**`-k`** **``*`threshold`*``** **`/ -jcrit=`****``*`threshold`*``**'
  id: totrans-833
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-k`** **``*`阈值`*``** **`/ -jcrit=`****``*`阈值`*``**'
- en: This is the critical threshold for the jitter in milliseconds in the threshold
    format.
  id: totrans-834
  prefs: []
  type: TYPE_NORMAL
  zh: 这是阈值格式中抖动的临界阈值。
- en: Chapter 7. Testing Local Resources
  id: totrans-835
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第7章。测试本地资源
- en: The plugins introduced in this chapter, originating from the **`nagios-plugins`**
    package,^([[71](#ftn.CHP-7-FN-1)]) test local resources that do not have their
    own network protocol and therefore cannot be easily queried over the network.
    They must therefore be locally installed on the computer to be tested. Such plugins
    on the Nagios server can test only the server itself—with command and service
    definitions as described in [Chapter 6](../Text/ch06.html "Chapter 6. Plugins
    for Network Services").
  id: totrans-836
  prefs: []
  type: TYPE_NORMAL
  zh: 本章介绍的插件来自**`nagios-plugins`**包，^([[71](#ftn.CHP-7-FN-1)]) 测试没有自己的网络协议的本地资源，因此不能轻易通过网络查询。因此，它们必须安装在被测试的计算机上。Nagios服务器上的此类插件只能测试服务器本身——命令和服务定义如第6章[网络服务插件](../Text/ch06.html
    "第6章。网络服务插件")中所述。
- en: 'To perform such local tests from a central Nagios server on remote hosts, you
    require further utilities: the plugins are started via a secure shell, or you
    use the *Nagios Remote Plugin Executor* (NRPE). Using the secure shell is described
    in [Chapter 9](../Text/ch09.html "Chapter 9. Executing Plugins via SSH") from
    page 205, and [Chapter 10](../Text/ch10.html "Chapter 10. The Nagios Remote Plugin
    Executor (NRPE)") (page 213) is devoted to NRPE.'
  id: totrans-837
  prefs: []
  type: TYPE_NORMAL
  zh: 要从中央Nagios服务器对远程主机执行此类本地测试，你需要额外的工具：插件通过安全外壳启动，或者你使用*Nagios远程插件执行器*（NRPE）。使用安全外壳的描述见第9章[通过SSH执行插件](../Text/ch09.html
    "第9章。通过SSH执行插件"，第205页)，以及第10章[第10章。Nagios远程插件执行器（NRPE）](../Text/ch10.html "第10章。Nagios远程插件执行器（NRPE）")（第213页）专门介绍了NRPE。
- en: The definition of command and service depends on the choice of mechanism. If
    you want to test for free hard drive capacity with the **`check_by_ssh`** plugin
    installed on the Nagios server, which remotely calls **`check_disk`** on the target
    server (see [Chapter 7](../Text/ch07.html "Chapter 7. Testing Local Resources"),
    page 157), then a special command definition is required for this, which differs
    somewhat from the definitions given in [Chapter 6](../Text/ch06.html "Chapter 6. Plugins
    for Network Services") (page 105). What command and service definitions for remotely
    executed local plugins look like is described in the aforementioned chapters on
    NRPE and SSH.
  id: totrans-838
  prefs: []
  type: TYPE_NORMAL
  zh: 命令和服务的定义取决于机制的选择。如果你想在安装了**`check_by_ssh`**插件的Nagios服务器上测试空闲硬盘容量，该插件远程调用目标服务器上的**`check_disk`**（见第7章[测试本地资源](../Text/ch07.html
    "第7章。测试本地资源"，第157页)），则需要为此定义一个特殊的命令，这与第6章[网络服务插件](../Text/ch06.html "第6章。网络服务插件")（第105页）中给出的定义有所不同。远程执行本地插件看起来像什么命令和服务定义在前面提到的NRPE和SSH章节中描述。
- en: For the remote query of some local resources you can also use SNMP (see [Chapter 11](../Text/ch11.html
    "Chapter 11. Collecting Information Relevant for Monitoring with SNMP") from page
    227), but the checks are then restricted to the capabilities of the SNMP daemon
    used. Local plugins are usually more flexible here and provide more options for
    querying.
  id: totrans-839
  prefs: []
  type: TYPE_NORMAL
  zh: 对于远程查询某些本地资源，您还可以使用SNMP（参见第11章[收集与SNMP相关的监控信息](../Text/ch11.html "第11章. 使用SNMP收集监控信息")，从第227页开始），但检查将限于使用的SNMP守护进程的功能。本地插件通常在这里更灵活，并提供更多查询选项。
- en: 7.1 Free Hard Drive Capacity
  id: totrans-840
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.1 空闲硬盘容量
- en: 'The question of when the hard drive(s) of a computer may threaten to overflow
    is answered by the **`check_disk`** plugin. It has the following options for specifying
    thresholds:'
  id: totrans-841
  prefs: []
  type: TYPE_NORMAL
  zh: 计算机硬盘可能溢出的时间问题由**`check_disk`**插件回答。它有以下选项用于指定阈值：
- en: '**`-w`** **``*`limit`*``** /**`--warning=`****``*`limit`*``**'
  id: totrans-842
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`limit`*``** /**`--warning=`****``*`limit`*``**'
- en: The plugin will give a warning if the free hard drive capacity drops below this
    limit, expressed as a percentage or as an integer. If you specify percentage,
    the percent sign **`%`** must also be included; floating point decimals such as
    **`12.5%`** are possible. Integer values represent the absolute free space in
    the unit that defines the **`--units`** switch. The default is **`--units=MB`**,
    or megabytes.
  id: totrans-843
  prefs: []
  type: TYPE_NORMAL
  zh: 如果空闲硬盘容量低于此限制，插件将发出警告，该限制可以表示为百分比或整数。如果您指定百分比，则必须包括百分号**`%`**；例如**`12.5%`**这样的浮点小数是可能的。整数值表示**`--units`**开关定义的单位中的绝对空闲空间。默认值为**`--units=MB`**，即兆字节。
- en: '**`-c`** **``*`limit`*``** / **`--critical=`****``*`limit`*``**'
  id: totrans-844
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`limit`*``** / **`--critical=`****``*`limit`*``**'
- en: If the free hard drive capacity level falls below this as a percentage or integer
    (see **`-w`**), **`check_disk`** displays the CRITICAL status. The critical limit
    must be smaller than the warning limit.
  id: totrans-845
  prefs: []
  type: TYPE_NORMAL
  zh: 如果空闲硬盘容量低于此百分比或整数（见**`-w`**），**`check_disk`**将显示CRITICAL状态。临界限制必须小于警告限制。
- en: '**`-W`** **``*`limit`*``** / **`-iwarning=`****``*`limit`*``**'
  id: totrans-846
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-W`** **``*`limit`*``** / **`-iwarning=`****``*`limit`*``**'
- en: The number of free inodes in the file system as a percentage; **`check_ disk`**
    issues a warning if this drops below the limit.
  id: totrans-847
  prefs: []
  type: TYPE_NORMAL
  zh: 文件系统中空闲inode的数量作为百分比；如果此值低于限制，**`check_disk`**将发出警告。
- en: '**`-K`** **``*`limit`*``** / **`-icritical=`****``*`limit`*``**'
  id: totrans-848
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-K`** **``*`limit`*``** / **`-icritical=`****``*`limit`*``**'
- en: Like **`-W`**, except that this is the critical threshold.
  id: totrans-849
  prefs: []
  type: TYPE_NORMAL
  zh: 与**`-W`**类似，但这是临界阈值。
- en: '**`-u`** **``*`unit`*``** / **`--units=`****``*`unit`*``**'
  id: totrans-850
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u`** **``*`unit`*``** / **`--units=`****``*`unit`*``**'
- en: In what unit do you specify integer limit values? **`kB`**, **`MB`**, **`GB`**,
    and **`TB`** are all possible.
  id: totrans-851
  prefs: []
  type: TYPE_NORMAL
  zh: 您指定整数限制值时使用什么单位？**`kB`**、**`MB`**、**`GB`**和**`TB`**都是可能的。
- en: '**`-k`** / **`--kilobytes`**'
  id: totrans-852
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-k`** / **`--kilobytes`**'
- en: With this switch, limit values given as whole numbers with **`-c`** and **`-w`**
    are to be interpreted as KB. This is the same as **`--units=kB`**.
  id: totrans-853
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此开关，**`-c`**和**`-w`**中给出的整个数字限制值应解释为KB。这等同于**`--units=kB`**。
- en: '**`-m`** / **`--megabytes`**'
  id: totrans-854
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-m`** / **`--megabytes`**'
- en: With this switch, whole number limit values with **`-c`** and **`-w`** are interpreted
    by the plugin as MB (the default). This is the same as **`--units=MB`**.
  id: totrans-855
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此开关，**`-c`**和**`-w`**中的整个数字限制值被插件解释为MB（默认值）。这等同于**`--units=MB`**。
- en: Before one of the following path selectors is specified, at least one threshold
    must be given (**`-w`**, **`-c`**, **`-W`**, or **`-K`**).
  id: totrans-856
  prefs: []
  type: TYPE_NORMAL
  zh: 在指定以下路径选择器之前，至少必须给出一个阈值（**`-w`**、**`-c`**、**`-W`**或**`-K`**）。
- en: '**`-p`** **``*`path_or_partition`*``** / **`--path=`****``*`path`*``** or **`--partition=`****``*`partitioin`*``**'
  id: totrans-857
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`path_or_partition`*``** / **`--path=`****``*`path`*``**或**`--partition=`****``*`partitioin`*``**'
- en: This specifies the root directory in file systems or the physical device in
    partitions (e.g., **`/dev/sda5`**). From version 1.4 **`-p`** can be called multiple
    times. If the path is not specified, the plugin tests all file systems (see also
    **`-x`** and **`-X`**).
  id: totrans-858
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了文件系统的根目录或分区中的物理设备（例如，**`/dev/sda5`**）。从版本1.4开始，**`-p`**可以多次调用。如果没有指定路径，插件将测试所有文件系统（另见**`-x`**和**`-X`**）。
- en: '**`-E`** / **`--exact-match`**'
  id: totrans-859
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-E`** / **`--exact-match`**'
- en: 'This demands that the root of the file system is included for all paths or
    partitions specified with **`-p`**, otherwise the plugin will issue an error:'
  id: totrans-860
  prefs: []
  type: TYPE_NORMAL
  zh: 这要求对于使用**`-p`**指定的所有路径或分区，都必须包含文件系统的根目录，否则插件将发出错误：
- en: '[PRE101]'
  id: totrans-861
  prefs: []
  type: TYPE_PRE
  zh: '[PRE101]'
- en: '**`/usr/local`** is not a file system, but a directory within the **`/usr`**
    file system on the partition **`/dev/md2`**. If you call the plugin with the switches
    **`-p /usr/local`** and **`-E`**, you will receive an error, since **`/usr/local`**
    is not itself the root of the file system as required by **`-E`**:'
  id: totrans-862
  prefs: []
  type: TYPE_NORMAL
  zh: '**`/usr/local`** 不是一个文件系统，而是位于分区 **`/dev/md2`** 上的 **`/usr`** 文件系统中的一个目录。如果您使用
    **`-p /usr/local`** 和 **`-E`** 调用插件，您将收到错误，因为 **`/usr/local`** 本身不是所需的文件系统根目录
    **`-E`**：'
- en: '[PRE102]'
  id: totrans-863
  prefs: []
  type: TYPE_PRE
  zh: '[PRE102]'
- en: '**`-x`** **``*`path`*``** / **`--exclude_device=`****``*`path`*``**'
  id: totrans-864
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-x`** **``*`path`*``** / **`--exclude_device=`****``*`path`*``**'
- en: This switch excludes the mount point specified as **``*`path`*``** from the
    test. This option assumes that paths are specified with **`-p`** and that they
    may be run in a plugin call multiple times.
  id: totrans-865
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项排除指定的挂载点 **``*`path`*``**，从测试中排除。此选项假定路径使用 **`-p`** 指定，并且它们可能在插件调用中多次运行。
- en: '**`-X`** **``*`fs_typ`*``** / **`--exclude-type=`****``*`fs_typ`*``** (from
    1.4)'
  id: totrans-866
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-X`** **``*`fs_typ`*``** / **`--exclude-type=`****``*`fs_typ`*``** (从 1.4)'
- en: This switch excludes a specific file system type from the test. It is given
    the same abbreviation as in the **`-t`** option of the **`mount`** command. In
    this way **`fs_type`** can take the values **`ext3`**, **`reiserfs`**, or **`proc`**,
    for example (see also **`man 8 mount`**). This option can be used several times
    in a plugin command.
  id: totrans-867
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项排除特定文件系统类型，其缩写与 **`mount`** 命令的 **`-t`** 选项中相同。这样，**`fs_type`** 可以取 **`ext3`**、**`reiserfs`**
    或 **`proc`** 等值（另见 **`man 8 mount`**）。此选项可以在插件命令中使用多次。
- en: '**`-R`** **``*`regexp`*``** / **`--eregi-path=`****``*`regexp`*``**,**`--eregi-partition=`****``*`regexp`*``**'
  id: totrans-868
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-R`** **``*`regexp`*``** / **`--eregi-path=`****``*`regexp`*``**,**`--eregi-partition=`****``*`regexp`*``**'
- en: 'From version 1.4.8: a regular expression that selects all paths or partitions
    with which it matches. Upper/lower case is ignored here. The following example
    checks all partitions that end with **`mdO`** thru **`md2`**:'
  id: totrans-869
  prefs: []
  type: TYPE_NORMAL
  zh: 从版本 1.4.8 开始：一个正则表达式，用于选择所有与它匹配的路径或分区。这里忽略大小写。以下示例检查所有以 **`mdO`** 至 **`md2`**
    结尾的分区：
- en: '[PRE103]'
  id: totrans-870
  prefs: []
  type: TYPE_PRE
  zh: '[PRE103]'
- en: The swap partition **`/dev/mdl`** is ignored here.
  id: totrans-871
  prefs: []
  type: TYPE_NORMAL
  zh: 交换分区 **`/dev/mdl`** 在这里被忽略。
- en: '**`-r`** **``*`regexp`*``** / **`--ereg-path=`****``*`regexp`*``**, **`--ereg-partition=`****``*`regexp`*``**'
  id: totrans-872
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** **``*`regexp`*``** / **`--ereg-path=`****``*`regexp`*``**, **`--ereg-partition=`****``*`regexp`*``**'
- en: 'From version 1.4.8: a regular expression to check partitions and/or paths.
    Like **`-R`**, except that it is now case-sensitive.'
  id: totrans-873
  prefs: []
  type: TYPE_NORMAL
  zh: 从版本 1.4.8 开始：一个正则表达式，用于检查分区和/或路径。类似于 **`-R`**，但现在区分大小写。
- en: '**`-A`** / **`--all`**'
  id: totrans-874
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-A`** / **`--all`**'
- en: 'From version 1.4.10: checks all partitions and file systems. The equivalent
    of **`-R ''.*''`**.'
  id: totrans-875
  prefs: []
  type: TYPE_NORMAL
  zh: 从版本 1.4.10 开始：检查所有分区和文件系统。相当于 **`-R '.*'`**。
- en: '**`-I`** **``*`regexp`*``** / **`--ignore-eregi-path=`****``*`regexp`*``**,
    **`--ignore-eregi-partition=`****``*`regexp`*``**'
  id: totrans-876
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-I`** **``*`regexp`*``** / **`--ignore-eregi-path=`****``*`regexp`*``**,
    **`--ignore-eregi-partition=`****``*`regexp`*``**'
- en: 'From version 1.4.10: a regular expression that excludes paths or partitions
    that match it from the check. Upper/lower case is ignored.'
  id: totrans-877
  prefs: []
  type: TYPE_NORMAL
  zh: 从版本 1.4.10 开始：一个正则表达式，用于排除检查中匹配的路径或分区。这里忽略大小写。
- en: '**`-i`** **``*`regexp`*``** / **`--ignore-ereg-path=`****``*`regexp`*``**,
    **`--ignore-ereg-partition=`****``*`regexp`*``**'
  id: totrans-878
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-i`** **``*`regexp`*``** / **`--ignore-ereg-path=`****``*`regexp`*``**,
    **`--ignore-ereg-partition=`****``*`regexp`*``**'
- en: 'From version 1.4.10: like **`-I`**, except that it is now case-sensitive.'
  id: totrans-879
  prefs: []
  type: TYPE_NORMAL
  zh: 从版本 1.4.10 开始：类似于 **`-I`**，但现在区分大小写。
- en: 'In addition the plugin has the following options:'
  id: totrans-880
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，插件还具有以下选项：
- en: '**`-e`** / **`--errors-only`**'
  id: totrans-881
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-e`** / **`--errors-only`**'
- en: With this switch, the plugin shows only the file systems or partitions that
    are in a WARNING or CRITICAL state.
  id: totrans-882
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此选项，插件仅显示处于警告或关键状态的文件系统或分区。
- en: '**`-M`** / **`--mountpoint`**'
  id: totrans-883
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-M`** / **`--mountpoint`**'
- en: From version 1.4 on, **`check_disk`** by default displays the file system path
    (e.g., **`/usr`**). With **`-M`** you are told instead what physical device (e.g.,
    **`/dev/sda5`**) is involved.
  id: totrans-884
  prefs: []
  type: TYPE_NORMAL
  zh: 从版本 1.4 开始，默认情况下，**`check_disk`** 显示文件系统路径（例如，**`/usr`**）。使用 **`-M`**，您将被告知涉及的是哪个物理设备（例如，**`/dev/sda5`**）。
- en: '**`-C`** / **`--clear`**'
  id: totrans-885
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** / **`--clear`**'
- en: 'From version 1.4 on, **`-p`** can be used multiple times. If you want to test
    several file systems at the same time, but using different limit values, **`-C`**
    can be used to delete old limit values that have been set:'
  id: totrans-886
  prefs: []
  type: TYPE_NORMAL
  zh: 从版本 1.4 开始，**`-p`** 可以多次使用。如果您想同时测试多个文件系统，但使用不同的限制值，可以使用 **`-C`** 删除已设置的旧限制值：
- en: '[PRE104]'
  id: totrans-887
  prefs: []
  type: TYPE_PRE
  zh: '[PRE104]'
- en: 'The order is important here: the limit values are valid for the file system
    details until they are reset with **`-C`**. Then new limits must be set with **`-w`**
    and **`-c`**.'
  id: totrans-888
  prefs: []
  type: TYPE_NORMAL
  zh: 这里的顺序很重要：限制值在文件系统详细信息中有效，直到它们被 **`-C`** 重置。然后必须使用 **`-w`** 和 **`-c`** 设置新的限制值。
- en: '**`−1`** / **`--local`**'
  id: totrans-889
  prefs: []
  type: TYPE_NORMAL
  zh: '**`−1`** / **`--local`**'
- en: Only checks local file systems, others-file systems mounted via NFS, for example-are
    ignored.
  id: totrans-890
  prefs: []
  type: TYPE_NORMAL
  zh: 仅检查本地文件系统，例如通过NFS挂载的其他文件系统被忽略。
- en: '**`-L`** / **`--stat-remote-fs`** (ab Version 1.4.10)'
  id: totrans-891
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-L`** / **`--stat-remote-fs`** (ab 版本 1.4.10)'
- en: Checks local file systems for the specified thresholds, but checks network file
    systems only for availability. With this switch you can test, for example, whether
    a *stale file handle* exists for a path connected via NFS.^([[72](#ftn.CHP-7-FN-2)])
  id: totrans-892
  prefs: []
  type: TYPE_NORMAL
  zh: 检查指定阈值的本地文件系统，但仅检查网络文件系统的可用性。使用此开关，您可以测试例如，通过NFS连接的路径是否存在*过时的文件句柄*。^([[72](#ftn.CHP-7-FN-2)])
- en: '**`-g`** **``*`group_name`*``** / **`--group-type=`****``*`group_name`*``**'
  id: totrans-893
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-g`** **``*`group_name`*``** / **`--group-type=`****``*`group_name`*``**'
- en: 'Refers to the thresholds of the sum of all specified partitions and paths.
    Without this switch the plugin compares each path and each partition separately
    with the thresholds. **`-g`** requires a name to be given, which the plugin includes
    as additional information in the output:'
  id: totrans-894
  prefs: []
  type: TYPE_NORMAL
  zh: 指的是所有指定分区和路径的总和的限制值。没有此开关，插件将单独将每个路径和每个分区与限制值进行比较。**`-g`** 需要给出一个名称，该插件将其作为附加信息包含在输出中：
- en: '[PRE105]'
  id: totrans-895
  prefs: []
  type: TYPE_PRE
  zh: '[PRE105]'
- en: This option must be placed *in front of* the path specification to which it
    refers.
  id: totrans-896
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项必须放置在它所引用的路径指定之前。
- en: '**`-t`** **``*`timeout`*``** / **`--timeout=`****``*`timeout`*``**'
  id: totrans-897
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** / **`--timeout=`****``*`timeout`*``**'
- en: After **``*`timeout`*``** seconds have expired the plugin stops the test and
    returns the CRITICAL status. The default is **`10`** seconds.
  id: totrans-898
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **``*`timeout`*``** 秒后，插件停止测试并返回CRITICAL状态。默认为 **`10`** 秒。
- en: 'Here is a somewhat more extensive example of the use of **`check_disk`**:'
  id: totrans-899
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是 **`check_disk`** 使用的一个稍微更详细的例子：
- en: '[PRE106]'
  id: totrans-900
  prefs: []
  type: TYPE_PRE
  zh: '[PRE106]'
- en: Everything is in order on the file system **`/`**, **`/usr`**, and **`/var`**,
    since more space is available on them—as can be seen from the performance data—than
    the limit value of 10 percent (for a warning), and certainly more than 5 percent
    (for the critical status). The file systems **`/net/emil1/a`** and **`/net/emil1/c`**
    encompass significantly larger ranges of data, which is why the limit values are
    set lower, after the previous ones have been deleted with **`-C`**.
  id: totrans-901
  prefs: []
  type: TYPE_NORMAL
  zh: 文件系统 **`/`**, **`/usr`**, 和 **`/var`** 上一切正常，因为它们上的可用空间比10%的限制值（用于警告）要多——这一点可以从性能数据中看出，当然也比5%的限制值（用于关键状态）要多。文件系统
    **`/net/emil1/a`** 和 **`/net/emil1/c`** 包含的数据范围显著更大，这就是为什么在删除之前的限制值后，限制值被设置得更低。
- en: '**`-e`** ensures that Nagios shows only the file systems that really display
    an error status. In fact the output of the plugin *before* the **`|`** sign, with
    **`/net/ emil1/c`**, only displays one single file system. The performance information
    after the pipe can only be seen on the command line—it contains all file systems
    tested, as before. This is slightly confusing, because a Nagios plugin restricts
    its output to a single line, which has been line wrapped here for this printed
    version.'
  id: totrans-902
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-e`** 确保Nagios只显示真正显示错误状态的文件系统。实际上，插件在 **`|`** 符号之前的输出，带有 **`/net/ emil1/c`**，只显示一个单独的文件系统。管道之后的性能信息只能在命令行上看到——它包含之前测试的所有文件系统。这有点令人困惑，因为Nagios插件将其输出限制为单行，这里为了打印版本而进行了换行。'
- en: '* * *'
  id: totrans-903
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[71](#CHP-7-FN-1)]) This edition is based on version 1.4.11.
  id: totrans-904
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[71](#CHP-7-FN-1)]) 本版基于1.4.11版本。
- en: ^([[72](#CHP-7-FN-2)]) The error message **`NFS stale file handle`** indicates
    the non-availability of the NFS path.
  id: totrans-905
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[72](#CHP-7-FN-2)]) 错误消息 **`NFS stale file handle`** 指示NFS路径不可用。
- en: 7.2 Utilization of the Swap Space
  id: totrans-906
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.2 交换空间的使用
- en: 'The **`check_swap`** plugin tests the locally available swap space:'
  id: totrans-907
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_swap`** 插件测试本地可用的交换空间：'
- en: '**`-w`** **``*`limit`*``** / **`--warning=`****``*`limit`*``**'
  id: totrans-908
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`limit`*``** / **`--warning=`****``*`limit`*``**'
- en: The warning limit can be specified as a percentage or as an integer, as with
    **`check_disk`**, but the integer value is specified in *bytes*, not in kilobytes!
  id: totrans-909
  prefs: []
  type: TYPE_NORMAL
  zh: 警告限制可以指定为百分比或整数，就像 **`check_disk`** 一样，但整数值以字节为单位指定，而不是以千字节为单位！
- en: If at least 10 percent should remain free, specify **`-c 10%`**. The integer
    specification refers to the remaining free space, too.
  id: totrans-910
  prefs: []
  type: TYPE_NORMAL
  zh: 如果至少应有10%的空间空闲，指定 **`-c 10%`**。整数指定也指剩余的空闲空间。
- en: '**`-c`** **``*`limit`*``** / **`--critical=`****``*`limit`*``**'
  id: totrans-911
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`limit`*``** / **`--critical=`****``*`limit`*``**'
- en: Critical limit, similar to the warning limit.
  id: totrans-912
  prefs: []
  type: TYPE_NORMAL
  zh: 临界限值，类似于警告限值。
- en: '**`-a`** / **`--allswaps`**'
  id: totrans-913
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-a`** / **`--allswaps`**'
- en: Tests the threshold values for each swap partition individually.
  id: totrans-914
  prefs: []
  type: TYPE_NORMAL
  zh: 分别测试每个交换分区的阈值值。
- en: 'The following example tests to see whether at least half of the swap space
    is available. If there is less than 20 percent free swap space, the plugin should
    return a critical status. After the **`|`** sign the program again provides performance
    data, which is logged by Nagios but not displayed in the message on the Web interface:'
  id: totrans-915
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例测试至少一半的交换空间是否可用。如果可用交换空间少于20%，则插件应返回临界状态。在**`|`**符号之后，程序再次提供性能数据，这些数据由Nagios记录但不显示在Web界面的消息中：
- en: '[PRE107]'
  id: totrans-916
  prefs: []
  type: TYPE_PRE
  zh: '[PRE107]'
- en: 7.3 Testing the System Load
  id: totrans-917
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.3 测试系统负载
- en: 'The load on a system can be seen from the number of simultaneously running
    processes, which is tested by the **`check_load`** plugin. With the help of the
    **`uptime`** program, it determines the average value for the last minute, the
    last five minutes, and the last 15 minutes. **`uptime`** displays these values
    in this sequence after the keyword **`load average`**:'
  id: totrans-918
  prefs: []
  type: TYPE_NORMAL
  zh: 系统负载可以通过同时运行的进程数量来观察，这是由**`check_load`**插件测试的。借助**`uptime`**程序，它确定过去一分钟、过去五分钟和过去十五分钟的平均值。**`uptime`**在关键字**`load
    average`**之后按此顺序显示这些值：
- en: '[PRE108]'
  id: totrans-919
  prefs: []
  type: TYPE_PRE
  zh: '[PRE108]'
- en: '**`check_loadhas`** only two options (the two limit values), but these can
    be specified in two different ways:'
  id: totrans-920
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_loadhas`**只有两个选项（两个限制值），但它们可以用两种不同的方式指定：'
- en: '**`-w`** **``*`limit`*``** / **`--warning=`****``*`limit`*``**'
  id: totrans-921
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`limit`*``** / **`--warning=`****``*`limit`*``**'
- en: This option specifies the warning limit either as a simple floating point decimal
    (**`5.0`**) or as a comma-separated triplet containing three floating point decimals
    (**`10.0,8.0,5.0`**).
  id: totrans-922
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项指定警告限值，可以是简单的浮点十进制数（**`5.0`**）或包含三个浮点十进制数的逗号分隔的三元组（**`10.0,8.0,5.0`**）。
- en: In the first case, the limit specified applies to all three average values.
    The plugin issues a warning if (at least) one of these is exceeded. In the second
    case the triplet allows the limit value to be specified separately for each average
    value. Here as well, **`check_load`** issues a warning as soon as one of the average
    values exceeds the limit defined for it.
  id: totrans-923
  prefs: []
  type: TYPE_NORMAL
  zh: 在第一种情况下，指定的限制适用于所有三个平均值。如果（至少）其中一个超过，插件会发出警告。在第二种情况下，三元组允许为每个平均值分别指定限制值。同样，**`check_load`**在任何一个平均值超过为其定义的限制时就会发出警告。
- en: '**`-c`** **``*`limit`*``** / **`--critical=`****``*`limit`*``**'
  id: totrans-924
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`limit`*``** / **`--critical=`****``*`limit`*``**'
- en: This specifies the critical limit in the same way as **`-w`** specifies the
    warning limit. These critical limit values should be higher than the values for
    **`-w`**.
  id: totrans-925
  prefs: []
  type: TYPE_NORMAL
  zh: 这以与**`-w`**指定警告限值相同的方式指定了临界限值。这些临界限值应高于**`-w`**的值。
- en: '**`-r`** / **`--percpu`** (from Version 1.4.9)'
  id: totrans-926
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** / **`--percpu`**（从版本1.4.9开始）'
- en: Divides the system load determined by the number of existing CPU kernels, to
    get a better idea of the load per CPU kernel.
  id: totrans-927
  prefs: []
  type: TYPE_NORMAL
  zh: 将由现有CPU核心数确定的系统负载进行分割，以更好地了解每个CPU核心的负载。
- en: 'In the following example Nagios would raise the alarm if more than 15 processes
    were active on average in the last minute, if more than 10 were active on average
    in the last five minutes, or if eight were active on average in the last 15 minutes.
    There is a warning for average values of ten, eight, or five processes:'
  id: totrans-928
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下示例中，如果在过去一分钟内平均有超过15个进程活跃，在过去五分钟内平均有超过10个进程活跃，或者在过去15分钟内平均有8个进程活跃，Nagios会发出警报。对于十个、八个或五个进程的平均值，都有一个警告：
- en: '[PRE109]'
  id: totrans-929
  prefs: []
  type: TYPE_PRE
  zh: '[PRE109]'
- en: 7.4 Monitoring Processes
  id: totrans-930
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.4 监控进程
- en: The **`check_procs`** plugin monitors processes according to various criteria.
    Usually it is used to monitor the running processes of just one single program.
    Here the upper and lower limits can also be specified.
  id: totrans-931
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_procs`**插件根据各种标准监控进程。通常它用于监控单个程序的运行进程。在这里，也可以指定上限和下限。'
- en: '**`nmbd`**, for example, the name service of Samba, always runs as a daemon
    with two processes. A larger number of **nmbd** entries in the process table is
    always a sure sign of a problem; it is commonly encountered, especially in older
    Samba versions.'
  id: totrans-932
  prefs: []
  type: TYPE_NORMAL
  zh: '**`nmbd`**，例如，Samba的名称服务，始终以守护进程的形式运行，有两个进程。进程表中的**nmbd**条目数量较多始终是问题的明确迹象；这在较老的Samba版本中尤为常见。'
- en: 'Services such as Nagios itself should only have one main process. This can
    be seen by the fact that its parent process has the process ID **`1`**, marking
    it as a child of the **`init`** process. It was often the case, in the development
    phase of Nagios 2.0, that several such processes were active in parallel after
    a failed restart or reload, which led to undesirable side effects. You can test
    to see whether there really is just one single Nagios main process active, as
    follows:'
  id: totrans-933
  prefs: []
  type: TYPE_NORMAL
  zh: 如Nagios本身这样的服务应该只有一个主进程。这可以通过其父进程的进程ID **`1`** 来看出，这表明它是**`init`**进程的子进程。在Nagios
    2.0的开发阶段，在失败的重新启动或重新加载后，通常会有几个这样的进程并行活动，这导致了不希望出现的副作用。你可以通过以下方式测试是否只有一个Nagios主进程活动：
- en: '[PRE110]'
  id: totrans-934
  prefs: []
  type: TYPE_PRE
  zh: '[PRE110]'
- en: 'The program to be monitored is called **`nagios`** (option **`-C`**), and its
    parent process should have the ID **`1`** (option **`-p`**). Exactly one Nagios
    process must be running, no more and no less; otherwise the plugin will issue
    a CRITICAL status. This is specified as a range: **`-c 1:1`**.'
  id: totrans-935
  prefs: []
  type: TYPE_NORMAL
  zh: 需要监控的程序称为**`nagios`**（选项**`-C`**），其父进程的ID应为**`1`**（选项**`-p`**）。必须恰好有一个Nagios进程正在运行，不多也不少；否则插件将发出CRITICAL状态。这被指定为一个范围：**`-c
    1:1`**。
- en: 'Another example: between one and four simultaneous processes of the OpenLDAP
    replication service **`slurpd`** should be active:'
  id: totrans-936
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个例子：OpenLDAP复制服务**`slurpd`**应该有一个到四个同时运行的进程：
- en: '[PRE111]'
  id: totrans-937
  prefs: []
  type: TYPE_PRE
  zh: '[PRE111]'
- en: If the actual process number lies between **`1`** and **`4`**, the plugin returns
    OK, as is the case here. If it finds between five and seven processes, however,
    a warning will be given. Outside this range, **`check_procs`** categorizes the
    status as CRITICAL. This is the case here if there are either no processes running
    at all, or more than seven running.
  id: totrans-938
  prefs: []
  type: TYPE_NORMAL
  zh: 如果实际进程数位于**`1`**和**`4`**之间，插件将返回OK，正如这里的情况。如果它发现五个到七个进程，则将发出警告。在此范围之外，**`check_procs`**将状态分类为CRITICAL。如果没有任何进程运行，或者运行超过七个，这种情况就适用。
- en: 'Instead of the number of processes of the same program, you can also monitor
    the CPU load caused by it, its use of memory, or even the CPU runtime used. **`check_procs`**
    has the following options:'
  id: totrans-939
  prefs: []
  type: TYPE_NORMAL
  zh: 除了相同程序的进程数量之外，你还可以监控由它引起的CPU负载、其内存使用，甚至CPU运行时间。**`check_procs`**有以下选项：
- en: '**`-w`** **``*`start: end`*``** / **`--warning=`****``*`start: end`*``**'
  id: totrans-940
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`start: end`*``** / **`--warning=`****``*`start: end`*``**'
- en: 'The plugin issues a warning if the actual values lie *outside* the range specified
    by the start and end value. Without further details, it assumes that it should
    count processes: **`-w 2:10`** means that **`check_ procs`** gives a warning if
    it finds less than two or more than ten processes.'
  id: totrans-941
  prefs: []
  type: TYPE_NORMAL
  zh: 如果实际值位于由起始值和结束值指定的范围内，插件将发出警告。在没有进一步细节的情况下，它假定应该计算进程：**`-w 2:10`**意味着如果**`check_
    procs`**发现少于两个或超过十个进程，它将发出警告。
- en: If you omit one of the two limit values, zero applies as the lower value, or
    infinite as the upper limit. This means that the range **`:10`** is identical
    to **`0:10; 10:`** describes any number larger than or equal to 10\. If you just
    enter a single whole number instead of a range, this represents the maximum. The
    entry **`5`** therefore stands for **`0:5`**.
  id: totrans-942
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你省略了两个限制值中的一个，则零作为下限，或无限作为上限。这意味着范围**`:10`**与**`0:10; 10:`**相同，描述任何大于或等于10的数字。如果你只输入一个单独的整数而不是范围，这表示最大值。因此，条目**`5`**代表**`0:5`**。
- en: If you swap the maximum and minimum, the plugin will give a warning if the actual
    value lies *within* the range, so for **`-w 10:5`** this will be if the value
    is 5, 6, 7, 8, 9, or 10\. You may always specify only one interval.
  id: totrans-943
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你交换最大值和最小值，如果实际值位于该范围内，插件将发出警告，因此对于**`-w 10:5`**，这将是在值为5、6、7、8、9或10时。你可以始终只指定一个区间。
- en: '**`-c`** **``*`start : end`*``** / **`--critical=`****``*`start : end`*``**'
  id: totrans-944
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`start : end`*``** / **`--critical=`****``*`start : end`*``**'
- en: This specifies the critical range, in the same way as for the warning limit.
  id: totrans-945
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了关键范围，与警告限制的方式相同。
- en: '**`-m`** **``*`type`*``** / **`--metric=`****``*`type`*``**'
  id: totrans-946
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-m`** **``*`type`*``** / **`--metric=`****``*`type`*``**'
- en: 'This switch selects one of the following metrics for the test:'
  id: totrans-947
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关选择以下指标之一用于测试：
- en: '**`PROCS`**:'
  id: totrans-948
  prefs: []
  type: TYPE_NORMAL
  zh: '**`PROCS`**:'
- en: number of processes (the default if no specific type is given)
  id: totrans-949
  prefs: []
  type: TYPE_NORMAL
  zh: 进程数量（如果没有指定特定类型，则为默认值）
- en: '**`VSZ`**:'
  id: totrans-950
  prefs: []
  type: TYPE_NORMAL
  zh: '**`VSZ`**:'
- en: the virtual size of a process in the memory *(virtual memory size)*, consisting
    of the main memory space that the process uses exclusively, plus that of the shared
    libraries used. These only take up memory space once, even if they are used by
    several different processes. The specification is given in bytes.
  id: totrans-951
  prefs: []
  type: TYPE_NORMAL
  zh: 进程在内存中的虚拟大小（虚拟内存大小），由进程使用的专用主内存空间和使用的共享库组成。这些库即使被多个不同的进程使用，也只占用一次内存空间。指定以字节为单位。
- en: '**`RSS`**:'
  id: totrans-952
  prefs: []
  type: TYPE_NORMAL
  zh: '**`RSS`**:'
- en: the proportion of main memory in KB that the process actually uses for itself
    (*Resident Set Size*), that is, **`VSZ`** minus the shared memory.
  id: totrans-953
  prefs: []
  type: TYPE_NORMAL
  zh: 进程实际为自己使用的物理内存的比例（以KB为单位）（*常驻集大小*），即**`VSZ`**减去共享内存。
- en: '**`CPU`**:'
  id: totrans-954
  prefs: []
  type: TYPE_NORMAL
  zh: '**`CPU`**:'
- en: CPU usage in percent. The plugin here checks the CPU usage for each individual
    process for morning and critical limits. If one of the processes exceeds the warning
    limit, Nagios will issue a warning. In the text output the plugin also shows how
    many processes have exceeded the warning or critical limit.
  id: totrans-955
  prefs: []
  type: TYPE_NORMAL
  zh: CPU使用百分比。此插件检查每个进程的CPU使用情况，以确定早晨和关键限制。如果某个进程超过警告限制，Nagios将发出警告。在文本输出中，插件还会显示超过警告或关键限制的进程数量。
- en: '**`ELAPSED`**:'
  id: totrans-956
  prefs: []
  type: TYPE_NORMAL
  zh: '**`ELAPSED`**:'
- en: The overall time that has passed since the process was started.
  id: totrans-957
  prefs: []
  type: TYPE_NORMAL
  zh: 自进程启动以来经过的总时间。
- en: '**`-s`** **``*`flags`*``** / **`--state=`****``*`flags`*``**'
  id: totrans-958
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-s`** **``*`flags`*``** / **`--state=`****``*`flags`*``**'
- en: 'This restricts the test to processes with the specified status flag. ^([[73](#ftn.CHP-7-FN-3)])
    The plugin in the following example gives a warning if there is more than one
    zombie process (status flag:**`Z`**) :'
  id: totrans-959
  prefs: []
  type: TYPE_NORMAL
  zh: 这将测试限制为具有指定状态标志的进程。^([[73](#ftn.CHP-7-FN-3)]) 下面的示例插件如果存在多于一个的僵尸进程（状态标志:**`Z`**)，将发出警告：
- en: '[PRE112]'
  id: totrans-960
  prefs: []
  type: TYPE_PRE
  zh: '[PRE112]'
- en: Things become critical here if more than five zombies "block up" the process
    table. Several states can be queried at the same time by by adding individual
    flags together, as in **`-s DSZ`**. Now Nagios cancels the processes that are
    in at least one of the states mentioned.
  id: totrans-961
  prefs: []
  type: TYPE_NORMAL
  zh: 如果多于五个僵尸进程“阻塞”进程表，情况将变得关键。可以通过将单个标志相加同时查询多个状态，例如**`-s DSZ`**。现在Nagios将取消处于至少一个上述状态之一的进程。
- en: '**`-p`** **``*`ppid`*``** / **`--ppid=`****``*`ppid`*``**'
  id: totrans-962
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`ppid`*``** / **`--ppid=`****``*`ppid`*``**'
- en: This switch restricts the test to processes whose parent processes have the
    *parent process ID* (**``*`ppid`*``**). The only PPIDs that are known from the
    beginning, and that do not change, are 0 (started by the kernel, and usually only
    concerns the init process) and 1 (the init process itself).
  id: totrans-963
  prefs: []
  type: TYPE_NORMAL
  zh: 此开关将测试限制为父进程具有*父进程ID*（**``*`ppid`*``**）的进程。从开始就已知且不会改变的唯一PPID是0（由内核启动，通常仅涉及init进程）和1（init进程本身）。
- en: '**`-P`** **``*`pcpu`*``** / **`--pcpu=`****``*`pcpu`*``**'
  id: totrans-964
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-P`** **``*`pcpu`*``** / **`--pcpu=`****``*`pcpu`*``**'
- en: 'This option filters processes according to the percentage of CPU they use :'
  id: totrans-965
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项根据进程使用的CPU百分比过滤进程：
- en: '[PRE113]'
  id: totrans-966
  prefs: []
  type: TYPE_PRE
  zh: '[PRE113]'
- en: The plugin in this example takes into account only processes which have at least
    a ten percent share of CPU usage. As long as there is just one such process (**`-w
    1`**), it returns OK. If there are between two and five such processes, the return
    value is a WARNING. With at least six processes, each with a CPU usage of at least
    ten percent, things get critical.
  id: totrans-967
  prefs: []
  type: TYPE_NORMAL
  zh: 此示例插件仅考虑至少有10%CPU使用率的进程。只要有一个这样的进程（**`-w 1`**），它就返回OK。如果有两个到五个这样的进程，返回值是WARNING。如果有至少六个进程，每个进程的CPU使用率至少为10%，则情况变得关键。
- en: '**`-r`** **``*`rss`*``** / **`--rss=`****``*`rss`*``**'
  id: totrans-968
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** **``*`rss`*``** / **`--rss=`****``*`rss`*``**'
- en: This option filters out processes that occupy at least **``*`rss`*``** bytes
    of main memory. It is used like **`-P`**.
  id: totrans-969
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项过滤掉至少占用**``*`rss`*``**字节主内存的进程。它像**`-P`**一样使用。
- en: '**`-z`** **``*`vsz`*``** / **`--vsz=`****``*`vsz`*``**'
  id: totrans-970
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-z`** **``*`vsz`*``** / **`--vsz=`****``*`vsz`*``**'
- en: This option filters out processes whose VSZ (see above) is at least **`vsz`**
    bytes. It is used like **`-P`**.
  id: totrans-971
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项过滤掉VSZ（见上文）至少为**`vsz`**字节的进程。它像**`-P`**一样使用。
- en: '**`-u`** **``*`user`*``** / **`--user=`****``*`user`*``**'
  id: totrans-972
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u`** **``*`user`*``** / **`--user=`****``*`user`*``**'
- en: This option filters out processes that belong to the specified user (see example
    below).
  id: totrans-973
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项过滤掉属于指定用户的进程（见下文示例）。
- en: '**`-a`** **``*`"string"`*``** / **`--argument-array=`****``*`"string"`*``**'
  id: totrans-974
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-a`** **``*`"string"`*``** / **`--argument-array=`****``*`"string"`*``**'
- en: Filters out commands whose argument list contains **``*`string`*``**. **`-a.
    tex`**, for example, refers to all processes that work with **`*. tex files`**;
    **`-a -v`** to all processess that are called with the -v flag.
  id: totrans-975
  prefs: []
  type: TYPE_NORMAL
  zh: 过滤掉其参数列表包含**``*`string`*``**的命令。例如，**`-a. tex`**指的是所有处理**`*. tex files`**的进程；**`-a
    -v`**指的是所有带有-v标志调用的进程。
- en: '**`-C`** **``*`command`*``** / **`--command=`****``*`command`*``**'
  id: totrans-976
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`command`*``** / **`--command=`****``*`command`*``**'
- en: This causes the process list to be searched for the specified command name.
    command must exactly match the **``*`command`*``** specified, without a path (see
    example below).
  id: totrans-977
  prefs: []
  type: TYPE_NORMAL
  zh: 这会导致进程列表搜索指定的命令名称。命令必须与指定的**``*`command`*``**完全匹配，没有路径（见下例）。
- en: '**`-t`** **``*`timeout`*``** / **`--timeout=`****``*`timeout`*``**'
  id: totrans-978
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** / **`--timeout=`****``*`timeout`*``**'
- en: After **``*`timeout`*``** seconds have expired, the plugin stops the test and
    returns the CRITICAL status. The default is **`10`** seconds.
  id: totrans-979
  prefs: []
  type: TYPE_NORMAL
  zh: 在**``*`timeout`*``**秒后过期，插件停止测试并返回CRITICAL状态。默认值为**`10`**秒。
- en: 'The following example checks to see whether exactly one process called **`master`**
    is running on a mail server on which the Cyrus IMAPd is installed. No process
    is just as much an error as more than one process:'
  id: totrans-980
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例检查是否恰好有一个名为**`master`**的进程在安装了Cyrus IMAPd的邮件服务器上运行。没有进程和多个进程一样都是错误：
- en: '[PRE114]'
  id: totrans-981
  prefs: []
  type: TYPE_PRE
  zh: '[PRE114]'
- en: 'The first attempt returns two processes, although only a single Cyrus Master
    process is running. The reason can be found if you run **`ps`**:'
  id: totrans-982
  prefs: []
  type: TYPE_NORMAL
  zh: 第一次尝试返回两个进程，尽管只有一个Cyrus Master进程正在运行。如果你运行**`ps`**，可以找到原因：
- en: '[PRE115]'
  id: totrans-983
  prefs: []
  type: TYPE_PRE
  zh: '[PRE115]'
- en: 'The Postfix mail service also has a process with the same name. To keep an
    eye just on the master process of the IMAPd, the search is additionally restricted
    to processes running with the permissions of the user **`cyrus`**:'
  id: totrans-984
  prefs: []
  type: TYPE_NORMAL
  zh: Postfix邮件服务也有一个同名进程。为了仅关注IMAPd的主进程，搜索还额外限制为以用户**`cyrus`**的权限运行的进程：
- en: '[PRE116]'
  id: totrans-985
  prefs: []
  type: TYPE_PRE
  zh: '[PRE116]'
- en: '* * *'
  id: totrans-986
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: '^([[73](#CHP-7-FN-3)]) The following states are possible in Linux: **`D`**
    (uninterruptible waiting, usually a *Disk Wait*), **`R`** (running process), **`S`**
    (wait status), **`T`** (process halted), **`W`** (paging, only up to kernel 2.4),
    **`X`** (a finished, killed process), and **`Z`** (zombie). Further information
    is provided by **`man ps`**.'
  id: totrans-987
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[73](#CHP-7-FN-3)]) 在Linux中可能存在以下状态：**`D`**（不可中断等待，通常是*磁盘等待*），**`R`**（运行进程），**`S`**（等待状态），**`T`**（进程挂起），**`W`**（分页，仅限于内核2.4），**`X`**（已结束、被杀死的进程），以及**`Z`**（僵尸进程）。更多信息可由**`man
    ps`**提供。
- en: 7.5 Checking Log Files
  id: totrans-988
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.5 检查日志文件
- en: Monitoring log files is not really part of the concept of Nagios. On the one
    hand, the syslog daemon notices critical events there immediately, so that an
    error status can be correctly determined. But if the error status continues, this
    cannot be seen in the log file in most cases.
  id: totrans-989
  prefs: []
  type: TYPE_NORMAL
  zh: 监控日志文件并不是Nagios概念的一部分。一方面，syslog守护进程会立即注意到那里的关键事件，从而可以正确确定错误状态。但如果错误状态持续，在大多数情况下无法在日志文件中看到。
- en: Correspondingly the plugins described here can determine only whether other,
    new entries on error events are added. In order to communicate information on
    a continuing error behavior to Nagios via a log file, the service monitored must
    log the error status regularly—at least at the same intervals as Nagios reads
    the log file—and repeatedly. Otherwise the plugin will alternate between returning
    an error status, and then an OK status, depending on whether the (continuing)
    error has in the meantime turned up in the log or not.
  id: totrans-990
  prefs: []
  type: TYPE_NORMAL
  zh: 相应地，这里描述的插件只能确定是否在错误事件上添加了其他、新的条目。为了通过日志文件将有关持续错误行为的消息传递给Nagios，被监控的服务必须定期记录错误状态——至少与Nagios读取日志文件的间隔相同，并且重复记录。否则，插件将在返回错误状态和OK状态之间交替，这取决于（持续）错误是否在此期间出现在日志中。
- en: Under no circumstances may Nagios repeat its test. The parameter **`max_check_attempts`**
    (see [2.3 Defining the Machines to Be Monitored, with host](../Text/ch02s03.html
    "2.3 Defining the Machines to Be Monitored, with host")) must have the value **`1`**.
    Otherwise Nagios would first assign the error status as a soft state, would repeat
    the test, and would almost always arrive at an OK, since it only takes into account
    new entries during repeat tests. **`max_check_attempts = 1`** ensures that Nagios
    diagnoses a hard state after the first test.
  id: totrans-991
  prefs: []
  type: TYPE_NORMAL
  zh: 在任何情况下，Nagios都不能重复测试。参数**`max_check_attempts`**（见[2.3 定义要监控的机器，带有主机](../Text/ch02s03.html
    "2.3 定义要监控的机器，带有主机"））必须具有值**`1`**。否则，Nagios会首先将错误状态分配为软状态，会重复测试，并且几乎总是到达OK状态，因为它只考虑重复测试期间的新条目。**`max_check_attempts
    = 1`**确保Nagios在第一次测试后诊断硬状态。
- en: 'For events that log an error just once, Nagios has *volatile services*, described
    in [14.5.2 Nagios configuration: volatile services](../Text/ch14s05.html#nagios_configuration_colon_volatile_se
    "14.5.2 Nagios configuration: volatile services") from page 309\. For services
    defined in this way, the system treats every error status as if it was occurring
    for the first time (causing a message to be sent each time, for example).'
  id: totrans-992
  prefs: []
  type: TYPE_NORMAL
  zh: 对于仅记录一次错误的事件，Nagios有*易失性服务*，在[14.5.2 Nagios配置：易失性服务](../Text/ch14s05.html#nagios_configuration_colon_volatile_se
    "14.5.2 Nagios配置：易失性服务")的第309页中描述。对于以这种方式定义的服务，系统将每个错误状态都视为第一次发生（例如，每次都会发送消息）。
- en: Nagios periodically performs (active) checks with the plugins introduced here.
    If the entry sought does not reoccur, the plugin returns an OK. This is desired
    in many cases, and the administrator does not need to worry about the earlier
    error event. But if an error event needs to be handled in all cases, a simple
    Nagios check is no longer sufficient, since it will be easily overlooked due to
    the OK of a subsequent check. A slightly different approach, in which an administrator
    has to explicitly confirm every error result, is introduced in [Chapter 23](../Text/ch23.html
    "Chapter 23. Processing Events with the EventDB") in page 531.
  id: totrans-993
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios定期使用这里介绍的插件执行（主动）检查。如果所寻求的条目没有再次出现，插件返回OK。这在许多情况下是期望的，管理员不需要担心早期错误事件。但如果所有情况下都需要处理错误事件，简单的Nagios检查就不再足够，因为它很容易因为后续检查的OK而被忽略。在[第23章](../Text/ch23.html
    "第23章。使用EventDB处理事件")的第531页中介绍了一种稍微不同的方法，其中管理员必须明确确认每个错误结果。
- en: 7.5.1 The standard plugin **`check.log`**
  id: totrans-994
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 7.5.1 标准插件 **`check.log`**
- en: 'With **`check_log`**, Nagios provides a simple plugin for monitoring log files.
    It creates a copy of the tested log file each time it is run. If the log file
    has changed since the previous call, **`check_log`** searches the newly added
    data for simple text patterns. The plugin does not have any longer options and
    just has the states OK and CRITICAL :'
  id: totrans-995
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**`check_log`**，Nagios提供了一个简单的插件来监控日志文件。每次运行时，它都会创建测试日志文件的一个副本。如果自上次调用以来日志文件已更改，**`check_log`**将在新添加的数据中搜索简单的文本模式。该插件没有更长的选项，只有OK和CRITICAL两种状态：
- en: '**`-F`** **``*`logfile`*``**'
  id: totrans-996
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-F`** **``*`logfile`*``**'
- en: This is the name and path of the log file to be tested. It must be readable
    for the user **`nagios`**.
  id: totrans-997
  prefs: []
  type: TYPE_NORMAL
  zh: 这是待测试的日志文件的名称和路径。它必须对用户**`nagios`**可读。
- en: '**`-O`** **``*`oldlog`*``**'
  id: totrans-998
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-O`** **``*`oldlog`*``**'
- en: This is the name and path of the log file copy. The plugin just examines the
    difference between **``*`oldlog`*``** and **``*`logfile`*``** when it is run.
    Afterward it copies the current log file to **``*`oldlog. oldlog`*``** must contain
    the absolute path and be readable for the user **`nagios`**.
  id: totrans-999
  prefs: []
  type: TYPE_NORMAL
  zh: 这是日志文件副本的名称和路径。插件在运行时仅检查**``*`oldlog`*``**和**``*`logfile`*``**之间的差异。之后，它将当前日志文件复制到**``*`oldlog.
    oldlog`*``**。**``*`oldlog`*``**必须包含绝对路径，并且用户**`nagios`**可读。
- en: '**`-q`** **``*`query`*``**'
  id: totrans-1000
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-q`** **``*`query`*``**'
- en: This is the pattern searched for in examining the log file. Not found means
    OK; a match returns the CRITICAL status.
  id: totrans-1001
  prefs: []
  type: TYPE_NORMAL
  zh: 这是在检查日志文件时搜索的模式。未找到表示正常；匹配则返回CRITICAL状态。
- en: It is recommended that you generally do not use messages of the type *recovery
    notification* (OK after an error state).
  id: totrans-1002
  prefs: []
  type: TYPE_NORMAL
  zh: 建议您通常不要使用*恢复通知*类型的信息（错误状态后的OK）。
- en: An OK in a repeated test just means that no new error in events have occurred
    since the last test. The **`notification_options`** parameter (see [2.3 Defining
    the Machines to Be Monitored, with host](../Text/ch02s03.html "2.3 Defining the
    Machines to Be Monitored, with host")) in the service definition should therefore
    not contain an **`r`**.
  id: totrans-1003
  prefs: []
  type: TYPE_NORMAL
  zh: 重复测试中的OK仅意味着自上次测试以来事件中没有出现新的错误。因此，在服务定义中的**`notification_options`**参数（见[2.3
    定义要监控的机器，包括主机](../Text/ch02s03.html "2.3 定义要监控的机器，包括主机"））中不应包含**`r`**。
- en: 'The following command examines the file **`/var/log/auth`** for failed logins
    :'
  id: totrans-1004
  prefs: []
  type: TYPE_NORMAL
  zh: 以下命令检查**`/var/log/auth`**文件中的失败登录：
- en: '[PRE117]'
  id: totrans-1005
  prefs: []
  type: TYPE_PRE
  zh: '[PRE117]'
- en: This produces one hit. The plugin does not show its return value in the text,
    but it can be displayed in the shell with **`echo $?`**. In the example, a **`2`**
    for CRITICAL is returned.
  id: totrans-1006
  prefs: []
  type: TYPE_NORMAL
  zh: 这会产生一个匹配项。插件在文本中不显示其返回值，但可以在shell中使用**`echo $?`**显示。在示例中，返回一个**`2`**表示CRITICAL。
- en: 'If you examine the log file for several different events, you must specify
    a separate **``*`oldlog`*``** for each log file:'
  id: totrans-1007
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你检查多个不同事件的日志文件，你必须为每个日志文件指定一个单独的**``*`oldlog`*``**：
- en: '[PRE118]'
  id: totrans-1008
  prefs: []
  type: TYPE_PRE
  zh: '[PRE118]'
- en: 'Even if you are searching in the same original log file, you cannot avoid using
    two different **`oldlogs`**: otherwise **`check_log`** would not work correctly.'
  id: totrans-1009
  prefs: []
  type: TYPE_NORMAL
  zh: 即使你在同一个原始日志文件中进行搜索，也无法避免使用两个不同的**`oldlogs`**：否则**`check_log`**将无法正确工作。
- en: '7.5.2 The modern variation: **`check_logs.pl`**'
  id: totrans-1010
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 7.5.2 现代变体：**`check_logs.pl`**
- en: As an alternative, The Nagios Exchange^([[74](#ftn.CHP-7-FN-4)]) provides a
    completely new plugin for monitoring log files. **`check_logs.pi`** represents
    a further development of the Perl plugin **`check_log2.pl`**, which is included
    in the **`contrib`** directory for Nagios plugins but is not installed automatically.
  id: totrans-1011
  prefs: []
  type: TYPE_NORMAL
  zh: 作为替代方案，Nagios Exchange^([[74](#ftn.CHP-7-FN-4)])提供了一个用于监控日志文件的全新插件。**`check_logs.pi`**是Perl插件**`check_log2.pl`**的进一步发展，该插件包含在Nagios插件的**`contrib`**目录中，但不是自动安装的。
- en: '**`check_logs.pl`** can examine several log files simultaneously for events,
    in contrast to **`check_log`** and **`check_log2.pl`**. It requires a configuration
    file to do this.'
  id: totrans-1012
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_logs.pl`**可以同时检查多个日志文件中的事件，这与**`check_log`**和**`check_log2.pl`**不同。为此，它需要一个配置文件。'
- en: It does have a simple command line mode, but this functions only if you specify
    a single log file and a single regular expression simultaneously. But the really
    interesting feature of **`check_logs.pl`** is that you can perform several examinations
    in one go. This is why we will not spend any more time describing the command
    line mode.
  id: totrans-1013
  prefs: []
  type: TYPE_NORMAL
  zh: 它确实有一个简单的命令行模式，但只有在同时指定单个日志文件和单个正则表达式时才会工作。但**`check_logs.pl`**真正有趣的功能是你可以一次进行多次检查。这就是为什么我们不会花更多时间描述命令行模式。
- en: Initially we create a configuration file with roughly the following contents,
    preferably in the directory **`/etc/nagios:`**
  id: totrans-1014
  prefs: []
  type: TYPE_NORMAL
  zh: 初始时，我们创建一个配置文件，大致内容如下，最好放在目录**`/etc/nagios:`**中。
- en: '[PRE119]'
  id: totrans-1015
  prefs: []
  type: TYPE_PRE
  zh: '[PRE119]'
- en: The Perl variable **`$seek_file_template`** contains the path to the file in
    which the plugin saves the current position of the last search. **`check_logs.pl`**
    remembers here at what point in the log file it should carry on searching the
    next time it is run. This means that the plugin does not require a copy of the
    processed log file. Instead of the variable **`$log_file`**, it uses the name
    of the log file to be examined in each case and creates a separate position file
    for each log file.
  id: totrans-1016
  prefs: []
  type: TYPE_NORMAL
  zh: Perl变量**`$seek_file_template`**包含插件保存最后搜索位置的文件的路径。**`check_logs.pl`**在这里记住下次运行时应该在日志文件的哪个位置继续搜索。这意味着插件不需要处理过的日志文件的副本。而不是使用变量**`$log_file`**，它使用要检查的日志文件名，并为每个日志文件创建一个单独的位置文件。
- en: 'What exactly **`check_logs.pl`** is to do is defined by the Perl array **`@log_files`**.
    The entry **`file_name`** points to the log file to be tested (with the absolute
    path), and **`reg_exp`** contains the regular expression,^([[75](#ftn.CHP-7-FN-5)])
    for which **`check_logs.pl`** should search the log file. In the example above
    this is just a simple text called **`ntpd`** in the case of the **`/var/log/messages`**
    log file, but there is an alternative in the case of **`/var/log/warn`**: the
    regular expression **`(named | dhcpd)`** matches lines that contain either the
    text **`named`** or the text **`dhcpd`**.'
  id: totrans-1017
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_logs.pl`**具体要做什么由Perl数组**`@log_files`**定义。条目**`file_name`**指向要测试的日志文件（带有绝对路径），而**`reg_exp`**包含**`check_logs.pl`**应在日志文件中搜索的正则表达式^([[75](#ftn.CHP-7-FN-5)))。在上面的例子中，这是**`/var/log/messages`**日志文件中的一个简单文本**`ntpd`**，但在**`/var/log/warn`**的情况下有一个替代方案：正则表达式**`(named
    | dhcpd)`**匹配包含文本**`named`**或文本**`dhcpd`**的行。'
- en: 'The only specification that the plugin itself requires when it is run is the
    configuration file (option **`-c`**):'
  id: totrans-1018
  prefs: []
  type: TYPE_NORMAL
  zh: 当插件运行时，它本身需要的唯一指定是配置文件（选项**`-c`**）：
- en: '[PRE120]'
  id: totrans-1019
  prefs: []
  type: TYPE_PRE
  zh: '[PRE120]'
- en: 'The first command shows the basic principle: in the text output the plugin
    for each log file announces separately whether it has found a matching event or
    not. In the above example it didn''t find anything, so it returns OK. In the second
    command the plugin comes across four relevant entries in the **`warn`** log file,
    but it doesn''t find any in **`/var/log/messages`**. Because of this, the plugin
    returns a WARNING; OK is given only if no relevant events were found in any of
    the log files checked. In its output line, after **`(4):`**, the plugin remembers
    the last of the four lines found.'
  id: totrans-1020
  prefs: []
  type: TYPE_NORMAL
  zh: 第一条命令展示了基本原理：在文本输出中，每个日志文件的插件会分别宣布是否找到了匹配的事件。在上面的例子中，它没有找到任何内容，因此返回OK。在第二条命令中，插件在**`warn`**日志文件中发现了四个相关条目，但在**`/var/log/messages`**中没有找到。因此，插件返回警告；只有在检查的任何日志文件中都没有找到相关事件时，才会给出OK。在其输出行中，在**`(4):`**之后，插件会记住找到的四个行中的最后一个。
- en: '7.5.3 The Swiss Army knife: **`check_logfiles`**'
  id: totrans-1021
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 7.5.3 瑞士军刀：**`check_logfiles`**
- en: If you have many requirements from a log file check and the tools introduced
    so far do not meet your needs, then you really should take a look at the plugin
    **`check_logfiles`** by Gerhard Laußer. As well as sophisticated search options,
    it can handle any rotation methods you please, so that no information will be
    lost after a rotation. Its range of functions can be extended by scripts, which
    can be used to restart applications that have crashed, to send SNMP traps, or
    send passive check results to an NSCA daemon via **`send_nsca`** ([14.4 Sending
    Test Results to the Server](../Text/ch14s04.html "14.4 Sending Test Results to
    the Server"), page 305).
  id: totrans-1022
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你有很多来自日志文件的要求，而迄今为止介绍的工具不能满足你的需求，那么你真的应该看看Gerhard Laußer开发的插件 **`check_logfiles`**。除了复杂的搜索选项外，它还可以处理任何你想要的轮换方法，以确保轮换后不会丢失任何信息。其功能范围可以通过脚本扩展，这些脚本可以用于重启崩溃的应用程序，发送SNMP陷阱，或者通过
    **`send_nsca`** 将被动检查结果发送到NSCA守护进程（[14.4 将测试结果发送到服务器](../Text/ch14s04.html "14.4
    将测试结果发送到服务器")，第305页）。
- en: 'For simple tasks the plugin can be operated easily from the command line, but
    to use it in more advanced ways you will need to have some knowledge of Perl:
    the configuration file that is needed to make use of all the features uses the
    Perl syntax.'
  id: totrans-1023
  prefs: []
  type: TYPE_NORMAL
  zh: 对于简单的任务，插件可以通过命令行轻松操作，但若要更高级地使用它，你需要具备一些Perl知识：用于利用所有功能的配置文件使用Perl语法。
- en: 'The plugin^([[76](#ftn.CHP-7-FN-6)]) is unpacked in a suitable directory, for
    example in **`/usr/local/src`**:'
  id: totrans-1024
  prefs: []
  type: TYPE_NORMAL
  zh: 将插件解压到合适的目录中，例如 **`/usr/local/src`**：
- en: '[PRE121]'
  id: totrans-1025
  prefs: []
  type: TYPE_PRE
  zh: '[PRE121]'
- en: The installation is done with the three commands **`configure && make && make
    install`**. **`--with-seekf iles-dir`** specifies the directory in which **`check_logfiles`**
    writes status information, and **`--with-protocol-dir`** specifies the directory
    in which **`check_logfiles`** explicitly retains matches it has found. When doing
    this you should select a directory that is not deleted directly after every reboot.
    Logging can be switched off in the configuration, depending on the check defined.
  id: totrans-1026
  prefs: []
  type: TYPE_NORMAL
  zh: 安装通过三个命令 **`configure && make && make install`** 完成。**`--with-seekf iles-dir`**
    指定 **`check_logfiles`** 写入状态信息的目录，而 **`--with-protocol-dir`** 指定 **`check_logfiles`**
    明确保留找到的匹配项的目录。在执行此操作时，你应该选择一个在每次重启后不会直接删除的目录。根据定义的检查，可以在配置中关闭日志记录。
- en: 'On the command line, **`check_logfiles`** offers the following options :'
  id: totrans-1027
  prefs: []
  type: TYPE_NORMAL
  zh: 在命令行上，**`check_logfiles`** 提供以下选项：
- en: '**`--tag=`****``*`designator`*``**'
  id: totrans-1028
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--tag=`****``*`designator`*``**'
- en: Indicates individual checks, to make better distinction between them. The names
    of the variables in the performance data also start with this designator, so that
    the values can later be reassigned to a check. Specifying **`--tag`** is optional,
    but the author of the plugin generally recommends its use.
  id: totrans-1029
  prefs: []
  type: TYPE_NORMAL
  zh: 指示单个检查，以便更好地区分它们。性能数据中变量的名称也以此标识符开头，以便以后可以将值重新分配给检查。指定 **`--tag`** 是可选的，但插件作者通常推荐使用它。
- en: '**`--logfile=`****``*`logfile`*``**'
  id: totrans-1030
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--logfile=`****``*`logfile`*``**'
- en: Specifies the name and path of the log files to be examined. **`check_logfiles`**
    takes note of the last line of the file to be considered during each check, so
    that it can continue at the same place the next time it is called. In addition,
    **`check_logfiles`** saves other information such as inode and timestamp, so that
    it can detect log file rotations.
  id: totrans-1031
  prefs: []
  type: TYPE_NORMAL
  zh: 指定要检查的日志文件名称和路径。**`check_logfiles`** 在每次检查时都会注意文件的最后一行，以便在下一次调用时从相同的位置继续。此外，**`check_logfiles`**
    还会保存其他信息，如inode和时间戳，以便检测日志文件轮换。
- en: '**`--rotation=`****``*`rotation method`*``**'
  id: totrans-1032
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--rotation=`****``*`rotation method`*``**'
- en: 'Specifies the rotation procedure for the log file: **`loglog0log1gz`** is used
    if if you want to turn **``*`logfile`*``** into **``*`logfile.0`*``** and turn
    this into **``*`Logfile.1.gz.`*``**'
  id: totrans-1033
  prefs: []
  type: TYPE_NORMAL
  zh: 指定日志文件的轮换过程：如果你想将 **``*`logfile`*``** 转换为 **``*`logfile.0`*``** 并将其转换为 **``*`Logfile.1.gz.`*``**，则使用
    **`loglog0log1gz`**。
- en: '**`loglog0gzlog1gz`** means that **``*`logfile`*``** is first compressed to
    **``*`logfile. 0\. gz`*``** and is later renamed **``*`logfile.1.gz.`*``**'
  id: totrans-1034
  prefs: []
  type: TYPE_NORMAL
  zh: '**`loglog0gzlog1gz`** 表示首先将 **``*`logfile`*``** 压缩为 **``*`logfile. 0\. gz`*``**，然后将其重命名为
    **``*`logfile.1.gz.`*``**'
- en: '**`loglogdate8gz`** states that **``*`logfile`*``** will be converted into
    **``*`logfile. YYYYMMDD.gz.`*``**'
  id: totrans-1035
  prefs: []
  type: TYPE_NORMAL
  zh: '**`loglogdate8gz`** 表示 **``*`logfile`*``** 将被转换为 **``*`logfile. YYYYMMDD.gz.`*``**。'
- en: '**`loglog01og1`** describes the rotation method that turns **``*`logfile`*``**
    into **``*`logfile.0`*``** and creates the file **``*`logfile.1`*``** in the next
    rotation step.'
  id: totrans-1036
  prefs: []
  type: TYPE_NORMAL
  zh: '**`loglog01og1`** 描述了将 **``*`logfile`*``** 转换为 **``*`logfile.0`*``** 并在下一个旋转步骤中创建文件
    **``*`logfile.1`*``** 的旋转方法。'
- en: hpux in turn describes the variation " **``*`logfile`*``** is turned into **`OLD`****``*`logfile`*``**".
  id: totrans-1037
  prefs: []
  type: TYPE_NORMAL
  zh: hpux 则描述了变体“ **``*`logfile`*``** 转换为 **`OLD`****``*`logfile`*``**”。
- en: If a suitable rotation method is missing, you can specify a regular expression
    that matches the archived files instead. For Debian, you therefore specify **`--rotation='`**
    **``*`logfile`*\. (0|[0-9]+\.gz)``**. This is in case the ending **`.0`** is missed
    during the initial rotation of the file, and if all older archived files end in
    **``*`.number`*``****`.gz`**.
  id: totrans-1038
  prefs: []
  type: TYPE_NORMAL
  zh: 如果缺少合适的旋转方法，可以指定一个匹配存档文件的正则表达式。对于 Debian，因此指定 **`--rotation='`** **``*`logfile`*\.
    (0|[0-9]+\.gz)``**。这是以防在文件的初始旋转过程中错过结尾 **`.0`**，并且如果所有较旧的存档文件都以 **``*`.number`*``****`.gz`**
    结尾。
- en: '**`--criticalpattern=`****``*`regexp`*``**'
  id: totrans-1039
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--criticalpattern=`****``*`regexp`*``**'
- en: Regular expression in Perl syntax that triggers a CRITICAL. More detailed information
    on this is provided by **`man perlre`**.
  id: totrans-1040
  prefs: []
  type: TYPE_NORMAL
  zh: Perl 语法中的正则表达式，触发 CRITICAL。更详细的信息由 **`man perlre`** 提供。
- en: '**`--warningpattern=`****``*`regexp`*``**'
  id: totrans-1041
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--warningpattern=`****``*`regexp`*``**'
- en: Like **`--criticalpattern`**, except that the regular expression here triggers
    a WARNING.
  id: totrans-1042
  prefs: []
  type: TYPE_NORMAL
  zh: 与 **`--criticalpattern`** 类似，但这里的正则表达式触发 WARNING。
- en: '**`--noprotocol`**'
  id: totrans-1043
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--noprotocol`**'
- en: Switches off logging of matches to a separate file.
  id: totrans-1044
  prefs: []
  type: TYPE_NORMAL
  zh: 关闭匹配的记录到单独的文件。
- en: '**`--syslogserver`**'
  id: totrans-1045
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--syslogserver`**'
- en: Restricts the evaluation of log files of a syslog server to lines that the server
    itself has entered.
  id: totrans-1046
  prefs: []
  type: TYPE_NORMAL
  zh: 将对 syslog 服务器日志文件的评估限制在服务器本身输入的行。
- en: '**`--syslogclient=`****``*`clientname`*``**'
  id: totrans-1047
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--syslogclient=`****``*`clientname`*``**'
- en: Restricts the evaluation of log files of a syslog server to lines that originate
    from the syslog client **``*`clientname`*``**.
  id: totrans-1048
  prefs: []
  type: TYPE_NORMAL
  zh: 将对 syslog 服务器日志文件的评估限制在来自 syslog 客户端 **``*`clientname`*``** 的行。
- en: '**`-f`** **``*`configfile`*``**'
  id: totrans-1049
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-f`** **``*`configfile`*``**'
- en: 'Specifies a configuration file that allows a more extensive configuration than
    that allowed by just a few command line parameters. A knowledge of Perl is essential
    for this (see [7.5.3 The Swiss Army knife: check_logfiles](../Text/ch07s05.html#the_swiss_army_knife_colon_check_undersc
    "7.5.3 The Swiss Army knife: check_logfiles")).'
  id: totrans-1050
  prefs: []
  type: TYPE_NORMAL
  zh: 指定一个配置文件，它允许比仅通过几个命令行参数允许的更广泛的配置。对于此功能，Perl 知识是必不可少的（参见 [7.5.3 瑞士军刀：check_logfiles](../Text/ch07s05.html#the_swiss_army_knife_colon_check_undersc
    "7.5.3 瑞士军刀：check_logfiles")）。
- en: '**`-d`**'
  id: totrans-1051
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-d`**'
- en: Switches on debugging. Useful for searching for errors; this option should not
    be used during normal operation.
  id: totrans-1052
  prefs: []
  type: TYPE_NORMAL
  zh: 开启调试模式。在查找错误时很有用；此选项不应在正常操作期间使用。
- en: '**`check_logfiles`** is initialized when it is first called so that it can
    orient itself. The plugin only takes into account log entries that are subsequently
    appended to the log file, so it cannot evaluate already existing details.'
  id: totrans-1053
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_logfiles`** 在首次调用时初始化，以便它可以定位自身。插件仅考虑随后附加到日志文件的日志条目，因此它无法评估已存在的详细信息。'
- en: 'For demonstration purposes we will first use the **`logger`** program to generate
    an entry in the file **`/var/log/messages`**: ^([[77](#ftn.CHP-7-FN-7)])'
  id: totrans-1054
  prefs: []
  type: TYPE_NORMAL
  zh: 为了演示目的，我们首先使用 **`logger`** 程序在文件 **`/var/log/messages`** 中生成条目：^([[77](#ftn.CHP-7-FN-7)])
- en: '[PRE122]'
  id: totrans-1055
  prefs: []
  type: TYPE_PRE
  zh: '[PRE122]'
- en: 'The log file now contains the following entry:'
  id: totrans-1056
  prefs: []
  type: TYPE_NORMAL
  zh: 日志文件现在包含以下条目：
- en: '[PRE123]'
  id: totrans-1057
  prefs: []
  type: TYPE_PRE
  zh: '[PRE123]'
- en: 'A simple call of **`check_logfiles`** returns the following result :'
  id: totrans-1058
  prefs: []
  type: TYPE_NORMAL
  zh: 简单调用 **`check_logfiles`** 返回以下结果：
- en: '[PRE124]'
  id: totrans-1059
  prefs: []
  type: TYPE_PRE
  zh: '[PRE124]'
- en: All variables in the performance data are appended to the **`hellowob`** tag
    so that the respective events can be referenced again, if **`check_logfiles`**
    is to simultaneously search for several different entries.
  id: totrans-1060
  prefs: []
  type: TYPE_NORMAL
  zh: 性能数据中的所有变量都附加到 **`hellowob`** 标签，以便在 **`check_logfiles`** 同时搜索多个不同条目时可以再次引用相应的事件。
- en: 'Re-running **`check_logfiles`** again returns an OK, since none of the 32 newly
    added entries (**`hellowob_lines=32`**) contains the text being sought:'
  id: totrans-1061
  prefs: []
  type: TYPE_NORMAL
  zh: 再次运行 **`check_logfiles`** 返回 OK，因为新增的 32 条条目（**`hellowob_lines=32`**）中没有任何一条包含要搜索的文本：
- en: '[PRE125]'
  id: totrans-1062
  prefs: []
  type: TYPE_PRE
  zh: '[PRE125]'
- en: Configuration Files
  id: totrans-1063
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 配置文件
- en: 'Configuration files for **`check_logfiles`** basically contain an array consisting
    of search instructions, each of which are written as an anonymous hash:'
  id: totrans-1064
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_logfiles`** 的配置文件基本上包含一个由搜索指令组成的数组，每个指令都编写为一个匿名散列：'
- en: '[PRE126]'
  id: totrans-1065
  prefs: []
  type: TYPE_PRE
  zh: '[PRE126]'
- en: 'The array is called **`@searches`**; each instruction enclosed in **`{}`**
    is a search instruction. A configuration file for the **`hellowob`** example could
    look like this:'
  id: totrans-1066
  prefs: []
  type: TYPE_NORMAL
  zh: 该数组被称为**`@searches`**；每个包含在**`{}`**中的指令都是一个搜索指令。**`hellowob`**示例的配置文件可能看起来像这样：
- en: '[PRE127]'
  id: totrans-1067
  prefs: []
  type: TYPE_PRE
  zh: '[PRE127]'
- en: 'The instructions tag and **`rotation`** correspond to the command line parameters
    of the same name. The instructions **`criticalpatterns`** and **`warningpatterns`**
    are notated here -in contrast to the equivalent command line parameter-in the
    plural. The configuration file also allows multiple details :'
  id: totrans-1068
  prefs: []
  type: TYPE_NORMAL
  zh: 指令标记和**`rotation`**对应于同名命令行参数。指令**`criticalpatterns`**和**`warningpatterns`**在此处标记（与等效命令行参数不同）为复数。配置文件还允许指定多个细节：
- en: '[PRE128]'
  id: totrans-1069
  prefs: []
  type: TYPE_PRE
  zh: '[PRE128]'
- en: 'Instead of a scalar, an anonymous array may also be specified within square
    brackets. Here are some more instructions for **`@searches`**:'
  id: totrans-1070
  prefs: []
  type: TYPE_NORMAL
  zh: 除了标量之外，还可以在方括号内指定匿名数组。以下是**`@searches`**的一些更多指令：
- en: '**`archivedir`**'
  id: totrans-1071
  prefs: []
  type: TYPE_NORMAL
  zh: '**`archivedir`**'
- en: Archive directory for rotated log files. The default is the directory in which
    the log file is located.
  id: totrans-1072
  prefs: []
  type: TYPE_NORMAL
  zh: 轮转日志文件的存档目录。默认是日志文件所在的目录。
- en: '**`type`**'
  id: totrans-1073
  prefs: []
  type: TYPE_NORMAL
  zh: '**`type`**'
- en: 'Specifies the type of log file: **`rotation`** is accepted by default if the
    parameter **`rotation`** is set. **`simple`** describes log files without rotation,
    **`check_logfiles`** does not continue searching for archived files. **`virtual`**
    indicates files that should always be searched from the beginning, such as sockets
    or files from the **`/proc`** directory in Linux. For AIX, the option **`errpt`**
    is also available: instead of a real file, the plugin now searches for the output
    of the **`errpt`** command.'
  id: totrans-1074
  prefs: []
  type: TYPE_NORMAL
  zh: 指定日志文件的类型：如果设置了参数**`rotation`**，则默认接受**`rotation`**。**`simple`**描述没有轮转的日志文件，**`check_logfiles`**不会继续搜索归档文件。**`virtual`**表示应该从开始搜索的文件，例如Linux中的**`/proc`**目录中的套接字或文件。对于AIX，选项**`errpt`**也可用：插件现在搜索**`errpt`**命令的输出，而不是真实文件。
- en: '**`criticalpatterns`**'
  id: totrans-1075
  prefs: []
  type: TYPE_NORMAL
  zh: '**`criticalpatterns`**'
- en: 'Like the command line option **`--criticalpattern`**, except that now a number
    of expressions may be specified as an array:'
  id: totrans-1076
  prefs: []
  type: TYPE_NORMAL
  zh: 与命令行选项**`--criticalpattern`**类似，但现在可以指定多个表达式作为数组：
- en: '[PRE129]'
  id: totrans-1077
  prefs: []
  type: TYPE_PRE
  zh: '[PRE129]'
- en: The exclamation mark ensures a CRITICAL if no line is found with the text **`dontcryforme`**.
  id: totrans-1078
  prefs: []
  type: TYPE_NORMAL
  zh: 感叹号确保如果没有找到包含文本**`dontcryforme`**的行，则状态为CRITICAL。
- en: '**`criticalexceptions`**'
  id: totrans-1079
  prefs: []
  type: TYPE_NORMAL
  zh: '**`criticalexceptions`**'
- en: 'Like **`criticalpatterns`**, except as an exception: If a line matches an expression
    from **`criticalpatterns`**, a CRITICAL would be triggered. If an expression from
    **`criticalexceptions`** also matches this very same line, this then stops the
    critical state. The instruction is used to intercept special cases.'
  id: totrans-1080
  prefs: []
  type: TYPE_NORMAL
  zh: 与**`criticalpatterns`**类似，但作为例外：如果一行匹配**`criticalpatterns`**中的表达式，则会触发CRITICAL状态。如果**`criticalexceptions`**中的表达式也匹配此行，则停止临界状态。该指令用于拦截特殊情况。
- en: '**`criticalthreshold`**'
  id: totrans-1081
  prefs: []
  type: TYPE_NORMAL
  zh: '**`criticalthreshold`**'
- en: Sets a threshold. The value **`5`**, for example, means that only every fifth
    match from **`criticalpatterns`** is really counted as CRITICAL. Below this threshold,
    the result remains OK.
  id: totrans-1082
  prefs: []
  type: TYPE_NORMAL
  zh: 设置一个阈值。例如，值**`5`**表示只有来自**`criticalpatterns`**的每第五个匹配项才真正被计为CRITICAL。低于此阈值，结果保持为OK。
- en: '**`warningpatterns`**'
  id: totrans-1083
  prefs: []
  type: TYPE_NORMAL
  zh: '**`warningpatterns`**'
- en: Like **`criticalpatterns`**, except for warnings.
  id: totrans-1084
  prefs: []
  type: TYPE_NORMAL
  zh: 与**`criticalpatterns`**类似，但针对警告。
- en: '**`warningexceptions`**'
  id: totrans-1085
  prefs: []
  type: TYPE_NORMAL
  zh: '**`warningexceptions`**'
- en: Like **`criticalexceptions`**, except for warnings.
  id: totrans-1086
  prefs: []
  type: TYPE_NORMAL
  zh: 与**`criticalexceptions`**类似，但针对警告。
- en: '**`warningthreshold`**'
  id: totrans-1087
  prefs: []
  type: TYPE_NORMAL
  zh: '**`warningthreshold`**'
- en: Like **`criticalthreshold`**, except for warnings.
  id: totrans-1088
  prefs: []
  type: TYPE_NORMAL
  zh: 与**`criticalthreshold`**类似，但针对警告。
- en: '**`okpatterns`**'
  id: totrans-1089
  prefs: []
  type: TYPE_NORMAL
  zh: '**`okpatterns`**'
- en: Sometimes errors can rectify themselves. In such cases the administrator does
    not want to be woken up by unnecessary alarms.
  id: totrans-1090
  prefs: []
  type: TYPE_NORMAL
  zh: 有时错误可以自行纠正。在这种情况下，管理员不希望被不必要的警报唤醒。
- en: '**`okpatterns`** cancels all previous WARNINGs and CRITICALs. It is possible
    to specify multiple details (see **`criticalpatterns`**).'
  id: totrans-1091
  prefs: []
  type: TYPE_NORMAL
  zh: '**`okpatterns`**取消所有之前的WARNINGs和CRITICALs。可以指定多个细节（见**`criticalpatterns`**）。'
- en: '**`script`**'
  id: totrans-1092
  prefs: []
  type: TYPE_NORMAL
  zh: '**`script`**'
- en: 'Allows a script to be executed in case a match is found. To following instructions
    supplement this: **`scriptparams`** passes additional command line options to
    the script, **`scriptstdin`** allows to specify strings that are expected by the
    script on STDIN, and **`scriptdelay`** forces **`check_logfiles`** to take a break
    after the script has been executed.'
  id: totrans-1093
  prefs: []
  type: TYPE_NORMAL
  zh: 允许在找到匹配项时执行脚本。以下指令补充了这一点：**`scriptparams`**将额外的命令行选项传递给脚本，**`scriptstdin`**允许指定脚本期望的STDIN字符串，而**`scriptdelay`**强制**`check_logfiles`**在脚本执行后暂停。
- en: '**`options`**'
  id: totrans-1094
  prefs: []
  type: TYPE_NORMAL
  zh: '**`options`**'
- en: 'This instruction allows further settings options to be made, the meanings of
    which can be negated by placing the prefix **`no`** in front of the option:'
  id: totrans-1095
  prefs: []
  type: TYPE_NORMAL
  zh: 此指令允许进一步设置选项，其含义可以通过在选项前放置前缀**`no`**来否定：
- en: '**`script`**'
  id: totrans-1096
  prefs: []
  type: TYPE_NORMAL
  zh: '**`script`**'
- en: Executes the specified script. The default is **`noscript`**.
  id: totrans-1097
  prefs: []
  type: TYPE_NORMAL
  zh: 执行指定的脚本。默认是**`noscript`**。
- en: '**`smartscript`**'
  id: totrans-1098
  prefs: []
  type: TYPE_NORMAL
  zh: '**`smartscript`**'
- en: Controls whether the return value of the script and its output should be included
    in the match list. The default is **`nosmartscript`**.
  id: totrans-1099
  prefs: []
  type: TYPE_NORMAL
  zh: 控制脚本的返回值及其输出是否应包含在匹配列表中。默认是**`nosmartscript`**。
- en: '**`supersmartscript`**'
  id: totrans-1100
  prefs: []
  type: TYPE_NORMAL
  zh: '**`supersmartscript`**'
- en: Defines whether the return value and the output of the script should replace
    previous matches (the default is **`nosupersmartscript`**). The return value **`0`**
    (OK) of the script would, for example, suppress a found match, by overwriting
    the return value that is normally returned by **`check_logfiles`**.
  id: totrans-1101
  prefs: []
  type: TYPE_NORMAL
  zh: 定义了脚本的返回值和输出是否应该替换之前的匹配（默认是**`nosupersmartscript`**）。例如，脚本的返回值**`0`**（OK）将抑制一个找到的匹配项，通过覆盖通常由**`check_logfiles`**返回的返回值。
- en: '**`protocol`**'
  id: totrans-1102
  prefs: []
  type: TYPE_NORMAL
  zh: '**`protocol`**'
- en: Controls whether matches are to be retained in a separate log file. (The default
    is **`protocol`**).
  id: totrans-1103
  prefs: []
  type: TYPE_NORMAL
  zh: 控制是否将匹配项保留在单独的日志文件中。（默认是**`protocol`**）。
- en: '**`count`**'
  id: totrans-1104
  prefs: []
  type: TYPE_NORMAL
  zh: '**`count`**'
- en: Should matches be counted or not? **`count`** is the default. If this option
    is switched off with **`nocount`**, you can still use **`check_logfiles`** to
    just execute scripts.
  id: totrans-1105
  prefs: []
  type: TYPE_NORMAL
  zh: 是否应该计数匹配项？**`count`**是默认值。如果使用**`nocount`**关闭此选项，你仍然可以使用**`check_logfiles`**来仅执行脚本。
- en: '**`syslogserver`**'
  id: totrans-1106
  prefs: []
  type: TYPE_NORMAL
  zh: '**`syslogserver`**'
- en: Corresponds to the option **`--syslogserver`** (the default is **`nosyslogserver`**).
  id: totrans-1107
  prefs: []
  type: TYPE_NORMAL
  zh: 对应于**`--syslogserver`**选项（默认是**`nosyslogserver`**）。
- en: '**`syslogclient=string`**'
  id: totrans-1108
  prefs: []
  type: TYPE_NORMAL
  zh: '**`syslogclient=string`**'
- en: Like **`--syslogclient`**, except that an additional filter may be specified,
    for example, to search only for the files of a specific client (**`nosyslogclient`**
    is the default).
  id: totrans-1109
  prefs: []
  type: TYPE_NORMAL
  zh: 与**`--syslogclient`**类似，但可以指定一个额外的过滤器，例如，仅搜索特定客户端的文件（默认是**`nosyslogclient`**）。
- en: '**`perfdata`**'
  id: totrans-1110
  prefs: []
  type: TYPE_NORMAL
  zh: '**`perfdata`**'
- en: Should performance data be displayed? The default is **`perfdata`**.
  id: totrans-1111
  prefs: []
  type: TYPE_NORMAL
  zh: 是否应该显示性能数据？默认是**`perfdata`**。
- en: '**`logfilenocry`**'
  id: totrans-1112
  prefs: []
  type: TYPE_NORMAL
  zh: '**`logfilenocry`**'
- en: If a log file does not exist, **`check_logfiles`** outputs UNKNOWN, in accordance
    with the default, **`logfilenocry`**. The parameter **`nologfilenocry`** tells
    the plugin to omit an error message if the log file is missing.
  id: totrans-1113
  prefs: []
  type: TYPE_NORMAL
  zh: 如果日志文件不存在，**`check_logfiles`**将输出UNKNOWN，按照默认的**`logfilenocry`**。参数**`nologfilenocry`**告诉插件如果日志文件缺失则省略错误信息。
- en: '**`case nocase`**'
  id: totrans-1114
  prefs: []
  type: TYPE_NORMAL
  zh: '**`case nocase`**'
- en: ignores upper/lower case. The default, with case, is the opposite of this.
  id: totrans-1115
  prefs: []
  type: TYPE_NORMAL
  zh: 忽略大小写。默认情况下，带有大小写的情况与这种情况相反。
- en: '**`sticky=seconds`**'
  id: totrans-1116
  prefs: []
  type: TYPE_NORMAL
  zh: '**`sticky=seconds`**'
- en: With this option **`check_logfiles`** notices an error state for the amount
    of time specified. Normally a subsequent check that does not find any more matches
    would return an OK, so that the administrator might overlook an important entry.
  id: totrans-1117
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此选项**`check_logfiles`**会注意到指定时间内的错误状态。通常，后续的检查如果没有找到更多匹配项，将返回OK，这样管理员可能会忽略一个重要的条目。
- en: Let us assume that you only accept the truce when there have been no more matches
    in the log file for two hours. Then the check with **`sticky=7200`** will announce
    an error state for up to two hours. Only after this period has expired will **`check_logfiles`**
    return to an OK, provided that in the meantime no new entry restarts the two-hour
    time limit.
  id: totrans-1118
  prefs: []
  type: TYPE_NORMAL
  zh: 假设你只有在日志文件中没有更多匹配项两小时后才接受休战。那么使用**`sticky=7200`**的检查将宣布一个错误状态长达两小时。只有在这一时期过后，如果在此期间没有新的条目重新启动两小时的时间限制，**`check_logfiles`**才会返回OK。
- en: If the search pattern contains **`okpattern`**, **`check_logfiles`** returns
    an OK directly after a match, that is, before the specified time has expired.
  id: totrans-1119
  prefs: []
  type: TYPE_NORMAL
  zh: 如果搜索模式包含**`okpattern`**，**`check_logfiles`**将在匹配后直接返回OK，即在指定时间到期之前。
- en: '**`savethresholdcount`**'
  id: totrans-1120
  prefs: []
  type: TYPE_NORMAL
  zh: '**`savethresholdcount`**'
- en: If an event does not attain the number of matches required in the **`*threshold`**
    options, no error is announced. The question here is how the matches overall should
    be handled. **`savethresholdcount`** (the default) saves the number of matches
    until the next check and adds these together until the threshold is reached and
    an error is triggered. The parameter **`nosavethresholdcount`** prevents the event
    counter from always being reset to zero between two checks.
  id: totrans-1121
  prefs: []
  type: TYPE_NORMAL
  zh: 如果事件没有达到**`*threshold`**选项中要求的匹配数量，则不会宣布错误。这里的问题是整体上应该如何处理匹配。**`savethresholdcount`**（默认值）将匹配数量保存到下一次检查，并将这些数量相加，直到达到阈值并触发错误。**`nosavethresholdcount`**参数防止事件计数器在两次检查之间总是重置为零。
- en: It is beyond the scope of this book to describe all the possible applications
    of **`check_logfiles`**. For this reason, we refer to the documentation, available
    in German and English, on the **`check_logfiles`** Web site.^([[78](#ftn.CHP-7-FN-8)])
  id: totrans-1122
  prefs: []
  type: TYPE_NORMAL
  zh: 本书不涉及所有可能的**`check_logfiles`**应用。因此，我们参考**`check_logfiles`**网站上的文档，该文档有德语和英语版本.^([[78](#ftn.CHP-7-FN-8)])
- en: '* * *'
  id: totrans-1123
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[74](#CHP-7-FN-4)]) [http://www.nagiosexchange.org/54;279](http://www.nagiosexchange.org/54;279)
  id: totrans-1124
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[74](#CHP-7-FN-4)]) [http://www.nagiosexchange.org/54;279](http://www.nagiosexchange.org/54;279)
- en: ^([[75](#CHP-7-FN-5)]) In the form of Perl-compatible regular expressions (PCRE,
    see **`man perlre`**), since **`check_logs.pi`** is a Perl script.
  id: totrans-1125
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[75](#CHP-7-FN-5)]) 以Perl兼容正则表达式（PCRE，见**`man perlre`**）的形式，因为**`check_logs.pi`**是一个Perl脚本。
- en: ^([[76](#CHP-7-FN-6)]) [http://www.consol.de/opensource/nagios/check-logfiles](http://www.consol.de/opensource/nagios/check-logfiles)
  id: totrans-1126
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[76](#CHP-7-FN-6)]) [http://www.consol.de/opensource/nagios/check-logfiles](http://www.consol.de/opensource/nagios/check-logfiles)
- en: ^([[77](#CHP-7-FN-7)]) We are assuming here that the **`daemon`** facility is
    logged with the **`info`** priority in **`/var/log/messages`**. This is dependent
    on the distribution, however. In Debian, such entries land in **`/var/log/daemon.log`**.
  id: totrans-1127
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[77](#CHP-7-FN-7)]) 我们假设**`daemon`**功能以**`info`**优先级记录在**`/var/log/messages`**中。然而，这取决于发行版。在Debian中，此类条目位于**`/var/log/daemon.log`**。
- en: ^([[78](#CHP-7-FN-8)]) [http://www.consol.com/opensource/nagios/check-logfiles](http://www.consol.com/opensource/nagios/check-logfiles)
  id: totrans-1128
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[78](#CHP-7-FN-8)]) [http://www.consol.com/opensource/nagios/check-logfiles](http://www.consol.com/opensource/nagios/check-logfiles)
- en: 7.6 Keeping Tabs on the Number of Logged-In Users
  id: totrans-1129
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.6 监控登录用户数量
- en: 'The plugin **`check_users`** is used to monitor the number of logged-in users:'
  id: totrans-1130
  prefs: []
  type: TYPE_NORMAL
  zh: 插件**`check_users`**用于监控登录用户数量：
- en: '[PRE130]'
  id: totrans-1131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE130]'
- en: 'It has just two options:'
  id: totrans-1132
  prefs: []
  type: TYPE_NORMAL
  zh: 它只有两个选项：
- en: '**`-w`** **``*`number`*``** **`/ --warning=`****``*`number`*``**'
  id: totrans-1133
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`number`*``** **`/ --warning=`****``*`number`*``**'
- en: This is the threshold for the number of logged-in users after which the plugin
    should give a warning.
  id: totrans-1134
  prefs: []
  type: TYPE_NORMAL
  zh: 这是登录用户数量的阈值，超过这个阈值后插件应该发出警告。
- en: '**`-c`** **``*`number`*``** **`/ --critical=`****``*`number`*``**'
  id: totrans-1135
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`number`*``** **`/ --critical=`****``*`number`*``**'
- en: This is the threshold for a critical state, measured by the number of logged-in
    users.
  id: totrans-1136
  prefs: []
  type: TYPE_NORMAL
  zh: 这是临界状态的阈值，通过登录用户数量来衡量。
- en: The performance data after the **`|`** is as usual visible only on the command
    line; Nagios does not include it in the Web interface.
  id: totrans-1137
  prefs: []
  type: TYPE_NORMAL
  zh: '**`|`**后面的性能数据通常仅在命令行中可见；Nagios不会将其包含在Web界面中。'
- en: 7.7 Checking the System Time
  id: totrans-1138
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.7 检查系统时间
- en: 7.7.1 Checking the system time via NTP
  id: totrans-1139
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 7.7.1 通过NTP检查系统时间
- en: The two plugins **`check_ntp`** and **`check_ntp_time`** compare the clock time
    of the local computer with that of an available NTP server in the network. If
    the Nagios server keeps time via NTP accurately enough, so that it can serve as
    a reference itself, then it can also be used as a network plugin, provided that
    the host to be checked in the network has an NTP daemon installed.
  id: totrans-1140
  prefs: []
  type: TYPE_NORMAL
  zh: 两个插件**`check_ntp`**和**`check_ntp_time`**比较本地计算机的时钟时间与网络中可用的NTP服务器的时间。如果Nagios服务器通过NTP准确到足以作为参考，那么它也可以用作网络插件，前提是网络中要检查的主机已安装NTP守护进程。
- en: 'From plugin version 1.4.11, the plugins **`check_ntp_time`** and **`check_ntp_peer`**
    ([6.12 Health Check of an NTP Server with check_ntp_peer](../Text/ch06s15.html
    "6.12 Health Check of an NTP Server with check_ntp_peer"), page 154) replace **`check_ntp`**,
    which contains the functions of both: the comparison of the local system time
    with an NTP server described here and the health check of the NTP server itself.
    The options here apply both to **`check_ntp`** and to **`check_ntp_time`**.'
  id: totrans-1141
  prefs: []
  type: TYPE_NORMAL
  zh: 从插件版本1.4.11开始，插件 **`check_ntp_time`** 和 **`check_ntp_peer`** ([6.12 使用check_ntp_peer检查NTP服务器健康](../Text/ch06s15.html
    "6.12 使用check_ntp_peer检查NTP服务器健康"), 第154页)) 替换了 **`check_ntp`**，它包含两个功能：将本地系统时间与这里描述的NTP服务器进行比较，以及检查NTP服务器本身的健康状态。这里的选项适用于
    **`check_ntp`** 和 **`check_ntp_time`**。
- en: 'In the simplest case, **`check_ntp`** is called, specifying the computer (here:
    **`ntpserver`**) whose time should be compared with that of the local computer:'
  id: totrans-1142
  prefs: []
  type: TYPE_NORMAL
  zh: 在最简单的情况下，**`check_ntp`** 被调用，指定了计算机（此处：**`ntpserver`**），其时间应与本地计算机的时间进行比较：
- en: '[PRE131]'
  id: totrans-1143
  prefs: []
  type: TYPE_PRE
  zh: '[PRE131]'
- en: 'The deviation determined here amounts to just 9.5 milliseconds, a good value.
    How much deviation can be tolerated depends on the particular intended use. If
    you want to compare the log file entries of several different computers, they
    ought to be NTP-synchronized. Then you can certainly use **`-w 1 -c 2`**, that
    is, assign a deviation of two seconds as critical. In environments in which Kerberos
    is used for authentication, time synchronization of all hosts involved is also
    important, but not quite as critical: Microsoft''s Active Directory under Windows
    Server 2003 tolerates a maximum deviation of five minutes, and only when there
    are larger deviations do real problems arise.'
  id: totrans-1144
  prefs: []
  type: TYPE_NORMAL
  zh: 这里确定的偏差仅为9.5毫秒，这是一个很好的值。可以容忍的偏差大小取决于特定的用途。如果您想比较几个不同计算机的日志文件条目，它们应该进行NTP同步。然后您当然可以使用
    **`-w 1 -c 2`**，即分配两秒的偏差作为临界值。在使用Kerberos进行身份验证的环境中，所有涉及的主机的时间同步也很重要，但并不那么关键：Windows
    Server 2003下的Microsoft Active Directory可以容忍最大五分钟的偏差，只有在出现更大的偏差时才会真正出现问题。
- en: '**`check_ntp_time`** and **`check_ntp`** have the following options:'
  id: totrans-1145
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_ntp_time`** 和 **`check_ntp`** 具有以下选项：'
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  id: totrans-1146
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`地址`*``** **`/ --host=`****``*`地址`*``**'
- en: This is the NTP server with which the plugin should compare the local system
    time.
  id: totrans-1147
  prefs: []
  type: TYPE_NORMAL
  zh: 这是插件应该与之比较本地系统时间的NTP服务器。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-1148
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`端口`*``** **`/ --port=`****``*`端口`*``**'
- en: The UDP port on which the NTP server runs. The default is port **`123`**.
  id: totrans-1149
  prefs: []
  type: TYPE_NORMAL
  zh: NTP服务器运行的UDP端口。默认端口为 **`123`**。
- en: '**`-w`** **``*`threshold`*``** **`/ --warning=`****``*`threshold`*``**'
  id: totrans-1150
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`阈值`*``** **`/ --warning=`****``*`阈值`*``**'
- en: This is the warning limit, specified in the standard threshold format ([24.1.5
    Specifying thresholds](../Text/ch24.html#specifying_thresholds "24.1.5 Specifying
    thresholds"), page 557). The warning is given if the fluctuation of the local
    system time is larger than the threshold specified. The default is 60 seconds.
  id: totrans-1151
  prefs: []
  type: TYPE_NORMAL
  zh: 这是警告限制，按照标准阈值格式指定（[24.1.5 指定阈值](../Text/ch24.html#specifying_thresholds "24.1.5
    指定阈值"), 第557页）。如果本地系统时间的波动大于指定的阈值，则发出警告。默认值为60秒。
- en: '**`-c`** **``*`threshold`*``** **`/ --critical=`****``*`threshold`*``**'
  id: totrans-1152
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`阈值`*``** **`/ --critical=`****``*`阈值`*``**'
- en: Critical threshold in seconds, specified in the standard threshold format ([24.1.5
    Specifying thresholds](../Text/ch24.html#specifying_thresholds "24.1.5 Specifying
    thresholds"), page 557). If the local system time deviates more than the given
    number of seconds (in the default setting 120 seconds) from that of the NTP server,
    the status becomes CRITICAL.
  id: totrans-1153
  prefs: []
  type: TYPE_NORMAL
  zh: 以秒为单位的临界阈值，按照标准阈值格式指定（[24.1.5 指定阈值](../Text/ch24.html#specifying_thresholds
    "24.1.5 指定阈值"), 第557页）。如果本地系统时间与NTP服务器的时间偏差超过给定的秒数（默认设置120秒），状态变为CRITICAL。
- en: '**`-q / --quiet`** (only **`check_ntp_time`**)'
  id: totrans-1154
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-q / --quiet`** (仅 **`check_ntp_time`**)'
- en: Returns UNKNOWN instead of CRITICAL if the NTP server-for whatever reason-does
    not provide an offset.
  id: totrans-1155
  prefs: []
  type: TYPE_NORMAL
  zh: 如果NTP服务器由于任何原因不提供偏移量，则返回UNKNOWN而不是CRITICAL。
- en: 7.7.2 Checking system time with the time protocol
  id: totrans-1156
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 7.7.2 使用时间协议检查系统时间
- en: 'Apart from the *Network Time Protocol* NTP there is another protocol, older
    and more simple: the *Time Protocol* described in RFC 868, in which communication
    takes place via TCP port 37\. On many Unix systems the corresponding server is
    integrated into the inet daemon, so you do not have to start a separate daemon.
    With **`check_time`**, Nagios provides an appropriate test plugin.'
  id: totrans-1157
  prefs: []
  type: TYPE_NORMAL
  zh: 除了*网络时间协议* NTP之外，还有另一个更老、更简单的协议：RFC 868中描述的*时间协议*，其中通信通过TCP端口37进行。在许多Unix系统中，相应的服务器集成到inet守护进程，因此您不需要启动单独的守护进程。使用**`check_time`**，Nagios提供了一个适当的测试插件。
- en: '**`check_time`** can also be used as a network plugin, in a similar way to
    **`check_ntp`**, but this again assumes that the time service is available for
    every client. In most cases it will therefore be used as a local plugin that compares
    its own clock time with that of a central time server (here: **`timesrv`**):'
  id: totrans-1158
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_time`**也可以用作网络插件，类似于**`check_ntp`**，但这也假设每个客户端都可用时间服务。因此，在大多数情况下，它将用作本地插件，将其自己的时钟时间与中央时间服务器的时间进行比较（此处：**`timesrv`**）：'
- en: '[PRE132]'
  id: totrans-1159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE132]'
- en: 'The performance data after the **`|`** sign, not shown in the Web interface,
    contains the response time in seconds, with **`time`** (here: zero seconds); **`offset`**
    describes by how much the clock time differs from that of the time server (here:
    **`1160`** seconds). The other values, each separated by a semicolon, provide
    the warning limit, the critical threshold, and the minimum (see also [19.1 Processing
    Plugin Performance Data with Nagios](../Text/ch19.html#processing_plugin_performance_data_with
    "19.1 Processing Plugin Performance Data with Nagios") from page 404). Since we
    have not set any threshold values with the options **`-W`** or **`-C`**, the corresponding
    entries for **`time`** are empty'
  id: totrans-1160
  prefs: []
  type: TYPE_NORMAL
  zh: '**`|`**符号后面的性能数据，在Web界面中未显示，包含以秒为单位的响应时间，**`time`**（此处：零秒）；**`offset`**描述时钟时间与时间服务器时间差异的程度（此处：**`1160`**秒）。其他值，每个值由分号分隔，提供警告限制、关键阈值和最小值（另见[19.1
    使用Nagios处理插件性能数据](../Text/ch19.html#processing_plugin_performance_data_with "19.1
    使用Nagios处理插件性能数据")，第404页）。由于我们没有使用**`-W`**或**`-C`**选项设置任何阈值值，因此**`time`**的相应条目为空。'
- en: '**`check_time`** has the following options:'
  id: totrans-1161
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_time`**有以下选项：'
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  id: totrans-1162
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`地址`*``** **`/ --主机名=`****``*`地址`*``**'
- en: This is the host name or IP address of the time server.
  id: totrans-1163
  prefs: []
  type: TYPE_NORMAL
  zh: 这是时间服务器的计算机名或IP地址。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-1164
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`端口`*``** **`/ --端口=`****``*`端口`*``**'
- en: This is the TCP port specification, if different from the default **`37`**.
  id: totrans-1165
  prefs: []
  type: TYPE_NORMAL
  zh: 这是TCP端口指定，如果与默认的**`37`**不同。
- en: '**`-u / --udp`**'
  id: totrans-1166
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u / --udp`**'
- en: Normally the time server is queried via TCP. With **`-u`** you can use UDP if
    the server supports this.
  id: totrans-1167
  prefs: []
  type: TYPE_NORMAL
  zh: 通常通过TCP查询时间服务器。使用**`-u`**，如果服务器支持，可以使用UDP。
- en: '**`-w`** **``*`integer`*``** **`/ --warning-variance=`****``*`integer`*``**'
  id: totrans-1168
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`整数`*``** **`/ --警告偏差=`****``*`整数`*``**'
- en: If the local time deviates more than **``*`integer`*``** seconds from that of
    the time server, the plugin returns a WARNING. **``*`integer`*``** is always positive,
    and this covers clocks that are running both slow and fast.
  id: totrans-1169
  prefs: []
  type: TYPE_NORMAL
  zh: 如果本地时间与时间服务器的时间差异超过**``*`整数`*``**秒，插件返回WARNING。**``*`整数`*``**始终为正数，这涵盖了运行速度慢和快的时钟。
- en: '**`-c`** **``*`integer`*``** **`/ --critical-variance=`****``*`integer`*``**'
  id: totrans-1170
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`整数`*``** **`/ --关键偏差=`****``*`整数`*``**'
- en: If there is more than **``*`integer`*``** seconds difference between the local
    and the time server time, the return value of the plugin is CRITICAL.
  id: totrans-1171
  prefs: []
  type: TYPE_NORMAL
  zh: 如果本地时间和时间服务器时间之间的差异超过**``*`整数`*``**秒，该插件的返回值为CRITICAL。
- en: '**`-W`** **``*`integer`*``** **`/ --warning-connect=`****``*`integer`*``**'
  id: totrans-1172
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-W`** **``*`整数`*``** **`/ --警告连接=`****``*`整数`*``**'
- en: If the time server needs more than **``*`integer`*``** seconds for the response,
    a WARNING is returned.
  id: totrans-1173
  prefs: []
  type: TYPE_NORMAL
  zh: 如果时间服务器需要超过**``*`整数`*``**秒的响应时间，则返回WARNING。
- en: '**`-C`** **``*`integer`*``** **`/ --critical-connect=`****``*`integer`*``**'
  id: totrans-1174
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`整数`*``** **`/ --关键连接=`****``*`整数`*``**'
- en: If the time server does not respond within **``*`integer`*``** seconds, the
    plugin reacts with the return value CRITICAL.
  id: totrans-1175
  prefs: []
  type: TYPE_NORMAL
  zh: 如果时间服务器在**``*`整数`*``**秒内没有响应，插件将以CRITICAL返回值响应。
- en: 7.8 Regularly Checking the Status of the Mail Queue
  id: totrans-1176
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.8 定期检查邮件队列状态
- en: 'The **`check_mailq`** plugin can be used to monitor the mail queue of a mail
    server for e-mails that have not yet been delivered. **`check_mailq`** runs the
    program **`mailq`** of the mail service installed. Unfortunately each MTA interprets
    the mail queue differently, so the plugin can evaluate only mail queues from mail
    services that the programmer has taken into account. These are, specifically:
    **`sendmail`**, **`qmail`**, **`postfix`**, and **`exim`**. The **`check_mailq`**
    plugin has the following options:'
  id: totrans-1177
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_mailq`** 插件可以用来监控邮件服务器的邮件队列，以监控尚未投递的电子邮件。**`check_mailq`** 运行已安装的邮件服务的
    **`mailq`** 程序。不幸的是，每个 MTA 对邮件队列的解释都不同，因此插件只能评估程序员考虑到的邮件服务的邮件队列。这些是：**`sendmail`**、**`qmail`**、**`postfix`**
    和 **`exim`**。**`check_mailq`** 插件有以下选项：'
- en: '**`-w`** **``*`number`*``** **`/ --warning=`****``*`number`*``**'
  id: totrans-1178
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`number`*``** **`/ --warning=`****``*`number`*``**'
- en: If there are at least **``*`number`*``** mails in the mail queue, the plugin
    gives a warning.
  id: totrans-1179
  prefs: []
  type: TYPE_NORMAL
  zh: 如果邮件队列中至少有 **``*`number`*``** 封邮件，插件会发出警告。
- en: '**`-c`** **``*`number`*``** **`/ --critical=`****``*`number`*``**'
  id: totrans-1180
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`number`*``** **`/ --critical=`****``*`number`*``**'
- en: As soon as there are at least **``*`number`*``** of mails in the queue waiting
    to be delivered, then the critical status has been reached.
  id: totrans-1181
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦队列中有至少 **``*`number`*``** 封邮件等待投递，则达到临界状态。
- en: '**`-W`** **``*`number_of_domains`*``** **`/ --Warning=`****``*`number_of_domains`*``**'
  id: totrans-1182
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-W`** **``*`number_of_domains`*``** **`/ --Warning=`****``*`number_of_domains`*``**'
- en: This is the warning limit with respect to the number of recipient domains of
    a message waiting in the mail queue. Thus **`-W 3`** generates a warning if there
    are any mails in the queue that are addressed to three or more different recipient
    domains.
  id: totrans-1183
  prefs: []
  type: TYPE_NORMAL
  zh: 这是关于邮件队列中等待消息的接收者域数量的警告限制。因此 **`-W 3`** 如果队列中有任何邮件被发送到三个或更多不同的接收者域，则会发出警告。
- en: '**`-C`** **``*`number_of_domains`*``** **`/ --Critical=`****``*`number_of_domains`*``**'
  id: totrans-1184
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`number_of_domains`*``** **`/ --Critical=`****``*`number_of_domains`*``**'
- en: This is the critical threshold with respect to the number of recipient domains
    (like **`-W`**).
  id: totrans-1185
  prefs: []
  type: TYPE_NORMAL
  zh: 这是关于接收者域数量（如 **`-W`**）的临界阈值。
- en: '**`-M`** **``*`daemon`*``** **`/ --mailserver=`****``*`daemon`*``** (from version
    1.4)'
  id: totrans-1186
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-M`** **``*`daemon`*``** **`/ --mailserver=`****``*`daemon`*``**（从版本 1.4
    开始）'
- en: This specifies the mail service used. Possible values for **``*`daemon`*``**
    are **`sendmail`** (the default), **`qmail`**, **`postfix`**, and **`exim`**.
  id: totrans-1187
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了使用的邮件服务。**``*`daemon`*``** 的可能值是 **`sendmail`**（默认值）、**`qmail`**、**`postfix`**
    和 **`exim`**。
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  id: totrans-1188
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
- en: After **``*`timeout`*``** seconds, the plugin stops the test and returns the
    CRITICAL status. The default here—as an exception—is **`15`** seconds (usually
    it is 10 seconds).
  id: totrans-1189
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **``*`timeout`*``** 秒后，插件停止测试并返回 CRITICAL 状态。这里作为一个例外，默认值是 **`15`** 秒（通常为
    10 秒）。
- en: 'In the following example, Nagios should give a warning if there are at least
    five mails in the queue; if the number reaches ten, the status of the MTAs Postfix
    used here becomes CRITICAL:'
  id: totrans-1190
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下示例中，如果队列中至少有五封邮件，Nagios 应该发出警告；如果数量达到十封，这里使用的 MTAs Postfix 的状态变为 CRITICAL：
- en: '[PRE133]'
  id: totrans-1191
  prefs: []
  type: TYPE_PRE
  zh: '[PRE133]'
- en: Since the queue is empty, **`check_mailq`** returns OK here.
  id: totrans-1192
  prefs: []
  type: TYPE_NORMAL
  zh: 由于队列是空的，**`check_mailq`** 在这里返回 OK。
- en: 7.9 Keeping an Eye on the Modification Date of a File
  id: totrans-1193
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.9 监控文件的修改日期
- en: 'With the **`check_file_age`** plugin you can monitor not only the last modification
    date of a file, but also its size. In the simplest case it is just run with the
    name and path of the file to be monitored:'
  id: totrans-1194
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 **`check_file_age`** 插件，您可以监控文件的最后修改日期，也可以监控其大小。在最简单的情况下，它只是运行要监控的文件名和路径：
- en: '[PRE134]'
  id: totrans-1195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE134]'
- en: Here the plugin gives a warning, since the warning limit set is 240 seconds
    and the critical limit, 600 seconds. The last modification of the file was 376
    seconds ago—that is, inside the warning range.
  id: totrans-1196
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，由于设置的警告限制是 240 秒，临界限制是 600 秒，插件发出警告。文件的最后修改是在 376 秒前——即在警告范围内。
- en: The file size is taken into account by **`check_file_age`** only if a warning
    limit for the file size (option **`-W`**) is explicitly specified. The plugin
    could then give a warning if the file is smaller than the given limit (in bytes).
    The defaults for the warning and critical limits here are both zero bytes.
  id: totrans-1197
  prefs: []
  type: TYPE_NORMAL
  zh: 只有在显式指定文件大小的警告限制（选项 **`-W`**）时，**`check_file_age`** 才会考虑文件大小。然后，如果文件小于给定的限制（以字节为单位），插件可以发出警告。这里的警告和临界限制的默认值都是零字节。
- en: '**`check_file_age`** has the following options:'
  id: totrans-1198
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_file_age`** 具有以下选项：'
- en: '**`-w`** **``*`integer`*``** **`/ --warning-age=`****``*`integer`*``**'
  id: totrans-1199
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`整数`*``** **`/ --warning-age=`****``*`整数`*``**'
- en: If the file is older than **``*`integer`*``**^([[79](#ftn.CHP-7-FN-9)]) (the
    default is **`240`**) seconds, the plugin issues a warning.
  id: totrans-1200
  prefs: []
  type: TYPE_NORMAL
  zh: 如果文件比 **``*`整数`*``**^([[79](#ftn.CHP-7-FN-9)])（默认为 **`240`**）秒旧，插件会发出警告。
- en: '**`-c`** **``*`integer`*``** **`/ --critical-age=`****``*`integer`*``**'
  id: totrans-1201
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`整数`*``** **`/ --critical-age=`****``*`整数`*``**'
- en: 'A critical status occurs if the file is older than **``*`integer`*``** (default:
    **`600`**) seconds.'
  id: totrans-1202
  prefs: []
  type: TYPE_NORMAL
  zh: 如果文件比 **``*`整数`*``**（默认：**`600`**）秒旧，则会发生临界状态。
- en: '**`-W`** **``*`size`*``** **`/ --warning-size=`****``*`size`*``**'
  id: totrans-1203
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-W`** **``*`大小`*``** **`/ --warning-size=`****``*`大小`*``**'
- en: If the file is smaller than **``*`size`*``** bytes, the plugin gives a warning.
    If the option is omitted, **`0`** bytes is the limit. In this case **`check_file_age`**
    does not take the file size into account.
  id: totrans-1204
  prefs: []
  type: TYPE_NORMAL
  zh: 如果文件小于 **``*`大小`*``** 字节，插件会发出警告。如果省略了选项，**`0`** 字节是限制。在这种情况下，**`check_file_age`**
    不考虑文件大小。
- en: '**`-C`** **``*`size`*``** **`/ --critical-size=`****``*`size`*``**'
  id: totrans-1205
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`大小`*``** **`/ --critical-size=`****``*`大小`*``**'
- en: A file size smaller than **``*`size`*``** bytes sets off a critical status.
    The default is **`0`** bytes, which means that the file size is ignored.
  id: totrans-1206
  prefs: []
  type: TYPE_NORMAL
  zh: 如果文件大小小于 **``*`大小`*``** 字节，则会触发临界状态。默认值为 **`0`** 字节，这意味着文件大小被忽略。
- en: '**`-f`** **``*`file`*``** **`/ --file=`****``*`file`*``**'
  id: totrans-1207
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-f`** **``*`文件`*``** **`/ --file=`****``*`文件`*``**'
- en: The name of the file to be tested. The option may be omitted if you instead—as
    in the above example—just give the file name itself as an argument.
  id: totrans-1208
  prefs: []
  type: TYPE_NORMAL
  zh: 要测试的文件名。如果像上面的例子一样，您直接提供文件名作为参数，则可以省略此选项。
- en: '* * *'
  id: totrans-1209
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[79](#CHP-7-FN-9)]) Because **`check_file_age`** is a Perl script, it does
    not matter in this case whether an integer or a floating point decimal is specified.
    Fractions of a second do not play a role in the file system.
  id: totrans-1210
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[79](#CHP-7-FN-9)]) 因为 **`check_file_age`** 是一个 Perl 脚本，所以在这种情况下指定整数或浮点小数没有关系。在文件系统中，秒的分数不起作用。
- en: 7.10 Monitoring UPSs with apcupsd
  id: totrans-1211
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.10 使用 apcupsd 监控不间断电源（UPS）
- en: To monitor uninterruptible power supplies (UPS) from the company APC there is
    the possibility, apart from the Network UPS Tools described in [6.11 Monitoring
    UPS with the Network UPS Tools](../Text/ch06s14.html "6.11 Monitoring UPS with
    the Network UPS Tools") from page 149 of using the **`apcupsd`** daemon, optimized
    specifically for use with these UPSs. The software can be obtained from [http://www.apcupsd.com/](http://www.apcupsd.com/)
    and is licensed under the GPL, despite the fact that it is vendor-dependent.
  id: totrans-1212
  prefs: []
  type: TYPE_NORMAL
  zh: 要监控来自 APC 公司的不间断电源（UPS），除了在 [6.11 使用网络 UPS 工具监控 UPS](../Text/ch06s14.html "6.11
    使用网络 UPS 工具监控 UPS") 中描述的网络 UPS 工具外，还可以使用专门针对这些 UPS 优化的 **`apcupsd`** 守护进程。软件可以从
    [http://www.apcupsd.com/](http://www.apcupsd.com/) 获取，并且尽管它依赖于供应商，但遵循 GPL 许可。
- en: The principal function here is the capacity to be able to shut down systems
    in the event of power failure, rather than a mere monitoring function with Nagios.
    For this latter purpose, it is easier to configure the Network UPS Tools.
  id: totrans-1213
  prefs: []
  type: TYPE_NORMAL
  zh: 主要功能是在断电事件发生时能够关闭系统，而不仅仅是 Nagios 的监控功能。对于后者，配置网络 UPS 工具更容易。
- en: 'Nearly all Linux distributions contain a working **`apcupsd`** package,^([[80](#ftn.CHP-7-FN-10)])
    so you don''t have to worry about installing it. Nagios does not include an **`apcupsd`**
    plugin, but there is a very simple and effective script available for download
    at [http://www.negativel.org/check_apc/](http://www.negativel.org/check_apc/):
    **`check_apc`**.^([[81](#ftn.CHP-7-FN-11)]) It is also licensed under the GPL,
    but it has no network capabilities. The plugin cannot be given a host when it
    is run, and it also does not support any other types of options. Instead of this,
    internal commands control its functionality, which are given as the first argument.'
  id: totrans-1214
  prefs: []
  type: TYPE_NORMAL
  zh: 几乎所有 Linux 发行版都包含一个可用的 **`apcupsd`** 软件包，^([[80](#ftn.CHP-7-FN-10)]) 因此您无需担心安装问题。Nagios
    不包含 **`apcupsd`** 插件，但有一个非常简单且有效的脚本可供下载，网址为 [http://www.negativel.org/check_apc/](http://www.negativel.org/check_apc/)：**`check_apc`**.^([[81](#ftn.CHP-7-FN-11)])
    它也遵循 GPL 许可，但没有网络功能。插件运行时不能指定主机，也不支持任何其他类型的选项。相反，内部命令控制其功能，这些命令作为第一个参数给出。
- en: 'Executing **`check_apc status`** tests whether the UPS is online. If this is
    the case, the plugin returns the OK status, in all other cases it returns CRITICAL:'
  id: totrans-1215
  prefs: []
  type: TYPE_NORMAL
  zh: 执行 **`check_apc status`** 测试 UPS 是否在线。如果是这样，插件返回 OK 状态，在其他所有情况下返回 CRITICAL：
- en: '[PRE135]'
  id: totrans-1216
  prefs: []
  type: TYPE_PRE
  zh: '[PRE135]'
- en: '**`check_apc load`** **``*`warn crit`*``** checks the load currently on the
    UPS and displays it as a percentage of the maximum capacity A warning is given
    if the load is greater than the warning limits specified in **``*`warn`*``** (in
    the following example, 60 percent), CRITICAL if the load is greater than **``*`crit`*``**
    (here 80 percent):'
  id: totrans-1217
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_apc load`** **``*`warn crit`*``** 检查UPS当前的负载，并以最大容量的百分比显示。如果负载超过**``*`warn`*``**（以下示例中为60%）指定的警告限制，则发出警告；如果负载超过**``*`crit`*``**（此处为80%），则发出CRITICAL。'
- en: '[PRE136]'
  id: totrans-1218
  prefs: []
  type: TYPE_PRE
  zh: '[PRE136]'
- en: 'The load status of the UPS is checked by the command **`check_apc bcharge`**
    **``*`warn crit`*``**. Here the warning limit warn and the critical limit **``*`crit`*``**
    are also given in percent. The value **`100`** means "fully loaded." The plugin
    accordingly gives a warning if the load is smaller than the warning limit, and
    a CRITICAL if the load is smaller than the critical limit:'
  id: totrans-1219
  prefs: []
  type: TYPE_NORMAL
  zh: UPS的负载状态通过命令**`check_apc bcharge`** **``*`warn crit`*``**进行检查。在这里，警告限制**``*`warn`*``**和临界限制**``*`crit`*``**也以百分比给出。值**`100`**表示“完全加载”。插件相应地如果负载小于警告限制则发出警告，如果负载小于临界限制则发出CRITICAL。
- en: '[PRE137]'
  id: totrans-1220
  prefs: []
  type: TYPE_PRE
  zh: '[PRE137]'
- en: 'You can find out how long the saved energy will last with **`check_apc time`**
    **``*`warn crit`*``**. Here **`check_apc`** gives a warning if the remaining time
    is less than **``*`warn`*``** minutes, and a CRITICAL if the remaining time is
    less than **``*`crit`*``** minutes:'
  id: totrans-1221
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用**`check_apc time`** **``*`warn crit`*``**来找出存储的电能可以维持多长时间。在这里，如果剩余时间少于**``*`warn`*``**分钟，则**`check_apc`**发出警告；如果剩余时间少于**``*`crit`*``**分钟，则发出CRITICAL。
- en: '[PRE138]'
  id: totrans-1222
  prefs: []
  type: TYPE_PRE
  zh: '[PRE138]'
- en: '* * *'
  id: totrans-1223
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[80](#CHP-7-FN-10)]) At least SuSE and Debian use this package name.
  id: totrans-1224
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[80](#CHP-7-FN-10)]) 至少SuSE和Debian使用这个包名。
- en: '^([[81](#CHP-7-FN-11)]) It can also be obtained at: [http://www.nagiosexchange.org/54;615](http://www.nagiosexchange.org/54;615).'
  id: totrans-1225
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[81](#CHP-7-FN-11)]) 它也可以在以下位置获得：[http://www.nagiosexchange.org/54;615](http://www.nagiosexchange.org/54;615)。
- en: 7.11 Nagios Monitors Itself
  id: totrans-1226
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.11 Nagios 自我监控
- en: 'If necessary, Nagios can even monitor itself: the included plugin, **`check_nagios`**,
    tests, on the one hand, whether Nagios processes are running and, on the other
    hand, the age of the log file **`nagios.log`** in the Nagios **`var`** directory,
    for example, **`/var/nagios/nagios.log`**.'
  id: totrans-1227
  prefs: []
  type: TYPE_NORMAL
  zh: 如果需要，Nagios甚至可以自我监控：包含的插件**`check_nagios`**一方面测试Nagios进程是否正在运行，另一方面测试Nagios
    **`var`** 目录中日志文件**`nagios.log`**的年龄，例如，**`/var/nagios/nagios.log`**。
- en: 'Despite this, the question needs to be asked: if Nagios itself is not running,
    then the system simply cannot perform the plugin, which in turn cannot deliver
    an error message. The solution to this problem consists in having two Nagios servers,
    each of which addresses the locally installed plugin on the opposite server, with
    the help of NRPE (see [Chapter 10](../Text/ch10.html "Chapter 10. The Nagios Remote
    Plugin Executor (NRPE)") from page 213).'
  id: totrans-1228
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管如此，这个问题需要被提出：如果Nagios本身没有运行，那么系统就无法执行插件，进而无法传递错误信息。解决这个问题的方法是拥有两个Nagios服务器，每个服务器都通过NRPE（见第10章，第213页的“Nagios远程插件执行器（NRPE）”）来处理对方服务器上本地安装的插件。
- en: If you have just one Nagios server you can also run **`check_nagios`** alone
    via cron and have the return value checked using a shell script. In this case,
    you take action yourself, as shown in [7.11.1 Running the plugin manually with
    a script](../Text/ch07s11.html#running_the_plugin_manually_with_a_scrip "7.11.1
    Running the plugin manually with a script"), so that you are suitably informed
    of this.
  id: totrans-1229
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你只有一个Nagios服务器，你也可以通过cron单独运行**`check_nagios`**，并使用shell脚本来检查返回值。在这种情况下，你自己采取行动，如[7.11.1
    使用脚本手动运行插件](../Text/ch07s11.html#running_the_plugin_manually_with_a_scrip "7.11.1
    使用脚本手动运行插件")中所示，以便你得到适当的告知。
- en: 'The plugin has the following options:'
  id: totrans-1230
  prefs: []
  type: TYPE_NORMAL
  zh: 插件有以下选项：
- en: '**`-C`** **``*`/path/to/nagios`*``** **`/ --command=`****``*`/path/to/nagios`*``**'
  id: totrans-1231
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`/path/to/nagios`*``** **`/ --command=`****``*`/path/to/nagios`*``**'
- en: This is the complete nagios command, including the path (e.g., **`-C /usr/local/nagios/bin/nagios`**).
  id: totrans-1232
  prefs: []
  type: TYPE_NORMAL
  zh: 这是完整的nagios命令，包括路径（例如，**`-C /usr/local/nagios/bin/nagios`**）。
- en: '**`-F`** **``*`/path/to/logfile`*``** **`/ --filename=`****``*`/path/to/logfile`*``**'
  id: totrans-1233
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-F`** **``*`/path/to/logfile`*``** **`/ --filename=`****``*`/path/to/logfile`*``**'
- en: This is the path to where the Nagios log file **`nagios.log`** is saved. The
    file is located in the Nagios **`var`** directory.
  id: totrans-1234
  prefs: []
  type: TYPE_NORMAL
  zh: 这是Nagios日志文件**`nagios.log`**的保存路径。该文件位于Nagios的**`var`**目录中。
- en: '**`-e`** **``*`integer`*``** **`/ --expires=`****``*`integer`*``**'
  id: totrans-1235
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-e`** **``*`integer`*``** **`/ --expires=`****``*`integer`*``**'
- en: This is the maximum age of the log file. If there have been no changes to the
    file for longer than **``*`integer`*``** minutes, **`check_nagios`** issues a
    warning.
  id: totrans-1236
  prefs: []
  type: TYPE_NORMAL
  zh: 这是日志文件的最大年龄。如果文件在超过**``*`integer`*``**分钟内没有发生变化，**`check_nagios`**将发出警告。
- en: 'You should make sure that this time specification is large enough: if no errors
    are currently occurring, Nagios will not log anything in the log file. The only
    reliable way to obtain a regular entry is with the parameter **`retention_update_interval`**
    in the configuration file **`nagios.cfg`** (see [A.1 The Main Configuration File
    nagios.cfg](../Text/apa.html#an_overview_of_the_nagios_configuration "A.1 The
    Main Configuration File nagios.cfg")). The default value is 60 minutes.'
  id: totrans-1237
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该确保这个时间指定足够大：如果没有当前错误发生，Nagios不会在日志文件中记录任何内容。获取常规条目的唯一可靠方法是使用配置文件**`nagios.cfg`**中的参数**`retention_update_interval`**（见[A.1
    主配置文件 nagios.cfg](../Text/apa.html#an_overview_of_the_nagios_configuration "A.1
    主配置文件 nagios.cfg")）。默认值是60分钟。
- en: 'In the following example the log file should not be older than 60 minutes (this
    corresponds to the default *retention update interval*; see [A.1 The Main Configuration
    File nagios.cfg](../Text/apa.html#an_overview_of_the_nagios_configuration "A.1
    The Main Configuration File nagios.cfg")):'
  id: totrans-1238
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下示例中，日志文件不应超过60分钟（这对应于默认的*保留更新间隔*；见[A.1 主配置文件 nagios.cfg](../Text/apa.html#an_overview_of_the_nagios_configuration
    "A.1 主配置文件 nagios.cfg"))：
- en: '[PRE139]'
  id: totrans-1239
  prefs: []
  type: TYPE_PRE
  zh: '[PRE139]'
- en: With one running Nagios process and a log file last changed 183 seconds (about
    three minutes) ago, everything is in order here. If the **`-e`** parameter is
    omitted, the plugin always gives a warning.
  id: totrans-1240
  prefs: []
  type: TYPE_NORMAL
  zh: 在一个运行中的Nagios进程和一个最后更改了183秒（大约三分钟）的日志文件的情况下，这里一切正常。如果省略了**`-e`**参数，插件总是给出警告。
- en: 7.11.1 Running the plugin manually with a script
  id: totrans-1241
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 7.11.1 使用脚本手动运行插件
- en: 'The following example script demonstrates how the plugin is called outside
    the Nagios environment. It starts **`check_nagios`** initially as Nagios does
    and then evaluates the return value. If the status is not **`0`**, it sends an
    e-mail to the administrator [nagios-admin@example.com](mailto:nagios-admin@example.com),
    using the external **`mailx`** program:'
  id: totrans-1242
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例脚本演示了如何在Nagios环境外调用插件。它最初像Nagios一样启动**`check_nagios`**，然后评估返回值。如果状态不是**`0`**，它将使用外部**`mailx`**程序给管理员[nagios-admin@example.com](mailto:nagios-admin@example.com)发送电子邮件：
- en: '[PRE140]'
  id: totrans-1243
  prefs: []
  type: TYPE_PRE
  zh: '[PRE140]'
- en: The script can be run at regular intervals via a cron job—such as every 15 minutes.
    But then it will also "irritate" the administrator every quarter of an hour with
    an e-mail. There is certainly room for improvement in this respect—but that would
    go beyond the scope of this book.
  id: totrans-1244
  prefs: []
  type: TYPE_NORMAL
  zh: 可以通过cron作业定期运行此脚本——例如每15分钟一次。但这样它也会每隔一刻钟就通过电子邮件“打扰”管理员。在这方面肯定有改进的空间——但这将超出本书的范围。
- en: 7.12 Hardware Checks with LM Sensors
  id: totrans-1245
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7.12 使用LM Sensors进行硬件检查
- en: Modern mainboards are equipped with sensors that allow you to check the "health"
    of the system. In the **`lm-sensors`**^([[82](#ftn.CHP-7-FN-12)]) project it is
    also possible in Linux to query this data via I2C or SMBus (*System Management
    Bus*, a I2C special case).
  id: totrans-1246
  prefs: []
  type: TYPE_NORMAL
  zh: 现代主板配备了传感器，允许你检查系统的“健康”状态。在**`lm-sensors`**^([[82](#ftn.CHP-7-FN-12)])项目中，在Linux中也可以通过I2C或SMBus（*系统管理总线*，I2C的一个特殊情况）查询这些数据。
- en: To enable this, the kernel must have a suitable driver. Kernel 2.4.x normally
    requires additional modules, which are included in the software.^([[83](#ftn.CHP-7-FN-13)])
    With a little luck, your distribution may include precompiled modules (e.g., SUSE).
    Kernel 2.6, however, already includes many drivers; here you just compile the
    entire branch below **`I2C Hardware Sensors Chip support`**.
  id: totrans-1247
  prefs: []
  type: TYPE_NORMAL
  zh: 要启用此功能，内核必须有一个合适的驱动程序。2.4.x内核通常需要额外的模块，这些模块包含在软件中.^([[83](#ftn.CHP-7-FN-13)])
    有一些运气的话，你的发行版可能包含预编译的模块（例如，SUSE）。然而，2.6内核已经包含了许多驱动程序；在这里，你只需编译以下整个分支**`I2C Hardware
    Sensors Chip support`**。
- en: 'It would take too much space here to detail the installation of the necessary
    modules. We will therefore only go into detail for the **`check_sensors`** plugin,
    and assume that the corresponding kernel driver is already loaded as a module.
    Help is provided during operation with the **`sensors-detect`** program from the
    **`lm-sensors`** package, which does a number of tests and then tells you which
    modules need to be loaded. If all requirements are fulfilled, running the **`sensors`**
    program will produce an output similar to the following one, and shows that the
    onboard sensors are providing data:'
  id: totrans-1248
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里详细说明必要模块的安装会占用太多空间。因此，我们只对**`check_sensors`**插件进行详细说明，并假设相应的内核驱动程序已经作为模块加载。在操作过程中，**`lm-sensors`**包中的**`sensors-detect`**程序会提供帮助，该程序执行一系列测试，然后告诉您需要加载哪些模块。如果所有要求都得到满足，运行**`sensors`**程序将产生类似于以下输出的结果，并显示板载传感器正在提供数据：
- en: '[PRE141]'
  id: totrans-1249
  prefs: []
  type: TYPE_PRE
  zh: '[PRE141]'
- en: The output depends on the hardware, so it will be slightly different for each
    computer. Here you can see, for example, the CPU and motherboard temperatures
    (41 and 45 degrees Celsius), the rotation speed of the fans, and the voltages
    on the 12- and 5-volt circuits and on the battery. Depending on the board design
    and the manufacturer, some details may be missing; in this example, only the fan
    for the power supply **`FAN1/PS`**^([[84](#ftn.CHP-7-FN-14)]) provides information;
    **`Fan3/AUX`** refers to an additional fan inside the computer box that, although
    it is running, is not recorded by the chipset.
  id: totrans-1250
  prefs: []
  type: TYPE_NORMAL
  zh: 输出取决于硬件，因此对于每台计算机都会略有不同。例如，您可以看到CPU和主板温度（41和45摄氏度），风扇的转速，以及12伏和5伏电路和电池上的电压。根据板设计和生产商的不同，某些详细信息可能缺失；在这个例子中，只有电源风扇**`FAN1/PS`**^([[84](#ftn.CHP-7-FN-14)])提供了信息；**`Fan3/AUX`**指的是计算机箱内的额外风扇，尽管它在运行，但芯片组没有记录。
- en: 'Apart from the standard options **`-h`** (help function), **`-v`** (*verbose*),
    which displays the response of the sensors, and **`-V`**, which shows the plugin
    version, the plugin itself has no special options. Warning and critical limits
    must be set via the **`lm-sensors`** configuration. **`check_sensors`** only returns
    the status given by the onboard sensors:'
  id: totrans-1251
  prefs: []
  type: TYPE_NORMAL
  zh: 除了标准选项**`-h`**（帮助功能）、**`-v`**（详细），它显示传感器的响应，以及**`-V`**，它显示插件版本之外，插件本身没有特殊选项。警告和临界限制必须通过**`lm-sensors`**配置设置。**`check_sensors`**只返回板载传感器的状态：
- en: '[PRE142]'
  id: totrans-1252
  prefs: []
  type: TYPE_PRE
  zh: '[PRE142]'
- en: 'If this is called with the **`-v`** option, you can see more clearly whether
    the test works:'
  id: totrans-1253
  prefs: []
  type: TYPE_NORMAL
  zh: 如果使用**`-v`**选项调用，您可以更清楚地看到测试是否工作：
- en: '[PRE143]'
  id: totrans-1254
  prefs: []
  type: TYPE_PRE
  zh: '[PRE143]'
- en: The output line is only wrapped for printing purposes; the plugin displays verbose
    information on a single line.
  id: totrans-1255
  prefs: []
  type: TYPE_NORMAL
  zh: 输出行仅为了打印目的而换行；插件在单行上显示详细信息。
- en: 'Alternatively you can use SNMP to access the sensor data: the NET-SNMP package
    (see [11.2 NET-SNMP](../Text/ch11s02.html "11.2 NET-SNMP") from page 234) provides
    the data delivered by **`lm-sensors`**, and with the SNMP plugin **`check_snmp`**,
    warning limits can also be set from Nagios. This solution is described in [11.3.1
    The generic SNMP plugin check_snmp](../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp
    "11.3.1 The generic SNMP plugin check_snmp") from page 246.'
  id: totrans-1256
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，您可以使用SNMP来访问传感器数据：NET-SNMP软件包（见第234页的[11.2 NET-SNMP](../Text/ch11s02.html
    "11.2 NET-SNMP")）提供了**`lm-sensors`**提供的数据，并且通过SNMP插件**`check_snmp`**，还可以从Nagios设置警告限制。这种解决方案在[11.3.1
    通用SNMP插件check_snmp](../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp "11.3.1
    通用SNMP插件check_snmp")中描述，见第246页。
- en: '* * *'
  id: totrans-1257
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[82](#CHP-7-FN-12)]) [http://www.lm-sensors.nu/](http://www.lm-sensors.nu/)
  id: totrans-1258
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[82](#CHP-7-FN-12)]) [http://www.lm-sensors.nu/](http://www.lm-sensors.nu/)
- en: ^([[83](#CHP-7-FN-13)]) [http://secure.netroedge.com/˜lm78/download.html](http://secure.netroedge.com/%CB%9Clm78/download.html)
  id: totrans-1259
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[83](#CHP-7-FN-13)]) [http://secure.netroedge.com/˜lm78/download.html](http://secure.netroedge.com/%CB%9Clm78/download.html)
- en: ^([[84](#CHP-7-FN-14)]) PS stands for *power supply*; but the names displayed
    can be edited in **`/etc/sensors.conf`**.
  id: totrans-1260
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[84](#CHP-7-FN-14)]) PS代表**电源供应**；但显示的名称可以在**`/etc/sensors.conf`**中进行编辑。
- en: Chapter 8. Plugins for Special Tasks
  id: totrans-1261
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第8章. 特殊任务插件
- en: A number of plugins do not really fit into the category of local checks versus
    remote checks because they themselves do not detect operating states but manipulate
    the results of other checks or summarize them into new results. These include
    the plugin **`check_dummy`**, which always returns a fixed result in order to
    create a well-defined environment for test scenarios.
  id: totrans-1262
  prefs: []
  type: TYPE_NORMAL
  zh: 许多插件实际上并不适合本地检查与远程检查的分类，因为它们本身不检测操作系统状态，而是操作其他检查的结果或将它们总结成新的结果。这些包括始终返回固定结果的插件**`check_dummy`**，以创建一个为测试场景定义良好的环境。
- en: '**`negate`** (which negates the return value) and **`urlize`** (which adds
    a hyperlink to the text output) manipulate the outputs. Summarizing and processing
    check results is the task of **`check_cluster`** and **`check_multi`**. Whereas
    **`check_cluster`** only combines and evaluates existing states, **`check_multi`**
    calls the specified plugins itself and combines their results.'
  id: totrans-1263
  prefs: []
  type: TYPE_NORMAL
  zh: '**`negate`**（取消返回值）和**`urlize`**（将超链接添加到文本输出）操作输出。总结和处理检查结果是**`check_cluster`**和**`check_multi`**的任务。其中**`check_cluster`**仅组合和评估现有状态，而**`check_multi`**则直接调用指定的插件并组合其结果。'
- en: 8.1 The Dummy Plugin for Tests
  id: totrans-1264
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 8.1 用于测试的虚拟插件
- en: 'For tests expected to end with a defined response, the **`check_dummy`** plugin
    can be used. it is given a return value and the desired response text as parameters,
    and it provides exactly these two responses as a result:'
  id: totrans-1265
  prefs: []
  type: TYPE_NORMAL
  zh: 对于预期以定义响应结束的测试，可以使用**`check_dummy`**插件。它被赋予一个返回值和所需的响应文本作为参数，并精确地提供这两个响应作为结果：
- en: '[PRE144]'
  id: totrans-1266
  prefs: []
  type: TYPE_PRE
  zh: '[PRE144]'
- en: 'The output line contains the defined response, preceded by the status in text
    form. the return value can again be checked with **`echo $?: 1`** stands for WARNING.'
  id: totrans-1267
  prefs: []
  type: TYPE_NORMAL
  zh: '输出行包含定义的响应，前面是文本形式的状况。返回值可以通过**`echo $?: 1`**再次检查，其中**`1`**代表WARNING。'
- en: Alternatively you can give **`check_dummy`** a **`0`** (OK), an **`2`** (CRITICAL)
    or a **`3`** (UNKNOWN) as the first argument. The second argument, the response
    text, is optional.
  id: totrans-1268
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，你可以给**`check_dummy`**一个**`0`**（OK）、**`2`**（CRITICAL）或**`3`**（UNKNOWN）作为第一个参数。第二个参数，响应文本，是可选的。
- en: 8.2 Negating Plugin Results
  id: totrans-1269
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 8.2 取消插件结果
- en: In some situations you may want to test the opposite of what the standard plugin
    normally tests, such as an interface that should *not* be active, a Web page or
    a host that should normally *not* be reached. In these cases the program **`negate`**,
    included in the Nagios plugins, provides a way of negating the return value of
    the original check.
  id: totrans-1270
  prefs: []
  type: TYPE_NORMAL
  zh: 在某些情况下，你可能想测试标准插件通常测试的相反情况，例如一个不应激活的接口，一个不应通常可达的网页或主机。在这些情况下，Nagios插件中包含的**`negate`**程序提供了一种取消原始检查返回值的方法。
- en: 'Like plugins, **`negate`** has an option to specify a timeout in seconds, with
    **`-t`**, after which it should abort the operation. The actual command line must
    always contain the complete path to the plugin:'
  id: totrans-1271
  prefs: []
  type: TYPE_NORMAL
  zh: 与插件类似，**`negate`**有一个选项可以指定秒数作为超时时间，使用**`-t`**，之后应终止操作。实际的命令行必须始终包含插件的全路径：
- en: '[PRE145]'
  id: totrans-1272
  prefs: []
  type: TYPE_PRE
  zh: '[PRE145]'
- en: '**`negate`** changes the return value of **`2`** (CRITICAL) to **`0`** (OK)
    and vice versa. The return codes **`1`** (WARNING) and **`3`** (UNKNOWN) remain
    unchanged.'
  id: totrans-1273
  prefs: []
  type: TYPE_NORMAL
  zh: '**`negate`**将**`2`**（CRITICAL）的返回值改为**`0`**（OK），反之亦然。返回代码**`1`**（WARNING）和**`3`**（UNKNOWN）保持不变。'
- en: 'The following example carries out **`check_icmp`** on the host **`192.0.2.1`**,
    which in normal cases should not be reachable:'
  id: totrans-1274
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例在主机**`192.0.2.1`**上执行**`check_icmp`**，在正常情况下不应可达：
- en: '[PRE146]'
  id: totrans-1275
  prefs: []
  type: TYPE_PRE
  zh: '[PRE146]'
- en: The plugin itself returns a CRITICAL in this case with a corresponding text.
    **`negate`** "inverts" the return value; **`2`** (CRITICAL) turns into **`0`**
    (OK). Since the text originates from the plugin and is not changed, the information
    **`CRITICAL`** remains here. For Nagios itself, however, nothing but the return
    value is of any interest.
  id: totrans-1276
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，插件本身返回一个CRITICAL状态和相应的文本。**`negate`**“反转”返回值；**`2`**（CRITICAL）变为**`0`**（OK）。由于文本来自插件且未更改，因此信息**`CRITICAL`**仍然在这里。然而，对于Nagios本身来说，只有返回值才是任何感兴趣的。
- en: 8.3 Inserting Hyperlinks with **`urlize`**
  id: totrans-1277
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 8.3 使用**`urlize`**插入超链接
- en: The program **`urlize`** represents the text output of a plugin as a hyperlink,
    if required, so that clicking in the Nagios Web interface on the test result takes
    you to another Web page. Like **`negate`**, **`urlize`** functions as a wrapper
    around the normal plugin command and is included with the other Nagios plugins.
  id: totrans-1278
  prefs: []
  type: TYPE_NORMAL
  zh: 如果需要，程序**`urlize`**将插件文本输出表示为超链接，这样在Nagios Web界面上点击测试结果就会带你到另一个网页。与**`negate`**类似，**`urlize`**作为正常插件命令的包装器，包含在其他Nagios插件中。
- en: 'As the first argument it expects a valid URL to which the hyperlink should
    point. This is followed by the plugin command, including its path:'
  id: totrans-1279
  prefs: []
  type: TYPE_NORMAL
  zh: 作为第一个参数，它期望一个有效的URL，该URL是超链接应指向的位置。之后是插件命令，包括其路径：
- en: '[PRE147]'
  id: totrans-1280
  prefs: []
  type: TYPE_PRE
  zh: '[PRE147]'
- en: To avoid problems with spaces in plugin arguments, you can set the complete
  id: totrans-1281
  prefs: []
  type: TYPE_NORMAL
  zh: 为了避免插件参数中的空格问题，您可以设置完整的
- en: '**``*`plugin command`*``** in double quotation marks.'
  id: totrans-1282
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`插件命令`*``**用双引号括起来。'
- en: 'The hyperlink around the normal plugin output can be easily recognized when
    running the command manually:'
  id: totrans-1283
  prefs: []
  type: TYPE_NORMAL
  zh: 当手动运行命令时，可以轻松地识别围绕正常插件输出的超链接：
- en: '[PRE148]'
  id: totrans-1284
  prefs: []
  type: TYPE_PRE
  zh: '[PRE148]'
- en: In version 1.4 **`urlize`** also embeds the performance output in the link text,
    but Nagios cut this off before the representation in the Web interface, together
    with the end tag. But most browsers do not have any problem with the missing **`</A>`**.
  id: totrans-1285
  prefs: []
  type: TYPE_NORMAL
  zh: 在版本1.4中，**`urlize`**也将性能输出嵌入到链接文本中，但Nagios在Web界面的表示之前将其截断，包括结束标签。但大多数浏览器对缺失的**`</A>`**没有问题。
- en: 8.4 Checking Host or Service Clusters as an Entity
  id: totrans-1286
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 8.4 将主机或服务集群作为一个实体进行检查
- en: Plugins normally check an individual host or service, compare the result with
    the specified thresholds, and then return an appropriate result. On systems with
    redundant designs (such as in clusters) you can also check the respective host
    or service individually. In addition, a check of the virtual host or service provides
    a clue as to whether or not the virtual system as a whole is reachable. The plugin
    **`check_cluster`** allows more complex values to be queried.
  id: totrans-1287
  prefs: []
  type: TYPE_NORMAL
  zh: 插件通常检查单个主机或服务，将结果与指定的阈值进行比较，然后返回适当的结果。在冗余设计系统（如集群）中，您也可以单独检查相应的主机或服务。此外，对虚拟主机或服务的检查可以提供有关整个虚拟系统是否可访问的线索。插件**`check_cluster`**允许查询更复杂的价值。
- en: As an example, we will take a host cluster consisting of five identical single
    systems. One of these hosts may fail without any problem, but if a second one
    fails, the plugin should issue a WARNING. If a third host should fail, a CRITICAL
    should certainly be signalled.
  id: totrans-1288
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，我们将以一个由五个相同单系统组成的主机集群为例。这些主机中的一个可能没有任何问题就失败了，但如果第二个失败了，插件应该发出WARNING。如果第三个主机应该失败，则肯定应该发出CRITICAL信号。
- en: The special feature of **`check_cluster`** is that it does not actively perform
    a check itself but determines the return value from already-existing status values
    from the desired hosts or services. To do this it uses on-demand macros (see [D.2
    On-Demand Macros](../Text/apds02.html "D.2 On-Demand Macros") from page 632).
    Whereas the standard macros always refer to the current host or service, which
    obviously makes little sense for **`check_cluster`**, on-demand macros allow access
    to all existing information on other hosts or services.
  id: totrans-1289
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_cluster`**的特殊之处在于它本身不主动执行检查，而是从所需的主机或服务已存在的状态值中确定返回值。为此，它使用按需宏（参见第632页的[D.2
    按需宏](../Text/apds02.html "D.2 按需宏")）。与标准宏始终引用当前主机或服务相比，这对于**`check_cluster`**显然意义不大，按需宏允许访问其他主机或服务的所有现有信息。'
- en: 'For **`check_cluster`** we require the status of various hosts or services.
    These can be determined through the on-demand macros **`$HOSTSTATEID:`****``*`host`*$``**
    and **`$SERVICESTATEID:`** **``*`host`*:``** **``*`service_description`*$``**.
    They both provide the respective status in numerical form: **`0`** for OK; for
    hosts, **`1`** for DOWN and **`2`** for UNREACHABLE; for services, **`1`** for
    WARNING, **`2`** for CRITICAL, and **`3`** for UNKNOWN).^([[85](#ftn.CHP-8-FN-1)])
    In each case the host name must be specified, and for **`$SERVICESTATEID$`** the
    service description of the host or service from which Nagios is to obtain the
    values must also be given.'
  id: totrans-1290
  prefs: []
  type: TYPE_NORMAL
  zh: 对于**`check_cluster`**，我们需要各种主机或服务的状态。这些可以通过按需宏**`$HOSTSTATEID:`**和**`$SERVICESTATEID:`**确定。它们都提供相应的状态，以数值形式表示：**`0`**表示OK；对于主机，**`1`**表示DOWN，**`2`**表示UNREACHABLE；对于服务，**`1`**表示WARNING，**`2`**表示CRITICAL，**`3`**表示UNKNOWN).^([[85](#ftn.CHP-8-FN-1)])
    在每种情况下，都必须指定主机名，并且对于**`$SERVICESTATEID$`**，还必须给出从Nagios获取值的宿主或服务的服务描述。
- en: 'The plugin has the following options:'
  id: totrans-1291
  prefs: []
  type: TYPE_NORMAL
  zh: 插件有以下选项：
- en: '**`-s / --service`**'
  id: totrans-1292
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-s / --service`**'
- en: Handles the status values as the results of service checks, that is, **`0`**
    as OK, **`1`** as WARNING and **`2`** as CRITICAL
  id: totrans-1293
  prefs: []
  type: TYPE_NORMAL
  zh: 将状态值作为服务检查的结果处理，即**`0`**表示OK，**`1`**表示WARNING，**`2`**表示CRITICAL
- en: '**`-h / --host`**'
  id: totrans-1294
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-h / --host`**'
- en: Handles the status values as the results of host checks, that is, **`0`** as
    UP, **`1`** as DOWN, and **`2`** as UNREACHABLE
  id: totrans-1295
  prefs: []
  type: TYPE_NORMAL
  zh: 将状态值作为主机检查的结果处理，即**`0`**表示UP，**`1`**表示DOWN，**`2`**表示UNREACHABLE
- en: '**`-l`** **``*`label`*``** **`/ --label=`****``*`label`*``**'
  id: totrans-1296
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-l`** **``*`label`*``** **`/ --label=`****``*`label`*``**'
- en: Inserts the text specified with **``*`label`*``** into the text output
  id: totrans-1297
  prefs: []
  type: TYPE_NORMAL
  zh: 将指定的文本 **``*`label`*``** 插入到文本输出中
- en: '**`-d`** **``*`statusliste`*``** **`/ --data=`****``*`statusliste`*``**'
  id: totrans-1298
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-d`** **``*`statusliste`*``** **`/ --data=`****``*`statusliste`*``**'
- en: 'Comma-separated list of the states from which the total result should be determined;
    here the already mentioned macros are used:'
  id: totrans-1299
  prefs: []
  type: TYPE_NORMAL
  zh: 以逗号分隔的状态列表，从这些状态中确定总结果；这里使用已提到的宏：
- en: '[PRE149]'
  id: totrans-1300
  prefs: []
  type: TYPE_PRE
  zh: '[PRE149]'
- en: '**`-w`** **``*`schwellwert`*``** **`/ --warning=`****``*`schwellwert`*``**'
  id: totrans-1301
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`schwellwert`*``** **`/ --warning=`****``*`schwellwert`*``**'
- en: Warning threshold in the threshold format,^([[86](#ftn.CHP-8-FN-2)]) with respect
    to the number of error states. So by specifying **`-w 0:2`**, a maximum of two
    error states are allowed for an OK result. From the third error state, a WARNING
    is issued.
  id: totrans-1302
  prefs: []
  type: TYPE_NORMAL
  zh: 警告阈值在阈值格式中，^([[86](#ftn.CHP-8-FN-2)]) 与错误状态的数量相关。所以通过指定 **`-w 0:2`**，允许最多两个错误状态为OK结果。从第三个错误状态开始，将发出警告。
- en: '**`-c`** **``*`threshold`*``** **`/ --critical=`****``*`threshold`*``**'
  id: totrans-1303
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`threshold`*``** **`/ --critical=`****``*`threshold`*``**'
- en: Like **`--warning`**, but refers to the critical threshold
  id: totrans-1304
  prefs: []
  type: TYPE_NORMAL
  zh: 与 **`--warning`** 类似，但指的是关键阈值
- en: 'The following call simulates the failure of two out of a total of five existing
    Web servers. A third server displays a WARNING. This means that we have a total
    of three error states:'
  id: totrans-1305
  prefs: []
  type: TYPE_NORMAL
  zh: 以下调用模拟了五个现有Web服务器中两个发生故障的情况。第三个服务器显示警告。这意味着我们总共有三个错误状态：
- en: '[PRE150]'
  id: totrans-1306
  prefs: []
  type: TYPE_PRE
  zh: '[PRE150]'
- en: 'The check issues a WARNING because the warning threshold is exceeded (even
    though the critical threshold is not). The definition of the **`check_cluster`**
    command is kept simple:'
  id: totrans-1307
  prefs: []
  type: TYPE_NORMAL
  zh: 检查发出警告，因为超过了警告阈值（即使关键阈值没有）。**`check_cluster`** 命令的定义保持简单：
- en: '[PRE151]'
  id: totrans-1308
  prefs: []
  type: TYPE_PRE
  zh: '[PRE151]'
- en: 'The command expects a label as the first argument, and the plugin prefixes
    it to the text output. Everything else is defined in the second argument in the
    host or service definition:'
  id: totrans-1309
  prefs: []
  type: TYPE_NORMAL
  zh: 命令期望一个标签作为第一个参数，并将插件将其添加到文本输出之前。其他所有内容都在第二个参数中定义，在主机或服务定义中：
- en: '[PRE152]'
  id: totrans-1310
  prefs: []
  type: TYPE_PRE
  zh: '[PRE152]'
- en: The service **`Web Cluster`** checks the service states of the two services
    **`srv1:HTTP`** and **`srv2:HTTP`**. As long as they are both working without
    errors, the command returns OK. If there is an error state, the result will be
    a WARNING, and if both services have errors, CRITICAL is returned.
  id: totrans-1311
  prefs: []
  type: TYPE_NORMAL
  zh: 服务 **`Web Cluster`** 检查两个服务 **`srv1:HTTP`** 和 **`srv2:HTTP`** 的服务状态。只要它们都工作正常且无错误，命令将返回OK。如果存在错误状态，结果将是警告，如果两个服务都有错误，则返回CRITICAL。
- en: This completes the possibilities of **`check_cluster`**. If you are not satisfied
    with simply evaluating the number of existing error states, you should take a
    closer look at the plugin **`check_multi`**, which also allows AND and OR operations.
  id: totrans-1312
  prefs: []
  type: TYPE_NORMAL
  zh: 这完成了 **`check_cluster`** 的可能性。如果您对仅仅评估现有错误状态的数量不满意，您应该更仔细地查看插件 **`check_multi`**，它还允许AND和OR操作。
- en: '* * *'
  id: totrans-1313
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[85](#CHP-8-FN-1)]) See [Appendix D](../Text/apd.html "Appendix D. Macros")
    from page 625.
  id: totrans-1314
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[85](#CHP-8-FN-1)]) 请参阅第625页的[附录D](../Text/apd.html "附录D. 宏")。
- en: ^([[86](#CHP-8-FN-2)]) For the specification of thresholds, see [24.1.5 Specifying
    thresholds](../Text/ch24.html#specifying_thresholds "24.1.5 Specifying thresholds")
    in page 557.
  id: totrans-1315
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[86](#CHP-8-FN-2)]) 关于阈值的指定，请参阅第557页的[24.1.5 指定阈值](../Text/ch24.html#specifying_thresholds
    "24.1.5 指定阈值")。
- en: 8.5 Summarizing Checks with **`check_multi`**
  id: totrans-1316
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 8.5 使用 **`check_multi`** 汇总检查
- en: There are various reasons for grouping different checks into a single one. On
    one hand it simplifies work for Nagios, because the system now only needs to manage
    1,000 procedures instead of maybe 20,000—this increases performance significantly
    in many cases. If you summarize checks remotely, Nagios now performs 1 instead
    of 20 network queries, which results in better network performance. The Nagios
    administrator may also have an easier time, as the configuration is more concise.
  id: totrans-1317
  prefs: []
  type: TYPE_NORMAL
  zh: 将不同的检查组合成一个的原因有很多。一方面，它简化了Nagios的工作，因为现在系统只需要管理1,000个程序，而不是可能20,000个——这在许多情况下显著提高了性能。如果您远程汇总检查，Nagios现在执行1次而不是20次网络查询，这导致更好的网络性能。Nagios管理员也可能更容易配置，因为配置更简洁。
- en: The method originally planned for load distribution and reducing checks was
    via distributed Nagios instances. There are certainly productive installations
    in which a Nagios instance performs only 50 checks and transmits these to a central
    Nagios installation. If there are some several hundred Nagios instances, this
    method does ease the load on the central Nagios installation but not on the administrator,
    who has a considerable amount of work managing such configurations.
  id: totrans-1318
  prefs: []
  type: TYPE_NORMAL
  zh: 原计划用于负载分配和减少检查的方法是通过分布式Nagios实例。当然，有一些生产安装中，一个Nagios实例只执行50个检查并将这些检查传输到中央Nagios安装。如果有几百个Nagios实例，这种方法确实可以减轻中央Nagios安装的负载，但不会减轻管理员的工作负担，因为管理员需要管理大量的此类配置。
- en: The plugin **`check_multi`**, by Matthias Flacke, takes a different approach.
    It performs (almost) any number of checks decentrally and returns just a sum total
    of the results to the Nagios server ([Figure 8-1](../Text/ch08s05.html#summarizing_checks_with_check
    "Figure 8-1. Summarizing checks with check_multi")). The plugin is executed remotely;
    it is called either via NRPE ([Chapter 10](../Text/ch10.html "Chapter 10. The
    Nagios Remote Plugin Executor (NRPE)") from page 213) or via the plugin **`check_by_ssh`**
    ([9.1 The check_by_ssh Plugin](../Text/ch09.html#the_check_underscore_by_underscore_ssh
    "9.1 The check_by_ssh Plugin") from page 206).
  id: totrans-1319
  prefs: []
  type: TYPE_NORMAL
  zh: Matthias Flacke编写的插件**`check_multi`**采取了不同的方法。它以去中心化的方式执行（几乎）任何数量的检查，并将结果的汇总仅返回给Nagios服务器（[图8-1](../Text/ch08s05.html#summarizing_checks_with_check
    "图8-1. 使用check_multi汇总检查")）。该插件在远程执行；它可以通过NRPE（[第10章](../Text/ch10.html "第10章.
    Nagios远程插件执行器（NRPE）")，第213页）或通过插件**`check_by_ssh`**（[9.1 check_by_ssh插件](../Text/ch09.html#the_check_underscore_by_underscore_ssh
    "9.1 check_by_ssh插件")，第206页）来调用。
- en: '![Summarizing checks with check_multi](../Images/tagoreillycom20081104nostarchimages223808.png.jpg)'
  id: totrans-1320
  prefs: []
  type: TYPE_IMG
  zh: '![使用check_multi汇总检查](../Images/tagoreillycom20081104nostarchimages223808.png.jpg)'
- en: Figure 8-1. Summarizing checks with `check_multi`
  id: totrans-1321
  prefs: []
  type: TYPE_NORMAL
  zh: 图8-1. 使用`check_multi`汇总检查
- en: 'Information is lost during this process—ultimately, there can be only one return
    value for each **`check_multi`** call. But you gain clarity with the configuration
    of services, and you acquire—unexpectedly—a nice feature: The checks that must
    be performed are listed in an NRPE-like configuration file on the corresponding
    target system on which **`check_multi`** is also installed. This makes it possible
    to delegate certain tasks, such as the maintenance of threshold values, to other
    (non-Nagios) administrators. They require write access to the relevant **`check_multi`**
    configuration file but do not need to continue grappling—apart from correctly
    running the plugins used—with a Nagios configuration.'
  id: totrans-1322
  prefs: []
  type: TYPE_NORMAL
  zh: 在此过程中会丢失信息——最终，每个**`check_multi`**调用只能有一个返回值。但通过配置服务，你可以获得清晰度，并且意外地获得了一个很好的功能：必须执行的检查列在**`check_multi`**也安装的对应目标系统上的类似NRPE的配置文件中。这使得可以将某些任务，例如阈值维护，委托给其他（非Nagios）管理员。他们需要访问相关的**`check_multi`**配置文件的写权限，但不需要继续与Nagios配置纠缠——除了正确运行所使用的插件之外。
- en: To be able to pass on as much information as possible, **`check_multi`** makes
    regular use of the multiple-line plugin output format that was introduced with
    Nagios 3.0 (see [8.5.1 Multiple-line plugin output](../Text/ch08s05.html#multiple-line_plugin_output
    "8.5.1 Multiple-line plugin output")). This restricts the use of **`check_multi`**
    essentially to Nagios 3.0\. Starting from **`check_multi`** in version 0.14, there
    have been approaches to support Nagios 2.x. These are only of limited use, however,
    since the entire amount of information for plugins in Nagios 2.x is about 300
    bytes, and only the first line of the plugin output is utilized.
  id: totrans-1323
  prefs: []
  type: TYPE_NORMAL
  zh: 为了传递尽可能多的信息，**`check_multi`**经常使用Nagios 3.0引入的多行插件输出格式（见[8.5.1 多行插件输出](../Text/ch08s05.html#multiple-line_plugin_output
    "8.5.1 多行插件输出")）。这基本上限制了**`check_multi`**的使用范围到Nagios 3.0。从**`check_multi`**版本0.14开始，已经有一些方法来支持Nagios
    2.x。然而，这些方法的使用有限，因为Nagios 2.x中插件的所有信息大约有300字节，并且只使用了插件输出的第一行。
- en: 8.5.1 Multiple-line plugin output
  id: totrans-1324
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.5.1 多行插件输出
- en: 'Starting with Nagios 3.0, an expanded output format for plugins has been introduced.
    Instead of squeezing everything onto a single line, the output may be spread over
    several lines:'
  id: totrans-1325
  prefs: []
  type: TYPE_NORMAL
  zh: 从Nagios 3.0开始，引入了插件扩展输出格式。而不是将所有内容挤在单行上，输出可以扩展到多行：
- en: '[PRE153]'
  id: totrans-1326
  prefs: []
  type: TYPE_PRE
  zh: '[PRE153]'
- en: 'The first line contains the standard text output, supplemented with performance
    data if required. This line can still be processed by Nagios 2.x, so it shouldn''t
    be longer than 300 bytes. In the following lines a plugin may supply other text
    information until the character **`|`** closes the text output and allows other
    performance data to be written. Nagios 3.0 displays the entire text information
    in the status information generated by **`extinfo.cgi`** on the Web interface
    (see [16.2.2 Additional information and control center: extinfo.cgi](../Text/ch16s02.html#additional_information_and_control_cent
    "16.2.2 Additional information and control center: extinfo.cgi") from page 339).'
  id: totrans-1327
  prefs: []
  type: TYPE_NORMAL
  zh: 第一行包含标准文本输出，如果需要，还会补充性能数据。这一行仍然可以被 Nagios 2.x 处理，因此它不应该超过 300 字节。在随后的行中，插件可以提供其他文本信息，直到字符
    **`|`** 关闭文本输出，并允许写入其他性能数据。Nagios 3.0 在 Web 界面上的 **`extinfo.cgi`** 生成的状态信息中显示整个文本信息（参见第
    339 页的 [16.2.2 额外信息和控制中心：extinfo.cgi](../Text/ch16s02.html#additional_information_and_control_cent
    "16.2.2 额外信息和控制中心：extinfo.cgi")）。
- en: 'When accessing text information via macros (See [D.1 Standard Macros](../Text/apd.html#standard_macros
    "D.1 Standard Macros") from page 627), Nagios splits up the information into two
    macros: **`$HOSTOUTPUT$`** contains the first line of the text information of
    host checks (that is, the contents of the placeholder **``*`normal text output`*``**),
    and **`$LONGHOSTOUTPUT$`** contains only the long text. For service checks the
    macros are called **`$SERVICEOUTPUT$`** and **`$LONGSERVICEOUTPUT$`**. The **`LONG*`**
    variation of the macro is available only in Nagios 3.0 and later; Nagios 2.x only
    knows the short version.'
  id: totrans-1328
  prefs: []
  type: TYPE_NORMAL
  zh: 当通过宏访问文本信息时（参见第 627 页的 [D.1 标准宏](../Text/apd.html#standard_macros "D.1 标准宏")），Nagios
    将信息分成两个宏：**`$HOSTOUTPUT$`** 包含主机检查的文本信息的第一行（即占位符 **``*`normal text output`*``**
    的内容），而 **`$LONGHOSTOUTPUT$`** 只包含长文本。对于服务检查，宏称为 **`$SERVICEOUTPUT$`** 和 **`$LONGSERVICEOUTPUT$`**。宏的
    **`LONG*`** 变体仅在 Nagios 3.0 及以后版本中可用；Nagios 2.x 只知道短版本。
- en: The performance data from the first line and from the end is summarized by Nagios
    3.0 in the macros **`$HOSTPERFDATA$`** and **`$SERVICEPERFDATA$`**. There is no
    **`LONG*`** variation, as is the case for the output.
  id: totrans-1329
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios 3.0 将第一行和末尾的性能数据汇总到宏 **`$HOSTPERFDATA$`** 和 **`$SERVICEPERFDATA$`** 中。没有
    **`LONG*`** 变体，正如输出那样。
- en: The entire output, including performance data, is a maximum of 8 KB long in
    Nagios 3.0\. If Nagios runs a plugin directly, as opposed to indirectly, (for
    instance, via NRPE or **`check_by_ssh`**), you must ensure that the entire 8 KB
    really are passed across the entire transmission path. This is covered in [8.5.2
    Installation requirements](../Text/ch08s05.html#installation_requirements "8.5.2
    Installation requirements").
  id: totrans-1330
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Nagios 3.0 中，整个输出（包括性能数据）最长为 8 KB。如果 Nagios 直接运行插件，而不是间接运行（例如，通过 NRPE 或 **`check_by_ssh`**），你必须确保整个
    8 KB 确实通过了整个传输路径。这已在 [8.5.2 安装要求](../Text/ch08s05.html#installation_requirements
    "8.5.2 安装要求") 中说明。
- en: 8.5.2 Installation requirements
  id: totrans-1331
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.5.2 安装要求
- en: '**`check_multi`** does not put any restrictions on the size of its output.
    In order to support enough checks, you should ensure that all the resources used
    allow at least 8 KB of plugin output. For Nagios version 3.0, the developers have
    increased the buffer size to to 8 KB, so no adjustments are necessary. For scenarios
    involving remote use with NRPE or **`check_by_ssh`**, you may need to make manual
    adjustments.'
  id: totrans-1332
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_multi`** 对其输出的尺寸没有限制。为了支持足够的检查，你应该确保所有使用的资源都允许至少 8 KB 的插件输出。对于 Nagios
    3.0 版本，开发人员已将缓冲区大小增加到 8 KB，因此不需要调整。对于涉及 NRPE 或 **`check_by_ssh`** 的远程使用场景，你可能需要手动调整。'
- en: Adjusting buffer sizes for NRPE
  id: totrans-1333
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 调整 NRPE 的缓冲区大小
- en: 'By default, NRPE ([Chapter 10](../Text/ch10.html "Chapter 10. The Nagios Remote
    Plugin Executor (NRPE)"), page 213) transmits no more than 1,024 characters. To
    make proper use of **`check_multi`**, you need to adjust the buffer size in the
    source code. To do this, you set the appropriate values in the file **`include/common.h`**
    to **`8192`**:'
  id: totrans-1334
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，NRPE ([第 10 章](../Text/ch10.html "第 10 章。Nagios 远程插件执行器 (NRPE)"), 第 213
    页) 传输不超过 1,024 个字符。为了正确使用 **`check_multi`**，你需要调整源代码中的缓冲区大小。为此，你需要在文件 **`include/common.h`**
    中设置适当的值为 **`8192`**：
- en: '[PRE154]'
  id: totrans-1335
  prefs: []
  type: TYPE_PRE
  zh: '[PRE154]'
- en: Afterward, you must re-compile and re-install the NRPE daemon and the **`check_nrpe`**
    plugin.
  id: totrans-1336
  prefs: []
  type: TYPE_NORMAL
  zh: 之后，你必须重新编译和重新安装 NRPE 守护进程和 **`check_nrpe`** 插件。
- en: Adjusting buffer sizes for **`check_by_ssh`**
  id: totrans-1337
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 调整 **`check_by_ssh`** 的缓冲区大小
- en: The plugin **`check_by_ssh`** ([9.1 The check_by_ssh Plugin](../Text/ch09.html#the_check_underscore_by_underscore_ssh
    "9.1 The check_by_ssh Plugin") from page 206) can handle multiple-line output
    from plugins in versions 1.4.10 and later, so it can be used unchanged. A patch
    is required for older versions, which can be found on the **`check_multi`** homepage.^([[87](#ftn.CHP-8-FN-3)])
  id: totrans-1338
  prefs: []
  type: TYPE_NORMAL
  zh: 插件**`check_by_ssh`**([9.1 check_by_ssh插件](../Text/ch09.html#the_check_underscore_by_underscore_ssh
    "9.1 check_by_ssh插件")，第206页)可以处理版本1.4.10及更高版本的插件的多行输出，因此可以不修改直接使用。对于旧版本，需要补丁，可以在**`check_multi`**主页上找到.^([[87](#ftn.CHP-8-FN-3)])
- en: 8.5.3 Installation and testing
  id: totrans-1339
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.5.3 安装和测试
- en: 'After downloading the plugin from the very extensive and well-documented homepage,^([[88](#ftn.CHP-8-FN-4)])
    you should unpack it in a directory anywhere, and then change to that directory
    to carry out an initial test. In the subdirectory **`contrib`** of the source
    code there is a preconfigured file, **`check_multi.cmd`**, containing several
    example checks. When running the plugin, specify this file with the option **`-f`**;
    **`check_multi`** will perform all the checks defined there in one go. This output
    gives you a feeling of how the plugin functions:'
  id: totrans-1340
  prefs: []
  type: TYPE_NORMAL
  zh: 在从非常详尽的、有良好文档的首页下载插件后，^([[88](#ftn.CHP-8-FN-4)])你应该在任何目录中解压缩它，然后切换到该目录以执行初始测试。在源代码的**`contrib`**子目录中有一个预配置的文件，**`check_multi.cmd`**，其中包含几个示例检查。在运行插件时，使用选项**`-f`**指定此文件；**`check_multi`**将一次性执行那里定义的所有检查。此输出让你对插件的功能有了一定的感觉：
- en: '[PRE155]'
  id: totrans-1341
  prefs: []
  type: TYPE_PRE
  zh: '[PRE155]'
- en: The first line of the output—starting with **`MULTI CRITICAL`**—summarizes all
    the executed checks. These lines (line-wrapped here for display purposes) are
    also processed by Nagios 2.x. The output from the individual checks begins on
    line 2 (starting with **`[ 1]`**), which looks exactly like the output of a single
    call of the plugin currently being run. The performance data is summarized by
    **`check_multi`**, but only at the the end, in a totals line—starting with **`|
    MULTI::check_multi::plugins`**. The individual variables are separated by spaces.
    The purpose for the variable names, along with their format (which takes some
    getting used to), is explained in [8.5.6 Performance data and PNP](../Text/ch08s05.html#performance_data_and_pnp
    "8.5.6 Performance data and PNP") from page 198.
  id: totrans-1342
  prefs: []
  type: TYPE_NORMAL
  zh: 输出的第一行——以**`MULTI CRITICAL`**开头——总结了所有已执行的检查。这些行（为了显示目的而换行）也由Nagios 2.x处理。单个检查的输出从第2行开始（以**`[
    1]`**开头），这与当前正在运行的插件的单次调用输出完全相同。性能数据由**`check_multi`**总结，但仅在末尾的总计行中——以**`| MULTI::check_multi::plugins`**开头。各个变量由空格分隔。变量名称的目的，以及它们的格式（需要一些时间来适应），在[8.5.6
    性能数据和PNP](../Text/ch08s05.html#performance_data_and_pnp "8.5.6 性能数据和PNP")的第198页中解释。
- en: 8.5.4 Configuration file
  id: totrans-1343
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.5.4 配置文件
- en: 'The format of the configuration file is based on that of NRPE ([10.3 NRPE Configuration
    on the Computer to Be Monitored](../Text/ch10s03.html "10.3 NRPE Configuration
    on the Computer to Be Monitored") from page 218). For **`check_multi`**, however,
    only the commands are defined. Here is an extract from the example file included,
    **`check_multi.cmd`**:'
  id: totrans-1344
  prefs: []
  type: TYPE_NORMAL
  zh: 配置文件的格式基于NRPE的格式([10.3 监控计算机上的NRPE配置](../Text/ch10s03.html "10.3 监控计算机上的NRPE配置")，第218页)。然而，对于**`check_multi`**，只定义了命令。以下是包含的示例文件摘录，**`check_multi.cmd`**：
- en: '[PRE156]'
  id: totrans-1345
  prefs: []
  type: TYPE_PRE
  zh: '[PRE156]'
- en: The command **`command[`** **``*`Name_of_check`* ]``** specifies the name for
    the appropriate check. This is used in the text output and in the performance
    data.
  id: totrans-1346
  prefs: []
  type: TYPE_NORMAL
  zh: 命令**`command[`** **``*`Name_of_check`* ]``**指定了相应检查的名称。这在文本输出和性能数据中使用。
- en: After the equal sign comes the check to be executed. When calling the plugin,
    path details can be omitted if the plugins are located in the default path, **`/usr/local/nagios/libexec`**.
    Alternatively, you can include the plugin path with the option **`−1`** when running
    **`check_multi`**. You can also specify the absolute path in the configuration
    file, of course.
  id: totrans-1347
  prefs: []
  type: TYPE_NORMAL
  zh: 等号后面是执行的检查。在调用插件时，如果插件位于默认路径**`/usr/local/nagios/libexec`**，则可以省略路径细节。或者，在运行**`check_multi`**时，可以使用选项**`−1`**包含插件路径。当然，你还可以在配置文件中指定绝对路径。
- en: 8.5.5 Command-line parameters
  id: totrans-1348
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.5.5 命令行参数
- en: '**`check_multi`** has the following options:'
  id: totrans-1349
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_multi`**有以下选项：'
- en: '**`-f`** **``*`/path/to/config/file`*``** **`/ --filename=`****``*`/path/to/config/file`*``**'
  id: totrans-1350
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-f`** **``*`/path/to/config/file`*``** **`/ --filename=`****``*`/path/to/config/file`*``**'
- en: This specifies the configuration file. So that Nagios can find it, you should
    always specify the complete path. This option does not have a default value; it
    can be given several times.
  id: totrans-1351
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了配置文件。为了使Nagios能够找到它，您应该始终指定完整的路径。此选项没有默认值；它可以多次指定。
- en: '**`-l`** **``*`/path/to/the/plugins`*``** **`/ --libexec=`****``*`/path/to/the/plugins`*``**'
  id: totrans-1352
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-l`** **``*`/path/to/the/plugins`*``** **`/ --libexec=`****``*`/path/to/the/plugins`*``**'
- en: The default for calling plugins is the path **`/usr/local/nagios/libexec`**.
    If they are located in a different directory, this is specified here with the
    **`-l`** option.
  id: totrans-1353
  prefs: []
  type: TYPE_NORMAL
  zh: 调用插件的默认路径是 **`/usr/local/nagios/libexec`**。如果它们位于不同的目录中，可以使用 **`-l`** 选项在这里指定。
- en: '**`-n`** **``*`name`*``** **`/ --name=`****``*`name`*``**'
  id: totrans-1354
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-n`** **``*`name`*``** **`/ --name=`****``*`name`*``**'
- en: This is the name of a check that **`check_multi`** outputs in the text output
    and in the performance data. The default is an empty string. If you run **`check_multi`**
    on a machine several times with different checks, it is better here to use different
    names so that they are more clearly separated from each other.
  id: totrans-1355
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 **`check_multi`** 在文本输出和性能数据中输出的检查名称。默认为空字符串。如果您在机器上多次运行 **`check_multi`**
    并使用不同的检查，这里最好使用不同的名称，以便它们之间更加清晰地区分开来。
- en: '**`-t`** **``*`sekunden`*``** **`/ --timeout=`****``*`seconds`*``**'
  id: totrans-1356
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** **``*`sekunden`*``** **`/ --timeout=`****``*`seconds`*``**'
- en: This specifies the timeout for an individual check. The default is **`10`**
    seconds.
  id: totrans-1357
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了单个检查的超时时间。默认为 **`10`** 秒。
- en: '**`-T`** **``*`seconds`*``** **`/ --TIMEOUT=`****``*`seconds`*``**'
  id: totrans-1358
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-T`** **``*`seconds`*``** **`/ --TIMEOUT=`****``*`seconds`*``**'
- en: For all checks together, **`check_multi`** requires a further timeout parameter,
    which is defined with **`-T`** (the default is **`60`** seconds).
  id: totrans-1359
  prefs: []
  type: TYPE_NORMAL
  zh: 对于所有检查一起，**`check_multi`** 需要一个额外的超时参数，该参数通过 **`-T`** (默认为 **`60`** 秒) 定义。
- en: This ensures that the call of **`check_multi`** will end within the time specified.
    The plugin does not start any new checks if the starting time and the timeout
    of a single plugin exceed the timeout of the entire **`check_multi`** call.^([[89](#ftn.CHP-8-FN-5)])
    Such individual checks are given the status UNKNOWN; in the output, **`check_multi`**
    assigns them the message **`plugin cancelled due to global timeout`**.
  id: totrans-1360
  prefs: []
  type: TYPE_NORMAL
  zh: 这确保了 **`check_multi`** 的调用将在指定的时间内结束。如果单个插件启动时间和超时超过了整个 **`check_multi`** 调用的超时，插件将不会启动任何新的检查。[^([[89](#ftn.CHP-8-FN-5)])
    这样的单个检查将被赋予未知状态；在输出中，**`check_multi`** 将它们分配给消息 **`plugin cancelled due to global
    timeout`**。
- en: '**`-r`** **``*`integer`*``** **`/ --report=`****``*`integer`*``**'
  id: totrans-1361
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** **``*`integer`*``** **`/ --report=`****``*`integer`*``**'
- en: 'This option controls the output behavior of **`check_multi`**. The placeholder
    **``*`integer`*``** can take on the following values:'
  id: totrans-1362
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项控制 **`check_multi`** 的输出行为。占位符 **``*`integer`*``** 可以取以下值：
- en: '**`1`** includes the service name for error states in parentheses in the plugin
    output:'
  id: totrans-1363
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`1`** 在插件输出中包含括号内的服务名称以表示错误状态：'
- en: '[PRE157]'
  id: totrans-1364
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE157]'
- en: '**`2`** formats the output as HTML. Here the numbers of the individual checks
    (e.g., [ **`3`**]) are stored along with the color of the respective return value
    (green for OK, yellow for WARNING, red for CRITICAL, and orange for UNKNOWN).'
  id: totrans-1365
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`2`** 将输出格式化为HTML。在这里，存储了单个检查的编号（例如，[ **`3`**]）以及相应的返回值颜色（绿色表示OK，黄色表示WARNING，红色表示CRITICAL，橙色表示UNKNOWN）。'
- en: If you use **`check_multi`** recursively (a **`check_multi`** itself calls other
    instances of **`check_multi`**), the output of the subordinate checks are indented
    (see [Figure 8-3](../Text/ch08s05.html#recursive_output_of_chech_underscore_mul
    "Figure 8-3. Recursive output of chech_multi on the Extended Infro page of the
    Nagios Web interface") in page 202).
  id: totrans-1366
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果您递归地使用 **`check_multi`**（一个 **`check_multi`** 本身调用其他 **`check_multi`** 实例），则下属检查的输出将缩进（见第202页的[图8-3](../Text/ch08s05.html#recursive_output_of_chech_underscore_mul
    "图8-3. 在Nagios Web界面扩展信息页面上的chech_multi递归输出")）。
- en: '**`4`** shows the output of the individual check—if they exist—on STD-ERR.'
  id: totrans-1367
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`4`** 如果存在，则在STD-ERR上显示单个检查的输出。'
- en: '**`8`** outputs the performance data in the multi-format (see [8.5.6 Performance
    data and PNP](../Text/ch08s05.html#performance_data_and_pnp "8.5.6 Performance
    data and PNP") from page 198).'
  id: totrans-1368
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`8`** 以多格式输出性能数据（见第8.5.6节“性能数据和PNP”，第198页）。'
- en: '**`16`** has the same function as **`1`**, except that states for which there
    are no check results (e.g., **`0 unknown`**) are also included.'
  id: totrans-1369
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`16`** 与 **`1`** 有相同的功能，除了对于没有检查结果的状态（例如，**`0 unknown`**）也会包括在内。'
- en: '**`32`** outputs performance data in the classical format (see [8.5.6 Performance
    data and PNP](../Text/ch08s05.html#performance_data_and_pnp "8.5.6 Performance
    data and PNP")).'
  id: totrans-1370
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`32`** 以经典格式输出性能数据（见[8.5.6 性能数据和PNP](../Text/ch08s05.html#performance_data_and_pnp
    "8.5.6 性能数据和PNP")）。'
- en: '**`128`** extends the HTML format required by **`2`** by including a hyperlink
    to an installed PNP if performance data is available and the output is in multi-format
    (**`8`**). PNP is described in [19.6 Smooth Plotting with PNP](../Text/ch19s06.html
    "19.6 Smooth Plotting with PNP") from page 446.'
  id: totrans-1371
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`128`** 通过包含一个指向已安装的PNP的超链接来扩展了**`2`**所需的HTML格式，如果可用性能数据且输出为多格式（**`8`**）。PNP在[19.6
    使用PNP进行平滑绘图](../Text/ch19s06.html "19.6 使用PNP进行平滑绘图")的第446页进行描述。'
- en: '**`256`** displays the output in XML formatting.'
  id: totrans-1372
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`256`** 以XML格式显示输出。'
- en: '**`512`** ensures that the output is Nagios 2.x compatible in order to bring
    the output below the 300-byte limit.'
  id: totrans-1373
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`512`** 确保输出与Nagios 2.x兼容，以便将输出控制在300字节限制以下。'
- en: Indivudal values may be combined; the default is 13 (8 + 4 + 1).
  id: totrans-1374
  prefs: []
  type: TYPE_NORMAL
  zh: 可以组合单个值；默认为13（8 + 4 + 1）。
- en: '**`-w`** **``*`expression`*``** **`/ --warning=`****``*`expression`*``**'
  id: totrans-1375
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`expression`*``** **`/ --warning=`****``*`expression`*``**'
- en: 'This sets the status WARNING if **``*`expression`*``** is true, e.g., **`COUNT
    (WARNING) > 0`** (the default). For all states, **`check_multi`** separately checks
    whether or not the corresponding status was determined. Eventually, the status
    with the highest priority wins out: CRITICAL trumps WARNING, trumps UNKNOWN, trumps
    OK. The definition and use of expressions is explained in [8.5.7 Simple business
    process monitoring](../Text/ch08s05.html#simple_business_process_monitoring "8.5.7
    Simple business process monitoring") from page 199.'
  id: totrans-1376
  prefs: []
  type: TYPE_NORMAL
  zh: 如果**``*`expression`*``**为真，则设置状态为WARNING，例如**`COUNT (WARNING) > 0`**（默认）。对于所有状态，**`check_multi`**分别检查相应的状态是否已确定。最终，具有最高优先级的状态获胜：CRITICAL胜过WARNING，胜过UNKNOWN，胜过OK。表达式定义和使用的说明见[8.5.7
    简单业务流程监控](../Text/ch08s05.html#simple_business_process_monitoring "8.5.7 简单业务流程监控")的第199页。
- en: '**`-c`** **``*`ausdruck`*``** **`/ --critical=`****``*`expression`*``**'
  id: totrans-1377
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`ausdruck`*``** **`/ --critical=`****``*`expression`*``**'
- en: If the expression is true, the status is set to CRITICAL. Eventually, the status
    with the highest priority wins out (see **`--warning`** and [8.5.7 Simple business
    process monitoring](../Text/ch08s05.html#simple_business_process_monitoring "8.5.7
    Simple business process monitoring")).
  id: totrans-1378
  prefs: []
  type: TYPE_NORMAL
  zh: 如果表达式为真，则将状态设置为CRITICAL。最终，具有最高优先级的状态获胜（见**`--warning`**和[8.5.7 简单业务流程监控](../Text/ch08s05.html#simple_business_process_monitoring
    "8.5.7 简单业务流程监控")）。
- en: '**`-u`** **``*`expression`*``** **`/ --unknown=`****``*`expression`*``**'
  id: totrans-1379
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u`** **``*`expression`*``** **`/ --unknown=`****``*`expression`*``**'
- en: If the expression is true, the status UNKNOWN is set. The status with the highest
    priority (see **`--warning`** and [8.5.7 Simple business process monitoring](../Text/ch08s05.html#simple_business_process_monitoring
    "8.5.7 Simple business process monitoring")) wins out.
  id: totrans-1380
  prefs: []
  type: TYPE_NORMAL
  zh: 如果表达式为真，则设置状态UNKNOWN。具有最高优先级的状态（见**`--warning`**和[8.5.7 简单业务流程监控](../Text/ch08s05.html#simple_business_process_monitoring
    "8.5.7 简单业务流程监控")）获胜。
- en: '**`-o`** **``*`expression`*``** **`/ --ok=`****``*`expression`*``**'
  id: totrans-1381
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-o`** **``*`expression`*``** **`/ --ok=`****``*`expression`*``**'
- en: If **``*`ausdruck`*``** is true, the status OK is set. Here the status with
    the highest priority also wins out (see **`--warning`** and [8.5.7 Simple business
    process monitoring](../Text/ch08s05.html#simple_business_process_monitoring "8.5.7
    Simple business process monitoring")).
  id: totrans-1382
  prefs: []
  type: TYPE_NORMAL
  zh: 如果**``*`ausdruck`*``**为真，则设置状态OK。在这里，具有最高优先级的状态也获胜（见**`--warning`**和[8.5.7 简单业务流程监控](../Text/ch08s05.html#simple_business_process_monitoring
    "8.5.7 简单业务流程监控")）。
- en: '**`-v / --verbose`**'
  id: totrans-1383
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-v / --verbose`**'
- en: This increases the verbosity of the plugin for debugging purposes. The option
    can be used up to three times; if specified three times, you will obtain the most
    detailed information.
  id: totrans-1384
  prefs: []
  type: TYPE_NORMAL
  zh: 这增加了插件的详细程度，以便进行调试。此选项最多可以使用三次；如果指定了三次，您将获得最详细的信息。
- en: 8.5.6 Performance data and PNP
  id: totrans-1385
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.5.6 性能数据和PNP
- en: 'In the simple output form for performance data (which can be set with the option
    **``*`-r`*``** **`32`**), **`check_multi`** simply lists all variables provided
    by the plugins:'
  id: totrans-1386
  prefs: []
  type: TYPE_NORMAL
  zh: 在性能数据的简单输出形式（可以通过选项**``*`-r`*``** **`32`**设置）中，**`check_multi`**简单地列出插件提供的所有变量：
- en: '[PRE158]'
  id: totrans-1387
  prefs: []
  type: TYPE_PRE
  zh: '[PRE158]'
- en: The performance data for the plugin **`check_icmp`** (the average response time
    **``*`r`*``****`ta`** and the packet loss **`pl`**) in this example seamlessly
    follow the performance data of **`check_ntp`** in the form of deviation from the
    local system time (**`offset`**). You can't tell, at first glance, what information
    comes from which plugin—you have to consult the order in the configuration file
    and the outputs of the individual checks.
  id: totrans-1388
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，插件 **`check_icmp`**（平均响应时间 **``*`r`*``****`ta`** 和丢包率 **`pl`**）的性能数据无缝地跟随
    **`check_ntp`** 的性能数据，形式为与本地系统时间的偏差（**`offset`**）。一开始你无法判断信息来自哪个插件——你必须查阅配置文件的顺序和各个检查的输出。
- en: 'This is not particularly suitable for automatic processing. **`check_multi`**
    therefore provides an extended output with the default option **``*`-r`*``****`8`**,
    which is modified specifically to handle PNP (see [19.6 Smooth Plotting with PNP](../Text/ch19s06.html
    "19.6 Smooth Plotting with PNP") from page 446). When doing this, the plugin adds
    a service description and the name of the plugin used to the name of the variables.
    No deviation is made from the standardized format; the label is just given a more
    extensive form:'
  id: totrans-1389
  prefs: []
  type: TYPE_NORMAL
  zh: 这并不特别适合自动处理。因此，**`check_multi`** 提供了默认选项 **``*`-r`*``****`8`** 的扩展输出，该选项专门修改以处理
    PNP（参见第 446 页的 [19.6 使用 PNP 进行平滑绘图](../Text/ch19s06.html "19.6 使用 PNP 进行平滑绘图")）。在这种情况下，插件会将服务描述和所使用的插件名称添加到变量名称中。没有偏离标准化格式；标签只是给出了更广泛的形式：
- en: '[PRE159]'
  id: totrans-1390
  prefs: []
  type: TYPE_PRE
  zh: '[PRE159]'
- en: 'PNP requires information on the plugin executed so that it can select a suitable
    template for processing the graphics (see [19.6.5 How should the graphic appear?](../Text/ch19s06.html#how_should_the_graphic_appear_question
    "19.6.5 How should the graphic appear?") from page 454). In addition, **`check_multi`**
    now also provides performance data referring to the overall processing:'
  id: totrans-1391
  prefs: []
  type: TYPE_NORMAL
  zh: PNP 需要有关已执行插件的详细信息，以便它可以选择一个合适的模板来处理图形（参见第 454 页的 [19.6.5 图形应该如何显示？](../Text/ch19s06.html#how_should_the_graphic_appear_question
    "19.6.5 图形应该如何显示？")）。此外，**`check_multi`** 现在也提供了关于整体处理的性能数据：
- en: '[PRE160]'
  id: totrans-1392
  prefs: []
  type: TYPE_PRE
  zh: '[PRE160]'
- en: First **`check_multi`** announces that it has called **`5`** plugins and has
    used a total of 0.18 seconds for processing. This is followed by the performance
    data for the other plugins, each supplemented with the service description and
    plugin name. If a plugin issues more than one variable, the service description
    and plugin name are not repeated.
  id: totrans-1393
  prefs: []
  type: TYPE_NORMAL
  zh: 首先 **`check_multi`** 宣布它已调用 **`5`** 个插件，并用了总共 0.18 秒来处理。随后是其他插件的性能数据，每个都补充了服务描述和插件名称。如果一个插件发出多个变量，则服务描述和插件名称不会重复。
- en: 8.5.7 Simple business process monitoring
  id: totrans-1394
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 8.5.7 简单业务流程监控
- en: In order to evaluate business processes, you generally want to know whether
    a particular process is working—for instance, whether or not a customer can perform
    online banking. Individual pieces of information on all hosts and services involved
    are not relevant from this perspective and are also not always useful if systems
    are designed redundantly in different forms.
  id: totrans-1395
  prefs: []
  type: TYPE_NORMAL
  zh: 为了评估业务流程，你通常想知道某个特定流程是否在运行——例如，客户是否能够进行在线银行操作。所有涉及的主机和服务的个别信息从这个角度来看并不相关，而且在系统以不同形式冗余设计的情况下也并不总是有用的。
- en: '![For the terminal server farm to be reachable from the Internet, an OpenVPN
    access and a terminal server must be available.](../Images/tagoreillycom20081104nostarchimages223810.png.jpg)'
  id: totrans-1396
  prefs: []
  type: TYPE_IMG
  zh: '![要从互联网访问终端服务器农场，必须提供 OpenVPN 访问和终端服务器。](../Images/tagoreillycom20081104nostarchimages223810.png.jpg)'
- en: Figure 8-2. For the terminal server farm to be reachable from the Internet,
    an OpenVPN access and a terminal server must be available.
  id: totrans-1397
  prefs: []
  type: TYPE_NORMAL
  zh: 图 8-2. 要从互联网访问终端服务器农场，必须提供 OpenVPN 访问和终端服务器。
- en: 'One example is shown in [Figure 8-2](../Text/ch08s05.html#for_the_terminal_server_arm_to_be_reacha
    "Figure 8-2. For the terminal server farm to be reachable from the Internet, an
    OpenVPN access and a terminal server must be available."): Home office users access
    a terminal server farm via OpenVPN. For access from the Internet, two connections
    are available, and with **`gate1`** and **`gate2`**, two OpenVPN gateways are
    available. The terminal server farm consists of the eight terminal servers **`ts01`**
    through **`ts08`**.'
  id: totrans-1398
  prefs: []
  type: TYPE_NORMAL
  zh: 一个例子显示在 [图 8-2](../Text/ch08s05.html#for_the_terminal_server_arm_to_be_reacha
    "图 8-2. 要从互联网访问终端服务器农场，必须提供 OpenVPN 访问和终端服务器。") 中：在家办公的用户通过 OpenVPN 访问终端服务器农场。对于从互联网的访问，有两个连接可用，并且有
    **`gate1`** 和 **`gate2`**，两个 OpenVPN 网关可用。终端服务器农场由八个终端服务器 **`ts01`** 到 **`ts08`**
    组成。
- en: 'In order for home office users to be able to work, at least one Internet connection
    (including the accompanying gateway) must be available, and the server farm must
    be reachable. The business process can be split into two processes: Our example
    looks at the Internet access separated from the server farm, and afterward it
    can connect the two results with one another.'
  id: totrans-1399
  prefs: []
  type: TYPE_NORMAL
  zh: 为了让在家办公的用户能够工作，至少必须有一个互联网连接（包括伴随的网关）可用，并且服务器场必须可访问。业务流程可以分为两个过程：我们的例子将互联网访问与服务器场分开，然后可以使用一个过程将两个结果连接起来。
- en: 'The condition for a critical status for Internet access could be formulated
    as follows:'
  id: totrans-1400
  prefs: []
  type: TYPE_NORMAL
  zh: 互联网访问处于关键状态的条件可以表述如下：
- en: '[PRE161]'
  id: totrans-1401
  prefs: []
  type: TYPE_PRE
  zh: '[PRE161]'
- en: 'Access is unusable if the provider is unreachable or (**`||`**) the OpenVPN
    service is not available on the gateway. But it is sufficient if one of the two
    access points is functioning (thus the AND logical operator with &&). The syntax
    is taken from Perl and can equally be processed by **`check_multi`**. The configuration
    file for the Internet check therefore contains four commands and the logocal operators:'
  id: totrans-1402
  prefs: []
  type: TYPE_NORMAL
  zh: 如果提供者不可达或（**`||`**）网关上没有可用的 OpenVPN 服务，则访问不可用。但如果两个接入点中的任何一个正在工作（因此使用 && 逻辑运算符），则足够了。语法来自
    Perl，并且可以由 **`check_multi`** 同样处理。因此，用于互联网检查的配置文件包含四个命令和逻辑运算符：
- en: '[PRE162]'
  id: totrans-1403
  prefs: []
  type: TYPE_PRE
  zh: '[PRE162]'
- en: The two **`gate*`** commands each check (via NRPE) whether the gateway of the
    OpenVPN service is running. The provider test sends ICMP echo packets to the dial-up
    router of the respective provider. You should take great care here to ensure that
    routing is correctly set up, that is, that the ICMP packets to the respective
    provider really are sent across the accompanying connection.
  id: totrans-1404
  prefs: []
  type: TYPE_NORMAL
  zh: 两个 **`gate*`** 命令各自检查（通过 NRPE）OpenVPN 服务的网关是否正在运行。提供者测试向各自提供者的拨号路由器发送 ICMP 回显数据包。在这里，你应该非常小心，确保路由设置正确，即向各自提供者的
    ICMP 数据包确实是通过伴随的连接发送的。
- en: 'For a business process, a Boolean expression for individual states is defined
    in the configuration file, so depending on requirements, there may be one for
    CRITICAL, one for WARNING, and, if necessary, one for UNKNOWN as well. The syntax
    and the operators are passed on to Perl as specified and are described in detail
    in the Perl online documentation (**`man`** **``*`per`*``****`lop`**). Before
    evaluating the expression, **`check_multi`** undertakes the following substitutions:'
  id: totrans-1405
  prefs: []
  type: TYPE_NORMAL
  zh: 对于业务流程，配置文件中定义了单个状态的布尔表达式，因此根据需要，可能会有一个用于 CRITICAL，一个用于 WARNING，如果需要，还有一个用于
    UNKNOWN。语法和运算符按照指定传递给 Perl，并在 Perl 在线文档（**`man`** **``*`per`*``****`lop`**）中详细描述。在评估表达式之前，**`check_multi`**
    执行以下替换：
- en: If the expression contains the name of a check previously defined with **`command`**,
    the return value of this check will be used instead. Let's assume that check **`gatel`**
    returns **`2`** and check **`providerl`** returns **`1`**. Then the partial expression
    shown above will become
  id: totrans-1406
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果表达式中包含之前使用 **`command`** 定义的检查的名称，则将使用该检查的返回值。假设检查 **`gatel`** 返回 **`2`**，检查
    **`providerl`** 返回 **`1`**。那么上述部分表达式将变为
- en: '[PRE163]'
  id: totrans-1407
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE163]'
- en: Within the brackets, the first condition is true, and through the subsequent
    OR (**`||`** in Perl syntax) the partial expression evaluates to true.
  id: totrans-1408
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在括号内，第一个条件为真，并通过随后的 OR（Perl 语法中的 **`||`**）操作，部分表达式评估为真。
- en: The function **`count`** determines the number of all checks that provided the
    return value given as an argument.
  id: totrans-1409
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 函数 **`count`** 确定所有提供作为参数给出的返回值的检查的数量。
- en: Instead of the numerical value of a status, the text form (UNKNOWN, WARNING,
    CRITICAL, WARNING, OK) can also be included in the expression (so you can write
    something like **`gate1 > WARNING`**). This detail is replaced by **`check_multi`**
    with the numerical value before the expression is evaluated.
  id: totrans-1410
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在表达式中，除了状态数值之外，还可以包含文本形式（UNKNOWN、WARNING、CRITICAL、WARNING、OK），（因此可以写类似 **`gate1
    > WARNING`** 的内容）。这个细节在表达式评估之前由 **`check_multi`** 替换为数值。
- en: The WARNING status is set in **`openvpn.cmd`** if at least one critical status
    occurs, at least one check delivers UNKNOWN, or at least one check returns WARNING.
    The CRITICAL status appears if both accesses should fail (because of the AND logical
    operator between the two partial expressions in brackets). The partial expressions
    on their own are true if either of the **`gate`** or **`provider`** checks delivers
    a CRITICAL (return value **`2`**) or an UNKNOWN (return value **`3`**). The condition
    for the UNKNOWN status can be omitted since UNKNOWN results always lead to the
    WARNING status.
  id: totrans-1411
  prefs: []
  type: TYPE_NORMAL
  zh: 当至少发生一个关键状态、至少一个检查返回未知或至少一个检查返回警告时，警告状态将在**`openvpn.cmd`**中设置。如果两个访问都应失败（因为括号中两个部分表达式之间的AND逻辑运算符），则会出现关键状态。如果**`gate`**或**`provider`**检查中的任何一个返回关键（返回值**`2`**）或未知（返回值**`3`**），则部分表达式本身为真。由于未知结果总是导致警告状态，因此可以省略未知状态的条件。
- en: 'The second partial process—the function of the terminal server farm—is described
    in the configuration file **`terminalserver.cmd`**:'
  id: totrans-1412
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个部分过程——终端服务器农场的功能——在配置文件**`terminalserver.cmd`**中描述：
- en: '[PRE164]'
  id: totrans-1413
  prefs: []
  type: TYPE_PRE
  zh: '[PRE164]'
- en: The individual checks here consist of only a primitive TCP check of the RDP
    port 3389 in order to keep the example relatively simple. WARNING should be indicated
    if at least one CRITICAL or at least one UNKNOWN occurs so that the administrator
    has the opportunity to fix the problem at an early stage. The condition for the
    CRITICAL status stipulates that **`ts01`** must not be CRITICAL because a very
    specific application is running there which is not available on the other servers.
    In addition, no more than three terminal servers may fail, as otherwise the load
    on the other servers may increase so heavily that useful work would no longer
    be possible.
  id: totrans-1414
  prefs: []
  type: TYPE_NORMAL
  zh: 这里单独的检查仅包括对RDP端口3389的原始TCP检查，以保持示例相对简单。如果至少发生一个关键或至少一个未知，应指示警告，以便管理员有机会在早期修复问题。对于关键状态的条件规定，**`ts01`**不得为关键，因为那里运行着一个非常特定的应用程序，其他服务器上没有。此外，不超过三个终端服务器可能失败，否则其他服务器的负载可能会增加得如此之高，以至于无法进行有用的工作。
- en: '![Recursive output of chech_multi on the Extended Infro page of the Nagios
    Web interface](../Images/tagoreillycom20081104nostarchimages223812.png.jpg)'
  id: totrans-1415
  prefs: []
  type: TYPE_IMG
  zh: '![Nagios Web界面扩展信息页面上的chech_multi递归输出](../Images/tagoreillycom20081104nostarchimages223812.png.jpg)'
- en: Figure 8-3. Recursive output of `chech_multi` on the Extended Infro page of
    the Nagios Web interface
  id: totrans-1416
  prefs: []
  type: TYPE_NORMAL
  zh: 图8-3. Nagios Web界面扩展信息页面上的`chech_multi`递归输出
- en: 'The two checks of the partial processes are summarized by a **`check_multi`**
    call into a single result (the lines are wrapped for display purposes):'
  id: totrans-1417
  prefs: []
  type: TYPE_NORMAL
  zh: 部分过程的两个检查通过一个**`check_multi`**调用汇总为一个单一的结果（以下行是为了显示目的而换行的）：
- en: '[PRE165]'
  id: totrans-1418
  prefs: []
  type: TYPE_PRE
  zh: '[PRE165]'
- en: So that the Extended Info page of Nagios ([Figure 8-3](../Text/ch08s05.html#recursive_output_of_chech_underscore_mul
    "Figure 8-3. Recursive output of chech_multi on the Extended Infro page of the
    Nagios Web interface")) is more presentable, the details of the respective plugin
    names are omitted (through the missing option **`-n`**; the recursive HTML output
    of **`check_multi`** adds the name of the check called anyway). The **`-r 31`**
    detail sets all reporting functions from 1 to 16, including HTML formatting (**``*`-r`*``**
    **`2`**). Special conditions for a status are not formulated, so a WARNING of
    a partial process leads to a WARNING in the overlying check, and a CRITICAL leads
    to a CRITICAL.
  id: totrans-1419
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使Nagios的扩展信息页面（[图8-3](../Text/ch08s05.html#recursive_output_of_chech_underscore_mul
    "图8-3. Nagios Web界面扩展信息页面上的chech_multi递归输出"))更具可读性，省略了各自的插件名称的细节（通过缺失的选项**`-n`**；**`check_multi`**的递归HTML输出添加了无论如何被调用的检查名称）。**`-r
    31`**细节设置所有报告功能从1到16，包括HTML格式（**``*`-r`*``** **`2`**）。没有为状态的特殊条件制定公式，因此部分过程的警告会导致上层检查的警告，而关键会导致关键。
- en: '[Figure 8-3](../Text/ch08s05.html#recursive_output_of_chech_underscore_mul
    "Figure 8-3. Recursive output of chech_multi on the Extended Infro page of the
    Nagios Web interface") shows the two partial processes quite clearly separated.
    The serial numbers of the checks are stored with the respective status colors,
    which are unfortunately not visible in this black-and-white book. A complex color
    example of recursive display in the Extended Info Web page can be found on the
    homepage of the plugin.^([[90](#ftn.CHP-8-FN-6)])'
  id: totrans-1420
  prefs: []
  type: TYPE_NORMAL
  zh: '[图8-3](../Text/ch08s05.html#recursive_output_of_chech_underscore_mul "图8-3. chech_multi在Nagios
    Web界面扩展信息页面上的递归输出")清楚地显示了两个部分流程。检查的序列号与相应的状态颜色一起存储，遗憾的是，这些颜色在这本黑白书中不可见。在插件主页上可以找到复杂颜色示例的递归显示在扩展信息Web页面上.^([[90](#ftn.CHP-8-FN-6)])'
- en: 'For the sake of completeness, here is the definition of command and service
    for Nagios. The former is kept deliberately simple, and all the details for the
    command line are repeated in the service definition:'
  id: totrans-1421
  prefs: []
  type: TYPE_NORMAL
  zh: 为了完整性，以下是Nagios的命令和服务的定义。前者被故意保持简单，并且所有命令行的详细信息都在服务定义中重复：
- en: '[PRE166]'
  id: totrans-1422
  prefs: []
  type: TYPE_PRE
  zh: '[PRE166]'
- en: If the mapping of business processes with **`check_multi`** isn't enough for
    you, you should take a look at the somewhat more complex addon *Nagios Business
    Process View and Nagios Business Impact Analysis* from the Sparda-Datenverarbeitung
    eG, Nuremberg, Germany, which is available on the Nagios-Exchange.^([[91](#ftn.CHP-8-FN-7)])
  id: totrans-1423
  prefs: []
  type: TYPE_NORMAL
  zh: 如果使用**`check_multi`**对业务流程的映射不足以满足您的需求，您应该查看来自德国纽伦堡的Sparda-Datenverarbeitung
    eG提供的相对更复杂的插件*Nagios Business Process View and Nagios Business Impact Analysis*，该插件可在Nagios-Exchange上找到.^([[91](#ftn.CHP-8-FN-7)])
- en: In contrast to **`check_multi`**, which appears as the only Nagios service and
    which also needs to be managed only once by Nagios, this addon uses services already
    defined in Nagios, which means that Nagios performs each individual check as usual.
    It retrieves the results of individual checks, links these, and displays them
    on its own Web interface.
  id: totrans-1424
  prefs: []
  type: TYPE_NORMAL
  zh: 与仅作为唯一Nagios服务出现且只需由Nagios管理一次的**`check_multi`**不同，此插件使用Nagios中已定义的服务，这意味着Nagios会像往常一样执行每个单个检查。它检索单个检查的结果，将这些结果链接起来，并在自己的Web界面上显示。
- en: When doing so, the result of such links—business processes, so to speak—can
    be redefined in Nagios as a separate service so that it is possible, for instance,
    to use the notification logic of Nagios. Furthermore, the addon includes a mode
    with which it can simulate a "what would happen if" scenario. Individual services
    are set to an expected status, and the effects can be seen via the Web interface.
  id: totrans-1425
  prefs: []
  type: TYPE_NORMAL
  zh: 在这样做的时候，这些链接（即业务流程）的结果可以在Nagios中重新定义为单独的服务，这样就可以使用Nagios的通知逻辑。此外，该插件还包括一个模式，可以模拟“如果发生什么情况”的情景。单个服务被设置为预期的状态，并且可以通过Web界面查看其效果。
- en: '**`check_multi`** and the Nagios Business Process View and Nagios Business
    Impact Analysis addon are thus not in competition. Depending on the intended use,
    either **`check_multi`** will reduce the complexity of the services represented
    in Nagios and therefore will reduce the number of checks performed, or the addon
    will allow a more detailed view of overall events, though it does demand that
    all services are individually mapped in Nagios.'
  id: totrans-1426
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，**`check_multi`**和Nagios Business Process View以及Nagios Business Impact Analysis插件并不相互竞争。根据预期的用途，**`check_multi`**将减少Nagios中表示的服务复杂性，从而减少执行的检查数量，或者插件将允许更详细地查看整体事件，尽管它要求在Nagios中单独映射所有服务。
- en: '* * *'
  id: totrans-1427
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[87](#CHP-8-FN-3)]) [http://www.my-plugin.de/wiki/de/projects/check_multi/installation#c
    heck_by_ssh](http://www.my-plugin.de/wiki/de/projects/check_multi/installation#c%20heck_by_ssh)
  id: totrans-1428
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[87](#CHP-8-FN-3)]) [http://www.my-plugin.de/wiki/de/projects/check_multi/installation#c
    heck_by_ssh](http://www.my-plugin.de/wiki/de/projects/check_multi/installation#c%20heck_by_ssh)
- en: ^([[88](#CHP-8-FN-4)]) [http://www.my-plugin.de/wiki/de/projects/check_multi/start](http://www.my-plugin.de/wiki/de/projects/check_multi/start)
  id: totrans-1429
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[88](#CHP-8-FN-4)]) [http://www.my-plugin.de/wiki/de/projects/check_multi/start](http://www.my-plugin.de/wiki/de/projects/check_multi/start)
- en: ^([[89](#CHP-8-FN-5)]) Let us assume that 53 have passed since **`check_multi`**
    was called, but not all planned individual checks have yet been processed. The
    total from starting time and individual timeout (53 + 10 = 63) exceeds the timeout
    of the **`check_multi`** call, so **`check_multi`** does not start any further
    checks.
  id: totrans-1430
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[89](#CHP-8-FN-5)]) 假设自**`check_multi`**被调用以来已经过去了53分钟，但并非所有计划的单个检查都已完成。从开始时间和单个超时（53
    + 10 = 63）的总和超过了**`check_multi`**调用的超时时间，因此**`check_multi`**不会启动任何进一步的检查。
- en: ^([[90](#CHP-8-FN-6)]) [http://www.my-plugin.de/wiki/de/projects/check_multi/screenshot#ser-vice_extended_info_rekursiv](http://www.my-plugin.de/wiki/de/projects/check_multi/screenshot#ser-vice_extended_info_rekursiv)
  id: totrans-1431
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[90](#CHP-8-FN-6)]) [http://www.my-plugin.de/wiki/de/projects/check_multi/screenshot#ser-vice_extended_info_rekursiv](http://www.my-plugin.de/wiki/de/projects/check_multi/screenshot#ser-vice_extended_info_rekursiv)
- en: ^([[91](#CHP-8-FN-7)]) [http://www.nagioserchange.org/22;1088](http://www.nagioserchange.org/22;1088)
  id: totrans-1432
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[91](#CHP-8-FN-7)]) [http://www.nagioserchange.org/22;1088](http://www.nagioserchange.org/22;1088)
- en: Chapter 9. Executing Plugins via SSH
  id: totrans-1433
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第9章。通过SSH执行插件
- en: Local plugins, that is, programs that only run tests locally because there are
    no network protocols available, must be installed on the target system and started
    there. They check processes, CPU load, or how much free hard disk capacity is
    still available, among other things.
  id: totrans-1434
  prefs: []
  type: TYPE_NORMAL
  zh: 本地插件，即仅在本地上运行测试的程序，因为不存在网络协议，必须在目标系统上安装并启动。它们检查进程、CPU负载或剩余多少空闲硬盘容量，等等。
- en: But if you still want to execute these plugins from the Nagios server, it is
    recommended that you use the secure shell, especially if any kind of Unix system
    is installed on the machine to be tested—a Secure Shell daemon will almost always
    be running on such a target system, and you do not require any special permissions
    to run most plugins. The Nagios administrator needs nothing more than an account,
    which he can use from the Nagios server. On the server itself, the **`check_by_ssh`**
    plugin must be installed.
  id: totrans-1435
  prefs: []
  type: TYPE_NORMAL
  zh: 但是，如果您仍然想从Nagios服务器执行这些插件，建议您使用安全外壳，特别是如果测试的机器上安装了任何类型的Unix系统——在这样的目标系统上，Secure
    Shell守护进程几乎总是运行的，并且您不需要任何特殊权限来运行大多数插件。Nagios管理员只需要一个账户，他可以从Nagios服务器使用这个账户。在服务器本身，必须安装**`check_by_ssh`**插件。
- en: 'In heterogeneous environments the Secure Shell itself often create conditions
    that may cause problems: depending on the operating system, an SSH daemon may
    be in use that returns a false return code^([[92](#ftn.CHP-9-FN-1)]) or is so
    old that it cannot handle the SSH protocol version 2.0\. In this case it is better
    to install the current OpenSSH version.^([[93](#ftn.CHP-9-FN-2)]) In pure Linux
    environments with up-to-date and maintained installations, such problems generally
    do not occur.'
  id: totrans-1436
  prefs: []
  type: TYPE_NORMAL
  zh: 在异构环境中，Secure Shell本身常常会创建可能导致问题的条件：根据操作系统，可能正在使用一个返回错误返回代码^([[92](#ftn.CHP-9-FN-1)])的SSH守护进程，或者它太旧，无法处理SSH协议版本2.0。在这种情况下，最好安装当前的OpenSSH版本.^([[93](#ftn.CHP-9-FN-2)])
    在纯Linux环境中，如果安装最新且维护良好，这些问题通常不会发生。
- en: 9.1 The **`check_by_ssh`** Plugin
  id: totrans-1437
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 9.1 **`check_by_ssh`**插件
- en: '**`check_by_ssh`** is run on the Nagios server and establishes a Secure Shell
    connection to a remote computer so that it can perform local tests on it. The
    programs run on the remote machine are to a large extent local plugins (see [Chapter 7](../Text/ch07.html
    "Chapter 7. Testing Local Resources") from page 157); the use of **`check_by_ssh`**
    is not just restricted to these, however.'
  id: totrans-1438
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_by_ssh`**在Nagios服务器上运行，并建立一个到远程计算机的Secure Shell连接，以便可以在其上执行本地测试。在远程机器上运行的程序在很大程度上是本地插件（参见第7章[测试本地资源](../Text/ch07.html
    "第7章。测试本地资源")，第157页）；然而，**`check_by_ssh`**的使用并不仅限于这些。'
- en: 'The plugin sends a complete command line to the remote computer and then waits
    for a plugin-compatible response: a response status between **`0`** (OK) and **`3`**
    (UNKNOWN), as well as a one-line text information for the administrator ([Chapter 6](../Text/ch06.html
    "Chapter 6. Plugins for Network Services")).'
  id: totrans-1439
  prefs: []
  type: TYPE_NORMAL
  zh: 插件向远程计算机发送完整的命令行，然后等待插件兼容的响应：一个介于**`0`**（OK）和**`3`**（UNKNOWN）之间的响应状态，以及一行文本信息供管理员使用（[第6章](../Text/ch06.html
    "第6章。网络服务插件")）。
- en: If you run network plugins via **`check_by_ssh`** in order to perform tests
    on other computers, these are known as *indirect checks*, which will be explained
    in the context of the *Nagios Remote Plugin Executor* in [10.6 Indirect Checks](../Text/ch10s06.html
    "10.6 Indirect Checks") from page 224.
  id: totrans-1440
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您通过**`check_by_ssh`**运行网络插件以在其他计算机上执行测试，这些被称为*间接检查*，将在[10.6间接检查](../Text/ch10s06.html
    "10.6间接检查")中解释，见第224页。
- en: 'The following example shows how **`check_by_ssh`** can be used to check the
    swap partition on the target computer:'
  id: totrans-1441
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例展示了如何使用**`check_by_ssh`**来检查目标计算机上的交换分区：
- en: '[PRE167]'
  id: totrans-1442
  prefs: []
  type: TYPE_PRE
  zh: '[PRE167]'
- en: The command is similar to that for a secure shell, in the form of
  id: totrans-1443
  prefs: []
  type: TYPE_NORMAL
  zh: 命令与安全外壳的命令类似，形式为
- en: '[PRE168]'
  id: totrans-1444
  prefs: []
  type: TYPE_PRE
  zh: '[PRE168]'
- en: The fact that a separate private key—not the default private key in the home
    directory—is used, is optional and is described in detail in [9.2 Configuring
    SSH](../Text/ch09s02.html "9.2 Configuring SSH") from page 208\. The command to
    be run is specified in **`check_by_ssh`**—in contrast to the secure shell **`ssh`**—with
    the option **`-C`**, the plugin is always specified with an absolute path.
  id: totrans-1445
  prefs: []
  type: TYPE_NORMAL
  zh: 使用单独的私钥（不是主目录中的默认私钥）是可选的，并在 [9.2 配置 SSH](../Text/ch09s02.html "9.2 配置 SSH")
    中详细描述，从第 208 页开始。要运行的命令在 **`check_by_ssh`** 中指定——与安全的 shell **`ssh`** 相比——使用带有选项
    **`-C`** 的命令，插件始终使用绝对路径。
- en: '**`check_by_sshhas`** the following options:'
  id: totrans-1446
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_by_sshhas`** 具有以下选项：'
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  id: totrans-1447
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
- en: The host name or IP address of the computer to which the plugin should set up
    an SSH connection.
  id: totrans-1448
  prefs: []
  type: TYPE_NORMAL
  zh: 插件应建立 SSH 连接的计算机的主机名或 IP 地址。
- en: '**`-C`** **``*`command`*``** **`/--command=`****``*`command`*``**'
  id: totrans-1449
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`command`*``** **`/--command=`****``*`command`*``**'
- en: 'The command to be run on the remote computer, that is, the plugin with its
    complete path and all the necessary parameters:'
  id: totrans-1450
  prefs: []
  type: TYPE_NORMAL
  zh: 在远程计算机上运行的命令，即带有完整路径和所有必要参数的插件：
- en: '[PRE169]'
  id: totrans-1451
  prefs: []
  type: TYPE_PRE
  zh: '[PRE169]'
- en: '**`−1 /--proto1`**'
  id: totrans-1452
  prefs: []
  type: TYPE_NORMAL
  zh: '**`−1 /--proto1`**'
- en: Force version 1 of the secure shell protocol.
  id: totrans-1453
  prefs: []
  type: TYPE_NORMAL
  zh: 强制使用 secure shell 协议的第 1 版。
- en: '**`−2 /--proto2`**'
  id: totrans-1454
  prefs: []
  type: TYPE_NORMAL
  zh: '**`−2 /--proto2`**'
- en: Force version 2 of the secure shell protocol.
  id: totrans-1455
  prefs: []
  type: TYPE_NORMAL
  zh: 强制使用 secure shell 协议的第 2 版。
- en: '**`-o`** **``*`ssh_option`*``** **`/--ssh-option=`****``*`ssh_option`*``**
    (from version 1.4.6)'
  id: totrans-1456
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-o`** **``*`ssh_option`*``** **`/--ssh-option=`****``*`ssh_option`*``**
    (从版本 1.4.6)'
- en: Passes an SSH option to the secure shell on the target host. To specify multiple
    options, use of the switch is repeated.
  id: totrans-1457
  prefs: []
  type: TYPE_NORMAL
  zh: 将 SSH 选项传递给目标主机上的 Secure Shell。要指定多个选项，请重复使用开关。
- en: '**`-i`** **``*`keyfile`*``** **`/--ldentlty=`****``*`keyfile`*``**'
  id: totrans-1458
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-i`** **``*`keyfile`*``** **`/--ldentlty=`****``*`keyfile`*``**'
- en: Which file should be used instead of the standard key file containing the private
    key of the user **`nagios?`** For one option, which is recommended, see [9.2.3
    Checking the SSH connection and check_by_ssh](../Text/ch09s02.html#checking_the_ssh_connection_and_check_un
    "9.2.3 Checking the SSH connection and check_by_ssh"), page 210.
  id: totrans-1459
  prefs: []
  type: TYPE_NORMAL
  zh: 应使用哪个文件代替包含用户 **`nagios`** 的私钥的标准密钥文件。有关一个推荐选项，请参阅 [9.2.3 检查 SSH 连接和 check_by_ssh](../Text/ch09s02.html#checking_the_ssh_connection_and_check_un
    "9.2.3 检查 SSH 连接和 check_by_ssh")，第 210 页。
- en: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
  id: totrans-1460
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
- en: This specifies the port if the Secure Shell daemon on the target server is not
    listening on the standard TCP port 22.
  id: totrans-1461
  prefs: []
  type: TYPE_NORMAL
  zh: 如果目标服务器上的 Secure Shell 守护进程没有监听标准 TCP 端口 22，则指定端口号。
- en: '**`-l`** **``*`user`*``** **`/--logname=`****``*`user`*``**'
  id: totrans-1462
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-l`** **``*`user`*``** **`/--logname=`****``*`user`*``**'
- en: User name on the target host. [**`-S`** **``*`number`*``** /**``--skip-stdout=*`number`*``**
    (from version 1.4.9)]
  id: totrans-1463
  prefs: []
  type: TYPE_NORMAL
  zh: 目标主机上的用户名。 [**`-S`** **``*`number`*``** /**``--skip-stdout=*`number`*``** (从版本
    1.4.9)]
- en: Ignores the specified number of lines at the beginning of the output to STDOUT.
    If this option is omitted, the entire output is ignored.
  id: totrans-1464
  prefs: []
  type: TYPE_NORMAL
  zh: 忽略 STDOUT 输出的指定行数。如果省略此选项，则忽略整个输出。
- en: '**`-E`** **``*`number`*``** **`/--skip-stderr=`****``*`lines`*``** (from version
    1.4.9)'
  id: totrans-1465
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-E`** **``*`number`*``** **`/--skip-stderr=`****``*`lines`*``** (从版本 1.4.9)'
- en: Like **`--skip-stdout`**, but refers only to the output of STDERR.
  id: totrans-1466
  prefs: []
  type: TYPE_NORMAL
  zh: 与 **`--skip-stdout`** 类似，但仅指 STDERR 的输出。
- en: '**`-w`** **``*`floating_point_decimal`*``** **`/--warning=`****``*`floating_point_decimal`*``**'
  id: totrans-1467
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`floating_point_decimal`*``** **`/--warning=`****``*`floating_point_decimal`*``**'
- en: If the response to the command to be executed takes more than *floating_point_decimal*
    seconds, the plugin will issue a warning.
  id: totrans-1468
  prefs: []
  type: TYPE_NORMAL
  zh: 如果执行命令的响应时间超过 *浮点小数* 秒，插件将发出警告。
- en: '**`-c`** **``*`floating_point_decimal`*``** **`/--critical=`****``*`floating_point_decimal`*``**'
  id: totrans-1469
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`floating_point_decimal`*``** **`/--critical=`****``*`floating_point_decimal`*``**'
- en: The critical value in seconds concerning the response time of the command to
    be executed.
  id: totrans-1470
  prefs: []
  type: TYPE_NORMAL
  zh: 关于要执行的命令响应时间的临界值（以秒为单位）。
- en: '**`-f`**^([[94](#ftn.CHP-9-FN-3)])'
  id: totrans-1471
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-f`**^([[94](#ftn.CHP-9-FN-3)])'
- en: Starts a background process without opening an interactive terminal (tty).
  id: totrans-1472
  prefs: []
  type: TYPE_NORMAL
  zh: 在不打开交互式终端（tty）的情况下启动后台进程。
- en: '**`-t`** *timeout* /**`--timeout=`***timeout*'
  id: totrans-1473
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-t`** *超时时间* /**`--timeout=`***超时时间*'
- en: After *timeout* seconds have expired, the plugin stops the test and returns
    the CRITICAL status. The default is **`10`** seconds.
  id: totrans-1474
  prefs: []
  type: TYPE_NORMAL
  zh: 超过 *超时时间* 秒后，插件停止测试并返回 CRITICAL 状态。默认为 **`10`** 秒。
- en: In addition to this, **`check_by_ssh`** has parameters available, **`-o`**,
    **`-s`** and **`-n`**, enabling it to write the result in *passive mode* to the
    *interface for external commands* (see [13.1 The Interface for External Commands](../Text/ch13.html#the_interface_for_external_commands
    "13.1 The Interface for External Commands") from page 292). The mode is named
    this way because Nagios does not receive the information itself but reads it indirectly
    from the interface.
  id: totrans-1475
  prefs: []
  type: TYPE_NORMAL
  zh: 除了这个之外，**`check_by_ssh`** 还有一些可用的参数，**`-o`**，**`-s`** 和 **`-n`**，这使得它能够以**被动模式**将结果写入**外部命令接口**（参见第
    292 页的[13.1 外部命令接口](../Text/ch13.html#the_interface_for_external_commands "13.1
    外部命令接口")）。这种模式之所以被命名为这种方式，是因为 Nagios 本身并不直接接收信息，而是从接口间接读取。
- en: This procedure has the advantage of being able to run several separate commands
    simultaneously over a single SSH connection. This may cause the command definition
    to be rather complicated, however. Since the plugins themselves are called and
    executed as programs on the target server, it hardly matters whether the SSH connection
    is established once or three times. For this reason it is better to use a simple
    command definition rather than the passive mode.
  id: totrans-1476
  prefs: []
  type: TYPE_NORMAL
  zh: 此过程的优势在于能够在单个 SSH 连接上同时运行多个独立的命令。然而，这可能会使命令定义相当复杂。由于插件本身是在目标服务器上作为程序调用和执行的，所以
    SSH 连接建立一次或三次几乎无关紧要。因此，最好使用简单的命令定义而不是被动模式。
- en: But if you still want to find more information about this, you can look in the
    online help, which is called with **`check_by_ssh -h`**.
  id: totrans-1477
  prefs: []
  type: TYPE_NORMAL
  zh: 但是，如果您仍然想了解更多关于这个的信息，您可以在在线帮助中查找，该帮助是通过 **`check_by_ssh -h`** 调用的。
- en: '* * *'
  id: totrans-1478
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[92](#CHP-9-FN-1)]) In the **`nagios-users`** mailing list it was reported
    that **`Sun_SSH_1.0`** returns a return code of 255 instead of 0, which makes
    it unsuitable for the deployment described here.
  id: totrans-1479
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[92](#CHP-9-FN-1)]) 在 **`nagios-users`** 邮件列表中报告说 **`Sun_SSH_1.0`** 返回代码为
    255 而不是 0，这使得它不适合此处描述的部署。
- en: ^([[93](#CHP-9-FN-2)]) [http://www.openssh.org/](http://www.openssh.org/)
  id: totrans-1480
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[93](#CHP-9-FN-2)]) [http://www.openssh.org/](http://www.openssh.org/)
- en: ^([[94](#CHP-9-FN-3)]) There is currently no long form for this option.
  id: totrans-1481
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[94](#CHP-9-FN-3)]) 目前没有此选项的长格式。
- en: 9.2 Configuring SSH
  id: totrans-1482
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 9.2 配置 SSH
- en: So that Nagios can run plugins over the secure shell remotely and automatically,
    it—or, strictly speaking, the user **`nagios`** on the Nagios server—must not
    be distracted by any password queries. This is avoided with a login via a Public
    Key mechanism.
  id: totrans-1483
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使 Nagios 能够在远程和自动的情况下通过安全外壳运行插件，它——或者更严格地说，Nagios 服务器上的用户 **`nagios`**——不能被任何密码查询所打扰。这通过通过公钥机制进行登录来避免。
- en: 9.2.1 Generating SSH key pairs on the Nagios server
  id: totrans-1484
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 9.2.1 在 Nagios 服务器上生成 SSH 密钥对
- en: 'The key pair required to do this is stored by the key generator **`ssh-keygen`**
    by default in the subdirectory **`.ssh`** of the respective user''s home directory
    (for the user **`nagios`**, this therefore corresponds to the installation guide
    in [1.2 Compiling Source Code](../Text/ch01s02.html "1.2 Compiling Source Code")
    from page 39, that is, **`/usr/local/nagios`**). If it is also sent on its way
    with the **`-f`** **``*`private_keyfile`*``** option (without path specification),
    it will land in the current working directory, which in the following example
    is **`/etc/nagios/.ssh`**:'
  id: totrans-1485
  prefs: []
  type: TYPE_NORMAL
  zh: 执行此操作所需的关键对默认由密钥生成器 **`ssh-keygen`** 存储在相应用户主目录的子目录 **`.ssh`** 中（对于用户 **`nagios`**，这因此对应于第
    39 页的[1.2 编译源代码](../Text/ch01s02.html "1.2 编译源代码")中的安装指南，即 **`/usr/local/nagios`**）。如果它还通过
    **`-f`** **`private_keyfile`** 选项（不指定路径）发送，它将落在当前工作目录中，在下面的例子中是 **`/etc/nagios/.ssh`**：
- en: '[PRE170]'
  id: totrans-1486
  prefs: []
  type: TYPE_PRE
  zh: '[PRE170]'
- en: 'The length of the key here is 1024 bits, and DSA is used to encrypt the keys.
    **`-N'' ''`** ensures that the private key in **`id_dsa`** does not receive separate
    password protection: this option forces an empty password.'
  id: totrans-1487
  prefs: []
  type: TYPE_NORMAL
  zh: 这里密钥的长度是 1024 位，使用 DSA 加密密钥。**`-N' '`** 确保私钥在 **`id_dsa`** 中不接收单独的密码保护：此选项强制使用空密码。
- en: 9.2.2 Setting up the user **`nagios`** on the target host
  id: totrans-1488
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 9.2.2 在目标主机上设置用户 **`nagios`**
- en: 'Similar to the configuration on the Nagios server, the group and the user **`nagios`**
    are also set up on the computer to be monitored:'
  id: totrans-1489
  prefs: []
  type: TYPE_NORMAL
  zh: 与 Nagios 服务器上的配置类似，被监控计算机上的组和用户 **`nagios`** 也被设置：
- en: '[PRE171]'
  id: totrans-1490
  prefs: []
  type: TYPE_PRE
  zh: '[PRE171]'
- en: 'The target computer is given the directory **`/home/nagios`** as the home directory,
    where a subdirectory **`.ssh`** is created. In this the administrator (or another
    user^([[95](#ftn.CHP-9-FN-4)])) saves the public key generated on the Nagios server
    **`/etc/nagios/.ssh/id_dsa.pub`**, in a file called **`authorized_keys`**:'
  id: totrans-1491
  prefs: []
  type: TYPE_NORMAL
  zh: 目标计算机被分配了目录 **`/home/nagios`** 作为主目录，其中创建了一个子目录 **`.ssh`**。在这里，管理员（或另一个用户^([[95](#ftn.CHP-9-FN-4)]))
    将在Nagios服务器上生成的公钥保存在名为 **`authorized_keys`** 的文件中：
- en: '[PRE172]'
  id: totrans-1492
  prefs: []
  type: TYPE_PRE
  zh: '[PRE172]'
- en: 'Now the user **`nagios`** does not require its own password on the target server.
    You just need to make sure that on the target server the **`.ssh`** directory,
    together with **`authorized_keys`**, belongs to the user **`nagios`**:'
  id: totrans-1493
  prefs: []
  type: TYPE_NORMAL
  zh: 现在用户 **`nagios`** 在目标服务器上不需要自己的密码。您只需确保在目标服务器上，**`.ssh`** 目录以及 **`authorized_keys`**
    文件属于用户 **`nagios`**：
- en: '[PRE173]'
  id: totrans-1494
  prefs: []
  type: TYPE_PRE
  zh: '[PRE173]'
- en: 9.2.3 Checking the SSH connection and **`check_by_ssh`**
  id: totrans-1495
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 9.2.3 检查SSH连接和 **`check_by_ssh`**
- en: 'With this configuration you should first check whether the secure shell connection
    is working properly. The test is performed as the user **`nagios`**, since Nagios
    makes use of this during the checks:'
  id: totrans-1496
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此配置，您首先应该检查安全壳连接是否正常工作。测试是以用户 **`nagios`** 的身份进行的，因为Nagios在检查过程中会使用它：
- en: '[PRE174]'
  id: totrans-1497
  prefs: []
  type: TYPE_PRE
  zh: '[PRE174]'
- en: The **`-i`** option explicitly specifies the path to the private key file. If
    the command **`w`** to be run on the target computer does not provide any output
    or if the opposite SSH daemon requests a password, then the login via public key
    is not working. In this case you must first find and eliminate the error before
    you can move on to testing **`check_by_ssh`**.
  id: totrans-1498
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-i`** 选项明确指定了私钥文件的路径。如果要在目标计算机上运行的命令 **`w`** 没有提供任何输出，或者相反的SSH守护进程请求密码，那么通过公钥的登录将不起作用。在这种情况下，您必须首先找到并消除错误，然后才能继续测试
    **`check_by_ssh`**。'
- en: 'In this next step, you run the local plugin on the target computer, with **`check_by_ssh`**,
    which later on is run automatically, from the command line of the Nagios server.
    Make sure that the plugin paths are correct in each case. The path to the private
    key file of the user **`nagios`** on the server is specified with **`-i`**:'
  id: totrans-1499
  prefs: []
  type: TYPE_NORMAL
  zh: 在此下一步中，您在目标计算机上运行本地插件，使用 **`check_by_ssh`**，稍后它将自动从Nagios服务器的命令行运行。确保每种情况下插件路径都是正确的。服务器上用户
    **`nagios`** 的私钥文件路径使用 **`-i`** 指定：
- en: '[PRE175]'
  id: totrans-1500
  prefs: []
  type: TYPE_PRE
  zh: '[PRE175]'
- en: In the example, **`check_by_ssh`** should start the **`/usr/local/nagios/libexec/check_disk`**
    plugin on the target computer with the options **`-w 10% -c 5% -e -m`**. If this
    does not work, then this is first run locally on the target host with the same
    parameter. By doing this you can rule out that the problem lies in the plugin
    command itself and not in the secure shell connection.
  id: totrans-1501
  prefs: []
  type: TYPE_NORMAL
  zh: 在示例中，**`check_by_ssh`** 应该在目标计算机上以选项 **`-w 10% -c 5% -e -m`** 启动 **`/usr/local/nagios/libexec/check_disk`**
    插件。如果这不起作用，那么它首先在目标主机上以相同的参数本地运行。通过这样做，您可以排除问题出在插件命令本身，而不是在安全壳连接上。
- en: '* * *'
  id: totrans-1502
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[95](#CHP-9-FN-4)]) ... but not the user **`nagios`**, because when an account
    is created, **`useradd`** first sets an invalid password here, which we do not
    change into a valid one. This means that you cannot currently log in to the target
    computer as **`nagios`**.
  id: totrans-1503
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[95](#CHP-9-FN-4)]) ... 但不是用户 **`nagios`**，因为当创建账户时，**`useradd`** 首先在这里设置了一个无效密码，我们没有将其更改为有效密码。这意味着您目前无法以
    **`nagios`** 身份登录到目标计算机。
- en: 9.3 Nagios Configuration
  id: totrans-1504
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 9.3 Nagios配置
- en: 'The matching command object is again defined in the file **`checkcommands.cfg`**;
    similar to **`check_local_disk`**, it should be named **`check_ssh_disk`**:'
  id: totrans-1505
  prefs: []
  type: TYPE_NORMAL
  zh: 匹配的命令对象再次在文件 **`checkcommands.cfg`** 中定义；类似于 **`check_local_disk`**，它应该命名为 **`check_ssh_disk`**：
- en: '[PRE176]'
  id: totrans-1506
  prefs: []
  type: TYPE_PRE
  zh: '[PRE176]'
- en: The command line stored in **`command_line`** first runs **`check_by_ssh; $USER1$`**
    contains the local plugin path on the Nagios server. Next come the arguments—the
    IP address of the target host (parameter **`-H`**), the private key file (parameter
    **`-i`**) and finally, with the **`-C`** parameter, the complete command that
    the target host should carry out. If the plugin path on the target host and on
    the Nagios server are identical, then you can also use the **`$USER1$`** macro
    in it; otherwise the plugin path on the target computer is given explicitly.
  id: totrans-1507
  prefs: []
  type: TYPE_NORMAL
  zh: 存储在 **`command_line`** 中的命令行首先运行 **`check_by_ssh; $USER1$`**，其中包含Nagios服务器上的本地插件路径。接下来是参数——目标主机的IP地址（参数
    **`-H`**）、私钥文件（参数 **`-i`**）以及最后，使用 **`-C`** 参数，目标主机应执行的全部命令。如果目标主机和Nagios服务器上的插件路径相同，那么您也可以在其中使用
    **`$USER1$`** 宏；否则，目标计算机上的插件路径将明确给出。
- en: Setting up the command is no different here to the one in **`check_local_disk`**
    in [7.1 Free Hard Drive Capacity](../Text/ch07.html#free_hard_drive_capacity "7.1
    Free Hard Drive Capacity") in page 158\. This means that apart from the warning
    and critical limits, we explicitly specify a file system or a hard drive partition,
    with the **`-p`** parameter.
  id: totrans-1508
  prefs: []
  type: TYPE_NORMAL
  zh: 设置命令与[7.1 硬盘剩余空间](../Text/ch07.html#free_hard_drive_capacity "7.1 硬盘剩余空间")中的**`check_local_disk`**（第158页）中的命令没有不同。这意味着除了警告和临界限制之外，我们明确指定了一个文件系统或硬盘分区，使用**`-p`**参数。
- en: 'The command **`check_ssh_disk`** defined in this way is applied as follows,
    here on a computer called **`linux02`**:'
  id: totrans-1509
  prefs: []
  type: TYPE_NORMAL
  zh: 以这种方式定义的命令**`check_ssh_disk`**如下应用，这里在一个名为**`linux02`**的计算机上：
- en: '[PRE177]'
  id: totrans-1510
  prefs: []
  type: TYPE_PRE
  zh: '[PRE177]'
- en: The service object defined in this way ensures that Nagios checks its **`/`**
    file system. The warning limit lies at 10 percent, the critical limit at 5 percent.
  id: totrans-1511
  prefs: []
  type: TYPE_NORMAL
  zh: 以这种方式定义的服务对象确保Nagios检查其**`/`**文件系统。警告限制在10%，临界限制在5%。
- en: 'If you use the **`check_by_ssh`** plugin with **`check_ssh_disk`**, as in the
    example here, you must make sure that the plugin path is identical on all target
    hosts. This is also worth doing for reasons of simplicity, though it is not always
    possible in practice. The following service definition, for this reason, gives
    the plugin path to the target computer as an additional argument:'
  id: totrans-1512
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用**`check_by_ssh`**插件与**`check_ssh_disk`**一起，如本例所示，你必须确保所有目标主机上的插件路径相同。出于简单起见，这也值得做，尽管在实践中并不总是可能。以下服务定义因此将插件路径作为附加参数提供给目标计算机：
- en: '[PRE178]'
  id: totrans-1513
  prefs: []
  type: TYPE_PRE
  zh: '[PRE178]'
- en: 'In order for this to work, you must change the command line in the command
    definition, passed on with **`-C`**, as follows:'
  id: totrans-1514
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使这成为可能，你必须更改命令定义中的命令行，通过**`-C`**传递，如下所示：
- en: '[PRE179]'
  id: totrans-1515
  prefs: []
  type: TYPE_PRE
  zh: '[PRE179]'
- en: 'Caution: this causes the numbers of each of the **`$ARGx`** macros for **`-w`**,
    **`-c`**, and **`-p`** to be shifted by one.'
  id: totrans-1516
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：这会导致**`$ARGx`**宏的每个**`-w`**、**`-c`**和**`-p`**的数字都向右移动一位。
- en: Chapter 10. The Nagios Remote Plugin Executor (NRPE)
  id: totrans-1517
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第10章. Nagios远程插件执行器（NRPE）
- en: The *Nagios Remote Plugin Executor* (or in short, NRPE) as the name suggests,
    executes programs on a remote host. These are usually plugins that test the corresponding
    computer locally and therefore must be installed on it. The use of NRPE is not
    restricted to local plugins; any plugins at all can be executed, including those
    intended to test network services—for example, to indirectly test computers that
    are not reachable from the Nagios server (as shown in [10.6 Indirect Checks](../Text/ch10s06.html
    "10.6 Indirect Checks") from page 224).
  id: totrans-1518
  prefs: []
  type: TYPE_NORMAL
  zh: 如其名所示，*Nagios远程插件执行器*（或简称NRPE）在远程主机上执行程序。这些通常是本地测试相应计算机的插件，因此必须安装在其上。NRPE的使用不仅限于本地插件；任何插件都可以执行，包括那些旨在测试网络服务的插件——例如，间接测试无法从Nagios服务器访问的计算机（如第224页的[10.6间接检查](../Text/ch10s06.html
    "10.6间接检查")所示）。
- en: 'While a genuine user account must be available on the remote computer when
    the secure shell is used (see [Chapter 9](../Text/ch09.html "Chapter 9. Executing
    Plugins via SSH")), which can also be used to do other things than just start
    plugins, NRPE is restricted exclusively to explicitly configured tests. If you
    want to, or are forced to, do without a login shell on the target host, it is
    better to use NRPE, even if there is somewhat more configuration work involved
    than with the secure shell. In addition to the Nagios configuration and the installation
    of the **`check_nrpe`** plugin on the Nagios server, the following tasks remain
    on the target system:'
  id: totrans-1519
  prefs: []
  type: TYPE_NORMAL
  zh: 当使用安全外壳时，远程计算机上必须有一个真正的用户账户（见[第9章](../Text/ch09.html "第9章. 通过SSH执行插件")），这也可以用来做除了启动插件之外的其他事情，但NRPE仅限于显式配置的测试。如果你愿意或被迫在目标主机上不使用登录外壳，那么使用NRPE会更好，尽管与安全外壳相比，这需要更多的配置工作。除了Nagios配置和在Nagios服务器上安装**`check_nrpe`**插件之外，以下任务仍然在目标系统上：
- en: The program **`nrpe`** must be installed.
  id: totrans-1520
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 必须安装程序**`nrpe`**。
- en: The inet daemon there (**`inetd`** or **`xinetd`**) must be configured with
    administrator privileges.
  id: totrans-1521
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 那里的inet守护进程（**`inetd`**或**`xinetd`**）必须以管理员权限配置。
- en: All the plugins called via NRPE must be installed.
  id: totrans-1522
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 所有通过NRPE调用的插件都必须安装。
- en: 10.1 Installation
  id: totrans-1523
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 10.1 安装
- en: NRPE and the plugins are installed from the sources, or you can fall back on
    the packages provided by the distributor. You should use at least version 2.0
    of NRPE, since this is incompatible with its predecessors. Starting with version
    2.6, NRPE has the switch **`-u`**. If the NRPE service on the target system is
    not reachable, the plugin **`check_nrpe`** on the Nagios server returns an UNKNOWN
    for this switch. Starting with version 2.8, NRPE supports the multi-line output
    of plugins that was introduced with Nagios 3.0 (see [8.5.1 Multiple-line plugin
    output](../Text/ch08s05.html#multiple-line_plugin_output "8.5.1 Multiple-line
    plugin output") from page 193). At the time this book went to press, the current
    version was 2.12, dated 26\. 03\. 2008.
  id: totrans-1524
  prefs: []
  type: TYPE_NORMAL
  zh: NRPE 和插件可以从源代码安装，或者您也可以使用发行商提供的软件包。您应该使用至少 2.0 版本的 NRPE，因为这与它的前辈不兼容。从 2.6 版本开始，NRPE
    具有开关 **`-u`**。如果目标系统上的 NRPE 服务不可达，Nagios 服务器上的插件 **`check_nrpe`** 会为此开关返回一个 UNKNOWN。从
    2.8 版本开始，NRPE 支持与 Nagios 3.0 一起引入的多行插件输出（参见第 193 页的 [8.5.1 多行插件输出](../Text/ch08s05.html#multiple-line_plugin_output
    "8.5.1 多行插件输出")）。在本书付印时，当前版本为 2.12，日期为 2008 年 3 月 26 日。
- en: All established distributions include the plugin collection from at least version
    1.4\. Whether you need the most up-to-date version depends on your expectations
    of the respective plugins.
  id: totrans-1525
  prefs: []
  type: TYPE_NORMAL
  zh: 所有已建立的发行版至少包含从 1.4 版本开始的插件集合。您是否需要最新版本取决于您对相应插件的期望。
- en: 10.1.1 Distribution-specific packages
  id: totrans-1526
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 10.1.1 特定发行版的软件包
- en: SuSE Linux 10.3 includes the packages **`nagios-nrpe-2.10-4.1.i586.rpm, nagios-plugins-1.4.10-12.1.i586.rpm`**,
    and **`nagios-plugins-extras −1.4.10-12.1.i586.rpm.nagios-nrpe`** contains both
    the daemon and the plugin **`check_nrpe. nagios-plugins-extras`** installs several
    additional plugins, such as database checks, FPing test or Radius test, which
    can be omitted, depending on your specific monitoring needs.
  id: totrans-1527
  prefs: []
  type: TYPE_NORMAL
  zh: SuSE Linux 10.3 包含以下软件包：**`nagios-nrpe-2.10-4.1.i586.rpm, nagios-plugins-1.4.10-12.1.i586.rpm`**，以及
    **`nagios-plugins-extras −1.4.10-12.1.i586.rpm.nagios-nrpe`** 包含了守护进程和插件 **`check_nrpe`**，该插件安装了几个额外的插件，例如数据库检查、FPing
    测试或 Radius 测试，这些可以根据您的具体监控需求省略。
- en: For the sake of simplicity, the design packages are installed via YAST2^([[96](#ftn.CHP-10-FN-1)])
    or **`rpm -ihv`** **``*`package`*``**. the second method is also open to Fedora
    users.
  id: totrans-1528
  prefs: []
  type: TYPE_NORMAL
  zh: 为了简化，设计软件包通过 YAST2^([[96](#ftn.CHP-10-FN-1)]) 或 **`rpm -ihv`** **``*`package`*``**
    安装。第二种方法也适用于 Fedora 用户。
- en: For Fedora Core and Red Hat Enterprise Linux, Dag Wieers has made available
    corresponding Nagios packages of several versions.^([[97](#ftn.CHP-10-FN-2)])
  id: totrans-1529
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 Fedora Core 和 Red Hat Enterprise Linux，Dag Wieers 已经提供了几个版本的相应 Nagios 软件包.^([[97](#ftn.CHP-10-FN-2)])
- en: Debian/Sarge distributes the NRPE daemon and the NRPE plugin **`check_nrpe`**
    in two different packages called **`nagios-nrpe-server`** and **`nagios-nrpe-plugin`**,
    which can be installed separately via **`apt-get install`** **``*`package`*``**.
    If you want to do without local documentation, you can omit the package **`nagios-nrpe-doc`**
    and just add the plugin package **`nagios-plugins`** to the target hosts.
  id: totrans-1530
  prefs: []
  type: TYPE_NORMAL
  zh: Debian/Sarge 将 NRPE 守护进程和 NRPE 插件 **`check_nrpe`** 分装在两个不同的软件包中，分别称为 **`nagios-nrpe-server`**
    和 **`nagios-nrpe-plugin`**，可以通过 **`apt-get install`** **``*`package`*``** 独立安装。如果您不想安装本地文档，可以省略软件包
    **`nagios-nrpe-doc`**，只需将插件软件包 **`nagios-plugins`** 添加到目标主机即可。
- en: The paths for the program **`nrpe`**, the configuration file **`nrpe.cfg`**,
    and the plugin directory are listed in [Table 10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "Table 10-1. Installation paths for NRPE and plugins").
  id: totrans-1531
  prefs: []
  type: TYPE_NORMAL
  zh: 程序 **`nrpe`**、配置文件 **`nrpe.cfg`** 和插件目录的路径列在 [表 10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "表 10-1. NRPE 和插件的安装路径") 中。
- en: Table 10-1. Installation paths for NRPE and plugins
  id: totrans-1532
  prefs: []
  type: TYPE_NORMAL
  zh: 表 10-1. NRPE 和插件的安装路径
- en: '| Distribution | NRPE program | Configuration file | Plugins |'
  id: totrans-1533
  prefs: []
  type: TYPE_TB
  zh: '| 发行版 | NRPE 程序 | 配置文件 | 插件 |'
- en: '| --- | --- | --- | --- |'
  id: totrans-1534
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- | --- |'
- en: '| ^([[a](#ftn.CHP-10-TFN-3)]) |'
  id: totrans-1535
  prefs: []
  type: TYPE_TB
  zh: '| ^([[a](#ftn.CHP-10-TFN-3)]) |'
- en: '| ^([[b](#ftn.CHP-10-TFN-4)]) |'
  id: totrans-1536
  prefs: []
  type: TYPE_TB
  zh: '| ^([[b](#ftn.CHP-10-TFN-4)]) |'
- en: '| Self-compiled^([[a](../Text/ch10.html#ftn.CHP-10-TFN-3)]) | **`/usr/local/sbin/nrpe`**
    | **`/etc/nagios/nrpe.cfg`** | **`/usr/local/nagios/libexec`** |'
  id: totrans-1537
  prefs: []
  type: TYPE_TB
  zh: '| 自编译^([[a](../Text/ch10.html#ftn.CHP-10-TFN-3)]) | **`/usr/local/sbin/nrpe`**
    | **`/etc/nagios/nrpe.cfg`** | **`/usr/local/nagios/libexec`** |'
- en: '| SuSE | **`/usr/bin/nrpe`** | **`/etc/nagios/nrpe.cfg`** | **`/usr/lib/nagios/plugins`**
    |'
  id: totrans-1538
  prefs: []
  type: TYPE_TB
  zh: '| SuSE | **`/usr/bin/nrpe`** | **`/etc/nagios/nrpe.cfg`** | **`/usr/lib/nagios/plugins`**
    |'
- en: '| Debian | **`/usr/sbin/nrpe`** | **`/etc/nagios/nrpe.cfg`** | **`/usr/lib/nagios/plugins`**
    |'
  id: totrans-1539
  prefs: []
  type: TYPE_TB
  zh: '| Debian | **`/usr/sbin/nrpe`** | **`/etc/nagios/nrpe.cfg`** | **`/usr/lib/nagios/plugins`**
    |'
- en: '| Fedora^([[b](../Text/ch10.html#ftn.CHP-10-TFN-4)]) | **`/usr/sbin/nrpe`**
    | **`/etc/nagios/nrpe.cfg`** | **`/usr/lib/nagios/plugins`** |'
  id: totrans-1540
  prefs: []
  type: TYPE_TB
  zh: '| Fedora^([[b](../Text/ch10.html#ftn.CHP-10-TFN-4)]) | **`/usr/sbin/nrpe`**
    | **`/etc/nagios/nrpe.cfg`** | **`/usr/lib/nagios/plugins`** |'
- en: '|'
  id: totrans-1541
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: ^([[a](#CHP-10-TFN-3)]) Recommended.
  id: totrans-1542
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[a](#CHP-10-TFN-3)]) 推荐。
- en: ^([[b](#CHP-10-TFN-4)]) From the packages provided by Dag Wieers.
  id: totrans-1543
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[b](#CHP-10-TFN-4)]) 来自Dag Wieers提供的包。
- en: '|'
  id: totrans-1544
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: 10.1.2 Installation from the source code
  id: totrans-1545
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 10.1.2 从源代码安装
- en: The plugins are installed on the computers to be monitored exactly as described
    in [1.4 Installing and Testing Plugins](../Text/ch01s04.html "1.4 Installing and
    Testing Plugins") from page 43 for the Nagios server.
  id: totrans-1546
  prefs: []
  type: TYPE_NORMAL
  zh: 插件按照[1.4 安装和测试插件](../Text/ch01s04.html "1.4 安装和测试插件")中从第43页描述的Nagios服务器上的方式安装在要监控的计算机上。
- en: The NRPE source code is obtained from the Nagios homepage.^([[98](#ftn.CHP-10-FN-5)])
    The directory **`/usr/local/src`**^([[99](#ftn.CHP-10-FN-6)]) is ideal for unloading
    the sources.
  id: totrans-1547
  prefs: []
  type: TYPE_NORMAL
  zh: NRPE源代码可以从Nagios主页获取.^([[98](#ftn.CHP-10-FN-5)]) 目录**`/usr/local/src`**^([[99](#ftn.CHP-10-FN-6)])
    是卸载源代码的理想选择。
- en: '[PRE180]'
  id: totrans-1548
  prefs: []
  type: TYPE_PRE
  zh: '[PRE180]'
- en: 'In the new directory that has been created, you run the **`configure`** command:'
  id: totrans-1549
  prefs: []
  type: TYPE_NORMAL
  zh: 在已创建的新目录中，您运行**`configure`**命令：
- en: '[PRE181]'
  id: totrans-1550
  prefs: []
  type: TYPE_PRE
  zh: '[PRE181]'
- en: The recommended path specifications are listed in [Table 10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "Table 10-1. Installation paths for NRPE and plugins"). The only difference from
    the default settings are for the directory in which the NRPE configuration file
    is stored (**`configure`** option **`--sysconfdir`**).
  id: totrans-1551
  prefs: []
  type: TYPE_NORMAL
  zh: 推荐的路径规范列在[表10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins "表10-1.
    NRPE和插件的安装路径")中。与默认设置唯一不同的是NRPE配置文件存储的目录（**`configure`**选项**`--sysconfdir`**）。
- en: Accordingly, we can leave out the entry for **`--with-nrpe-user`** and **`--with-nrpe-group`**
    in the **`configure`** command. Both options are relevant only if the **`nrpe`**
    program is running as a daemon, and they can be overwritten in the configuration
    file. If the inet daemon is used, you should specify the user with whose permissions
    **`nrpe`** should start in the configuration file for the inet daemon.
  id: totrans-1552
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们可以在**`configure`**命令中省略**`--with-nrpe-user`**和**`--with-nrpe-group`**的条目。这两个选项仅在**`nrpe`**程序作为守护进程运行时相关，并且可以在配置文件中覆盖。如果使用inet守护进程，您应该在inet守护进程的配置文件中指定**`nrpe`**应该以何种权限启动的用户。
- en: '**`--enable-ssl`** ensures that NRPE communicates over an SSL-encrypted channel.
    This will only work, of course, if both **`nrpe`** on the target host and **`check_nrpe`**
    on the Nagios server have both been compiled accordingly.'
  id: totrans-1553
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--enable-ssl`** 确保NRPE通过SSL加密通道进行通信。当然，这只有在目标主机上的**`nrpe`**和Nagios服务器上的**`check_nrpe`**都相应编译的情况下才能工作。'
- en: 'The command **`make all`** compiles the programs **`nrpe`** and **`check_nrpe`**,
    but it does *not* copy them from **`/usr/local/src/nrpe-2.11/src`** to the corresponding
    system directories. Since there is no **`make install`**, you must do this yourself,
    following the details in [Table 10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "Table 10-1. Installation paths for NRPE and plugins"): you need to have **`nrpe`**
    on the computer to be monitored and the **`check_nrpe`** plugin on the Nagios
    server.'
  id: totrans-1554
  prefs: []
  type: TYPE_NORMAL
  zh: 命令**`make all`**编译程序**`nrpe`**和**`check_nrpe`**，但它**不会**将它们从**`/usr/local/src/nrpe-2.11/src`**复制到相应的系统目录中。由于没有**`make
    install`**，您必须自己完成此操作，具体细节请参考[表10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "表10-1. NRPE和插件的安装路径")：您需要在要监控的计算机上安装**`nrpe`**，并在Nagios服务器上安装**`check_nrpe`**插件。
- en: If the Nagios server and the target host used the same platform, you can compile
    both programs on one computer (e.g., the server) and then copy **`nrpe`** together
    with its configuration file to the computer to be monitored, instead of separately
    compiling **`check_nrpe`** on the Nagios server and **`nrpe`** on the target system.
  id: totrans-1555
  prefs: []
  type: TYPE_NORMAL
  zh: 如果Nagios服务器和目标主机使用相同的平台，您可以在一台计算机（例如服务器）上编译这两个程序，然后将**`nrpe`**及其配置文件复制到要监控的计算机上，而不是在Nagios服务器上单独编译**`check_nrpe`**，在目标系统上单独编译**`nrpe`**。
- en: '* * *'
  id: totrans-1556
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[96](#CHP-10-FN-1)]) On the command line, using **`yast -i`** **``*`package`*``**.
  id: totrans-1557
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[96](#CHP-10-FN-1)]) 在命令行上，使用**`yast -i`** **``*`package`*``**。
- en: ^([[97](#CHP-10-FN-2)]) [http://dag.wieers.com/](http://dag.wieers.com/)
  id: totrans-1558
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[97](#CHP-10-FN-2)]) [http://dag.wieers.com/](http://dag.wieers.com/)
- en: ^([[98](#CHP-10-FN-5)]) [http://www.nagios.org/download/](http://www.nagios.org/download/)
  id: totrans-1559
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[98](#CHP-10-FN-5)]) [http://www.nagios.org/download/](http://www.nagios.org/download/)
- en: ^([[99](#CHP-10-FN-6)]) The subdirectory **`src`** may need to be created first.
  id: totrans-1560
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[99](#CHP-10-FN-6)]) 可能需要首先创建子目录**`src`**。
- en: 10.2 Starting via the inet Daemon
  id: totrans-1561
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 10.2 通过inet守护进程启动
- en: It is best to start the program **`nrpe`** on the machine to be monitored via
    the inet daemon rather than as a separate daemon, since the Nagios server only
    performs the tests occasionally, and **`nrpe`** does not need to load any large
    resources.
  id: totrans-1562
  prefs: []
  type: TYPE_NORMAL
  zh: 最好通过 inet 守护进程在要监控的机器上启动程序 **`nrpe`**，而不是作为单独的守护进程，因为 Nagios 服务器只是偶尔执行测试，而 **`nrpe`**
    不需要加载任何大型资源。
- en: 'If you have a choice, you should use the more modern **`xinetd`**. But to keep
    work to a minimum, the inet daemon will normally be used, as it is already running
    on the target system. In order that NRPE can be started as a service via **`inetd`**
    or **`xinetd`**, the **`nrpe`** service is defined in the file **`/etc/services`**:'
  id: totrans-1563
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你有选择，你应该使用更现代的 **`xinetd`**。但为了将工作减少到最低限度，通常将使用 inet 守护进程，因为它已经在目标系统上运行。为了使
    NRPE 可以通过 **`inetd`** 或 **`xinetd`** 作为服务启动，**`nrpe`** 服务在文件 **`/etc/services`**
    中定义：
- en: '[PRE182]'
  id: totrans-1564
  prefs: []
  type: TYPE_PRE
  zh: '[PRE182]'
- en: Even if this has been installed as a package, you should still check to see
    whether this entry exists. By default, NRPE uses TCP port 5666.
  id: totrans-1565
  prefs: []
  type: TYPE_NORMAL
  zh: 即使这是作为软件包安装的，你也应该检查此条目是否存在。默认情况下，NRPE 使用 TCP 端口 5666。
- en: 10.2.1 **`xinetd`** configuration
  id: totrans-1566
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 10.2.1 **`xinetd`** 配置
- en: 'If **`xinetd`** is used, a separate file is stored in the directory **`/etc/xinetd.d`**.
    for each service to be started, so for **`nrpe`** it is best to create a file
    called **`nrpe`** or **`nagios-nrpe`**:'
  id: totrans-1567
  prefs: []
  type: TYPE_NORMAL
  zh: 如果使用 **`xinetd`**，则每个要启动的服务都会在目录 **`/etc/xinetd.d`** 中存储一个单独的文件。对于 **`nrpe`**，最好创建一个名为
    **`nrpe`** 或 **`nagios-nrpe`** 的文件：
- en: '[PRE183]'
  id: totrans-1568
  prefs: []
  type: TYPE_PRE
  zh: '[PRE183]'
- en: The values printed in italics are passed on to your own environment; instead
    of the placeholder **``*`ip_of_the_nagios_server`*``** you should enter, for example
    for **`only_from`**, the IP address of your own Nagios server. The NRPE access
    from outside is then restricted to this computer and to **`local-host`** (**`127.0.0.1`**).
    The latter address allows local tests; multiple IP addresses are separated by
    a space. However, this restrictive configuration functions only if **`xinetd`**
    has been compiled with support for the TCP wrapper (this is normally the case).
  id: totrans-1569
  prefs: []
  type: TYPE_NORMAL
  zh: 以斜体打印的值会传递到你的环境中；对于 **`only_from`**，例如，你应该输入你的 Nagios 服务器的 IP 地址，而不是占位符 **``*`ip_of_the_nagios_server`*``**。NRPE
    从外部访问将仅限于这台计算机和 **`local-host`** （**`127.0.0.1`**）。后者地址允许本地测试；多个 IP 地址由空格分隔。然而，此限制性配置仅在
    **`xinetd`** 编译了 TCP 包装器支持的情况下才有效。
- en: Under no circumstances should NRPE run with the permissions of a privileged
    user—**`nobody`** is therefore a sensible value. The **`server`** parameter specifies
    the complete path to the program **`nrpe;`** for **`server_args`** you should
    enter the matching path to the configuration file. After this modification, the
    configuration of **`xinetd`** is reloaded, with
  id: totrans-1570
  prefs: []
  type: TYPE_NORMAL
  zh: 在任何情况下都不应该使用具有特权的用户权限运行 NRPE——因此 **`nobody`** 是一个合理的值。**`server`** 参数指定了程序 **`nrpe;`**
    的完整路径，对于 **`server_args`**，你应该输入配置文件的匹配路径。在此修改后，重新加载 **`xinetd`** 的配置，使用
- en: '[PRE184]'
  id: totrans-1571
  prefs: []
  type: TYPE_PRE
  zh: '[PRE184]'
- en: 10.2.2 **`inetd`** configurationt
  id: totrans-1572
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 10.2.2 **`inetd`** 配置
- en: 'In the standard **`inetd`**, the following line is added to the configuration
    file **`/etc/inetd.conf`**:'
  id: totrans-1573
  prefs: []
  type: TYPE_NORMAL
  zh: 在标准的 **`inetd`** 中，以下行被添加到配置文件 **`/etc/inetd.conf`** 中：
- en: '[PRE185]'
  id: totrans-1574
  prefs: []
  type: TYPE_PRE
  zh: '[PRE185]'
- en: 'The line has been split up for reasons of space, but in the configuration file
    this must all be in a single line. Here the TCP wrapper **`tcpd`** is used. If
    this is not intended, you simply leave out this entry^([[100](#ftn.CHP-10-FN-7)])
    Here you should also explicitly enter the user **`nobody`**, the complete path
    to the binary **`nrpe`**, and the configuration file, also with its complete path.
    These strings, printed above in italics, should be adjusted to your own system,
    where necessary. After the configuration change, **`inetd`** is reloaded:'
  id: totrans-1575
  prefs: []
  type: TYPE_NORMAL
  zh: 这一行被拆分是为了空间原因，但在配置文件中，所有这些必须在单行中。这里使用 TCP 包装器 **`tcpd`**。如果不打算使用它，只需省略此条目^([[100](#ftn.CHP-10-FN-7)])。在这里，你还应该明确输入用户
    **`nobody`**、二进制文件的完整路径 **`nrpe`** 和配置文件，以及其完整路径。上述斜体打印的字符串应根据你的系统进行必要的调整。配置更改后，重新加载
    **`inetd`**：
- en: '[PRE186]'
  id: totrans-1576
  prefs: []
  type: TYPE_PRE
  zh: '[PRE186]'
- en: 10.2.3 Is the Inet daemon watching on the NRPE port?
  id: totrans-1577
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 10.2.3 Inet 守护进程是否正在监视 NRPE 端口？
- en: 'A simple test shows whether the inet daemon wants to respond to queries on
    port 5666:'
  id: totrans-1578
  prefs: []
  type: TYPE_NORMAL
  zh: 一个简单的测试可以显示 inet 守护进程是否想要在端口 5666 上响应查询：
- en: '[PRE187]'
  id: totrans-1579
  prefs: []
  type: TYPE_PRE
  zh: '[PRE187]'
- en: The program **`netstat`** uses option **`−1`** to display all the ports on which
    a service is waiting for incoming queries, that is, a service which is in the
    **`LISTEN`** state. Option **`-n`** suppresses the name resolution of hosts and
    ports and speeds up the display of information, and **`-t`** restricts the otput
    to TCP ports.
  id: totrans-1580
  prefs: []
  type: TYPE_NORMAL
  zh: 程序 **`netstat`** 使用选项 **`−1`** 显示服务等待接收查询的所有端口，即处于 **`LISTEN`** 状态的服务。选项 **`-n`**
    抑制主机和端口的名称解析，并加快信息显示速度，而 **`-t`** 限制输出为 TCP 端口。
- en: The test shows only whether the inet daemon was properly configured and newly
    started, for instance, whether the **`nrpe`** service is correctly entered in
    **`/etc/services`**. It does not clarify whether the paths to the NRPE daemon
    and its configuration file are correct. Errors like this are announced by the
    inet daemon only when a concrete access attempt takes place on NRPE port 5666\.
    The subsequent complete function test is carried out only after the NRPE daemon
    has been configured. This is described in [10.4 NRPE Function Test](../Text/ch10s04.html
    "10.4 NRPE Function Test") from page 221.
  id: totrans-1581
  prefs: []
  type: TYPE_NORMAL
  zh: 测试仅显示 inet 守护进程是否正确配置并已重新启动，例如，是否在 **`/etc/services`** 中正确地输入了 **`nrpe`** 服务。它不明确指出
    NRPE 守护进程及其配置文件的路径是否正确。这种错误仅在具体尝试访问 NRPE 端口 5666 时由 inet 守护进程宣布。只有在 NRPE 守护进程配置完成后，才会进行后续的完整功能测试。这在本节的
    [10.4 NRPE 功能测试](../Text/ch10s04.html "10.4 NRPE 功能测试") 页 221 中描述。
- en: '* * *'
  id: totrans-1582
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[100](#CHP-10-FN-7)]) **`inetd`** does not have a built-in method to allow
    access to services only from specific IP addresses. This function is added in
    the TCP wrapper **`tcpd`**. The access configuration is then taken over by the
    files **`/etc/hosts.allow`** and **`/etc/hosts.deny`**. More information on this
    is given by **`man host_access`**.
  id: totrans-1583
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[100](#CHP-10-FN-7)]) **`inetd`** 没有内置方法仅允许来自特定 IP 地址的服务访问。此功能是在 TCP 包装器
    **`tcpd`** 中添加的。然后，访问配置由文件 **`/etc/hosts.allow`** 和 **`/etc/hosts.deny`** 担任。关于此的更多信息，请参阅
    **`man host_access`**。
- en: 10.3 NRPE Configuration on the Computer to Be Monitored
  id: totrans-1584
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 10.3 监控计算机上的 NRPE 配置
- en: 'When compiling NRPE, the file **`nrpe.cfg`** is created in the source directory,
    which contains several parameters as well as the commands to run NRPE. These are
    copied manually to the configuration directory, which normally first has to be
    created on the target computer:'
  id: totrans-1585
  prefs: []
  type: TYPE_NORMAL
  zh: 在编译 NRPE 时，源目录中会创建 **`nrpe.cfg`** 文件，其中包含几个参数以及运行 NRPE 的命令。这些命令需要手动复制到配置目录，通常首先需要在目标计算机上创建该目录：
- en: '[PRE188]'
  id: totrans-1586
  prefs: []
  type: TYPE_PRE
  zh: '[PRE188]'
- en: Distribution-specific packages are unpacked from the location specified in [Table 10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "Table 10-1. Installation paths for NRPE and plugins") in page 215.
  id: totrans-1587
  prefs: []
  type: TYPE_NORMAL
  zh: 特定于发行版的软件包从第 215 页 [表 10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "表 10-1. NRPE 和插件安装路径") 中指定的位置解包。
- en: '**`nrpe`** is given the permissions of the user at runtime specified in the
    inet daemon configuration, which in our case is that of **`nobody`**. Therefore
    **`nrpe.cfg`** needs to be readable for this user. As long as the file does not
    contain any passwords (these really should not be used) or other critical information,
    then read permissions for all can be allowed.'
  id: totrans-1588
  prefs: []
  type: TYPE_NORMAL
  zh: '**`nrpe`** 在运行时被赋予 inet 守护进程配置中指定的用户权限，在我们的例子中是 **`nobody`**。因此，**`nrpe.cfg`**
    需要对该用户可读。只要文件不包含任何密码（这些实际上不应该使用）或其他关键信息，则可以允许所有用户读取权限。'
- en: The configuration file contains many comments; the following command displays
    the active parameters:^([[101](#ftn.CHP-10-FN-8)])
  id: totrans-1589
  prefs: []
  type: TYPE_NORMAL
  zh: 配置文件包含许多注释；以下命令显示活动参数：^([[101](#ftn.CHP-10-FN-8)])
- en: '[PRE189]'
  id: totrans-1590
  prefs: []
  type: TYPE_PRE
  zh: '[PRE189]'
- en: The parameters **`server_port`**, **`allowed_hosts`**, **`nrpe_user`**, and
    **`nrpe_group`** are only relevant if **`nrpe`** is working as a daemon. When
    the inet daemon is used, the program ignores these values since they have already
    been determined by the **`(x) indetd`** configuration.
  id: totrans-1591
  prefs: []
  type: TYPE_NORMAL
  zh: 参数 **`server_port`**、**`allowed_hosts`**、**`nrpe_user`** 和 **`nrpe_group`**
    仅在 **`nrpe`** 作为守护进程运行时相关。当使用 inet 守护进程时，程序会忽略这些值，因为它们已经被 **`(x) indetd`** 配置确定。
- en: The entry **`dont_blame_nrpe=0`** prevents **`nrpe`** from accepting parameters,
    thus closing a potential security hole. **`debug=l`** allows extensive logging,
    useful if you are looking for errors (**`debug=0`** switches off the output for
    debugging information), and **`command_timeout`** specifies a timespan in seconds
    after which **`nrpe`** abruptly interrupts a plugin that has hung. Comments in
    the configuration file explain all these parameters as well.
  id: totrans-1592
  prefs: []
  type: TYPE_NORMAL
  zh: 条目**`dont_blame_nrpe=0`**阻止**`nrpe`**接受参数，从而关闭了一个潜在的安全漏洞。**`debug=l`**允许详细的日志记录，这在查找错误时很有用（**`debug=0`**关闭调试信息的输出），而**`command_timeout`**指定了秒数，在此之后**`nrpe`**会突然中断挂起的插件。配置文件中的注释解释了所有这些参数。
- en: After this, the commands are defined that are to be executed by NRPE. The configuration
    file **`nrpe.cfg`** already contains some, but first they all have to be commented
    out, and only those commands activated that really are intended for use.
  id: totrans-1593
  prefs: []
  type: TYPE_NORMAL
  zh: 在此之后，定义了将被NRPE执行的命令。配置文件**`nrpe.cfg`**已经包含了一些，但首先它们都必须被注释掉，并且只有那些真正打算使用的命令被激活。
- en: The keyword **`command`** is followed in square brackets by the name with which
    **`check_nrpe`** should call the command. After the equals sign (=), the corresponding
    plugin command is specified, with its complete path:^([[102](#ftn.CHP-10-FN-9)])
  id: totrans-1594
  prefs: []
  type: TYPE_NORMAL
  zh: 关键字**`command`**后面跟着方括号中的名称，这是**`check_nrpe`**应该调用的命令的名称。在等号（=）之后，指定相应的插件命令，包括其完整路径:^([[102](#ftn.CHP-10-FN-9)])
- en: '[PRE190]'
  id: totrans-1595
  prefs: []
  type: TYPE_PRE
  zh: '[PRE190]'
- en: With the path, care must be taken that this really does point to the local plugin
    directory. In the directory specified here, **`/usr/local/nagios/libexec`**, the
    self-compiled plugins are located^([[103](#ftn.CHP-10-FN-10)]); and for installations
    from distribution packages the path is usually **`/usr/lib/nagios/plugins`**.
  id: totrans-1596
  prefs: []
  type: TYPE_NORMAL
  zh: 在路径方面，必须注意这确实指向了本地插件目录。在这里指定的目录中，**`/usr/local/nagios/libexec`**，自编译的插件位于^([[103](#ftn.CHP-10-FN-10)]）；而对于来自发行版包的安装，路径通常是**`/usr/lib/nagios/plugins`**。
- en: 'From the Nagios server, the command just defined, **`check_users`** is now
    run on the *target computer* via **`check_nrpe`**:'
  id: totrans-1597
  prefs: []
  type: TYPE_NORMAL
  zh: 从Nagios服务器，现在通过**`check_nrpe`**在**目标计算机**上运行刚刚定义的命令**`check_users`**：
- en: '[PRE191]'
  id: totrans-1598
  prefs: []
  type: TYPE_PRE
  zh: '[PRE191]'
- en: 10.3.1 Passing parameters on to local plugins
  id: totrans-1599
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 10.3.1 将参数传递给本地插件
- en: 'The method described so far has one disadvantage: for each test on the target
    system, a separately defined command is required for this. Here is the example
    of a server on which the plugin **`check_disk`** (see [7.1 Free Hard Drive Capacity](../Text/ch07.html#free_hard_drive_capacity
    "7.1 Free Hard Drive Capacity") from page 158) is required to monitor nine file
    systems:'
  id: totrans-1600
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止描述的方法有一个缺点：对于目标系统上的每个测试，都需要一个单独定义的命令。以下是一个需要监控九个文件系统的服务器的示例，其中插件**`check_disk`**（参见第158页的[7.1
    硬盘剩余空间](../Text/ch07.html#free_hard_drive_capacity "7.1 硬盘剩余空间")）是必需的：
- en: '[PRE192]'
  id: totrans-1601
  prefs: []
  type: TYPE_PRE
  zh: '[PRE192]'
- en: 'To avoid all this work, NRPE can also be configured so that parameters may
    be passed on to **`check_nrpe`**:'
  id: totrans-1602
  prefs: []
  type: TYPE_NORMAL
  zh: 为了避免所有这些工作，NRPE也可以配置为将参数传递给**`check_nrpe`**：
- en: '[PRE193]'
  id: totrans-1603
  prefs: []
  type: TYPE_PRE
  zh: '[PRE193]'
- en: In order for this to work, the NRPE **`configure`** script must be run with
    the option
  id: totrans-1604
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使这生效，必须使用带有选项的NRPE **`configure`** 脚本运行：
- en: '**`--enable-command-args`**. The reason for this inconvenient procedure is
    that passing parameters on is a fundamental risk, since it cannot be ruled out
    that a certain choice of parameters could cause an (as yet unknown) buffer overflow,
    allowing the target system to be penetrated.'
  id: totrans-1605
  prefs: []
  type: TYPE_NORMAL
  zh: '**`--enable-command-args`**。这种不便的程序的原因是传递参数是一个基本的风险，因为不能排除某些参数选择可能导致（尚未知）的缓冲区溢出，从而允许目标系统被渗透。'
- en: If you still decide on this, despite all the security risks, you should use
    a TCP wrapper (see [10.2.2 inetd configurationt](../Text/ch10s02.html#inetd_configurationt
    "10.2.2 inetd configurationt"), page 217), to ensure that only the Nagios server
    itself is allowed to send commands to NRPE.
  id: totrans-1606
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管存在所有安全风险，如果你仍然决定这样做，应该使用TCP包装器（参见[10.2.2 inetd配置](../Text/ch10s02.html#inetd_configurationt
    "10.2.2 inetd配置")，第217页），以确保只有Nagios服务器本身被允许向NRPE发送命令。
- en: 'If the plugin provides the corresponding options, there is sometimes a third
    method, however: the above-mentioned problem can also be solved by getting **`check_disk`**,
    if necessary, to test all file systems with one single command:'
  id: totrans-1607
  prefs: []
  type: TYPE_NORMAL
  zh: 如果插件提供了相应的选项，有时还有第三种方法：上述问题也可以通过获取**`check_disk`**来解决，如果需要，可以使用一个单独的命令测试所有文件系统：
- en: '[PRE194]'
  id: totrans-1608
  prefs: []
  type: TYPE_PRE
  zh: '[PRE194]'
- en: 'The **`-e`** parameter persuades the plugin to display only those file systems
    that produced a warning or an error. One restriction remains: the warning and
    critical limits are, by necessity, the same for all file systems.'
  id: totrans-1609
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-e`**参数说服插件只显示那些产生警告或错误的文件系统。一个限制仍然存在：警告和临界限制对于所有文件系统来说，必然是相同的。'
- en: '* * *'
  id: totrans-1610
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[101](#CHP-10-FN-8)]) The regular expression **`^#|^$`** matches all lines
    that either begin with a comment sign **`#`** or that consist of an empty line.
    The option **`-v`** ensures that **`egrep`** shows all lines that are *not* matched
    by this.
  id: totrans-1611
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[101](#CHP-10-FN-8)]) 正则表达式**`^#|^$`**匹配所有以注释符号**`#`**开头或由空行组成的行。选项**`-v`**确保**`egrep`**显示所有不匹配这些行的行。
- en: ^([[102](#CHP-10-FN-9)]) The **`check_users`** command is explained in [7.6
    Keeping Tabs on the Number of Logged-In Users](../Text/ch07s06.html "7.6 Keeping
    Tabs on the Number of Logged-In Users") from page 177, **`check_load`** is explained
    in [7.3 Testing the System Load](../Text/ch07s03.html "7.3 Testing the System
    Load") from page 162, and [7.4 Monitoring Processes](../Text/ch07s04.html "7.4
    Monitoring Processes") from page 163 deals with **`check_procs`**.
  id: totrans-1612
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[102](#CHP-10-FN-9)]) **`check_users`**命令在[7.6 监控登录用户数量](../Text/ch07s06.html
    "7.6 监控登录用户数量")的第177页进行了解释，**`check_load`**在[7.3 测试系统负载](../Text/ch07s03.html
    "7.3 测试系统负载")的第162页进行了解释，而[7.4 监控进程](../Text/ch07s04.html "7.4 监控进程")的第163页涉及**`check_procs`**。
- en: ^([[103](#CHP-10-FN-10)]) ... provided you have followed the instructions in
    the book.
  id: totrans-1613
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[103](#CHP-10-FN-10)]) ...前提是你已经遵循了书中的说明。
- en: 10.4 NRPE Function Test
  id: totrans-1614
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 10.4 NRPE功能测试
- en: 'For a concluding function test, the plugin **`check_nrpe`** on the Nagios server
    is called. The command **`-H`** **``*`target`*``** **`host`** returns the IP address
    specified for the server on which the NRPE service has just been installed:'
  id: totrans-1615
  prefs: []
  type: TYPE_NORMAL
  zh: 为了进行一个总结性的功能测试，Nagios服务器上的插件**`check_nrpe`**被调用。命令**`-H`** **``*`目标`*``** **`主机`**返回刚刚安装NRPE服务的服务器上指定的IP地址：
- en: '[PRE195]'
  id: totrans-1616
  prefs: []
  type: TYPE_PRE
  zh: '[PRE195]'
- en: The error message given here occurs very frequently and causes confusion almost
    as often because although problems may occur with the SSL handshake, the cause
    is to be found elsewhere in most cases. You only have an SSL problem if the SSL
    versions used by the plugin **`check_nrpe`** and the **`NRPE daemon`** addressed
    are incompatible or if one of the two software packages was compiled without SSL
    and the other was compiled with SSL.
  id: totrans-1617
  prefs: []
  type: TYPE_NORMAL
  zh: 这里给出的错误信息非常频繁地发生，并且几乎同样频繁地引起混淆，因为尽管SSL握手可能会出现问题，但在大多数情况下，原因在其他地方。只有当插件**`check_nrpe`**和所指向的**`NRPE守护进程`**使用的SSL版本不兼容，或者两个软件包中有一个没有使用SSL编译，而另一个使用了SSL时，你才有一个SSL问题。
- en: 'Otherwise, the cause will lie elsewhere: The problem could be caused by an
    error in the configuration file, the inet daemon being unable to find the NRPE
    program or configuration file, or access permissions for the file **`nrpe.cfg`**
    that are not sufficient. You would also receive the error message mentioned if
    the Nagios server cannot access the NRPE service at all via the inetd configuration.
    In this case, you need to check the parameter **`only_from`** for **`xinetd`**
    or the same restrictions via the **`tcpd`** for **`inetd`**.'
  id: totrans-1618
  prefs: []
  type: TYPE_NORMAL
  zh: 否则，原因将在于其他地方：问题可能是由于配置文件中的错误引起的，或者inet守护进程无法找到NRPE程序或配置文件，或者文件**`nrpe.cfg`**的访问权限不足。如果Nagios服务器无法通过inetd配置访问NRPE服务，你也会收到提到的错误信息。在这种情况下，你需要检查**`xinetd`**的**`only_from`**参数或通过**`tcpd`**为**`inetd`**设置的相同限制。
- en: 'You can search for the exact cause of error in the syslog files, particularly
    in the file **`messages`**, and depending on the distribution, also in **`warn.log`**,
    **`daemon.log`**, or another log file:'
  id: totrans-1619
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在syslog文件中查找错误的精确原因，特别是文件**`messages`**，根据发行版的不同，也可能在**`warn.log`**、**`daemon.log`**或另一个日志文件中：
- en: '[PRE196]'
  id: totrans-1620
  prefs: []
  type: TYPE_PRE
  zh: '[PRE196]'
- en: In this example, the file **`nrpe.cfg`** is either not in the path being searched
    or **`nrpe`** cannot open it. Since **`nrpe`** is running with the permissions
    of the user **`nobody`**, it must also be able to read the configuration file.
  id: totrans-1621
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，文件**`nrpe.cfg`**要么不在搜索的路径中，要么**`nrpe`**无法打开它。由于**`nrpe`**以**`nobody`**用户的权限运行，它也必须能够读取配置文件。
- en: 'A successful call of **`check_nrpe`** will then provide the version of the
    installed NRPE service:'
  id: totrans-1622
  prefs: []
  type: TYPE_NORMAL
  zh: 然后一个成功的**`check_nrpe`**调用将提供已安装NRPE服务的版本：
- en: '[PRE197]'
  id: totrans-1623
  prefs: []
  type: TYPE_PRE
  zh: '[PRE197]'
- en: 10.5 Nagios Configuration
  id: totrans-1624
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 10.5 Nagios配置
- en: Commands that "trigger" local plugins on remote computers via **`check_nrpe`**
    are defined as before in the file **`checkcommands.cfg`** on the Nagios server.
  id: totrans-1625
  prefs: []
  type: TYPE_NORMAL
  zh: 通过 **`check_nrpe`** 在远程计算机上“触发”本地插件的命令，在 Nagios 服务器上的 **`checkcommands.cfg`**
    文件中定义为之前所述。
- en: 10.5.1 NRPE without passing parameters on
  id: totrans-1626
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 10.5.1 不传递参数的 NRPE
- en: 'If no parameters are passed on to the target plugin, things will look like
    this:'
  id: totrans-1627
  prefs: []
  type: TYPE_NORMAL
  zh: 如果没有将参数传递给目标插件，情况将如下所示：
- en: '[PRE198]'
  id: totrans-1628
  prefs: []
  type: TYPE_PRE
  zh: '[PRE198]'
- en: As the only argument, Nagios passes the command here that NRPE is to execute.
    If the **`check_nrpe`** plugin on the Nagios server is located in a different
    directory to the other plugins, you must enter the correct path instead of **`$USER1$`**.
  id: totrans-1629
  prefs: []
  type: TYPE_NORMAL
  zh: 作为唯一的参数，Nagios 在这里传递给 NRPE 执行的命令。如果 Nagios 服务器上的 **`check_nrpe`** 插件位于与其他插件不同的目录中，你必须输入正确的路径而不是
    **`$USER1$`**。
- en: 'A service to be tested via NRPE uses the command just defined, **`check_nrpe`**,
    as **`check_command`**. As an argument, the command is specified that was defined
    in **`nrpe.cfg`** on the target system (here: **`linux04`**):'
  id: totrans-1630
  prefs: []
  type: TYPE_NORMAL
  zh: 要通过 NRPE 测试的服务使用刚刚定义的命令 **`check_nrpe`** 作为 **`check_command`**。作为参数，指定了在目标系统（此处：**`linux04`**）上的
    **`nrpe.cfg`** 中定义的命令：
- en: '[PRE199]'
  id: totrans-1631
  prefs: []
  type: TYPE_PRE
  zh: '[PRE199]'
- en: 10.5.2 Passing parameters on in NRPE
  id: totrans-1632
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 10.5.2 NRPE 中的参数传递
- en: In order to address the command defined in [10.3.1 Passing parameters on to
    local plugins](../Text/ch10s03.html#passing_parameters_on_to_local_plugins "10.3.1
    Passing parameters on to local plugins") in page 220
  id: totrans-1633
  prefs: []
  type: TYPE_NORMAL
  zh: 为了解决第 220 页 [10.3.1 将参数传递给本地插件](../Text/ch10s03.html#passing_parameters_on_to_local_plugins
    "10.3.1 将参数传递给本地插件") 中定义的命令
- en: '[PRE200]'
  id: totrans-1634
  prefs: []
  type: TYPE_PRE
  zh: '[PRE200]'
- en: 'from the Nagios server, the **`check_nrpe`** is given the corresponding arguments
    through the option **`-a`**:'
  id: totrans-1635
  prefs: []
  type: TYPE_NORMAL
  zh: 从 Nagios 服务器，通过选项 **`-a`** 将相应的参数传递给 **`check_nrpe`**：
- en: '[PRE201]'
  id: totrans-1636
  prefs: []
  type: TYPE_PRE
  zh: '[PRE201]'
- en: 'So that **`$ARG2$`** can correctly transport the parameters for the remote
    plugin, these are separated by spaces in the service definition. in addition,
    you should ensure that the order is correct:'
  id: totrans-1637
  prefs: []
  type: TYPE_NORMAL
  zh: 以便 **`$ARG2$`** 可以正确地传输远程插件的参数，这些参数在服务定义中以空格分隔。此外，你应该确保顺序正确：
- en: '[PRE202]'
  id: totrans-1638
  prefs: []
  type: TYPE_PRE
  zh: '[PRE202]'
- en: The locally installed **`check_disk`** on **`linux04`** distributes the three
    strings **`10%, 5%`**, and /var to its own three macros **`$ARG1$`**, **`$ARG2$`**,
    and **`$ARG3$`** for the command defined in **`nrpe.cfg`**.
  id: totrans-1639
  prefs: []
  type: TYPE_NORMAL
  zh: 本地安装在 **`linux04`** 上的 **`check_disk`** 将三个字符串 **`10%，5%`** 和 /var 分配给其自己的三个宏
    **`$ARG1$`**、**`$ARG2$`** 和 **`$ARG3$**，用于 **`nrpe.cfg`** 中定义的命令。
- en: 10.5.3 Optimizing the configuration
  id: totrans-1640
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 10.5.3 优化配置
- en: 'If the NRPE commands are given identical names on all target systems, then
    all NRPE commands with the same name can be included in a single service definition.
    When doing this you can make use of the possibility of specifying several hosts,
    or even an entire group of hosts:'
  id: totrans-1641
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在所有目标系统上给 NRPE 命令相同的名称，则可以将具有相同名称的所有 NRPE 命令包含在单个服务定义中。在这种情况下，你可以利用指定多个主机或甚至整个主机组的可能性：
- en: '[PRE203]'
  id: totrans-1642
  prefs: []
  type: TYPE_PRE
  zh: '[PRE203]'
- en: 'With the command **`check_disk_var`**, defined at the beginning of [10.3.1
    Passing parameters on to local plugins](../Text/ch10s03.html#passing_parameters_on_to_local_plugins
    "10.3.1 Passing parameters on to local plugins") in page 220, Nagios now checks
    the **`/var`** file systems on the computers **`linux04`**, **`linux02`**, and
    **`linux11`**. If other file systems are to be included in the test, a separate
    service is created for each one, thus avoiding the security problem involved in
    passing parameters on. If you use the option of testing all file systems at the
    same time, with the **`check_disk`** plugin (see [7.1 Free Hard Drive Capacity](../Text/ch07.html#free_hard_drive_capacity
    "7.1 Free Hard Drive Capacity")), then ultimately, one single service definition
    is sufficient to monitor all file systems on all Linux servers— provided you have
    a corresponding NRPE configuration on the target system:'
  id: totrans-1643
  prefs: []
  type: TYPE_NORMAL
  zh: 使用在 [10.3.1 将参数传递给本地插件](../Text/ch10s03.html#passing_parameters_on_to_local_plugins
    "10.3.1 将参数传递给本地插件") 的第 220 页开头定义的命令 **`check_disk_var`**，Nagios 现在检查计算机 **`linux04`**、**`linux02`**
    和 **`linux11`** 上的 **`/var`** 文件系统。如果要将其他文件系统包含在测试中，则为每个文件系统创建单独的服务，从而避免传递参数时涉及的安全问题。如果你使用测试所有文件系统的同时的选项，使用
    **`check_disk`** 插件（见 [7.1 硬盘剩余空间](../Text/ch07.html#free_hard_drive_capacity
    "7.1 硬盘剩余空间")），那么最终，一个单一的服务定义就足够监控所有 Linux 服务器上的所有文件系统——前提是你有目标系统上的相应 NRPE 配置：
- en: '[PRE204]'
  id: totrans-1644
  prefs: []
  type: TYPE_PRE
  zh: '[PRE204]'
- en: 10.6 Indirect Checks
  id: totrans-1645
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 10.6 间接检查
- en: NRPE executes not just local plugins, but any plugins that are available. If
    you use network plugins via NRPE, these are referred to as *indirect checks*,
    as illustrated graphically in [Figure 10-1](../Text/ch10s06.html#indirect_checks_with_nrpe
    "Figure 10-1. Indirect checks with NRPE").
  id: totrans-1646
  prefs: []
  type: TYPE_NORMAL
  zh: NRPE不仅执行本地插件，还执行任何可用的插件。如果你通过NRPE使用网络插件，这些插件被称为*间接检查*，如图[图10-1](../Text/ch10s06.html#indirect_checks_with_nrpe
    "图10-1. 使用NRPE进行间接检查")所示。
- en: '![Indirect checks with NRPE](../Images/tagoreillycom20081104nostarchimages223814.png)'
  id: totrans-1647
  prefs: []
  type: TYPE_IMG
  zh: '![使用NRPE进行间接检查](../Images/tagoreillycom20081104nostarchimages223814.png)'
- en: Figure 10-1. Indirect checks with NRPE
  id: totrans-1648
  prefs: []
  type: TYPE_NORMAL
  zh: 图10-1. 使用NRPE进行间接检查
- en: If every network service was tested directly across the firewall, it would have
    to open all the required ports. In the example, these would be the ports for SMTP,
    HTTP, LDAP, PostgreSQL, and SSH. If the checks are performed indirectly from a
    computer that is behind the firewall, on the other hand, then it is sufficient
    just to have the port for NRPE (TCP port 5666) open on the firewall. As long as
    it is configured via NRPE, the NRPE server behind the firewall can perform any
    tests it wants.
  id: totrans-1649
  prefs: []
  type: TYPE_NORMAL
  zh: 如果每个网络服务都直接通过防火墙进行测试，那么就必须打开所有所需的端口。在示例中，这些端口将是SMTP、HTTP、LDAP、PostgreSQL和SSH的端口。另一方面，如果检查是从防火墙后面的计算机间接进行的，那么只需要在防火墙上打开NRPE（TCP端口5666）的端口就足够了。只要通过NRPE进行配置，防火墙后面的NRPE服务器就可以执行它想要的任何测试。
- en: 'Whether the effort involved in indirect checks is greater than that for direct
    ones is dependent on the specific implementation: if this means that you would
    have to "drill holes into your firewall," then the additional work on the NRPE
    server may be worthwhile. But if the ports involved are open anyway, then the
    direct test can usually be recommended; this would make additional configuration
    work on an NRPE host unnecessary.'
  id: totrans-1650
  prefs: []
  type: TYPE_NORMAL
  zh: 间接检查所涉及的努力是否大于直接检查的努力取决于具体的实现：如果这意味着你必须在防火墙上“打洞”，那么在NRPE服务器上的额外工作可能是值得的。但如果涉及的端口已经打开，那么通常可以直接进行测试；这会使在NRPE主机上进行额外配置工作变得不必要。
- en: Chapter 11. Collecting Information Relevant for Monitoring with SNMP
  id: totrans-1651
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第11章. 使用SNMP收集与监控相关的信息
- en: SNMP stands for *Simple Network Management Protocol*, a protocol defined above
    all to monitor and manage network devices. This means being able to have not only
    read access, but also write access to network devices, so that you can turn a
    specific port on a switch on or off, or intervene in other ways.
  id: totrans-1652
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP代表*简单网络管理协议*，这是一个定义在所有之上的协议，用于监控和管理网络设备。这意味着不仅能够读取网络设备，还能够写入网络设备，因此你可以打开或关闭交换机上的特定端口，或以其他方式干预。
- en: Nearly all network-capable devices that can also be addressed via TCP/IP can
    handle SNMP, and not just switches and routers. For Unix systems there are SNMP
    daemons; even Windows servers contain an SNMP implementation in their standard
    distribution, although this must be explicitly installed. But even uninterruptible
    power supplies (UPSs) or network-capable sensors are SNMP-capable.
  id: totrans-1653
  prefs: []
  type: TYPE_NORMAL
  zh: 几乎所有可以通过TCP/IP进行寻址的网络设备都可以处理SNMP，而不仅仅是交换机和路由器。对于Unix系统，有SNMP守护进程；即使是Windows服务器在其标准发行版中也包含SNMP实现，尽管这必须明确安装。但即使是不间断电源（UPS）或网络传感器也具有SNMP功能。
- en: If you are using Nagios, then at some point you can't avoid coming into contact
    with SNMP, because although you usually have a great choice of querying techniques
    for Unix and Windows systems, when it comes to hardware-specific components such
    as switches, without their own sophisticated operating system, then SNMP is often
    the only way to obtain information from the network device. SNMP certainly does
    not have a reputation of being easy to understand, which among other things lies
    in the fact that it is intended for communication between programs, and machine
    processing is in the foreground. In addition, you generally do not make direct
    contact with the protocol and with the original information, since even modems
    or routers provide a simple-to-operate interface that disguises the complexity
    of the underlying SNMP.
  id: totrans-1654
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用Nagios，那么在某个时候你不可避免地会接触到SNMP，因为尽管你通常有很多查询Unix和Windows系统的技术选择，但当涉及到没有自己复杂操作系统的硬件特定组件，如交换机时，SNMP通常是获取网络设备信息的唯一方式。SNMP并不以易于理解而闻名，这与其他因素有关，例如它旨在程序之间的通信，机器处理是主要的。此外，你通常不会直接与协议和原始信息接触，因为即使是调制解调器或路由器也提供了一个简单易用的界面，掩盖了底层SNMP的复杂性。
- en: If you want to use SNMP with Nagios, you cannot avoid getting involved with
    the information structure of the protocol. [11.1 Introduction to SNMP](../Text/ch11.html#introduction_to_snmp
    "11.1 Introduction to SNMP") therefore provides a short introduction to SNMP.
    [11.2 NET-SNMP](../Text/ch11s02.html "11.2 NET-SNMP") from page 234 introduces
    NET-SNMP, probably the most widely used implementation for SNMP on Unix systems.
    On the one hand it shows how to obtain an overview of the information structure
    of a network device with command-line tools, and on the other it describes the
    configuration of the SNMP daemon in Linux. Finally, [11.3 Nagios's Own SNMP Plugins](../Text/ch11s03.html
    "11.3 Nagios's Own SNMP Plugins") from page 246 is devoted to the concrete use
    of SNMP with Nagios.
  id: totrans-1655
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想在Nagios中使用SNMP，你不可避免地要涉及到协议的信息结构。[11.1 SNMP简介](../Text/ch11.html#introduction_to_snmp
    "11.1 Introduction to SNMP")因此提供了对SNMP的简要介绍。[11.2 NET-SNMP](../Text/ch11s02.html
    "11.2 NET-SNMP")从第234页介绍了NET-SNMP，这可能是Unix系统上最广泛使用的SNMP实现。一方面，它展示了如何使用命令行工具获取网络设备信息结构的概览，另一方面，它描述了Linux中SNMP守护进程的配置。最后，[11.3
    Nagios自带的SNMP插件](../Text/ch11s03.html "11.3 Nagios's Own SNMP Plugins")从第246页专门讨论了SNMP与Nagios的具体使用。
- en: 11.1 Introduction to SNMP
  id: totrans-1656
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 11.1 SNMP简介
- en: 'Although SNMP contains the P for "protocol" in its name, this does not stand
    for a protocol alone, but is used as a synonym for the *Internet Standard Management
    Framework*. This consists of the following components:'
  id: totrans-1657
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然SNMP的名字中包含了“协议”的P，但这不仅仅代表一个协议，而是作为*互联网标准管理框架*的同义词使用。这包括以下组件：
- en: Manageable network nodes that can be controlled remotely via SNMP. A specific
    implementation of an SNMP engine, whether by software or hardware, is referred
    to as an *agent*.
  id: totrans-1658
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 可管理的网络节点，可以通过SNMP远程控制。一个特定的SNMP引擎实现，无论是软件还是硬件，被称为*代理*。
- en: At least one SNMP unit consisting of applications with which the agents can
    be managed. This unit is referred to as a *manager*.
  id: totrans-1659
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 至少一个由可以管理代理的应用程序组成的SNMP单元。这个单元被称为*管理者*。
- en: 'A protocol with which agent and manager can exchange information: the *Simple
    Network Management Protocol* (SNMP).'
  id: totrans-1660
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个代理和管理者可以交换信息的协议：*简单网络管理协议*（SNMP）。
- en: 'A well-defined information structure, so that any managers and agents can understand
    each other: the so-called *Management Information Base*, or in short, MIB.'
  id: totrans-1661
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个明确的信息结构，以便任何管理者和代理都能相互理解：所谓的*管理信息库*，简称MIB。
- en: 'The framework assigns the manager the active role. The agent itself just waits
    passively for incoming commands. In addition, so-called *traps* extend the application
    possibilities of SNMP: these are messages that the agent actively sends to a single
    manager or a whole group of managers, for example if predefined limit values are
    exceeded or if functions of the network device fail.'
  id: totrans-1662
  prefs: []
  type: TYPE_NORMAL
  zh: 框架将管理者的角色定义为主动。代理本身只是被动地等待接收命令。此外，所谓的*陷阱*扩展了SNMP的应用可能性：这些是代理主动发送给单个管理者或一组管理者的消息，例如当预定义的极限值被超过或当网络设备的函数失败时。
- en: As agents, SNMP engines implemented by the manufacturer are used for hardware-specific
    devices (switches, routers). For Linux and general Unix systems, the NET-SNMP
    implementation is available (see [11.2 NET-SNMP](../Text/ch11s02.html "11.2 NET-SNMP")),
    for Windows servers there is equivalent software already included with the operating
    system.
  id: totrans-1663
  prefs: []
  type: TYPE_NORMAL
  zh: 作为代理，制造商实现的SNMP引擎用于特定硬件设备（交换机、路由器）。对于Linux和通用Unix系统，有NET-SNMP实现可用（见[11.2 NET-SNMP](../Text/ch11s02.html
    "11.2 NET-SNMP")），对于Windows服务器，操作系统已经包含了等效的软件。
- en: 'In combination with Nagios, there are two possibilities. With respect to Nagios
    in the active role, corresponding Nagios plugins, as the manager, ask the agents
    for the desired information. The other way round, Nagios can also passively receive
    incoming SNMP traps using utilities and process these. [14.6 Application Example
    II: Processing SNMP Traps](../Text/ch14s06.html "14.6 Application Example II:
    Processing SNMP Traps") from page 312 is devoted to this topic.'
  id: totrans-1664
  prefs: []
  type: TYPE_NORMAL
  zh: '与Nagios结合使用时，有两种可能性。在Nagios扮演主动角色的方面，相应的Nagios插件，作为管理者，会向代理请求所需信息。反过来，Nagios也可以使用工具被动接收传入的SNMP陷阱并处理它们。[14.6
    应用示例II：处理SNMP陷阱](../Text/ch14s06.html "14.6 Application Example II: Processing
    SNMP Traps")从第312页专门讨论了这一主题。'
- en: An understanding of the SNMP information structure, the so-called *Management
    Information Base* (MIB), is critical if you want to use SNMP with Nagios successfully.
    For this reason this section will focus on this. The protocol itself is only mentioned
    briefly to illustrate the differences between different protocol versions.
  id: totrans-1665
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想成功使用Nagios与SNMP，理解SNMP信息结构，所谓的 *管理信息库* (MIB) 是至关重要的。因此，本节将专注于这一点。协议本身只是简要提及，以说明不同协议版本之间的差异。
- en: 'If you want to get involved more deeply with SNMP, we refer you to the numerous
    *Request for Comments* (RFCs) describing SNMP. The best place to start would be
    in RFC 3410, "Introduction and Applicability Statements for Internet Standard
    Management Framework", and RFC 3411: "An Architecture for Describing Simple Network
    Management Protocol (SNMP) Management Frameworks." Apart from an introduction
    and numerous crosslinks, you will also find references there to the original documents
    of the older versions, today referred to as SNMPv1 and SNMPv2.'
  id: totrans-1666
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想要更深入地了解SNMP，我们建议你查阅描述SNMP的众多 *请求评论* (RFCs)。最佳起点是RFC 3410，“互联网标准管理框架的介绍和适用性声明”和RFC
    3411：“描述简单网络管理协议（SNMP）管理框架的架构”。除了介绍和许多交叉链接外，你还可以在那里找到对较旧版本原始文档的引用，今天被称为SNMPv1和SNMPv2。
- en: 11.1.1 The Management Information Base
  id: totrans-1667
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.1.1 管理信息库
- en: The SNMP information structure consists of a hierarchical namespace construction
    of numbers. [Figure 11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "Figure 11-1. SNMP namespace using the example of the MIB-II interfaces") shows
    an extract from this. The tree structure is similar to those of other hierarchical
    directory services, such as DNS or LDAP.
  id: totrans-1668
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP信息结构由数字的分层命名空间构造组成。[图11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "图11-1. 使用MIB-II接口示例的SNMP命名空间") 展示了这一结构的摘录。树结构类似于其他分层目录服务，如DNS或LDAP。
- en: Its root is called **`1 (iso)`** and stands for the *International Organization
    for Standardization*. The next level, **`3 (org)`** shown in [Figure 11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "Figure 11-1. SNMP namespace using the example of the MIB-II interfaces") provides
    a space for general, national and international organizations. Beneath this is
    **`6 (dod)`** for the U.S. *Department of Defense*. The general (IP-based) **`internet`**
    owes its assignment as a subitem **`1 (internet)`** of **`dod`** to its origin
    as a military project.
  id: totrans-1669
  prefs: []
  type: TYPE_NORMAL
  zh: 它的根被称为 **`1 (iso)`**，代表 *国际标准化组织*。下一级，如图 [图11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "图11-1. 使用MIB-II接口示例的SNMP命名空间") 所示的 **`3 (org)`**，为一般、国家和国际组织提供空间。在其下方是 **`6 (dod)`**，代表美国的
    *国防部*。基于IP的一般（互联网）**`internet`** 被分配为 **`dod`** 的子项 **`1 (internet)`**，这归因于其作为军事项目的起源。
- en: If you bring together the corresponding numbers from left to right and separate
    them with the dot, then for the **`internet`** node in the tree, you arrive at
    the designation **`1.3.6.1`**. Such nodes are referred to in general as *object
    identifiers* (OID). Their syntax is used not only in SNMP but also in the definition
    of LDAP objects and attributes, for example.
  id: totrans-1670
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你从左到右将相应的数字组合起来并用点分隔，那么对于树中的 **`internet`** 节点，你将得到标识 **`1.3.6.1`**。这类节点通常被称为
    *对象标识符* (OID)。它们的语法不仅用于SNMP，也用于定义LDAP对象和属性，例如。
- en: 'The OID **`1.3.6.1`** is not exactly easily readable for humans, which is why
    other notation methods have gained acceptance: both **`iso.org.dod.internet`**
    and the combination **`iso(1).org(3).dod(6).internet(1)`** is allowed. Because
    this would quickly make readable descriptions infinitely long if the tree were
    deep enough, another abbreviated notation method has become established: as long
    as the term remains unique, you may simply write **`internet`** instead of **`1.3.6.1`**.'
  id: totrans-1671
  prefs: []
  type: TYPE_NORMAL
  zh: OID **`1.3.6.1`** 对于人类来说并不容易阅读，这就是为什么其他表示方法已经得到认可：**`iso.org.dod.internet`**
    和组合 **`iso(1).org(3).dod(6).internet(1)`** 都是允许的。因为如果树足够深，这会迅速使可读描述变得无限长，因此另一种缩写表示方法已经建立：只要术语保持唯一，你只需简单地写
    **`internet`** 而不是 **`1.3.6.1`**。
- en: The important thing here is that the communication between manager and agent
    is exclusively of a numerical nature. Whether the manager also allows text input
    or is capable of issuing information as text instead of as a numeric OID depends
    on the implementation in each case. The information on individual nodes is provided
    by the manufacturer of the SNMP agent as a Management Information Base (MIB) in
    file form.
  id: totrans-1672
  prefs: []
  type: TYPE_NORMAL
  zh: 这里重要的是，管理器和代理之间的通信完全是数值性的。管理器是否也允许文本输入或能否以文本形式而不是以数值OID发布信息取决于每种情况下的实现。有关各个节点的信息由SNMP代理的制造商以文件形式提供，作为管理信息库（MIB）。
- en: '![SNMP namespace using the example of the MIB-II interfaces](../Images/tagoreillycom20081104nostarchimages223816.png)'
  id: totrans-1673
  prefs: []
  type: TYPE_IMG
  zh: '![使用MIB-II接口示例的SNMP命名空间](../Images/tagoreillycom20081104nostarchimages223816.png)'
- en: Figure 11-1. SNMP namespace using the example of the MIB-II interfaces
  id: totrans-1674
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-1. 使用MIB-II接口示例的SNMP命名空间
- en: The data stored in the MIB includes contact information (who designed the MIB;
    usually the manufacturer of the device will be given here), the definition of
    individual subnodes and attributes, and the data types used. If an MIB file also
    describes the individual subnodes and attributes, this puts the manager in a position
    to supply the user with additional information on the meaning and purpose of the
    entry in question.
  id: totrans-1675
  prefs: []
  type: TYPE_NORMAL
  zh: 存储在MIB中的数据包括联系信息（谁设计了MIB；通常设备制造商将被提供在这里），各个子节点和属性的定义，以及使用的数据类型。如果MIB文件还描述了各个子节点和属性，这将使管理器能够向用户提供有关所讨论条目意义和目的的附加信息。
- en: Below **`internet`**, the next level is divided into various namespaces. The
    management node **`1.3.6.1.2`** is especially important for SNMP, that is, **`iso(1)
    .org(3) .dod(6) .internet(1) .mgmt(2)`**. The namespace here is described by RFC
    1155, "Structure and Identification of Management Information for TCP/IP-based
    Internets."
  id: totrans-1676
  prefs: []
  type: TYPE_NORMAL
  zh: 在**`internet`**下面，下一级被划分为各种命名空间。对于SNMP来说，管理节点**`1.3.6.1.2`**特别重要，即**`iso(1)
    .org(3) .dod(6) .internet(1) .mgmt(2)`**。这里的命名空间由RFC 1155，“基于TCP/IP互联网的管理信息的结构和标识”所描述。
- en: In order for manager and agent to be able to understand each other, the manager
    needs to know how the agent structures its data. This is where the *Management
    Information Base, Version II* comes into play. SNMP requests information from
    the agents on their implementation; with this, every manager can access the most
    important parameters of the agent, without a previous exchange of MIB definitions.
    The *Management Information Base II*, or MIB-II (or mib-2) for short, can be found
    in the namespace at **`1.3.6.1.2.1`** or **`iso(1).org(3).dod(6).internet(1).mgmt(2).mib-2(1)`**.
    Since it is well-defined and unique, OIDs lying beneath that are usually described
    in short, starting with MIB-II or mib-2.
  id: totrans-1677
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使管理器和代理能够相互理解，管理器需要知道代理如何结构化其数据。这就是**管理信息库，版本II**发挥作用的地方。SNMP从代理那里请求有关其实施的信息；通过这种方式，每个管理器都可以访问代理的最重要参数，而无需之前的MIB定义交换。**管理信息库II**，或简称为MIB-II（或mib-2），可以在**`1.3.6.1.2.1`**或**`iso(1).org(3).dod(6).internet(1).mgmt(2).mib-2(1)`**命名空间中找到。由于它是明确定义且唯一的，因此位于其下的OID通常简短描述，以MIB-II或mib-2开头。
- en: Manufacturer-specific information can also be defined in your own Management
    Information Base. Corresponding MIBs are located beneath **`internet.private.enterprise`**.
    Once an OID has been described in an MIB, the meaning of this entry may never
    be changed. The description format for an MIB is standardized by RFC 1212, which
    is the reason that special MIBs, included by a vendor for its agents, can be integrated
    into almost any manager.
  id: totrans-1678
  prefs: []
  type: TYPE_NORMAL
  zh: 您也可以在自己的管理信息库中定义制造商特定的信息。相应的MIB位于**`internet.private.enterprise`**之下。一旦在MIB中描述了一个OID，该条目的含义就永远不能更改。MIB的描述格式由RFC
    1212标准化，这也是为什么供应商为代理提供的特殊MIB几乎可以集成到任何管理器中。
- en: MIB-II
  id: totrans-1679
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: MIB-II
- en: MIB-II, the Management Information Base, which is obligatory for all SNMP agents,
    contains several information groups. The most important of these are summarized
    in [Table 11-1](../Text/ch11.html#mib-ii_groups_open_parenthesis_a_selecti "Table 11-1. MIB-II
    groups (a selection)"). The notation **`mib-2.`****``*`x`*``** stands for **`1.3.6.1.2.1.`****``*`x`*``**.
  id: totrans-1680
  prefs: []
  type: TYPE_NORMAL
  zh: MIB-II，即所有SNMP代理都必须遵守的管理信息库，包含几个信息组。其中最重要的总结在[表11-1](../Text/ch11.html#mib-ii_groups_open_parenthesis_a_selecti
    "表11-1. MIB-II groups (a selection)")中。表示法**`mib-2.`****``*`x`*``**代表**`1.3.6.1.2.1.`****``*`x`*``**。
- en: Table 11-1. MIB-II groups (a selection)
  id: totrans-1681
  prefs: []
  type: TYPE_NORMAL
  zh: 表11-1. MIB-II组（部分选择）
- en: '| Group | OID | Description |'
  id: totrans-1682
  prefs: []
  type: TYPE_TB
  zh: '| 组 | OID | 描述 |'
- en: '| --- | --- | --- |'
  id: totrans-1683
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| system | mib-2.1 | Information on the device, (e.g., the location, contact
    partner, or uptime) |'
  id: totrans-1684
  prefs: []
  type: TYPE_TB
  zh: '| system | mib-2.1 | 设备信息（例如，位置、联系人或运行时间）|'
- en: '| interfaces | mib-2.2 | Information on the network interfaces (Name, interface
    type, status, statistics etc.) |'
  id: totrans-1685
  prefs: []
  type: TYPE_TB
  zh: '| 接口 | mib-2.2 | 网络接口信息（名称、接口类型、状态、统计信息等）|'
- en: '| at | mib-2.3 | Assignment of physical addresses (e.g., of MAC addresses)
    to the IP address *(Address Translation Table)* |'
  id: totrans-1686
  prefs: []
  type: TYPE_TB
  zh: '| at | mib-2.3 | 将物理地址（例如，MAC地址）分配给IP地址（地址转换表）|'
- en: '| ip | mib-2.4 | Routing tables and IP packet statistics |'
  id: totrans-1687
  prefs: []
  type: TYPE_TB
  zh: '| ip | mib-2.4 | 路由表和IP数据包统计信息|'
- en: '| icmp | mib-2.5 | Statistics on individual ICMP packet types |'
  id: totrans-1688
  prefs: []
  type: TYPE_TB
  zh: '| icmp | mib-2.5 | 单个ICMP数据包类型的统计信息|'
- en: '| tcp | mib-2.6 | Open ports and existing TCP connections |'
  id: totrans-1689
  prefs: []
  type: TYPE_TB
  zh: '| tcp | mib-2.6 | 打开的端口和现有的TCP连接|'
- en: '| udp | mib-2.7 | ditto for UDP |'
  id: totrans-1690
  prefs: []
  type: TYPE_TB
  zh: '| udp | mib-2.7 | 对于UDP也是如此|'
- en: '| host | mib-2.25 | Information on storage media, devices, running processes
    and their use of resources |'
  id: totrans-1691
  prefs: []
  type: TYPE_TB
  zh: '| host | mib-2.25 | 存储介质、设备、运行进程及其资源使用的信息|'
- en: 'How you specifically handle information stored in the MIB-II can be explained
    using the example of the *interfaces* group: [Figure 11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "Figure 11-1. SNMP namespace using the example of the MIB-II interfaces") shows
    how they are split up into the two OID **`interfaces.if Number`** and **`interfaces.if
    Table`**. This is because one network node initially reveals an unknown number
    of interfaces. This number is taken up by **`ifNumber`**. Before looking at these
    interfaces more closely, a manager can get the information from **`ifNumber`**
    about how many there really are.'
  id: totrans-1692
  prefs: []
  type: TYPE_NORMAL
  zh: 如何具体处理存储在MIB-II中的信息可以通过*接口*组的例子来解释：[图11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "图11-1. 使用MIB-II接口的SNMP命名空间")展示了它们如何分为两个OID **`interfaces.if Number`** 和 **`interfaces.if
    Table`**。这是因为一个网络节点最初会显示未知数量的接口。这个数量由**`ifNumber`**来表示。在更详细地查看这些接口之前，管理者可以从**`ifNumber`**获取有关实际接口数量的信息。
- en: '**`ifTable`** then contains the actual information on the different interfaces.
    To obtain this information for a specific interface, the manager queries all the
    entries in which the last number is the same, like this:'
  id: totrans-1693
  prefs: []
  type: TYPE_NORMAL
  zh: '**`ifTable`** 包含了不同接口的实际信息。为了获取特定接口的信息，管理者查询所有最后一位数字相同的条目，如下所示：'
- en: '[PRE205]'
  id: totrans-1694
  prefs: []
  type: TYPE_PRE
  zh: '[PRE205]'
- en: '**`ifIndex`** describes the device-internal index—SNMP always starts counting
    from **`1`**, switches start counting here from **`100`**. **`ifDescr`** contains
    the name of the interface, here **`eth0`**—this is obviously a Linux machine.
    It can be assumed from the next four entries that a normal 100-Mbit Ethernet interface
    is involved.'
  id: totrans-1695
  prefs: []
  type: TYPE_NORMAL
  zh: '**`ifIndex`** 描述了设备内部的索引——SNMP总是从**`1`**开始计数，交换机从这里开始计数为**`100`**。**`ifDescr`**
    包含接口的名称，这里为**`eth0`**——这显然是一台Linux机器。从接下来的四个条目可以推断出，这里涉及到的是一个普通的100-Mbit以太网接口。'
- en: The interface type **`ifType`** is given as **`ethernetCsmacd`**,^([[104](#ftn.CHP-11-FN-1)])
    that is, Ethernet. **`ifMtu`** specifies the *Maximum Transfer Unit*, which in
    local networks is always 1,500 bytes for Ethernet. The interface speed **`ifSpeed`**
    is 100,000,000 bits here, that is, 100 Mbit. And **`ifPhysAddress`** contains
    the physical network address, also called the MAC address.
  id: totrans-1696
  prefs: []
  type: TYPE_NORMAL
  zh: 接口类型**`ifType`**给出为**`ethernetCsmacd`**，即以太网。**`ifMtu`**指定了*最大传输单元*，在本地网络中，以太网总是1,500字节。接口速度**`ifSpeed`**为100,000,000位，即100
    Mbit。而**`ifPhysAddress`**包含物理网络地址，也称为MAC地址。
- en: '**`ifAdminStatus`** reveals whether the admin has switched the interface on
    (**`up`**) or off (**`down`**) via the configuration. **`ifOperStatus`** on the
    other hand specifies the actual status, since even interfaces activated by an
    administrator are not necessarily connected to a device, or even switched on.'
  id: totrans-1697
  prefs: []
  type: TYPE_NORMAL
  zh: '**`ifAdminStatus`** 揭示了管理员是否通过配置将接口打开（**`up`**）或关闭（**`down`**）。另一方面，**`ifOperStatus`**
    指定了实际状态，因为即使由管理员激活的接口也不一定连接到设备，或者甚至打开。'
- en: 'There is a similar picture for the second interface:'
  id: totrans-1698
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个接口也有类似的图示：
- en: '[PRE206]'
  id: totrans-1699
  prefs: []
  type: TYPE_PRE
  zh: '[PRE206]'
- en: This is not an Ethernet card here, however, but a local loopback device.
  id: totrans-1700
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，这里不是以太网卡，而是一个本地回环设备。
- en: 11.1.2 SNMP protocol versions
  id: totrans-1701
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.1.2 SNMP协议版本
- en: The first SNMP version and *Internet Standard Management Framework* were described
    back in 1988 in RFCs 1065–1067; the current documentation on this version, named
    SNMPv1, can be found in RFC 1155–1157\. It is still used today, since higher versions
    are fundamentally backward-compatible.
  id: totrans-1702
  prefs: []
  type: TYPE_NORMAL
  zh: 第一个 SNMP 版本和**互联网标准管理框架**最早在 1988 年的 RFC 1065–1067 中描述；关于这个版本（命名为 SNMPv1）的当前文档可以在
    RFC 1155–1157 中找到。它今天仍在使用，因为更高版本在本质上与旧版本向后兼容。
- en: 'The big disadvantage of SNMPv1 is that this version allows only unsatisfactory
    authentication in precisely three stages: no access, read access, and full access
    for read and write operations. Two simple passwords, the so-called *communities*,
    provide a little protection here: they divide users into one community with read
    permissions, and the second one with read and write permissions. No further differentiation
    is possible. If this was not enough, the community is transmitted in plain text,
    making it an easy prey for sniffer tools.'
  id: totrans-1703
  prefs: []
  type: TYPE_NORMAL
  zh: SNMPv1 的主要缺点是这个版本只允许在精确的三阶段中进行令人不满意的认证：无访问权限、读取访问权限和读写操作的完全访问权限。两个简单的密码，所谓的**社区**，在这里提供了一点保护：它们将用户分为具有读取权限的一个社区，以及具有读取和写入权限的第二个社区。不可能进行进一步的区分。如果这还不够，社区是以明文形式传输的，这使得它很容易成为嗅探工具的目标。
- en: Further development on the second version, SNMPv2, was intended to solve problems
    concerning the display of value ranges, error events, and the performance if there
    are mass requests (RFC 1905). This RFC was never fully implemented, however. The
    only relatively complete implementation that was used in practice is known as
    the *Community-based SNMPv2*, or SNMPv2c for short (RFC 1901-1908). The current
    version, SNMPv3 (RFC 3411–3418), has the status of an Internet standard. Agents
    with SNMPv3 implementations always understand requests from SNMPv1.
  id: totrans-1704
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个版本 SNMPv2 的进一步开发旨在解决有关值范围显示、错误事件以及大量请求时的性能问题（RFC 1905）。然而，这个 RFC 从未完全实现。在实践中使用的唯一相对完整的实现被称为**基于社区的
    SNMPv2**，或简称为 SNMPv2c（RFC 1901-1908）。当前版本 SNMPv3（RFC 3411–3418）具有互联网标准的地位。具有 SNMPv3
    实现的代理始终理解来自 SNMPv1 的请求。
- en: Apart from extended protocol operations, there are no fundamental differences
    between SNMPv1 and SNMPv2c. This is probably also the reason why SNMPv2 could
    not really gain a foothold. The hoped-for increase in security was certainly missing
    in this version. It is only the extensions of the framework in SNMPv3 which allow
    more precise access control, but this is much more complicated than the two community
    strings in SNMPv1\. RFC 3414 describes the *user-based security model* (USM),
    RFC 3415 the *view-based access control model* (VACM).
  id: totrans-1705
  prefs: []
  type: TYPE_NORMAL
  zh: 除了扩展协议操作外，SNMPv1 和 SNMPv2c 之间没有根本性的区别。这也可能是 SNMPv2 无法真正站稳脚跟的原因。在这个版本中，期望的安全性的提高显然是缺失的。只有
    SNMPv3 中框架的扩展允许更精确的访问控制，但这比 SNMPv1 中的两个社区字符串要复杂得多。RFC 3414 描述了基于用户的**安全模型**（USM），RFC
    3415 描述了基于视图的**访问控制模型**（VACM）。
- en: 'When accessing an SNMP agent, you must tell all tools, including plugins, which
    protocol version is to be used. In Nagios you exclusively require read access.
    If this is restricted to the required information and you only allow the access
    from the Nagios server, you need have no qualms about doing without the extended
    authentication of SNMPv3\. It is only important that you configure the agent—if
    possible—so that it completely prevents write accesses, or at least demands a
    password. You should never use this: since it is transmitted in plain text, there
    is always a danger that somebody may be listening, and misuse the password later
    on.'
  id: totrans-1706
  prefs: []
  type: TYPE_NORMAL
  zh: 当访问 SNMP 代理时，你必须告诉所有工具，包括插件，要使用哪个协议版本。在 Nagios 中，你只需要读取访问。如果这仅限于所需的信息，并且你只允许来自
    Nagios 服务器的访问，那么你无需担心没有 SNMPv3 的扩展认证。重要的是，如果你可能的话，配置代理以完全防止写访问，或者至少要求密码。你永远不应该使用这个：因为它以明文形式传输，总有人可能会监听，并可能在以后滥用密码。
- en: In NET-SNMP, write accesses can be completely prevented, access can be restricted
    to specific hosts, and information revealed can be limited. For other agents implemented
    in hardware such as switches and routers, you must weigh up whether you really
    need SNMPv3, assuming the manufacturer has made this available. SNMPv1, however,
    is available for all SNMP devices.
  id: totrans-1707
  prefs: []
  type: TYPE_NORMAL
  zh: 在 NET-SNMP 中，可以完全防止写访问，访问可以限制到特定的主机，并且可以限制公开的信息。对于其他在硬件中实现的代理，例如交换机和路由器，你必须权衡是否真的需要
    SNMPv3，假设制造商已经提供了这项功能。然而，SNMPv1 对于所有 SNMP 设备都是可用的。
- en: We will therefore only explain access via SNMPv1 below, and assume that this
    is generally read access only. If you still want to get involved with SNMPv3,
    we refer you to the NET-SNMP documentation.^([[105](#ftn.CHP-11-FN-2)])
  id: totrans-1708
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们下面将仅解释通过SNMPv1的访问方式，并假设这通常是只读访问。如果您仍然想涉足SNMPv3，我们建议您查阅NET-SNMP文档.^([[105](#ftn.CHP-11-FN-2)])
- en: '* * *'
  id: totrans-1709
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[104](#CHP-11-FN-1)]) *Carrier Sense* (CS) means that each network interface
    checks to see whether the line is free, based on the network signal (in contrast
    to Token Ring, for example, where the network card may use the line only if it
    explicitly receives a token); *Multiple Access* (MA) means that several network
    cards may access a common network medium simultaneously.
  id: totrans-1710
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[104](#CHP-11-FN-1)]) *载波侦听* (CS) 指的是每个网络接口根据网络信号（例如与令牌环网相比，网络卡可能只有明确接收到令牌时才能使用线路）检查线路是否空闲；*多路访问*
    (MA) 指的是多个网络卡可以同时访问一个公共网络介质。
- en: ^([[105](#CHP-11-FN-2)]) [http://net-snmp.sourceforge.net/docs/FAQ.html#How_do_I_use_SNMPv](http://net-snmp.sourceforge.net/docs/FAQ.html#How_do_I_use_SNMPv)
  id: totrans-1711
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[105](#CHP-11-FN-2)]) [http://net-snmp.sourceforge.net/docs/FAQ.html#How_do_I_use_SNMPv](http://net-snmp.sourceforge.net/docs/FAQ.html#How_do_I_use_SNMPv)
- en: 11.2 NET-SNMP
  id: totrans-1712
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 11.2 NET-SNMP
- en: Probably the most widely used SNMP implementation for Linux and other UNIX systems
    is NET-SNMP ^([[106](#ftn.CHP-11-FN-3)]) and was originally conceived at Carnegie-Mellon
    University Wes Hardaker, a system administrator at the University of California
    in Davis, continued developing the code and first published it under the name
    UCD-SNMP (Version 3.0).
  id: totrans-1713
  prefs: []
  type: TYPE_NORMAL
  zh: 可能是Linux和其他UNIX系统上最广泛使用的SNMP实现是NET-SNMP ^([[106](#ftn.CHP-11-FN-3)])，最初由卡内基梅隆大学的Wes
    Hardaker，加州大学戴维斯分校的系统管理员构想，他继续开发代码，并首次以UCD-SNMP（版本3.0）的名义发布。
- en: With version 5.0 the project finally got the name NET-SNMP. But various distributions
    still call the package UCD-SNMP, in part because it contains version 4.2, in part
    because the maintainer has simply not gotten around to renaming it.
  id: totrans-1714
  prefs: []
  type: TYPE_NORMAL
  zh: 在5.0版本中，该项目最终得到了NET-SNMP这个名字。但各种发行版仍然称这个包为UCD-SNMP，部分原因是因为它包含了4.2版本，部分原因是因为维护者简单地还没有时间将其重命名。
- en: NET-SNMP consists of a set of command line tools, a graphical browser (**`tkmib`**),
    an agent (**`snmpd`**, see [11.2.2 The NET-SNMP daemon](../Text/ch11s02.html#the_net-snmp_daemon
    "11.2.2 The NET-SNMP daemon") in page 238) and a library, which now forms the
    basis of nearly all SNMP implementations in the Open Source field.
  id: totrans-1715
  prefs: []
  type: TYPE_NORMAL
  zh: NET-SNMP由一组命令行工具、一个图形浏览器（**`tkmib`**）、一个代理（**`snmpd`**，见第238页的[11.2.2 NET-SNMP守护进程](../Text/ch11s02.html#the_net-snmp_daemon
    "11.2.2 NET-SNMP守护进程")）和一个库组成，现在它几乎成为开源领域几乎所有SNMP实现的基石。
- en: All common distributions include corresponding packages. In SuSE this is called
    **`net-snmp`** and contains all the components; Debian packs the tools in the
    package **`snmp`**, and the daemon in the package **`snmpd`**. At the time of
    going to press, version 5.4.1 was the current version, but an older 5.x version
    will do the job for our purposes. Their outputs differ to some extent, but the
    exact options can be looked up where necessary in the man page.
  id: totrans-1716
  prefs: []
  type: TYPE_NORMAL
  zh: 所有常见的发行版都包括相应的包。在SuSE中，这被称为**`net-snmp`**，包含所有组件；Debian将工具打包在**`snmp`**包中，并将守护进程打包在**`snmpd`**包中。在印刷时，5.4.1是当前版本，但较老的5.x版本也能满足我们的需求。它们的输出在某种程度上有所不同，但具体选项可以在必要的man页面上查找。
- en: 11.2.1 Tools for SNMP requests
  id: totrans-1717
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.2.1 SNMP请求工具
- en: 'For read access, the programs **`snmpget`**, **`snmpgetnext`** and **`snmpwalk`**
    are used. **`snmpget`** specifically requests a single OID and returns a single
    value from it. **`snmpgetnext`** displays the next variable existing in the Management
    Information Base, including its value:'
  id: totrans-1718
  prefs: []
  type: TYPE_NORMAL
  zh: 对于读取访问，使用**`snmpget`**、**`snmpgetnext`**和**`snmpwalk`**程序。**`snmpget`**特别请求一个OID并从中返回一个值。**`snmpgetnext`**显示管理信息库中存在的下一个变量，包括其值：
- en: '[PRE207]'
  id: totrans-1719
  prefs: []
  type: TYPE_PRE
  zh: '[PRE207]'
- en: The option **`-v1`** instructs **`snmpget`** to use SNMPv1 as the protocol.
    With **`-c`** you specify the read community an; in this case then, the password
    is **`public`**. This is followed by the computer to be queried, here **`localhost`**,
    and finally there is the OID whose value we would like to find out.
  id: totrans-1720
  prefs: []
  type: TYPE_NORMAL
  zh: 选项**`-v1`**指示**`snmpget`**使用SNMPv1作为协议。使用**`-c`**指定读取社区；在这种情况下，密码是**`public`**。接下来是查询的计算机，这里为**`localhost`**，最后是我们要查找值的OID。
- en: 'The NET-SNMP tools are masters of OID abbreviation: without special instructions,
    they always assume that an OID is involved which lies inside the MIB-II. For unique
    entries such as **`ifDescr.1`**, this is sufficient. But whether the various SNMP
    plugins for Nagios can also handle this depends on the specific implementation;
    it is best to try out cases on an individual basis. To be on the safe side, it
    is better to use complete OIDs, either numerical in readable form. The latter
    is obtained if you instruct **`snmpget`** to display the full OID:'
  id: totrans-1721
  prefs: []
  type: TYPE_NORMAL
  zh: NET-SNMP工具是OID缩写的专家：没有特殊指令，它们总是假设涉及的OID位于MIB-II内部。对于如**`ifDescr.1`**这样的唯一条目，这已经足够了。但各种Nagios
    SNMP插件是否也能处理这种情况取决于具体的实现；最好逐个尝试。为了安全起见，最好使用完整的OID，可以是数值形式，也可以是可读形式。后者是在你指示**`snmpget`**显示完整OID时获得的：
- en: '[PRE208]'
  id: totrans-1722
  prefs: []
  type: TYPE_PRE
  zh: '[PRE208]'
- en: 'The **`-On`** option provides the numerical OID, **`-Of`** the text version.
    In this way you can easily find out the complete OID, for plugins which cannot
    handle the abbreviation. It is important to remember here: each OID always starts
    with a period. If you omit this, there will always be a plugin which doesn''t
    work properly.'
  id: totrans-1723
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-On`**选项提供数值OID，**`-Of`**提供文本版本。这样，你可以轻松地找到完整的OID，对于无法处理缩写的插件来说。这里重要的是要记住：每个OID总是以一个点开始。如果你省略了它，总会有一个插件无法正常工作。'
- en: 'In order to obtain the entire information stored in the MIB-II, it is better
    to use **`snmpwalk`**. As the name suggests, the program takes a walk through
    the Management Information Base, either in its entirety or in a specified part
    of the tree. If you would like to find out about all the entries beneath the node
    **`mib-2.interfaces`** ([Figure 11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "Figure 11-1. SNMP namespace using the example of the MIB-II interfaces") in page
    230), you simply give **`snmpwalk`** the required OID:'
  id: totrans-1724
  prefs: []
  type: TYPE_NORMAL
  zh: 为了获取MIB-II中存储的所有信息，最好使用**`snmpwalk`**。正如其名称所暗示的，该程序会遍历整个管理信息库，要么是全部，要么是树的一部分。如果你想要了解节点**`mib-2.interfaces`**（[图11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "图11-1. 使用MIB-II接口示例的SNMP命名空间")在第230页）下的所有条目，你只需给**`snmpwalk`**提供所需的OID：
- en: '[PRE209]'
  id: totrans-1725
  prefs: []
  type: TYPE_PRE
  zh: '[PRE209]'
- en: '**`snmpwalk`** hides the exact structure slightly (links to **`ifTable`** and
    **`ifEntry`** are missing, for example, see [Figure 11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "Figure 11-1. SNMP namespace using the example of the MIB-II interfaces")), so
    that it is better to use **`-Of:`**'
  id: totrans-1726
  prefs: []
  type: TYPE_NORMAL
  zh: '**`snmpwalk`**略微隐藏了确切的结构（例如，缺少到**`ifTable`**和**`ifEntry`**的链接，例如，参见[图11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "图11-1. 使用MIB-II接口示例的SNMP命名空间"))，因此最好使用**`-Of:`**'
- en: '[PRE210]'
  id: totrans-1727
  prefs: []
  type: TYPE_PRE
  zh: '[PRE210]'
- en: The three dots ... in the version here abbreviated for print stand for **`.iso.org.dod.internet.mgmt`**.
  id: totrans-1728
  prefs: []
  type: TYPE_NORMAL
  zh: 这里简写用于打印的三个点...代表**`.iso.org.dod.internet.mgmt`**。
- en: 'As the next step, you could take a look around your own network and query the
    Management Information Bases available there. Normally you will get quite far
    with the read community **`public`**, since this is often the default setting.
    So you should also try out the community string **`private`**, which is the default
    set by many vendors. An extremely dubious practice, by the way: anyone who knows
    a bit about SNMP and who has access to the network can use this to manipulate
    device settings, such as switching off certain ports or the entire switch. But
    even with all the other default passwords, you should take the trouble to change
    them. Entire password lists can be found on the Internet, sorted by vendors and
    devices—easily found through Google.'
  id: totrans-1729
  prefs: []
  type: TYPE_NORMAL
  zh: 作为下一步，你可以查看自己的网络并查询那里可用的管理信息库。通常，使用读取社区**`public`**可以走得很远，因为这是常见的默认设置。因此，你也应该尝试社区字符串**`private`**，这是许多厂商默认设置的。顺便说一句，这是一种极其可疑的做法：任何对SNMP有点了解并且有权访问网络的人都可以使用它来操纵设备设置，例如关闭某些端口或整个交换机。但即使对于所有其他默认密码，你也应该麻烦去更改它们。整个密码列表可以在互联网上找到，按厂商和设备分类——通过Google很容易找到。
- en: Whether you also change the preset read community (such as **`public`**) depends
    on the information available on it and on your own security requirements. But
    the read-write community should under no circumstances retain the default setting.
    In addition it is recommended that you switch off SNMP completely for devices
    that are neither queried nor administrated via SMNP, just to be on the safe side.
  id: totrans-1730
  prefs: []
  type: TYPE_NORMAL
  zh: 无论你是否也更改了预设的读取社区（例如**`public`**），这取决于该社区上的信息以及你自己的安全需求。但读写社区在任何情况下都不应保留默认设置。此外，对于既不通过SNMP查询也不通过SNMP管理的设备，建议您完全关闭SNMP，以确保安全。
- en: Taking a graphic walk with **`mbrowse`**
  id: totrans-1731
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用**`mbrowse`**进行图形遍历
- en: A graphical interface is often recommended for interactive research and for
    initial explorations of the Management Information Base, such as the SNMP browser
    **`mbrowse`**^([[107](#ftn.CHP-11-FN-4)]) (see [Figure 11-2](../Text/ch11s02.html#snmp_browser_mbrowse
    "Figure 11-2. SNMP browser mbrowse")). This is not a component of NET-SNMP, but
    most Linux distributions provide an **`mbrowse`** package for installation.
  id: totrans-1732
  prefs: []
  type: TYPE_NORMAL
  zh: 图形界面通常推荐用于交互式研究和管理信息库的初始探索，例如SNMP浏览器**`mbrowse`**^([[107](#ftn.CHP-11-FN-4)])（见[图11-2](../Text/ch11s02.html#snmp_browser_mbrowse
    "图11-2. SNMP浏览器 mbrowse")）。这不是NET-SNMP的组件，但大多数Linux发行版都提供了**`mbrowse`**包以供安装。
- en: '![SNMP browser mbrowse](../Images/tagoreillycom20081104nostarchimages223818.png)'
  id: totrans-1733
  prefs: []
  type: TYPE_IMG
  zh: '![SNMP浏览器 mbrowse](../Images/tagoreillycom20081104nostarchimages223818.png)'
- en: Figure 11-2. SNMP browser `mbrowse`
  id: totrans-1734
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-2. SNMP浏览器 `mbrowse`
- en: If you highlight an entry and click on the **`Walk`** button, the lower window
    displays the same output as **`snmpwalk`**. The graphical display, however, allows
    better orientation—it is easier to see in which partial tree you are currently
    located. It is also interesting that **`mbrowse`** shows the numeric OID of each
    selected object, in **`Object Identifier`**.
  id: totrans-1735
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你突出显示一个条目并点击**`Walk`**按钮，下方的窗口将显示与**`snmpwalk`**相同的输出。然而，图形显示允许更好的定位——更容易看到你目前位于哪个部分树中。而且，**`mbrowse`**还会在**`Object
    Identifier`**中显示每个选定对象的数值OID。
- en: 11.2.2 The NET-SNMP daemon
  id: totrans-1736
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.2.2 NET-SNMP守护进程
- en: The NET-SNMP daemon **`snmpd`** works as an SNMP agent for Linux and other Unix
    systems; that is, it answers requests from a manager and also provides a way of
    making settings to the Linux system via write accesses, such as manipulating the
    routing table.
  id: totrans-1737
  prefs: []
  type: TYPE_NORMAL
  zh: NET-SNMP守护进程**`snmpd`**作为Linux和其他Unix系统的SNMP代理工作；也就是说，它响应管理器的请求，同时也提供了一种通过写入访问来设置Linux系统的方式，例如操作路由表。
- en: Supported Mangement Information Bases
  id: totrans-1738
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 支持的管理信息库
- en: The agent initially provides information on the MIB-II described in RFC 1213
    ([11.1.1 The Management Information Base](../Text/ch11.html#the_management_information_base
    "11.1.1 The Management Information Base") from page 229), but also the host extensions
    belonging to this from RFC 2790 (host MIB). [Table 11-2](../Text/ch11s02.html#components_of_the_host_resources_mib
    "Table 11-2. Components of the Host Resources MIB mib-2.host (RFC 2790)") summarizes
    the groups of the host MIB, and the most important MIB-II groups are introduced
    in [Table 11-1](../Text/ch11.html#mib-ii_groups_open_parenthesis_a_selecti "Table 11-1. MIB-II
    groups (a selection)") (page 231).
  id: totrans-1739
  prefs: []
  type: TYPE_NORMAL
  zh: 代理最初提供关于RFC 1213中描述的MIB-II的信息([11.1.1 管理信息库](../Text/ch11.html#the_management_information_base
    "11.1.1 管理信息库"，第229页)，以及属于此的RFC 2790（主机MIB）的扩展。[表11-2](../Text/ch11s02.html#components_of_the_host_resources_mib
    "表11-2. 主机资源MIB组件 mib-2.host (RFC 2790)")总结了主机MIB的组，并在[表11-1](../Text/ch11.html#mib-ii_groups_open_parenthesis_a_selecti
    "表11-1. MIB-II组（选择）")（第231页）中介绍了最重要的MIB-II组。
- en: If you are interested in a detailed description of the MIB-II, including the
    host MIB, we refer you to [http://www.snmplink.org/](http://www.snmplink.org/).
    There you can surf through a huge number of MIBs and download them if you wish.
  id: totrans-1740
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你感兴趣MIB-II的详细描述，包括主机MIB，我们推荐你访问[http://www.snmplink.org/](http://www.snmplink.org/)。在那里你可以浏览大量的MIB，如果你愿意，还可以下载它们。
- en: In addition to the basic MIB-II, the NET-SNMP implementation has its own extension
    at **`private.enterprises.ucdavis`** (UCD-SNMP-MIB). The directives given in [Table 11-3](../Text/ch11s02.html#extract_from_the_ucd-snmp-mib
    "Table 11-3. Extract from the UCD-SNMP-MIB") refer to instructions in the configuration
    file **`snmpd.conf`** (see [Supported Mangement Information Bases](../Text/ch11s02.html#supported_mangement_information_bases
    "Supported Mangement Information Bases")). Some of the information here is also
    given in the Host Resources MIB.
  id: totrans-1741
  prefs: []
  type: TYPE_NORMAL
  zh: 除了基本的MIB-II之外，NET-SNMP实现在其**`private.enterprises.ucdavis`**（UCD-SNMP-MIB）处有自己的扩展。在[表11-3](../Text/ch11s02.html#extract_from_the_ucd-snmp-mib
    "表11-3. UCD-SNMP-MIB的提取")中给出的指令指的是配置文件**`snmpd.conf`**（见[支持的管理信息库](../Text/ch11s02.html#supported_mangement_information_bases
    "支持的管理信息库")）中的指令。这里的一些信息也包含在主机资源MIB中。
- en: Table 11-2. Components of the Host Resources `MIB mib-2.host` (RFC 2790)
  id: totrans-1742
  prefs: []
  type: TYPE_NORMAL
  zh: 表11-2. 主机资源MIB `MIB mib-2.host`（RFC 2790）
- en: '| Group | OID | Description |'
  id: totrans-1743
  prefs: []
  type: TYPE_TB
  zh: '| 组 | OID | 描述 |'
- en: '| --- | --- | --- |'
  id: totrans-1744
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- |'
- en: '| hrSystem | host.1 | System time and uptime of the host, logged-in users,
    and number of active processes |'
  id: totrans-1745
  prefs: []
  type: TYPE_TB
  zh: '| hrSystem | host.1 | 主机系统时间和运行时间，登录用户和活动进程数量 |'
- en: '| hrStorage | host.2 | Details on all storage media such as swap, hard drives,
    removable media, and main memory |'
  id: totrans-1746
  prefs: []
  type: TYPE_TB
  zh: '| hrStorage | host.2 | 所有存储媒体的详细信息，如交换、硬盘驱动器、可移动媒体和主内存 |'
- en: '| hrDevice | host.3 | List of available devices and their properties: apart
    from details on the processor, network interfaces, printer and DVD-/CD-ROM drives,
    there is also information on hard drives, their partitioning, file systems, mount
    points and file system types |'
  id: totrans-1747
  prefs: []
  type: TYPE_TB
  zh: '| hrDevice | host.3 | 可用设备及其属性的列表：除了处理器、网络接口、打印机和DVD-/CD-ROM驱动器的详细信息外，还包括硬盘驱动器、它们的分区、文件系统、挂载点和文件系统类型
    |'
- en: '| hrSWRun | host.4 | All running processes including PID and command line parameters
    |'
  id: totrans-1748
  prefs: []
  type: TYPE_TB
  zh: '| hrSWRun | host.4 | 包括PID和命令行参数的所有运行进程 |'
- en: '| hrSWRunPerf | host.5 | CPU usage and memory usage for the processes from
    hrSWRun |'
  id: totrans-1749
  prefs: []
  type: TYPE_TB
  zh: '| hrSWRunPerf | host.5 | 来自hrSWRun的进程的CPU使用率和内存使用率 |'
- en: '| hrSWInstalled | host.6 | Installed software; the information originates from
    the RPM database (unfortunately this does not work in Debian). |'
  id: totrans-1750
  prefs: []
  type: TYPE_TB
  zh: '| hrSWInstalled | host.6 | 已安装的软件；信息来源于RPM数据库（不幸的是，这在Debian中不起作用）。 |'
- en: Table 11-3. Extract from the UCD-SNMP-MIB
  id: totrans-1751
  prefs: []
  type: TYPE_NORMAL
  zh: 表11-3. UCD-SNMP-MIB的摘录
- en: '| **`Group`** | **`OID`** | **`Directive`** | **`description`** |'
  id: totrans-1752
  prefs: []
  type: TYPE_TB
  zh: '| **`Group`** | **`OID`** | **`Directive`** | **`description`** |'
- en: '| --- | --- | --- | --- |'
  id: totrans-1753
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- | --- |'
- en: '| prTable | ucdavis.2 | **`proc`** | details of running processes |'
  id: totrans-1754
  prefs: []
  type: TYPE_TB
  zh: '| prTable | ucdavis.2 | **`proc`** | 运行进程的详细信息 |'
- en: '| memory | ucdavis.4 | - | Memory and Swap space load, as in the program **`free`**
    |'
  id: totrans-1755
  prefs: []
  type: TYPE_TB
  zh: '| memory | ucdavis.4 | - | 内存和交换空间负载，如程序**`free`**所示 |'
- en: '| extTable | ucdavis.8 | **`exec`** | Information on self-defined commands
    in the configuration file ^([[a](#ftn.CHP-11-FN-5)]) |'
  id: totrans-1756
  prefs: []
  type: TYPE_TB
  zh: '| extTable | ucdavis.8 | **`exec`** | 关于配置文件中自定义命令的信息 ^([[a](#ftn.CHP-11-FN-5)])
    |'
- en: '| dskTable | ucdavis.9 | **`disk`** | Information on file systems, see example
    in the text |'
  id: totrans-1757
  prefs: []
  type: TYPE_TB
  zh: '| dskTable | ucdavis.9 | **`disk`** | 关于文件系统的信息，请参见文本中的示例 |'
- en: '| laTable | ucdavis.10 | **`load`** | System load |'
  id: totrans-1758
  prefs: []
  type: TYPE_TB
  zh: '| laTable | ucdavis.10 | **`load`** | 系统负载 |'
- en: '| ucdExper- | ucdavis.13 | - | Experimental extension containing an entry with
    lm-sensor information, among other things |'
  id: totrans-1759
  prefs: []
  type: TYPE_TB
  zh: '| ucdExper- | ucdavis.13 | - | 包含lm-sensor信息条目的实验性扩展，等等 |'
- en: '| fileTable | ucdavis.15 | **`file`** | Information on files to be explicitly
    monitored |'
  id: totrans-1760
  prefs: []
  type: TYPE_TB
  zh: '| fileTable | ucdavis.15 | **`file`** | 关于要显式监控的文件的信息 |'
- en: '| version | ucdavis.100 - | - | Details on the NET-SNMP version and the parameters
    with which the daemon was compiled |'
  id: totrans-1761
  prefs: []
  type: TYPE_TB
  zh: '| version | ucdavis.100 - | - | 关于NET-SNMP版本和编译守护进程的参数的详细信息 |'
- en: '|'
  id: totrans-1762
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: ^([[a](#CHP-11-FN-5)]) Any executable programs can be used here.
  id: totrans-1763
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[a](#CHP-11-FN-5)]) 这里可以使用任何可执行程序。
- en: '|'
  id: totrans-1764
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: 'While **`mib-2.host`** only specifies absolute values, such as for file systems,
    UCD-SNMP-MIB also allows threshold values to be set for agent pages, which then
    explicitly generate an error value (**`dskErrorFlag`**) with error text (**`dskErrorMsg`**):'
  id: totrans-1765
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然**`mib-2.host`**仅指定绝对值，例如文件系统，但UCD-SNMP-MIB还允许为代理页面设置阈值值，然后明确生成一个错误值（**`dskErrorFlag`**）和错误文本（**`dskErrorMsg`**）：
- en: '[PRE211]'
  id: totrans-1766
  prefs: []
  type: TYPE_PRE
  zh: '[PRE211]'
- en: The **`grep '. 2 ='`** filters all entries on the second device from the **`snmpwalk`**
    output, the Linux software-RAID **`/dev/md6`**. The entry **`dskPercent`** shows
    the current load of this data medium. An error exists if **`dskErrorFlag`** contains
    the value 1 instead of 0; **`dskErrorMsg`** adds a readable message to the error
    message. It can be assumed from this that the agent is being configured so that
    it will announce an error if free capacity falls below 10 percent.
  id: totrans-1767
  prefs: []
  type: TYPE_NORMAL
  zh: '**`grep ''. 2 =''`**过滤器从**`snmpwalk`**输出中过滤出第二台设备的所有条目，Linux软件RAID **`/dev/md6`**。条目**`dskPercent`**显示此数据媒体的当前负载。如果**`dskErrorFlag`**包含值1而不是0，则存在错误；**`dskErrorMsg`**向错误消息添加可读的消息。可以假设代理正在配置为在可用容量低于10%时宣布错误。'
- en: The configuration file **`snmpd.conf`**
  id: totrans-1768
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**`snmpd.conf`**配置文件'
- en: Configuring the agent is done in the file **`snmpd.conf`**, which is either
    located in the directory **`/etc`** directly (the case for SUSE) or in **`/etc/snmp`**
    (Debian), depending on the distribution.
  id: totrans-1769
  prefs: []
  type: TYPE_NORMAL
  zh: 代理的配置在文件**`snmpd.conf`**中完成，该文件位于目录**`/etc`**中（适用于SUSE的情况）或**`/etc/snmp`**（Debian），具体取决于发行版。
- en: '`Authentication and security` As the first step towards a finely tuned access
    control, you first need to define who should have access to which community:'
  id: totrans-1770
  prefs: []
  type: TYPE_NORMAL
  zh: '`身份验证和安全` 作为精细访问控制的第一步，您首先需要定义谁应该有权访问哪个社区：'
- en: '[PRE212]'
  id: totrans-1771
  prefs: []
  type: TYPE_PRE
  zh: '[PRE212]'
- en: '**`com2sec`** links the source IP addresses to a community string (the SNMP
    password). This keyword is followed by an alias for the IP address range, the
    address range itself, and then a freely selectable community string, for which
    we will use **`public`** here, to keep things simple.^([[108](#ftn.CHP-11-FN-6)]).
    **`192.168.1.0/24`** refers to the local network; the Nagios server itself has
    the IP address **`192.168.1.9`**. If you set access permissions for the alias
    **`localnet`** later on, they will apply to the entire local network **`192.168.1.0/24`**,
    but if you reference **`nagiossrv`** when doing this, they will only apply to
    the Nagios server itself.'
  id: totrans-1772
  prefs: []
  type: TYPE_NORMAL
  zh: '**`com2sec`** 将源IP地址链接到一个社区字符串（SNMP密码）。此关键字后跟IP地址范围的别名，地址范围本身，然后是一个自由选择的社区字符串，我们将使用
    **`public`** 以保持简单.^([[108](#ftn.CHP-11-FN-6)]）。**`192.168.1.0/24`** 指的是本地网络；Nagios服务器本身的IP地址为
    **`192.168.1.9`**。如果您稍后设置别名 **`localnet`** 的访问权限，它们将应用于整个本地网络 **`192.168.1.0/24`**，但如果您引用
    **`nagiossrv`**，则它们仅应用于Nagios服务器本身。'
- en: 'Then the defined computers and networks are assigned via their aliases to groups
    which have different security models:'
  id: totrans-1773
  prefs: []
  type: TYPE_NORMAL
  zh: 然后将定义的计算机和网络通过它们的别名分配给具有不同安全模型的组：
- en: '[PRE213]'
  id: totrans-1774
  prefs: []
  type: TYPE_PRE
  zh: '[PRE213]'
- en: 'The keyword **`group`** is followed first by a freely selectable group name:
    here we define the group **`Local`** with the security model **`v1`**, which belongs
    to the address range defined as **`localhost`**, and the group **`Nagios`** with
    the same security model contained in the Nagios server.'
  id: totrans-1775
  prefs: []
  type: TYPE_NORMAL
  zh: 关键词 **`group`** 首先跟一个自由选择的组名：在这里我们定义了名为 **`Local`** 的组，其安全模型为 **`v1`**，属于地址范围
    **`localhost`**，以及具有相同安全模型的 **`Nagios`** 组，该组包含在Nagios服务器中。
- en: 'You can choose from **`v1`** (SNMPv1), **`v2c`** (community-based SNMPv2),
    and **`usm`** (the *User Model* from SNMPv3) as the security model. If you assign
    a computer or a network several security models at the same time, then separate
    entries with the same group name are required:'
  id: totrans-1776
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以选择 **`v1`**（SNMPv1）、**`v2c`**（基于社区的SNMPv2）和 **`usm`**（SNMPv3的 *用户模型*）作为安全模型。如果您同时分配给计算机或网络多个安全模型，则需要具有相同组名的单独条目：
- en: '[PRE214]'
  id: totrans-1777
  prefs: []
  type: TYPE_PRE
  zh: '[PRE214]'
- en: 'With the definition of views (keyword **`view`**) the view from the outside
    can be restricted precisely to partial trees of the Management Information Base.
    Each view here is also given a name for referencing:'
  id: totrans-1778
  prefs: []
  type: TYPE_NORMAL
  zh: 通过定义视图（关键字 **`view`**），可以从外部精确限制对管理信息库的部分树的视图。每个视图也都有一个名称用于引用：
- en: '[PRE215]'
  id: totrans-1779
  prefs: []
  type: TYPE_PRE
  zh: '[PRE215]'
- en: 'The reference **`included`** includes the following partial tree in the view.
    Thus the view **`all`** covers the entire tree (**`.1`**). If you want to exclude
    certain partial trees in this, then the keyword **`excluded`** is used:'
  id: totrans-1780
  prefs: []
  type: TYPE_NORMAL
  zh: 引用 **`included`** 包含视图中的以下部分树。因此视图 **`all`** 覆盖整个树（**`.1`**）。如果您想排除某些部分树，则使用关键字
    **`excluded`**：
- en: '[PRE216]'
  id: totrans-1781
  prefs: []
  type: TYPE_PRE
  zh: '[PRE216]'
- en: The partial tree beneath **`private`** in **`all`** is now blocked, such as
    the MIB **`ucdavis (private.enterprises.ucdavis`**).
  id: totrans-1782
  prefs: []
  type: TYPE_NORMAL
  zh: 在 **`all`** 下的 **`private`** 下的部分树现在已被阻止，例如MIB **`ucdavis (private.enterprises.ucdavis`**）。
- en: 'One interesting feature is the mask; it specifies in hexadecimal notation which
    nodes correspond exactly to the subtree:'
  id: totrans-1783
  prefs: []
  type: TYPE_NORMAL
  zh: 一个有趣的功能是掩码；它以十六进制表示法指定哪些节点正好对应于子树：
- en: '[PRE217]'
  id: totrans-1784
  prefs: []
  type: TYPE_PRE
  zh: '[PRE217]'
- en: All places of the queried OID, for which the mask contains a 1 in binary notation,
    must be identical in the queried partial tree to the OID specified here, **`.iso.org.dod.internet.mgmt`**,
    otherwise the daemon will refuse access and not provide any information. **`.iso.org.dod.internet.mgmt`**
    is written numerically as **`.1.3.6.1.2`**.
  id: totrans-1785
  prefs: []
  type: TYPE_NORMAL
  zh: 对于查询的OID的所有位置，如果掩码以二进制表示法包含1，则必须在查询的部分树中与这里指定的OID **`.iso.org.dod.internet.mgmt`**
    相同，否则守护进程将拒绝访问且不提供任何信息。**`.iso.org.dod.internet.mgmt`** 以数值形式表示为 **`.1.3.6.1.2`**。
- en: Thanks to the mask **`F8`**,^([[109](#ftn.CHP-11-FN-7)]) binary 11111000, the
    first five places from the left in the OID must always be **`.iso.org.dod.internet.mgmt`**.
    If somebody queried an OID (such as the **`private`** tree **`.1.3.6.1.4`**),
    which deviates from this, the agent would remain silent and not provide any information.
    If you leave out the mask detail, **`FF`** will be used.
  id: totrans-1786
  prefs: []
  type: TYPE_NORMAL
  zh: 多亏了掩码 **`F8`**，^([[109](#ftn.CHP-11-FN-7)]) 二进制 11111000，OID的最左边五个位置必须始终是 **`.iso.org.dod.internet.mgmt`**。如果有人查询了一个OID（例如
    **`private`** 树 **`.1.3.6.1.4`**），它偏离了这一点，代理将保持沉默且不提供任何信息。如果您省略掩码细节，将使用 **`FF`**。
- en: 'If you have defined the alias, community, security model, and view, you just
    need to bring them together for the purpose of access control. This is done with
    the **`access`** instruction:'
  id: totrans-1787
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您已定义了别名、社区、安全模型和视图，您只需将它们组合起来用于访问控制。这是通过 **`access`** 指令完成的。
- en: '[PRE218]'
  id: totrans-1788
  prefs: []
  type: TYPE_PRE
  zh: '[PRE218]'
- en: The access restrictions are bound to the group. The **`context`** column remains
    empty (**`'""`**), since only SNMPv3 requires it.^([[110](#ftn.CHP-11-FN-8)]).
    As the security model, you then normally choose **`any`**, but you may define
    a specific model with **`v1`**, **`v2c`** or **`usm`**, since several different
    security models may be assigned to a group, as shown in the discussion of "Authentication
    and Security" at the beginning of this Section. The fifth column specifies the
    security level, which is also of interest only for SNMPv3\. In the other two security
    models (we are only using **`v1`**), **`noauth`** is given here. The fourth last
    column also has just one meaning in SNMPv3\. But since you must enter a valid
    value forSNMPv1 and SNMPv2c as well, then **`exact`** is chosen here.
  id: totrans-1789
  prefs: []
  type: TYPE_NORMAL
  zh: 访问限制绑定到组。**`context`** 列保持为空（**`'""`**），因为只有SNMPv3需要它.^([[110](#ftn.CHP-11-FN-8)]）。作为安全模型，你通常选择
    **`any`**，但你也可以使用 **`v1`**、**`v2c`** 或 **`usm`** 定义一个特定的模型，因为可能将多个不同的安全模型分配给一个组，如本节开头“身份验证和安全”讨论中所示。第五列指定了安全级别，这对于SNMPv3也是感兴趣的。在其他两种安全模型（我们只使用
    **`v1`**）中，**`noauth`** 被给出。第四列最后一列在SNMPv3中也有唯一的意义。但由于你必须为SNMPv1和SNMPv2c输入有效的值，因此这里选择
    **`exact`**。
- en: 'The last two columns specify which view should be used for which access (read
    or write). In the example, the groups **`Local`** and **`NagiosGrp`** obtain read
    access for the view **`all`**, but no write access. The final column defines whether
    the agent should send SNMP traps—that is, active messages, to the manager—for
    events that occur within the range of validity of the view. [14.6 Application
    Example II: Processing SNMP Traps](../Text/ch14s06.html "14.6 Application Example
    II: Processing SNMP Traps") from page 312 goes into more detail about SNMP traps.'
  id: totrans-1790
  prefs: []
  type: TYPE_NORMAL
  zh: 最后两列指定了哪种视图应该用于哪种访问（读取或写入）。在示例中，组 **`Local`** 和 **`NagiosGrp`** 获得了对视图 **`all`**
    的读取访问，但没有写入访问。最后一列定义了代理是否应该为视图有效范围内发生的事件向管理器发送SNMP陷阱——即主动消息。[14.6 应用示例II：处理SNMP陷阱](../Text/ch14s06.html
    "14.6 应用示例II：处理SNMP陷阱") 从第312页更详细地介绍了SNMP陷阱。
- en: With the configuration described here, you can now exclusively access the Nagios
    server and **`localhost`** via SNMPv1 for information. The server access can be
    restricted further by defining a view that makes only parts of the MIB visible.
    But you should only try this once the configuration described is working, to avoid
    logical errors and time-consuming debugging.
  id: totrans-1791
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这里描述的配置，你现在可以通过SNMPv1独家访问Nagios服务器和 **`localhost`** 以获取信息。可以通过定义一个只使MIB的部分可见的视图进一步限制服务器访问。但你应该在配置描述正常工作后尝试此操作，以避免逻辑错误和耗时的调试。
- en: '`System and local information` The partial tree **`mib-2.system`** provides
    information on the system itself and on the available (that is, implemented) MIBs.
    With **`syslocation`** you can specify where a system is located in the company
    or on the campus, and after the keyword **`syscontact`** you enter the e-mail
    address of the administrator responsible:'
  id: totrans-1792
  prefs: []
  type: TYPE_NORMAL
  zh: '`系统与本地信息` 部分树 **`mib-2.system`** 提供了关于系统本身以及可用的（即已实现的）MIBs的信息。使用 **`syslocation`**
    你可以指定系统在公司或校园中的位置，并在关键字 **`syscontact`** 后输入负责管理员的电子邮件地址：'
- en: '[PRE219]'
  id: totrans-1793
  prefs: []
  type: TYPE_PRE
  zh: '[PRE219]'
- en: 'As long as you do not redefine the parameters **`sysname`** and **`sysdescr`**
    at this point, the corresponding MIBs in the default will reveal the host name
    and/or the system and kernel specification, corresponding to **`uname -a`**:'
  id: totrans-1794
  prefs: []
  type: TYPE_NORMAL
  zh: 只要在此处不重新定义参数 **`sysname`** 和 **`sysdescr`**，默认情况下相应的MIBs将揭示主机名和/或系统和内核规范，对应于
    **`uname -a`**：
- en: '[PRE220]'
  id: totrans-1795
  prefs: []
  type: TYPE_PRE
  zh: '[PRE220]'
- en: '`Defining processes to be monitored` Processes that you want to monitor using
    SNMP are specified with the **`proc`** directive, and if required you can specify
    the minimum or maximum number of processes:'
  id: totrans-1796
  prefs: []
  type: TYPE_NORMAL
  zh: '`定义要监控的进程` 使用SNMP监控的进程通过 **`proc`** 指令指定，如果需要，你可以指定进程的最小或最大数量：'
- en: '[PRE221]'
  id: totrans-1797
  prefs: []
  type: TYPE_PRE
  zh: '[PRE221]'
- en: 'If the entry for maximum and minimum is missing, at least one process must
    be running. If only the minimum is omitted, NET-SNMP will define this with zero
    processes. The corresponding entries end up in the MIB **`ucdavis.prTable`**;
    in case of error you will receive an error flag (**`prError-Flag`** and an error
    description (**`prErrMessage`**) (which unfortunately you cannot define yourself):'
  id: totrans-1798
  prefs: []
  type: TYPE_NORMAL
  zh: 如果缺少最大和最小值的条目，至少必须有一个进程正在运行。如果只省略了最小值，NET-SNMP将使用零进程定义此值。相应的条目最终会出现在MIB **`ucdavis.prTable`**
    中；在出错的情况下，你会收到一个错误标志（**`prError-Flag`** 和错误描述（**`prErrMessage`**）（遗憾的是，你不能自己定义它））：
- en: '[PRE222]'
  id: totrans-1799
  prefs: []
  type: TYPE_PRE
  zh: '[PRE222]'
- en: '**`ucdavis. prTable`** only reveals the configured processes; on the other
    hand it allows **`mib-2.host.hrSWRun`** and **`mib-2.host.hrSWRunPerf`** in general
    to query all running processes. If you want to prevent this, the view must exclude
    the area you do not want.'
  id: totrans-1800
  prefs: []
  type: TYPE_NORMAL
  zh: '**`ucdavis. prTable`** 仅显示已配置的进程；另一方面，它允许 **`mib-2.host.hrSWRun`** 和 **`mib-2.host.hrSWRunPerf`**
    通常查询所有运行进程。如果您想防止这种情况，视图必须排除您不希望包含的区域。'
- en: '`Your own commands` With the **`exec`** directive you can specify commands
    in the extension **`ucdavis.extTable`**, which the agent will execute in the corresponding
    queries. The result then appears in the relevant entries. In the following example
    the agent calls **`/bin/echo`** if it is asked for **`ucdavis.extTable`**:'
  id: totrans-1801
  prefs: []
  type: TYPE_NORMAL
  zh: '`您的自定义命令` 使用 **`exec`** 指令，您可以在扩展 **`ucdavis.extTable`** 中指定命令，代理将在相应的查询中执行这些命令。结果随后将出现在相关条目中。在以下示例中，如果代理被要求查询
    **`ucdavis.extTable`**，它将调用 **`/bin/echo`**：'
- en: '[PRE223]'
  id: totrans-1802
  prefs: []
  type: TYPE_PRE
  zh: '[PRE223]'
- en: 'The program to be executed must appear with its absolute path in the configuration.
    Running **`snmpwalk`** provides only the following:'
  id: totrans-1803
  prefs: []
  type: TYPE_NORMAL
  zh: 要执行的程序必须在配置中以其绝对路径出现。运行 **`snmpwalk`** 只提供以下信息：
- en: '[PRE224]'
  id: totrans-1804
  prefs: []
  type: TYPE_PRE
  zh: '[PRE224]'
- en: '**`extTable.extEntry.extResult`** contains the return value of the command
    executed, and **`extTable.extEntry.extOutput`** contains the text output.'
  id: totrans-1805
  prefs: []
  type: TYPE_NORMAL
  zh: '**`extTable.extEntry.extResult`** 包含执行命令的返回值，而 **`extTable.extEntry.extOutput`**
    包含文本输出。'
- en: 'With the **`exec`** directive you can thus query everything that a local script
    or program can find out. This could be a security problem, however: if the programs
    used are susceptible to buffer overflows, this feature could be misused as a starting
    point for a denial-of-service attack.'
  id: totrans-1806
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，使用 **`exec`** 指令可以查询本地脚本或程序可以找到的所有信息。然而，这可能会成为一个安全问题：如果使用的程序容易受到缓冲区溢出的影响，这个功能可能会被误用作为拒绝服务攻击的起点。
- en: '`Monitoring hard drive capacity` The **`disk`** directive is suitable for monitoring
    file systems. The keyword **`disk`** is followed by the path for a mount point,
    and then the minimum hard drive space in KB or in percent that should be available.
    If you omit the capacity entry, at least 100 MB must be available; otherwise an
    error message will be given.'
  id: totrans-1807
  prefs: []
  type: TYPE_NORMAL
  zh: 监控硬盘容量：**`disk`** 指令适用于监控文件系统。关键字 **`disk`** 后跟挂载点的路径，然后是应可用的最小硬盘空间（以 KB 或百分比表示）。如果您省略容量条目，至少必须有
    100 MB 可用；否则将给出错误消息。
- en: 'In the following example the free capacity in the **`/`** file system should
    not drop below **`10%`** and on **`/usr`**, at least 800 MB ^([[111](#ftn.CHP-11-FN-9)])
    should remain free:'
  id: totrans-1808
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下示例中，**`/`** 文件系统的空闲容量不应低于 **`10%`**，在 **`/usr`** 上，至少应保留 800 MB 的空闲空间 ^([[111](#ftn.CHP-11-FN-9)])：
- en: '[PRE225]'
  id: totrans-1809
  prefs: []
  type: TYPE_PRE
  zh: '[PRE225]'
- en: 'As far as the data partition **`/data`** is concerned, the alarm should be
    raised if free capacity falls below **`50%. dskErrorFlag`** in this case contains
    the value 1 instead of 0, and **`dskErrorMsg`** contains an error text:'
  id: totrans-1810
  prefs: []
  type: TYPE_NORMAL
  zh: 就数据分区 **`/data`** 而言，如果空闲容量低于 **`50%. dskErrorFlag`**，则应发出警报：在这种情况下，`dskErrorFlag`
    的值应为 1 而不是 0，`dskErrorMsg` 包含错误文本：
- en: '[PRE226]'
  id: totrans-1811
  prefs: []
  type: TYPE_PRE
  zh: '[PRE226]'
- en: '**`dskPercent`** reveals a current load of **`65%`**. Instead of the partial
    tree configured here, **`ucdavis.dskTable, mib-2.host.hrStorage`** also provides
    an overview of all file systems, even those not explicitly defined. These are
    missing percentage details, however, and you do not receive an error status or
    error message, as supplied by **`ucdavis.dskTable`**.'
  id: totrans-1812
  prefs: []
  type: TYPE_NORMAL
  zh: '**`dskPercent`** 显示当前负载为 **`65%`**。除了此处配置的部分树外，**`ucdavis.dskTable, mib-2.host.hrStorage`**
    还提供了所有文件系统的概述，包括那些未明确定义的文件系统。然而，这些文件系统缺少百分比细节，并且您不会收到 **`ucdavis.dskTable`** 提供的错误状态或错误消息。'
- en: 'You should think hard about whether you set the warning limit in the NET-SNMP
    or in the Nagios configuration. In the first case you must configure the values
    on each individual host. If you query the percentage load, however, with the **`check_snmp`**
    plugin (see [11.3.1 The generic SNMP plugin check_snmp](../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp
    "11.3.1 The generic SNMP plugin check_snmp") from page 246), then you set warning
    and critical limits centrally on the Nagios server, saving yourself a lot of work
    if you make changes later on. The **`includeAHDisks`** directive adds all existing
    file systems to the **`dskTable`** table:'
  id: totrans-1813
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该仔细考虑是否在 NET-SNMP 或 Nagios 配置中设置警告限制。在前一种情况下，您必须在每个单独的主机上配置值。但是，如果您使用 **`check_snmp`**
    插件（见第 246 页的 [11.3.1 通用 SNMP 插件 check_snmp](../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp
    "11.3.1 通用 SNMP 插件 check_snmp")）查询百分比负载，那么您将在 Nagios 服务器上集中设置警告和临界限制，如果以后进行更改，这将节省您大量工作。**`includeAHDisks`**
    指令将所有现有文件系统添加到 **`dskTable`** 表中：
- en: '[PRE227]'
  id: totrans-1814
  prefs: []
  type: TYPE_PRE
  zh: '[PRE227]'
- en: It requires a minimum limit to be specified in percent, and also returns error
    values. An absolute specification in KB is not possible here. If you set warning
    and error limits centrally for **`check_snmp`**; (see [11.3.1 The generic SNMP
    plugin check_snmp](../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp "11.3.1
    The generic SNMP plugin check_snmp") from page 246) the error attributes **`dskErrorFlag`**
    and **`dskErrorMsg`** are not queried, so that the value set here as the minimum
    limit can be ignored.
  id: totrans-1815
  prefs: []
  type: TYPE_NORMAL
  zh: 它需要指定一个最小限制值（以百分比表示），并返回错误值。在这里无法进行绝对KB的指定。如果您为**`check_snmp`**集中设置警告和错误限制；（参见[11.3.1
    通用SNMP插件check_snmp](../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp "11.3.1
    通用SNMP插件check_snmp")，从第246页开始）则不会查询错误属性**`dskErrorFlag`**和**`dskErrorMsg`**，因此这里设置的最低限制值可以忽略。
- en: '`System load` The **`load`** directive queries the CPU load. As the limit values,
    you specify the average values for one minute, and optionally for five and 15
    minutes:'
  id: totrans-1816
  prefs: []
  type: TYPE_NORMAL
  zh: '`系统负载` **`load`** 指令查询CPU负载。作为限制值，您指定一分钟的平均值，可选的五分钟和十五分钟的平均值：'
- en: '[PRE228]'
  id: totrans-1817
  prefs: []
  type: TYPE_PRE
  zh: '[PRE228]'
- en: 'If the values are overstepped, **`laErrorFlag`** will contain the status **`1`**
    (otherwise: **`0`**) and **`laErrMessage`** will have the text of the error message.'
  id: totrans-1818
  prefs: []
  type: TYPE_NORMAL
  zh: 如果值超出范围，**`laErrorFlag`** 将包含状态 **`1`**（否则：**`0`**），而 **`laErrMessage`** 将包含错误信息的文本。
- en: 'In a system that exceeds one of the specified limits, **`snmpwalk`** returns
    the following:'
  id: totrans-1819
  prefs: []
  type: TYPE_NORMAL
  zh: 在超过指定限制的系统上，**`snmpwalk`** 返回以下内容：
- en: '[PRE229]'
  id: totrans-1820
  prefs: []
  type: TYPE_PRE
  zh: '[PRE229]'
- en: From **`laLoadlnt.1`** we are told the one-minute average value for the system
    **`load`** as an integer, from **`laLoad.l`** as a string, and from **`laLoadFloat.1`**
    as a floating-point decimal. **`laErrorFlag.1`** contains the corresponding error
    status, **`laErrMessage.1`** the corresponding error message. The same applies
    for the other two averages.
  id: totrans-1821
  prefs: []
  type: TYPE_NORMAL
  zh: 从 **`laLoadlnt.1`** 我们得知系统 **`load`** 的一分钟平均值为整数，从 **`laLoad.l`** 作为字符串，从 **`laLoadFloat.1`**
    作为浮点十进制。**`laErrorFlag.1`** 包含相应的错误状态，**`laErrMessage.1`** 包含相应的错误信息。其他两个平均值也适用同样的规则。
- en: You can also use the **`check_snmp`** plugin here to query the floating-point
    decimal values just as accurately, and specify limit values centrally.
  id: totrans-1822
  prefs: []
  type: TYPE_NORMAL
  zh: 您也可以在这里使用**`check_snmp`**插件，以极高的精度查询浮点十进制值，并集中指定限制值。
- en: '* * *'
  id: totrans-1823
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[106](#CHP-11-FN-3)]) [http://net-snmp.sourceforge.net/](http://net-snmp.sourceforge.net/)
  id: totrans-1824
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[106](#CHP-11-FN-3)]) [http://net-snmp.sourceforge.net/](http://net-snmp.sourceforge.net/)
- en: ^([[107](#CHP-11-FN-4)]) [http://www.kill-9.org/mbrowse/](http://www.kill-9.org/mbrowse/)
  id: totrans-1825
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[107](#CHP-11-FN-4)]) [http://www.kill-9.org/mbrowse/](http://www.kill-9.org/mbrowse/)
- en: ^([[108](#CHP-11-FN-6)]) See also page 236
  id: totrans-1826
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[108](#CHP-11-FN-6)]) 参见第236页
- en: ^([[109](#CHP-11-FN-7)]) F= 1.2³+1.2²+1.2¹ +1.2⁰ = 1111, 8=1000
  id: totrans-1827
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[109](#CHP-11-FN-7)]) F= 1.2³+1.2²+1.2¹ +1.2⁰ = 1111, 8=1000
- en: ^([[110](#CHP-11-FN-8)]) Corresponding descriptions on SNMPv3 would go beyond
    the bounds of this book
  id: totrans-1828
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[110](#CHP-11-FN-8)]) 关于SNMPv3的相应描述将超出本书的范围
- en: ^([[111](#CHP-11-FN-9)]) 1024KB * 800
  id: totrans-1829
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[111](#CHP-11-FN-9)]) 1024KB * 800
- en: 11.3 Nagios's Own SNMP Plugins
  id: totrans-1830
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 11.3 Nagios自带的SNMP插件
- en: 'Among the standard Nagios plugins there are three programs with which data
    can be obtained via SNMP: a generic plugin that queries any OIDs you want, and
    two Perl scripts that are specialized in interface data of network cards and the
    ports of switches, routers and so forth. In addition to this, the directory **`contrib`**
    contains the source code of other SNMP plugins that are not automatically installed.
    Apparently these are no longer maintained and cannot run without major adjustments
    to the code.'
  id: totrans-1831
  prefs: []
  type: TYPE_NORMAL
  zh: 在标准Nagios插件中，有三个程序可以通过SNMP获取数据：一个通用的插件可以查询您想要的任何OID，以及两个专门处理网络卡接口数据和交换机、路由器等端口信息的Perl脚本。此外，**`contrib`**
    目录包含其他未自动安装的SNMP插件源代码。显然，这些插件已经不再维护，并且需要代码的重大调整才能运行。
- en: '[http://www.nagiosexchange.org/](http://www.nagiosexchange.org/) also provides
    some useful specialized plugins, some of which are introduced in [11.4 Other SNMP-based
    Plugins](../Text/ch11s04.html "11.4 Other SNMP-based Plugins") from page 255\.
    The following descriptions are limited, for reasons of space, to SNMPv1/2 queries;
    for SNMPv3-specific options, we refer you to the online help for the corresponding
    plugin.'
  id: totrans-1832
  prefs: []
  type: TYPE_NORMAL
  zh: '[http://www.nagiosexchange.org/](http://www.nagiosexchange.org/) 也提供了一些有用的专用插件，其中一些在[11.4
    其他基于SNMP的插件](../Text/ch11s04.html "11.4 其他基于SNMP的插件")中介绍，从第255页开始。由于篇幅限制，以下描述仅限于SNMPv1/2查询；对于SNMPv3特定的选项，请参阅相应插件的在线帮助。'
- en: 11.3.1 The generic SNMP plugin **`check_snmp`**
  id: totrans-1833
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.3.1 通用SNMP插件 **`check_snmp`**
- en: With **`check_snmp`** a generic plugin is available that queries all available
    information via SNMP, according to your requirements. However, its operation does
    require a degree of care, since as a generic plugin, it has no idea of specifically
    what data it is querying.
  id: totrans-1834
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**`check_snmp`**，有一个通用的插件可以查询所有可用的信息，根据您的要求。然而，它的操作确实需要一定的谨慎，因为作为一个通用插件，它不知道它具体查询的是什么数据。
- en: For this reason as well, its output looks quite meager; specialized plugins
    provide more convenience here. But since these don't exist for every purpose,
    **`check_snmp`** is then quite justified. It calls the program **`snmpget`** auf,
    which means that the NET-SNMP tools must be installed.
  id: totrans-1835
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，其输出看起来相当简陋；专门的插件在这里提供了更多便利。但是，由于并非每个目的都有这些插件，因此**`check_snmp`**的使用是相当合理的。它调用程序**`snmpget`**，这意味着必须安装NET-SNMP工具。
- en: 'It provides the following options:'
  id: totrans-1836
  prefs: []
  type: TYPE_NORMAL
  zh: 它提供了以下选项：
- en: '**`-H`** **``*`address`*``**/ **`--host=`****``*`address`*``**'
  id: totrans-1837
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``**/ **`--host=`****``*`address`*``**'
- en: This is the host name or IP address of the SNMP agent to be queried.
  id: totrans-1838
  prefs: []
  type: TYPE_NORMAL
  zh: 这是将被查询的SNMP代理的主机名或IP地址。
- en: '**`-o`** **``*`OID`*``** /**`--oid=`****``*`OID`*``**'
  id: totrans-1839
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-o`** **``*`OID`*``** /**`--oid=`****``*`OID`*``**'
- en: This is the object identifier to be queried, either as a complete numerical
    OID or as a string, which is interpreted by **`snmpget`** (e.g., **`system.sysName.O`**).
  id: totrans-1840
  prefs: []
  type: TYPE_NORMAL
  zh: 这是将被查询的对象标识符，可以是完整的数值OID，也可以是字符串，由**`snmpget`**解释（例如，**`system.sysName.O`**）。
- en: 'Attention: in contrast to **`snmpwalk`**, you must always specify the end nodes
    containing the information.'
  id: totrans-1841
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：与**`snmpwalk`**不同，您必须始终指定包含信息的端节点。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-1842
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: This is the alternative port on which the SNMP agent is running. The default
    is UDP port 161.
  id: totrans-1843
  prefs: []
  type: TYPE_NORMAL
  zh: 这是SNMP代理运行的备用端口。默认为UDP端口161。
- en: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
  id: totrans-1844
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
- en: This is the community string for read access. The default value is **`public`**.
  id: totrans-1845
  prefs: []
  type: TYPE_NORMAL
  zh: 这是读取访问的社区字符串。默认值为**`public`**。
- en: '**`-w`** **``*`start:end`*``** **`/ --warning=`****``*`start:end`*``**'
  id: totrans-1846
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`start:end`*``** **`/ --warning=`****``*`start:end`*``**'
- en: If the queried value lies within the range specified by *start* and *end*, **`check_snmp`**
    does not give out a warning. For **`-w 0:90`** it must therefore be larger than
    0 and smaller than 90.
  id: totrans-1847
  prefs: []
  type: TYPE_NORMAL
  zh: 如果查询值在由*start*和*end*指定的范围内，**`check_snmp`**不会输出警告。因此，对于**`-w 0:90`**，它必须大于0且小于90。
- en: '**`-c`** **``*`start:end`*``** **`/ --critical=`****``*`start:end`*``**'
  id: totrans-1848
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`start:end`*``** **`/ --critical=`****``*`start:end`*``**'
- en: If the query value lies outside the range, the plugin gives out CRITICAL. If
    the warning and critical limits overlap, the critical limit always has priority
  id: totrans-1849
  prefs: []
  type: TYPE_NORMAL
  zh: 如果查询值超出范围，插件将输出CRITICAL。如果警告和临界限制重叠，则临界限制始终具有优先级
- en: '**`-s`** **``*`string`*``** **`/ --string=`****``*`string`*``**'
  id: totrans-1850
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-s`** **``*`string`*``** **`/ --string=`****``*`string`*``**'
- en: The contents of the queried OID must correspond exactly to the specified *string*,
    otherwise **`check_snmp`** will give out an error.
  id: totrans-1851
  prefs: []
  type: TYPE_NORMAL
  zh: 查询的OID内容必须与指定的*字符串*完全匹配，否则**`check_snmp`**将输出错误。
- en: '**`-r`** **``*`regexp`*``** **`/ --ereg=`****``*`regexp`*``**'
  id: totrans-1852
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** **``*`regexp`*``** **`/ --ereg=`****``*`regexp`*``**'
- en: This option checks the contents of the queried OID to see whether the regular
    expression *regexp*^([[112](#ftn.CHP-11-FN-10)]) is matched. If this is the case,
    the plugin returns OK, otherwise CRITICAL.
  id: totrans-1853
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项检查查询的OID内容，以查看是否匹配正则表达式*regexp*^([[112](#ftn.CHP-11-FN-10)])。如果是这样，插件返回OK，否则返回CRITICAL。
- en: '**`-R`** **``*`regexp`*``** **`/ --erexi=`****``*`regexp`*``**'
  id: totrans-1854
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-R`** **``*`regexp`*``** **`/ --erexi=`****``*`regexp`*``**'
- en: As **`-r`**, except that there is no case distinction.
  id: totrans-1855
  prefs: []
  type: TYPE_NORMAL
  zh: 与**`-r`**类似，但没有任何大小写区分。
- en: '**`−1`** **``*`prefix`*``** **`/ --label=`****``*`prefix`*``**'
  id: totrans-1856
  prefs: []
  type: TYPE_NORMAL
  zh: '**`−1`** **``*`prefix`*``** **`/ --label=`****``*`prefix`*``**'
- en: A string that is placed in front of the plugin response. The default is **`SNMP`**.
  id: totrans-1857
  prefs: []
  type: TYPE_NORMAL
  zh: 放在插件响应前面的字符串。默认为**`SNMP`**。
- en: '**`-u`** **``*`string`*``** **`/ --units=`****``*`string`*``**'
  id: totrans-1858
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u`** **``*`string`*``** **`/ --units=`****``*`string`*``**'
- en: SNMP only has simple values, not units. A string that is specified instead of
    *string* is extended by the plugin in the text output so that it serves the value
    as a unit. Because only text is involved here, you can also specify **`apples`**
    or **`pears`**, for example, as "units".
  id: totrans-1859
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP只有简单值，没有单位。指定的字符串代替*string*被插件扩展到文本输出中，以便作为值使用单位。因为这里只涉及文本，所以您也可以指定**`apples`**或**`pears`**等作为“单位”。
- en: '**`-d`** **``*`delimiter`*``** **`/ --delimiter=`****``*`delimiter`*``**'
  id: totrans-1860
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-d`** **``*`delimiter`*``** **`/ --delimiter=`****``*`delimiter`*``**'
- en: This character separates the OID in the **`snmpget`** output from the value.
    The default is =.
  id: totrans-1861
  prefs: []
  type: TYPE_NORMAL
  zh: 这个字符将**`snmpget`**输出中的OID与值分开。默认是=。
- en: '**`-D`** **``*`delimiter`*``** **`/ --output-`** **`delimiter=`****``*`delimiter`*``**'
  id: totrans-1862
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-D`** **``*`分隔符`*``** **`/ --output-`** **`delimiter=`****``*`分隔符`*``**'
- en: The plugin is able to query several OIDs simultaneously. The result values are
    separated with *delimiter*, which in the default is a space.
  id: totrans-1863
  prefs: []
  type: TYPE_NORMAL
  zh: 插件能够同时查询多个OID。结果值由*分隔符*分隔，默认是一个空格。
- en: '**`-m`** **``*`mibs`*``** **`/ --miblist=`****``*`mibs`*``**'
  id: totrans-1864
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-m`** **``*`mibs`*``** **`/ --miblist=`****``*`mibs`*``**'
- en: This specifies the MIBs that should be loaded for **`snmpget`**. The default
    is **`ALL.-m +UCD-DEMO-MIB`**^([[113](#ftn.CHP-11-FN-11)]). loads *in addition*,
    **`-m UCD-DEMO-MIB`** <without the **`+`** sign> *only* loads the specified MIB.^([[114](#ftn.CHP-11-FN-12)]).
  id: totrans-1865
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了**`snmpget`**应该加载的MIB。默认是**`ALL.-m +UCD-DEMO-MIB`**^([[113](#ftn.CHP-11-FN-11)]）。加载*附加的*，**`-m
    UCD-DEMO-MIB`**（没有**`+`**符号）*仅*加载指定的MIB.^([[114](#ftn.CHP-11-FN-12)]）。
- en: '**`-P`** **``*`version`*``** **`/ --protocol=`****``*`version`*``**'
  id: totrans-1866
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-P`** **``*`version`*``** **`/ --protocol=`****``*`version`*``**'
- en: Defines the SNMP protocol version. The values for *version* are **`1`** or **`3`**.
    Without this option, SNMPv1 is used.
  id: totrans-1867
  prefs: []
  type: TYPE_NORMAL
  zh: 定义SNMP协议版本。*版本*的值是**`1`**或**`3`**。如果没有此选项，则使用SNMPv1。
- en: SNMP provides almost unlimited possibilities, so the following examples can
    merely convey a feeling for other plugins used.
  id: totrans-1868
  prefs: []
  type: TYPE_NORMAL
  zh: SNMP提供了几乎无限的可能性，所以以下示例只能传达对其他插件使用的感觉。
- en: Testing hard drive capacity via SNMP
  id: totrans-1869
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 通过SNMP测试硬盘容量
- en: 'The following command queries the load of a file system and to do this accesses
    the partial tree **`ucdavis.dskTable`** of a locally running NET-SNMP agent:'
  id: totrans-1870
  prefs: []
  type: TYPE_NORMAL
  zh: 以下命令查询文件系统的负载，为此访问本地运行的NET-SNMP代理的局部树**`ucdavis.dskTable`**：
- en: '[PRE230]'
  id: totrans-1871
  prefs: []
  type: TYPE_PRE
  zh: '[PRE230]'
- en: The query applies to the percentage load of the file system with the index number
    2\. As long as no more than 90 percent of the hard drive space is then occupied,
    the test should return OK; here a warning will be returned if it is between 91
    and 95 percent, and critical status if it goes beyond this. Thanks to the **`-u`**
    option, **`check_snmp`** adds the description **`percent`** to the output of the
    figure determined.
  id: totrans-1872
  prefs: []
  type: TYPE_NORMAL
  zh: 查询适用于索引号为2的文件系统的百分比负载。只要硬盘空间使用率不超过90%，测试应该返回OK；如果它在91%到95%之间，则返回警告，如果超过这个范围，则返回关键状态。多亏了**`-u`**选项，**`check_snmp`**将**`percent`**描述添加到确定的数值输出中。
- en: 'Nevertheless, the plugin does not tell the whole truth: a test check with **`df`**
    shows a 96 percent load, which comes from the fact that this program correctly
    rounded up the actual 95.8 percent load, while integer values in SNMP are seldom
    rounded up, but simply cut off. So you just have to live with slight inaccuracies
    as long as the MIB does not provide any floatingpoint decimals.'
  id: totrans-1873
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，插件并没有说出全部真相：使用**`df`**进行的测试检查显示96%的负载，这是因为该程序正确地将实际的95.8%负载向上取整，而SNMP中的整数值很少向上取整，而是简单地截断。所以只要MIB不提供任何浮点小数，你就只能忍受轻微的不准确。
- en: 'If you would like things to be more detailed, you can use the option **`−1:
    −1 ''SNMP-DISK: /net/swobspace/b''`** causes other, self-defined information to
    be added to the output of the above command:'
  id: totrans-1874
  prefs: []
  type: TYPE_NORMAL
  zh: '如果你想让内容更详细，可以使用选项**`−1: −1 ''SNMP-DISK: /net/swobspace/b''`**，这会导致其他，自定义的信息被添加到上述命令的输出中：'
- en: '[PRE231]'
  id: totrans-1875
  prefs: []
  type: TYPE_PRE
  zh: '[PRE231]'
- en: 'The above query can be more generally run through a command object such as
    the following:'
  id: totrans-1876
  prefs: []
  type: TYPE_NORMAL
  zh: 上述查询可以通过以下命令对象更一般地运行：
- en: '[PRE232]'
  id: totrans-1877
  prefs: []
  type: TYPE_PRE
  zh: '[PRE232]'
- en: This definition assumes that the value being queried is numerical, and not Boolean
    (see [Monitoring network interfaces](../Text/ch11s03.html#monitoring_network_interfaces
    "Monitoring network interfaces")), otherwise specifying a warning and critical
    value simultaneously would make no sense. We store the community here in the macro
    **`$USER3$`**.^([[115](#ftn.CHP-11-FN-13)]). this is followed by the protocol
    version (**`-P 1`** stands for SNMPv1), the OID, the warning and critical limits,
    and a prefix.
  id: totrans-1878
  prefs: []
  type: TYPE_NORMAL
  zh: 此定义假定要查询的值是数值，而不是布尔值（参见[监控网络接口](../Text/ch11s03.html#monitoring_network_interfaces
    "监控网络接口")），否则同时指定警告和关键值就没有意义。我们在这里将社区存储在宏**`$USER3$`**中.^([[115](#ftn.CHP-11-FN-13)]）。这后面跟着协议版本（**`-P
    1`**代表SNMPv1），OID，警告和关键限制，以及一个前缀。
- en: The call for this command in service definitions is then made in the form
  id: totrans-1879
  prefs: []
  type: TYPE_NORMAL
  zh: 在服务定义中对该命令的调用形式是
- en: '[PRE233]'
  id: totrans-1880
  prefs: []
  type: TYPE_PRE
  zh: '[PRE233]'
- en: 'If you want to specifically monitor the load of the file system with the index
    number 2 on the computer **`swobspace`** through **`dskTable`**, then the following
    definition would be used:'
  id: totrans-1881
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想要通过 **`dskTable`** 特定地监控计算机 **`swobspace`** 上索引号为2的文件系统的负载，那么以下定义将被使用：
- en: '[PRE234]'
  id: totrans-1882
  prefs: []
  type: TYPE_PRE
  zh: '[PRE234]'
- en: Even though the **`check_command`** line is wrapped here, in practice all parameters
    must be on a single line, separated by an exclamation point **`!`** (without spaces
    before or after the delimiter).
  id: totrans-1883
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管这里的 **`check_command`** 行被换行了，但在实际操作中，所有参数必须位于同一行，由感叹号 **`!`**（分隔符前后没有空格）分隔。
- en: Measuring temperature via **`lm-sensors`**
  id: totrans-1884
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 通过 **`lm-sensors`** 测量温度
- en: The next test checks the CPU temperature of the host. For the sensor, the package
    **`lm-sensors`**^([[116](#ftn.CHP-11-FN-14)]) is used here, which accesses corresponding
    chips on modern mainboards. As soon as **`lm-sensors`** is active, it allows the
    NET-SNMP agents to read out the corresponding information from the partial tree
    **`ucdavis.ucdExperimental.lmSensors:`**
  id: totrans-1885
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个测试检查主机的CPU温度。对于传感器，这里使用的是 **`lm-sensors`** 软件包^([[116](#ftn.CHP-11-FN-14)]),
    它访问现代主板上相应的芯片。一旦 **`lm-sensors`** 激活，它允许 NET-SNMP 代理从部分树 **`ucdavis.ucdExperimental.lmSensors:`**
    中读取相应的信息。
- en: '[PRE235]'
  id: totrans-1886
  prefs: []
  type: TYPE_PRE
  zh: '[PRE235]'
- en: 'The output depends on the chipset: here you must multiply the query values
    by the factor 1000\. Accordingly, you have no other alternative but to adjust
    the warning and critical limits to the main board you are using. In the example,
    the CPU temperature, 41 degrees Celsius, is "on a green light": if it were to
    drop below 25 degrees or rise above 45 degrees, it would cause a warning, while
    below 20 or above 48 degrees, this would be critical.'
  id: totrans-1887
  prefs: []
  type: TYPE_NORMAL
  zh: 输出取决于芯片组：在这里你必须将查询值乘以1000的系数。因此，你别无选择，只能将警告和临界限制调整到你使用的主板。在示例中，CPU温度为41摄氏度，处于“绿灯”状态：如果它低于25摄氏度或高于45摄氏度，将会触发警告，而低于20摄氏度或高于48摄氏度，则会被视为临界。
- en: Regular expressions and comparing fixed strings
  id: totrans-1888
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 正则表达式和比较固定字符串
- en: 'You can check whether the text **`swobspace`** occurs in the system name as
    follows:'
  id: totrans-1889
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以检查文本 **`swobspace`** 是否出现在系统名称中，方法如下：
- en: '[PRE236]'
  id: totrans-1890
  prefs: []
  type: TYPE_PRE
  zh: '[PRE236]'
- en: Instead of defining the string being searched for, with **`-r`** as the regular
    expression, you could also use the **`-s`** option. Then the text must match exactly,
    however, which may be quite tricky, since everything counts that **`snmpget`**
    outputs after the delimiter, **`=`**.
  id: totrans-1891
  prefs: []
  type: TYPE_NORMAL
  zh: 除了使用 **`-r`** 作为正则表达式来定义要搜索的字符串外，你也可以使用 **`-s`** 选项。然后文本必须完全匹配，但这可能相当棘手，因为 **`snmpget`**
    在分隔符 **`=`** 之后输出的所有内容都算数。
- en: Monitoring network interfaces
  id: totrans-1892
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 监控网络接口
- en: 'The final example queries whether the first network interface of a Cisco router
    is in operation:'
  id: totrans-1893
  prefs: []
  type: TYPE_NORMAL
  zh: 最后一个示例查询的是否是Cisco路由器的第一个网络接口正在运行：
- en: '[PRE237]'
  id: totrans-1894
  prefs: []
  type: TYPE_PRE
  zh: '[PRE237]'
- en: The information sought can be found in **`ifOperStatus`**. Here we are querying
    port 1\. While **`ifOperStatus`** gives out the operating status, **`ifAdmin-Status`**
    reveals whether the interface is administratively switched on or off.
  id: totrans-1895
  prefs: []
  type: TYPE_NORMAL
  zh: 所需信息可以在 **`ifOperStatus`** 中找到。在这里我们查询端口1。而 **`ifOperStatus`** 提供操作状态，**`ifAdmin-Status`**
    则揭示接口是否被管理性地开启或关闭。
- en: When specifying the warning limit here, we use the range **`1:1`**, so that
    the plugin gives out a warning if the interface is physically switched off, and
    the return value is thus 0\. We will do without the definition of a critical status
    here, since there are only two states, "on" or "off." If the plugin returns a
    CRITICAL when the interface is switched off, you should use **`-c 1:1`** and omit
    **`-w`** entirely.
  id: totrans-1896
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里指定警告限制时，我们使用范围 **`1:1`**，这样插件就会在接口物理关闭时发出警告，因此返回值是0。在这里我们不需要定义临界状态，因为只有两种状态，“开启”或“关闭”。如果插件在接口关闭时返回CRITICAL，你应该使用
    **`-c 1:1`** 并完全省略 **`-w`**。
- en: If you just want to query the status of network interfaces, you should certainly
    take a look at the plugins **`check_ifstatus`** and **`check_ifoperstatus`**,
    described below, which provide slightly more operating convenience.
  id: totrans-1897
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你只想查询网络接口的状态，你当然应该看看下面描述的插件 **`check_ifstatus`** 和 **`check_ifoperstatus`**，它们提供了稍微更多一些的操作便利性。
- en: 'If MIB-II or MIB **`ucdavis`** do not provide the desired information, you
    could also take a look at the MIB provided by the manufacturer. You can find out
    from **`mib-2.system`** in which partial tree the overall MIB is hidden:'
  id: totrans-1898
  prefs: []
  type: TYPE_NORMAL
  zh: 如果 MIB-II 或 MIB **`ucdavis`** 没有提供所需的信息，你也可以看看制造商提供的 MIB。你可以从 **`mib-2.system`**
    中找出整体 MIB 隐藏在哪个部分树中：
- en: '[PRE238]'
  id: totrans-1899
  prefs: []
  type: TYPE_PRE
  zh: '[PRE238]'
- en: 'The example involves a network-capable Konica photocopying machine called **`konica01.system.sysObjectID.0`**
    reveals that **`enterprises.2364`** serves as the entry point for device specific
    details. With **`snmpwalk`** you can then obtain further information:'
  id: totrans-1900
  prefs: []
  type: TYPE_NORMAL
  zh: 该示例涉及一台名为**`konica01.system.sysObjectID.0`**的网络功能型柯尼卡复印机，表明**`enterprises.2364`**是设备特定细节的入口点。使用**`snmpwalk`**，您可以进一步获取信息：
- en: '[PRE239]'
  id: totrans-1901
  prefs: []
  type: TYPE_PRE
  zh: '[PRE239]'
- en: In the concrete case of this photocopier, you can query the current device status
    through **`enterprises.2364.1.2.6.1.1.5.1.1`**. Manufacturers usually store information
    on the implemented MIBs, so that you are not restricted to just guessing.
  id: totrans-1902
  prefs: []
  type: TYPE_NORMAL
  zh: 在这台复印机的具体情况下，您可以通过**`enterprises.2364.1.2.6.1.1.5.1.1`**查询当前设备状态。制造商通常存储有关实现MIB的信息，这样您就不必仅仅猜测。
- en: 11.3.2 Checking several interfaces simultaneously
  id: totrans-1903
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.3.2 同时检查多个接口
- en: 'Active network components such as switches usually have quite a large number
    of ports, and it would be very time-consuming to check every single one of them.
    Here the **`check_ifstatus`** plugin is very useful, since it tests all ports
    simultaneously. It retrieves the information necessary for this via SNMP, and
    has the following options:'
  id: totrans-1904
  prefs: []
  type: TYPE_NORMAL
  zh: 活动网络组件，如交换机，通常具有相当多的端口，检查每一个端口都会非常耗时。在这里，**`check_ifstatus`**插件非常有用，因为它可以同时测试所有端口。它通过SNMP检索此信息，并具有以下选项：
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  id: totrans-1905
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
- en: This is the host name or IP address of the SNMP agent to be queried.
  id: totrans-1906
  prefs: []
  type: TYPE_NORMAL
  zh: 这是将被查询的SNMP代理的主机名或IP地址。
- en: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
  id: totrans-1907
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
- en: This sets the community string for read access.
  id: totrans-1908
  prefs: []
  type: TYPE_NORMAL
  zh: 这设置了读取访问的社区字符串。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-1909
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: This parameter is the alternative port on which the SNMP agent is running. The
    default is UDP port 161.
  id: totrans-1910
  prefs: []
  type: TYPE_NORMAL
  zh: 此参数是SNMP代理运行的备用端口。默认为UDP端口161。
- en: '**`-v`** **``*`version`*``** **`/ --snmp_version=`****``*`version`*``**'
  id: totrans-1911
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-v`** **``*`version`*``** **`/ --snmp_version=`****``*`version`*``**'
- en: This parameter specifies the SNMP version (**`1`**, **`2`**, or **`3`**) for
    the query.
  id: totrans-1912
  prefs: []
  type: TYPE_NORMAL
  zh: 此参数指定查询的SNMP版本（**`1`**、**`2`**或**`3`**）。
- en: '**`-x`** **``*`list`*``** **`/ --exclude=`****``*`list`*``**'
  id: totrans-1913
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-x`** **``*`list`*``** **`/ --exclude=`****``*`list`*``**'
- en: Use this to specify a comma-separated list of interface types that should not
    be queried (see example below).
  id: totrans-1914
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此选项来指定不应查询的逗号分隔的接口类型列表（请参见以下示例）。
- en: '**`-u`** **``*`list`*``** **`/ --unused_ports=`****``*`list`*``**'
  id: totrans-1915
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u`** **``*`list`*``** **`/ --unused_ports=`****``*`list`*``**'
- en: 'Use this to specify a comma-separated list of all ports that should be excluded
    from the test. Like **`-x`**, the list consists of the indices of the interfaces
    which are determined from **`if Index: -u 13,14,15,16`**.'
  id: totrans-1916
  prefs: []
  type: TYPE_NORMAL
  zh: '使用此选项来指定应从测试中排除的所有端口的逗号分隔列表。像**`-x`**一样，该列表由接口索引组成，这些索引由**`if Index: -u 13,14,15,16`**确定。'
- en: '**`-M`** **``*`bytes`*``** **`/ --maxmsgsize=`****``*`bytes`*``**'
  id: totrans-1917
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-M`** **``*`bytes`*``** **`/ --maxmsgsize=`****``*`bytes`*``**'
- en: This is the maximum size of the SNMP data packets; the default is **`1472`**
    bytes.
  id: totrans-1918
  prefs: []
  type: TYPE_NORMAL
  zh: 这是SNMP数据包的最大大小；默认为**`1472`**字节。
- en: With exclusion lists it is possible to exclude certain interface types or port
    numbers from the test, perhaps because these are not occupied, or are connected
    to PCs or other devices that are not always running.
  id: totrans-1919
  prefs: []
  type: TYPE_NORMAL
  zh: 使用排除列表，可以排除某些接口类型或端口号，可能是因为这些端口未被占用，或者连接到PC或其他设备，而这些设备并不总是运行。
- en: 'With the following query we can find out, for example, which interface types
    are gathered together on the Cisco switch here named **`cisco01`**:'
  id: totrans-1920
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下查询，我们可以找出例如，在名为**`cisco01`**的Cisco交换机上哪些接口类型被组合在一起：
- en: '[PRE240]'
  id: totrans-1921
  prefs: []
  type: TYPE_PRE
  zh: '[PRE240]'
- en: 'If the interface types **`other(1)`** and **`propVirtual(53)`** should now
    be excluded, the plugin is sent off with the two figures, separated by a comma,
    as the exclusion list **`-x 1,53`**:'
  id: totrans-1922
  prefs: []
  type: TYPE_NORMAL
  zh: 如果要排除接口类型**`other(1)`**和**`propVirtual(53)`**，则插件将发送带有两个数字的排除列表**`-x 1,53`**：
- en: '[PRE241]'
  id: totrans-1923
  prefs: []
  type: TYPE_PRE
  zh: '[PRE241]'
- en: In reality, this plugin also does *not* display its output over several lines,
    as the line wrap here may suggest. The fact that this information appears on the
    Nagios Web interface in a relatively clear form is because the HMTL formatting
    element **`<BR>`** is thrown in. This causes the output for each port to be displayed
    on a separate line. The **`|`** character defines the beginning of the performance
    data, which does not appear at all in the Web interface.
  id: totrans-1924
  prefs: []
  type: TYPE_NORMAL
  zh: 实际上，此插件也不会在其输出中显示多行，尽管这里的换行可能暗示了这一点。此信息之所以在Nagios Web界面中以相对清晰的形式出现，是因为其中加入了HTML格式化元素**`<BR>`**。这导致每个端口的输出都显示在不同的行上。**`|`**字符定义性能数据的开始，在Web界面中根本不会出现。
- en: 'A query of this type is implemented as a command object as follows:'
  id: totrans-1925
  prefs: []
  type: TYPE_NORMAL
  zh: 此类查询作为以下命令对象实现：
- en: '[PRE242]'
  id: totrans-1926
  prefs: []
  type: TYPE_PRE
  zh: '[PRE242]'
- en: Here the macro **`$USER3$`** is also used to define the community string in
    the file **`resource.cfg`**. Altogether, 32 **`$USERx$`** macros are available,
    of which the first two usually contain path details, and the others can be used
    in any way you want.
  id: totrans-1927
  prefs: []
  type: TYPE_NORMAL
  zh: 这里也使用了宏**`$USER3$`**来在文件**`resource.cfg`**中定义社区字符串。总共有32个**`$USERx$`**宏可用，其中前两个通常包含路径细节，其余的可以按您希望的方式使用。
- en: If you would prefer to exclude ports rather than interface types, you can use
    the **`-u`** option instead of **`-x`** in the definition.
  id: totrans-1928
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您希望排除端口而不是接口类型，可以在定义中使用**`-u`**选项而不是**`-x`**。
- en: 'If Nagios is to monitor the switch **`cisco01`**, as shown above, excluding
    the two interface types **`1`** and **`53`**, the corresponding service definition
    begins as follows:'
  id: totrans-1929
  prefs: []
  type: TYPE_NORMAL
  zh: 如果Nagios要监控**`cisco01`**交换机，如上所示，排除接口类型**`1`**和**`53`**，相应的服务定义如下：
- en: '[PRE243]'
  id: totrans-1930
  prefs: []
  type: TYPE_PRE
  zh: '[PRE243]'
- en: 11.3.3 Testing the operating status of individual interfaces
  id: totrans-1931
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.3.3 测试单个接口的运行状态
- en: 'To test an individual interface, you can use either the generic plugin **`check_snmp`**
    or **`check_ifoperstatus`**, which specifically tests the operating status (**`ifOperStatus`**)
    of the network card. The advantage of this over the generic plugin consists above
    all in its ease of use: instead of an index for the port, you can also specify
    its description here—for example, **`eth0`**.'
  id: totrans-1932
  prefs: []
  type: TYPE_NORMAL
  zh: 要测试单个接口，可以使用通用的插件**`check_snmp`**或**`check_ifoperstatus`**，后者专门测试网络卡的运行状态（**`ifOperStatus`**）。与通用插件相比，其优势主要在于易于使用：您不仅可以指定端口的索引，还可以指定其描述，例如，**`eth0`**。
- en: '**`check_ifoperstatus`** has the following options:'
  id: totrans-1933
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_ifoperstatus`**具有以下选项：'
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  id: totrans-1934
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
- en: This is the host name or IP address of the SNP agent to be queried.
  id: totrans-1935
  prefs: []
  type: TYPE_NORMAL
  zh: 这是待查询的SNP代理的主机名或IP地址。
- en: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
  id: totrans-1936
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
- en: This parameter gives the community string for read access.
  id: totrans-1937
  prefs: []
  type: TYPE_NORMAL
  zh: 此参数给出读取访问的社区字符串。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-1938
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: As long as the SNMP agent is not running on UDP port 161, the port is specified
    with this option.
  id: totrans-1939
  prefs: []
  type: TYPE_NORMAL
  zh: 只要SNMP代理不在UDP端口161上运行，就可以使用此选项指定端口。
- en: '**`-k`** **``*`ifIndex`*``** **`/ --key=`****``*`ifIndex`*``**'
  id: totrans-1940
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-k`** **``*`ifIndex`*``** **`/ --key=`****``*`ifIndex`*``**'
- en: '*ifIndex* is the number of the network interface to be queried (such as the
    network card of a computer or the port of a switch).'
  id: totrans-1941
  prefs: []
  type: TYPE_NORMAL
  zh: '*ifIndex* 是要查询的网络接口的编号（例如计算机的网络卡或交换机的端口）。'
- en: '**`-d`** **``*`ifDescr`*``** **`/ --descr=`****``*`ifDescr`*``**'
  id: totrans-1942
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-d`** **``*`ifDescr`*``** **`/ --descr=`****``*`ifDescr`*``**'
- en: Instead of the index key, the plugin processes the name of the interface from
    *ifDescr* (see below).
  id: totrans-1943
  prefs: []
  type: TYPE_NORMAL
  zh: 与索引键不同，该插件处理接口名称，从 *ifDescr*（见下文）获取。
- en: '**`-v`** **``*`version`*``** **`/ --snmp_version=`****``*`version`*``**'
  id: totrans-1944
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-v`** **``*`version`*``** **`/ --snmp_version=`****``*`version`*``**'
- en: This specifies the SNMP version (**`1, 2`**, or **`3`**) for the query.
  id: totrans-1945
  prefs: []
  type: TYPE_NORMAL
  zh: 此处指定查询的SNMP版本（**`1, 2`**，或 **`3`**）。
- en: '**`-w`** **``*`return_value`*``** **`/ --warn=`****``*`return_value`*``**'
  id: totrans-1946
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`return_value`*``** **`/ --warn=`****``*`return_value`*``**'
- en: This option selects the return value if the interface is dormant. The *return_value*
    can be **`i`** (ignore the dormant status and return OK!), **`w`** (WARNING) or
    **`c`** (CRITICAL, the default).
  id: totrans-1947
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项选择在接口休眠时的返回值。*return_value* 可以是 **`i`**（忽略休眠状态并返回OK!），**`w`**（警告）或 **`c`**（严重，默认值）。
- en: '**`-D`** **``*`return_value`*``** **`/ --admin-down=`****``*`return_value`*``**'
  id: totrans-1948
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-D`** **``*`return_value`*``** **`/ --admin-down=`****``*`return_value`*``**'
- en: What value (**`i`**, **`w`** or **`c`**) should the plugin return if the interface
    has been shut down administratively? The default, **`w`**, issues a warning, **`c`**
    returns CRITICAL, and **`i`** returns OK.
  id: totrans-1949
  prefs: []
  type: TYPE_NORMAL
  zh: 如果接口被管理员关闭，插件应该返回什么值（**`i`**、**`w`** 或 **`c`**）？默认值 **`w`** 会发出警告，**`c`** 返回
    CRITICAL，**`i`** 返回 OK。
- en: '**`-M`** **``*`bytes`*``** **`/ --maxmsgsize=`****``*`bytes`*``**'
  id: totrans-1950
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-M`** **``*`bytes`*``** **`/ --maxmsgsize=`****``*`bytes`*``**'
- en: This is the maximum size of the SNMP data packets; the default is **`1472`**
    bytes.
  id: totrans-1951
  prefs: []
  type: TYPE_NORMAL
  zh: 这是 SNMP 数据包的最大大小；默认为 **`1472`** 字节。
- en: On a system called **`igate`**, on which **`snmpwalk`** finds the following
    interfaces ...
  id: totrans-1952
  prefs: []
  type: TYPE_NORMAL
  zh: 在一个名为 **`igate`** 的系统上，其中 **`snmpwalk`** 找到以下接口 ...
- en: '[PRE244]'
  id: totrans-1953
  prefs: []
  type: TYPE_PRE
  zh: '[PRE244]'
- en: the first Ethernet card is tested either with **`-k 7`** or with **`-d etho`**.
    Since the plugin in the second case has to query all **`ifDescr`** entries to
    determine the index itself, this variation generates a somewhat higher network
    load. It can be especially useful if not all network interfaces are active on
    a host, causing its index to change.
  id: totrans-1954
  prefs: []
  type: TYPE_NORMAL
  zh: 第一块以太网卡可以通过 **`-k 7`** 或 **`-d etho`** 进行测试。由于在第二种情况下，插件必须查询所有 **`ifDescr`**
    条目以确定索引本身，这种变化会产生更高的网络负载。如果主机上的不是所有网络接口都处于活动状态，导致其索引发生变化，这特别有用。
- en: 'The plugin itself reveals which index this port currently has:'
  id: totrans-1955
  prefs: []
  type: TYPE_NORMAL
  zh: 插件本身会显示当前端口的索引：
- en: '[PRE245]'
  id: totrans-1956
  prefs: []
  type: TYPE_PRE
  zh: '[PRE245]'
- en: 'As the command object in the Nagios configuration, the call looks like this:'
  id: totrans-1957
  prefs: []
  type: TYPE_NORMAL
  zh: 作为 Nagios 配置中的命令对象，调用看起来是这样的：
- en: '[PRE246]'
  id: totrans-1958
  prefs: []
  type: TYPE_PRE
  zh: '[PRE246]'
- en: 'The **`$USER3$`** macro again contains the community string, defined in the
    file **`resource.cfg`**. The service definition for **`igate`** specifies the
    name of the interface to be tested as a plugin argument:'
  id: totrans-1959
  prefs: []
  type: TYPE_NORMAL
  zh: '**`$USER3$`** 宏再次包含社区字符串，该字符串在文件 **`resource.cfg`** 中定义。**`igate`** 服务的定义指定了要测试的接口名称作为插件参数：'
- en: '[PRE247]'
  id: totrans-1960
  prefs: []
  type: TYPE_PRE
  zh: '[PRE247]'
- en: '* * *'
  id: totrans-1961
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[112](#CHP-11-FN-10)]) POSIX regular expression, see **`man 7 regex`**.
  id: totrans-1962
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[112](#CHP-11-FN-10)]) POSIX 正则表达式，请参阅 **`man 7 regex`**。
- en: ^([[113](#CHP-11-FN-11)]) **`UCD-DEMO-MIB`** is an MIB included for demonstration
    purposes
  id: totrans-1963
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[113](#CHP-11-FN-11)]) **`UCD-DEMO-MIB`** 是一个用于演示目的的 MIB
- en: ^([[114](#CHP-11-FN-12)]) See also the online help, with **`man snmpcmd`**
  id: totrans-1964
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[114](#CHP-11-FN-12)]) 参见在线帮助，使用 **`man snmpcmd`**
- en: ^([[115](#CHP-11-FN-13)]) The **`$USERx$`** macros are defined in the resource
    file **`resource.cfg`**
  id: totrans-1965
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[115](#CHP-11-FN-13)]) **`$USERx$`** 宏定义在资源文件 **`resource.cfg`** 中
- en: ^([[116](#CHP-11-FN-14)]) [http://www.lm-sensors.nu/](http://www.lm-sensors.nu/)
  id: totrans-1966
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[116](#CHP-11-FN-14)]) [http://www.lm-sensors.nu/](http://www.lm-sensors.nu/)
- en: 11.4 Other SNMP-based Plugins
  id: totrans-1967
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 11.4 其他基于 SNMP 的插件
- en: Apart form the SNMP plugins from the Nagios Plugin package, the Nagios community
    provides a large variety of other plugins for special purposes. Most of them can
    be found at **`[http://www.nagiosexchange.org/](http://www.nagiosexchange.org/)`**
    in the category `Check Plugins | SNMP`.^([[117](#ftn.CHP-11-FN-15)])
  id: totrans-1968
  prefs: []
  type: TYPE_NORMAL
  zh: 除了 Nagios 插件包中的 SNMP 插件外，Nagios 社区还提供大量针对特殊目的的其他插件。大多数可以在 **`[http://www.nagiosexchange.org/](http://www.nagiosexchange.org/)`**
    的 `Check Plugins | SNMP` 类别中找到。^([[117](#ftn.CHP-11-FN-15)])
- en: 11.4.1 Monitoring hard drive space and processes with **`nagios-snmp-plugins`**
  id: totrans-1969
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.4.1 使用 **`nagios-snmp-plugins`** 监控硬盘空间和进程
- en: 'One of these is the package **`nagios-snmp-plugins`**,^([[118](#ftn.CHP-11-FN-16)])
    which exists not only as source code but also as an RPM package (for Red Hat and
    Fedora). It contains two very easy-to-use plugins: **`check_snmp_disk`** and **`check_snmp_proc`**.'
  id: totrans-1970
  prefs: []
  type: TYPE_NORMAL
  zh: 其中之一是包 **`nagios-snmp-plugins`**，^([[118](#ftn.CHP-11-FN-16)]) 它不仅存在源代码版本，也存在
    RPM 包（适用于 Red Hat 和 Fedora）。它包含两个非常易于使用的插件：**`check_snmp_disk`** 和 **`check_snmp_proc`**。
- en: 'Both absolutely require the NET-SNMP agent as the partner on the other side
    (see [11.2.2 The NET-SNMP daemon](../Text/ch11s02.html#the_net-snmp_daemon "11.2.2
    The NET-SNMP daemon") from page 238) and use **`ucdavis.dskTable`** and **`ucdavis.prTable`**
    to test the processes and file systems specified in the configuration file **`snmpd.conf`**.
    Its options are restricted to specifying the host and the community string:'
  id: totrans-1971
  prefs: []
  type: TYPE_NORMAL
  zh: 它们都绝对需要 NET-SNMP 代理作为另一侧的合作伙伴（参见第 238 页的 [11.2.2 The NET-SNMP daemon](../Text/ch11s02.html#the_net-snmp_daemon
    "11.2.2 The NET-SNMP daemon")），并使用 **`ucdavis.dskTable`** 和 **`ucdavis.prTable`**
    测试配置文件 **`snmpd.conf`** 中指定的进程和文件系统。其选项仅限于指定主机和社区字符串：
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  id: totrans-1972
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
- en: This is the host name or IP address of the NET-SNMP agent to be queried.
  id: totrans-1973
  prefs: []
  type: TYPE_NORMAL
  zh: 这是将被查询的 NET-SNMP 代理的主机名或 IP 地址。
- en: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
  id: totrans-1974
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
- en: This is the community string for read access.
  id: totrans-1975
  prefs: []
  type: TYPE_NORMAL
  zh: 这是读取访问的社区字符串。
- en: 'The next example tests the available capacity of the **`/data`** file system;
    **`public`** is again used as the community string:'
  id: totrans-1976
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例测试了 **`/data`** 文件系统的可用容量；再次使用 **`public`** 作为社区字符串：
- en: '[PRE248]'
  id: totrans-1977
  prefs: []
  type: TYPE_PRE
  zh: '[PRE248]'
- en: The configuration of the NET-SNMP agent specifies, with the **`disk`** directive
    ([The configuration file snmpd.conf](../Text/ch11s02.html#the_configuration_file_snmpd.conf
    "The configuration file snmpd.conf")), **`50%`** as the threshold for this file
    system. In this case the plugin accordingly returns a CRITICAL. It can only distinguish
    between an error and OK; it does not have a WARNING status.
  id: totrans-1978
  prefs: []
  type: TYPE_NORMAL
  zh: NET-SNMP 代理的配置使用 **`disk`** 指令 ([配置文件 snmpd.conf](../Text/ch11s02.html#the_configuration_file_snmpd.conf
    "配置文件 snmpd.conf"))，将 **`50%`** 作为此文件系统的阈值。在这种情况下，插件相应地返回 CRITICAL。它只能区分错误和正常；没有警告状态。
- en: 'Using **`check_snmp_proc`** is just as easy:'
  id: totrans-1979
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 **`check_snmp_proc`** 同样简单：
- en: '[PRE249]'
  id: totrans-1980
  prefs: []
  type: TYPE_PRE
  zh: '[PRE249]'
- en: The plugin again tests the processes defined in the configuration of the NET-SNMP
    agent with the **`proc`** directive ([The configuration file snmpd.conf](../Text/ch11s02.html#the_configuration_file_snmpd.conf
    "The configuration file snmpd.conf")). The process **`slapd`** is missing here,
    which is why a CRITICAL is returned. The return value is revealed by **`echo $?`**.
  id: totrans-1981
  prefs: []
  type: TYPE_NORMAL
  zh: 插件再次使用 **`proc`** 指令 ([配置文件 snmpd.conf](../Text/ch11s02.html#the_configuration_file_snmpd.conf
    "配置文件 snmpd.conf")) 测试 NET-SNMP 代理配置中定义的进程。这里缺少 **`slapd`** 进程，因此返回 CRITICAL。返回值通过
    **`echo $?`** 揭示。
- en: 'The corresponding command objects are defined in a similar unspectacular way:'
  id: totrans-1982
  prefs: []
  type: TYPE_NORMAL
  zh: 相应的命令对象以类似不引人注目的方式定义：
- en: '[PRE250]'
  id: totrans-1983
  prefs: []
  type: TYPE_PRE
  zh: '[PRE250]'
- en: 'This definition also assumes that the community string is stored in the **`$USER3$`**
    macro in the file **`resource.cfg`**. In order to query the NET-SMTPD on the computer
    **`linux01`** for its hard drive load, the following service object is defined:'
  id: totrans-1984
  prefs: []
  type: TYPE_NORMAL
  zh: 此定义还假设社区字符串存储在文件 **`resource.cfg`** 中的 **`$USER3$`** 宏中。为了查询计算机 **`linux01`**
    上的 NET-SMTPD 的硬盘负载，定义以下服务对象：
- en: '[PRE251]'
  id: totrans-1985
  prefs: []
  type: TYPE_PRE
  zh: '[PRE251]'
- en: 11.4.2 Observing the load on network interfaces with **`check-iftraffic`**
  id: totrans-1986
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.4.2 使用 **`check-iftraffic`** 检查网络接口的负载
- en: The MIB-II contains only numbers that provide information on the load on network
    interfaces, but no average values for the used bandwidth, for example. If the
    vendor has not specifically made such an entry available in his MIB, then you
    will always have to make a note of the last counter status and the timestamp,
    so that you can work out the relative usage yourself.
  id: totrans-1987
  prefs: []
  type: TYPE_NORMAL
  zh: MIB-II 只包含关于网络接口负载的信息数字，但没有使用带宽的平均值，例如。如果供应商在其 MIB 中没有特别提供此类条目，那么您将始终需要记录最后计数器状态和时间戳，以便您可以自己计算出相对使用情况。
- en: '**`[http://www.nagiosexchange.org/](http://www.nagiosexchange.org/)`** introduces
    two plugins that take over this task. The Perl-based plugin **`check_traffic`**^([[119](#ftn.CHP-11-FN-17)])
    writes the query values into a *round-robin database* (RRD, see [19.2 Graphs for
    the Web with Nagiosgraph](../Text/ch19s02.html "19.2 Graphs for the Web with Nagiosgraph")),
    which makes it somewhat more complex to handle.'
  id: totrans-1988
  prefs: []
  type: TYPE_NORMAL
  zh: '**`[http://www.nagiosexchange.org/](http://www.nagiosexchange.org/)`** 介绍了两个插件，它们接管此任务。基于
    Perl 的插件 **`check_traffic`**^([[119](#ftn.CHP-11-FN-17)]) 将查询值写入 *循环冗余数据库*（RRD，见
    [19.2 使用 Nagiosgraph 在 Web 上创建图形](../Text/ch19s02.html "19.2 使用 Nagiosgraph 在
    Web 上创建图形"))，这使得处理稍微复杂一些。'
- en: 'The same purpose is achieved, but with more simple means, by the **`check_iftraffic.pl`**
    plugin.^([[120](#ftn.CHP-11-FN-18)]). It has the following options:'
  id: totrans-1989
  prefs: []
  type: TYPE_NORMAL
  zh: 通过 **`check_iftraffic.pl`** 插件.^([[120](#ftn.CHP-11-FN-18)])，以更简单的方式达到相同的目的。它有以下选项：
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  id: totrans-1990
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
- en: '*`address`* is the host name or IP address of the NET-SNMP agent that is to
    be queried.'
  id: totrans-1991
  prefs: []
  type: TYPE_NORMAL
  zh: '*`address`* 是要查询的 NET-SNMP 代理的主机名或 IP 地址。'
- en: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
  id: totrans-1992
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
- en: '**``*`password`*``** is the community string for read access. The default is
    public.'
  id: totrans-1993
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`password`*``** 是读取访问的社区字符串。默认为公开。'
- en: '**`-i`** **``*`ifDescr`*``** **`/ --interface=`****``*`ifDescr`*``**'
  id: totrans-1994
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-i`** **``*`ifDescr`*``** **`/ --interface=`****``*`ifDescr`*``**'
- en: From the interface name **``*`ifDescr`*``** the plugin determines the index
    so that it can access other values (e. g., the counter states).
  id: totrans-1995
  prefs: []
  type: TYPE_NORMAL
  zh: 从接口名称 **``*`ifDescr`*``**，插件确定索引以便它可以访问其他值（例如，计数器状态）。
- en: '**`-b`** **``*`integer`*``** **`/ --bandwith=`****``*`integer`*``**'
  id: totrans-1996
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-b`** **``*`integer`*``** **`/ --bandwith=`****``*`integer`*``**'
- en: This is the maximum bandwidth of the interface in bits (see **`-u`**).
  id: totrans-1997
  prefs: []
  type: TYPE_NORMAL
  zh: 这是接口的最大带宽，以比特为单位（见 **`-u`**）。
- en: '**`-u`** **``*`unit`*``** **`/ --units=`****``*`unit`*``**'
  id: totrans-1998
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-u`** **``*`单位`*``** **`/ --units=`****``*`单位`*``**'
- en: 'This is the unit for bandwidth specification with **`-b`**. Possible values
    are **`g`** (Gbit), **`m`** (Mbit), **`k`** (kbit) and the default **`b`** (bit):
    **`-b 100 -u m`** corresponds to 100 Megabits (Fast Ethernet).'
  id: totrans-1999
  prefs: []
  type: TYPE_NORMAL
  zh: 这是使用**`-b`**指定的带宽的单位。可能的值是**`g`**（Gbit）、**`m`**（Mbit）、**`k`**（kbit）和默认的**`b`**（bit）：**`-b
    100 -u m`**对应于100兆比特（快速以太网）。
- en: '**`-w`** **``*`integer`*``** **`/ --warning=`****``*`integer`*``**'
  id: totrans-2000
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`整数`*``** **`/ --warning=`****``*`整数`*``**'
- en: 'If traffic exceeds this warning limit in percent (default: **`85`** percent),
    the plugin issues a WARNING.'
  id: totrans-2001
  prefs: []
  type: TYPE_NORMAL
  zh: 如果流量超过此警告限制的百分比（默认：**`85`**%），则插件发出警告。
- en: '**`-c`** **``*`integer`*``** **`/ --critical=`****``*`integer`*``**'
  id: totrans-2002
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`整数`*``** **`/ --critical=`****``*`整数`*``**'
- en: 'This is the critical threshold in percent (default: **`92`** percent).'
  id: totrans-2003
  prefs: []
  type: TYPE_NORMAL
  zh: 这是百分比中的临界阈值（默认：**`92`**%）。
- en: The plugin saves the timestamp and counter status of the interface queried in
    files in **`/tmp`**, to which it adds the prefix **`traffic`**. So if you are
    using a different user ID than **`nagios`** for the manual test on the command
    line, you should delete the files **`/tmp/traffic`****``*`_interface_computer`*``**
    before activating the appropriate Nagios service.
  id: totrans-2004
  prefs: []
  type: TYPE_NORMAL
  zh: 该插件将查询界面的时间戳和计数器状态保存在**`/tmp`**目录下的文件中，并在其前添加前缀**`traffic`**。因此，如果你在命令行上使用不同于**`nagios`**的用户ID进行手动测试，应在激活适当的Nagios服务之前删除**`/tmp/traffic`**目录下的**`_interface_computer`**文件。
- en: 'The following command line example queries the Fast Ethernet network interface
    **`etho`** on the computer **`linux01`**, which in theory has a bandwidth of 100
    Mbit:'
  id: totrans-2005
  prefs: []
  type: TYPE_NORMAL
  zh: 以下命令行示例查询了计算机**`linux01`**上的快速以太网网络接口**`etho`**，理论上具有100 Mbit的带宽：
- en: '[PRE252]'
  id: totrans-2006
  prefs: []
  type: TYPE_PRE
  zh: '[PRE252]'
- en: The amount of data transmitted here is reported separately by the plugin, depending
    on the direction, and here it announces 60.32 (**`RX`**, "received") and 26.59
    MB (**`TX`**, "transmitted"). The text contains the HTML element **`<br>`** (line
    break), to display the output in the Nagios Web interface on two lines. This is
    followed by the average transmission rate, again separated for incoming and outgoing
    data traffic. The performance data (see [19.1 Processing Plugin Performance Data
    with Nagios](../Text/ch19.html#processing_plugin_performance_data_with "19.1 Processing
    Plugin Performance Data with Nagios"), page 404) after the **`|`** sign contain
    only the average load as a percentage, each separated by incoming and outgoing
    values. The numbers **`85`** and **`98`** are the default values for the warning
    and critical limits.
  id: totrans-2007
  prefs: []
  type: TYPE_NORMAL
  zh: 此处传输的数据量由插件分别报告，根据方向不同，这里宣布了60.32 MB（**`RX`**，"接收")和26.59 MB（**`TX`**，"发送")。文本包含HTML元素**`<br>`**（换行），用于在Nagios
    Web界面上显示输出为两行。随后是平均传输速率，再次分别针对传入和传出数据流量。**`|`**符号之后的性能数据（见[19.1 使用Nagios处理插件性能数据](../Text/ch19.html#processing_plugin_performance_data_with
    "19.1 使用Nagios处理插件性能数据")，第404页）仅包含平均负载的百分比，每个值分别对应传入和传出。数字**`85`**和**`98`**是警告和临界限制的默认值。
- en: 'The corresponding command object is implemented as follows:'
  id: totrans-2008
  prefs: []
  type: TYPE_NORMAL
  zh: 相应的命令对象实现如下：
- en: '[PRE253]'
  id: totrans-2009
  prefs: []
  type: TYPE_PRE
  zh: '[PRE253]'
- en: If the definition is taken over literally, you must define the community string
    in the **`$USER3$`** macro. If you only generally use **`public`** as the password,
    it is better to write **`-C public`** instead of **`-C $USER3$`**.
  id: totrans-2010
  prefs: []
  type: TYPE_NORMAL
  zh: 如果直接采用定义，必须在**`$USER3$`**宏中定义社区字符串。如果你只一般性地使用**`public`**作为密码，最好写成**`-C public`**而不是**`-C
    $USER3$`**。
- en: To simplify the call of the command within the following service definition,
    we set the unit to Mbit/second (**`-u m`**).
  id: totrans-2011
  prefs: []
  type: TYPE_NORMAL
  zh: 为了简化以下服务定义中命令的调用，我们将单位设置为兆比特/秒（**`-u m`**）。
- en: '[PRE254]'
  id: totrans-2012
  prefs: []
  type: TYPE_PRE
  zh: '[PRE254]'
- en: '**`check_iftraffic`** calculates the bandwidth used by comparing two counter
    states at different times. Because Nagios does not test exactly down to the second,
    the check interval you choose should not be too small. The *Multi Router Traffic
    Grapher*,^([[121](#ftn.CHP-11-FN-19)]) which displays the bandwidth used in graphic
    form, normally works at five-minute intervals.'
  id: totrans-2013
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_iftraffic`**通过比较不同时间点的两个计数器状态来计算使用的带宽。由于Nagios不能精确到秒进行测试，因此你选择的检查间隔不应太小。显示带宽使用的图形形式的**`Multi
    Router Traffic Grapher`**，^([[121](#ftn.CHP-11-FN-19)])通常以五分钟为间隔工作。'
- en: If you select **`max_check_attempts`** other than **`1`**, you should make sure
    that the retry interval (**`retry_check_interval`**) is the same as the normal
    check interval. For **`max_check_attempts 1`** this makes no difference, but you
    have to define a **`retry_check_interval`** at some time or other.
  id: totrans-2014
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你选择 **`max_check_attempts`** 不是 **`1`**，你应该确保重试间隔（**`retry_check_interval`**）与正常检查间隔相同。对于
    **`max_check_attempts 1`** 这没有区别，但你必须在某个时候定义一个 **`retry_check_interval`**。
- en: 11.4.3 The [manubulon.com](http://manubulon.com) plugins for special application
    purposes
  id: totrans-2015
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.4.3 用于特殊应用目的的 [manubulon.com](http://manubulon.com) 插件
- en: The Nagios Exchange, with the SNMP plugins to be found under [http://www.manubulon.com/nagios/](http://www.manubulon.com/nagios/)
    (see [Table 11-4](../Text/ch11s04.html#the_manubulon.com-snmp_plu "Table 11-4. The
    manubulon.com-SNMP plugins")), also includes some that are customized to a specific
    application, such as querying hard drive space. They are relatively simple to
    use.
  id: totrans-2016
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios Exchange，其中包含可在 [http://www.manubulon.com/nagios/](http://www.manubulon.com/nagios/)
    找到的 SNMP 插件（见 [表 11-4](../Text/ch11s04.html#the_manubulon.com-snmp_plu "表 11-4. manubulon.com-SNMP
    插件")），还包括一些针对特定应用定制的插件，例如查询硬盘空间。它们相对简单易用。
- en: Table 11-4. The [manubulon.com](http://manubulon.com)-SNMP plugins
  id: totrans-2017
  prefs: []
  type: TYPE_NORMAL
  zh: 表 11-4. [manubulon.com](http://manubulon.com)-SNMP 插件
- en: '| Plugin | Description |'
  id: totrans-2018
  prefs: []
  type: TYPE_TB
  zh: '| 插件 | 描述 |'
- en: '| --- | --- |'
  id: totrans-2019
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| **`check_sn.mp_storage.pl`** | Query of storage devices (hard drives, swap
    space, main memory, etc.) |'
  id: totrans-2020
  prefs: []
  type: TYPE_TB
  zh: '| **`check_sn.mp_storage.pl`** | 存储设备（硬盘驱动器、交换空间、主内存等）查询 |'
- en: '| **`check_snmp_int.pl`** | Interface status and load |'
  id: totrans-2021
  prefs: []
  type: TYPE_TB
  zh: '| **`check_snmp_int.pl`** | 接口状态和负载 |'
- en: '| **`check_snmp_process.pl`** | processes: status, CPU and memory usage |'
  id: totrans-2022
  prefs: []
  type: TYPE_TB
  zh: '| **`check_snmp_process.pl`** | 进程：状态、CPU 和内存使用情况 |'
- en: '| **`check_snmp_load.pl`** | System load |'
  id: totrans-2023
  prefs: []
  type: TYPE_TB
  zh: '| **`check_snmp_load.pl`** | 系统负载 |'
- en: '| **`check_snmp_mem.pl`** | main memory and swap usage |'
  id: totrans-2024
  prefs: []
  type: TYPE_TB
  zh: '| **`check_snmp_mem.pl`** | 主内存和交换空间使用情况 |'
- en: '| **`check_snmp_vrrp.pl`** | querying a Nokia-VRRP cluster ^([[a](#ftn.CHP-11-FN-20)])
    |'
  id: totrans-2025
  prefs: []
  type: TYPE_TB
  zh: '| **`check_snmp_vrrp.pl`** | 查询诺基亚-VRRP 集群 ^([[a](#ftn.CHP-11-FN-20)]) |'
- en: '| **`check_snmp_cpfw.pl`** | querying a Checkpoint firewall-1^([[b](#ftn.CHP-11-FN-21)])
    |'
  id: totrans-2026
  prefs: []
  type: TYPE_TB
  zh: '| **`check_snmp_cpfw.pl`** | 查询 Checkpoint firewall-1^([[b](#ftn.CHP-11-FN-21)])
    |'
- en: '| **`check_snmp_env.pl`** | tests environment parameters of switches such as
    temperature, power supply unit, and fan (Cisco, Foundry, and others) |'
  id: totrans-2027
  prefs: []
  type: TYPE_TB
  zh: '| **`check_snmp_env.pl`** | 测试交换机等环境参数，如温度、电源单元和风扇（思科、Foundry 等） |'
- en: '| **`check_snmp_win.pl`** | Queries Windows services via SNMP |'
  id: totrans-2028
  prefs: []
  type: TYPE_TB
  zh: '| **`check_snmp_win.pl`** | 通过 SNMP 查询 Windows 服务 |'
- en: '|'
  id: totrans-2029
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: ^([[a](#CHP-11-FN-20)]) The abbreviation VRRP stands for *Virtual Router Redundancy
    Protocol*.
  id: totrans-2030
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[a](#CHP-11-FN-20)]) VRRP 的缩写代表 *虚拟路由冗余协议*。
- en: ^([[b](#CHP-11-FN-21)]) [http://www.checkpoint.com/products/firewall-1/](http://www.checkpoint.com/products/firewall-1/)
  id: totrans-2031
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[b](#CHP-11-FN-21)]) [http://www.checkpoint.com/products/firewall-1/](http://www.checkpoint.com/products/firewall-1/)
- en: '|'
  id: totrans-2032
  prefs: []
  type: TYPE_NORMAL
  zh: '|'
- en: We will introduce two of the plugins—**`check_snmp_storage.pl`** and check **`_snmp_load.pl`**—in
    detail here.
  id: totrans-2033
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在这里详细介绍两个插件——**`check_snmp_storage.pl`** 和 **`_snmp_load.pl`**。
- en: Keeping checks on storage media with **`check_snmp_storage`**
  id: totrans-2034
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用 **`check_snmp_storage`** 保持对存储介质的检查
- en: While the **`check_snmp_disk`** plugin, introduced in [11.4.1 Monitoring hard
    drive space and processes with nagios-snmp-plugins](../Text/ch11s04.html#monitoring_hard_drive_space_and_processe
    "11.4.1 Monitoring hard drive space and processes with nagios-snmp-plugins") from
    page 256, only checks the file systems entered in the NET-SNMP configuration,
    **`check_snmp_storage.pl`** is capable of querying any storage media—even swap
    space or main memory—without previous configuration on the target host. **`check_snmp_storage.pl`**
    tests the partial tree **`mib-2`**. host here, while **`check_snmp_mem.pl`** uses
    **`ucdavis.memory`**, so that it remains restricted to NET-SNMP.
  id: totrans-2035
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然 **`check_snmp_disk`** 插件，如第 256 页的 [11.4.1 使用 nagios-snmp-plugins 监控硬盘空间和进程](../Text/ch11s04.html#monitoring_hard_drive_space_and_processe
    "11.4.1 使用 nagios-snmp-plugins 监控硬盘空间和进程") 中所述，仅检查在 NET-SNMP 配置中输入的文件系统，但 **`check_snmp_storage.pl`**
    能够查询任何存储介质——甚至交换空间或主内存——无需在目标主机上进行预先配置。**`check_snmp_storage.pl`** 测试的是 **`mib-2`**
    的部分树，这里的 **`host`**，而 **`check_snmp_mem.pl`** 使用 **`ucdavis.memory`**，因此它仍然局限于
    NET-SNMP。
- en: 'The fact that you do not have to battle with OIDs, but instead can work with
    descriptions of the **`swap space`** type to specify the type of the storage medium,
    provides a certain level of convenience. These can be queried with **`snmpwalk`**
    as follows:'
  id: totrans-2036
  prefs: []
  type: TYPE_NORMAL
  zh: 你不必与 OID 作战，而是可以使用 **`swap space`** 类型的描述来指定存储介质的类型，这提供了一定程度的便利。这些可以通过以下方式使用
    **`snmpwalk`** 进行查询：
- en: '[PRE255]'
  id: totrans-2037
  prefs: []
  type: TYPE_PRE
  zh: '[PRE255]'
- en: 'When the plugin is called, the text specified after the **`STRING`**: is sufficient
    or—if unique—a part of this:'
  id: totrans-2038
  prefs: []
  type: TYPE_NORMAL
  zh: 当插件被调用时，**`STRING`**之后指定的文本就足够了，或者如果唯一的话，是这部分的一部分：
- en: '[PRE256]'
  id: totrans-2039
  prefs: []
  type: TYPE_PRE
  zh: '[PRE256]'
- en: In the second example, it is sufficient to specify **`Swap`**, in order to query
    the data for **`Swap Space`**, since the pattern is unique. The **`-f`** option
    ensures that **`check_snmp_storage.pl`** will include performance data in its
    output.
  id: totrans-2040
  prefs: []
  type: TYPE_NORMAL
  zh: 在第二个示例中，只需指定**`Swap`**，即可查询**`交换空间`**的数据，因为模式是唯一的。**`-f`**选项确保**`check_snmp_storage.pl`**将在其输出中包含性能数据。
- en: '**`-w`** and **`-c`** specify in normal fashion the warning or critical limits
    in percent of the available memory space. The following overview lists all the
    options:'
  id: totrans-2041
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`**和**`-c`**以常规方式指定可用内存空间的警告或临界限制的百分比。以下概述列出了所有选项：'
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  id: totrans-2042
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`地址`*``** **`/ --host=`****``*`地址`*``**'
- en: This is the host name or IP address of the NET-SNMP agent that is to be queried.
  id: totrans-2043
  prefs: []
  type: TYPE_NORMAL
  zh: 这是将要查询的NET-SNMP代理的主机名或IP地址。
- en: '**`-C`** **``*`string`*``** **`/ --community=`****``*`string`*``**'
  id: totrans-2044
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`字符串`*``** **`/ --community=`****``*`字符串`*``**'
- en: This is the community string for read access.
  id: totrans-2045
  prefs: []
  type: TYPE_NORMAL
  zh: 这是读取访问的共同体字符串。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-2046
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`端口`*``** **`/ --port=`****``*`端口`*``**'
- en: '**``*`port`*``** specifies an alternative port if the SNMP agent is not running
    on the default UDP port 161.'
  id: totrans-2047
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`端口`*``**指定一个替代端口，如果SNMP代理不在默认的UDP端口161上运行。'
- en: '**`-m`** **``*`string`*``** **`/ --name=`****``*`string`*``**'
  id: totrans-2048
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-m`** **``*`字符串`*``** **`/ --name=`****``*`字符串`*``**'
- en: '**``*`string`*``** contains a description of the device to be queried, corresponding
    to its description in **`hrStorageDescr`** (see above), such as **`-m "Swap Space"`**
    for swap devices, **`-m "Real Memory"`** for the main memory, or **`-m "/usr"`**
    for the partition mounted under **`/usr`** in the file tree.'
  id: totrans-2049
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`字符串`*``**包含要查询的设备的描述，对应于其在**`hrStorageDescr`**中的描述（见上文），例如**`-m "交换空间"`**用于交换设备，**`-m
    "真实内存"`**用于主内存，或**`-m "/usr"`**用于文件树中挂载在**`/usr`**的分区。'
- en: '**`-w`** **``*`percent`*``** **`/ --warn=`****``*`percent`*``**'
  id: totrans-2050
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`百分比`*``** **`/ --warn=`****``*`百分比`*``**'
- en: A warning is given in the default if the proportion of used memory is larger
    than the specified threshold. Other warning limits can be defined with the **`-T`**
    parameter.
  id: totrans-2051
  prefs: []
  type: TYPE_NORMAL
  zh: 如果使用的内存比例超过指定的阈值，默认情况下会发出警告。其他警告限制可以通过**`-T`**参数定义。
- en: '**`-c`** **``*`crit`*``** **`/ --critical=`****``*`crit`*``**'
  id: totrans-2052
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`临界`*``** **`/ --critical=`****``*`临界`*``**'
- en: In the default, the status is categorized as critical if the proportion of used
    memory is larger than the specified critical limit. Other critical limits can
    also be specified with the **`-T`** parameter.
  id: totrans-2053
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，如果使用的内存比例超过指定的临界限制，状态将被分类为临界。也可以通过**`-T`**参数指定其他临界限制。
- en: '**`-T`** **``*`option`*``** **`/ --type=`****``*`option`*``**'
  id: totrans-2054
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-T`** **``*`选项`*``** **`/ --type=`****``*`选项`*``**'
- en: What do the critical and the warning thresholds refer to?
  id: totrans-2055
  prefs: []
  type: TYPE_NORMAL
  zh: 临界和警告阈值指的是什么？
- en: '**`pu`** (*percent used*): used capacity in percent'
  id: totrans-2056
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`pu`** (*使用百分比*): 使用容量（百分比）'
- en: '**`pl`** (*percent left*): free capacity in percent'
  id: totrans-2057
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`pl`** (*剩余百分比*): 百分比剩余空间'
- en: '**`bu`** (*bytes used*): used capacity in megabytes'
  id: totrans-2058
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`bu`** (*使用字节*): 使用容量（兆字节）'
- en: '**`bl`** (*bytes left*): free capacity in megabytes'
  id: totrans-2059
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**`bl`** (*剩余字节*): 百分比剩余空间'
- en: The default is -**`T pu`**.
  id: totrans-2060
  prefs: []
  type: TYPE_NORMAL
  zh: 默认是**`-T pu`**。
- en: '**`-r`** **`/ --noregexp`**'
  id: totrans-2061
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-r`** **`/ --noregexp`**'
- en: Normally the description in the **`-m`** parameter is treated as a regular expression.
    For example, **`/var`** here stands for all file systems containing **`/var`**,
    for example **`/var and /var/spool/imap`**, provided that these are really two
    independent file systems. The **`-r`** option switches off the regular expression
    capability, so that specifying **`/var`** will then match this file system exactly,
    but not **`/var/spool/imap`**, for example.
  id: totrans-2062
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，**`-m`**参数中的描述被视为正则表达式。例如，这里的**`/var`**代表包含**`/var`**的所有文件系统，例如**`/var`**和**`/var/spool/imap`**，前提是这些确实是两个独立的文件系统。**`-r`**选项关闭正则表达式功能，因此指定**`/var`**将精确匹配此文件系统，但不匹配例如**`/var/spool/imap`**。
- en: '**`-s`** **`/ --sum`**'
  id: totrans-2063
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-s`** **`/ --sum`**'
- en: Instead of performing individual tests for several specified storage media,
    the total occupied space is added up and compared to the total capacity. It is
    then determined whether thresholds are exceeded.
  id: totrans-2064
  prefs: []
  type: TYPE_NORMAL
  zh: 而不是对几个指定的存储介质进行单独测试，将总占用空间加起来并与总容量进行比较。然后确定是否超过阈值。
- en: '**`-i`** **`/ --index`**'
  id: totrans-2065
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-i`** **`/ --index`**'
- en: 'With **`-m`**, a text is normally specified, which turns up again in the description
    **`hrStorageDescr`**. With the **`-i`** option, the index table is used instead
    of the description. Here the Regexp capability also applies: **`-m 2`** matches
    all the entries containing the number **`2`** in the index (that is, **`2, 12,
    20`**, etc.). It then makes sense to use the **`-r`** option at the same time.'
  id: totrans-2066
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 **`-m`**，通常指定一个文本，该文本会在描述 **`hrStorageDescr`** 中再次出现。使用 **`-i`** 选项时，使用索引表而不是描述。在这里，正则表达式功能也适用：**`-m
    2`** 匹配索引中包含数字 **`2`** 的所有条目（即，**`2, 12, 20`** 等）。因此，同时使用 **`-r`** 选项是有意义的。
- en: '**`-e`** **`/ --exclude`**'
  id: totrans-2067
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-e`** **`/ --exclude`**'
- en: Now all the memories that are matched by the **`-m`** specification are excluded
    from the test, the remaining ones are included in the test.
  id: totrans-2068
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，所有与 **`-m`** 规范匹配的内存都被排除在测试之外，剩余的内存包含在测试中。
- en: '**`-f`** **`/--perfparse`**'
  id: totrans-2069
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-f`** **`/--perfparse`**'
- en: This option provides an additional output of performance data that is not shown
    in the Web interface but can be evaluated by additonal tools (see [Chapter 19](../Text/ch19.html
    "Chapter 19. Graphic Display of Performance Data")).
  id: totrans-2070
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项提供额外的性能数据输出，这些数据未在 Web 界面中显示，但可以通过其他工具评估（见[第 19 章](../Text/ch19.html "第 19
    章。性能数据的图形显示")）。
- en: Testing system load with **`check_snmp_load`**
  id: totrans-2071
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用 **`check_snmp_load`** 测试系统负载
- en: The plugin compares either the average system load in form of averages of 1
    min, 5 min, and 15 min, or the CPU load in percent.
  id: totrans-2072
  prefs: []
  type: TYPE_NORMAL
  zh: 插件比较平均系统负载，形式为一分钟、五分钟和十五分钟的平均值，或者以百分比表示的 CPU 负载。
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  id: totrans-2073
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
- en: This is the host name or IP address of the NET-SNMP agent to be queried.
  id: totrans-2074
  prefs: []
  type: TYPE_NORMAL
  zh: 这是将被查询的 NET-SNMP 代理的主机名或 IP 地址。
- en: '**`-C`** **``*`string`*``** **`/ --community=`****``*`string`*``**'
  id: totrans-2075
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-C`** **``*`string`*``** **`/ --community=`****``*`string`*``**'
- en: This is the community string for read access.
  id: totrans-2076
  prefs: []
  type: TYPE_NORMAL
  zh: 这是读取访问的社区字符串。
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  id: totrans-2077
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
- en: '**``*`port`*``** is the alternative UDP port on which the SNMP agent is running.
    The default is UDP port 161.'
  id: totrans-2078
  prefs: []
  type: TYPE_NORMAL
  zh: '**``*`port`*``** 是 SNMP 代理运行的替代 UDP 端口。默认为 UDP 端口 161。'
- en: '**`-w`** **``*`warning_limit`*``** **`/ --warn=`****``*`warning_limit`*``**'
  id: totrans-2079
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-w`** **``*`warning_limit`*``** **`/ --warn=`****``*`warning_limit`*``**'
- en: The warning limit is given either as a simple integer value in percent (e.g.,
    **`90`**) or as an integer triplet separated by commas, which defines the thresholds
    for the system load average for one, five, and 15 minutes (e.g., **`8,5,5`**).
    The percentage load, on the other hand, always refers to the CPU load of the last
    minute.
  id: totrans-2080
  prefs: []
  type: TYPE_NORMAL
  zh: 警告限制可以是一个简单的整数百分比（例如，**`90`**）或由逗号分隔的整数三元组，它定义了系统负载平均的阈值，用于一分钟、五分钟和十五分钟（例如，**`8,5,5`**）。另一方面，百分比负载始终指代最后分钟的
    CPU 负载。
- en: If the plugin queries a NET-SNMP agent, you *must* additionally specify the
    **`-L`** option in the second variation, for the percentage, **`-N`**.
  id: totrans-2081
  prefs: []
  type: TYPE_NORMAL
  zh: 如果插件查询 NET-SNMP 代理，则必须在第二种变体中另外指定 **`-L`** 选项，对于百分比，**`-N`**。
- en: '**`-c`** **``*`critical_limit`*``** **`/ --crit=`****``*`critical_limit`*``**'
  id: totrans-2082
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`critical_limit`*``** **`/ --crit=`****``*`critical_limit`*``**'
- en: This specifies a critical limit; the syntax is the same as that for **`-w`**.
  id: totrans-2083
  prefs: []
  type: TYPE_NORMAL
  zh: 这指定了一个临界限制；语法与 **`-w`** 相同。
- en: '**`-L`** **`/ --linux`**'
  id: totrans-2084
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-L`** **`/ --linux`**'
- en: This option specifies that the plugin queries the system mode of a Linux system
    via NET-SNMP.
  id: totrans-2085
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项指定插件通过 NET-SNMP 查询 Linux 系统的系统模式。
- en: '**`-A`** **`/ --as400`**'
  id: totrans-2086
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-A`** **`/ --as400`**'
- en: This option specifies that the CPU loaded on an AS/400 machine is queried.
  id: totrans-2087
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项指定查询 AS/400 机器上的 CPU 负载。
- en: '**`-I`** **`/ --cisco`**'
  id: totrans-2088
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-I`** **`/ --cisco`**'
- en: This option specifies that the CPU load of a Cisco network component is involved.
  id: totrans-2089
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项指定 Cisco 网络组件的 CPU 负载涉及。
- en: '**`-N`** **`/ --netsnmp`**'
  id: totrans-2090
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-N`** **`/ --netsnmp`**'
- en: If the plugin queries the percentage CPU load of a Linux system via NET-SNMP,
    the **`-N`** option must be specified.
  id: totrans-2091
  prefs: []
  type: TYPE_NORMAL
  zh: 如果插件通过 NET-SNMP 查询 Linux 系统的 CPU 负载百分比，则必须指定 **`-N`** 选项。
- en: '**`-f`** **`/--perfparse`**'
  id: totrans-2092
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-f`** **`/--perfparse`**'
- en: This option ensures the output of performance data that is not displayed in
    the Web interface, but can be evaluated by additional tools (see [Chapter 19](../Text/ch19.html
    "Chapter 19. Graphic Display of Performance Data")).
  id: totrans-2093
  prefs: []
  type: TYPE_NORMAL
  zh: 此选项确保输出未在 Web 界面中显示的性能数据，但可以通过其他工具评估（见[第 19 章](../Text/ch19.html "第 19 章。性能数据的图形显示")）。
- en: 'The following example queries the system load on the computer **`swobspace`**
    via NET-SNMP and specifies threshold values for the one-, five-, and fifteen-minute
    averages:'
  id: totrans-2094
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例通过NET-SNMP查询计算机**`swobspace`**的系统负载，并指定了一分钟、五分钟和十五分钟平均值的阈值：
- en: '[PRE257]'
  id: totrans-2095
  prefs: []
  type: TYPE_PRE
  zh: '[PRE257]'
- en: The second example involves the percentage CPU load on the same machine. Here
    we additionally request performance data, which as usual repeats not only the
    measured value but also the thresholds.
  id: totrans-2096
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个示例涉及同一台机器的CPU负载百分比。在这里，我们除了请求性能数据外，还像往常一样重复了测量的值和阈值。
- en: '* * *'
  id: totrans-2097
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[117](#CHP-11-FN-15)]) [http://www.nagiosexchange.org/SNMP.51.0.html](http://www.nagiosexchange.org/SNMP.51.0.html)
  id: totrans-2098
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[117](#CHP-11-FN-15)]) [http://www.nagiosexchange.org/SNMP.51.0.html](http://www.nagiosexchange.org/SNMP.51.0.html)
- en: ^([[118](#CHP-11-FN-16)]) [ftp://ftp.hometree.net/pub/nagios-snmp-plugins/](ftp://ftp.hometree.net/pub/nagios-snmp-plugins/)
  id: totrans-2099
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[118](#CHP-11-FN-16)]) [ftp://ftp.hometree.net/pub/nagios-snmp-plugins/](ftp://ftp.hometree.net/pub/nagios-snmp-plugins/)
- en: ^([[119](#CHP-11-FN-17)]) [http://nagios.sourceforge.net/download/contrib/misc/check_traffic/](http://nagios.sourceforge.net/download/contrib/misc/check_traffic/)
  id: totrans-2100
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[119](#CHP-11-FN-17)]) [http://nagios.sourceforge.net/download/contrib/misc/check_traffic/](http://nagios.sourceforge.net/download/contrib/misc/check_traffic/)
- en: ^([[120](#CHP-11-FN-18)]) [http://www.nagiosexchange.org//51;37](http://www.nagiosexchange.org//51;37)
  id: totrans-2101
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[120](#CHP-11-FN-18)]) [http://www.nagiosexchange.org//51;37](http://www.nagiosexchange.org//51;37)
- en: ^([[121](#CHP-11-FN-19)]) [http://www.mrtg.org/](http://www.mrtg.org/)
  id: totrans-2102
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[121](#CHP-11-FN-19)]) [http://www.mrtg.org/](http://www.mrtg.org/)
- en: Chapter 12. The Nagios Notification System
  id: totrans-2103
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第12章. Nagios通知系统
- en: What would be the point of system and network monitoring if it did not inform
    the right contact partner when things went wrong? Hardly any system or network
    administrator can afford to keep an eye on the Nagios Web interface continually
    and wait for changes in status to occur. A practical working system must inform
    the admin actively (push information), so that the admin has time to devote to
    other things and needs to intervene only when Nagios raises the alarm.
  id: totrans-2104
  prefs: []
  type: TYPE_NORMAL
  zh: 如果系统出现问题时没有通知正确的联系人，系统和网络监控还有什么意义？几乎没有任何系统或网络管理员能够持续关注Nagios Web界面并等待状态变化。一个实用的工作系统必须主动通知管理员（推送信息），这样管理员就有时间处理其他事情，并且只有在Nagios发出警报时才需要干预。
- en: Whether a notification system does its job in practice or not is ultimately
    decided by how well it can be adjusted to the requirements of a specific situation.
    What may already be a critical error for one person may, for another, not be normal
    but still tolerable, and nothing is worse than being bombarded with supposed error
    messages that are not even seen as errors in a certain environment. An excess
    of wrong information can make the administrator careless, and at some point the
    real problems get lost in a flood of false messages.
  id: totrans-2105
  prefs: []
  type: TYPE_NORMAL
  zh: 一个通知系统是否在实际中发挥作用，最终取决于它如何适应特定情况的要求。对某个人来说可能是关键错误的错误，对另一个人来说可能不是正常但仍然可以容忍的，没有什么比被大量看似错误但甚至在某些环境中不被视为错误的消息轰炸更糟糕了。过多的错误信息会使管理员变得粗心大意，并且最终真正的问题会淹没在错误消息的洪流中。
- en: Nagios provides a sophisticated notification system allowing your own environment
    to be fine-tuned to your own requirements. The wide range of settings at first
    seem confusing, but once you have understood the basic principle, everything becomes
    much clearer.
  id: totrans-2106
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios提供了一个复杂的通知系统，允许您根据自身需求对环境进行精细调整。一开始的广泛设置可能看起来令人困惑，但一旦理解了基本原理，一切都会变得清晰许多。
- en: 'The efforts to keep Nagios small and modular also apply to the notification
    system: sending a message is again left by the system to external programs: from
    a simple e-mail through SMS, down to hardware solutions—such as a real traffic
    light on the server cabinet—anything is possible.'
  id: totrans-2107
  prefs: []
  type: TYPE_NORMAL
  zh: 保持Nagios小巧和模块化的努力也适用于通知系统：发送消息再次由系统交给外部程序：从简单的电子邮件到短信，再到硬件解决方案——例如服务器机柜上的真实交通灯——任何可能的事情都是可能的。
- en: 12.1 Who Should be Informed of What, When?
  id: totrans-2108
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 12.1 应在何时通知谁？
- en: 'In order for Nagios to send meaningful messages, the administrator must answer
    four questions:'
  id: totrans-2109
  prefs: []
  type: TYPE_NORMAL
  zh: 为了让Nagios发送有意义的消息，管理员必须回答四个问题：
- en: When should the system generate a message?
  id: totrans-2110
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 系统应在何时生成消息？
- en: When should it be delivered?
  id: totrans-2111
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 应在何时发送？
- en: Whom should the system inform?
  id: totrans-2112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 系统应通知谁？
- en: How should the message be sent?
  id: totrans-2113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 消息应该如何发送？
- en: '![An overview of the notification system](../Images/tagoreillycom20081104nostarchimages223820.png)'
  id: totrans-2114
  prefs: []
  type: TYPE_IMG
  zh: '![通知系统的概述](../Images/tagoreillycom20081104nostarchimages223820.png)'
- en: Figure 12-1. An overview of the notification system
  id: totrans-2115
  prefs: []
  type: TYPE_NORMAL
  zh: 图12-1. 通知系统的概述
- en: '[Figure 12-1](../Text/ch12.html#an_overview_of_the_notification_system "Figure 12-1. An
    overview of the notification system") gives a rough outline of the concept. The
    service and host check generate the message, which then runs through various filters,^([[122](#ftn.CHP-12-FN-1)])
    which usually refer to the time. The *contact* refers to the person whom Nagios
    should inform. If the message has passed all tests, the system hands it to an
    external program, which informs the respective contact.'
  id: totrans-2116
  prefs: []
  type: TYPE_NORMAL
  zh: '[图12-1](../Text/ch12.html#an_overview_of_the_notification_system "图12-1. 通知系统的概述")给出了概念的大致轮廓。服务和主机检查生成消息，然后该消息通过各种过滤器，^([[122](#ftn.CHP-12-FN-1)])这些通常与时间有关。*联系人*指的是Nagios应该通知的人。如果消息通过了所有测试，系统将其交给一个外部程序，该程序通知相应的联系人。'
- en: '* * *'
  id: totrans-2117
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[122](#CHP-12-FN-1)]) Strictly speaking, filters defined in the host or service
    prevent a message from being created, instead of filtering already generated messages.
    To keep things simple, however, we pretend that Nagios has created a message that
    is then discarded by a corresponding filter.
  id: totrans-2118
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[122](#CHP-12-FN-1)]) 严格来说，在主机或服务中定义的过滤器阻止消息的创建，而不是过滤已经生成的消息。然而，为了简化问题，我们假设Nagios创建了一个随后被相应过滤器丢弃的消息。
- en: 12.2 When Does a Message Occur?
  id: totrans-2119
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 12.2 消息何时发生？
- en: 'Each message is preceded by a host or service check, which determines the current
    status. In the following two cases it generates a message:'
  id: totrans-2120
  prefs: []
  type: TYPE_NORMAL
  zh: 每条消息都由主机或服务检查开始，这确定了当前状态。在以下两种情况下，它会生成一条消息：
- en: One hard state changes to another hard state.
  id: totrans-2121
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一个硬状态变为另一个硬状态。
- en: One computer or service remains in a hard error state. (The test therefore confirms
    a problem that already exists.)
  id: totrans-2122
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一台计算机或服务保持在一个硬错误状态。（因此，测试确认了一个已经存在的问题。）
- en: 'To remind you: the **`max_check_attempts`** parameter (see [2.3 Defining the
    Machines to Be Monitored, with host](../Text/ch02s03.html "2.3 Defining the Machines
    to Be Monitored, with host") and [2.5 Defining Services to Be Monitored with service](../Text/ch02s05.html
    "2.5 Defining Services to Be Monitored with service")) defines in host and service
    objects how often a test should be repeated before Nagios categorizes a new status
    as "hard." If it is set to **`1`**, this is immediately the case and is followed
    by the corresponding message. With a value greater than 1, the system repeats
    the test that number of times, and only if they all come to the same new result—such
    as determining the CRITICAL error status—does the status finally change to the
    new hard state, thus triggering a new notification.'
  id: totrans-2123
  prefs: []
  type: TYPE_NORMAL
  zh: 为了提醒您：**`max_check_attempts`** 参数（参见[2.3 定义要监控的机器，包括主机](../Text/ch02s03.html
    "2.3 定义要监控的机器，包括主机")和[2.5 定义要监控的服务](../Text/ch02s05.html "2.5 定义要监控的服务"))定义了在主机和服务对象中，在Nagios将新状态分类为“硬”之前，测试应该重复多少次。如果设置为**`1`**，这立即就是情况，并随后产生相应的消息。如果值大于1，系统会重复测试这么多次数，并且只有当它们都得到相同的新结果——例如确定CRITICAL错误状态——状态才会最终变为新的硬状态，从而触发新的通知。
- en: As long as Nagios has not exhausted the specified number of repeats, a soft
    state exists. If the old status reoccurs before these have finished, the administrator
    remains uninformed unless he looks at the Web interface or in the log file. Ultimately
    the administrator is only interested in genuine unsolved problems. On the other
    hand, to assess availability as such, it normally does matter if a service is
    not available for minutes on end, which is why the soft states are also taken
    into account in the evaluation.
  id: totrans-2124
  prefs: []
  type: TYPE_NORMAL
  zh: 只要Nagios没有达到指定的重复次数，就存在一个软状态。如果在这些重复完成之前旧状态再次出现，除非管理员查看Web界面或日志文件，否则管理员将不会得到通知。最终，管理员只对真正的未解决问题感兴趣。另一方面，为了评估可用性，通常连续几分钟服务不可用确实很重要，这就是为什么在评估中也考虑了软状态。
- en: 12.3 The Message Filter
  id: totrans-2125
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 12.3 消息过滤器
- en: Even if you define on a systemwide basis that Nagios may bring attention to
    errors not just through the Web interface and log files but also via e-mail and/or
    SMS, filter parameters in the host and service definition may in individual cases
    cancel out these basic decisions. In all cases the final word is had by the filters
    defined for the relevant contact. Which parameters play a role on each of these
    three levels (systemwide, host/service, contact), is described in [Figure 12-2](../Text/ch12s03.html#the_filter_sequence_in_the_nagios_notif
    "Figure 12-2. The filter sequence in the Nagios notification system (some parameters
    are only available starting with Nagios version 3.0)").
  id: totrans-2126
  prefs: []
  type: TYPE_NORMAL
  zh: 即使您在系统范围内定义Nagios不仅可以通过Web界面和日志文件，还可以通过电子邮件和/或短信来引起对错误的注意，但在某些情况下，主机和服务定义中的过滤器参数可能会取消这些基本决定。在所有情况下，最终决定权在于为相关联系人定义的过滤器。在每个这三个级别（系统范围、主机/服务、联系人）上起作用的参数是什么，在[图12-2](../Text/ch12s03.html#the_filter_sequence_in_the_nagios_notif
    "图12-2. Nagios通知系统中的过滤器序列（一些参数仅从Nagios版本3.0开始可用")中有描述。
- en: If a filter stops a notification, the filter chain ends "in a vacuum," so to
    speak—filter options further down in the hierarchy remain unaccounted for—and
    Nagios does not generate any message.
  id: totrans-2127
  prefs: []
  type: TYPE_NORMAL
  zh: 如果一个过滤器阻止了通知，那么过滤器链就“在真空中”结束，换句话说——在层次结构中更低的过滤器选项仍然没有被考虑——Nagios不会生成任何消息。
- en: '![The filter sequence in the Nagios notification system (some parameters are
    only available starting with Nagios version 3.0)](../Images/tagoreillycom20081104nostarchimages223822.png.jpg)'
  id: totrans-2128
  prefs: []
  type: TYPE_IMG
  zh: '![Nagios通知系统中的过滤器序列（一些参数仅从Nagios版本3.0开始可用）](../Images/tagoreillycom20081104nostarchimages223822.png.jpg)'
- en: Figure 12-2. The filter sequence in the Nagios notification system (some parameters
    are only available starting with Nagios version 3.0)
  id: totrans-2129
  prefs: []
  type: TYPE_NORMAL
  zh: 图12-2. Nagios通知系统中的过滤器序列（一些参数仅从Nagios版本3.0开始可用）
- en: 12.3.1 Switching messages on and off systemwide
  id: totrans-2130
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.3.1 在系统范围内开启和关闭消息
- en: 'With the **`enable_notifications`** parameter in the central configuration
    file **`nagios.cfg`**, you can in principal define whether Nagios should send
    messages at all. Only if it is set to **`1`** will the notification system work:'
  id: totrans-2131
  prefs: []
  type: TYPE_NORMAL
  zh: 在中央配置文件**`nagios.cfg`**中的**`enable_notifications`**参数，原则上可以定义Nagios是否应该发送消息。只有当它设置为**`1`**时，通知系统才会工作：
- en: '[PRE258]'
  id: totrans-2132
  prefs: []
  type: TYPE_PRE
  zh: '[PRE258]'
- en: 12.3.2 Enabling and suppressing computer and service-related messages
  id: totrans-2133
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.3.2 启用和抑制计算机和服务相关的消息
- en: When defining a host or service, various parameters can influence the messaging
    system. Here you can define, for example, at what time Nagios should send messages,
    whether the contact person is regularly informed of error states, and about which
    states or changes in state he should be informed (just CRITICAL, or WARNING as
    well, etc.).
  id: totrans-2134
  prefs: []
  type: TYPE_NORMAL
  zh: 在定义主机或服务时，各种参数可以影响消息系统。在这里，您可以定义，例如，Nagios应该在什么时间发送消息，是否应该定期通知联系人错误状态，以及关于哪些状态或状态变化他应该被告知（仅CRITICAL，或者WARNING等）。
- en: 'The switch **`notifications_enabled`** determines whether this specific computer
    or service is important enough for the admin to be informed of errors not just
    through the Web interface, but also in other ways as well. If this is so, the
    parameter must be set to **`1`**:'
  id: totrans-2135
  prefs: []
  type: TYPE_NORMAL
  zh: 开关**`notifications_enabled`**确定这个特定的计算机或服务是否足够重要，以至于管理员不仅应该通过Web界面，还应该通过其他方式被告知错误。如果是这样，该参数必须设置为**`1`**：
- en: '[PRE259]'
  id: totrans-2136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE259]'
- en: This is also the case in the default, so that you have to set the value explicitly
    to **`0`** at this point to stop separate notifications.
  id: totrans-2137
  prefs: []
  type: TYPE_NORMAL
  zh: 这也是默认情况，因此您必须在此处显式地将值设置为**`0`**以停止单独的通知。
- en: Taking downtimes into account
  id: totrans-2138
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 考虑停机时间
- en: At times when a specific service or host is intentionally not available, Nagios
    should certainly not send any error messages through the network. The configuration
    of corresponding maintenance periods (*downtime scheduling*) is only possible
    through the Web interface and is described in [16.3 Planning Downtimes](../Text/ch16s03.html
    "16.3 Planning Downtimes") from page 359.
  id: totrans-2139
  prefs: []
  type: TYPE_NORMAL
  zh: 在特定服务或主机故意不可用的时候，Nagios当然不应该通过网络发送任何错误消息。相应的维护期配置（*停机时间安排*）只能通过Web界面进行，并在第359页的[16.3
    计划停机时间](../Text/ch16s03.html "16.3 计划停机时间")中描述。
- en: What states and changes of state are worth a notification?
  id: totrans-2140
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 哪些状态和状态变化值得发送通知？
- en: 'If a regular test shows that service or computer is changing its data continuously,
    this is called *flapping* in Nagios (see also [Appendix B](../Text/apb.html "Appendix B. Rapidly
    Alternating States: Flapping") from page 611). If the **`flap_detection_enabled`**
    parameter is set to **`1`**, the system tries to detect this situation.'
  id: totrans-2141
  prefs: []
  type: TYPE_NORMAL
  zh: 如果常规测试显示服务或计算机正在持续更改其数据，这在Nagios中被称为*摆动*（参见第611页的[附录B](../Text/apb.html "附录B.
    快速交替状态：摆动"））。如果将**`flap_detection_enabled`**参数设置为**`1`**，系统会尝试检测这种情况。
- en: 'Whether Nagios sends a message in this case depends on the **`notification_options`**
    filter. This decides on which states or changes of state Nagios will inform the
    contact involved. In host definitions it can have the following combinations of
    values, separated by commas: **`d`** (switched off or crashed, *down*), **`u`**
    (*unreachable*), **`r`** (computer again reachable, *recovered*), and **`f`**
    (quickly alternating state, *flapping*). Starting with Nagios 3.0, there is an
    additional value **`s`**, which is used to send notifications if a planned maintenance
    period is about to start, end, or is canceled.'
  id: totrans-2142
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，Nagios是否发送消息取决于**`notification_options`**过滤器。这决定了Nagios将通知涉及哪些状态或状态变化。在主机定义中，它可以有以下值的组合，用逗号分隔：**`d`**（关闭或崩溃，*down*），**`u`**（*不可达*），**`r`**（计算机再次可达，*恢复*），和**`f`**（快速交替状态，*摆动*）。从Nagios
    3.0开始，还有一个额外的值**`s`**，用于在计划维护期即将开始、结束或取消时发送通知。
- en: 'For service objects, **`notification_options`** recognizes the following states:
    **`c`** (CRITICAL), **`w`** (WARNING), **`u`** (UNKNOWN, unknown problem), **`r`**
    (service again reachable, *recovered*), and **`f`** (*flapping*). From Nagios
    3.0 onward, the value s is also available for sending notifications on planned
    maintenance periods.'
  id: totrans-2143
  prefs: []
  type: TYPE_NORMAL
  zh: 对于服务对象，**`notification_options`**识别以下状态：**`c`**（CRITICAL，关键），**`w`**（WARNING，警告），**`u`**（UNKNOWN，未知问题），**`r`**（服务再次可达，*恢复*），和**`f`**（*摆动*）。从Nagios
    3.0开始，也可以使用值s在计划维护期间发送通知。
- en: Nagios correspondingly informs the admin of the state of the service whose definition
    is contained in the line
  id: totrans-2144
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios相应地通知管理员包含在行中的服务定义的状态。
- en: '[PRE260]'
  id: totrans-2145
  prefs: []
  type: TYPE_PRE
  zh: '[PRE260]'
- en: only if this is critical or was recreated after an error state. Messages involving
    a WARNING or flapping are discarded by the system.
  id: totrans-2146
  prefs: []
  type: TYPE_NORMAL
  zh: 只有在这是关键情况或是在错误状态之后重新创建的情况下，系统才会丢弃涉及警告或摆动状态的消息。
- en: If **`notification_options`** is set to **`n`** (*none*), Nagios will generally
    not send a message concerning this computer or service.
  id: totrans-2147
  prefs: []
  type: TYPE_NORMAL
  zh: 如果**`notification_options`**设置为**`n`**（*none*），Nagios通常不会发送关于此计算机或服务的消息。
- en: When should Nagios send messages?
  id: totrans-2148
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Nagios应在何时发送消息？
- en: 'At what time should a message be sent? This can be defined with the **`notification_period`**
    parameter:'
  id: totrans-2149
  prefs: []
  type: TYPE_NORMAL
  zh: 消息应在何时发送？这可以通过**`notification_period`**参数来定义：
- en: '[PRE261]'
  id: totrans-2150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE261]'
- en: '**`notification_period`** expects a time object (see [2.10 Defining a Time
    Period with timeperiod](../Text/ch02s10.html "2.10 Defining a Time Period with
    timeperiod") from page 74) as the value; **`24x7h`** is such a value and stands
    for "round the clock."'
  id: totrans-2151
  prefs: []
  type: TYPE_NORMAL
  zh: '**`notification_period`**期望一个时间对象（参见第74页的[2.10 使用timeperiod定义时间周期](../Text/ch02s10.html
    "2.10 使用timeperiod定义时间周期"））作为值；**`24x7h`**是一个这样的值，代表“全天候”。'
- en: Outside the specified time period, Nagios suppresses possible messages, but
    does not simply discard them, in contrast to the other filters. Instead of this,
    the system places the message in a kind of queue and sends it as soon as the notification
    period begins (*rescheduling*). This means that the relevant contact will certainly
    get to hear about the problem. Nagios also ensures that the admin receives the
    message only once, even if multiple messages on the same event were generated
    outside the time period.
  id: totrans-2152
  prefs: []
  type: TYPE_NORMAL
  zh: 在指定时间周期之外，Nagios会抑制可能的消息，但不会简单地丢弃它们，这与其他过滤器不同。相反，系统将消息放入一种队列中，并在通知周期开始时发送它（*重新安排*）。这意味着相关的联系人一定会了解到这个问题。Nagios还确保管理员只收到一次消息，即使在该时间段外生成了关于同一事件的多个消息。
- en: '**`notification_period`** is the only time-controlled filter in which a message
    is not lost, despite filtering. With all the other time filters, the message never
    reaches its destination outside the specified period of time.'
  id: totrans-2153
  prefs: []
  type: TYPE_NORMAL
  zh: '**`notification_period`**是唯一一个即使经过过滤也不会丢失消息的时间控制过滤器。与其他所有时间过滤器不同，消息永远不会在指定的时间周期之外到达目的地。'
- en: 'With an *interval check*, Nagios can be instructed to report at regular intervals
    on problems that persist for a longer time:'
  id: totrans-2154
  prefs: []
  type: TYPE_NORMAL
  zh: 通过**`interval check`**，Nagios可以指示在较长时间持续的问题上定期报告：
- en: '[PRE262]'
  id: totrans-2155
  prefs: []
  type: TYPE_PRE
  zh: '[PRE262]'
- en: If a state persists that Nagios should normally report, corresponding to the
    **`notification_option`** parameter—CRITICAL, for example—for along time, the
    system would grant this wish, in the example, every 120 time units (normally,
    minutes). In other words it suppresses the notification that is generated anyway
    with every check, after a corresponding notification until the specified time
    has elapsed. If nothing has changed in the state until then, it then sends the
    corresponding notification.
  id: totrans-2156
  prefs: []
  type: TYPE_NORMAL
  zh: 如果Nagios应该报告的状态持续存在，对应于**`notification_option`**参数——例如，CRITICAL——很长时间，系统就会满足这个愿望，例如，每120个时间单位（通常是分钟）一次。换句话说，它抑制了在相应的通知发送后，直到指定时间过去之前，每次检查都会生成的通知。如果在此期间状态没有发生变化，那么它随后会发送相应的通知。
- en: 'If you set **`notification_interval`** to **`0`**, Nagios will send a notification
    of this only once. You should be careful when doing this, however: filters defined
    for the contact can also reject messages. If you normally generate just one single
    message, which might arrive at the relevant admin outside the admin''s chosen
    contact time period, then the admin will never be told anything about the problem,
    even if it persists into working hours.'
  id: totrans-2157
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你将**`notification_interval`**设置为**`0`**，Nagios只会发送一次此类通知。然而，在进行此操作时你应该小心：为联系人定义的过滤器也可能拒绝消息。如果你通常只生成一条单一的消息，这条消息可能在不属于管理员选择的时间段内到达相关管理员，那么管理员将永远不会被告知任何关于问题的信息，即使问题持续到工作时间。
- en: Starting with Nagios 3.0, the parameter **`first_notification_delay`** allows
    the delayed sending of a notification. With the setting
  id: totrans-2158
  prefs: []
  type: TYPE_NORMAL
  zh: 从Nagios 3.0开始，参数**`first_notification_delay`**允许延迟发送通知。使用设置
- en: '[PRE263]'
  id: totrans-2159
  prefs: []
  type: TYPE_PRE
  zh: '[PRE263]'
- en: Nagios sends notification only after 15 time units (usually minutes) have expired.
    If the system administrator responsible for handling the problem posts an acknowledgement
    within the delay period ([16.1.2 Taking responsibility for problems](../Text/ch16.html#taking_responsibility_for_problems
    "16.1.2 Taking responsibility for problems") from page 332), the notification
    will not be sent, but if the administrator does not react in time, then Nagios
    sends the first notification once the delay period has expired. This option is
    useful for avoiding unneeded notifications when administrators use the Web interface
    to check on the system periodically during their regular working hours.
  id: totrans-2160
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios仅在15个时间单位（通常是分钟）过期后发送通知。如果负责处理问题的系统管理员在延迟期内（[16.1.2 对问题的负责](../Text/ch16.html#taking_responsibility_for_problems
    "16.1.2 对问题的负责")，第332页）发布确认，则不会发送通知，但如果管理员没有及时反应，那么一旦延迟期过期，Nagios就会发送第一次通知。此选项对于避免在管理员在正常工作时间期间使用Web界面定期检查系统时发送不必要的通知非常有用。
- en: Whose concern is the message?
  id: totrans-2161
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 消息是谁关注的？
- en: 'The contact group defined in the host or service object does not itself belong
    to the message filters, but it still decides on who is informed and who is not:'
  id: totrans-2162
  prefs: []
  type: TYPE_NORMAL
  zh: 在主机或服务对象中定义的联系人组本身不属于消息过滤器，但它仍然决定谁被通知，谁不被通知：
- en: '[PRE264]'
  id: totrans-2163
  prefs: []
  type: TYPE_PRE
  zh: '[PRE264]'
- en: 'What contacts belong to the specified group (here: **`admins`**) is defined
    by the corresponding **`contact_group`** object in its definition object (see
    also [2.8 The Message Recipient: contactgroup](../Text/ch02s08.html "2.8 The Message
    Recipient: contactgroup") from page 72):'
  id: totrans-2164
  prefs: []
  type: TYPE_NORMAL
  zh: 哪些联系人属于指定的组（此处：**`admins`**）是由其定义对象中的相应**`contact_group`**对象定义的（参见[2.8 消息接收者：联系人组](../Text/ch02s08.html
    "2.8 消息接收者：联系人组")，第72页）：
- en: '[PRE265]'
  id: totrans-2165
  prefs: []
  type: TYPE_PRE
  zh: '[PRE265]'
- en: 'The specified contact group, though, merely makes a rough preselection: which
    of the contacts specified in it actually receive the message depends on the filter
    functions in the definition of the individual contact. In this way you can ensure
    that one employee is only notified during normal office hours, another one round-the-clock,
    and that one of them is kept up to date about all changes in status, and the other
    one is informed only of a selection (for example, only CRITICAL but not WARNING).'
  id: totrans-2166
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管指定的联系人组仅进行粗略的预选：其中指定的哪些联系人实际上会收到消息取决于单个联系人定义中的过滤器函数。通过这种方式，你可以确保一位员工只在正常办公时间内被通知，另一位员工全天候被通知，其中一位员工需要了解所有状态变化，而另一位员工只被通知选择的一部分（例如，只有CRITICAL而不是WARNING）。
- en: 12.3.3 Person-related filter options
  id: totrans-2167
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.3.3 与人员相关的过滤器选项
- en: When defining the **`contact`** objects, the method is also specified in which
    Nagios delivers the notification in specific cases (see [12.4 External Notification
    Programs](../Text/ch12s04.html "12.4 External Notification Programs") from page
    275). It can be described separately for host and service problems. Several parallel
    methods are also possible, such as via e-mail *and* SMS.
  id: totrans-2168
  prefs: []
  type: TYPE_NORMAL
  zh: 在定义**`contact`**对象时，也指定了Nagios在特定情况下如何发送通知的方法（参见第275页的[12.4 外部通知程序](../Text/ch12s04.html
    "12.4 外部通知程序")）。它可以分别针对主机和服务问题进行描述。还可能有几种并行方法，例如通过电子邮件**和**短信。
- en: Since the contact-related filters are specifically for the corresponding contact
    object, it can certainly be useful to define several contacts for one and the
    same recipient that differ in individual parameters, such as a contact object
    that keeps the person informed via e-mail of all problems during normal working
    hours, and a second one for SMS messages concerning critical events outside working
    hours.
  id: totrans-2169
  prefs: []
  type: TYPE_NORMAL
  zh: 由于与联系人相关的过滤器专门针对相应的联系人对象，因此为同一个收件人定义几个参数不同的联系人肯定是有用的，例如一个联系人对象在正常工作时间通过电子邮件通知所有问题，另一个用于工作外时间的短信消息。
- en: What should Nagios inform you about?
  id: totrans-2170
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Nagios应该通知你什么？
- en: 'The events for which somebody should be informed can be specified not only
    by host or service, but also by contact. Host and service-related states are defined
    separately here:'
  id: totrans-2171
  prefs: []
  type: TYPE_NORMAL
  zh: 应通知某人的事件不仅可以由主机或服务指定，也可以由联系人指定。在这里分别定义与主机和服务相关的状态：
- en: '[PRE266]'
  id: totrans-2172
  prefs: []
  type: TYPE_PRE
  zh: '[PRE266]'
- en: The possible values are the same as those for the host-service parameter **`notification_options`**
    ([12.3.2 Enabling and suppressing computer and service-related messages](../Text/ch12s03.html#enabling_and_suppressing_computer_and_s
    "12.3.2 Enabling and suppressing computer and service-related messages")).
  id: totrans-2173
  prefs: []
  type: TYPE_NORMAL
  zh: 可能的值与主机-服务参数**`notification_options`**相同（参见第12.3.2节的[启用和抑制计算机和服务相关消息](../Text/ch12s03.html#enabling_and_suppressing_computer_and_s
    "启用和抑制计算机和服务相关消息")）。
- en: 'From Nagios 3.0 onward you can normally switch notifications for host and service
    on and off via an additional parameter:'
  id: totrans-2174
  prefs: []
  type: TYPE_NORMAL
  zh: 从Nagios 3.0开始，您通常可以通过一个附加参数来切换主机和服务的通知：
- en: '[PRE267]'
  id: totrans-2175
  prefs: []
  type: TYPE_PRE
  zh: '[PRE267]'
- en: The value 0 prevents the corresponding messages, and the value 1 ensures that
    the messages are sent. At first glance this corresponds to the value **`n`** (no
    notification) for the accompanying option parameter.
  id: totrans-2176
  prefs: []
  type: TYPE_NORMAL
  zh: 值0阻止相应的消息，值1确保消息被发送。乍一看，这对应于伴随选项参数的值**`n`**（无通知）。
- en: The two **`*_notifications_enabled`** parameters can also be switched on and
    off with the external commands **`ENABLE/DISABLE_CONTACT_HOST_NOTIFICATIONS`**
    and **`ENABLE/DISABLE_C0NTACT_SVC_N0TIFICATI0NS`**^([[123](#ftn.CHP-12-FN-2)])
    via the interface for external commands ([13.1 The Interface for External Commands](../Text/ch13.html#the_interface_for_external_commands
    "13.1 The Interface for External Commands") from page 292). This can be done with
    a script where the contact is concerned, without having to alter the preset **`*_notification_options`**.
  id: totrans-2177
  prefs: []
  type: TYPE_NORMAL
  zh: 两个**`*_notifications_enabled`**参数也可以通过外部命令**`ENABLE/DISABLE_CONTACT_HOST_NOTIFICATIONS`**和**`ENABLE/DISABLE_C0NTACT_SVC_N0TIFICATI0NS`**^([[123](#ftn.CHP-12-FN-2)])来开启和关闭，这是通过外部命令接口实现的（参见第292页的[13.1
    外部命令接口](../Text/ch13.html#the_interface_for_external_commands "13.1 外部命令接口")）。这可以通过一个涉及联系人的脚本完成，无需更改预设的**`*_notification_options`**。
- en: When do messages reach the recipient?
  id: totrans-2178
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 消息何时到达收件人？
- en: 'The final filter in the filter chain again refers to time periods. If a message
    is produced in the time period specified here, Nagios notifies the contact; otherwise
    it discards the message. The notification window can again be set separately for
    hosts and services, and as a value it expects a **`timeperiod`** object defined
    elsewhere:'
  id: totrans-2179
  prefs: []
  type: TYPE_NORMAL
  zh: 过滤链中的最后一个过滤器再次引用时间段。如果在此指定的时间段内产生消息，Nagios会通知联系人；否则它会丢弃该消息。通知窗口可以分别为主机和服务的设置，并且它期望一个在别处定义的**`timeperiod`**对象作为值：
- en: '[PRE268]'
  id: totrans-2180
  prefs: []
  type: TYPE_PRE
  zh: '[PRE268]'
- en: 12.3.4 Case examples
  id: totrans-2181
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.3.4 案例示例
- en: Letting you know once, but doing this reliably
  id: totrans-2182
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 通知一次，但可靠地完成
- en: What should you do if only a single message should be sent for each change in
    status of the service, but this message must always reach the relevant recipient
    during working hours? We can illustrate the solution to this problem through the
    example of the **`admins`** contact group to which the contact **`wob`** is assigned,
    ...
  id: totrans-2183
  prefs: []
  type: TYPE_NORMAL
  zh: 如果只为服务状态的每次变化发送一条消息，但这条消息必须在工作时间内始终到达相关收件人，你应该怎么做？我们可以通过将**`admins`**联系人组作为例子来说明这个问题的解决方案，该组分配了联系人**`wob`**，...
- en: '[PRE269]'
  id: totrans-2184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE269]'
- en: '... and to the **`PING`** service for the computer **`linux01`**:'
  id: totrans-2185
  prefs: []
  type: TYPE_NORMAL
  zh: '...以及针对计算机**`linux01`**的**`PING`**服务：'
- en: '[PRE270]'
  id: totrans-2186
  prefs: []
  type: TYPE_PRE
  zh: '[PRE270]'
- en: '**`notification_interval 0`** normally forces Nagios not to produce any repeat
    messages. The **`notification_period`** ensures the desired time period through
    the **`timeperiod`** object **`workhours`**: if Nagios raises the alarm at other
    times, the inbuilt *rescheduling* is used, that is, the notification is sent on
    its way only if the specified time period again applies. It is definitely not
    discarded.'
  id: totrans-2187
  prefs: []
  type: TYPE_NORMAL
  zh: '**`notification_interval 0`**通常强制Nagios不产生任何重复消息。**`notification_period`**通过**`timeperiod`**对象**`workhours`**确保所需的时间段：如果Nagios在其他时间发出警报，则使用内置的*重新安排*，即只有当指定的时间段再次适用时，才会发送通知。它绝对不会被丢弃。'
- en: In order for Nagios to be active in all changes of state, the **`notification_options`**
    must always cover all possible events for services.
  id: totrans-2188
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使Nagios在所有状态变化中保持活跃，**`notification_options`**必须始终覆盖所有可能的服务事件。
- en: 'To guarantee that the contact **`wob`** always receives the messages, it is
    essential that the **`service_notification_period`** in the corresponding **`contact`**
    object is **`24x7`**:'
  id: totrans-2189
  prefs: []
  type: TYPE_NORMAL
  zh: 为了确保联系人**`wob`**始终收到消息，重要的是在相应的**`contact`**对象中**`service_notification_period`**设置为**`24x7`**：
- en: '[PRE271]'
  id: totrans-2190
  prefs: []
  type: TYPE_PRE
  zh: '[PRE271]'
- en: 'A restricted time filter at this position could, under certain circumstances,
    lead to the loss of each of the individual messages. The same applies for the
    values of **`service_notification_options`**: only if all are entered here as
    well will no message be lost.'
  id: totrans-2191
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个位置设置一个受限的时间过滤器，在特定情况下可能会导致每个单独的消息丢失。对于**`service_notification_options`**的值也是如此：只有当所有这些值都输入到这里时，才不会丢失任何消息。
- en: Informing different admins at different times
  id: totrans-2192
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 在不同时间通知不同的管理员
- en: 'If you want to inform different persons at different times about different
    events, you may not restrict either the **`notification_period`** or the **`notification_options`**
    of a host or service:'
  id: totrans-2193
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想在不同的时间通知不同的人关于不同的事件，您可能不能限制主机或服务的**`notification_period`**或**`notification_options`**：
- en: '[PRE272]'
  id: totrans-2194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE272]'
- en: Filtering takes place exclusively for individual contacts. For this to work
    on a time level you must ensure that Nagios generates a message regularly (here
    every 120 time units, normally minutes) if error states persist.
  id: totrans-2195
  prefs: []
  type: TYPE_NORMAL
  zh: 过滤仅针对单个联系人进行。为了在时间级别上使其工作，您必须确保Nagios在错误状态持续时定期生成消息（此处为每120个时间单位，通常是分钟）。
- en: 'If admin A is to be informed only during his working hours, and then only of
    changes to critical or OK states, A''s contact object will be sent with the following
    parameters:'
  id: totrans-2196
  prefs: []
  type: TYPE_NORMAL
  zh: 如果管理员A只想在工作时间内收到通知，并且只通知关键或正常状态的变化，A的联系人对象将带有以下参数：
- en: '[PRE273]'
  id: totrans-2197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE273]'
- en: 'There is also a second and not quite so obvious difference to the first example:
    let us assume that the service reports the CRITICAL status at 7:30 in the morning,
    which will persist for several hours. The **`workhours`** object is defined so
    that it describes the time from Monday to Friday between 8:00 and 18:00\. In the
    above example, Nagios holds back the message (rescheduling), until the time period
    defined in it has been reached. The administrator therefore receives a corresponding
    message at 8:00.'
  id: totrans-2198
  prefs: []
  type: TYPE_NORMAL
  zh: 与第一个例子相比，还有一个第二个不那么明显的变化：让我们假设该服务在早上7:30报告CRITICAL状态，这将持续几个小时。**`workhours`**对象被定义为描述周一至周五上午8:00至下午18:00的时间。在上面的例子中，Nagios会暂时保留消息（重新安排），直到达到其中定义的时间段。因此，管理员将在8:00收到相应的消息。
- en: In the case described here, no rescheduling takes place, Nagios generates a
    corresponding message every two hours, which is filtered out if the contact is
    currently taking a "break." The system correspondingly discards the message at
    7:30, but allows the next message two hours later to pass through. The administrator
    therefore does not receive the corresponding information until 9:30, provided
    that the problem still exists at this point in time.
  id: totrans-2199
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里描述的情况下，不会进行重新安排，Nagios每两小时生成一条相应的消息，如果联系人当前正在休息，则该消息会被过滤掉。系统相应地在7:30丢弃该消息，但允许两小时后下一条消息通过。因此，如果问题仍然存在，管理员直到9:30才能收到相应的信息。
- en: Which of the two solutions is more suitable depends on specific requirements.
    For an e-mail notification, for example, it makes little difference if the administrator
    receives mails round-the-clock but reads them only when sitting in his office.
    A filter for Nagios messages in the mail client, sorting them in reverse chronological
    order (the most current mail first) makes sense in this case. Sitting in front
    of the screen, the administrator can also take a quick look at the Web interface
    when problems are announced, to check whether anything has changed.
  id: totrans-2200
  prefs: []
  type: TYPE_NORMAL
  zh: 两种解决方案哪一种更适合取决于具体要求。例如，对于电子邮件通知来说，管理员是否全天候接收邮件但只在办公室里阅读邮件几乎没有区别。在这种情况下，在邮件客户端中为Nagios消息设置过滤器，按倒序时间排序（最新的邮件排在前面）是有意义的。当问题被宣布时，管理员也可以在屏幕前快速查看Web界面，以检查是否有任何变化。
- en: If the methods of differentiation described so far are not sufficient, then
    escalation management, described in [12.5 Escalation Management](../Text/ch12s05.html
    "12.5 Escalation Management"), may be of further help.
  id: totrans-2201
  prefs: []
  type: TYPE_NORMAL
  zh: 如果到目前为止描述的微分方法不足以解决问题，那么在[12.5 升级管理](../Text/ch12s05.html "12.5 升级管理")中描述的升级管理可能有所帮助。
- en: '* * *'
  id: totrans-2202
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[123](#CHP-12-FN-2)]) See [http://www.nagios.org/developerinfo/externalcommands/](http://www.nagios.org/developerinfo/externalcommands/).
  id: totrans-2203
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[123](#CHP-12-FN-2)]) 查看 [http://www.nagios.org/developerinfo/externalcommands/](http://www.nagios.org/developerinfo/externalcommands/).
- en: 12.4 External Notification Programs
  id: totrans-2204
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 12.4 外部通知程序
- en: Which external programs deliver the messages is defined by the contact definition.
  id: totrans-2205
  prefs: []
  type: TYPE_NORMAL
  zh: 哪些外部程序传递消息由联系定义确定。
- en: 'Here there are again two parameters to define the commands to be used, one
    for services and one for hosts:'
  id: totrans-2206
  prefs: []
  type: TYPE_NORMAL
  zh: 这里又有两个参数用于定义要使用的命令，一个用于服务，一个用于主机：
- en: '[PRE274]'
  id: totrans-2207
  prefs: []
  type: TYPE_PRE
  zh: '[PRE274]'
- en: 'Both **`*_notification_commands`** allow comma-separated lists, so it is permitted
    to specify more than one command at the same time. The message is then sent simultaneously
    to the recipient in all the ways defined. The names of the command objects describe
    these ways: via e-mail and via SMS.'
  id: totrans-2208
  prefs: []
  type: TYPE_NORMAL
  zh: 两个**`*_notification_commands`**都允许逗号分隔的列表，因此可以同时指定多个命令。然后，消息会以定义的所有方式同时发送给所有接收者。命令对象的名称描述了这些方式：通过电子邮件和通过短信。
- en: To achieve a better overview, the corresponding commands are not defined together
    with the plugin commands in the file **`checkcommands.cfg`**, but in a separate
    object file, **`misccommands.cfg`**. Nagios loads these like any other file with
    object definitions, which is why any name can be chosen for them.
  id: totrans-2209
  prefs: []
  type: TYPE_NORMAL
  zh: 为了获得更好的概览，相应的命令不是与文件**`checkcommands.cfg`**中的插件命令一起定义，而是在一个单独的对象文件**`misccommands.cfg`**中定义。Nagios像加载任何其他具有对象定义的文件一样加载这些文件，这就是为什么可以为它们选择任何名称。
- en: The other parameters, **`email`**, **`pager`**, **`address1`**, and **`address2`**,
    can be regarded as variables. The delivery commands access the values set in these
    through macros. Whether **`pager`** contains a telephone number for SMS delivery
    or an e-mail address pointing to an e-mail SMS gateway is immaterial for the contact
    definition. The decisive factor is that the value matches the corresponding command
    that references this variable.
  id: totrans-2210
  prefs: []
  type: TYPE_NORMAL
  zh: 其他参数，**`email`**、**`pager`**、**`address1`**和**`address2`**，可以被视为变量。传递命令通过宏访问这些变量中设置的值。对于联系定义来说，**`pager`**是否包含用于短信发送的电话号码或指向电子邮件短信网关的电子邮件地址无关紧要。决定性因素是值与引用此变量的相应命令相匹配。
- en: 12.4.1 Notification via e-mail
  id: totrans-2211
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.4.1 通过电子邮件通知
- en: 'In defining the **`notify-by-email`** command, a name and the command line
    to be executed is specified, as with every other command object. Only its length
    is unusual, which is why it has had to be line-wrapped several times for this
    printed version:'
  id: totrans-2212
  prefs: []
  type: TYPE_NORMAL
  zh: 在定义**`notify-by-email`**命令时，指定一个名称和要执行的命令行，就像其他每个命令对象一样。只是它的长度不寻常，这就是为什么在这个打印版本中不得不多次换行：
- en: '[PRE275]'
  id: totrans-2213
  prefs: []
  type: TYPE_PRE
  zh: '[PRE275]'
- en: 'The printed-out command object comes from the included example file **`misccommands.cfg-sample`**.
    The command line defined in it can be reduced in principle to the following pattern:'
  id: totrans-2214
  prefs: []
  type: TYPE_NORMAL
  zh: 打印出的命令对象来自包含的示例文件**`misccommands.cfg-sample`**。其中定义的命令行在原则上可以简化为以下模式：
- en: '[PRE276]'
  id: totrans-2215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE276]'
- en: 'With the help of the macro, **`printf`** generates the message text, which
    is passed on to the mail program through a pipe. What is caused by the macros
    specifically used is revealed in [Table 12-1](../Text/ch12s04.html#macros_used_in_notify-by-email_and_host
    "Table 12-1. Macros used in notify-by-email and host-notify-by-email").^([[124](#ftn.CHP-12-FN-3)])
    Using this, the jumbo line shown above produces messages that look something like
    this:'
  id: totrans-2216
  prefs: []
  type: TYPE_NORMAL
  zh: 通过宏的帮助，**`printf`**生成消息文本，该文本通过管道传递给邮件程序。具体由哪些宏引起的情况在[表12-1](../Text/ch12s04.html#macros_used_in_notify-by-email_and_host
    "表12-1. 在通过电子邮件通知和主机通过电子邮件通知中使用的宏")中揭示。^([[124](#ftn.CHP-12-FN-3)]) 使用此方法，上述长行生成类似以下的消息：
- en: '[PRE277]'
  id: totrans-2217
  prefs: []
  type: TYPE_PRE
  zh: '[PRE277]'
- en: Table 12-1. Macros used in notify-by-email and host-notify-by-email
  id: totrans-2218
  prefs: []
  type: TYPE_NORMAL
  zh: 表12-1. 在通过电子邮件通知和主机通过电子邮件通知中使用的宏
- en: '| Macro | Description |'
  id: totrans-2219
  prefs: []
  type: TYPE_TB
  zh: '| 宏 | 描述 |'
- en: '| --- | --- |'
  id: totrans-2220
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| **`$CONTACTEMAIL$`** | Value of the **`email`** parameter from the contact
    definition |'
  id: totrans-2221
  prefs: []
  type: TYPE_TB
  zh: '| **`$CONTACTEMAIL$`** | 联系定义中**`email`**参数的值 |'
- en: '| **`$LONGDATETIME$`** | Long form of data specification, e.g., **`Fri Jan
    14 16:22:47 CET 2005`** |'
  id: totrans-2222
  prefs: []
  type: TYPE_TB
  zh: '| **`$LONGDATETIME$`** | 数据指定的长格式，例如，**`Fri Jan 14 16:22:47 CET 2005`** |'
- en: '| **`$HOSTALIAS$`** | Value of the **`alias`** parameter from the host definition
    |'
  id: totrans-2223
  prefs: []
  type: TYPE_TB
  zh: '| **`$HOSTALIAS$`** | 主机定义中**`alias`**参数的值 |'
- en: '| **`$HOSTADDRESS$`** | Value of the **`address`** parameter from the host
    definition |'
  id: totrans-2224
  prefs: []
  type: TYPE_TB
  zh: '| **`$HOSTADDRESS$`** | 主机定义中**`address`**参数的值 |'
- en: '| **`$HOSTNAME$`** | Value of the **`host_name`** parameter from the host definition
    |'
  id: totrans-2225
  prefs: []
  type: TYPE_TB
  zh: '| **`$HOSTNAME$`** | 主机定义中**`host_name`**参数的值 |'
- en: '| **`$HOSTOUTPUT$`** | Text output of the last host check |'
  id: totrans-2226
  prefs: []
  type: TYPE_TB
  zh: '| **`$HOSTOUTPUT$`** | 上次主机检查的文本输出 |'
- en: '| **`$HOSTSTATE$`** | State of the host: **`UP`**, **`DOWN`**, or **`UNREACHABLE`**
    |'
  id: totrans-2227
  prefs: []
  type: TYPE_TB
  zh: '| **`$HOSTSTATE$`** | 主机状态：**`UP`**、**`DOWN`**或**`UNREACHABLE`** |'
- en: '| **`$NOTIFICATIONTYPE$`** | Type of notification: **`PROBLEM`** (CRITICAL,
    WARNING, or UNKNOWN), **`RECOVERY`** (OK after error state), **`ACKNOWLEDGEMENT`**
    (an admin has confirmed the error state; see [16.1.2 Taking responsibility for
    problems](../Text/ch16.html#taking_responsibility_for_problems "16.1.2 Taking
    responsibility for problems"), page 332), **`FLAPPINGSTART`** or **`FLAPPINGSTOP`**
    |'
  id: totrans-2228
  prefs: []
  type: TYPE_TB
  zh: '| **`$NOTIFICATIONTYPE$`** | 通知类型：**`PROBLEM`**（CRITICAL、WARNING或UNKNOWN），**`RECOVERY`**（错误状态后的OK），**`ACKNOWLEDGEMENT`**（管理员已确认错误状态；见[16.1.2
    对问题的负责](../Text/ch16.html#taking_responsibility_for_problems "16.1.2 对问题的负责")，第332页），**`FLAPPINGSTART`**或**`FLAPPINGSTOP`**
    |'
- en: '| **`$SERVICEDESC$`** | Value of the **`description`** parameter in the service
    definition |'
  id: totrans-2229
  prefs: []
  type: TYPE_TB
  zh: '| **`$SERVICEDESC$`** | 服务定义中**`description`**参数的值 |'
- en: '| **`$SERVICEOUTPUT$`** | Text output of the last service check |'
  id: totrans-2230
  prefs: []
  type: TYPE_TB
  zh: '| **`$SERVICEOUTPUT$`** | 上次服务检查的文本输出 |'
- en: '| **`$SERVICESTATE$`** | State of the service: **`OK`**, **`WARNING`**, **`CRITICAL`**,
    **`UNKNOWN`** |'
  id: totrans-2231
  prefs: []
  type: TYPE_TB
  zh: '| **`$SERVICESTATE$`** | 服务状态：**`OK`**、**`WARNING`**、**`CRITICAL`**、**`UNKNOWN`**
    |'
- en: 'For the command **`host-notify-by-email`**, the command line looks similar,
    except that now host-related macros are used:'
  id: totrans-2232
  prefs: []
  type: TYPE_NORMAL
  zh: 对于命令**`host-notify-by-email`**，命令行看起来类似，但现在使用的是与主机相关的宏：
- en: '[PRE278]'
  id: totrans-2233
  prefs: []
  type: TYPE_PRE
  zh: '[PRE278]'
- en: 'It generates e-mails with the following content:'
  id: totrans-2234
  prefs: []
  type: TYPE_NORMAL
  zh: 它生成以下内容的电子邮件：
- en: '[PRE279]'
  id: totrans-2235
  prefs: []
  type: TYPE_PRE
  zh: '[PRE279]'
- en: 12.4.2 Notification via SMS
  id: totrans-2236
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.4.2 通过短信通知
- en: While the infrastructure necessary for sending e-mails^([[125](#ftn.CHP-12-FN-4)])
    is usually available anyway, programs for sending SMS messages such as **`yaps`**,^([[126](#ftn.CHP-12-FN-5)])
    **`smssend`**,^([[127](#ftn.CHP-12-FN-6)]) or **`smsclient`**^([[128](#ftn.CHP-12-FN-7)])
    usually have to be additionally installed. **`yaps`** and **`smsclient`** require
    a local modem or ISDN card and "telephone" directly with the cell phone provider
    (e.g., T-Mobile), **`smssend`** establishes a connection to the Internet servers
    of the cellphone provider and sends the SMS message on this route. With **`yaps`**
    and **`smsclient`** you can also use a mail gateway that generates and sends an
    SMS message from an e-mail.
  id: totrans-2237
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然发送电子邮件所需的基础设施通常总是可用的，但发送短信的程序，如**`yaps`**，^([[125](#ftn.CHP-12-FN-4)]) **`smssend`**，^([[126](#ftn.CHP-12-FN-5)])
    或**`smsclient`**^([[127](#ftn.CHP-12-FN-6)**)，通常需要额外安装。**`yaps`**和**`smsclient`**需要本地调制解调器或ISDN卡，并直接与手机服务提供商（例如，T-Mobile）“电话”联系，**`smssend`**则建立与手机服务提供商的互联网服务器的连接，并通过此路径发送短信。使用**`yaps`**和**`smsclient`**，您还可以使用一个邮件网关，该网关从电子邮件生成并发送短信。
- en: 'Whichever method you choose, you should be aware of possible interference in
    sending messages: a connection between the Nagios server and the Internet passes
    through many hosts, routers, and firewalls. Especially if Nagios is itself monitoring
    one of the computers involved, things get interesting: if this machine is down,
    then a message sent via **`smssend`** will no longer work either. The same thing
    applies for e-mail-SMS gateways. Whether a self-made construction is involved,
    with **`yaps`** or **`smsclient`**, each of which represents its own SMS gateway,
    or a telecom installation with a sophisticated unified messaging solution, if
    the actual sender of the SMS is many nodes removed from the Nagios server (because
    you have a networked telephone installation with several locations, for example),
    the chances increase that the message will not reach its destination because of
    an interrupted connection.'
  id: totrans-2238
  prefs: []
  type: TYPE_NORMAL
  zh: 无论你选择哪种方法，都应该意识到在发送消息时可能存在的干扰：Nagios服务器与互联网之间的连接要经过许多主机、路由器和防火墙。特别是如果Nagios本身正在监控涉及的某台计算机，事情就变得有趣了：如果这台机器宕机，那么通过**`smssend`**发送的消息将不再有效。同样适用于电子邮件-SMS网关。无论是涉及自制的结构，使用**`yaps`**或**`smsclient`**，每个都代表自己的SMS网关，还是具有复杂统一消息解决方案的电信安装，如果实际发送SMS的节点距离Nagios服务器很远（例如，因为你有一个具有多个位置的联网电话系统），由于连接中断，消息无法到达目标的可能性会增加。
- en: For this reason the best solution is an **`smsclient`** or **`yaps`** installation
    on the Nagios server itself with a direct telephone access. In larger, networked
    telephone systems you can also consider giving the telephone access a dedicated,
    direct line from the telephone system. Whether this is ISDN or analog is just
    a question here of the technology used.
  id: totrans-2239
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，最佳解决方案是在Nagios服务器本身上安装**`smsclient`**或**`yaps`**，并直接提供电话访问。在较大的、联网的电话系统中，你也可以考虑为电话访问提供从电话系统来的专用、直接线路。这里是否是ISDN或模拟只是所用技术的区别。
- en: To represent the programs mentioned here, we will take a closer look at **`smsclient`**,
    which can be configured very simply, and has an active community On its homepage
    you can also find a link to a mailing list whose members will be pleased to help
    in case you have questions.
  id: totrans-2240
  prefs: []
  type: TYPE_NORMAL
  zh: 为了表示这里提到的程序，我们将更详细地研究**`smsclient`**，它可以非常简单地配置，并且在其主页上有一个活跃的社区。你还可以在那里找到一个链接到邮件列表，其成员会乐意在你有问题时提供帮助。
- en: Setting up **`smsclient`**
  id: totrans-2241
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 设置**`smsclient`**
- en: While Debian has its own precompiled **`smsclient`** package, for SuSE and other
    distributions you have to compile the software yourself. For historical reasons
    the program itself is called **`sms_client`**; a short subtext is provided with
    **`man sms_client`**.
  id: totrans-2242
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然Debian有自己的预编译**`smsclient`**软件包，但对于SuSE和其他发行版，你必须自己编译软件。出于历史原因，程序本身被称为**`sms_client`**；在**`man
    sms_client`**中提供了一个简短的子文本。
- en: 'The installation from the source code follows the usual procedure:'
  id: totrans-2243
  prefs: []
  type: TYPE_NORMAL
  zh: 从源代码安装遵循常规流程：
- en: '[PRE280]'
  id: totrans-2244
  prefs: []
  type: TYPE_PRE
  zh: '[PRE280]'
- en: The only point worth mentioning here is that the "homemade" **`configure`**
    procedure manages without **`autoconf`** and **`automake`**.
  id: totrans-2245
  prefs: []
  type: TYPE_NORMAL
  zh: 这里值得提的一点是，“自制”的**`configure`**过程无需**`autoconf`**和**`automake`**。
- en: The configuration files listed in [Table 12-2](../Text/ch12s04.html#smsclients_configuration_files
    "Table 12-2. smsclients configuration files") are now located in the directory
    **`/etc/sms`**; the Debian package installs it to **`/etc/smsclient`**.
  id: totrans-2246
  prefs: []
  type: TYPE_NORMAL
  zh: '[表12-2](../Text/ch12s04.html#smsclients_configuration_files "表12-2. `smsclients`配置文件")中列出的配置文件现在位于目录**`/etc/sms`**；Debian软件包将其安装到**`/etc/smsclient`**。'
- en: Table 12-2. `smsclients` configuration files
  id: totrans-2247
  prefs: []
  type: TYPE_NORMAL
  zh: 表12-2. `smsclients`配置文件
- en: '| File | Description |'
  id: totrans-2248
  prefs: []
  type: TYPE_TB
  zh: '| 文件 | 描述 |'
- en: '| --- | --- |'
  id: totrans-2249
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| **`sms_addressbook`** | Definition of aliases and groups |'
  id: totrans-2250
  prefs: []
  type: TYPE_TB
  zh: '| **`sms_addressbook`** | 别名和组的定义 |'
- en: '| **`sms_config`** | Main configuration file |'
  id: totrans-2251
  prefs: []
  type: TYPE_TB
  zh: '| **`sms_config`** | 主要配置文件 |'
- en: '| **`sms_daemons`** | Configuration file for the daemon mode of **`smsclient`**,
    in which this can be reached via a proprietary protocol. Is not required. |'
  id: totrans-2252
  prefs: []
  type: TYPE_TB
  zh: '| **`sms_daemons`** | **`smsclient`**守护进程模式的配置文件，其中可以通过专有协议访问。不是必需的。 |'
- en: '| **`sms_modem`** | Modem configuration |'
  id: totrans-2253
  prefs: []
  type: TYPE_TB
  zh: '| **`sms_modem`** | 调制解调器配置 |'
- en: '| **`sms_services`** | Supported provider |'
  id: totrans-2254
  prefs: []
  type: TYPE_TB
  zh: '| **`sms_services`** | 支持的提供商 |'
- en: The file **`sms_services`** lists the supported providers and at the same time
    assigns them to the protocol used. The precise telephone number dialed is specified
    by the corresponding service file in the directory **`services`** (if you have
    compiled this yourself) or **`/usr/lib/smsclient/services`** (for Debian). In
    case of doubt, you should request the telephone number of your own mobile cell
    provider. The mailing list can also be of assistance here.
  id: totrans-2255
  prefs: []
  type: TYPE_NORMAL
  zh: 文件 **`sms_services`** 列出了支持的提供商，并同时将它们分配给使用的协议。精确的拨打电话号码由目录 **`services`**（如果你自己编译）或
    **`/usr/lib/smsclient/services`**（对于Debian）中的相应服务文件指定。如有疑问，你应该请求你自己的移动蜂窝提供商的电话号码。邮件列表在这里也可能有所帮助。
- en: 'In the file **`sms_config`** you set a default provider, which the program
    uses for calls when the provider is not specifically given:'
  id: totrans-2256
  prefs: []
  type: TYPE_NORMAL
  zh: 在文件 **`sms_config`** 中，你设置了一个默认的提供商，程序在未指定特定提供商时将使用它进行调用：
- en: '[PRE281]'
  id: totrans-2257
  prefs: []
  type: TYPE_PRE
  zh: '[PRE281]'
- en: 'Only the configuration of the modem is now missing in the file **`sms_modem`**.
    In principle, however, any modem that functions under Linux can be used. In the
    following example we address an ISDN card with the Isdn4Linux-HiSax driver:'
  id: totrans-2258
  prefs: []
  type: TYPE_NORMAL
  zh: 目前文件 **`sms_modem`** 中缺少的只是调制解调器的配置。然而，原则上，任何在Linux下工作的调制解调器都可以使用。以下示例中我们使用的是带有Isdn4Linux-HiSax驱动程序的ISDN卡：
- en: '[PRE282]'
  id: totrans-2259
  prefs: []
  type: TYPE_PRE
  zh: '[PRE282]'
- en: '**`/dev/ttyI0`** is used as the device here; for **`MDM_init_command`**, your
    own MSN is used. This applies particularly to private branch exchanges, which
    allow a connection only if your own MSN has been correctly specified.'
  id: totrans-2260
  prefs: []
  type: TYPE_NORMAL
  zh: 这里使用 **`/dev/ttyI0`** 作为设备；对于 **`MDM_init_command`**，使用你自己的MSN。这尤其适用于私人分支交换，它只允许在正确指定你自己的MSN时建立连接。
- en: Since Isdn4Linux does not recognize tone or pulse dialing, we use only **`D`**
    instead of the usual **`DT`** as the **`MDM_dial_command`**. If the ISDN connection
    requires an outside line as part of a phone exchange, you should enter the corresponding
    prefix; otherwise this string remains empty.
  id: totrans-2261
  prefs: []
  type: TYPE_NORMAL
  zh: 由于Isdn4Linux不识别音调或脉冲拨号，我们只使用 **`D`** 而不是通常的 **`DT`** 作为 **`MDM_dial_command`**。如果ISDN连接需要作为电话交换的一部分的外部线路，你应该输入相应的前缀；否则，此字符串保持为空。
- en: '**`smsclient`** requires write permissions both for the device used and for
    the log file **`/var/log/smsclient.log`**:'
  id: totrans-2262
  prefs: []
  type: TYPE_NORMAL
  zh: '**`smsclient`** 需要用于所使用的设备和日志文件 **`/var/log/smsclient.log`** 的写权限：'
- en: '[PRE283]'
  id: totrans-2263
  prefs: []
  type: TYPE_PRE
  zh: '[PRE283]'
- en: 'To test this, you should now send—preferably as the user **`nagios`**, who
    will later use **`smsclient`**—an SMS message to your own cellphone (here to be
    reached at the number **`01604711`**):'
  id: totrans-2264
  prefs: []
  type: TYPE_NORMAL
  zh: 为了测试这个，你现在应该发送——最好是作为用户 **`nagios`**（稍后将会使用 **`smsclient`**）——一条短信到你的手机（这里可以通过电话号码
    **`01604711`** 接达）：
- en: '[PRE284]'
  id: totrans-2265
  prefs: []
  type: TYPE_PRE
  zh: '[PRE284]'
- en: Getting Nagios to work together with **`smsclient`**
  id: totrans-2266
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使Nagios与 **`smsclient`** 协同工作
- en: 'If the second argument is missing in **`smsclient`**, which contains the message
    text, the program will read it from STDIN:'
  id: totrans-2267
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在 **`smsclient`** 中缺少第二个参数，即包含消息文本的参数，程序将从中读取STDIN：
- en: '[PRE285]'
  id: totrans-2268
  prefs: []
  type: TYPE_PRE
  zh: '[PRE285]'
- en: 'Based on the command **`notify-by-email`**, described from page 276, we will
    use the second variation here for defining the **`notify-by-sms`** command:'
  id: totrans-2269
  prefs: []
  type: TYPE_NORMAL
  zh: 基于命令 **`notify-by-email`**，如第276页所述，我们在此将使用第二个变体来定义 **`notify-by-sms`** 命令：
- en: '[PRE286]'
  id: totrans-2270
  prefs: []
  type: TYPE_PRE
  zh: '[PRE286]'
- en: 'As usual, the entire **`command_line`** is written on a single line. Nagios
    obtains the telephone number (or alias) through the macro **`$CONTACTPAGER$`**,
    which reads out the value of the **`pager`** parameter from the contact definition.
    Since an SMS here may not be longer than 150 characters, we will considerably
    abbreviate the information, compared to the e-mail message. To be on the safe
    side (you never know how long the plugin output (**`$SERVICEOUTPUT$`**) really
    is), the **`printf`** format specification **`.150`** (instead of **`%b`**) cuts
    off the text after 150 characters. Although we then do without the line breaks
    in the message, by means of **`\n`**, an SMS is never formatted cleanly, due to
    its limited display. Thus **`notify-by-sms`** generates a one-line message of
    the following type:'
  id: totrans-2271
  prefs: []
  type: TYPE_NORMAL
  zh: 如同往常，整个 **`command_line`** 都写在一行上。Nagios通过宏 **`$CONTACTPAGER$`** 获取电话号码（或别名），该宏从联系定义中读取
    **`pager`** 参数的值。由于这里的短信可能不超过150个字符，我们将与电子邮件消息相比大大缩短信息。为了安全起见（你永远不知道插件输出（**`$SERVICEOUTPUT$`**）的实际长度），**`printf`**
    格式说明符 **`.150`**（而不是 **`%b`**）在150个字符后截断文本。尽管我们通过 **`\n`** 在消息中省略了换行符，但由于其有限的显示，短信永远不会格式化得很好。因此
    **`notify-by-sms`** 生成以下类型的一行消息：
- en: '[PRE287]'
  id: totrans-2272
  prefs: []
  type: TYPE_PRE
  zh: '[PRE287]'
- en: '* * *'
  id: totrans-2273
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[124](#CHP-12-FN-3)]) A complete list of all macros is contained in the original
    documentation at [http://localhost/nagios/docs/macros.html](http://localhost/nagios/docs/macros.html)
    (normally to be found in the file system under **`/usr/local/nagios/share/docs/macros.html`**).
    For Nagios 3.0 the corresponding file **`macrolist.html`** can also be found in
    this directory.
  id: totrans-2274
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[124](#CHP-12-FN-3)]) 所有宏的完整列表包含在原始文档中，可在[http://localhost/nagios/docs/macros.html](http://localhost/nagios/docs/macros.html)（通常在文件系统中的**`/usr/local/nagios/share/docs/macros.html`**下找到）找到。对于Nagios
    3.0，相应的文件**`macrolist.html`**也可以在这个目录中找到。
- en: ^([[125](#CHP-12-FN-4)]) Apart from the **`/usr/bin/mail`** client, a local
    mail server is required.
  id: totrans-2275
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[125](#CHP-12-FN-4)]) 除了**`/usr/bin/mail`**客户端之外，还需要一个本地邮件服务器。
- en: ^([[126](#CHP-12-FN-5)]) **`[http://www.sta.to/ftp/yaps/](http://www.sta.to/ftp/yaps/)`**
  id: totrans-2276
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[126](#CHP-12-FN-5)]) **`[http://www.sta.to/ftp/yaps/](http://www.sta.to/ftp/yaps/)`**
- en: ^([[127](#CHP-12-FN-6)]) **`[http://zekiller.skytech.org/smssend_menu_en.html](http://zekiller.skytech.org/smssend_menu_en.html)`**
  id: totrans-2277
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[127](#CHP-12-FN-6)]) **`[http://zekiller.skytech.org/smssend_menu_en.html](http://zekiller.skytech.org/smssend_menu_en.html)`**
- en: ^([[128](#CHP-12-FN-7)]) **`[http://www.smsclient.org/](http://www.smsclient.org/)`**
  id: totrans-2278
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[128](#CHP-12-FN-7)]) **`[http://www.smsclient.org/](http://www.smsclient.org/)`**
- en: 12.5 Escalation Management
  id: totrans-2279
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 12.5 升级管理
- en: Whenever the administrators responsible cannot find a solution in the specified
    time when important components fail, although Service Level Agreements or other
    contracts commit the IT department to do this,^([[129](#ftn.CHP-12-FN-8)]) Nagios's
    ability to escalate notifications makes allowances for conflicts, at least on
    an organizational level. It can be used to provide multilevel support. For example,
    Nagios first informs the *First Level Support* (usually the *Help Desk*). If the
    problem still persists after one day, then the *Second Level Support* is notified,
    and so on.
  id: totrans-2280
  prefs: []
  type: TYPE_NORMAL
  zh: 当重要组件失败且负责的管理员在指定时间内找不到解决方案时，尽管服务水平协议或其他合同要求IT部门这样做，^([[129](#ftn.CHP-12-FN-8)])
    Nagios升级通知的能力允许在组织层面上至少解决冲突。它可以用来提供多级支持。例如，Nagios首先通知*第一级支持*（通常是*帮助台*）。如果问题在一天后仍然存在，那么就会通知*第二级支持*，依此类推。
- en: Nagios also makes a distinction here between host- and service-related escalation
    stages. In essence, both function identically.
  id: totrans-2281
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios在这里也对主机和服务相关的升级阶段进行了区分。本质上，它们的功能是相同的。
- en: 'In the escalation, Nagios does not count in time units, but in how many messages
    it has already sent out. In the following example the system should report on
    error states of the **`Database`** service on **`linux01`** every 120 minutes,^([[130](#ftn.CHP-12-FN-9)])
    and this, round-the-clock:'
  id: totrans-2282
  prefs: []
  type: TYPE_NORMAL
  zh: 在升级过程中，Nagios不按时间单位计算，而是按已发送的消息数量计算。在以下示例中，系统应每120分钟报告**`linux01`**上**`Database`**服务的错误状态，^([[130](#ftn.CHP-12-FN-9)])并且全天候：
- en: '[PRE288]'
  id: totrans-2283
  prefs: []
  type: TYPE_PRE
  zh: '[PRE288]'
- en: The corresponding messages always go to a contact group, so without escalation,
    that is to **`admins`**.
  id: totrans-2284
  prefs: []
  type: TYPE_NORMAL
  zh: 相应的消息总是发送到联系人组，因此没有升级时，就是发送到**`admins`**。
- en: '![Nagios escalates, depending on the number of messages already sent](../Images/tagoreillycom20081104nostarchimages223824.png.jpg)'
  id: totrans-2285
  prefs: []
  type: TYPE_IMG
  zh: '![Nagios根据已发送的消息数量进行升级](../Images/tagoreillycom20081104nostarchimages223824.png.jpg)'
- en: Figure 12-3. Nagios escalates, depending on the number of messages already sent
  id: totrans-2286
  prefs: []
  type: TYPE_NORMAL
  zh: 图12-3. Nagios根据已发送的消息数量进行升级
- en: After the fourth notification, Nagios should switch on the first stage of escalation
    (as illustrated in [Figure 12-3](../Text/ch12s05.html#nagios_escalates_comma_depending_on_the
    "Figure 12-3. Nagios escalates, depending on the number of messages already sent"))
    and, in addition to **`admins`**, should notify the **`second-level`** contact
    group. The eighth message triggers the second level, at which Nagios informs the
    **`contact_group third-level`**.
  id: totrans-2287
  prefs: []
  type: TYPE_NORMAL
  zh: 在第四次通知之后，Nagios应启动升级的第一阶段（如图12-3所示），除了**`admins`**之外，还应通知**`second-level`**联系人组。第八条消息触发第二级，此时Nagios会通知**`contact_group
    third-level`**。
- en: As shown in [Figure 12-3](../Text/ch12s05.html#nagios_escalates_comma_depending_on_the
    "Figure 12-3. Nagios escalates, depending on the number of messages already sent"),
    escalations may certainly overlap. It can also be seen from the graphics that
    the contact group defined in the service object only applies as long as Nagios
    does not escalate. As soon as an escalation stage is switched on, the system puts
    the default contact group out of action.
  id: totrans-2288
  prefs: []
  type: TYPE_NORMAL
  zh: 如[图12-3](../Text/ch12s05.html#nagios_escalates_comma_depending_on_the "图12-3.
    Nagios根据已发送的消息数量进行升级")所示，升级确实可以重叠。从图形中还可以看出，在服务对象中定义的联系人组仅在Nagios不进行升级时适用。一旦启动升级阶段，系统就会使默认联系人组失效。
- en: If the original contact group—here **`admins`**—should also receive a message
    in the first escalation level, then this must be additionally specified in the
    escalation definition. If several levels overlap, Nagios informs all the groups
    involved. In [Figure 12-3](../Text/ch12s05.html#nagios_escalates_comma_depending_on_the
    "Figure 12-3. Nagios escalates, depending on the number of messages already sent")
    the eighth to the tenth messages accordingly go both to **`admins`** and to **`second-level`**
    and **`third-level`**, while only the latter receives message numbers 11 and 12\.
    From message number 13, Nagios keeps only the contact group **`admins`** informed,
    since escalation is no longer defined here.
  id: totrans-2289
  prefs: []
  type: TYPE_NORMAL
  zh: 如果原始联系人组——这里为**`admins`**——在第一级升级中也应收到消息，那么必须在升级定义中额外指定。如果有多个级别重叠，Nagios将通知所有涉及的组。在[图12-3](../Text/ch12s05.html#nagios_escalates_comma_depending_on_the
    "图12-3. Nagios根据已发送的消息数量进行升级")中，第8到第10条消息相应地发送给**`admins`**和**`second-level`**以及**`third-level`**，而只有后者接收消息编号11和12。从消息编号13开始，Nagios只通知联系人组**`admins`**，因为此处不再定义升级。
- en: 'The latter takes place via separate **`serviceescalation`** (for services)
    and **`hostescalation`** objects (for computers). For a service escalation object,
    Nagios requires the beginning and the end of exceptional circumstances to be defined,
    apart from service details (consisting of the **`service_description`** and **`host_name`**)
    parameters and the name of the contact groups responsible:'
  id: totrans-2290
  prefs: []
  type: TYPE_NORMAL
  zh: 后者通过单独的**`serviceescalation`**（用于服务）和**`hostescalation`**对象（用于计算机）来实现。对于服务升级对象，Nagios除了服务详情（由**`service_description`**和**`host_name`**参数组成）和负责的联系人组名称之外，还要求定义异常情况开始和结束的时间：
- en: '[PRE289]'
  id: totrans-2291
  prefs: []
  type: TYPE_PRE
  zh: '[PRE289]'
- en: The escalation level defined here starts, as desired, with message No 4 and
    ends with message No 10\. If **`last_notification`** is given the value **`0`**,
    the escalation only ends if the service changes back to the OK state.
  id: totrans-2292
  prefs: []
  type: TYPE_NORMAL
  zh: 在此处定义的升级级别从所需的第4条消息开始，并以第10条消息结束。如果**`last_notification`**被赋予值**`0`**，则升级仅在服务返回到OK状态时才结束。
- en: 'In addition you must specify the **`notification_interval`** parameter for
    service escalations: this changes the notification interval (previously **`120`**
    according to the service definition) to **`60`** time units. This parameter is
    also mandatory for a host escalation. The only difference in the definition of
    a **`hostescalation`** object is that instead of the host name, you can also specify
    one or more host groups (in addition the **`service_description`** parameter is
    dropped, of course).'
  id: totrans-2293
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，您还必须指定服务升级的**`notification_interval`**参数：这改变了通知间隔（根据服务定义之前为**`120`**）到**`60`**时间单位。此参数对于主机升级也是强制性的。**`hostescalation`**对象定义的唯一区别是，除了主机名称外，您还可以指定一个或多个主机组（当然，**`service_description`**参数也被删除）。
- en: 'The second escalation step is defined in the same way:'
  id: totrans-2294
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个升级步骤以相同的方式定义：
- en: '[PRE290]'
  id: totrans-2295
  prefs: []
  type: TYPE_PRE
  zh: '[PRE290]'
- en: If there are overlapping escalations with different **`notification_intervals`**,
    Nagios chooses the smallest defined time unit in each case. Nagios therefore sends
    messages 8 to 10 at intervals of 60 minutes, numbers 11 and 12 at intervals of
    90 minutes, and then the original interval of 120 minutes again applies.
  id: totrans-2296
  prefs: []
  type: TYPE_NORMAL
  zh: 如果存在具有不同**`notification_intervals`**的重叠升级，Nagios将选择每种情况下定义的最小时间单位。因此，Nagios以60分钟的间隔发送消息8到10，以90分钟的间隔发送数字11和12，然后再次应用原始的120分钟间隔。
- en: With **`escalation_period`** and **`escalation_options`** there are two more
    setting parameters specially for escalations. Both have the same function as **`notification_period`**
    and **`notification_options`** in the host or service definition, but they refer
    only to the escalation case.
  id: totrans-2297
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**`escalation_period`**和**`escalation_options`**，有另外两个专门用于升级的设置参数。这两个参数与主机或服务定义中的**`notification_period`**和**`notification_options`**具有相同的功能，但它们仅适用于升级情况。
- en: In contrast to **`notification_interval`**, **`escalation_period`** *does not
    replace* the **`notification_period`**, but acts in addition to this. From the
    intersection of **`notification_period`** and **`escalation_period`**, the actual
    time period is deduced. Suppose that **`notification_period`** refers to the time
    between 7:00 A:M and 5:00 P.M., and **`escalation_period`** to the period from
    8:00 A.M. to 8:00 P.M.. Then Nagios will only send out messages in the escalation
    level between 8:00 A.M. and 5:00 P.M.. You must always remember here that it is
    only the number of messages that have already been sent that decides whether an
    escalation level exists. **`escalation_period`** and **`escalation_options`**
    only have an effect as additional filters.
  id: totrans-2298
  prefs: []
  type: TYPE_NORMAL
  zh: 与**`notification_interval`**相反，**`escalation_period`** *并不替代* **`notification_period`**，而是作为其补充。从**`notification_period`**和**`escalation_period`**的交集，可以推导出实际的时间段。假设**`notification_period`**指的是早上7:00到下午5:00的时间，而**`escalation_period`**指的是上午8:00到下午8:00的时间段。那么Nagios将只在上午8:00到下午5:00的升级级别发送消息。你必须始终记住，只有已经发送的消息数量决定了是否存在升级级别。**`escalation_period`**和**`escalation_options`**仅作为额外的过滤器起作用。
- en: 'Before these two parameters are used, you should carefully consider what it
    is you want to achieve with them. To restrict the escalation to a specific time
    period could under certain circumstances result in it being omitted entirely.
    If you restrict them to weekdays, for example, this would mean that if the **`Database`**
    service failed during the weekend, Nagios would inform the contact group **`admins`**
    only on Monday morning: over the weekend the system has already sent more than
    12 messages, so it no longer even uses its escalation mechanism. If there is a
    time restriction via **`escalation_period`**, you should set **`last_notification`**
    to **`0`** to ensure that the escalation really does take place.'
  id: totrans-2299
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用这两个参数之前，你应该仔细考虑你想通过它们实现什么。在某些情况下，将升级限制在特定时间段可能会导致它完全被省略。例如，如果你将它们限制在工作日，这意味着如果**`Database`**服务在周末失败，Nagios只会在周一早上通知联系人组**`admins`**：周末系统已经发送了超过12条消息，因此它甚至不再使用其升级机制。如果通过**`escalation_period`**有时间限制，你应该将**`last_notification`**设置为**`0`**，以确保升级确实发生。
- en: Every case of error is followed at some point in time by a recovery. An intelligent
    mechanism ensures that Nagios only notifies those contacts of the corresponding
    recovery who are in charge, depending on the active escalation level, and who
    also received the last notification to be sent.
  id: totrans-2300
  prefs: []
  type: TYPE_NORMAL
  zh: 每次错误都会在某个时间点之后被恢复。一个智能机制确保Nagios只通知那些负责的联系人，这些联系人根据活跃的升级级别，并且也收到了要发送的最后一项通知。
- en: '* * *'
  id: totrans-2301
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[129](#CHP-12-FN-8)]) These can also be internal specialist departments.
  id: totrans-2302
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[129](#CHP-12-FN-8)]) 这些也可以是内部的专业部门。
- en: ^([[130](#CHP-12-FN-9)]) To be precise, every 120 time units, whereby the default
    time unit is 60 seconds.
  id: totrans-2303
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[130](#CHP-12-FN-9)]) 严格来说，每120个时间单位，默认时间单位是60秒。
- en: 12.6 Accounting for Dependencies between Hosts and Services
  id: totrans-2304
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 12.6 主机和服务的依赖关系处理
- en: If you test services with local plugins (see [Chapter 7](../Text/ch07.html "Chapter 7. Testing
    Local Resources")) via NRPE (see [Chapter 10](../Text/ch10.html "Chapter 10. The
    Nagios Remote Plugin Executor (NRPE)")), all these tests will come to nothing
    the moment the Plugin Executor fails. With *service dependencies* you can prevent
    Nagios from flooding the appropriate administrator with messages on the dependent
    services. Instead of this, the system informs him specifically of the NRPE failure.
  id: totrans-2305
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你通过NRPE（见[第10章](../Text/ch10.html "第10章. Nagios远程插件执行器（NRPE）")）使用本地插件（见[第7章](../Text/ch07.html
    "第7章. 测试本地资源"））测试服务，一旦插件执行器失败，所有这些测试都将毫无意义。通过*服务依赖*，你可以防止Nagios向适当的管理员发送有关依赖服务的消息。相反，系统会具体通知他NRPE的失败情况。
- en: Aa with such service dependencies, Nagios also has *host dependencies*, which
    suppress messages, depending on individual hosts. Both variations can also be
    used to specifically "switch off" tests.
  id: totrans-2306
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种服务依赖的情况下，Nagios也有*主机依赖*，这会根据个别主机抑制消息。这两种变体也可以用来特别“关闭”测试。
- en: '12.6.1 The standard case: service dependencies'
  id: totrans-2307
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.6.1 标准情况：服务依赖
- en: Let us take as an example the host **`linux01`**, illustrated in [Figure 12-4](../Text/ch12s06.html#the_three_above-mentioned_services_depe
    "Figure 12-4. The three above-mentioned services depend on NRPE"), on which locally
    installed plugins, controlled via NRPE, monitor hard drive space (**`Disks`**
    service, see [10.5.3 Optimizing the configuration](../Text/ch10s05.html#optimizing_the_configuration
    "10.5.3 Optimizing the configuration")), the number of logged-in users (**`Users`**
    service), and the system load (**`Load`** service). If NRPE were now to fail,
    Nagios would announce the CRITICAL state for all three services, although their
    actual state is unknown, and the real problem is the "NRPE daemon."
  id: totrans-2308
  prefs: []
  type: TYPE_NORMAL
  zh: 以主机**`linux01`**为例，如[图12-4](../Text/ch12s06.html#the_three_above-mentioned_services_depe
    "图12-4. 上述三个服务依赖于NRPE")所示，该主机上本地安装的插件通过NRPE监控硬盘空间（**`Disks`**服务，见[10.5.3 优化配置](../Text/ch10s05.html#optimizing_the_configuration
    "10.5.3 优化配置"))、登录用户数（**`Users`**服务）和系统负载（**`Load`**服务）。如果NRPE现在失败，Nagios将宣布所有三个服务的CRITICAL状态，尽管它们的实际状态是未知的，而真正的问题是“NRPE守护进程”。
- en: In order to solve this contradiction, NRPE is monitored as a separate service
    and describes the dependencies in a **`servicedependency`** object.
  id: totrans-2309
  prefs: []
  type: TYPE_NORMAL
  zh: 为了解决这个矛盾，NRPE作为一个独立的服务进行监控，并在**`servicedependency`**对象中描述了依赖关系。
- en: '![The three above-mentioned services depend on NRPE](../Images/tagoreillycom20081104nostarchimages223826.png)'
  id: totrans-2310
  prefs: []
  type: TYPE_IMG
  zh: '![上述三个服务依赖于NRPE](../Images/tagoreillycom20081104nostarchimages223826.png)'
- en: Figure 12-4. The three above-mentioned services depend on NRPE
  id: totrans-2311
  prefs: []
  type: TYPE_NORMAL
  zh: 图12-4. 上述三个服务依赖于NRPE
- en: 'To define the additional service check for NRPE, we make use of the possibility
    of calling the **`check_nrpe`** plugin (see [Chapter 10](../Text/ch10.html "Chapter 10. The
    Nagios Remote Plugin Executor (NRPE)")) (almost) without any parameters at all.
    It then simply returns the version of the NRPE daemons being used:'
  id: totrans-2312
  prefs: []
  type: TYPE_NORMAL
  zh: 为了定义NRPE的附加服务检查，我们利用调用**`check_nrpe`**插件（见[第10章](../Text/ch10.html "第10章. Nagios远程插件执行器（NRPE）"))（几乎）没有任何参数的可能性。它将简单地返回正在使用的NRPE守护进程的版本：
- en: '[PRE291]'
  id: totrans-2313
  prefs: []
  type: TYPE_PRE
  zh: '[PRE291]'
- en: 'The command defined in [10.5 Nagios Configuration](../Text/ch10s05.html "10.5
    Nagios Configuration") in page 222, **`check_nrpe`**, requires further arguments
    and therefore cannot be used for our purposes. For this reason we set up a new
    command object, **`test_nrpe`**, which exclusively tests NRPE:'
  id: totrans-2314
  prefs: []
  type: TYPE_NORMAL
  zh: 在第222页[10.5 Nagios 配置](../Text/ch10s05.html "10.5 Nagios Configuration")中定义的命令**`check_nrpe`**需要额外的参数，因此不能用于我们的目的。因此，我们设置了一个新的命令对象**`test_nrpe`**，它专门测试NRPE：
- en: '[PRE292]'
  id: totrans-2315
  prefs: []
  type: TYPE_PRE
  zh: '[PRE292]'
- en: 'With this, an **`NRPE`** service can now be defined:'
  id: totrans-2316
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这种方式，现在可以定义一个**`NRPE`**服务：
- en: '[PRE293]'
  id: totrans-2317
  prefs: []
  type: TYPE_PRE
  zh: '[PRE293]'
- en: The dependencies of the three local services of NRPE are described by the following
    **`servicedependency`** object.
  id: totrans-2318
  prefs: []
  type: TYPE_NORMAL
  zh: NRPE的三个本地服务的依赖关系由以下**`servicedependency`**对象描述。
- en: '[PRE294]'
  id: totrans-2319
  prefs: []
  type: TYPE_PRE
  zh: '[PRE294]'
- en: '**`host_name`** and **`service_description`** define the master service, the
    failure of which leads to the failure of the services named in **`dependent_service_description`**
    on the computer specified in **`dependent_host_name`**. Multiple entries, separated
    by commas, are possible for all four parameters mentioned. You should bear in
    mind, however, that each dependent service is dependent on every possible master
    service.'
  id: totrans-2320
  prefs: []
  type: TYPE_NORMAL
  zh: '**`host_name`**和**`service_description`**定义了主服务，其故障会导致在**`dependent_host_name`**指定的计算机上名为**`dependent_service_description`**的服务失败。所有四个参数都可以有多个条目，用逗号分隔。然而，你应该记住，每个从属服务都依赖于每个可能的主服务。'
- en: 'The remaining parameters influence service checks and notifications: **`notification_failure_criteria`**
    specifies for which states of the master service notifications involving an error
    of the dependent services (e.g., **`Disks`**) should not appear. Possible values
    are **`u`** (UNKNOWN), **`w`** (WARNING), **`c`** (CRITICAL), **`p`** (PENDING,
    i.e., an initial check is planned but was so far not yet carried out), **`o`**
    (OK), and **`n`** (None).'
  id: totrans-2321
  prefs: []
  type: TYPE_NORMAL
  zh: 剩余的参数影响服务检查和通知：**`notification_failure_criteria`**指定对于主服务的哪些状态，涉及从属服务（例如**`Disks`**）错误的通告不应出现。可能的值是**`u`**（未知），**`w`**（警告），**`c`**（严重），**`p`**（挂起，即计划进行初始检查但尚未执行），**`o`**（正常）和**`n`**（无）。
- en: '**`u`**, **`c`** in the example above means that Nagios does not inform the
    administrators responsible of "errors" in the services **`Disks`**, **`Users`**,
    and **`Load`** on **`linux01`** if the master service is in the CRITICAL or UNKNOWN
    state. With an **`o`** for OK, the logic can be reversed: here there is no message
    if there is an error in the dependent service, as long as the master service is
    in an OK state. Accordingly, **`n`** means that Nagios provides a notification
    irrespective of the status of the master service.'
  id: totrans-2322
  prefs: []
  type: TYPE_NORMAL
  zh: '**`u`**, **`c`** 在上述示例中意味着，如果主服务处于 CRITICAL 或 UNKNOWN 状态，Nagios 不会通知负责 "错误"
    的管理员关于 **`Disks`**, **`Users`**, 和 **`Load`** 在 **`linux01`** 上的服务。如果用 **`o`**
    表示 OK，逻辑可以反转：这里在没有错误的情况下没有消息，只要主服务处于 OK 状态。相应地，**`n`** 表示无论主服务状态如何，Nagios 都会提供通知。'
- en: The **`execution_failure_criteria`** parameter controls tests, depending on
    the state of the master service. The details **`u`** (UNKNOWN), **`w`** (WARNING),
    **`c`** (CRITICAL), **`p`** (PENDING), **`o`** (OK), and **`n`** (None), as with
    **`notification_failure_criteria`**, refer to states of the master service for
    which there should be no check. In the example, **`n`** is specified, so that
    Nagios tests **`Disks`**, **`Users`**, and **`Load`** even if NRPE fails.
  id: totrans-2323
  prefs: []
  type: TYPE_NORMAL
  zh: '**`execution_failure_criteria`** 参数根据主服务状态控制测试。与 **`notification_failure_criteria`**
    一样，**`u`**（未知），**`w`**（警告），**`c`**（严重），**`p`**（挂起），**`o`**（正常），和 **`n`**（无），都指的是应该没有检查的主服务状态。在示例中，指定了
    **`n`**，因此即使 NRPE 失败，Nagios 也会测试 **`Disks`**, **`Users`**, 和 **`Load`**。'
- en: Nagios therefore suppresses messages, but since it still carries out the service
    checks on the dependent services, the Web interface always shows the current status
    of these.
  id: totrans-2324
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，Nagios 抑制消息，但由于它仍然在依赖服务上执行服务检查，Web 界面始终显示这些服务的当前状态。
- en: The details for **`notification_failure_criteria`** interact with the *Freshness
    mechanism* of passive tests (see [13.4 Reacting to Out-of-Date Information of
    Passive Checks](../Text/ch13s04.html "13.4 Reacting to Out-of-Date Information
    of Passive Checks") from page 295). If **`check_freshness`** is used in the service
    definition, and if Nagios considers the most recently determined status to be
    out of date, it will carry out active tests even if it ought to suppress them,
    according to the service dependency.
  id: totrans-2325
  prefs: []
  type: TYPE_NORMAL
  zh: '**`notification_failure_criteria`** 的详细信息与被动测试的 *Freshness 机制* 相互作用（参见第 295
    页的 [13.4 对被动检查过时信息的响应](../Text/ch13s04.html "13.4 对被动检查过时信息的响应")）。如果服务定义中使用了 **`check_freshness`**，并且
    Nagios 认为最近确定的状态已过时，它将根据服务依赖关系执行主动测试，即使它应该抑制它们。'
- en: Inheritance
  id: totrans-2326
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 继承
- en: 'Nagios does not automatically inherit dependencies. An example of this is shown
    in [Figure 12-5](../Text/ch12s06.html#multilevel_dependencies_for_services "Figure 12-5. Multilevel
    dependencies for services"): on the internal side of a firewall, the system should
    query various resources via SNMP. For security reasons, the test is performed
    indirectly via NRPE, that is, the Nagios server runs the SNMP plugins, which are
    installed on a host inside the file, indirectly via NRPE.'
  id: totrans-2327
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios 不自动继承依赖关系。一个例子在 [图 12-5](../Text/ch12s06.html#multilevel_dependencies_for_services
    "图 12-5. 服务多级依赖") 中显示：在防火墙的内部，系统应通过 SNMP 查询各种资源。出于安全原因，测试是通过 NRPE 间接执行的，也就是说，Nagios
    服务器运行安装在文件内部主机上的 SNMP 插件，间接通过 NRPE。
- en: '![Multilevel dependencies for services](../Images/tagoreillycom20081104nostarchimages223828.png)'
  id: totrans-2328
  prefs: []
  type: TYPE_IMG
  zh: '![服务的多级依赖](../Images/tagoreillycom20081104nostarchimages223828.png)'
- en: Figure 12-5. Multilevel dependencies for services
  id: totrans-2329
  prefs: []
  type: TYPE_NORMAL
  zh: 图 12-5. 服务的多级依赖
- en: 'The following two **`servicedependency`** objects describe a dependency between
    the **`SNMP`** (Master) service and the **`Disks`** service (dependent service)
    on the host **`linux04`**, as well as between the **`NRPE`** service on **`linux01`**
    and the **`SNMP`** service on **`linux04`**:'
  id: totrans-2330
  prefs: []
  type: TYPE_NORMAL
  zh: 以下两个 **`servicedependency`** 对象描述了主机 **`linux04`** 上 **`SNMP`**（主服务）和 **`Disks`**（依赖服务）之间的依赖关系，以及
    **`linux01`** 上的 **`NRPE`** 服务和 **`linux04`** 上的 **`SNMP`** 服务之间的依赖关系：
- en: '[PRE295]'
  id: totrans-2331
  prefs: []
  type: TYPE_PRE
  zh: '[PRE295]'
- en: 'If the NRPE daemon on **`linux01`** fails, Nagios would only recognize the
    defined dependencies between **`NRPE`** and **`SNMP`**, but not the implicit dependency
    between **`NRPE`** and **`Disks`**. To take these into account as well, the parameter
    **`inherits_parent`** is inserted in the definition of the service dependency
    between **`Disks`** and **`SNMP`**:'
  id: totrans-2332
  prefs: []
  type: TYPE_NORMAL
  zh: 如果 **`linux01`** 上的 NRPE 守护进程失败，Nagios 只会识别 **`NRPE`** 和 **`SNMP`** 之间的定义依赖关系，但不会识别
    **`NRPE`** 和 **`Disks`** 之间的隐式依赖关系。为了考虑这些依赖关系，在 **`Disks`** 和 **`SNMP`** 之间的服务依赖关系定义中插入参数
    **`inherits_parent`**。
- en: '[PRE296]'
  id: totrans-2333
  prefs: []
  type: TYPE_PRE
  zh: '[PRE296]'
- en: With this, Nagios tests whether the master service itself (here **`SNMP`**)
    is dependent on another service, thanks to a corresponding **`servicedependency`**.
    If the **`NRPE`** service on **`linux01`** fails (CRITICAL state), Nagios leaves
    out the check of **`Disks`** on **`linux04`**, thanks to **`execution_failure_criteria
    c, u`**, and also does not send any notification of the most recently detected
    status of **`Disks`**.
  id: totrans-2334
  prefs: []
  type: TYPE_NORMAL
  zh: 通过这种方式，Nagios 检查主服务本身（此处为 **`SNMP`**）是否依赖于另一个服务，这得益于相应的 **`servicedependency`**。如果
    **`linux01`** 上的 **`NRPE`** 服务失败（CRITICAL 状态），Nagios 将省略对 **`linux04`** 上的 **`Disks`**
    的检查，归功于 **`execution_failure_criteria c, u`**，并且也不会发送任何关于最近检测到的 **`Disks`** 状态的通知。
- en: Other application cases
  id: totrans-2335
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 其他应用案例
- en: Dependency definitions between services are particularly useful if a great deal
    depends on a single service, so that the actual problem is in danger of disappearing
    under a flood of error messages. Apart from the already described use in combination
    with NRPE, this applies for all services that the Nagios server cannot test directly
    and for which it must use tools instead (NRPE, SNMP, or even **`NSCLIENT`** for
    Windows, see [20.2.1 NSClient](../Text/ch20s02.html#nsclient "20.2.1 NSClient")).
    If a simple connection to the utility cannot be established and a constant value
    (version number, system name) cannot be queried, you can still use a generic plugin
    to address the corresponding port.
  id: totrans-2336
  prefs: []
  type: TYPE_NORMAL
  zh: 如果大量依赖单一服务，服务之间的依赖定义尤其有用，这样实际问题可能会在错误消息的洪流中消失。除了与 NRPE 结合使用之外，这也适用于 Nagios 服务器无法直接测试的所有服务，并且它必须使用工具（NRPE、SNMP
    或甚至 **`NSCLIENT`** 用于 Windows，见 [20.2.1 NSClient](../Text/ch20s02.html#nsclient
    "20.2.1 NSClient")）。如果无法建立到实用程序的简单连接并且无法查询常量值（版本号、系统名称），您仍然可以使用通用插件来访问相应的端口。
- en: 'Another example of using service dependencies are the applications that depend
    on a database: a Web application with dynamic Web pages fails if the underlying
    database (which may be located somewhere in the network on another host) is not
    working. A precisely defined dependency between the database service and dynamic
    Web application also ensures here that the administrator is notified of the actual
    cause.'
  id: totrans-2337
  prefs: []
  type: TYPE_NORMAL
  zh: 使用服务依赖性的另一个例子是依赖于数据库的应用程序：如果一个具有动态网页的Web应用程序（其基础数据库可能位于网络中的另一个主机上）无法工作，那么该Web应用程序将失败。数据库服务与动态Web应用程序之间精确定义的依赖性也确保了管理员会被告知实际原因。
- en: Additional functions in Nagios 3.0
  id: totrans-2338
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Nagios 3.0 的附加功能
- en: 'Nagios 3.0 includes two innovations: On one hand, the parameter **`dependency_period`**
    now allows a time restriction to be placed on the dependency. The default is **`7x24h`**,
    that is, round the clock.'
  id: totrans-2339
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios 3.0 包含两项创新：一方面，参数 **`dependency_period`** 现在允许对依赖性施加时间限制。默认值为 **`7x24h`**，即全天候。
- en: On the other hand, Nagios 3.0 makes it easier to define the dependencies between
    services and dependent services on the same host. Specifying **`dependent_host_name`**,
    as was done in the previous examples, can be omitted if this is identical to **`host_name`**.
    An example of this so-called *same-host dependency* is described in [H.1.6 Dependency
    descriptions](../Text/aph.html#dependency_descriptions "H.1.6 Dependency descriptions")
    in page 683.
  id: totrans-2340
  prefs: []
  type: TYPE_NORMAL
  zh: 另一方面，Nagios 3.0 使得在同一主机上定义服务和依赖服务的依赖性变得更加容易。如果 **`dependent_host_name`** 与 **`host_name`**
    相同，则可以省略在前面示例中使用的指定。这种所谓的 *同一主机依赖性* 的一个例子在 [H.1.6 依赖描述](../Text/aph.html#dependency_descriptions
    "H.1.6 Dependency descriptions") 页 683 中描述。
- en: '12.6.2 Only in exceptional cases: host dependencies'
  id: totrans-2341
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 12.6.2 仅在异常情况下：主机依赖性
- en: Host dependencies function in principle exactly like service dependencies; the
    **`hostdependency`** object is also capable of suppressing messages.
  id: totrans-2342
  prefs: []
  type: TYPE_NORMAL
  zh: 主机依赖性在原则上与服务依赖性完全相同；**`hostdependency`** 对象也能够抑制消息。
- en: There are a number of subtle differences in the detail, however. Only explicitly
    configured regular host checks can be suppressed in which checked intervals are
    defined as for services. This type of host check should be used only in exceptional
    circumstances, however, since it can have a significant influence on the performance
    of Nagios. Normally Nagios decides for itself when it will perform a host check
    (see [4.1 Taking into Account the Network Topology](../Text/ch04.html#taking_into_account_the_network_topology
    "4.1 Taking into Account the Network Topology") from page 92).
  id: totrans-2343
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，在细节上存在一些细微的差异。只有显式配置的常规主机检查可以被抑制，其中检查间隔被定义为与服务相同。然而，这种类型的主机检查应仅在特殊情况下使用，因为它可能会对Nagios的性能产生重大影响。通常，Nagios会自行决定何时执行主机检查（参见第92页的[4.1
    考虑网络拓扑](../Text/ch04.html#taking_into_account_the_network_topology "4.1 考虑网络拓扑")）。
- en: In nearly all cases the **`parents`** parameter in the host definition is better
    at describing the dependencies between hosts. As long as Nagios can test individual
    hosts directly, the system can distinguish much better between DOWN and UNREACHABLE
    (see [4.1 Taking into Account the Network Topology](../Text/ch04.html#taking_into_account_the_network_topology
    "4.1 Taking into Account the Network Topology") from page 92). If you do not want
    any notification for particular hosts, dependent on the network topology, then
    you should be informed only for DOWN, but not for UNREACHABLE.
  id: totrans-2344
  prefs: []
  type: TYPE_NORMAL
  zh: 在几乎所有情况下，主机定义中的**`parents`**参数在描述主机之间的依赖关系方面表现得更好。只要Nagios可以直接测试单个主机，系统就能更好地区分DOWN和UNREACHABLE（参见第92页的[4.1
    考虑网络拓扑](../Text/ch04.html#taking_into_account_the_network_topology "4.1 考虑网络拓扑")）。如果您不希望对特定主机进行任何通知，这取决于网络拓扑，那么您只应收到DOWN的通知，而不是UNREACHABLE的通知。
- en: Host dependencies should be used only when Nagios can no longer distinguish
    between DOWN and UNREACHABLE. This is usually the case when indirect checksthe
    host check is performed indirectly (e. g., in the figure shown in [10.5.3 Optimizing
    the configuration](../Text/ch10s05.html#optimizing_the_configuration "10.5.3 Optimizing
    the configuration")).
  id: totrans-2345
  prefs: []
  type: TYPE_NORMAL
  zh: 只有当Nagios无法再区分DOWN和UNREACHABLE时，才应使用主机依赖。这通常是在间接检查（例如，在[10.5.3 优化配置](../Text/ch10s05.html#optimizing_the_configuration
    "10.5.3 优化配置")中显示的图中）执行主机检查时的情况。
- en: Chapter 13. Passive Tests with the External Command File
  id: totrans-2346
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第13章. 使用外部命令文件进行被动测试
- en: Apart from active service and host checks, Nagios also makes use of passive
    tests (and combinations of both types of test). While the system itself defines
    the time for active checks when they are performed, and then initiates them, Nagios
    in passive mode only processes incoming results.
  id: totrans-2347
  prefs: []
  type: TYPE_NORMAL
  zh: 除了主动服务和主机检查之外，Nagios还利用被动测试（以及这两种类型测试的组合）。虽然系统本身定义了主动检查执行的时间，并随后启动它们，但在被动模式下，Nagios仅处理传入的结果。
- en: For this to work, an interface is required that allows test results from the
    outside to be passed on to Nagios, as well as commands that perform checks and
    feed in the results through the interface. Normally remote hosts send their test
    results, determined by shell scripts, via the *Nagios Service Check Acceptor*
    (NSCA), which is introduced in the next chapter ([Chapter 14](../Text/ch14.html
    "Chapter 14. The Nagios Service Check Acceptor (NSCA)")), to the Nagios server.
  id: totrans-2348
  prefs: []
  type: TYPE_NORMAL
  zh: 为了实现这一点，需要一个接口，允许将外部测试结果传递给Nagios，以及执行检查并通过接口提供结果的命令。通常，远程主机通过*Nagios服务检查接受器*（NSCA）发送由shell脚本确定的测试结果，如下一章（[第14章](../Text/ch14.html
    "第14章. Nagios服务检查接受器（NSCA）")）中所述，到Nagios服务器。
- en: 'Passive checks are used in particular with distributed monitoring, in which
    noncentral Nagios servers send all their results to a central Nagios instance.
    This subject is discussed in [Chapter 15](../Text/ch15.html "Chapter 15. Distributed
    Monitoring"). Another field in which they are used is in the processing of asynchronous
    events, the time of which Nagios cannot define itself. One example of this is
    a backup script that sends a result to Nagios (OK or CRITICAL) when it has completed
    a data backup, and another example is processing SNMP traps (see [14.6 Application
    Example II: Processing SNMP Traps](../Text/ch14s06.html "14.6 Application Example
    II: Processing SNMP Traps")).'
  id: totrans-2349
  prefs: []
  type: TYPE_NORMAL
  zh: 被动检查在分布式监控中尤其有用，其中非中心化的Nagios服务器将所有结果发送到中央Nagios实例。这一主题在[第15章](../Text/ch15.html
    "第15章. 分布式监控")中有详细讨论。它们还用于处理异步事件，这些事件的时间Nagios无法自行定义。一个例子是备份脚本在完成数据备份后向Nagios发送结果（OK或CRITICAL），另一个例子是处理SNMP陷阱（参见[14.6
    应用示例II：处理SNMP陷阱](../Text/ch14s06.html "14.6 应用示例II：处理SNMP陷阱")）。
- en: 13.1 The Interface for External Commands
  id: totrans-2350
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 13.1 外部命令的接口
- en: 'The interface for external commands, known in Nagios jargon as *External Command
    Files*, consists of a named pipe (FIFO)^([[131](#ftn.CHP-13-FN-1)]) in the subdirectory
    **`rw`** of the Nagios **`var`** directory:'
  id: totrans-2351
  prefs: []
  type: TYPE_NORMAL
  zh: 外部命令的接口，在Nagios术语中称为*外部命令文件*，由Nagios **`var`**目录下的子目录**`rw`**中的命名管道（FIFO）组成。[131](#ftn.CHP-13-FN-1)]
- en: '[PRE297]'
  id: totrans-2352
  prefs: []
  type: TYPE_PRE
  zh: '[PRE297]'
- en: The pipe, marked in the **`ls`** output with **`p`**, correctly sets up the
    **`make install-commandmode`** command during installation. For reasons of security
    it is essential that you ensure that only the group **`nagcmd`** can read from
    and write to the pipe. Anyone who has access here can control Nagios remotely
    via commands, and can, if they want, shut it down entirely.
  id: totrans-2353
  prefs: []
  type: TYPE_NORMAL
  zh: 在**`ls`**输出中用**`p`**标记的管道，在安装过程中正确设置了**`make install-commandmode`**命令。出于安全考虑，确保只有组**`nagcmd`**可以读取和写入管道是至关重要的。任何有权访问这里的人都可以通过命令远程控制Nagios，并且如果他们想的话，可以完全关闭它。
- en: 'Commands that Nagios accepts from the External Command File have the following
    form:'
  id: totrans-2354
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios从外部命令文件接受的命令具有以下形式：
- en: '[PRE298]'
  id: totrans-2355
  prefs: []
  type: TYPE_PRE
  zh: '[PRE298]'
- en: As the timestamp in square brackets, Nagios expects the current time in epoch
    seconds, that is the number of seconds which have elapsed in the UTC time zone
    since January 1, 1970\. This is followed by a space, then a command followed by
    a matching number of arguments, separated by a semicolon.
  id: totrans-2356
  prefs: []
  type: TYPE_NORMAL
  zh: 正如方括号中的时间戳所示，Nagios期望的是以纪元秒为单位的当前时间，即自1970年1月1日以来在UTC时区中经过的秒数。其后跟一个空格，然后是一个命令，后面跟着匹配数量的参数，由分号分隔。
- en: The interface makes extensive use of this mechanism, allowing its users to make
    various settings via mouse click. A detailed description of all possible commands
    is provided by the online documentation.^([[132](#ftn.CHP-13-FN-2)]) An example
    script for each command can be found there, which can be copied to a file with
    cut-and-paste and used after a few path adjustments have been made.
  id: totrans-2357
  prefs: []
  type: TYPE_NORMAL
  zh: 该接口广泛使用这种机制，允许用户通过鼠标点击进行各种设置。在线文档提供了所有可能命令的详细描述。[132](#ftn.CHP-13-FN-2)]。每个命令的示例脚本都可以在那里找到，可以复制到文件中并通过剪切粘贴使用，之后进行一些路径调整。
- en: In this chapter we will limit ourselves to the two processing commands with
    which computers deliver the results of passive checks to the Nagios server, **`PROCESS_SERVICE_CHECK_RESULT`**
    and **`PROCESS_HOST_CHECK_RESULT`**.
  id: totrans-2358
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将仅限于两种处理命令，即计算机将被动检查的结果传递给Nagios服务器的命令，**`PROCESS_SERVICE_CHECK_RESULT`**和**`PROCESS_HOST_CHECK_RESULT`**。
- en: 'For reasons of security, the processing of external commands must be explicitly
    switched on in the main configuration file **`nagios.cfg`** with the directive
    **`check_external_commands=1`**:'
  id: totrans-2359
  prefs: []
  type: TYPE_NORMAL
  zh: 出于安全考虑，必须在主配置文件**`nagios.cfg`**中使用指令**`check_external_commands=1`**显式地打开外部命令的处理：
- en: '[PRE299]'
  id: totrans-2360
  prefs: []
  type: TYPE_PRE
  zh: '[PRE299]'
- en: The **`command_check_interval`** determines that Nagios checks the interface
    for existing commands every so many seconds. **`−1`** means "as often as possible."
    **`command_file`** specifies the path to the named pipe.
  id: totrans-2361
  prefs: []
  type: TYPE_NORMAL
  zh: '**`command_check_interval`**确定Nagios每隔几秒钟检查一次现有命令的接口。**`−1`**表示“尽可能频繁”。**`command_file`**指定命名管道的路径。'
- en: '* * *'
  id: totrans-2362
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: '^([[131](#CHP-13-FN-1)]) A named pipe is a buffer to which a process can write
    something, which can then be read by another process. Whatever is written first
    is also read first: *First In, First Out* (FIFO). Since this involves space in
    the main memory, a named pipe does not need any space on the hard drive.'
  id: totrans-2363
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[131](#CHP-13-FN-1)]) 命名管道是一个进程可以写入数据的缓冲区，然后另一个进程可以读取这些数据。最先写入的数据也是最先被读取的：*先进先出*（FIFO）。由于这涉及到主内存中的空间，命名管道不需要在硬盘上占用任何空间。
- en: ^([[132](#CHP-13-FN-2)]) [http://www.nagios.org/developerinfo/externalcommands/](http://www.nagios.org/developerinfo/externalcommands/)
  id: totrans-2364
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[132](#CHP-13-FN-2)]) [http://www.nagios.org/developerinfo/externalcommands/](http://www.nagios.org/developerinfo/externalcommands/)
- en: 13.2 Passive Service Checks
  id: totrans-2365
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 13.2 被动服务检查
- en: In order for Nagios to be able to accept passive service checks via the interface,
    this must be explicitly allowed in the global configuration and in the corresponding
    service definition. The corresponding entry in **`nagios.cfg`** is
  id: totrans-2366
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使Nagios能够通过接口接受被动服务检查，必须在全局配置和相应的服务定义中明确允许。在**`nagios.cfg`**中的对应条目是
- en: '[PRE300]'
  id: totrans-2367
  prefs: []
  type: TYPE_PRE
  zh: '[PRE300]'
- en: 'In the service definition you can select whether you want to perform active
    checks in parallel to the passive ones. Active checks are only possible, of course,
    if Nagios can query the information itself. The following example allows passive
    checks and stops all active ones:'
  id: totrans-2368
  prefs: []
  type: TYPE_NORMAL
  zh: 在服务定义中，你可以选择是否要在被动检查的同时执行主动检查。当然，只有在Nagios能够自己查询信息的情况下，才能执行主动检查。以下示例允许被动检查并停止所有主动检查：
- en: '[PRE301]'
  id: totrans-2369
  prefs: []
  type: TYPE_PRE
  zh: '[PRE301]'
- en: An exception is normally made for *freshness checks* (see [13.4 Reacting to
    Out-of-Date Information of Passive Checks](../Text/ch13s04.html "13.4 Reacting
    to Out-of-Date Information of Passive Checks") from page 295)—here Nagios makes
    use of the command defined in **`check_command`**. To ban active checks entirely,
    the **`check_period`** parameter is set to **`none`**. The check command does
    not play a role in this case, so you can just enter a dummy check here, for example
    (which like all other commands has to be defined, of course).
  id: totrans-2370
  prefs: []
  type: TYPE_NORMAL
  zh: 通常会对*新鲜度检查*（见[13.4 对被动检查过时信息的反应](../Text/ch13s04.html "13.4 对被动检查过时信息的反应")，第295页）进行例外处理——在这里，Nagios使用在**`check_command`**中定义的命令。要完全禁止主动检查，将**`check_period`**参数设置为**`none`**。在这种情况下，检查命令不起作用，因此你可以在这里输入一个虚拟检查，例如（当然，像所有其他命令一样，必须定义）。
- en: 'On the computer to be tested passively (in this example, **`linux01`**) you
    must ensure, via NSCA (see [Chapter 14](../Text/ch14.html "Chapter 14. The Nagios
    Service Check Acceptor (NSCA)")), that it contacts the Nagios server through the
    interface for external commands. There it writes the command for passive service
    checks in the following one-line form:'
  id: totrans-2371
  prefs: []
  type: TYPE_NORMAL
  zh: 在要被动测试的计算机（在这个例子中，**`linux01`**）上，你必须通过NSCA（见[第14章](../Text/ch14.html "第14章。Nagios服务检查接受者（NSCA）")）确保它通过外部命令接口联系Nagios服务器。在那里，它以下一行形式写入被动服务检查的命令：
- en: '[PRE302]'
  id: totrans-2372
  prefs: []
  type: TYPE_PRE
  zh: '[PRE302]'
- en: 'The timestamp can be created in a shell script, for example with **`date`**:'
  id: totrans-2373
  prefs: []
  type: TYPE_NORMAL
  zh: 时间戳可以在shell脚本中创建，例如使用**`date`**：
- en: '[PRE303]'
  id: totrans-2374
  prefs: []
  type: TYPE_PRE
  zh: '[PRE303]'
- en: 'A simple script that passes on the result of a passive service check on the
    Nagios server itself to the Nagios installed there, could look like this:'
  id: totrans-2375
  prefs: []
  type: TYPE_NORMAL
  zh: 一个简单的脚本，可以将Nagios服务器上被动服务检查的结果传递给安装在该服务器上的Nagios，可能看起来像这样：
- en: '[PRE304]'
  id: totrans-2376
  prefs: []
  type: TYPE_PRE
  zh: '[PRE304]'
- en: 'When it is run it expects the parameters in the correct sequence:'
  id: totrans-2377
  prefs: []
  type: TYPE_NORMAL
  zh: 当它运行时，它期望参数以正确的顺序出现：
- en: '[PRE305]'
  id: totrans-2378
  prefs: []
  type: TYPE_PRE
  zh: '[PRE305]'
- en: After the host and service names, the test status follows as a digit, and finally
    the output text. If the service name contains spaces, then it should also be set
    in quotation marks.
  id: totrans-2379
  prefs: []
  type: TYPE_NORMAL
  zh: 在主机名和服务名之后，测试状态以数字形式跟随，最后是输出文本。如果服务名包含空格，那么它也应该用引号括起来。
- en: 13.3 Passive Host Checks
  id: totrans-2380
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 13.3 被动主机检查
- en: 'Passive host checks follow the same principle as passive service checks, except
    that they involve computers and not services. To allow them globally, the **`accept_passive_host_checks`**
    parameter is set in **`nagios.cfg`** to 1:'
  id: totrans-2381
  prefs: []
  type: TYPE_NORMAL
  zh: 被动主机检查遵循与被动服务检查相同的原理，只是它们涉及的是计算机而不是服务。要全局允许它们，必须在**`nagios.cfg`**中将**`accept_passive_host_checks`**参数设置为1：
- en: '[PRE306]'
  id: totrans-2382
  prefs: []
  type: TYPE_PRE
  zh: '[PRE306]'
- en: 'In addition, the host definition for the computer to be monitored passively
    must allow this kind of host check:'
  id: totrans-2383
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，要被动监控的计算机的主机定义必须允许这种主机检查：
- en: '[PRE307]'
  id: totrans-2384
  prefs: []
  type: TYPE_PRE
  zh: '[PRE307]'
- en: In this example it simultaneously forbids active checks.
  id: totrans-2385
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，它同时禁止了主动检查。
- en: 'The command to be sent through the external interface with which the computer
    delivers its test results differs here only marginally from the syntax used in
    the service check command already introduced:'
  id: totrans-2386
  prefs: []
  type: TYPE_NORMAL
  zh: 通过外部接口发送的命令，该计算机通过该接口提供其测试结果，与已经介绍的服务检查命令的语法只有细微差别：
- en: '[PRE308]'
  id: totrans-2387
  prefs: []
  type: TYPE_PRE
  zh: '[PRE308]'
- en: 'Active and passive host checks differ in one important respect: with passive
    checks, Nagios is no longer in a position to distinguish between DOWN and UNREACHABLE
    (see [4.1 Taking into Account the Network Topology](../Text/ch04.html#taking_into_account_the_network_topology
    "4.1 Taking into Account the Network Topology") from page 92). If you still want
    to take account of network topology dependencies when making notifications and
    to give specific information on the actual host that is down, you must make use
    of host dependencies in this case (see [12.6.2 Only in exceptional cases: host
    dependencies](../Text/ch12s06.html#only_in_exceptional_cases_colon_host_de "12.6.2
    Only in exceptional cases: host dependencies") from page 289).'
  id: totrans-2388
  prefs: []
  type: TYPE_NORMAL
  zh: 激活和被动主机检查在一点上有所不同：在被动检查中，Nagios不再能够区分DOWN和UNREACHABLE（参见第92页的[4.1 考虑网络拓扑](../Text/ch04.html#taking_into_account_the_network_topology
    "4.1 考虑网络拓扑")）。如果你仍然想在发出通知时考虑网络拓扑依赖性，并给出实际已关闭的主机的具体信息，你必须在这种情况下使用主机依赖性（参见第289页的[12.6.2
    仅在异常情况下：主机依赖性](../Text/ch12s06.html#only_in_exceptional_cases_colon_host_de "12.6.2
    仅在异常情况下：主机依赖性")）。
- en: 13.4 Reacting to Out-of-Date Information of Passive Checks
  id: totrans-2389
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 13.4 对被动检查过时信息的反应
- en: It lies in the nature of passive checks that Nagios is content with the information
    delivered. Nagios has no influence over when and at what intervals the remote
    host delivers them. It may even be the case that the information does not arrive
    at all.
  id: totrans-2390
  prefs: []
  type: TYPE_NORMAL
  zh: 被动检查的本质在于Nagios对提供的信息感到满意。Nagios无法控制远程主机何时以及以何种间隔提供这些信息。甚至可能发生信息根本未到达的情况。
- en: 'In order to classify the "knowledge state" of the server as out of date, Nagios
    has the ability to become active itself, with a *freshness check*. Like passive
    checks, freshness checking must be enabled both globally and in the relevant serviceable
    host object. To do this, you need to set the following global parameters in the
    file **`nagios.cfg`**:'
  id: totrans-2391
  prefs: []
  type: TYPE_NORMAL
  zh: 为了将服务器的“知识状态”分类为过时，Nagios具有通过*freshness 检查*自行变得活跃的能力。与被动检查一样，freshness 检查必须在全局范围内以及相关的服务主机对象中启用。为此，你需要在文件**`nagios.cfg`**中设置以下全局参数：
- en: '[PRE309]'
  id: totrans-2392
  prefs: []
  type: TYPE_PRE
  zh: '[PRE309]'
- en: The value **`0`** in **`check_host_freshness`** and the value **`1`** in **`check_service_freshness`**
    ensure that Nagios carries out freshness checks only for services, and not for
    hosts. The check interval defines the intervals at which the server updates its
    information, in this case, every 60 seconds. When Nagios really becomes active
    in the case of a specific service or host depends on the threshold value, which
    you can set in the appropriate service or host definition with the **`freshness_threshold`**
    parameter:^([[133](#ftn.CHP-13-FN-3)])
  id: totrans-2393
  prefs: []
  type: TYPE_NORMAL
  zh: '**`check_host_freshness`**中的值**`0`**和**`check_service_freshness`**中的值**`1`**确保Nagios只为服务执行
    freshness 检查，而不是为主机。检查间隔定义了服务器更新其信息的间隔，在这种情况下，每60秒更新一次。Nagios在特定服务或主机的情况下真正变得活跃取决于阈值值，你可以使用**`freshness_threshold`**参数在适当的服务或主机定义中设置此值：^([[133](#ftn.CHP-13-FN-3)])'
- en: '[PRE310]'
  id: totrans-2394
  prefs: []
  type: TYPE_PRE
  zh: '[PRE310]'
- en: So in this example Nagios performs the freshness check for this service only
    if the last transmitted value is older than 3600 seconds (one hour). Then Nagios
    starts the command defined in **`check_command`**, even if active checks have
    been switched off in the corresponding host or service definition, or even globally.
  id: totrans-2395
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，在这个例子中，Nagios只有在最后传输的值超过3600秒（一小时）时才会执行此服务的 freshness 检查。然后Nagios启动在**`check_command`**中定义的命令，即使相应的主机或服务定义中已关闭主动检查，或者甚至在全局范围内也是如此。
- en: If you define the command named here in the example, **`service_is_stale`**,
    so that Nagios really does check the service or host, then Nagios will perform
    active tests even if active checking is switched off, but always only if passive
    results are overdue for longer than the threshold value set.
  id: totrans-2396
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你定义了示例中提到的命令，即**`service_is_stale`**，以便Nagios真正检查服务或主机，那么即使主动检查被关闭，Nagios也会执行主动测试，但始终仅在被动结果超过阈值值设置的时间更长时。
- en: 'If active checks are not possible or not wanted, you can ensure, using a pseudo-test,
    that Nagios will explicitly signal an error status, so that the administrator''s
    attention is drawn to it. Otherwise Nagios will always display the last status
    to be received. If this was OK, then it will not necessarily be noticed that current
    results have not been arriving for some time. The following pseudo-test script
    delivers an appropriate error message with **`echo`**, and with **`exit 2`** delivers
    the return value for CRITICAL, so that the administrator can react accordingly:'
  id: totrans-2397
  prefs: []
  type: TYPE_NORMAL
  zh: 如果无法进行或不需要主动检查，您可以使用伪测试来确保Nagios会明确地显示错误状态，从而引起管理员的注意。否则，Nagios将始终显示最后接收到的状态。如果这是正常的，那么可能不会注意到当前结果已经有一段时间没有到达。以下伪测试脚本使用**`echo`**提供适当的错误信息，并通过**`exit
    2`**提供CRITICAL的返回值，以便管理员可以相应地做出反应：
- en: '[PRE311]'
  id: totrans-2398
  prefs: []
  type: TYPE_PRE
  zh: '[PRE311]'
- en: 'If you start the script from the plugin directory as **`service_is_stale. sh`**,
    the Nagios command **`service_is_stale`** will be defined as follows:'
  id: totrans-2399
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您从插件目录中以**`service_is_stale.sh`**启动脚本，Nagios命令**`service_is_stale`**将被定义为以下内容：
- en: '[PRE312]'
  id: totrans-2400
  prefs: []
  type: TYPE_PRE
  zh: '[PRE312]'
- en: If the results for the service **`Disks`** on **`linux01`** fail to appear for
    longer than one hour, Nagios will run the script **`service_is_stale.sh`**, which
    always returns CRITICAL, irrespective of what data **`linux01`** last sent. This
    CRITICAL status is only ended when the host passes on new and more positive results
    to the server through a passive check.
  id: totrans-2401
  prefs: []
  type: TYPE_NORMAL
  zh: 如果**`linux01`**上的**`Disks`**服务的结果超过一小时没有出现，Nagios将运行脚本**`service_is_stale.sh`**，该脚本始终返回CRITICAL，无论**`linux01`**最后发送了什么数据。只有当主机通过被动检查向服务器传递新的更积极的结果时，这种CRITICAL状态才会结束。
- en: '* * *'
  id: totrans-2402
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[133](#CHP-13-FN-3)]) If you do not explicitly specify **`freshness_threshold`**,
    the value set for **`normal_check_interval`** will be used in the hard state,
    and if there is a soft state, the value **`retry_check_interval`** will serve
    as the default.
  id: totrans-2403
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[133](#CHP-13-FN-3)]) 如果您没有明确指定**`freshness_threshold`**，则硬状态将使用为**`normal_check_interval`**设置的值，如果存在软状态，则**`retry_check_interval`**的值将作为默认值。
- en: Chapter 14. The Nagios Service Check Acceptor (NSCA)
  id: totrans-2404
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第14章. Nagios服务检查接受者（NSCA）
- en: 'In order to send service and host checks across the network to the central
    Nagios server, a transmission mechanism is required. This is provided by the *Nagios
    Service Check Acceptor* (NSCA). It consists of two components: a client program
    **`send_nsca`**, which accepts the results of a service or host check on the remote
    host and sends them to the Nagios server, and the NSCA daemon **`nsca`**, which
    runs on the server, receives data from the client, processes this for the External
    Command File interface (see [13.1 The Interface for External Commands](../Text/ch13.html#the_interface_for_external_commands
    "13.1 The Interface for External Commands")), and passes this data on to it ([Figure 14-1](../Text/ch14.html#how_the_nsca_functions
    "Figure 14-1. How the NSCA functions")).'
  id: totrans-2405
  prefs: []
  type: TYPE_NORMAL
  zh: 为了将服务和主机检查通过网络发送到中央Nagios服务器，需要一个传输机制。这由**Nagios服务检查接受者**（NSCA）提供。它由两个组件组成：一个客户端程序**`send_nsca`**，它接受远程主机上的服务或主机检查结果并将它们发送到Nagios服务器，以及运行在服务器上的NSCA守护进程**`nsca`**，它接收来自客户端的数据，为此外部命令文件接口（参见[13.1外部命令接口](../Text/ch13.html#the_interface_for_external_commands
    "13.1外部命令接口"））进行处理，并将这些数据传递给它（[图14-1](../Text/ch14.html#how_the_nsca_functions
    "图14-1. NSCA的功能")）。
- en: The Nagios Service Check Acceptor was originally developed to enable distributed
    monitoring in which decentralized Nagios servers can send their results to a central
    Nagios server (see [Chapter 15](../Text/ch15.html "Chapter 15. Distributed Monitoring")
    from page 317). In principle, the data that **`send_nsca`** sends to the Nagios
    server can come from any applications you like.
  id: totrans-2406
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios服务检查接受者最初开发是为了实现分布式监控，其中分散的Nagios服务器可以将它们的检测结果发送到中央Nagios服务器（参见第15章[分布式监控](../Text/ch15.html
    "第15章. 分布式监控")，第317页）。原则上，**`send_nsca`**发送给Nagios服务器的数据可以来自您喜欢的任何应用程序。
- en: Sending commands across the network to the central Nagios instance is not insignificant,
    from a security point of view, since Nagios could be completely switched off using
    the External Command File. This is why NSCA sends the data in encrypted form,
    and clients must have the correct key to obtain access to the interface. This
    prevents an arbitrary network participant from being able to run any commands
    at all on the Nagios server.
  id: totrans-2407
  prefs: []
  type: TYPE_NORMAL
  zh: 在网络安全方面，通过网络发送命令到中央Nagios实例并非微不足道，因为可以使用外部命令文件完全关闭Nagios。这就是为什么NSCA以加密形式发送数据，客户端必须拥有正确的密钥才能访问接口。这阻止了任意网络参与者能够运行任何命令在Nagios服务器上。
- en: '![How the NSCA functions](../Images/tagoreillycom20081104nostarchimages223830.png)'
  id: totrans-2408
  prefs: []
  type: TYPE_IMG
  zh: '![NSCA的功能](../Images/tagoreillycom20081104nostarchimages223830.png)'
- en: Figure 14-1. How the NSCA functions
  id: totrans-2409
  prefs: []
  type: TYPE_NORMAL
  zh: 图14-1. NSCA的功能
- en: 14.1 Installation
  id: totrans-2410
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 14.1 安装
- en: NSCA version 2.7.2, current at the time of going to press, was published in
    the spring of 2007; the chances are therefore quite high that the distribution
    you are using contains a current package. The source code^([[134](#ftn.CHP-14-FN-1)])
    is quite easy to compile yourself, however. As a prerequisite, you need to have
    the library **`libmcrypt`** installed, together with the relevant header files,^([[135](#ftn.CHP-14-FN-2)])
    or else the integrated encryption cannot be used.
  id: totrans-2411
  prefs: []
  type: TYPE_NORMAL
  zh: NSCA版本2.7.2，在本书印刷时，是在2007年春季发布的；因此，你使用的发行版很可能包含一个当前包。然而，源代码^([[134](#ftn.CHP-14-FN-1)])编译起来相当简单。作为先决条件，你需要安装库**`libmcrypt`**以及相关的头文件^([[135](#ftn.CHP-14-FN-2)))，否则无法使用集成加密。
- en: 'In the unpacked source directory, you should run the included **`configure`**
    script, specifying the Nagios configuration and **`var`** directories:'
  id: totrans-2412
  prefs: []
  type: TYPE_NORMAL
  zh: 在解压后的源代码目录中，你应该运行包含的**`configure`**脚本，指定Nagios配置和**`var`**目录：
- en: '[PRE313]'
  id: totrans-2413
  prefs: []
  type: TYPE_PRE
  zh: '[PRE313]'
- en: At the end it displays output, showing the permissions with which the NSCA user
    starts by default, if not otherwise specified in the configuration. Normally the
    NSCA daemon waits on TCP port 5667.
  id: totrans-2414
  prefs: []
  type: TYPE_NORMAL
  zh: 最后它会显示输出，显示NSCA用户默认启动时的权限，如果没有在配置中指定其他权限。通常NSCA守护进程在TCP端口5667上等待。
- en: 'A final **`make all`** compiles the two programs **`nsca`** and **`send_nsca`**.
    They are now located in the subdirectory **`src`** and need to be copied manually
    to a suitable directory:'
  id: totrans-2415
  prefs: []
  type: TYPE_NORMAL
  zh: 最后执行**`make all`**编译两个程序**`nsca`**和**`send_nsca`**。它们现在位于子目录**`src`**中，需要手动复制到合适的目录：
- en: '[PRE314]'
  id: totrans-2416
  prefs: []
  type: TYPE_PRE
  zh: '[PRE314]'
- en: '**`nsca`** is copied to the Nagios server, preferably to the directory **`/usr/local/
    sbin. send_nsca`** belongs on the remote host that is to send its test results
    to the Nagios server. If this computer has a different operating system version
    or platform, it is possible that the client to run there will need to be recompiled.
    Both programs each require their own configuration file, which is best stored
    in the directory **`/etc/nagios:`**'
  id: totrans-2417
  prefs: []
  type: TYPE_NORMAL
  zh: '**`nsca`**被复制到Nagios服务器，最好复制到目录**`/usr/local/ sbin`**。**`send_nsca`**应该位于将测试结果发送到Nagios服务器的远程主机上。如果这台计算机有不同的操作系统版本或平台，那么运行在那里的客户端可能需要重新编译。这两个程序各自都需要自己的配置文件，最好存储在目录**`/etc/nagios`**中。'
- en: '[PRE315]'
  id: totrans-2418
  prefs: []
  type: TYPE_PRE
  zh: '[PRE315]'
- en: '* * *'
  id: totrans-2419
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[134](#CHP-14-FN-1)]) [http://www.nagios.org/download/](http://www.nagios.org/download/)
  id: totrans-2420
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[134](#CHP-14-FN-1)]) [http://www.nagios.org/download/](http://www.nagios.org/download/)
- en: ^([[135](#CHP-14-FN-2)]) The corresponding binary package usually contains **`-dev`**
    or **`-devel`** in its name.
  id: totrans-2421
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[135](#CHP-14-FN-2)]) 相应的二进制包通常在其名称中包含**`-dev`**或**`-devel`**。
- en: 14.2 Configuring the Nagios Server
  id: totrans-2422
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 14.2 配置Nagios服务器
- en: 14.2.1 The configuration file **`nsca.cfg`**
  id: totrans-2423
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.2.1 配置文件**`nsca.cfg`**
- en: For NSCA to work, the External Command File interface on the Nagios server must
    be activated in the configuration file **`/etc/nagios/nagios.cfg`** ([13.1 The
    Interface for External Commands](../Text/ch13.html#the_interface_for_external_commands
    "13.1 The Interface for External Commands"), page 292) and the corresponding data
    entered in the NSCA configuration file **`nsca.cfg:`**
  id: totrans-2424
  prefs: []
  type: TYPE_NORMAL
  zh: 为了NSCA能够工作，Nagios服务器上的外部命令文件接口必须在配置文件**`/etc/nagios/nagios.cfg`**中激活（[13.1 外部命令接口](../Text/ch13.html#the_interface_for_external_commands
    "13.1 外部命令接口"), 第292页）并且相应的数据在NSCA配置文件**`nsca.cfg`**中输入。
- en: '[PRE316]'
  id: totrans-2425
  prefs: []
  type: TYPE_PRE
  zh: '[PRE316]'
- en: The parameters **`server_port`**, **`server_address`**, **`allowed_hosts`**,
    **`nsca_user`**, and **`nsca_group`** take effect only if **`nsca`** is started
    as a daemon. If it is started as an inet daemon, the values set in its configuration
    apply to the NSCA server address and the port on which the NSCA is listening,
    the IP addresses of the hosts that are allowed to access the interface,^([[136](#ftn.CHP-14-FN-3)])
    and the users and group with whose permissions the Service Check Acceptor runs.
  id: totrans-2426
  prefs: []
  type: TYPE_NORMAL
  zh: 参数 **`server_port`**、**`server_address`**、**`allowed_hosts`**、**`nsca_user`**
    和 **`nsca_group`** 仅在 **`nsca`** 以守护进程方式启动时生效。如果以 inet 守护进程启动，则其配置文件中设置的值应用于 NSCA
    服务器地址和 NSCA 监听的端口，允许访问该接口的主机的 IP 地址，以及运行 Service Check Acceptor 的用户和组权限。
- en: The **`debug`** parameter makes it easier to search for errors, but it should
    normally be switched off (value **`0`**). If it is set to **`1`**, NSCA writes
    debugging information in the syslog.
  id: totrans-2427
  prefs: []
  type: TYPE_NORMAL
  zh: '**`debug`** 参数使得查找错误更加容易，但通常应关闭（值 **`0`**）。如果设置为 **`1`**，NSCA 将将调试信息写入 syslog。'
- en: The named pipe is defined by the entry **`command_file`**. If you specify an
    alternative output file, with **`alternate_dump_file`**, this serves as a fallback
    in case the named pipe given does not exist. Before version 2.0, Nagios removed
    the pipe each time it was shut down, but this should not happen anymore.
  id: totrans-2428
  prefs: []
  type: TYPE_NORMAL
  zh: 命名管道由条目 **`command_file`** 定义。如果你指定了替代输出文件，使用 **`alternate_dump_file`**，则在指定的命名管道不存在时，它作为后备。在版本
    2.0 之前，Nagios 每次关闭时都会删除管道，但这种情况不应再发生。
- en: If it is set to **`1`**, **`aggregate_writes`** ensures that NSCA collects all
    the incoming commands just once and then passes these on to the interface as a
    block. If the value at this position is **`0`**, then NSCA sends on each incoming
    command immediately to the External Command File.
  id: totrans-2429
  prefs: []
  type: TYPE_NORMAL
  zh: 如果设置为 **`1`**，**`aggregate_writes`** 确保NSCA只收集一次所有传入的命令，然后将这些命令作为块传递给接口。如果此位置的值是
    **`0`**，则 NSCA 会立即将每个传入的命令发送到外部命令文件。
- en: '**`append_to_file`** can have the values **`0`** (opens the External Command
    File in write mode) or **`1`** (opens it in the append mode), and it should always
    be set to **`0`**.^([[137](#ftn.CHP-14-FN-4)])'
  id: totrans-2430
  prefs: []
  type: TYPE_NORMAL
  zh: '**`append_to_file`** 可以是值 **`0`**（以写入模式打开外部命令文件）或 **`1`**（以追加模式打开），并且应始终设置为
    **`0`**。^([[137](#ftn.CHP-14-FN-4)])'
- en: Client messages older than **`max_packet_age`** seconds are discarded by NSCA,
    to avoid replay attacks. This value may not be larger than 900 seconds (15 minutes)
    and should be as small as possible.
  id: totrans-2431
  prefs: []
  type: TYPE_NORMAL
  zh: NSCA 会丢弃超过 **`max_packet_age`** 秒的客户端消息，以避免重放攻击。此值不应超过 900 秒（15 分钟），并且应尽可能小。
- en: The last two parameters refer to the encryption of the communication. **`password`**
    contains the actual key, which is identical for clients, and which must be entered
    in the configuration for the clients (see [14.3 Client-side Configuration](../Text/ch14s03.html
    "14.3 Client-side Configuration") in page 304). Because the key is written in
    the file in plain text, **`nsca.cfg`** should be readable only for the user with
    whose permissions the NSCA is running, which in our case is **`nagios:`**
  id: totrans-2432
  prefs: []
  type: TYPE_NORMAL
  zh: 最后两个参数涉及通信的加密。**`password`** 包含实际密钥，对于客户端来说是相同的，并且必须在客户端的配置中输入（参见第 304 页的 [14.3
    客户端配置](../Text/ch14s03.html "14.3 Client-side Configuration")）。因为密钥以明文形式写入文件，所以
    **`nsca.cfg`** 应仅对运行 NSCA 的用户可读，在我们的例子中是 **`nagios:`**。
- en: '[PRE317]'
  id: totrans-2433
  prefs: []
  type: TYPE_PRE
  zh: '[PRE317]'
- en: Finally, **`decryption_method`** defines the encryption algorithm. The default
    is **`1`** (XOR), which is almost as insecure as **`0`** (no encryption). **`10`**
    stands for LOKI97, which is regarded as secure.^([[138](#ftn.CHP-14-FN-5)]) The
    list of all possible algorithms is contained in the supplied configuration file,
    which contains many old algorithms and some newer ones, such as DES (**`2`**),
    Triple-DES (**`3`**), Blowfish (**`8`**), and Rijndael (AES).^([[139](#ftn.CHP-14-FN-6)])
  id: totrans-2434
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，**`decryption_method`** 定义了加密算法。默认值为 **`1`**（XOR），与 **`0`**（无加密）几乎一样不安全。**`10`**
    代表 LOKI97，被认为是安全的。所有可能的算法列表包含在提供的配置文件中，其中包含许多旧算法和一些较新的算法，如 DES（**`2`**）、Triple-DES（**`3`**）、Blowfish（**`8`**）和
    Rijndael（AES）。
- en: 14.2.2 Configuring the inet daemon
  id: totrans-2435
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.2.2 配置 inet 守护进程
- en: If you want to start **`nsca`** with the inet daemon, the following entry is
    added in the file **`/etc/services:`**
  id: totrans-2436
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想使用 inet 守护进程启动 **`nsca`**，则需要在文件 **`/etc/services:`** 中添加以下条目。
- en: '[PRE318]'
  id: totrans-2437
  prefs: []
  type: TYPE_PRE
  zh: '[PRE318]'
- en: '**`xinetd`** configuration'
  id: totrans-2438
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**`xinetd`** 配置'
- en: 'If the newer **`xinetd`** is used, the file **`nagios-nsca`** is created in
    the directory **`/etc/xinetd.d`** with the following contents:'
  id: totrans-2439
  prefs: []
  type: TYPE_NORMAL
  zh: 如果使用较新的 **`xinetd`**，则将在 **`/etc/xinetd.d`** 目录中创建 **`nagios-nsca`** 文件，内容如下：
- en: '[PRE319]'
  id: totrans-2440
  prefs: []
  type: TYPE_PRE
  zh: '[PRE319]'
- en: The values printed in bold type for the user and group with whose permissions
    the NSCA should run, and the path to the NSCA daemon **`nsca`** (parameter **`server`**)
    and the corresponding configuration file, are adjusted if necessary to your own
    environment. The line **`only_from`**, as an equivalent to the **`nsca.cfg`**
    parameter **`allowed_hosts`**, takes in all the IP addresses, separated by spaces,
    from which the NSCA may be addressed. Distributions that include NSCA as a finished
    package and install **`xinetd`** by default, include a ready-to-use **`xinetd`**
    configuration file, where you only need to adjust this last parameter.
  id: totrans-2441
  prefs: []
  type: TYPE_NORMAL
  zh: 对于用户和组，以它们的权限运行NSCA，以及NSCA守护进程 **`nsca`**（参数 **`server`**) 和相应的配置文件路径，以粗体打印的值，如有必要，调整到您自己的环境。行
    **`only_from`**，作为 **`nsca.cfg`** 参数 **`allowed_hosts`** 的等效，接受来自所有IP地址的空间分隔值，这些地址可以用来调用NSCA。包含NSCA作为完整包并默认安装
    **`xinetd`** 的发行版，包括一个可用的 **`xinetd`** 配置文件，您只需调整最后一个参数。
- en: 'In order for the new configuration to become effective, the **`xinetd`** init
    script is run with the **`reload`** argument:'
  id: totrans-2442
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使新的配置生效，需要使用 **`reload`** 参数运行 **`xinetd`** 初始化脚本：
- en: '[PRE320]'
  id: totrans-2443
  prefs: []
  type: TYPE_PRE
  zh: '[PRE320]'
- en: inetd configuration
  id: totrans-2444
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: inetd配置
- en: If the standard **`inetd`** command is run, the following line is added (line-wrapped
    for the printed version) in the configuration file **`/etc/inetd.conf:`**
  id: totrans-2445
  prefs: []
  type: TYPE_NORMAL
  zh: 如果运行标准 **`inetd`** 命令，配置文件 **`/etc/inetd.conf:`** 中将添加以下行（为了打印版本而进行了换行）：
- en: '[PRE321]'
  id: totrans-2446
  prefs: []
  type: TYPE_PRE
  zh: '[PRE321]'
- en: 'If you want to leave out the TCP wrapper **`tcpd`**, you just omit the string
    **`/usr/sbin/tcpd`**. In this case you must also explicitly specify the user (**`nagios`**)
    with whose permissions the NSCA starts, the complete path to the binary **`nsca`**,
    and the configuration file with its absolute path. So that the Internet daemon
    can take account of the modification, its configuration must be reloaded:'
  id: totrans-2447
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想省略TCP包装器 **`tcpd`**，只需省略字符串 **`/usr/sbin/tcpd`**。在这种情况下，您还必须明确指定NSCA启动时使用的用户（**`nagios`**)、二进制的完整路径
    **`nsca`** 和配置文件的绝对路径。以便网络守护进程能够考虑到修改，其配置必须重新加载：
- en: '[PRE322]'
  id: totrans-2448
  prefs: []
  type: TYPE_PRE
  zh: '[PRE322]'
- en: '* * *'
  id: totrans-2449
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[136](#CHP-14-FN-3)]) If you want to define more than one IP address for
    **`allowed_hosts`**, they are separated by a comma.
  id: totrans-2450
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[136](#CHP-14-FN-3)]) 如果要为 **`allowed_hosts`** 定义多个IP地址，它们之间用逗号分隔。
- en: ^([[137](#CHP-14-FN-4)]) The append mode only makes sense if the External Command
    File is replaced for debugging purposes with a simple file.
  id: totrans-2451
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[137](#CHP-14-FN-4)]) 仅当外部命令文件用于调试目的替换为简单文件时，追加模式才有意义。
- en: ^([[138](#CHP-14-FN-5)]) [http://en.wikipedia.org/wiki/L0KI97](http://en.wikipedia.org/wiki/L0KI97)
  id: totrans-2452
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[138](#CHP-14-FN-5)]) [http://en.wikipedia.org/wiki/L0KI97](http://en.wikipedia.org/wiki/L0KI97)
- en: '^([[139](#CHP-14-FN-6)]) Rijndael-128: **`14`**; Rijndael-192: **`15`**; Rijndael-256:
    **`16`**'
  id: totrans-2453
  prefs: []
  type: TYPE_NORMAL
  zh: '^([[139](#CHP-14-FN-6)]) Rijndael-128: **`14`**; Rijndael-192: **`15`**; Rijndael-256:
    **`16`**'
- en: 14.3 Client-side Configuration
  id: totrans-2454
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 14.3 客户端配置
- en: 'The configuration file **`send_nsca.cfg`** on the client side must contain
    the same encryption parameters as the file on the Nagios server:'
  id: totrans-2455
  prefs: []
  type: TYPE_NORMAL
  zh: 客户端侧的配置文件 **`send_nsca.cfg`** 必须包含与Nagios服务器上的文件相同的加密参数：
- en: '[PRE323]'
  id: totrans-2456
  prefs: []
  type: TYPE_PRE
  zh: '[PRE323]'
- en: 'Since the key is also written here in plain text, it should not be readable
    for just any user. For this reason it is best to create a user **`nagios`** and
    a group **`nagios`** on the client side:'
  id: totrans-2457
  prefs: []
  type: TYPE_NORMAL
  zh: 由于密钥也以纯文本形式写入此处，因此它不应被任何用户读取。因此，最好在客户端创建一个用户 **`nagios`** 和一个组 **`nagios`**：
- en: '[PRE324]'
  id: totrans-2458
  prefs: []
  type: TYPE_PRE
  zh: '[PRE324]'
- en: 'You should now protect the file **`send_nsca.cfg`** so that only the user **`nagios`**
    can read it, and ensure, using the SUID mechanism, that the program **`send_nsca`**
    always runs under the user ID of this user. If you now grant execute permission
    to the group **`nagios`**, only its members may execute the NSCA client program:'
  id: totrans-2459
  prefs: []
  type: TYPE_NORMAL
  zh: 您现在应该保护文件 **`send_nsca.cfg`**，以确保只有用户 **`nagios`** 可以读取它，并确保使用SUID机制，程序 **`send_nsca`**
    总是以此用户的用户ID运行。如果您现在授予组 **`nagios`** 执行权限，只有其成员可以执行NSCA客户端程序：
- en: '[PRE325]'
  id: totrans-2460
  prefs: []
  type: TYPE_PRE
  zh: '[PRE325]'
- en: 14.4 Sending Test Results to the Server
  id: totrans-2461
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 14.4 将测试结果发送到服务器
- en: The client program **`send_nsca`** reads the details of a host or service check
    from the standard input, which the administrator must format as follows:^([[140](#ftn.CHP-14-FN-7)])
  id: totrans-2462
  prefs: []
  type: TYPE_NORMAL
  zh: 客户端程序 **`send_nsca`** 从标准输入读取主机或服务检查的详细信息，管理员必须按以下格式格式化：^([[140](#ftn.CHP-14-FN-7)])
- en: '[PRE326]'
  id: totrans-2463
  prefs: []
  type: TYPE_PRE
  zh: '[PRE326]'
- en: '**`send_nsca`** sends this to the Nagios server. The first line describes the
    format for service checks and the second line, that for host checks. The placeholder
    **``*`return value`*``** is replaced by the status determined, that is, **`0`**
    for OK, **`1`** for WARNING, **`2`** for CRITICAL, and **`3`** for UNKNOWN. By
    **``*`output`*``**, a one-line text is meant, of the type that plugins provide
    as a support for the administrator. As the separator, a tab sign is used (**`\t`**).'
  id: totrans-2464
  prefs: []
  type: TYPE_NORMAL
  zh: '**`send_nsca`**将此发送到Nagios服务器。第一行描述了服务检查的格式，第二行描述了主机检查的格式。占位符**``*`返回值`*``**被替换为确定的状态，即**`0`**表示OK，**`1`**表示WARNING，**`2`**表示CRITICAL，**`3`**表示UNKNOWN。**``*`输出`*``**指的是一行文本，是插件为管理员提供的支持类型。作为分隔符，使用制表符（**`\t`**）。'
- en: In order to make a complete command from this that can be understood by the
    external command, the NSCA daemon first prefixes the timestamp and the matching
    command (**`PROCESS_SERVICE_CHECK_RESULT`** or **`PROCESS. HOST_CHECK_RESULT`**).
    This is why only these two commands can be sent using NSCA.
  id: totrans-2465
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使这个命令能够被外部命令理解，NSCA守护进程首先在时间戳和匹配的命令（**`PROCESS_SERVICE_CHECK_RESULT`** 或 **`PROCESS.HOST_CHECK_RESULT`**）前加上前缀。这就是为什么只有这两个命令可以使用NSCA发送。
- en: '**`send_nsca`** itself has the following options:'
  id: totrans-2466
  prefs: []
  type: TYPE_NORMAL
  zh: '**`send_nsca`**本身有以下选项：'
- en: '**`-H`** **``*`address`*``**'
  id: totrans-2467
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-H`** **``*`地址`*``**'
- en: This is the host name or IP address of the Nagios server to be addressed by
    NSCA.
  id: totrans-2468
  prefs: []
  type: TYPE_NORMAL
  zh: 这是NSCA将要联系的目标Nagios服务器的计算机名或IP地址。
- en: '**`-d`** **``*`delimiter`*``**'
  id: totrans-2469
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-d`** **``*`分隔符`*``**'
- en: This is the delimiter for the input; the default is a tab sign. The following
    example page uses the semicolon as a *delimiter*.
  id: totrans-2470
  prefs: []
  type: TYPE_NORMAL
  zh: 这是输入的分隔符；默认为制表符。以下示例页面使用分号作为*分隔符*。
- en: '**`-c`** **``*`path/to_the/configuration_file`*``**'
  id: totrans-2471
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-c`** **``*`配置文件路径`*``**'
- en: This parameter specifies the path to the configuration file **`send_nsca.cfg`**.
    Since no path has been compiled into the client, **`send_nsca`** expects by default
    to find the file in the current directory. For this reason it makes sense to specify
    the absolute path with this option.
  id: totrans-2472
  prefs: []
  type: TYPE_NORMAL
  zh: 此参数指定配置文件**`send_nsca.cfg`**的路径。由于没有路径被编译到客户端中，**`send_nsca`**默认期望在当前目录中找到该文件。因此，使用此选项指定绝对路径是有意义的。
- en: '**`-p`** **``*`port`*``**'
  id: totrans-2473
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-p`** **``*`端口`*``**'
- en: This defines an alternative port if the default, the TCP port 5667, is not used.
  id: totrans-2474
  prefs: []
  type: TYPE_NORMAL
  zh: 这定义了一个替代端口，如果默认的TCP端口5667没有被使用。
- en: '**`-to`** **``*`timeout`*``**'
  id: totrans-2475
  prefs: []
  type: TYPE_NORMAL
  zh: '**`-to`** **``*`超时`*``**'
- en: After **``*`timeout`*``** seconds (by default, **`10`**) **`send_nsca`** aborts
    the connection attempt to the NSCA daemon, if no connection is established.
  id: totrans-2476
  prefs: []
  type: TYPE_NORMAL
  zh: 在**``*`超时`*``**秒（默认为**`10`**）后，如果未建立连接，**`send_nsca`**将终止连接尝试到NSCA守护进程。
- en: With simple test scripts such as the following one, the functionality of the
    NSCA can be tested. A service is chosen as the test object, which is in a state
    other than UNKNOWN (e.g., OK), in this case, **`nmbd`** on the host **`linux0l:`**
  id: totrans-2477
  prefs: []
  type: TYPE_NORMAL
  zh: 通过以下简单的测试脚本，可以测试NSCA的功能。选择一个状态不是未知（例如，OK）的服务作为测试对象，在这个例子中，是主机**`linux0l:`**上的**`nmbd`**。
- en: '[PRE327]'
  id: totrans-2478
  prefs: []
  type: TYPE_PRE
  zh: '[PRE327]'
- en: 'The script puts it, from Nagios''s point of view, into the UNKNOWN status.
    After it is run, you should discover if the transfer was successful:'
  id: totrans-2479
  prefs: []
  type: TYPE_NORMAL
  zh: 脚本将其从Nagios的角度看，置于未知状态。运行之后，你应该发现传输是否成功：
- en: '[PRE328]'
  id: totrans-2480
  prefs: []
  type: TYPE_PRE
  zh: '[PRE328]'
- en: As soon as Nagios processes the command and you have reloaded the page in your
    browser, the Web interface displays the UNKNOWN status for the selected service.
    With the next active check, the previous status will be recovered.
  id: totrans-2481
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦Nagios处理了这个命令，并且你在浏览器中重新加载了页面，Web界面就会显示所选服务的未知状态。在下一个活跃的检查之后，之前的状态将会恢复。
- en: Because it is so simple to send Nagios check results with **`send_nsca`**, it
    is essential that you protect the NSCA from misuse, as already demonstrated. On
    the client, you should restrict access to the client program **`send_nsca`** and
    to its configuration file and you should make sure that you have secure encryption,
    and on the server explicitly define the sender and IP addresses that are to be
    allowed.
  id: totrans-2482
  prefs: []
  type: TYPE_NORMAL
  zh: 由于使用**`send_nsca`**发送Nagios检查结果非常简单，因此保护NSCA不被滥用至关重要，正如已经展示的那样。在客户端，你应该限制对客户端程序**`send_nsca`**及其配置文件的访问，并确保你有安全的加密，在服务器上明确定义允许的发送者和IP地址。
- en: '* * *'
  id: totrans-2483
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[140](#CHP-14-FN-7)]) Normally you have to ensure that test scripts you have
    written yourself produce the correct output; if you use Nagios plugins, you must
    reformat their output accordingly. Since the latter can be run much better directly
    with NRPE, this should be the exception to the rule.
  id: totrans-2484
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[140](#CHP-14-FN-7)]) 通常你必须确保你自己编写的测试脚本产生正确的输出；如果你使用 Nagios 插件，你必须相应地重新格式化它们的输出。由于后者可以直接通过
    NRPE 运行得更好，这应该成为规则的例外。
- en: '14.5 Application Example I: Integrating syslog and Nagios'
  id: totrans-2485
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 14.5 应用示例 I：集成 syslog 和 Nagios
- en: Linux and Unix systems as a rule log system-relevant events through syslog.
    Sooner or later you will probably want Nagios to also inform the administrator
    of important syslog events. To do this, you require passive service checks, NSCA
    for transmitting the results to the Nagios server, and a method of filtering individual
    block entries.
  id: totrans-2486
  prefs: []
  type: TYPE_NORMAL
  zh: Linux 和 Unix 系统通常通过 syslog 记录系统相关的事件。迟早你可能会希望 Nagios 也通知管理员重要的 syslog 事件。为此，你需要被动服务检查、NSCA
    用于将结果传输到 Nagios 服务器，以及过滤单个块条目的方法。
- en: If you are using **`syslog-ng`**^([[141](#ftn.CHP-14-FN-8)]) instead of the
    standard BSD syslog, you can make use of its ability to set filters and to format
    the output using templates. The use of NSCA compensates for the fact that the
    program cannot itself transmit data in encrypted form.
  id: totrans-2487
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用的是 **`syslog-ng`**^([[141](#ftn.CHP-14-FN-8)]) 而不是标准的 BSD syslog，你可以利用其设置过滤器和使用模板格式化输出的能力。使用
    NSCA 可以弥补程序本身无法以加密形式传输数据的事实。
- en: This connection to Nagios is supplemented by programs to evaluate log files,
    such as **`logcheck`**,^([[142](#ftn.CHP-14-FN-9)]) which is contained in almost
    every Linux distribution, but it does not replace them. This is because Nagios
    can send individual e-mails for each event, but not for a summary of events, as
    **`logcheck`** does (usually once per hour). In addition to this, the Web interface
    always displays the last event in each case.
  id: totrans-2488
  prefs: []
  type: TYPE_NORMAL
  zh: 除了与 Nagios 的连接外，还有评估日志文件的程序来补充，例如 **`logcheck`**^([[142](#ftn.CHP-14-FN-9)])，它几乎包含在每一个
    Linux 发行版中，但它并不能取代它们。这是因为 Nagios 可以为每个事件发送单独的电子邮件，但不能像 **`logcheck`** 那样发送事件摘要（通常每小时一次）。此外，Web
    界面总是显示每个情况下的最后事件。
- en: 14.5.1 Preparing **`syslog-ng`** for use with Nagios
  id: totrans-2489
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.5.1 为使用 Nagios 准备 **`syslog-ng`**
- en: Apart from the source code, the **`syslog-ng`** homepage^([[143](#ftn.CHP-14-FN-10)])
    also provides a detailed manual, which is why we shall only discuss the basic
    principle at this point. The software differentiates between the **`source`**,
    **`filter`**, and **`destination`**. All three objects can be combined in any
    form; they are defined in the configuration file **`/etc/syslog-ng/syslog-ng.conf:`**
  id: totrans-2490
  prefs: []
  type: TYPE_NORMAL
  zh: 除了源代码外，**`syslog-ng`** 的主页^([[143](#ftn.CHP-14-FN-10)]) 还提供了一份详细的手册，因此我们在此仅讨论基本原理。该软件区分了
    **`source`**、**`filter`** 和 **`destination`**。所有三个对象可以以任何形式组合；它们在配置文件 **`/etc/syslog-ng/syslog-ng.conf:`**
    中定义。
- en: '[PRE329]'
  id: totrans-2491
  prefs: []
  type: TYPE_PRE
  zh: '[PRE329]'
- en: 'This example defines three sources at the same time: **`unix-stream`** reads
    from the socket **`/dev/log`**, through which most programs send their messages
    to the syslog. **`internal`** is the name of the source **`syslog-ng`** feeds
    with internal messages, and from the file **`/proc/kmsg`** syslog receives **`kernel`**
    messages. These are given the **`kernel:`** prefix, so that they can be be distinguished
    from normal log entries.'
  id: totrans-2492
  prefs: []
  type: TYPE_NORMAL
  zh: 此示例同时定义了三个源：**`unix-stream`** 从套接字 **`/dev/log`** 读取，这是大多数程序将消息发送到 syslog 的方式。**`internal`**
    是 **`syslog-ng`** 提供内部消息的源名称，以及从文件 **`/proc/kmsg`** 接收 **`kernel`** 消息。这些消息带有
    **`kernel:`** 前缀，以便它们可以与正常日志条目区分开来。
- en: The **`destination`** definition ensures that all syslog output appears on the
    console **`ttyl0`** (this can be displayed with ![14.5.1 Preparing syslog-ng for
    use with Nagios](../Images/tagoreillycom20081104nostarchimages223832.png)-![14.5.1
    Preparing syslog-ng for use with Nagios](../Images/tagoreillycom20081104nostarchimages223834.png)).
  id: totrans-2493
  prefs: []
  type: TYPE_NORMAL
  zh: '**`destination`** 定义确保所有 syslog 输出都显示在控制台 **`ttyl0`** 上（这可以通过 ![14.5.1 为使用
    Nagios 准备 syslog-ng](../Images/tagoreillycom20081104nostarchimages223832.png)-![14.5.1
    为使用 Nagios 准备 syslog-ng](../Images/tagoreillycom20081104nostarchimages223834.png))。'
- en: '**`filter`** defines what messages should reach this destination, if any. In
    the case of the **`f_messages`** filter, this is all messages matching the category
    (the **`level`**) **`info`** and that syslog does not provide with the stamp (the
    **`facility`**; see **`man syslog.conf`** and **`man 3 syslog`**) **`auth`** or
    **`authpriv`**. Alternatively **`syslog-ng`** filters according to a search pattern,
    with the instruction **`match`** (**``"*`pattern`*"``**), according to the program
    doing the logging (**`program`**(**``"*`program name`*"``**)) and according to
    the source host (**`host`** (**``"*`hostname`*"``**)).'
  id: totrans-2494
  prefs: []
  type: TYPE_NORMAL
  zh: '**`filter`** 定义了哪些消息应该到达这个目的地，如果有。在 **`f_messages`** 过滤器的情况下，这是所有匹配类别（**`level`**）**`info`**
    的消息，并且 syslog 没有提供带有戳记（**`facility`**；参见 **`man syslog.conf`** 和 **`man 3 syslog`**）**`auth`**
    或 **`authpriv`** 的消息。或者 **`syslog-ng`** 可以根据搜索模式进行过滤，使用指令 **`match`** （**``"*`pattern`*"``**），根据记录日志的程序（**`program`**（**``"*`program
    name`*"``**））和根据源主机（**`host`**（**``"*`hostname`*"``**））。'
- en: 'Finally the keyword **`log`** links the source, filter, and destination. Multiple
    specifications are possible here, so several sources and destinations can be specified
    in a single statement:'
  id: totrans-2495
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，关键字 **`log`** 将源、过滤器和目的地链接起来。这里可以指定多个配置，因此可以在单个语句中指定多个源和目的地：
- en: '[PRE330]'
  id: totrans-2496
  prefs: []
  type: TYPE_PRE
  zh: '[PRE330]'
- en: If you specify several filters in a **`log`** statement, **`syslog-ng`** only
    allows data through that matches all filter criteria (AND link).
  id: totrans-2497
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你在一个 **`log`** 语句中指定了多个过滤器，**`syslog-ng`** 只允许通过匹配所有过滤条件的数据（AND 链接）。
- en: 'To integrate this into Nagios, use is made of the option of defining a program
    as a target, which is called for every event:'
  id: totrans-2498
  prefs: []
  type: TYPE_NORMAL
  zh: 要将此集成到 Nagios 中，使用定义程序作为目标的选项，该目标会在每个事件上被调用：
- en: '[PRE331]'
  id: totrans-2499
  prefs: []
  type: TYPE_PRE
  zh: '[PRE331]'
- en: 'The **`template`** directive formats the output so that it is suitable for
    **`send_nsca`**, using a semicolon as the delimiter: host and service names (**`syslog-ng`**)
    are followed by the state (**`1`** = WARNING; **`2`** = CRITICAL), and then the
    actual output text is given. Apart from **`$H0ST`** and **`$MSG`**, **`syslog-ng`**
    has a series of further macros, which are described individually in the documentation
    on the homepage. The parameter **`template_escape`** protects quotation marks
    in the text and is intended principally for SQL commands, so in this case it can
    be set to **`no`**.'
  id: totrans-2500
  prefs: []
  type: TYPE_NORMAL
  zh: '**`template`** 指令格式化输出，使其适合用于 **`send_nsca`**，使用分号作为分隔符：主机和服务名称（**`syslog-ng`**）后面跟着状态（**`1`**
    = 警告；**`2`** = 严重），然后是实际输出文本。除了 **`$H0ST`** 和 **`$MSG`**，**`syslog-ng`** 还有一系列其他宏，这些宏在主页上的文档中分别进行了描述。参数
    **`template_escape`** 用于保护文本中的引号，主要用于 SQL 命令，因此在这种情况下可以将其设置为 **`no`**。'
- en: 'The following script **`send_syslog.sh`** uses the bash function **`read`**
    to read from the standard input line by line, and for each line read it calls
    up **`send_nsca`**, which sends on the data—as described in this chapter—as a
    passive test result to Nagios:'
  id: totrans-2501
  prefs: []
  type: TYPE_NORMAL
  zh: 以下脚本 **`send_syslog.sh`** 使用 bash 函数 **`read`** 逐行读取标准输入，对于每行读取的内容，它调用 **`send_nsca`**，将数据作为被动测试结果发送到
    Nagios（如本章所述）：
- en: '[PRE332]'
  id: totrans-2502
  prefs: []
  type: TYPE_PRE
  zh: '[PRE332]'
- en: Because a semicolon is used as a delimiter, we specify this explicitly with
    the option **`-d`**. The status report that each **`send_nsca`** command displays
    on the standard output is diverted by the script into a separate log file (**`/usr/local/nagios/var/send_syslog.log`**).
  id: totrans-2503
  prefs: []
  type: TYPE_NORMAL
  zh: 由于使用了分号作为分隔符，我们使用选项 **`-d`** 明确指定这一点。每个 **`send_nsca`** 命令在标准输出上显示的状态报告被脚本重定向到单独的日志文件（**`/usr/local/nagios/var/send_syslog.log`**）。
- en: 'Thanks to the **`program`** instruction in the syslog configuration, **`syslog-ng`**
    starts the script automatically. This is also the reason that the **`send_nsca`**
    command is in an endless loop: this means that **`syslog-ng`** does not run an
    external program every time there is a relevant event.'
  id: totrans-2504
  prefs: []
  type: TYPE_NORMAL
  zh: 由于 syslog 配置中的 **`program`** 指令，**`syslog-ng`** 会自动启动脚本。这也是 **`send_nsca`**
    命令处于无限循环中的原因：这意味着每次有相关事件时，**`syslog-ng`** 都不会运行外部程序。
- en: '14.5.2 Nagios configuration: volatile services'
  id: totrans-2505
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.5.2 Nagios 配置：易变服务
- en: 'In Nagios slang, "volatile" refers to services that show an error state only
    once. This refers to devices, for example, that automatically reset the state
    when an error is queried—which means that the error cannot be reproduced. The
    same applies for syslog entries: if a check following an error state returns an
    error, this will always be a second event. So we don''t have a continuing error
    state here, but a problem that has again occurred.'
  id: totrans-2506
  prefs: []
  type: TYPE_NORMAL
  zh: 在Nagios术语中，“volatile”指的是只显示一次错误状态的服务。这适用于例如在查询错误时自动重置状态的设备——这意味着错误无法重现。同样适用于syslog条目：如果跟随错误状态检查返回错误，这始终是第二个事件。因此，这里没有持续错误状态，而是一个再次发生的问题。
- en: For continuing error states, Nagios normally does not send any further messages
    for the time being. With the **`is_volatile`** parameter, however, it treats every
    error as if it had just occurred. Nagios logs the state, sends a notification,
    and implements the event handler—provided it is defined—(see [Appendix C](../Text/apc.html
    "Appendix C. Event Handlers") from page 619).
  id: totrans-2507
  prefs: []
  type: TYPE_NORMAL
  zh: 对于持续错误状态，Nagios通常在将问题状态分类为硬状态之前不会发送任何进一步的消息。然而，有了**`is_volatile`**参数，它将每个错误都视为刚刚发生。Nagios记录状态，发送通知，并实现事件处理器——如果已定义的话——（见第619页的[附录C](../Text/apc.html
    "附录C. 事件处理器"））。
- en: 'For **`syslog-ng`**, this means that each entry is seen as an independent event.
    In order that Nagios sees things in this way as well, the corresponding service
    definition contains the **`is_volatile`** parameter:'
  id: totrans-2508
  prefs: []
  type: TYPE_NORMAL
  zh: 对于**`syslog-ng`**，这意味着每个条目被视为一个独立的事件。为了让Nagios也以这种方式看待事物，相应的服务定义中包含**`is_volatile`**参数：
- en: '[PRE333]'
  id: totrans-2509
  prefs: []
  type: TYPE_PRE
  zh: '[PRE333]'
- en: Since the Nagios server should not test anything on its own, **`active_checks_enabled
    0`** switches off active service checks. However, *freshness checking* (see [13.4
    Reacting to Out-of-Date Information of Passive Checks](../Text/ch13s04.html "13.4
    Reacting to Out-of-Date Information of Passive Checks") from page 295) can always
    cause Nagios to perform active tests. To prevent this, we set the **`check_freshness`**
    parameter in this case explicitly to **`0`**.
  id: totrans-2510
  prefs: []
  type: TYPE_NORMAL
  zh: 由于Nagios服务器不应自行测试任何内容，**`active_checks_enabled 0`** 将主动服务检查关闭。然而，*新鲜度检查*（见第295页的[13.4
    对被动检查过时信息的响应](../Text/ch13s04.html "13.4 对被动检查过时信息的响应"））总是会导致Nagios执行主动测试。为了防止这种情况，我们在此明确将**`check_freshness`**参数设置为**`0`**。
- en: 'This service definition does not really require the parameters **`check_command`**
    and **`check_period`**, but since these are mandatory parameters, they must still
    be specified: as **`check_command`**, the plugin **`check_dummy`** (see [8.1 The
    Dummy Plugin for Tests](../Text/ch08.html#the_dummy_plugin_for_tests "8.1 The
    Dummy Plugin for Tests") in page 188) is used.'
  id: totrans-2511
  prefs: []
  type: TYPE_NORMAL
  zh: 此服务定义实际上不需要**`check_command`**和**`check_period`**参数，但由于这些是必填参数，它们仍然必须被指定：作为**`check_command`**，使用插件**`check_dummy`**（见第188页的[8.1
    测试用的虚拟插件](../Text/ch08.html#the_dummy_plugin_for_tests "8.1 测试用的虚拟插件"））。
- en: It is also important that **`max_check_attempts`** is set to **`1`**, so that
    a transmitted error state immediately triggers a hard state. With a value larger
    than **`1`**, Nagios would wait for further error results here before categorizing
    the problem state as a hard state.
  id: totrans-2512
  prefs: []
  type: TYPE_NORMAL
  zh: 还很重要的一点是**`max_check_attempts`**设置为**`1`**，这样传递的错误状态就会立即触发硬状态。如果值大于**`1`**，Nagios会在将问题状态分类为硬状态之前等待进一步的错误结果。
- en: The **`notification_options`** parameter ensures that the system informs the
    specified contact group of all error states (WARNING, CRITICAL, and UNKNOWN).
    The **`notification_interval`**, which defines the interval between two notifications
    for a continuing error state, is actually superfluous, since Nagios, thanks to
    **`is_volatile 1`**, provides notification of every event immediately, irrespective
    of what the previous state looked like. But since it is a mandatory parameter,
    **`notification_interval`** still has to be specified.
  id: totrans-2513
  prefs: []
  type: TYPE_NORMAL
  zh: '**`notification_options`**参数确保系统通知指定的联系人组所有错误状态（警告、严重和未知）。定义持续错误状态之间通知间隔的**`notification_interval`**实际上是不必要的，因为Nagios，多亏了**`is_volatile
    1`**，会立即通知每个事件，而不考虑之前的状态如何。但由于它是一个必填参数，**`notification_interval`**仍然需要被指定。'
- en: 14.5.3 Resetting error states manually
  id: totrans-2514
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.5.3 手动重置错误状态
- en: Events that are taken into account by the syslog filter always inform you of
    only one current state, which is why the syslog service in Nagios never displays
    an OK state on its own ([Figure 14-2](../Text/ch14s05.html#the_syslog-ng_service_in_an_error_state
    "Figure 14-2. The syslog-ng service in an error state")).
  id: totrans-2515
  prefs: []
  type: TYPE_NORMAL
  zh: 被syslog过滤器考虑的事件始终只通知您一个当前状态，这就是为什么Nagios中的syslog服务永远不会单独显示OK状态（[图14-2](../Text/ch14s05.html#the_syslog-ng_service_in_an_error_state
    "图14-2. syslog-ng服务处于错误状态"））。
- en: '![The syslog-ng service in an error state](../Images/tagoreillycom20081104nostarchimages223836.png.jpg)'
  id: totrans-2516
  prefs: []
  type: TYPE_IMG
  zh: '![syslog-ng服务处于错误状态](../Images/tagoreillycom20081104nostarchimages223836.png.jpg)'
- en: Figure 14-2. The `syslog-ng` service in an error state
  id: totrans-2517
  prefs: []
  type: TYPE_NORMAL
  zh: 图14-2. `syslog-ng`服务处于错误状态
- en: This problem can be solved with the Web interface, which allows a passive check
    result to be generated manually.
  id: totrans-2518
  prefs: []
  type: TYPE_NORMAL
  zh: 此问题可以通过Web界面解决，该界面允许手动生成被动检查结果。
- en: If you click on the service name in [Figure 14-2](../Text/ch14s05.html#the_syslog-ng_service_in_an_error_state
    "Figure 14-2. The syslog-ng service in an error state"), the extended status information
    will be shown ([Figure 14-3](../Text/ch14s05.html#the_arrow_points_to_the_possibility_of
    "Figure 14-3. The arrow points to the possibility of "generating" a passive test
    result for the syslog-ng service")). There you will find the entry **`Submit passive
    check result for this service`**, with which a test result can be sent manually
    ([Figure 14-4](../Text/ch14s05.html#creating_a_passive_check_result_sysl "Figure 14-4. Creating
    a passive check result syslog-ng")). In this way the **`syslog-ng`** service can
    be reset to its normal state. Since the Web interface always shows only the most
    recent error state, but not individual error messages, you must look through the
    e-mail messages to see whether other errors have occurred apart from those errors
    displayed by Nagios in the Web interface.
  id: totrans-2519
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您点击[图14-2](../Text/ch14s05.html#the_syslog-ng_service_in_an_error_state "图14-2.
    syslog-ng服务处于错误状态")中的服务名称，将显示扩展状态信息（[图14-3](../Text/ch14s05.html#the_arrow_points_to_the_possibility_of
    "图14-3. 箭头指向生成syslog-ng服务被动测试结果的可能性"））。在那里您将找到条目**`为该服务提交被动检查结果`**，通过它可以手动发送测试结果（[图14-4](../Text/ch14s05.html#creating_a_passive_check_result_sysl
    "图14-4. 创建被动检查结果 syslog-ng"））。这样，**`syslog-ng`**服务就可以重置到其正常状态。由于Web界面始终只显示最新的错误状态，而不显示单个错误消息，因此您必须查看电子邮件消息，以确定是否还有其他错误发生，而不仅仅是Nagios在Web界面中显示的错误。
- en: '![The arrow points to the possibility of "generating" a passive test result
    for the syslog-ng service](../Images/tagoreillycom20081104nostarchimages223838.png.jpg)'
  id: totrans-2520
  prefs: []
  type: TYPE_IMG
  zh: '![箭头指向生成syslog-ng服务的被动测试结果的可能性](../Images/tagoreillycom20081104nostarchimages223838.png.jpg)'
- en: Figure 14-3. The arrow points to the possibility of "generating" a passive test
    result for the `syslog-ng` service
  id: totrans-2521
  prefs: []
  type: TYPE_NORMAL
  zh: 图14-3. 箭头指向生成`syslog-ng`服务的被动测试结果的可能性
- en: You can also define your own service for each syslog event, of course. This
    may sometimes be quite time-consuming, but it does allow you to separate various
    messages and their processing states in the Web interface. If the filter in **`syslog-ng`**
    is restricted so that a syslog service object always refers to just one resource
    to be monitored, you can also leave out the **`is_volatile`** parameter.
  id: totrans-2522
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，您也可以为每个syslog事件定义自己的服务。这有时可能相当耗时，但它确实允许您在Web界面中分离各种消息及其处理状态。如果**`syslog-ng`**中的过滤器限制为syslog服务对象始终只引用一个要监控的资源，您也可以省略**`is_volatile`**参数。
- en: '![Creating a passive check result syslog-ng](../Images/tagoreillycom20081104nostarchimages223840.png.jpg)'
  id: totrans-2523
  prefs: []
  type: TYPE_IMG
  zh: '![创建被动检查结果 syslog-ng](../Images/tagoreillycom20081104nostarchimages223840.png.jpg)'
- en: Figure 14-4. Creating a passive check result `syslog-ng`
  id: totrans-2524
  prefs: []
  type: TYPE_NORMAL
  zh: 图14-4. 创建被动检查结果 `syslog-ng`
- en: '* * *'
  id: totrans-2525
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[141](#CHP-14-FN-8)]) The "ng" stands here for *next generation*.
  id: totrans-2526
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[141](#CHP-14-FN-8)]) 中的“ng”代表*下一代*。
- en: ^([[142](#CHP-14-FN-9)]) [http://sourceforge.net/projects/logcheck/](http://sourceforge.net/projects/logcheck/)
  id: totrans-2527
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[142](#CHP-14-FN-9)]) [http://sourceforge.net/projects/logcheck/](http://sourceforge.net/projects/logcheck/)
- en: ^([[143](#CHP-14-FN-10)]) [http://www.balabit.com/products/syslog_ng/](http://www.balabit.com/products/syslog_ng/)
  id: totrans-2528
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[143](#CHP-14-FN-10)]) [http://www.balabit.com/products/syslog_ng/](http://www.balabit.com/products/syslog_ng/)
- en: '14.6 Application Example II: Processing SNMP Traps'
  id: totrans-2529
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 14.6 应用示例II：处理SNMP陷阱
- en: Asynchronous messages that are sent by an SNMP agent (see [11.1 Introduction
    to SNMP](../Text/ch11.html#introduction_to_snmp "11.1 Introduction to SNMP") from
    page 228) to a central management unit, called *traps* in SNMP jargon, can be
    processed by Nagios in a way similar to the Nagios Service Check Acceptor (NSCA).
    In addition, it allows SNMP traps to be accepted on a host other than the Nagios
    server itself.
  id: totrans-2530
  prefs: []
  type: TYPE_NORMAL
  zh: 由SNMP代理（见[11.1 SNMP简介](../Text/ch11.html#introduction_to_snmp "11.1 SNMP简介"，第228页）发送给中央管理单元的异步消息，在SNMP术语中称为*陷阱*，可以通过Nagios以类似于Nagios服务检查接受器（NSCA）的方式进行处理。此外，它还允许在Nagios服务器本身之外的主机上接受SNMP陷阱。
- en: Processing SNMP traps with Nagios is particularly worthwhile if the system monitors
    the network almost completely, and only a few devices or services restrict their
    communication just to SNMP and SNMP traps. Nagios, or the Open Source tool OpenNMS,^([[144](#ftn.CHP-14-FN-11)])
    are no substitutes for real commercial SNMP management systems.
  id: totrans-2531
  prefs: []
  type: TYPE_NORMAL
  zh: 使用Nagios处理SNMP陷阱特别有意义，如果系统几乎完全监控网络，并且只有少数设备或服务将它们的通信限制为仅SNMP和SNMP陷阱。Nagios或开源工具OpenNMS不能替代真正的商业SNMP管理系统。
- en: In many cases, SNMP traps are vendor-specific, so that you cannot avoid getting
    to grips with the appropriate documentation and the vendor-specific MIB (*Management
    Information Base*; see [11.1.1 The Management Information Base](../Text/ch11.html#the_management_information_base
    "11.1.1 The Management Information Base") from page 229).
  id: totrans-2532
  prefs: []
  type: TYPE_NORMAL
  zh: 在许多情况下，SNMP陷阱是厂商特定的，因此你不可避免地需要熟悉相应的文档和厂商特定的MIB（*管理信息库*；见[11.1.1 管理信息库](../Text/ch11.html#the_management_information_base
    "11.1.1 管理信息库"，第229页)）。
- en: 14.6.1 Receiving traps with **`snmptrapd`**
  id: totrans-2533
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.6.1 使用**`snmptrapd`**接收陷阱
- en: In order to receive SNMP traps, you require a special Unix/Linux daemon that
    generates messages for Nagios from them. The software package NET-SNMP, described
    in [11.2.2 The NET-SNMP daemon](../Text/ch11s02.html#the_net-snmp_daemon "11.2.2
    The NET-SNMP daemon") from page 238, includes the daemon **`snmptrapd`**.
  id: totrans-2534
  prefs: []
  type: TYPE_NORMAL
  zh: 为了接收SNMP陷阱，你需要一个特殊的Unix/Linux守护进程，它从它们生成消息供Nagios使用。软件包NET-SNMP，在[11.2.2 NET-SNMP守护进程](../Text/ch11s02.html#the_net-snmp_daemon
    "11.2.2 NET-SNMP守护进程"，第238页)中描述，包括守护进程**`snmptrapd`**。
- en: In the following scenario, **`snmptrapd`** is installed on a third host (neither
    the computer generating the trap, nor the Nagios server). It evaluates the information
    received by means of a script and forwards it with NSCA to the Nagios server.^([[145](#ftn.CHP-14-FN-12)])
  id: totrans-2535
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下场景中，**`snmptrapd`**安装在第三台主机上（既不是生成陷阱的计算机，也不是Nagios服务器）。它通过脚本评估接收到的信息，并将其通过NSCA转发到Nagios服务器。[145](#ftn.CHP-14-FN-12)]
- en: 'In the **`snmptrapd`** configuration file **`/etc/snmp/snmptrapd.conf`**, each
    trap type is given a separate entry, the syntax of which corresponds to one of
    the following lines:'
  id: totrans-2536
  prefs: []
  type: TYPE_NORMAL
  zh: 在**`snmptrapd`**配置文件**`/etc/snmp/snmptrapd.conf`**中，每个陷阱类型都有一个单独的条目，其语法对应于以下行之一：
- en: '[PRE334]'
  id: totrans-2537
  prefs: []
  type: TYPE_PRE
  zh: '[PRE334]'
- en: The keyword **`traphandle`** is followed either by the object identifier of
    the desired trap, or by the keyword **`default`**. In the second case the entry
    applies to all traps that do not have their own configuration entry. Finally the
    program that should run if a relevant trap arrives is specified.
  id: totrans-2538
  prefs: []
  type: TYPE_NORMAL
  zh: 关键字**`traphandle`**后面跟的是所需陷阱的对象标识符，或者跟关键字**`default`**。在后一种情况下，条目适用于所有没有自己的配置条目的陷阱。最后，指定了在接收到相关陷阱时应运行的程序。
- en: In addition you can also include arguments used with this program. But you must
    be a bit careful when doing this. Quotation marks are passed on by **`snmptrapd`**
    as characters and spaces are always used as delimiters. This means that you cannot
    pass on any arguments containing spaces, which you should bear in mind when assigning
    name services in Nagios.
  id: totrans-2539
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，你还可以包括与此程序一起使用的参数。但在此过程中必须小心。引号由**`snmptrapd`**作为字符传递，而空格始终用作分隔符。这意味着你不能传递包含空格的任何参数，这在分配Nagios中的名称服务时应予以考虑。
- en: '**`snmpdtrapd`** gives this program information via the standard output in
    the following format:'
  id: totrans-2540
  prefs: []
  type: TYPE_NORMAL
  zh: '**`snmpdtrapd`**通过标准输出以以下格式向此程序提供信息：'
- en: '[PRE335]'
  id: totrans-2541
  prefs: []
  type: TYPE_PRE
  zh: '[PRE335]'
- en: The first line contains the *fully qualified domain name* of the host that sends
    the message and the second, its IP address. Then one or more OID-value pairs are
    given, each on a separate line. A particular event is very often linked to a unique
    OID-value pair, so that the program can often omit the evaluation of the OID-value
    pair entirely.
  id: totrans-2542
  prefs: []
  type: TYPE_NORMAL
  zh: 第一行包含发送消息的主机的完全限定域名，第二行是其IP地址。然后给出一个或多个OID-值对，每个值对占一行。特定事件通常与一个唯一的OID-值对相关联，因此程序通常可以完全省略OID-值对的评估。
- en: 'In the following **`snmptrapd.conf`** example, the lines are wrapped for readability
    Each **`traphandle`** instruction *must* be entered on a single line:'
  id: totrans-2543
  prefs: []
  type: TYPE_NORMAL
  zh: 在下面的 **`snmptrapd.conf`** 示例中，为了便于阅读，行已被换行。每个 **`traphandle`** 指令 *必须* 在一行中输入：
- en: '[PRE336]'
  id: totrans-2544
  prefs: []
  type: TYPE_PRE
  zh: '[PRE336]'
- en: The traps used here are sent by the SNMP agent **`snmpd`** from the NET-SNMP
    package by default, as long as a destination was specified in **`snmpd.conf:`**
  id: totrans-2545
  prefs: []
  type: TYPE_NORMAL
  zh: 这里使用的陷阱默认由NET-SNMP包中的SNMP代理 **`snmpd`** 发送，只要在 **`snmpd.conf:`** 中指定了目的地。
- en: '[PRE337]'
  id: totrans-2546
  prefs: []
  type: TYPE_PRE
  zh: '[PRE337]'
- en: If a trap arrives with the OID **`SNMPv2-MIB::coldStart`**, for example, **`snmptrapd`**
    starts the script **`handle-trap`** with the argument **`cold-start`**. In this
    way it does not have to search first for the necessary information from the OID-value
    pairs. However, this shortcut only works with trap OID names that describe their
    function.
  id: totrans-2547
  prefs: []
  type: TYPE_NORMAL
  zh: 如果收到带有OID **`SNMPv2-MIB::coldStart`** 的陷阱，例如，**`snmptrapd`** 将使用参数 **`cold-start`**
    启动脚本 **`handle-trap`**。这样它就不必首先从OID-值对中搜索必要的信息。然而，这个快捷方式仅适用于描述其功能的陷阱OID名称。
- en: 14.6.2 Passing on traps to NSCA
  id: totrans-2548
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.6.2 将陷阱传递给NSCA
- en: The script **`handle-trap`**, which is run by **`snmptrapd`**, breaks down the
    information passed on and hands it over, correctly formatted, to **`send_nsca:`**
  id: totrans-2549
  prefs: []
  type: TYPE_NORMAL
  zh: 脚本 **`handle-trap`**，由 **`snmptrapd`** 运行，分解传递的信息并将其正确格式化后传递给 **`send_nsca:`**
- en: '[PRE338]'
  id: totrans-2550
  prefs: []
  type: TYPE_PRE
  zh: '[PRE338]'
- en: First it saves the log file and the name of the Nagios server **`nagsrv`**,
    each in a separate variable. The first **`case`** statement specifies the host
    name used by Nagios for the IP address passed on (and temporarily stored in **`IPADDR`**).
    **`HOST`** normally contains the fully qualified domain name, which also cannot
    be used directly, and sometimes also just contains one IP address, so that it
    is better to use the latter here. The explicit test also allows it to discard
    traps from undesired hosts. Finally, matching traps land without further authentication
    on the Nagios server.^([[146](#ftn.CHP-14-FN-13)])
  id: totrans-2551
  prefs: []
  type: TYPE_NORMAL
  zh: 首先它保存日志文件和Nagios服务器 **`nagsrv`** 的名称，每个都在单独的变量中。第一个 **`case`** 语句指定Nagios用于传递的IP地址（暂时存储在
    **`IPADDR`** 中）的主机名。**`HOST`** 通常包含完全限定域名，这也不可以直接使用，有时也只包含一个IP地址，因此在这里使用后者更好。显式测试还允许它丢弃来自不受欢迎的主机的陷阱。最后，匹配的陷阱无需进一步认证即可在Nagios服务器上着陆.^([[146](#ftn.CHP-14-FN-13)])
- en: The following **`if`** statement determines whether a service name was also
    given to the script. If this is the case, then it is saved in the **`SERVICE`**
    variable. If there was a second argument, the procedure is similar. Depending
    on the value, the next **`case $SWITCH`** instruction defines the output text
    and the desired status for Nagios.
  id: totrans-2552
  prefs: []
  type: TYPE_NORMAL
  zh: 下面的 **`if`** 语句确定是否也向脚本提供了服务名称。如果是这样，则将其保存到 **`SERVICE`** 变量中。如果有第二个参数，过程类似。根据值，下一个
    **`case $SWITCH`** 指令定义输出文本和Nagios期望的状态。
- en: The command for NSCA is finally assembled and the **`CMD`** variable is passed
    on by the script to **`send_nsca`**. As in previous examples, a semicolon is used
    as the delimiter, which must be specified in **`send_nsca`** with the option **`-d`**.
  id: totrans-2553
  prefs: []
  type: TYPE_NORMAL
  zh: 最终组装NSCA的命令，并通过脚本将 **`CMD`** 变量传递给 **`send_nsca`**。与前面的示例一样，使用分号作为分隔符，这必须在 **`send_nsca`**
    中使用选项 **`-d`** 指定。
- en: 14.6.3 The matching service definition
  id: totrans-2554
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 14.6.3 匹配服务定义
- en: 'As in the **`syslog-ng`** example ([14.5.1 Preparing syslog-ng for use with
    Nagios](../Text/ch14s05.html#preparing_syslog-ng_for_use_with_nagios "14.5.1 Preparing
    syslog-ng for use with Nagios")), we again define the service on the Nagios server
    as a purely passive one:'
  id: totrans-2555
  prefs: []
  type: TYPE_NORMAL
  zh: 与 **`syslog-ng`** 示例（[14.5.1 为使用Nagios准备syslog-ng](../Text/ch14s05.html#preparing_syslog-ng_for_use_with_nagios
    "14.5.1 为使用Nagios准备syslog-ng"））一样，我们再次将Nagios服务器上的服务定义为纯被动型：
- en: '[PRE339]'
  id: totrans-2556
  prefs: []
  type: TYPE_PRE
  zh: '[PRE339]'
- en: 'Since soft states do not make any sense in a single trap message, we should
    set **`max_check_attempts`** back to **`1`**. Whether the parameter **`is_volatile`**
    is used or not depends on the purpose to which the service is put. As long as
    you define a separate service for each error category, there is no problem in
    omitting **`is_volatile`**. But if you form different error categories using a
    single service, you should **`set is_volatile 1`**, because in this case the previous
    error will seldom have anything to do with the new one. [14.5.2 Nagios configuration:
    volatile services](../Text/ch14s05.html#nagios_configuration_colon_volatile_se
    "14.5.2 Nagios configuration: volatile services") in page 309 is devoted to the
    subject of volatile services.'
  id: totrans-2557
  prefs: []
  type: TYPE_NORMAL
  zh: 由于软状态在单个陷阱消息中没有意义，我们应该将**`max_check_attempts`**设置回**`1`**。是否使用参数**`is_volatile`**取决于服务的用途。只要为每个错误类别定义一个单独的服务，就可以忽略**`is_volatile`**。但如果您使用单个服务形成不同的错误类别，则应该**`set
    is_volatile 1`**，因为在这种情况下，先前的错误很少与新的错误有任何关系。[14.5.2 Nagios配置：易变服务](../Text/ch14s05.html#nagios_configuration_colon_volatile_se
    "14.5.2 Nagios配置：易变服务")在第309页专门讨论了易变服务的问题。
- en: '* * *'
  id: totrans-2558
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: ^([[144](#CHP-14-FN-11)]) [http://www.opennms.org/](http://www.opennms.org/)
  id: totrans-2559
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[144](#CHP-14-FN-11)]) [http://www.opennms.org/](http://www.opennms.org/)
- en: ^([[145](#CHP-14-FN-12)]) If you install the **`snmptrapd`** on the Nagios server
    itself, you do not need NSCA and you can send a correspondingly formatted command,
    as described in [13.2 Passive Service Checks](../Text/ch13s02.html "13.2 Passive
    Service Checks") from page 293 directly to the interface for external commands.
  id: totrans-2560
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[145](#CHP-14-FN-12)]) 如果您在Nagios服务器本身上安装**`snmptrapd`**，则不需要NSCA，并且可以像[第13.2节被动服务检查](../Text/ch13s02.html
    "13.2被动服务检查")中描述的那样，直接将格式化命令发送到外部命令接口，该节在第293页。
- en: ^([[146](#CHP-14-FN-13)]) Although SNMPv3 does provide authentication for SNMP
    traps, this would go beyond the scope of this book.
  id: totrans-2561
  prefs: []
  type: TYPE_NORMAL
  zh: ^([[146](#CHP-14-FN-13)]) 虽然SNMPv3确实为SNMP陷阱提供了认证，但这超出了本书的范围。
- en: Chapter 15. Distributed Monitoring
  id: totrans-2562
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第15章. 分布式监控
- en: Passive service and host checks can be used to create a scenario in which several
    noncentral Nagios instances send their results to a central server. In general
    they transfer their results using the Nagios Service Check Acceptor (see [Chapter 14](../Text/ch14.html
    "Chapter 14. The Nagios Service Check Acceptor (NSCA)")); the central Nagios instance
    receives them through the External Command File interface and continues processing
    them as passive checks (see [Chapter 13](../Text/ch13.html "Chapter 13. Passive
    Tests with the External Command File") from page 291).
  id: totrans-2563
  prefs: []
  type: TYPE_NORMAL
  zh: 可以使用被动服务和主机检查来创建一个场景，其中几个非中心Nagios实例将它们的结果发送到中央服务器。通常，它们使用Nagios服务检查接受者（参见[第14章](../Text/ch14.html
    "第14章. Nagios服务检查接受者（NSCA）"））来传输它们的结果；中央Nagios实例通过外部命令文件接口接收它们，并继续将它们作为被动检查处理（参见第291页的[第13章](../Text/ch13.html
    "第13章. 使用外部命令文件进行被动测试"））。
- en: What is now missing is the mechanism that prepares each test result of a noncentral
    Nagios instance to be sent with NSCA. For such cases, Nagios provides the commands
    OCSP ("Obsessive Compulsive Service Processor") and OCHP ("Obsessive Compulsive
    Host Processor"), two commands designed specifically for distributed monitoring.
    In contrast to *event handler* (see [Appendix C](../Text/apc.html "Appendix C. Event
    Handlers") from page 619), which shows changes in status and only passes on check
    results if the status has changed, these two commands obsessively pass on every
    test result ([Figure 15-1](../Text/ch15.html#distributed_monitoring_with_nagios
    "Figure 15-1. Distributed monitoring with Nagios")).
  id: totrans-2564
  prefs: []
  type: TYPE_NORMAL
  zh: 目前缺少的是准备每个非中心Nagios实例的测试结果以便与NSCA一起发送的机制。对于这种情况，Nagios提供了OCSP（“强迫症服务处理器”）和OCHP（“强迫症主机处理器”）这两个命令，这两个命令专门为分布式监控设计。与*事件处理器*（参见第619页的[附录C](../Text/apc.html
    "附录C. 事件处理器"））相比，它只显示状态变化，并且只有在状态发生变化时才传递检查结果，这两个命令则强迫性地传递每一个测试结果（[图15-1](../Text/ch15.html#distributed_monitoring_with_nagios
    "图15-1. 使用Nagios进行分布式监控")）。
- en: '![Distributed monitoring with Nagios](../Images/tagoreillycom20081104nostarchimages223842.png)'
  id: totrans-2565
  prefs: []
  type: TYPE_IMG
  zh: '![使用Nagios进行分布式监控](../Images/tagoreillycom20081104nostarchimages223842.png)'
- en: Figure 15-1. Distributed monitoring with Nagios
  id: totrans-2566
  prefs: []
  type: TYPE_NORMAL
  zh: 图15-1. 使用Nagios进行分布式监控
- en: 15.1 Switching On the OCSP/OCHP Mechanism
  id: totrans-2567
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 15.1 启用OCSP/OCHP机制
- en: In order to use OCSP/OCHP, several steps are necessary. The mechanism is initially
    switched on (only) on the noncentral Nagios servers in the global configuration
    file **`/etc/nagios/nagios.cfg`**, where a global command for hosts (OCHP) and
    services (OCSP) is defined. This causes the noncentral Nagios instance to send
    every result to the central server.
  id: totrans-2568
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使用OCSP/OCHP，需要几个步骤。该机制最初在全局配置文件**`/etc/nagios/nagios.cfg`**中的非中央Nagios服务器上开启（仅限），其中定义了针对主机（OCHP）和服务的全局命令。这导致非中央Nagios实例将每个结果发送到中央服务器。
- en: In the service and host definitions you can additionally set whether the corresponding
    service or host should use the mechanism or not. For the central Nagios server
    to be able to use the results transferred, each service or host on it must finally
    be defined once again.
  id: totrans-2569
  prefs: []
  type: TYPE_NORMAL
  zh: 在服务和主机定义中，您可以额外设置相应的服务或主机是否应该使用该机制。为了使中央Nagios服务器能够使用传输的结果，它上面的每个服务或主机最终都必须重新定义一次。
- en: 'You should only switch on the two parameters **`obsess_over_services`** and
    **`obsess_over_hosts`** in **`nagios.cfg`** if you really do want distributed
    monitoring:'
  id: totrans-2570
  prefs: []
  type: TYPE_NORMAL
  zh: 只有在您确实想要分布式监控的情况下，才应在**`nagios.cfg`**中开启**`obsess_over_services`**和**`obsess_over_hosts`**这两个参数。
- en: '[PRE340]'
  id: totrans-2571
  prefs: []
  type: TYPE_PRE
  zh: '[PRE340]'
- en: Every time a new test result arrives on the Nagios server, it calls the command
    object defined with **`ocsp_command`** or **`ochp_command`**. This causes an additional
    load on resources.
  id: totrans-2572
  prefs: []
  type: TYPE_NORMAL
  zh: 每次Nagios服务器收到新的测试结果时，它会调用使用**`ocsp_command`**或**`ochp_command`**定义的命令对象。这会在资源上造成额外的负载。
- en: The two timeouts prevent Nagios from spending too much time on one command.
    If processing does not terminate (because the command itself does not receive
    a timeout and the central Nagios server does not react), then the process table
    of the noncentral Nagios instance would fill very quickly, and might overflow.
  id: totrans-2573
  prefs: []
  type: TYPE_NORMAL
  zh: 这两个超时防止Nagios在一个命令上花费太多时间。如果处理没有终止（因为命令本身没有超时，中央Nagios服务器没有反应），那么非中央Nagios实例的进程表会很快填满，并可能溢出。
- en: 'If you want to selectively exclude test results for specific services and hosts
    from transmission to the central Nagios server, the following parameters are used:'
  id: totrans-2574
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想选择性地排除特定服务和主机的测试结果，不将其传输到中央Nagios服务器，可以使用以下参数：
- en: '[PRE341]'
  id: totrans-2575
  prefs: []
  type: TYPE_PRE
  zh: '[PRE341]'
- en: With a value of **`1`** the local Nagios instance sends the results of the host
    or service check to the central server, but with a value of **`0`**, this does
    not happen. The **`1`** is the default for both **`obsess_over_hosts`** and **`obsess_over_services`**;
    if results are *not* to be transferred, then you have to specify the two parameters.
    This is always recommended if the central location is only responsible for particular
    things, and the remaining administration is carried out on site.
  id: totrans-2576
  prefs: []
  type: TYPE_NORMAL
  zh: 当值为**`1`**时，本地Nagios实例将主机或服务检查的结果发送到中央服务器，但值为**`0`**时，则不会发生这种情况。**`1`**是**`obsess_over_hosts`**和**`obsess_over_services`**的默认值；如果结果**不**要传输，则必须指定这两个参数。如果中央位置只负责特定的事情，而其余的行政工作在现场进行，则始终建议这样做。
- en: 15.2 Defining OCSP/OCHP Commands
  id: totrans-2577
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 15.2 定义OCSP/OCHP命令
- en: Defining the two commands with which the noncentral instances send their results
    to the Nagios main server in most cases involves scripts that are based on **`send_nsca`**
    (see also the example in [14.4 Sending Test Results to the Server](../Text/ch14s04.html
    "14.4 Sending Test Results to the Server")). For services, such a script would
    look like the following one, in this case called **`submit_service_check:`**
  id: totrans-2578
  prefs: []
  type: TYPE_NORMAL
  zh: 定义非中央实例将结果发送到Nagios主服务器的两个命令，在大多数情况下涉及基于**`send_nsca`**的脚本（参见[14.4 将测试结果发送到服务器](../Text/ch14s04.html
    "14.4 将测试结果发送到服务器")中的示例）。对于服务，这样的脚本如下所示，在这种情况下称为**`submit_service_check:`**
- en: '[PRE342]'
  id: totrans-2579
  prefs: []
  type: TYPE_PRE
  zh: '[PRE342]'
- en: 'When run, the command expects four parameters on the command line in the correct
    order: the host monitored, the service name, the return value for the plugin opened
    (**`0`** for OK, **`1`** for WARNING, etc.), and the one-line info text that is
    issued by the plugin. To format the data we use the **`printf`** function (**`man
    printf`**). The newly formatted string is finally passed on to **`send_nsca`**.'
  id: totrans-2580
  prefs: []
  type: TYPE_NORMAL
  zh: 当运行时，命令期望在命令行上以正确的顺序提供四个参数：监控的主机、服务名称、插件打开的返回值（**`0`** 表示OK，**`1`** 表示WARNING等），以及插件发出的单行信息文本。为了格式化数据，我们使用**`printf`**函数（**`man
    printf`**）。最终将格式化后的字符串传递给**`send_nsca`**。
- en: 'The equivalent script for OCHP (stored here in the file **`submit_host_check`**)
    looks something like this:'
  id: totrans-2581
  prefs: []
  type: TYPE_NORMAL
  zh: OCHP的等效脚本（存储在此处的文件**`submit_host_check`**）看起来如下所示：
- en: '[PRE343]'
  id: totrans-2582
  prefs: []
  type: TYPE_PRE
  zh: '[PRE343]'
- en: The only thing missing is the specification of the service description.
  id: totrans-2583
  prefs: []
  type: TYPE_NORMAL
  zh: 唯一缺少的是服务描述的指定。
- en: It is best to store the two scripts, in conformity with the Nagios documentation,
    in a subdirectory **`eventhandlers`** (which normally needs to be created) in
    the plugin directory (usually **`/usr/local/nagios/libexec`**, but for some distributions
    this will be **`/usr/lib/nagios/plugins`**). You can retrieve this from the definition
    of the matching command object using the macro **`$USER1$`**. This is best defined
    in the **`misccommands.cfg file:`**
  id: totrans-2584
  prefs: []
  type: TYPE_NORMAL
  zh: 最好将这两个脚本，按照Nagios文档的要求，存储在插件目录（通常是 **`/usr/local/nagios/libexec`**，但对于某些发行版来说将是
    **`/usr/lib/nagios/plugins`**）下的子目录 **`eventhandlers`** 中（通常需要创建）。您可以使用宏 **`$USER1$`**
    从匹配的命令对象定义中检索它。这最好在 **`misccommands.cfg 文件`** 中定义：
- en: '[PRE344]'
  id: totrans-2585
  prefs: []
  type: TYPE_PRE
  zh: '[PRE344]'
- en: If you use a separate file for this, you must make sure that Nagios will load
    this file by adding an entry to **`/etc/nagios/nagios.cfg`**. The single quotes
    surrounding the **`$SERVICEDESC$`** macro and the two output macros in the **`command_line`**
    line are important. Their values sometimes contain empty spaces, which the command
    line would interpret as delimiters without the quotes.
  id: totrans-2586
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您为此使用单独的文件，您必须确保Nagios通过在 **`/etc/nagios/nagios.cfg`** 中添加条目来加载此文件。**`$SERVICEDESC$`**
    宏和 **`command_line`** 行中的两个输出宏周围的单引号很重要。它们的值有时包含空格，如果没有引号，命令行会将这些空格解释为分隔符。
- en: 15.3 Practical Scenarios
  id: totrans-2587
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 15.3 实际场景
- en: One application for distributed monitoring is the monitoring of branches or
    external offices in which a noncentral Nagios installation is limited to running
    service and host checks and sending the results to the central instance. The noncentral
    instances do not need further Nagios functions, such as the notification system
    or the Web interface.
  id: totrans-2588
  prefs: []
  type: TYPE_NORMAL
  zh: 分布式监控的一个应用是监控分支或外部办公室，在这些地方，非中心Nagios安装仅限于运行服务和主机检查，并将结果发送到中心实例。非中心实例不需要进一步使用Nagios功能，如通知系统或Web界面。
- en: On the other hand, if administrators look after the networks at the distributed
    locations, while the central IT department only looks after special services,
    then the noncentral Nagios server is set up as a normal, full-fledged installation
    and selectively forwards only those check results over the OCSP/OCHP mechanism
    to the central office for which the specialists there are responsible.
  id: totrans-2589
  prefs: []
  type: TYPE_NORMAL
  zh: 另一方面，如果管理员负责分布式位置的网络安全，而中心IT部门只负责特殊服务，那么非中心Nagios服务器将设置为正常、完整的安装，并选择性地通过OCSP/OCHP机制仅将那些检查结果转发到中央办公室，那里的专家负责。
- en: 'Whatever the case, you must ensure that the host and service definition is
    available both noncentrally and centrally. This can be done quite simply using
    templates ([2.11 Templates](../Text/ch02s11.html "2.11 Templates") in page 75)
    and the **`cfg_dir`** directive ([2.1 The Main Configuration File nagios.cfg](../Text/ch02.html#the_main_configuration_file_nagios.cfg
    "2.1 The Main Configuration File nagios.cfg"), page 55): you set up the definition
    so that the configuration files can be copied 1:1.'
  id: totrans-2590
  prefs: []
  type: TYPE_NORMAL
  zh: 无论情况如何，您必须确保主机和服务定义在非中心和中心都可用。这可以通过使用模板（[2.11 模板](../Text/ch02s11.html "2.11
    Templates")，第75页）和 **`cfg_dir`** 指令（[2.1 主配置文件 nagios.cfg](../Text/ch02.html#the_main_configuration_file_nagios.cfg
    "2.1 The Main Configuration File nagios.cfg")，第55页）非常简单地完成：您设置定义，以便配置文件可以1:1复制。
- en: 15.3.1 Avoiding redundancy in configuration files
  id: totrans-2591
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 15.3.1 避免配置文件中的冗余
- en: 'In the following example we assume that the noncentral servers only perform
    host and service checks and send the results to the central server, and do not
    provide any other Nagios functions. The following directories are set up on the
    central host:'
  id: totrans-2592
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下示例中，我们假设非中心服务器仅执行主机和服务的检查，并将结果发送到中心服务器，不提供任何其他Nagios功能。以下目录设置在中心主机上：
- en: '[PRE345]'
  id: totrans-2593
  prefs: []
  type: TYPE_PRE
  zh: '[PRE345]'
- en: Each of the configurations used for a location lands in the directory **`/etc/nagios/sites/`****``*`location`*``**.
    After **`global`**, all the definitions follow that can be used identically at
    all locations (e.g., the command definitions in **`checkcommands.cfg`**). The
    directory **`local`** takes in specific definitions for the central server definitions.
    These include the templates for services and hosts, where distinction must be
    made between central and noncentral.
  id: totrans-2594
  prefs: []
  type: TYPE_NORMAL
  zh: 用于每个位置的配置都放在目录 **`/etc/nagios/sites/`** 下的 **`location`** 目录中。在 **`global`**
    之后，所有可以在所有位置相同使用的定义都跟随（例如，在 **`checkcommands.cfg`** 中的命令定义）。目录 **`local`** 包含针对中心服务器定义的特定定义。这些包括服务和主机的模板，其中必须区分中心和外部。
- en: 'This directory is also created separately on the noncentral servers: only the
    folders **`global`** and **`sites/`****``*`location`*``** are copied from the
    central instance to the branch offices.'
  id: totrans-2595
  prefs: []
  type: TYPE_NORMAL
  zh: 此目录也在非中心服务器上单独创建：仅从中心实例复制 **`global`** 和 **`sites/`****``*`location`*``** 文件夹到分支机构。
- en: The three directories are read in with the **`cfg_dir`** directive in **`/etc/nagios/nagios.cfg:`**
  id: totrans-2596
  prefs: []
  type: TYPE_NORMAL
  zh: 三个目录通过 **`/etc/nagios/nagios.cfg`** 中的 **`cfg_dir`** 指令读取。
- en: '[PRE346]'
  id: totrans-2597
  prefs: []
  type: TYPE_PRE
  zh: '[PRE346]'
- en: 'Only settings that are identical for the noncentral and central page are used
    in the service definition:'
  id: totrans-2598
  prefs: []
  type: TYPE_NORMAL
  zh: 在服务定义中仅使用对于非中心页面和中心页面都相同的设置：
- en: '[PRE347]'
  id: totrans-2599
  prefs: []
  type: TYPE_PRE
  zh: '[PRE347]'
- en: The location-dependent parameters are dealt with by the templates.
  id: totrans-2600
  prefs: []
  type: TYPE_NORMAL
  zh: 位置相关的参数由模板处理。
- en: 15.3.2 Defining templates
  id: totrans-2601
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 15.3.2 定义模板
- en: In order that service definitions are identical on both the central and non-central
    servers, the local templates must have the same names as the central ones. In
    addition you should ensure that the obligatory parameters (see [Chapter 2](../Text/ch02.html
    "Chapter 2. Nagios Configuration") from page 53) are also all entered, even if
    they are not even required at one of the locations, because together, the template
    and service definitions must cover all obligatory parameters.
  id: totrans-2602
  prefs: []
  type: TYPE_NORMAL
  zh: 为了确保中心服务器和非中心服务器上的服务定义一致，本地模板必须与中心模板具有相同的名称。此外，您还应该确保所有必需的参数（参见第2章[配置Nagios](../Text/ch02.html
    "第2章。Nagios配置")第53页）都已输入，即使它们在某个位置不是必需的，因为模板和服务定义必须共同覆盖所有必需的参数。
- en: 'The following example shows a service template for one of the noncentral locations:'
  id: totrans-2603
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例显示了一个非中心位置的服务模板：
- en: '[PRE348]'
  id: totrans-2604
  prefs: []
  type: TYPE_PRE
  zh: '[PRE348]'
- en: The parameters that are important for the noncentral page are printed in bold
    type. Besides the parameters that refer to the test itself, the parameter **`obsess_over_services`**
    must also not be left out. This ensures that the check results are sent to the
    central server.
  id: totrans-2605
  prefs: []
  type: TYPE_NORMAL
  zh: 对于非中心页面重要的参数以粗体形式打印。除了指向测试本身的参数外，参数 **`obsess_over_services`** 也必须包含在内。这确保检查结果被发送到中心服务器。
- en: '**`notifications_enabled`** switches off notification in this case, since the
    local admins do not need to worry about error messages from services that are
    centrally monitored. Alternatively this can be done globally in the non-central
    **`/etc/nagios/nagios.cfg`**.'
  id: totrans-2606
  prefs: []
  type: TYPE_NORMAL
  zh: '**`notifications_enabled`** 在此情况下关闭通知，因为本地管理员无需担心来自中心监控服务的错误消息。或者这也可以在非中心的
    **`/etc/nagios/nagios.cfg`** 中全局完成。'
- en: '**`register 0`** ensures that the template is used exclusively as a template,
    so that Nagios does not interpret it as a separate service definition.'
  id: totrans-2607
  prefs: []
  type: TYPE_NORMAL
  zh: '**`register 0`** 确保模板仅作为模板使用，因此Nagios不会将其解释为单独的服务定义。'
- en: 'The counterpart with the same name on the central server looks something like
    this:'
  id: totrans-2608
  prefs: []
  type: TYPE_NORMAL
  zh: 中心服务器上具有相同名称的对应部分看起来如下：
- en: '[PRE349]'
  id: totrans-2609
  prefs: []
  type: TYPE_PRE
  zh: '[PRE349]'
- en: The parameter **`passive_checks_enabled`** is of importance here, as well as
    the configuration of the notification system. On the central side, the parameters
    involving the test itself come into play only if freshness checking is used (see
    [13.4 Reacting to Out-of-Date Information of Passive Checks](../Text/ch13s04.html
    "13.4 Reacting to Out-of-Date Information of Passive Checks") from page 295).
    This works only if the central Nagios server is itself in a position to actively
    test all services if there is any doubt. Since the **`check_command`** in this
    simple template solution is given in the location-dependent service definition,
    which is identical on the non-central and central servers, this will work only
    if the same command object can be used both centrally and noncentrally—if the
    object definitions in **`global/checkcommands.cfg`** match on both sides.
  id: totrans-2610
  prefs: []
  type: TYPE_NORMAL
  zh: 参数 **`passive_checks_enabled`** 以及通知系统的配置在这里很重要。在中心侧，涉及测试本身的参数仅在启用新鲜度检查时才会起作用（参见第13.4节[对被动检查过时信息的反应](../Text/ch13s04.html
    "第13.4节。对被动检查过时信息的反应")第295页）。这仅在中心Nagios服务器本身能够主动测试所有服务且有任何疑问时才有效。由于在此简单的模板解决方案中，**`check_command`**
    在位置相关的服务定义中给出，且在非中心和中心服务器上相同，因此只有在中心和非中心都可以使用相同的命令对象时才会有效——如果**`global/checkcommands.cfg`**
    中的对象定义在两边匹配。
- en: In the example, however, we completely switch off active tests of services at
    the Bonn location, with **`check_period none`** and **`check_freshness`** set
    to 0\. The system described so far can also be applied to host checks, of course.
  id: totrans-2611
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，在示例中，我们完全关闭了波恩地点的服务主动测试，使用 **`check_period none`** 和将 **`check_freshness`**
    设置为0。到目前为止所描述的系统当然也可以应用于主机检查。
