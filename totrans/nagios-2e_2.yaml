- en: Part II. In More Detail...
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Chapter 4. Nagios Basics
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The fact that a host can be reached, in itself, has little meaning if no service
    is running on it on which somebody or something relies. Accordingly, everything
    in Nagios revolves around service checks. After all, no service can run without
    a host. If the host computer fails, it cannot provide the desired service. Things
    get slightly more complicated if, for example, a router that lies between users
    and the system providing services is brought into play. If this fails, the desired
    service may still be running on the target host, but it is nevertheless no longer
    reachable for the user.
  prefs: []
  type: TYPE_NORMAL
- en: Nagios is in a position to reproduce such dependencies and to precisely inform
    the administrator of the failure of an important network component, instead of
    flooding the administrator with irrelevant error messages concerning services
    that cannot be reached. An understanding of such dependencies is essential for
    the smooth operation of Nagios, which is why [4.1 Taking into Account the Network
    Topology](../Text/ch04.html#taking_into_account_the_network_topology "4.1 Taking
    into Account the Network Topology") will examine these dependencies and the way
    Nagios works in more detail.
  prefs: []
  type: TYPE_NORMAL
- en: Another important item is the *state* of a host or service. On the one hand
    Nagios allows a much finer distinction than just OK or "not OK;" on the other
    hand the distinction between *soft state* and *hard state* means that the administrator
    does not have to deal with short-term disruptions that have long since disappeared
    by the time the administrator has received the information. These states also
    influence the intensity of the service checks. How this functions is described
    in detail in [4.3 States of Hosts and Services](../Text/ch04s03.html "4.3 States
    of Hosts and Services").
  prefs: []
  type: TYPE_NORMAL
- en: 4.1 Taking into Account the Network Topology
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: How Nagios handles dependencies of hosts and services can be best illustrated
    with an example. [Figure 4-1](../Text/ch04.html#topology_of_an_example_network
    "Figure 4-1. Topology of an example network") represents a small network in which
    the Domain Name Service on **`proxy`** is to be monitored.
  prefs: []
  type: TYPE_NORMAL
- en: '![Topology of an example network](../Images/tagoreillycom20081104nostarchimages223798.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 4-1. Topology of an example network
  prefs: []
  type: TYPE_NORMAL
- en: The service check always serves as the starting point for monitoring that is
    regularly performed by the system. As long as the service can be reached, Nagios
    takes no further steps; that is, it does not perform any host checks.^([[41](#ftn.CHP-4-FN-1)])
  prefs: []
  type: TYPE_NORMAL
- en: For **`switch1`**, **`switch2`**, and **`proxy`**, such a check would be pointless
    anyway, because if the DNS service responds to **`proxy`**, then the hosts mentioned
    are automatically accessible.
  prefs: []
  type: TYPE_NORMAL
- en: If the name service fails, however, Nagios tests the computer involved with
    a host check, to see whether the service or the host is causing the problem.
  prefs: []
  type: TYPE_NORMAL
- en: If **`proxy`** cannot be reached, Nagios might test the *parent* hosts entered
    in the configuration ([Figure 4-2](../Text/ch04.html#the_order_of_tests_performed_after_a
    "Figure 4-2. The order of tests performed after a service failure")). With the
    **`parents`** host parameter, the administrator has a means available to provide
    Nagios with information on the network topology.
  prefs: []
  type: TYPE_NORMAL
- en: '![The order of tests performed after a service failure](../Images/tagoreillycom20081104nostarchimages223800.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 4-2. The order of tests performed after a service failure
  prefs: []
  type: TYPE_NORMAL
- en: 'When doing this, the administrator only enters the direct neighbor computer
    for each host on the same path to the Nagios server as the parent.^([[42](#ftn.CHP-4-FN-2)])
    Hosts that are allocated in the same network segment as the Nagios server itself
    are defined without a parent. For the network topology from [Figure 4-1](../Text/ch04.html#topology_of_an_example_network
    "Figure 4-1. Topology of an example network"), the corresponding configuration
    (reduced to the host name and parent) appears as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: '**`switch1`** is located in the same network segment as the Nagios server,
    so it is therefore not allocated a parent computer. What belongs to a network
    segment is a matter of opinion. If you interpret the switches as the segment limit,
    as is the case here, this has the advantage of being able to more closely isolate
    a disruption. But you can also take a different view and interpret an IP subnetwork
    as a segment. Then a router would form the segment limit; in our example, **`proxy`**
    would then count in the same network as the Nagios server. However, it would no
    longer be possible to distinguish between a failure of **`proxy`** and a failure
    of **`switch1`** or **`switch2`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '![Classification of individual network nodes by Nagios](../Images/tagoreillycom20081104nostarchimages223802.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 4-3. Classification of individual network nodes by Nagios
  prefs: []
  type: TYPE_NORMAL
- en: If **`switch1`** in the example fails, [Figure 4-3](../Text/ch04.html#classification_of_individual_network_no
    "Figure 4-3. Classification of individual network nodes by Nagios") shows the
    sequence in which Nagios proceeds. First the system checks the DNS service on
    **`proxy`** and determines that this service is no longer reachable (1). To differentiate,
    it now performs a host check to determine the state of the **`proxy`** computer
    (2). Since **`proxy`** cannot be reached, but it has **`switch2`** as a parent,
    Nagios performs a host check on **`switch2`** (3). If this switch also cannot
    be reached, the system checks its parent, **`switch1`** (4).
  prefs: []
  type: TYPE_NORMAL
- en: 'If Nagios can establish contact with **`switch1`**, the cause for the failure
    of the DNS service on **`proxy`** can be isolated to **`switch2`**. The system
    accordingly specifies the states of the host: **`switch1`** is UP, **`switch2`**
    DOWN; **`proxy`**, on the other hand, is UNREACHABLE. Through a suitable configuration
    of the Nagios messaging system (see [12.3 The Message Filter](../Text/ch12s03.html
    "12.3 The Message Filter") in page 267) you can use this distinction to determine,
    for example, that the administrator is informed only about the host that is in
    the DOWN state and represents the actual problem, but not about the hosts that
    are dependent on the down host.'
  prefs: []
  type: TYPE_NORMAL
- en: In a further step, Nagios can determine other topology-specific failures in
    the network (so-called *network outages*). **`proxy`** is the parent of **`gate`**,
    so **`gate`** is also represented as UNREACHABLE (5). **`gate`** in turn functions
    as a parent; the Internet server dependent on this is also classified as "UNREACHABLE."
  prefs: []
  type: TYPE_NORMAL
- en: This "intelligence," which distinguishes Nagios, helps the administrator all
    the more when more hosts and services are dependent on a failed component. For
    a router in the backbone, on which hundreds of hosts and services are dependent,
    the system informs administrators of the specific disruption, instead of sending
    them hundreds of error messages that are not wrong in principle, but are not really
    of any help in trying to eliminate the disruption.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[41](#CHP-4-FN-1)]) [4.2 On-Demand Host Checks vs. Periodic Reachability
    Tests](../Text/ch04s02.html "4.2 On-Demand Host Checks vs. Periodic Reachability
    Tests") from page 95 deals with these *on-demand checks*
  prefs: []
  type: TYPE_NORMAL
- en: ^([[42](#CHP-4-FN-2)]) The parameter name **`parents`** can be explained by
    the fact that there are scenarios— such as in high availability environments—in
    which a host has two upstream routers that guarantee the Internet connection,
    for example.
  prefs: []
  type: TYPE_NORMAL
- en: 4.2 On-Demand Host Checks vs. Periodic Reachability Tests
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'As a matter of principle, Nagios performs service checks at regular intervals,
    with the exception of passive service checks. (See [13.2 Passive Service Checks](../Text/ch13s02.html
    "13.2 Passive Service Checks") in page 293.) Some slightly different rules apply
    for host checks, which play the main role. Nagios executes host checks when it
    needs them—that is, *on demand*—and uses them to monitor hosts where a service
    installed on them changes to an error state or hosts that lie in topological dependency
    to a failed host. A third way is via host dependencies, as described in [12.6.2
    Only in exceptional cases: host dependencies](../Text/ch12s06.html#only_in_exceptional_cases_colon_host_de
    "12.6.2 Only in exceptional cases: host dependencies") in page 289\. On-demand
    host checks are a core function of Nagios, as this is the only way the system
    can precisely inform the administrator about a failed central switch, instead
    of bombarding him with thousands of error messages about unreachable services.'
  prefs: []
  type: TYPE_NORMAL
- en: Planned host checks at regular intervals—*active host checks* in Nagios terminology
    —play only a minor role. Although Nagios 2.0 does provide a way to do this, Nagios
    2.x only performs active host checks serially, which is considered to be a real
    performance killer.
  prefs: []
  type: TYPE_NORMAL
- en: In Nagios 3.0, checks are executed simultaneously, eliminating the drop in performance
    of earlier versions. If a Nagios version prior to 3.0 is used, you would be well
    advised not to use active host checks. However, in Nagios 3.0 regular host checks
    like these can help to improve performance, because this version caches the check
    results, if required, for a time that can be specified. Instead of running an
    on-demand check, Nagios then reverts to the cached result, saving considerable
    time—provided that this is still sufficiently up-to-date. The new logic for host
    checks in Nagios 3.0 is dealt with in [H.7 A New Logic for Host Checks](../Text/aphs07.html
    "H.7 A New Logic for Host Checks") in page 689.
  prefs: []
  type: TYPE_NORMAL
- en: The reachability of a host can also be regularly be checked in Nagios 2.x by
    using a trick in the shape of a ping-based service check (see [6.2 Reachability
    Test with Ping](../Text/ch06s02.html "6.2 Reachability Test with Ping") in page
    108). Nagios performs service checks in parallel, so the serial brake in performance
    under Nagios 2.x is released. At the same time you will obtain further information
    such as the response times or possible packet losses, which provides indirect
    clues about the network load or possible network problems. A host check, on the
    other hand, also issues an OK even if many packets go missing and the network
    performance is catastrophic. What is involved here, as the name "host check" implies,
    is only reachability in principle and not the quality of the connection.
  prefs: []
  type: TYPE_NORMAL
- en: 4.3 States of Hosts and Services
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Nagios uses plugins for the host and service checks. They provide four different
    return values (see [Table 6-1](../Text/ch06.html#return_values_for_nagios_plugins
    "Table 6-1. Return values for Nagios plugins") in page 105): **`0`** (OK), **`1`**
    (WARNING), **`2`** (CRITICAL), and **`3`** (UNKNOWN).'
  prefs: []
  type: TYPE_NORMAL
- en: The return value UNKNOWN means that the running of the plugin generally went
    wrong, perhaps because of wrong parameters. You can normally specify the situations
    in which the plugin issues a warning or a critical state when it is started.
  prefs: []
  type: TYPE_NORMAL
- en: 'Nagios determines the states of services and hosts from the return values of
    the plugin. The states for services are the same as the return values OK, WARNING,
    CRITICAL, and UNKNOWN. For the hosts the picture is slightly different: the UP
    state describes a reachable host, DOWN means that the computer is down, and UNREACHABLE
    refers to the state of nonreachability, where Nagios cannot test whether the host
    is available or not, because a parent is down (see [4.1 Taking into Account the
    Network Topology](../Text/ch04.html#taking_into_account_the_network_topology "4.1
    Taking into Account the Network Topology"), page 92).'
  prefs: []
  type: TYPE_NORMAL
- en: 'In addition to this, Nagios makes a distinction between two types of state:
    soft state and hard state. If a problem occurs for the first time (that is, if
    there was nothing wrong with the state of a service until now), then the program
    categorizes the new state initially as a soft state and repeats the test several
    times. It may be the case that the error state was just a one-off event that was
    eliminated a short while later. Only if the error continues to exist after multiple
    tests is it then categorized by Nagios as a hard state. Administrators are informed
    only of hard states, because messages involving short-term disruptions that disappear
    again immediately afterwards only add to an unnecessary flood of information.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In our example the chronological sequence of states of a service can be illustrated
    quite simply. A service with the following parameters is used for this purpose:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: '**`normal_check_interval`** specifies at what interval Nagios should check
    the corresponding service as long as the state is OK or if a hard state exists—in
    this case, every five minutes. **`retry_check_interval`** defines the interval
    between two service checks during a soft state—one minute in the example. If a
    new error occurs, then Nagios will take a closer look at the service at shorter
    intervals.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`max_check_attempts`** determines how often the service check is to be repeated
    after an error has first occurred. If **`max_check_attempts`** has been reached
    and if the error state continues, Nagios inspects the service again at the intervals
    specified in **`normal_check_interval`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '[Figure 4-4](../Text/ch04s03.html#example_of_the_chronological_progressio "Figure 4-4. Example
    of the chronological progression of states in a monitored service") represents
    the chronological progression in graphic form. The illustration begins with an
    OK state (which is always a hard state). Normally Nagios will repeat the service
    check at five-minute intervals. After ten minutes an error occurs; the state changes
    to CRITICAL, but this is initially a soft state. At this point in time, Nagios
    has not yet issued any message.'
  prefs: []
  type: TYPE_NORMAL
- en: Now the system checks the service at intervals specified in **`retry_check_interval`**.
    Here this is every minute. After a total of five checks (as specified in **`max_check_attempts`**)
    with the same result, the state changes from soft to hard. Only now does Nagios
    inform the relevant people. The tests are now repeated at the intervals specified
    in **`normal_check_interval`**.
  prefs: []
  type: TYPE_NORMAL
- en: '![Example of the chronological progression of states in a monitored service](../Images/tagoreillycom20081104nostarchimages223804.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 4-4. Example of the chronological progression of states in a monitored
    service
  prefs: []
  type: TYPE_NORMAL
- en: In the next test the service is again available; thus its state changes from
    CRITICAL to OK. Since an OK state is always a hard state, this change is not subject
    to any tests by Nagios at shorter intervals.
  prefs: []
  type: TYPE_NORMAL
- en: The transition of the service to the OK state after an error in the hard state
    is referred to as a *hard recovery*. The system informs the administrators of
    this (if it is configured to do so) as well as of the change between various error-connected
    hard states (such as from WARNING to UNKNOWN). If the service recovers from an
    error soft state to the normal state (OK)—also called a *soft recovery*—the administrators
    will not be notified.
  prefs: []
  type: TYPE_NORMAL
- en: Even if the messaging system leaves out soft states and switches back to soft
    states, it will still record such states in the Web interface and in the log files.
    In the Web front end, soft states can be identified by the fact that the value
    **`2/5`** is listed in the column **Attempts**, for example. This means that **`max_check_attempts`**
    expects **`five`** attempts, but only two have been carried out until now. With
    a hard state, **`max_check_attempts`** is listed twice at the corresponding position,
    which in the example is **`5/5`**.
  prefs: []
  type: TYPE_NORMAL
- en: More important for the administrator in the Web interface than the distinction
    of whether the state is still "soft" or already "hard," is the duration of the
    error state in the column **Duration**. From this a better judgment can be made
    of how large the overall problem may be.
  prefs: []
  type: TYPE_NORMAL
- en: 'For services that are not available because the host is down, the entry 1/5
    in the column **Attempts** would appear, since Nagios does not repeat service
    checks until the entire host is reachable again. The failure of a computer can
    be more easily recognized by its color in the Web interface: the service overview
    figure in [3.3 Overview of the Web Interface](../Text/ch03s03.html "3.3 Overview
    of the Web Interface") marks the failed host in red; if the computer is reachable,
    the background remains gray.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[43](#CHP-4-FN-3)]) As an alternative, Nagios 3.0 allows the notation known
    from the host definition, **`check_interval`**.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[44](#CHP-4-FN-4)]) For Nagios 3.0 you can alternatively use **`retry_interval`**.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 5. Service Checks and How They Are Performed
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To test services, Nagios makes use of external programs called *plugins*. In
    the simplest case this involves testing an Internet service, for example, SMTP.
    Here the service can be addressed directly over the network, so it is sufficient
    to call a program locally on the Nagios server that tests the mail server on the
    remote host.
  prefs: []
  type: TYPE_NORMAL
- en: Not everything you might want to test can be reached so easily over the network,
    however; there is no network protocol for checking free capacity on a hard drive,
    for example. Then you must either start a plugin on the remote host via a remote
    shell (but first this has to be installed on the remote computer), or you use
    other methods, such as the *Simple Network Management Protocol (SNMP)*, to test
    the hard drive capacity.
  prefs: []
  type: TYPE_NORMAL
- en: The fact that different methods are available here does not make it any easier
    to get started with Nagios. For this reason, this chapter provides an overview
    of the common methods and attempts to develop an understanding of the underlying
    concepts involved. Later chapters then provide detailed configuration examples.
  prefs: []
  type: TYPE_NORMAL
- en: '![Nagios allows different testing methods.](../Images/tagoreillycom20081104nostarchimages223806.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 5-1. Nagios allows different testing methods.
  prefs: []
  type: TYPE_NORMAL
- en: '[Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods "Figure 5-1. Nagios
    allows different testing methods.") shows an overview of the various test methods
    supported by Nagios. The upper box with a gray background marks all the components
    that run directly on the Nagios server machine: this includes the server itself,
    as well as plugins and other auxiliary tools. This unit is in contact with five
    clients, which are tested in various ways. The following sections will go into
    somewhat more detail regarding the individual methods.'
  prefs: []
  type: TYPE_NORMAL
- en: In order to monitor the network service on the first client (starting from the
    left) marked as **`service`**, the Nagios server runs its "own" plugin, **`check_xyz`**
    ([5.1 Testing Network Services Directly](../Text/ch05.html#testing_network_services_directly
    "5.1 Testing Network Services Directly"), page 101). For the second client it
    starts the "middle plugin" **`check_by_ssh`**, in order to execute the plugin
    it really wants remotely on the client ([5.2 Running Plugins via Secure Shell
    on the Remote Computer](../Text/ch05s02.html "5.2 Running Plugins via Secure Shell
    on the Remote Computer"), page 102).
  prefs: []
  type: TYPE_NORMAL
- en: In the third case the plugin is also executed directly on the client machine,
    but now Nagios uses the NRPE service, created specifically for this purpose. The
    query is made on the Nagios side with **`check_nrpe`** ([5.3 The Nagios Remote
    Plugin Executor](../Text/ch05s03.html "5.3 The Nagios Remote Plugin Executor"),
    page 102).
  prefs: []
  type: TYPE_NORMAL
- en: The fourth method performs a query via SNMP. For this, the client must have
    an SNMP agent available ([11.1 Introduction to SNMP](../Text/ch11.html#introduction_to_snmp
    "11.1 Introduction to SNMP"), page 228). Various plugins are available for querying
    data via SNMP ([5.4 Monitoring via SNMP](../Text/ch05s04.html "5.4 Monitoring
    via SNMP"), page 103).
  prefs: []
  type: TYPE_NORMAL
- en: These four methods represent "active" checks, because Nagios takes the initiative
    and triggers the test itself. The fifth method, in contrast, is passive. Here
    Nagios does nothing actively, but waits for incoming information that the client
    sends to the Nagios server with the program **`send_nsca`**. On the Nagios server
    itself the *Nagios Service Check Acceptor*, NSCA, is running as a daemon that
    accepts the transmitted results and forwards them to the interface for external
    commands (see [5.5 The Nagios Service Check Acceptor](../Text/ch05s05.html "5.5
    The Nagios Service Check Acceptor"), page 104).
  prefs: []
  type: TYPE_NORMAL
- en: There are other ways of performing checks in addition to these. Usually a separate
    service is installed on the client, which is then queried by the Nagios server
    via a specialized plugin. A typical example here is NSClient/NC_Net, which can
    be used to monitor Windows servers ([20.2.1 NSClient](../Text/ch20s02.html#nsclient
    "20.2.1 NSClient"), page 464).
  prefs: []
  type: TYPE_NORMAL
- en: 5.1 Testing Network Services Directly
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Mail or Web servers can be tested very simply over the network, since the underlying
    protocols, SMTP and HTTP, are by definition network-capable ([Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "Figure 5-1. Nagios allows different testing methods."), page 100, Client 1).
    Nagios can call here on a wide range of plugins, each specialized for a particular
    service.
  prefs: []
  type: TYPE_NORMAL
- en: Such a specific program has advantages over a generic one. A generic plugin
    tests only whether the corresponding TCP or UDP port is open and whether the service
    is waiting there, but it does not determine whether the correct service is on
    the port, or whether it is active.
  prefs: []
  type: TYPE_NORMAL
- en: 'Specific plugins adopt the network protocol and test whether the service on
    the port in question behaves as it is expected to. A mail server, for example,
    normally responds with a so-called *Greeting* after a connection has been established:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: The important thing here is the number **`220`**. A number in the 200 range
    means OK, 220 stands for the greeting. The **`check_smtp`** plugin evaluates this
    reply. It can also simulate the initial dialog when sending mail (in addition
    to the greeting), as shown in [6.3 Monitoring Mail Servers](../Text/ch06s03.html
    "6.3 Monitoring Mail Servers") in page 113.
  prefs: []
  type: TYPE_NORMAL
- en: It behaves in a similar way with other specific plugins, such as **`check_http`**,
    which not only can handle a simple HTTP dialog, but also manipulates HTTP headers
    where required, checks SSL capabilities and certificates of the Web server, and
    even sends data to the server with the **`POST`** command (more on this in [6.4
    Monitoring FTP and Web Servers](../Text/ch06s04.html "6.4 Monitoring FTP and Web
    Servers") from page 118).
  prefs: []
  type: TYPE_NORMAL
- en: The package with the Nagios plugins, which is installed separately (see [1.4
    Installing and Testing Plugins](../Text/ch01s04.html "1.4 Installing and Testing
    Plugins") from page 43), includes specific plugins for the most important network
    services. If one is missing for a specific service, it is worth taking a look
    at the Nagios homepage^([[45](#ftn.CHP-5-FN-1)]) or the Exchange for Nagios Add-ons.^([[46](#ftn.CHP-5-FN-2)])
  prefs: []
  type: TYPE_NORMAL
- en: If no suitable plugin can be found in these locations, you can use the generic
    plugins **`check_tcp`** or **`check_udp`**, which apart from performing a pure
    port test, also send data to the target port and evaluate the response. (In most
    cases, this only makes sense if an ASCII-based protocol is involved.) More on
    generic plugins in [6.7.1 Testing TCP ports](../Text/ch06s09.html#testing_tcp_ports
    "6.7.1 Testing TCP ports") in page 132.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[45](#CHP-5-FN-1)]) [http://www.nagios.org/](http://www.nagios.org/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[46](#CHP-5-FN-2)]) [http://www.nagiosexchange.org/](http://www.nagiosexchange.org/)
  prefs: []
  type: TYPE_NORMAL
- en: 5.2 Running Plugins via Secure Shell on the Remote Computer
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To test local resources such as hard drive capacity, the load on the swap area,
    the current CPU load, or whether a specific process is running, various *local
    plugins* are available. They are called "local" because they have to be installed
    on the computer that is to be checked.
  prefs: []
  type: TYPE_NORMAL
- en: The Nagios server has no way to directly access such information over the network,
    without taking further measures. However, it can start local plugins on the remote
    host via a remote shell ([Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "Figure 5-1. Nagios allows different testing methods."), page 100, Client 2).
    Only the *Secure Shell*, SSH, should be considered for use here; the *Remote Shell*,
    RSH, simply has too many security holes.
  prefs: []
  type: TYPE_NORMAL
- en: To do this, the Nagios server runs the program **`check_by_ssh`**, which is
    given the command, as an argument, to run the local plugin on the target host.
    For this, **`check_by_ssh`** needs a way of logging into the target host without
    a password, which can be set up with *Public Key Authentication*.
  prefs: []
  type: TYPE_NORMAL
- en: From the viewpoint of the Nagios server, **`check_by_ssh`** is the plugin whose
    results are processed. It does not notice anything concerning the start of the
    secure shell connection and of the remote plugin—the main thing is that the reply
    corresponds to the Nagios standard and contains the status plus a line of comment
    text for the administrator. (See the introduction to [Chapter 6](../Text/ch06.html
    "Chapter 6. Plugins for Network Services") in page 105.)
  prefs: []
  type: TYPE_NORMAL
- en: Further information on the *Remote Execution* of plugins via Secure Shell is
    provided in [Chapter 9](../Text/ch09.html "Chapter 9. Executing Plugins via SSH")
    in page 205.
  prefs: []
  type: TYPE_NORMAL
- en: 5.3 The Nagios Remote Plugin Executor
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: An alternative method of running plugins installed on the target computer via
    the secure shell is represented by the *Nagios Remote Plugin Executor* (NRPE).
    [Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods "Figure 5-1. Nagios
    allows different testing methods.") (page 100) illustrates this with the middle
    client.
  prefs: []
  type: TYPE_NORMAL
- en: The NRPE is installed on the target host and started via the inet daemon, which
    must be configured accordingly. If NRPE receives a query from the Nagios server
    via the (selectable) TCP port 5666, it will run the matching query for this. As
    with the method using the Secure Shell, the plugin that is to perform the test
    must be installed on the target host.
  prefs: []
  type: TYPE_NORMAL
- en: So all of this is somewhat more work than using the Secure Shell, especially
    as SSH should be installed on almost every Unix machine, and when it is used,
    enables monitoring to be configured centrally on the Nagios server. The Secure
    Shell method requires an account with a local shell, however, thus enabling any
    command to be run on the target host.^([[47](#ftn.CHP-5-FN-3)]) The Remote Plugin
    Executor, on the other hand, is restricted to the commands configured.
  prefs: []
  type: TYPE_NORMAL
- en: If you don't want the user **`nagios`** to be able to do anything more than
    run plugins on the target host without a password, than you are better off sticking
    with NRPE. The installation configuration for this is described in [Chapter 10](../Text/ch10.html
    "Chapter 10. The Nagios Remote Plugin Executor (NRPE)") in page 213.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[47](#CHP-5-FN-3)]) The Secure Shell does allow a single command to be executed
    without opening a separate shell. Usually, however, you will want to test several
    resources, so you'll need to run more than one command.
  prefs: []
  type: TYPE_NORMAL
- en: 5.4 Monitoring via SNMP
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: With the *Simple Network Management Protocol*, SNMP, local resources can be
    queried over the network (see also Client 4 in [Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "Figure 5-1. Nagios allows different testing methods."), page 100). If an SNMP
    daemon is installed (NET-SNMPD is used extensively and is described in [11.2.2
    The NET-SNMP daemon](../Text/ch11s02.html#the_net-snmp_daemon "11.2.2 The NET-SNMP
    daemon") in page 238), Nagios can use it to query local resources such as processes,
    hard drive, and interface load.
  prefs: []
  type: TYPE_NORMAL
- en: The advantage of SNMP lies in the fact that it is widely used. There are corresponding
    services for both UNIX and Windows systems, and almost all modern network components
    such as routers and switches can be queried via SNMP. Even uninterruptable power
    supplies (UPSs) and other equipment sometimes have a network connection and can
    provide current status information via SNMP.
  prefs: []
  type: TYPE_NORMAL
- en: Apart from the standard plugin **`check_snmp`**, a generic SNMP plugin, there
    are various specialized plugins that concentrate on specific SNMP queries but
    are sometimes more simple to use. **`check_ifstatus`** and **`check_if-operstatus`**,
    for example, focus on the status of network interfaces.
  prefs: []
  type: TYPE_NORMAL
- en: If you are grappling with SNMP for the first time, you will soon come to realize
    that the phrase "human-readable" did not seem to be high on the list of priorities
    when the protocol was defined. SNMP queries are optimized for machine processing,
    such as for a network monitoring tool.
  prefs: []
  type: TYPE_NORMAL
- en: If you use the tool available from the vendor for its network components, SNMP
    will basically remain hidden to the user. But to use it with Nagios, you have
    to get your hands dirty and get involved with the protocol and its underlying
    syntax. It takes some getting used to, but it's not really as difficult as it
    seems at first sight.
  prefs: []
  type: TYPE_NORMAL
- en: The use of SNMP is the subject of [Chapter 11](../Text/ch11.html "Chapter 11. Collecting
    Information Relevant for Monitoring with SNMP") (page 227); there you can learn
    how to configure and use an SNMP daemon for Linux and other UNIX systems.
  prefs: []
  type: TYPE_NORMAL
- en: 5.5 The Nagios Service Check Acceptor
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The fifth method of processing the results of service checks leads to the use
    of the *Nagios Service Check Acceptor*, NSCA. This runs as a daemon on the Nagios
    server and waits for incoming test results (see [Figure 5-1](../Text/ch05.html#nagios_allows_different_testing_methods
    "Figure 5-1. Nagios allows different testing methods.") in the right in [Chapter 5](../Text/ch05.html
    "Chapter 5. Service Checks and How They Are Performed")). This method is referred
    to as *passive*, because Nagios itself does not take the initiative.
  prefs: []
  type: TYPE_NORMAL
- en: NSCA uses the interface for external commands used by CGI scripts, among others,
    to send commands to Nagios. It consists of a *named pipe*^([[48](#ftn.CHP-5-FN-4)])
    from which Nagios reads the external commands. With the command **`PROCESS_SERVICE_CHECK_RESULT`**
    Nagios processes test results that were determined elsewhere. The interface itself
    is described in more detail in [13.1 The Interface for External Commands](../Text/ch13.html#the_interface_for_external_commands
    "13.1 The Interface for External Commands") in page 292.
  prefs: []
  type: TYPE_NORMAL
- en: The main use for NSCA is *Distributed Monitoring*. By this we mean having several
    different Nagios installations that send their results to a central Nagios server.
    The distributed Nagios servers, perhaps in different branches of a company, work
    as autonomous and independent Nagios instances, except that they also send the
    results to a head office. This does not check the decentralized networks actively,
    but processes the information sent from the branches in a purely passive manner.
  prefs: []
  type: TYPE_NORMAL
- en: NSCA is not just restricted to distributed monitoring, however. With the program
    **`send_nsca`**, test results can be sent which were not obtained from a Nagios
    instance, but rather from a cron job, for example, which executes the desired
    service check.
  prefs: []
  type: TYPE_NORMAL
- en: Before you use NSCA, you should consider the security aspects. Because it can
    be used by external programs to send information and commands to Nagios, there
    is a danger that it could be misused. This should not stop you from using NSCA,
    but rather should motivate you into paying attention to security aspects during
    the NSCA configuration.
  prefs: []
  type: TYPE_NORMAL
- en: Further information on using NSCA, distributed monitoring and on security in
    general is provided in [Chapter 14](../Text/ch14.html "Chapter 14. The Nagios
    Service Check Acceptor (NSCA)") in page 299.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[48](#CHP-5-FN-4)]) A named pipe is a buffer to which a process writes something
    and from which another process reads out the data. This buffer is given a name
    in the file system so that it can be specifically addressed, which is why it is
    called *named* pipe.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 6. Plugins for Network Services
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Every plugin that is used for host and service checks is a separate and independent
    program that can also be used independently of Nagios. The other way round, it
    is not so easy: in order for Nagios to use an external program, it must obey certain
    rules. The most important of these concerns the return status that is returned
    by the program. Using this, Nagios precisely evaluates the status. [Table 6-1](../Text/ch06.html#return_values_for_nagios_plugins
    "Table 6-1. Return values for Nagios plugins") displays the possible values.'
  prefs: []
  type: TYPE_NORMAL
- en: Table 6-1. Return values for Nagios plugins
  prefs: []
  type: TYPE_NORMAL
- en: '| Status | Name | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| 0 | OK | Everything in order |'
  prefs: []
  type: TYPE_TB
- en: '| 1 | WARNING | Warning limit has been exceeded, but critical limit not yet
    reached |'
  prefs: []
  type: TYPE_TB
- en: '| 2 | CRITICAL | Critical limit exceeded or the plugin has broken off the test
    after a timeout |'
  prefs: []
  type: TYPE_TB
- en: '| 3 | UNKNOWN | Error has occurred inside the plugin (the wrong parameter has
    been used, for example) |'
  prefs: []
  type: TYPE_TB
- en: A plugin therefore does not distinguish by using the pattern "OK—Not OK," but
    instead is more highly differentiated. In order for it to be able to categorize
    a status as WARNING, it requires details of up to what measured value a certain
    event is regarded as OK, when it is seen as a WARNING, and when it is CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: For example, apart from the response time, a ping also returns the rate of packet
    loss. For a slow network connection (ISDN, DSL), a response time of 1000 milliseconds
    could be seen as a warning limit and 5000 milliseconds as critical, because that
    would mean that interactive working is no longer possible. If there is a high
    load on the network connection, occasional packet loss could also occur,^([[49](#ftn.CHP-6-FN-1)])
    so that 20 percent packet loss can be specified as a warning limit and 60 percent
    as the critical limit.
  prefs: []
  type: TYPE_NORMAL
- en: In all cases, the administrator decides what values shall serve as warning signs
    or be regarded as critical. Since all services can be individually configured,
    the values for each host may vary, even in the same plugin.
  prefs: []
  type: TYPE_NORMAL
- en: Plugins always have a *timeout*, which is usually ten seconds. This prevents
    the program from waiting endlessly, thus stopping a large number of plugin processes
    from accumulating at the Nagios host. In other ways too, a response time above
    10 seconds makes little sense for many applications, since these interrupt connection
    attempts themselves after a certain time span, which has the same effect as the
    total failure of the corresponding service. Here the administrator can step in
    and explicitly specify a different timeout.
  prefs: []
  type: TYPE_NORMAL
- en: 'A further characteristic of all plugins is a text output, which Nagios shows
    in its overview. It is principally intended for the administrator, so it needs
    to be "human-readable." Nagios 2.x processes only the first line, and here the
    output may not exceed 300 characters. Nagios since version 3.0 no longer has this
    restriction. The output may have multiple lines and can be up to 8KB in length
    (see [8.5.1 Multiple-line plugin output](../Text/ch08s05.html#multiple-line_plugin_output
    "8.5.1 Multiple-line plugin output"), page 193). In the Web interface, however,
    Nagios 3.0 also displays only the first line. Simple plugins should therefore
    restrict their output to a single line, the multiple-line output is recommended
    only for special applications such as the **`plugin check_multi`** ([8.5 Summarizing
    Checks with check_multi](../Text/ch08s05.html "8.5 Summarizing Checks with check_multi")
    from page 191). The following form has become established for the text output:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'In practice, the text output looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: The above examples are from the plugin **`check_smtp`** and **`check_disk`**,
    respectively. In both cases, the type of check (here **`SMTP`** or **`DISK`**)
    is followed by the status in text form and then the actual information. Not all
    plugins adhere to this recommendation in their output. Sometimes the detail of
    the test type is missing, and sometimes even the status is missing.
  prefs: []
  type: TYPE_NORMAL
- en: 'Various plugins also provide performance information, which can be evaluated
    and graphically represented with external programs (see [Chapter 19](../Text/ch19.html
    "Chapter 19. Graphic Display of Performance Data"), page 403):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: As can be seen here from the example of the **`check_icmp`** plugin, the performance
    data follows the text output, separated by the pipe character **`|`**. These data
    do not appear in the Web interface.
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_icmp`** here provides two values: the medium reply time, **``*`r`*``****`ta`**
    (*Real Time Answer*), in milliseconds and the packet loss rate, **`pl`**.^([[50](#ftn.CHP-6-FN-2)])
    For each variable, the plugin first displays the measured value (**`97.751`**
    ms and **`0%`**), followed by the warning limit (200 milliseconds or 40 percent)
    and the critical limit (500 milliseconds or 80 percent). The fact that only the
    first value in the **``*`r`*``****`ta`** or **`pl`** list is provided with a scale
    unit is specified by the Developer Guidelines—since the unit of a variable does
    not change, it only needs to be given once.'
  prefs: []
  type: TYPE_NORMAL
- en: To keep the installation ([1.4 Installing and Testing Plugins](../Text/ch01s04.html
    "1.4 Installing and Testing Plugins") from page 43) as simple as possible, there
    are no manual pages for the plugins. Each of these programs must maintain an online
    help, which is displayed with the option **`-h`** or **`--help`**. Some plugins
    distinguish here between a short help (**`-h`**) and a long one (**`--help`**);
    it is therefore recommended that you always try **`--help`** as well.
  prefs: []
  type: TYPE_NORMAL
- en: This chapter introduces the most important plugins from the basic distribution
    of the **`nagios-plugins`** package, version 1.4.11,^([[51](#ftn.CHP-6-FN-3)])
    which test network services. With their help, the Nagios server queries services
    on other servers. The description is restricted to the functionality that is important
    for normal operation. If you are interested in all the options, we refer you to
    the integrated online help.
  prefs: []
  type: TYPE_NORMAL
- en: 6.1 Standard Options
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '[Table 6-2](../Text/ch06.html#standard_options_of_plugins "Table 6-2. Standard
    options of plugins") lists the options that are common to all plugins. The options
    in bold type must be known to all plugins. The key words not in bold type can
    be omitted by the programs, but if they are supported at all, they must be used
    in the sense specified.'
  prefs: []
  type: TYPE_NORMAL
- en: If an option demands an argument, it is usually separated by spaces in the short
    form, but by equals signs in the long form. But for Perl or shell scripts in particular,
    not all authors adhere to these, so you have no option here but to take a look
    at the corresponding description.
  prefs: []
  type: TYPE_NORMAL
- en: Table 6-2. Standard options of plugins
  prefs: []
  type: TYPE_NORMAL
- en: '| Short form | Long form | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| ^([[a](#ftn.CHP-6-TFN-4)]) |'
  prefs: []
  type: TYPE_TB
- en: '| **`-h`** | **`--help`** | Output of the online help |'
  prefs: []
  type: TYPE_TB
- en: '| **`-V`** | **`--version`** | Output of the plugin version |'
  prefs: []
  type: TYPE_TB
- en: '| **`-v`** | **`--verbose`** | Output of additional information-this option
    may be given multiple times^([[a](../Text/ch06.html#ftn.CHP-6-TFN-4)]) |'
  prefs: []
  type: TYPE_TB
- en: '| **`-H`** | **`--hostname`** | Host name or IP address of the target |'
  prefs: []
  type: TYPE_TB
- en: '| **`-t`** | **`--timeout`** | Timeout in seconds after which the plugin will
    interrupt the operation and return the CRITICAL status |'
  prefs: []
  type: TYPE_TB
- en: '| **`-w`** | **`--warning`** | Specificies the warning limit value |'
  prefs: []
  type: TYPE_TB
- en: '| **`-c`** | **`--critical`** | Specifies the critical limit value |'
  prefs: []
  type: TYPE_TB
- en: '| **`−4`** | **`--use-ipv4`** | Force IPv4 to be used |'
  prefs: []
  type: TYPE_TB
- en: '| **`−6`** | **`--use-ipv6`** | Force IPv6 to be used |'
  prefs: []
  type: TYPE_TB
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[a](#CHP-6-TFN-4)]) Whether this leads to more information depends on the
    individual plugin ...
  prefs: []
  type: TYPE_NORMAL
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: Thus it is not allowed to use **`-c`**, for example, for anything other than
    specifying a critical limit. How exactly **`-c`** and **-w** are used may, on
    the other hand, vary from plugin to plugin, because sometimes an individual value
    may be required, at other times, multiple values (see also the explanations on
    the plugin **`check_icmp`**), described below.
  prefs: []
  type: TYPE_NORMAL
- en: Most plugins also have the options **`−4`** and **`−6`**, which was not necessarily
    the case prior to version 1.4.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[49](#CHP-6-FN-1)]) ICMP packets are not re-sent; a lost packet remains lost.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[50](#CHP-6-FN-2)]) Short for *packet loss*.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[51](#CHP-6-FN-3)]) Versions prior to 1.4 should no longer be used. Some
    parameters have changed, and often performance data output is missing. In addition,
    plugin developers make great efforts to clean up existing errors and to continually
    improve the plugins.
  prefs: []
  type: TYPE_NORMAL
- en: 6.2 Reachability Test with Ping
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The classic reachability test in UNIX systems has always been a ping, which
    sends an ICMP echo request packet and waits for an ICMP echo response packet.
    The Nagios plugin package includes two programs that carry out this ping check:
    **`check_icmp`** and **`check_ping`**. Even though **`check_ping`** is used in
    the standard configuration, you should replace it with the more efficient **`check_icmp`**,
    which has been included since plugin version 1.4.'
  prefs: []
  type: TYPE_NORMAL
- en: Whereas **`check_ping`** calls the UNIX program **`/bin/ping`**, which is why
    there are always compatibility problems with the existing **`ping`** version,
    **`check_icmp`** sends ICMP without any external help programs. **`check_icmp`**
    basically works more efficiently, since it does not wait for one second between
    individual packets, as **`ping`** does. In addition it evaluates ICMP error messages
    such as **`ICMP host unreachable`**, while **`check_ping`** discards these. **`check_icmp`**
    is backward-compatible to **`check_ping`**; this makes it easy to do without **`check_ping`**
    entirely and to replace it with **`check_icmp`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_icmp`** measures the reply time of the ICMP packets and determines
    the proportion of packets that have been lost. If an error message arrives instead
    of the expected **`ICMP echo reply`**, this is evaluated immediately. Thus Nagios
    breaks off the test if an **`ICMP host unreachable`** message arrives.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_icmp`** has the following options:^([[52](#ftn.CHP-6-FN-5)])'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Without the host name or the IP address of the computer to be tested, **`check_icmp`**
    cannot work. With **`-H`**, multiple **``*`host`*``** entries can be separated,
    using spaces.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`response_time,packet_loss_percent%`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch sets the warning limit for a warning. **``*`response time`*``**
    stands here for the desired response time in milliseconds, **``*`packet loss percent`*``**
    stands for the corresponding packet loss as a percentage. If you specify **`-w
    500.0,20%`** the plugin will give a warning either if the response time is at
    least 500.0 milliseconds or if 20 percent or more of ICMP packets are lost.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`response_time,packet_loss_percent%`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch specifies the critical limit in the same way as **`-w`** defines
    the warning value. The critical limit should always be larger than the warning
    limit.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-n`** **``*`packets`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: With **``*`packets`*``** you can set the number of packets that **`check_icmp`**
    should use for each test. The default is **`5`** packets.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-i`** **``*`packet_interval`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch sets the time interval between two single packets that are going
    to the same host. The default is 80 milliseconds. It is specified as a floating
    point (e.g., **`-i 80.000`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-I`** **``*`target_interval`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch sets the time interval in which packets are sent to different hosts
    (provided that **`-H`** contains more than one host). The default is **`0`** milliseconds,
    meaning that packets to multiple hosts are sent simultaneously.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-m`** **``*`number_of_reachable_hosts`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This switch specifies the number of hosts that must be reachable for the plugin
    to return OK. This option allows a simple cluster check:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: Of the three hosts specified, **`192.168.1.11`** (printed in bold) is not reachable.
    **`-m 2`** requests only two reachable hosts; therefore, the result is OK. Without
    this detail, the result would be CRITICAL, because one host is not reachable.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-l`** **``*`ttl`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: A value larger than **`0`** sets the TTL (*Time to Live*) of the IP packet.
    The default is the value **`0`**, which means that the plugin leaves the choice
    of the TTL to the operating system.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds have passed, the plugin interrupts the test
    and returns the CRITICAL status. The default is **`10`** seconds.
  prefs: []
  type: TYPE_NORMAL
- en: 'Like the program **`/bin/ping`**, **`check_icmp`** must also run with **``*`r`*``****`oot`**
    permissions, which is why the SUID bit is set:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: 'As a test, you should execute the plugin on the command line as the user **`nagios`**,
    since Nagios will later execute it under this account:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: '**`check_icmp`** then sends the standard number of five ICMP packets on their
    way. Instead of an OK, it issues a WARNING as soon as the response time, averaged
    over all the packets, is at least 100.0 milliseconds or if 20 percent or more
    are lost—that is, at least one packet in five. For a CRITICAL status, the average
    response time must be at least 200.0 milliseconds, or at least two packets (40
    percent of five) must remain unanswered.'
  prefs: []
  type: TYPE_NORMAL
- en: 6.2.1 **`check_icmp`** as a Service Check
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In order for **`check_icmp`** to be used as a service check, you need to have
    a suitable command object. The file **`checkcommands.cfg`**, with **`check_ping`**,
    already has one for the ping service. We will just replace the **`check_ping`**
    plugin in it with **`check_icmp`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: The macro **`$HOSTADDRESS$`** provides the IP address of the **`address`** parameter
    from the host definition, and with the two freely defined macros **`$ARG1$`**
    and **`$ARG2$`**, parameters can be taken over from the service definition, so
    that warning and critical limits can be set with these.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the service definition (an extract of it is shown here)^([[53](#ftn.CHP-6-FN-6)])
    for the **`PING`** service, the **`check_command`** entry, in addition to the
    name of the command object to be executed, now needs two arguments, which are
    entered after the command and separated by an exclamation mark:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: From the definition of the command object, you can see that the first parameter
    (**`100.0,20%`**) defines the warning limit, and the second one (**`500.0,60%`**)
    defines the critical value.
  prefs: []
  type: TYPE_NORMAL
- en: 6.2.2 **`check_icmp`** as a Host Check
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'To be able to use the plugin under the name **`check_host`** for host checks,
    a corresponding symbolic link to **`check_icmp`** is set:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'If it is called under its new name, **`check_host`**, the plugin modifies its
    behavior somewhat: it interrupts the test after receiving the first ICMP echo
    reply, because a single reply packet is enough to prove that the host "is alive."
    The same applies if the first response to be returned is an error message such
    as **`ICMP network unreachable`** or **`host unreachable`**—the host is then considered
    to be unreachable.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Host checks are defined like every other check. The only difference is that
    this test is specified during the definition of the host object (and not of a
    service object):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'The name used here, **`check-host-alive`**, can be freely defined and can be
    specified separately for each host. The definition of the command itself is made
    in **`checkcommands.cfg`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: Host checks do not always need to be executed with **`check_icmp`**. You could
    just as well measure the refrigerator temperature or test, with the generic plugins
    for TCP or UDP (**`check_tcp`** and **`check_udp`**; see [6.7.1 Testing TCP ports](../Text/ch06s09.html#testing_tcp_ports
    "6.7.1 Testing TCP ports") from page 132), whether a specific port is open or
    not. The port scanner **`nmap`**, for example, uses TCP port 80 (HTTP).
  prefs: []
  type: TYPE_NORMAL
- en: The disadvantage of such a method lies in the fact that, apart from the host
    itself, another application also needs to run—that is, the Web server. In addition,
    the test of a specific application by no means proves that the computer is no
    longer reachable. A ping has the great advantage that the kernel replies to ICMP
    echo request messages itself, so that no application needs to be running for this.
    You should therefore change from ping to other host check methods only if there
    is a good reason to do so. One example might be a firewall that filters ICMP messages,
    and over which the administrator has no influence, but that does let through HTTP
    queries on TCP port 80.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[52](#CHP-6-FN-5)]) The online help **`check_icmp`** -h says that it knows
    some of the options in the long form as well, but these have not been implemented
    as of today.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[53](#CHP-6-FN-6)]) Like any other object, service definitions can also be
    defined in a file of your choice, from which Nagios loads object definitions.
    For the sake of clarity it is best to choose a descriptive name for the file,
    such as **`services.cfg`**, as in our example in [Simple structure](../Text/ch02.html#simple_structure
    "Simple structure").
  prefs: []
  type: TYPE_NORMAL
- en: 6.3 Monitoring Mail Servers
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: A number of plugins are also available to monitor mail servers. The mail server
    itself (*Mail Transport Agent* (MTA)) is monitored by **`check_smtp`**, and the
    mail queue on the mail server can be checked with **`check_mailq`**. Since the
    latter test takes place locally, the plugin is described in the next chapter in
    [7.8 Regularly Checking the Status of the Mail Queue](../Text/ch07s08.html "7.8
    Regularly Checking the Status of the Mail Queue") (page 180).
  prefs: []
  type: TYPE_NORMAL
- en: To monitor the *Mail User Agent* (MUA) protocols POP3 and IMAP —including the
    SSL variants, POP3S and IMAPS—the plugin **`check_tcp`** is used. **`check_pop`**
    and so forth are symbolic links to **`check_tcp`**, which determines which protocol
    it should test by means of the name by which it is called, and makes the relevant
    presettings.
  prefs: []
  type: TYPE_NORMAL
- en: 6.3.1 Monitoring SMTP with **`check_smtp`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The SMTP monitoring plugin **`check_smtp`** has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/--host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Details the computer on which the SMTP service should be checked.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`port`*``** determines the ports, in case the mail service is not listening
    on the standard port 25\. In this way the mail virus scanner Amavis (usually port
    10024) can be monitored, for example. But this can normally be reached only from
    **`localhost`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-e`** **``*`string`*``** **`/--expect=`****``*`string`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`string`*``** defines the text which the mail server must provide in the
    very first reply line. The default setting for **``*`string`*``** is **`220`**,
    with which the normal SMTP greeting begins, but there may be servers that have
    different settings. A wrong reply from the service monitored will generate a WARNING.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-f`** **``*`address`*``** **`/--from=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: With **``*`address`*``** you specify a mail address that **`check_smtp`** then
    sends to the server with the "**`MAIL FROM:`**" command. This option is required
    to test a Microsoft Exchange 2000 Server.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`"mail command"`*``** **`/--command=`****``*`"mail command"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: With **`-C`** you can send individual mail commands to the server, to extend
    the test slightly (see example below).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-R`** **``*`"string"`*``** **`/--response=`** **``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If you send an SMTP command to the server with **`-C`**, you can specify the
    expected reply here instead of **``*`string`*``** (for example, **`250`**). A
    "wrong" reply triggers a WARNING.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-S / --starttls`**'
  prefs: []
  type: TYPE_NORMAL
- en: The connection setup during the test uses STARTTLS.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-D`** **``*`duration`*``****`/--certificate=`****``*`duration`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The minimum duration in days for which the certificate used for STARTTLS must
    still be valid.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-A / --authtype=`****``*`autheutication type`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The authentication type for the SMTP-Auth procedure. The default is **`none`**
    (no authentication). The only procedure supported until now is **`LOGIN`**, which
    is based on user-password pairs.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-U / --authuser=`****``*`user`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The user name for the SMTP authentication, if **`-A LOGIN`** is used.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-P / --authpass=`****``*`password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The accompanying password if **`-A LOGIN`** is specified.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`floating_point_dec`*``** **`/--warning=`****``*`floatii2g_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the server takes longer than **``*`floating_point_dec`*``** seconds for the
    answer, **`check_smtp`** issues a WARNING.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`floating_point_dec`*``** **`/--critical=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Like **`-w`**, except that **`check_smtp`** issues a CRITICAL after **``*`floating_point_dec`*``**
    seconds.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the simplest case, you just enter the name or the IP address of the mail
    server:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: The plugin **`check_smtp`** sends back a **`HELO`** **``*`hostname`*``** after
    receiving the SMTP greeting, which should contain the reply **`250`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'The definition of the corresponding command object in this case appears as
    follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: 'To check the host object **`linux01`** with this, it requires the following
    service definition:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: 'Using the **`-C`** option, the SMTP dialog can be extended even further, roughly
    until **`RCPT TO`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: 'Such a test could be used, for example, to check the configuration of the restrictions
    built into the mail server (invalid domains, spam defenses, and more). The example
    checks whether the mail server refuses to accept a mail containing the invalid
    domain **`gna.dot`** (that is, in the **`RCPT TO`**:). The test runs successfully,
    therefore, if the server rejects the mail with **`554`**. What **`check_smtp`**
    does here corresponds to the following mail dialog reproduced by **`telnet`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: If the mail server did not reject the recipient domain because of the configuration
    error, the reply would no longer contain **`554`** and the plugin would issue
    a WARNING.
  prefs: []
  type: TYPE_NORMAL
- en: In general you should remember, when checking restrictions, that the server
    rejects mails only after a **`RCPT TO:`**, depending on the configuration, even
    if the reason for this (a certain client IP address, the server name in **`HELO`**
    or the sender address in **`MAIL FROM:`**) has already occurred before this.
  prefs: []
  type: TYPE_NORMAL
- en: 6.3.2 POP and IMAP
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Four pseudo plugins are available for testing the POP and IMAP protocols: **`check_pop`**,
    **`check_spop`**, **`check_imap`**, and **`check_simap`**. They are called pseudo
    plugins because they are just symbolic links to the plugin **`check_tcp`**. By
    means of the name with which the plugin is called, this determines its intended
    use and correspondingly sets the required parameters, such as the standard port,
    whether something should be sent to the server, the expected response, and how
    the connection should be terminated. The options are the same for all plugins,
    which is why we shall introduce them all together:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/--host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the computer on which POP or IMAP is to be checked.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`port`*``** specifies an alternative port if the plugin is intended to
    monitor a different port from the standard one: 110 for **`check_pop`**, 995 for
    **`check_spop`**, 143 for **`check_imap`**, and 993 for **`check_simap`** (see
    also **`/etc/services`**).'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`floating_point_dec`*``** **`/--warning=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The placeholder **``*`floating_point_dec`*``** is replaced by the warning limit
    for the response time in seconds, specified as a floating point decimal.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`floating_point_dec`*``** **`/--critical=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This sets the critical limit for the response time in seconds (see **`-w`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s`** **``*`"string"`*``** **`/--send=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This string is to be sent to the server. In the default setting, none of the
    four plugins uses this option.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-e`** **``*`"string"`*``** **`/--expect=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`string`*``** specifies a text string, which must be contained in the
    response of the server. The default is +**`0K`** for (S) POP and **`* OK`** for
    (S)IMAP. This option may be given multiple times to search for different partial
    strings in the answer.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-E / --escape`**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch allows the use of the escape sequences **`\n`**, **`\r`**, **`\t`**,
    or simply **`\`** in the details for **`-s`** and **`-e`**. In all cases **`-E`**
    must be placed in front of the options **`-s`** and **`-e`** on which it is to
    have an influence.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-A / --all`**'
  prefs: []
  type: TYPE_NORMAL
- en: If you specify several reply strings with **`-e`**, the plugin with **`-A`**
    will only return OK if all required reply strings were found. Without this option,
    one string out of several sought is enough to trigger a positive acknowledgment.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-M`** **``*`return value`*``** **`/ -mismatch=`****``*`return value`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: How should the plugin react if a returned string does not match the statement
    in **`-e`**? The default is **`warn`**, which means there is a WARNING. With **`crit`**
    a false return can be assigned as CRITICAL, with **`ok`** as OK.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-q`** **``*`"string"`*``** **`/--quit=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the string with which the service is requested to end the connection.
    For (S)POP this is **`QUIT\r\n`**, for (S)IMAP, **`al L0G0UT\r\n`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-S / --ssl`**'
  prefs: []
  type: TYPE_NORMAL
- en: The connection set up during the test uses SSL/TLS for the connection. If you
    call the plugins **`check_simap`** and **`check_spop`**, this option is set automatically.
    In order for a connection to be established, the server must support SSL/TLS directly
    on the addressed port.
  prefs: []
  type: TYPE_NORMAL
- en: STARTTLS^([[54](#ftn.CHP-6-FN-7)]) on its own does not support the plugin. With
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: 'you can at least check whether the server provides this method: the plugin
    returns OK if the reply string contains STARTTLS, or WARNING if it doesn''t. But
    this is not really a genuine test of whether STARTTLS really does work properly.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-D`** **``*`duration`*``** **`/--certificate=`****``*`duration`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch specifies the number of days the certificate used for STARTTLS will
    remain valid.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** **``*`return_value`*``** **`/ -refuse=`****``*`return_value`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch specifies which value the plugin returns if the server rejects the
    TCP connection. The default is **`crit`** (CRITICAL). The value **`ok`** can be
    set in case no POP or IMAP service is available. The third possible value, **`warn`**,
    triggers a WARNING.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-m`** **``*`bytes`*``** **`/--maxbytes=`****``*`bytes`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch advices the plugin to close the TCP connection when the specified
    data amount (in bytes) has been received.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`** **``*`seconds`*``** **`/--delay=`****``*`seconds`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch waits for the specified time after a string has been sent to the
    server before the answer is searched for the string specified with **`-e`**.
  prefs: []
  type: TYPE_NORMAL
- en: Of course, all the other options of the generic plugin **`check_tcp`** (described
    in [6.7.1 Testing TCP ports](../Text/ch06s09.html#testing_tcp_ports "6.7.1 Testing
    TCP ports") in page 132) can be used with **`check_pop`**, **`check_spop`**, **`check_imap`**,
    and **`check_simap`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the simplest case you just need to give the name of the computer to be tested
    (here: **`mailsrv`**) or the IP address:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: In each case the plugin provides just one line of output, which has been line-wrapped
    here for layout reasons. The details after the pipe character **`|`** in turn
    involve performance data not shown by the Web interface. The structure of performance
    data and how they are processed are described in more detail in [19.1 Processing
    Plugin Performance Data with Nagios](../Text/ch19.html#processing_plugin_performance_data_with
    "19.1 Processing Plugin Performance Data with Nagios") in page 404.
  prefs: []
  type: TYPE_NORMAL
- en: 'Implemented as a command object, the above **`check_pop`** command looks like
    this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: 'As a service for the machine **`linuxO1`**, it is integrated like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[54](#CHP-6-FN-7)]) STARTTLS refers to the capacity of a service to set up
    an SSL/TLS-secured connection after a normal connection has been established—for
    example, for POP3, via TCP port 110\. Every service that implements STARTTLS must
    have a suitable command available to do this. With POP3 this is called **`STLS`**
    (see RFC 2595). STARTTLS is used with SMTP, LDAP, IMAP, and POP3, among others,
    but not every server supports this method automatically.
  prefs: []
  type: TYPE_NORMAL
- en: 6.4 Monitoring FTP and Web Servers
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The Nagios plugin package provides two plugins to monitor the classic Internet
    services FTP and HTTP (including HTTPS): **`check_ftp`** and **`check_ http`**.
    When many users from a network are using Web services, a proxy is usually used
    in addition. To monitor this, you could also use **`check_http`**, but with the
    **`check_squid.pl`** plugin, The Nagios Exchange has a better tool available.'
  prefs: []
  type: TYPE_NORMAL
- en: 6.4.1 FTP services
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The plugin **`check_ftp`** is, like the plugins for POP and IMAP, a symbolic
    link to the generic plugin **`check_tcp`**, so that it also has the same options.
    They are described in detail in [6.7.1 Testing TCP ports](../Text/ch06s09.html#testing_tcp_ports
    "6.7.1 Testing TCP ports") in page 132.
  prefs: []
  type: TYPE_NORMAL
- en: 'The generic plugin sets the following parameters if it is called with the name
    **`check_ftp`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: It does not send a string to the server, but it expects a reply containing the
    text **`220`**, and it ends the connection to the standard port 21 cleanly with
    **`QUIT\r\n`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'On the command line there is, as usual, a one-line reply (with line breaks
    for the printed version) with performance data after the **`|`** character that
    is not shown by the Web interface, (see [19.1 Processing Plugin Performance Data
    with Nagios](../Text/ch19.html#processing_plugin_performance_data_with "19.1 Processing
    Plugin Performance Data with Nagios") from page 404) for an explanation of this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: 'As a command object, this call appears as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: 'A corresponding service definition looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: 6.4.2 Web server control via HTTP
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The **`check_http`** plugin for HTTP and HTTPS checks contains a large number
    of very useful options, depending on the intended use:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`virtual_host`*``** **`/--hostn.ame=`****``*`virtual_host`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This switch specifies the virtual host name that the plugin transmits in the
    HTTP header in the **`host:`** field:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: If you don't want **`check_http`** to send this, you can use **`-I`** instead.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-I`** **``*`ip-address`*``** **`/--IP-address=`****``*`ip-address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Instead of **``*`ip`*``**, the host name or IP address of the target computer
    is given. For systems with several virtual environments, you will land in the
    default environment, and for most Web hosting providers you will then receive
    an error message:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: '**`-u`** **``*`url_or_path`*``** **`/--url=`****``*`url_or_path`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'The argument is the URL to be sent to the Web server. If the design document
    lies on the server to be tested, it is sufficient to enter the directory path,
    starting from the *document root* of the server:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: If this option is not specified, the plugin asks for the document root**`/`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is an alternative port specification for HTTP.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`floating_point_dec`*``** **`/--warning=`****``*`floati.ng_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the warning limit for the response time of the Web server in seconds.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`floating_point_dec`*``** **`/--critical=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the critical limit for the response time of the Web server in seconds.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** **`/--timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds have expired, the plugin interrupts the test
    and returns the CRITICAL status. The default is **`10`** seconds.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-L`** **`/--link-url`**'
  prefs: []
  type: TYPE_NORMAL
- en: This option ensures that the virtual host in the text output appears on the
    Web interface as a link.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: '**`-a`** **``*`username : password`*``** **`/--authorization=`****``*`username
    : password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the Web server requires authentication, this option can be used to specify
    a user-password pair. The plugin can only handle *basic authentication*, however;
    *digest authentication* is currently not yet possible.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-f`** **``*`behavior`*``** **`/--onredirect=`****``*`behavior`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the Web server sends a redirect as a reply to the requested Web page, the
    **``*`behavior`*``** parameter influences the behavior of the plugin. The values
    **`ok`**, **`warning`**, **`critical`** and **`follow`** are allowed. The default
    is **`ok`**, so the plugin will simply return an OK, without following the redirect.
    The plugin can be made to follow the redirect with **`follow`**. **`warning`**
    and **`critical`** with a redirect return the **`WARNING`** or **`CRITICAL`**
    status.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-e`** **``*`"string"`*``** **`/--expect=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the text that the server response should contain in its first status
    line. If this option is not specified, the plugin expects **`HTTP/1`**. as a **``*`string`*``**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s`** **``*`"string"`*``** **`/--string=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the search text that the plugin looks for in the contents of the page
    returned, not in the header.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** **``*`"regexp"`*``** **`/--regex=`****``*`"regexp"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is a regular expression^([[55](#ftn.CHP-6-FN-8)]) for which the plugin
    should search in the page returned.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-R`** **``*`"regexp"`*``** **`/--eregi=`****``*`"regexp"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch works like **``*`-r`*``**, except that the plugin now makes no distinction
    between upper and lower case.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--invert-regex`**'
  prefs: []
  type: TYPE_NORMAL
- en: This inverts the search with **``*`-r`*``** or **`-R`**. The plugin now returns
    CRITICAL instead of OK if there is a match.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-l`** **`/--linespan`**'
  prefs: []
  type: TYPE_NORMAL
- en: Normally the search for regular expressions is restricted to one line with **``*`-r`*``**
    and **`-R`**. If **`−l`** precedes these options, the search pattern can refer
    to text covering multiple lines.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-P`** **``*`string`*``** **`/--post=`****``*`string`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Use this switch for data that you would like to send via a POST command to the
    Web server. The characters in **``*`string`*``** must be encoded in accordance
    with RFC 1738:^([[56](#ftn.CHP-6-FN-9)]) only the letters A to Z (upper and lower
    case), the special characters **`$-_. + !*' ()`**, and the numbers 0 to 9 are
    allowed.
  prefs: []
  type: TYPE_NORMAL
- en: To send the text **Übung für Anfänger** ("Exercise For Beginners" in German)
    as a **``*`string`*``**, umlauts and spaces must be encoded before they are sent:**%DCbung%20f%FCr%20Anf%E4nger**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-T`** **``*`string`*``** **`/ -content-type=`****``*`string`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the **`content type`** of the header, if you are sending something
    with **`--post`**, for example, to the server. The default is **`application/x-www-form-urlencoded`**.
    A list of all content types is given in the file **`/etc/mime.types`**, and a
    description of the format can be found in RFC2045.^([[57](#ftn.CHP-6-FN-10)])
  prefs: []
  type: TYPE_NORMAL
- en: '**`-m`** **``*`min_bytes:max_bytes`*``** **`/--pagesize=`****``*`min_bytes:max_bytes`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This parameter defines that the page returned must be at least **``*`min_bytes`*``**
    in size, otherwise the plugin will issue a WARNING. You can optionally use an
    upper limit as well—separated by a colon—to specify the size of the Web page.
    Now **`check_http`** will also give a warning if the page returned is larger than
    **``*`max_bytes`*``**. In the following example, everything is in order if the
    page returned is at least 500 bytes and at most 2000 bytes in size:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: '**`-N`** **`/--no-body`**'
  prefs: []
  type: TYPE_NORMAL
- en: With this option the plugin does not wait for the server to return the complete
    page contents, but just reads in the header data. To do this it uses the HTTP
    commands **`GET`** or **`POST`**, and not **`HEAD`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-M`** **``*`seconds`*``** **`/--max-age=`****``*`seconds`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the returned document is older than the date specified in the header (HTTP
    header field **`Date:`**), the plugin will generate a WARNING. Instead of seconds
    (without additional details) you can also use explicit units such as **`5m`**
    (five minutes), **`12h`** (twelve hours), or **`3d`** (three days); combinations
    are not allowed.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-A`** **``*`"string"`*``** **`/--useragent=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This parameter explicitly specifies a user agent in the HTTP header, such as
    **`-A "Lynx/1.12"`** for Lynx version 1.12\. Normally the plugin does not send
    this field.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-k`** **``*`"string"`*``** **`/--header=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This specifies any HTTP header tags. If several tags are to be specified, they
    must be separated by a semicolon, as in the following example:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  prefs: []
  type: TYPE_PRE
- en: '**`-S`** **`/--ssl`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This forces an SSL connection to be used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  prefs: []
  type: TYPE_PRE
- en: The host [www.verisign.com](http://www.verisign.com) allows an SSL connection.
    If this is not the case, the server returns an error and the plugin returns the
    value CRITICAL:^([[58](#ftn.CHP-6-FN-11)])
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  prefs: []
  type: TYPE_PRE
- en: '**`-C`** **``*`days`*``** **`/--certificate=`****``*`days`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Tests whether the certificate is at least valid for the given number of days.
    Otherwise a WARNING is issued.
  prefs: []
  type: TYPE_NORMAL
- en: '**`−4`** **`/--use-ipv4`**'
  prefs: []
  type: TYPE_NORMAL
- en: The test is made explicitly over an IPv4 connection.
  prefs: []
  type: TYPE_NORMAL
- en: '**`−6`** **`/--use-ipv6`**'
  prefs: []
  type: TYPE_NORMAL
- en: The test is made explicitly over an IPv6 connection.
  prefs: []
  type: TYPE_NORMAL
- en: The definition of a corresponding command object and its use as a service is
    no different from that based on other plugins; [6.4.3 Monitoring Web proxies](../Text/ch06s04.html#monitoring_web_proxies
    "6.4.3 Monitoring Web proxies") shows an example.
  prefs: []
  type: TYPE_NORMAL
- en: 6.4.3 Monitoring Web proxies
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Proxy test with **`check_http`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'A proxy such as Squid can also be tested with **`check_http`**, but this assumes
    that you have some knowledge of how a browser makes contact with the proxy. It
    does this in the form of an HTTP header:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  prefs: []
  type: TYPE_PRE
- en: 'The decisive entries are printed in bold type. In contrast to normal Web server
    queries, the browser requests the document from the server via a GET command,
    not by specifying the directory path, but by using the complete URL, including
    the protocol type. In the **`Host:`** field it specifies the host name of the
    Web server that it actually wants to reach. With normal HTTP queries that go directly
    to a Web server (and not via a proxy), the host name of the Web server would be
    written there. This behavior can be reproduced with **`check_http`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  prefs: []
  type: TYPE_PRE
- en: 'In order to set the **`Host:`** field in the header, you specify the name of
    a Web server with **-H**. The nonlocal URL is forced by a **`-u`**, and specifying
    **-I** at the same time ensures that the proxy is addressed, and not the Web server
    itself. Finally you need to select the proxy port, and the proxy test is then
    complete. Then **`check_http`** will send the following HTTP header to the proxy:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  prefs: []
  type: TYPE_PRE
- en: This test does not use any implementation-specific information of the proxy,
    so it should work with every Web proxy.
  prefs: []
  type: TYPE_NORMAL
- en: 'The command object is defined as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  prefs: []
  type: TYPE_PRE
- en: 'The proxy computer **`linuxO1`** is then tested with the following service:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  prefs: []
  type: TYPE_PRE
- en: The parameter **`3128`** ensures that the command object **`check_proxy`** can
    read out the port from **`$ARG1$`**.
  prefs: []
  type: TYPE_NORMAL
- en: Proxy test with **`check_squid`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The proxy check with **`check_http`**, introduced in the last section, works
    only if the desired Web page is available or is already in the cache. If neither
    is the case, this test will produce an error, even if the proxy is working in
    principle.
  prefs: []
  type: TYPE_NORMAL
- en: The plugin **`check_squid.pl`** uses a different method, but it is not part
    of the standard installation, and is to be found in the **Check Plugins** category,
    under **Software | HTTP & FTP | Squid Proxy**.^([[59](#ftn.CHP-6-FN-12)])
  prefs: []
  type: TYPE_NORMAL
- en: It makes use of the *cache manager* of the Squid proxy, which is queried by
    a pseudo protocol. A command is sent in the form
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  prefs: []
  type: TYPE_PRE
- en: 'to Squid and obtains the desired information. The plugin **`check_squid.pl`**
    uses the **`info`** command, which queries a range of statistical usage information:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  prefs: []
  type: TYPE_PRE
- en: It is targeted at the number of still-free file descriptors (the third line
    from the end); you can set a warning or critical limit for this value. The number
    of file descriptors plays a role when access is made to objects in the Squid cache
    at the same time. In environments with a high number of parallel accesses to the
    proxy, it is quite possible that 1024 file descriptors are insufficient. In smaller
    networks with just a few hundred users, not all of whom are surfing at the same
    time, the compiled-in value of 1024 will be sufficient.
  prefs: []
  type: TYPE_NORMAL
- en: '`Squid configuration` Normally Squid allows access to the cache manager only
    from **`localhost`**. So that Nagios can query it over the network, the proxy
    must be reconfigured accordingly:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  prefs: []
  type: TYPE_PRE
- en: The necessary changes to the configuration file **`squid.conf`** are printed
    in bold type, and the other relevant lines are already contained in the default
    file. The first line to be printed defines an access control list (*Access Control
    List*, **`acl`**) called **`manager`** by means of the internal protocol **`cache_object`**,
    so it refers to everything that accesses the proxy using the **`cache_object`**
    protocol. This is followed by an access control list for the Nagios server, based
    on its IP address, here **`192.168.1.9`**. The list name **`nagiosserver`** may
    be freely chosen here (as can **`manager`** in the first line). With **`http_access
    allow`**, **`nagiosserver`** obtains access to the cache manager (**`manager`**),
    before the line
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  prefs: []
  type: TYPE_PRE
- en: 'prohibits access to all others through the **`cache_object`** protocol. Finally,
    **`cachemgr_passwd`** provides a password for the cache manager access. If you
    omit this, with none, then only selected commands should be allowed that have
    no potential to change things, such as **`info`** and **`menu`**, which shows
    all the things that the cache manager can do. After the configuration file has
    been modified, Squid needs to read it in again:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  prefs: []
  type: TYPE_PRE
- en: '`Applying the plugin` The test plugin **`check_squid.pl`** itself has the following
    options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/--hostname=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the server on which Squid is to be tested, specified by IP address or
    FQDN.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-P`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the port on which Squid is listening. The default is the standard
    port 3128.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`password`*``** **`/ --password=`****``*`password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the password for access to the cache manager.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`free_descriptors`*``** **`/ --warning=`****``*`free_descriptors`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the number of free file descriptors, where the plugin will issue a warning
    if the number drops below this. The default is 200.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`free_descriptors`*``** **`/ --critical=`****``*`free_descriptors`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the critical limit for free file descriptors. If the number falls below
    this, **`check_squid`** returns CRITICAL. The default is 50.
  prefs: []
  type: TYPE_NORMAL
- en: 'When **`check_squid`** is run, it is usually very unspectacular:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  prefs: []
  type: TYPE_PRE
- en: The matching command also presents no problems ...
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE46]'
  prefs: []
  type: TYPE_PRE
- en: '... and the same goes for service definitions:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[55](#CHP-6-FN-8)]) Posix regular expressions, see **`man 7 regex`**.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[56](#CHP-6-FN-9)]) [http://www.faqs.org/rfcs/rfcl738.html](http://www.faqs.org/rfcs/rfcl738.html),
    paragraph 2.2
  prefs: []
  type: TYPE_NORMAL
- en: ^([[57](#CHP-6-FN-10)]) [http://tools.ietf.org/html/rfc2045#section-5](http://tools.ietf.org/html/rfc2045#section-5)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[58](#CHP-6-FN-11)]) This can be checked in the shell with **`echo $?`**.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[59](#CHP-6-FN-12)]) [http://www.nagiosexchange.org/cgi-bin/pages/Detailed/1764.html](http://www.nagiosexchange.org/cgi-bin/pages/Detailed/1764.html)
  prefs: []
  type: TYPE_NORMAL
- en: 6.5 Domain Name Server Under Control
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Two plugins are also available for testing the *Domain Name Service (DNS):*
    **`check_dns`** and **`check_dig`**. While **`check_dns`** tests whether a host
    name can be resolved, using the external **`nslookup`** program, **`check_dig`**
    allows any records at all to be queried. Both plugins are part of the standard
    distribution.
  prefs: []
  type: TYPE_NORMAL
- en: The situations in which they are used overlap somewhat. With **`check_dns`**,
    you can also explicitly query a specific DNS server, although this plugin is really
    for checking whether the name service is available generally.
  prefs: []
  type: TYPE_NORMAL
- en: 6.5.1 DNS check with **`nslookup`**
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The **`check_dns`** plugin checks whether a specified host name can be resolved
    to an IP address. Used locally, the plugin tests the DNS configuration of the
    computer on which it is run. For the name resolution, it uses the name server
    configured in **`/etc/resolv.conf`**.
  prefs: []
  type: TYPE_NORMAL
- en: The possible options are just as unspectacular.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`host`*``** **`/ --hostname=`****``*`host`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name to be resolved to an IP address.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s`** **``*`dns-server`*``** **`/ --server=`****``*`dns-server`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch explicitly specifies the name server to be used. If this option
    is missing, **`check_dns`** uses the name server from **`/etc/resolv.conf`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-a`** **``*`ip_address`*``** **`/ --expected-address=`****``*`ip_address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The **``*`ip_address`*``** is the IP address that **``*`host`*``** should have.
    If the name service returns a different address, the plugin will raise the alarm
    with CRITICAL. This option makes sense only if it is necessary for the name server
    to provide a fixed IP address. Without this option, the plugin will accept every
    IP address as a reply.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-A / --expect-authority`**'
  prefs: []
  type: TYPE_NORMAL
- en: The name server specified with **`-s`** should answer the given query authoritatively,
    so the corresponding domain must act as a primary or secondary name server. If
    this is not the case, the plugin returns CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`floating point`*``** **`/ - warning=`****``*`floating point`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch specifies the warning limit for the response time of the name server
    in seconds (specified as a floating point).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`floating point`*``** **`/ - critical=`****``*`floating point`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch gives the critical response time of name server in seconds, specified
    as a floating point.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds have expired, the plugin interrupts the test
    and returns the CRITICAL state. The default is **`10`** seconds.
  prefs: []
  type: TYPE_NORMAL
- en: 'For the local test of the DNS configuration (not that for a name server) you
    just require a host name that is highly unlikely to disappear from the DNS, such
    as [www.google.com](http://www.google.com):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  prefs: []
  type: TYPE_PRE
- en: 'The corresponding command definition appears as follows in this case:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  prefs: []
  type: TYPE_PRE
- en: 'The following service tests whether the name server configuration for the computer
    **`linux01`** is functioning:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  prefs: []
  type: TYPE_PRE
- en: 6.5.2 Monitoring the name server with **`dig`**
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The plugin **`check_dig`** provides more options for monitoring a name server
    than **`check_dns`**. As the name implies, it is based on the external utility
    **`dig`**, intended for precisely this purpose.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** / **`--hostname=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The **``*`address`*``** is the IP address for the DNS server to be tested. It
    is also possible to specify a host name (instead of an IP address), but in most
    cases this makes little sense, because this would first have to be resolved before
    it can reach the name server.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch specifies the UDP port to be used. The default is **`53`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`−1`** **``*`hostname`*``** **`/ --lookup=`** **``*`hostuame`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The **``*`hostname`*``** is the host name to be tested. If no particular computer
    is looked up, but only the functionality of the DNS server is to be tested, you
    should specify an address here easily reachable from the Internet, such as [www.google.com](http://www.google.com).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-T`** **``*`record_type`*``** **`/ --record_type=`****``*`record_type`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch specifies the record type to be queried. The default is **`A`**
    (IPv4 address), but often **`NS`** (relevant name server), **`MX`** (relevant
    *Mail Exchange*), **`PTR`**(*Pointer*; IP address for reverse lookup), or **`S0A`**(*Source
    of Authority*, the administration details of the domain) are also used.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch sets the warning limit for the response time of the name server
    in seconds (floating point decimal).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch sets the critical response time of the name server in seconds (floating
    point decimal).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-a`** **``*`address`*``** **`/ --expected_address=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the address that **`dig`** should return in the *ANSWER SECTION*. In
    contrast to **`check_dns, check_dig`** delivers a WARNING only if the IP address
    does not match, but the reply itself has arrived within the given time limit.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds have expired, the plugin breaks off the test
    and returns the CRITICAL state. The default is **`10`** seconds.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following two examples check the name server **`194.25.2.129`**, by requesting
    it for the IP address of the computer [www.swobspace.de](http://www.swobspace.de.)
    The second example ends with a WARNING, since the reply of the name server for
    [www.swobspace.de](http://www.swobspace.de) returns a different IP address from
    **`1.2.3.4`** in the **`ANSWER SECTION`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  prefs: []
  type: TYPE_PRE
- en: 'Example 1 is implemented as a command object as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE52]'
  prefs: []
  type: TYPE_PRE
- en: In order to test the specific name server **`linux0l`**, you look for an address
    that Nagios should always be able to resolve, such as [www.google.com](http://www.google.com/)
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE53]'
  prefs: []
  type: TYPE_PRE
- en: 6.6 Querying the Secure Shell Server
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Monitoring of Secure Shell servers (irrespective of whether they use protocol
    version 1 or 2) is taken over by the plugin **`check_ssh`** (included in the standard
    distribution). It is quite a simple construction and just evaluates the SSH handshake.
    User name and password are not required for the test.
  prefs: []
  type: TYPE_NORMAL
- en: Not to be confused with **`check_sshis`** the plugin **`check_by_ssh`** (see
    [Chapter 9](../Text/ch09.html "Chapter 9. Executing Plugins via SSH") from page
    205), which starts plugins remotely on a different computer.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Host name or IP address of the computer to which the plugin should set up an
    SSH connection.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies an alternative port. The default is 22.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** **``*`version`*``** **`/ --remote-version=`****``*`version`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The version details for the tested Secure Shell must match the specified text
    instead of **``*`version`*``**, otherwise a WARNING will be sent (see example
    below). If the version details contain spaces, the string must be enclosed by
    double quotes.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** (by default, **`10`**) seconds the plugin breaks off
    the test and returns the CRITICAL state.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example in turn tests the Secure Shell daemons on the local computer
    and on **`wobgate`**, to see whether the current SSH version from Debian Etch
    is being used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE54]'
  prefs: []
  type: TYPE_PRE
- en: The latest version of SSH is not in use on **`wobgate`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'In heterogeneous environments with various Linux distributions, you will usually
    use version checking "manually" only for plugin calls, and only rarely integrate
    them into the Nagios configuration. Instead, it is normally sufficient to use
    command and service definitions using the following simple pattern:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE55]'
  prefs: []
  type: TYPE_PRE
- en: Otherwise you run the risk of having to adjust the version number in the command
    object after every security update.
  prefs: []
  type: TYPE_NORMAL
- en: 6.7 Generic Network Plugins
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Sometimes no plugin can be found that is precisely geared to the service to
    be monitored. For such cases, two generic plugins are available: **`check_tcp`**
    and **`check_udp`**. Both of them test whether a service is active on the target
    port for the protocol in question. Although this does not yet guarantee that the
    service running on the port really is the one in question, in an environment that
    one adminstrator looks after and configures, this can be sufficiently guaranteed
    in other ways.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Both plugins send a string to the server and evaluate the reply. This is at
    its most simple for text-based protocols such as POP or IMAP: these two "specific"
    plugins, which are tailor-made for these two mail services (see [6.3.2 POP and
    IMAP](../Text/ch06s03.html#pop_and_imap "6.3.2 POP and IMAP") from page 115),
    use nothing more than symbolic links to **`check_tcp`**, which has already completed
    the corresponding question-and-answer game with relevant default settings.'
  prefs: []
  type: TYPE_NORMAL
- en: If you know the protocol to be tested and you configure a "quiz" that will fit
    this (no easy task for binary protocols), a check becomes considerably more than
    just a port scan. In this way the generic plugins can also be substituted for
    specific missing plugins.
  prefs: []
  type: TYPE_NORMAL
- en: 6.7.1 Testing TCP ports
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '**`check_tcp`** is concentrated on TCP-based services. In line with its generic
    nature, it has a large number of options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the IP address or host name of the computer whose port should be tested.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the target port. In contrast to the plugins that are formed as
    a symbolic link to **`check_tcp`**, this detail is always required.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This sets the warning limit for the response time in seconds.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This sets a time limit like **`-w`** but specifies the critical limit value.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s`** **``*`"string"`*``** **`/ --send=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the string that the plugin should send to the server.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-e`** **``*`"string"`*``****`/ --expect=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the string that the reply of the server should contain. The plugin does
    not restrict its search here to the first line.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-E`** **`/ --escape`**'
  prefs: []
  type: TYPE_NORMAL
- en: This allows the use of the escape sequences **`\n`**, **`\r`**, **`\t`** or
    simply **`\`** for **`-s`** and **`-e`**. In all cases **`-E`** must be placed
    in front of the options **`-s`** and **`-e`** on which it should have an influence.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-A`** **`/ --all`**'
  prefs: []
  type: TYPE_NORMAL
- en: If you specify multiple reply strings with **`-e`**, the plugin with **`-A`**
    will only return OK if all required reply strings were found. Without this option
    it is enough for a positive return if just one of several strings is found.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-M`** **``*`return_value`*``** **`/ --mismatch=`****``*`return_value`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: How should the plugin react if a returned string does not match what is specified
    with **`-e?`** The default is **`warn`**, which means that a WARNING is given.
    With **`crit`**, a false return value could be categorized as CRITICAL, and with
    **`ok`**, as OK.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-q`** **``*`"string"`*``** **`/ --quit=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the string that requests the service to end the connection.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-m`** **``*`bytes`*``** **`/ --maxbytes=`****``*`bytes`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The plugin closes the connection if it has received more than **``*`bytes`*``**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`** **``*`floating_point_decimal`*``** **`/ --delay=`****``*`floating_point_decimal`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the time period in seconds between sending a string and checking the
    response.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** (the default is **`10`**) seconds the plugin stops
    the test and returns the CRITICAL status.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-j`** **`/ --jail`**'
  prefs: []
  type: TYPE_NORMAL
- en: Setting this displays the TCP output. For text-based protocols such as POP or
    IMAP, this is usually "human-readable", but for binary protocols you generally
    cannot decipher the output, so that **`-j`** is appropriate.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** **``*`return_value`*``** **`/ --refuse=`****``*`return_value`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch specifies what value the plugin returns if the server rejects the
    TCP connection. The default is **`crit`** (CRITICAL). With **`ok`** as the **``*`return_value`*``**,
    you can test whether a service is available that should not be accessible from
    outside. The third possible value, **`warn`**, ensures that a WARNING is given.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-D`** **``*`days`*``** **`/ --certificate=`****``*`days`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This is the time span in days for which a server certificate must at least
    be valid for the test to run successfully. It is relevant only for SSL connections.
    Note that there is a danger of confusion: in the **`check_http`** plugin this
    same option is **`-C`** (see [6.4.2 Web server control via HTTP](../Text/ch06s04.html#web_server_control_via_http
    "6.4.2 Web server control via HTTP")). If the time span drops below the time period
    specified for the server certificate, the plugin returns a WARNING.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-S`** **`/ --ssl`**'
  prefs: []
  type: TYPE_NORMAL
- en: SSL/TLS should be used for the connection. The plugin cannot handle STARTTLS^([[60](#ftn.CHP-6-FN-13)]).
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example checks on the command line whether a service on the target
    host **`192.168.1.89`** is active on port 5631, the TCP port for the Windows remote-control
    software, PCAnywhere:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE56]'
  prefs: []
  type: TYPE_PRE
- en: 'For all services for which the computer name and port detail are sufficient
    as parameters for the test, the command object is as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE57]'
  prefs: []
  type: TYPE_PRE
- en: 'To monitor the said PCAnywhere on the machine **`Win0l`**, the following service
    definition would be used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE58]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[60](#CHP-6-FN-13)]) See footnote in [6.3.2 POP and IMAP](../Text/ch06s03.html#pop_and_imap
    "6.3.2 POP and IMAP").
  prefs: []
  type: TYPE_NORMAL
- en: 6.7.2 Monitoring UDP ports
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: It is not so simple to monitor UDP ports, since there is no standard connection
    setup, such as the *three-way-handshake* for TCP, in the course of which a connection
    is opened, but data is not yet transferred. For a stateless protocol such as UDP
    there is no regulated sequence for sent and received packets. The server can reply
    to a UDP packet sent by the client with a UDP packet, but it is not obliged to
    do this.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you find an unoccupied port, the requested host normally sends back an ICMP
    port unreachable message, which evaluates the plugin. If there is no reply, there
    are two possibilities: either the service on the target port is not reacting to
    the request, or a firewall is filtering out network traffic (either the UDP traffic
    itself or the ICMP message). This is why you can never be sure with UDP whether
    the server behind a particular port really is offering a service or not.'
  prefs: []
  type: TYPE_NORMAL
- en: In order to force a positive response where possible, you normally have to send
    data to the server, with the option **`-s`**, containing some kind of meaningful
    message for the underlying protocol. Most services will not respond to empty or
    meaningless packets. This is why you cannot avoid getting to grips with the corresponding
    protocol, since you will otherwise not be in a position to send meaningful data
    to the server, to prompt it into giving a reply at all.
  prefs: []
  type: TYPE_NORMAL
- en: Ever since Nagios plugin version 1.4.4, **`check_udp`** has been a symlink to
    **`check_tcp`**, so that **`check_udp`** has the same options as **`check_tcp`**
    (see [6.6 Querying the Secure Shell Server](../Text/ch06s08.html "6.6 Querying
    the Secure Shell Server")). **`-p`** **``*`port`*``**, **`-s`** **``*`string`*``**,
    and **`-e`** **``*`string`*``** are obligatory entries, even though the integrated
    online help declares these to be optional.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example tests whether a service on the target host **`192.168.1.13`**
    is active on the time server (NTP) Port 123\. The NTP daemon only replies to packets
    containing a meaningful request (e.g., to ones whose contents begin with **`w`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE59]'
  prefs: []
  type: TYPE_PRE
- en: 'The reply remains empty, so the reply string is specified as **`-e ""`**. The
    NTP server does not respond to packets with data not in the protocol form. Normally
    NTP expects a relatively complex packet^([[61](#ftn.CHP-6-FN-14)]) containing
    various information. The **`w`** used here was found out by trial and error: It
    does not contain really meaningful data, but it does provoke the server into giving
    a response.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The command line command shown above is implemented as follows as a command
    object:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE60]'
  prefs: []
  type: TYPE_PRE
- en: Here we pass on the port as the first argument; all the other switches of the
    plugin are accessed through **`$ARG2$`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'Checking an NTP time server is then taken over by the following service definition:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE61]'
  prefs: []
  type: TYPE_PRE
- en: As in the command line example, Nagios sends the string **`w`** to the service
    to provoke a positive response.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: '^([[61](#CHP-6-FN-14)]) The protocol version NTPv3 is described in RFC 1305:
    [http://rfc.sunsite.dk/rfc/rfcl305.html](http://rfc.sunsite.dk/rfc/rfcl305.html).'
  prefs: []
  type: TYPE_NORMAL
- en: 6.8 Monitoring Databases
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Nagios provides three plugins for monitoring databases: **`check_pgsql`** for
    PostgreSQL, **`check_mysql`** for MySQL, and **`check_oracle`** for Oracle. The
    last will not be covered in this book.^([[62](#ftn.CHP-6-FN-15)]) They all have
    in common the fact that they can be used both locally and over the network. The
    latter has the advantage that the plugin in question does not have to be installed
    on the database server. The disadvantage is that you have to get more deeply involved
    with the subject of authentication, because configuring a secure *local* access
    to the database is somewhat more simple.'
  prefs: []
  type: TYPE_NORMAL
- en: For less critical systems, network access by the plugin can be done without
    a password. To do this, the user **`nagios`** is set up with its own database
    in the database management system to be tested, which does not contain any (important)
    data. Areas accessed by this user can be isolated from other data, stored in the
    DBMS, through the database's own permissions system.
  prefs: []
  type: TYPE_NORMAL
- en: Of course, there is nothing stopping you from setting up a password for the
    user **`nagios`**. But if you cannot make use of SSL-encrypted connections, this
    will be transmitted in plain text for most database connections. In addition,
    it is stored unencrypted in the Nagios configuration files. In this respect the
    password does offer some protection, but it is not really that secure.
  prefs: []
  type: TYPE_NORMAL
- en: As an additional measure, you should certainly restrict the IP address from
    which a user **`nagios`** user can access the database on the Nagios server.
  prefs: []
  type: TYPE_NORMAL
- en: The plugins introduced here have only read access to the database. **`check_mysql`**
    additionally allows a pure connection check, without read access. A write access
    to the database is not available in any of the plugins mentioned. For Oracle there
    is a plugin on Nagios Exchange^([[63](#ftn.CHP-6-FN-16)]) called **`check_oracle_writeaccess.sh`**,
    which also tests the writeability of the database.
  prefs: []
  type: TYPE_NORMAL
- en: 6.8.1 PostgreSQL
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: With the **`check_pgsql`** plugin you can establish both local and network connections
    to the database. Local connections are handled by PostgreSQL via a Unix socket,
    which is a purely local mechanism. An IP connection is set up by **`check_pgsql`**
    if a target host is explicitly passed to it. The plugin performs a pure connection
    test to a test database but does not read any data from it.
  prefs: []
  type: TYPE_NORMAL
- en: In order that PostgreSQL can be reached over the network, you must start the
    **`postmaster`** program, either with **`-i`**, or by setting the parameter **`tcpip_socket`**
    in the configuration file **`postgresql.conf`** to the value **`true`**.
  prefs: []
  type: TYPE_NORMAL
- en: Configuring a monitor-friendly DBMS
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'In order to separate the data that the user **`nagios`** (executing the plugin)
    gets to see more clearly from other data, you first set up a database user with
    the same name, and a database to which this user is given access:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE62]'
  prefs: []
  type: TYPE_PRE
- en: Of particular importance when creating a database user with the command **`createuser`**
    is the option **`--no-adduser`**. To PostgreSQL, the ability to be allowed to
    create users automatically means that you are the superuser, who can easily get
    round the various permissions set.^([[64](#ftn.CHP-6-FN-17)]) But **`nagios`**
    should not be given superuser permissions under any circumstances.
  prefs: []
  type: TYPE_NORMAL
- en: '**`createdb`** finally creates a new, empty database called **`nagdb`**, which
    belongs to **`nagios`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Access to the database can be restricted in the file **`pg_hba.conf`**. Depending
    on the distribution, this can be found either in **`/etc/postgresql`** or in the
    subdirectory **`./data`** of the database itself (for example, **`/var/lib/pgsql/data`**
    for SUSE). The following extract restricts access by the database user **`nagios`**
    to a specific database and to the IP address of the Nagios server (instead of
    the IP address to be completed by **``*`ip-nagios`*``**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE63]'
  prefs: []
  type: TYPE_PRE
- en: The first line is a comment describing the function of the columns. The second
    line allows the database user **`nagios`** access to the database **`nagdb`**
    over a local connection. Even though the authentication method here is called
    **`ident`**, you do not need a local ident daemon for Linux and BSD variants (NetBSD,
    FreeBSD, etc.).
  prefs: []
  type: TYPE_NORMAL
- en: The last line describes the same restriction, but this time it is for a TCP/IP
    connection to the Nagios server. But now PostgreSQL asks the ident daemon of the
    Nagios server which user has set off the connection request. This means that an
    ident daemon must be installed on **``*`ip-nagios`*``**. In this way the DBMS
    tests whether the user initiating the connection from the Nagios server really
    is called **`nagios`**. It will not permit another user (or a connection from
    a different host).
  prefs: []
  type: TYPE_NORMAL
- en: Normally the ident protocol is only partially suited for user authentication.
    But in the case of the Nagios server you can assume that a host is involved that
    is under the control of the administrator who can ensure that an ident daemon
    really is running on port 113.
  prefs: []
  type: TYPE_NORMAL
- en: There is a huge range of different ident daemons. **`pidentd`**^([[65](#ftn.CHP-6-FN-18)])
    is widely used and is included in most Linux distributions. Normally it is already
    precon-figured and just needs to be started. But how it is started depends on
    the distribution; usually **`inetd`** or **`xinetd`** takes over this task. A
    glance at the documentation (should) put you straight.
  prefs: []
  type: TYPE_NORMAL
- en: After modifying the configuration in **`pg_hba.conf`** you must stop the DBMS
    so that it can reload the configuration files. This is best done with the command
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE64]'
  prefs: []
  type: TYPE_PRE
- en: (a restart is not necessary). If the configuration of the **`inetd/xinetd`**
    was modified, this daemon is reinitialized in the same way.
  prefs: []
  type: TYPE_NORMAL
- en: The test plugin **`check_pgsql`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`check_pgsql`** has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If given this option, the plugin establishes a TCP/IP connection instead of
    making contact with a local DBMS through a Unix socket.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-P`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: In contrast to the plugins discussed until now, **`check_pgsql`** uses a capital
    P to specify the port on which PostgreSQL is running. In its default value it
    is connected to port 5432\. This option is only useful if PostgreSQL allows TCP/IP
    connections.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`** **``*`database`*``** **`/ --database=`****``*`database`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Specifies the name of the database to which the plugin should connect. If this
    detail is missing, it uses the standard database **`template1`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the warning time in seconds for the performance time for the test.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the critical limit for the performance time of the test in seconds.
  prefs: []
  type: TYPE_NORMAL
- en: '**`−1`** **``*`user`*``** **`/ --logname=`****``*`user`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name of the user who should establish contact to the database.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`passwd`*``** **`/ --password=`****``*`passwd`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch sets the password for access to the database. Since this must be
    stored in plain text in the service definition, a potential security problem is
    involved. It is preferable to explicitly define a restricted, password-free access
    to the database in the PostgreSQL configuration for the user **`nagios`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After 10 seconds have expired, the plugin stops the test and returns the CRITICAL
    status. This option allows the default value to be changed.
  prefs: []
  type: TYPE_NORMAL
- en: 'To test the reachability across the network of the database **`nagdb`** set
    up specially for this purpose, this is passed on as a parameter together with
    the target host (here: **`linux01`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE65]'
  prefs: []
  type: TYPE_PRE
- en: 'The fact that the check went wrong in the example is clearly due to the ident
    authentication. This happens, for example, if you forget to reload the ident daemon
    after the configuration has been modified. Once the error has been rectified,
    the plugin—hopefully—will work better:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE66]'
  prefs: []
  type: TYPE_PRE
- en: 'If the database parameter is omitted, **`check_pgsql`** will address the database
    **`template1`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE67]'
  prefs: []
  type: TYPE_PRE
- en: 'A similar result is obtained if you run the test with the correct database,
    but with the wrong user:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE68]'
  prefs: []
  type: TYPE_PRE
- en: You should certainly run the last two tests, just to check that the PostgreSQL
    database really does reject corresponding requests. Otherwise you will have a
    security leak, and we recommend that you remove settings in the configuration
    that are too generous.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you have created a separate database for the check, there is no reason why
    you shouldn''t write this explicitly in the command definition, instead of using
    parameters, with **`$ARG1$`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE69]'
  prefs: []
  type: TYPE_PRE
- en: 'Then the service definition for **`linux01`** is as simple as this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE70]'
  prefs: []
  type: TYPE_PRE
- en: 6.8.2 MySQL
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: With the **`check_mysql`** plugin, MySQL databases can be tested both locally
    and across the network. For local connections, it makes contact via a Unix socket,
    and not via a real network connection.
  prefs: []
  type: TYPE_NORMAL
- en: MySQL configuration
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'In order that the database can be reached across the network, the **`skip-networking`**
    option in the configuration file **`my.cnf`** must be commented out. The database
    should then be running on TCP port 3306, which can be tested with **`netstat -ant`**,
    for example:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE71]'
  prefs: []
  type: TYPE_PRE
- en: To set up the password-free access to the database relatively securely, a separate
    **`nagdb`** database is created here that does not contain any critical data,
    and for which the user **`nagios`** is given restricted access from the Nagios
    server. To do this, you connect yourself, as the database user **`root`**, to
    the database **`mysql`**, and there you create the database **`nagdb:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE72]'
  prefs: []
  type: TYPE_PRE
- en: If the command **`mysql --user=root mysql`** functions without the need to enter
    a **`root`** password, then you have a serious security problem. In that case,
    anyone—at least from the database server—is able to obtain full access to the
    database. If this is the case, it is essential that you read the security notes
    in the MySQL documentation.^([[66](#ftn.CHP-6-FN-19)])
  prefs: []
  type: TYPE_NORMAL
- en: 'Recreating a user and the access restrictions can be done in one and the same
    step:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE73]'
  prefs: []
  type: TYPE_PRE
- en: The command sets up the user **`nagios`**, if it does not exist. It may only
    accept connections from the Nagios server with the IP address **``*`ip-nagios`*``**
    and obtains access to all tables in the database **`nagdb`**, but may execute
    only the **`SELECT`** command there (no **`INSERT`**, no **`UPDATE`** or **`DELETE`**);
    that is, user **`nagios`** only has read access.
  prefs: []
  type: TYPE_NORMAL
- en: The test plugin **`check_mysql`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`check_mysql`** has fewer options than its PostgreSQL equivalent—apart from
    **`-H`**, it does not implement any standard flags and has neither a warning not
    a critical limit for the performance time of the test. For the database-specific
    options, it uses the same syntax as **`check_pgsql`**, except for the user entry:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This sets the host name or IP address of the database server. If the option
    **`-H`** is omitted, or if it is used in connection with the argument **`localhost`**,
    **`check_mysql`** does not set up a network connection but uses a Unix socket.
    If you want to establish an IP connection to **`localhost`**, you must explicitly
    specify the IP address **`127.0.0.1`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-P`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the TCP port on which MySQL is installed. In the default, port 3306
    is used.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`** **``*`database`*``** **`/ --database=`****``*`database`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name of the database to which the plugin should set up a connection.
    If this option is omitted, it only makes a connection to the database process,
    without addressing a specific database.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u`** **``*`user`*``** **`/ --username=`****``*`user`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the user in whose name the plugin should log in to the DBMS.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`passwd`*``** **`/ --password=`****``*`passwd`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch is used to provide the password for logging in to the database.
  prefs: []
  type: TYPE_NORMAL
- en: 'To set up a connection to the database **`nagdb`** as the user **`nagios`**,
    both parameters are passed on to the plugin:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE74]'
  prefs: []
  type: TYPE_PRE
- en: 'In contrast to PostgreSQL, with MySQL you can also make contact without establishing
    a connection to a specific database:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE75]'
  prefs: []
  type: TYPE_PRE
- en: 'With a manual connection to the database, with **`mysql`**, you can then subsequently
    change to the desired database, using the MySQL command **`use`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE76]'
  prefs: []
  type: TYPE_PRE
- en: With this plugin, a subsequent database change is not possible. Here you must
    decide from the beginning whether you want to contact a database or whether you
    just want to establish a connection to the MySQL database system.
  prefs: []
  type: TYPE_NORMAL
- en: 'To test a **`nagdb`** database set up explicitly for this purpose, you can
    do without parameters when creating the corresponding command object, and explicitly
    specify both user and database:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE77]'
  prefs: []
  type: TYPE_PRE
- en: 'This simplifies the service definition:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE78]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[62](#CHP-6-FN-15)]) The plugin **`check_oracle`** assumes the installation
    of an Oracle Full Client on the Nagios server; it does not work together with
    the Instant Client and expects its users to have an extensive knowledge of Oracle.
    To explain all this here is far beyond the scope of this book.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[63](#CHP-6-FN-16)]) [http://www.nagiosexchange.org/153;3](http://www.nagiosexchange.org/153;3)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[64](#CHP-6-FN-17)]) Permissions in PostgreSQL are given by the database
    command **`GRANT`**.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[65](#CHP-6-FN-18)]) [http://www.lysator.liu.se/~pen/pidentd/](http://www.lysator.liu.se/~pen/pidentd/).
  prefs: []
  type: TYPE_NORMAL
- en: ^([[66](#CHP-6-FN-19)]) To be found at [http://dev.mysql.com/doc/mysql/de/Security.html](http://dev.mysql.com/doc/mysql/de/Security.html).
  prefs: []
  type: TYPE_NORMAL
- en: 6.9 Monitoring LDAP Directory Services
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'For monitoring LDAP directory services, the **`check_ldap`** plugin is available.
    It runs a search query that can be specified anonymously or with authentication.
    It has the following parameters to do this:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name or IP address of the LDAP server.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-b`** **``*`base_dn`*``** **`/ --base=`****``*`base_dn`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This is the top element (*Base Domain Name*) of the LDAP directory, formed
    for example from the components of the domain name: **`dc=swobspace,dc=de`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the port on which the LDAP server is running. The default is the standard
    port 389.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-a`** **``*`"ldap-attribute"`*``** **`/ --attr=`****``*`"ldap-attribute"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch enables a search according to specific attributes. Thus **`-a "(objectclass=inetOrgPerson)"`**
    searches for all nodes in the directory tree containing the object class **`inetOrgPerson`**
    (normally used for telephone and e-mail directories, for example).
  prefs: []
  type: TYPE_NORMAL
- en: Specifying attributes in the check is less useful than it may seem. If you search
    through an LDAP directory for nonexistent attributes, you will normally receive
    an answer with zero results, but no errors.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-D`** **``*`ldap_bind_dn`*``** **`/ --bin.d=`****``*`ldap_bind_dn`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This specifies a bind DN^([[67](#ftn.CHP-6-FN-20)]) for an authenticated connection,
    such as:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE79]'
  prefs: []
  type: TYPE_PRE
- en: Without this entry, the plugin establishes an anonymous connection.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-P`** **``*`ldap_passwd`*``** **`/ --pass=`****``*`ldap_passwd`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the password for an authenticated connection. It only makes sense in
    conjunction with the option **`-D`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds have expired (**`10`** seconds if this option
    is not given), the plugin stops the test and returns the CRITICAL status.
  prefs: []
  type: TYPE_NORMAL
- en: '**`−2`** **`/ --ver2`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Use LDAP version v2 (the default). If the server does not support this protocol
    version, the connection will fail. In OpenLDAP from version 2.1, v3 is used by
    default; to activate protocol version v2, the following line is entered in the
    configuration file **`slapd.conf`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE80]'
  prefs: []
  type: TYPE_PRE
- en: Many clients, such as Mozilla and the Thunderbird address book, are still using
    LDAP version v2.
  prefs: []
  type: TYPE_NORMAL
- en: '**`−3 / --ver3`**'
  prefs: []
  type: TYPE_NORMAL
- en: Use LDAP version v3\. For many modern LDAP servers such as Open-LDAP, this is
    now the standard, but they usually also have parallel support for the older version
    v2, since various clients cannot yet implement v3.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`floating_point_dec`*``** **`/ --warning=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the performance time of the plugin exceeds **``*`floating_point_dec`*``**
    seconds, it issues a warning.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`floating_point_dec`*``** **`/ --critical=`****``*`floating_point_dec`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the performance time of the plugin exceeds **``*`floating_point_dec`*``**
    seconds, it returns CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-T`** **`/ --starttls`**'
  prefs: []
  type: TYPE_NORMAL
- en: Uses the STARTTLS intended in LDAPv3.^([[68](#ftn.CHP-6-FN-21)])
  prefs: []
  type: TYPE_NORMAL
- en: '**`-S`** **`/ --ssl`**'
  prefs: []
  type: TYPE_NORMAL
- en: Uses SSL encrypted LDAP (LDAPS) from LDAPv2 and at the same time sets the port
    used for this, port 636\. Whenever possible you should choose STARTTLS. LDAP with
    STARTTLS uses the same port as LDAP without SSL encryption; in many cases this
    allows the unencrypted LDAP access to be configured as a fallback for LDAP with
    STARTTLS. Such a fallback is not possible for LDAPS due to the different ports.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the simplest case it is sufficient to query whether the LDAP server really
    does own the base DN specified with **`-b`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE81]'
  prefs: []
  type: TYPE_PRE
- en: 'This query corresponds to the following command object:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE82]'
  prefs: []
  type: TYPE_PRE
- en: 'Since an LDAP server can handle many LDAP directories with different base DNs,
    it is recommended that you configure this with parameters:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE83]'
  prefs: []
  type: TYPE_PRE
- en: 'If authentication is involved, things get slightly more complicated. On the
    one hand the plugin is given the bind-DN of the **`nagios`** user, with **`-D`**.
    On the other hand, the following example protects the necessary password from
    curious onlookers by storing this as the macro **`$USER3$`** in the file **`resource.cfg`**,
    which may be readable only for the user **`nagios`** (see [2.14 The Resources
    File resource.cfg](../Text/ch02s14.html "2.14 The Resources File resource.cfg"),
    page 79):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE84]'
  prefs: []
  type: TYPE_PRE
- en: 'Accordingly, the matching service definition contains the base DN and bind
    DN as arguments, but not the password:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE85]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[67](#CHP-6-FN-20)]) A bind DN serves to identify the user and refers to
    the user's nodes in the directory tree, specifying all the overlying nodes. The
    bind DN in LDAP corresponds in its function more or less to the user name when
    logging in under Unix.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[68](#CHP-6-FN-21)]) See footnote in [6.3.2 POP and IMAP](../Text/ch06s03.html#pop_and_imap
    "6.3.2 POP and IMAP").
  prefs: []
  type: TYPE_NORMAL
- en: 6.10 Checking a DHCP Server
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To monitor DHCP services, the plugin **`check_dhcp`** is available. It sends
    a **`DHCPDISCOVER`** via UDP broadcast to the target port 67 and waits for an
    offer from a DHCP server in the form of a **`DHCPOFFER`**, which offers an IP
    address and further configuration information.
  prefs: []
  type: TYPE_NORMAL
- en: Because **`check_dhcp`** does not send a **`DHCPREQUEST`** after this, the server
    does not need to reserve the sources and to confirm this reservation with **`DHCPACK`**,
    nor does it need to reject the request with **`DHCPNACK`**.
  prefs: []
  type: TYPE_NORMAL
- en: Granting the plugin **`root`** permissions
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Granting the plugin **`root`** permissions
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'There is a further restriction to the **`check_dhcp`**: it requires full access
    to the network interface and must therefore run with **`root`** privileges.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In order for the user **`nagios`** to be able to run the plugin with **`root`**
    permissions, the plugin must belong to the user **`root`** and the SUID bit must
    be set. If you install the plugins from a current tarball, the permissions will
    be set correctly. Several distributions disable the SUID bit, as it represents
    a potential danger—it is possible that general **`root`** permissions may slip
    in via buffer overflows in uncleanly programmed code. Here the program owner must
    be changed manually to the user **`root`** so that the SUID bit can be set with
    **`chmod`**. When this is done, only the group **`nagios`**, apart from **`root`**,
    is allowed to run the plugin:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE86]'
  prefs: []
  type: TYPE_PRE
- en: The **`chown`** command assigns the plugin to the user **`root`** and to the
    group **`nagios`**, to whom nobody else should belong apart from the user **`nagios`**
    itself. (The user in whose name the Web server is running should be a member of
    a different group, such as **`nagcmd`**, as is described in [Chapter 1](../Text/ch01.html
    "Chapter 1. Installation") from page 37.)
  prefs: []
  type: TYPE_NORMAL
- en: In addition the **`chmod`** ensures that nobody apart from **`root`** may even
    read the plugin file, let alone edit it.
  prefs: []
  type: TYPE_NORMAL
- en: Applying the plugin
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '**`check_dhcp`** only the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s`** **``*`server_ip`*``** **`/ --serverip=`****``*`server_ip`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the IP address of a DHCP server that the plugin should explicitly query.
    Without this entry, it is sufficient to have a functioning DHCP server in the
    network to pass the test satisfactorily. So you have to decide whether you want
    to test the general availability of the DHCP service or the functionality of a
    specific DHCP server.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** **``*`requested_ip`*``** **`/ --requestedip=`****``*`requested_ip`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: With this option the plugin attempts to obtain the IP address **``*`requested_ip`*``**
    from the server. If this is not successful because it is already reserved or lies
    outside the configured area, **`check_dhcp`** reacts with a warning.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-i`** **``*`interface`*``** **`/ --interface=`****``*`interface`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This selects a specific network interface through which the DHCP request should
    pass. Without this parameter, the plugin always uses the first network card to
    be configured (in Linux, usually **`ethO`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-m`** **``*`mac_address`*``** **`/ -mac=`****``*`mac_address`*``** (from
    version 1.4.10)'
  prefs: []
  type: TYPE_NORMAL
- en: Uses the specified MAC address in DHCP queries instead of that of the Nagios
    server. This explicit detail is required if the DHCP server only assigns IP addresses
    to specific MAC addresses, and the MAC address of the Nagios server is not one
    of these.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u`** **`/ --unicast`** (from version 1.4.10)'
  prefs: []
  type: TYPE_NORMAL
- en: Sends a unicast message instead of a broadcast.^([[69](#ftn.CHP-6-FN-22)]) The
    IP address to which the DHCP request is addressed is specified with **`-s`** **``*`server_ip`*``**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **`10`** seconds have expired (the default), otherwise **``*`timeout`*``**
    seconds, the plugin stops the test and returns the CRITICAL state.
  prefs: []
  type: TYPE_NORMAL
- en: With a configurable warning or critical limit for the performance time, the
    plugin is of no use. Here you must, where necessary, explicitly set a timeout,
    which causes the CRITICAL return value to be issued.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example shows that the DHCP service in the network is working:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE87]'
  prefs: []
  type: TYPE_PRE
- en: The plugin includes only the **``*`lease time`*``** as additional information,
    that is, the time for which the client would be assigned an IP address. If you
    want to see all the information contained in **`DHCPOFFER`**, you should use the
    option **`-v`** ("verbose").
  prefs: []
  type: TYPE_NORMAL
- en: 'In the next example the plugin explicitly requests a specific IP address (**`192.168.1.40`**),
    but this is not available:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE88]'
  prefs: []
  type: TYPE_PRE
- en: The result is a WARNING, as is shown by the output of the status, with **`$?`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you want to test both the availability of the DHCP service overall and the
    servers in question individually, you need two different commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE89]'
  prefs: []
  type: TYPE_PRE
- en: '**`check_dhcp_service`** grills the DHCP service as a whole by sending a broadcast,
    to which any DHCP server at all may respond.'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE90]'
  prefs: []
  type: TYPE_PRE
- en: '**`check_dhcp_server`** on the other hand explicitly tests the DHCP service
    on a specific server.'
  prefs: []
  type: TYPE_NORMAL
- en: 'To match this, you can then define one service that monitors DHCP as a whole
    and another one that tests DHCP for a specific host. Even if the first variation
    is in principle not host-specific, it still needs to be assigned explicitly to
    a computer for it to run in Nagios:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE91]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[69](#CHP-6-FN-22)]) A unicast message is addressed to exactly one IP address,
    whereas a broadcast message is meant for all stations in the local network.
  prefs: []
  type: TYPE_NORMAL
- en: 6.11 Monitoring UPS with the Network UPS Tools
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'There are two possibilities for monitoring uninterruptible power supplies (UPS):
    the *Network UPS Tools* support nearly all standard devices. The **`apcupsd`**
    daemon is specifically tailored to UPS''s from the company APC, described in [7.10
    Monitoring UPSs with apcupsd](../Text/ch07s10.html "7.10 Monitoring UPSs with
    apcupsd") from page 182\. The plugin **`check_ups`** included in Nagios only supports
    the first implementation.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The following rule generally applies: no plugin directly accesses the UPS interface.
    Rather they rely on a corresponding daemon that monitors the UPS and provides
    status information. This daemon primarily serves the purpose of shutting down
    the connected servers in time in case of a power failure. But it also always provides
    status information, which plugins can query and which can be processed by Nagios.'
  prefs: []
  type: TYPE_NORMAL
- en: Both the solution with the Network UPS Tools and that with **`apcupsd`** are
    fundamentally network-capable, that is, the daemon is always queried via TCP/IP
    (through a proprietary protocol, or alternatively SNMP). But you should be aware
    here that a power failure may affect the transmission path, so that the corresponding
    information might no longer even reach Nagios. Monitoring via the network therefore
    makes sense only if the entire network path is safeguarded properly against power
    failure. In the ideal scenario, the UPS is connected directly to the Nagios server.
    Calling the **`check_ups`** plugin is no different in this case from that for
    the network configuration, since even for local use it communicates via TCP/IP—but
    in this case, with the host **`localhost`**.
  prefs: []
  type: TYPE_NORMAL
- en: The Network UPS Tools
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The Network UPS Tools
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The Network UPS Tools is a manufacturer-independent package containing tools
    for monitoring uninterruptible power supplies. Different specific drivers take
    care of hardware access, so that new power supplies can be easily supported, provided
    their protocols are known.
  prefs: []
  type: TYPE_NORMAL
- en: 'The remaining functionality is also spread across various programs: while the
    daemon **`upsd`** provides information, the program **`upsmon`** shuts down the
    computers supplied by the UPS in a controlled manner. It takes care both of machines
    connected via serial interface to the UPS and, in client/ server mode, of computers
    supplied via the network.'
  prefs: []
  type: TYPE_NORMAL
- en: '[http://www.networkupstools.org/](http://www.networkupstools.org/) lists the
    currently supported models and provides further information on the topic of UPS.
    Standard distributions already contain the software, but not always with package
    names that are very obvious: in SuSE and Debian they are known by the name of
    **`nut`**.'
  prefs: []
  type: TYPE_NORMAL
- en: To query the information provided by the daemon **`upsd`**, there is the **`check_ups`**
    plugin from the Nagios Plugin package. It queries the status of the UPS through
    the network UPS Tools' own network protocol. A subproject also allows it to query
    the power supplies via SNMP.^([[70](#ftn.CHP-6-FN-23)]) However, further development
    on it is not taking place at the present time.
  prefs: []
  type: TYPE_NORMAL
- en: For purely monitoring purposes via Nagios (without shutting down the computer
    automatically, depending on the test result), it is sufficient to configure and
    start the **`upsd`** on the host to which the UPS is connected via serial cable.
    The relevant configuration file in the directory **`/etc/nut`** is called **`ups.conf`**.
    If you perform the query via the network, you must normally add an entry for the
    Nagios server in the (IP-based) access permissions. Detailed information can be
    found directly in the files themselves or in the documentation included, which
    in Debian is in the directory **`/usr/share/doc/nut`**, and in SuSE, in **`/usr/share/doc/packages/nut`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'Provided that the Network UPS Tools include a suitable driver for the uninterruptable
    power supply used, the driver and communication interface are entered in the file
    **`ups.conf`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE92]'
  prefs: []
  type: TYPE_PRE
- en: 'In the example, a UPS of the company APC is used. Communication takes place
    on the serial interface **`/dev/ttySO`**. A name for the UPS is given in square
    brackets, with which it is addressed later on: **`desc`** can be used to describe
    the intended purpose of the UPS in more detail, but Nagios ignores this.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Next you must ensure that the user with whose permissions the Network UPS Tools
    are running (such as the user **`nut`** from the group **`nut`**) has full access
    to the interface **`/dev/ttySO`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE93]'
  prefs: []
  type: TYPE_PRE
- en: 'In order for Nagios to access information from the UPS via the **`upsd`** daemon,
    corresponding data is entered in an Access Control List in the **`upsd`** configuration
    file **`upsd.conf`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE94]'
  prefs: []
  type: TYPE_PRE
- en: 'With the keyword **`ACL`** you first define hosts and network ranges with their
    IP address. You must always specify a network block here: **`/32`** means that
    all 32 bits of the netmask are set to 1 (this corresponds to 255.255.255.255),
    which is therefore a single host address. It is not sufficient just to specify
    the IP address here.'
  prefs: []
  type: TYPE_NORMAL
- en: An **`ACCEPT`** entry allows access for the computer specified in the ACL **``*`acl-name`*``**.
    **`ACCEPT`** rules may be used more than once. The final **`REJECT`** entry then
    refuses access to all other hosts.
  prefs: []
  type: TYPE_NORMAL
- en: To conclude the configuration, you should make sure that the UPS daemon is started
    with every system start. In SuSE this is done via YaST2; in Debian this is taken
    care of during the installation.
  prefs: []
  type: TYPE_NORMAL
- en: The check_ups plugin
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The monitoring plugin itself has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the computer on which **`upsd`** is installed.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u`** **``*`identifier`*``** **`/ --ups=`****``*`identifier`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name for the UPS in **`ups.conf`**, specified in square brackets.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the number of the port on which the **`upsd`** is running. The default
    is TCP port 3493.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`whole_number`*``** **`/ --warning=`****``*`whole_number`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This switch defines a warning limit as a whole number. If no variable is given
    (see **`-v`**), **``*`whole_number`*``** means a response time in seconds; otherwise
    the value range of the variable (e.g., **`80`** for 80% in **`BATTPCT`**). Specifying
    multiple warning limits is currently not possible: the plugin then only uses the
    last variable and the last warning limit.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`whole_number`*``** **`/ --critical=`****``*`whole_number`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This option specifies a critical limit in connection with a variable (see **`-v`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-v`** **``*`variable`*``** **`/ --variable=`****``*`variable`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'With this option, specific values of the UPS can be queried. The limit values
    then referred to this parameter. **`check_ups`** currently supports only the following
    variables:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`LINE:`**'
  prefs: []
  type: TYPE_NORMAL
- en: input voltage of the UPS.
  prefs: []
  type: TYPE_NORMAL
- en: '**`TEMP:`**'
  prefs: []
  type: TYPE_NORMAL
- en: Temperature of the USV.
  prefs: []
  type: TYPE_NORMAL
- en: '**`BATTPCT:`**'
  prefs: []
  type: TYPE_NORMAL
- en: Remaining battery capacity in percent.
  prefs: []
  type: TYPE_NORMAL
- en: '**`LOADPCT:`**'
  prefs: []
  type: TYPE_NORMAL
- en: Load on the UPS in percent.
  prefs: []
  type: TYPE_NORMAL
- en: If this option is missing, the plugin only checks the status of the UPS (online
    or offline).
  prefs: []
  type: TYPE_NORMAL
- en: Since **`-v`** thus has another value, **`check_ups`** does not know the obligatory
    option **`--verbose`** (see [Table 6-2](../Text/ch06.html#standard_options_of_plugins
    "Table 6-2. Standard options of plugins") in page 108), even in its long form.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-T /--temperature`**'
  prefs: []
  type: TYPE_NORMAL
- en: This command issues temperature values in degrees Celsius instead of Fahrenheit.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds have expired, the plugin stops the test and
    returns the CRITICAL state. The default is **`10`** seconds.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example tests the above defined local UPS with the name **`upsfw`**.
    The **`-T`** switch ensures that the output of the temperature is given in degrees
    Celsius:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE95]'
  prefs: []
  type: TYPE_PRE
- en: If a variable is not used, the plugin returns a CRITICAL if the UPS is switched
    off (**`Status=Off`**) or has reached low battery capacity (**`Status=0n Battery,
    Low Battery`**). **`check_ups`** issues a warning if at least one of the three
    states **`On Battery`**, **`Low Battery`**, or **`Replace Battery`** applies,
    but this is not sufficient for a CRITICAL status (for example, because of correspondingly
    set variables). With **`On Battery`** the power supply is provided by the battery,
    with **`Low Battery`** the UPS is online with a low battery state, and with **`Replace
    Battery`**, the battery must be replaced.
  prefs: []
  type: TYPE_NORMAL
- en: 'If none of these points apply, the plugin issues an OK for the following states:'
  prefs: []
  type: TYPE_NORMAL
- en: In the normal **`online`** state
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the UPS is being calibrated (**`Calibrating`**)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If it is currently being bypassed and the power supply is provided directly
    from the power supply grid (**`On Bypass`**)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the UPS is overloaded (**`Overload`**)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the voltage in the power grid is too high and the UPS restricts the voltage
    to the normal value (**`Trimming`**)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the voltage in the power grid is too low and is supplemented by the UPS (**`Boosting`**)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the UPS is currently being charged (**`Charging`**)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the UPS is currently being discharged (e.g., during a programmed maintenance
    procedure) (**`Discharging`**)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Transformed into a command object, the above test for any host looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE96]'
  prefs: []
  type: TYPE_PRE
- en: 'The corresponding service definition for the computer **`linux01`**, to which
    the UPS is connected, and for the above defined UPS **`upsfw`**, would then look
    like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE97]'
  prefs: []
  type: TYPE_PRE
- en: 'If **`check_ups`** is to determine the UPS status by means of the current load,
    the relevant information is taken from the variable **`LOADPCT`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE98]'
  prefs: []
  type: TYPE_PRE
- en: With 61 percent, the UPS has a heavier load than specified in the limit value
    **`-w`**, but it does not yet reach the critical area above 80 percent, so there
    is just a warning. If two error criteria occur, such as a warning limit for a
    queried variable being exceeded and a critical state simultaneously, because the
    UPS is losing power (**`On Battery`** and **`Low Battery`** simultaneously), the
    most critical state has priority for the return value of the plugin, so here,
    **`check_ups`** would return CRITICAL, and not the WARNING which results from
    the query of **`LOADPCT`**.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[70](#CHP-6-FN-23)]) [http://eul.networkupstools.org/server-projects/](http://eul.networkupstools.org/server-projects/)
  prefs: []
  type: TYPE_NORMAL
- en: 6.12 Health Check of an NTP Server with **`check_ntp_peer`**
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The plugin **`check_ntp_peer`**, which is included from plugin version 1.4.11,
    tests the quality of an NTP server. If you want to check the time deviation of
    a local server against an NTP server, you need to use the plugin **`check_ntp_time`**,
    described in [7.7.1 Checking the system time via NTP](../Text/ch07s07.html#checking_the_system_time_via_ntp
    "7.7.1 Checking the system time via NTP") in page 177.
  prefs: []
  type: TYPE_NORMAL
- en: 'Several parameters characterize the quality: the *offset* describes the time
    difference from other NTP servers (the reference servers). *Jitter* is a measurement
    of the fluctuations in the packet delay to a remote reference server, and *stratum*
    specifies the topological distance from the next atomic clock. Stratum 0 is the
    atomic clock itself, stratum 1 refers to an NTP server directly connected to an
    atomic clock. Stratum 2 is an NTP server that obtains its time from an NTP server
    with stratum 1\. The further an NTP server is away from the atomic clock, the
    higher the stratum value. The imprecision of the server also increases the higher
    this value is.'
  prefs: []
  type: TYPE_NORMAL
- en: 'These parameters can also be queried with the program **`ntpq`**, by giving
    the IP address of the NTP server. The option **`-p`** reveals the reference server
    from which the queried NTP server obtains its time details. The option **`-n`**
    prevents name resolution on the reference servers, thus accelerating the execution
    of **`ntpq`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE99]'
  prefs: []
  type: TYPE_PRE
- en: The **`remote`** column specifies the reference server that uses the queried
    NTP server. **`127.127.1.1`** here is a special case, and stands for the local
    system clock. The stratum value (column **`st`**), with **`10`**, is relatively
    high, but the local system clock only plays a role if no other NTP source can
    is reachable. The other two quality parameters, offset and jitter, are located
    in the last two columns.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the simplest case you can run **`check_ntp_peer`**, specifying only the
    NTP server to be checked (option **`-H`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE100]'
  prefs: []
  type: TYPE_PRE
- en: 'Without further details the plugin checks the time deviation from the reference
    servers, and the stratum and jitter are not taken into account. All threshold
    details from **`check_ntp_peer`** are specified in the format described in [24.1.5
    Specifying thresholds](../Text/ch24.html#specifying_thresholds "24.1.5 Specifying
    thresholds") from page 557\. The plugin has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ -host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name or IP address of the NTP server to be checked.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the UDP port on which the NTP server is listening. The default is port
    **`123`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-q`** **`/--quiet`**'
  prefs: []
  type: TYPE_NORMAL
- en: This returns UNKNOWN instead of WARNING or CRITICAL if the NTP server is not
    synchronized.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`threshold`*``** **`/ -warning=`****``*`threshold`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the warning threshold for the time deviation. A warning is issued if
    the time deviation between the NTP server and at least one of the reference servers
    is greater than the specified number of seconds. The default is **`60`** seconds.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`seconds`*``** **`/ -critical=`****``*`seconds`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This is the critical threshold for the time deviation. If the time of one of
    the reference servers used deviates by more than **``*`seconds`*``** seconds (in
    the default: **`120`**) from that of the NTP server, the state becomes CRITICAL.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-W`** **``*`threshold`*``** **`/ -swarn=`****``*`threshold`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the warning threshold based on the stratum value. A warning is issued
    if no reference server is available whose stratum value matches the specified
    threshold. This means that **`-W 1:2`** causes a WARNING if no reference server
    is available with stratum 1 or stratum 2\. Without the detail of this parameter
    the stratum value is not included in the check.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`threshold`*``** **`/ -scrit=`****``*`threshold`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the critical threshold based on the stratum value. See **`-W`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-j`** **``*`threshold`*``** **`/ -jwarn=`****``*`threshold`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the warning threshold for the jitter in milliseconds, given in the threshold
    format. The plugin returns OK if at least one reference server displays a jitter
    within the specified range. If this option is not given, the jitter is not included
    in the evaluation; there is no default.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-k`** **``*`threshold`*``** **`/ -jcrit=`****``*`threshold`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the critical threshold for the jitter in milliseconds in the threshold
    format.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 7. Testing Local Resources
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The plugins introduced in this chapter, originating from the **`nagios-plugins`**
    package,^([[71](#ftn.CHP-7-FN-1)]) test local resources that do not have their
    own network protocol and therefore cannot be easily queried over the network.
    They must therefore be locally installed on the computer to be tested. Such plugins
    on the Nagios server can test only the server itself—with command and service
    definitions as described in [Chapter 6](../Text/ch06.html "Chapter 6. Plugins
    for Network Services").
  prefs: []
  type: TYPE_NORMAL
- en: 'To perform such local tests from a central Nagios server on remote hosts, you
    require further utilities: the plugins are started via a secure shell, or you
    use the *Nagios Remote Plugin Executor* (NRPE). Using the secure shell is described
    in [Chapter 9](../Text/ch09.html "Chapter 9. Executing Plugins via SSH") from
    page 205, and [Chapter 10](../Text/ch10.html "Chapter 10. The Nagios Remote Plugin
    Executor (NRPE)") (page 213) is devoted to NRPE.'
  prefs: []
  type: TYPE_NORMAL
- en: The definition of command and service depends on the choice of mechanism. If
    you want to test for free hard drive capacity with the **`check_by_ssh`** plugin
    installed on the Nagios server, which remotely calls **`check_disk`** on the target
    server (see [Chapter 7](../Text/ch07.html "Chapter 7. Testing Local Resources"),
    page 157), then a special command definition is required for this, which differs
    somewhat from the definitions given in [Chapter 6](../Text/ch06.html "Chapter 6. Plugins
    for Network Services") (page 105). What command and service definitions for remotely
    executed local plugins look like is described in the aforementioned chapters on
    NRPE and SSH.
  prefs: []
  type: TYPE_NORMAL
- en: For the remote query of some local resources you can also use SNMP (see [Chapter 11](../Text/ch11.html
    "Chapter 11. Collecting Information Relevant for Monitoring with SNMP") from page
    227), but the checks are then restricted to the capabilities of the SNMP daemon
    used. Local plugins are usually more flexible here and provide more options for
    querying.
  prefs: []
  type: TYPE_NORMAL
- en: 7.1 Free Hard Drive Capacity
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The question of when the hard drive(s) of a computer may threaten to overflow
    is answered by the **`check_disk`** plugin. It has the following options for specifying
    thresholds:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`limit`*``** /**`--warning=`****``*`limit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The plugin will give a warning if the free hard drive capacity drops below this
    limit, expressed as a percentage or as an integer. If you specify percentage,
    the percent sign **`%`** must also be included; floating point decimals such as
    **`12.5%`** are possible. Integer values represent the absolute free space in
    the unit that defines the **`--units`** switch. The default is **`--units=MB`**,
    or megabytes.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`limit`*``** / **`--critical=`****``*`limit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the free hard drive capacity level falls below this as a percentage or integer
    (see **`-w`**), **`check_disk`** displays the CRITICAL status. The critical limit
    must be smaller than the warning limit.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-W`** **``*`limit`*``** / **`-iwarning=`****``*`limit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The number of free inodes in the file system as a percentage; **`check_ disk`**
    issues a warning if this drops below the limit.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-K`** **``*`limit`*``** / **`-icritical=`****``*`limit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Like **`-W`**, except that this is the critical threshold.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u`** **``*`unit`*``** / **`--units=`****``*`unit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: In what unit do you specify integer limit values? **`kB`**, **`MB`**, **`GB`**,
    and **`TB`** are all possible.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-k`** / **`--kilobytes`**'
  prefs: []
  type: TYPE_NORMAL
- en: With this switch, limit values given as whole numbers with **`-c`** and **`-w`**
    are to be interpreted as KB. This is the same as **`--units=kB`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-m`** / **`--megabytes`**'
  prefs: []
  type: TYPE_NORMAL
- en: With this switch, whole number limit values with **`-c`** and **`-w`** are interpreted
    by the plugin as MB (the default). This is the same as **`--units=MB`**.
  prefs: []
  type: TYPE_NORMAL
- en: Before one of the following path selectors is specified, at least one threshold
    must be given (**`-w`**, **`-c`**, **`-W`**, or **`-K`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`path_or_partition`*``** / **`--path=`****``*`path`*``** or **`--partition=`****``*`partitioin`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the root directory in file systems or the physical device in
    partitions (e.g., **`/dev/sda5`**). From version 1.4 **`-p`** can be called multiple
    times. If the path is not specified, the plugin tests all file systems (see also
    **`-x`** and **`-X`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-E`** / **`--exact-match`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This demands that the root of the file system is included for all paths or
    partitions specified with **`-p`**, otherwise the plugin will issue an error:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE101]'
  prefs: []
  type: TYPE_PRE
- en: '**`/usr/local`** is not a file system, but a directory within the **`/usr`**
    file system on the partition **`/dev/md2`**. If you call the plugin with the switches
    **`-p /usr/local`** and **`-E`**, you will receive an error, since **`/usr/local`**
    is not itself the root of the file system as required by **`-E`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE102]'
  prefs: []
  type: TYPE_PRE
- en: '**`-x`** **``*`path`*``** / **`--exclude_device=`****``*`path`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch excludes the mount point specified as **``*`path`*``** from the
    test. This option assumes that paths are specified with **`-p`** and that they
    may be run in a plugin call multiple times.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-X`** **``*`fs_typ`*``** / **`--exclude-type=`****``*`fs_typ`*``** (from
    1.4)'
  prefs: []
  type: TYPE_NORMAL
- en: This switch excludes a specific file system type from the test. It is given
    the same abbreviation as in the **`-t`** option of the **`mount`** command. In
    this way **`fs_type`** can take the values **`ext3`**, **`reiserfs`**, or **`proc`**,
    for example (see also **`man 8 mount`**). This option can be used several times
    in a plugin command.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-R`** **``*`regexp`*``** / **`--eregi-path=`****``*`regexp`*``**,**`--eregi-partition=`****``*`regexp`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'From version 1.4.8: a regular expression that selects all paths or partitions
    with which it matches. Upper/lower case is ignored here. The following example
    checks all partitions that end with **`mdO`** thru **`md2`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE103]'
  prefs: []
  type: TYPE_PRE
- en: The swap partition **`/dev/mdl`** is ignored here.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** **``*`regexp`*``** / **`--ereg-path=`****``*`regexp`*``**, **`--ereg-partition=`****``*`regexp`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'From version 1.4.8: a regular expression to check partitions and/or paths.
    Like **`-R`**, except that it is now case-sensitive.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-A`** / **`--all`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'From version 1.4.10: checks all partitions and file systems. The equivalent
    of **`-R ''.*''`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-I`** **``*`regexp`*``** / **`--ignore-eregi-path=`****``*`regexp`*``**,
    **`--ignore-eregi-partition=`****``*`regexp`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'From version 1.4.10: a regular expression that excludes paths or partitions
    that match it from the check. Upper/lower case is ignored.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-i`** **``*`regexp`*``** / **`--ignore-ereg-path=`****``*`regexp`*``**,
    **`--ignore-ereg-partition=`****``*`regexp`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'From version 1.4.10: like **`-I`**, except that it is now case-sensitive.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In addition the plugin has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-e`** / **`--errors-only`**'
  prefs: []
  type: TYPE_NORMAL
- en: With this switch, the plugin shows only the file systems or partitions that
    are in a WARNING or CRITICAL state.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-M`** / **`--mountpoint`**'
  prefs: []
  type: TYPE_NORMAL
- en: From version 1.4 on, **`check_disk`** by default displays the file system path
    (e.g., **`/usr`**). With **`-M`** you are told instead what physical device (e.g.,
    **`/dev/sda5`**) is involved.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** / **`--clear`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'From version 1.4 on, **`-p`** can be used multiple times. If you want to test
    several file systems at the same time, but using different limit values, **`-C`**
    can be used to delete old limit values that have been set:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE104]'
  prefs: []
  type: TYPE_PRE
- en: 'The order is important here: the limit values are valid for the file system
    details until they are reset with **`-C`**. Then new limits must be set with **`-w`**
    and **`-c`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`−1`** / **`--local`**'
  prefs: []
  type: TYPE_NORMAL
- en: Only checks local file systems, others-file systems mounted via NFS, for example-are
    ignored.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-L`** / **`--stat-remote-fs`** (ab Version 1.4.10)'
  prefs: []
  type: TYPE_NORMAL
- en: Checks local file systems for the specified thresholds, but checks network file
    systems only for availability. With this switch you can test, for example, whether
    a *stale file handle* exists for a path connected via NFS.^([[72](#ftn.CHP-7-FN-2)])
  prefs: []
  type: TYPE_NORMAL
- en: '**`-g`** **``*`group_name`*``** / **`--group-type=`****``*`group_name`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Refers to the thresholds of the sum of all specified partitions and paths.
    Without this switch the plugin compares each path and each partition separately
    with the thresholds. **`-g`** requires a name to be given, which the plugin includes
    as additional information in the output:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE105]'
  prefs: []
  type: TYPE_PRE
- en: This option must be placed *in front of* the path specification to which it
    refers.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** / **`--timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds have expired the plugin stops the test and
    returns the CRITICAL status. The default is **`10`** seconds.
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is a somewhat more extensive example of the use of **`check_disk`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE106]'
  prefs: []
  type: TYPE_PRE
- en: Everything is in order on the file system **`/`**, **`/usr`**, and **`/var`**,
    since more space is available on them—as can be seen from the performance data—than
    the limit value of 10 percent (for a warning), and certainly more than 5 percent
    (for the critical status). The file systems **`/net/emil1/a`** and **`/net/emil1/c`**
    encompass significantly larger ranges of data, which is why the limit values are
    set lower, after the previous ones have been deleted with **`-C`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-e`** ensures that Nagios shows only the file systems that really display
    an error status. In fact the output of the plugin *before* the **`|`** sign, with
    **`/net/ emil1/c`**, only displays one single file system. The performance information
    after the pipe can only be seen on the command line—it contains all file systems
    tested, as before. This is slightly confusing, because a Nagios plugin restricts
    its output to a single line, which has been line wrapped here for this printed
    version.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[71](#CHP-7-FN-1)]) This edition is based on version 1.4.11.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[72](#CHP-7-FN-2)]) The error message **`NFS stale file handle`** indicates
    the non-availability of the NFS path.
  prefs: []
  type: TYPE_NORMAL
- en: 7.2 Utilization of the Swap Space
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The **`check_swap`** plugin tests the locally available swap space:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`limit`*``** / **`--warning=`****``*`limit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The warning limit can be specified as a percentage or as an integer, as with
    **`check_disk`**, but the integer value is specified in *bytes*, not in kilobytes!
  prefs: []
  type: TYPE_NORMAL
- en: If at least 10 percent should remain free, specify **`-c 10%`**. The integer
    specification refers to the remaining free space, too.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`limit`*``** / **`--critical=`****``*`limit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Critical limit, similar to the warning limit.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-a`** / **`--allswaps`**'
  prefs: []
  type: TYPE_NORMAL
- en: Tests the threshold values for each swap partition individually.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example tests to see whether at least half of the swap space
    is available. If there is less than 20 percent free swap space, the plugin should
    return a critical status. After the **`|`** sign the program again provides performance
    data, which is logged by Nagios but not displayed in the message on the Web interface:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE107]'
  prefs: []
  type: TYPE_PRE
- en: 7.3 Testing the System Load
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The load on a system can be seen from the number of simultaneously running
    processes, which is tested by the **`check_load`** plugin. With the help of the
    **`uptime`** program, it determines the average value for the last minute, the
    last five minutes, and the last 15 minutes. **`uptime`** displays these values
    in this sequence after the keyword **`load average`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE108]'
  prefs: []
  type: TYPE_PRE
- en: '**`check_loadhas`** only two options (the two limit values), but these can
    be specified in two different ways:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`limit`*``** / **`--warning=`****``*`limit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This option specifies the warning limit either as a simple floating point decimal
    (**`5.0`**) or as a comma-separated triplet containing three floating point decimals
    (**`10.0,8.0,5.0`**).
  prefs: []
  type: TYPE_NORMAL
- en: In the first case, the limit specified applies to all three average values.
    The plugin issues a warning if (at least) one of these is exceeded. In the second
    case the triplet allows the limit value to be specified separately for each average
    value. Here as well, **`check_load`** issues a warning as soon as one of the average
    values exceeds the limit defined for it.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`limit`*``** / **`--critical=`****``*`limit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the critical limit in the same way as **`-w`** specifies the
    warning limit. These critical limit values should be higher than the values for
    **`-w`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** / **`--percpu`** (from Version 1.4.9)'
  prefs: []
  type: TYPE_NORMAL
- en: Divides the system load determined by the number of existing CPU kernels, to
    get a better idea of the load per CPU kernel.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example Nagios would raise the alarm if more than 15 processes
    were active on average in the last minute, if more than 10 were active on average
    in the last five minutes, or if eight were active on average in the last 15 minutes.
    There is a warning for average values of ten, eight, or five processes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE109]'
  prefs: []
  type: TYPE_PRE
- en: 7.4 Monitoring Processes
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The **`check_procs`** plugin monitors processes according to various criteria.
    Usually it is used to monitor the running processes of just one single program.
    Here the upper and lower limits can also be specified.
  prefs: []
  type: TYPE_NORMAL
- en: '**`nmbd`**, for example, the name service of Samba, always runs as a daemon
    with two processes. A larger number of **nmbd** entries in the process table is
    always a sure sign of a problem; it is commonly encountered, especially in older
    Samba versions.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Services such as Nagios itself should only have one main process. This can
    be seen by the fact that its parent process has the process ID **`1`**, marking
    it as a child of the **`init`** process. It was often the case, in the development
    phase of Nagios 2.0, that several such processes were active in parallel after
    a failed restart or reload, which led to undesirable side effects. You can test
    to see whether there really is just one single Nagios main process active, as
    follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE110]'
  prefs: []
  type: TYPE_PRE
- en: 'The program to be monitored is called **`nagios`** (option **`-C`**), and its
    parent process should have the ID **`1`** (option **`-p`**). Exactly one Nagios
    process must be running, no more and no less; otherwise the plugin will issue
    a CRITICAL status. This is specified as a range: **`-c 1:1`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Another example: between one and four simultaneous processes of the OpenLDAP
    replication service **`slurpd`** should be active:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE111]'
  prefs: []
  type: TYPE_PRE
- en: If the actual process number lies between **`1`** and **`4`**, the plugin returns
    OK, as is the case here. If it finds between five and seven processes, however,
    a warning will be given. Outside this range, **`check_procs`** categorizes the
    status as CRITICAL. This is the case here if there are either no processes running
    at all, or more than seven running.
  prefs: []
  type: TYPE_NORMAL
- en: 'Instead of the number of processes of the same program, you can also monitor
    the CPU load caused by it, its use of memory, or even the CPU runtime used. **`check_procs`**
    has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`start: end`*``** / **`--warning=`****``*`start: end`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'The plugin issues a warning if the actual values lie *outside* the range specified
    by the start and end value. Without further details, it assumes that it should
    count processes: **`-w 2:10`** means that **`check_ procs`** gives a warning if
    it finds less than two or more than ten processes.'
  prefs: []
  type: TYPE_NORMAL
- en: If you omit one of the two limit values, zero applies as the lower value, or
    infinite as the upper limit. This means that the range **`:10`** is identical
    to **`0:10; 10:`** describes any number larger than or equal to 10\. If you just
    enter a single whole number instead of a range, this represents the maximum. The
    entry **`5`** therefore stands for **`0:5`**.
  prefs: []
  type: TYPE_NORMAL
- en: If you swap the maximum and minimum, the plugin will give a warning if the actual
    value lies *within* the range, so for **`-w 10:5`** this will be if the value
    is 5, 6, 7, 8, 9, or 10\. You may always specify only one interval.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`start : end`*``** / **`--critical=`****``*`start : end`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the critical range, in the same way as for the warning limit.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-m`** **``*`type`*``** / **`--metric=`****``*`type`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This switch selects one of the following metrics for the test:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`PROCS`**:'
  prefs: []
  type: TYPE_NORMAL
- en: number of processes (the default if no specific type is given)
  prefs: []
  type: TYPE_NORMAL
- en: '**`VSZ`**:'
  prefs: []
  type: TYPE_NORMAL
- en: the virtual size of a process in the memory *(virtual memory size)*, consisting
    of the main memory space that the process uses exclusively, plus that of the shared
    libraries used. These only take up memory space once, even if they are used by
    several different processes. The specification is given in bytes.
  prefs: []
  type: TYPE_NORMAL
- en: '**`RSS`**:'
  prefs: []
  type: TYPE_NORMAL
- en: the proportion of main memory in KB that the process actually uses for itself
    (*Resident Set Size*), that is, **`VSZ`** minus the shared memory.
  prefs: []
  type: TYPE_NORMAL
- en: '**`CPU`**:'
  prefs: []
  type: TYPE_NORMAL
- en: CPU usage in percent. The plugin here checks the CPU usage for each individual
    process for morning and critical limits. If one of the processes exceeds the warning
    limit, Nagios will issue a warning. In the text output the plugin also shows how
    many processes have exceeded the warning or critical limit.
  prefs: []
  type: TYPE_NORMAL
- en: '**`ELAPSED`**:'
  prefs: []
  type: TYPE_NORMAL
- en: The overall time that has passed since the process was started.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s`** **``*`flags`*``** / **`--state=`****``*`flags`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This restricts the test to processes with the specified status flag. ^([[73](#ftn.CHP-7-FN-3)])
    The plugin in the following example gives a warning if there is more than one
    zombie process (status flag:**`Z`**) :'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE112]'
  prefs: []
  type: TYPE_PRE
- en: Things become critical here if more than five zombies "block up" the process
    table. Several states can be queried at the same time by by adding individual
    flags together, as in **`-s DSZ`**. Now Nagios cancels the processes that are
    in at least one of the states mentioned.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`ppid`*``** / **`--ppid=`****``*`ppid`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This switch restricts the test to processes whose parent processes have the
    *parent process ID* (**``*`ppid`*``**). The only PPIDs that are known from the
    beginning, and that do not change, are 0 (started by the kernel, and usually only
    concerns the init process) and 1 (the init process itself).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-P`** **``*`pcpu`*``** / **`--pcpu=`****``*`pcpu`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This option filters processes according to the percentage of CPU they use :'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE113]'
  prefs: []
  type: TYPE_PRE
- en: The plugin in this example takes into account only processes which have at least
    a ten percent share of CPU usage. As long as there is just one such process (**`-w
    1`**), it returns OK. If there are between two and five such processes, the return
    value is a WARNING. With at least six processes, each with a CPU usage of at least
    ten percent, things get critical.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** **``*`rss`*``** / **`--rss=`****``*`rss`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This option filters out processes that occupy at least **``*`rss`*``** bytes
    of main memory. It is used like **`-P`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-z`** **``*`vsz`*``** / **`--vsz=`****``*`vsz`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This option filters out processes whose VSZ (see above) is at least **`vsz`**
    bytes. It is used like **`-P`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u`** **``*`user`*``** / **`--user=`****``*`user`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This option filters out processes that belong to the specified user (see example
    below).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-a`** **``*`"string"`*``** / **`--argument-array=`****``*`"string"`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Filters out commands whose argument list contains **``*`string`*``**. **`-a.
    tex`**, for example, refers to all processes that work with **`*. tex files`**;
    **`-a -v`** to all processess that are called with the -v flag.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`command`*``** / **`--command=`****``*`command`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This causes the process list to be searched for the specified command name.
    command must exactly match the **``*`command`*``** specified, without a path (see
    example below).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** / **`--timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds have expired, the plugin stops the test and
    returns the CRITICAL status. The default is **`10`** seconds.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example checks to see whether exactly one process called **`master`**
    is running on a mail server on which the Cyrus IMAPd is installed. No process
    is just as much an error as more than one process:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE114]'
  prefs: []
  type: TYPE_PRE
- en: 'The first attempt returns two processes, although only a single Cyrus Master
    process is running. The reason can be found if you run **`ps`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE115]'
  prefs: []
  type: TYPE_PRE
- en: 'The Postfix mail service also has a process with the same name. To keep an
    eye just on the master process of the IMAPd, the search is additionally restricted
    to processes running with the permissions of the user **`cyrus`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE116]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: '^([[73](#CHP-7-FN-3)]) The following states are possible in Linux: **`D`**
    (uninterruptible waiting, usually a *Disk Wait*), **`R`** (running process), **`S`**
    (wait status), **`T`** (process halted), **`W`** (paging, only up to kernel 2.4),
    **`X`** (a finished, killed process), and **`Z`** (zombie). Further information
    is provided by **`man ps`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 7.5 Checking Log Files
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Monitoring log files is not really part of the concept of Nagios. On the one
    hand, the syslog daemon notices critical events there immediately, so that an
    error status can be correctly determined. But if the error status continues, this
    cannot be seen in the log file in most cases.
  prefs: []
  type: TYPE_NORMAL
- en: Correspondingly the plugins described here can determine only whether other,
    new entries on error events are added. In order to communicate information on
    a continuing error behavior to Nagios via a log file, the service monitored must
    log the error status regularly—at least at the same intervals as Nagios reads
    the log file—and repeatedly. Otherwise the plugin will alternate between returning
    an error status, and then an OK status, depending on whether the (continuing)
    error has in the meantime turned up in the log or not.
  prefs: []
  type: TYPE_NORMAL
- en: Under no circumstances may Nagios repeat its test. The parameter **`max_check_attempts`**
    (see [2.3 Defining the Machines to Be Monitored, with host](../Text/ch02s03.html
    "2.3 Defining the Machines to Be Monitored, with host")) must have the value **`1`**.
    Otherwise Nagios would first assign the error status as a soft state, would repeat
    the test, and would almost always arrive at an OK, since it only takes into account
    new entries during repeat tests. **`max_check_attempts = 1`** ensures that Nagios
    diagnoses a hard state after the first test.
  prefs: []
  type: TYPE_NORMAL
- en: 'For events that log an error just once, Nagios has *volatile services*, described
    in [14.5.2 Nagios configuration: volatile services](../Text/ch14s05.html#nagios_configuration_colon_volatile_se
    "14.5.2 Nagios configuration: volatile services") from page 309\. For services
    defined in this way, the system treats every error status as if it was occurring
    for the first time (causing a message to be sent each time, for example).'
  prefs: []
  type: TYPE_NORMAL
- en: Nagios periodically performs (active) checks with the plugins introduced here.
    If the entry sought does not reoccur, the plugin returns an OK. This is desired
    in many cases, and the administrator does not need to worry about the earlier
    error event. But if an error event needs to be handled in all cases, a simple
    Nagios check is no longer sufficient, since it will be easily overlooked due to
    the OK of a subsequent check. A slightly different approach, in which an administrator
    has to explicitly confirm every error result, is introduced in [Chapter 23](../Text/ch23.html
    "Chapter 23. Processing Events with the EventDB") in page 531.
  prefs: []
  type: TYPE_NORMAL
- en: 7.5.1 The standard plugin **`check.log`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'With **`check_log`**, Nagios provides a simple plugin for monitoring log files.
    It creates a copy of the tested log file each time it is run. If the log file
    has changed since the previous call, **`check_log`** searches the newly added
    data for simple text patterns. The plugin does not have any longer options and
    just has the states OK and CRITICAL :'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-F`** **``*`logfile`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name and path of the log file to be tested. It must be readable
    for the user **`nagios`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-O`** **``*`oldlog`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name and path of the log file copy. The plugin just examines the
    difference between **``*`oldlog`*``** and **``*`logfile`*``** when it is run.
    Afterward it copies the current log file to **``*`oldlog. oldlog`*``** must contain
    the absolute path and be readable for the user **`nagios`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-q`** **``*`query`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the pattern searched for in examining the log file. Not found means
    OK; a match returns the CRITICAL status.
  prefs: []
  type: TYPE_NORMAL
- en: It is recommended that you generally do not use messages of the type *recovery
    notification* (OK after an error state).
  prefs: []
  type: TYPE_NORMAL
- en: An OK in a repeated test just means that no new error in events have occurred
    since the last test. The **`notification_options`** parameter (see [2.3 Defining
    the Machines to Be Monitored, with host](../Text/ch02s03.html "2.3 Defining the
    Machines to Be Monitored, with host")) in the service definition should therefore
    not contain an **`r`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following command examines the file **`/var/log/auth`** for failed logins
    :'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE117]'
  prefs: []
  type: TYPE_PRE
- en: This produces one hit. The plugin does not show its return value in the text,
    but it can be displayed in the shell with **`echo $?`**. In the example, a **`2`**
    for CRITICAL is returned.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you examine the log file for several different events, you must specify
    a separate **``*`oldlog`*``** for each log file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE118]'
  prefs: []
  type: TYPE_PRE
- en: 'Even if you are searching in the same original log file, you cannot avoid using
    two different **`oldlogs`**: otherwise **`check_log`** would not work correctly.'
  prefs: []
  type: TYPE_NORMAL
- en: '7.5.2 The modern variation: **`check_logs.pl`**'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: As an alternative, The Nagios Exchange^([[74](#ftn.CHP-7-FN-4)]) provides a
    completely new plugin for monitoring log files. **`check_logs.pi`** represents
    a further development of the Perl plugin **`check_log2.pl`**, which is included
    in the **`contrib`** directory for Nagios plugins but is not installed automatically.
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_logs.pl`** can examine several log files simultaneously for events,
    in contrast to **`check_log`** and **`check_log2.pl`**. It requires a configuration
    file to do this.'
  prefs: []
  type: TYPE_NORMAL
- en: It does have a simple command line mode, but this functions only if you specify
    a single log file and a single regular expression simultaneously. But the really
    interesting feature of **`check_logs.pl`** is that you can perform several examinations
    in one go. This is why we will not spend any more time describing the command
    line mode.
  prefs: []
  type: TYPE_NORMAL
- en: Initially we create a configuration file with roughly the following contents,
    preferably in the directory **`/etc/nagios:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE119]'
  prefs: []
  type: TYPE_PRE
- en: The Perl variable **`$seek_file_template`** contains the path to the file in
    which the plugin saves the current position of the last search. **`check_logs.pl`**
    remembers here at what point in the log file it should carry on searching the
    next time it is run. This means that the plugin does not require a copy of the
    processed log file. Instead of the variable **`$log_file`**, it uses the name
    of the log file to be examined in each case and creates a separate position file
    for each log file.
  prefs: []
  type: TYPE_NORMAL
- en: 'What exactly **`check_logs.pl`** is to do is defined by the Perl array **`@log_files`**.
    The entry **`file_name`** points to the log file to be tested (with the absolute
    path), and **`reg_exp`** contains the regular expression,^([[75](#ftn.CHP-7-FN-5)])
    for which **`check_logs.pl`** should search the log file. In the example above
    this is just a simple text called **`ntpd`** in the case of the **`/var/log/messages`**
    log file, but there is an alternative in the case of **`/var/log/warn`**: the
    regular expression **`(named | dhcpd)`** matches lines that contain either the
    text **`named`** or the text **`dhcpd`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The only specification that the plugin itself requires when it is run is the
    configuration file (option **`-c`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE120]'
  prefs: []
  type: TYPE_PRE
- en: 'The first command shows the basic principle: in the text output the plugin
    for each log file announces separately whether it has found a matching event or
    not. In the above example it didn''t find anything, so it returns OK. In the second
    command the plugin comes across four relevant entries in the **`warn`** log file,
    but it doesn''t find any in **`/var/log/messages`**. Because of this, the plugin
    returns a WARNING; OK is given only if no relevant events were found in any of
    the log files checked. In its output line, after **`(4):`**, the plugin remembers
    the last of the four lines found.'
  prefs: []
  type: TYPE_NORMAL
- en: '7.5.3 The Swiss Army knife: **`check_logfiles`**'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you have many requirements from a log file check and the tools introduced
    so far do not meet your needs, then you really should take a look at the plugin
    **`check_logfiles`** by Gerhard Laußer. As well as sophisticated search options,
    it can handle any rotation methods you please, so that no information will be
    lost after a rotation. Its range of functions can be extended by scripts, which
    can be used to restart applications that have crashed, to send SNMP traps, or
    send passive check results to an NSCA daemon via **`send_nsca`** ([14.4 Sending
    Test Results to the Server](../Text/ch14s04.html "14.4 Sending Test Results to
    the Server"), page 305).
  prefs: []
  type: TYPE_NORMAL
- en: 'For simple tasks the plugin can be operated easily from the command line, but
    to use it in more advanced ways you will need to have some knowledge of Perl:
    the configuration file that is needed to make use of all the features uses the
    Perl syntax.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The plugin^([[76](#ftn.CHP-7-FN-6)]) is unpacked in a suitable directory, for
    example in **`/usr/local/src`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE121]'
  prefs: []
  type: TYPE_PRE
- en: The installation is done with the three commands **`configure && make && make
    install`**. **`--with-seekf iles-dir`** specifies the directory in which **`check_logfiles`**
    writes status information, and **`--with-protocol-dir`** specifies the directory
    in which **`check_logfiles`** explicitly retains matches it has found. When doing
    this you should select a directory that is not deleted directly after every reboot.
    Logging can be switched off in the configuration, depending on the check defined.
  prefs: []
  type: TYPE_NORMAL
- en: 'On the command line, **`check_logfiles`** offers the following options :'
  prefs: []
  type: TYPE_NORMAL
- en: '**`--tag=`****``*`designator`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Indicates individual checks, to make better distinction between them. The names
    of the variables in the performance data also start with this designator, so that
    the values can later be reassigned to a check. Specifying **`--tag`** is optional,
    but the author of the plugin generally recommends its use.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--logfile=`****``*`logfile`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Specifies the name and path of the log files to be examined. **`check_logfiles`**
    takes note of the last line of the file to be considered during each check, so
    that it can continue at the same place the next time it is called. In addition,
    **`check_logfiles`** saves other information such as inode and timestamp, so that
    it can detect log file rotations.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--rotation=`****``*`rotation method`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Specifies the rotation procedure for the log file: **`loglog0log1gz`** is used
    if if you want to turn **``*`logfile`*``** into **``*`logfile.0`*``** and turn
    this into **``*`Logfile.1.gz.`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**`loglog0gzlog1gz`** means that **``*`logfile`*``** is first compressed to
    **``*`logfile. 0\. gz`*``** and is later renamed **``*`logfile.1.gz.`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**`loglogdate8gz`** states that **``*`logfile`*``** will be converted into
    **``*`logfile. YYYYMMDD.gz.`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**`loglog01og1`** describes the rotation method that turns **``*`logfile`*``**
    into **``*`logfile.0`*``** and creates the file **``*`logfile.1`*``** in the next
    rotation step.'
  prefs: []
  type: TYPE_NORMAL
- en: hpux in turn describes the variation " **``*`logfile`*``** is turned into **`OLD`****``*`logfile`*``**".
  prefs: []
  type: TYPE_NORMAL
- en: If a suitable rotation method is missing, you can specify a regular expression
    that matches the archived files instead. For Debian, you therefore specify **`--rotation='`**
    **``*`logfile`*\. (0|[0-9]+\.gz)``**. This is in case the ending **`.0`** is missed
    during the initial rotation of the file, and if all older archived files end in
    **``*`.number`*``****`.gz`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--criticalpattern=`****``*`regexp`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Regular expression in Perl syntax that triggers a CRITICAL. More detailed information
    on this is provided by **`man perlre`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--warningpattern=`****``*`regexp`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Like **`--criticalpattern`**, except that the regular expression here triggers
    a WARNING.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--noprotocol`**'
  prefs: []
  type: TYPE_NORMAL
- en: Switches off logging of matches to a separate file.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--syslogserver`**'
  prefs: []
  type: TYPE_NORMAL
- en: Restricts the evaluation of log files of a syslog server to lines that the server
    itself has entered.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--syslogclient=`****``*`clientname`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Restricts the evaluation of log files of a syslog server to lines that originate
    from the syslog client **``*`clientname`*``**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-f`** **``*`configfile`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Specifies a configuration file that allows a more extensive configuration than
    that allowed by just a few command line parameters. A knowledge of Perl is essential
    for this (see [7.5.3 The Swiss Army knife: check_logfiles](../Text/ch07s05.html#the_swiss_army_knife_colon_check_undersc
    "7.5.3 The Swiss Army knife: check_logfiles")).'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`**'
  prefs: []
  type: TYPE_NORMAL
- en: Switches on debugging. Useful for searching for errors; this option should not
    be used during normal operation.
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_logfiles`** is initialized when it is first called so that it can
    orient itself. The plugin only takes into account log entries that are subsequently
    appended to the log file, so it cannot evaluate already existing details.'
  prefs: []
  type: TYPE_NORMAL
- en: 'For demonstration purposes we will first use the **`logger`** program to generate
    an entry in the file **`/var/log/messages`**: ^([[77](#ftn.CHP-7-FN-7)])'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE122]'
  prefs: []
  type: TYPE_PRE
- en: 'The log file now contains the following entry:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE123]'
  prefs: []
  type: TYPE_PRE
- en: 'A simple call of **`check_logfiles`** returns the following result :'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE124]'
  prefs: []
  type: TYPE_PRE
- en: All variables in the performance data are appended to the **`hellowob`** tag
    so that the respective events can be referenced again, if **`check_logfiles`**
    is to simultaneously search for several different entries.
  prefs: []
  type: TYPE_NORMAL
- en: 'Re-running **`check_logfiles`** again returns an OK, since none of the 32 newly
    added entries (**`hellowob_lines=32`**) contains the text being sought:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE125]'
  prefs: []
  type: TYPE_PRE
- en: Configuration Files
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Configuration files for **`check_logfiles`** basically contain an array consisting
    of search instructions, each of which are written as an anonymous hash:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE126]'
  prefs: []
  type: TYPE_PRE
- en: 'The array is called **`@searches`**; each instruction enclosed in **`{}`**
    is a search instruction. A configuration file for the **`hellowob`** example could
    look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE127]'
  prefs: []
  type: TYPE_PRE
- en: 'The instructions tag and **`rotation`** correspond to the command line parameters
    of the same name. The instructions **`criticalpatterns`** and **`warningpatterns`**
    are notated here -in contrast to the equivalent command line parameter-in the
    plural. The configuration file also allows multiple details :'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE128]'
  prefs: []
  type: TYPE_PRE
- en: 'Instead of a scalar, an anonymous array may also be specified within square
    brackets. Here are some more instructions for **`@searches`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`archivedir`**'
  prefs: []
  type: TYPE_NORMAL
- en: Archive directory for rotated log files. The default is the directory in which
    the log file is located.
  prefs: []
  type: TYPE_NORMAL
- en: '**`type`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Specifies the type of log file: **`rotation`** is accepted by default if the
    parameter **`rotation`** is set. **`simple`** describes log files without rotation,
    **`check_logfiles`** does not continue searching for archived files. **`virtual`**
    indicates files that should always be searched from the beginning, such as sockets
    or files from the **`/proc`** directory in Linux. For AIX, the option **`errpt`**
    is also available: instead of a real file, the plugin now searches for the output
    of the **`errpt`** command.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`criticalpatterns`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Like the command line option **`--criticalpattern`**, except that now a number
    of expressions may be specified as an array:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE129]'
  prefs: []
  type: TYPE_PRE
- en: The exclamation mark ensures a CRITICAL if no line is found with the text **`dontcryforme`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`criticalexceptions`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Like **`criticalpatterns`**, except as an exception: If a line matches an expression
    from **`criticalpatterns`**, a CRITICAL would be triggered. If an expression from
    **`criticalexceptions`** also matches this very same line, this then stops the
    critical state. The instruction is used to intercept special cases.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`criticalthreshold`**'
  prefs: []
  type: TYPE_NORMAL
- en: Sets a threshold. The value **`5`**, for example, means that only every fifth
    match from **`criticalpatterns`** is really counted as CRITICAL. Below this threshold,
    the result remains OK.
  prefs: []
  type: TYPE_NORMAL
- en: '**`warningpatterns`**'
  prefs: []
  type: TYPE_NORMAL
- en: Like **`criticalpatterns`**, except for warnings.
  prefs: []
  type: TYPE_NORMAL
- en: '**`warningexceptions`**'
  prefs: []
  type: TYPE_NORMAL
- en: Like **`criticalexceptions`**, except for warnings.
  prefs: []
  type: TYPE_NORMAL
- en: '**`warningthreshold`**'
  prefs: []
  type: TYPE_NORMAL
- en: Like **`criticalthreshold`**, except for warnings.
  prefs: []
  type: TYPE_NORMAL
- en: '**`okpatterns`**'
  prefs: []
  type: TYPE_NORMAL
- en: Sometimes errors can rectify themselves. In such cases the administrator does
    not want to be woken up by unnecessary alarms.
  prefs: []
  type: TYPE_NORMAL
- en: '**`okpatterns`** cancels all previous WARNINGs and CRITICALs. It is possible
    to specify multiple details (see **`criticalpatterns`**).'
  prefs: []
  type: TYPE_NORMAL
- en: '**`script`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Allows a script to be executed in case a match is found. To following instructions
    supplement this: **`scriptparams`** passes additional command line options to
    the script, **`scriptstdin`** allows to specify strings that are expected by the
    script on STDIN, and **`scriptdelay`** forces **`check_logfiles`** to take a break
    after the script has been executed.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`options`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This instruction allows further settings options to be made, the meanings of
    which can be negated by placing the prefix **`no`** in front of the option:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`script`**'
  prefs: []
  type: TYPE_NORMAL
- en: Executes the specified script. The default is **`noscript`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`smartscript`**'
  prefs: []
  type: TYPE_NORMAL
- en: Controls whether the return value of the script and its output should be included
    in the match list. The default is **`nosmartscript`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`supersmartscript`**'
  prefs: []
  type: TYPE_NORMAL
- en: Defines whether the return value and the output of the script should replace
    previous matches (the default is **`nosupersmartscript`**). The return value **`0`**
    (OK) of the script would, for example, suppress a found match, by overwriting
    the return value that is normally returned by **`check_logfiles`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`protocol`**'
  prefs: []
  type: TYPE_NORMAL
- en: Controls whether matches are to be retained in a separate log file. (The default
    is **`protocol`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`count`**'
  prefs: []
  type: TYPE_NORMAL
- en: Should matches be counted or not? **`count`** is the default. If this option
    is switched off with **`nocount`**, you can still use **`check_logfiles`** to
    just execute scripts.
  prefs: []
  type: TYPE_NORMAL
- en: '**`syslogserver`**'
  prefs: []
  type: TYPE_NORMAL
- en: Corresponds to the option **`--syslogserver`** (the default is **`nosyslogserver`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`syslogclient=string`**'
  prefs: []
  type: TYPE_NORMAL
- en: Like **`--syslogclient`**, except that an additional filter may be specified,
    for example, to search only for the files of a specific client (**`nosyslogclient`**
    is the default).
  prefs: []
  type: TYPE_NORMAL
- en: '**`perfdata`**'
  prefs: []
  type: TYPE_NORMAL
- en: Should performance data be displayed? The default is **`perfdata`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`logfilenocry`**'
  prefs: []
  type: TYPE_NORMAL
- en: If a log file does not exist, **`check_logfiles`** outputs UNKNOWN, in accordance
    with the default, **`logfilenocry`**. The parameter **`nologfilenocry`** tells
    the plugin to omit an error message if the log file is missing.
  prefs: []
  type: TYPE_NORMAL
- en: '**`case nocase`**'
  prefs: []
  type: TYPE_NORMAL
- en: ignores upper/lower case. The default, with case, is the opposite of this.
  prefs: []
  type: TYPE_NORMAL
- en: '**`sticky=seconds`**'
  prefs: []
  type: TYPE_NORMAL
- en: With this option **`check_logfiles`** notices an error state for the amount
    of time specified. Normally a subsequent check that does not find any more matches
    would return an OK, so that the administrator might overlook an important entry.
  prefs: []
  type: TYPE_NORMAL
- en: Let us assume that you only accept the truce when there have been no more matches
    in the log file for two hours. Then the check with **`sticky=7200`** will announce
    an error state for up to two hours. Only after this period has expired will **`check_logfiles`**
    return to an OK, provided that in the meantime no new entry restarts the two-hour
    time limit.
  prefs: []
  type: TYPE_NORMAL
- en: If the search pattern contains **`okpattern`**, **`check_logfiles`** returns
    an OK directly after a match, that is, before the specified time has expired.
  prefs: []
  type: TYPE_NORMAL
- en: '**`savethresholdcount`**'
  prefs: []
  type: TYPE_NORMAL
- en: If an event does not attain the number of matches required in the **`*threshold`**
    options, no error is announced. The question here is how the matches overall should
    be handled. **`savethresholdcount`** (the default) saves the number of matches
    until the next check and adds these together until the threshold is reached and
    an error is triggered. The parameter **`nosavethresholdcount`** prevents the event
    counter from always being reset to zero between two checks.
  prefs: []
  type: TYPE_NORMAL
- en: It is beyond the scope of this book to describe all the possible applications
    of **`check_logfiles`**. For this reason, we refer to the documentation, available
    in German and English, on the **`check_logfiles`** Web site.^([[78](#ftn.CHP-7-FN-8)])
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[74](#CHP-7-FN-4)]) [http://www.nagiosexchange.org/54;279](http://www.nagiosexchange.org/54;279)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[75](#CHP-7-FN-5)]) In the form of Perl-compatible regular expressions (PCRE,
    see **`man perlre`**), since **`check_logs.pi`** is a Perl script.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[76](#CHP-7-FN-6)]) [http://www.consol.de/opensource/nagios/check-logfiles](http://www.consol.de/opensource/nagios/check-logfiles)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[77](#CHP-7-FN-7)]) We are assuming here that the **`daemon`** facility is
    logged with the **`info`** priority in **`/var/log/messages`**. This is dependent
    on the distribution, however. In Debian, such entries land in **`/var/log/daemon.log`**.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[78](#CHP-7-FN-8)]) [http://www.consol.com/opensource/nagios/check-logfiles](http://www.consol.com/opensource/nagios/check-logfiles)
  prefs: []
  type: TYPE_NORMAL
- en: 7.6 Keeping Tabs on the Number of Logged-In Users
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The plugin **`check_users`** is used to monitor the number of logged-in users:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE130]'
  prefs: []
  type: TYPE_PRE
- en: 'It has just two options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`number`*``** **`/ --warning=`****``*`number`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the threshold for the number of logged-in users after which the plugin
    should give a warning.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`number`*``** **`/ --critical=`****``*`number`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the threshold for a critical state, measured by the number of logged-in
    users.
  prefs: []
  type: TYPE_NORMAL
- en: The performance data after the **`|`** is as usual visible only on the command
    line; Nagios does not include it in the Web interface.
  prefs: []
  type: TYPE_NORMAL
- en: 7.7 Checking the System Time
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 7.7.1 Checking the system time via NTP
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The two plugins **`check_ntp`** and **`check_ntp_time`** compare the clock time
    of the local computer with that of an available NTP server in the network. If
    the Nagios server keeps time via NTP accurately enough, so that it can serve as
    a reference itself, then it can also be used as a network plugin, provided that
    the host to be checked in the network has an NTP daemon installed.
  prefs: []
  type: TYPE_NORMAL
- en: 'From plugin version 1.4.11, the plugins **`check_ntp_time`** and **`check_ntp_peer`**
    ([6.12 Health Check of an NTP Server with check_ntp_peer](../Text/ch06s15.html
    "6.12 Health Check of an NTP Server with check_ntp_peer"), page 154) replace **`check_ntp`**,
    which contains the functions of both: the comparison of the local system time
    with an NTP server described here and the health check of the NTP server itself.
    The options here apply both to **`check_ntp`** and to **`check_ntp_time`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In the simplest case, **`check_ntp`** is called, specifying the computer (here:
    **`ntpserver`**) whose time should be compared with that of the local computer:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE131]'
  prefs: []
  type: TYPE_PRE
- en: 'The deviation determined here amounts to just 9.5 milliseconds, a good value.
    How much deviation can be tolerated depends on the particular intended use. If
    you want to compare the log file entries of several different computers, they
    ought to be NTP-synchronized. Then you can certainly use **`-w 1 -c 2`**, that
    is, assign a deviation of two seconds as critical. In environments in which Kerberos
    is used for authentication, time synchronization of all hosts involved is also
    important, but not quite as critical: Microsoft''s Active Directory under Windows
    Server 2003 tolerates a maximum deviation of five minutes, and only when there
    are larger deviations do real problems arise.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_ntp_time`** and **`check_ntp`** have the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the NTP server with which the plugin should compare the local system
    time.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The UDP port on which the NTP server runs. The default is port **`123`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`threshold`*``** **`/ --warning=`****``*`threshold`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the warning limit, specified in the standard threshold format ([24.1.5
    Specifying thresholds](../Text/ch24.html#specifying_thresholds "24.1.5 Specifying
    thresholds"), page 557). The warning is given if the fluctuation of the local
    system time is larger than the threshold specified. The default is 60 seconds.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`threshold`*``** **`/ --critical=`****``*`threshold`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Critical threshold in seconds, specified in the standard threshold format ([24.1.5
    Specifying thresholds](../Text/ch24.html#specifying_thresholds "24.1.5 Specifying
    thresholds"), page 557). If the local system time deviates more than the given
    number of seconds (in the default setting 120 seconds) from that of the NTP server,
    the status becomes CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-q / --quiet`** (only **`check_ntp_time`**)'
  prefs: []
  type: TYPE_NORMAL
- en: Returns UNKNOWN instead of CRITICAL if the NTP server-for whatever reason-does
    not provide an offset.
  prefs: []
  type: TYPE_NORMAL
- en: 7.7.2 Checking system time with the time protocol
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Apart from the *Network Time Protocol* NTP there is another protocol, older
    and more simple: the *Time Protocol* described in RFC 868, in which communication
    takes place via TCP port 37\. On many Unix systems the corresponding server is
    integrated into the inet daemon, so you do not have to start a separate daemon.
    With **`check_time`**, Nagios provides an appropriate test plugin.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_time`** can also be used as a network plugin, in a similar way to
    **`check_ntp`**, but this again assumes that the time service is available for
    every client. In most cases it will therefore be used as a local plugin that compares
    its own clock time with that of a central time server (here: **`timesrv`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE132]'
  prefs: []
  type: TYPE_PRE
- en: 'The performance data after the **`|`** sign, not shown in the Web interface,
    contains the response time in seconds, with **`time`** (here: zero seconds); **`offset`**
    describes by how much the clock time differs from that of the time server (here:
    **`1160`** seconds). The other values, each separated by a semicolon, provide
    the warning limit, the critical threshold, and the minimum (see also [19.1 Processing
    Plugin Performance Data with Nagios](../Text/ch19.html#processing_plugin_performance_data_with
    "19.1 Processing Plugin Performance Data with Nagios") from page 404). Since we
    have not set any threshold values with the options **`-W`** or **`-C`**, the corresponding
    entries for **`time`** are empty'
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_time`** has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name or IP address of the time server.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the TCP port specification, if different from the default **`37`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u / --udp`**'
  prefs: []
  type: TYPE_NORMAL
- en: Normally the time server is queried via TCP. With **`-u`** you can use UDP if
    the server supports this.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`integer`*``** **`/ --warning-variance=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the local time deviates more than **``*`integer`*``** seconds from that of
    the time server, the plugin returns a WARNING. **``*`integer`*``** is always positive,
    and this covers clocks that are running both slow and fast.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`integer`*``** **`/ --critical-variance=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If there is more than **``*`integer`*``** seconds difference between the local
    and the time server time, the return value of the plugin is CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-W`** **``*`integer`*``** **`/ --warning-connect=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the time server needs more than **``*`integer`*``** seconds for the response,
    a WARNING is returned.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`integer`*``** **`/ --critical-connect=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the time server does not respond within **``*`integer`*``** seconds, the
    plugin reacts with the return value CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: 7.8 Regularly Checking the Status of the Mail Queue
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The **`check_mailq`** plugin can be used to monitor the mail queue of a mail
    server for e-mails that have not yet been delivered. **`check_mailq`** runs the
    program **`mailq`** of the mail service installed. Unfortunately each MTA interprets
    the mail queue differently, so the plugin can evaluate only mail queues from mail
    services that the programmer has taken into account. These are, specifically:
    **`sendmail`**, **`qmail`**, **`postfix`**, and **`exim`**. The **`check_mailq`**
    plugin has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`number`*``** **`/ --warning=`****``*`number`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If there are at least **``*`number`*``** mails in the mail queue, the plugin
    gives a warning.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`number`*``** **`/ --critical=`****``*`number`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: As soon as there are at least **``*`number`*``** of mails in the queue waiting
    to be delivered, then the critical status has been reached.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-W`** **``*`number_of_domains`*``** **`/ --Warning=`****``*`number_of_domains`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the warning limit with respect to the number of recipient domains of
    a message waiting in the mail queue. Thus **`-W 3`** generates a warning if there
    are any mails in the queue that are addressed to three or more different recipient
    domains.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`number_of_domains`*``** **`/ --Critical=`****``*`number_of_domains`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the critical threshold with respect to the number of recipient domains
    (like **`-W`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-M`** **``*`daemon`*``** **`/ --mailserver=`****``*`daemon`*``** (from version
    1.4)'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the mail service used. Possible values for **``*`daemon`*``**
    are **`sendmail`** (the default), **`qmail`**, **`postfix`**, and **`exim`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`timeout`*``** **`/ --timeout=`****``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds, the plugin stops the test and returns the
    CRITICAL status. The default here—as an exception—is **`15`** seconds (usually
    it is 10 seconds).
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example, Nagios should give a warning if there are at least
    five mails in the queue; if the number reaches ten, the status of the MTAs Postfix
    used here becomes CRITICAL:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE133]'
  prefs: []
  type: TYPE_PRE
- en: Since the queue is empty, **`check_mailq`** returns OK here.
  prefs: []
  type: TYPE_NORMAL
- en: 7.9 Keeping an Eye on the Modification Date of a File
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'With the **`check_file_age`** plugin you can monitor not only the last modification
    date of a file, but also its size. In the simplest case it is just run with the
    name and path of the file to be monitored:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE134]'
  prefs: []
  type: TYPE_PRE
- en: Here the plugin gives a warning, since the warning limit set is 240 seconds
    and the critical limit, 600 seconds. The last modification of the file was 376
    seconds ago—that is, inside the warning range.
  prefs: []
  type: TYPE_NORMAL
- en: The file size is taken into account by **`check_file_age`** only if a warning
    limit for the file size (option **`-W`**) is explicitly specified. The plugin
    could then give a warning if the file is smaller than the given limit (in bytes).
    The defaults for the warning and critical limits here are both zero bytes.
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_file_age`** has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`integer`*``** **`/ --warning-age=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the file is older than **``*`integer`*``**^([[79](#ftn.CHP-7-FN-9)]) (the
    default is **`240`**) seconds, the plugin issues a warning.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`integer`*``** **`/ --critical-age=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'A critical status occurs if the file is older than **``*`integer`*``** (default:
    **`600`**) seconds.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-W`** **``*`size`*``** **`/ --warning-size=`****``*`size`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the file is smaller than **``*`size`*``** bytes, the plugin gives a warning.
    If the option is omitted, **`0`** bytes is the limit. In this case **`check_file_age`**
    does not take the file size into account.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`size`*``** **`/ --critical-size=`****``*`size`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: A file size smaller than **``*`size`*``** bytes sets off a critical status.
    The default is **`0`** bytes, which means that the file size is ignored.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-f`** **``*`file`*``** **`/ --file=`****``*`file`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The name of the file to be tested. The option may be omitted if you instead—as
    in the above example—just give the file name itself as an argument.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[79](#CHP-7-FN-9)]) Because **`check_file_age`** is a Perl script, it does
    not matter in this case whether an integer or a floating point decimal is specified.
    Fractions of a second do not play a role in the file system.
  prefs: []
  type: TYPE_NORMAL
- en: 7.10 Monitoring UPSs with apcupsd
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To monitor uninterruptible power supplies (UPS) from the company APC there is
    the possibility, apart from the Network UPS Tools described in [6.11 Monitoring
    UPS with the Network UPS Tools](../Text/ch06s14.html "6.11 Monitoring UPS with
    the Network UPS Tools") from page 149 of using the **`apcupsd`** daemon, optimized
    specifically for use with these UPSs. The software can be obtained from [http://www.apcupsd.com/](http://www.apcupsd.com/)
    and is licensed under the GPL, despite the fact that it is vendor-dependent.
  prefs: []
  type: TYPE_NORMAL
- en: The principal function here is the capacity to be able to shut down systems
    in the event of power failure, rather than a mere monitoring function with Nagios.
    For this latter purpose, it is easier to configure the Network UPS Tools.
  prefs: []
  type: TYPE_NORMAL
- en: 'Nearly all Linux distributions contain a working **`apcupsd`** package,^([[80](#ftn.CHP-7-FN-10)])
    so you don''t have to worry about installing it. Nagios does not include an **`apcupsd`**
    plugin, but there is a very simple and effective script available for download
    at [http://www.negativel.org/check_apc/](http://www.negativel.org/check_apc/):
    **`check_apc`**.^([[81](#ftn.CHP-7-FN-11)]) It is also licensed under the GPL,
    but it has no network capabilities. The plugin cannot be given a host when it
    is run, and it also does not support any other types of options. Instead of this,
    internal commands control its functionality, which are given as the first argument.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Executing **`check_apc status`** tests whether the UPS is online. If this is
    the case, the plugin returns the OK status, in all other cases it returns CRITICAL:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE135]'
  prefs: []
  type: TYPE_PRE
- en: '**`check_apc load`** **``*`warn crit`*``** checks the load currently on the
    UPS and displays it as a percentage of the maximum capacity A warning is given
    if the load is greater than the warning limits specified in **``*`warn`*``** (in
    the following example, 60 percent), CRITICAL if the load is greater than **``*`crit`*``**
    (here 80 percent):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE136]'
  prefs: []
  type: TYPE_PRE
- en: 'The load status of the UPS is checked by the command **`check_apc bcharge`**
    **``*`warn crit`*``**. Here the warning limit warn and the critical limit **``*`crit`*``**
    are also given in percent. The value **`100`** means "fully loaded." The plugin
    accordingly gives a warning if the load is smaller than the warning limit, and
    a CRITICAL if the load is smaller than the critical limit:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE137]'
  prefs: []
  type: TYPE_PRE
- en: 'You can find out how long the saved energy will last with **`check_apc time`**
    **``*`warn crit`*``**. Here **`check_apc`** gives a warning if the remaining time
    is less than **``*`warn`*``** minutes, and a CRITICAL if the remaining time is
    less than **``*`crit`*``** minutes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE138]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[80](#CHP-7-FN-10)]) At least SuSE and Debian use this package name.
  prefs: []
  type: TYPE_NORMAL
- en: '^([[81](#CHP-7-FN-11)]) It can also be obtained at: [http://www.nagiosexchange.org/54;615](http://www.nagiosexchange.org/54;615).'
  prefs: []
  type: TYPE_NORMAL
- en: 7.11 Nagios Monitors Itself
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'If necessary, Nagios can even monitor itself: the included plugin, **`check_nagios`**,
    tests, on the one hand, whether Nagios processes are running and, on the other
    hand, the age of the log file **`nagios.log`** in the Nagios **`var`** directory,
    for example, **`/var/nagios/nagios.log`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Despite this, the question needs to be asked: if Nagios itself is not running,
    then the system simply cannot perform the plugin, which in turn cannot deliver
    an error message. The solution to this problem consists in having two Nagios servers,
    each of which addresses the locally installed plugin on the opposite server, with
    the help of NRPE (see [Chapter 10](../Text/ch10.html "Chapter 10. The Nagios Remote
    Plugin Executor (NRPE)") from page 213).'
  prefs: []
  type: TYPE_NORMAL
- en: If you have just one Nagios server you can also run **`check_nagios`** alone
    via cron and have the return value checked using a shell script. In this case,
    you take action yourself, as shown in [7.11.1 Running the plugin manually with
    a script](../Text/ch07s11.html#running_the_plugin_manually_with_a_scrip "7.11.1
    Running the plugin manually with a script"), so that you are suitably informed
    of this.
  prefs: []
  type: TYPE_NORMAL
- en: 'The plugin has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`/path/to/nagios`*``** **`/ --command=`****``*`/path/to/nagios`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the complete nagios command, including the path (e.g., **`-C /usr/local/nagios/bin/nagios`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-F`** **``*`/path/to/logfile`*``** **`/ --filename=`****``*`/path/to/logfile`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the path to where the Nagios log file **`nagios.log`** is saved. The
    file is located in the Nagios **`var`** directory.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-e`** **``*`integer`*``** **`/ --expires=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the maximum age of the log file. If there have been no changes to the
    file for longer than **``*`integer`*``** minutes, **`check_nagios`** issues a
    warning.
  prefs: []
  type: TYPE_NORMAL
- en: 'You should make sure that this time specification is large enough: if no errors
    are currently occurring, Nagios will not log anything in the log file. The only
    reliable way to obtain a regular entry is with the parameter **`retention_update_interval`**
    in the configuration file **`nagios.cfg`** (see [A.1 The Main Configuration File
    nagios.cfg](../Text/apa.html#an_overview_of_the_nagios_configuration "A.1 The
    Main Configuration File nagios.cfg")). The default value is 60 minutes.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example the log file should not be older than 60 minutes (this
    corresponds to the default *retention update interval*; see [A.1 The Main Configuration
    File nagios.cfg](../Text/apa.html#an_overview_of_the_nagios_configuration "A.1
    The Main Configuration File nagios.cfg")):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE139]'
  prefs: []
  type: TYPE_PRE
- en: With one running Nagios process and a log file last changed 183 seconds (about
    three minutes) ago, everything is in order here. If the **`-e`** parameter is
    omitted, the plugin always gives a warning.
  prefs: []
  type: TYPE_NORMAL
- en: 7.11.1 Running the plugin manually with a script
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The following example script demonstrates how the plugin is called outside
    the Nagios environment. It starts **`check_nagios`** initially as Nagios does
    and then evaluates the return value. If the status is not **`0`**, it sends an
    e-mail to the administrator [nagios-admin@example.com](mailto:nagios-admin@example.com),
    using the external **`mailx`** program:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE140]'
  prefs: []
  type: TYPE_PRE
- en: The script can be run at regular intervals via a cron job—such as every 15 minutes.
    But then it will also "irritate" the administrator every quarter of an hour with
    an e-mail. There is certainly room for improvement in this respect—but that would
    go beyond the scope of this book.
  prefs: []
  type: TYPE_NORMAL
- en: 7.12 Hardware Checks with LM Sensors
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Modern mainboards are equipped with sensors that allow you to check the "health"
    of the system. In the **`lm-sensors`**^([[82](#ftn.CHP-7-FN-12)]) project it is
    also possible in Linux to query this data via I2C or SMBus (*System Management
    Bus*, a I2C special case).
  prefs: []
  type: TYPE_NORMAL
- en: To enable this, the kernel must have a suitable driver. Kernel 2.4.x normally
    requires additional modules, which are included in the software.^([[83](#ftn.CHP-7-FN-13)])
    With a little luck, your distribution may include precompiled modules (e.g., SUSE).
    Kernel 2.6, however, already includes many drivers; here you just compile the
    entire branch below **`I2C Hardware Sensors Chip support`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'It would take too much space here to detail the installation of the necessary
    modules. We will therefore only go into detail for the **`check_sensors`** plugin,
    and assume that the corresponding kernel driver is already loaded as a module.
    Help is provided during operation with the **`sensors-detect`** program from the
    **`lm-sensors`** package, which does a number of tests and then tells you which
    modules need to be loaded. If all requirements are fulfilled, running the **`sensors`**
    program will produce an output similar to the following one, and shows that the
    onboard sensors are providing data:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE141]'
  prefs: []
  type: TYPE_PRE
- en: The output depends on the hardware, so it will be slightly different for each
    computer. Here you can see, for example, the CPU and motherboard temperatures
    (41 and 45 degrees Celsius), the rotation speed of the fans, and the voltages
    on the 12- and 5-volt circuits and on the battery. Depending on the board design
    and the manufacturer, some details may be missing; in this example, only the fan
    for the power supply **`FAN1/PS`**^([[84](#ftn.CHP-7-FN-14)]) provides information;
    **`Fan3/AUX`** refers to an additional fan inside the computer box that, although
    it is running, is not recorded by the chipset.
  prefs: []
  type: TYPE_NORMAL
- en: 'Apart from the standard options **`-h`** (help function), **`-v`** (*verbose*),
    which displays the response of the sensors, and **`-V`**, which shows the plugin
    version, the plugin itself has no special options. Warning and critical limits
    must be set via the **`lm-sensors`** configuration. **`check_sensors`** only returns
    the status given by the onboard sensors:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE142]'
  prefs: []
  type: TYPE_PRE
- en: 'If this is called with the **`-v`** option, you can see more clearly whether
    the test works:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE143]'
  prefs: []
  type: TYPE_PRE
- en: The output line is only wrapped for printing purposes; the plugin displays verbose
    information on a single line.
  prefs: []
  type: TYPE_NORMAL
- en: 'Alternatively you can use SNMP to access the sensor data: the NET-SNMP package
    (see [11.2 NET-SNMP](../Text/ch11s02.html "11.2 NET-SNMP") from page 234) provides
    the data delivered by **`lm-sensors`**, and with the SNMP plugin **`check_snmp`**,
    warning limits can also be set from Nagios. This solution is described in [11.3.1
    The generic SNMP plugin check_snmp](../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp
    "11.3.1 The generic SNMP plugin check_snmp") from page 246.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[82](#CHP-7-FN-12)]) [http://www.lm-sensors.nu/](http://www.lm-sensors.nu/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[83](#CHP-7-FN-13)]) [http://secure.netroedge.com/˜lm78/download.html](http://secure.netroedge.com/%CB%9Clm78/download.html)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[84](#CHP-7-FN-14)]) PS stands for *power supply*; but the names displayed
    can be edited in **`/etc/sensors.conf`**.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 8. Plugins for Special Tasks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: A number of plugins do not really fit into the category of local checks versus
    remote checks because they themselves do not detect operating states but manipulate
    the results of other checks or summarize them into new results. These include
    the plugin **`check_dummy`**, which always returns a fixed result in order to
    create a well-defined environment for test scenarios.
  prefs: []
  type: TYPE_NORMAL
- en: '**`negate`** (which negates the return value) and **`urlize`** (which adds
    a hyperlink to the text output) manipulate the outputs. Summarizing and processing
    check results is the task of **`check_cluster`** and **`check_multi`**. Whereas
    **`check_cluster`** only combines and evaluates existing states, **`check_multi`**
    calls the specified plugins itself and combines their results.'
  prefs: []
  type: TYPE_NORMAL
- en: 8.1 The Dummy Plugin for Tests
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'For tests expected to end with a defined response, the **`check_dummy`** plugin
    can be used. it is given a return value and the desired response text as parameters,
    and it provides exactly these two responses as a result:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE144]'
  prefs: []
  type: TYPE_PRE
- en: 'The output line contains the defined response, preceded by the status in text
    form. the return value can again be checked with **`echo $?: 1`** stands for WARNING.'
  prefs: []
  type: TYPE_NORMAL
- en: Alternatively you can give **`check_dummy`** a **`0`** (OK), an **`2`** (CRITICAL)
    or a **`3`** (UNKNOWN) as the first argument. The second argument, the response
    text, is optional.
  prefs: []
  type: TYPE_NORMAL
- en: 8.2 Negating Plugin Results
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In some situations you may want to test the opposite of what the standard plugin
    normally tests, such as an interface that should *not* be active, a Web page or
    a host that should normally *not* be reached. In these cases the program **`negate`**,
    included in the Nagios plugins, provides a way of negating the return value of
    the original check.
  prefs: []
  type: TYPE_NORMAL
- en: 'Like plugins, **`negate`** has an option to specify a timeout in seconds, with
    **`-t`**, after which it should abort the operation. The actual command line must
    always contain the complete path to the plugin:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE145]'
  prefs: []
  type: TYPE_PRE
- en: '**`negate`** changes the return value of **`2`** (CRITICAL) to **`0`** (OK)
    and vice versa. The return codes **`1`** (WARNING) and **`3`** (UNKNOWN) remain
    unchanged.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example carries out **`check_icmp`** on the host **`192.0.2.1`**,
    which in normal cases should not be reachable:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE146]'
  prefs: []
  type: TYPE_PRE
- en: The plugin itself returns a CRITICAL in this case with a corresponding text.
    **`negate`** "inverts" the return value; **`2`** (CRITICAL) turns into **`0`**
    (OK). Since the text originates from the plugin and is not changed, the information
    **`CRITICAL`** remains here. For Nagios itself, however, nothing but the return
    value is of any interest.
  prefs: []
  type: TYPE_NORMAL
- en: 8.3 Inserting Hyperlinks with **`urlize`**
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The program **`urlize`** represents the text output of a plugin as a hyperlink,
    if required, so that clicking in the Nagios Web interface on the test result takes
    you to another Web page. Like **`negate`**, **`urlize`** functions as a wrapper
    around the normal plugin command and is included with the other Nagios plugins.
  prefs: []
  type: TYPE_NORMAL
- en: 'As the first argument it expects a valid URL to which the hyperlink should
    point. This is followed by the plugin command, including its path:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE147]'
  prefs: []
  type: TYPE_PRE
- en: To avoid problems with spaces in plugin arguments, you can set the complete
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`plugin command`*``** in double quotation marks.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The hyperlink around the normal plugin output can be easily recognized when
    running the command manually:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE148]'
  prefs: []
  type: TYPE_PRE
- en: In version 1.4 **`urlize`** also embeds the performance output in the link text,
    but Nagios cut this off before the representation in the Web interface, together
    with the end tag. But most browsers do not have any problem with the missing **`</A>`**.
  prefs: []
  type: TYPE_NORMAL
- en: 8.4 Checking Host or Service Clusters as an Entity
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Plugins normally check an individual host or service, compare the result with
    the specified thresholds, and then return an appropriate result. On systems with
    redundant designs (such as in clusters) you can also check the respective host
    or service individually. In addition, a check of the virtual host or service provides
    a clue as to whether or not the virtual system as a whole is reachable. The plugin
    **`check_cluster`** allows more complex values to be queried.
  prefs: []
  type: TYPE_NORMAL
- en: As an example, we will take a host cluster consisting of five identical single
    systems. One of these hosts may fail without any problem, but if a second one
    fails, the plugin should issue a WARNING. If a third host should fail, a CRITICAL
    should certainly be signalled.
  prefs: []
  type: TYPE_NORMAL
- en: The special feature of **`check_cluster`** is that it does not actively perform
    a check itself but determines the return value from already-existing status values
    from the desired hosts or services. To do this it uses on-demand macros (see [D.2
    On-Demand Macros](../Text/apds02.html "D.2 On-Demand Macros") from page 632).
    Whereas the standard macros always refer to the current host or service, which
    obviously makes little sense for **`check_cluster`**, on-demand macros allow access
    to all existing information on other hosts or services.
  prefs: []
  type: TYPE_NORMAL
- en: 'For **`check_cluster`** we require the status of various hosts or services.
    These can be determined through the on-demand macros **`$HOSTSTATEID:`****``*`host`*$``**
    and **`$SERVICESTATEID:`** **``*`host`*:``** **``*`service_description`*$``**.
    They both provide the respective status in numerical form: **`0`** for OK; for
    hosts, **`1`** for DOWN and **`2`** for UNREACHABLE; for services, **`1`** for
    WARNING, **`2`** for CRITICAL, and **`3`** for UNKNOWN).^([[85](#ftn.CHP-8-FN-1)])
    In each case the host name must be specified, and for **`$SERVICESTATEID$`** the
    service description of the host or service from which Nagios is to obtain the
    values must also be given.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The plugin has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s / --service`**'
  prefs: []
  type: TYPE_NORMAL
- en: Handles the status values as the results of service checks, that is, **`0`**
    as OK, **`1`** as WARNING and **`2`** as CRITICAL
  prefs: []
  type: TYPE_NORMAL
- en: '**`-h / --host`**'
  prefs: []
  type: TYPE_NORMAL
- en: Handles the status values as the results of host checks, that is, **`0`** as
    UP, **`1`** as DOWN, and **`2`** as UNREACHABLE
  prefs: []
  type: TYPE_NORMAL
- en: '**`-l`** **``*`label`*``** **`/ --label=`****``*`label`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Inserts the text specified with **``*`label`*``** into the text output
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`** **``*`statusliste`*``** **`/ --data=`****``*`statusliste`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Comma-separated list of the states from which the total result should be determined;
    here the already mentioned macros are used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE149]'
  prefs: []
  type: TYPE_PRE
- en: '**`-w`** **``*`schwellwert`*``** **`/ --warning=`****``*`schwellwert`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Warning threshold in the threshold format,^([[86](#ftn.CHP-8-FN-2)]) with respect
    to the number of error states. So by specifying **`-w 0:2`**, a maximum of two
    error states are allowed for an OK result. From the third error state, a WARNING
    is issued.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`threshold`*``** **`/ --critical=`****``*`threshold`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Like **`--warning`**, but refers to the critical threshold
  prefs: []
  type: TYPE_NORMAL
- en: 'The following call simulates the failure of two out of a total of five existing
    Web servers. A third server displays a WARNING. This means that we have a total
    of three error states:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE150]'
  prefs: []
  type: TYPE_PRE
- en: 'The check issues a WARNING because the warning threshold is exceeded (even
    though the critical threshold is not). The definition of the **`check_cluster`**
    command is kept simple:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE151]'
  prefs: []
  type: TYPE_PRE
- en: 'The command expects a label as the first argument, and the plugin prefixes
    it to the text output. Everything else is defined in the second argument in the
    host or service definition:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE152]'
  prefs: []
  type: TYPE_PRE
- en: The service **`Web Cluster`** checks the service states of the two services
    **`srv1:HTTP`** and **`srv2:HTTP`**. As long as they are both working without
    errors, the command returns OK. If there is an error state, the result will be
    a WARNING, and if both services have errors, CRITICAL is returned.
  prefs: []
  type: TYPE_NORMAL
- en: This completes the possibilities of **`check_cluster`**. If you are not satisfied
    with simply evaluating the number of existing error states, you should take a
    closer look at the plugin **`check_multi`**, which also allows AND and OR operations.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[85](#CHP-8-FN-1)]) See [Appendix D](../Text/apd.html "Appendix D. Macros")
    from page 625.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[86](#CHP-8-FN-2)]) For the specification of thresholds, see [24.1.5 Specifying
    thresholds](../Text/ch24.html#specifying_thresholds "24.1.5 Specifying thresholds")
    in page 557.
  prefs: []
  type: TYPE_NORMAL
- en: 8.5 Summarizing Checks with **`check_multi`**
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: There are various reasons for grouping different checks into a single one. On
    one hand it simplifies work for Nagios, because the system now only needs to manage
    1,000 procedures instead of maybe 20,000—this increases performance significantly
    in many cases. If you summarize checks remotely, Nagios now performs 1 instead
    of 20 network queries, which results in better network performance. The Nagios
    administrator may also have an easier time, as the configuration is more concise.
  prefs: []
  type: TYPE_NORMAL
- en: The method originally planned for load distribution and reducing checks was
    via distributed Nagios instances. There are certainly productive installations
    in which a Nagios instance performs only 50 checks and transmits these to a central
    Nagios installation. If there are some several hundred Nagios instances, this
    method does ease the load on the central Nagios installation but not on the administrator,
    who has a considerable amount of work managing such configurations.
  prefs: []
  type: TYPE_NORMAL
- en: The plugin **`check_multi`**, by Matthias Flacke, takes a different approach.
    It performs (almost) any number of checks decentrally and returns just a sum total
    of the results to the Nagios server ([Figure 8-1](../Text/ch08s05.html#summarizing_checks_with_check
    "Figure 8-1. Summarizing checks with check_multi")). The plugin is executed remotely;
    it is called either via NRPE ([Chapter 10](../Text/ch10.html "Chapter 10. The
    Nagios Remote Plugin Executor (NRPE)") from page 213) or via the plugin **`check_by_ssh`**
    ([9.1 The check_by_ssh Plugin](../Text/ch09.html#the_check_underscore_by_underscore_ssh
    "9.1 The check_by_ssh Plugin") from page 206).
  prefs: []
  type: TYPE_NORMAL
- en: '![Summarizing checks with check_multi](../Images/tagoreillycom20081104nostarchimages223808.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8-1. Summarizing checks with `check_multi`
  prefs: []
  type: TYPE_NORMAL
- en: 'Information is lost during this process—ultimately, there can be only one return
    value for each **`check_multi`** call. But you gain clarity with the configuration
    of services, and you acquire—unexpectedly—a nice feature: The checks that must
    be performed are listed in an NRPE-like configuration file on the corresponding
    target system on which **`check_multi`** is also installed. This makes it possible
    to delegate certain tasks, such as the maintenance of threshold values, to other
    (non-Nagios) administrators. They require write access to the relevant **`check_multi`**
    configuration file but do not need to continue grappling—apart from correctly
    running the plugins used—with a Nagios configuration.'
  prefs: []
  type: TYPE_NORMAL
- en: To be able to pass on as much information as possible, **`check_multi`** makes
    regular use of the multiple-line plugin output format that was introduced with
    Nagios 3.0 (see [8.5.1 Multiple-line plugin output](../Text/ch08s05.html#multiple-line_plugin_output
    "8.5.1 Multiple-line plugin output")). This restricts the use of **`check_multi`**
    essentially to Nagios 3.0\. Starting from **`check_multi`** in version 0.14, there
    have been approaches to support Nagios 2.x. These are only of limited use, however,
    since the entire amount of information for plugins in Nagios 2.x is about 300
    bytes, and only the first line of the plugin output is utilized.
  prefs: []
  type: TYPE_NORMAL
- en: 8.5.1 Multiple-line plugin output
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Starting with Nagios 3.0, an expanded output format for plugins has been introduced.
    Instead of squeezing everything onto a single line, the output may be spread over
    several lines:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE153]'
  prefs: []
  type: TYPE_PRE
- en: 'The first line contains the standard text output, supplemented with performance
    data if required. This line can still be processed by Nagios 2.x, so it shouldn''t
    be longer than 300 bytes. In the following lines a plugin may supply other text
    information until the character **`|`** closes the text output and allows other
    performance data to be written. Nagios 3.0 displays the entire text information
    in the status information generated by **`extinfo.cgi`** on the Web interface
    (see [16.2.2 Additional information and control center: extinfo.cgi](../Text/ch16s02.html#additional_information_and_control_cent
    "16.2.2 Additional information and control center: extinfo.cgi") from page 339).'
  prefs: []
  type: TYPE_NORMAL
- en: 'When accessing text information via macros (See [D.1 Standard Macros](../Text/apd.html#standard_macros
    "D.1 Standard Macros") from page 627), Nagios splits up the information into two
    macros: **`$HOSTOUTPUT$`** contains the first line of the text information of
    host checks (that is, the contents of the placeholder **``*`normal text output`*``**),
    and **`$LONGHOSTOUTPUT$`** contains only the long text. For service checks the
    macros are called **`$SERVICEOUTPUT$`** and **`$LONGSERVICEOUTPUT$`**. The **`LONG*`**
    variation of the macro is available only in Nagios 3.0 and later; Nagios 2.x only
    knows the short version.'
  prefs: []
  type: TYPE_NORMAL
- en: The performance data from the first line and from the end is summarized by Nagios
    3.0 in the macros **`$HOSTPERFDATA$`** and **`$SERVICEPERFDATA$`**. There is no
    **`LONG*`** variation, as is the case for the output.
  prefs: []
  type: TYPE_NORMAL
- en: The entire output, including performance data, is a maximum of 8 KB long in
    Nagios 3.0\. If Nagios runs a plugin directly, as opposed to indirectly, (for
    instance, via NRPE or **`check_by_ssh`**), you must ensure that the entire 8 KB
    really are passed across the entire transmission path. This is covered in [8.5.2
    Installation requirements](../Text/ch08s05.html#installation_requirements "8.5.2
    Installation requirements").
  prefs: []
  type: TYPE_NORMAL
- en: 8.5.2 Installation requirements
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '**`check_multi`** does not put any restrictions on the size of its output.
    In order to support enough checks, you should ensure that all the resources used
    allow at least 8 KB of plugin output. For Nagios version 3.0, the developers have
    increased the buffer size to to 8 KB, so no adjustments are necessary. For scenarios
    involving remote use with NRPE or **`check_by_ssh`**, you may need to make manual
    adjustments.'
  prefs: []
  type: TYPE_NORMAL
- en: Adjusting buffer sizes for NRPE
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'By default, NRPE ([Chapter 10](../Text/ch10.html "Chapter 10. The Nagios Remote
    Plugin Executor (NRPE)"), page 213) transmits no more than 1,024 characters. To
    make proper use of **`check_multi`**, you need to adjust the buffer size in the
    source code. To do this, you set the appropriate values in the file **`include/common.h`**
    to **`8192`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE154]'
  prefs: []
  type: TYPE_PRE
- en: Afterward, you must re-compile and re-install the NRPE daemon and the **`check_nrpe`**
    plugin.
  prefs: []
  type: TYPE_NORMAL
- en: Adjusting buffer sizes for **`check_by_ssh`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The plugin **`check_by_ssh`** ([9.1 The check_by_ssh Plugin](../Text/ch09.html#the_check_underscore_by_underscore_ssh
    "9.1 The check_by_ssh Plugin") from page 206) can handle multiple-line output
    from plugins in versions 1.4.10 and later, so it can be used unchanged. A patch
    is required for older versions, which can be found on the **`check_multi`** homepage.^([[87](#ftn.CHP-8-FN-3)])
  prefs: []
  type: TYPE_NORMAL
- en: 8.5.3 Installation and testing
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'After downloading the plugin from the very extensive and well-documented homepage,^([[88](#ftn.CHP-8-FN-4)])
    you should unpack it in a directory anywhere, and then change to that directory
    to carry out an initial test. In the subdirectory **`contrib`** of the source
    code there is a preconfigured file, **`check_multi.cmd`**, containing several
    example checks. When running the plugin, specify this file with the option **`-f`**;
    **`check_multi`** will perform all the checks defined there in one go. This output
    gives you a feeling of how the plugin functions:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE155]'
  prefs: []
  type: TYPE_PRE
- en: The first line of the output—starting with **`MULTI CRITICAL`**—summarizes all
    the executed checks. These lines (line-wrapped here for display purposes) are
    also processed by Nagios 2.x. The output from the individual checks begins on
    line 2 (starting with **`[ 1]`**), which looks exactly like the output of a single
    call of the plugin currently being run. The performance data is summarized by
    **`check_multi`**, but only at the the end, in a totals line—starting with **`|
    MULTI::check_multi::plugins`**. The individual variables are separated by spaces.
    The purpose for the variable names, along with their format (which takes some
    getting used to), is explained in [8.5.6 Performance data and PNP](../Text/ch08s05.html#performance_data_and_pnp
    "8.5.6 Performance data and PNP") from page 198.
  prefs: []
  type: TYPE_NORMAL
- en: 8.5.4 Configuration file
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The format of the configuration file is based on that of NRPE ([10.3 NRPE Configuration
    on the Computer to Be Monitored](../Text/ch10s03.html "10.3 NRPE Configuration
    on the Computer to Be Monitored") from page 218). For **`check_multi`**, however,
    only the commands are defined. Here is an extract from the example file included,
    **`check_multi.cmd`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE156]'
  prefs: []
  type: TYPE_PRE
- en: The command **`command[`** **``*`Name_of_check`* ]``** specifies the name for
    the appropriate check. This is used in the text output and in the performance
    data.
  prefs: []
  type: TYPE_NORMAL
- en: After the equal sign comes the check to be executed. When calling the plugin,
    path details can be omitted if the plugins are located in the default path, **`/usr/local/nagios/libexec`**.
    Alternatively, you can include the plugin path with the option **`−1`** when running
    **`check_multi`**. You can also specify the absolute path in the configuration
    file, of course.
  prefs: []
  type: TYPE_NORMAL
- en: 8.5.5 Command-line parameters
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '**`check_multi`** has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-f`** **``*`/path/to/config/file`*``** **`/ --filename=`****``*`/path/to/config/file`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the configuration file. So that Nagios can find it, you should
    always specify the complete path. This option does not have a default value; it
    can be given several times.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-l`** **``*`/path/to/the/plugins`*``** **`/ --libexec=`****``*`/path/to/the/plugins`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The default for calling plugins is the path **`/usr/local/nagios/libexec`**.
    If they are located in a different directory, this is specified here with the
    **`-l`** option.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-n`** **``*`name`*``** **`/ --name=`****``*`name`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the name of a check that **`check_multi`** outputs in the text output
    and in the performance data. The default is an empty string. If you run **`check_multi`**
    on a machine several times with different checks, it is better here to use different
    names so that they are more clearly separated from each other.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** **``*`sekunden`*``** **`/ --timeout=`****``*`seconds`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the timeout for an individual check. The default is **`10`**
    seconds.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-T`** **``*`seconds`*``** **`/ --TIMEOUT=`****``*`seconds`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: For all checks together, **`check_multi`** requires a further timeout parameter,
    which is defined with **`-T`** (the default is **`60`** seconds).
  prefs: []
  type: TYPE_NORMAL
- en: This ensures that the call of **`check_multi`** will end within the time specified.
    The plugin does not start any new checks if the starting time and the timeout
    of a single plugin exceed the timeout of the entire **`check_multi`** call.^([[89](#ftn.CHP-8-FN-5)])
    Such individual checks are given the status UNKNOWN; in the output, **`check_multi`**
    assigns them the message **`plugin cancelled due to global timeout`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** **``*`integer`*``** **`/ --report=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This option controls the output behavior of **`check_multi`**. The placeholder
    **``*`integer`*``** can take on the following values:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`1`** includes the service name for error states in parentheses in the plugin
    output:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE157]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '**`2`** formats the output as HTML. Here the numbers of the individual checks
    (e.g., [ **`3`**]) are stored along with the color of the respective return value
    (green for OK, yellow for WARNING, red for CRITICAL, and orange for UNKNOWN).'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If you use **`check_multi`** recursively (a **`check_multi`** itself calls other
    instances of **`check_multi`**), the output of the subordinate checks are indented
    (see [Figure 8-3](../Text/ch08s05.html#recursive_output_of_chech_underscore_mul
    "Figure 8-3. Recursive output of chech_multi on the Extended Infro page of the
    Nagios Web interface") in page 202).
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '**`4`** shows the output of the individual check—if they exist—on STD-ERR.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**`8`** outputs the performance data in the multi-format (see [8.5.6 Performance
    data and PNP](../Text/ch08s05.html#performance_data_and_pnp "8.5.6 Performance
    data and PNP") from page 198).'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**`16`** has the same function as **`1`**, except that states for which there
    are no check results (e.g., **`0 unknown`**) are also included.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**`32`** outputs performance data in the classical format (see [8.5.6 Performance
    data and PNP](../Text/ch08s05.html#performance_data_and_pnp "8.5.6 Performance
    data and PNP")).'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**`128`** extends the HTML format required by **`2`** by including a hyperlink
    to an installed PNP if performance data is available and the output is in multi-format
    (**`8`**). PNP is described in [19.6 Smooth Plotting with PNP](../Text/ch19s06.html
    "19.6 Smooth Plotting with PNP") from page 446.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**`256`** displays the output in XML formatting.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**`512`** ensures that the output is Nagios 2.x compatible in order to bring
    the output below the 300-byte limit.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Indivudal values may be combined; the default is 13 (8 + 4 + 1).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`expression`*``** **`/ --warning=`****``*`expression`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This sets the status WARNING if **``*`expression`*``** is true, e.g., **`COUNT
    (WARNING) > 0`** (the default). For all states, **`check_multi`** separately checks
    whether or not the corresponding status was determined. Eventually, the status
    with the highest priority wins out: CRITICAL trumps WARNING, trumps UNKNOWN, trumps
    OK. The definition and use of expressions is explained in [8.5.7 Simple business
    process monitoring](../Text/ch08s05.html#simple_business_process_monitoring "8.5.7
    Simple business process monitoring") from page 199.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`ausdruck`*``** **`/ --critical=`****``*`expression`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the expression is true, the status is set to CRITICAL. Eventually, the status
    with the highest priority wins out (see **`--warning`** and [8.5.7 Simple business
    process monitoring](../Text/ch08s05.html#simple_business_process_monitoring "8.5.7
    Simple business process monitoring")).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u`** **``*`expression`*``** **`/ --unknown=`****``*`expression`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the expression is true, the status UNKNOWN is set. The status with the highest
    priority (see **`--warning`** and [8.5.7 Simple business process monitoring](../Text/ch08s05.html#simple_business_process_monitoring
    "8.5.7 Simple business process monitoring")) wins out.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-o`** **``*`expression`*``** **`/ --ok=`****``*`expression`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If **``*`ausdruck`*``** is true, the status OK is set. Here the status with
    the highest priority also wins out (see **`--warning`** and [8.5.7 Simple business
    process monitoring](../Text/ch08s05.html#simple_business_process_monitoring "8.5.7
    Simple business process monitoring")).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-v / --verbose`**'
  prefs: []
  type: TYPE_NORMAL
- en: This increases the verbosity of the plugin for debugging purposes. The option
    can be used up to three times; if specified three times, you will obtain the most
    detailed information.
  prefs: []
  type: TYPE_NORMAL
- en: 8.5.6 Performance data and PNP
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In the simple output form for performance data (which can be set with the option
    **``*`-r`*``** **`32`**), **`check_multi`** simply lists all variables provided
    by the plugins:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE158]'
  prefs: []
  type: TYPE_PRE
- en: The performance data for the plugin **`check_icmp`** (the average response time
    **``*`r`*``****`ta`** and the packet loss **`pl`**) in this example seamlessly
    follow the performance data of **`check_ntp`** in the form of deviation from the
    local system time (**`offset`**). You can't tell, at first glance, what information
    comes from which plugin—you have to consult the order in the configuration file
    and the outputs of the individual checks.
  prefs: []
  type: TYPE_NORMAL
- en: 'This is not particularly suitable for automatic processing. **`check_multi`**
    therefore provides an extended output with the default option **``*`-r`*``****`8`**,
    which is modified specifically to handle PNP (see [19.6 Smooth Plotting with PNP](../Text/ch19s06.html
    "19.6 Smooth Plotting with PNP") from page 446). When doing this, the plugin adds
    a service description and the name of the plugin used to the name of the variables.
    No deviation is made from the standardized format; the label is just given a more
    extensive form:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE159]'
  prefs: []
  type: TYPE_PRE
- en: 'PNP requires information on the plugin executed so that it can select a suitable
    template for processing the graphics (see [19.6.5 How should the graphic appear?](../Text/ch19s06.html#how_should_the_graphic_appear_question
    "19.6.5 How should the graphic appear?") from page 454). In addition, **`check_multi`**
    now also provides performance data referring to the overall processing:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE160]'
  prefs: []
  type: TYPE_PRE
- en: First **`check_multi`** announces that it has called **`5`** plugins and has
    used a total of 0.18 seconds for processing. This is followed by the performance
    data for the other plugins, each supplemented with the service description and
    plugin name. If a plugin issues more than one variable, the service description
    and plugin name are not repeated.
  prefs: []
  type: TYPE_NORMAL
- en: 8.5.7 Simple business process monitoring
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In order to evaluate business processes, you generally want to know whether
    a particular process is working—for instance, whether or not a customer can perform
    online banking. Individual pieces of information on all hosts and services involved
    are not relevant from this perspective and are also not always useful if systems
    are designed redundantly in different forms.
  prefs: []
  type: TYPE_NORMAL
- en: '![For the terminal server farm to be reachable from the Internet, an OpenVPN
    access and a terminal server must be available.](../Images/tagoreillycom20081104nostarchimages223810.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8-2. For the terminal server farm to be reachable from the Internet,
    an OpenVPN access and a terminal server must be available.
  prefs: []
  type: TYPE_NORMAL
- en: 'One example is shown in [Figure 8-2](../Text/ch08s05.html#for_the_terminal_server_arm_to_be_reacha
    "Figure 8-2. For the terminal server farm to be reachable from the Internet, an
    OpenVPN access and a terminal server must be available."): Home office users access
    a terminal server farm via OpenVPN. For access from the Internet, two connections
    are available, and with **`gate1`** and **`gate2`**, two OpenVPN gateways are
    available. The terminal server farm consists of the eight terminal servers **`ts01`**
    through **`ts08`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In order for home office users to be able to work, at least one Internet connection
    (including the accompanying gateway) must be available, and the server farm must
    be reachable. The business process can be split into two processes: Our example
    looks at the Internet access separated from the server farm, and afterward it
    can connect the two results with one another.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The condition for a critical status for Internet access could be formulated
    as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE161]'
  prefs: []
  type: TYPE_PRE
- en: 'Access is unusable if the provider is unreachable or (**`||`**) the OpenVPN
    service is not available on the gateway. But it is sufficient if one of the two
    access points is functioning (thus the AND logical operator with &&). The syntax
    is taken from Perl and can equally be processed by **`check_multi`**. The configuration
    file for the Internet check therefore contains four commands and the logocal operators:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE162]'
  prefs: []
  type: TYPE_PRE
- en: The two **`gate*`** commands each check (via NRPE) whether the gateway of the
    OpenVPN service is running. The provider test sends ICMP echo packets to the dial-up
    router of the respective provider. You should take great care here to ensure that
    routing is correctly set up, that is, that the ICMP packets to the respective
    provider really are sent across the accompanying connection.
  prefs: []
  type: TYPE_NORMAL
- en: 'For a business process, a Boolean expression for individual states is defined
    in the configuration file, so depending on requirements, there may be one for
    CRITICAL, one for WARNING, and, if necessary, one for UNKNOWN as well. The syntax
    and the operators are passed on to Perl as specified and are described in detail
    in the Perl online documentation (**`man`** **``*`per`*``****`lop`**). Before
    evaluating the expression, **`check_multi`** undertakes the following substitutions:'
  prefs: []
  type: TYPE_NORMAL
- en: If the expression contains the name of a check previously defined with **`command`**,
    the return value of this check will be used instead. Let's assume that check **`gatel`**
    returns **`2`** and check **`providerl`** returns **`1`**. Then the partial expression
    shown above will become
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[PRE163]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Within the brackets, the first condition is true, and through the subsequent
    OR (**`||`** in Perl syntax) the partial expression evaluates to true.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: The function **`count`** determines the number of all checks that provided the
    return value given as an argument.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Instead of the numerical value of a status, the text form (UNKNOWN, WARNING,
    CRITICAL, WARNING, OK) can also be included in the expression (so you can write
    something like **`gate1 > WARNING`**). This detail is replaced by **`check_multi`**
    with the numerical value before the expression is evaluated.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The WARNING status is set in **`openvpn.cmd`** if at least one critical status
    occurs, at least one check delivers UNKNOWN, or at least one check returns WARNING.
    The CRITICAL status appears if both accesses should fail (because of the AND logical
    operator between the two partial expressions in brackets). The partial expressions
    on their own are true if either of the **`gate`** or **`provider`** checks delivers
    a CRITICAL (return value **`2`**) or an UNKNOWN (return value **`3`**). The condition
    for the UNKNOWN status can be omitted since UNKNOWN results always lead to the
    WARNING status.
  prefs: []
  type: TYPE_NORMAL
- en: 'The second partial process—the function of the terminal server farm—is described
    in the configuration file **`terminalserver.cmd`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE164]'
  prefs: []
  type: TYPE_PRE
- en: The individual checks here consist of only a primitive TCP check of the RDP
    port 3389 in order to keep the example relatively simple. WARNING should be indicated
    if at least one CRITICAL or at least one UNKNOWN occurs so that the administrator
    has the opportunity to fix the problem at an early stage. The condition for the
    CRITICAL status stipulates that **`ts01`** must not be CRITICAL because a very
    specific application is running there which is not available on the other servers.
    In addition, no more than three terminal servers may fail, as otherwise the load
    on the other servers may increase so heavily that useful work would no longer
    be possible.
  prefs: []
  type: TYPE_NORMAL
- en: '![Recursive output of chech_multi on the Extended Infro page of the Nagios
    Web interface](../Images/tagoreillycom20081104nostarchimages223812.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 8-3. Recursive output of `chech_multi` on the Extended Infro page of
    the Nagios Web interface
  prefs: []
  type: TYPE_NORMAL
- en: 'The two checks of the partial processes are summarized by a **`check_multi`**
    call into a single result (the lines are wrapped for display purposes):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE165]'
  prefs: []
  type: TYPE_PRE
- en: So that the Extended Info page of Nagios ([Figure 8-3](../Text/ch08s05.html#recursive_output_of_chech_underscore_mul
    "Figure 8-3. Recursive output of chech_multi on the Extended Infro page of the
    Nagios Web interface")) is more presentable, the details of the respective plugin
    names are omitted (through the missing option **`-n`**; the recursive HTML output
    of **`check_multi`** adds the name of the check called anyway). The **`-r 31`**
    detail sets all reporting functions from 1 to 16, including HTML formatting (**``*`-r`*``**
    **`2`**). Special conditions for a status are not formulated, so a WARNING of
    a partial process leads to a WARNING in the overlying check, and a CRITICAL leads
    to a CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: '[Figure 8-3](../Text/ch08s05.html#recursive_output_of_chech_underscore_mul
    "Figure 8-3. Recursive output of chech_multi on the Extended Infro page of the
    Nagios Web interface") shows the two partial processes quite clearly separated.
    The serial numbers of the checks are stored with the respective status colors,
    which are unfortunately not visible in this black-and-white book. A complex color
    example of recursive display in the Extended Info Web page can be found on the
    homepage of the plugin.^([[90](#ftn.CHP-8-FN-6)])'
  prefs: []
  type: TYPE_NORMAL
- en: 'For the sake of completeness, here is the definition of command and service
    for Nagios. The former is kept deliberately simple, and all the details for the
    command line are repeated in the service definition:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE166]'
  prefs: []
  type: TYPE_PRE
- en: If the mapping of business processes with **`check_multi`** isn't enough for
    you, you should take a look at the somewhat more complex addon *Nagios Business
    Process View and Nagios Business Impact Analysis* from the Sparda-Datenverarbeitung
    eG, Nuremberg, Germany, which is available on the Nagios-Exchange.^([[91](#ftn.CHP-8-FN-7)])
  prefs: []
  type: TYPE_NORMAL
- en: In contrast to **`check_multi`**, which appears as the only Nagios service and
    which also needs to be managed only once by Nagios, this addon uses services already
    defined in Nagios, which means that Nagios performs each individual check as usual.
    It retrieves the results of individual checks, links these, and displays them
    on its own Web interface.
  prefs: []
  type: TYPE_NORMAL
- en: When doing so, the result of such links—business processes, so to speak—can
    be redefined in Nagios as a separate service so that it is possible, for instance,
    to use the notification logic of Nagios. Furthermore, the addon includes a mode
    with which it can simulate a "what would happen if" scenario. Individual services
    are set to an expected status, and the effects can be seen via the Web interface.
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_multi`** and the Nagios Business Process View and Nagios Business
    Impact Analysis addon are thus not in competition. Depending on the intended use,
    either **`check_multi`** will reduce the complexity of the services represented
    in Nagios and therefore will reduce the number of checks performed, or the addon
    will allow a more detailed view of overall events, though it does demand that
    all services are individually mapped in Nagios.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[87](#CHP-8-FN-3)]) [http://www.my-plugin.de/wiki/de/projects/check_multi/installation#c
    heck_by_ssh](http://www.my-plugin.de/wiki/de/projects/check_multi/installation#c%20heck_by_ssh)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[88](#CHP-8-FN-4)]) [http://www.my-plugin.de/wiki/de/projects/check_multi/start](http://www.my-plugin.de/wiki/de/projects/check_multi/start)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[89](#CHP-8-FN-5)]) Let us assume that 53 have passed since **`check_multi`**
    was called, but not all planned individual checks have yet been processed. The
    total from starting time and individual timeout (53 + 10 = 63) exceeds the timeout
    of the **`check_multi`** call, so **`check_multi`** does not start any further
    checks.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[90](#CHP-8-FN-6)]) [http://www.my-plugin.de/wiki/de/projects/check_multi/screenshot#ser-vice_extended_info_rekursiv](http://www.my-plugin.de/wiki/de/projects/check_multi/screenshot#ser-vice_extended_info_rekursiv)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[91](#CHP-8-FN-7)]) [http://www.nagioserchange.org/22;1088](http://www.nagioserchange.org/22;1088)
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 9. Executing Plugins via SSH
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Local plugins, that is, programs that only run tests locally because there are
    no network protocols available, must be installed on the target system and started
    there. They check processes, CPU load, or how much free hard disk capacity is
    still available, among other things.
  prefs: []
  type: TYPE_NORMAL
- en: But if you still want to execute these plugins from the Nagios server, it is
    recommended that you use the secure shell, especially if any kind of Unix system
    is installed on the machine to be tested—a Secure Shell daemon will almost always
    be running on such a target system, and you do not require any special permissions
    to run most plugins. The Nagios administrator needs nothing more than an account,
    which he can use from the Nagios server. On the server itself, the **`check_by_ssh`**
    plugin must be installed.
  prefs: []
  type: TYPE_NORMAL
- en: 'In heterogeneous environments the Secure Shell itself often create conditions
    that may cause problems: depending on the operating system, an SSH daemon may
    be in use that returns a false return code^([[92](#ftn.CHP-9-FN-1)]) or is so
    old that it cannot handle the SSH protocol version 2.0\. In this case it is better
    to install the current OpenSSH version.^([[93](#ftn.CHP-9-FN-2)]) In pure Linux
    environments with up-to-date and maintained installations, such problems generally
    do not occur.'
  prefs: []
  type: TYPE_NORMAL
- en: 9.1 The **`check_by_ssh`** Plugin
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '**`check_by_ssh`** is run on the Nagios server and establishes a Secure Shell
    connection to a remote computer so that it can perform local tests on it. The
    programs run on the remote machine are to a large extent local plugins (see [Chapter 7](../Text/ch07.html
    "Chapter 7. Testing Local Resources") from page 157); the use of **`check_by_ssh`**
    is not just restricted to these, however.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The plugin sends a complete command line to the remote computer and then waits
    for a plugin-compatible response: a response status between **`0`** (OK) and **`3`**
    (UNKNOWN), as well as a one-line text information for the administrator ([Chapter 6](../Text/ch06.html
    "Chapter 6. Plugins for Network Services")).'
  prefs: []
  type: TYPE_NORMAL
- en: If you run network plugins via **`check_by_ssh`** in order to perform tests
    on other computers, these are known as *indirect checks*, which will be explained
    in the context of the *Nagios Remote Plugin Executor* in [10.6 Indirect Checks](../Text/ch10s06.html
    "10.6 Indirect Checks") from page 224.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example shows how **`check_by_ssh`** can be used to check the
    swap partition on the target computer:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE167]'
  prefs: []
  type: TYPE_PRE
- en: The command is similar to that for a secure shell, in the form of
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE168]'
  prefs: []
  type: TYPE_PRE
- en: The fact that a separate private key—not the default private key in the home
    directory—is used, is optional and is described in detail in [9.2 Configuring
    SSH](../Text/ch09s02.html "9.2 Configuring SSH") from page 208\. The command to
    be run is specified in **`check_by_ssh`**—in contrast to the secure shell **`ssh`**—with
    the option **`-C`**, the plugin is always specified with an absolute path.
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_by_sshhas`** the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --hostname=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The host name or IP address of the computer to which the plugin should set up
    an SSH connection.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`command`*``** **`/--command=`****``*`command`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'The command to be run on the remote computer, that is, the plugin with its
    complete path and all the necessary parameters:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE169]'
  prefs: []
  type: TYPE_PRE
- en: '**`−1 /--proto1`**'
  prefs: []
  type: TYPE_NORMAL
- en: Force version 1 of the secure shell protocol.
  prefs: []
  type: TYPE_NORMAL
- en: '**`−2 /--proto2`**'
  prefs: []
  type: TYPE_NORMAL
- en: Force version 2 of the secure shell protocol.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-o`** **``*`ssh_option`*``** **`/--ssh-option=`****``*`ssh_option`*``**
    (from version 1.4.6)'
  prefs: []
  type: TYPE_NORMAL
- en: Passes an SSH option to the secure shell on the target host. To specify multiple
    options, use of the switch is repeated.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-i`** **``*`keyfile`*``** **`/--ldentlty=`****``*`keyfile`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Which file should be used instead of the standard key file containing the private
    key of the user **`nagios?`** For one option, which is recommended, see [9.2.3
    Checking the SSH connection and check_by_ssh](../Text/ch09s02.html#checking_the_ssh_connection_and_check_un
    "9.2.3 Checking the SSH connection and check_by_ssh"), page 210.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/--port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the port if the Secure Shell daemon on the target server is not
    listening on the standard TCP port 22.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-l`** **``*`user`*``** **`/--logname=`****``*`user`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: User name on the target host. [**`-S`** **``*`number`*``** /**``--skip-stdout=*`number`*``**
    (from version 1.4.9)]
  prefs: []
  type: TYPE_NORMAL
- en: Ignores the specified number of lines at the beginning of the output to STDOUT.
    If this option is omitted, the entire output is ignored.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-E`** **``*`number`*``** **`/--skip-stderr=`****``*`lines`*``** (from version
    1.4.9)'
  prefs: []
  type: TYPE_NORMAL
- en: Like **`--skip-stdout`**, but refers only to the output of STDERR.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`floating_point_decimal`*``** **`/--warning=`****``*`floating_point_decimal`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the response to the command to be executed takes more than *floating_point_decimal*
    seconds, the plugin will issue a warning.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`floating_point_decimal`*``** **`/--critical=`****``*`floating_point_decimal`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The critical value in seconds concerning the response time of the command to
    be executed.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-f`**^([[94](#ftn.CHP-9-FN-3)])'
  prefs: []
  type: TYPE_NORMAL
- en: Starts a background process without opening an interactive terminal (tty).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-t`** *timeout* /**`--timeout=`***timeout*'
  prefs: []
  type: TYPE_NORMAL
- en: After *timeout* seconds have expired, the plugin stops the test and returns
    the CRITICAL status. The default is **`10`** seconds.
  prefs: []
  type: TYPE_NORMAL
- en: In addition to this, **`check_by_ssh`** has parameters available, **`-o`**,
    **`-s`** and **`-n`**, enabling it to write the result in *passive mode* to the
    *interface for external commands* (see [13.1 The Interface for External Commands](../Text/ch13.html#the_interface_for_external_commands
    "13.1 The Interface for External Commands") from page 292). The mode is named
    this way because Nagios does not receive the information itself but reads it indirectly
    from the interface.
  prefs: []
  type: TYPE_NORMAL
- en: This procedure has the advantage of being able to run several separate commands
    simultaneously over a single SSH connection. This may cause the command definition
    to be rather complicated, however. Since the plugins themselves are called and
    executed as programs on the target server, it hardly matters whether the SSH connection
    is established once or three times. For this reason it is better to use a simple
    command definition rather than the passive mode.
  prefs: []
  type: TYPE_NORMAL
- en: But if you still want to find more information about this, you can look in the
    online help, which is called with **`check_by_ssh -h`**.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[92](#CHP-9-FN-1)]) In the **`nagios-users`** mailing list it was reported
    that **`Sun_SSH_1.0`** returns a return code of 255 instead of 0, which makes
    it unsuitable for the deployment described here.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[93](#CHP-9-FN-2)]) [http://www.openssh.org/](http://www.openssh.org/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[94](#CHP-9-FN-3)]) There is currently no long form for this option.
  prefs: []
  type: TYPE_NORMAL
- en: 9.2 Configuring SSH
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: So that Nagios can run plugins over the secure shell remotely and automatically,
    it—or, strictly speaking, the user **`nagios`** on the Nagios server—must not
    be distracted by any password queries. This is avoided with a login via a Public
    Key mechanism.
  prefs: []
  type: TYPE_NORMAL
- en: 9.2.1 Generating SSH key pairs on the Nagios server
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The key pair required to do this is stored by the key generator **`ssh-keygen`**
    by default in the subdirectory **`.ssh`** of the respective user''s home directory
    (for the user **`nagios`**, this therefore corresponds to the installation guide
    in [1.2 Compiling Source Code](../Text/ch01s02.html "1.2 Compiling Source Code")
    from page 39, that is, **`/usr/local/nagios`**). If it is also sent on its way
    with the **`-f`** **``*`private_keyfile`*``** option (without path specification),
    it will land in the current working directory, which in the following example
    is **`/etc/nagios/.ssh`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE170]'
  prefs: []
  type: TYPE_PRE
- en: 'The length of the key here is 1024 bits, and DSA is used to encrypt the keys.
    **`-N'' ''`** ensures that the private key in **`id_dsa`** does not receive separate
    password protection: this option forces an empty password.'
  prefs: []
  type: TYPE_NORMAL
- en: 9.2.2 Setting up the user **`nagios`** on the target host
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Similar to the configuration on the Nagios server, the group and the user **`nagios`**
    are also set up on the computer to be monitored:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE171]'
  prefs: []
  type: TYPE_PRE
- en: 'The target computer is given the directory **`/home/nagios`** as the home directory,
    where a subdirectory **`.ssh`** is created. In this the administrator (or another
    user^([[95](#ftn.CHP-9-FN-4)])) saves the public key generated on the Nagios server
    **`/etc/nagios/.ssh/id_dsa.pub`**, in a file called **`authorized_keys`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE172]'
  prefs: []
  type: TYPE_PRE
- en: 'Now the user **`nagios`** does not require its own password on the target server.
    You just need to make sure that on the target server the **`.ssh`** directory,
    together with **`authorized_keys`**, belongs to the user **`nagios`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE173]'
  prefs: []
  type: TYPE_PRE
- en: 9.2.3 Checking the SSH connection and **`check_by_ssh`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'With this configuration you should first check whether the secure shell connection
    is working properly. The test is performed as the user **`nagios`**, since Nagios
    makes use of this during the checks:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE174]'
  prefs: []
  type: TYPE_PRE
- en: The **`-i`** option explicitly specifies the path to the private key file. If
    the command **`w`** to be run on the target computer does not provide any output
    or if the opposite SSH daemon requests a password, then the login via public key
    is not working. In this case you must first find and eliminate the error before
    you can move on to testing **`check_by_ssh`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this next step, you run the local plugin on the target computer, with **`check_by_ssh`**,
    which later on is run automatically, from the command line of the Nagios server.
    Make sure that the plugin paths are correct in each case. The path to the private
    key file of the user **`nagios`** on the server is specified with **`-i`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE175]'
  prefs: []
  type: TYPE_PRE
- en: In the example, **`check_by_ssh`** should start the **`/usr/local/nagios/libexec/check_disk`**
    plugin on the target computer with the options **`-w 10% -c 5% -e -m`**. If this
    does not work, then this is first run locally on the target host with the same
    parameter. By doing this you can rule out that the problem lies in the plugin
    command itself and not in the secure shell connection.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[95](#CHP-9-FN-4)]) ... but not the user **`nagios`**, because when an account
    is created, **`useradd`** first sets an invalid password here, which we do not
    change into a valid one. This means that you cannot currently log in to the target
    computer as **`nagios`**.
  prefs: []
  type: TYPE_NORMAL
- en: 9.3 Nagios Configuration
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The matching command object is again defined in the file **`checkcommands.cfg`**;
    similar to **`check_local_disk`**, it should be named **`check_ssh_disk`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE176]'
  prefs: []
  type: TYPE_PRE
- en: The command line stored in **`command_line`** first runs **`check_by_ssh; $USER1$`**
    contains the local plugin path on the Nagios server. Next come the arguments—the
    IP address of the target host (parameter **`-H`**), the private key file (parameter
    **`-i`**) and finally, with the **`-C`** parameter, the complete command that
    the target host should carry out. If the plugin path on the target host and on
    the Nagios server are identical, then you can also use the **`$USER1$`** macro
    in it; otherwise the plugin path on the target computer is given explicitly.
  prefs: []
  type: TYPE_NORMAL
- en: Setting up the command is no different here to the one in **`check_local_disk`**
    in [7.1 Free Hard Drive Capacity](../Text/ch07.html#free_hard_drive_capacity "7.1
    Free Hard Drive Capacity") in page 158\. This means that apart from the warning
    and critical limits, we explicitly specify a file system or a hard drive partition,
    with the **`-p`** parameter.
  prefs: []
  type: TYPE_NORMAL
- en: 'The command **`check_ssh_disk`** defined in this way is applied as follows,
    here on a computer called **`linux02`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE177]'
  prefs: []
  type: TYPE_PRE
- en: The service object defined in this way ensures that Nagios checks its **`/`**
    file system. The warning limit lies at 10 percent, the critical limit at 5 percent.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you use the **`check_by_ssh`** plugin with **`check_ssh_disk`**, as in the
    example here, you must make sure that the plugin path is identical on all target
    hosts. This is also worth doing for reasons of simplicity, though it is not always
    possible in practice. The following service definition, for this reason, gives
    the plugin path to the target computer as an additional argument:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE178]'
  prefs: []
  type: TYPE_PRE
- en: 'In order for this to work, you must change the command line in the command
    definition, passed on with **`-C`**, as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE179]'
  prefs: []
  type: TYPE_PRE
- en: 'Caution: this causes the numbers of each of the **`$ARGx`** macros for **`-w`**,
    **`-c`**, and **`-p`** to be shifted by one.'
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 10. The Nagios Remote Plugin Executor (NRPE)
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The *Nagios Remote Plugin Executor* (or in short, NRPE) as the name suggests,
    executes programs on a remote host. These are usually plugins that test the corresponding
    computer locally and therefore must be installed on it. The use of NRPE is not
    restricted to local plugins; any plugins at all can be executed, including those
    intended to test network services—for example, to indirectly test computers that
    are not reachable from the Nagios server (as shown in [10.6 Indirect Checks](../Text/ch10s06.html
    "10.6 Indirect Checks") from page 224).
  prefs: []
  type: TYPE_NORMAL
- en: 'While a genuine user account must be available on the remote computer when
    the secure shell is used (see [Chapter 9](../Text/ch09.html "Chapter 9. Executing
    Plugins via SSH")), which can also be used to do other things than just start
    plugins, NRPE is restricted exclusively to explicitly configured tests. If you
    want to, or are forced to, do without a login shell on the target host, it is
    better to use NRPE, even if there is somewhat more configuration work involved
    than with the secure shell. In addition to the Nagios configuration and the installation
    of the **`check_nrpe`** plugin on the Nagios server, the following tasks remain
    on the target system:'
  prefs: []
  type: TYPE_NORMAL
- en: The program **`nrpe`** must be installed.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The inet daemon there (**`inetd`** or **`xinetd`**) must be configured with
    administrator privileges.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: All the plugins called via NRPE must be installed.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 10.1 Installation
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: NRPE and the plugins are installed from the sources, or you can fall back on
    the packages provided by the distributor. You should use at least version 2.0
    of NRPE, since this is incompatible with its predecessors. Starting with version
    2.6, NRPE has the switch **`-u`**. If the NRPE service on the target system is
    not reachable, the plugin **`check_nrpe`** on the Nagios server returns an UNKNOWN
    for this switch. Starting with version 2.8, NRPE supports the multi-line output
    of plugins that was introduced with Nagios 3.0 (see [8.5.1 Multiple-line plugin
    output](../Text/ch08s05.html#multiple-line_plugin_output "8.5.1 Multiple-line
    plugin output") from page 193). At the time this book went to press, the current
    version was 2.12, dated 26\. 03\. 2008.
  prefs: []
  type: TYPE_NORMAL
- en: All established distributions include the plugin collection from at least version
    1.4\. Whether you need the most up-to-date version depends on your expectations
    of the respective plugins.
  prefs: []
  type: TYPE_NORMAL
- en: 10.1.1 Distribution-specific packages
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: SuSE Linux 10.3 includes the packages **`nagios-nrpe-2.10-4.1.i586.rpm, nagios-plugins-1.4.10-12.1.i586.rpm`**,
    and **`nagios-plugins-extras −1.4.10-12.1.i586.rpm.nagios-nrpe`** contains both
    the daemon and the plugin **`check_nrpe. nagios-plugins-extras`** installs several
    additional plugins, such as database checks, FPing test or Radius test, which
    can be omitted, depending on your specific monitoring needs.
  prefs: []
  type: TYPE_NORMAL
- en: For the sake of simplicity, the design packages are installed via YAST2^([[96](#ftn.CHP-10-FN-1)])
    or **`rpm -ihv`** **``*`package`*``**. the second method is also open to Fedora
    users.
  prefs: []
  type: TYPE_NORMAL
- en: For Fedora Core and Red Hat Enterprise Linux, Dag Wieers has made available
    corresponding Nagios packages of several versions.^([[97](#ftn.CHP-10-FN-2)])
  prefs: []
  type: TYPE_NORMAL
- en: Debian/Sarge distributes the NRPE daemon and the NRPE plugin **`check_nrpe`**
    in two different packages called **`nagios-nrpe-server`** and **`nagios-nrpe-plugin`**,
    which can be installed separately via **`apt-get install`** **``*`package`*``**.
    If you want to do without local documentation, you can omit the package **`nagios-nrpe-doc`**
    and just add the plugin package **`nagios-plugins`** to the target hosts.
  prefs: []
  type: TYPE_NORMAL
- en: The paths for the program **`nrpe`**, the configuration file **`nrpe.cfg`**,
    and the plugin directory are listed in [Table 10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "Table 10-1. Installation paths for NRPE and plugins").
  prefs: []
  type: TYPE_NORMAL
- en: Table 10-1. Installation paths for NRPE and plugins
  prefs: []
  type: TYPE_NORMAL
- en: '| Distribution | NRPE program | Configuration file | Plugins |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| ^([[a](#ftn.CHP-10-TFN-3)]) |'
  prefs: []
  type: TYPE_TB
- en: '| ^([[b](#ftn.CHP-10-TFN-4)]) |'
  prefs: []
  type: TYPE_TB
- en: '| Self-compiled^([[a](../Text/ch10.html#ftn.CHP-10-TFN-3)]) | **`/usr/local/sbin/nrpe`**
    | **`/etc/nagios/nrpe.cfg`** | **`/usr/local/nagios/libexec`** |'
  prefs: []
  type: TYPE_TB
- en: '| SuSE | **`/usr/bin/nrpe`** | **`/etc/nagios/nrpe.cfg`** | **`/usr/lib/nagios/plugins`**
    |'
  prefs: []
  type: TYPE_TB
- en: '| Debian | **`/usr/sbin/nrpe`** | **`/etc/nagios/nrpe.cfg`** | **`/usr/lib/nagios/plugins`**
    |'
  prefs: []
  type: TYPE_TB
- en: '| Fedora^([[b](../Text/ch10.html#ftn.CHP-10-TFN-4)]) | **`/usr/sbin/nrpe`**
    | **`/etc/nagios/nrpe.cfg`** | **`/usr/lib/nagios/plugins`** |'
  prefs: []
  type: TYPE_TB
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[a](#CHP-10-TFN-3)]) Recommended.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[b](#CHP-10-TFN-4)]) From the packages provided by Dag Wieers.
  prefs: []
  type: TYPE_NORMAL
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: 10.1.2 Installation from the source code
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The plugins are installed on the computers to be monitored exactly as described
    in [1.4 Installing and Testing Plugins](../Text/ch01s04.html "1.4 Installing and
    Testing Plugins") from page 43 for the Nagios server.
  prefs: []
  type: TYPE_NORMAL
- en: The NRPE source code is obtained from the Nagios homepage.^([[98](#ftn.CHP-10-FN-5)])
    The directory **`/usr/local/src`**^([[99](#ftn.CHP-10-FN-6)]) is ideal for unloading
    the sources.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE180]'
  prefs: []
  type: TYPE_PRE
- en: 'In the new directory that has been created, you run the **`configure`** command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE181]'
  prefs: []
  type: TYPE_PRE
- en: The recommended path specifications are listed in [Table 10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "Table 10-1. Installation paths for NRPE and plugins"). The only difference from
    the default settings are for the directory in which the NRPE configuration file
    is stored (**`configure`** option **`--sysconfdir`**).
  prefs: []
  type: TYPE_NORMAL
- en: Accordingly, we can leave out the entry for **`--with-nrpe-user`** and **`--with-nrpe-group`**
    in the **`configure`** command. Both options are relevant only if the **`nrpe`**
    program is running as a daemon, and they can be overwritten in the configuration
    file. If the inet daemon is used, you should specify the user with whose permissions
    **`nrpe`** should start in the configuration file for the inet daemon.
  prefs: []
  type: TYPE_NORMAL
- en: '**`--enable-ssl`** ensures that NRPE communicates over an SSL-encrypted channel.
    This will only work, of course, if both **`nrpe`** on the target host and **`check_nrpe`**
    on the Nagios server have both been compiled accordingly.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The command **`make all`** compiles the programs **`nrpe`** and **`check_nrpe`**,
    but it does *not* copy them from **`/usr/local/src/nrpe-2.11/src`** to the corresponding
    system directories. Since there is no **`make install`**, you must do this yourself,
    following the details in [Table 10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "Table 10-1. Installation paths for NRPE and plugins"): you need to have **`nrpe`**
    on the computer to be monitored and the **`check_nrpe`** plugin on the Nagios
    server.'
  prefs: []
  type: TYPE_NORMAL
- en: If the Nagios server and the target host used the same platform, you can compile
    both programs on one computer (e.g., the server) and then copy **`nrpe`** together
    with its configuration file to the computer to be monitored, instead of separately
    compiling **`check_nrpe`** on the Nagios server and **`nrpe`** on the target system.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[96](#CHP-10-FN-1)]) On the command line, using **`yast -i`** **``*`package`*``**.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[97](#CHP-10-FN-2)]) [http://dag.wieers.com/](http://dag.wieers.com/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[98](#CHP-10-FN-5)]) [http://www.nagios.org/download/](http://www.nagios.org/download/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[99](#CHP-10-FN-6)]) The subdirectory **`src`** may need to be created first.
  prefs: []
  type: TYPE_NORMAL
- en: 10.2 Starting via the inet Daemon
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: It is best to start the program **`nrpe`** on the machine to be monitored via
    the inet daemon rather than as a separate daemon, since the Nagios server only
    performs the tests occasionally, and **`nrpe`** does not need to load any large
    resources.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you have a choice, you should use the more modern **`xinetd`**. But to keep
    work to a minimum, the inet daemon will normally be used, as it is already running
    on the target system. In order that NRPE can be started as a service via **`inetd`**
    or **`xinetd`**, the **`nrpe`** service is defined in the file **`/etc/services`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE182]'
  prefs: []
  type: TYPE_PRE
- en: Even if this has been installed as a package, you should still check to see
    whether this entry exists. By default, NRPE uses TCP port 5666.
  prefs: []
  type: TYPE_NORMAL
- en: 10.2.1 **`xinetd`** configuration
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If **`xinetd`** is used, a separate file is stored in the directory **`/etc/xinetd.d`**.
    for each service to be started, so for **`nrpe`** it is best to create a file
    called **`nrpe`** or **`nagios-nrpe`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE183]'
  prefs: []
  type: TYPE_PRE
- en: The values printed in italics are passed on to your own environment; instead
    of the placeholder **``*`ip_of_the_nagios_server`*``** you should enter, for example
    for **`only_from`**, the IP address of your own Nagios server. The NRPE access
    from outside is then restricted to this computer and to **`local-host`** (**`127.0.0.1`**).
    The latter address allows local tests; multiple IP addresses are separated by
    a space. However, this restrictive configuration functions only if **`xinetd`**
    has been compiled with support for the TCP wrapper (this is normally the case).
  prefs: []
  type: TYPE_NORMAL
- en: Under no circumstances should NRPE run with the permissions of a privileged
    user—**`nobody`** is therefore a sensible value. The **`server`** parameter specifies
    the complete path to the program **`nrpe;`** for **`server_args`** you should
    enter the matching path to the configuration file. After this modification, the
    configuration of **`xinetd`** is reloaded, with
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE184]'
  prefs: []
  type: TYPE_PRE
- en: 10.2.2 **`inetd`** configurationt
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In the standard **`inetd`**, the following line is added to the configuration
    file **`/etc/inetd.conf`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE185]'
  prefs: []
  type: TYPE_PRE
- en: 'The line has been split up for reasons of space, but in the configuration file
    this must all be in a single line. Here the TCP wrapper **`tcpd`** is used. If
    this is not intended, you simply leave out this entry^([[100](#ftn.CHP-10-FN-7)])
    Here you should also explicitly enter the user **`nobody`**, the complete path
    to the binary **`nrpe`**, and the configuration file, also with its complete path.
    These strings, printed above in italics, should be adjusted to your own system,
    where necessary. After the configuration change, **`inetd`** is reloaded:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE186]'
  prefs: []
  type: TYPE_PRE
- en: 10.2.3 Is the Inet daemon watching on the NRPE port?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'A simple test shows whether the inet daemon wants to respond to queries on
    port 5666:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE187]'
  prefs: []
  type: TYPE_PRE
- en: The program **`netstat`** uses option **`−1`** to display all the ports on which
    a service is waiting for incoming queries, that is, a service which is in the
    **`LISTEN`** state. Option **`-n`** suppresses the name resolution of hosts and
    ports and speeds up the display of information, and **`-t`** restricts the otput
    to TCP ports.
  prefs: []
  type: TYPE_NORMAL
- en: The test shows only whether the inet daemon was properly configured and newly
    started, for instance, whether the **`nrpe`** service is correctly entered in
    **`/etc/services`**. It does not clarify whether the paths to the NRPE daemon
    and its configuration file are correct. Errors like this are announced by the
    inet daemon only when a concrete access attempt takes place on NRPE port 5666\.
    The subsequent complete function test is carried out only after the NRPE daemon
    has been configured. This is described in [10.4 NRPE Function Test](../Text/ch10s04.html
    "10.4 NRPE Function Test") from page 221.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[100](#CHP-10-FN-7)]) **`inetd`** does not have a built-in method to allow
    access to services only from specific IP addresses. This function is added in
    the TCP wrapper **`tcpd`**. The access configuration is then taken over by the
    files **`/etc/hosts.allow`** and **`/etc/hosts.deny`**. More information on this
    is given by **`man host_access`**.
  prefs: []
  type: TYPE_NORMAL
- en: 10.3 NRPE Configuration on the Computer to Be Monitored
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'When compiling NRPE, the file **`nrpe.cfg`** is created in the source directory,
    which contains several parameters as well as the commands to run NRPE. These are
    copied manually to the configuration directory, which normally first has to be
    created on the target computer:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE188]'
  prefs: []
  type: TYPE_PRE
- en: Distribution-specific packages are unpacked from the location specified in [Table 10-1](../Text/ch10.html#installation_paths_for_nrpe_and_plugins
    "Table 10-1. Installation paths for NRPE and plugins") in page 215.
  prefs: []
  type: TYPE_NORMAL
- en: '**`nrpe`** is given the permissions of the user at runtime specified in the
    inet daemon configuration, which in our case is that of **`nobody`**. Therefore
    **`nrpe.cfg`** needs to be readable for this user. As long as the file does not
    contain any passwords (these really should not be used) or other critical information,
    then read permissions for all can be allowed.'
  prefs: []
  type: TYPE_NORMAL
- en: The configuration file contains many comments; the following command displays
    the active parameters:^([[101](#ftn.CHP-10-FN-8)])
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE189]'
  prefs: []
  type: TYPE_PRE
- en: The parameters **`server_port`**, **`allowed_hosts`**, **`nrpe_user`**, and
    **`nrpe_group`** are only relevant if **`nrpe`** is working as a daemon. When
    the inet daemon is used, the program ignores these values since they have already
    been determined by the **`(x) indetd`** configuration.
  prefs: []
  type: TYPE_NORMAL
- en: The entry **`dont_blame_nrpe=0`** prevents **`nrpe`** from accepting parameters,
    thus closing a potential security hole. **`debug=l`** allows extensive logging,
    useful if you are looking for errors (**`debug=0`** switches off the output for
    debugging information), and **`command_timeout`** specifies a timespan in seconds
    after which **`nrpe`** abruptly interrupts a plugin that has hung. Comments in
    the configuration file explain all these parameters as well.
  prefs: []
  type: TYPE_NORMAL
- en: After this, the commands are defined that are to be executed by NRPE. The configuration
    file **`nrpe.cfg`** already contains some, but first they all have to be commented
    out, and only those commands activated that really are intended for use.
  prefs: []
  type: TYPE_NORMAL
- en: The keyword **`command`** is followed in square brackets by the name with which
    **`check_nrpe`** should call the command. After the equals sign (=), the corresponding
    plugin command is specified, with its complete path:^([[102](#ftn.CHP-10-FN-9)])
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE190]'
  prefs: []
  type: TYPE_PRE
- en: With the path, care must be taken that this really does point to the local plugin
    directory. In the directory specified here, **`/usr/local/nagios/libexec`**, the
    self-compiled plugins are located^([[103](#ftn.CHP-10-FN-10)]); and for installations
    from distribution packages the path is usually **`/usr/lib/nagios/plugins`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'From the Nagios server, the command just defined, **`check_users`** is now
    run on the *target computer* via **`check_nrpe`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE191]'
  prefs: []
  type: TYPE_PRE
- en: 10.3.1 Passing parameters on to local plugins
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The method described so far has one disadvantage: for each test on the target
    system, a separately defined command is required for this. Here is the example
    of a server on which the plugin **`check_disk`** (see [7.1 Free Hard Drive Capacity](../Text/ch07.html#free_hard_drive_capacity
    "7.1 Free Hard Drive Capacity") from page 158) is required to monitor nine file
    systems:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE192]'
  prefs: []
  type: TYPE_PRE
- en: 'To avoid all this work, NRPE can also be configured so that parameters may
    be passed on to **`check_nrpe`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE193]'
  prefs: []
  type: TYPE_PRE
- en: In order for this to work, the NRPE **`configure`** script must be run with
    the option
  prefs: []
  type: TYPE_NORMAL
- en: '**`--enable-command-args`**. The reason for this inconvenient procedure is
    that passing parameters on is a fundamental risk, since it cannot be ruled out
    that a certain choice of parameters could cause an (as yet unknown) buffer overflow,
    allowing the target system to be penetrated.'
  prefs: []
  type: TYPE_NORMAL
- en: If you still decide on this, despite all the security risks, you should use
    a TCP wrapper (see [10.2.2 inetd configurationt](../Text/ch10s02.html#inetd_configurationt
    "10.2.2 inetd configurationt"), page 217), to ensure that only the Nagios server
    itself is allowed to send commands to NRPE.
  prefs: []
  type: TYPE_NORMAL
- en: 'If the plugin provides the corresponding options, there is sometimes a third
    method, however: the above-mentioned problem can also be solved by getting **`check_disk`**,
    if necessary, to test all file systems with one single command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE194]'
  prefs: []
  type: TYPE_PRE
- en: 'The **`-e`** parameter persuades the plugin to display only those file systems
    that produced a warning or an error. One restriction remains: the warning and
    critical limits are, by necessity, the same for all file systems.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[101](#CHP-10-FN-8)]) The regular expression **`^#|^$`** matches all lines
    that either begin with a comment sign **`#`** or that consist of an empty line.
    The option **`-v`** ensures that **`egrep`** shows all lines that are *not* matched
    by this.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[102](#CHP-10-FN-9)]) The **`check_users`** command is explained in [7.6
    Keeping Tabs on the Number of Logged-In Users](../Text/ch07s06.html "7.6 Keeping
    Tabs on the Number of Logged-In Users") from page 177, **`check_load`** is explained
    in [7.3 Testing the System Load](../Text/ch07s03.html "7.3 Testing the System
    Load") from page 162, and [7.4 Monitoring Processes](../Text/ch07s04.html "7.4
    Monitoring Processes") from page 163 deals with **`check_procs`**.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[103](#CHP-10-FN-10)]) ... provided you have followed the instructions in
    the book.
  prefs: []
  type: TYPE_NORMAL
- en: 10.4 NRPE Function Test
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'For a concluding function test, the plugin **`check_nrpe`** on the Nagios server
    is called. The command **`-H`** **``*`target`*``** **`host`** returns the IP address
    specified for the server on which the NRPE service has just been installed:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE195]'
  prefs: []
  type: TYPE_PRE
- en: The error message given here occurs very frequently and causes confusion almost
    as often because although problems may occur with the SSL handshake, the cause
    is to be found elsewhere in most cases. You only have an SSL problem if the SSL
    versions used by the plugin **`check_nrpe`** and the **`NRPE daemon`** addressed
    are incompatible or if one of the two software packages was compiled without SSL
    and the other was compiled with SSL.
  prefs: []
  type: TYPE_NORMAL
- en: 'Otherwise, the cause will lie elsewhere: The problem could be caused by an
    error in the configuration file, the inet daemon being unable to find the NRPE
    program or configuration file, or access permissions for the file **`nrpe.cfg`**
    that are not sufficient. You would also receive the error message mentioned if
    the Nagios server cannot access the NRPE service at all via the inetd configuration.
    In this case, you need to check the parameter **`only_from`** for **`xinetd`**
    or the same restrictions via the **`tcpd`** for **`inetd`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'You can search for the exact cause of error in the syslog files, particularly
    in the file **`messages`**, and depending on the distribution, also in **`warn.log`**,
    **`daemon.log`**, or another log file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE196]'
  prefs: []
  type: TYPE_PRE
- en: In this example, the file **`nrpe.cfg`** is either not in the path being searched
    or **`nrpe`** cannot open it. Since **`nrpe`** is running with the permissions
    of the user **`nobody`**, it must also be able to read the configuration file.
  prefs: []
  type: TYPE_NORMAL
- en: 'A successful call of **`check_nrpe`** will then provide the version of the
    installed NRPE service:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE197]'
  prefs: []
  type: TYPE_PRE
- en: 10.5 Nagios Configuration
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Commands that "trigger" local plugins on remote computers via **`check_nrpe`**
    are defined as before in the file **`checkcommands.cfg`** on the Nagios server.
  prefs: []
  type: TYPE_NORMAL
- en: 10.5.1 NRPE without passing parameters on
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If no parameters are passed on to the target plugin, things will look like
    this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE198]'
  prefs: []
  type: TYPE_PRE
- en: As the only argument, Nagios passes the command here that NRPE is to execute.
    If the **`check_nrpe`** plugin on the Nagios server is located in a different
    directory to the other plugins, you must enter the correct path instead of **`$USER1$`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'A service to be tested via NRPE uses the command just defined, **`check_nrpe`**,
    as **`check_command`**. As an argument, the command is specified that was defined
    in **`nrpe.cfg`** on the target system (here: **`linux04`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE199]'
  prefs: []
  type: TYPE_PRE
- en: 10.5.2 Passing parameters on in NRPE
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In order to address the command defined in [10.3.1 Passing parameters on to
    local plugins](../Text/ch10s03.html#passing_parameters_on_to_local_plugins "10.3.1
    Passing parameters on to local plugins") in page 220
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE200]'
  prefs: []
  type: TYPE_PRE
- en: 'from the Nagios server, the **`check_nrpe`** is given the corresponding arguments
    through the option **`-a`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE201]'
  prefs: []
  type: TYPE_PRE
- en: 'So that **`$ARG2$`** can correctly transport the parameters for the remote
    plugin, these are separated by spaces in the service definition. in addition,
    you should ensure that the order is correct:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE202]'
  prefs: []
  type: TYPE_PRE
- en: The locally installed **`check_disk`** on **`linux04`** distributes the three
    strings **`10%, 5%`**, and /var to its own three macros **`$ARG1$`**, **`$ARG2$`**,
    and **`$ARG3$`** for the command defined in **`nrpe.cfg`**.
  prefs: []
  type: TYPE_NORMAL
- en: 10.5.3 Optimizing the configuration
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If the NRPE commands are given identical names on all target systems, then
    all NRPE commands with the same name can be included in a single service definition.
    When doing this you can make use of the possibility of specifying several hosts,
    or even an entire group of hosts:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE203]'
  prefs: []
  type: TYPE_PRE
- en: 'With the command **`check_disk_var`**, defined at the beginning of [10.3.1
    Passing parameters on to local plugins](../Text/ch10s03.html#passing_parameters_on_to_local_plugins
    "10.3.1 Passing parameters on to local plugins") in page 220, Nagios now checks
    the **`/var`** file systems on the computers **`linux04`**, **`linux02`**, and
    **`linux11`**. If other file systems are to be included in the test, a separate
    service is created for each one, thus avoiding the security problem involved in
    passing parameters on. If you use the option of testing all file systems at the
    same time, with the **`check_disk`** plugin (see [7.1 Free Hard Drive Capacity](../Text/ch07.html#free_hard_drive_capacity
    "7.1 Free Hard Drive Capacity")), then ultimately, one single service definition
    is sufficient to monitor all file systems on all Linux servers— provided you have
    a corresponding NRPE configuration on the target system:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE204]'
  prefs: []
  type: TYPE_PRE
- en: 10.6 Indirect Checks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: NRPE executes not just local plugins, but any plugins that are available. If
    you use network plugins via NRPE, these are referred to as *indirect checks*,
    as illustrated graphically in [Figure 10-1](../Text/ch10s06.html#indirect_checks_with_nrpe
    "Figure 10-1. Indirect checks with NRPE").
  prefs: []
  type: TYPE_NORMAL
- en: '![Indirect checks with NRPE](../Images/tagoreillycom20081104nostarchimages223814.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 10-1. Indirect checks with NRPE
  prefs: []
  type: TYPE_NORMAL
- en: If every network service was tested directly across the firewall, it would have
    to open all the required ports. In the example, these would be the ports for SMTP,
    HTTP, LDAP, PostgreSQL, and SSH. If the checks are performed indirectly from a
    computer that is behind the firewall, on the other hand, then it is sufficient
    just to have the port for NRPE (TCP port 5666) open on the firewall. As long as
    it is configured via NRPE, the NRPE server behind the firewall can perform any
    tests it wants.
  prefs: []
  type: TYPE_NORMAL
- en: 'Whether the effort involved in indirect checks is greater than that for direct
    ones is dependent on the specific implementation: if this means that you would
    have to "drill holes into your firewall," then the additional work on the NRPE
    server may be worthwhile. But if the ports involved are open anyway, then the
    direct test can usually be recommended; this would make additional configuration
    work on an NRPE host unnecessary.'
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 11. Collecting Information Relevant for Monitoring with SNMP
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: SNMP stands for *Simple Network Management Protocol*, a protocol defined above
    all to monitor and manage network devices. This means being able to have not only
    read access, but also write access to network devices, so that you can turn a
    specific port on a switch on or off, or intervene in other ways.
  prefs: []
  type: TYPE_NORMAL
- en: Nearly all network-capable devices that can also be addressed via TCP/IP can
    handle SNMP, and not just switches and routers. For Unix systems there are SNMP
    daemons; even Windows servers contain an SNMP implementation in their standard
    distribution, although this must be explicitly installed. But even uninterruptible
    power supplies (UPSs) or network-capable sensors are SNMP-capable.
  prefs: []
  type: TYPE_NORMAL
- en: If you are using Nagios, then at some point you can't avoid coming into contact
    with SNMP, because although you usually have a great choice of querying techniques
    for Unix and Windows systems, when it comes to hardware-specific components such
    as switches, without their own sophisticated operating system, then SNMP is often
    the only way to obtain information from the network device. SNMP certainly does
    not have a reputation of being easy to understand, which among other things lies
    in the fact that it is intended for communication between programs, and machine
    processing is in the foreground. In addition, you generally do not make direct
    contact with the protocol and with the original information, since even modems
    or routers provide a simple-to-operate interface that disguises the complexity
    of the underlying SNMP.
  prefs: []
  type: TYPE_NORMAL
- en: If you want to use SNMP with Nagios, you cannot avoid getting involved with
    the information structure of the protocol. [11.1 Introduction to SNMP](../Text/ch11.html#introduction_to_snmp
    "11.1 Introduction to SNMP") therefore provides a short introduction to SNMP.
    [11.2 NET-SNMP](../Text/ch11s02.html "11.2 NET-SNMP") from page 234 introduces
    NET-SNMP, probably the most widely used implementation for SNMP on Unix systems.
    On the one hand it shows how to obtain an overview of the information structure
    of a network device with command-line tools, and on the other it describes the
    configuration of the SNMP daemon in Linux. Finally, [11.3 Nagios's Own SNMP Plugins](../Text/ch11s03.html
    "11.3 Nagios's Own SNMP Plugins") from page 246 is devoted to the concrete use
    of SNMP with Nagios.
  prefs: []
  type: TYPE_NORMAL
- en: 11.1 Introduction to SNMP
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Although SNMP contains the P for "protocol" in its name, this does not stand
    for a protocol alone, but is used as a synonym for the *Internet Standard Management
    Framework*. This consists of the following components:'
  prefs: []
  type: TYPE_NORMAL
- en: Manageable network nodes that can be controlled remotely via SNMP. A specific
    implementation of an SNMP engine, whether by software or hardware, is referred
    to as an *agent*.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: At least one SNMP unit consisting of applications with which the agents can
    be managed. This unit is referred to as a *manager*.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'A protocol with which agent and manager can exchange information: the *Simple
    Network Management Protocol* (SNMP).'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'A well-defined information structure, so that any managers and agents can understand
    each other: the so-called *Management Information Base*, or in short, MIB.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The framework assigns the manager the active role. The agent itself just waits
    passively for incoming commands. In addition, so-called *traps* extend the application
    possibilities of SNMP: these are messages that the agent actively sends to a single
    manager or a whole group of managers, for example if predefined limit values are
    exceeded or if functions of the network device fail.'
  prefs: []
  type: TYPE_NORMAL
- en: As agents, SNMP engines implemented by the manufacturer are used for hardware-specific
    devices (switches, routers). For Linux and general Unix systems, the NET-SNMP
    implementation is available (see [11.2 NET-SNMP](../Text/ch11s02.html "11.2 NET-SNMP")),
    for Windows servers there is equivalent software already included with the operating
    system.
  prefs: []
  type: TYPE_NORMAL
- en: 'In combination with Nagios, there are two possibilities. With respect to Nagios
    in the active role, corresponding Nagios plugins, as the manager, ask the agents
    for the desired information. The other way round, Nagios can also passively receive
    incoming SNMP traps using utilities and process these. [14.6 Application Example
    II: Processing SNMP Traps](../Text/ch14s06.html "14.6 Application Example II:
    Processing SNMP Traps") from page 312 is devoted to this topic.'
  prefs: []
  type: TYPE_NORMAL
- en: An understanding of the SNMP information structure, the so-called *Management
    Information Base* (MIB), is critical if you want to use SNMP with Nagios successfully.
    For this reason this section will focus on this. The protocol itself is only mentioned
    briefly to illustrate the differences between different protocol versions.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you want to get involved more deeply with SNMP, we refer you to the numerous
    *Request for Comments* (RFCs) describing SNMP. The best place to start would be
    in RFC 3410, "Introduction and Applicability Statements for Internet Standard
    Management Framework", and RFC 3411: "An Architecture for Describing Simple Network
    Management Protocol (SNMP) Management Frameworks." Apart from an introduction
    and numerous crosslinks, you will also find references there to the original documents
    of the older versions, today referred to as SNMPv1 and SNMPv2.'
  prefs: []
  type: TYPE_NORMAL
- en: 11.1.1 The Management Information Base
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The SNMP information structure consists of a hierarchical namespace construction
    of numbers. [Figure 11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "Figure 11-1. SNMP namespace using the example of the MIB-II interfaces") shows
    an extract from this. The tree structure is similar to those of other hierarchical
    directory services, such as DNS or LDAP.
  prefs: []
  type: TYPE_NORMAL
- en: Its root is called **`1 (iso)`** and stands for the *International Organization
    for Standardization*. The next level, **`3 (org)`** shown in [Figure 11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "Figure 11-1. SNMP namespace using the example of the MIB-II interfaces") provides
    a space for general, national and international organizations. Beneath this is
    **`6 (dod)`** for the U.S. *Department of Defense*. The general (IP-based) **`internet`**
    owes its assignment as a subitem **`1 (internet)`** of **`dod`** to its origin
    as a military project.
  prefs: []
  type: TYPE_NORMAL
- en: If you bring together the corresponding numbers from left to right and separate
    them with the dot, then for the **`internet`** node in the tree, you arrive at
    the designation **`1.3.6.1`**. Such nodes are referred to in general as *object
    identifiers* (OID). Their syntax is used not only in SNMP but also in the definition
    of LDAP objects and attributes, for example.
  prefs: []
  type: TYPE_NORMAL
- en: 'The OID **`1.3.6.1`** is not exactly easily readable for humans, which is why
    other notation methods have gained acceptance: both **`iso.org.dod.internet`**
    and the combination **`iso(1).org(3).dod(6).internet(1)`** is allowed. Because
    this would quickly make readable descriptions infinitely long if the tree were
    deep enough, another abbreviated notation method has become established: as long
    as the term remains unique, you may simply write **`internet`** instead of **`1.3.6.1`**.'
  prefs: []
  type: TYPE_NORMAL
- en: The important thing here is that the communication between manager and agent
    is exclusively of a numerical nature. Whether the manager also allows text input
    or is capable of issuing information as text instead of as a numeric OID depends
    on the implementation in each case. The information on individual nodes is provided
    by the manufacturer of the SNMP agent as a Management Information Base (MIB) in
    file form.
  prefs: []
  type: TYPE_NORMAL
- en: '![SNMP namespace using the example of the MIB-II interfaces](../Images/tagoreillycom20081104nostarchimages223816.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 11-1. SNMP namespace using the example of the MIB-II interfaces
  prefs: []
  type: TYPE_NORMAL
- en: The data stored in the MIB includes contact information (who designed the MIB;
    usually the manufacturer of the device will be given here), the definition of
    individual subnodes and attributes, and the data types used. If an MIB file also
    describes the individual subnodes and attributes, this puts the manager in a position
    to supply the user with additional information on the meaning and purpose of the
    entry in question.
  prefs: []
  type: TYPE_NORMAL
- en: Below **`internet`**, the next level is divided into various namespaces. The
    management node **`1.3.6.1.2`** is especially important for SNMP, that is, **`iso(1)
    .org(3) .dod(6) .internet(1) .mgmt(2)`**. The namespace here is described by RFC
    1155, "Structure and Identification of Management Information for TCP/IP-based
    Internets."
  prefs: []
  type: TYPE_NORMAL
- en: In order for manager and agent to be able to understand each other, the manager
    needs to know how the agent structures its data. This is where the *Management
    Information Base, Version II* comes into play. SNMP requests information from
    the agents on their implementation; with this, every manager can access the most
    important parameters of the agent, without a previous exchange of MIB definitions.
    The *Management Information Base II*, or MIB-II (or mib-2) for short, can be found
    in the namespace at **`1.3.6.1.2.1`** or **`iso(1).org(3).dod(6).internet(1).mgmt(2).mib-2(1)`**.
    Since it is well-defined and unique, OIDs lying beneath that are usually described
    in short, starting with MIB-II or mib-2.
  prefs: []
  type: TYPE_NORMAL
- en: Manufacturer-specific information can also be defined in your own Management
    Information Base. Corresponding MIBs are located beneath **`internet.private.enterprise`**.
    Once an OID has been described in an MIB, the meaning of this entry may never
    be changed. The description format for an MIB is standardized by RFC 1212, which
    is the reason that special MIBs, included by a vendor for its agents, can be integrated
    into almost any manager.
  prefs: []
  type: TYPE_NORMAL
- en: MIB-II
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: MIB-II, the Management Information Base, which is obligatory for all SNMP agents,
    contains several information groups. The most important of these are summarized
    in [Table 11-1](../Text/ch11.html#mib-ii_groups_open_parenthesis_a_selecti "Table 11-1. MIB-II
    groups (a selection)"). The notation **`mib-2.`****``*`x`*``** stands for **`1.3.6.1.2.1.`****``*`x`*``**.
  prefs: []
  type: TYPE_NORMAL
- en: Table 11-1. MIB-II groups (a selection)
  prefs: []
  type: TYPE_NORMAL
- en: '| Group | OID | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| system | mib-2.1 | Information on the device, (e.g., the location, contact
    partner, or uptime) |'
  prefs: []
  type: TYPE_TB
- en: '| interfaces | mib-2.2 | Information on the network interfaces (Name, interface
    type, status, statistics etc.) |'
  prefs: []
  type: TYPE_TB
- en: '| at | mib-2.3 | Assignment of physical addresses (e.g., of MAC addresses)
    to the IP address *(Address Translation Table)* |'
  prefs: []
  type: TYPE_TB
- en: '| ip | mib-2.4 | Routing tables and IP packet statistics |'
  prefs: []
  type: TYPE_TB
- en: '| icmp | mib-2.5 | Statistics on individual ICMP packet types |'
  prefs: []
  type: TYPE_TB
- en: '| tcp | mib-2.6 | Open ports and existing TCP connections |'
  prefs: []
  type: TYPE_TB
- en: '| udp | mib-2.7 | ditto for UDP |'
  prefs: []
  type: TYPE_TB
- en: '| host | mib-2.25 | Information on storage media, devices, running processes
    and their use of resources |'
  prefs: []
  type: TYPE_TB
- en: 'How you specifically handle information stored in the MIB-II can be explained
    using the example of the *interfaces* group: [Figure 11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "Figure 11-1. SNMP namespace using the example of the MIB-II interfaces") shows
    how they are split up into the two OID **`interfaces.if Number`** and **`interfaces.if
    Table`**. This is because one network node initially reveals an unknown number
    of interfaces. This number is taken up by **`ifNumber`**. Before looking at these
    interfaces more closely, a manager can get the information from **`ifNumber`**
    about how many there really are.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`ifTable`** then contains the actual information on the different interfaces.
    To obtain this information for a specific interface, the manager queries all the
    entries in which the last number is the same, like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE205]'
  prefs: []
  type: TYPE_PRE
- en: '**`ifIndex`** describes the device-internal index—SNMP always starts counting
    from **`1`**, switches start counting here from **`100`**. **`ifDescr`** contains
    the name of the interface, here **`eth0`**—this is obviously a Linux machine.
    It can be assumed from the next four entries that a normal 100-Mbit Ethernet interface
    is involved.'
  prefs: []
  type: TYPE_NORMAL
- en: The interface type **`ifType`** is given as **`ethernetCsmacd`**,^([[104](#ftn.CHP-11-FN-1)])
    that is, Ethernet. **`ifMtu`** specifies the *Maximum Transfer Unit*, which in
    local networks is always 1,500 bytes for Ethernet. The interface speed **`ifSpeed`**
    is 100,000,000 bits here, that is, 100 Mbit. And **`ifPhysAddress`** contains
    the physical network address, also called the MAC address.
  prefs: []
  type: TYPE_NORMAL
- en: '**`ifAdminStatus`** reveals whether the admin has switched the interface on
    (**`up`**) or off (**`down`**) via the configuration. **`ifOperStatus`** on the
    other hand specifies the actual status, since even interfaces activated by an
    administrator are not necessarily connected to a device, or even switched on.'
  prefs: []
  type: TYPE_NORMAL
- en: 'There is a similar picture for the second interface:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE206]'
  prefs: []
  type: TYPE_PRE
- en: This is not an Ethernet card here, however, but a local loopback device.
  prefs: []
  type: TYPE_NORMAL
- en: 11.1.2 SNMP protocol versions
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The first SNMP version and *Internet Standard Management Framework* were described
    back in 1988 in RFCs 1065–1067; the current documentation on this version, named
    SNMPv1, can be found in RFC 1155–1157\. It is still used today, since higher versions
    are fundamentally backward-compatible.
  prefs: []
  type: TYPE_NORMAL
- en: 'The big disadvantage of SNMPv1 is that this version allows only unsatisfactory
    authentication in precisely three stages: no access, read access, and full access
    for read and write operations. Two simple passwords, the so-called *communities*,
    provide a little protection here: they divide users into one community with read
    permissions, and the second one with read and write permissions. No further differentiation
    is possible. If this was not enough, the community is transmitted in plain text,
    making it an easy prey for sniffer tools.'
  prefs: []
  type: TYPE_NORMAL
- en: Further development on the second version, SNMPv2, was intended to solve problems
    concerning the display of value ranges, error events, and the performance if there
    are mass requests (RFC 1905). This RFC was never fully implemented, however. The
    only relatively complete implementation that was used in practice is known as
    the *Community-based SNMPv2*, or SNMPv2c for short (RFC 1901-1908). The current
    version, SNMPv3 (RFC 3411–3418), has the status of an Internet standard. Agents
    with SNMPv3 implementations always understand requests from SNMPv1.
  prefs: []
  type: TYPE_NORMAL
- en: Apart from extended protocol operations, there are no fundamental differences
    between SNMPv1 and SNMPv2c. This is probably also the reason why SNMPv2 could
    not really gain a foothold. The hoped-for increase in security was certainly missing
    in this version. It is only the extensions of the framework in SNMPv3 which allow
    more precise access control, but this is much more complicated than the two community
    strings in SNMPv1\. RFC 3414 describes the *user-based security model* (USM),
    RFC 3415 the *view-based access control model* (VACM).
  prefs: []
  type: TYPE_NORMAL
- en: 'When accessing an SNMP agent, you must tell all tools, including plugins, which
    protocol version is to be used. In Nagios you exclusively require read access.
    If this is restricted to the required information and you only allow the access
    from the Nagios server, you need have no qualms about doing without the extended
    authentication of SNMPv3\. It is only important that you configure the agent—if
    possible—so that it completely prevents write accesses, or at least demands a
    password. You should never use this: since it is transmitted in plain text, there
    is always a danger that somebody may be listening, and misuse the password later
    on.'
  prefs: []
  type: TYPE_NORMAL
- en: In NET-SNMP, write accesses can be completely prevented, access can be restricted
    to specific hosts, and information revealed can be limited. For other agents implemented
    in hardware such as switches and routers, you must weigh up whether you really
    need SNMPv3, assuming the manufacturer has made this available. SNMPv1, however,
    is available for all SNMP devices.
  prefs: []
  type: TYPE_NORMAL
- en: We will therefore only explain access via SNMPv1 below, and assume that this
    is generally read access only. If you still want to get involved with SNMPv3,
    we refer you to the NET-SNMP documentation.^([[105](#ftn.CHP-11-FN-2)])
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[104](#CHP-11-FN-1)]) *Carrier Sense* (CS) means that each network interface
    checks to see whether the line is free, based on the network signal (in contrast
    to Token Ring, for example, where the network card may use the line only if it
    explicitly receives a token); *Multiple Access* (MA) means that several network
    cards may access a common network medium simultaneously.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[105](#CHP-11-FN-2)]) [http://net-snmp.sourceforge.net/docs/FAQ.html#How_do_I_use_SNMPv](http://net-snmp.sourceforge.net/docs/FAQ.html#How_do_I_use_SNMPv)
  prefs: []
  type: TYPE_NORMAL
- en: 11.2 NET-SNMP
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Probably the most widely used SNMP implementation for Linux and other UNIX systems
    is NET-SNMP ^([[106](#ftn.CHP-11-FN-3)]) and was originally conceived at Carnegie-Mellon
    University Wes Hardaker, a system administrator at the University of California
    in Davis, continued developing the code and first published it under the name
    UCD-SNMP (Version 3.0).
  prefs: []
  type: TYPE_NORMAL
- en: With version 5.0 the project finally got the name NET-SNMP. But various distributions
    still call the package UCD-SNMP, in part because it contains version 4.2, in part
    because the maintainer has simply not gotten around to renaming it.
  prefs: []
  type: TYPE_NORMAL
- en: NET-SNMP consists of a set of command line tools, a graphical browser (**`tkmib`**),
    an agent (**`snmpd`**, see [11.2.2 The NET-SNMP daemon](../Text/ch11s02.html#the_net-snmp_daemon
    "11.2.2 The NET-SNMP daemon") in page 238) and a library, which now forms the
    basis of nearly all SNMP implementations in the Open Source field.
  prefs: []
  type: TYPE_NORMAL
- en: All common distributions include corresponding packages. In SuSE this is called
    **`net-snmp`** and contains all the components; Debian packs the tools in the
    package **`snmp`**, and the daemon in the package **`snmpd`**. At the time of
    going to press, version 5.4.1 was the current version, but an older 5.x version
    will do the job for our purposes. Their outputs differ to some extent, but the
    exact options can be looked up where necessary in the man page.
  prefs: []
  type: TYPE_NORMAL
- en: 11.2.1 Tools for SNMP requests
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'For read access, the programs **`snmpget`**, **`snmpgetnext`** and **`snmpwalk`**
    are used. **`snmpget`** specifically requests a single OID and returns a single
    value from it. **`snmpgetnext`** displays the next variable existing in the Management
    Information Base, including its value:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE207]'
  prefs: []
  type: TYPE_PRE
- en: The option **`-v1`** instructs **`snmpget`** to use SNMPv1 as the protocol.
    With **`-c`** you specify the read community an; in this case then, the password
    is **`public`**. This is followed by the computer to be queried, here **`localhost`**,
    and finally there is the OID whose value we would like to find out.
  prefs: []
  type: TYPE_NORMAL
- en: 'The NET-SNMP tools are masters of OID abbreviation: without special instructions,
    they always assume that an OID is involved which lies inside the MIB-II. For unique
    entries such as **`ifDescr.1`**, this is sufficient. But whether the various SNMP
    plugins for Nagios can also handle this depends on the specific implementation;
    it is best to try out cases on an individual basis. To be on the safe side, it
    is better to use complete OIDs, either numerical in readable form. The latter
    is obtained if you instruct **`snmpget`** to display the full OID:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE208]'
  prefs: []
  type: TYPE_PRE
- en: 'The **`-On`** option provides the numerical OID, **`-Of`** the text version.
    In this way you can easily find out the complete OID, for plugins which cannot
    handle the abbreviation. It is important to remember here: each OID always starts
    with a period. If you omit this, there will always be a plugin which doesn''t
    work properly.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In order to obtain the entire information stored in the MIB-II, it is better
    to use **`snmpwalk`**. As the name suggests, the program takes a walk through
    the Management Information Base, either in its entirety or in a specified part
    of the tree. If you would like to find out about all the entries beneath the node
    **`mib-2.interfaces`** ([Figure 11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "Figure 11-1. SNMP namespace using the example of the MIB-II interfaces") in page
    230), you simply give **`snmpwalk`** the required OID:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE209]'
  prefs: []
  type: TYPE_PRE
- en: '**`snmpwalk`** hides the exact structure slightly (links to **`ifTable`** and
    **`ifEntry`** are missing, for example, see [Figure 11-1](../Text/ch11.html#snmp_namespace_using_the_example_of_the
    "Figure 11-1. SNMP namespace using the example of the MIB-II interfaces")), so
    that it is better to use **`-Of:`**'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE210]'
  prefs: []
  type: TYPE_PRE
- en: The three dots ... in the version here abbreviated for print stand for **`.iso.org.dod.internet.mgmt`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'As the next step, you could take a look around your own network and query the
    Management Information Bases available there. Normally you will get quite far
    with the read community **`public`**, since this is often the default setting.
    So you should also try out the community string **`private`**, which is the default
    set by many vendors. An extremely dubious practice, by the way: anyone who knows
    a bit about SNMP and who has access to the network can use this to manipulate
    device settings, such as switching off certain ports or the entire switch. But
    even with all the other default passwords, you should take the trouble to change
    them. Entire password lists can be found on the Internet, sorted by vendors and
    devices—easily found through Google.'
  prefs: []
  type: TYPE_NORMAL
- en: Whether you also change the preset read community (such as **`public`**) depends
    on the information available on it and on your own security requirements. But
    the read-write community should under no circumstances retain the default setting.
    In addition it is recommended that you switch off SNMP completely for devices
    that are neither queried nor administrated via SMNP, just to be on the safe side.
  prefs: []
  type: TYPE_NORMAL
- en: Taking a graphic walk with **`mbrowse`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: A graphical interface is often recommended for interactive research and for
    initial explorations of the Management Information Base, such as the SNMP browser
    **`mbrowse`**^([[107](#ftn.CHP-11-FN-4)]) (see [Figure 11-2](../Text/ch11s02.html#snmp_browser_mbrowse
    "Figure 11-2. SNMP browser mbrowse")). This is not a component of NET-SNMP, but
    most Linux distributions provide an **`mbrowse`** package for installation.
  prefs: []
  type: TYPE_NORMAL
- en: '![SNMP browser mbrowse](../Images/tagoreillycom20081104nostarchimages223818.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 11-2. SNMP browser `mbrowse`
  prefs: []
  type: TYPE_NORMAL
- en: If you highlight an entry and click on the **`Walk`** button, the lower window
    displays the same output as **`snmpwalk`**. The graphical display, however, allows
    better orientation—it is easier to see in which partial tree you are currently
    located. It is also interesting that **`mbrowse`** shows the numeric OID of each
    selected object, in **`Object Identifier`**.
  prefs: []
  type: TYPE_NORMAL
- en: 11.2.2 The NET-SNMP daemon
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The NET-SNMP daemon **`snmpd`** works as an SNMP agent for Linux and other Unix
    systems; that is, it answers requests from a manager and also provides a way of
    making settings to the Linux system via write accesses, such as manipulating the
    routing table.
  prefs: []
  type: TYPE_NORMAL
- en: Supported Mangement Information Bases
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The agent initially provides information on the MIB-II described in RFC 1213
    ([11.1.1 The Management Information Base](../Text/ch11.html#the_management_information_base
    "11.1.1 The Management Information Base") from page 229), but also the host extensions
    belonging to this from RFC 2790 (host MIB). [Table 11-2](../Text/ch11s02.html#components_of_the_host_resources_mib
    "Table 11-2. Components of the Host Resources MIB mib-2.host (RFC 2790)") summarizes
    the groups of the host MIB, and the most important MIB-II groups are introduced
    in [Table 11-1](../Text/ch11.html#mib-ii_groups_open_parenthesis_a_selecti "Table 11-1. MIB-II
    groups (a selection)") (page 231).
  prefs: []
  type: TYPE_NORMAL
- en: If you are interested in a detailed description of the MIB-II, including the
    host MIB, we refer you to [http://www.snmplink.org/](http://www.snmplink.org/).
    There you can surf through a huge number of MIBs and download them if you wish.
  prefs: []
  type: TYPE_NORMAL
- en: In addition to the basic MIB-II, the NET-SNMP implementation has its own extension
    at **`private.enterprises.ucdavis`** (UCD-SNMP-MIB). The directives given in [Table 11-3](../Text/ch11s02.html#extract_from_the_ucd-snmp-mib
    "Table 11-3. Extract from the UCD-SNMP-MIB") refer to instructions in the configuration
    file **`snmpd.conf`** (see [Supported Mangement Information Bases](../Text/ch11s02.html#supported_mangement_information_bases
    "Supported Mangement Information Bases")). Some of the information here is also
    given in the Host Resources MIB.
  prefs: []
  type: TYPE_NORMAL
- en: Table 11-2. Components of the Host Resources `MIB mib-2.host` (RFC 2790)
  prefs: []
  type: TYPE_NORMAL
- en: '| Group | OID | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| hrSystem | host.1 | System time and uptime of the host, logged-in users,
    and number of active processes |'
  prefs: []
  type: TYPE_TB
- en: '| hrStorage | host.2 | Details on all storage media such as swap, hard drives,
    removable media, and main memory |'
  prefs: []
  type: TYPE_TB
- en: '| hrDevice | host.3 | List of available devices and their properties: apart
    from details on the processor, network interfaces, printer and DVD-/CD-ROM drives,
    there is also information on hard drives, their partitioning, file systems, mount
    points and file system types |'
  prefs: []
  type: TYPE_TB
- en: '| hrSWRun | host.4 | All running processes including PID and command line parameters
    |'
  prefs: []
  type: TYPE_TB
- en: '| hrSWRunPerf | host.5 | CPU usage and memory usage for the processes from
    hrSWRun |'
  prefs: []
  type: TYPE_TB
- en: '| hrSWInstalled | host.6 | Installed software; the information originates from
    the RPM database (unfortunately this does not work in Debian). |'
  prefs: []
  type: TYPE_TB
- en: Table 11-3. Extract from the UCD-SNMP-MIB
  prefs: []
  type: TYPE_NORMAL
- en: '| **`Group`** | **`OID`** | **`Directive`** | **`description`** |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| prTable | ucdavis.2 | **`proc`** | details of running processes |'
  prefs: []
  type: TYPE_TB
- en: '| memory | ucdavis.4 | - | Memory and Swap space load, as in the program **`free`**
    |'
  prefs: []
  type: TYPE_TB
- en: '| extTable | ucdavis.8 | **`exec`** | Information on self-defined commands
    in the configuration file ^([[a](#ftn.CHP-11-FN-5)]) |'
  prefs: []
  type: TYPE_TB
- en: '| dskTable | ucdavis.9 | **`disk`** | Information on file systems, see example
    in the text |'
  prefs: []
  type: TYPE_TB
- en: '| laTable | ucdavis.10 | **`load`** | System load |'
  prefs: []
  type: TYPE_TB
- en: '| ucdExper- | ucdavis.13 | - | Experimental extension containing an entry with
    lm-sensor information, among other things |'
  prefs: []
  type: TYPE_TB
- en: '| fileTable | ucdavis.15 | **`file`** | Information on files to be explicitly
    monitored |'
  prefs: []
  type: TYPE_TB
- en: '| version | ucdavis.100 - | - | Details on the NET-SNMP version and the parameters
    with which the daemon was compiled |'
  prefs: []
  type: TYPE_TB
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[a](#CHP-11-FN-5)]) Any executable programs can be used here.
  prefs: []
  type: TYPE_NORMAL
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: 'While **`mib-2.host`** only specifies absolute values, such as for file systems,
    UCD-SNMP-MIB also allows threshold values to be set for agent pages, which then
    explicitly generate an error value (**`dskErrorFlag`**) with error text (**`dskErrorMsg`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE211]'
  prefs: []
  type: TYPE_PRE
- en: The **`grep '. 2 ='`** filters all entries on the second device from the **`snmpwalk`**
    output, the Linux software-RAID **`/dev/md6`**. The entry **`dskPercent`** shows
    the current load of this data medium. An error exists if **`dskErrorFlag`** contains
    the value 1 instead of 0; **`dskErrorMsg`** adds a readable message to the error
    message. It can be assumed from this that the agent is being configured so that
    it will announce an error if free capacity falls below 10 percent.
  prefs: []
  type: TYPE_NORMAL
- en: The configuration file **`snmpd.conf`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Configuring the agent is done in the file **`snmpd.conf`**, which is either
    located in the directory **`/etc`** directly (the case for SUSE) or in **`/etc/snmp`**
    (Debian), depending on the distribution.
  prefs: []
  type: TYPE_NORMAL
- en: '`Authentication and security` As the first step towards a finely tuned access
    control, you first need to define who should have access to which community:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE212]'
  prefs: []
  type: TYPE_PRE
- en: '**`com2sec`** links the source IP addresses to a community string (the SNMP
    password). This keyword is followed by an alias for the IP address range, the
    address range itself, and then a freely selectable community string, for which
    we will use **`public`** here, to keep things simple.^([[108](#ftn.CHP-11-FN-6)]).
    **`192.168.1.0/24`** refers to the local network; the Nagios server itself has
    the IP address **`192.168.1.9`**. If you set access permissions for the alias
    **`localnet`** later on, they will apply to the entire local network **`192.168.1.0/24`**,
    but if you reference **`nagiossrv`** when doing this, they will only apply to
    the Nagios server itself.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Then the defined computers and networks are assigned via their aliases to groups
    which have different security models:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE213]'
  prefs: []
  type: TYPE_PRE
- en: 'The keyword **`group`** is followed first by a freely selectable group name:
    here we define the group **`Local`** with the security model **`v1`**, which belongs
    to the address range defined as **`localhost`**, and the group **`Nagios`** with
    the same security model contained in the Nagios server.'
  prefs: []
  type: TYPE_NORMAL
- en: 'You can choose from **`v1`** (SNMPv1), **`v2c`** (community-based SNMPv2),
    and **`usm`** (the *User Model* from SNMPv3) as the security model. If you assign
    a computer or a network several security models at the same time, then separate
    entries with the same group name are required:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE214]'
  prefs: []
  type: TYPE_PRE
- en: 'With the definition of views (keyword **`view`**) the view from the outside
    can be restricted precisely to partial trees of the Management Information Base.
    Each view here is also given a name for referencing:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE215]'
  prefs: []
  type: TYPE_PRE
- en: 'The reference **`included`** includes the following partial tree in the view.
    Thus the view **`all`** covers the entire tree (**`.1`**). If you want to exclude
    certain partial trees in this, then the keyword **`excluded`** is used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE216]'
  prefs: []
  type: TYPE_PRE
- en: The partial tree beneath **`private`** in **`all`** is now blocked, such as
    the MIB **`ucdavis (private.enterprises.ucdavis`**).
  prefs: []
  type: TYPE_NORMAL
- en: 'One interesting feature is the mask; it specifies in hexadecimal notation which
    nodes correspond exactly to the subtree:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE217]'
  prefs: []
  type: TYPE_PRE
- en: All places of the queried OID, for which the mask contains a 1 in binary notation,
    must be identical in the queried partial tree to the OID specified here, **`.iso.org.dod.internet.mgmt`**,
    otherwise the daemon will refuse access and not provide any information. **`.iso.org.dod.internet.mgmt`**
    is written numerically as **`.1.3.6.1.2`**.
  prefs: []
  type: TYPE_NORMAL
- en: Thanks to the mask **`F8`**,^([[109](#ftn.CHP-11-FN-7)]) binary 11111000, the
    first five places from the left in the OID must always be **`.iso.org.dod.internet.mgmt`**.
    If somebody queried an OID (such as the **`private`** tree **`.1.3.6.1.4`**),
    which deviates from this, the agent would remain silent and not provide any information.
    If you leave out the mask detail, **`FF`** will be used.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you have defined the alias, community, security model, and view, you just
    need to bring them together for the purpose of access control. This is done with
    the **`access`** instruction:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE218]'
  prefs: []
  type: TYPE_PRE
- en: The access restrictions are bound to the group. The **`context`** column remains
    empty (**`'""`**), since only SNMPv3 requires it.^([[110](#ftn.CHP-11-FN-8)]).
    As the security model, you then normally choose **`any`**, but you may define
    a specific model with **`v1`**, **`v2c`** or **`usm`**, since several different
    security models may be assigned to a group, as shown in the discussion of "Authentication
    and Security" at the beginning of this Section. The fifth column specifies the
    security level, which is also of interest only for SNMPv3\. In the other two security
    models (we are only using **`v1`**), **`noauth`** is given here. The fourth last
    column also has just one meaning in SNMPv3\. But since you must enter a valid
    value forSNMPv1 and SNMPv2c as well, then **`exact`** is chosen here.
  prefs: []
  type: TYPE_NORMAL
- en: 'The last two columns specify which view should be used for which access (read
    or write). In the example, the groups **`Local`** and **`NagiosGrp`** obtain read
    access for the view **`all`**, but no write access. The final column defines whether
    the agent should send SNMP traps—that is, active messages, to the manager—for
    events that occur within the range of validity of the view. [14.6 Application
    Example II: Processing SNMP Traps](../Text/ch14s06.html "14.6 Application Example
    II: Processing SNMP Traps") from page 312 goes into more detail about SNMP traps.'
  prefs: []
  type: TYPE_NORMAL
- en: With the configuration described here, you can now exclusively access the Nagios
    server and **`localhost`** via SNMPv1 for information. The server access can be
    restricted further by defining a view that makes only parts of the MIB visible.
    But you should only try this once the configuration described is working, to avoid
    logical errors and time-consuming debugging.
  prefs: []
  type: TYPE_NORMAL
- en: '`System and local information` The partial tree **`mib-2.system`** provides
    information on the system itself and on the available (that is, implemented) MIBs.
    With **`syslocation`** you can specify where a system is located in the company
    or on the campus, and after the keyword **`syscontact`** you enter the e-mail
    address of the administrator responsible:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE219]'
  prefs: []
  type: TYPE_PRE
- en: 'As long as you do not redefine the parameters **`sysname`** and **`sysdescr`**
    at this point, the corresponding MIBs in the default will reveal the host name
    and/or the system and kernel specification, corresponding to **`uname -a`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE220]'
  prefs: []
  type: TYPE_PRE
- en: '`Defining processes to be monitored` Processes that you want to monitor using
    SNMP are specified with the **`proc`** directive, and if required you can specify
    the minimum or maximum number of processes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE221]'
  prefs: []
  type: TYPE_PRE
- en: 'If the entry for maximum and minimum is missing, at least one process must
    be running. If only the minimum is omitted, NET-SNMP will define this with zero
    processes. The corresponding entries end up in the MIB **`ucdavis.prTable`**;
    in case of error you will receive an error flag (**`prError-Flag`** and an error
    description (**`prErrMessage`**) (which unfortunately you cannot define yourself):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE222]'
  prefs: []
  type: TYPE_PRE
- en: '**`ucdavis. prTable`** only reveals the configured processes; on the other
    hand it allows **`mib-2.host.hrSWRun`** and **`mib-2.host.hrSWRunPerf`** in general
    to query all running processes. If you want to prevent this, the view must exclude
    the area you do not want.'
  prefs: []
  type: TYPE_NORMAL
- en: '`Your own commands` With the **`exec`** directive you can specify commands
    in the extension **`ucdavis.extTable`**, which the agent will execute in the corresponding
    queries. The result then appears in the relevant entries. In the following example
    the agent calls **`/bin/echo`** if it is asked for **`ucdavis.extTable`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE223]'
  prefs: []
  type: TYPE_PRE
- en: 'The program to be executed must appear with its absolute path in the configuration.
    Running **`snmpwalk`** provides only the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE224]'
  prefs: []
  type: TYPE_PRE
- en: '**`extTable.extEntry.extResult`** contains the return value of the command
    executed, and **`extTable.extEntry.extOutput`** contains the text output.'
  prefs: []
  type: TYPE_NORMAL
- en: 'With the **`exec`** directive you can thus query everything that a local script
    or program can find out. This could be a security problem, however: if the programs
    used are susceptible to buffer overflows, this feature could be misused as a starting
    point for a denial-of-service attack.'
  prefs: []
  type: TYPE_NORMAL
- en: '`Monitoring hard drive capacity` The **`disk`** directive is suitable for monitoring
    file systems. The keyword **`disk`** is followed by the path for a mount point,
    and then the minimum hard drive space in KB or in percent that should be available.
    If you omit the capacity entry, at least 100 MB must be available; otherwise an
    error message will be given.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example the free capacity in the **`/`** file system should
    not drop below **`10%`** and on **`/usr`**, at least 800 MB ^([[111](#ftn.CHP-11-FN-9)])
    should remain free:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE225]'
  prefs: []
  type: TYPE_PRE
- en: 'As far as the data partition **`/data`** is concerned, the alarm should be
    raised if free capacity falls below **`50%. dskErrorFlag`** in this case contains
    the value 1 instead of 0, and **`dskErrorMsg`** contains an error text:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE226]'
  prefs: []
  type: TYPE_PRE
- en: '**`dskPercent`** reveals a current load of **`65%`**. Instead of the partial
    tree configured here, **`ucdavis.dskTable, mib-2.host.hrStorage`** also provides
    an overview of all file systems, even those not explicitly defined. These are
    missing percentage details, however, and you do not receive an error status or
    error message, as supplied by **`ucdavis.dskTable`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'You should think hard about whether you set the warning limit in the NET-SNMP
    or in the Nagios configuration. In the first case you must configure the values
    on each individual host. If you query the percentage load, however, with the **`check_snmp`**
    plugin (see [11.3.1 The generic SNMP plugin check_snmp](../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp
    "11.3.1 The generic SNMP plugin check_snmp") from page 246), then you set warning
    and critical limits centrally on the Nagios server, saving yourself a lot of work
    if you make changes later on. The **`includeAHDisks`** directive adds all existing
    file systems to the **`dskTable`** table:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE227]'
  prefs: []
  type: TYPE_PRE
- en: It requires a minimum limit to be specified in percent, and also returns error
    values. An absolute specification in KB is not possible here. If you set warning
    and error limits centrally for **`check_snmp`**; (see [11.3.1 The generic SNMP
    plugin check_snmp](../Text/ch11s03.html#the_generic_snmp_plugin_check_snmp "11.3.1
    The generic SNMP plugin check_snmp") from page 246) the error attributes **`dskErrorFlag`**
    and **`dskErrorMsg`** are not queried, so that the value set here as the minimum
    limit can be ignored.
  prefs: []
  type: TYPE_NORMAL
- en: '`System load` The **`load`** directive queries the CPU load. As the limit values,
    you specify the average values for one minute, and optionally for five and 15
    minutes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE228]'
  prefs: []
  type: TYPE_PRE
- en: 'If the values are overstepped, **`laErrorFlag`** will contain the status **`1`**
    (otherwise: **`0`**) and **`laErrMessage`** will have the text of the error message.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In a system that exceeds one of the specified limits, **`snmpwalk`** returns
    the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE229]'
  prefs: []
  type: TYPE_PRE
- en: From **`laLoadlnt.1`** we are told the one-minute average value for the system
    **`load`** as an integer, from **`laLoad.l`** as a string, and from **`laLoadFloat.1`**
    as a floating-point decimal. **`laErrorFlag.1`** contains the corresponding error
    status, **`laErrMessage.1`** the corresponding error message. The same applies
    for the other two averages.
  prefs: []
  type: TYPE_NORMAL
- en: You can also use the **`check_snmp`** plugin here to query the floating-point
    decimal values just as accurately, and specify limit values centrally.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[106](#CHP-11-FN-3)]) [http://net-snmp.sourceforge.net/](http://net-snmp.sourceforge.net/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[107](#CHP-11-FN-4)]) [http://www.kill-9.org/mbrowse/](http://www.kill-9.org/mbrowse/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[108](#CHP-11-FN-6)]) See also page 236
  prefs: []
  type: TYPE_NORMAL
- en: ^([[109](#CHP-11-FN-7)]) F= 1.2³+1.2²+1.2¹ +1.2⁰ = 1111, 8=1000
  prefs: []
  type: TYPE_NORMAL
- en: ^([[110](#CHP-11-FN-8)]) Corresponding descriptions on SNMPv3 would go beyond
    the bounds of this book
  prefs: []
  type: TYPE_NORMAL
- en: ^([[111](#CHP-11-FN-9)]) 1024KB * 800
  prefs: []
  type: TYPE_NORMAL
- en: 11.3 Nagios's Own SNMP Plugins
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Among the standard Nagios plugins there are three programs with which data
    can be obtained via SNMP: a generic plugin that queries any OIDs you want, and
    two Perl scripts that are specialized in interface data of network cards and the
    ports of switches, routers and so forth. In addition to this, the directory **`contrib`**
    contains the source code of other SNMP plugins that are not automatically installed.
    Apparently these are no longer maintained and cannot run without major adjustments
    to the code.'
  prefs: []
  type: TYPE_NORMAL
- en: '[http://www.nagiosexchange.org/](http://www.nagiosexchange.org/) also provides
    some useful specialized plugins, some of which are introduced in [11.4 Other SNMP-based
    Plugins](../Text/ch11s04.html "11.4 Other SNMP-based Plugins") from page 255\.
    The following descriptions are limited, for reasons of space, to SNMPv1/2 queries;
    for SNMPv3-specific options, we refer you to the online help for the corresponding
    plugin.'
  prefs: []
  type: TYPE_NORMAL
- en: 11.3.1 The generic SNMP plugin **`check_snmp`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: With **`check_snmp`** a generic plugin is available that queries all available
    information via SNMP, according to your requirements. However, its operation does
    require a degree of care, since as a generic plugin, it has no idea of specifically
    what data it is querying.
  prefs: []
  type: TYPE_NORMAL
- en: For this reason as well, its output looks quite meager; specialized plugins
    provide more convenience here. But since these don't exist for every purpose,
    **`check_snmp`** is then quite justified. It calls the program **`snmpget`** auf,
    which means that the NET-SNMP tools must be installed.
  prefs: []
  type: TYPE_NORMAL
- en: 'It provides the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``**/ **`--host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name or IP address of the SNMP agent to be queried.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-o`** **``*`OID`*``** /**`--oid=`****``*`OID`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the object identifier to be queried, either as a complete numerical
    OID or as a string, which is interpreted by **`snmpget`** (e.g., **`system.sysName.O`**).
  prefs: []
  type: TYPE_NORMAL
- en: 'Attention: in contrast to **`snmpwalk`**, you must always specify the end nodes
    containing the information.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the alternative port on which the SNMP agent is running. The default
    is UDP port 161.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the community string for read access. The default value is **`public`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`start:end`*``** **`/ --warning=`****``*`start:end`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the queried value lies within the range specified by *start* and *end*, **`check_snmp`**
    does not give out a warning. For **`-w 0:90`** it must therefore be larger than
    0 and smaller than 90.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`start:end`*``** **`/ --critical=`****``*`start:end`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: If the query value lies outside the range, the plugin gives out CRITICAL. If
    the warning and critical limits overlap, the critical limit always has priority
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s`** **``*`string`*``** **`/ --string=`****``*`string`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The contents of the queried OID must correspond exactly to the specified *string*,
    otherwise **`check_snmp`** will give out an error.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** **``*`regexp`*``** **`/ --ereg=`****``*`regexp`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This option checks the contents of the queried OID to see whether the regular
    expression *regexp*^([[112](#ftn.CHP-11-FN-10)]) is matched. If this is the case,
    the plugin returns OK, otherwise CRITICAL.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-R`** **``*`regexp`*``** **`/ --erexi=`****``*`regexp`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: As **`-r`**, except that there is no case distinction.
  prefs: []
  type: TYPE_NORMAL
- en: '**`−1`** **``*`prefix`*``** **`/ --label=`****``*`prefix`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: A string that is placed in front of the plugin response. The default is **`SNMP`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u`** **``*`string`*``** **`/ --units=`****``*`string`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: SNMP only has simple values, not units. A string that is specified instead of
    *string* is extended by the plugin in the text output so that it serves the value
    as a unit. Because only text is involved here, you can also specify **`apples`**
    or **`pears`**, for example, as "units".
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`** **``*`delimiter`*``** **`/ --delimiter=`****``*`delimiter`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This character separates the OID in the **`snmpget`** output from the value.
    The default is =.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-D`** **``*`delimiter`*``** **`/ --output-`** **`delimiter=`****``*`delimiter`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The plugin is able to query several OIDs simultaneously. The result values are
    separated with *delimiter*, which in the default is a space.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-m`** **``*`mibs`*``** **`/ --miblist=`****``*`mibs`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the MIBs that should be loaded for **`snmpget`**. The default
    is **`ALL.-m +UCD-DEMO-MIB`**^([[113](#ftn.CHP-11-FN-11)]). loads *in addition*,
    **`-m UCD-DEMO-MIB`** <without the **`+`** sign> *only* loads the specified MIB.^([[114](#ftn.CHP-11-FN-12)]).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-P`** **``*`version`*``** **`/ --protocol=`****``*`version`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Defines the SNMP protocol version. The values for *version* are **`1`** or **`3`**.
    Without this option, SNMPv1 is used.
  prefs: []
  type: TYPE_NORMAL
- en: SNMP provides almost unlimited possibilities, so the following examples can
    merely convey a feeling for other plugins used.
  prefs: []
  type: TYPE_NORMAL
- en: Testing hard drive capacity via SNMP
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The following command queries the load of a file system and to do this accesses
    the partial tree **`ucdavis.dskTable`** of a locally running NET-SNMP agent:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE230]'
  prefs: []
  type: TYPE_PRE
- en: The query applies to the percentage load of the file system with the index number
    2\. As long as no more than 90 percent of the hard drive space is then occupied,
    the test should return OK; here a warning will be returned if it is between 91
    and 95 percent, and critical status if it goes beyond this. Thanks to the **`-u`**
    option, **`check_snmp`** adds the description **`percent`** to the output of the
    figure determined.
  prefs: []
  type: TYPE_NORMAL
- en: 'Nevertheless, the plugin does not tell the whole truth: a test check with **`df`**
    shows a 96 percent load, which comes from the fact that this program correctly
    rounded up the actual 95.8 percent load, while integer values in SNMP are seldom
    rounded up, but simply cut off. So you just have to live with slight inaccuracies
    as long as the MIB does not provide any floatingpoint decimals.'
  prefs: []
  type: TYPE_NORMAL
- en: 'If you would like things to be more detailed, you can use the option **`−1:
    −1 ''SNMP-DISK: /net/swobspace/b''`** causes other, self-defined information to
    be added to the output of the above command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE231]'
  prefs: []
  type: TYPE_PRE
- en: 'The above query can be more generally run through a command object such as
    the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE232]'
  prefs: []
  type: TYPE_PRE
- en: This definition assumes that the value being queried is numerical, and not Boolean
    (see [Monitoring network interfaces](../Text/ch11s03.html#monitoring_network_interfaces
    "Monitoring network interfaces")), otherwise specifying a warning and critical
    value simultaneously would make no sense. We store the community here in the macro
    **`$USER3$`**.^([[115](#ftn.CHP-11-FN-13)]). this is followed by the protocol
    version (**`-P 1`** stands for SNMPv1), the OID, the warning and critical limits,
    and a prefix.
  prefs: []
  type: TYPE_NORMAL
- en: The call for this command in service definitions is then made in the form
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE233]'
  prefs: []
  type: TYPE_PRE
- en: 'If you want to specifically monitor the load of the file system with the index
    number 2 on the computer **`swobspace`** through **`dskTable`**, then the following
    definition would be used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE234]'
  prefs: []
  type: TYPE_PRE
- en: Even though the **`check_command`** line is wrapped here, in practice all parameters
    must be on a single line, separated by an exclamation point **`!`** (without spaces
    before or after the delimiter).
  prefs: []
  type: TYPE_NORMAL
- en: Measuring temperature via **`lm-sensors`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The next test checks the CPU temperature of the host. For the sensor, the package
    **`lm-sensors`**^([[116](#ftn.CHP-11-FN-14)]) is used here, which accesses corresponding
    chips on modern mainboards. As soon as **`lm-sensors`** is active, it allows the
    NET-SNMP agents to read out the corresponding information from the partial tree
    **`ucdavis.ucdExperimental.lmSensors:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE235]'
  prefs: []
  type: TYPE_PRE
- en: 'The output depends on the chipset: here you must multiply the query values
    by the factor 1000\. Accordingly, you have no other alternative but to adjust
    the warning and critical limits to the main board you are using. In the example,
    the CPU temperature, 41 degrees Celsius, is "on a green light": if it were to
    drop below 25 degrees or rise above 45 degrees, it would cause a warning, while
    below 20 or above 48 degrees, this would be critical.'
  prefs: []
  type: TYPE_NORMAL
- en: Regular expressions and comparing fixed strings
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'You can check whether the text **`swobspace`** occurs in the system name as
    follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE236]'
  prefs: []
  type: TYPE_PRE
- en: Instead of defining the string being searched for, with **`-r`** as the regular
    expression, you could also use the **`-s`** option. Then the text must match exactly,
    however, which may be quite tricky, since everything counts that **`snmpget`**
    outputs after the delimiter, **`=`**.
  prefs: []
  type: TYPE_NORMAL
- en: Monitoring network interfaces
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The final example queries whether the first network interface of a Cisco router
    is in operation:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE237]'
  prefs: []
  type: TYPE_PRE
- en: The information sought can be found in **`ifOperStatus`**. Here we are querying
    port 1\. While **`ifOperStatus`** gives out the operating status, **`ifAdmin-Status`**
    reveals whether the interface is administratively switched on or off.
  prefs: []
  type: TYPE_NORMAL
- en: When specifying the warning limit here, we use the range **`1:1`**, so that
    the plugin gives out a warning if the interface is physically switched off, and
    the return value is thus 0\. We will do without the definition of a critical status
    here, since there are only two states, "on" or "off." If the plugin returns a
    CRITICAL when the interface is switched off, you should use **`-c 1:1`** and omit
    **`-w`** entirely.
  prefs: []
  type: TYPE_NORMAL
- en: If you just want to query the status of network interfaces, you should certainly
    take a look at the plugins **`check_ifstatus`** and **`check_ifoperstatus`**,
    described below, which provide slightly more operating convenience.
  prefs: []
  type: TYPE_NORMAL
- en: 'If MIB-II or MIB **`ucdavis`** do not provide the desired information, you
    could also take a look at the MIB provided by the manufacturer. You can find out
    from **`mib-2.system`** in which partial tree the overall MIB is hidden:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE238]'
  prefs: []
  type: TYPE_PRE
- en: 'The example involves a network-capable Konica photocopying machine called **`konica01.system.sysObjectID.0`**
    reveals that **`enterprises.2364`** serves as the entry point for device specific
    details. With **`snmpwalk`** you can then obtain further information:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE239]'
  prefs: []
  type: TYPE_PRE
- en: In the concrete case of this photocopier, you can query the current device status
    through **`enterprises.2364.1.2.6.1.1.5.1.1`**. Manufacturers usually store information
    on the implemented MIBs, so that you are not restricted to just guessing.
  prefs: []
  type: TYPE_NORMAL
- en: 11.3.2 Checking several interfaces simultaneously
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Active network components such as switches usually have quite a large number
    of ports, and it would be very time-consuming to check every single one of them.
    Here the **`check_ifstatus`** plugin is very useful, since it tests all ports
    simultaneously. It retrieves the information necessary for this via SNMP, and
    has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name or IP address of the SNMP agent to be queried.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This sets the community string for read access.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This parameter is the alternative port on which the SNMP agent is running. The
    default is UDP port 161.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-v`** **``*`version`*``** **`/ --snmp_version=`****``*`version`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This parameter specifies the SNMP version (**`1`**, **`2`**, or **`3`**) for
    the query.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-x`** **``*`list`*``** **`/ --exclude=`****``*`list`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Use this to specify a comma-separated list of interface types that should not
    be queried (see example below).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u`** **``*`list`*``** **`/ --unused_ports=`****``*`list`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'Use this to specify a comma-separated list of all ports that should be excluded
    from the test. Like **`-x`**, the list consists of the indices of the interfaces
    which are determined from **`if Index: -u 13,14,15,16`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-M`** **``*`bytes`*``** **`/ --maxmsgsize=`****``*`bytes`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the maximum size of the SNMP data packets; the default is **`1472`**
    bytes.
  prefs: []
  type: TYPE_NORMAL
- en: With exclusion lists it is possible to exclude certain interface types or port
    numbers from the test, perhaps because these are not occupied, or are connected
    to PCs or other devices that are not always running.
  prefs: []
  type: TYPE_NORMAL
- en: 'With the following query we can find out, for example, which interface types
    are gathered together on the Cisco switch here named **`cisco01`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE240]'
  prefs: []
  type: TYPE_PRE
- en: 'If the interface types **`other(1)`** and **`propVirtual(53)`** should now
    be excluded, the plugin is sent off with the two figures, separated by a comma,
    as the exclusion list **`-x 1,53`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE241]'
  prefs: []
  type: TYPE_PRE
- en: In reality, this plugin also does *not* display its output over several lines,
    as the line wrap here may suggest. The fact that this information appears on the
    Nagios Web interface in a relatively clear form is because the HMTL formatting
    element **`<BR>`** is thrown in. This causes the output for each port to be displayed
    on a separate line. The **`|`** character defines the beginning of the performance
    data, which does not appear at all in the Web interface.
  prefs: []
  type: TYPE_NORMAL
- en: 'A query of this type is implemented as a command object as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE242]'
  prefs: []
  type: TYPE_PRE
- en: Here the macro **`$USER3$`** is also used to define the community string in
    the file **`resource.cfg`**. Altogether, 32 **`$USERx$`** macros are available,
    of which the first two usually contain path details, and the others can be used
    in any way you want.
  prefs: []
  type: TYPE_NORMAL
- en: If you would prefer to exclude ports rather than interface types, you can use
    the **`-u`** option instead of **`-x`** in the definition.
  prefs: []
  type: TYPE_NORMAL
- en: 'If Nagios is to monitor the switch **`cisco01`**, as shown above, excluding
    the two interface types **`1`** and **`53`**, the corresponding service definition
    begins as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE243]'
  prefs: []
  type: TYPE_PRE
- en: 11.3.3 Testing the operating status of individual interfaces
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'To test an individual interface, you can use either the generic plugin **`check_snmp`**
    or **`check_ifoperstatus`**, which specifically tests the operating status (**`ifOperStatus`**)
    of the network card. The advantage of this over the generic plugin consists above
    all in its ease of use: instead of an index for the port, you can also specify
    its description here—for example, **`eth0`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`check_ifoperstatus`** has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name or IP address of the SNP agent to be queried.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This parameter gives the community string for read access.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: As long as the SNMP agent is not running on UDP port 161, the port is specified
    with this option.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-k`** **``*`ifIndex`*``** **`/ --key=`****``*`ifIndex`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '*ifIndex* is the number of the network interface to be queried (such as the
    network card of a computer or the port of a switch).'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`** **``*`ifDescr`*``** **`/ --descr=`****``*`ifDescr`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: Instead of the index key, the plugin processes the name of the interface from
    *ifDescr* (see below).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-v`** **``*`version`*``** **`/ --snmp_version=`****``*`version`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies the SNMP version (**`1, 2`**, or **`3`**) for the query.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`return_value`*``** **`/ --warn=`****``*`return_value`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This option selects the return value if the interface is dormant. The *return_value*
    can be **`i`** (ignore the dormant status and return OK!), **`w`** (WARNING) or
    **`c`** (CRITICAL, the default).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-D`** **``*`return_value`*``** **`/ --admin-down=`****``*`return_value`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: What value (**`i`**, **`w`** or **`c`**) should the plugin return if the interface
    has been shut down administratively? The default, **`w`**, issues a warning, **`c`**
    returns CRITICAL, and **`i`** returns OK.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-M`** **``*`bytes`*``** **`/ --maxmsgsize=`****``*`bytes`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the maximum size of the SNMP data packets; the default is **`1472`**
    bytes.
  prefs: []
  type: TYPE_NORMAL
- en: On a system called **`igate`**, on which **`snmpwalk`** finds the following
    interfaces ...
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE244]'
  prefs: []
  type: TYPE_PRE
- en: the first Ethernet card is tested either with **`-k 7`** or with **`-d etho`**.
    Since the plugin in the second case has to query all **`ifDescr`** entries to
    determine the index itself, this variation generates a somewhat higher network
    load. It can be especially useful if not all network interfaces are active on
    a host, causing its index to change.
  prefs: []
  type: TYPE_NORMAL
- en: 'The plugin itself reveals which index this port currently has:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE245]'
  prefs: []
  type: TYPE_PRE
- en: 'As the command object in the Nagios configuration, the call looks like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE246]'
  prefs: []
  type: TYPE_PRE
- en: 'The **`$USER3$`** macro again contains the community string, defined in the
    file **`resource.cfg`**. The service definition for **`igate`** specifies the
    name of the interface to be tested as a plugin argument:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE247]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[112](#CHP-11-FN-10)]) POSIX regular expression, see **`man 7 regex`**.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[113](#CHP-11-FN-11)]) **`UCD-DEMO-MIB`** is an MIB included for demonstration
    purposes
  prefs: []
  type: TYPE_NORMAL
- en: ^([[114](#CHP-11-FN-12)]) See also the online help, with **`man snmpcmd`**
  prefs: []
  type: TYPE_NORMAL
- en: ^([[115](#CHP-11-FN-13)]) The **`$USERx$`** macros are defined in the resource
    file **`resource.cfg`**
  prefs: []
  type: TYPE_NORMAL
- en: ^([[116](#CHP-11-FN-14)]) [http://www.lm-sensors.nu/](http://www.lm-sensors.nu/)
  prefs: []
  type: TYPE_NORMAL
- en: 11.4 Other SNMP-based Plugins
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Apart form the SNMP plugins from the Nagios Plugin package, the Nagios community
    provides a large variety of other plugins for special purposes. Most of them can
    be found at **`[http://www.nagiosexchange.org/](http://www.nagiosexchange.org/)`**
    in the category `Check Plugins | SNMP`.^([[117](#ftn.CHP-11-FN-15)])
  prefs: []
  type: TYPE_NORMAL
- en: 11.4.1 Monitoring hard drive space and processes with **`nagios-snmp-plugins`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'One of these is the package **`nagios-snmp-plugins`**,^([[118](#ftn.CHP-11-FN-16)])
    which exists not only as source code but also as an RPM package (for Red Hat and
    Fedora). It contains two very easy-to-use plugins: **`check_snmp_disk`** and **`check_snmp_proc`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Both absolutely require the NET-SNMP agent as the partner on the other side
    (see [11.2.2 The NET-SNMP daemon](../Text/ch11s02.html#the_net-snmp_daemon "11.2.2
    The NET-SNMP daemon") from page 238) and use **`ucdavis.dskTable`** and **`ucdavis.prTable`**
    to test the processes and file systems specified in the configuration file **`snmpd.conf`**.
    Its options are restricted to specifying the host and the community string:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name or IP address of the NET-SNMP agent to be queried.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the community string for read access.
  prefs: []
  type: TYPE_NORMAL
- en: 'The next example tests the available capacity of the **`/data`** file system;
    **`public`** is again used as the community string:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE248]'
  prefs: []
  type: TYPE_PRE
- en: The configuration of the NET-SNMP agent specifies, with the **`disk`** directive
    ([The configuration file snmpd.conf](../Text/ch11s02.html#the_configuration_file_snmpd.conf
    "The configuration file snmpd.conf")), **`50%`** as the threshold for this file
    system. In this case the plugin accordingly returns a CRITICAL. It can only distinguish
    between an error and OK; it does not have a WARNING status.
  prefs: []
  type: TYPE_NORMAL
- en: 'Using **`check_snmp_proc`** is just as easy:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE249]'
  prefs: []
  type: TYPE_PRE
- en: The plugin again tests the processes defined in the configuration of the NET-SNMP
    agent with the **`proc`** directive ([The configuration file snmpd.conf](../Text/ch11s02.html#the_configuration_file_snmpd.conf
    "The configuration file snmpd.conf")). The process **`slapd`** is missing here,
    which is why a CRITICAL is returned. The return value is revealed by **`echo $?`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'The corresponding command objects are defined in a similar unspectacular way:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE250]'
  prefs: []
  type: TYPE_PRE
- en: 'This definition also assumes that the community string is stored in the **`$USER3$`**
    macro in the file **`resource.cfg`**. In order to query the NET-SMTPD on the computer
    **`linux01`** for its hard drive load, the following service object is defined:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE251]'
  prefs: []
  type: TYPE_PRE
- en: 11.4.2 Observing the load on network interfaces with **`check-iftraffic`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The MIB-II contains only numbers that provide information on the load on network
    interfaces, but no average values for the used bandwidth, for example. If the
    vendor has not specifically made such an entry available in his MIB, then you
    will always have to make a note of the last counter status and the timestamp,
    so that you can work out the relative usage yourself.
  prefs: []
  type: TYPE_NORMAL
- en: '**`[http://www.nagiosexchange.org/](http://www.nagiosexchange.org/)`** introduces
    two plugins that take over this task. The Perl-based plugin **`check_traffic`**^([[119](#ftn.CHP-11-FN-17)])
    writes the query values into a *round-robin database* (RRD, see [19.2 Graphs for
    the Web with Nagiosgraph](../Text/ch19s02.html "19.2 Graphs for the Web with Nagiosgraph")),
    which makes it somewhat more complex to handle.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The same purpose is achieved, but with more simple means, by the **`check_iftraffic.pl`**
    plugin.^([[120](#ftn.CHP-11-FN-18)]). It has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '*`address`* is the host name or IP address of the NET-SNMP agent that is to
    be queried.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`password`*``** **`/ --community=`****``*`password`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`password`*``** is the community string for read access. The default is
    public.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-i`** **``*`ifDescr`*``** **`/ --interface=`****``*`ifDescr`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: From the interface name **``*`ifDescr`*``** the plugin determines the index
    so that it can access other values (e. g., the counter states).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-b`** **``*`integer`*``** **`/ --bandwith=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the maximum bandwidth of the interface in bits (see **`-u`**).
  prefs: []
  type: TYPE_NORMAL
- en: '**`-u`** **``*`unit`*``** **`/ --units=`****``*`unit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This is the unit for bandwidth specification with **`-b`**. Possible values
    are **`g`** (Gbit), **`m`** (Mbit), **`k`** (kbit) and the default **`b`** (bit):
    **`-b 100 -u m`** corresponds to 100 Megabits (Fast Ethernet).'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`integer`*``** **`/ --warning=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'If traffic exceeds this warning limit in percent (default: **`85`** percent),
    the plugin issues a WARNING.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`integer`*``** **`/ --critical=`****``*`integer`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: 'This is the critical threshold in percent (default: **`92`** percent).'
  prefs: []
  type: TYPE_NORMAL
- en: The plugin saves the timestamp and counter status of the interface queried in
    files in **`/tmp`**, to which it adds the prefix **`traffic`**. So if you are
    using a different user ID than **`nagios`** for the manual test on the command
    line, you should delete the files **`/tmp/traffic`****``*`_interface_computer`*``**
    before activating the appropriate Nagios service.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following command line example queries the Fast Ethernet network interface
    **`etho`** on the computer **`linux01`**, which in theory has a bandwidth of 100
    Mbit:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE252]'
  prefs: []
  type: TYPE_PRE
- en: The amount of data transmitted here is reported separately by the plugin, depending
    on the direction, and here it announces 60.32 (**`RX`**, "received") and 26.59
    MB (**`TX`**, "transmitted"). The text contains the HTML element **`<br>`** (line
    break), to display the output in the Nagios Web interface on two lines. This is
    followed by the average transmission rate, again separated for incoming and outgoing
    data traffic. The performance data (see [19.1 Processing Plugin Performance Data
    with Nagios](../Text/ch19.html#processing_plugin_performance_data_with "19.1 Processing
    Plugin Performance Data with Nagios"), page 404) after the **`|`** sign contain
    only the average load as a percentage, each separated by incoming and outgoing
    values. The numbers **`85`** and **`98`** are the default values for the warning
    and critical limits.
  prefs: []
  type: TYPE_NORMAL
- en: 'The corresponding command object is implemented as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE253]'
  prefs: []
  type: TYPE_PRE
- en: If the definition is taken over literally, you must define the community string
    in the **`$USER3$`** macro. If you only generally use **`public`** as the password,
    it is better to write **`-C public`** instead of **`-C $USER3$`**.
  prefs: []
  type: TYPE_NORMAL
- en: To simplify the call of the command within the following service definition,
    we set the unit to Mbit/second (**`-u m`**).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE254]'
  prefs: []
  type: TYPE_PRE
- en: '**`check_iftraffic`** calculates the bandwidth used by comparing two counter
    states at different times. Because Nagios does not test exactly down to the second,
    the check interval you choose should not be too small. The *Multi Router Traffic
    Grapher*,^([[121](#ftn.CHP-11-FN-19)]) which displays the bandwidth used in graphic
    form, normally works at five-minute intervals.'
  prefs: []
  type: TYPE_NORMAL
- en: If you select **`max_check_attempts`** other than **`1`**, you should make sure
    that the retry interval (**`retry_check_interval`**) is the same as the normal
    check interval. For **`max_check_attempts 1`** this makes no difference, but you
    have to define a **`retry_check_interval`** at some time or other.
  prefs: []
  type: TYPE_NORMAL
- en: 11.4.3 The [manubulon.com](http://manubulon.com) plugins for special application
    purposes
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The Nagios Exchange, with the SNMP plugins to be found under [http://www.manubulon.com/nagios/](http://www.manubulon.com/nagios/)
    (see [Table 11-4](../Text/ch11s04.html#the_manubulon.com-snmp_plu "Table 11-4. The
    manubulon.com-SNMP plugins")), also includes some that are customized to a specific
    application, such as querying hard drive space. They are relatively simple to
    use.
  prefs: []
  type: TYPE_NORMAL
- en: Table 11-4. The [manubulon.com](http://manubulon.com)-SNMP plugins
  prefs: []
  type: TYPE_NORMAL
- en: '| Plugin | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_sn.mp_storage.pl`** | Query of storage devices (hard drives, swap
    space, main memory, etc.) |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_snmp_int.pl`** | Interface status and load |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_snmp_process.pl`** | processes: status, CPU and memory usage |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_snmp_load.pl`** | System load |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_snmp_mem.pl`** | main memory and swap usage |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_snmp_vrrp.pl`** | querying a Nokia-VRRP cluster ^([[a](#ftn.CHP-11-FN-20)])
    |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_snmp_cpfw.pl`** | querying a Checkpoint firewall-1^([[b](#ftn.CHP-11-FN-21)])
    |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_snmp_env.pl`** | tests environment parameters of switches such as
    temperature, power supply unit, and fan (Cisco, Foundry, and others) |'
  prefs: []
  type: TYPE_TB
- en: '| **`check_snmp_win.pl`** | Queries Windows services via SNMP |'
  prefs: []
  type: TYPE_TB
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[a](#CHP-11-FN-20)]) The abbreviation VRRP stands for *Virtual Router Redundancy
    Protocol*.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[b](#CHP-11-FN-21)]) [http://www.checkpoint.com/products/firewall-1/](http://www.checkpoint.com/products/firewall-1/)
  prefs: []
  type: TYPE_NORMAL
- en: '|'
  prefs: []
  type: TYPE_NORMAL
- en: We will introduce two of the plugins—**`check_snmp_storage.pl`** and check **`_snmp_load.pl`**—in
    detail here.
  prefs: []
  type: TYPE_NORMAL
- en: Keeping checks on storage media with **`check_snmp_storage`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: While the **`check_snmp_disk`** plugin, introduced in [11.4.1 Monitoring hard
    drive space and processes with nagios-snmp-plugins](../Text/ch11s04.html#monitoring_hard_drive_space_and_processe
    "11.4.1 Monitoring hard drive space and processes with nagios-snmp-plugins") from
    page 256, only checks the file systems entered in the NET-SNMP configuration,
    **`check_snmp_storage.pl`** is capable of querying any storage media—even swap
    space or main memory—without previous configuration on the target host. **`check_snmp_storage.pl`**
    tests the partial tree **`mib-2`**. host here, while **`check_snmp_mem.pl`** uses
    **`ucdavis.memory`**, so that it remains restricted to NET-SNMP.
  prefs: []
  type: TYPE_NORMAL
- en: 'The fact that you do not have to battle with OIDs, but instead can work with
    descriptions of the **`swap space`** type to specify the type of the storage medium,
    provides a certain level of convenience. These can be queried with **`snmpwalk`**
    as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE255]'
  prefs: []
  type: TYPE_PRE
- en: 'When the plugin is called, the text specified after the **`STRING`**: is sufficient
    or—if unique—a part of this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE256]'
  prefs: []
  type: TYPE_PRE
- en: In the second example, it is sufficient to specify **`Swap`**, in order to query
    the data for **`Swap Space`**, since the pattern is unique. The **`-f`** option
    ensures that **`check_snmp_storage.pl`** will include performance data in its
    output.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** and **`-c`** specify in normal fashion the warning or critical limits
    in percent of the available memory space. The following overview lists all the
    options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name or IP address of the NET-SNMP agent that is to be queried.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`string`*``** **`/ --community=`****``*`string`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the community string for read access.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`port`*``** specifies an alternative port if the SNMP agent is not running
    on the default UDP port 161.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-m`** **``*`string`*``** **`/ --name=`****``*`string`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`string`*``** contains a description of the device to be queried, corresponding
    to its description in **`hrStorageDescr`** (see above), such as **`-m "Swap Space"`**
    for swap devices, **`-m "Real Memory"`** for the main memory, or **`-m "/usr"`**
    for the partition mounted under **`/usr`** in the file tree.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`percent`*``** **`/ --warn=`****``*`percent`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: A warning is given in the default if the proportion of used memory is larger
    than the specified threshold. Other warning limits can be defined with the **`-T`**
    parameter.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`crit`*``** **`/ --critical=`****``*`crit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: In the default, the status is categorized as critical if the proportion of used
    memory is larger than the specified critical limit. Other critical limits can
    also be specified with the **`-T`** parameter.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-T`** **``*`option`*``** **`/ --type=`****``*`option`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: What do the critical and the warning thresholds refer to?
  prefs: []
  type: TYPE_NORMAL
- en: '**`pu`** (*percent used*): used capacity in percent'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**`pl`** (*percent left*): free capacity in percent'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**`bu`** (*bytes used*): used capacity in megabytes'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**`bl`** (*bytes left*): free capacity in megabytes'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The default is -**`T pu`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-r`** **`/ --noregexp`**'
  prefs: []
  type: TYPE_NORMAL
- en: Normally the description in the **`-m`** parameter is treated as a regular expression.
    For example, **`/var`** here stands for all file systems containing **`/var`**,
    for example **`/var and /var/spool/imap`**, provided that these are really two
    independent file systems. The **`-r`** option switches off the regular expression
    capability, so that specifying **`/var`** will then match this file system exactly,
    but not **`/var/spool/imap`**, for example.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-s`** **`/ --sum`**'
  prefs: []
  type: TYPE_NORMAL
- en: Instead of performing individual tests for several specified storage media,
    the total occupied space is added up and compared to the total capacity. It is
    then determined whether thresholds are exceeded.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-i`** **`/ --index`**'
  prefs: []
  type: TYPE_NORMAL
- en: 'With **`-m`**, a text is normally specified, which turns up again in the description
    **`hrStorageDescr`**. With the **`-i`** option, the index table is used instead
    of the description. Here the Regexp capability also applies: **`-m 2`** matches
    all the entries containing the number **`2`** in the index (that is, **`2, 12,
    20`**, etc.). It then makes sense to use the **`-r`** option at the same time.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-e`** **`/ --exclude`**'
  prefs: []
  type: TYPE_NORMAL
- en: Now all the memories that are matched by the **`-m`** specification are excluded
    from the test, the remaining ones are included in the test.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-f`** **`/--perfparse`**'
  prefs: []
  type: TYPE_NORMAL
- en: This option provides an additional output of performance data that is not shown
    in the Web interface but can be evaluated by additonal tools (see [Chapter 19](../Text/ch19.html
    "Chapter 19. Graphic Display of Performance Data")).
  prefs: []
  type: TYPE_NORMAL
- en: Testing system load with **`check_snmp_load`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The plugin compares either the average system load in form of averages of 1
    min, 5 min, and 15 min, or the CPU load in percent.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``** **`/ --host=`****``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name or IP address of the NET-SNMP agent to be queried.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-C`** **``*`string`*``** **`/ --community=`****``*`string`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the community string for read access.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``** **`/ --port=`****``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: '**``*`port`*``** is the alternative UDP port on which the SNMP agent is running.
    The default is UDP port 161.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-w`** **``*`warning_limit`*``** **`/ --warn=`****``*`warning_limit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: The warning limit is given either as a simple integer value in percent (e.g.,
    **`90`**) or as an integer triplet separated by commas, which defines the thresholds
    for the system load average for one, five, and 15 minutes (e.g., **`8,5,5`**).
    The percentage load, on the other hand, always refers to the CPU load of the last
    minute.
  prefs: []
  type: TYPE_NORMAL
- en: If the plugin queries a NET-SNMP agent, you *must* additionally specify the
    **`-L`** option in the second variation, for the percentage, **`-N`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`critical_limit`*``** **`/ --crit=`****``*`critical_limit`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This specifies a critical limit; the syntax is the same as that for **`-w`**.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-L`** **`/ --linux`**'
  prefs: []
  type: TYPE_NORMAL
- en: This option specifies that the plugin queries the system mode of a Linux system
    via NET-SNMP.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-A`** **`/ --as400`**'
  prefs: []
  type: TYPE_NORMAL
- en: This option specifies that the CPU loaded on an AS/400 machine is queried.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-I`** **`/ --cisco`**'
  prefs: []
  type: TYPE_NORMAL
- en: This option specifies that the CPU load of a Cisco network component is involved.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-N`** **`/ --netsnmp`**'
  prefs: []
  type: TYPE_NORMAL
- en: If the plugin queries the percentage CPU load of a Linux system via NET-SNMP,
    the **`-N`** option must be specified.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-f`** **`/--perfparse`**'
  prefs: []
  type: TYPE_NORMAL
- en: This option ensures the output of performance data that is not displayed in
    the Web interface, but can be evaluated by additional tools (see [Chapter 19](../Text/ch19.html
    "Chapter 19. Graphic Display of Performance Data")).
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example queries the system load on the computer **`swobspace`**
    via NET-SNMP and specifies threshold values for the one-, five-, and fifteen-minute
    averages:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE257]'
  prefs: []
  type: TYPE_PRE
- en: The second example involves the percentage CPU load on the same machine. Here
    we additionally request performance data, which as usual repeats not only the
    measured value but also the thresholds.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[117](#CHP-11-FN-15)]) [http://www.nagiosexchange.org/SNMP.51.0.html](http://www.nagiosexchange.org/SNMP.51.0.html)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[118](#CHP-11-FN-16)]) [ftp://ftp.hometree.net/pub/nagios-snmp-plugins/](ftp://ftp.hometree.net/pub/nagios-snmp-plugins/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[119](#CHP-11-FN-17)]) [http://nagios.sourceforge.net/download/contrib/misc/check_traffic/](http://nagios.sourceforge.net/download/contrib/misc/check_traffic/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[120](#CHP-11-FN-18)]) [http://www.nagiosexchange.org//51;37](http://www.nagiosexchange.org//51;37)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[121](#CHP-11-FN-19)]) [http://www.mrtg.org/](http://www.mrtg.org/)
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 12. The Nagios Notification System
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: What would be the point of system and network monitoring if it did not inform
    the right contact partner when things went wrong? Hardly any system or network
    administrator can afford to keep an eye on the Nagios Web interface continually
    and wait for changes in status to occur. A practical working system must inform
    the admin actively (push information), so that the admin has time to devote to
    other things and needs to intervene only when Nagios raises the alarm.
  prefs: []
  type: TYPE_NORMAL
- en: Whether a notification system does its job in practice or not is ultimately
    decided by how well it can be adjusted to the requirements of a specific situation.
    What may already be a critical error for one person may, for another, not be normal
    but still tolerable, and nothing is worse than being bombarded with supposed error
    messages that are not even seen as errors in a certain environment. An excess
    of wrong information can make the administrator careless, and at some point the
    real problems get lost in a flood of false messages.
  prefs: []
  type: TYPE_NORMAL
- en: Nagios provides a sophisticated notification system allowing your own environment
    to be fine-tuned to your own requirements. The wide range of settings at first
    seem confusing, but once you have understood the basic principle, everything becomes
    much clearer.
  prefs: []
  type: TYPE_NORMAL
- en: 'The efforts to keep Nagios small and modular also apply to the notification
    system: sending a message is again left by the system to external programs: from
    a simple e-mail through SMS, down to hardware solutions—such as a real traffic
    light on the server cabinet—anything is possible.'
  prefs: []
  type: TYPE_NORMAL
- en: 12.1 Who Should be Informed of What, When?
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In order for Nagios to send meaningful messages, the administrator must answer
    four questions:'
  prefs: []
  type: TYPE_NORMAL
- en: When should the system generate a message?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: When should it be delivered?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Whom should the system inform?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How should the message be sent?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![An overview of the notification system](../Images/tagoreillycom20081104nostarchimages223820.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12-1. An overview of the notification system
  prefs: []
  type: TYPE_NORMAL
- en: '[Figure 12-1](../Text/ch12.html#an_overview_of_the_notification_system "Figure 12-1. An
    overview of the notification system") gives a rough outline of the concept. The
    service and host check generate the message, which then runs through various filters,^([[122](#ftn.CHP-12-FN-1)])
    which usually refer to the time. The *contact* refers to the person whom Nagios
    should inform. If the message has passed all tests, the system hands it to an
    external program, which informs the respective contact.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[122](#CHP-12-FN-1)]) Strictly speaking, filters defined in the host or service
    prevent a message from being created, instead of filtering already generated messages.
    To keep things simple, however, we pretend that Nagios has created a message that
    is then discarded by a corresponding filter.
  prefs: []
  type: TYPE_NORMAL
- en: 12.2 When Does a Message Occur?
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Each message is preceded by a host or service check, which determines the current
    status. In the following two cases it generates a message:'
  prefs: []
  type: TYPE_NORMAL
- en: One hard state changes to another hard state.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: One computer or service remains in a hard error state. (The test therefore confirms
    a problem that already exists.)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To remind you: the **`max_check_attempts`** parameter (see [2.3 Defining the
    Machines to Be Monitored, with host](../Text/ch02s03.html "2.3 Defining the Machines
    to Be Monitored, with host") and [2.5 Defining Services to Be Monitored with service](../Text/ch02s05.html
    "2.5 Defining Services to Be Monitored with service")) defines in host and service
    objects how often a test should be repeated before Nagios categorizes a new status
    as "hard." If it is set to **`1`**, this is immediately the case and is followed
    by the corresponding message. With a value greater than 1, the system repeats
    the test that number of times, and only if they all come to the same new result—such
    as determining the CRITICAL error status—does the status finally change to the
    new hard state, thus triggering a new notification.'
  prefs: []
  type: TYPE_NORMAL
- en: As long as Nagios has not exhausted the specified number of repeats, a soft
    state exists. If the old status reoccurs before these have finished, the administrator
    remains uninformed unless he looks at the Web interface or in the log file. Ultimately
    the administrator is only interested in genuine unsolved problems. On the other
    hand, to assess availability as such, it normally does matter if a service is
    not available for minutes on end, which is why the soft states are also taken
    into account in the evaluation.
  prefs: []
  type: TYPE_NORMAL
- en: 12.3 The Message Filter
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Even if you define on a systemwide basis that Nagios may bring attention to
    errors not just through the Web interface and log files but also via e-mail and/or
    SMS, filter parameters in the host and service definition may in individual cases
    cancel out these basic decisions. In all cases the final word is had by the filters
    defined for the relevant contact. Which parameters play a role on each of these
    three levels (systemwide, host/service, contact), is described in [Figure 12-2](../Text/ch12s03.html#the_filter_sequence_in_the_nagios_notif
    "Figure 12-2. The filter sequence in the Nagios notification system (some parameters
    are only available starting with Nagios version 3.0)").
  prefs: []
  type: TYPE_NORMAL
- en: If a filter stops a notification, the filter chain ends "in a vacuum," so to
    speak—filter options further down in the hierarchy remain unaccounted for—and
    Nagios does not generate any message.
  prefs: []
  type: TYPE_NORMAL
- en: '![The filter sequence in the Nagios notification system (some parameters are
    only available starting with Nagios version 3.0)](../Images/tagoreillycom20081104nostarchimages223822.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12-2. The filter sequence in the Nagios notification system (some parameters
    are only available starting with Nagios version 3.0)
  prefs: []
  type: TYPE_NORMAL
- en: 12.3.1 Switching messages on and off systemwide
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'With the **`enable_notifications`** parameter in the central configuration
    file **`nagios.cfg`**, you can in principal define whether Nagios should send
    messages at all. Only if it is set to **`1`** will the notification system work:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE258]'
  prefs: []
  type: TYPE_PRE
- en: 12.3.2 Enabling and suppressing computer and service-related messages
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: When defining a host or service, various parameters can influence the messaging
    system. Here you can define, for example, at what time Nagios should send messages,
    whether the contact person is regularly informed of error states, and about which
    states or changes in state he should be informed (just CRITICAL, or WARNING as
    well, etc.).
  prefs: []
  type: TYPE_NORMAL
- en: 'The switch **`notifications_enabled`** determines whether this specific computer
    or service is important enough for the admin to be informed of errors not just
    through the Web interface, but also in other ways as well. If this is so, the
    parameter must be set to **`1`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE259]'
  prefs: []
  type: TYPE_PRE
- en: This is also the case in the default, so that you have to set the value explicitly
    to **`0`** at this point to stop separate notifications.
  prefs: []
  type: TYPE_NORMAL
- en: Taking downtimes into account
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: At times when a specific service or host is intentionally not available, Nagios
    should certainly not send any error messages through the network. The configuration
    of corresponding maintenance periods (*downtime scheduling*) is only possible
    through the Web interface and is described in [16.3 Planning Downtimes](../Text/ch16s03.html
    "16.3 Planning Downtimes") from page 359.
  prefs: []
  type: TYPE_NORMAL
- en: What states and changes of state are worth a notification?
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If a regular test shows that service or computer is changing its data continuously,
    this is called *flapping* in Nagios (see also [Appendix B](../Text/apb.html "Appendix B. Rapidly
    Alternating States: Flapping") from page 611). If the **`flap_detection_enabled`**
    parameter is set to **`1`**, the system tries to detect this situation.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Whether Nagios sends a message in this case depends on the **`notification_options`**
    filter. This decides on which states or changes of state Nagios will inform the
    contact involved. In host definitions it can have the following combinations of
    values, separated by commas: **`d`** (switched off or crashed, *down*), **`u`**
    (*unreachable*), **`r`** (computer again reachable, *recovered*), and **`f`**
    (quickly alternating state, *flapping*). Starting with Nagios 3.0, there is an
    additional value **`s`**, which is used to send notifications if a planned maintenance
    period is about to start, end, or is canceled.'
  prefs: []
  type: TYPE_NORMAL
- en: 'For service objects, **`notification_options`** recognizes the following states:
    **`c`** (CRITICAL), **`w`** (WARNING), **`u`** (UNKNOWN, unknown problem), **`r`**
    (service again reachable, *recovered*), and **`f`** (*flapping*). From Nagios
    3.0 onward, the value s is also available for sending notifications on planned
    maintenance periods.'
  prefs: []
  type: TYPE_NORMAL
- en: Nagios correspondingly informs the admin of the state of the service whose definition
    is contained in the line
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE260]'
  prefs: []
  type: TYPE_PRE
- en: only if this is critical or was recreated after an error state. Messages involving
    a WARNING or flapping are discarded by the system.
  prefs: []
  type: TYPE_NORMAL
- en: If **`notification_options`** is set to **`n`** (*none*), Nagios will generally
    not send a message concerning this computer or service.
  prefs: []
  type: TYPE_NORMAL
- en: When should Nagios send messages?
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'At what time should a message be sent? This can be defined with the **`notification_period`**
    parameter:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE261]'
  prefs: []
  type: TYPE_PRE
- en: '**`notification_period`** expects a time object (see [2.10 Defining a Time
    Period with timeperiod](../Text/ch02s10.html "2.10 Defining a Time Period with
    timeperiod") from page 74) as the value; **`24x7h`** is such a value and stands
    for "round the clock."'
  prefs: []
  type: TYPE_NORMAL
- en: Outside the specified time period, Nagios suppresses possible messages, but
    does not simply discard them, in contrast to the other filters. Instead of this,
    the system places the message in a kind of queue and sends it as soon as the notification
    period begins (*rescheduling*). This means that the relevant contact will certainly
    get to hear about the problem. Nagios also ensures that the admin receives the
    message only once, even if multiple messages on the same event were generated
    outside the time period.
  prefs: []
  type: TYPE_NORMAL
- en: '**`notification_period`** is the only time-controlled filter in which a message
    is not lost, despite filtering. With all the other time filters, the message never
    reaches its destination outside the specified period of time.'
  prefs: []
  type: TYPE_NORMAL
- en: 'With an *interval check*, Nagios can be instructed to report at regular intervals
    on problems that persist for a longer time:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE262]'
  prefs: []
  type: TYPE_PRE
- en: If a state persists that Nagios should normally report, corresponding to the
    **`notification_option`** parameter—CRITICAL, for example—for along time, the
    system would grant this wish, in the example, every 120 time units (normally,
    minutes). In other words it suppresses the notification that is generated anyway
    with every check, after a corresponding notification until the specified time
    has elapsed. If nothing has changed in the state until then, it then sends the
    corresponding notification.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you set **`notification_interval`** to **`0`**, Nagios will send a notification
    of this only once. You should be careful when doing this, however: filters defined
    for the contact can also reject messages. If you normally generate just one single
    message, which might arrive at the relevant admin outside the admin''s chosen
    contact time period, then the admin will never be told anything about the problem,
    even if it persists into working hours.'
  prefs: []
  type: TYPE_NORMAL
- en: Starting with Nagios 3.0, the parameter **`first_notification_delay`** allows
    the delayed sending of a notification. With the setting
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE263]'
  prefs: []
  type: TYPE_PRE
- en: Nagios sends notification only after 15 time units (usually minutes) have expired.
    If the system administrator responsible for handling the problem posts an acknowledgement
    within the delay period ([16.1.2 Taking responsibility for problems](../Text/ch16.html#taking_responsibility_for_problems
    "16.1.2 Taking responsibility for problems") from page 332), the notification
    will not be sent, but if the administrator does not react in time, then Nagios
    sends the first notification once the delay period has expired. This option is
    useful for avoiding unneeded notifications when administrators use the Web interface
    to check on the system periodically during their regular working hours.
  prefs: []
  type: TYPE_NORMAL
- en: Whose concern is the message?
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The contact group defined in the host or service object does not itself belong
    to the message filters, but it still decides on who is informed and who is not:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE264]'
  prefs: []
  type: TYPE_PRE
- en: 'What contacts belong to the specified group (here: **`admins`**) is defined
    by the corresponding **`contact_group`** object in its definition object (see
    also [2.8 The Message Recipient: contactgroup](../Text/ch02s08.html "2.8 The Message
    Recipient: contactgroup") from page 72):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE265]'
  prefs: []
  type: TYPE_PRE
- en: 'The specified contact group, though, merely makes a rough preselection: which
    of the contacts specified in it actually receive the message depends on the filter
    functions in the definition of the individual contact. In this way you can ensure
    that one employee is only notified during normal office hours, another one round-the-clock,
    and that one of them is kept up to date about all changes in status, and the other
    one is informed only of a selection (for example, only CRITICAL but not WARNING).'
  prefs: []
  type: TYPE_NORMAL
- en: 12.3.3 Person-related filter options
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: When defining the **`contact`** objects, the method is also specified in which
    Nagios delivers the notification in specific cases (see [12.4 External Notification
    Programs](../Text/ch12s04.html "12.4 External Notification Programs") from page
    275). It can be described separately for host and service problems. Several parallel
    methods are also possible, such as via e-mail *and* SMS.
  prefs: []
  type: TYPE_NORMAL
- en: Since the contact-related filters are specifically for the corresponding contact
    object, it can certainly be useful to define several contacts for one and the
    same recipient that differ in individual parameters, such as a contact object
    that keeps the person informed via e-mail of all problems during normal working
    hours, and a second one for SMS messages concerning critical events outside working
    hours.
  prefs: []
  type: TYPE_NORMAL
- en: What should Nagios inform you about?
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The events for which somebody should be informed can be specified not only
    by host or service, but also by contact. Host and service-related states are defined
    separately here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE266]'
  prefs: []
  type: TYPE_PRE
- en: The possible values are the same as those for the host-service parameter **`notification_options`**
    ([12.3.2 Enabling and suppressing computer and service-related messages](../Text/ch12s03.html#enabling_and_suppressing_computer_and_s
    "12.3.2 Enabling and suppressing computer and service-related messages")).
  prefs: []
  type: TYPE_NORMAL
- en: 'From Nagios 3.0 onward you can normally switch notifications for host and service
    on and off via an additional parameter:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE267]'
  prefs: []
  type: TYPE_PRE
- en: The value 0 prevents the corresponding messages, and the value 1 ensures that
    the messages are sent. At first glance this corresponds to the value **`n`** (no
    notification) for the accompanying option parameter.
  prefs: []
  type: TYPE_NORMAL
- en: The two **`*_notifications_enabled`** parameters can also be switched on and
    off with the external commands **`ENABLE/DISABLE_CONTACT_HOST_NOTIFICATIONS`**
    and **`ENABLE/DISABLE_C0NTACT_SVC_N0TIFICATI0NS`**^([[123](#ftn.CHP-12-FN-2)])
    via the interface for external commands ([13.1 The Interface for External Commands](../Text/ch13.html#the_interface_for_external_commands
    "13.1 The Interface for External Commands") from page 292). This can be done with
    a script where the contact is concerned, without having to alter the preset **`*_notification_options`**.
  prefs: []
  type: TYPE_NORMAL
- en: When do messages reach the recipient?
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The final filter in the filter chain again refers to time periods. If a message
    is produced in the time period specified here, Nagios notifies the contact; otherwise
    it discards the message. The notification window can again be set separately for
    hosts and services, and as a value it expects a **`timeperiod`** object defined
    elsewhere:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE268]'
  prefs: []
  type: TYPE_PRE
- en: 12.3.4 Case examples
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Letting you know once, but doing this reliably
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: What should you do if only a single message should be sent for each change in
    status of the service, but this message must always reach the relevant recipient
    during working hours? We can illustrate the solution to this problem through the
    example of the **`admins`** contact group to which the contact **`wob`** is assigned,
    ...
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE269]'
  prefs: []
  type: TYPE_PRE
- en: '... and to the **`PING`** service for the computer **`linux01`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE270]'
  prefs: []
  type: TYPE_PRE
- en: '**`notification_interval 0`** normally forces Nagios not to produce any repeat
    messages. The **`notification_period`** ensures the desired time period through
    the **`timeperiod`** object **`workhours`**: if Nagios raises the alarm at other
    times, the inbuilt *rescheduling* is used, that is, the notification is sent on
    its way only if the specified time period again applies. It is definitely not
    discarded.'
  prefs: []
  type: TYPE_NORMAL
- en: In order for Nagios to be active in all changes of state, the **`notification_options`**
    must always cover all possible events for services.
  prefs: []
  type: TYPE_NORMAL
- en: 'To guarantee that the contact **`wob`** always receives the messages, it is
    essential that the **`service_notification_period`** in the corresponding **`contact`**
    object is **`24x7`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE271]'
  prefs: []
  type: TYPE_PRE
- en: 'A restricted time filter at this position could, under certain circumstances,
    lead to the loss of each of the individual messages. The same applies for the
    values of **`service_notification_options`**: only if all are entered here as
    well will no message be lost.'
  prefs: []
  type: TYPE_NORMAL
- en: Informing different admins at different times
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If you want to inform different persons at different times about different
    events, you may not restrict either the **`notification_period`** or the **`notification_options`**
    of a host or service:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE272]'
  prefs: []
  type: TYPE_PRE
- en: Filtering takes place exclusively for individual contacts. For this to work
    on a time level you must ensure that Nagios generates a message regularly (here
    every 120 time units, normally minutes) if error states persist.
  prefs: []
  type: TYPE_NORMAL
- en: 'If admin A is to be informed only during his working hours, and then only of
    changes to critical or OK states, A''s contact object will be sent with the following
    parameters:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE273]'
  prefs: []
  type: TYPE_PRE
- en: 'There is also a second and not quite so obvious difference to the first example:
    let us assume that the service reports the CRITICAL status at 7:30 in the morning,
    which will persist for several hours. The **`workhours`** object is defined so
    that it describes the time from Monday to Friday between 8:00 and 18:00\. In the
    above example, Nagios holds back the message (rescheduling), until the time period
    defined in it has been reached. The administrator therefore receives a corresponding
    message at 8:00.'
  prefs: []
  type: TYPE_NORMAL
- en: In the case described here, no rescheduling takes place, Nagios generates a
    corresponding message every two hours, which is filtered out if the contact is
    currently taking a "break." The system correspondingly discards the message at
    7:30, but allows the next message two hours later to pass through. The administrator
    therefore does not receive the corresponding information until 9:30, provided
    that the problem still exists at this point in time.
  prefs: []
  type: TYPE_NORMAL
- en: Which of the two solutions is more suitable depends on specific requirements.
    For an e-mail notification, for example, it makes little difference if the administrator
    receives mails round-the-clock but reads them only when sitting in his office.
    A filter for Nagios messages in the mail client, sorting them in reverse chronological
    order (the most current mail first) makes sense in this case. Sitting in front
    of the screen, the administrator can also take a quick look at the Web interface
    when problems are announced, to check whether anything has changed.
  prefs: []
  type: TYPE_NORMAL
- en: If the methods of differentiation described so far are not sufficient, then
    escalation management, described in [12.5 Escalation Management](../Text/ch12s05.html
    "12.5 Escalation Management"), may be of further help.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[123](#CHP-12-FN-2)]) See [http://www.nagios.org/developerinfo/externalcommands/](http://www.nagios.org/developerinfo/externalcommands/).
  prefs: []
  type: TYPE_NORMAL
- en: 12.4 External Notification Programs
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Which external programs deliver the messages is defined by the contact definition.
  prefs: []
  type: TYPE_NORMAL
- en: 'Here there are again two parameters to define the commands to be used, one
    for services and one for hosts:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE274]'
  prefs: []
  type: TYPE_PRE
- en: 'Both **`*_notification_commands`** allow comma-separated lists, so it is permitted
    to specify more than one command at the same time. The message is then sent simultaneously
    to the recipient in all the ways defined. The names of the command objects describe
    these ways: via e-mail and via SMS.'
  prefs: []
  type: TYPE_NORMAL
- en: To achieve a better overview, the corresponding commands are not defined together
    with the plugin commands in the file **`checkcommands.cfg`**, but in a separate
    object file, **`misccommands.cfg`**. Nagios loads these like any other file with
    object definitions, which is why any name can be chosen for them.
  prefs: []
  type: TYPE_NORMAL
- en: The other parameters, **`email`**, **`pager`**, **`address1`**, and **`address2`**,
    can be regarded as variables. The delivery commands access the values set in these
    through macros. Whether **`pager`** contains a telephone number for SMS delivery
    or an e-mail address pointing to an e-mail SMS gateway is immaterial for the contact
    definition. The decisive factor is that the value matches the corresponding command
    that references this variable.
  prefs: []
  type: TYPE_NORMAL
- en: 12.4.1 Notification via e-mail
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In defining the **`notify-by-email`** command, a name and the command line
    to be executed is specified, as with every other command object. Only its length
    is unusual, which is why it has had to be line-wrapped several times for this
    printed version:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE275]'
  prefs: []
  type: TYPE_PRE
- en: 'The printed-out command object comes from the included example file **`misccommands.cfg-sample`**.
    The command line defined in it can be reduced in principle to the following pattern:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE276]'
  prefs: []
  type: TYPE_PRE
- en: 'With the help of the macro, **`printf`** generates the message text, which
    is passed on to the mail program through a pipe. What is caused by the macros
    specifically used is revealed in [Table 12-1](../Text/ch12s04.html#macros_used_in_notify-by-email_and_host
    "Table 12-1. Macros used in notify-by-email and host-notify-by-email").^([[124](#ftn.CHP-12-FN-3)])
    Using this, the jumbo line shown above produces messages that look something like
    this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE277]'
  prefs: []
  type: TYPE_PRE
- en: Table 12-1. Macros used in notify-by-email and host-notify-by-email
  prefs: []
  type: TYPE_NORMAL
- en: '| Macro | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| **`$CONTACTEMAIL$`** | Value of the **`email`** parameter from the contact
    definition |'
  prefs: []
  type: TYPE_TB
- en: '| **`$LONGDATETIME$`** | Long form of data specification, e.g., **`Fri Jan
    14 16:22:47 CET 2005`** |'
  prefs: []
  type: TYPE_TB
- en: '| **`$HOSTALIAS$`** | Value of the **`alias`** parameter from the host definition
    |'
  prefs: []
  type: TYPE_TB
- en: '| **`$HOSTADDRESS$`** | Value of the **`address`** parameter from the host
    definition |'
  prefs: []
  type: TYPE_TB
- en: '| **`$HOSTNAME$`** | Value of the **`host_name`** parameter from the host definition
    |'
  prefs: []
  type: TYPE_TB
- en: '| **`$HOSTOUTPUT$`** | Text output of the last host check |'
  prefs: []
  type: TYPE_TB
- en: '| **`$HOSTSTATE$`** | State of the host: **`UP`**, **`DOWN`**, or **`UNREACHABLE`**
    |'
  prefs: []
  type: TYPE_TB
- en: '| **`$NOTIFICATIONTYPE$`** | Type of notification: **`PROBLEM`** (CRITICAL,
    WARNING, or UNKNOWN), **`RECOVERY`** (OK after error state), **`ACKNOWLEDGEMENT`**
    (an admin has confirmed the error state; see [16.1.2 Taking responsibility for
    problems](../Text/ch16.html#taking_responsibility_for_problems "16.1.2 Taking
    responsibility for problems"), page 332), **`FLAPPINGSTART`** or **`FLAPPINGSTOP`**
    |'
  prefs: []
  type: TYPE_TB
- en: '| **`$SERVICEDESC$`** | Value of the **`description`** parameter in the service
    definition |'
  prefs: []
  type: TYPE_TB
- en: '| **`$SERVICEOUTPUT$`** | Text output of the last service check |'
  prefs: []
  type: TYPE_TB
- en: '| **`$SERVICESTATE$`** | State of the service: **`OK`**, **`WARNING`**, **`CRITICAL`**,
    **`UNKNOWN`** |'
  prefs: []
  type: TYPE_TB
- en: 'For the command **`host-notify-by-email`**, the command line looks similar,
    except that now host-related macros are used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE278]'
  prefs: []
  type: TYPE_PRE
- en: 'It generates e-mails with the following content:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE279]'
  prefs: []
  type: TYPE_PRE
- en: 12.4.2 Notification via SMS
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: While the infrastructure necessary for sending e-mails^([[125](#ftn.CHP-12-FN-4)])
    is usually available anyway, programs for sending SMS messages such as **`yaps`**,^([[126](#ftn.CHP-12-FN-5)])
    **`smssend`**,^([[127](#ftn.CHP-12-FN-6)]) or **`smsclient`**^([[128](#ftn.CHP-12-FN-7)])
    usually have to be additionally installed. **`yaps`** and **`smsclient`** require
    a local modem or ISDN card and "telephone" directly with the cell phone provider
    (e.g., T-Mobile), **`smssend`** establishes a connection to the Internet servers
    of the cellphone provider and sends the SMS message on this route. With **`yaps`**
    and **`smsclient`** you can also use a mail gateway that generates and sends an
    SMS message from an e-mail.
  prefs: []
  type: TYPE_NORMAL
- en: 'Whichever method you choose, you should be aware of possible interference in
    sending messages: a connection between the Nagios server and the Internet passes
    through many hosts, routers, and firewalls. Especially if Nagios is itself monitoring
    one of the computers involved, things get interesting: if this machine is down,
    then a message sent via **`smssend`** will no longer work either. The same thing
    applies for e-mail-SMS gateways. Whether a self-made construction is involved,
    with **`yaps`** or **`smsclient`**, each of which represents its own SMS gateway,
    or a telecom installation with a sophisticated unified messaging solution, if
    the actual sender of the SMS is many nodes removed from the Nagios server (because
    you have a networked telephone installation with several locations, for example),
    the chances increase that the message will not reach its destination because of
    an interrupted connection.'
  prefs: []
  type: TYPE_NORMAL
- en: For this reason the best solution is an **`smsclient`** or **`yaps`** installation
    on the Nagios server itself with a direct telephone access. In larger, networked
    telephone systems you can also consider giving the telephone access a dedicated,
    direct line from the telephone system. Whether this is ISDN or analog is just
    a question here of the technology used.
  prefs: []
  type: TYPE_NORMAL
- en: To represent the programs mentioned here, we will take a closer look at **`smsclient`**,
    which can be configured very simply, and has an active community On its homepage
    you can also find a link to a mailing list whose members will be pleased to help
    in case you have questions.
  prefs: []
  type: TYPE_NORMAL
- en: Setting up **`smsclient`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: While Debian has its own precompiled **`smsclient`** package, for SuSE and other
    distributions you have to compile the software yourself. For historical reasons
    the program itself is called **`sms_client`**; a short subtext is provided with
    **`man sms_client`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'The installation from the source code follows the usual procedure:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE280]'
  prefs: []
  type: TYPE_PRE
- en: The only point worth mentioning here is that the "homemade" **`configure`**
    procedure manages without **`autoconf`** and **`automake`**.
  prefs: []
  type: TYPE_NORMAL
- en: The configuration files listed in [Table 12-2](../Text/ch12s04.html#smsclients_configuration_files
    "Table 12-2. smsclients configuration files") are now located in the directory
    **`/etc/sms`**; the Debian package installs it to **`/etc/smsclient`**.
  prefs: []
  type: TYPE_NORMAL
- en: Table 12-2. `smsclients` configuration files
  prefs: []
  type: TYPE_NORMAL
- en: '| File | Description |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| **`sms_addressbook`** | Definition of aliases and groups |'
  prefs: []
  type: TYPE_TB
- en: '| **`sms_config`** | Main configuration file |'
  prefs: []
  type: TYPE_TB
- en: '| **`sms_daemons`** | Configuration file for the daemon mode of **`smsclient`**,
    in which this can be reached via a proprietary protocol. Is not required. |'
  prefs: []
  type: TYPE_TB
- en: '| **`sms_modem`** | Modem configuration |'
  prefs: []
  type: TYPE_TB
- en: '| **`sms_services`** | Supported provider |'
  prefs: []
  type: TYPE_TB
- en: The file **`sms_services`** lists the supported providers and at the same time
    assigns them to the protocol used. The precise telephone number dialed is specified
    by the corresponding service file in the directory **`services`** (if you have
    compiled this yourself) or **`/usr/lib/smsclient/services`** (for Debian). In
    case of doubt, you should request the telephone number of your own mobile cell
    provider. The mailing list can also be of assistance here.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the file **`sms_config`** you set a default provider, which the program
    uses for calls when the provider is not specifically given:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE281]'
  prefs: []
  type: TYPE_PRE
- en: 'Only the configuration of the modem is now missing in the file **`sms_modem`**.
    In principle, however, any modem that functions under Linux can be used. In the
    following example we address an ISDN card with the Isdn4Linux-HiSax driver:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE282]'
  prefs: []
  type: TYPE_PRE
- en: '**`/dev/ttyI0`** is used as the device here; for **`MDM_init_command`**, your
    own MSN is used. This applies particularly to private branch exchanges, which
    allow a connection only if your own MSN has been correctly specified.'
  prefs: []
  type: TYPE_NORMAL
- en: Since Isdn4Linux does not recognize tone or pulse dialing, we use only **`D`**
    instead of the usual **`DT`** as the **`MDM_dial_command`**. If the ISDN connection
    requires an outside line as part of a phone exchange, you should enter the corresponding
    prefix; otherwise this string remains empty.
  prefs: []
  type: TYPE_NORMAL
- en: '**`smsclient`** requires write permissions both for the device used and for
    the log file **`/var/log/smsclient.log`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE283]'
  prefs: []
  type: TYPE_PRE
- en: 'To test this, you should now send—preferably as the user **`nagios`**, who
    will later use **`smsclient`**—an SMS message to your own cellphone (here to be
    reached at the number **`01604711`**):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE284]'
  prefs: []
  type: TYPE_PRE
- en: Getting Nagios to work together with **`smsclient`**
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If the second argument is missing in **`smsclient`**, which contains the message
    text, the program will read it from STDIN:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE285]'
  prefs: []
  type: TYPE_PRE
- en: 'Based on the command **`notify-by-email`**, described from page 276, we will
    use the second variation here for defining the **`notify-by-sms`** command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE286]'
  prefs: []
  type: TYPE_PRE
- en: 'As usual, the entire **`command_line`** is written on a single line. Nagios
    obtains the telephone number (or alias) through the macro **`$CONTACTPAGER$`**,
    which reads out the value of the **`pager`** parameter from the contact definition.
    Since an SMS here may not be longer than 150 characters, we will considerably
    abbreviate the information, compared to the e-mail message. To be on the safe
    side (you never know how long the plugin output (**`$SERVICEOUTPUT$`**) really
    is), the **`printf`** format specification **`.150`** (instead of **`%b`**) cuts
    off the text after 150 characters. Although we then do without the line breaks
    in the message, by means of **`\n`**, an SMS is never formatted cleanly, due to
    its limited display. Thus **`notify-by-sms`** generates a one-line message of
    the following type:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE287]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[124](#CHP-12-FN-3)]) A complete list of all macros is contained in the original
    documentation at [http://localhost/nagios/docs/macros.html](http://localhost/nagios/docs/macros.html)
    (normally to be found in the file system under **`/usr/local/nagios/share/docs/macros.html`**).
    For Nagios 3.0 the corresponding file **`macrolist.html`** can also be found in
    this directory.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[125](#CHP-12-FN-4)]) Apart from the **`/usr/bin/mail`** client, a local
    mail server is required.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[126](#CHP-12-FN-5)]) **`[http://www.sta.to/ftp/yaps/](http://www.sta.to/ftp/yaps/)`**
  prefs: []
  type: TYPE_NORMAL
- en: ^([[127](#CHP-12-FN-6)]) **`[http://zekiller.skytech.org/smssend_menu_en.html](http://zekiller.skytech.org/smssend_menu_en.html)`**
  prefs: []
  type: TYPE_NORMAL
- en: ^([[128](#CHP-12-FN-7)]) **`[http://www.smsclient.org/](http://www.smsclient.org/)`**
  prefs: []
  type: TYPE_NORMAL
- en: 12.5 Escalation Management
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Whenever the administrators responsible cannot find a solution in the specified
    time when important components fail, although Service Level Agreements or other
    contracts commit the IT department to do this,^([[129](#ftn.CHP-12-FN-8)]) Nagios's
    ability to escalate notifications makes allowances for conflicts, at least on
    an organizational level. It can be used to provide multilevel support. For example,
    Nagios first informs the *First Level Support* (usually the *Help Desk*). If the
    problem still persists after one day, then the *Second Level Support* is notified,
    and so on.
  prefs: []
  type: TYPE_NORMAL
- en: Nagios also makes a distinction here between host- and service-related escalation
    stages. In essence, both function identically.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the escalation, Nagios does not count in time units, but in how many messages
    it has already sent out. In the following example the system should report on
    error states of the **`Database`** service on **`linux01`** every 120 minutes,^([[130](#ftn.CHP-12-FN-9)])
    and this, round-the-clock:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE288]'
  prefs: []
  type: TYPE_PRE
- en: The corresponding messages always go to a contact group, so without escalation,
    that is to **`admins`**.
  prefs: []
  type: TYPE_NORMAL
- en: '![Nagios escalates, depending on the number of messages already sent](../Images/tagoreillycom20081104nostarchimages223824.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12-3. Nagios escalates, depending on the number of messages already sent
  prefs: []
  type: TYPE_NORMAL
- en: After the fourth notification, Nagios should switch on the first stage of escalation
    (as illustrated in [Figure 12-3](../Text/ch12s05.html#nagios_escalates_comma_depending_on_the
    "Figure 12-3. Nagios escalates, depending on the number of messages already sent"))
    and, in addition to **`admins`**, should notify the **`second-level`** contact
    group. The eighth message triggers the second level, at which Nagios informs the
    **`contact_group third-level`**.
  prefs: []
  type: TYPE_NORMAL
- en: As shown in [Figure 12-3](../Text/ch12s05.html#nagios_escalates_comma_depending_on_the
    "Figure 12-3. Nagios escalates, depending on the number of messages already sent"),
    escalations may certainly overlap. It can also be seen from the graphics that
    the contact group defined in the service object only applies as long as Nagios
    does not escalate. As soon as an escalation stage is switched on, the system puts
    the default contact group out of action.
  prefs: []
  type: TYPE_NORMAL
- en: If the original contact group—here **`admins`**—should also receive a message
    in the first escalation level, then this must be additionally specified in the
    escalation definition. If several levels overlap, Nagios informs all the groups
    involved. In [Figure 12-3](../Text/ch12s05.html#nagios_escalates_comma_depending_on_the
    "Figure 12-3. Nagios escalates, depending on the number of messages already sent")
    the eighth to the tenth messages accordingly go both to **`admins`** and to **`second-level`**
    and **`third-level`**, while only the latter receives message numbers 11 and 12\.
    From message number 13, Nagios keeps only the contact group **`admins`** informed,
    since escalation is no longer defined here.
  prefs: []
  type: TYPE_NORMAL
- en: 'The latter takes place via separate **`serviceescalation`** (for services)
    and **`hostescalation`** objects (for computers). For a service escalation object,
    Nagios requires the beginning and the end of exceptional circumstances to be defined,
    apart from service details (consisting of the **`service_description`** and **`host_name`**)
    parameters and the name of the contact groups responsible:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE289]'
  prefs: []
  type: TYPE_PRE
- en: The escalation level defined here starts, as desired, with message No 4 and
    ends with message No 10\. If **`last_notification`** is given the value **`0`**,
    the escalation only ends if the service changes back to the OK state.
  prefs: []
  type: TYPE_NORMAL
- en: 'In addition you must specify the **`notification_interval`** parameter for
    service escalations: this changes the notification interval (previously **`120`**
    according to the service definition) to **`60`** time units. This parameter is
    also mandatory for a host escalation. The only difference in the definition of
    a **`hostescalation`** object is that instead of the host name, you can also specify
    one or more host groups (in addition the **`service_description`** parameter is
    dropped, of course).'
  prefs: []
  type: TYPE_NORMAL
- en: 'The second escalation step is defined in the same way:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE290]'
  prefs: []
  type: TYPE_PRE
- en: If there are overlapping escalations with different **`notification_intervals`**,
    Nagios chooses the smallest defined time unit in each case. Nagios therefore sends
    messages 8 to 10 at intervals of 60 minutes, numbers 11 and 12 at intervals of
    90 minutes, and then the original interval of 120 minutes again applies.
  prefs: []
  type: TYPE_NORMAL
- en: With **`escalation_period`** and **`escalation_options`** there are two more
    setting parameters specially for escalations. Both have the same function as **`notification_period`**
    and **`notification_options`** in the host or service definition, but they refer
    only to the escalation case.
  prefs: []
  type: TYPE_NORMAL
- en: In contrast to **`notification_interval`**, **`escalation_period`** *does not
    replace* the **`notification_period`**, but acts in addition to this. From the
    intersection of **`notification_period`** and **`escalation_period`**, the actual
    time period is deduced. Suppose that **`notification_period`** refers to the time
    between 7:00 A:M and 5:00 P.M., and **`escalation_period`** to the period from
    8:00 A.M. to 8:00 P.M.. Then Nagios will only send out messages in the escalation
    level between 8:00 A.M. and 5:00 P.M.. You must always remember here that it is
    only the number of messages that have already been sent that decides whether an
    escalation level exists. **`escalation_period`** and **`escalation_options`**
    only have an effect as additional filters.
  prefs: []
  type: TYPE_NORMAL
- en: 'Before these two parameters are used, you should carefully consider what it
    is you want to achieve with them. To restrict the escalation to a specific time
    period could under certain circumstances result in it being omitted entirely.
    If you restrict them to weekdays, for example, this would mean that if the **`Database`**
    service failed during the weekend, Nagios would inform the contact group **`admins`**
    only on Monday morning: over the weekend the system has already sent more than
    12 messages, so it no longer even uses its escalation mechanism. If there is a
    time restriction via **`escalation_period`**, you should set **`last_notification`**
    to **`0`** to ensure that the escalation really does take place.'
  prefs: []
  type: TYPE_NORMAL
- en: Every case of error is followed at some point in time by a recovery. An intelligent
    mechanism ensures that Nagios only notifies those contacts of the corresponding
    recovery who are in charge, depending on the active escalation level, and who
    also received the last notification to be sent.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[129](#CHP-12-FN-8)]) These can also be internal specialist departments.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[130](#CHP-12-FN-9)]) To be precise, every 120 time units, whereby the default
    time unit is 60 seconds.
  prefs: []
  type: TYPE_NORMAL
- en: 12.6 Accounting for Dependencies between Hosts and Services
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: If you test services with local plugins (see [Chapter 7](../Text/ch07.html "Chapter 7. Testing
    Local Resources")) via NRPE (see [Chapter 10](../Text/ch10.html "Chapter 10. The
    Nagios Remote Plugin Executor (NRPE)")), all these tests will come to nothing
    the moment the Plugin Executor fails. With *service dependencies* you can prevent
    Nagios from flooding the appropriate administrator with messages on the dependent
    services. Instead of this, the system informs him specifically of the NRPE failure.
  prefs: []
  type: TYPE_NORMAL
- en: Aa with such service dependencies, Nagios also has *host dependencies*, which
    suppress messages, depending on individual hosts. Both variations can also be
    used to specifically "switch off" tests.
  prefs: []
  type: TYPE_NORMAL
- en: '12.6.1 The standard case: service dependencies'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Let us take as an example the host **`linux01`**, illustrated in [Figure 12-4](../Text/ch12s06.html#the_three_above-mentioned_services_depe
    "Figure 12-4. The three above-mentioned services depend on NRPE"), on which locally
    installed plugins, controlled via NRPE, monitor hard drive space (**`Disks`**
    service, see [10.5.3 Optimizing the configuration](../Text/ch10s05.html#optimizing_the_configuration
    "10.5.3 Optimizing the configuration")), the number of logged-in users (**`Users`**
    service), and the system load (**`Load`** service). If NRPE were now to fail,
    Nagios would announce the CRITICAL state for all three services, although their
    actual state is unknown, and the real problem is the "NRPE daemon."
  prefs: []
  type: TYPE_NORMAL
- en: In order to solve this contradiction, NRPE is monitored as a separate service
    and describes the dependencies in a **`servicedependency`** object.
  prefs: []
  type: TYPE_NORMAL
- en: '![The three above-mentioned services depend on NRPE](../Images/tagoreillycom20081104nostarchimages223826.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12-4. The three above-mentioned services depend on NRPE
  prefs: []
  type: TYPE_NORMAL
- en: 'To define the additional service check for NRPE, we make use of the possibility
    of calling the **`check_nrpe`** plugin (see [Chapter 10](../Text/ch10.html "Chapter 10. The
    Nagios Remote Plugin Executor (NRPE)")) (almost) without any parameters at all.
    It then simply returns the version of the NRPE daemons being used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE291]'
  prefs: []
  type: TYPE_PRE
- en: 'The command defined in [10.5 Nagios Configuration](../Text/ch10s05.html "10.5
    Nagios Configuration") in page 222, **`check_nrpe`**, requires further arguments
    and therefore cannot be used for our purposes. For this reason we set up a new
    command object, **`test_nrpe`**, which exclusively tests NRPE:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE292]'
  prefs: []
  type: TYPE_PRE
- en: 'With this, an **`NRPE`** service can now be defined:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE293]'
  prefs: []
  type: TYPE_PRE
- en: The dependencies of the three local services of NRPE are described by the following
    **`servicedependency`** object.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE294]'
  prefs: []
  type: TYPE_PRE
- en: '**`host_name`** and **`service_description`** define the master service, the
    failure of which leads to the failure of the services named in **`dependent_service_description`**
    on the computer specified in **`dependent_host_name`**. Multiple entries, separated
    by commas, are possible for all four parameters mentioned. You should bear in
    mind, however, that each dependent service is dependent on every possible master
    service.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The remaining parameters influence service checks and notifications: **`notification_failure_criteria`**
    specifies for which states of the master service notifications involving an error
    of the dependent services (e.g., **`Disks`**) should not appear. Possible values
    are **`u`** (UNKNOWN), **`w`** (WARNING), **`c`** (CRITICAL), **`p`** (PENDING,
    i.e., an initial check is planned but was so far not yet carried out), **`o`**
    (OK), and **`n`** (None).'
  prefs: []
  type: TYPE_NORMAL
- en: '**`u`**, **`c`** in the example above means that Nagios does not inform the
    administrators responsible of "errors" in the services **`Disks`**, **`Users`**,
    and **`Load`** on **`linux01`** if the master service is in the CRITICAL or UNKNOWN
    state. With an **`o`** for OK, the logic can be reversed: here there is no message
    if there is an error in the dependent service, as long as the master service is
    in an OK state. Accordingly, **`n`** means that Nagios provides a notification
    irrespective of the status of the master service.'
  prefs: []
  type: TYPE_NORMAL
- en: The **`execution_failure_criteria`** parameter controls tests, depending on
    the state of the master service. The details **`u`** (UNKNOWN), **`w`** (WARNING),
    **`c`** (CRITICAL), **`p`** (PENDING), **`o`** (OK), and **`n`** (None), as with
    **`notification_failure_criteria`**, refer to states of the master service for
    which there should be no check. In the example, **`n`** is specified, so that
    Nagios tests **`Disks`**, **`Users`**, and **`Load`** even if NRPE fails.
  prefs: []
  type: TYPE_NORMAL
- en: Nagios therefore suppresses messages, but since it still carries out the service
    checks on the dependent services, the Web interface always shows the current status
    of these.
  prefs: []
  type: TYPE_NORMAL
- en: The details for **`notification_failure_criteria`** interact with the *Freshness
    mechanism* of passive tests (see [13.4 Reacting to Out-of-Date Information of
    Passive Checks](../Text/ch13s04.html "13.4 Reacting to Out-of-Date Information
    of Passive Checks") from page 295). If **`check_freshness`** is used in the service
    definition, and if Nagios considers the most recently determined status to be
    out of date, it will carry out active tests even if it ought to suppress them,
    according to the service dependency.
  prefs: []
  type: TYPE_NORMAL
- en: Inheritance
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Nagios does not automatically inherit dependencies. An example of this is shown
    in [Figure 12-5](../Text/ch12s06.html#multilevel_dependencies_for_services "Figure 12-5. Multilevel
    dependencies for services"): on the internal side of a firewall, the system should
    query various resources via SNMP. For security reasons, the test is performed
    indirectly via NRPE, that is, the Nagios server runs the SNMP plugins, which are
    installed on a host inside the file, indirectly via NRPE.'
  prefs: []
  type: TYPE_NORMAL
- en: '![Multilevel dependencies for services](../Images/tagoreillycom20081104nostarchimages223828.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12-5. Multilevel dependencies for services
  prefs: []
  type: TYPE_NORMAL
- en: 'The following two **`servicedependency`** objects describe a dependency between
    the **`SNMP`** (Master) service and the **`Disks`** service (dependent service)
    on the host **`linux04`**, as well as between the **`NRPE`** service on **`linux01`**
    and the **`SNMP`** service on **`linux04`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE295]'
  prefs: []
  type: TYPE_PRE
- en: 'If the NRPE daemon on **`linux01`** fails, Nagios would only recognize the
    defined dependencies between **`NRPE`** and **`SNMP`**, but not the implicit dependency
    between **`NRPE`** and **`Disks`**. To take these into account as well, the parameter
    **`inherits_parent`** is inserted in the definition of the service dependency
    between **`Disks`** and **`SNMP`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE296]'
  prefs: []
  type: TYPE_PRE
- en: With this, Nagios tests whether the master service itself (here **`SNMP`**)
    is dependent on another service, thanks to a corresponding **`servicedependency`**.
    If the **`NRPE`** service on **`linux01`** fails (CRITICAL state), Nagios leaves
    out the check of **`Disks`** on **`linux04`**, thanks to **`execution_failure_criteria
    c, u`**, and also does not send any notification of the most recently detected
    status of **`Disks`**.
  prefs: []
  type: TYPE_NORMAL
- en: Other application cases
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Dependency definitions between services are particularly useful if a great deal
    depends on a single service, so that the actual problem is in danger of disappearing
    under a flood of error messages. Apart from the already described use in combination
    with NRPE, this applies for all services that the Nagios server cannot test directly
    and for which it must use tools instead (NRPE, SNMP, or even **`NSCLIENT`** for
    Windows, see [20.2.1 NSClient](../Text/ch20s02.html#nsclient "20.2.1 NSClient")).
    If a simple connection to the utility cannot be established and a constant value
    (version number, system name) cannot be queried, you can still use a generic plugin
    to address the corresponding port.
  prefs: []
  type: TYPE_NORMAL
- en: 'Another example of using service dependencies are the applications that depend
    on a database: a Web application with dynamic Web pages fails if the underlying
    database (which may be located somewhere in the network on another host) is not
    working. A precisely defined dependency between the database service and dynamic
    Web application also ensures here that the administrator is notified of the actual
    cause.'
  prefs: []
  type: TYPE_NORMAL
- en: Additional functions in Nagios 3.0
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Nagios 3.0 includes two innovations: On one hand, the parameter **`dependency_period`**
    now allows a time restriction to be placed on the dependency. The default is **`7x24h`**,
    that is, round the clock.'
  prefs: []
  type: TYPE_NORMAL
- en: On the other hand, Nagios 3.0 makes it easier to define the dependencies between
    services and dependent services on the same host. Specifying **`dependent_host_name`**,
    as was done in the previous examples, can be omitted if this is identical to **`host_name`**.
    An example of this so-called *same-host dependency* is described in [H.1.6 Dependency
    descriptions](../Text/aph.html#dependency_descriptions "H.1.6 Dependency descriptions")
    in page 683.
  prefs: []
  type: TYPE_NORMAL
- en: '12.6.2 Only in exceptional cases: host dependencies'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Host dependencies function in principle exactly like service dependencies; the
    **`hostdependency`** object is also capable of suppressing messages.
  prefs: []
  type: TYPE_NORMAL
- en: There are a number of subtle differences in the detail, however. Only explicitly
    configured regular host checks can be suppressed in which checked intervals are
    defined as for services. This type of host check should be used only in exceptional
    circumstances, however, since it can have a significant influence on the performance
    of Nagios. Normally Nagios decides for itself when it will perform a host check
    (see [4.1 Taking into Account the Network Topology](../Text/ch04.html#taking_into_account_the_network_topology
    "4.1 Taking into Account the Network Topology") from page 92).
  prefs: []
  type: TYPE_NORMAL
- en: In nearly all cases the **`parents`** parameter in the host definition is better
    at describing the dependencies between hosts. As long as Nagios can test individual
    hosts directly, the system can distinguish much better between DOWN and UNREACHABLE
    (see [4.1 Taking into Account the Network Topology](../Text/ch04.html#taking_into_account_the_network_topology
    "4.1 Taking into Account the Network Topology") from page 92). If you do not want
    any notification for particular hosts, dependent on the network topology, then
    you should be informed only for DOWN, but not for UNREACHABLE.
  prefs: []
  type: TYPE_NORMAL
- en: Host dependencies should be used only when Nagios can no longer distinguish
    between DOWN and UNREACHABLE. This is usually the case when indirect checksthe
    host check is performed indirectly (e. g., in the figure shown in [10.5.3 Optimizing
    the configuration](../Text/ch10s05.html#optimizing_the_configuration "10.5.3 Optimizing
    the configuration")).
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 13. Passive Tests with the External Command File
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Apart from active service and host checks, Nagios also makes use of passive
    tests (and combinations of both types of test). While the system itself defines
    the time for active checks when they are performed, and then initiates them, Nagios
    in passive mode only processes incoming results.
  prefs: []
  type: TYPE_NORMAL
- en: For this to work, an interface is required that allows test results from the
    outside to be passed on to Nagios, as well as commands that perform checks and
    feed in the results through the interface. Normally remote hosts send their test
    results, determined by shell scripts, via the *Nagios Service Check Acceptor*
    (NSCA), which is introduced in the next chapter ([Chapter 14](../Text/ch14.html
    "Chapter 14. The Nagios Service Check Acceptor (NSCA)")), to the Nagios server.
  prefs: []
  type: TYPE_NORMAL
- en: 'Passive checks are used in particular with distributed monitoring, in which
    noncentral Nagios servers send all their results to a central Nagios instance.
    This subject is discussed in [Chapter 15](../Text/ch15.html "Chapter 15. Distributed
    Monitoring"). Another field in which they are used is in the processing of asynchronous
    events, the time of which Nagios cannot define itself. One example of this is
    a backup script that sends a result to Nagios (OK or CRITICAL) when it has completed
    a data backup, and another example is processing SNMP traps (see [14.6 Application
    Example II: Processing SNMP Traps](../Text/ch14s06.html "14.6 Application Example
    II: Processing SNMP Traps")).'
  prefs: []
  type: TYPE_NORMAL
- en: 13.1 The Interface for External Commands
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The interface for external commands, known in Nagios jargon as *External Command
    Files*, consists of a named pipe (FIFO)^([[131](#ftn.CHP-13-FN-1)]) in the subdirectory
    **`rw`** of the Nagios **`var`** directory:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE297]'
  prefs: []
  type: TYPE_PRE
- en: The pipe, marked in the **`ls`** output with **`p`**, correctly sets up the
    **`make install-commandmode`** command during installation. For reasons of security
    it is essential that you ensure that only the group **`nagcmd`** can read from
    and write to the pipe. Anyone who has access here can control Nagios remotely
    via commands, and can, if they want, shut it down entirely.
  prefs: []
  type: TYPE_NORMAL
- en: 'Commands that Nagios accepts from the External Command File have the following
    form:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE298]'
  prefs: []
  type: TYPE_PRE
- en: As the timestamp in square brackets, Nagios expects the current time in epoch
    seconds, that is the number of seconds which have elapsed in the UTC time zone
    since January 1, 1970\. This is followed by a space, then a command followed by
    a matching number of arguments, separated by a semicolon.
  prefs: []
  type: TYPE_NORMAL
- en: The interface makes extensive use of this mechanism, allowing its users to make
    various settings via mouse click. A detailed description of all possible commands
    is provided by the online documentation.^([[132](#ftn.CHP-13-FN-2)]) An example
    script for each command can be found there, which can be copied to a file with
    cut-and-paste and used after a few path adjustments have been made.
  prefs: []
  type: TYPE_NORMAL
- en: In this chapter we will limit ourselves to the two processing commands with
    which computers deliver the results of passive checks to the Nagios server, **`PROCESS_SERVICE_CHECK_RESULT`**
    and **`PROCESS_HOST_CHECK_RESULT`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'For reasons of security, the processing of external commands must be explicitly
    switched on in the main configuration file **`nagios.cfg`** with the directive
    **`check_external_commands=1`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE299]'
  prefs: []
  type: TYPE_PRE
- en: The **`command_check_interval`** determines that Nagios checks the interface
    for existing commands every so many seconds. **`−1`** means "as often as possible."
    **`command_file`** specifies the path to the named pipe.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: '^([[131](#CHP-13-FN-1)]) A named pipe is a buffer to which a process can write
    something, which can then be read by another process. Whatever is written first
    is also read first: *First In, First Out* (FIFO). Since this involves space in
    the main memory, a named pipe does not need any space on the hard drive.'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[132](#CHP-13-FN-2)]) [http://www.nagios.org/developerinfo/externalcommands/](http://www.nagios.org/developerinfo/externalcommands/)
  prefs: []
  type: TYPE_NORMAL
- en: 13.2 Passive Service Checks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In order for Nagios to be able to accept passive service checks via the interface,
    this must be explicitly allowed in the global configuration and in the corresponding
    service definition. The corresponding entry in **`nagios.cfg`** is
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE300]'
  prefs: []
  type: TYPE_PRE
- en: 'In the service definition you can select whether you want to perform active
    checks in parallel to the passive ones. Active checks are only possible, of course,
    if Nagios can query the information itself. The following example allows passive
    checks and stops all active ones:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE301]'
  prefs: []
  type: TYPE_PRE
- en: An exception is normally made for *freshness checks* (see [13.4 Reacting to
    Out-of-Date Information of Passive Checks](../Text/ch13s04.html "13.4 Reacting
    to Out-of-Date Information of Passive Checks") from page 295)—here Nagios makes
    use of the command defined in **`check_command`**. To ban active checks entirely,
    the **`check_period`** parameter is set to **`none`**. The check command does
    not play a role in this case, so you can just enter a dummy check here, for example
    (which like all other commands has to be defined, of course).
  prefs: []
  type: TYPE_NORMAL
- en: 'On the computer to be tested passively (in this example, **`linux01`**) you
    must ensure, via NSCA (see [Chapter 14](../Text/ch14.html "Chapter 14. The Nagios
    Service Check Acceptor (NSCA)")), that it contacts the Nagios server through the
    interface for external commands. There it writes the command for passive service
    checks in the following one-line form:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE302]'
  prefs: []
  type: TYPE_PRE
- en: 'The timestamp can be created in a shell script, for example with **`date`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE303]'
  prefs: []
  type: TYPE_PRE
- en: 'A simple script that passes on the result of a passive service check on the
    Nagios server itself to the Nagios installed there, could look like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE304]'
  prefs: []
  type: TYPE_PRE
- en: 'When it is run it expects the parameters in the correct sequence:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE305]'
  prefs: []
  type: TYPE_PRE
- en: After the host and service names, the test status follows as a digit, and finally
    the output text. If the service name contains spaces, then it should also be set
    in quotation marks.
  prefs: []
  type: TYPE_NORMAL
- en: 13.3 Passive Host Checks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Passive host checks follow the same principle as passive service checks, except
    that they involve computers and not services. To allow them globally, the **`accept_passive_host_checks`**
    parameter is set in **`nagios.cfg`** to 1:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE306]'
  prefs: []
  type: TYPE_PRE
- en: 'In addition, the host definition for the computer to be monitored passively
    must allow this kind of host check:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE307]'
  prefs: []
  type: TYPE_PRE
- en: In this example it simultaneously forbids active checks.
  prefs: []
  type: TYPE_NORMAL
- en: 'The command to be sent through the external interface with which the computer
    delivers its test results differs here only marginally from the syntax used in
    the service check command already introduced:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE308]'
  prefs: []
  type: TYPE_PRE
- en: 'Active and passive host checks differ in one important respect: with passive
    checks, Nagios is no longer in a position to distinguish between DOWN and UNREACHABLE
    (see [4.1 Taking into Account the Network Topology](../Text/ch04.html#taking_into_account_the_network_topology
    "4.1 Taking into Account the Network Topology") from page 92). If you still want
    to take account of network topology dependencies when making notifications and
    to give specific information on the actual host that is down, you must make use
    of host dependencies in this case (see [12.6.2 Only in exceptional cases: host
    dependencies](../Text/ch12s06.html#only_in_exceptional_cases_colon_host_de "12.6.2
    Only in exceptional cases: host dependencies") from page 289).'
  prefs: []
  type: TYPE_NORMAL
- en: 13.4 Reacting to Out-of-Date Information of Passive Checks
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: It lies in the nature of passive checks that Nagios is content with the information
    delivered. Nagios has no influence over when and at what intervals the remote
    host delivers them. It may even be the case that the information does not arrive
    at all.
  prefs: []
  type: TYPE_NORMAL
- en: 'In order to classify the "knowledge state" of the server as out of date, Nagios
    has the ability to become active itself, with a *freshness check*. Like passive
    checks, freshness checking must be enabled both globally and in the relevant serviceable
    host object. To do this, you need to set the following global parameters in the
    file **`nagios.cfg`**:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE309]'
  prefs: []
  type: TYPE_PRE
- en: The value **`0`** in **`check_host_freshness`** and the value **`1`** in **`check_service_freshness`**
    ensure that Nagios carries out freshness checks only for services, and not for
    hosts. The check interval defines the intervals at which the server updates its
    information, in this case, every 60 seconds. When Nagios really becomes active
    in the case of a specific service or host depends on the threshold value, which
    you can set in the appropriate service or host definition with the **`freshness_threshold`**
    parameter:^([[133](#ftn.CHP-13-FN-3)])
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE310]'
  prefs: []
  type: TYPE_PRE
- en: So in this example Nagios performs the freshness check for this service only
    if the last transmitted value is older than 3600 seconds (one hour). Then Nagios
    starts the command defined in **`check_command`**, even if active checks have
    been switched off in the corresponding host or service definition, or even globally.
  prefs: []
  type: TYPE_NORMAL
- en: If you define the command named here in the example, **`service_is_stale`**,
    so that Nagios really does check the service or host, then Nagios will perform
    active tests even if active checking is switched off, but always only if passive
    results are overdue for longer than the threshold value set.
  prefs: []
  type: TYPE_NORMAL
- en: 'If active checks are not possible or not wanted, you can ensure, using a pseudo-test,
    that Nagios will explicitly signal an error status, so that the administrator''s
    attention is drawn to it. Otherwise Nagios will always display the last status
    to be received. If this was OK, then it will not necessarily be noticed that current
    results have not been arriving for some time. The following pseudo-test script
    delivers an appropriate error message with **`echo`**, and with **`exit 2`** delivers
    the return value for CRITICAL, so that the administrator can react accordingly:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE311]'
  prefs: []
  type: TYPE_PRE
- en: 'If you start the script from the plugin directory as **`service_is_stale. sh`**,
    the Nagios command **`service_is_stale`** will be defined as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE312]'
  prefs: []
  type: TYPE_PRE
- en: If the results for the service **`Disks`** on **`linux01`** fail to appear for
    longer than one hour, Nagios will run the script **`service_is_stale.sh`**, which
    always returns CRITICAL, irrespective of what data **`linux01`** last sent. This
    CRITICAL status is only ended when the host passes on new and more positive results
    to the server through a passive check.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[133](#CHP-13-FN-3)]) If you do not explicitly specify **`freshness_threshold`**,
    the value set for **`normal_check_interval`** will be used in the hard state,
    and if there is a soft state, the value **`retry_check_interval`** will serve
    as the default.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 14. The Nagios Service Check Acceptor (NSCA)
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In order to send service and host checks across the network to the central
    Nagios server, a transmission mechanism is required. This is provided by the *Nagios
    Service Check Acceptor* (NSCA). It consists of two components: a client program
    **`send_nsca`**, which accepts the results of a service or host check on the remote
    host and sends them to the Nagios server, and the NSCA daemon **`nsca`**, which
    runs on the server, receives data from the client, processes this for the External
    Command File interface (see [13.1 The Interface for External Commands](../Text/ch13.html#the_interface_for_external_commands
    "13.1 The Interface for External Commands")), and passes this data on to it ([Figure 14-1](../Text/ch14.html#how_the_nsca_functions
    "Figure 14-1. How the NSCA functions")).'
  prefs: []
  type: TYPE_NORMAL
- en: The Nagios Service Check Acceptor was originally developed to enable distributed
    monitoring in which decentralized Nagios servers can send their results to a central
    Nagios server (see [Chapter 15](../Text/ch15.html "Chapter 15. Distributed Monitoring")
    from page 317). In principle, the data that **`send_nsca`** sends to the Nagios
    server can come from any applications you like.
  prefs: []
  type: TYPE_NORMAL
- en: Sending commands across the network to the central Nagios instance is not insignificant,
    from a security point of view, since Nagios could be completely switched off using
    the External Command File. This is why NSCA sends the data in encrypted form,
    and clients must have the correct key to obtain access to the interface. This
    prevents an arbitrary network participant from being able to run any commands
    at all on the Nagios server.
  prefs: []
  type: TYPE_NORMAL
- en: '![How the NSCA functions](../Images/tagoreillycom20081104nostarchimages223830.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 14-1. How the NSCA functions
  prefs: []
  type: TYPE_NORMAL
- en: 14.1 Installation
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: NSCA version 2.7.2, current at the time of going to press, was published in
    the spring of 2007; the chances are therefore quite high that the distribution
    you are using contains a current package. The source code^([[134](#ftn.CHP-14-FN-1)])
    is quite easy to compile yourself, however. As a prerequisite, you need to have
    the library **`libmcrypt`** installed, together with the relevant header files,^([[135](#ftn.CHP-14-FN-2)])
    or else the integrated encryption cannot be used.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the unpacked source directory, you should run the included **`configure`**
    script, specifying the Nagios configuration and **`var`** directories:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE313]'
  prefs: []
  type: TYPE_PRE
- en: At the end it displays output, showing the permissions with which the NSCA user
    starts by default, if not otherwise specified in the configuration. Normally the
    NSCA daemon waits on TCP port 5667.
  prefs: []
  type: TYPE_NORMAL
- en: 'A final **`make all`** compiles the two programs **`nsca`** and **`send_nsca`**.
    They are now located in the subdirectory **`src`** and need to be copied manually
    to a suitable directory:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE314]'
  prefs: []
  type: TYPE_PRE
- en: '**`nsca`** is copied to the Nagios server, preferably to the directory **`/usr/local/
    sbin. send_nsca`** belongs on the remote host that is to send its test results
    to the Nagios server. If this computer has a different operating system version
    or platform, it is possible that the client to run there will need to be recompiled.
    Both programs each require their own configuration file, which is best stored
    in the directory **`/etc/nagios:`**'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE315]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[134](#CHP-14-FN-1)]) [http://www.nagios.org/download/](http://www.nagios.org/download/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[135](#CHP-14-FN-2)]) The corresponding binary package usually contains **`-dev`**
    or **`-devel`** in its name.
  prefs: []
  type: TYPE_NORMAL
- en: 14.2 Configuring the Nagios Server
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 14.2.1 The configuration file **`nsca.cfg`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: For NSCA to work, the External Command File interface on the Nagios server must
    be activated in the configuration file **`/etc/nagios/nagios.cfg`** ([13.1 The
    Interface for External Commands](../Text/ch13.html#the_interface_for_external_commands
    "13.1 The Interface for External Commands"), page 292) and the corresponding data
    entered in the NSCA configuration file **`nsca.cfg:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE316]'
  prefs: []
  type: TYPE_PRE
- en: The parameters **`server_port`**, **`server_address`**, **`allowed_hosts`**,
    **`nsca_user`**, and **`nsca_group`** take effect only if **`nsca`** is started
    as a daemon. If it is started as an inet daemon, the values set in its configuration
    apply to the NSCA server address and the port on which the NSCA is listening,
    the IP addresses of the hosts that are allowed to access the interface,^([[136](#ftn.CHP-14-FN-3)])
    and the users and group with whose permissions the Service Check Acceptor runs.
  prefs: []
  type: TYPE_NORMAL
- en: The **`debug`** parameter makes it easier to search for errors, but it should
    normally be switched off (value **`0`**). If it is set to **`1`**, NSCA writes
    debugging information in the syslog.
  prefs: []
  type: TYPE_NORMAL
- en: The named pipe is defined by the entry **`command_file`**. If you specify an
    alternative output file, with **`alternate_dump_file`**, this serves as a fallback
    in case the named pipe given does not exist. Before version 2.0, Nagios removed
    the pipe each time it was shut down, but this should not happen anymore.
  prefs: []
  type: TYPE_NORMAL
- en: If it is set to **`1`**, **`aggregate_writes`** ensures that NSCA collects all
    the incoming commands just once and then passes these on to the interface as a
    block. If the value at this position is **`0`**, then NSCA sends on each incoming
    command immediately to the External Command File.
  prefs: []
  type: TYPE_NORMAL
- en: '**`append_to_file`** can have the values **`0`** (opens the External Command
    File in write mode) or **`1`** (opens it in the append mode), and it should always
    be set to **`0`**.^([[137](#ftn.CHP-14-FN-4)])'
  prefs: []
  type: TYPE_NORMAL
- en: Client messages older than **`max_packet_age`** seconds are discarded by NSCA,
    to avoid replay attacks. This value may not be larger than 900 seconds (15 minutes)
    and should be as small as possible.
  prefs: []
  type: TYPE_NORMAL
- en: The last two parameters refer to the encryption of the communication. **`password`**
    contains the actual key, which is identical for clients, and which must be entered
    in the configuration for the clients (see [14.3 Client-side Configuration](../Text/ch14s03.html
    "14.3 Client-side Configuration") in page 304). Because the key is written in
    the file in plain text, **`nsca.cfg`** should be readable only for the user with
    whose permissions the NSCA is running, which in our case is **`nagios:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE317]'
  prefs: []
  type: TYPE_PRE
- en: Finally, **`decryption_method`** defines the encryption algorithm. The default
    is **`1`** (XOR), which is almost as insecure as **`0`** (no encryption). **`10`**
    stands for LOKI97, which is regarded as secure.^([[138](#ftn.CHP-14-FN-5)]) The
    list of all possible algorithms is contained in the supplied configuration file,
    which contains many old algorithms and some newer ones, such as DES (**`2`**),
    Triple-DES (**`3`**), Blowfish (**`8`**), and Rijndael (AES).^([[139](#ftn.CHP-14-FN-6)])
  prefs: []
  type: TYPE_NORMAL
- en: 14.2.2 Configuring the inet daemon
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you want to start **`nsca`** with the inet daemon, the following entry is
    added in the file **`/etc/services:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE318]'
  prefs: []
  type: TYPE_PRE
- en: '**`xinetd`** configuration'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If the newer **`xinetd`** is used, the file **`nagios-nsca`** is created in
    the directory **`/etc/xinetd.d`** with the following contents:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE319]'
  prefs: []
  type: TYPE_PRE
- en: The values printed in bold type for the user and group with whose permissions
    the NSCA should run, and the path to the NSCA daemon **`nsca`** (parameter **`server`**)
    and the corresponding configuration file, are adjusted if necessary to your own
    environment. The line **`only_from`**, as an equivalent to the **`nsca.cfg`**
    parameter **`allowed_hosts`**, takes in all the IP addresses, separated by spaces,
    from which the NSCA may be addressed. Distributions that include NSCA as a finished
    package and install **`xinetd`** by default, include a ready-to-use **`xinetd`**
    configuration file, where you only need to adjust this last parameter.
  prefs: []
  type: TYPE_NORMAL
- en: 'In order for the new configuration to become effective, the **`xinetd`** init
    script is run with the **`reload`** argument:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE320]'
  prefs: []
  type: TYPE_PRE
- en: inetd configuration
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If the standard **`inetd`** command is run, the following line is added (line-wrapped
    for the printed version) in the configuration file **`/etc/inetd.conf:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE321]'
  prefs: []
  type: TYPE_PRE
- en: 'If you want to leave out the TCP wrapper **`tcpd`**, you just omit the string
    **`/usr/sbin/tcpd`**. In this case you must also explicitly specify the user (**`nagios`**)
    with whose permissions the NSCA starts, the complete path to the binary **`nsca`**,
    and the configuration file with its absolute path. So that the Internet daemon
    can take account of the modification, its configuration must be reloaded:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE322]'
  prefs: []
  type: TYPE_PRE
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[136](#CHP-14-FN-3)]) If you want to define more than one IP address for
    **`allowed_hosts`**, they are separated by a comma.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[137](#CHP-14-FN-4)]) The append mode only makes sense if the External Command
    File is replaced for debugging purposes with a simple file.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[138](#CHP-14-FN-5)]) [http://en.wikipedia.org/wiki/L0KI97](http://en.wikipedia.org/wiki/L0KI97)
  prefs: []
  type: TYPE_NORMAL
- en: '^([[139](#CHP-14-FN-6)]) Rijndael-128: **`14`**; Rijndael-192: **`15`**; Rijndael-256:
    **`16`**'
  prefs: []
  type: TYPE_NORMAL
- en: 14.3 Client-side Configuration
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The configuration file **`send_nsca.cfg`** on the client side must contain
    the same encryption parameters as the file on the Nagios server:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE323]'
  prefs: []
  type: TYPE_PRE
- en: 'Since the key is also written here in plain text, it should not be readable
    for just any user. For this reason it is best to create a user **`nagios`** and
    a group **`nagios`** on the client side:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE324]'
  prefs: []
  type: TYPE_PRE
- en: 'You should now protect the file **`send_nsca.cfg`** so that only the user **`nagios`**
    can read it, and ensure, using the SUID mechanism, that the program **`send_nsca`**
    always runs under the user ID of this user. If you now grant execute permission
    to the group **`nagios`**, only its members may execute the NSCA client program:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE325]'
  prefs: []
  type: TYPE_PRE
- en: 14.4 Sending Test Results to the Server
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The client program **`send_nsca`** reads the details of a host or service check
    from the standard input, which the administrator must format as follows:^([[140](#ftn.CHP-14-FN-7)])
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE326]'
  prefs: []
  type: TYPE_PRE
- en: '**`send_nsca`** sends this to the Nagios server. The first line describes the
    format for service checks and the second line, that for host checks. The placeholder
    **``*`return value`*``** is replaced by the status determined, that is, **`0`**
    for OK, **`1`** for WARNING, **`2`** for CRITICAL, and **`3`** for UNKNOWN. By
    **``*`output`*``**, a one-line text is meant, of the type that plugins provide
    as a support for the administrator. As the separator, a tab sign is used (**`\t`**).'
  prefs: []
  type: TYPE_NORMAL
- en: In order to make a complete command from this that can be understood by the
    external command, the NSCA daemon first prefixes the timestamp and the matching
    command (**`PROCESS_SERVICE_CHECK_RESULT`** or **`PROCESS. HOST_CHECK_RESULT`**).
    This is why only these two commands can be sent using NSCA.
  prefs: []
  type: TYPE_NORMAL
- en: '**`send_nsca`** itself has the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**`-H`** **``*`address`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the host name or IP address of the Nagios server to be addressed by
    NSCA.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-d`** **``*`delimiter`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This is the delimiter for the input; the default is a tab sign. The following
    example page uses the semicolon as a *delimiter*.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-c`** **``*`path/to_the/configuration_file`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This parameter specifies the path to the configuration file **`send_nsca.cfg`**.
    Since no path has been compiled into the client, **`send_nsca`** expects by default
    to find the file in the current directory. For this reason it makes sense to specify
    the absolute path with this option.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-p`** **``*`port`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: This defines an alternative port if the default, the TCP port 5667, is not used.
  prefs: []
  type: TYPE_NORMAL
- en: '**`-to`** **``*`timeout`*``**'
  prefs: []
  type: TYPE_NORMAL
- en: After **``*`timeout`*``** seconds (by default, **`10`**) **`send_nsca`** aborts
    the connection attempt to the NSCA daemon, if no connection is established.
  prefs: []
  type: TYPE_NORMAL
- en: With simple test scripts such as the following one, the functionality of the
    NSCA can be tested. A service is chosen as the test object, which is in a state
    other than UNKNOWN (e.g., OK), in this case, **`nmbd`** on the host **`linux0l:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE327]'
  prefs: []
  type: TYPE_PRE
- en: 'The script puts it, from Nagios''s point of view, into the UNKNOWN status.
    After it is run, you should discover if the transfer was successful:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE328]'
  prefs: []
  type: TYPE_PRE
- en: As soon as Nagios processes the command and you have reloaded the page in your
    browser, the Web interface displays the UNKNOWN status for the selected service.
    With the next active check, the previous status will be recovered.
  prefs: []
  type: TYPE_NORMAL
- en: Because it is so simple to send Nagios check results with **`send_nsca`**, it
    is essential that you protect the NSCA from misuse, as already demonstrated. On
    the client, you should restrict access to the client program **`send_nsca`** and
    to its configuration file and you should make sure that you have secure encryption,
    and on the server explicitly define the sender and IP addresses that are to be
    allowed.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[140](#CHP-14-FN-7)]) Normally you have to ensure that test scripts you have
    written yourself produce the correct output; if you use Nagios plugins, you must
    reformat their output accordingly. Since the latter can be run much better directly
    with NRPE, this should be the exception to the rule.
  prefs: []
  type: TYPE_NORMAL
- en: '14.5 Application Example I: Integrating syslog and Nagios'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Linux and Unix systems as a rule log system-relevant events through syslog.
    Sooner or later you will probably want Nagios to also inform the administrator
    of important syslog events. To do this, you require passive service checks, NSCA
    for transmitting the results to the Nagios server, and a method of filtering individual
    block entries.
  prefs: []
  type: TYPE_NORMAL
- en: If you are using **`syslog-ng`**^([[141](#ftn.CHP-14-FN-8)]) instead of the
    standard BSD syslog, you can make use of its ability to set filters and to format
    the output using templates. The use of NSCA compensates for the fact that the
    program cannot itself transmit data in encrypted form.
  prefs: []
  type: TYPE_NORMAL
- en: This connection to Nagios is supplemented by programs to evaluate log files,
    such as **`logcheck`**,^([[142](#ftn.CHP-14-FN-9)]) which is contained in almost
    every Linux distribution, but it does not replace them. This is because Nagios
    can send individual e-mails for each event, but not for a summary of events, as
    **`logcheck`** does (usually once per hour). In addition to this, the Web interface
    always displays the last event in each case.
  prefs: []
  type: TYPE_NORMAL
- en: 14.5.1 Preparing **`syslog-ng`** for use with Nagios
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Apart from the source code, the **`syslog-ng`** homepage^([[143](#ftn.CHP-14-FN-10)])
    also provides a detailed manual, which is why we shall only discuss the basic
    principle at this point. The software differentiates between the **`source`**,
    **`filter`**, and **`destination`**. All three objects can be combined in any
    form; they are defined in the configuration file **`/etc/syslog-ng/syslog-ng.conf:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE329]'
  prefs: []
  type: TYPE_PRE
- en: 'This example defines three sources at the same time: **`unix-stream`** reads
    from the socket **`/dev/log`**, through which most programs send their messages
    to the syslog. **`internal`** is the name of the source **`syslog-ng`** feeds
    with internal messages, and from the file **`/proc/kmsg`** syslog receives **`kernel`**
    messages. These are given the **`kernel:`** prefix, so that they can be be distinguished
    from normal log entries.'
  prefs: []
  type: TYPE_NORMAL
- en: The **`destination`** definition ensures that all syslog output appears on the
    console **`ttyl0`** (this can be displayed with ![14.5.1 Preparing syslog-ng for
    use with Nagios](../Images/tagoreillycom20081104nostarchimages223832.png)-![14.5.1
    Preparing syslog-ng for use with Nagios](../Images/tagoreillycom20081104nostarchimages223834.png)).
  prefs: []
  type: TYPE_NORMAL
- en: '**`filter`** defines what messages should reach this destination, if any. In
    the case of the **`f_messages`** filter, this is all messages matching the category
    (the **`level`**) **`info`** and that syslog does not provide with the stamp (the
    **`facility`**; see **`man syslog.conf`** and **`man 3 syslog`**) **`auth`** or
    **`authpriv`**. Alternatively **`syslog-ng`** filters according to a search pattern,
    with the instruction **`match`** (**``"*`pattern`*"``**), according to the program
    doing the logging (**`program`**(**``"*`program name`*"``**)) and according to
    the source host (**`host`** (**``"*`hostname`*"``**)).'
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally the keyword **`log`** links the source, filter, and destination. Multiple
    specifications are possible here, so several sources and destinations can be specified
    in a single statement:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE330]'
  prefs: []
  type: TYPE_PRE
- en: If you specify several filters in a **`log`** statement, **`syslog-ng`** only
    allows data through that matches all filter criteria (AND link).
  prefs: []
  type: TYPE_NORMAL
- en: 'To integrate this into Nagios, use is made of the option of defining a program
    as a target, which is called for every event:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE331]'
  prefs: []
  type: TYPE_PRE
- en: 'The **`template`** directive formats the output so that it is suitable for
    **`send_nsca`**, using a semicolon as the delimiter: host and service names (**`syslog-ng`**)
    are followed by the state (**`1`** = WARNING; **`2`** = CRITICAL), and then the
    actual output text is given. Apart from **`$H0ST`** and **`$MSG`**, **`syslog-ng`**
    has a series of further macros, which are described individually in the documentation
    on the homepage. The parameter **`template_escape`** protects quotation marks
    in the text and is intended principally for SQL commands, so in this case it can
    be set to **`no`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The following script **`send_syslog.sh`** uses the bash function **`read`**
    to read from the standard input line by line, and for each line read it calls
    up **`send_nsca`**, which sends on the data—as described in this chapter—as a
    passive test result to Nagios:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE332]'
  prefs: []
  type: TYPE_PRE
- en: Because a semicolon is used as a delimiter, we specify this explicitly with
    the option **`-d`**. The status report that each **`send_nsca`** command displays
    on the standard output is diverted by the script into a separate log file (**`/usr/local/nagios/var/send_syslog.log`**).
  prefs: []
  type: TYPE_NORMAL
- en: 'Thanks to the **`program`** instruction in the syslog configuration, **`syslog-ng`**
    starts the script automatically. This is also the reason that the **`send_nsca`**
    command is in an endless loop: this means that **`syslog-ng`** does not run an
    external program every time there is a relevant event.'
  prefs: []
  type: TYPE_NORMAL
- en: '14.5.2 Nagios configuration: volatile services'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In Nagios slang, "volatile" refers to services that show an error state only
    once. This refers to devices, for example, that automatically reset the state
    when an error is queried—which means that the error cannot be reproduced. The
    same applies for syslog entries: if a check following an error state returns an
    error, this will always be a second event. So we don''t have a continuing error
    state here, but a problem that has again occurred.'
  prefs: []
  type: TYPE_NORMAL
- en: For continuing error states, Nagios normally does not send any further messages
    for the time being. With the **`is_volatile`** parameter, however, it treats every
    error as if it had just occurred. Nagios logs the state, sends a notification,
    and implements the event handler—provided it is defined—(see [Appendix C](../Text/apc.html
    "Appendix C. Event Handlers") from page 619).
  prefs: []
  type: TYPE_NORMAL
- en: 'For **`syslog-ng`**, this means that each entry is seen as an independent event.
    In order that Nagios sees things in this way as well, the corresponding service
    definition contains the **`is_volatile`** parameter:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE333]'
  prefs: []
  type: TYPE_PRE
- en: Since the Nagios server should not test anything on its own, **`active_checks_enabled
    0`** switches off active service checks. However, *freshness checking* (see [13.4
    Reacting to Out-of-Date Information of Passive Checks](../Text/ch13s04.html "13.4
    Reacting to Out-of-Date Information of Passive Checks") from page 295) can always
    cause Nagios to perform active tests. To prevent this, we set the **`check_freshness`**
    parameter in this case explicitly to **`0`**.
  prefs: []
  type: TYPE_NORMAL
- en: 'This service definition does not really require the parameters **`check_command`**
    and **`check_period`**, but since these are mandatory parameters, they must still
    be specified: as **`check_command`**, the plugin **`check_dummy`** (see [8.1 The
    Dummy Plugin for Tests](../Text/ch08.html#the_dummy_plugin_for_tests "8.1 The
    Dummy Plugin for Tests") in page 188) is used.'
  prefs: []
  type: TYPE_NORMAL
- en: It is also important that **`max_check_attempts`** is set to **`1`**, so that
    a transmitted error state immediately triggers a hard state. With a value larger
    than **`1`**, Nagios would wait for further error results here before categorizing
    the problem state as a hard state.
  prefs: []
  type: TYPE_NORMAL
- en: The **`notification_options`** parameter ensures that the system informs the
    specified contact group of all error states (WARNING, CRITICAL, and UNKNOWN).
    The **`notification_interval`**, which defines the interval between two notifications
    for a continuing error state, is actually superfluous, since Nagios, thanks to
    **`is_volatile 1`**, provides notification of every event immediately, irrespective
    of what the previous state looked like. But since it is a mandatory parameter,
    **`notification_interval`** still has to be specified.
  prefs: []
  type: TYPE_NORMAL
- en: 14.5.3 Resetting error states manually
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Events that are taken into account by the syslog filter always inform you of
    only one current state, which is why the syslog service in Nagios never displays
    an OK state on its own ([Figure 14-2](../Text/ch14s05.html#the_syslog-ng_service_in_an_error_state
    "Figure 14-2. The syslog-ng service in an error state")).
  prefs: []
  type: TYPE_NORMAL
- en: '![The syslog-ng service in an error state](../Images/tagoreillycom20081104nostarchimages223836.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 14-2. The `syslog-ng` service in an error state
  prefs: []
  type: TYPE_NORMAL
- en: This problem can be solved with the Web interface, which allows a passive check
    result to be generated manually.
  prefs: []
  type: TYPE_NORMAL
- en: If you click on the service name in [Figure 14-2](../Text/ch14s05.html#the_syslog-ng_service_in_an_error_state
    "Figure 14-2. The syslog-ng service in an error state"), the extended status information
    will be shown ([Figure 14-3](../Text/ch14s05.html#the_arrow_points_to_the_possibility_of
    "Figure 14-3. The arrow points to the possibility of "generating" a passive test
    result for the syslog-ng service")). There you will find the entry **`Submit passive
    check result for this service`**, with which a test result can be sent manually
    ([Figure 14-4](../Text/ch14s05.html#creating_a_passive_check_result_sysl "Figure 14-4. Creating
    a passive check result syslog-ng")). In this way the **`syslog-ng`** service can
    be reset to its normal state. Since the Web interface always shows only the most
    recent error state, but not individual error messages, you must look through the
    e-mail messages to see whether other errors have occurred apart from those errors
    displayed by Nagios in the Web interface.
  prefs: []
  type: TYPE_NORMAL
- en: '![The arrow points to the possibility of "generating" a passive test result
    for the syslog-ng service](../Images/tagoreillycom20081104nostarchimages223838.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 14-3. The arrow points to the possibility of "generating" a passive test
    result for the `syslog-ng` service
  prefs: []
  type: TYPE_NORMAL
- en: You can also define your own service for each syslog event, of course. This
    may sometimes be quite time-consuming, but it does allow you to separate various
    messages and their processing states in the Web interface. If the filter in **`syslog-ng`**
    is restricted so that a syslog service object always refers to just one resource
    to be monitored, you can also leave out the **`is_volatile`** parameter.
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating a passive check result syslog-ng](../Images/tagoreillycom20081104nostarchimages223840.png.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 14-4. Creating a passive check result `syslog-ng`
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[141](#CHP-14-FN-8)]) The "ng" stands here for *next generation*.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[142](#CHP-14-FN-9)]) [http://sourceforge.net/projects/logcheck/](http://sourceforge.net/projects/logcheck/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[143](#CHP-14-FN-10)]) [http://www.balabit.com/products/syslog_ng/](http://www.balabit.com/products/syslog_ng/)
  prefs: []
  type: TYPE_NORMAL
- en: '14.6 Application Example II: Processing SNMP Traps'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Asynchronous messages that are sent by an SNMP agent (see [11.1 Introduction
    to SNMP](../Text/ch11.html#introduction_to_snmp "11.1 Introduction to SNMP") from
    page 228) to a central management unit, called *traps* in SNMP jargon, can be
    processed by Nagios in a way similar to the Nagios Service Check Acceptor (NSCA).
    In addition, it allows SNMP traps to be accepted on a host other than the Nagios
    server itself.
  prefs: []
  type: TYPE_NORMAL
- en: Processing SNMP traps with Nagios is particularly worthwhile if the system monitors
    the network almost completely, and only a few devices or services restrict their
    communication just to SNMP and SNMP traps. Nagios, or the Open Source tool OpenNMS,^([[144](#ftn.CHP-14-FN-11)])
    are no substitutes for real commercial SNMP management systems.
  prefs: []
  type: TYPE_NORMAL
- en: In many cases, SNMP traps are vendor-specific, so that you cannot avoid getting
    to grips with the appropriate documentation and the vendor-specific MIB (*Management
    Information Base*; see [11.1.1 The Management Information Base](../Text/ch11.html#the_management_information_base
    "11.1.1 The Management Information Base") from page 229).
  prefs: []
  type: TYPE_NORMAL
- en: 14.6.1 Receiving traps with **`snmptrapd`**
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In order to receive SNMP traps, you require a special Unix/Linux daemon that
    generates messages for Nagios from them. The software package NET-SNMP, described
    in [11.2.2 The NET-SNMP daemon](../Text/ch11s02.html#the_net-snmp_daemon "11.2.2
    The NET-SNMP daemon") from page 238, includes the daemon **`snmptrapd`**.
  prefs: []
  type: TYPE_NORMAL
- en: In the following scenario, **`snmptrapd`** is installed on a third host (neither
    the computer generating the trap, nor the Nagios server). It evaluates the information
    received by means of a script and forwards it with NSCA to the Nagios server.^([[145](#ftn.CHP-14-FN-12)])
  prefs: []
  type: TYPE_NORMAL
- en: 'In the **`snmptrapd`** configuration file **`/etc/snmp/snmptrapd.conf`**, each
    trap type is given a separate entry, the syntax of which corresponds to one of
    the following lines:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE334]'
  prefs: []
  type: TYPE_PRE
- en: The keyword **`traphandle`** is followed either by the object identifier of
    the desired trap, or by the keyword **`default`**. In the second case the entry
    applies to all traps that do not have their own configuration entry. Finally the
    program that should run if a relevant trap arrives is specified.
  prefs: []
  type: TYPE_NORMAL
- en: In addition you can also include arguments used with this program. But you must
    be a bit careful when doing this. Quotation marks are passed on by **`snmptrapd`**
    as characters and spaces are always used as delimiters. This means that you cannot
    pass on any arguments containing spaces, which you should bear in mind when assigning
    name services in Nagios.
  prefs: []
  type: TYPE_NORMAL
- en: '**`snmpdtrapd`** gives this program information via the standard output in
    the following format:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE335]'
  prefs: []
  type: TYPE_PRE
- en: The first line contains the *fully qualified domain name* of the host that sends
    the message and the second, its IP address. Then one or more OID-value pairs are
    given, each on a separate line. A particular event is very often linked to a unique
    OID-value pair, so that the program can often omit the evaluation of the OID-value
    pair entirely.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following **`snmptrapd.conf`** example, the lines are wrapped for readability
    Each **`traphandle`** instruction *must* be entered on a single line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE336]'
  prefs: []
  type: TYPE_PRE
- en: The traps used here are sent by the SNMP agent **`snmpd`** from the NET-SNMP
    package by default, as long as a destination was specified in **`snmpd.conf:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE337]'
  prefs: []
  type: TYPE_PRE
- en: If a trap arrives with the OID **`SNMPv2-MIB::coldStart`**, for example, **`snmptrapd`**
    starts the script **`handle-trap`** with the argument **`cold-start`**. In this
    way it does not have to search first for the necessary information from the OID-value
    pairs. However, this shortcut only works with trap OID names that describe their
    function.
  prefs: []
  type: TYPE_NORMAL
- en: 14.6.2 Passing on traps to NSCA
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The script **`handle-trap`**, which is run by **`snmptrapd`**, breaks down the
    information passed on and hands it over, correctly formatted, to **`send_nsca:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE338]'
  prefs: []
  type: TYPE_PRE
- en: First it saves the log file and the name of the Nagios server **`nagsrv`**,
    each in a separate variable. The first **`case`** statement specifies the host
    name used by Nagios for the IP address passed on (and temporarily stored in **`IPADDR`**).
    **`HOST`** normally contains the fully qualified domain name, which also cannot
    be used directly, and sometimes also just contains one IP address, so that it
    is better to use the latter here. The explicit test also allows it to discard
    traps from undesired hosts. Finally, matching traps land without further authentication
    on the Nagios server.^([[146](#ftn.CHP-14-FN-13)])
  prefs: []
  type: TYPE_NORMAL
- en: The following **`if`** statement determines whether a service name was also
    given to the script. If this is the case, then it is saved in the **`SERVICE`**
    variable. If there was a second argument, the procedure is similar. Depending
    on the value, the next **`case $SWITCH`** instruction defines the output text
    and the desired status for Nagios.
  prefs: []
  type: TYPE_NORMAL
- en: The command for NSCA is finally assembled and the **`CMD`** variable is passed
    on by the script to **`send_nsca`**. As in previous examples, a semicolon is used
    as the delimiter, which must be specified in **`send_nsca`** with the option **`-d`**.
  prefs: []
  type: TYPE_NORMAL
- en: 14.6.3 The matching service definition
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'As in the **`syslog-ng`** example ([14.5.1 Preparing syslog-ng for use with
    Nagios](../Text/ch14s05.html#preparing_syslog-ng_for_use_with_nagios "14.5.1 Preparing
    syslog-ng for use with Nagios")), we again define the service on the Nagios server
    as a purely passive one:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE339]'
  prefs: []
  type: TYPE_PRE
- en: 'Since soft states do not make any sense in a single trap message, we should
    set **`max_check_attempts`** back to **`1`**. Whether the parameter **`is_volatile`**
    is used or not depends on the purpose to which the service is put. As long as
    you define a separate service for each error category, there is no problem in
    omitting **`is_volatile`**. But if you form different error categories using a
    single service, you should **`set is_volatile 1`**, because in this case the previous
    error will seldom have anything to do with the new one. [14.5.2 Nagios configuration:
    volatile services](../Text/ch14s05.html#nagios_configuration_colon_volatile_se
    "14.5.2 Nagios configuration: volatile services") in page 309 is devoted to the
    subject of volatile services.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: ^([[144](#CHP-14-FN-11)]) [http://www.opennms.org/](http://www.opennms.org/)
  prefs: []
  type: TYPE_NORMAL
- en: ^([[145](#CHP-14-FN-12)]) If you install the **`snmptrapd`** on the Nagios server
    itself, you do not need NSCA and you can send a correspondingly formatted command,
    as described in [13.2 Passive Service Checks](../Text/ch13s02.html "13.2 Passive
    Service Checks") from page 293 directly to the interface for external commands.
  prefs: []
  type: TYPE_NORMAL
- en: ^([[146](#CHP-14-FN-13)]) Although SNMPv3 does provide authentication for SNMP
    traps, this would go beyond the scope of this book.
  prefs: []
  type: TYPE_NORMAL
- en: Chapter 15. Distributed Monitoring
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Passive service and host checks can be used to create a scenario in which several
    noncentral Nagios instances send their results to a central server. In general
    they transfer their results using the Nagios Service Check Acceptor (see [Chapter 14](../Text/ch14.html
    "Chapter 14. The Nagios Service Check Acceptor (NSCA)")); the central Nagios instance
    receives them through the External Command File interface and continues processing
    them as passive checks (see [Chapter 13](../Text/ch13.html "Chapter 13. Passive
    Tests with the External Command File") from page 291).
  prefs: []
  type: TYPE_NORMAL
- en: What is now missing is the mechanism that prepares each test result of a noncentral
    Nagios instance to be sent with NSCA. For such cases, Nagios provides the commands
    OCSP ("Obsessive Compulsive Service Processor") and OCHP ("Obsessive Compulsive
    Host Processor"), two commands designed specifically for distributed monitoring.
    In contrast to *event handler* (see [Appendix C](../Text/apc.html "Appendix C. Event
    Handlers") from page 619), which shows changes in status and only passes on check
    results if the status has changed, these two commands obsessively pass on every
    test result ([Figure 15-1](../Text/ch15.html#distributed_monitoring_with_nagios
    "Figure 15-1. Distributed monitoring with Nagios")).
  prefs: []
  type: TYPE_NORMAL
- en: '![Distributed monitoring with Nagios](../Images/tagoreillycom20081104nostarchimages223842.png)'
  prefs: []
  type: TYPE_IMG
- en: Figure 15-1. Distributed monitoring with Nagios
  prefs: []
  type: TYPE_NORMAL
- en: 15.1 Switching On the OCSP/OCHP Mechanism
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In order to use OCSP/OCHP, several steps are necessary. The mechanism is initially
    switched on (only) on the noncentral Nagios servers in the global configuration
    file **`/etc/nagios/nagios.cfg`**, where a global command for hosts (OCHP) and
    services (OCSP) is defined. This causes the noncentral Nagios instance to send
    every result to the central server.
  prefs: []
  type: TYPE_NORMAL
- en: In the service and host definitions you can additionally set whether the corresponding
    service or host should use the mechanism or not. For the central Nagios server
    to be able to use the results transferred, each service or host on it must finally
    be defined once again.
  prefs: []
  type: TYPE_NORMAL
- en: 'You should only switch on the two parameters **`obsess_over_services`** and
    **`obsess_over_hosts`** in **`nagios.cfg`** if you really do want distributed
    monitoring:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE340]'
  prefs: []
  type: TYPE_PRE
- en: Every time a new test result arrives on the Nagios server, it calls the command
    object defined with **`ocsp_command`** or **`ochp_command`**. This causes an additional
    load on resources.
  prefs: []
  type: TYPE_NORMAL
- en: The two timeouts prevent Nagios from spending too much time on one command.
    If processing does not terminate (because the command itself does not receive
    a timeout and the central Nagios server does not react), then the process table
    of the noncentral Nagios instance would fill very quickly, and might overflow.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you want to selectively exclude test results for specific services and hosts
    from transmission to the central Nagios server, the following parameters are used:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE341]'
  prefs: []
  type: TYPE_PRE
- en: With a value of **`1`** the local Nagios instance sends the results of the host
    or service check to the central server, but with a value of **`0`**, this does
    not happen. The **`1`** is the default for both **`obsess_over_hosts`** and **`obsess_over_services`**;
    if results are *not* to be transferred, then you have to specify the two parameters.
    This is always recommended if the central location is only responsible for particular
    things, and the remaining administration is carried out on site.
  prefs: []
  type: TYPE_NORMAL
- en: 15.2 Defining OCSP/OCHP Commands
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Defining the two commands with which the noncentral instances send their results
    to the Nagios main server in most cases involves scripts that are based on **`send_nsca`**
    (see also the example in [14.4 Sending Test Results to the Server](../Text/ch14s04.html
    "14.4 Sending Test Results to the Server")). For services, such a script would
    look like the following one, in this case called **`submit_service_check:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE342]'
  prefs: []
  type: TYPE_PRE
- en: 'When run, the command expects four parameters on the command line in the correct
    order: the host monitored, the service name, the return value for the plugin opened
    (**`0`** for OK, **`1`** for WARNING, etc.), and the one-line info text that is
    issued by the plugin. To format the data we use the **`printf`** function (**`man
    printf`**). The newly formatted string is finally passed on to **`send_nsca`**.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The equivalent script for OCHP (stored here in the file **`submit_host_check`**)
    looks something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE343]'
  prefs: []
  type: TYPE_PRE
- en: The only thing missing is the specification of the service description.
  prefs: []
  type: TYPE_NORMAL
- en: It is best to store the two scripts, in conformity with the Nagios documentation,
    in a subdirectory **`eventhandlers`** (which normally needs to be created) in
    the plugin directory (usually **`/usr/local/nagios/libexec`**, but for some distributions
    this will be **`/usr/lib/nagios/plugins`**). You can retrieve this from the definition
    of the matching command object using the macro **`$USER1$`**. This is best defined
    in the **`misccommands.cfg file:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE344]'
  prefs: []
  type: TYPE_PRE
- en: If you use a separate file for this, you must make sure that Nagios will load
    this file by adding an entry to **`/etc/nagios/nagios.cfg`**. The single quotes
    surrounding the **`$SERVICEDESC$`** macro and the two output macros in the **`command_line`**
    line are important. Their values sometimes contain empty spaces, which the command
    line would interpret as delimiters without the quotes.
  prefs: []
  type: TYPE_NORMAL
- en: 15.3 Practical Scenarios
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: One application for distributed monitoring is the monitoring of branches or
    external offices in which a noncentral Nagios installation is limited to running
    service and host checks and sending the results to the central instance. The noncentral
    instances do not need further Nagios functions, such as the notification system
    or the Web interface.
  prefs: []
  type: TYPE_NORMAL
- en: On the other hand, if administrators look after the networks at the distributed
    locations, while the central IT department only looks after special services,
    then the noncentral Nagios server is set up as a normal, full-fledged installation
    and selectively forwards only those check results over the OCSP/OCHP mechanism
    to the central office for which the specialists there are responsible.
  prefs: []
  type: TYPE_NORMAL
- en: 'Whatever the case, you must ensure that the host and service definition is
    available both noncentrally and centrally. This can be done quite simply using
    templates ([2.11 Templates](../Text/ch02s11.html "2.11 Templates") in page 75)
    and the **`cfg_dir`** directive ([2.1 The Main Configuration File nagios.cfg](../Text/ch02.html#the_main_configuration_file_nagios.cfg
    "2.1 The Main Configuration File nagios.cfg"), page 55): you set up the definition
    so that the configuration files can be copied 1:1.'
  prefs: []
  type: TYPE_NORMAL
- en: 15.3.1 Avoiding redundancy in configuration files
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In the following example we assume that the noncentral servers only perform
    host and service checks and send the results to the central server, and do not
    provide any other Nagios functions. The following directories are set up on the
    central host:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE345]'
  prefs: []
  type: TYPE_PRE
- en: Each of the configurations used for a location lands in the directory **`/etc/nagios/sites/`****``*`location`*``**.
    After **`global`**, all the definitions follow that can be used identically at
    all locations (e.g., the command definitions in **`checkcommands.cfg`**). The
    directory **`local`** takes in specific definitions for the central server definitions.
    These include the templates for services and hosts, where distinction must be
    made between central and noncentral.
  prefs: []
  type: TYPE_NORMAL
- en: 'This directory is also created separately on the noncentral servers: only the
    folders **`global`** and **`sites/`****``*`location`*``** are copied from the
    central instance to the branch offices.'
  prefs: []
  type: TYPE_NORMAL
- en: The three directories are read in with the **`cfg_dir`** directive in **`/etc/nagios/nagios.cfg:`**
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE346]'
  prefs: []
  type: TYPE_PRE
- en: 'Only settings that are identical for the noncentral and central page are used
    in the service definition:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE347]'
  prefs: []
  type: TYPE_PRE
- en: The location-dependent parameters are dealt with by the templates.
  prefs: []
  type: TYPE_NORMAL
- en: 15.3.2 Defining templates
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In order that service definitions are identical on both the central and non-central
    servers, the local templates must have the same names as the central ones. In
    addition you should ensure that the obligatory parameters (see [Chapter 2](../Text/ch02.html
    "Chapter 2. Nagios Configuration") from page 53) are also all entered, even if
    they are not even required at one of the locations, because together, the template
    and service definitions must cover all obligatory parameters.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example shows a service template for one of the noncentral locations:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE348]'
  prefs: []
  type: TYPE_PRE
- en: The parameters that are important for the noncentral page are printed in bold
    type. Besides the parameters that refer to the test itself, the parameter **`obsess_over_services`**
    must also not be left out. This ensures that the check results are sent to the
    central server.
  prefs: []
  type: TYPE_NORMAL
- en: '**`notifications_enabled`** switches off notification in this case, since the
    local admins do not need to worry about error messages from services that are
    centrally monitored. Alternatively this can be done globally in the non-central
    **`/etc/nagios/nagios.cfg`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '**`register 0`** ensures that the template is used exclusively as a template,
    so that Nagios does not interpret it as a separate service definition.'
  prefs: []
  type: TYPE_NORMAL
- en: 'The counterpart with the same name on the central server looks something like
    this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE349]'
  prefs: []
  type: TYPE_PRE
- en: The parameter **`passive_checks_enabled`** is of importance here, as well as
    the configuration of the notification system. On the central side, the parameters
    involving the test itself come into play only if freshness checking is used (see
    [13.4 Reacting to Out-of-Date Information of Passive Checks](../Text/ch13s04.html
    "13.4 Reacting to Out-of-Date Information of Passive Checks") from page 295).
    This works only if the central Nagios server is itself in a position to actively
    test all services if there is any doubt. Since the **`check_command`** in this
    simple template solution is given in the location-dependent service definition,
    which is identical on the non-central and central servers, this will work only
    if the same command object can be used both centrally and noncentrally—if the
    object definitions in **`global/checkcommands.cfg`** match on both sides.
  prefs: []
  type: TYPE_NORMAL
- en: In the example, however, we completely switch off active tests of services at
    the Bonn location, with **`check_period none`** and **`check_freshness`** set
    to 0\. The system described so far can also be applied to host checks, of course.
  prefs: []
  type: TYPE_NORMAL
