<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;USER LOCATION"><div class="titlepage"><div><div><h1 class="title"><a id="user_location"/>Chapter 7. USER LOCATION</h1></div></div></div><div class="informalfigure"><div class="mediaobject"><a id="I_mediaobject7_d1e7656"/><img src="httpatomoreillycomsourcenostarchimages671943.png.jpg" alt="image with no caption"/></div></div><p>Creating a location-based website requires a starting point. Sometimes this point comes as data from your database or from your site's focus on a small geographic area. Even in these cases, you can benefit from knowing a user's location.<a id="IDX-CHP-7-0001" class="indexterm"/><a id="IDX-CHP-7-0002" class="indexterm"/></p><p>You can retrieve this information in a number of ways, which I'll cover in this chapter. The methods vary in complexity and accuracy. In some cases, you'll need to make a simple call in JavaScript. In others, you'll install a database so your server can determine the location.</p><p>Finding a user's location also depends on how much permission you need from him or her. An IP address, for example, is something every Internet user has. You can find a city-level location for most users without them even knowing you looked. For methods where the browser accesses another data source, you'll need the user's permission. In all cases, of course, you should do your part to ensure user privacy.<a id="IDX-CHP-7-0003" class="indexterm"/></p><p>We'll start with perhaps the simplest method of determining a user's location, something that has been around as long as the Web itself.</p><div class="sect1" title="#47: Ask Users Where They Are"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_47_colon_ask_users_where_t"/>#47: Ask Users Where They Are</h1></div></div></div><p>Does this seem obvious? Asking users where they are may not be a flashy method of determining their location, but this method is bound to produce results the user expects. Plus, it has the built-in benefit of being only as specific as the user wants. In other words, the user can provide a full address, postal code, or simply a city name. If you're counting on knowing your users' whereabouts, at least include this project as a fallback when you cannot otherwise determine their location.<a id="IDX-CHP-7-0004" class="indexterm"/><a id="IDX-CHP-7-0005" class="indexterm"/><a id="IDX-CHP-7-0006" class="indexterm"/><a id="IDX-CHP-7-0007" class="indexterm"/><a id="IDX-CHP-7-0008" class="indexterm"/></p><p>Of course, what you want is latitude and longitude coordinates. Our maps expect those coordinates, and that's how so much geographic data is stored. We can't ask for latitude and longitude directly (go ahead and try that on your friends and see how many know their current geocodes); instead, we ask for the text representation of those coordinates. Once users give you this information, you'll probably need to feed it to a geocoder. This section won't cover that part, but you can learn all about it in <a class="xref" href="ch03.html" title="Chapter 3. GEOCODING">Chapter 3</a>. In this project, I'll show how to get the input into variables in both JavaScript and PHP.</p><div class="sect2" title="Get Input Using JavaScript"><div class="titlepage"><div><div><h2 class="title"><a id="get_input_using_javascript"/>Get Input Using JavaScript</h2></div></div></div><p>When we rely upon JavaScript to accept input, you can use the data without having to reload the entire page. Also because mapping providers work with JavaScript, you only need one programming language, which simplifies things a bit.</p><p>To accept user input, we'll incorporate an HTML form into the site. The form will have a simple text input box and a Submit button, as shown in <a class="xref" href="ch07.html#request_location_or_other_input_with_jav" title="Figure 7-1. Request location or other input with JavaScript.">Figure 7-1</a>.</p><div class="figure"><a id="request_location_or_other_input_with_jav"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject7_d1e7724"/><img src="httpatomoreillycomsourcenostarchimages672075.png.jpg" alt="Request location or other input with JavaScript."/></div></div><p class="title">Figure 7-1. Request location or other input with JavaScript.</p></div><p>Add the following code to a new HTML page:</p><a id="I_programlisting7_d1e7731"/><pre class="programlisting">&lt;!DOCTYPE html "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
  &lt;html &gt;
    &lt;head&gt;
      &lt;title&gt;Get Input from a Form with JavaScript&lt;/title&gt;
      &lt;script type="text/javascript"&gt;
        var f;
❶       function prepare() {
          f = document.getElementById("myform");
❷         f.onsubmit = function() {
            var userinput = ❸f.wheretext.value;
            // Do something with userinput
❹           return false; // avoids form submission
          };
        }
      &lt;/script&gt;
    &lt;/head&gt;
    &lt;body onload="prepare()"&gt;
      &lt;form id="myform"&gt;
        &lt;input type="text" name="wheretext" /&gt;
        &lt;input type="submit" name="butnew" value="Get Input" /&gt;
      &lt;/form&gt;
    &lt;/body&gt;
  &lt;/html&gt;</pre><p>When the page is loaded, the <code class="literal">prepare</code> function is called ❶. This method is similar to the <code class="literal">create_map</code> function in other mapping projects. The name of this function can be whatever you want, as long as it matches the name you use to call it.<a id="IDX-CHP-7-0009" class="indexterm"/><a id="IDX-CHP-7-0010" class="indexterm"/><a id="IDX-CHP-7-0011" class="indexterm"/></p><p>First, you need to attach a submission event to the form ❷. You want to stop the form from submitting to the server, however, and instead use the data within JavaScript. In this example, I've used an inline, anonymous function instead of a named function for submitting the form. Otherwise, the <code class="literal">prepare</code> function would be a single line.</p><p>Also, I'm referencing the form by its index, which, in this case, is zero. It is the first and only form on this page. If other forms were on the page, it might be the second and its index would be one (because JavaScript array indexers start at zero). You could also give the form a name or ID and access it that way.</p><p>To obtain the user input, I refer to the text input field by name from the form object ❸. Including the <code class="literal">.value</code> portion is important, as that retrieves the text the user typed, as opposed to the input field object. Once you have the text, what you do with it is your decision; for instance, you might display it on the site or determine its coordinates using <a class="xref" href="ch03s03.html" title="#12: Geocode with JavaScript">#12: Geocode with JavaScript</a> in <a class="xref" href="ch03s03.html" title="#12: Geocode with JavaScript">#12: Geocode with JavaScript</a>.</p><p>The final line ❹ of the submission function is also important. This line stops the browser from sending the form's input to the server, which is what we <span class="emphasis"><em>want</em></span> to happen in the next section.</p></div><div class="sect2" title="Get Input Using PHP"><div class="titlepage"><div><div><h2 class="title"><a id="get_input_using_php"/>Get Input Using PHP</h2></div></div></div><p>Let's be clear: Users type their input inside a browser. The difference between using JavaScript to get input and using PHP (or any server-side language) is that we allow the data to be submitted to the server. The original intention of an HTML form is to send data to a server-side script that then replies with additional HTML.</p><p>Because most of the notable stuff happens within a PHP script, the HTML for getting input is fairly simple. Add the following lines to a new HTML file:<a id="IDX-CHP-7-0012" class="indexterm"/><a id="IDX-CHP-7-0013" class="indexterm"/><a id="IDX-CHP-7-0014" class="indexterm"/><a id="IDX-CHP-7-0015" class="indexterm"/></p><a id="I_programlisting7_d1e7794"/><pre class="programlisting">&lt;!DOCTYPE html "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
&lt;html &gt;
  &lt;head&gt;
    &lt;title&gt;Get Input from a Form with PHP&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;form ❶method="POST" ❷action="input.php"&gt;
      &lt;input type="text" name="wheretext" /&gt;
      &lt;input type="submit" name="butnew" value="Get Input" /&gt;
    &lt;/form&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre><p>This code is essentially the same HTML as in the JavaScript example, but the JavaScript has been removed. The major difference is that the <code class="literal">&lt;form&gt;</code> tag receives a few more attributes.</p><p>I've declared a method ❶, which tells the browser how to send the input to the server. The two major options here are <code class="literal">GET</code>, which sends input inside the URL as a query string. I chose <code class="literal">POST</code>, which passes the data in the body of the HTTP message, so the user doesn't see it.</p><p>Another important attribute is the form's action ❷. This action is the destination URL for the form data. If the action is omitted, the current page will be assumed. If you're sending from a regular HTML file, this result is definitely not what you want because the server-side language will be unable to parse the data. I've used a PHP file in this case, as that's how I'll be reading in the input.</p><p>Now we need to make that PHP code, so add the following code to a new file named <span class="emphasis"><em>input.php</em></span> (or to match your action attribute):</p><a id="I_programlisting7_d1e7816"/><pre class="programlisting">&lt;?
 $userinput = $_POST["wheretext"];
 // Do something with userinput
?&gt;</pre><p>Pretty simple, right? All you need to do is pass the name of the input box to the <code class="literal">$_POST</code> variable, which is an associative array. PHP does the hard work of deciphering the header text and deciphering the encoded text.</p><p>If you're going to use the value within a database, make sure you verify the data is good. If you expecting a postal code, make sure the data is in the correct format. If you have an address, watch out for strange characters that don't belong in addresses—semicolons come to mind. You don't want to be the victim of a SQL injection attack, where user input is co-opted to create a hazardous query.</p><p>If you're going to use the input elsewhere, such as in <a class="xref" href="ch03s04.html" title="#13: Geocode with an HTTP Web Service">#13: Geocode with an HTTP Web Service</a> in <a class="xref" href="ch03s04.html" title="#13: Geocode with an HTTP Web Service">#13: Geocode with an HTTP Web Service</a>, you might be able to rely on its security. But most of the time, do as much as you can on your side to ensure data integrity.<a id="IDX-CHP-7-0016" class="indexterm"/><a id="IDX-CHP-7-0017" class="indexterm"/><a id="IDX-CHP-7-0018" class="indexterm"/><a id="IDX-CHP-7-0019" class="indexterm"/><a id="IDX-CHP-7-0020" class="indexterm"/><a id="IDX-CHP-7-0021" class="indexterm"/></p></div></div></div>
<div class="sect1" title="#48: Get Location Using JavaScript"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_48_colon_get_location_usin"/>#48: Get Location Using JavaScript</h1></div></div></div><p>Many web browsers can now report your user's location with a lot more precision than you get with an IP address. Using the coordinates, you can save users the hassle of having to tell you their location, and you could, for example, automatically search nearby.</p><p>The Worldwide Web Consortium, often called the W3C, is an organization working for standards on the Web. In these examples, I will use the W3C's recommended syntax. Whether using a desktop, laptop, or mobile phone, the code that you will use is the same.</p><p>So, let's get to it. From anywhere in your JavaScript code, add the following line:</p><a id="I_programlisting7_d1e7863"/><pre class="programlisting">navigator.geolocation.getCurrentPosition(foundLoc, noLoc);</pre><p>This function begins the geolocation process. The browser will request the user's permission to share his or her location with you. When the user approves, the browser will call a callback function, which is the first argument passed to <code class="literal">getCurrentPosition</code>. A second callback function is available when the location cannot be determined or the user rejects your request.</p><p>I made up the names of those functions, and you can use whatever name you want. Whatever you call them, however, you'll then need to write the functions, so the browser has something to reference. If you prefer anonymous, inline functions, you can use those in place of the named functions.</p><p>In the same file that you used to make the location request, let's add those two functions:</p><a id="I_programlisting7_d1e7874"/><pre class="programlisting">function foundLoc(❶pos) {
    var lat = ❷pos.coords.latitude;
    var lon = pos.coords.longitude;
❸   alert('Found location: ' + lat + ', ' + lon);
  }
  function noLoc() {
❹   alert('Could not find location');
  }</pre><p>The first function, which is called when the browser is able to find a location and the user approves sharing it, is passed a position object ❶. We can use this to get at the latitude ❷, longitude, and some other data (more on that later). Once we have snagged both coordinates, we create a JavaScript alert, showing the location ❸. This alert is not especially useful, but we're just proving it works right now.<a id="IDX-CHP-7-0022" class="indexterm"/><a id="IDX-CHP-7-0023" class="indexterm"/><a id="IDX-CHP-7-0024" class="indexterm"/><a id="IDX-CHP-7-0025" class="indexterm"/></p><p>If no location can be found (or if the user doesn't want to share his or her location), we create a JavaScript alert that says so ❹. In a full application, you might choose to do nothing in this case. Or depending on how your site is designed, you could create an option to enter the location manually when it can't be determined.</p><p>Before we do something a little more interesting, let's talk about how an ordinary browser can even access your location.</p><div class="sect2" title="Where Does the Data Come From?"><div class="titlepage"><div><div><h2 class="title"><a id="where_does_the_data_come_from_question"/>Where Does the Data Come From?</h2></div></div></div><p>The source and accuracy of the location data varies by source. A cutting-edge smart phone is certainly fitted with global positioning satellite (GPS), so the browser has a pretty good idea where you are if that's the source. What about on a laptop or desktop though?<a id="IDX-CHP-7-0026" class="indexterm"/></p><p>Most computers do not have GPS. Instead, they rely on Wi-Fi to find your location. A handful of companies have driven around the world's largest cities (and some small ones, too!) and "sniffed" for wireless Internet. Whenever they find a signal, they add its unique ID to their database, along with the latitude and longitude.</p><p>Then, when a browser requests a location, it sniffs the available Wi-Fi. Armed with an ID, it asks a server to reply back with coordinates. Are you skeptical? In urban areas, this method is extremely accurate in finding a location because so many Wi-Fi access points are available. Also, wireless is only supposed to go a few hundred feet, so for most uses it's still fairly accurate. And in many cases, Wi-Fi is more reliable than GPS, which has a difficult time accessing signals indoors. You can see the accuracy of different methods in <a class="xref" href="ch07s02.html#accuracy_of_geolocation_methods" title="Table 7-1. Accuracy of Geolocation Methods">Table 7-1</a>.</p><div class="table"><a id="accuracy_of_geolocation_methods"/><p class="title">Table 7-1. Accuracy of Geolocation Methods</p><div class="table-contents"><table summary="Accuracy of Geolocation Methods" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/></colgroup><thead><tr><th style="text-align: left" valign="bottom"><p>Method</p></th><th style="text-align: left" valign="bottom"><p>Accuracy</p></th></tr></thead><tbody><tr><td style="text-align: left" valign="top"><p>GPS</p></td><td style="text-align: left" valign="top"><p>Within feet</p></td></tr><tr><td style="text-align: left" valign="top"><p>WiFi</p></td><td style="text-align: left" valign="top"><p>Within a block</p></td></tr><tr><td style="text-align: left" valign="top"><p>Cell towers</p></td><td style="text-align: left" valign="top"><p>Within a few miles</p></td></tr><tr><td style="text-align: left" valign="top"><p>IP address</p></td><td style="text-align: left" valign="top"><p>ZIP- or city-level</p></td></tr></tbody></table></div></div><p>When neither of these options is available, you need a fallback plan. A mobile device can sometimes use cell tower triangulation. A standard web browser, on the other hand, will always have an IP address. Whether the fallback is used depends on the implementation.<a id="IDX-CHP-7-0027" class="indexterm"/></p><p>Another thing that varies with the device being used and the way the browser implements the location code is what additional data is available.</p></div><div class="sect2" title="What Other Data Can We Get?"><div class="titlepage"><div><div><h2 class="title"><a id="what_other_data_can_we_get_question"/>What Other Data Can We Get?</h2></div></div></div><p>The W3C created a standard that could work in all situations. As you've seen, a number of data sources and devices can be used to determine a location. Mobile phones, especially, can provide some interesting data.<a id="IDX-CHP-7-0028" class="indexterm"/></p><p>Previously, I described how to grab a location's coordinates using JavaScript. Here are some other values you may be able to access:<a id="IDX-CHP-7-0029" class="indexterm"/></p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Time the location was acquired</p></li><li class="listitem"><p>Accuracy of the location, in meters</p></li><li class="listitem"><p>Altitude of the location</p></li><li class="listitem"><p>Accuracy of the altitude, if it exists, in meters</p></li><li class="listitem"><p>Speed, in meters per second</p></li><li class="listitem"><p>Heading, the direction in degrees relative to true north</p></li></ul></div><p>Not every device will be able to provide all this information. For example, if the user is on a laptop, latitude and longitude may be all that is available. If the data comes from GPS, however, you may be able to access all these fields.</p></div><div class="sect2" title="Use the Location on the Map"><div class="titlepage"><div><div><h2 class="title"><a id="use_the_location_on_the_map"/>Use the Location on the Map</h2></div></div></div><p>Now that you can get the user's location, you probably want to <span class="emphasis"><em>do something</em></span> with it. The easiest example is to use it as the center of your new map. You could also add a marker at that spot. Heck, why don't we do both?</p><p>This example will be slightly different than the others in that the map won't be created until we know that we have a location. Because of this, let's start with a fresh HTML file, instead of the basic map. Add these lines to your new file:</p><a id="I_programlisting7_d1e8009"/><pre class="programlisting">&lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;W3C Geolocation Map&lt;/title&gt;

      &lt;script type="text/javascript"
              src="http://maps.google.com/maps/api/js?sensor=false"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="mxn.js?(googlev3)"&gt;&lt;/script&gt;
      &lt;style&gt;
        div#mymap {
          width: 400px;
          height: 350px;
        }
      &lt;/style&gt;
      &lt;script type="text/javascript"&gt;
        navigator.geolocation.getCurrentPosition(❶create_map, ❷function() {});

        function create_map(❸pos) {
❹         var pt = new mxn.LatLonPoint(pos.coords.latitude, pos.coords.longitude);
          mapstraction = new mxn.Mapstraction('mymap', 'googlev3');
          mapstraction.setCenterAndZoom(pt, 15);
          var marker = new mxn.Marker(pt);
          marker.setInfoBubble('You Are Here');
          mapstraction.addMarker(marker);
❺         marker.openBubble();
        }
      &lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div id="mymap"&gt;&lt;/div&gt;
    &lt;/body&gt;
  &lt;/html&gt;</pre><p>Because we only want to call the <code class="literal">create_map</code> function when we have a location, nothing is called when the page loads. Instead the call to <code class="literal">getCurrentPosition</code> happens within bare JavaScript, and then the map initialization function is used as a callback ❶. If no location is found, we don't want to do anything, so we create an empty inline function ❷. In the future, you might want to do something, so this leaves a template to remind you that something can go here.<a id="IDX-CHP-7-0030" class="indexterm"/><a id="IDX-CHP-7-0031" class="indexterm"/><a id="IDX-CHP-7-0032" class="indexterm"/><a id="IDX-CHP-7-0033" class="indexterm"/></p><p>When the <code class="literal">create_map</code> function does get called, the position ❸ the browser found is passed to it. The first thing we'll do with that position, which is an object in the W3C format, is convert it to Mapstraction's object for describing a point ❹. Then centering the map and creating the marker is as easy as the examples shown in the first two chapters.</p><p>For a little extra fun, we give the marker a message box that says "You Are Here." After adding the marker to the map, we automatically display the message ❺. When I ran this in my hometown of Portland, I got the result shown in <a class="xref" href="ch07s02.html#location_coordinates_plotted_on_a_map" title="Figure 7-2. Location coordinates plotted on a map">Figure 7-2</a>.</p><p>From here, you could plot local results on a map or get driving questions using the found location as a starting point.</p></div><div class="sect2" title="Receive Continual Updates"><div class="titlepage"><div><div><h2 class="title"><a id="receive_continual_updates"/>Receive Continual Updates</h2></div></div></div><p>If your application will be used on a mobile device, then a user's location may change as he or she moves around. Depending on what you're doing with the data, receiving an initial location may not be enough—you may want updates.</p><p>The W3C has accounted for this need with a second function to access the user's location. Rather than <code class="literal">getCurrentPosition</code>, you can use this line:</p><a id="I_programlisting7_d1e8054"/><pre class="programlisting">var geoid = navigator.geolocation.watchPosition(foundLoc, noLoc);</pre><p>The two function references passed as arguments are used just as they are with a single location request. The difference here is the browser will periodically call your functions without the code performing another request. Frequency is determined by the browser and may be every minute or so. Mobile browsers will likely send updates more often.</p><div class="figure"><a id="location_coordinates_plotted_on_a_map"/><div class="figure-contents"><div class="mediaobject"><a id="I_mediaobject7_d1e8061"/><img src="httpatomoreillycomsourcenostarchimages672077.png.jpg" alt="Location coordinates plotted on a map"/></div></div><p class="title">Figure 7-2. Location coordinates plotted on a map</p></div><p>You could implement this yourself by calling the single request every so often. The browser might prompt the user with every request, however; the <code class="literal">watchPosition</code> function's permission lasts until the user reloads the page.</p><p>If you want the application to stop tracking the user's location, you can clear it with this function:</p><a id="I_programlisting7_d1e8073"/><pre class="programlisting">navigator.geolocation.clearWatch(geoid);</pre><p>Note the function accepts one argument. This variable is an identifier output by the <code class="literal">watchPosition</code> function. In order to stop watching, store this identifier in a variable.</p></div><div class="sect2" title="Additional Geolocation Options"><div class="titlepage"><div><div><h2 class="title"><a id="additional_geolocation_options"/>Additional Geolocation Options</h2></div></div></div><p>The two functions mentioned in the previous sections accept a third argument that I haven't covered yet. You can set additional options, such as how old a location can be and whether you want the highest accuracy possible.</p><p>Here is an example geolocation call that includes options:<a id="IDX-CHP-7-0034" class="indexterm"/><a id="IDX-CHP-7-0035" class="indexterm"/><a id="IDX-CHP-7-0036" class="indexterm"/><a id="IDX-CHP-7-0037" class="indexterm"/><a id="IDX-CHP-7-0038" class="indexterm"/><a id="IDX-CHP-7-0039" class="indexterm"/><a id="IDX-CHP-7-0040" class="indexterm"/></p><a id="I_programlisting7_d1e8114"/><pre class="programlisting">var locOptions = {
  enableHighAccuracy: true,
  timeout: 5000,
  maximumAge: 60000
}
navigator.geolocation.getCurrentPosition(foundLocation, noLocation, locOptions);</pre><p>I created a variable to hold the location options, which are stored as a JavaScript object. The options can be entered in any order, and you don't have to include them all. In this case, I've used all three potential options.</p><p>First, <code class="literal">enableHighAccuracy</code> is a boolean that expects either <code class="literal">true</code> or <code class="literal">false</code> as a value. When set to <code class="literal">true</code>, the browser will provide the most accurate location it can, even if more time is required to do so (for example, a lock on additional GPS satellites). In previous examples where we did not use the options parameter, high accuracy was <span class="emphasis"><em>not</em></span> enabled for efficiency reasons.</p><p>We can also give the browser a time limit for the location lookup using the <code class="literal">timeout</code> option. This option is set in milliseconds. Because there are 1000 milliseconds in 1 second, the example shows a 5-second timeout.</p><p>The final option, <code class="literal">maximumAge</code>, provides the browser with instructions for sending cached locations. Depending on your needs, you may want a very recent location, or you may not care as much. Like the timeout, this value is passed in milliseconds. In this example, I've shown a <code class="literal">maximumAge</code> of 60,000 milliseconds, or 1 minute.</p><p>The options object can be passed as the third argument to either <code class="literal">getCurrentPosition</code> or <code class="literal">watchPosition</code>. If you use the latter requesting continual updates, the options will be followed <span class="emphasis"><em>every</em></span> time the browser returns a location.</p></div></div>
<div class="sect1" title="#49: Use Fire Eagle to Get Location"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_49_colon_use_fire_eagle_to"/>#49: Use Fire Eagle to Get Location</h1></div></div></div><p>You can retrieve your user's location in several ways, some of them with very precise output. Many services that ask and store a user's current whereabouts are also available. Fire Eagle, a product from Yahoo!, is a broker for those services. When you write a Fire Eagle application, you can set or receive the user's current location, which then makes it available to all other Fire Eagle applications, as long as the user gives permission.</p><p>In this project, I'll show how you can gain access to your user's location using Fire Eagle. And once a user has approved your application for access, you'll be able to get the user's latest location at any time, even when he or she isn't online.</p><p>Of course, some application has to set the location for it to be accurate. Remember all those sites I mentioned that help users share their location? We'll let them worry about setting the location in Fire Eagle, so let's dive into using Fire Eagle to retrieve a location. The application we write will use PHP, which I cover in more depth in <a class="xref" href="ch09.html" title="Chapter 9. GO SERVER-SIDE">Chapter 9</a>.</p><div class="note" title="Note"><h3 class="title">Note</h3><p>There are many other services for sharing location. By the time you read this, there are probably more. See a list and links to tutorials at <a class="ulink" href="http://mapscripting.com/location-apis">http://mapscripting.com/location-apis</a>.<a id="IDX-CHP-7-0041" class="indexterm"/><a id="IDX-CHP-7-0042" class="indexterm"/><a id="IDX-CHP-7-0043" class="indexterm"/><a id="IDX-CHP-7-0044" class="indexterm"/><a id="IDX-CHP-7-0045" class="indexterm"/><a id="IDX-CHP-7-0046" class="indexterm"/><a id="IDX-CHP-7-0047" class="indexterm"/><a id="IDX-CHP-7-0048" class="indexterm"/><a id="IDX-CHP-7-0049" class="indexterm"/><a id="IDX-CHP-7-0050" class="indexterm"/><a id="IDX-CHP-7-0051" class="indexterm"/><a id="IDX-CHP-7-0052" class="indexterm"/></p></div><div class="sect2" title="Get the Fire Eagle Essentials"><div class="titlepage"><div><div><h2 class="title"><a id="get_the_fire_eagle_essentials"/>Get the Fire Eagle Essentials</h2></div></div></div><p>Yahoo! has some tools that make writing Fire Eagle applications much easier. Before you can use them, you'll want to register your application with Fire Eagle, so you get the codes that will make your program work. One is an API key, much like other services use; the other is a "secret code." If it helps, you can think of it as joining a secret club. Really, you're just filling out a form.</p><p>You'll need a Yahoo! account. Once you have that, head over to this page to register your app: <a class="ulink" href="https://fireeagle.yahoo.net/developer/create">https://fireeagle.yahoo.net/developer/create</a>.</p><p>Don't worry about being perfect. You can edit this application later. Plus, Fire Eagle lets you register multiple applications, so let this one be a dress rehearsal for the one you'll write later.</p><p>Fire Eagle has two important settings to pay attention to as you create your application. First, you're going to use <span class="strong"><strong>Auth for Web-based Services</strong></span> for authentication. Next, you'll need to set a callback URL. The URL can be named anything you want, but for this simple example, let's use <strong class="userinput"><code>callback.php</code></strong>. Fire Eagle wants to know a full URL, so you'll insert something like <a class="ulink" href="http://yoursite.com/fireeagle/callback.php">http://yoursite.com/fireeagle/callback.php</a>. For testing purposes, you can even use your local machine instead of your server.<a id="IDX-CHP-7-0053" class="indexterm"/></p><p>Once you register your application, Fire Eagle will show you some special keys, the API, and the secret code I mentioned earlier. You can get back to them any time by visiting this page: <a class="ulink" href="http://fireeagle.yahoo.net/developer/manage">http://fireeagle.yahoo.net/developer/manage</a>.</p><p>One last thing before you can leave the site for a little while: You need the API kit. Fire Eagle has prepackaged code for various web programming languages that makes coding applications much easier. Download the PHP kit from this page: <a class="ulink" href="http://fireeagle.yahoo.net/developer/code/php">http://fireeagle.yahoo.net/developer/code/php</a>.</p><p>You absolutely need two files from this package: <span class="emphasis"><em>fireeagle.php</em></span> and <span class="emphasis"><em>OAuth.php</em></span>. Store these inside a directory called <span class="emphasis"><em>lib</em></span> (which stands for library) because we'll be accessing them soon.<a id="IDX-CHP-7-0054" class="indexterm"/></p></div><div class="sect2" title="Authenticate the User"><div class="titlepage"><div><div><h2 class="title"><a id="authenticate_the_user"/>Authenticate the User</h2></div></div></div><p>As the name of one of these files suggests, Fire Eagle uses OAuth to authenticate users. If you haven't used OAuth before, it might seem a little strange, but I've come to appreciate its simplicity and security.</p><p>The process to authenticate a user begins by requesting a <span class="emphasis"><em>token</em></span> from Fire Eagle. This token actually comes in two pieces: <span class="emphasis"><em>public</em></span> and <span class="emphasis"><em>private</em></span>. We redirect the user to Fire Eagle, along with the public token. Then, when the user approves us for access, we can use the public and private tokens together to prove to Fire Eagle that we're the approved application.</p><p>Let's see how it looks in code. Create a new file called <span class="emphasis"><em>authorize.php</em></span> and add the following lines:<a id="IDX-CHP-7-0055" class="indexterm"/><a id="IDX-CHP-7-0056" class="indexterm"/></p><a id="I_programlisting7_d1e8293"/><pre class="programlisting">&lt;?
  require_once "lib/fireeagle.php";

  $key = "<em class="replaceable"><code>YOURKEY</code></em>";
  $secret = "<em class="replaceable"><code>YOURSECRETCODE</code></em>";

❶ $fe = new FireEagle($key, $secret);
❷ $response = $fe-&gt;getRequestToken();

  session_start();
  $oauth_token = $response["oauth_token"];
  $_SESSION['oauth_token'] = $oauth_token;
  $_SESSION['oauth_secret'] = $response["oauth_token_secret"];
❸ $_SESSION["signed_in"] = 0;


❹ header("Location: " . $fe-&gt;getAuthorizeURL($oauth_token));
  ?&gt;</pre><p>To start, we use the key and secret code to create a new Fire Eagle object ❶. The key and secret code are different from the tokens I described. The key and secret code identify your application itself and will never change. The tokens are different for each user.</p><p>Using the Fire Eagle object we created, now we request the public and private tokens ❷. We store these as session variables, which is how PHP maintains data for a user from one page to the next. Then we create another session variable that tells us the user has not signed in yet ❸.</p><p>Finally, using the public token, we redirect the user to a Fire Eagle URL ❹. This page is where the user will approve our application.</p></div><div class="sect2" title="Answer the Call"><div class="titlepage"><div><div><h2 class="title"><a id="answer_the_call"/>Answer the Call</h2></div></div></div><p>Once the user agrees to give us access, Fire Eagle will redirect back to our callback URL. Remember that from the settings? When the user comes to this page, chances are pretty good he or she has authorized our application.</p><p>The callback page is where the user will officially log in. How you set this up will vary depending on what type of application you are creating. For example, if users have accounts stored in a database, you might maintain their Fire Eagle tokens there. Here we will simply update the session variables.<a id="IDX-CHP-7-0057" class="indexterm"/></p><p>Add the following code to your <span class="emphasis"><em>callback.php</em></span> file:</p><a id="I_programlisting7_d1e8322"/><pre class="programlisting">&lt;?
  require_once "lib/fireeagle.php";

  $key = "<em class="replaceable"><code>YOURKEY</code></em>";
  $secret = "<em class="replaceable"><code>YOURSECRETCODE</code></em>";

  session_start();
❶ $fe = new FireEagle($key, $secret,
                      $_SESSION["oauth_token"], $_SESSION["oauth_secret"]);
❷ $response = $fe-&gt;getAccessToken();

  $oauth_token = $response["oauth_token"];
  $_SESSION["oauth_token"] = $oauth_token;
  $_SESSION["oauth_secret"] = $response["oauth_token_secret"];
❸ $_SESSION["signed_in"] = 1;

❹ header("Location: getloc.php");
  ?&gt;</pre><p>We create a Fire Eagle object ❶ again using the PHP kit that Yahoo! provided. This time we include the user's public and private tokens, in addition to our application's key and secret. Remember, this information proves we're the same application the user just approved.<a id="IDX-CHP-7-0058" class="indexterm"/></p><p>If all these keys and tokens are confusing, get ready. One more pair is coming. Once a user approves an application, the public and private tokens aren't needed. Instead, they're replaced by <span class="emphasis"><em>access tokens</em></span> ❷. We overwrite our previous session variables with new ones. And because the user has now successfully signed in, we can set that session variable appropriately ❸.<a id="IDX-CHP-7-0059" class="indexterm"/></p><p>This process may seem like a long one to follow to access a user's location, but keep in mind it only needs to happen once. And the steps are all required in the name of security, which users appreciate. Plus, this callback page will appear instantly to the user.</p><p>The final line redirects the user to the page we'll use to retrieve his or her location ❹. That's what this whole thing is really about, after all. So let's get down to it.</p></div><div class="sect2" title="Get the User's Location"><div class="titlepage"><div><div><h2 class="title"><a id="get_the_user_apostrophy_s_location"/>Get the User's Location</h2></div></div></div><p>The user has given us access to his or her location. We can even check the session variable that we set to make sure. Now we're going to retrieve the user's location.</p><p>Add the following code to the <span class="emphasis"><em>getloc.php</em></span> file:</p><a id="I_programlisting7_d1e8357"/><pre class="programlisting">&lt;?
  require_once "lib/fireeagle.php";

  $key = "<em class="replaceable"><code>YOURKEY</code></em>";
  $secret = "<em class="replaceable"><code>YOURSECRETCODE</code></em>";

  session_start();
❶ if ($_SESSION["signed_in"] == 1) {
    $fe = new FireEagle($key, $secret,
                        $_SESSION["oauth_token"], $_SESSION["oauth_secret"]);

❷   $loc = $fe-&gt;user();
❸   $toploc = $loc-&gt;user-&gt;best_guess;
❹   $lat = $toploc-&gt;latitude;
    $lon = $toploc-&gt;longitude;
    $datetime = date("M j, g:i A", strtotime(❺$toploc-&gt;located_at));
  }
  ?&gt;
  &lt;p&gt;
❻ Your current location: &lt;strong&gt;&lt;?=$lat?&gt;, &lt;?=$lon?&gt;&lt;/strong&gt;
  (as of &lt;?=$datetime?&gt;)
  &lt;/p&gt;</pre><p>The code starts much like other pages have, by including the PHP API kit and declaring our application's key and secret code. Then we check our session variable to make sure the user really has given us permission ❶. If the signed-in variable is still 0, we could redirect to the authentication page, or show an error.<a id="IDX-CHP-7-0060" class="indexterm"/><a id="IDX-CHP-7-0061" class="indexterm"/></p><p>As in the previous section, we create a Fire Eagle object using the application keys and the access tokens. Because we're pretty sure we can access the user's location at this point, we then ask Fire Eagle for the location object ❷. From there, we can retrieve its best guess for the user's location ❸, the most granular level of data the user is willing to share.</p><p>Now we have access to several pieces of data, including the latitude ❹ and longitude. We can also get an idea of how long ago the user shared that location ❺. To improve legibility, I used the PHP <code class="literal">date</code> function to format the time stamp.</p><p>Finally, in the HTML, we output the data ❻ we retrieved from Fire Eagle. Of course, this is just an example, not a great Fire Eagle application. The great one is the one you'll write. Right?</p></div></div>
<div class="sect1" title="#50: Get Location by IP"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_50_colon_get_location_by"/>#50: Get Location by IP</h1></div></div></div><p>All users on the Internet can be identified with a number that stays the same for at least a single online session and can be static—never changing. This number, called an <span class="emphasis"><em>IP address</em></span>, is owned by the Internet provider, who usually has an entire block (or more) of similar numbers. With a database of these numbers tied to locations, you can usually determine at least the city your user is located in, if not the postal code.</p><p>I'll demonstrate other projects in this chapter that get at more granular data, determining a user's precise location. But knowing a geographic area is generally enough to do some interesting things. Plus, you can geolocate most of your users by using IPs, and you don't have to ask their permission.</p><p>What is an IP address? An IP address is a series of four numbers, each from one to three digits. For example, it might be <span class="emphasis"><em>208.54.34.3</em></span>. Each computer connected to the Internet has its own IP address, though sometimes an address is shared across a local area network.</p><p>For this project, we'll look at two services that provide geographic coordinates based on the user's IP address. One must be used on the server, whereas the other runs in the browser using JavaScript. Which you choose depends on how you want to use the data. For example, if you store the result to a database, you will likely want the server-side version. But if you just want to center your map on the user's location, the JavaScript version will do just fine.<a id="IDX-CHP-7-0062" class="indexterm"/></p><div class="sect2" title="Use the HostIP Web Service"><div class="titlepage"><div><div><h2 class="title"><a id="use_the_hostip_web_service"/>Use the HostIP Web Service</h2></div></div></div><p>For this example, I'll use the hostip.info API. A number of web services provide IP-based geolocation, including a commercial service called MaxMind. I picked HostIP, however, because it is easy to use, and the database is maintained by a community of developers and users.<a id="IDX-CHP-7-0063" class="indexterm"/></p><p>We'll be using PHP to call the API, including some concepts described in <a class="xref" href="ch08.html" title="Chapter 8. DATA FORMATS">Chapter 8</a> and <a class="xref" href="ch09.html" title="Chapter 9. GO SERVER-SIDE">Chapter 9</a>. I'll do my best to make understanding them easy, but you may want to flip ahead if something looks strange.</p><p>Before we can start our PHP code, we need to get a feel for how we are going to get the data back from HostIP. Luckily, the site makes trying out the API within your browser easy. Try loading this URL into your address bar: <a class="ulink" href="http://api.hostip.info/?ip=12.215.42.19">http://api.hostip.info/?ip=12.215.42.19</a>.</p><p>Your results should look something like this:</p><a id="I_programlisting7_d1e8426"/><pre class="programlisting">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;HostipLookupResultSet ... &gt;
  &lt;gml:description&gt;This is the Hostip Lookup Service&lt;/gml:description&gt;
  ...
  &lt;gml:featureMember&gt;
    &lt;Hostip&gt;
      &lt;gml:name&gt;Sugar Grove, IL&lt;/gml:name&gt;
      &lt;countryName&gt;UNITED STATES&lt;/countryName&gt;
      &lt;countryAbbrev&gt;US&lt;/countryAbbrev&gt;
      &lt;ipLocation&gt;
        &lt;gml:PointProperty&gt;
          &lt;gml:Point srsName="http://www.opengis.net/gml/srs/epsg.xml#4326"&gt;
            &lt;gml:coordinates&gt;<strong class="userinput"><code>−88.4588,41.7696</code></strong>&lt;/gml:coordinates&gt;
          &lt;/gml:Point&gt;
        &lt;/gml:PointProperty&gt;
      &lt;/ipLocation&gt;
    &lt;/Hostip&gt;
  &lt;/gml:featureMember&gt;
&lt;/HostipLookupResultSet&gt;</pre><p>Right in the middle of it all, shown in bold, are the latitude and longitude coordinates we want (note that here longitude comes first). Getting at those numbers means parsing the result and extracting the numbers. This process is shown in detail in <a class="xref" href="ch08.html#number_symble_52_colon_use_xml" title="#52: Use XML">#52: Use XML</a> in <a class="xref" href="ch08.html#number_symble_52_colon_use_xml" title="#52: Use XML">#52: Use XML</a>. Let's put the latitude and longitude into two variables using PHP. Create a new file and add the following lines of code:</p><a id="I_programlisting7_d1e8437"/><pre class="programlisting">&lt;?
❶ $ipaddr = $_SERVER["REMOTE_ADDR"];
❷ $xmltxt = get_url("http://api.hostip.info/?ip=$ipaddr");
❸ $xmlobj = simplexml_load_string($xmltxt);
❹ $coords = $xmlobj-&gt;xpath("//coordinates");
❺ list($lon, $lat) = preg_split("/\,/", $coords[0]);

  // cUrl functions
❻ function get_url($url) {
   ...
  }
  ?&gt;</pre><p>Before we can make a call to HostIP, we need to determine the user's IP. Luckily, the IP is made available to PHP via a server variable, which we place into a local variable ❶.<a id="IDX-CHP-7-0064" class="indexterm"/><a id="IDX-CHP-7-0065" class="indexterm"/><a id="IDX-CHP-7-0066" class="indexterm"/><a id="IDX-CHP-7-0067" class="indexterm"/><a id="IDX-CHP-7-0068" class="indexterm"/><a id="IDX-CHP-7-0069" class="indexterm"/><a id="IDX-CHP-7-0070" class="indexterm"/><a id="IDX-CHP-7-0071" class="indexterm"/><a id="IDX-CHP-7-0072" class="indexterm"/><a id="IDX-CHP-7-0073" class="indexterm"/><a id="IDX-CHP-7-0074" class="indexterm"/></p><p>The rest of the code is relatively spartan, despite all that it does, mainly because it counts on other functions to do the heavy lifting. For example, we load the XML text in a one-line call ❷, passing the HostIP URL, which includes the user's IP address. To turn the text into an object we can use, we call the <code class="literal">SimpleXML</code> parsing function ❸ that converts the XML. Now that we have an easy-to-access object, we use the <code class="literal">xpath</code> function to return all <code class="literal">&lt;coordinates&gt;</code> tags ❹. We only have one, so we then pass it off to a string-splitting function to insert it into our two variables ❺.</p><p>Most of these functions rely on internal PHP, but one of them ❻ I wrote myself. You can see this entire function in <a class="xref" href="ch09s03.html" title="#61: Retrieve a Web Page">#61: Retrieve a Web Page</a> in <a class="xref" href="ch09s03.html" title="#61: Retrieve a Web Page">#61: Retrieve a Web Page</a>.</p></div><div class="sect2" title="Use Google's ClientLocation JavaScript Object"><div class="titlepage"><div><div><h2 class="title"><a id="use_google_apostrophy_s_clientlocation"/>Use Google's ClientLocation JavaScript Object</h2></div></div></div><p>If you don't need the user's location on the server, you can easily get it if you use Google's Ajax Loader. This is an alternate way to load Google's JavaScript APIs, including Maps and Search. The <code class="literal">ClientLocation</code> object is available even without loading a specific API, which makes for minimal overhead considering the data it provides.</p><p>As with the standard Google Maps API, you need to include the call to Google's JavaScript within the header of your HTML file:</p><a id="I_programlisting7_d1e8514"/><pre class="programlisting">&lt;script type="text/javascript" src="http://www.google.com/jsapi?key=
<em class="replaceable"><code>yourkey</code></em>"&gt;&lt;/script&gt;</pre><p>Then, anywhere within your JavaScript code, you can access <code class="literal">google.loader.ClientLocation.latitude</code> and <code class="literal">google.loader.ClientLocation.longitude</code> (in addition to a few other data items, such as the city name).</p><div class="note" title="Note"><h3 class="title">Note</h3><p>At press time the Ajax Loader only supports Google Maps version 2. To use this example, you will need a Google Maps API key. You can find that, as well as updated information about the Ajax Loader at <a class="ulink" href="http://code.google.com/apis/ajax/documentation/">http://code.google.com/apis/ajax/documentation/</a>.</p></div><p>Seeing it on a map is always easier, so let's create a new Mapstraction map using Google as the mapping provider. Instead of the standard Google Maps, we'll use the Ajax loader. Add the following code to a new HTML file:<a id="IDX-CHP-7-0075" class="indexterm"/><a id="IDX-CHP-7-0076" class="indexterm"/><a id="IDX-CHP-7-0077" class="indexterm"/></p><a id="I_programlisting7_d1e8547"/><pre class="programlisting">&lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;ClientLocation Map&lt;/title&gt;
      &lt;script type="text/javascript"
              src="http://www.google.com/jsapi?key=<em class="replaceable"><code>yourkeyhere</code></em>"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="mxn.js?(google)"&gt;
      &lt;style&gt;
        div#mymap {
          width: 400px;
          height: 350px;
        }
      &lt;/style&gt;
      &lt;script type="text/javascript"&gt;
❶       google.load("maps", "2");
        function create_map() {
❷         var pos = google.loader.ClientLocation;
❸         var pt = new mxn.LatLonPoint(pos.latitude, pos.longitude);
          mapstraction = new mxn.Mapstraction('mymap', 'google');
          mapstraction.setCenterAndZoom(pt, 10);
          var marker = new mxn.Marker(pt);
          marker.setInfoBubble('You Are Here');
          mapstraction.addMarker(marker);
          marker.openBubble();
        }
      &lt;/script&gt;
    &lt;/head&gt;
    &lt;body onLoad="create_map()"&gt;
      &lt;div id="mymap"&gt;&lt;/div&gt;
    &lt;/body&gt;
  &lt;/html&gt;</pre><p>The JavaScript's very first line tells the Google Ajax Loader to load in the Maps API ❶. Then, once it—and the rest of the page—has loaded, the <code class="literal">create_map</code> function gets called.</p><p>To access the location, we copy the <code class="literal">ClientLocation</code> object into a local variable ❷, making accessing it easier. Then we create a point ❸ using the latitude and longitude from the new object. From there, the code is much like previous JavaScript examples, where we use this point as the center of the map and create a marker.</p></div></div>
<div class="sect1" title="#51: Roll Your Own IP Database"><div class="titlepage"><div><div><h1 class="title"><a id="number_symble_51_colon_roll_your_own_ip"/>#51: Roll Your Own IP Database</h1></div></div></div><p>Are you the type who would refuse help if you took a spill in a public place? Then you're probably also the type who wants to host your <span class="emphasis"><em>own</em></span> IP database, rather than depend on someone else's service. Of course, you might simply be someone who cares about performance or doesn't want to worry about network latency. Whatever the case, this project will help you geolocate users by IP using your own server.<a id="IDX-CHP-7-0078" class="indexterm"/><a id="IDX-CHP-7-0079" class="indexterm"/><a id="IDX-CHP-7-0080" class="indexterm"/><a id="IDX-CHP-7-0081" class="indexterm"/><a id="IDX-CHP-7-0082" class="indexterm"/><a id="IDX-CHP-7-0083" class="indexterm"/><a id="IDX-CHP-7-0084" class="indexterm"/><a id="IDX-CHP-7-0085" class="indexterm"/></p><p>Where does the data come from? We'll use a free service called IPInfoDB, which updates a streamlined MySQL database dump every month. Download the latest database at <a class="ulink" href="http://ipinfodb.com/ip_database.php">http://ipinfodb.com/ip_database.php</a>.<a id="IDX-CHP-7-0086" class="indexterm"/></p><p>You have a number of choices for database types. For this example, we'll use the small, city-level database with a single table. The table should contain about 1.4 million records, which will result in a database file a little over 100MB. (The file will be much smaller when you download the compressed version.)</p><div class="sect2" title="Import IP Data"><div class="titlepage"><div><div><h2 class="title"><a id="import_ip_data"/>Import IP Data</h2></div></div></div><p>Now that you have downloaded the SQL file, you need to import it. The file will be far too big to use phpMyAdmin, so you will need to use the command interpreter, which you can usually get to via the <code class="literal">mysql</code> command on a server.</p><p>You may be able to ask your system administrator to help you get to your MySQL database's command interpreter. Or, if you are using MAMP, you can run <code class="literal">Library/bin/mysql -u root -p</code> within the MAMP directory (the password is also <code class="literal">root</code>). On WAMP, the location may vary, but it can commonly be found at <code class="literal">C:\wamp\bin\mysql\mysql</code><span class="emphasis"><em>version</em></span><code class="literal">\bin\mysql</code>. In either case, you will need to access the interpreter via the command line: Terminal (on Mac) or CMD (on Windows).<a id="IDX-CHP-7-0087" class="indexterm"/></p><p>Open the command interpreter and select your database, or create a new one (see <a class="xref" href="ch09s05.html" title="#63: Store Locations to a Database">#63: Store Locations to a Database</a> in <a class="xref" href="ch09s04.html#install_mysql_yourself" title="Install MySQL Yourself">Install MySQL Yourself</a>). To begin the process of importing your data, type the following command:</p><a id="I_programlisting7_d1e8639"/><pre class="programlisting">\. /path/to/ipdata.sql</pre><p>Make sure you include the full path to the SQL file you downloaded. As it imports, you'll see messages like this:</p><a id="I_programlisting7_d1e8643"/><pre class="programlisting">Query OK, 0 rows affected (0.00 sec)
Query OK, 0 rows affected (0.00 sec)
Query OK, 11068 rows affected (0.35 sec)
Records: 11068 Duplicates: 0 Warnings: 0</pre><p>When the messages end, you can leave the command interpreter and return to phpMyAdmin, if you wish. Now that we've added the data, let's access it.</p></div><div class="sect2" title="Find an IP's Location"><div class="titlepage"><div><div><h2 class="title"><a id="find_an_ip_apostrophy_s_location"/>Find an IP's Location</h2></div></div></div><p>What information is available with the IP database, and how is it stored? From phpMyAdmin, click through to your database and then to the <code class="literal">ip_group_city</code> table that you've just imported. Click the Browse tab and you'll see the first 30 records in the database.<a id="IDX-CHP-7-0088" class="indexterm"/><a id="IDX-CHP-7-0089" class="indexterm"/></p><p>Among the interesting fields available are city, latitude, and longitude. You'll also see the IP address itself, stored as a very large number, which is different than the period-separated version you're used to seeing. The difference is because you need to do a little preprocessing, which makes the lookup process much more efficient.<a id="IDX-CHP-7-0090" class="indexterm"/></p><p>Where the IP is <code class="literal">A.B.C.D</code>, the number can be expressed as <code class="literal">((A*256+B)*256+C)*256</code>. So <span class="emphasis"><em>71.59.208.255</em></span> would become <span class="emphasis"><em>1195102208</em></span>. As would anything in the <span class="emphasis"><em>71.59.208.X</em></span> block. Notice the formula does not have a D; that's because IPs come in blocks, so everything in the range will likely have the same location.</p><p>This process of converting an IP to a number is fairly standardized. In fact, MySQL has a helper function, <code class="literal">INET_ATON</code>, which makes it super easy. Click the SQL tab in phpMyAdmin, or use the command interpreter, and add the following query:</p><a id="I_programlisting7_d1e8690"/><pre class="programlisting">SELECT * FROM ip_group_city
WHERE ip_start &lt;= INET_ATON('<em class="replaceable"><code>71.59.208.255</code></em>')
ORDER BY ip_start DESC LIMIT 1</pre><p>Remember to replace the IP address I used with one of your own. Here, I've requested all the fields for the closest IP address in the database. In order to keep from getting all 1.4 million records back in order, I limit the results to one row—the one I want.</p><p>Now we'll connect it to a PHP script, something covered in <a class="xref" href="ch09s07.html" title="#65: Use MySQL from PHP">#65: Use MySQL from PHP</a> in <a class="xref" href="ch09s07.html" title="#65: Use MySQL from PHP">#65: Use MySQL from PHP</a>.</p></div></div></body></html>