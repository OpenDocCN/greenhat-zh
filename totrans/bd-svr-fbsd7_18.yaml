- en: Chapter 5\. COURIER - IMAP SERVER 4.3.0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[HTTP://WWW.COURIER-MTA.ORG/IMAP](HTTP://WWW.COURIER-MTA.ORG/IMAP)'
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 5.1\. SUMMARY
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Courier-IMAP is an open source IMAP (Internet Message Access Protocol) server
    that functions in conjunction with an MTA (Mail Transfer Agent) such as Postfix.
    Courier-IMAP provides access to Maildir mailboxes, a system for email storage
    first introduced in Qmail.
  prefs: []
  type: TYPE_NORMAL
- en: Courier-IMAP also includes a POP3 (Post Office Protocol version 3) server that
    provides POP3 protocol access to Maildir mailboxes. POP3 is currently the most
    popular email retrieval protocol; virtually all email providers support it. A
    POP3 mail transaction consists of a client-initiated connection to the server,
    the downloading of messages, deletion of those messages from the server, and connection
    termination. This method of email retrieval is well suited to users who access
    their email from the same computer on a consistent basis, but it can be cumbersome
    for users who need email access from a variety of different computers (e.g., work,
    home, Internet caf√©, etc.).
  prefs: []
  type: TYPE_NORMAL
- en: IMAP was written by Mark Crispin in 1986 to provide an alternative to POP. Some
    advantages IMAP provides over POP are on-demand message downloading (only selected
    messages are downloaded to the client instead of the whole mailbox), support for
    multiple mailboxes (IMAP users can create and move messages between folders on
    the server), and portable mailbox access (IMAP users may move between different
    computers and have full access to their mail; POP users are restricted to the
    machine where their email was downloaded).
  prefs: []
  type: TYPE_NORMAL
- en: Sam Varshavchik wrote Courier-IMAP in 1999\. He did so to provide IMAP support
    to MTAs employing the Maildir format; none existed at the time.
  prefs: []
  type: TYPE_NORMAL
- en: 5.2\. RESOURCES
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Official Courier-IMAP Documentation
  prefs: []
  type: TYPE_NORMAL
- en: '[http://www.courier-mta.org/imap/documentation.html](http://www.courier-mta.org/imap/documentation.html)'
  prefs: []
  type: TYPE_NORMAL
- en: RFC 3501 - Internet Message Access Protocol (IMAP)
  prefs: []
  type: TYPE_NORMAL
- en: '[http://tools.ietf.org/html/rfc3501](http://tools.ietf.org/html/rfc3501)'
  prefs: []
  type: TYPE_NORMAL
- en: RFC 1939 - Post Office Protocol - Version 3 (POP3)
  prefs: []
  type: TYPE_NORMAL
- en: '[http://tools.ietf.org/html/rfc1939](http://tools.ietf.org/html/rfc1939)'
  prefs: []
  type: TYPE_NORMAL
- en: 5.3\. REQUIRED
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '![](bTM3ZzJkLzhzNHRnOS9lL3BjMWk1OTU3MWk5ZmFycHMwZzMvMC5uVQ--.jpg) FreeBSD 7.0-RELEASE
    (see "[FreeBSD 7.0](freebsd_7.0_split_000.html#freebsd_7.0)")'
  prefs: []
  type: TYPE_IMG
- en: '![](bTM3ZzJkLzhzNHRnOS9lL3BjMWk1OTU3MWk5ZmFycHMwZzMvMC5uVQ--.jpg) Updated ports
    collection (see "[FreeBSD Ports Collection](freebsd_ports_collection.html#freebsd_ports_collection)")'
  prefs: []
  type: TYPE_IMG
- en: '![](bTM3ZzJkLzhzNHRnOS9lL3BjMWk1OTU3MWk5ZmFycHMwZzMvMC5uVQ--.jpg) MTA configured
    to deliver to Maildir (see "[Postfix SMTP Server 2.5.1](postfix_smtp_server_2.5.1.html#postfix_smtp_server_2.5.1)")'
  prefs: []
  type: TYPE_IMG
- en: '![](bTM3ZzJkLzhzNHRnOS9lL3BjMWk1OTU3MWk5ZmFycHMwZzMvMC5uVQ--.jpg) Courier-authlib
    (see "Courier-authlib 0.60.2" on page 39)'
  prefs: []
  type: TYPE_IMG
- en: '![](bTM3ZzJkLzhzNHRnOS9lL3BjMWk1OTU3MWk5ZmFycHMwZzMvMC5uVQ--.jpg) Internet
    connection'
  prefs: []
  type: TYPE_NORMAL
- en: 5.4\. OPTIONAL
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '![](bTM3ZzJkLzhzNHRnOS9lL3BjMWk1OTU3MWk5ZmFycHMwZzMvMC5uVQ--.jpg) OpenSSL with
    a signed SSL Certificate (see "[OpenSSL 0.9.8g](openssl_0.9.8g.html#openssl_0.9.8g)");
    if you need secure communication between the email client and the server, OpenSSL
    should be installed before starting'
  prefs: []
  type: TYPE_NORMAL
- en: 5.5\. PREPARATION
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Become the superuser.
  prefs: []
  type: TYPE_NORMAL
- en: 5.6\. INSTALL
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'To begin the installation of Courier-IMAP, enter the following commands:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: A menu with a list of options for Courier-IMAP will appear. Leave the options
    at their defaults; press [tab] to select OK and then press [enter] to start the
    installation.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: '***Note:*** Courier-IMAP includes both an IMAP and a POP3 server. This guide
    will configure both services; if you do not wish to enable a particular server,
    simply skip to the appropriate part of the "[Testing](testing.html#testing)" section
    (beginning).'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: 5.7\. CONFIGURE
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Once the installation process is complete, it's time to configure Courier-IMAP
    for use on your system.
  prefs: []
  type: TYPE_NORMAL
- en: To enable secure communications between Courier-IMAP and email clients, you
    need to configure SSL Certificates. If you do not wish to enable secure communications,
    skip to "See [Testing](testing.html#testing)". Courier-IMAP needs the private
    server key and the server's SSL Certificate combined into a single file. We will
    assume your private key and server certificates reside in the /usr/local/openssl/certs
    directory.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The following commands will merge your private key with your server certificate
    into a single file that Courier-IMAP can use:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '[host.example.com](http://host.example.com)`-unencrypted-key.pem` is your server''s
    unencrypted private key file.'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[host.example.com](http://host.example.com)`-key-cert.pem` is the combined
    key and certificate file.'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[host.example.com](http://host.example.com)`-cert.pem` is the server''s public
    certificate file.'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Change these example filenames to match the naming conventions you used when
    you created your server key and certificate files with OpenSSL.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'You will need to tell Courier-IMAP where the combined key-certificate file
    (the one created in step 1) resides by editing the imap-ssl and pop3d-ssl files
    located in /usr/local/etc/courier-imap. Open and modify the imap-ssl file as follows
    (~257):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Save and exit.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Open and modify the pop3d-ssl file as follows (~244):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Save and exit.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Substitute the appropriate filename for [host.example.com](http://host.example.com)`-key-cert.pem`
    if you used a different naming convention. If the path to this file is different
    than above, be sure to change that as well. Your certificate file must be in the
    format key followed by certificate (as demonstrated in step 1), with no extraneous
    text.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 5.8\. TESTING
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In this section we'll perform some basic tests to confirm that Courier-IMAP
    is answering requests properly.
  prefs: []
  type: TYPE_NORMAL
- en: 5.8.1\. IMAP
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: You will need the username and password of an account on your system to test
    IMAP functionality. Ensure the user account you select has an existing Maildir
    directory. This directory is automatically created by Postfix when it delivers
    mail to users. If a user has not yet received email, the Maildir directory will
    be absent. Use the `maildirmake` command to manually create a Maildir directory
    in this case. See "[maildirmake](utilities-id2.html#maildirmake)" for details.
  prefs: []
  type: TYPE_NORMAL
- en: 'Check that Courier-IMAP starts and handles requests properly. To enable the
    IMAP service, modify rc.conf. Open the rc.conf file located in /etc:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'and add one or both of the following lines:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '* * *'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '***Note:*** If you did not configure Courier-IMAP to use SSL for secure communications,
    omit the second line.'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '* * *'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'To start the IMAP service, enter:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Enter the following command to connect to the IMAP server on port 143:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Code View:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '* * *'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '***Note:*** This output, the IMAP server connection banner, will appear on
    a single line.'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '* * *'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Log in using a valid username and password for your system.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The next command is typically sent by mail clients prior to retrieving messages
    from the mailbox; you'll want to see a response similar to that shown below.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '[PRE10]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: If your session looked similar to the one above, then Courier-IMAP is functional.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Testing Courier-IMAP with SSL is similar, but uses the OpenSSL command-line
    tool. (If you did not choose to configure secure communications with SSL, you
    may proceed to the "POP3" section below.) The following command begins an IMAP
    session with SSL:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Once the connection is established, you may issue the same commands as above
    to test IMAP-SSL functionality, starting with the command `aa login` `*username
    password*`.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 5.8.2\. POP3
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: You will need the username and password of an account on your system to test
    POP3 functionality. Ensure the user account you select has an existing Maildir
    directory. This directory is automatically created by Postfix when it delivers
    mail to users. If a user has not yet received email, the Maildir directory will
    be absent. Use the `maildirmake` command to manually create a Maildir in this
    case. See "[maildirmake](utilities-id2.html#maildirmake)" for details.
  prefs: []
  type: TYPE_NORMAL
- en: 'Check that Courier-IMAP starts and handles requests properly. To enable the
    POP3 service, open the rc.conf file located in /etc:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'and add one or both of the following lines:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: '* * *'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '***Note:*** If you did not configure Courier-IMAP to use SSL for secure communication,
    omit the second line.'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '* * *'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'To start the POP3 service, enter:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Enter the following command to connect to the POP3 server on port 110:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Log in using a valid username and password for your system.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The `stat` command triggers the POP3 server to return what is known as a drop
    listing. The seven (in the drop listing below) signifies the number of messages
    in the mailbox, followed by the number of bytes these messages consume on disk
    (in octets). Your output will certainly be different depending on the contents
    of your mailbox.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: At this point, we can assume the POP3 server is functioning correctly.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'You can test the POP3 daemon with SSL the same way, using the OpenSSL command-line
    utility. The following command begins a POP3 session over SSL:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Once the connection is established, you may issue the same commands as above,
    starting with the command `user` `*username*`, to test POP3 SSL functionality.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 5.9\. UTILITIES
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Following is brief information on the `maildirmake` program, which is used to
    create a user's initial Maildir directory structure or to add subdirectories to
    an existing Maildir.
  prefs: []
  type: TYPE_NORMAL
- en: 5.9.1\. maildirmake
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: This utility is used to create a user's Maildir directory and subdirectories.
  prefs: []
  type: TYPE_NORMAL
- en: Command
  prefs: []
  type: TYPE_NORMAL
- en: '`maildirmake`'
  prefs: []
  type: TYPE_NORMAL
- en: Syntax
  prefs: []
  type: TYPE_NORMAL
- en: '`maildirmake -``*options*` `Maildir`'
  prefs: []
  type: TYPE_NORMAL
- en: Options
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: Create a subdirectory within an existing Maildir
  prefs: []
  type: TYPE_NORMAL
- en: Examples
  prefs: []
  type: TYPE_NORMAL
- en: The following examples assume you are the root user and in the appropriate user's
    home directory.
  prefs: []
  type: TYPE_NORMAL
- en: 'To create a new Maildir, enter:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: In place of `*user*`, substitute the username of the account for which you are
    creating the Maildir.
  prefs: []
  type: TYPE_NORMAL
- en: 'To create a subdirectory named Junk within an existing Maildir, use the command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: In place of `*user*`, substitute the username of the account for which you are
    creating the subdirectory.
  prefs: []
  type: TYPE_NORMAL
- en: 5.10\. CONFIG FILES
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: /usr/local/etc/courier-imap/imapd
  prefs: []
  type: TYPE_NORMAL
- en: The main IMAP configuration file
  prefs: []
  type: TYPE_NORMAL
- en: /usr/local/etc/courier-imap/imapd-ssl
  prefs: []
  type: TYPE_NORMAL
- en: Supplements the main IMAP configuration file with options pertaining to SSL
  prefs: []
  type: TYPE_NORMAL
- en: /usr/local/etc/courier-imap/pop3d
  prefs: []
  type: TYPE_NORMAL
- en: The main POP3 configuration file
  prefs: []
  type: TYPE_NORMAL
- en: /usr/local/etc/courier-imap/pop3d-ssl
  prefs: []
  type: TYPE_NORMAL
- en: Supplements the main POP3 configuration file with options pertaining to SSL
  prefs: []
  type: TYPE_NORMAL
- en: 5.11\. LOG FILES
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: /var/log/maillog
  prefs: []
  type: TYPE_NORMAL
- en: General log of email activity
  prefs: []
  type: TYPE_NORMAL
- en: 5.12\. NOTES
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: If you installed Courier-IMAP without SSL support, be aware that port 143 transmits
    login and password information "in the clear." This means that it can be obtained
    by unauthorized persons. If all of your users will be using email clients with
    SSL support, it may be a good idea to run only the SSL-enabled instance of Courier-IMAP
    by removing the non-SSL startup line from the /etc/rc.conf file.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If your server is behind a NAT router, you can enable port forwarding to only
    port 993\. This would allow only SSL connections from outside the local network.
    Local traffic would still be vulnerable unless you have Standard IMAP disabled
    as mentioned above.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: If you intend to install a webmail client that uses IMAP (such as SquirrelMail;
    see "[SquirrelMail 1.4.13](squirrelmail_1.4.13.html#squirrelmail_1.4.13)") then
    do not disable Standard IMAP functionality on port 143.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'If you choose to remove the non-SSL imapd line from rc.conf, remember to stop
    the non-SSL daemon like this:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Similarly, if you installed POP3 without SSL support, be aware that port 110
    transmits login and password information "in the clear." This means that that
    it can be obtained by unauthorized persons. If all of your users will be using
    email clients with SSL support, it may be a good idea to run only the SSL-enabled
    instance of the POP3 daemon by removing the non-SSL startup line from the /etc/rc.conf
    file.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If your server is behind a NAT router, you can enable port forwarding to only
    port 995\. This would allow only SSL connections from outside the local network.
    Local traffic would still be vulnerable unless you have non-SSL POP3 disabled
    as mentioned above.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'If you choose to remove the non-SSL pop3d line from rc.conf, remember to stop
    the non-SSL daemon like this:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
