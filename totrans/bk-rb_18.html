<html><head></head><body><div class="chapter" title="Chapter&#xA0;18.&#xA0;Debugging and Testing"><div class="titlepage"><div><div><h1 class="title"><a id="debugging_and_testing"/>Chapter 18. Debugging and Testing</h1></div></div></div><div class="informalfigure"><a id="image_no_caption-id21"/><div class="mediaobject"><a id="I_mediaobject18_d1e20532"/><img src="httpatomoreillycomsourcenostarchimages860138.png.jpg" alt="image with no caption"/></div></div><p>The development of any real-world application progresses in steps. Most of us would prefer to take more steps forward than backward. To minimize the backward steps—caused by coding errors or unforeseen side effects—you can take advantage of testing and debugging techniques.<a id="IDX-CHP-18-0001" class="indexterm"/><a id="IDX-CHP-18-0002" class="indexterm"/><a id="IDX-CHP-18-0003" class="indexterm"/><a id="IDX-CHP-18-0004" class="indexterm"/></p><p>This chapter provides a brief overview of some of the most useful debugging tools available to Ruby programmers. Bear in mind, however, that if you are using a dedicated Ruby IDE, you may have more powerful visual debugging tools at your disposal. I will be discussing only the “standard” tools available to Ruby in this chapter.</p><div class="sect1" title="IRB: Interactive Ruby"><div class="titlepage"><div><div><h1 class="title"><a id="irb_colon_interactive_ruby"/>IRB: Interactive Ruby</h1></div></div></div><p>Sometimes you may just want to “try something” with Ruby. It is possible to do this using the standard Ruby interpreter: Enter <code class="literal">ruby</code> at the command prompt, and then enter your code one line at a time. However, this is far from being an ideal interactive environment. For one thing, the code you enter will be executed only when you enter an end-of-file character such as <code class="literal">^Z</code> or <code class="literal">^D</code> (that is, <span class="keycap">ctrl</span>-Z on Windows or <span class="keycap">ctrl</span>-D on some other operating systems). So, to do something as simple as displaying the value of 1 plus 1, you would enter the following sequence commands (remembering to enter whichever end-of-file character is required on your operating system).</p><a id="I_programlisting18_d1e20573"/><pre class="programlisting">ruby
1+1
^Z</pre><p>Only once the end-of-file character (here <code class="literal">^Z</code>) has been entered does Ruby execute the code and display the result:</p><a id="I_programlisting18_d1e20580"/><pre class="programlisting">2</pre><p>For a better way to interact with Ruby, use the Interactive Ruby shell (IRB). To start IRB, go to a command prompt and enter the following:</p><a id="I_programlisting18_d1e20584"/><pre class="programlisting">irb</pre><p>You should now see a prompt similar to the following:</p><a id="I_programlisting18_d1e20588"/><pre class="programlisting">irb(main):001:0&gt;</pre><p>Now you are ready to start entering some Ruby code. You can enter an expression over more than one line; as soon as the expression is complete, IRB will evaluate it and display the result. Try the following (pressing <span class="keycap">enter</span> after the <code class="literal">+</code> on the first line):</p><a id="I_programlisting18_d1e20598"/><pre class="programlisting">x = ( 10 +
( 2 * 4 ) )</pre><p>Finally, press <span class="keycap">enter</span> after the closing parenthesis. Now IRB will evaluate the expression and show the result:</p><a id="I_programlisting18_d1e20606"/><pre class="programlisting">=&gt; 18</pre><p>You can now evaluate <code class="literal">x</code>. Enter this:</p><a id="I_programlisting18_d1e20613"/><pre class="programlisting">x</pre><p>IRB shows this:</p><a id="I_programlisting18_d1e20617"/><pre class="programlisting">=&gt; 18</pre><p>So, up to this point, your entire IRB session should look like this:<a id="IDX-CHP-18-0005" class="indexterm"/><a id="IDX-CHP-18-0006" class="indexterm"/></p><a id="I_programlisting18_d1e20629"/><pre class="programlisting">irb(main):001:0&gt; x = (10 +
irb(main):002:1* (2*4))
=&gt; 18
irb(main):003:0&gt; x
=&gt; 18
irb(main):004:0&gt;</pre><p>Be careful, though. Try entering this:</p><a id="I_programlisting18_d1e20633"/><pre class="programlisting">x = (10
+ (2*4))</pre><p>This time the result is as follows:</p><a id="I_programlisting18_d1e20638"/><pre class="programlisting">=&gt; 8</pre><p>This is, in fact, normal Ruby behavior. It is normal because a line break acts as a terminator, while the <code class="literal">+</code> operator, when it begins the new line, acts as a unary operator (that is, rather than adding together <span class="emphasis"><em>two</em></span> values—one to its left and one to its right—it merely asserts that the <span class="emphasis"><em>single</em></span> expression that follows the <code class="literal">+</code> is positive). You will find a fuller explanation of this in <a class="xref" href="ch18s03.html#digging_deeper-id17" title="Digging Deeper">Digging Deeper</a> in <a class="xref" href="ch18s03.html#digging_deeper-id17" title="Digging Deeper">Digging Deeper</a>.</p><p>For now, just be aware that when entering expressions one line at a time, the position of the line break is important! When using IRB, you can tell whether the interpreter considers that you have ended a statement. If you have done so, a prompt is displayed ending with <code class="literal">&gt;</code> like this:</p><a id="I_programlisting18_d1e20664"/><pre class="programlisting">irb(main):013:1&gt;</pre><p>If a statement is complete and returns a result, a <code class="literal">=&gt;</code> prompt is displayed followed by the result. For example:</p><a id="I_programlisting18_d1e20671"/><pre class="programlisting">=&gt; 18</pre><p>If the statement is incomplete, the prompt ends with an asterisk:</p><a id="I_programlisting18_d1e20675"/><pre class="programlisting">irb(main):013:1*</pre><p>To end an IRB session, enter the word <code class="literal">quit</code> or <code class="literal">exit</code> at the prompt. You can, if you want, load a Ruby program into IRB by passing to it the program name when you run IRB like this:</p><a id="I_programlisting18_d1e20685"/><pre class="programlisting">irb myprogram.rb</pre><p>You may also invoke IRB with a variety of options to do things such as load a module (<code class="literal">irb -r</code> <em class="replaceable"><code>[load-module]</code></em>) or display the IRB version number (<code class="literal">irb -v</code>). Many of the available IRB options are rather esoteric and are not likely to be required by most users. The full range of options may be listed by entering this at the command line:</p><a id="I_programlisting18_d1e20699"/><pre class="programlisting">irb --help</pre><p>Although IRB may be useful for trying out some code, it does not provide all the features you need for debugging programs. Ruby does, however, provide a command-line debugger.<a id="IDX-CHP-18-0007" class="indexterm"/></p></div></div>
<div class="sect1" title="Debugging"><div class="titlepage"><div><div><h1 class="title"><a id="debugging"/>Debugging</h1></div></div></div><p>The default Ruby debugger allows you to set breakpoints and watchpoints and evaluate variables while your programs execute. To run a program in the debugger, use the <code class="literal">-r debug</code> option (where <code class="literal">-r</code> means “require” and <code class="literal">debug</code> is the name of the debugging library) when you start the Ruby interpreter. For example, this is how you would debug a program called <span class="emphasis"><em>debug_test.rb</em></span>:</p><a id="I_programlisting18_d1e20723"/><pre class="programlisting">ruby -r debug  debug_test.rb</pre><p>Once the debugger has started, you can enter various commands to step through your code, set breakpoints to cause the execution to pause at specific lines, set watches to monitor the values of variables, and so on. The following are the available debugging commands:</p><div class="variablelist"><dl><dt><span class="term"><strong class="userinput"><code>b[reak] [file|class:]&lt;line|method&gt;</code></strong> and <strong class="userinput"><code>b[reak] [file|class:]&lt;line|method&gt;</code></strong></span></dt><dd><p>Sets breakpoint to some position</p></dd><dt><span class="term"><strong class="userinput"><code>b[reak] [class.]&lt;line|method&gt;</code></strong></span></dt><dd><p>Sets breakpoint to some position</p></dd><dt><span class="term"><strong class="userinput"><code>wat[ch] &lt;expression&gt;</code></strong></span></dt><dd><p>Sets watchpoint to some expression</p></dd><dt><span class="term"><strong class="userinput"><code>cat[ch] &lt;an Exception&gt;</code></strong></span></dt><dd><p>Sets catchpoint to an exception</p></dd><dt><span class="term"><strong class="userinput"><code>b[reak]</code></strong></span></dt><dd><p>Lists breakpoints</p></dd><dt><span class="term"><strong class="userinput"><code>cat[ch]</code></strong></span></dt><dd><p>Shows catchpoint</p></dd><dt><span class="term"><strong class="userinput"><code>del[ete][ nnn]</code></strong></span></dt><dd><p>Deletes some or all breakpoints</p></dd><dt><span class="term"><strong class="userinput"><code>disp[lay] &lt;expression&gt;</code></strong></span></dt><dd><p>Adds expression to display expression list</p></dd><dt><span class="term"><strong class="userinput"><code>undisp[lay][ nnn]</code></strong></span></dt><dd><p>Deletes one particular or all display expressions</p></dd><dt><span class="term"><strong class="userinput"><code>c[ont]</code></strong></span></dt><dd><p>Runs until end or breakpoint</p></dd><dt><span class="term"><strong class="userinput"><code>s[tep][ nnn]</code></strong></span></dt><dd><p>Steps (into code) one line or to line <code class="literal">nnn</code></p></dd><dt><span class="term"><strong class="userinput"><code>n[ext][ nnn]</code></strong></span></dt><dd><p>Goes over one line or until line <code class="literal">nnn</code></p></dd><dt><span class="term"><strong class="userinput"><code>w[here]</code></strong></span></dt><dd><p>Displays frames</p></dd><dt><span class="term"><strong class="userinput"><code>f[rame]</code></strong></span></dt><dd><p>Is the alias for <code class="literal">where</code></p></dd><dt><span class="term"><strong class="userinput"><code>l[ist][ (-|nn-mm)]</code></strong></span></dt><dd><p>Lists program, lists backward <code class="literal">nn-mm</code>, lists given lines</p></dd><dt><span class="term"><strong class="userinput"><code>up[ nn]</code></strong></span></dt><dd><p>Moves to higher frame</p></dd><dt><span class="term"><strong class="userinput"><code>down[ nn]</code></strong></span></dt><dd><p>Moves to lower frame</p></dd><dt><span class="term"><strong class="userinput"><code>fin[ish]</code></strong></span></dt><dd><p>Returns to outer frame</p></dd><dt><span class="term"><strong class="userinput"><code>tr[ace] (on|off)</code></strong></span></dt><dd><p>Sets trace mode of current thread</p></dd><dt><span class="term"><strong class="userinput"><code>tr[ace] (on|off) all</code></strong></span></dt><dd><p>Sets trace mode of all threads</p></dd><dt><span class="term"><strong class="userinput"><code>q[uit]</code></strong></span></dt><dd><p>Exits from debugger</p></dd><dt><span class="term"><strong class="userinput"><code>v[ar] g[lobal]</code></strong></span></dt><dd><p>Shows global variables</p></dd><dt><span class="term"><strong class="userinput"><code>v[ar] l[ocal]</code></strong></span></dt><dd><p>Shows local variables</p></dd><dt><span class="term"><strong class="userinput"><code>v[ar] i[nstance] &lt;object&gt;</code></strong></span></dt><dd><p>Shows instance variables of object</p></dd><dt><span class="term"><strong class="userinput"><code>v[ar] c[onst] &lt;object&gt;</code></strong></span></dt><dd><p>Shows constants of object</p></dd><dt><span class="term"><strong class="userinput"><code>m[ethod] i[nstance] &lt;obj&gt;</code></strong></span></dt><dd><p>Shows methods of object</p></dd><dt><span class="term"><strong class="userinput"><code>m[ethod] &lt;class|module&gt;</code></strong></span></dt><dd><p>Shows instance methods of class or module</p></dd><dt><span class="term"><strong class="userinput"><code>th[read] l[ist]</code></strong></span></dt><dd><p>Lists all threads</p></dd><dt><span class="term"><strong class="userinput"><code>th[read] c[ur[rent]]</code></strong></span></dt><dd><p>Shows current thread</p></dd><dt><span class="term"><strong class="userinput"><code>th[read] [sw[itch]] &lt;nnn&gt;</code></strong></span></dt><dd><p>Switches thread context to <code class="literal">nnn</code></p></dd><dt><span class="term"><strong class="userinput"><code>th[read] stop &lt;nnn&gt;</code></strong></span></dt><dd><p>Stops thread <code class="literal">nnn</code><a id="IDX-CHP-18-0008" class="indexterm"/><a id="IDX-CHP-18-0009" class="indexterm"/></p></dd><dt><span class="term"><strong class="userinput"><code>th[read] resume &lt;nnn&gt;</code></strong></span></dt><dd><p>Resumes thread <code class="literal">nnn</code></p></dd><dt><span class="term"><strong class="userinput"><code>p expression</code></strong></span></dt><dd><p>Evaluates expression and prints its value</p></dd><dt><span class="term"><strong class="userinput"><code>h[elp]</code></strong></span></dt><dd><p>Prints this help</p></dd><dt><span class="term"><strong class="userinput"><code>&lt;everything else&gt;</code></strong></span></dt><dd><p>Evaluates</p></dd></dl></div><div class="sidebar"><a id="ubygems_question_whatas_ubygems_question"/><p class="title">Ubygems? What’s Ubygems?</p><p>In some cases, if you enter the command <code class="literal">ruby -r debug</code>, you may see an inscrutable message similar to the following:</p><a id="I_programlisting18_d1e21010"/><pre class="programlisting">c:/ruby/lib/ruby/site_ruby/1.8/ubygems.rb:4:require 'rubygems'</pre><p>If this happens, when you then start debugging, you will find yourself trying to debug the file <span class="emphasis"><em>ubygems.rb</em></span> rather than your program! This problem may occur when some software (for example, some customized Ruby installers) set the environment variable <code class="literal">RUBYOPT=-rubygems</code>. In most cases, this has the desirable effect of allowing your Ruby programs to use the Ruby Gems “packaging system,” which helps install Ruby libraries. When you try to use the <code class="literal">-r</code> option, however, this is interpreted as <code class="literal">-r ubygems</code>, which is why an attempt is made to load the file <span class="emphasis"><em>ubygems.rb</em></span>. Ruby conveniently (or possibly confusingly?) provides a file named <span class="emphasis"><em>ubygems.rb</em></span> that does nothing apart from requiring <span class="emphasis"><em>rubygems.rb</em></span>. There are two ways of dealing with this. You can remove <code class="literal">RUBYOPT</code> permanently, or you can disable it temporarily. If you choose to remove it permanently, however, you may encounter side effects when using Ruby Gems later. The way in which environment variables are added or removed varies according to your operating system. On Windows, you would need to click the Start menu (then Settings if using XP) and click Control Panel (then System and Maintenance if using Vista); then click System (on Vista, you should now click Advanced System Settings). In the System Properties dialog, select the Advanced tab. Next, click Environment Variables; finally, in the System Variables panel, find <code class="literal">RUBYOPT</code> and delete it. A safer alternative is to disable the variable at the command prompt prior to loading the debugger. To do this, enter the following:<a id="IDX-CHP-18-0010" class="indexterm"/><a id="IDX-CHP-18-0011" class="indexterm"/><a id="IDX-CHP-18-0012" class="indexterm"/></p><a id="I_programlisting18_d1e21051"/><pre class="programlisting">set RUBYOPT=</pre><p>This will disable the <code class="literal">RUBYOPT</code> environment variable for this command session only. You can verify this by entering the following:</p><a id="I_programlisting18_d1e21058"/><pre class="programlisting">set RUBYOPT</pre><p>You should see the message:</p><a id="I_programlisting18_d1e21062"/><pre class="programlisting">Environment variable RUBYOPT not defined</pre><p>However, open another command window and enter <code class="literal">set RUBYOPT</code>, and you will see that the environment variable here retains its default value.</p></div><p>Let’s see how a few of these commands might be used in a real debugging session. Open a system prompt, and navigate to the directory containing the file <span class="emphasis"><em>debug_test.rb</em></span>, which is supplied in the sample code for this chapter. Start the debugger by entering this:<a id="IDX-CHP-18-0013" class="indexterm"/><a id="IDX-CHP-18-0014" class="indexterm"/><a id="IDX-CHP-18-0015" class="indexterm"/></p><p><span class="emphasis"><em>debug_test.rb</em></span></p><a id="I_programlisting18_d1e21090"/><pre class="programlisting">ruby -r debug debug_test.rb</pre><p>Now, let’s try a few commands. In these examples, I’ve written <code class="literal">[Enter]</code> to show that you should press the <span class="keycap">enter</span> key after each command. First let’s see a code listing (here note that <code class="literal">l</code> is a lowercase <span class="emphasis"><em>L</em></span> character):</p><a id="I_programlisting18_d1e21106"/><pre class="programlisting">l [Enter]</pre><p>You should see this, which is a partial listing of the file <span class="emphasis"><em>debug_test.rb</em></span>:</p><a id="I_programlisting18_d1e21114"/><pre class="programlisting">debug_test.rb:2:          class Thing
(rdb:1) l
[-3, 6] in debug_test.rb
   1      # Thing
=&gt; 2      class Thing
   3
   4              attr_accessor( :name )
   5
   6              def initialize( aName )
(rdb:1)</pre><div class="note" title="Note"><h3 class="title">Note</h3><p>If you see a listing from a file called <span class="emphasis"><em>ubygems.rb</em></span> at this point instead of your program, refer to <a class="xref" href="ch18s02.html#ubygems_question_whatas_ubygems_question" title="Ubygems? What’s Ubygems?">Ubygems? What’s Ubygems?</a> in <a class="xref" href="ch18s02.html#ubygems_question_whatas_ubygems_question" title="Ubygems? What’s Ubygems?">Ubygems? What’s Ubygems?</a> for ways of correcting this problem.</p></div><p>The <code class="literal">l</code> you entered is the “list” command, which instructs the debugger to list the code in bite-sized chunks. The actual number of lines will vary with the code being debugged. Let’s list some more:</p><a id="I_programlisting18_d1e21131"/><pre class="programlisting">l [Enter]
l [Enter]</pre><p>Now list a specific number of lines. Enter the letter <code class="literal">l</code> followed by the digit <code class="literal">1</code>, a hyphen, and <code class="literal">100</code>:</p><a id="I_programlisting18_d1e21144"/><pre class="programlisting">l 1-100 [Enter]</pre><p>Let’s put a breakpoint on line 78:</p><a id="I_programlisting18_d1e21148"/><pre class="programlisting">b 78 [Enter]</pre><p>The Ruby debugger should reply with this:</p><a id="I_programlisting18_d1e21152"/><pre class="programlisting">Set breakpoint 1 at debug_test.rb:78</pre><p>You might also set one or more <span class="emphasis"><em>watchpoints</em></span>. A watchpoint can be used to trigger a break on a simple variable (for example, entering <code class="literal">wat @t2</code> would break when the <code class="literal">@t2</code> object is created); or it may be set to match a specific value (for example, <code class="literal">i == 10</code>). Here I want to set a watchpoint that breaks when the <code class="literal">name</code> attribute of <code class="literal">@t4</code> is “wombat”. Enter this:<a id="IDX-CHP-18-0016" class="indexterm"/></p><a id="I_programlisting18_d1e21181"/><pre class="programlisting">wat @t4.name == "wombat" [Enter]</pre><p>The debugger should confirm this:</p><a id="I_programlisting18_d1e21185"/><pre class="programlisting">Set watchpoint 2:@t4.name == "wombat"</pre><p>Notice the watchpoint number is 2. You’ll need that number if you subsequently decide to delete the watchpoint. Okay, so now let’s continue (<code class="literal">c</code>) execution:</p><a id="I_programlisting18_d1e21192"/><pre class="programlisting">c [Enter]</pre><p>The program will run until it hits the breakpoint. You will see a message similar to the following:</p><a id="I_programlisting18_d1e21196"/><pre class="programlisting">Breakpoint 1, toplevel at debug_test.rb:78
debug_test.rb:78:         puts("Game start" )</pre><p>Here it shows the line number it’s stopped on and the code on that line. Let’s continue:</p><a id="I_programlisting18_d1e21200"/><pre class="programlisting">c [Enter]</pre><p>This time it breaks here:</p><a id="I_programlisting18_d1e21205"/><pre class="programlisting">Watchpoint 2, toplevel at debug_test.rb:85
debug_test.rb:86:         @t5 = Treasure.new("ant", 2)</pre><p>This is the line immediately following the successful evaluation of the watchpoint condition. Check that by listing the line number indicated:</p><a id="I_programlisting18_d1e21209"/><pre class="programlisting">l 86</pre><p>The debugger shows a set of lines with the current line of execution (86) preceded by the <code class="literal">=&gt;</code> marker:</p><a id="I_programlisting18_d1e21216"/><pre class="programlisting">[81, 90] in debug_test.rb
   81     @t1 = Treasure.new("A sword", 800)
   82     @t4 = Treasure.new("potto", 500 )
   83     @t2 = Treasure.new("A dragon Horde", 550)
   84     @t3 = Treasure.new("An Elvish Ring", 3000)
   85     @t4 = Treasure.new("wombat", 10000)
=&gt; 86     @t5 = Treasure.new("ant", 2)
   87     @t6 = Treasure.new("sproggit", 400)
   88
   89     #   ii) Rooms
   90     @room1 = Room.new("Crystal Grotto", [])</pre><p>As you can see, line 86 contains the code that matches the watchpoint condition. Notice that execution did not stop after line 82, where <code class="literal">@t4</code> was originally created, because the watchpoint condition was not met there (its <code class="literal">name</code> attribute was “potto” and not “wombat”). If you want to inspect the value of a variable when paused at a breakpoint or watchpoint, just enter its name. Try this:</p><a id="I_programlisting18_d1e21226"/><pre class="programlisting">@t4 [Enter]</pre><p>The debugger will display the following:</p><a id="I_programlisting18_d1e21230"/><pre class="programlisting">#&lt;Treasure:0x315617c @value=10000, @name="wombat"&gt;</pre><p>You can similarly enter other expressions to be evaluated. Try this:</p><a id="I_programlisting18_d1e21234"/><pre class="programlisting">@t1.value [Enter]</pre><p>This shows <code class="literal">800</code>.</p><p>Or enter some arbitrary expression such as this:</p><a id="I_programlisting18_d1e21244"/><pre class="programlisting">10+4/2 [Enter]</pre><p>This shows <code class="literal">12</code>.</p><p>Now delete the watchpoint (recall that its number is 2):</p><a id="I_programlisting18_d1e21253"/><pre class="programlisting">del 2 [Enter]</pre><p>And continue until the program exits:</p><a id="I_programlisting18_d1e21257"/><pre class="programlisting">c [Enter]</pre><p>You can use many more commands to debug a program in this way, and you may want to experiment with those shown in the table given earlier. You can also view a list of commands during a debugging session by entering <code class="literal">help</code> or just <code class="literal">h</code>:</p><a id="I_programlisting18_d1e21267"/><pre class="programlisting">h [Enter]</pre><p>To quit a debugging session, enter <code class="literal">quit</code> or <code class="literal">q</code>:</p><a id="I_programlisting18_d1e21278"/><pre class="programlisting">q [Enter]</pre><p>Although the standard Ruby debugger has its uses, it is far from as simple or convenient to use as one of the graphical debuggers provided by integrated development environments. Moreover, it is quite slow. In my view, it is fine for debugging simple scripts but cannot be recommended for debugging large and complex programs.<a id="IDX-CHP-18-0017" class="indexterm"/></p></div>
<div class="sect1" title="Unit Testing"><div class="titlepage"><div><div><h1 class="title"><a id="unit_testing"/>Unit Testing</h1></div></div></div><p><span class="emphasis"><em>Unit testing</em></span> is a postdebugging testing technique that lets you try bits of your program in order to verify that they work as expected. Some programmers use unit testing habitually in addition to or even instead of interactive debugging; other programmers use it rarely or never. Entire books have been written on the techniques and methodologies of unit testing, and I will only cover its fundamentals here.<a id="IDX-CHP-18-0018" class="indexterm"/></p><p>The basic idea of unit testing is that you can write a number of “assertions” stating that certain results should be obtained as the consequence of certain actions. For example, you might assert that the return value of a specific method should be 100, that it should be a Boolean, or that it should be an instance of a specific class. If, when the test is run, the assertion proves to be correct, it passes the test; if it is incorrect, the test fails.</p><p>Here’s an example, which will fail if the <code class="literal">getVal</code> method of the object, <code class="literal">t</code>, returns any value other than 100:</p><a id="I_programlisting18_d1e21305"/><pre class="programlisting">assert_equal(100, t.getVal)</pre><p>But you can’t just pepper your code with assertions of this sort. There are precise rules to the game. First you have to require the <span class="emphasis"><em>test/unit</em></span> file. Then you need to derive a test class from the TestCase class, which is found in the <code class="literal">Unit</code> module, which is itself in the <code class="literal">Test</code> module:<a id="IDX-CHP-18-0019" class="indexterm"/><a id="IDX-CHP-18-0020" class="indexterm"/></p><a id="I_programlisting18_d1e21326"/><pre class="programlisting">class MyTest &lt; Test::Unit::TestCase</pre><p>Inside this class you can write one or more methods, each of which constitutes a test containing one or more assertions. The method names must begin with <code class="literal">test</code> (so methods called <code class="literal">test1</code> or <code class="literal">testMyProgram</code> are okay, but a method called <code class="literal">myTestMethod</code> isn’t). The following method contains a test that makes the single assertion that the return value of <code class="literal">TestClass.new(100).getVal</code> is 1,000:</p><a id="I_programlisting18_d1e21345"/><pre class="programlisting">def test2
    assert_equal(1000,TestClass.new(100).getVal)
end</pre><p>And here is a complete (albeit simple) test suite in which I have defined a TestCase class called MyTest that tests the class, TestClass. Here (with a little imagination!), TestClass may be taken to represent a whole program that I want to test:</p><p><span class="emphasis"><em>test1.rb</em></span></p><a id="I_programlisting18_d1e21353"/><pre class="programlisting">require 'test/unit'

class TestClass
    def initialize( aVal )
        @val = aVal * 10
    end

    def getVal
        return @val
    end
end

class MyTest &lt; Test::Unit::TestCase
    def test1
        t = TestClass.new(10)
        assert_equal(100, t.getVal)
        assert_equal(101, t.getVal)
        assert(100 != t.getVal)
    end

    def test2
        assert_equal(1000,TestClass.new(100).getVal)
    end
end</pre><p>This test suite contains two tests: <code class="literal">test1</code> (which contains three assertions) and <code class="literal">test2</code> (which contains one). To run the tests, you just need to run the program; you don’t have to create an instance of MyClass. You will see a report of the results that states there were two tests, three assertions, and one failure:<a id="IDX-CHP-18-0021" class="indexterm"/></p><a id="I_programlisting18_d1e21366"/><pre class="programlisting">1) Failure:
test1(MyTest) [C:/bookofruby/ch18/test1.rb:19]:
&lt;101&gt; expected but was
&lt;100&gt;.

2 tests, 3 assertions, 1 failures, 0 errors</pre><p>In fact, I made <span class="emphasis"><em>four</em></span> assertions. However, assertions following a failure are not evaluated in a given test. In <code class="literal">test1</code>, this assertion fails:</p><a id="I_programlisting18_d1e21376"/><pre class="programlisting">assert_equal(101, t.getVal)</pre><p>Having failed, the next assertion is skipped. If I now correct this failed assertion (asserting 100 instead of 101), this next assertion will also be tested:</p><a id="I_programlisting18_d1e21380"/><pre class="programlisting">assert(100 != t.getVal)</pre><p>But this too fails. This time, the report states that four assertions have been evaluated with one failure:</p><a id="I_programlisting18_d1e21384"/><pre class="programlisting">2 tests, 4 assertions, 1 failures, 0 errors, 0 skips</pre><p>Of course, in a real-life situation, you should aim to write correct assertions, and when any failures are reported, it should be the failing code that is rewritten—not the assertion!</p><p>For a slightly more complex example of testing, see the <span class="emphasis"><em>test2.rb</em></span> program (which requires a file called <span class="emphasis"><em>buggy.rb</em></span>). This is a small adventure game that includes the following test methods:</p><p><span class="emphasis"><em>test2.rb</em></span></p><a id="I_programlisting18_d1e21400"/><pre class="programlisting">def test1
    @game.treasures.each{ |t|
        assert(t.value &lt; 2000, "FAIL: #{t} t.value = #{t.value}" )
    }
end

def test2
    assert_kind_of( TestMod::Adventure::Map, @game.map)
    assert_kind_of( Array, @game.map)
end</pre><p>Here the first method, <code class="literal">test1</code>, performs an <code class="literal">assert</code> test on an array of objects passed into a block, and it fails when a <code class="literal">value</code> attribute is <span class="emphasis"><em>not</em></span> less than 2,000. The second method, <code class="literal">test2</code>, tests the class types of two objects using the <code class="literal">assert_kind_of</code> method. The second test in this method fails when <code class="literal">@game.map</code> is found to be of the type <code class="literal">TestMod::Adventure::Map</code> rather than <code class="literal">Array</code> as is asserted.<a id="IDX-CHP-18-0022" class="indexterm"/></p><p>The code also contains two more methods named <code class="literal">setup</code> and <code class="literal">teardown</code>. When defined, methods with these names will be run before and after each test method. In other words, in <span class="emphasis"><em>test2.rb</em></span>, the following methods will run in this order:<a id="IDX-CHP-18-0023" class="indexterm"/><a id="IDX-CHP-18-0024" class="indexterm"/><a id="IDX-CHP-18-0025" class="indexterm"/></p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col/><col/><col/></colgroup><tbody><tr><td style="text-align: left" valign="top"><p>1. <code class="literal">setup</code></p></td><td style="text-align: left" valign="top"><p>2. <code class="literal">test1</code></p></td><td style="text-align: left" valign="top"><p>3. <code class="literal">teardown</code></p></td></tr><tr><td style="text-align: left" valign="top"><p>4. <code class="literal">setup</code></p></td><td style="text-align: left" valign="top"><p>5. <code class="literal">test2</code></p></td><td style="text-align: left" valign="top"><p>6. <code class="literal">teardown</code></p></td></tr></tbody></table></div><p>This gives you the opportunity of reinitializing any variables to specific values prior to running each test or, as in this case, re-creating objects to ensure that they are in a known state as in the following example:</p><a id="I_programlisting18_d1e21499"/><pre class="programlisting">def setup
    @game = TestMod::Adventure.new
end

def teardown
    @game.endgame
end</pre><div class="sidebar"><a id="digging_deeper-id17"/><p class="title">Digging Deeper</p><p>This section contains a summary of assertions for unit testing, explains why IRB may show different results for what appears to be the same code, and considers the merits of more advanced debugging tools.<a id="IDX-CHP-18-0026" class="indexterm"/><a id="IDX-CHP-18-0027" class="indexterm"/><a id="IDX-CHP-18-0028" class="indexterm"/><a id="IDX-CHP-18-0029" class="indexterm"/><a id="IDX-CHP-18-0030" class="indexterm"/><a id="IDX-CHP-18-0031" class="indexterm"/><a id="IDX-CHP-18-0032" class="indexterm"/><a id="IDX-CHP-18-0033" class="indexterm"/><a id="IDX-CHP-18-0034" class="indexterm"/><a id="IDX-CHP-18-0035" class="indexterm"/><a id="IDX-CHP-18-0036" class="indexterm"/><a id="IDX-CHP-18-0037" class="indexterm"/><a id="IDX-CHP-18-0038" class="indexterm"/><a id="IDX-CHP-18-0039" class="indexterm"/></p><p><span class="bolditalic">Assertions Available When Unit Testing</span></p><p>The list of assertions shown next is provided for ease of reference. A full explanation of each assertion is beyond the scope of this book. You can find complete documentation of the testing libraries at <a class="ulink" href="http://ruby-doc.org/stdlib/">http://ruby-doc.org/stdlib/</a>. On this site, select the class listing for <code class="literal">Test::Unit::Assertions</code> in order to view the full documentation of the available assertions plus numerous code samples demonstrating their usage.</p><div class="variablelist"><dl><dt><span class="term"><strong class="userinput"><code>assert(boolean, message=nil)</code></strong></span></dt><dd><p>Asserts that boolean is not false or nil.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_block(message="assert_block failed.") {|| ...}</code></strong></span></dt><dd><p>The assertion upon which all other assertions are based. Passes if the block yields true.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_equal(expected, actual, message=nil</code></strong><code class="literal">)</code></span></dt><dd><p>Passes if <code class="literal">expected</code> == <code class="literal">actual</code>.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_in_delta(expected_float, actual_float, delta, message="")</code></strong></span></dt><dd><p>Passes if <code class="literal">expected_float</code> and <code class="literal">actual_float</code> are equal within <code class="literal">delta</code> tolerance.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_instance_of(klass, object, message="")</code></strong></span></dt><dd><p>Passes if object <code class="literal">.instance_of?</code> klass.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_kind_of(klass, object, message="")</code></strong></span></dt><dd><p>Passes if object <code class="literal">.kind_of?</code> klass.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_match(pattern, string, message="")</code></strong></span></dt><dd><p>Passes if string <code class="literal">=˜</code> pattern.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_nil(object, message="")</code></strong></span></dt><dd><p>Passes if object is <code class="literal">nil</code>.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_no_match(regexp, string, message="")</code></strong></span></dt><dd><p>Passes if regexp <code class="literal">!˜</code> string.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_not_equal(expected, actual, message="")</code></strong></span></dt><dd><p>Passes if expected <code class="literal">!=</code> actual.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_not_nil(object, message="")</code></strong></span></dt><dd><p>Passes if <code class="literal">!</code> object .nil?.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_not_same(expected, actual, message="")</code></strong></span></dt><dd><p>Passes if <code class="literal">!</code> actual <code class="literal">.equal?</code> expected.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_nothing_raised(*args) {|| ...}</code></strong></span></dt><dd><p>Passes if block does not raise an exception.<a id="IDX-CHP-18-0040" class="indexterm"/><a id="IDX-CHP-18-0041" class="indexterm"/><a id="IDX-CHP-18-0042" class="indexterm"/><a id="IDX-CHP-18-0043" class="indexterm"/><a id="IDX-CHP-18-0044" class="indexterm"/><a id="IDX-CHP-18-0045" class="indexterm"/><a id="IDX-CHP-18-0046" class="indexterm"/><a id="IDX-CHP-18-0047" class="indexterm"/><a id="IDX-CHP-18-0048" class="indexterm"/></p></dd><dt><span class="term"><strong class="userinput"><code>assert_nothing_thrown(message="", &amp;proc)</code></strong></span></dt><dd><p>Passes if block does not throw anything.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_operator(object1, operator, object2, message="")</code></strong></span></dt><dd><p>Compares the <code class="literal">object1</code> with <code class="literal">object2</code> using operator. Passes if <code class="literal">object1.send(operator, object2)</code> is true.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_raise(*args) {|| ...}</code></strong></span></dt><dd><p>Passes if the block raises one of the given exceptions.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_raises(*args, &amp;block)</code></strong></span></dt><dd><p>Alias of <code class="literal">assert_raise</code>. (Deprecated in Ruby 1.9 and to be removed in 2.0.)<a id="IDX-CHP-18-0049" class="indexterm"/></p></dd><dt><span class="term"><strong class="userinput"><code>assert_respond_to(object, method, message="")</code></strong></span></dt><dd><p>Passes if object <code class="literal">.respond_to?</code> method.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_same(expected, actual, message="")</code></strong></span></dt><dd><p>Passes if actual <code class="literal">.equal?</code> expected (in other words, they are the same instance).</p></dd><dt><span class="term"><strong class="userinput"><code>assert_send(send_array, message="")</code></strong></span></dt><dd><p>Passes if the method send returns a true value.</p></dd><dt><span class="term"><strong class="userinput"><code>assert_throws(expected_symbol, message="", &amp;proc)</code></strong></span></dt><dd><p>Passes if the block throws <code class="literal">expected_symbol</code></p></dd><dt><span class="term"><strong class="userinput"><code>build_message(head, template=nil, *arguments)</code></strong></span></dt><dd><p>Builds a failure message; head is added before the template and <code class="literal">*arguments</code> replaces the question marks positionally in the template.</p></dd><dt><span class="term"><strong class="userinput"><code>flunk(message="Flunked")</code></strong></span></dt><dd><p><code class="literal">flunk</code> always fails.<a id="IDX-CHP-18-0050" class="indexterm"/></p></dd></dl></div><p><span class="bolditalic">Line Breaks Are Significant</span></p><p>I said earlier that you need to take care when entering line breaks into the interactive Ruby console (IRB) since the position of line breaks may alter the meaning of your Ruby code. So, for example, the following:<a id="IDX-CHP-18-0051" class="indexterm"/><a id="IDX-CHP-18-0052" class="indexterm"/><a id="IDX-CHP-18-0053" class="indexterm"/></p><p><span class="emphasis"><em>linebreaks.rb</em></span></p><a id="I_programlisting18_d1e21852"/><pre class="programlisting">x = ( 10 +
( 2 * 4 ) )</pre><p>assigns <code class="literal">18</code> to <code class="literal">x</code>, but the following:</p><a id="I_programlisting18_d1e21862"/><pre class="programlisting">x = (10
+ (2*4))</pre><p>assigns <code class="literal">8</code> to <code class="literal">x</code>.</p><p>This is not merely a quirk of IRB. This is normal behavior of Ruby code even when entered into a text editor and executed by the Ruby interpreter. The second example just shown evaluates <code class="literal">10</code> on the first line, finds this to be a perfectly acceptable value, and promptly forgets about it; then it evaluates <code class="literal">+ (2*4)</code>, which it also finds to be an acceptable value (<code class="literal">8</code>), but it has no connection with the previous value (<code class="literal">10</code>), so <code class="literal">8</code> is returned and assigned to <code class="literal">x</code>.<a id="IDX-CHP-18-0054" class="indexterm"/><a id="IDX-CHP-18-0055" class="indexterm"/><a id="IDX-CHP-18-0056" class="indexterm"/><a id="IDX-CHP-18-0057" class="indexterm"/><a id="IDX-CHP-18-0058" class="indexterm"/></p><p>If you want to tell Ruby to evaluate expressions split over multiple lines, ignoring the line breaks, you can use the line continuation character (<code class="literal">\</code>). This is what I’ve done here:</p><a id="I_programlisting18_d1e21916"/><pre class="programlisting">x = (10 \
+ (2*4) )</pre><p>This time, <code class="literal">x</code> is assigned the value <code class="literal">18</code>.</p><p><span class="bolditalic">Graphical Debuggers</span></p><p>For serious debugging, I strongly recommend a graphical debugger. For example, the debugger in the Ruby In Steel IDE allows you to set breakpoints and watchpoints by clicking the margin of the editor.<a id="IDX-CHP-18-0059" class="indexterm"/></p><div class="informalfigure"><a id="image_no_caption-id22"/><div class="mediaobject"><a id="I_mediaobject18_d1e21935"/><img src="httpatomoreillycomsourcenostarchimages860166.png" alt="image with no caption"/></div></div><p>It lets you monitor the values of selected “watch variables” or all local variables in separate docked windows. It maintains a “callstack” of all method calls leading to the current point of execution and allows you to navigate “backward” through the callstack to view the changing values of variables. It also has “drill-down” expansion of variables to allow you to expand arrays and hashes and look inside complex objects. These capabilities go well beyond the features of the standard Ruby debugger. For information on Ruby IDEs, see <a class="xref" href="apd.html" title="Appendix D. Ruby and Rails Development Software">Appendix D</a>.</p></div></div></body></html>