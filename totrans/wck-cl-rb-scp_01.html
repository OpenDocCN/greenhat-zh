<html><head></head><body>
  <div class="sgc-1" id="filepos91052"/>&#13;
&#13;
  <h1 class="calibre1" id="calibre_pb_22"><span class="calibre2"><a class="calibre7" shape="rect"/>Chapter 1. GENERAL PURPOSE UTILITIES</span></h1>&#13;
&#13;
  <div class="calibre3"><a class="calibre17" shape="rect"/><img alt="GENERAL PURPOSE UTILITIES" class="calibre23" src="../Images/00001.jpg"/></div>&#13;
&#13;
  <p class="calibre4">In any programming language, scripting is the solution to frequently <a class="calibre17" shape="rect"/>performed tasks. If you find yourself asking <span><em class="italic">Couldn't a robot or well-trained monkey do this job?</em></span>, then scripting with Ruby just might be the next best solution. Writing <a class="calibre17" shape="rect"/>scripts for frequently performed tasks makes your job and computing experience as efficient as it can be. Who wouldn't want to get the job done in less time with less effort? As you work through these examples, I encourage you to write down ideas for your own scripts. Once you've finished this book, you will probably have a list of scripts you want to write, or at the very least, some useful revisions of mine. Are you ready? Let's get started!</p>&#13;


  <div class="calibre3 calibre3 calibre3 calibre3">
    <h1 class="calibre1" id="calibre_pb_23"><span class="calibre2"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos92614"/>Check for Changed Files</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_24"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos92911"/>Check for Changed Files</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>changedFiles.rb</h3>
      </div>

      <p class="calibre4">The purpose of this script is to validate a file's <a class="calibre17" shape="rect"/>integrity. While it sounds like a humble end use, its applications are broad: If you can't trust the contents of files on your computer, you can't trust your computer. Would you know if a malicious worm or virus modified a file on your system? If you think your antivirus has you covered, think again—most only go as far as <a class="calibre17" shape="rect"/>checking for known viruses and their signatures. File <a class="calibre17" shape="rect"/>integrity validation is used every day for real-world tasks such as digital forensics and tracking the behavior of malicious logic. One method of tracking file integrity is shown below.<a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_25"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos94318"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19">require 'find'<br class="calibre20"/>&#13;
      require 'digest/md5'<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <a class="calibre17" shape="rect"/><br class="calibre20"/>&#13;
      unless ARGV[0] and File.directory?(ARGV[0])<br class="calibre20"/>&#13;
          puts "\n\n\nYou need to specify a root directory:  <a class="calibre17" shape="rect"/>changedFiles.rb<br class="calibre20"/>&#13;
      &lt;directory&gt;\n\n\n"<br class="calibre20"/>&#13;
          exit<br class="calibre20"/>&#13;
      end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> root = ARGV[0]<br class="calibre20"/>&#13;
       oldfile_hash = Hash.new<br class="calibre20"/>&#13;
       newfile_hash = Hash.new<br class="calibre20"/>&#13;
       file_report = "#{root}/analysis_report.txt"<br class="calibre20"/>&#13;
       file_output = "#{root}/file_list.txt"<br class="calibre20"/>&#13;
       oldfile_output = "#{root}/file_list.old"<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> if File.exists?(file_output)<br class="calibre20"/>&#13;
         File.rename(file_output, oldfile_output)<br class="calibre20"/>&#13;
         File.open(oldfile_output, 'rb') do |infile|<br class="calibre20"/>&#13;
           while (temp = infile.gets)<br class="calibre20"/>&#13;
             line = /(.+)\s{5,5}(\w{32,32})/.match(temp)<br class="calibre20"/>&#13;
             puts "#{line[1]}  ---&gt;  #{line[2]}"<br class="calibre20"/>&#13;
             oldfile_hash[line[1]] = line[2]<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
         end<br class="calibre20"/>&#13;
      end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> Find.find(root) do |file|<br class="calibre20"/>&#13;
           next if /^\./.match(file)<br class="calibre20"/>&#13;
           next unless File.file?(file)<br class="calibre20"/>&#13;
           begin<br class="calibre20"/>&#13;
               newfile_hash[file] = Digest::MD5.hexdigest(File.read(file))<br class="calibre20"/>&#13;
           rescue<br class="calibre20"/>&#13;
               puts "Error reading #{file} --- MD5 hash not computed."<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       report = File.new(file_report, 'wb')<br class="calibre20"/>&#13;
       changed_files = File.new(file_output, 'wb')<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       newfile_hash.each do |file, md5|<br class="calibre20"/>&#13;
         changed_files.puts "#{file}     #{md5}"<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <a class="calibre17" shape="rect"/><br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/><br class="calibre20"/>&#13;
       newfile_hash.keys.select { |file| newfile_hash[file] == oldfile_hash[file]<br class="calibre20"/>&#13;
       }.each do |file|<br class="calibre20"/>&#13;
          newfile_hash.delete(file)<br class="calibre20"/>&#13;
          oldfile_hash.delete(file)<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/> newfile_hash.each do |file, md5|<br class="calibre20"/>&#13;
      <strong class="calibre22"><code class="calibre19">    report.puts "#{oldfile_hash[file] ? "<a class="calibre17" shape="rect"/>Changed" : "Added"} file: #{file}</code></strong><br class="calibre20"/>&#13;
      <strong class="calibre22"><code class="calibre19">#{md5}"</code></strong><br class="calibre20"/>&#13;
          oldfile_hash.delete(file)<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00007.jpg"/> oldfile_hash.each do |file, md5|<br class="calibre20"/>&#13;
          report.puts "Deleted/Moved file: #{file}     #{md5}"<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       report.close<br class="calibre20"/>&#13;
       changed_files.close</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_26"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos97651"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">Execute this script by typing:<a class="calibre17" shape="rect"/></p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby changedFiles.rb</code></strong> <em class="italic"><code class="calibre19">/path/to/check/</code></em></tt></span>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">You can add more than one directory to crawl, but subdirectories will automatically be verified. The script will automatically determine if a directory exists and then add it to the crawler's queue.</p>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_27"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos98634"/>The Results</span></h2>
    </div>

    <p class="calibre4">The script will initially produce two separate files (<span><em class="italic">changed.files and file_report.txt</em></span>). Both will contain a list of the names and MD5 hashes for all of the files scanned by the script:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Added file: fileSplit.rb d79c592af618266188a9a49f91fe0453<br class="calibre20"/>
      Added file: fileJoin.rb 5aedfe682e300dcc164ebbdebdcd8875<br class="calibre20"/>
      Added file: win32RegCheck.rb c0d26b249709cd91a0c8c14b65304aa7<br class="calibre20"/>
      Added file: changedFiles.rb c2760bfe406a6d88e04f8969b4287b4c<br class="calibre20"/>
      Added file: encrypt.rb 08caf04913b4a6d1f8a671ea28b86ed2<br class="calibre20"/>
      Added file: decrypt.rb 90f68b4f65bb9e9a279cd78b182949d4<br class="calibre20"/>
      Added file: file_report.txt d41d8cd98f00b204e9800998ecf8427e<br class="calibre20"/>
      Added file: changed.files d41d8cd98f00b204e9800998ecf8427e<br class="calibre20"/>
      Added file: test.txt a0cbe4bbf691bbb2a943f8d898c1b242<br class="calibre20"/>
      Added file: test.txt.rsplit1 35d5b2e522160ce3b3b98d2d4ad2a86e<br class="calibre20"/>
      Added file: test.txt.rsplit2 a65dde64f16a4441ff1619e734207528<br class="calibre20"/>
      Added file: test.txt.rsplit3 264b40b40103a4a3d82a40f82201a186<br class="calibre20"/>
      Added file: test.txt.rsplit4 943600762a52864780b9b9f0614a470a<br class="calibre20"/>
      Added file: test.txt.rsplit5 131c8aa7155483e7d7a999bf6e2e21c0<br class="calibre20"/>
      Added file: test.txt.rsplit6 1ce31f6fbeb01cbed6c579be2608e56c</tt></span>
    </div>

    <p class="calibre4">After the script is run a second time, three files will appear in the root directory. Two of the files, <span><em class="italic">changed.files</em></span> and <span><em class="italic">old_changed.files</em></span>, are where the MD5 hashes are stored; the third, <span><em class="italic">file_report.txt</em></span>, is a text file showing the results. The script will compare the MD5 hashes <a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/>for all of the files listed in <span><em class="italic">changed.files</em></span> with those in <span><em class="italic">old_changed.files</em></span> and return any differences found. Here is an example:<a class="calibre17" shape="rect"/></p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Changed file: old_changed.files 45de547aef9366eeaeb1b565dff1e1a3<br class="calibre20"/>
      Deleted/Moved file: test.txt.rsplit4 943600762a52864780b9b9f0614a470a<br class="calibre20"/>
      Deleted/Moved file: test.txt.rsplit5 131c8aa7155483e7d7a999bf6e2e21c0<br class="calibre20"/>
      Deleted/Moved file: test.txt.rsplit6 1ce31f6fbeb01cbed6c579be2608e56c<br class="calibre20"/>
      Deleted/Moved file: test.txt.rsplit1 35d5b2e522160ce3b3b98d2d4ad2a86e<br class="calibre20"/>
      Deleted/Moved file: test.txt.rsplit2 a65dde64f16a4441ff1619e734207528<br class="calibre20"/>
      Deleted/Moved file: test.txt.rsplit3 264b40b40103a4a3d82a40f82201a186</tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_28"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos101837"/>How It Works</span></h2>
    </div>

    <p class="calibre4">This script is great for verifying the contents of your hard drive and ensuring they haven't been manipulated. The script starts by confirming that the user-supplied arguments were included and that a valid <a class="calibre17" shape="rect"/>directory was given. Next is the initialization of <a class="calibre17" shape="rect"/>variables used in the script. The <code class="calibre19">root</code> variable contains the root directory to scan, two hashes are created that will be used for comparing the files and their MD5 hashes, and, finally, the names of the files to be used are specified <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. The script output is saved in two or three files, depending on whether the script has been run before. The main file, <span><em class="italic">file_report.txt</em></span>, is used for reading the output, and the other two files are used to store the list of MD5 hashes.<a class="calibre17" shape="rect"/></p>

    <p class="calibre4">Next, the script checks to see if it's been run before by looking for <span><em class="italic">file_list.txt</em></span><span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. If the file is not found, the script moves on. If it <a class="calibre17" shape="rect"/>finds <span><em class="italic">file_list.txt</em></span>, the script immediately renames the file. The renamed file is then opened and the contents are read. For every line in the file, the script reads a filename and MD5 hash and stores these in the <code class="calibre19">oldfile_hash</code> for later comparison. Once the <code class="calibre19">oldfile_hash</code> has been populated, the script is ready to begin computing new MD5 hashes and comparing results.<a class="calibre17" shape="rect"/></p>

    <p class="calibre4">As the script works its way through the directory tree, it will iterate through each object <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. The <code class="calibre19">Find.find</code> method is a powerful recursive way to retrieve files in a directory and subdirectories. The code block will be run on every file found. The first statement is looking for the "." and ".."—which are skipped for obvious reasons. If the object is a directory, the script will give it the skip treatment and press on. If the item is a file, the hash is generated and stored for later use. The <a class="calibre17" shape="rect"/>hashing process is surrounded by a <code class="calibre19">begin</code>/<code class="calibre19">rescue</code> block to save us if something goes terribly wrong.</p>

    <p class="calibre4">The bulk of the information gathering is now complete. All that is left is to determine the status of each file. If a file has the same name and MD5 hash, it is unchanged and the script will remove the filename from the output hash. There are three categories that a file can fit into aside from <span><em class="italic">Unchanged</em></span>. The first is <span><em class="italic">Deleted or Moved</em></span>, which is determined by a file's presence in the past scan but not the current one <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. Next is the <span><em class="italic">Changed</em></span> category. If the filename exists and the MD5 hash is not the same as in the previous scans, the file has been changed <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. At this point, for the sake of readability in the code, I used the <span><em class="italic">ternary operator</em></span>, which is an abbreviation of the <code class="calibre19">if</code>/<code class="calibre19">then</code>/<code class="calibre19">else</code> statement. So, this says if the file exists in <code class="calibre19">oldfile_hash</code>, <span><em class="italic">then</em></span> label it <span><em class="italic">Changed, else</em></span> label it <span><em class="italic">Added;</em></span> since the filename doesn't exist previously, it has been added since the last scan <a class="calibre17" shape="rect"/><span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00007.jpg"/></span>. All of the data is saved, and a report is generated so the user is aware of each file's status. If anything is out of the ordinary, further analysis is required.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>

    <p class="calibre4">There are several software packages that perform similar computations for security purposes, but the method above is a nice alternative, and the price is right, too. For enhanced security, you can store the output <a class="calibre17" shape="rect"/>files on a separate medium, but I generally leave them in the top-level directory for simplicity's sake.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_29"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos107737"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">This script can be modified to use any number of hashing algorithms. I chose MD5 because it is the most popular for <a class="calibre17" shape="rect"/>checking a file's <a class="calibre17" shape="rect"/>integrity (even though its hashes are vulnerable to a collision attack). This script works on both Microsoft Windows and Unix-like systems. Cross platform <a class="calibre17" shape="rect"/>scripts are always a plus!</p>

    <p class="calibre4">Other potential changes to the script include <a class="calibre17" shape="rect"/>encrypting the hashed files for added protection or interfacing the results into a database. The script has many potential uses, and I'll leave it to you to investigate further. If you are curious about encryption, check out the next script.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_30"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos108750">
    <h1 class="calibre1" id="calibre_pb_31"><span class="calibre2"><a class="calibre7" shape="rect"/>Encrypt a File</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_32"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos109239"/>Encrypt a File</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>encrypt.rb</h3>
      </div>

      <p class="calibre4">How often have you heard about people selling their computers on an auction site, only to later discover that their sensitive information had been exposed on the Internet? And what about corporate espionage, or all those missing government laptops? If you talk to security experts, one of the first recommendations they make is to encrypt sensitive information. You could always buy a program that does this for you, but that's no fun. Let's write our own encryption script! There are many encryption algorithms from which to choose, all with varying levels of strength. In this example, I will be using <a class="calibre17" shape="rect"/>Blowfish, a very fast, symmetric block cipher.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_33"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos110706"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><img alt="" class="calibre23" src="../Images/00002.jpg"/> require 'crypt/blowfish'<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       unless ARGV[0]<br class="calibre20"/>&#13;
           puts "Usage: ruby encrypt.rb &lt;filename.ext&gt;"<br class="calibre20"/>&#13;
           puts "Example: ruby encrypt.rb secret.stuff"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       #take in the file name to encrypt as an argument<br class="calibre20"/>&#13;
       filename = ARGV[0].chomp<br class="calibre20"/>&#13;
       puts filename<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> c = "Encrypted_#{filename}"<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> if File.exists?(c)<br class="calibre20"/>&#13;
           puts "File already exists."<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/> print 'Enter your encryption key (1-56 bytes): '<br class="calibre20"/>&#13;
       kee = gets.chomp<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/> begin<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00007.jpg"/>     blowfish = Crypt::Blowfish.new(kee)<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00008.jpg"/>     blowfish.encrypt_file(filename.to_str, c)<br class="calibre20"/>&#13;
           puts 'Encryption SUCCESS!'<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00009.jpg"/> rescue Exception =&gt; e<br class="calibre20"/>&#13;
           puts "An error occurred during encryption: \n #{e}"<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_34"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos112453"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">You must have the Ruby gem <span><em class="italic">crypt</em></span> installed on your system—use the command <code class="calibre19">gem install crypt</code> at the console to install the <a class="calibre17" shape="rect"/>crypt library. This encryption script is accessed through a command prompt. To run, type:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby encryption.rb</code></strong> <em class="italic"><code class="calibre19">/path/of/file/to/encrypt</code></em></tt></span>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">You will be prompted for a password:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19">Enter your encryption key (1-56 characters):</tt></span>&#13;
    </div>&#13;
&#13;
    <div class="calibre3">&#13;
      <hr class="calibre21"/>&#13;
    </div>&#13;
&#13;
    <div class="calibre3">&#13;
      <h3 class="calibre24" id="heading_id_2"><span class="calibre18"><a class="calibre7" shape="rect"/>Warning</span></h3>&#13;
&#13;
      <p class="calibre4"><span class="calibre18"><em class="italic">Remember your password, or you won't be able to decrypt your file!</em></span></p>&#13;
    </div>&#13;
&#13;
    <div class="calibre3">&#13;
      <hr class="calibre21"/>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">Now press enter and, if the encryption was successful, you will see this message:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19">Encryption SUCCESS!</tt></span>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">Look in the folder where this script resides; you will see the new, encrypted file, named <span><em class="italic">Encrypted_&lt;filename&gt;</em></span>.</p>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_35"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos114647"/>The Results</span></h2>
    </div>

    <p class="calibre4">For the example above, I used a plaintext file with the following contents:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Wicked Cool Ruby Scripts</tt></span>
    </div>

    <p class="calibre4">After the script has finished <a class="calibre17" shape="rect"/>encrypting the file, it will output a success message. You can then attempt to view the file. Good luck deciphering it if you forgot your password:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">qo".1[&gt;°&lt;|šã_8tÃhÞí}"f-%◦1ð»=ðrþ¡.,</tt></span>
    </div>

    <p class="calibre4">As you can see, the results don't resemble the original plaintext at all.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_36"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos115794"/>How It Works</span></h2>
    </div>

    <p class="calibre4">In the first line, I include the library used <a class="calibre17" shape="rect"/>for encryption: crypt/blowfish<a class="calibre17" shape="rect"/> <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. Note that you could change this to use another algorithm, such as Rijndael or GOST. Line <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span> starts the creation of our encrypted file. <a class="calibre17" shape="rect"/>Creating <a class="calibre17" shape="rect"/>files in Ruby is very simple. As you can see, I used a shortcut to name the file by including the variable (<code class="calibre19">filename</code>) <span><em class="italic">in line</em></span> with my string, <code class="calibre19">Encrypted_#{filename}</code>. I enjoy having the option of including variables in line with a text string, so you will see I use them throughout this book.</p>

    <p class="calibre4">Next, we check to see if the encrypted filename already exists. We don't want the <a class="calibre17" shape="rect"/>script overwriting <a class="calibre17" shape="rect"/>files arbitrarily—data gets lost very easily that way. If there is no conflict, the script continues on <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. Now that the script knows the encrypted file hasn't already been created, an <span><em class="italic">encryption key</em></span>, or password, needs to be provided by the user. The script asks for a key that is between 1 and 56 characters <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. Once all the ncessary information has been collected, the script starts a <code class="calibre19">begin</code>/<code class="calibre19">rescue</code> error-handling block <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. The last and most important piece of the script is the actual encryption of the data. A new encryption object is created with the encryption key passed as an argument <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00007.jpg"/></span>. Then the file is passed to the <code class="calibre19">encrypt_file</code> method, and <span><em class="italic">poof</em></span>—the file is encrypted <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00008.jpg"/></span>. If any errors were encountered during the encryption phase, the rescue block is there to catch them and exit the script gracefully, reporting the specific error <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00009.jpg"/></span>.<a class="calibre17" shape="rect"/></p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_37"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos119276"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">You can modify this script in many different ways. For example, you can make it a modular part of another program, change the encryption algorithm, layer the encryption, automatically delete the plaintext file after encryption, or encrypt entire directories.</p>

    <p class="calibre4">Next, we will look at how to reverse the process and get our information back.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_38"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos119863">
    <h1 class="calibre1" id="calibre_pb_39"><span class="calibre2"><a class="calibre7" shape="rect"/>Decrypt a File</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_40"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos120352"/>Decrypt a File</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>decrypt.rb</h3>
      </div>

      <p class="calibre4">This code is structured much like the encryption algorithm, so I will focus on the differences between the two. I am using the same algorithm for decryption as used during encryption. As mentioned earlier, you can use any number of encryption algorithms—just be sure to use the corresponding decryption algorithm. Don't forget your password, or else you will have to write your own brute force script if you ever want to see your data again!<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_41"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos121496"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> require 'crypt/blowfish'<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       unless ARGV[0]<br class="calibre20"/>&#13;
           puts "Usage: ruby decrypt.rb &lt;Encrypted_filename.ext&gt;"<br class="calibre20"/>&#13;
           puts "Example: ruby decrypt.rb Encrypted_secret.stuff"<br class="calibre20"/>&#13;
             exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <a class="calibre17" shape="rect"/><br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> filename = ARGV[0].chomp<br class="calibre20"/>&#13;
       puts "<a class="calibre17" shape="rect"/>Decrypting #{filename}."<br class="calibre20"/>&#13;
       p = "Decrypted_#{filename}"<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> if File.exists?(p)<br class="calibre20"/>&#13;
           puts "File already exists."<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> print 'Enter your encryption key: '<br class="calibre20"/>&#13;
       kee = gets.chomp<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       begin<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>     blowfish = Crypt::Blowfish.new(kee)<br class="calibre20"/>&#13;
           blowfish.decrypt_file(filename.to_str, p)<br class="calibre20"/>&#13;
           puts 'Decryption SUCCESS!'<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/> rescue Exception =&gt; e<br class="calibre20"/>&#13;
           puts "An error occurred during decryption: \n #{e}"<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_42"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos123143"/>Running the Code</span></h2>
    </div>

    <p class="calibre4">The code is simple to execute; just type the name of decryption script followed by the file you wish to decrypt:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby decrypt.rb</code></strong> <em class="italic"><code class="calibre19">encrypted_filename.ext</code></em></tt></span>
    </div>

    <p class="calibre4">The Ruby script will <a class="calibre17" shape="rect"/>prompt you for the encryption key. Remember that you must have the key used to encrypt the file in order to decrypt it. If you don't, then there is no way to recover the file other than brute force, which can take much longer than you probably want to spend.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_43"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos124286"/>The Results</span></h2>
    </div><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">File Content Before: qo".1[&gt;°&lt;|šã_8tÃhÞí}"f-%◦1ð»=ðrþ¡.,<br class="calibre20"/>
      File Content After: Wicked Cool Ruby Scripts</tt></span>
    </div>

    <p class="calibre4">As expected, the decryption script took the cipher text and cleanly translated it back into plaintext. If you have time, try using the wrong key and examine the output. It will look as cryptic as the cipher text.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_44"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos125086"/>How It Works</span></h2>
    </div>

    <p class="calibre4">The script starts by grabbing the filename from the command-line argument and initializing the variables that will be used <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. Whenever a file is created, you should always check to see if there is already a file with the same name <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. After the algorithms have been initialized, the script will ask for a key <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>.</p>

    <p class="calibre4">Up to this point in the script, everything looks as it did for the encryption script. Even if you type the wrong encryption key, the script will decrypt the file based on that incorrect key, with results as cryptic as they were before. If all goes well, you'll be able use the file that was previously encrypted.</p>

    <p class="calibre4">The actual decryption happens using the <code class="calibre19">decrypt</code> method from the crypt library <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>, which is just the reverse of the encryption.</p>

    <p class="calibre4">If there are no errors or exceptions, the output will display <code class="calibre19">Decryption SUCCESS!</code> and the program will exit. If there is an issue, our <code class="calibre19">begin</code>/<code class="calibre19">rescue</code> block will catch the error and enter our <code class="calibre19">rescue</code> case. The <code class="calibre19">rescue</code> case displays an error message and notifies the user that the file has not yet been decrypted <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>.</p>

    <p class="calibre4">Any modifications you make to the encryption script must also be made to the decryption script. If you do a task in the encryption script and forget to undo it in the decryption script, your data will be history.<a class="calibre17" shape="rect"/></p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_45"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos127646">
    <h1 class="calibre1" id="calibre_pb_46"><span class="calibre2"><a class="calibre7" shape="rect"/>File Splitting</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_47"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos128135"/>File Splitting</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>fileSplit.rb</h3>
      </div>

      <p class="calibre4">A cool use of Ruby scripting is to split a large file into several smaller, symmetric files. I wrote this script for a friend who was having trouble sending files into and out of his corporate network since the network administrators wouldn't allow files over a certain size to be transferred—presumably for bandwidth reasons. This script worked like a charm.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_48"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos129237"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><img alt="" class="calibre23" src="../Images/00002.jpg"/> if ARGV.size != 2<br class="calibre20"/>&#13;
           puts "Usage: ruby fileSplit.rb &lt;filename.ext&gt; &lt;size_of_pieces_in_bytes&gt;"<br class="calibre20"/>&#13;
           puts "Example: ruby fileSplit.rb myfile.txt 10"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       filename = ARGV[0]<br class="calibre20"/>&#13;
       size_of_split = ARGV[1]<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> if File.exists?(filename)<br class="calibre20"/>&#13;
           file = File.open(filename, "r")<br class="calibre20"/>&#13;
           size = size_of_split.to_i<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
           puts "The file is #{File.size(filename)} bytes."<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/>     temp = File.size(filename).divmod(size)<br class="calibre20"/>&#13;
           pieces = temp[0]<br class="calibre20"/>&#13;
           extra = temp[1]<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
           puts "\nSplitting the file into #{pieces} (#{size} byte) pieces and 1<br class="calibre20"/>&#13;
       (#{extra} byte) piece"<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>     pieces.times do |n|<br class="calibre20"/>&#13;
               f = File.open("#{filename}.rsplit#{n}", "w")<br class="calibre20"/>&#13;
               f.puts file.read(size)<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>     e = File.open("#{filename}.rsplit#{pieces}", "w")<br class="calibre20"/>&#13;
           e.puts file.read(extra)<br class="calibre20"/>&#13;
       else<br class="calibre20"/>&#13;
           puts "\n\nFile does NOT exist, please check filename."<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_49"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos131168"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">It's easiest to run this script in a fresh directory with the file you want to split. Like the previous scripts, start by typing:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby <a class="calibre17" shape="rect"/>fileSplit.rb</code></strong> <em class="italic"><code class="calibre19">path/to/file size_of_pieces_in_bytes</code></em></tt></span>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">If you want to split up a 10KB file into 1,000-byte (or 1KB) pieces, the script will make 10 separate files labeled <span><em class="italic">&lt;filename&gt;.rsplit&lt;#1-10&gt;</em></span>. To do this, type:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby fileSplit.rb test.txt 1000</code></strong></tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_50"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos132523"/>The Results</span></h2>
    </div>

    <p class="calibre4">The initial file used in this example is called <span><em class="italic">test.txt</em></span>, and the results are shown below:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">test.txt.rsplit0<br class="calibre20"/>
      test.txt.rsplit1<br class="calibre20"/>
      test.txt.rsplit2<br class="calibre20"/>
      test.txt.rsplit3<br class="calibre20"/>
      test.txt.rsplit4<br class="calibre20"/>
      test.txt.rsplit5<br class="calibre20"/>
      test.txt.rsplit6<br class="calibre20"/>
      test.txt.rsplit7<br class="calibre20"/>
      test.txt.rsplit8<br class="calibre20"/>
      test.txt.rsplit9</tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_51"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos133353"/>How It Works</span></h2>
    </div>

    <p class="calibre4">If you are faced with a pesky corporate network policy that has limited the size of files allowed to be transferred, or if you are looking for a more reliable way to transfer <a class="calibre17" shape="rect"/>large files, this utility will save the day. I was faced with the corporate scenario, and I knew the file size limit, so I was able to hard code the file sizes. However, you can use whatever size you need or make it an option in the script.</p>

    <p class="calibre4">The script starts by reading the first two items out of the ARGV array: the name of the file to split and the size of each section. If the two variables, <code class="calibre19">filename</code> and <code class="calibre19">size</code>, aren't specified, the script will display <code class="calibre19">correct usage</code><span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>.</p>

    <p class="calibre4">Next, the script ensures that you are trying to split a real file <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. It's tough to divide by zero and even more difficult to split a file that doesn't exist. If the file cannot be found, the script exits and displays an error message letting the user know something is wrong with the filename. Hopefully, the file is found, and the script begins to set up for the splits.</p>

    <p class="calibre4">As you know, files can be any size, and rarely are they perfectly divisible by whatever number of bytes you chose. In order to deal with dynamic file sizes, the script uses <code class="calibre19">divmod</code>—<code class="calibre19">divmod</code> will divide two numbers, passing back an array containing the quotient and modulus. In this script, <code class="calibre19">pieces</code> is the quotient and the <code class="calibre19">extra</code> is the modulus <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>.<a class="calibre17" shape="rect"/></p>

    <p class="calibre4">To maintain the file's integrity, the split pieces are created by reading in one byte at a time and writing binary to the output. This section is where the magic happens <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. The whole pieces are written first, and then the extra piece <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_52"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos136487"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">If you want to extend the code, a perfect addition would be to add a compression routine before the file is split. I'll talk more about compression later. Another spin on this script, giving it more flexibility, is to add an option for <a class="calibre17" shape="rect"/>splitting the file into a specific number of pieces, regardless of the size. You could also modify this script to create file pieces sized to the media format of your choice, whether it's 700MB CDs or 2.88MB floppies.<a class="calibre17" shape="rect"/></p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_53"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos137202">
    <h1 class="calibre1" id="calibre_pb_54"><span class="calibre2"><a class="calibre7" shape="rect"/>File Joining</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_55"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos137689"/>File Joining</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>fileJoin.rb</h3>
      </div>

      <p class="calibre4">This script was also written for my friend, knowing he would be pretty upset if he didn't have a way to reconstruct his files. This is a companion script for the file-<a class="calibre17" shape="rect"/>splitting one, and both scripts can be put together in a <a class="calibre17" shape="rect"/>wrapper if you prefer. (A <span><em class="italic">wrapper</em></span> is code that brings both scripts together in one utility.) I separated them here for instructional purposes. This file-joining script will only work for files that were previously split (see "#4 File Splitting" on <a class="calibre6" href="../Text/dummy_split_033.html#filepos127646" shape="rect">File Splitting</a>); however, you can adjust it to suit your needs.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_56"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos139165"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><img alt="" class="calibre23" src="../Images/00002.jpg"/> if ARGV.size != 1<br class="calibre20"/>&#13;
           puts "Usage: ruby fileJoin.rb &lt;filename.ext&gt;"<br class="calibre20"/>&#13;
           puts "Example: ruby fileJoin.rb myfile.txt"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       file = ARGV[0]<br class="calibre20"/>&#13;
       piece = 0<br class="calibre20"/>&#13;
       orig_file = "New.#{file}"<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> if File.exists?("#{file}.rsplit#{piece}")<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/>     ofile = File.open(orig_file, "w")<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>     while File.exists?("#{file}.rsplit#{piece}")<br class="calibre20"/>&#13;
               puts "Reading File: #{file}.rsplit#{piece}"<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>         ofile &lt;&lt; File.open("#{file}.rsplit#{piece}","r").read.chomp<br class="calibre20"/>&#13;
               piece+=1<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
           ofile.close<br class="calibre20"/>&#13;
           puts "\nSUCCESS!  File reconstructed."<br class="calibre20"/>&#13;
       else<br class="calibre20"/>&#13;
           puts "\n\nCould not find #{file}.rsplit#{piece}."<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_57"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos140771"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">The script does not support a change in directory, so make sure it is located in the same directory as the <a class="calibre17" shape="rect"/>files you want to join. To run the script, type:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby fileJoin.rb</code></strong> <em class="italic"><code class="calibre19">filename.ext</code></em></tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_58"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos141610"/>The Results</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">Using the files output by the file-splitting script, the input should be the name of the file to be reassembled as shown below:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19">Reading File: test.txt.rsplit0<br class="calibre20"/>&#13;
      Reading File: test.txt.rsplit1<br class="calibre20"/>&#13;
      Reading File: test.txt.rsplit2<br class="calibre20"/>&#13;
      Reading File: test.txt.rsplit3<br class="calibre20"/>&#13;
      Reading File: test.txt.rsplit4<br class="calibre20"/>&#13;
      Reading File: test.txt.rsplit5<br class="calibre20"/>&#13;
      Reading File: test.txt.rsplit6<br class="calibre20"/>&#13;
      Reading File: test.txt.rsplit7<br class="calibre20"/>&#13;
      Reading File: test.txt.rsplit8<br class="calibre20"/>&#13;
      Reading File: test.txt.rsplit9<br class="calibre20"/>&#13;
      SUCCESS!  File Reconstructed.</tt></span>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">After the script has run, the assembled file will be called <span><em class="italic">New.test.txt</em></span>.</p>&#13;
&#13;
    <p class="calibre4">The new file that was joined will be found in the same directory as the script. Each <span><em class="italic">.rsplit</em></span> piece will still exist, in case there were any errors reconstructing the file. Once you locate the file and open it, the contents should be exactly as they were before you split the file. You can compare the old and new MD5 hashes to see for yourself (see "#1 Check for Changed Files" on <a class="calibre6" href="../Text/dummy_split_013.html#filepos92614" shape="rect">Check for Changed Files</a>).</p>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_59"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos143389"/>How It Works</span></h2>
    </div>

    <p class="calibre4">The script starts by getting the original filename of the file that was split. If a name was not provided as a command-line argument, the script will complain, and you'll have to try again <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. If a filename is provided, then the script checks to see if there are any pieces that correspond to that filename <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. If not, it will again complain, saying the file couldn't be found.</p>

    <p class="calibre4">After the first piece is located, the script creates the output file <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. Next, a while loop is used to ensure that only the next consecutive piece is appended to the main body <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. As long as there is a "next piece," the script will continue appending to the output file. Since the data of each split piece has a newline at the end, we use the <code class="calibre19">chomp</code> method to ensure only raw data is being streamed <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>.</p>

    <p class="calibre4">The output file is closed after all the pieces have been appended to it. A nice success message is displayed and the script exits. Now you can check the new file to verify that it is perfectly restored.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_60"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos145496"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">If you trust the script, you can tweak it to clean up after itself, erasing all of the .<span><em class="italic">rsplit</em></span> pieces. You could also compute the MD5 hash of the file before and after the split to verify its authenticity.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_61"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos145952">
    <h1 class="calibre1" id="calibre_pb_62"><span class="calibre2"><a class="calibre7" shape="rect"/>Windows Process Viewer</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_63"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos146449"/>Windows Process Viewer</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>listWin Processes.rb</h3>
      </div>

      <p class="calibre4">The process viewer in Windows <a class="calibre17" shape="rect"/>Task Manager can be extremely frustrating, due to a lack of information. If you have ever used the <code class="calibre19">ps</code> command on a Unix-like system, you know how much more information is available besides the process name, CPU/memory usage, and process owner. Some applications make nice, detailed entries in the process viewer, and those tasks are easy to identify, but other applications have some ambiguous name that doesn't do you any favors. Having an alternative way to view the processes is handy because you can customize the script to show exactly what is important to you. This script demonstrates how to retrieve every available process property.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_64"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos147951"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><img alt="" class="calibre23" src="../Images/00002.jpg"/> require 'win32ole'<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/>     ps = WIN32OLE.connect("winmgmts:\\\\.")<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/>     ps.InstancesOf("win32_process").each do |p|<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>     puts "Process: #{p.name}"<br class="calibre20"/>&#13;
           puts "\tID: #{p.processid}"<br class="calibre20"/>&#13;
           puts "\tPATH:#{p.executablepath}"<br class="calibre20"/>&#13;
           puts "\tTHREADS: #{p.threadcount}"<br class="calibre20"/>&#13;
           puts "\tPRIORITY: #{p.priority}"<br class="calibre20"/>&#13;
           puts "\tCMD_ARGS: #{p.commandline}"<br class="calibre20"/>&#13;
         end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_65"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos149071"/>Running the Code</span></h2>
    </div>

    <p class="calibre4">The script is written so that it runs autonomously and displays information about each process. Add and remove properties in the script as needed.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_66"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos149654"/>The Results</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19">Process: winlogon.exe<br class="calibre20"/>&#13;
          ID: 1296<br class="calibre20"/>&#13;
          PATH:C:\WINDOWS\system32\winlogon.exe<br class="calibre20"/>&#13;
          THREADS: 22<br class="calibre20"/>&#13;
          PRIORITY: 13<br class="calibre20"/>&#13;
          CMD_ARGS: winlogon.exe<br class="calibre20"/>&#13;
      Process: services.exe<br class="calibre20"/>&#13;
          ID: 1348<br class="calibre20"/>&#13;
          PATH:C:\<a class="calibre17" shape="rect"/>WINDOWS\system32\services.exe<br class="calibre20"/>&#13;
          THREADS: 15<br class="calibre20"/>&#13;
          PRIORITY: 9<br class="calibre20"/>&#13;
          CMD_ARGS: C:\WINDOWS\system32\services.exe<br class="calibre20"/>&#13;
      Process: explorer.exe<br class="calibre20"/>&#13;
          ID: 1240<br class="calibre20"/>&#13;
          PATH:C:\WINDOWS\Explorer.EXE<br class="calibre20"/>&#13;
          THREADS: 14<br class="calibre20"/>&#13;
          PRIORITY: 8<br class="calibre20"/>&#13;
          CMD_ARGS: C:\WINDOWS\Explorer.EXE<br class="calibre20"/>&#13;
      Process: svchost.exe<br class="calibre20"/>&#13;
          ID: 3836<br class="calibre20"/>&#13;
          PATH:C:\WINDOWS\System32\svchost.exe<br class="calibre20"/>&#13;
          THREADS: 8<br class="calibre20"/>&#13;
          PRIORITY: 8<br class="calibre20"/>&#13;
          CMD_ARGS: C:\WINDOWS\System32\svchost.exe -k HTTPFilter<br class="calibre20"/>&#13;
      Process: firefox.exe<br class="calibre20"/>&#13;
          ID: 2140<br class="calibre20"/>&#13;
          PATH:C:\Program Files\Mozilla Firefox\firefox.exe<br class="calibre20"/>&#13;
          THREADS: 7<br class="calibre20"/>&#13;
          PRIORITY: 8<br class="calibre20"/>&#13;
          CMD_ARGS: "C:\Program Files\Mozilla Firefox\firefox.exe"<br class="calibre20"/>&#13;
      Process: cmd.exe<br class="calibre20"/>&#13;
          ID: 1528<br class="calibre20"/>&#13;
          PATH:C:\WINDOWS\system32\cmd.exe<br class="calibre20"/>&#13;
          THREADS: 1<br class="calibre20"/>&#13;
          PRIORITY: 8<br class="calibre20"/>&#13;
          CMD_ARGS: "C:\WINDOWS\system32\cmd.exe"<br class="calibre20"/>&#13;
      Process: ruby.exe<br class="calibre20"/>&#13;
          ID: 244<br class="calibre20"/>&#13;
          PATH:c:\ruby\bin\ruby.exe<br class="calibre20"/>&#13;
          THREADS: 4<br class="calibre20"/>&#13;
          PRIORITY: 8<br class="calibre20"/>&#13;
          CMD_ARGS: ruby ListWinProcesses.rb</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_67"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos151835"/>How It Works</span></h2>
    </div>

    <p class="calibre4">For most interactions with the Windows Operating System, I use the <a class="calibre17" shape="rect"/>win32ole library <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. This library is very useful, and I'll demonstrate more automation with it in later chapters. The first part <a class="calibre17" shape="rect"/>of the script is the initialization of <span><em class="italic">winmgmts</em></span>, which lets the script interact with the Windows internal methods <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. <span><em class="italic">Winmgmts</em></span> is the <span><em class="italic">Windows Management Interface (WMI)</em></span>. <a class="calibre17" shape="rect"/>WMI has a lot of useful tools that you can explore further if you're interested in scripting for Windows. I called my instance of WMI <code class="calibre19">ps</code> because it reminds me of the <code class="calibre19">ps</code> method in Unix-style systems.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>

    <p class="calibre4">Next, the script iterates all instances of <code class="calibre19">win32_process</code>. This is where all of the processes are found and information can be extracted <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. The properties I used for the script are <code class="calibre19">process name, id, path, threads running</code>, <code class="calibre19">priority</code>, and <code class="calibre19">command line arguments</code>. I find knowing command-line arguments useful in case I want to invoke the program from some other script or from the command line <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>.<a class="calibre17" shape="rect"/></p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_68"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos154321"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">If you want to view everything about each process, you can include the properties listed below from the WMI <a class="calibre17" shape="rect"/>properties class. There are a lot of possible configurations to suit your needs.</p>

    <div class="calibre3">
      <table border="1" class="calibre26">
        <colgroup class="calibre27" span="1">
          <col class="calibre28" span="1"/>
          <col class="calibre28" span="1"/>
          <col class="calibre28" span="1"/>
        </colgroup>

        <thead class="calibre29">
          <tr class="calibre30">
            <th class="calibre31" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre18 bold">WMI Process Class Properties</span></p>
            </th>

            <th class="calibre31" colspan="1" rowspan="1">
              <p class="calibre4"/>
            </th>

            <th class="calibre31" colspan="1" rowspan="1">
              <p class="calibre4"/>
            </th>
          </tr>
        </thead>

        <tbody class="calibre33">
          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">Caption</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">OSCreationClassName</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">QuotaPeakPagedPoolUsage</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">CommandLine</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">OSName</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">ReadOperationCount</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">CreationClassName</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">OtherOperationCount</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">ReadTransferCount</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">CreationDate</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">OtherTransferCount</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">SessionId</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">CSCreationClassName</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">PageFaults</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">Status</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">CSName</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">PageFileUsage</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">TerminationDate</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">Description</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">ParentProcessId</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">ThreadCount</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">ExecutablePath</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">PeakPageFileUsage</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">UserModeTime</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">ExecutionState</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">PeakVirtualSize</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">VirtualSize</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">Handle</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">PeakWorkingSetSize</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">WindowsVersion</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">HandleCount</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">Priority</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">WorkingSetSize</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">InstallDate</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">PrivatePageCount</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">WriteOperationCount</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">KernelModeTime</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">ProcessId</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">WriteTransferCount</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">MaximumWorkingSetSize</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">QuotaNonPagedPoolUsage</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">WorkingSetSize</code></span></p>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">MinimumWorkingSetSize</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">QuotaPagedPoolUsage</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"/>
            </td>
          </tr>

          <tr class="calibre30">
            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">Name</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"><span class="calibre32"><code class="calibre19">QuotaPeakNonPagedPoolUsage</code></span></p>
            </td>

            <td border="1" class="calibre34" colspan="1" rowspan="1">
              <p class="calibre4"/>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <p class="calibre4">While the list above contains all the properties for the WMI process class, there are several other operating system classes—each with its own properties. To use the same script with a different operating system class, replace the <code class="calibre19">win32_process</code> at <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span> with another WMI class. For example, <code class="calibre19">registry</code> would be <code class="calibre19">win32_registry</code>.<a class="calibre17" shape="rect"/></p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_69"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos166354">
    <h1 class="calibre1" id="calibre_pb_70"><span class="calibre2"><a class="calibre7" shape="rect"/>File Compressor</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_71"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos166844"/>File Compressor</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>compress.rb</h3>
      </div>

      <p class="calibre4">Being able to effectively compress a file is a serious asset when you start talking about data storage. The more efficient the <a class="calibre17" shape="rect"/>compression, the more information can be stored in the same amount of space. There are two popular Ruby <a class="calibre17" shape="rect"/>compression libraries in use today. The first is <a class="calibre17" shape="rect"/>ruby-zlib, and the second is <a class="calibre17" shape="rect"/>rubyzip. Both have their advantages and disadvantages, and I'll leave it to you to choose a compression algorithm that fits your purpose. I will be using rubyzip in the following script.</p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_72"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos168121"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> require 'zip/zip'<br class="calibre20"/>&#13;
      <a class="calibre17" shape="rect"/><br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> unless ARGV[0]<br class="calibre20"/>&#13;
           puts "Usage: ruby compress.rb &lt;filename.ext&gt;"<br class="calibre20"/>&#13;
           puts "Example: ruby compress.rb myfile.exe"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       file = ARGV[0].chomp<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> if File.exists?(file)<br class="calibre20"/>&#13;
           print "Enter zip filename:"<br class="calibre20"/>&#13;
           zip = "#{gets.chomp}.zip"<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/>     Zip::ZipFile.open(zip, true) do |zipfile|<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>        begin<br class="calibre20"/>&#13;
                  puts "#{file} is being added to the archive."<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>        zipfile.add(file,file)<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00007.jpg"/>        rescue Exception =&gt; e<br class="calibre20"/>&#13;
                  puts "Error adding to zipfile: \n #{e}"<br class="calibre20"/>&#13;
              end<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
       else<br class="calibre20"/>&#13;
           puts "\nFile could not be found."<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_73"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos169858"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">This script allows users to compress different file types, either to save space or for easy archiving. Call the script with the following command:</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby compress.rb</code></strong> <em class="italic"><code class="calibre19">/path/to/file</code></em></tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_74"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos170651"/>The Results</span></h2>
    </div>

    <p class="calibre4">The script will create a compressed archive of the file specified on the command line using the name the user provides at the prompt. For this example, I compressed <span><em class="italic">chapter1.odt</em></span> into <span><em class="italic">nostarch.zip</em></span>. Before <a class="calibre17" shape="rect"/>compression, <span><em class="italic">chapter1.odt</em></span> was 29.1KB, and after the <a class="calibre17" shape="rect"/>compression, it was 26.3KB. The file will be stored in the same directory as the script is executed.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_75"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos171632"/>How It Works</span></h2>
    </div>

    <p class="calibre4">When the script is run, the first <a class="calibre17" shape="rect"/>error handling check is made to ensure the user has provided a file to compress <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. If a filename has been provided, the file is checked for availability. As always, there is no sense in continuing if the object we want to manipulate is not available. If the file doesn't exist, the script alerts the user and promptly exits <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. If the file does exist and has been validated, the user is asked to name the Zip file. After the user types the filename and presses ENTER, the script continues. That press of the ENTER key is added to the character stream and, in turn, sent to the script as user input. You'll note that <code class="calibre19">chomp</code> is used to remove the <code class="calibre19">\n</code> (<span><em class="italic">newline character</em></span>) that is added when the user strikes ENTER.<a class="calibre17" shape="rect"/></p>

    <p class="calibre4">The code used to compress the file is straightforward. As seen above on line <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>, the section will open an existing Zip file if it is available and the second parameter is set to <code class="calibre19">true</code>. A new Zip file will be created if the file doesn't already exist. These options are similar to the <code class="calibre19">open</code> method in the File library.</p>

    <p class="calibre4">Sometimes errors happen. The most vulnerable spot in this script is during the <a class="calibre17" shape="rect"/>compression while adding files to the Zip file. The <code class="calibre19">begin</code>/<code class="calibre19">rescue</code> block at <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span> is used to handle unforeseen errors and provide information to the user about any issues. If an error does occur, the <code class="calibre19">rescue</code> block will be executed and the script will exit, displaying the error message <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00007.jpg"/></span>.</p>

    <p class="calibre4">Each file that is being added to the Zip file is saved using the <code class="calibre19">add</code> method <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. You can create directories in the Zip file from this section or write entirely new files on the fly. Basically, the Zip filesystem can be treated like any normal directory on your computer. The syntax is a little different, but the results are the same.</p>

    <p class="calibre4">The <a class="calibre17" shape="rect"/>rubyzip library is wonderful because you can open the Zip file and manipulate the contents without having to decompress the entire archive. Also, instead of grouping files and then compressing them, as tar and gz do, rubyzip will do all of this with just one command.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_76"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos175311">
    <h1 class="calibre1" id="calibre_pb_77"><span class="calibre2"><a class="calibre7" shape="rect"/>File Decompression</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_78"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos175804"/>File Decompression</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>decompress.rb</h3>
      </div>

      <p class="calibre4">This script shows you the basics of <a class="calibre17" shape="rect"/>decompressing a file. The rubyzip library does all of the work for you. On a standard Unix-like system, you would have to manually unzip the file, carry out your task, and then re-compress the file. With rubyzip, you can work with files in an archive using one seamless library. This script completely decompresses an archive into the user-specified directory.<a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/><a class="calibre17" shape="rect"/></p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_79"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos176986"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> require 'zip/zip'<br class="calibre20"/>&#13;
       require 'fileutils'<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       unless ARGV[0]<br class="calibre20"/>&#13;
           puts "Usage: ruby decompress.rb &lt;zipfilename.zip&gt;"<br class="calibre20"/>&#13;
           puts "Example: ruby decompress.rb myfile.zip"<br class="calibre20"/>&#13;
           exit<br class="calibre20"/>&#13;
       end<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
       archive = ARGV[0].chomp<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> if File.exists?(archive)<br class="calibre20"/>&#13;
           print "Enter path to save files to (\'.\' for same directory): "<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/>     extract_dir = gets.chomp<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/>     begin<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/>         Zip::ZipFile::open(archive) do |zipfile|<br class="calibre20"/>&#13;
                   zipfile.each do |f|<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00006.jpg"/>                 path = File.join(extract_dir, f.name)<br class="calibre20"/>&#13;
                       FileUtils.mkdir_p(File.dirname(path))<br class="calibre20"/>&#13;
                       zipfile.extract(f, path)<br class="calibre20"/>&#13;
                   end<br class="calibre20"/>&#13;
               end<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00007.jpg"/>     rescue Exception =&gt; e<br class="calibre20"/>&#13;
               puts e<br class="calibre20"/>&#13;
           end<br class="calibre20"/>&#13;
       else<br class="calibre20"/>&#13;
           puts "An error occurred during decompression: \n #{e}"<br class="calibre20"/>&#13;
       end</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_80"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos178997"/>Running the Code</span></h2>&#13;
    </div>&#13;
&#13;
    <p class="calibre4">The decompression script is invoked like the compression script, with the file to decompress as the command-line argument.</p><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"><strong class="calibre22"><code class="calibre19">ruby decompress.rb</code></strong> <em class="italic"><code class="calibre19">/path/to/compressed/file</code></em></tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_81"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos179778"/>The Results</span></h2>
    </div>

    <p class="calibre4">All <a class="calibre17" shape="rect"/>files that were originally put into the Zip file will be decompressed in the same structure they had before compression. For this example, I decompressed <span><em class="italic">nostarch.zip</em></span> into <span><em class="italic">chapter1.odt</em></span>. The compressed Zip file <span><em class="italic">chapter1.odt</em></span> was 26.3KB, and after decompression, the file went back to the original 29.1KB.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_82"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos180671"/>How It Works</span></h2>
    </div>

    <p class="calibre4">Similar to the compression script, this script expects the zipped file to be provided as a command-line argument. If the archive file cannot be located, the script will present the user with an error message <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>. The major difference between the scripts is that, instead of asking for the name of the Zip file to be created, the decompression script requests the target path where the unzipped files should go <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>.</p>

    <p class="calibre4">The next step is the start of a <code class="calibre19">begin</code>/<code class="calibre19">rescue</code> block <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. As with the compression script, the decompression is a vulnerable section of code. The first part of decompression is to open the zipped file <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>. After that, each file is decompressed. The decompression routine recreates the directory structure as it was before compression <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00006.jpg"/></span>. So, if there were two subfolders before compression, there will also be two folders after this script has completed. As long as no errors are encountered, the script will output each file into the directory specified by the user. The last part of the script is the <code class="calibre19">rescue</code> block, which will catch and report any errors that occur during decompression <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00007.jpg"/></span>.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_83"/>


  <div class="calibre3 calibre3 calibre3 calibre3" id="filepos182843">
    <h1 class="calibre1" id="calibre_pb_84"><span class="calibre2"><a class="calibre7" shape="rect"/>Mortgage Calculator</span></h1>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_85"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos183337"/>Mortgage Calculator</span></h2>
    </div>

    <div class="calibre3">
      <div class="calibre3 calibre3 calibre3">
        <h3 class="calibre16" id="heading_id_2"><a class="calibre7" shape="rect"/>mortgageCalc.rb</h3>
      </div>

      <p class="calibre4">I recently began house shopping. Being a first-time home buyer, the task seemed daunting, especially when I considered the <a class="calibre17" shape="rect"/>financing options. So, I decided to write a script to help me get a handle on <a class="calibre17" shape="rect"/>mortgage rates—at least this way, I could estimate my monthly payments. Even though Ruby didn't solve all of the issues related to buying a home, this script helped me get a handle on my financing options.</p>
    </div>
  </div>


  <div class="calibre3">&#13;
    <div class="calibre3 calibre3 calibre3">&#13;
      <h2 class="calibre8" id="calibre_pb_86"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos184457"/>The Code</span></h2>&#13;
    </div><a class="calibre17" shape="rect"/>&#13;
&#13;
    <div class="calibre3">&#13;
      <span class="calibre18"><tt class="calibre19"> print "Enter Loan amount: "<br class="calibre20"/>&#13;
       loan = gets.chomp.to_i<br class="calibre20"/>&#13;
       print "Enter length of time in months: "<br class="calibre20"/>&#13;
       time = gets.chomp.to_i<br class="calibre20"/>&#13;
       print "Enter interest rate: "<br class="calibre20"/>&#13;
       rate = gets.chomp.to_f/100<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00002.jpg"/> i = (1+rate/12)**(12/12)-1<br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00003.jpg"/> annuity = (1-(1/(1+i))**time)/i<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00004.jpg"/> payment = loan/annuity<br class="calibre20"/>&#13;
      <br class="calibre20"/>&#13;
      <img alt="" class="calibre23" src="../Images/00005.jpg"/> puts "\n$%.2f per month" % [payment]</tt></span>&#13;
    </div>&#13;
  </div>&#13;


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_87"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos185465"/>Running the Code</span></h2>
    </div>

    <p class="calibre4">This script is interactive and therefore runs without any parameters. It walks the user through each piece of information needed to come up with the correct monthly payment. No command-line arguments are needed.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_88"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos186038"/>The Results</span></h2>
    </div><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">Enter Loan amount: <em class="italic"><code class="calibre19">250000</code></em><br class="calibre20"/>
      Enter length of time in months: <em class="italic"><code class="calibre19">360</code></em><br class="calibre20"/>
      Enter interest rate: <em class="italic"><code class="calibre19">6.5</code></em><br class="calibre20"/>
      <br class="calibre20"/>
      $1580.17 per month</tt></span>
    </div>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_89"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos186758"/>How It Works</span></h2>
    </div>

    <p class="calibre4">Mortgage calculations always seemed a bit cryptic to me, and I thought I needed a wall of degrees to understand the formulas. Thankfully, calculating a mortgage payment isn't like solving differential equations! It's quite a bit easier, once you understand the basic formulas. The calculations of a mortgage payment are broken down into two main formulas (that can be combined into one formula, if you are feeling especially daring). The first calculates the <span><em class="italic">interest rate</em></span> per month using the following equation <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00002.jpg"/></span>(don't forget that <code class="calibre19">**</code> is the Ruby way of expressing exponentiation):</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">i = (1+rate/12)**(12/12)-1</tt></span>
    </div>

    <p class="calibre4">The next piece of information that we need is the annuity factor <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00003.jpg"/></span>. Basically, the <span><em class="italic">annuity factor</em></span> is the current value of $1 for each period of time. The <span><em class="italic">time</em></span> is received in months. So, the calculations are:</p><a class="calibre17" shape="rect"/>

    <div class="calibre3">
      <span class="calibre18"><tt class="calibre19">annuity = (1-(1/(1+i))**time)/i</tt></span>
    </div>

    <p class="calibre4">Now that the annuity factor has been computed, monthly payments are really what we are after. A simple division of the loan by the annuity factor will reveal the final answer <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00004.jpg"/></span>. All that's left is some formatting to make the information easier to read. As with other programming languages, Ruby gives programmers the ability to specify how output should be formatted. In this case, for monetary values, I am interested in two decimal places for the cents in addition to the <span><em class="italic">integer</em></span>, or whole dollar, value <span><a class="calibre17" shape="rect"/><img alt="" class="calibre23" src="../Images/00005.jpg"/></span>.</p>
  </div>


  <div class="calibre3">
    <div class="calibre3 calibre3 calibre3">
      <h2 class="calibre8" id="calibre_pb_90"><span class="calibre9"><a class="calibre7" shape="rect"/><a class="calibre7" id="filepos189605"/>Hacking the Script</span></h2>
    </div>

    <p class="calibre4">One way to hack this script would be to give a variance of interest rates or loan amounts, so the output could display several possible monthly payments instead of just one—maybe +/-0.05 percent. Usually, when you are looking for a mortgage, you compare a lot of financial information. The more information you can present in one interface, the better the decision you can make.</p>
  </div>

  <div class="mbppagebreak" id="calibre_pb_91"/>
</body></html>