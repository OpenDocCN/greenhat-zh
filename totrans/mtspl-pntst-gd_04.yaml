- en: Chapter 4. Vulnerability Scanning
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: A *vulnerability scanner* is an automated program designed to look for weaknesses
    in computers, computer systems, networks, and applications. The program probes
    a system by sending data to it over a network and analyzing the responses received,
    in an effort to enumerate any vulnerabilities present on the target by using its
    vulnerability database as reference.
  prefs: []
  type: TYPE_NORMAL
- en: Various operating systems tend to respond differently when sent particular network
    probes because of the different networking implementations in use. These unique
    responses serve as a fingerprint that the vulnerability scanner uses to determine
    the operating system version and even its patch level. A vulnerability scanner
    can also use a given set of user credentials to log into the remote system and
    enumerate the software and services to determine whether they are patched. With
    the results it obtains, the scanner presents a report outlining any vulnerabilities
    detected on the system. That report can be useful for both network administrators
    and penetration testers.
  prefs: []
  type: TYPE_NORMAL
- en: Vulnerability scanners generally create a lot of traffic on a network and are
    therefore not typically used in a penetration test when one of the objectives
    is to remain undetected. If, however, you are running a penetration test and stealth
    is not an issue, a vulnerability scanner can save you from having to probe systems
    manually to determine their patch levels and vulnerabilities.
  prefs: []
  type: TYPE_NORMAL
- en: Whether you use an automated scanner or do it manually, scanning is one of the
    most important steps in the penetration testing process; if done thoroughly, it
    will provide the best value to your client. In this chapter, we will discuss a
    number of vulnerability scanners and how they can be integrated within Metasploit.
    We’ll highlight some auxiliary modules in the Metasploit Framework that can locate
    specific vulnerabilities in remote systems.
  prefs: []
  type: TYPE_NORMAL
- en: The Basic Vulnerability Scan
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Let’s look at how a scan works at the most basic level. In the following listing,
    we use *netcat* to grab a banner from the target 192.168.1.203\. *Banner grabbing*
    is the act of connecting to a remote network service and reading the service identification
    (banner) that is returned. Many network services such as web, file transfer, and
    mail servers return their banner either immediately upon connecting to them or
    in response to a specific command. Here we connect to a web server on TCP port
    80 and issue a `GET HTTP` request that allows us to look at the header information
    that the remote server returns in response to our request.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: The information returned at ![](../images/00002.gif) tells us that the system
    running on port 80 is a Microsoft IIS 5.1–based web server. Armed with this information,
    we could use a vulnerability scanner, as shown in [Figure 4-1](part0008.html#vulnerability_scan_results_against_the_t),
    to determine whether this version of IIS has any vulnerabilities associated with
    it and whether this particular server has been patched.
  prefs: []
  type: TYPE_NORMAL
- en: 'Of course, in practice, it’s not that simple. Vulnerability scans often contain
    many *false positives* (reported vulnerability where none exists) and *false negatives*
    (failure to log a vulnerability where one exists) due to subtle differences in
    system and application configurations. In addition, the creators of vulnerability
    scanners have an incentive to report positives: The more “hits” a vulnerability
    scanner finds, the better it looks to a potential buyer. Vulnerability scanners
    are only as good as their vulnerabilities database, and they can easily be fooled
    by misleading banners or inconsistent configurations.'
  prefs: []
  type: TYPE_NORMAL
- en: Let’s take a look at some of the more useful vulnerability scanners, including
    NeXpose, Nessus, and some specialized scanners.
  prefs: []
  type: TYPE_NORMAL
- en: '![Vulnerability scan results against the target web server](../images/00008.jpeg)Figure 4-1. Vulnerability
    scan results against the target web server'
  prefs: []
  type: TYPE_NORMAL
- en: Scanning with NeXpose
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: NeXpose is Rapid7’s vulnerability scanner that scans networks to identify the
    devices running on them and performs checks to identify security weaknesses in
    operating systems and applications. It then analyzes the scan data and processes
    it for inclusion in various reports.
  prefs: []
  type: TYPE_NORMAL
- en: Rapid7 offers multiple versions of NeXpose, but we’ll use the Community edition
    because it’s free. If you plan to use NeXpose commercially, see the Rapid7 site
    ([http://www.rapid7.com/vulnerability-scanner.jsp](http://www.rapid7.com/vulnerability-scanner.jsp))
    for information on the various versions and their capabilities and pricing.
  prefs: []
  type: TYPE_NORMAL
- en: Our target for scanning will be a default installation of Windows XP SP2 as
    configured in [Appendix A](part0022.html#configuring_your_target_machines). We
    will first perform a basic overt scan of our target and import the vulnerability
    scan results into Metasploit. We will close out this section by showing you how
    to run a NeXpose vulnerability scan directly from *msfconsole* rather than using
    the web-based GUI, eliminating the need to import a scan report.
  prefs: []
  type: TYPE_NORMAL
- en: Configuration
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: After installing NeXpose Community, open a web browser and navigate to *https://<youripaddress>:3780*.
    Accept the NeXpose self-signed certificate, and log in using the credentials you
    created during setup. You should next be presented with an interface similar to
    the one shown in [Figure 4-2](part0008.html#the_nexposeas_initial_home_screen).
    (You’ll find complete installation instructions for NeXpose at the Rapid7 website.)
  prefs: []
  type: TYPE_NORMAL
- en: 'On the NeXpose main page, you will notice a number of tabs at the top of the
    interface:'
  prefs: []
  type: TYPE_NORMAL
- en: The Assets tab ![](../images/00002.gif) displays details of computers and other
    devices on your network after they have been scanned.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The Reports tab ![](../images/00004.gif) lists vulnerability scan reports after
    they have been generated.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The Vulnerabilities tab ![](../images/00005.gif) gives you details on any vulnerabilities
    discovered during your scans.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The Administration tab ![](../images/00006.gif) allows you to configure various
    options.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![The NeXpose’s initial home screen](../images/00009.jpeg)Figure 4-2. The NeXpose’s
    initial home screen'
  prefs: []
  type: TYPE_NORMAL
- en: Buttons in the main body of the page let you perform common tasks such as creating
    a new site or setting up a new vulnerability scan.
  prefs: []
  type: TYPE_NORMAL
- en: The New Site Wizard
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Prior to running a vulnerability scan with NeXpose, you need to configure a
    *site* — a logical collection of devices such as a specific subnet, a collection
    of servers, or even a single workstation. These sites will then be scanned by
    NeXpose, and different scan types can be defined for a particular site.
  prefs: []
  type: TYPE_NORMAL
- en: To create a site, click the **New Site** button on the NeXpose home page, enter
    a name for your site and a brief description, and then click **Next**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the devices step, shown in [Figure 4-3](part0008.html#adding_a_device_to_the_new_nexpose_site),
    you have quite a bit of granularity in defining your targets. You can add a single
    IP address, address ranges, hostnames, and more. You can also declare devices,
    such as printers, to exclude from scans. (Printers frequently don’t take kindly
    to being scanned. We have seen instances in which a simple vulnerability scan
    caused more than one million pages of pure black to be placed in the queue to
    print!) Click **Next** when you have finished adding and excluding devices.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: At the scan setup step, you can choose from several different scan templates,
    such as Discovery Scan and Penetration test; select the scanning engine you want
    to use; or set up an automated scanning schedule. For purposes of this initial
    walk-through, keep the default selections and click **Next** to continue.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Add credentials for the site you want to scan, if you have them. Credentials
    can help create more accurate and complete results by performing in-depth enumeration
    of installed software and system policies on the target.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the Credentials tab, click the **New Login** button, type a username and
    password for the IP address you want to scan, and then click **Test Login** to
    verify your credentials then save them.![Adding a device to the new NeXpose site](../images/00010.jpeg)Figure 4-3. Adding
    a device to the new NeXpose site
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Last, click **Save** to complete the New Site wizard and return to the Home
    tab, which should list your newly added site, as shown in [Figure 4-4](part0008.html#the_home_tab_shows_the_newly_configured).![The
    Home tab shows the newly configured site.](../images/00011.jpeg)Figure 4-4. The
    Home tab shows the newly configured site.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The New Manual Scan Wizard
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'With your new site configured, you are now set to configure your first scan:'
  prefs: []
  type: TYPE_NORMAL
- en: Click the **New Manual Scan** button shown in [Figure 4-4](part0008.html#the_home_tab_shows_the_newly_configured).
    You should see the Start New Scan dialog shown in [Figure 4-5](part0008.html#the_nexpose_scan_configuration_dialog),
    which prompts you for the assets you want to scan or exclude. In this example,
    we are scanning our default Windows XP system.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Double-check your target IP address to be sure that you’re not about to scan
    the wrong device or network inadvertently, and click the **Start Now** button
    to begin.![The NeXpose scan configuration dialog](../images/00012.jpeg)Figure 4-5. The
    NeXpose scan configuration dialog
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: NeXpose should dynamically refresh the page as the scan progresses. Wait until
    the status for both Scan Progress and Discovered Assets shows *Completed*, as
    shown in [Figure 4-6](part0008.html#the_completed_nexpose_scan_and_report). Under
    the Scan Progress section, you can see that our single scanned device has 268
    vulnerabilities detected, and under Discovered Assets, you are provided with more
    information about the target such as the device name and its operating system.
    Now click the **Reports** tab.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![The completed NeXpose scan and report](../images/00013.jpeg)Figure 4-6. The
    completed NeXpose scan and report'
  prefs: []
  type: TYPE_NORMAL
- en: The New Report Wizard
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: If this is your first time running NeXpose and you have completed only one scan,
    the Reports tab should show that you have generated no reports.
  prefs: []
  type: TYPE_NORMAL
- en: Click **New Report**, as shown in [Figure 4-7](part0008.html#the_nexpose_reports_tab),
    to start the New Report wizard.![The NeXpose Reports tab](../images/00014.jpeg)Figure 4-7. The
    NeXpose Reports tab
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Enter a friendly name, and then in the Report format field, select **NeXpose
    Simple XML Export**, as shown in [Figure 4-8](part0008.html#selecting_a_name_and_format_for_the_repo),
    so that you will be able to import the scan results into Metasploit. You can select
    from different report templates and configure the time zone if you happen to be
    conducting your pen test on the road. Click **Next** when you are ready to proceed.![Selecting
    a name and format for the report](../images/00015.jpeg)Figure 4-8. Selecting a
    name and format for the report
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the subsequent window, add the devices you want to be included in the report
    by clicking **Select Sites** to add your scanned target range, as shown in [Figure 4-9](part0008.html#selecting_the_site_for_inclusion_in_the).
    Then click **Save**.![Selecting the site for inclusion in the report](../images/00016.jpeg)Figure 4-9. Selecting
    the site for inclusion in the report
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the Select Devices dialog, select the targets to include in your report and
    then click **Save**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Back in the Report Configuration wizard, click **Save** to accept the remaining
    defaults for the report. The Reports tab should now list the newly created report,
    as shown in [Figure 4-10](part0008.html#the_reports_tab_lists_your_reports). (Be
    sure to save the report file so that you can use it with the Framework.)![The
    Reports tab lists your reports.](../images/00017.jpeg)Figure 4-10. The Reports
    tab lists your reports.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Importing Your Report into the Metasploit Framework
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Having completed a full vulnerability scan with NeXpose, you need to import
    the results into Metasploit. But before you do, you must create a new database
    from *msfconsole* by issuing `db_connect`. After creating that database you’ll
    import the NeXpose XML using the `db_import` command. Metasploit will automatically
    detect that the file is from NeXpose and import the scanned host. You can then
    verify that the import was successful by running the `db_hosts` command. (These
    steps are shown in the following listing.) As you can see at ![](../images/00002.gif),
    Metasploit knows about the 268 vulnerabilities that your scan picked up.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'To display the full details of the vulnerabilities imported into Metasploit,
    including Common Vulnerabilities and Exposures (CVE) numbers and other references,
    run the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: As you can see, running an overt vulnerability scan with full credentials can
    provide an amazing amount of information — 268 vulnerabilities found in this case.
    But, of course, this has been a very noisy scan, likely to attract lots of attention.
    These types of vulnerability scans are best used in a pen test where being stealthy
    is not required.
  prefs: []
  type: TYPE_NORMAL
- en: Running NeXpose Within MSFconsole
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Running NeXpose from the web GUI is great for fine-tuning vulnerability scans
    and generating reports, but if you prefer to remain in *msfconsole*, you can still
    run full vulnerability scans with the NeXpose plug-in included in Metasploit.
  prefs: []
  type: TYPE_NORMAL
- en: 'To demonstrate the difference in results between a credentialed and noncredentialed
    scan, we will run a scan from with Metasploit without specifying a username and
    password for the target system. Before you begin, delete any existing database
    with `db_destroy`, create a new database in Metasploit with `db_connect`, and
    then load the NeXpose plug-in with `load nexpose` as shown next:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: With the NeXpose plug-in loaded, have a look at the commands loaded specifically
    for the vulnerability scanner by entering the **`help`** command. You should see
    a series of new commands at the top of the listing specific to running NeXpose.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'Before running your first scan from *msfconsole*, you will need to connect
    to your NeXpose installation. Enter **`nexpose_connect -h`** to display the usage
    required to connect; add your username, password, and host address; and accept
    the SSL certificate warning by adding `ok` to the end of the connect string:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: Now enter **`nexpose_scan`** followed by the target IP address to initiate a
    scan, as shown next. In this example, we are scanning a single IP address, but
    you could also pass a range of hosts to the scanner (192.168.1.1-254) or a subnet
    in Classless Inter-Domain Routing (CIDR) notation (192.168.1.0/24).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: After the NeXpose scan completes, the database you created earlier should contain
    the results of the vulnerability scan. To view the results, enter **`db_hosts`**,
    as shown next. (In this example, the output has been trimmed by filtering on the
    address column.)
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: 'As you can see, NeXpose has discovered seven vulnerabilities. Run **`db_vulns`**
    to display the vulnerabilities found:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: Although this scan has found significantly fewer than the 268 vulnerabilities
    discovered with our prior use of NeXpose through the GUI with credentials, you
    should have enough vulnerabilities here to get a great head start on exploiting
    the system.
  prefs: []
  type: TYPE_NORMAL
- en: Scanning with Nessus
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The Nessus vulnerability scanner from Tenable Security ([http://www.tenable.com/](http://www.tenable.com/))
    is one of the most widely used vulnerability scanners. Metasploit’s Nessus plug-in
    lets you launch scans and pull information from Nessus scans via the console,
    but in the example that follows, we’ll import Nessus scan results independently.
    Using Nessus 4.4.1 with a free Home Feed, we’ll run this scan against the same
    target we’ll use throughout this chapter, with known credentials. In these early
    stages of a penetration test, the more tools you can use to fine-tune your future
    attacks, the better.
  prefs: []
  type: TYPE_NORMAL
- en: Nessus Configuration
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: After you have downloaded and installed Nessus, open your web browser and navigate
    to *https://<youripaddress>:8834*, accept the certificate warning, and log into
    Nessus using the credentials you created during installation. You should see the
    main Nessus window, as shown in [Figure 4-11](part0008.html#the_main_nessus_window).
  prefs: []
  type: TYPE_NORMAL
- en: '![The main Nessus window](../images/00018.jpeg)Figure 4-11. The main Nessus
    window'
  prefs: []
  type: TYPE_NORMAL
- en: On login, you will see the Reports section, where any prior vulnerability scans
    should be listed. Along the top of the interface, you should see the Scans tab,
    where you can create and view scanning tasks; the Policies tab, where you configure
    Nessus to include various plug-ins you want to use in your scans; and the Users
    tab, where you can add user accounts to the Nessus server.
  prefs: []
  type: TYPE_NORMAL
- en: Creating a Nessus Scan Policy
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Before beginning a scan, you first need to create a Nessus scan policy. On the
    Policies tab, click the green **Add** button to open the policy configuration
    window shown in [Figure 4-12](part0008.html#the_nessus_policies_configuration_window).
  prefs: []
  type: TYPE_NORMAL
- en: '![The Nessus Policies configuration window](../images/00019.jpeg)Figure 4-12. The
    Nessus Policies configuration window'
  prefs: []
  type: TYPE_NORMAL
- en: You’ll see many available options, all of which can be found in Nessus’s documentation.
  prefs: []
  type: TYPE_NORMAL
- en: Enter a name for the scan, as shown in [Figure 4-13](part0008.html#the_nessus_general_settings).
    We will use the name *The_Works* in our example to have Nessus run all of its
    checks. Then click **Next**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: As with the NeXpose scan conducted earlier, we will configure this scan to use
    Windows login credentials to get a more complete picture of the vulnerabilities
    present on the target system. Enter the login credentials for your target system
    and click **Next**.![The Nessus General settings](../images/00020.jpeg)Figure 4-13. The
    Nessus General settings
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the Plugins page, you can choose from a large variety of Nessus plug-ins
    for Windows, Linux, BSD, and more. If, during a scan, you know you are going to
    scan only Windows-based systems, for example, you could deselect many of these
    plug-ins for your first run-through; for now, click **Enable All** (shown in the
    lower-right corner of [Figure 4-14](part0008.html#selecting_nessus_scan_plug-ins))
    and then click **Next**.![Selecting Nessus scan plug-ins](../images/00021.jpeg)Figure 4-14. Selecting
    Nessus scan plug-ins
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The final step in setting up the new policy is the Preferences page. Here, you
    can direct Nessus not to scan fragile devices such as network printers, configure
    it to store results in an external database, provide login credentials, and more.
    When you are done with your selections, click **Submit** to save the new policy.
    Your newly added policy should be displayed under Policies, as shown in [Figure 4-15](part0008.html#the_newly_added_policy_in_nessus).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![The newly added policy in Nessus](../images/00022.jpeg)Figure 4-15. The newly
    added policy in Nessus'
  prefs: []
  type: TYPE_NORMAL
- en: Running a Nessus Scan
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: After you have created a scan policy, you are ready to configure a scan. Begin
    by selecting the **Scans** tab, and then click the **Add** button to open the
    scan configuration window. Most Nessus configuration is set in its scan policies,
    so when you’re setting up a scan, enter a name for the scan, choose a policy,
    and enter the scan targets, as shown in [Figure 4-16](part0008.html#configuring_a_nessus_scan).
  prefs: []
  type: TYPE_NORMAL
- en: '![Configuring a Nessus scan](../images/00023.jpeg)Figure 4-16. Configuring
    a Nessus scan'
  prefs: []
  type: TYPE_NORMAL
- en: In our example, we are scanning only one host, but you can also enter IP address
    ranges in CIDR notation or even upload a file containing the addresses of the
    targets you want to scan. When you are satisfied with the scan configuration,
    click **Launch Scan**.
  prefs: []
  type: TYPE_NORMAL
- en: Nessus Reports
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: After the scan is complete, it will no longer appear under Scans, and you should
    find a new entry under the Reports tab listing the name of the scan, its status,
    and when it was last updated. Select the report and click **Browse** to open a
    summary page of the scan that shows the severity levels of the vulnerabilities
    found, as shown in [Figure 4-17](part0008.html#our_nessus_scan_report_summary).
  prefs: []
  type: TYPE_NORMAL
- en: '![Our Nessus scan report summary](../images/00024.jpeg)Figure 4-17. Our Nessus
    scan report summary'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Bear in mind that because this scan was run with Windows credentials, Nessus
    will find many more vulnerabilities than it would with an anonymous scan.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: Importing Results into the Metasploit Framework
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Now let’s import our results into the Framework.
  prefs: []
  type: TYPE_NORMAL
- en: Click the **Download Report** button on the Reports tab to save the results
    to your hard drive. The default file format for Nessus reports, *.nessus*, can
    be parsed by Metasploit, so click **Submit** when prompted to select the default
    format.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Load *msfconsole*, create a new database with `db_connect`, and import the Nessus
    results file by entering **`db_import`** followed by the report filename.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: To verify that the scanned host and vulnerability data was imported properly,
    enter **`db_hosts`** as shown next. This should output a brief listing with the
    target IP address, the number of services detected, and the number of vulnerabilities
    found by Nessus.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'For a complete listing of the vulnerability data that was imported into Metasploit,
    enter **`db_vulns`** without any switches, as shown here:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: At the end of your pen test, having these references available can be of great
    assistance when you’re writing the report for your client.
  prefs: []
  type: TYPE_NORMAL
- en: Scanning with Nessus from Within Metasploit
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: During those times when you don’t feel like leaving the comfort of the command
    line, you can use the Nessus Bridge plug-in ([http://blog.zate.org/nessus-plugin-dev/](http://blog.zate.org/nessus-plugin-dev/))
    by Zate within Metasploit. The Nessus Bridge allows you to control Nessus completely
    through the Metasploit Framework, run scans, interpret results, and launch attacks
    based on the vulnerabilities identified through Nessus.
  prefs: []
  type: TYPE_NORMAL
- en: As in the preceding examples, first destroy the existing database with the **`db_destroy`**
    command and create a new one using **`db_connect`**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Load the Nessus plug-in by running **`load nessus`**, as shown here:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Running the command `nessus_help` will display all of the commands that the
    plug-in supports. The Bridge undergoes regular development and updates, so it
    is a good idea to check the help output periodically to see what new features,
    if any, have been added.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Before starting a scan with the Bridge, you first need to authenticate to your
    Nessus server using **`nessus_connect`**, as shown here:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'As with the GUI version of Nessus, you need to initiate a scan using a defined
    policy by its policy ID number. To list the available scan policies on the server,
    use **`nessus_policy_list`**:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Take note of the policy ID you want to use for your scan, and then launch a
    new scan with **`nessus_scan_new`** followed by the policy number, a name for
    your scan, and your target IP address as shown next:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: While your scan is in progress, you can see its status by running the **`nessus_scan_status`**
    command. When this command’s output responds with “No Scans Running,” as shown
    next, you will know that your scan has completed.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: After the scan has completed, you can list the available scan reports with the
    `nessus_report_list` command. Identify the ID of the report you want to import
    and enter **`nessus_report_get`** to download the report and import it into the
    Metasploit database automatically.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Finally, as with the other import functions demonstrated in this chapter, you
    can use `db_hosts` to verify that the scan data was imported successfully:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: Now that you’ve seen the variation in scan results from two different products,
    you should have a better sense of the merit in using more than one tool for your
    scanning needs. It is still up to the penetration tester to interpret the results
    from these automated tools and turn them into actionable data.
  prefs: []
  type: TYPE_NORMAL
- en: Specialty Vulnerability Scanners
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Although many commercial vulnerability scanners are available on the market,
    you are not limited to them. When you want to run a scan for a specific vulnerability
    across a network, Metasploit’s many auxiliary modules can help you accomplish
    such tasks.
  prefs: []
  type: TYPE_NORMAL
- en: The following Metasploit modules are just a few examples of the many useful
    auxiliary scanning modules included in the Framework. Take advantage of your lab
    to probe and explore as many of them as you can.
  prefs: []
  type: TYPE_NORMAL
- en: Validating SMB Logins
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: To check the validity of a username and password combination, use the SMB Login
    Check Scanner to connect to a range of hosts. As you might expect, this scan is
    loud and noticeable, and each login attempt will show up in the event logs of
    *every* Windows box it encounters.
  prefs: []
  type: TYPE_NORMAL
- en: After selecting the *smb_login* module with `use`, you can run `show_options`
    to see the settings listed under the Required column. Metasploit allows you to
    specify a username and password combination, a username and password list, or
    a combination of either. In the next example, `RHOSTS` is set to a small range
    of IP addresses and a username and password are configured for Metasploit to try
    against all addresses.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: You can see a successful login with user *Administrator* and a password of *s3cr3t*
    at ![](../images/00002.gif). Because workstations are all cloned from one image
    and deployed through the enterprise in many corporate environments, the administrator
    password may well be the same on all of them, granting you access to every workstation
    on the network.
  prefs: []
  type: TYPE_NORMAL
- en: Scanning for Open VNC Authentication
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Virtual network computing (VNC) provides graphical access to remote systems
    in a way that’s similar to Microsoft’s Remote Desktop. VNC installations are common
    throughout corporations, because they provide a GUI-based view of server and workstation
    desktops. VNC is frequently installed to meet a temporary need and then completely
    forgotten and left unpatched, creating a major potential vulnerability. Metasploit’s
    built-in VNC Authentication None scanner searches a range of IP addresses for
    VNC servers that do not have a password configured (that support “None” authentication,
    meaning a blank password). Usually, this scan will turn up nothing of value, but
    a good penetration tester leaves no stone unturned when looking for ways access
    a target system.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Recent VNC servers do not allow blank passwords. To set one up in your lab for
    testing, use older VNC servers such as RealVNC 4.1.1.
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: 'The VNC scanner, like most Metasploit auxiliary modules, is easy to configure
    and run. The only required configuration for `vnc_none_auth` is to supply it with
    an IP or a range of IPs to scan. Simply select the module, define your `RHOSTS`
    and `THREADS`, if desired, and run it, as shown next:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: If you get lucky and Metasploit finds a VNC server with no authentication ![](../images/00002.gif),
    you can use Back|Track’s *vncviewer* to connect to the target machine without
    a password, as shown in [Figure 4-18](part0008.html#connecting_to_vnc_with_no_authentication).
  prefs: []
  type: TYPE_NORMAL
- en: '![Connecting to VNC with no authentication using vncviewer](../images/00025.jpeg)Figure 4-18. Connecting
    to VNC with no authentication using *vncviewer*'
  prefs: []
  type: TYPE_NORMAL
- en: If you think a VNC scan is likely to be a waste of time and that you’ll never
    find systems with open VNC servers enabled, think again. During a large penetration
    test, which included thousands of systems, one of the authors noticed that one
    of those systems had an open VNC server.
  prefs: []
  type: TYPE_NORMAL
- en: 'While the author was in the system documenting his finding, he noticed activity
    on the system. This was overnight on a system that was unlikely to have an authorized
    user on it. While not always considered a best practice, the author pretended
    to be another unauthorized intruder and engaged the intruder in conversation via
    Notepad. The intruder was not very bright and told the author that he was scanning
    large blocks of systems for open VNC servers. Here is a segment of the conversation:'
  prefs: []
  type: TYPE_NORMAL
- en: '*Author:* You in the us? or out of country? I know some people in denmark.*Attacker:*
    I’m from Norway actually, hehe, I have relatives in Denmark.*Author:* You hang
    in any boards? like I used to like some but they have been going away*Attacker:*
    I mostly hang in some programming boards, but not much else. Have you been into
    hacking for a long time or what? What’s your age btw? I’m 22.*Author:* I have
    been on this for like fun for around a year or so. Still in school. 16\. Just
    something to do.*Attacker:* Haven’t been there. I too mostly do this for fun,
    just trying to see what I can do, test my skills. I wrote the “VNC finder” myself
    btw, I have found a lot of servers, but this is the only one where I could actually
    have some fun*Author:* Wow. What did you write it in? Can I dl it? Do you have
    a handle?*Attacker:* It’s written in a language called PureBasic, but it’s kinda
    not ready for release yet, it’s only for my own use. But maybe I can share it
    anyway, I could upload the code somewhere and let you compile it. That is if you
    can find some PureBasic compiler on some warez site :P*Author:* Thats cool. you
    can put it in that pastebin site from irc. That lets you anon post I have not
    done purebasic before. just python and perl*Attacker:* Let me see, I’ll look for
    that pastebin site and upload it, just give me some minutes, I’ll be around.'
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: The attacker then gave the author a link to a pastebin page with the full source
    for the custom VNC scanner he was using.
  prefs: []
  type: TYPE_NORMAL
- en: Scanning for Open X11 Servers
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Metasploit’s built-in *open_x11* scanner is similar to the *vnc_auth* scanner,
    in that it scours a range of hosts for X11 servers that allow users to connect
    with-out authentication. Although X11 servers aren’t widely used today, lots of
    archaic boxes out there are still running old, unpatched, and forgotten operating
    systems. As you’ve seen in the preceding two examples, legacy systems are often
    the most vulnerable systems on a network.
  prefs: []
  type: TYPE_NORMAL
- en: 'To run the *open_x11* scanner, simply configure as you would most other auxiliary
    modules by setting the `RHOSTS` and, optionally, the `THREADS` values. A session
    is shown next. Notice at IP address 192.168.1.23 that the scanner has found an
    open X server. This is a serious vulnerability because it allows an attacker to
    gain unauthenticated access to the system: The X system handles the GUI including
    the mouse and keyboard.'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: 'To see what an attacker could do with a vulnerability like this, start keystroke
    logging using Back|Track’s *xspy* tool, like so:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: The *xspy* tool remotely sniffs the X server’s keyboard session and has captured
    a user running SSH to log in as root on a remote system. Vulnerabilities such
    as this can be rare, but when you find them they are extremely valuable.
  prefs: []
  type: TYPE_NORMAL
- en: Using Scan Results for Autopwning
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Let’s take a quick diversion into exploitation. Metasploit’s Autopwn tool automatically
    targets and exploits a system using an open port or using the results of a vulnerability
    scan export. You can use Autopwn to harness the results of most vulnerability
    scanners, including NeXpose, Nessus, and OpenVAS.
  prefs: []
  type: TYPE_NORMAL
- en: For example, here’s how we could use a Nessus results import to target a system
    and autopwn it. Create a new database with `db_connect` and use `db_import` to
    import the scan report. In the next example, we run `db_autopwn` with a series
    of switches to launch attacks against all targets (`e`), show all matching modules
    (`t`), use a reverse shell payload (`r`), select exploit modules based on vulnerability
    (`x`), and also select based on open ports (`p`). Once `db_autopwn` launches,
    Metasploit begins launching exploits at the targets. Successful exploits return
    a shell to the attacking machine.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: Based on these scans, Autopwn launched 72 exploits ![](../images/00002.gif)
    and one was successful, as shown at ![](../images/00004.gif). This exploit allows
    us full access to the machine with a Meterpreter console that will be discussed
    in far more depth in [Chapter 6](part0010.html#meterpreter).
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'One big caveat to remember when using Autopwn: If you’re going in with your
    Autopwn guns blazing, the target system can crash or lose stability. Autopwn has
    useful features not covered here, such as the ability to select only exploits
    that have an “Excellent” ranking, meaning it is very unlikely they will crash
    the remote system or service. For more information on its usage, enter **`db_autopwn
    -h`**.'
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  prefs: []
  type: TYPE_NORMAL
